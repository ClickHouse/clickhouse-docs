---
slug: /whats-new/changelog/2021
sidebar_position: 6
sidebar_label: "2021"
title: "2021年の変更履歴"
description: "2021年の変更履歴"
doc_type: "changelog"
keywords:
  [
    "ClickHouse 2021",
    "changelog 2021",
    "リリースノート",
    "バージョン履歴",
    "新機能"
  ]
---

### ClickHouseリリース v21.12, 2021-12-15 {#clickhouse-release-v2112-2021-12-15}

#### 後方互換性のない変更 {#backward-incompatible-change}

- _以前に望ましくない動作をしていた機能の修正。_ Kafka/RabbitMQ/FileLogに対する直接selectを許可しないようにしました。`stream_like_engine_allow_direct_select`設定で有効化できます。マテリアライズドビューがアタッチされている場合、設定で有効化しても直接selectは許可されません。KafkaとRabbitMQの直接selectは、許可されている場合でもデフォルトではメッセージをコミットしません。直接selectでコミットを有効にするには、ストレージレベルの設定`kafka{rabbitmq}_commit_on_select=1`(デフォルトは`0`)を使用する必要があります。[#31053](https://github.com/ClickHouse/ClickHouse/pull/31053) ([Kseniia Sumarokova](https://github.com/kssenii))。
- _新しい関数の動作のわずかな変更。_ JSON_VALUEで引用符なしの文字列を返すようにしました。[#27965](https://github.com/ClickHouse/ClickHouse/issues/27965)をクローズします。[#31008](https://github.com/ClickHouse/ClickHouse/pull/31008) ([Kseniia Sumarokova](https://github.com/kssenii))。
- _設定の名前変更。_ TSV/CSV入力フォーマットにカスタムnull表現のサポートを追加しました。TSV/CSV/JSONCompactStringsEachRow/JSONStringsEachRow入力フォーマットにおけるNullable(String)のデシリアライズを修正しました。`output_format_csv_null_representation`と`output_format_tsv_null_representation`をそれぞれ`format_csv_null_representation`と`format_tsv_null_representation`に名前変更しました。[#30497](https://github.com/ClickHouse/ClickHouse/pull/30497) ([Kruglov Pavel](https://github.com/Avogar))。
- _既に使用されていないコードのさらなる非推奨化。_ これは20.6より古いバージョンのClickHouseユーザーにのみ関連します。20.6以降は複数のリーダーがサポートされているため、`ReplicatedMergeTree`から「リーダー選出」メカニズムが削除されました。古いバージョンからアップグレードする際に、古いバージョンのレプリカがリーダーである場合、アップグレード後にサーバーの起動が失敗します。新しいバージョンを起動するには、古いバージョンのレプリカを停止してください。その後、20.6より古いバージョンへのダウングレードはできなくなります。[#32140](https://github.com/ClickHouse/ClickHouse/pull/32140) ([tavplubix](https://github.com/tavplubix))。

#### 新機能 {#new-feature}


* clickhouse-keeper において ZooKeeper Four Letter Words コマンドのさらなる部分を実装しました: [https://zookeeper.apache.org/doc/r3.4.8/zookeeperAdmin.html#sc&#95;zkCommands](https://zookeeper.apache.org/doc/r3.4.8/zookeeperAdmin.html#sc_zkCommands)。 [#28981](https://github.com/ClickHouse/ClickHouse/pull/28981)（[JackyWoo](https://github.com/JackyWoo)）。これにより、`clickhouse-keeper` は機能的に完成しました。
* `Bool` データ型をサポート。[#31072](https://github.com/ClickHouse/ClickHouse/pull/31072)（[kevin wan](https://github.com/MaxWk)）。
* File、URL、HDFS ストレージおよび `INSERT INTO` テーブル関数での `PARTITION BY` サポートを追加。 [#30273](https://github.com/ClickHouse/ClickHouse/issues/30273) をクローズ。 [#30690](https://github.com/ClickHouse/ClickHouse/pull/30690)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `INSERT` 時にチェックを行わない `CONSTRAINT ... ASSUME ...` を追加。より柔軟な最適化のために、クエリを CNF（[https://github.com/ClickHouse/ClickHouse/issues/11749](https://github.com/ClickHouse/ClickHouse/issues/11749)）へ変換する機能を追加。制約を利用した単純なクエリ書き換えを追加（現在は単純な一致のみ対応しており、今後 &lt;,=,&gt; などをサポートするよう改善予定）。可能な場合に重いカラムを軽いカラムで置き換える機能を追加。[#18787](https://github.com/ClickHouse/ClickHouse/pull/18787)（[Nikita Vasilev](https://github.com/nikvas0)）。
* http/url 関数に対する Basic アクセス認証。 [#31648](https://github.com/ClickHouse/ClickHouse/pull/31648) ([michael1589](https://github.com/michael1589)).
* `WITH FILL` 修飾子の `STEP` 句で `INTERVAL` 型をサポートするようにしました。 [#30927](https://github.com/ClickHouse/ClickHouse/pull/30927) ([Anton Popov](https://github.com/CurtizJ)).
* 複数ファイルからの並列読み込みをサポートし、`FROM INFILE` 句でグロブの利用をサポートしました。 [#30135](https://github.com/ClickHouse/ClickHouse/pull/30135) ([Filatenkov Artur](https://github.com/FArthur-cmd))。
* `Identifier` テーブルおよびデータベースのクエリパラメータのサポートを追加。[#27226](https://github.com/ClickHouse/ClickHouse/issues/27226) をクローズ。[#28668](https://github.com/ClickHouse/ClickHouse/pull/28668)（[Nikolay Degterinsky](https://github.com/evillique)）。
* *要約: テキストフォーマットの網羅性と一貫性が大幅に向上しました。* フォーマット `TSV`、`TSVRaw`、`CSV` および `JSONCompactEachRow`、`JSONCompactStringsEachRow` をリファクタリングし、コードの重複を削除し、`-WithNames` および `-WithNamesAndTypes` サフィックスを持つフォーマット向けの共通ベースインターフェースを追加しました。フォーマット `CSVWithNamesAndTypes`、`TSVRawWithNames`、`TSVRawWithNamesAndTypes`、`JSONCompactEachRowWIthNames`、`JSONCompactStringsEachRowWIthNames`、`RowBinaryWithNames` を追加しました。フォーマット `TSVWithNamesAndTypes`、`TSVRaw(WithNames/WIthNamesAndTypes)`、`CSVWithNamesAndTypes`、`JSONCompactEachRow(WithNames/WIthNamesAndTypes)`、`JSONCompactStringsEachRow(WithNames/WIthNamesAndTypes)` に対して並列パースをサポートしました。`RowBinaryWithNamesAndTypes` フォーマット向けにカラムのマッピングと型チェックをサポートしました。設定 `input_format_with_types_use_header` を追加し、`<format_name>WIthNamesAndTypes` フォーマットに書かれた型がテーブル構造と一致しているかをチェックするかどうかを指定できるようにしました。設定 `input_format_csv_empty_as_default` を追加し、CSV フォーマットでは `input_format_defaults_for_omitted_fields` の代わりにこれを使用するようにしました（`input_format_defaults_for_omitted_fields` は `csv_empty_as_default` を制御すべきではないため）。設定 `input_format_defaults_for_omitted_fields` の使用方法を修正しました（以前は `csv_empty_as_default` としてのみ使われていましたが、本来は省略されたフィールドに対してデフォルト式を計算するかどうかを制御するための設定です）。`TSVRaw` フォーマットでの Nullable の入出力を修正し、このフォーマットを TSV への挿入と完全に互換にしました。`input_format_null_as_default` が有効なときに `LowCardinality(Nullable)` へ NULL を挿入する処理を修正しました（以前は実際の NULL の代わりにデフォルト値が挿入されていました）。`JSONStringsEachRow`/`JSONCompactStringsEachRow` フォーマットでの文字列のデシリアライズを修正しました（文字列が最初の &#39;\n&#39; または &#39;\t&#39; までしかパースされていませんでした）。Template 入力フォーマットで `Raw` エスケープルールを使用できるようにしました。`JSONCompactEachRow(WithNames/WIthNamesAndTypes)` 入力フォーマット向けに診断情報を追加しました。設定 `min_chunk_bytes_for_parallel_parsing` が 1 行分のバイト数より小さい場合に、`-WithNames` フォーマットの並列パースで発生するバグを修正しました。[#30178](https://github.com/ClickHouse/ClickHouse/pull/30178)（[Kruglov Pavel](https://github.com/Avogar)）。`CustomSeparated` 入力/出力フォーマットでカラムの名前と型を出力/パースできるようにしました。`TSVWithNames/WithNamesAndTypes` と同様の `CustomSeparatedWithNames/WithNamesAndTypes` フォーマットを追加しました。[#31434](https://github.com/ClickHouse/ClickHouse/pull/31434)（[Kruglov Pavel](https://github.com/Avogar)）。
* Aliyun OSS Storage のサポート。[#31286](https://github.com/ClickHouse/ClickHouse/pull/31286)（[cfcz48](https://github.com/cfcz48)）。
* 設定ファイルでグローバルスレッドプールのすべての設定を公開します。 [#31285](https://github.com/ClickHouse/ClickHouse/pull/31285) ([Tomáš Hromada](https://github.com/gyfis)).
* より大きなウィンドウに対しては `exponentialMovingAverage` よりも効果的なウィンドウ関数 `exponentialTimeDecayedSum`、`exponentialTimeDecayedMax`、`exponentialTimeDecayedCount`、`exponentialTimeDecayedAvg` を導入しました。また、対応するユースケースも拡大しました。 [#29799](https://github.com/ClickHouse/ClickHouse/pull/29799) ([Vladimir Chebotarev](https://github.com/excitoon)).
* LZ4 を使用して、ログをファイルに書き込む前に圧縮するオプションを追加しました。[#23860](https://github.com/ClickHouse/ClickHouse/issues/23860) をクローズ。[#29219](https://github.com/ClickHouse/ClickHouse/pull/29219)（[Nikolay Degterinsky](https://github.com/evillique)）。
* CROSS JOIN と同じセマンティクスを持つ `JOIN ON 1 = 1` をサポートしました。これにより [#25578](https://github.com/ClickHouse/ClickHouse/issues/25578) がクローズされました。[#25894](https://github.com/ClickHouse/ClickHouse/pull/25894) ([Vladimir C](https://github.com/vdimir))。
* `Map` 型に Map コンビネータを追加しました。- マップされた配列向けの従来の `sum-, min-, max- Map` を `sum-, min-, max- MappedArrays` に名称変更しました。[#24539](https://github.com/ClickHouse/ClickHouse/pull/24539) ([Ildus Kurbangaliev](https://github.com/ildus))。
* HTTP からの読み取りを再試行可能にしました。[#29696](https://github.com/ClickHouse/ClickHouse/issues/29696) をクローズします。[#29894](https://github.com/ClickHouse/ClickHouse/pull/29894)（[Kseniia Sumarokova](https://github.com/kssenii)）。

#### 実験的機能 {#experimental-feature}

- ClickHouseでストリーム処理を可能にする`WINDOW VIEW`。[#8331](https://github.com/ClickHouse/ClickHouse/pull/8331) ([vxider](https://github.com/Vxider))。
- `MaterializedMySQL`でのOrdinaryデータベースの使用サポートを廃止。[#31292](https://github.com/ClickHouse/ClickHouse/pull/31292) ([Stig Bakken](https://github.com/stigsb))。
- Logファミリー向けのBACKUPおよびRESTOREコマンドを実装。この機能は開発中です。[#30688](https://github.com/ClickHouse/ClickHouse/pull/30688) ([Vitaly Baranov](https://github.com/vitlibar))。

#### パフォーマンス改善 {#performance-improvement}


- `s3` / `url` / `hdfs` フォーマット `Parquet`、`ORC`、`Arrow` での読み取り時のメモリ使用量を削減(設定 `input_format_allow_seeks` で制御、デフォルトで有効)。また、シークを制御するための設定 `remote_read_min_bytes_for_seek` を追加。[#10461](https://github.com/ClickHouse/ClickHouse/issues/10461) をクローズ。[#16857](https://github.com/ClickHouse/ClickHouse/issues/16857) をクローズ。[#30936](https://github.com/ClickHouse/ClickHouse/pull/30936) ([Kseniia Sumarokova](https://github.com/kssenii))。
- JOIN ON における定数条件の最適化を追加。参照 [#26928](https://github.com/ClickHouse/ClickHouse/issues/26928)。[#27021](https://github.com/ClickHouse/ClickHouse/pull/27021) ([Vladimir C](https://github.com/vdimir))。
- `JSONEachRowWithProgress` と `PrettyCompactMonoBlock` を除く、すべてのテキストフォーマットで並列フォーマットをサポート。[#31489](https://github.com/ClickHouse/ClickHouse/pull/31489) ([Kruglov Pavel](https://github.com/Avogar))。
- nullable カラムに対する count を高速化。[#31806](https://github.com/ClickHouse/ClickHouse/pull/31806) ([Raúl Marín](https://github.com/Algunenano))。
- `avg` および `sumCount` 集約関数を高速化。[#31694](https://github.com/ClickHouse/ClickHouse/pull/31694) ([Raúl Marín](https://github.com/Algunenano))。
- JSON および XML 出力フォーマットのパフォーマンスを改善。[#31673](https://github.com/ClickHouse/ClickHouse/pull/31673) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- ブロックデバイスへのデータ同期のパフォーマンスを改善。これにより [#31181](https://github.com/ClickHouse/ClickHouse/issues/31181) をクローズ。[#31229](https://github.com/ClickHouse/ClickHouse/pull/31229) ([zhanglistar](https://github.com/zhanglistar))。
- `LiveView` テーブルにおけるクエリパフォーマンスの問題を修正。[#30831](https://github.com/ClickHouse/ClickHouse/issues/30831) を修正。[#31006](https://github.com/ClickHouse/ClickHouse/pull/31006) ([vzakaznikov](https://github.com/vzakaznikov))。
- クエリ解析を高速化。[#31949](https://github.com/ClickHouse/ClickHouse/pull/31949) ([Raúl Marín](https://github.com/Algunenano))。
- プレーン/タグ付きメトリクスに対して `GraphiteMergeTree` ロールアップルールを分割できるように変更(オプションの `rule_type` フィールド)。[#25122](https://github.com/ClickHouse/ClickHouse/pull/25122) ([Michail Safronov](https://github.com/msaf1980))。
- `remote()` に対する過剰な `DESC TABLE` リクエストを削除(`remote('127.1', system.one)` の場合(つまり、文字列ではなく識別子として db.table を指定した場合)、過剰な `DESC TABLE` リクエストが発生していた)。[#32019](https://github.com/ClickHouse/ClickHouse/pull/32019) ([Azat Khuzhin](https://github.com/azat))。
- 設定 `optimize_functions_to_subcolumns` が有効な場合、関数 `tupleElement` をサブカラムの読み取りに最適化。[#31261](https://github.com/ClickHouse/ClickHouse/pull/31261) ([Anton Popov](https://github.com/CurtizJ))。
- 設定 `optimize_functions_to_subcolumns` が有効な場合、関数 `mapContains` をサブカラム `key` の読み取りに最適化。[#31218](https://github.com/ClickHouse/ClickHouse/pull/31218) ([Anton Popov](https://github.com/CurtizJ))。
- 設定 `merge_tree_min_rows_for_concurrent_read_for_remote_filesystem` および `merge_tree_min_bytes_for_concurrent_read_for_remote_filesystem` を追加。[#30970](https://github.com/ClickHouse/ClickHouse/pull/30970) ([Kseniia Sumarokova](https://github.com/kssenii))。
- `StorageMergeTree` において異なるパーティションのミューテーションをスキップするように変更。[#21326](https://github.com/ClickHouse/ClickHouse/pull/21326) ([Vladimir Chebotarev](https://github.com/excitoon))。

#### 改善 {#improvement}


* 他のテーブルまたはディクショナリが依存している場合、そのテーブルまたはディクショナリを `DROP` できないようになりました。 [#30977](https://github.com/ClickHouse/ClickHouse/pull/30977) ([tavplubix](https://github.com/tavplubix)).
* 集約関数状態のバージョニングを可能にしました。これにより、集約関数状態のシリアル化フォーマットに後方互換性のある変更を導入できるようになりました。[#12552](https://github.com/ClickHouse/ClickHouse/issues/12552) をクローズしました。[#24820](https://github.com/ClickHouse/ClickHouse/pull/24820)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* PostgreSQL スタイルの `ALTER MODIFY COLUMN` 構文をサポートします。 [#32003](https://github.com/ClickHouse/ClickHouse/pull/32003) ([SuperDJY](https://github.com/cmsxbc))。
* `RangeHashedDictionary` と `ComplexKeyRangeHashedDictionary` に `update_field` のサポートを追加しました。 [#32185](https://github.com/ClickHouse/ClickHouse/pull/32185) ([Maksim Kita](https://github.com/kitaisreal)).
* `murmurHash3_128` 関数と `sipHash128` 関数は、任意個の引数を受け取れるようになりました。これにより [#28774](https://github.com/ClickHouse/ClickHouse/issues/28774) がクローズされました。[#28965](https://github.com/ClickHouse/ClickHouse/pull/28965)（[小路](https://github.com/nicelulu)）。
* `HDFS` ストレージでのデフォルト式のサポートを追加し、ソースがカラム指向の場合のデータ取得を最適化しました。 [#32256](https://github.com/ClickHouse/ClickHouse/pull/32256) ([李扬](https://github.com/taiyang-li)).
* OpenTelemetry スパンのオペレーション名を改善。 [#32234](https://github.com/ClickHouse/ClickHouse/pull/32234) ([Frank Chen](https://github.com/FrankChen021))。
* 出力フォーマット `JSONEachRow` を使用する場合は、`Content-Type: application/x-ndjson`（[http://ndjson.org/](http://ndjson.org/)）を設定してください。 [#32223](https://github.com/ClickHouse/ClickHouse/pull/32223)（[Dmitriy Dorofeev](https://github.com/deem0n)）。
* Template/CustomSeparated フォーマットにおけるクオート付きエスケープ規則で、未知のフィールドをスキップする動作を改善しました。これまではクオートされた文字列のみスキップ可能でしたが、任意の型の値をスキップできるようになりました。 [#32204](https://github.com/ClickHouse/ClickHouse/pull/32204) ([Kruglov Pavel](https://github.com/Avogar)).
* `clickhouse-keeper` は、重複した ID やエンドポイントが含まれている場合には起動や設定変更の適用を拒否するようになりました。 [#31339](https://github.com/ClickHouse/ClickHouse/issues/31339) を修正。 [#32121](https://github.com/ClickHouse/ClickHouse/pull/32121) ([alesapin](https://github.com/alesapin))。
* URL エンジンが送信する HTTP パケットに Content-Type を設定。 [#32113](https://github.com/ClickHouse/ClickHouse/pull/32113) ([Frank Chen](https://github.com/FrankChen021)).
* `output_format_json_array_of_rows` が有効な場合、`JSONEachRow` フォーマットに対して Content-Type を `application/json` として返します。 [#32112](https://github.com/ClickHouse/ClickHouse/pull/32112) ([Frank Chen](https://github.com/FrankChen021)).
* `Float32` / `Float64` 型の値の前にある `+` をパースできるようにしました。 [#32079](https://github.com/ClickHouse/ClickHouse/pull/32079) ([Kruglov Pavel](https://github.com/Avogar)).
* `DiskHDFS` および `StorageHDFS` に対して、ユーザーが設定可能な `hdfs_replication` パラメータを許可。 [#32039](https://github.com/ClickHouse/ClickHouse/issues/32039) をクローズ。 [#32049](https://github.com/ClickHouse/ClickHouse/pull/32049)（[leosunli](https://github.com/leosunli)）。
* ClickHouse の `exception` および `exception_code` フィールドを OpenTelemetry の span ログに追加しました。 [#32040](https://github.com/ClickHouse/ClickHouse/pull/32040) ([Frank Chen](https://github.com/FrankChen021)).
* OpenTelemetry の span ログの継続時間を改善 — クエリ例外が発生した場合に、クエリレベルでの値が 0 になっていた問題を修正。 [#32038](https://github.com/ClickHouse/ClickHouse/pull/32038) ([Frank Chen](https://github.com/FrankChen021)).
* `Int256` の `LowCardinality` 型を作成できない問題を修正しました。 [#31832](https://github.com/ClickHouse/ClickHouse/pull/31832) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 異なる engine や partition&#95;by が設定されている場合に `system.*_log` テーブルを再作成するようにしました。 [#31824](https://github.com/ClickHouse/ClickHouse/pull/31824) ([Azat Khuzhin](https://github.com/azat))。
* `MaterializedMySQL`: `table` という名前のテーブルに関する問題を修正しました。 [#31781](https://github.com/ClickHouse/ClickHouse/pull/31781) ([Håvard Kvålen](https://github.com/havardk)).
* ClickHouse の辞書ソース: 事前定義された接続をサポート。[#31705](https://github.com/ClickHouse/ClickHouse/issues/31705) をクローズ。[#31749](https://github.com/ClickHouse/ClickHouse/pull/31749)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* Kafka および RabbitMQ エンジンで、他の統合テーブルエンジンと同様に、事前定義された接続設定を使用できるようにしました。 [#31691](https://github.com/ClickHouse/ClickHouse/pull/31691) ([Kseniia Sumarokova](https://github.com/kssenii)).
* clickhouse-client の履歴をたどる際に、常にプロンプトを再描画するようにしました。これにより、画面に収まりきらない非常に長いクエリを編集・操作する際の使い勝手が向上します。 [#31675](https://github.com/ClickHouse/ClickHouse/pull/31675) ([alexey-milovidov](https://github.com/alexey-milovidov)) (author: Amos Bird).
* 履歴（行単位ではなく履歴全体）を移動するためのキーバインドを追加しました。 [#31641](https://github.com/ClickHouse/ClickHouse/pull/31641) ([Azat Khuzhin](https://github.com/azat)).
* `max_execution_time` のチェックを改善しました。タイムアウトチェックが行われず、クエリが必要以上に長く実行されてしまういくつかのケースを修正しました。 [#31636](https://github.com/ClickHouse/ClickHouse/pull/31636) ([Raúl Marín](https://github.com/Algunenano)).
* パスワードハッシュが不正なために `users.xml` を読み込めない場合の例外メッセージを改善しました。これにより [#24126](https://github.com/ClickHouse/ClickHouse/issues/24126) がクローズされました。[#31557](https://github.com/ClickHouse/ClickHouse/pull/31557)（[Vitaly Baranov](https://github.com/vitlibar)）。
* `Replicated` データベースの引数からシャード名とレプリカ名を取得し、設定でこれらのマクロが定義されていない場合に `ReplicatedMergeTree` の引数内でマクロを展開する際に使用するようにしました。[#31471](https://github.com/ClickHouse/ClickHouse/issues/31471) をクローズ。[#31488](https://github.com/ClickHouse/ClickHouse/pull/31488)（[tavplubix](https://github.com/tavplubix)）。
* `min/max/count` プロジェクションの解析が改善されました。`allow_experimental_projection_optimization` を有効にすると、仮想 `min/max/count` プロジェクションをパーティションキーのカラムと組み合わせて使用できるようになりました。 [#31474](https://github.com/ClickHouse/ClickHouse/pull/31474) ([Amos Bird](https://github.com/amosbird))。
* `clickhouse-local` に `--pager` のサポートを追加。 [#31457](https://github.com/ClickHouse/ClickHouse/pull/31457) ([Azat Khuzhin](https://github.com/azat))。
* 対話的なクエリ編集時のエディタの待機処理を修正しました（`waitpid()` が `SIGWINCH` で -1 を返し、`EDITOR` と `clickhouse-local` / `clickhouse-client` が並行して動作している場合）。 [#31456](https://github.com/ClickHouse/ClickHouse/pull/31456) ([Azat Khuzhin](https://github.com/azat)).
* `JSONCompactStrings(EachRow)` フォーマットでフィールドの後に不要なデータが存在する場合、例外をスローするようにしました。 [#31455](https://github.com/ClickHouse/ClickHouse/pull/31455) ([Kruglov Pavel](https://github.com/Avogar)).
* `http_send_timeout` および `http_receive_timeout` 設定のデフォルト値が 1800（30分）から 180（3分）に変更されました。 [#31450](https://github.com/ClickHouse/ClickHouse/pull/31450) ([tavplubix](https://github.com/tavplubix))。
* `MaterializedMySQL` で `CREATE TABLE ... LIKE ...` DDL クエリを扱えるようになりました。 [#31410](https://github.com/ClickHouse/ClickHouse/pull/31410) ([Stig Bakken](https://github.com/stigsb)).
* `show create table` をシステムテーブルに対して実行したときに、擬似的な CREATE クエリを返すようにしました。 [#31391](https://github.com/ClickHouse/ClickHouse/pull/31391) ([SuperDJY](https://github.com/cmsxbc)).
* これまでは `numbers` テーブル関数に対してのみ進捗が表示されていましたが、`numbers_mt` に対しても表示されるようになりました。 [#31318](https://github.com/ClickHouse/ClickHouse/pull/31318) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 初期ユーザーのロールは、現在は行ポリシーを検索するために使用されます。[#31080](https://github.com/ClickHouse/ClickHouse/issues/31080) を参照してください。[#31262](https://github.com/ClickHouse/ClickHouse/pull/31262)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 一部の廃止予定の設定が変更された場合、`system.warnings` に警告を表示します。 [#31252](https://github.com/ClickHouse/ClickHouse/pull/31252) ([tavplubix](https://github.com/tavplubix))。
* `MergeTree` のバックグラウンドクリーンアップタスクに対するバックオフを改善しました。設定 `merge_tree_clear_old_temporary_directories_interval_seconds` と `merge_tree_clear_old_parts_interval_seconds` を users 設定から MergeTree 設定へ移動しました。 [#31180](https://github.com/ClickHouse/ClickHouse/pull/31180) ([tavplubix](https://github.com/tavplubix)).
* これにより、すべてのレプリカはプロファイルイベントカウンタについて、クライアントへ差分情報のみを送信するようになりました。 [#31155](https://github.com/ClickHouse/ClickHouse/pull/31155)（[Dmitry Novik](https://github.com/novikd)）。これにより、`clickhouse-client` の `--hardware_utilization` オプションが有効に活用できるようになりました。
* clickhouse-client で複数行編集をデフォルトで有効化しました。これにより [#31121](https://github.com/ClickHouse/ClickHouse/issues/31121) が解決されます。[#31123](https://github.com/ClickHouse/ClickHouse/pull/31123)（[Amos Bird](https://github.com/amosbird)）。
* `ALTER` クエリに対する関数名の正規化。これにより、インデックスやプロジェクション付きでテーブルを作成する場合と、`ALTER` コマンドでインデックスやプロジェクションを追加する場合との間でメタデータの不整合が発生するのを防ぎます。これは [https://github.com/ClickHouse/ClickHouse/pull/20174](https://github.com/ClickHouse/ClickHouse/pull/20174) のフォローアップ PR です。バグ報告がなく、かつ発生シナリオが比較的まれであるため、「改善」としてマークされています。[#31095](https://github.com/ClickHouse/ClickHouse/pull/31095) ([Amos Bird](https://github.com/amosbird))。
* `RENAME DATABASE`/`TABLE`/`DICTIONARY` クエリで `IF EXISTS` 修飾子をサポートしました。このディレクティブを使用すると、名前変更しようとしている DATABASE/TABLE/DICTIONARY が存在しない場合でもエラーになりません。[#31081](https://github.com/ClickHouse/ClickHouse/pull/31081) ([victorgao](https://github.com/kafka1991)).
* パーティションが削除されたときに垂直マージをキャンセルするようにしました。これは [https://github.com/ClickHouse/ClickHouse/pull/25684](https://github.com/ClickHouse/ClickHouse/pull/25684) および [https://github.com/ClickHouse/ClickHouse/pull/30996](https://github.com/ClickHouse/ClickHouse/pull/30996) のフォローアップです。 [#31057](https://github.com/ClickHouse/ClickHouse/pull/31057)（[Amos Bird](https://github.com/amosbird)）。
* ClickHouse の辞書ソース内のローカルセッションは、セッションログにイベントを送信しなくなりました。これにより、シャットダウン時に発生し得たデッドロック（tsan アラート）が解消されます。また、この PR では不安定だった `test_dictionaries_dependency_xml/` も修正しています。 [#31013](https://github.com/ClickHouse/ClickHouse/pull/31013) ([Vitaly Baranov](https://github.com/vitlibar))。
* ALTER コマンドによるロックを減らしました。 [#31010](https://github.com/ClickHouse/ClickHouse/pull/31010) ([Amos Bird](https://github.com/amosbird)).
* clickhouse-local のインタラクティブモードにおける `--verbose` オプションを修正し、ファイルへのログ出力を可能にしました。 [#30881](https://github.com/ClickHouse/ClickHouse/pull/30881) ([Kseniia Sumarokova](https://github.com/kssenii)).
* MySQL および PostgreSQL と同様に、`clickhouse-client` に `\l`、`\d`、`\c` コマンドを追加しました。 [#30876](https://github.com/ClickHouse/ClickHouse/pull/30876) ([Pavel Medvedev](https://github.com/pmed)).
* clickhouse-local または clickhouse-client の場合: `--query` または `--queries-file` と共に `--interactive` オプションが指定されている場合、まず非インタラクティブモードと同様にそれらを実行し、その後インタラクティブモードを開始します。 [#30851](https://github.com/ClickHouse/ClickHouse/pull/30851) ([Kseniia Sumarokova](https://github.com/kssenii))。
* （DROP が ZooKeeper から znode を削除している最中に失敗した場合に発生しうる）「The local set of parts of X doesn&#39;t look like the set of parts in ZooKeeper」エラーを修正。 [#30826](https://github.com/ClickHouse/ClickHouse/pull/30826) ([Azat Khuzhin](https://github.com/azat)).
* Avro フォーマットが Kafka でも動作するようになりました。`output_format_avro_rows_in_file` 設定を追加しました。[#30351](https://github.com/ClickHouse/ClickHouse/pull/30351)（[Ilya Golshtein](https://github.com/ilejn)）。
* 1 つの `MaterializedPostgreSQL` データベースに対して、1 つまたは任意の数の PostgreSQL スキーマを指定できるようにしました。[#28901](https://github.com/ClickHouse/ClickHouse/issues/28901) をクローズ。[#29324](https://github.com/ClickHouse/ClickHouse/issues/29324) をクローズ。[#28933](https://github.com/ClickHouse/ClickHouse/pull/28933)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* clickhouse-keeper の内部通信に使用するデフォルトポートを 44444 から 9234 に変更しました。 [#30879](https://github.com/ClickHouse/ClickHouse/issues/30879) を修正。[#31799](https://github.com/ClickHouse/ClickHouse/pull/31799)（[alesapin](https://github.com/alesapin)）。
* Decimal 型の引数を取る関数 `transform` を実装しました。 [#31839](https://github.com/ClickHouse/ClickHouse/pull/31839) ([李帅](https://github.com/loneylee)).
* 不正な hdfs URL の場合に、hdfs URL 構造の追加チェックを行うことで、デバッグサーバーで発生していた abort と、リリースサーバーでの `DB::Exception: std::out_of_range: basic_string` エラーを修正しました。 [#31042](https://github.com/ClickHouse/ClickHouse/pull/31042) ([Kruglov Pavel](https://github.com/Avogar)).
* `hdfs` テーブル関数/エンジンで発生し得るアサートを修正し、テストを追加。 [#31036](https://github.com/ClickHouse/ClickHouse/pull/31036) ([Kruglov Pavel](https://github.com/Avogar)).

#### バグ修正 {#bug-fixes}


* 位置引数が有効な場合の GROUP BY / ORDER BY / LIMIT BY におけるエイリアスの扱いを修正。 [#31173](https://github.com/ClickHouse/ClickHouse/issues/31173) をクローズ。 [#31741](https://github.com/ClickHouse/ClickHouse/pull/31741)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `Map` 型と併用した `Buffer` テーブルエンジンの動作を修正。 [#30546](https://github.com/ClickHouse/ClickHouse/issues/30546) を修正。 [#31742](https://github.com/ClickHouse/ClickHouse/pull/31742)（[Anton Popov](https://github.com/CurtizJ)）。
* `use_uncompressed_cache` が有効な `MergeTree` テーブルからの読み取りを修正。 [#31826](https://github.com/ClickHouse/ClickHouse/pull/31826) ([Anton Popov](https://github.com/CurtizJ)).
* `empty_result_for_aggregation_by_empty_set` 設定が有効な場合に、実際には行うべき処理がない mutation がハングしてしまう問題を修正しました。 [#32358](https://github.com/ClickHouse/ClickHouse/pull/32358) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Protobuf 書き込み時にカラムがスキップされてしまう問題を修正。この PR は [#31160](https://github.com/ClickHouse/ClickHouse/issues/31160) を解決します。コメント [#31160](https://github.com/ClickHouse/ClickHouse/issues/31160)#issuecomment-980595318 を参照してください。 [#31988](https://github.com/ClickHouse/ClickHouse/pull/31988)（[Vitaly Baranov](https://github.com/vitlibar)）。
* サブクエリ内で不要な列を削除する処理に存在していたバグを修正。`GROUP BY` を含まないクエリに集約関数がある場合、それが不要であっても削除しないようにした。[#32289](https://github.com/ClickHouse/ClickHouse/pull/32289) ([dongyifeng](https://github.com/dyf6372))。
* クォータの上限には達していなかったが、制限は超過していた。この PR は [#31174](https://github.com/ClickHouse/ClickHouse/issues/31174) を修正します。 [#31337](https://github.com/ClickHouse/ClickHouse/pull/31337)（[sunny](https://github.com/sunny19930321)）。
* 部分的な権限取り消しが使用されている場合の SHOW GRANTS の動作を修正しました。この PR は [#31138](https://github.com/ClickHouse/ClickHouse/issues/31138) を解決します。[#31249](https://github.com/ClickHouse/ClickHouse/pull/31249)（[Vitaly Baranov](https://github.com/vitlibar)）。
* cgroup 制限付きのコンテナ内で ClickHouse を実行した場合、メモリ量が正しく推定されていませんでした。 [#31157](https://github.com/ClickHouse/ClickHouse/pull/31157) ([Pavel Medvedev](https://github.com/pmed))。
* `ALTER ... MATERIALIZE COLUMN ...` クエリにおいて、デフォルト式のデータ型がカラムのデータ型と一致しない場合の挙動を修正しました。 [#32348](https://github.com/ClickHouse/ClickHouse/pull/32348) ([Anton Popov](https://github.com/CurtizJ)).
* `Decimal` 引数を持つ集約関数 `avgWeighted` で発生していた SIGFPE によるクラッシュを修正しました。[#32053](https://github.com/ClickHouse/ClickHouse/issues/32053) を解決します。 [#32303](https://github.com/ClickHouse/ClickHouse/pull/32303) ([tavplubix](https://github.com/tavplubix))。
* `Dictionary` テーブルが同名の XML 辞書を参照している場合に、サーバーが `Cannot attach 1 tables due to cyclic dependencies` エラーにより起動に失敗することがありましたが、修正されました。 [#31315](https://github.com/ClickHouse/ClickHouse/issues/31315) を修正。 [#32288](https://github.com/ClickHouse/ClickHouse/pull/32288)（[tavplubix](https://github.com/tavplubix)）。
* `Quoted` エスケープルールにおける `Nullable(Float)` の NaN デシリアライズ時のパースエラーを修正。 [#32190](https://github.com/ClickHouse/ClickHouse/pull/32190) ([Kruglov Pavel](https://github.com/Avogar)).
* XML 辞書: テーブル作成クエリで使用される識別子は、新しいバージョンへのアップグレード時に `default_database` を付けて修飾できるようになりました。 [#31963](https://github.com/ClickHouse/ClickHouse/issues/31963) をクローズ。 [#32187](https://github.com/ClickHouse/ClickHouse/pull/32187)（[Maksim Kita](https://github.com/kitaisreal)）。
* `replicated_can_become_leader` が一部のレプリカで無効になっている場合、クォーラム付き挿入時のアクティブなレプリカ数が誤って判定されることがありました。この問題は修正されました。 [#32157](https://github.com/ClickHouse/ClickHouse/pull/32157) ([tavplubix](https://github.com/tavplubix)).
* 辞書: カスタムデータベースクエリで `{condition}` が機能しないケースを修正。 [#32117](https://github.com/ClickHouse/ClickHouse/pull/32117) ([Maksim Kita](https://github.com/kitaisreal)).
* `cast_keep_nullable` 使用時の `Nullable` からの `CAST` を修正しました（たとえば `toUInt32OrDefault(toNullable(toUInt32(1)))` で、以前は `PARAMETER_OUT_OF_BOUND` エラーが発生していました）。 [#32080](https://github.com/ClickHouse/ClickHouse/pull/32080) ([Azat Khuzhin](https://github.com/azat)).
* いくつかの特殊なケースにおいて Join ストレージの CREATE TABLE を修正。 [#31680](https://github.com/ClickHouse/ClickHouse/issues/31680) をクローズ。 [#32066](https://github.com/ClickHouse/ClickHouse/pull/32066)（[SuperDJY](https://github.com/cmsxbc)）。
* パーツのデタッチ時に発生していた `Directory ... already exists and is not empty` エラーを修正。 [#32063](https://github.com/ClickHouse/ClickHouse/pull/32063) ([tavplubix](https://github.com/tavplubix)).
* `MaterializedMySQL`（実験的機能）：MySQL からの `DECIMAL` データの誤解釈を修正。 [#31990](https://github.com/ClickHouse/ClickHouse/pull/31990) ([Håvard Kvålen](https://github.com/havardk)).
* `FileLog`（実験的機能）エンジンで、テーブル作成が失敗した際に不要なメタデータディレクトリが作成されてしまう問題を修正。Fix [#31962](https://github.com/ClickHouse/ClickHouse/issues/31962). [#31967](https://github.com/ClickHouse/ClickHouse/pull/31967) ([flynn](https://github.com/ucasfl)).
* 一部の `GET_PART` エントリは、パーツがすべてのレプリカ上で失われ、同じパーティション内に他のパーツが存在しない場合、レプリケーションキュー内でハングすることがあります。パーティションキーが整数型の列または `Date[Time]` だけで構成されている場合については、この問題を修正しました。[#31485](https://github.com/ClickHouse/ClickHouse/issues/31485) を修正。 [#31887](https://github.com/ClickHouse/ClickHouse/pull/31887) ([tavplubix](https://github.com/tavplubix))。
* `UUID` 型の引数に対する `empty` 関数と `notEmpty` 関数の不具合を修正しました。 [#31819](https://github.com/ClickHouse/ClickHouse/issues/31819) を解決。 [#31883](https://github.com/ClickHouse/ClickHouse/pull/31883)（[Anton Popov](https://github.com/CurtizJ)）。
* `KeeperTCPHandler` を構築する際の設定パスを、`keeper_server.session_timeout_ms` から `keeper_server.coordination_settings.session_timeout_ms` に変更しました。`operation_timeout` も同様です。 [#31859](https://github.com/ClickHouse/ClickHouse/pull/31859) ([JackyWoo](https://github.com/JackyWoo))。
* nullable な主キーが使用されている場合の `Nullable` 型に対する不正なキャストを修正しました（nullable な主キーは非推奨の機能のため、使用しないでください）。この修正は [#31075](https://github.com/ClickHouse/ClickHouse/issues/31075) を解決します。 [#31823](https://github.com/ClickHouse/ClickHouse/pull/31823) ([Amos Bird](https://github.com/amosbird))。
* SQL の再帰 UDF で発生していたクラッシュを修正。[#30856](https://github.com/ClickHouse/ClickHouse/issues/30856) をクローズ。[#31820](https://github.com/ClickHouse/ClickHouse/pull/31820)（[Maksim Kita](https://github.com/kitaisreal)）。
* 型付きの関数 `dictGet` を、型が `Nullable` のディクショナリ属性に対して使用した際にクラッシュする問題を修正しました。 [#30980](https://github.com/ClickHouse/ClickHouse/issues/30980) を修正。 [#31800](https://github.com/ClickHouse/ClickHouse/pull/31800) ([Maksim Kita](https://github.com/kitaisreal)).
* 一部の ODBC ドライバーで、ODBC クエリの結果が空の場合に発生していたクラッシュを修正しました。[#31465](https://github.com/ClickHouse/ClickHouse/issues/31465) をクローズ。[#31766](https://github.com/ClickHouse/ClickHouse/pull/31766)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* クエリプロファイラの無効化処理を修正（`query_profiler_real_time_period_ns>0` / `query_profiler_cpu_time_period_ns>0` の場合、クエリ完了後もクエリプロファイラが有効なままの状態になってしまうことがありました）。 [#31740](https://github.com/ClickHouse/ClickHouse/pull/31740) ([Azat Khuzhin](https://github.com/azat)).
* 同時に実行される `ATTACH PARTITION` クエリでまれに発生するセグメンテーションフォルトを修正しました。 [#31738](https://github.com/ClickHouse/ClickHouse/pull/31738) ([tavplubix](https://github.com/tavplubix)).
* 出力内でデータと進捗行が混在する場合に発生する JSONEachRowWithProgress 出力フォーマットのレースコンディションを修正。 [#31736](https://github.com/ClickHouse/ClickHouse/pull/31736) ([Kruglov Pavel](https://github.com/Avogar)).
* `Replicated` データベースの名前をクラスタ名として指定した場合に、`ON CLUSTER` クエリの実行時に発生していた `there are no such cluster here` エラーを修正しました。 [#31723](https://github.com/ClickHouse/ClickHouse/pull/31723) ([tavplubix](https://github.com/tavplubix)).
* Nullable カラムに対する `decrypt` 関数の一部の使用時に発生していた例外を修正しました。これにより [#31662](https://github.com/ClickHouse/ClickHouse/issues/31662) がクローズされます。また、[#31426](https://github.com/ClickHouse/ClickHouse/issues/31426) もクローズされます。[#31707](https://github.com/ClickHouse/ClickHouse/pull/31707)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 文字列に UTF-8 文字が含まれている場合の関数 `ngrams` の不具合を修正しました。 [#31706](https://github.com/ClickHouse/ClickHouse/pull/31706) ([yandd](https://github.com/yandd)).
* `input_format_allow_errors_num` と `input_format_allow_errors_ratio` の設定が `IPv4` などのドメイン型のパース時に機能していませんでしたが、修正されました。 [#31686](https://github.com/ClickHouse/ClickHouse/issues/31686) を修正。 [#31697](https://github.com/ClickHouse/ClickHouse/pull/31697)（[tavplubix](https://github.com/tavplubix)）。
* `MATERIALIZE COLUMN` におけるヌルポインタ例外を修正しました。 [#31679](https://github.com/ClickHouse/ClickHouse/pull/31679) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `Ordinary` データベース内の DDL ディクショナリの名前を変更しようとした際に、`RENAME TABLE` クエリが正しく動作していなかった問題を修正しました。 [#31638](https://github.com/ClickHouse/ClickHouse/pull/31638) ([tavplubix](https://github.com/tavplubix)).
* `sparkbar` 集約関数を、本来の意図どおりに実装しました。詳しくは [#26175](https://github.com/ClickHouse/ClickHouse/issues/26175)#issuecomment-960353867、[コメント](https://github.com/ClickHouse/ClickHouse/issues/26175#issuecomment-961155065) を参照してください。[#31624](https://github.com/ClickHouse/ClickHouse/pull/31624)（[小路](https://github.com/nicelulu)）。
* カラム名のみが不正な UTF-8 シーケンスを含む場合に生成される不正な JSON を修正。 [#31534](https://github.com/ClickHouse/ClickHouse/pull/31534) ([Kevin Michel](https://github.com/kmichel-aiven)).
* この最適化のバグが修正されるまで、`partial_merge_join_left_table_buffer_bytes` を無効化します。[#31009](https://github.com/ClickHouse/ClickHouse/issues/31009) を参照。冗長なオプション `partial_merge_join_optimizations` を削除。 [#31528](https://github.com/ClickHouse/ClickHouse/pull/31528) ([Vladimir C](https://github.com/vdimir))。
* 短い `INSERT SELECT` クエリの進捗表示を修正。 [#31510](https://github.com/ClickHouse/ClickHouse/pull/31510) ([Azat Khuzhin](https://github.com/azat)).
* GROUP BY と位置引数に関する誤った動作を修正。[#31280](https://github.com/ClickHouse/ClickHouse/issues/31280)#issuecomment-968696186 をクローズ。 [#31420](https://github.com/ClickHouse/ClickHouse/pull/31420)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* S3 用の STS クレデンシャルプロバイダにおける `nullptr` の問題を解消しました。 [#31409](https://github.com/ClickHouse/ClickHouse/pull/31409) ([Vladimir Chebotarev](https://github.com/excitoon)).
* `notLike` 関数をインデックス解析から削除しました。誤った実装だったためです。 [#31169](https://github.com/ClickHouse/ClickHouse/pull/31169) ([sundyli](https://github.com/sundy-li)).
* 一部のcoordination logが失われ、最新のログよりも新しいスナップショットが存在する場合に、Keeperが起動できなくなる不具合を修正。 [#31150](https://github.com/ClickHouse/ClickHouse/pull/31150) ([alesapin](https://github.com/alesapin)).
* ローカル結合で右側の分散テーブルを書き換えるようにしました。[#25809](https://github.com/ClickHouse/ClickHouse/issues/25809) を解決。[#31105](https://github.com/ClickHouse/ClickHouse/pull/31105) ([abel-cheng](https://github.com/abel-cheng))。
* `Merge` テーブルでエイリアスと WHERE を使用した場合の不具合を修正しました（これまではまったく動作していませんでした）。[#28802](https://github.com/ClickHouse/ClickHouse/issues/28802) をクローズ。[#31044](https://github.com/ClickHouse/ClickHouse/pull/31044)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 引用付き識別子を使用した JSON&#95;VALUE/JSON&#95;QUERY を修正しました。これにより、JSON パスに空白を含められるようになりました。[#30971](https://github.com/ClickHouse/ClickHouse/issues/30971) をクローズ。[#31003](https://github.com/ClickHouse/ClickHouse/pull/31003)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 行指向ではないフォーマットで `formatRow` 関数を使用するとセグメンテーションフォールトが発生していました。このようなフォーマットでは（意味がないため）この関数を使用できないようにしました。 [#31001](https://github.com/ClickHouse/ClickHouse/pull/31001) ([Kruglov Pavel](https://github.com/Avogar)).
* マテリアライズドビューを削除した後に `SELECT` クエリが失敗する不具合を修正しました。[#30691](https://github.com/ClickHouse/ClickHouse/issues/30691) で報告。[#30997](https://github.com/ClickHouse/ClickHouse/pull/30997)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* ATTACH PARTITION ... FROM および MOVE PARTITION ... の場合には、`max_partition_size_to_drop check` をスキップするようにした [#30995](https://github.com/ClickHouse/ClickHouse/pull/30995)（[Amr Alaa](https://github.com/amralaa-MSFT)）。
* `INTERSECT` および `EXCEPT` 演算子に関するいくつかのコーナーケースを修正しました。[#30803](https://github.com/ClickHouse/ClickHouse/issues/30803) をクローズ。[#30965](https://github.com/ClickHouse/ClickHouse/pull/30965)（[Kseniia Sumarokova](https://github.com/kssenii)）。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement}

- 非x86ビルドにおける不正なフィルタリング結果を修正しました。これにより[#31417](https://github.com/ClickHouse/ClickHouse/issues/31417)が解決されます。これにより[#31524](https://github.com/ClickHouse/ClickHouse/issues/31524)が解決されます。[#31574](https://github.com/ClickHouse/ClickHouse/pull/31574) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- ClickHouseのビルドを完全に再現可能にしました(異なるマシンでバイト単位で同一)。これにより[#22113](https://github.com/ClickHouse/ClickHouse/issues/22113)が解決されます。[#31899](https://github.com/ClickHouse/ClickHouse/pull/31899) ([alexey-milovidov](https://github.com/alexey-milovidov))。再現可能なビルドを実現するため、バイナリからビルドディレクトリへのファイルシステムパスを削除しました。これは[#22113](https://github.com/ClickHouse/ClickHouse/issues/22113)に必要な対応です。[#31838](https://github.com/ClickHouse/ClickHouse/pull/31838) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `zlib-ng`、`cassandra`、`mariadb-connector-c`、`xz`、`re2`、`sentry`、`gsasl`、`arrow`、`protobuf`に対して独自のCMakeListsを使用します。これは[#20151](https://github.com/ClickHouse/ClickHouse/issues/20151)に必要な対応です。[#9226](https://github.com/ClickHouse/ClickHouse/issues/9226)の一部です。ビルドシステムから煩わしい不要物を削除するための小さな一歩です。[#30599](https://github.com/ClickHouse/ClickHouse/pull/30599) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 密閉ビルド: libcの固定バージョンを使用し、ビルド中にホストOSからのソースファイルやバイナリファイルが使用されないようにします。これにより[#27133](https://github.com/ClickHouse/ClickHouse/issues/27133)が解決されます。これにより[#21435](https://github.com/ClickHouse/ClickHouse/issues/21435)が解決されます。これにより[#30462](https://github.com/ClickHouse/ClickHouse/issues/30462)が解決されます。[#30011](https://github.com/ClickHouse/ClickHouse/pull/30011) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 特定の関数を簡単にファジングするための関数`getFuzzerData()`を追加しました。これにより[#23227](https://github.com/ClickHouse/ClickHouse/issues/23227)が解決されます。[#27526](https://github.com/ClickHouse/ClickHouse/pull/27526) ([Alexey Boykov](https://github.com/mathalex))。
- Docker内でのケーパビリティ設定をより正確にしました。[#31802](https://github.com/ClickHouse/ClickHouse/pull/31802) ([Constantine Peresypkin](https://github.com/pkit))。
- clangの`-fstrict-vtable-pointers`、`-fwhole-program-vtables`コンパイルオプションを有効にしました。[#20151](https://github.com/ClickHouse/ClickHouse/pull/20151) ([Maksim Kita](https://github.com/kitaisreal))。
- FreeBSD向けクロスコンパイル用のツールチェーンtarballのダウンロードを回避しました。[#31672](https://github.com/ClickHouse/ClickHouse/pull/31672) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- risc-vの初期サポート。注意点とテスト済みのビルドコマンドについてはdevelopment/build-cross-riscvを参照してください。[#31309](https://github.com/ClickHouse/ClickHouse/pull/31309) ([Vladimir Smirnov](https://github.com/Civil))。
- パラメータ「-DENABLE_TESTS=OFF」を使用したarmマシンでのコンパイルをサポートしました。[#31007](https://github.com/ClickHouse/ClickHouse/pull/31007) ([zhanghuajie](https://github.com/zhanghuajieHIT))。

### ClickHouseリリース v21.11, 2021-11-09 {#clickhouse-release-v2111-2021-11-09}

#### 後方互換性のない変更 {#backward-incompatible-change-1}


- SQL/JSON関数における json_path と json 引数の順序を変更しました（標準との整合性を保つため）。[#30449](https://github.com/ClickHouse/ClickHouse/issues/30449) をクローズします。[#30474](https://github.com/ClickHouse/ClickHouse/pull/30474) ([Kseniia Sumarokova](https://github.com/kssenii))。
- `MergeTree` テーブル設定 `write_final_mark` を削除しました。今後は常に `true` になります。[#30455](https://github.com/ClickHouse/ClickHouse/pull/30455) ([Kseniia Sumarokova](https://github.com/kssenii))。対応は不要です。すべてのテーブルは新バージョンと互換性があります。
- 関数 `bayesAB` を削除しました。この関数を刷新して復活させるためのご協力をお願いします。[#26233](https://github.com/ClickHouse/ClickHouse/issues/26233) をクローズします。[#29934](https://github.com/ClickHouse/ClickHouse/pull/29934) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- これは、実験的な `clickhouse-keeper` サポートをすでに使用している場合にのみ関連します。ClickHouse Keeper のスナップショットは、カスタム ClickHouse LZ4 ブロック圧縮の代わりに、デフォルトで `ZSTD` コーデックで圧縮されるようになりました。この動作は `compress_snapshots_with_zstd_format` 調整設定で無効にできます（すべてのクォーラムレプリカで同じ値である必要があります）。後方互換性の問題が発生することは非常にまれで、新しいノードが ZSTD 形式のスナップショットを読み取れない古いノードにスナップショットを送信する場合（リカバリ時に発生）にのみ発生する可能性があります。[#29417](https://github.com/ClickHouse/ClickHouse/pull/29417) ([alesapin](https://github.com/alesapin))。

#### 新機能 {#new-feature-1}


* 新しい非同期 `INSERT` モードにより、挿入されたデータを蓄積し、バックグラウンドで単一のバッチとして保存できるようになりました。クライアント側では、クエリ内にインライン化されたデータ、または別のバッファ内のデータ（例: HTTP プロトコル経由の `INSERT` クエリ）を伴う `INSERT` クエリに対して `async_insert` を設定することで有効にできます。`wait_for_async_insert` が true（デフォルト）である場合、クライアントはデータがテーブルにフラッシュされるまで待機します。サーバー側では、設定項目 `async_insert_threads`、`async_insert_max_data_size`、`async_insert_busy_timeout_ms` によって制御されます。[#18282](https://github.com/ClickHouse/ClickHouse/issues/18282) を実装しています。[#27537](https://github.com/ClickHouse/ClickHouse/pull/27537)（[Anton Popov](https://github.com/CurtizJ)）。[#20557](https://github.com/ClickHouse/ClickHouse/pull/20557)（[Ivan](https://github.com/abyss7)）。パフォーマンスに関する注意: 非同期挿入を使用すると、1 秒あたり最大およそ 10,000 件の個別の `INSERT` クエリを実行できます。そのため、1 秒あたり数百万行の挿入パフォーマンスを達成したい場合は、依然としてバッチで挿入することが推奨されます。
* `clickhouse-local` にインタラクティブモードを追加しました。これにより、サーバーに接続することなく `clickhouse-local` を実行するだけで、コマンドラインの ClickHouse インターフェイスを利用し、ファイルや外部データソースからデータを処理できるようになります。また、`clickhouse-client` と `clickhouse-local` のコードを統合しました。[#7203](https://github.com/ClickHouse/ClickHouse/issues/7203) をクローズ。[#25516](https://github.com/ClickHouse/ClickHouse/issues/25516) をクローズ。[#22401](https://github.com/ClickHouse/ClickHouse/issues/22401) をクローズ。[#26231](https://github.com/ClickHouse/ClickHouse/pull/26231)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 実行可能（スクリプト可能）なユーザー定義関数のサポートを追加しました。これらは任意のプログラミング言語で記述できる UDF です。 [#28803](https://github.com/ClickHouse/ClickHouse/pull/28803) ([Maksim Kita](https://github.com/kitaisreal))。
* 外部データソースへの事前定義済み接続を許可します。これにより、外部データソースを使用する際に認証情報やアドレスを指定する必要がなくなり、代わりに名前で参照できるようになります。[#28367](https://github.com/ClickHouse/ClickHouse/issues/28367) をクローズします。 [#28577](https://github.com/ClickHouse/ClickHouse/pull/28577) ([Kseniia Sumarokova](https://github.com/kssenii))。
* `system` データベース内の対応するテーブルに対する `SCHEMATA`、`TABLES`、`VIEWS`、`COLUMNS` ビューを備えた `INFORMATION_SCHEMA` データベースを追加しました。[#9770](https://github.com/ClickHouse/ClickHouse/issues/9770) をクローズ。[#28691](https://github.com/ClickHouse/ClickHouse/pull/28691)（[tavplubix](https://github.com/tavplubix)）。
* `EXISTS (subquery)` をサポート。[#6852](https://github.com/ClickHouse/ClickHouse/issues/6852) をクローズ。[#29731](https://github.com/ClickHouse/ClickHouse/pull/29731)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 監査用のセッションログ。新しい `system.session_log` テーブルに、すべてのログインおよびログアウトの成功・失敗イベントを記録します。 [#22415](https://github.com/ClickHouse/ClickHouse/pull/22415) ([Vasily Nemkov](https://github.com/Enmk)) ([Vitaly Baranov](https://github.com/vitlibar)).
* 多次元の cosine 距離および euclidean 距離関数、L1、L2、Lp、Linf の距離とノルムをサポートしました。タプル上でのスカラー積およびタプルに対する各種算術演算子をサポートしました。これにより [#4509](https://github.com/ClickHouse/ClickHouse/issues/4509) は完全にクローズされ、さらに多くの機能も追加されています。 [#27933](https://github.com/ClickHouse/ClickHouse/pull/27933) ([Alexey Boykov](https://github.com/mathalex)).
* `INTO OUTFILE` および `FROM INFILE` に、（自動検出または追加のオプション引数による）圧縮および解凍のサポートを追加しました。 [#27135](https://github.com/ClickHouse/ClickHouse/pull/27135) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* HTTP `OPTIONS` リクエストによる CORS（Cross Origin Resource Sharing）サポートを追加しました。これにより、Grafana は回避的な手段に頼ることなく、サーバーレスリクエストで動作するようになりました。[#18693](https://github.com/ClickHouse/ClickHouse/issues/18693) をクローズ。 [#29155](https://github.com/ClickHouse/ClickHouse/pull/29155) ([Filatenkov Artur](https://github.com/FArthur-cmd))。
* `JOIN ON` を用いたクエリで、選言（`OR`）がサポートされるようになりました。 [#21320](https://github.com/ClickHouse/ClickHouse/pull/21320) ([Ilya Golshtein](https://github.com/ilejn))。
* 関数 `tokens` を追加しました。英数字以外の ASCII 文字を区切りとして使用して文字列をトークンに分割できます。 [#29981](https://github.com/ClickHouse/ClickHouse/pull/29981) ([Maksim Kita](https://github.com/kitaisreal))。テキストから n-gram を抽出する関数 `ngrams` を追加しました。 [#29699](https://github.com/ClickHouse/ClickHouse/issues/29699) をクローズしました。 [#29738](https://github.com/ClickHouse/ClickHouse/pull/29738) ([Maksim Kita](https://github.com/kitaisreal))。
* Unicode 正規化用の関数 `normalizeUTF8NFC`、`normalizeUTF8NFD`、`normalizeUTF8NFKC`、`normalizeUTF8NFKD` を追加。 [#28633](https://github.com/ClickHouse/ClickHouse/pull/28633) ([darkkeks](https://github.com/darkkeks)).
* ClickHouse で `FileLog` テーブルエンジンを用いてアプリケーションのログファイルをストリーミング消費できるようにしました。ローカルファイルシステム上の追記専用かつローテーションされるログ向けの、`Kafka` や `RabbitMQ` エンジンに相当するエンジンです。[#6953](https://github.com/ClickHouse/ClickHouse/issues/6953) をクローズしました。[#25969](https://github.com/ClickHouse/ClickHouse/pull/25969)（[flynn](https://github.com/ucasfl)）（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `CapnProto` 出力フォーマットを追加し、`CapnProto` 入力フォーマットをリファクタリング。 [#29291](https://github.com/ClickHouse/ClickHouse/pull/29291) ([Kruglov Pavel](https://github.com/Avogar)).
* クエリ内で数値をバイナリリテラルとして記述できるようにしました。例: `SELECT 0b001;`。 [#29304](https://github.com/ClickHouse/ClickHouse/pull/29304)（[Maksim Kita](https://github.com/kitaisreal)）。
* `hashed_array` 辞書型を追加しました。これは、複数属性を持つ辞書を使用する場合にメモリ使用量を削減します。[#30236](https://github.com/ClickHouse/ClickHouse/issues/30236) をクローズ。[#30242](https://github.com/ClickHouse/ClickHouse/pull/30242)（[Maksim Kita](https://github.com/kitaisreal)）。
* `JSONExtractKeys` 関数を追加しました。 [#30056](https://github.com/ClickHouse/ClickHouse/pull/30056) ([Vitaly](https://github.com/orloffv))。
* `getOSKernelVersion` 関数を追加しました。OS カーネルバージョンの文字列を返します。 [#29755](https://github.com/ClickHouse/ClickHouse/pull/29755) ([Memo](https://github.com/Joeywzr)).
* `MD4` と `SHA384` 関数を追加しました。`MD4` は古く、安全ではないハッシュ関数であり、一部のレガシーシステムですでに `MD4` が使用されていて、まったく同じ結果を得る必要があるという稀なケースでのみ使用できます。 [#29602](https://github.com/ClickHouse/ClickHouse/pull/29602) ([Nikita Tikhomirov](https://github.com/NSTikhomirov)).
* 設定ファイルで `hsts_max_age` に正の値を設定することで、ClickHouse の HTTP サーバーで HSTS を有効化できます。 [#29516](https://github.com/ClickHouse/ClickHouse/pull/29516) ([凌涛](https://github.com/lingtaolf))。
* Huawei OBS ストレージをサポート。[#24294](https://github.com/ClickHouse/ClickHouse/issues/24294) をクローズ。[#29511](https://github.com/ClickHouse/ClickHouse/pull/29511)（[kevin wan](https://github.com/MaxWk)）。
* キーが単純な正規表現にマッチする要素を含むかどうかを判定するための新しい関数 `mapContainsKeyLike` を追加しました。 [#29471](https://github.com/ClickHouse/ClickHouse/pull/29471) ([凌涛](https://github.com/lingtaolf))。指定されたパターンにマッチした要素のみを保持するマップを取得する新しい関数 `mapExtractKeyLike` を追加しました。 [#30793](https://github.com/ClickHouse/ClickHouse/pull/30793) ([凌涛](https://github.com/lingtaolf))。
* `ALTER TABLE x MODIFY COMMENT` を実装しました。 [#29264](https://github.com/ClickHouse/ClickHouse/pull/29264) ([Vasily Nemkov](https://github.com/Enmk))。
* ClickHouse には存在しないが H3 API では利用可能な H3 のインスペクション関数を追加します: [https://h3geo.org/docs/api/inspection](https://h3geo.org/docs/api/inspection)。 [#29209](https://github.com/ClickHouse/ClickHouse/pull/29209) ([Bharat Nallan](https://github.com/bharatnc))。
* レプリケーテッドデータベースで、レプリケーションされていない ALTER TABLE FETCH および ATTACH を許可。 [#29202](https://github.com/ClickHouse/ClickHouse/pull/29202) ([Kevin Michel](https://github.com/kmichel-aiven)).
* `output_format_csv_null_representation` 設定を追加しました。これは `output_format_tsv_null_representation` と同様の設定ですが、CSV 出力用です。 [#29123](https://github.com/ClickHouse/ClickHouse/pull/29123) ([PHO](https://github.com/depressed-pho))。
* 現在の ZooKeeper セッションの稼働時間（秒）を返す関数 `zookeeperSessionUptime()` を追加しました。 [#28983](https://github.com/ClickHouse/ClickHouse/pull/28983) ([tavplubix](https://github.com/tavplubix))。
* `h3ToGeoBoundary` 関数を実装。 [#28952](https://github.com/ClickHouse/ClickHouse/pull/28952) ([Ivan Veselov](https://github.com/fuzzERot))。
* ウィンドウ関数として使用できる集約関数 `exponentialMovingAverage` を追加しました。これにより [#27511](https://github.com/ClickHouse/ClickHouse/issues/27511) がクローズされます。[#28914](https://github.com/ClickHouse/ClickHouse/pull/28914)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* テーブル列のサブカラムを `DESCRIBE` クエリ結果に含められるようにしました（`describe_include_subcolumns` を設定することで有効化できます）。 [#28905](https://github.com/ClickHouse/ClickHouse/pull/28905) ([Anton Popov](https://github.com/CurtizJ)).
* `Executable`、`ExecutablePool` にオプション `send_chunk_header` が追加されました。このオプションが true の場合、チャンクの送信前に、そのチャンクの行数（rows&#95;count）と改行がクライアントに送信されます。 [#28833](https://github.com/ClickHouse/ClickHouse/pull/28833) ([Maksim Kita](https://github.com/kitaisreal)).
* `tokenbf_v1` および `ngram` は、キーが String または FixedString 型の Map をサポートします。これにより、マップキーでフィルタするクエリにおけるデータスキップが強化されます。`sql CREATE TABLE map_tokenbf ( row_id UInt32, map Map(String, String), INDEX map_tokenbf map TYPE ngrambf_v1(4,256,2,0) GRANULARITY 1 ) Engine=MergeTree() ORDER BY id ` 上記のテーブルに対して、クエリ `SELECT * FROM map_tokenbf WHERE map['K'] = 'V'` を実行すると、キー `K` を含まないグラニュールはスキップされます。もちろん、スキップされる行数は、設定した `granularity` と `index_granularity` に依存します。[#28511](https://github.com/ClickHouse/ClickHouse/pull/28511) ([凌涛](https://github.com/lingtaolf))。
* サーバーからクライアントへプロファイルイベントを送信できるようにしました。新しいパケットタイプ `ProfileEvents` を導入しました。[#26177](https://github.com/ClickHouse/ClickHouse/issues/26177) をクローズ。[#28364](https://github.com/ClickHouse/ClickHouse/pull/28364)（[Dmitry Novik](https://github.com/novikd)）。
* `FixedString` および `String` データ型に対するビットシフト演算。これにより [#27763](https://github.com/ClickHouse/ClickHouse/issues/27763) がクローズされました。[#28325](https://github.com/ClickHouse/ClickHouse/pull/28325)（[小路](https://github.com/nicelulu)）。
* データベースエンジン MaterializedPostgreSQL において、PostgreSQL からレプリケーションするテーブルの動的な追加・削除をサポート。データベース設定に対する ALTER をサポート。[#27573](https://github.com/ClickHouse/ClickHouse/issues/27573) をクローズ。[#28301](https://github.com/ClickHouse/ClickHouse/pull/28301)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 関数 accurateCastOrDefault(x, T) を追加しました。 [#21330](https://github.com/ClickHouse/ClickHouse/issues/21330) をクローズしました。作者 @taiyang-li。 [#23028](https://github.com/ClickHouse/ClickHouse/pull/23028)（[Maksim Kita](https://github.com/kitaisreal)）。
* 文字列のパースに失敗した場合に、ユーザーがデフォルト値（NULL 以外）を指定できるようにする `toUUIDOrDefault`、`toUInt8/16/32/64/256OrDefault`、`toInt8/16/32/64/128/256OrDefault` 関数を追加しました。 [#21330](https://github.com/ClickHouse/ClickHouse/pull/21330) ([taiyang-li](https://github.com/taiyang-li)).

#### パフォーマンスの向上 {#performance-improvement-1}


* バックグラウンドマージは互いにプリエンプト可能で、適切な優先度でスケジューリングされます。これにより、長時間実行されるマージが、短時間で完了するマージの実行を妨げることはなくなりました。これは、マージ処理のスケジューリングと制御を改善するために必要な変更です。この結果、&quot;too many parts&quot; エラーが発生する可能性が低くなります。 [#22381](https://github.com/ClickHouse/ClickHouse/issues/22381)。 [#25165](https://github.com/ClickHouse/ClickHouse/pull/25165)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。バックグラウンドプール内のスレッド数を超える数のマージおよびミューテーションを実行できるようになりました。マージとミューテーションは、そのサイズに応じて（小さいものほど優先度が高く）段階的に実行されます。実行対象となるタスク数とスレッド数の比率は、設定 `background_merges_mutations_concurrency_ratio` によって制御され、デフォルト値は 2 です。 [#29140](https://github.com/ClickHouse/ClickHouse/pull/29140)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* リモートファイルシステムで非同期読み取りを使用できるようにしました。リモートファイルシステムからの読み取り時のシーク回数を減らします。これによりパフォーマンスが大幅に向上し、実験的機能だった `web` および `s3` ディスクが、特定の条件下では EBS よりも高速に動作するようになりました。 [#29205](https://github.com/ClickHouse/ClickHouse/pull/29205) ([Kseniia Sumarokova](https://github.com/kssenii))。同時に、`web` ディスクタイプ（Web サーバー上でホストされる静的データセット）は実験的ステータスを卒業し、本番利用可能なステータスとなりました。
* `clickhouse-client` での `INTO OUTFILE` を伴うクエリがマルチスレッドで実行されるようになりました。`INTO OUTFILE` 使用時にプログレスバーがちらつく問題を修正しました。これにより [#30873](https://github.com/ClickHouse/ClickHouse/issues/30873) がクローズされます。また、[#30872](https://github.com/ClickHouse/ClickHouse/issues/30872) もクローズされます。 [#30886](https://github.com/ClickHouse/ClickHouse/pull/30886) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 一部の種類の `SELECT` クエリに対して、ディスクから読み込む冗長な圧縮データ量を削減しました（`MergeTree` エンジンファミリーのみ）。 [#30111](https://github.com/ClickHouse/ClickHouse/pull/30111) ([alesapin](https://github.com/alesapin))。
* MergeTree テーブルエンジンファミリーで圧縮ブロックを読み込む際の冗長な `seek` 呼び出しの一部を削除しました。 [#29766](https://github.com/ClickHouse/ClickHouse/pull/29766) ([alesapin](https://github.com/alesapin)).
* `url` テーブル関数で複数の URL を並列処理できるようにしました。これにより [#29670](https://github.com/ClickHouse/ClickHouse/issues/29670) と [#29671](https://github.com/ClickHouse/ClickHouse/issues/29671) がクローズされました。 [#29673](https://github.com/ClickHouse/ClickHouse/pull/29673)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 主キー順序での集約パフォーマンスを向上しました（設定 `optimize_aggregation_in_order` が有効な場合）。[#30266](https://github.com/ClickHouse/ClickHouse/pull/30266)（[Anton Popov](https://github.com/CurtizJ)）。
* 現在、ClickHouse は外部の S3 と通信する際に DNS キャッシュを利用するようになりました。 [#29999](https://github.com/ClickHouse/ClickHouse/pull/29999) ([alesapin](https://github.com/alesapin)).
* 外部データベース（例: MySQL）への `IS NULL` / `IS NOT NULL` のプッシュダウンをサポートしました。[#29463](https://github.com/ClickHouse/ClickHouse/pull/29463)（[Azat Khuzhin](https://github.com/azat)）。`isNull` / `isNotNull` を（MySQL などの）外部データベース向けに `IS NULL` / `IS NOT NULL` へ変換するようにしました。[#29446](https://github.com/ClickHouse/ClickHouse/pull/29446)（[Azat Khuzhin](https://github.com/azat)）。
* Dictionary テーブルに対する SELECT クエリで複数スレッドが使用されるようになりました。 [#30500](https://github.com/ClickHouse/ClickHouse/pull/30500) ([Maksim Kita](https://github.com/kitaisreal)).
* `Decimal` 列に対するフィルタリング（`WHERE` 演算）のパフォーマンスを向上。 [#30431](https://github.com/ClickHouse/ClickHouse/pull/30431) ([Jun Jin](https://github.com/vesslanjin)).
* `popcnt`/`ctz` を用いた、より高性能な実装に置き換えることで、`filter` 演算における分岐の多いコードを削除しました。 [#29881](https://github.com/ClickHouse/ClickHouse/pull/29881) ([Jun Jin](https://github.com/vesslanjin))。
* WHERE 演算子で使用されるフィルター用 bytemask ジェネレーター関数を、SSE/AVX2/AVX512 命令をひとつにまとめて利用する形に改良しました。なお、デフォルトの ClickHouse では SSE のみを使用しているため、これはカスタムビルドでのみ有効です。 [#30014](https://github.com/ClickHouse/ClickHouse/pull/30014) ([jasperzhu](https://github.com/jinjunzh)). [#30670](https://github.com/ClickHouse/ClickHouse/pull/30670) ([jasperzhu](https://github.com/jinjunzh)).
* Nullable 浮動小数点数に対する SUM 集約関数のパフォーマンスを向上。 [#28906](https://github.com/ClickHouse/ClickHouse/pull/28906) ([Raúl Marín](https://github.com/Algunenano)).
* 複数のディスクを使用している場合のパート読み込み処理を高速化しました。このアイデアは [https://github.com/ClickHouse/ClickHouse/pull/16423](https://github.com/ClickHouse/ClickHouse/pull/16423) と同様です。本番環境では、24 分から 16 分への短縮が確認されています。 [#28363](https://github.com/ClickHouse/ClickHouse/pull/28363)（[Amos Bird](https://github.com/amosbird)）。
* S3 マルチパートアップロードのパートサイズに関するデフォルト設定を小さくし、メモリ使用量を削減しました。 [#28679](https://github.com/ClickHouse/ClickHouse/pull/28679) ([ianton-ru](https://github.com/ianton-ru)).
* `bitmapAnd` 関数を高速化。 [#28332](https://github.com/ClickHouse/ClickHouse/pull/28332) ([dddounaiking](https://github.com/OodounaikingoO)).
* マージ処理が進行中の際に `StorageMergeTree` で発生していた、最適ではないミューテーション通知を削除しました。 [#27552](https://github.com/ClickHouse/ClickHouse/pull/27552) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 文字列比較のパフォーマンスを改善しました。 [#28767](https://github.com/ClickHouse/ClickHouse/pull/28767) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* プライマリキーインデックスとパーティションフィルタがタプルで動作できるようになりました。 [#29281](https://github.com/ClickHouse/ClickHouse/pull/29281) ([凌涛](https://github.com/lingtaolf)).
* クエリに、同じ引数だが異なるレベルパラメータを持つ複数の quantile 集約関数が含まれている場合、設定 `optimize_syntax_fuse_functions` が有効になっていれば、それらはまとめて 1 回のパスで実行されます。 [#26657](https://github.com/ClickHouse/ClickHouse/pull/26657) ([hexiaoting](https://github.com/hexiaoting)).
* 主キーの先頭の式に対する min-max 集約が、プロジェクションによって最適化されるようになりました。これは [#329](https://github.com/ClickHouse/ClickHouse/issues/329) への対応です。[#29918](https://github.com/ClickHouse/ClickHouse/pull/29918)（[Amos Bird](https://github.com/amosbird)）。

#### 実験的機能 {#experimental-feature-1}

- ClickHouse Keeperのノード設定（`.xml`ファイル）を変更する機能を追加しました。[#30372](https://github.com/ClickHouse/ClickHouse/pull/30372) ([alesapin](https://github.com/alesapin))。
- `sparkbar`集約関数を追加しました。これにより[#26175](https://github.com/ClickHouse/ClickHouse/issues/26175)が解決されます。[#27481](https://github.com/ClickHouse/ClickHouse/pull/27481) ([小路](https://github.com/nicelulu))。注意：この関数には1つの不具合があり、将来のリリースで動作が変更される予定です。

#### 改善 {#improvement-1}


* 再起動せずにユーザーがログレベルを変更できるようにしました。 [#29586](https://github.com/ClickHouse/ClickHouse/pull/29586) ([Nikolay Degterinsky](https://github.com/evillique)).
* SQL UDF の複数の改善。SQL ユーザー定義関数を操作するクエリで、`ON CLUSTER` 句がサポートされました。例: `CREATE FUNCTION test_function ON CLUSTER 'cluster' AS x -> x + 1;`。[#30666](https://github.com/ClickHouse/ClickHouse/issues/30666) をクローズ。[#30734](https://github.com/ClickHouse/ClickHouse/pull/30734)（[Maksim Kita](https://github.com/kitaisreal)）。`CREATE OR REPLACE`、`CREATE IF NOT EXISTS` 構文をサポート。[#30454](https://github.com/ClickHouse/ClickHouse/pull/30454)（[Maksim Kita](https://github.com/kitaisreal)）。`DROP IF EXISTS` をサポートしました。例: `DROP FUNCTION IF EXISTS test_function`。[#30437](https://github.com/ClickHouse/ClickHouse/pull/30437)（[Maksim Kita](https://github.com/kitaisreal)）。ラムダ式をサポート。例: `CREATE FUNCTION lambda_function AS x -> arrayMap(element -> element * 2, x);`。[#30435](https://github.com/ClickHouse/ClickHouse/pull/30435)（[Maksim Kita](https://github.com/kitaisreal)）。`clickhouse-local` での SQL ユーザー定義関数をサポート。[#30179](https://github.com/ClickHouse/ClickHouse/pull/30179)（[Maksim Kita](https://github.com/kitaisreal)）。
* クエリごとのメモリプロファイラをグローバルに有効化し、`memory_profiler_step` を 4MiB に設定しました。[#29455](https://github.com/ClickHouse/ClickHouse/pull/29455)（[Azat Khuzhin](https://github.com/azat)）。
* `system.data_skipping_indices` に `data_compressed_bytes`、`data_uncompressed_bytes`、`marks_bytes` カラムを追加しました。`system.parts` に `secondary_indices_compressed_bytes`、`secondary_indices_uncompressed_bytes`、`secondary_indices_marks_bytes` カラムを追加しました。[#29697](https://github.com/ClickHouse/ClickHouse/issues/29697) をクローズしました。 [#29896](https://github.com/ClickHouse/ClickHouse/pull/29896) ([Maksim Kita](https://github.com/kitaisreal)).
* `system.tables` に `table` エイリアスを追加し、`system.databases` に `database` エイリアスを追加 [#29677](https://github.com/ClickHouse/ClickHouse/issues/29677)。 [#29882](https://github.com/ClickHouse/ClickHouse/pull/29882)（[kevin wan](https://github.com/MaxWk)）。
* サーバー起動時にテーブル間の相互依存関係を正しく解決するようにしました。[#8004](https://github.com/ClickHouse/ClickHouse/issues/8004) をクローズし、[#15170](https://github.com/ClickHouse/ClickHouse/issues/15170) をクローズしました。[#28373](https://github.com/ClickHouse/ClickHouse/pull/28373)（[tavplubix](https://github.com/tavplubix)）。
* `divide`、`intDiv`、`modulo` 関数において、分母が Nullable の場合に発生する &quot;Division by zero&quot; エラーを回避しました。[#22621](https://github.com/ClickHouse/ClickHouse/issues/22621) をクローズ。 [#28352](https://github.com/ClickHouse/ClickHouse/pull/28352)（[Kruglov Pavel](https://github.com/Avogar)）。
* `Date` データ型の値をテキスト形式で、`YYYY-MM-DD` に加えて `YYYYMMDD` としてもパースできるようにしました。これにより [#30870](https://github.com/ClickHouse/ClickHouse/issues/30870) がクローズされました。 [#30871](https://github.com/ClickHouse/ClickHouse/pull/30871) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* Web UI: テーブルセル内にバーを表示。 [#29792](https://github.com/ClickHouse/ClickHouse/pull/29792) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* ユーザーは、次のようにコメント付きで辞書を作成できるようになりました: `CREATE DICTIONARY ... COMMENT 'vaue'` ... [#29899](https://github.com/ClickHouse/ClickHouse/pull/29899) ([Vasily Nemkov](https://github.com/Enmk))。また、`CREATE DATABASE` ステートメントでデータベースにコメントを設定できるようにもなりました ... [#29429](https://github.com/ClickHouse/ClickHouse/pull/29429) ([Vasily Nemkov](https://github.com/Enmk))。
* `compiled_expression_cache_elements_size` 設定を導入しました。この設定を使いたいと思う頃には、すでにその役割について理解しているはずです。 [#30667](https://github.com/ClickHouse/ClickHouse/pull/30667) ([Maksim Kita](https://github.com/kitaisreal)).
* clickhouse-format が `--query` オプションをサポートするようになりました。以前のバージョンでは、クエリを stdin に渡す必要がありました。 [#29325](https://github.com/ClickHouse/ClickHouse/pull/29325) ([凌涛](https://github.com/lingtaolf))。
* `Memory` データベース内のテーブルに対する `ALTER TABLE` をサポートします。`Memory` データベースは `clickhouse-local` で使用されます。 [#30866](https://github.com/ClickHouse/ClickHouse/pull/30866) ([tavplubix](https://github.com/tavplubix)).
* `arrayStringConcat` で、シリアライズ可能なすべての型の配列がサポートされるようになりました。 [#30840](https://github.com/ClickHouse/ClickHouse/pull/30840) ([Nickita Taranov](https://github.com/nickitat)).
* ClickHouse は、システムメモリ量を取得する際に Docker/cgroups の制限を考慮するようになりました。[#25662](https://github.com/ClickHouse/ClickHouse/issues/25662) を参照。[#30574](https://github.com/ClickHouse/ClickHouse/pull/30574)（[Pavel Medvedev](https://github.com/pmed)）。
* PostgreSQL データベースから取得されるテーブル構造が、以前よりも信頼性の高いものになりました。 [#30477](https://github.com/ClickHouse/ClickHouse/pull/30477) ([Kseniia Sumarokova](https://github.com/kssenii)).
* GROUP BY および ORDER BY における位置指定引数の完全サポート。 [#30433](https://github.com/ClickHouse/ClickHouse/pull/30433) ([Kseniia Sumarokova](https://github.com/kssenii)).
* JSONExtractString を使用して、非文字列要素を文字列として抽出できるようにしました。これは [pull/25452#issuecomment-927123287](https://github.com/ClickHouse/ClickHouse/pull/25452#issuecomment-927123287) への対応です。 [#30426](https://github.com/ClickHouse/ClickHouse/pull/30426) ([Amos Bird](https://github.com/amosbird)).
* `GraphiteMergeTree` からの `SELECT` クエリで `FINAL` 句を使用できるようになりました。 [#30360](https://github.com/ClickHouse/ClickHouse/pull/30360) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* レプリカのクローン処理および破損したパーツに対するフェッチのキュー投入に対して細かな改善を行い、レプリケーションキュー内の `GET_PART` エントリが極めてまれなケースでハングする問題を回避できるようにしました。 [#30346](https://github.com/ClickHouse/ClickHouse/pull/30346) ([tavplubix](https://github.com/tavplubix)).
* `user_files` ディレクトリ内のファイルに対するシンボリックリンクを、file テーブル関数で使用できるようにしました。 [#30309](https://github.com/ClickHouse/ClickHouse/pull/30309) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `Date32` と `Date`、`DateTime`、`DateTime64`、`String` との比較を修正しました。 [#30219](https://github.com/ClickHouse/ClickHouse/pull/30219) ([liang.huang](https://github.com/lhuang09287750)).
* `MergeTree` テーブルから `SAMPLE BY` 式を削除できるようになりました（`ALTER TABLE <table> REMOVE SAMPLE BY`）。[#30180](https://github.com/ClickHouse/ClickHouse/pull/30180)（[Anton Popov](https://github.com/CurtizJ)）。
* 現在、`Keeper`（`clickhouse-server` の一部）は、他のノードのいずれかに接続できる場合、非同期で起動するようになりました。 [#30170](https://github.com/ClickHouse/ClickHouse/pull/30170) ([alesapin](https://github.com/alesapin)).
* `clickhouse-client` がネイティブの複数行編集に対応しました。 [#30143](https://github.com/ClickHouse/ClickHouse/pull/30143) ([Amos Bird](https://github.com/amosbird))。
* `polygon` 辞書（リバースジオコーディング）：設定 `store_polygon_key_column` = true の場合に、SELECT クエリ方式で辞書の内容を読み取れるようになりました。[#30090](https://github.com/ClickHouse/ClickHouse/issues/30090) をクローズ。[#30142](https://github.com/ClickHouse/ClickHouse/pull/30142)（[Maksim Kita](https://github.com/kitaisreal)）。
* Play UI に ClickHouse ロゴを追加。[#29674](https://github.com/ClickHouse/ClickHouse/pull/29674)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `Arrow`、`ArrowStream`、`Parquet`、`ORC` などの Arrow 対応形式からカラムを読み込む際の例外メッセージを改善しました。これにより [#29926](https://github.com/ClickHouse/ClickHouse/issues/29926) がクローズされました。 [#29927](https://github.com/ClickHouse/ClickHouse/pull/29927) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `Buffer` テーブルにおけるフラッシュ処理と起動処理の間のデータレースを修正。これはテストで発生する可能性があります。 [#29930](https://github.com/ClickHouse/ClickHouse/pull/29930) ([Azat Khuzhin](https://github.com/azat))。
* `DatabaseMemory` と `LiveView` の `DROP TABLE` 間の `lock-order-inversion` を修正しました。Live View は実験的な機能です。Memory データベースは clickhouse-local で使用されます。[#29929](https://github.com/ClickHouse/ClickHouse/pull/29929) ([Azat Khuzhin](https://github.com/azat))。
* 定期的な辞書の再読み込みと設定の再読み込みとの間のロック順序の逆転を修正。 [#29928](https://github.com/ClickHouse/ClickHouse/pull/29928) ([Azat Khuzhin](https://github.com/azat)).
* zoneinfo ファイルを 2021c に更新。 [#29925](https://github.com/ClickHouse/ClickHouse/pull/29925) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `clickhouse-copier` に対して、リトライ回数およびリトライ間の遅延を設定可能にした。 [#29921](https://github.com/ClickHouse/ClickHouse/pull/29921) ([Azat Khuzhin](https://github.com/azat)).
* `shutdown_wait_unfinished_queries` サーバー設定を追加し、実行中のクエリを `shutdown_wait_unfinished` で指定された時間まで待機できるようにしました。これは [#24451](https://github.com/ClickHouse/ClickHouse/issues/24451) に対応するものです。[#29914](https://github.com/ClickHouse/ClickHouse/pull/29914)（[Amos Bird](https://github.com/amosbird)）。
* ピークメモリ使用量をトレースできるようにしました（`system.trace_log` に新しい `trace_type` `MemoryPeak` を追加）。 [#29858](https://github.com/ClickHouse/ClickHouse/pull/29858) ([Azat Khuzhin](https://github.com/azat)).
* PostgreSQL 外部テーブル: レプリカ識別インデックスを取得するクエリに、パーティションテーブルを表すプレフィックス &#39;p&#39; を追加しました。 [#29828](https://github.com/ClickHouse/ClickHouse/pull/29828) ([Shoh Jahon](https://github.com/Shohjahon)).
* mutate/merge の実行時に `max_untracked_memory` / `memory_profiler_step` / `memory_profiler_sample_probability` を適用し、マージ処理中のメモリ使用量をプロファイリングできるようにしました。 [#29681](https://github.com/ClickHouse/ClickHouse/pull/29681) ([Azat Khuzhin](https://github.com/azat)).
* クエリ難読化ツール: `clickhouse-format --obfuscate` が、より多くの種類のクエリをサポートするようになりました。 [#29672](https://github.com/ClickHouse/ClickHouse/pull/29672) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 問題の修正: `clickhouse-format --obfuscate` が埋め込みディクショナリ（`regionTo...` 関数）を含むクエリを処理できない不具合を修正しました。 [#29667](https://github.com/ClickHouse/ClickHouse/pull/29667) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* JSON 関数における Nullable の誤った処理を修正しました。これにより [#29615](https://github.com/ClickHouse/ClickHouse/issues/29615) が修正されます。[https://github.com/ClickHouse/ClickHouse/pull/28012](https://github.com/ClickHouse/ClickHouse/pull/28012) がまだリリースされていないため、改善としてマークします。[#29659](https://github.com/ClickHouse/ClickHouse/pull/29659)（[Amos Bird](https://github.com/amosbird)）。
* デフォルトの `listen_backlog` を増やしました（新しい Linux カーネルのデフォルトに合わせるため）。[#29643](https://github.com/ClickHouse/ClickHouse/pull/29643) ([Azat Khuzhin](https://github.com/azat)).
* サーバー設定 `dictionaries_config`、`models_config`、`user_defined_executable_functions_config` が変更された場合に、辞書、モデル、ユーザー定義実行可能関数を再読み込みします。 [#28142](https://github.com/ClickHouse/ClickHouse/issues/28142) をクローズ。 [#29529](https://github.com/ClickHouse/ClickHouse/pull/29529) ([Maksim Kita](https://github.com/kitaisreal))。
* プロジェクション名に対する不必要な制限を撤廃しました。これにより、プロジェクション名を `tmp_` から始められるようになりました。 [#29520](https://github.com/ClickHouse/ClickHouse/pull/29520) ([Amos Bird](https://github.com/amosbird))。
* 入れ子になった副問い合わせを含むミューテーションで発生していた `There is no query or query context has expired` エラーを修正。テーブルがレプリケートされており、`allow_nondeterministic_mutations` 設定が無効な場合には、ミューテーション内で副問い合わせを許可しないようにした。 [#29495](https://github.com/ClickHouse/ClickHouse/pull/29495) ([tavplubix](https://github.com/tavplubix))。
* `max_concurrent_queries` の設定変更を、再起動なしで実行時に適用できるようにしました。[#29414](https://github.com/ClickHouse/ClickHouse/pull/29414) ([Raúl Marín](https://github.com/Algunenano)).
* 設定 `use_skip_indexes` を追加しました。 [#29405](https://github.com/ClickHouse/ClickHouse/pull/29405) ([Maksim Kita](https://github.com/kitaisreal)).
* インメモリパーツを `FREEZE`（バックアップ用）できるように対応を追加。 [#29376](https://github.com/ClickHouse/ClickHouse/pull/29376)（[Mo Xuan](https://github.com/mo-avatar)）。
* `clickhouse-benchmark` で初期の query&#95;id を引き継ぐようにしました（以前は `clickhouse-benchmark` 経由でリモートクエリを実行した場合、シャード上のクエリは `initial_query_id` によって初期クエリと関連付けられていませんでした）。 [#29364](https://github.com/ClickHouse/ClickHouse/pull/29364) ([Azat Khuzhin](https://github.com/azat)).
* スキップインデックス `tokenbf_v1` および `ngrambf_v1`: キーが `String` または `FixedString` 型の `Array` データ型をサポートしました。 [#29280](https://github.com/ClickHouse/ClickHouse/pull/29280) ([Maksim Kita](https://github.com/kitaisreal))。スキップインデックス `tokenbf_v1` および `ngrambf_v1` に、キーが `String` または `FixedString` 型の `Map` データ型のサポートを追加しました。著者 @lingtaolf。 [#29220](https://github.com/ClickHouse/ClickHouse/pull/29220) ([Maksim Kita](https://github.com/kitaisreal))。
* 関数 `has`: `Map` データ型をサポートしました。 [#29267](https://github.com/ClickHouse/ClickHouse/pull/29267) ([Maksim Kita](https://github.com/kitaisreal)).
* clickhouse-keeper 向けに `compress_logs` 設定を追加し、`ZSTD` で clickhouse-keeper のログ（replicated state machine 用）を圧縮できるようにしました。実装: [#26977](https://github.com/ClickHouse/ClickHouse/issues/26977)、[#29223](https://github.com/ClickHouse/ClickHouse/pull/29223)（[alesapin](https://github.com/alesapin)）。
* `external_table_strict_query` という設定を追加しました。これにより、互換性がない場合でも、外部データベースへのクエリに対して `WHERE` 句全体を必ず渡すようになります。 [#29206](https://github.com/ClickHouse/ClickHouse/pull/29206) ([Azat Khuzhin](https://github.com/azat))。
* `ARRAY JOIN` が使用されている場合はプロジェクションを無効にします。以前のバージョンでは、プロジェクションの解析によって ARRAY JOIN 内のエイリアスが壊れる可能性がありました。 [#29139](https://github.com/ClickHouse/ClickHouse/pull/29139) ([Amos Bird](https://github.com/amosbird))。
* `MsgPack` の入出力フォーマットで、より多くの型をサポートしました。 [#29077](https://github.com/ClickHouse/ClickHouse/pull/29077) ([Kruglov Pavel](https://github.com/Avogar)).
* `ORC` 入出力フォーマットで `LowCardinality` 列の読み書きが可能になりました。 [#29062](https://github.com/ClickHouse/ClickHouse/pull/29062) ([Kruglov Pavel](https://github.com/Avogar)).
* `system.distributed_ddl_queue` からの SELECT で誤った値が表示されることがある問題を修正しました。 [#29061](https://github.com/ClickHouse/ClickHouse/pull/29061) ([tavplubix](https://github.com/tavplubix))。
* HTTP 接続における未知のメソッドに対する正しい動作を実装しました。[#29050](https://github.com/ClickHouse/ClickHouse/issues/29050) を解決します。[#29057](https://github.com/ClickHouse/ClickHouse/pull/29057)（[Filatenkov Artur](https://github.com/FArthur-cmd)）。
* `clickhouse-keeper`: ZooKeeper のログ（スナップショットではない）から復元する際に一部のデータ損失を引き起こす可能性があった `clickhouse-keeper-converter` のバグを修正しました。 [#29030](https://github.com/ClickHouse/ClickHouse/pull/29030) ([小路](https://github.com/nicelulu)). ZooKeeper ログのデシリアライズが不正になる可能性があった `clickhouse-keeper-converter` のバグを修正しました。 [#29071](https://github.com/ClickHouse/ClickHouse/pull/29071) ([小路](https://github.com/nicelulu)).
* `CREATE ... AS SELECT` クエリから設定を適用（修正: [#28810](https://github.com/ClickHouse/ClickHouse/issues/28810)）。[#28962](https://github.com/ClickHouse/ClickHouse/pull/28962)（[Azat Khuzhin](https://github.com/azat)）。
* `ALTER TABLE ... ON CLUSTER ... REPLACE/MOVE PARTITION FROM/TO ...` において、デフォルトのデータベース設定を尊重するようになりました [#28955](https://github.com/ClickHouse/ClickHouse/pull/28955) ([anneji-dev](https://github.com/anneji-dev))。
* gRPC プロトコル: クライアントからサーバー側圧縮を変更可能に。 [#28953](https://github.com/ClickHouse/ClickHouse/pull/28953) ([Vitaly Baranov](https://github.com/vitlibar)).
* 非同期メトリクス用にサーマルセンサーを読み取る際、「データなし」例外をスキップするようにしました。これにより [#28852](https://github.com/ClickHouse/ClickHouse/issues/28852) がクローズされます。[#28882](https://github.com/ClickHouse/ClickHouse/pull/28882)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* まれな状況で既存のディクショナリに対して `Dictionary not found` エラーが発生する可能性があった論理的な競合状態を修正しました。 [#28853](https://github.com/ClickHouse/ClickHouse/pull/28853) ([tavplubix](https://github.com/tavplubix)).
* If コンビネータのチェックにおけるネストされた関数の制約を緩和（ただし同一コンビネータのネストは禁ずる）。 [#28828](https://github.com/ClickHouse/ClickHouse/pull/28828) ([Azat Khuzhin](https://github.com/azat)).
* サーバー終了時に発生しうる未捕捉例外を修正。 [#28761](https://github.com/ClickHouse/ClickHouse/pull/28761) ([Azat Khuzhin](https://github.com/azat)).
* 異常に長時間実行される `mutation` / `merge` がある場合、その `mutation` / `merge` で使用されている可能性のある `tmp` ディレクトリをクリーンアップ対象から除外します。 [#28760](https://github.com/ClickHouse/ClickHouse/pull/28760) ([Azat Khuzhin](https://github.com/azat)).
* エイリアスが使用されている場合にも、`optimize_arithmetic_operations_in_aggregate_functions = 1` 最適化を有効にできるようにしました。 [#28746](https://github.com/ClickHouse/ClickHouse/pull/28746) ([Amos Bird](https://github.com/amosbird)).
* `ReplicatedMergeTree` 向けに `detach_not_byte_identical_parts` 設定を実装し、バイト単位で同一ではないパーツ（マージ／ミューテート後）を削除するのではなく切り離すようにしました。 [#28708](https://github.com/ClickHouse/ClickHouse/pull/28708) ([Azat Khuzhin](https://github.com/azat)).
* `MergeTree` 向けに、すべての壊れたパーツの合計サイズを制限するための設定 `max_suspicious_broken_parts_bytes` を実装（デフォルトは `1GiB`）。 [#28707](https://github.com/ClickHouse/ClickHouse/pull/28707) ([Azat Khuzhin](https://github.com/azat)).
* `RabbitMQ` テーブル設定でのマクロ展開を有効化。 [#28683](https://github.com/ClickHouse/ClickHouse/pull/28683) ([Vitaly Baranov](https://github.com/vitlibar)).
* `Log` エンジンを使用するテーブルのデータを複数スレッドで読み取れるようにしました。 [#28125](https://github.com/ClickHouse/ClickHouse/pull/28125) ([Vitaly Baranov](https://github.com/vitlibar))。
* JSON 関数における NULL カラムの扱いの不正な動作を修正しました。これにより [#27930](https://github.com/ClickHouse/ClickHouse/issues/27930) が修正されます。[#28012](https://github.com/ClickHouse/ClickHouse/pull/28012)（[Amos Bird](https://github.com/amosbird)）。
* カラムとは別に、スキップインデックス用の Mark/Uncompressed キャッシュのサイズを個別に設定できるようにしました。 [#27961](https://github.com/ClickHouse/ClickHouse/pull/27961) ([Amos Bird](https://github.com/amosbird))。
* `USING` を用いる JOIN を、他の種類の JOIN と組み合わせて使用できるようにしました。 [#23881](https://github.com/ClickHouse/ClickHouse/pull/23881) ([darkkeks](https://github.com/darkkeks)).
* Yandex Cloud S3 のスロットリングに対応するため、aws-sdk サブモジュールを更新しました。 [#30646](https://github.com/ClickHouse/ClickHouse/pull/30646) ([ianton-ru](https://github.com/ianton-ru)).
* gRPC 呼び出しの処理中に、クエリ処理の終了時にクエリ ID およびセッション ID を解放する処理を修正。 [#29954](https://github.com/ClickHouse/ClickHouse/pull/29954) ([Vitaly Baranov](https://github.com/vitlibar)).
* `AccessControlManager` のシャットダウン処理を修正し、不安定なテストを解消しました。 [#29951](https://github.com/ClickHouse/ClickHouse/pull/29951) ([Vitaly Baranov](https://github.com/vitlibar)).
* `HDFS` からの読み取り時に発生していたアサーション失敗を修正しました。テストをデバッグモードで実行できるように、libhdfs3 ライブラリを更新しました。[#29251](https://github.com/ClickHouse/ClickHouse/issues/29251) をクローズ。[#27814](https://github.com/ClickHouse/ClickHouse/issues/27814) をクローズ。[#29276](https://github.com/ClickHouse/ClickHouse/pull/29276)（[Kseniia Sumarokova](https://github.com/kssenii)）。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-1}

- Aarch64マシン向けのFreeBSDビルドのサポートを追加しました。[#29952](https://github.com/ClickHouse/ClickHouse/pull/29952) ([MikaelUrankar](https://github.com/MikaelUrankar))。
- ClickHouseでは再帰的なサブモジュールが不要になりました。[#30315](https://github.com/ClickHouse/ClickHouse/pull/30315) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- ClickHouseはMuslで静的ビルドできるようになりました。これは実験的な追加であり、`odbc-bridge`、`library-bridge`のビルド、CatBoostとの統合、および一部のライブラリはサポートされていません。[#30248](https://github.com/ClickHouse/ClickHouse/pull/30248) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `AArch64`および`Darwin`(macOS)ビルドで`Protobuf`、`Arrow`、`ORC`、`Parquet`を有効化しました。これにより[#29248](https://github.com/ClickHouse/ClickHouse/issues/29248)が解決されます。これにより[#28018](https://github.com/ClickHouse/ClickHouse/issues/28018)が解決されます。[#30015](https://github.com/ClickHouse/ClickHouse/pull/30015) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- PowerPC(powerpc64le)向けのクロスビルドを追加しました。これにより[#9589](https://github.com/ClickHouse/ClickHouse/issues/9589)が解決されます。AArch64およびPowerPC向けのMySQL連携サポートを有効化しました。これにより[#26301](https://github.com/ClickHouse/ClickHouse/issues/26301)が解決されます。[#30010](https://github.com/ClickHouse/ClickHouse/pull/30010) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- クロスコンパイルツールチェーンに必要なファイルのみを残しました。これらはサブモジュールとして含まれます(以前はtarballとしてダウンロードされていました)。[#29974](https://github.com/ClickHouse/ClickHouse/pull/29974) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- SELECT文パーサー向けに構造認識型ファジングアプローチをClickHouseに実装しました。[#30012](https://github.com/ClickHouse/ClickHouse/pull/30012) ([Paul](https://github.com/PaulCher))。
- テンプレートコードのコンパイルを高速化するため、clang向けの実験的なconstexpr式評価器を有効化しました。[#29668](https://github.com/ClickHouse/ClickHouse/pull/29668) ([myrrc](https://github.com/myrrc))。
- 新しいシンボルを使用せずに新しいバージョンのglibcを使用してコンパイルする機能を追加しました。[#29594](https://github.com/ClickHouse/ClickHouse/pull/29594) ([Azat Khuzhin](https://github.com/azat))。
- clang最適化オプションによりDebugビルドのバイナリサイズを削減しました。[#28736](https://github.com/ClickHouse/ClickHouse/pull/28736) ([flynn](https://github.com/ucasfl))。
- CI用のすべてのイメージは別個のdockerhubリポジトリに配置されるようになりました。[#28656](https://github.com/ClickHouse/ClickHouse/pull/28656) ([alesapin](https://github.com/alesapin))。
- clang-13でのビルドサポートを改善しました。[#28046](https://github.com/ClickHouse/ClickHouse/pull/28046) ([Sergei Semin](https://github.com/syominsergey))。
- `clickhouse-client`に生のプロファイルイベントを出力する機能を追加しました(これはデバッグやテストに役立ちます)。[#30064](https://github.com/ClickHouse/ClickHouse/pull/30064) ([Azat Khuzhin](https://github.com/azat))。
- clickhouse-serverユニット(systemdおよびsysvinit init)に時間依存関係を追加しました。[#28891](https://github.com/ClickHouse/ClickHouse/pull/28891) ([Azat Khuzhin](https://github.com/azat))。
- シンボルが再読み込みされた際にスタックトレースキャッシュを再読み込みするようにしました。[#28137](https://github.com/ClickHouse/ClickHouse/pull/28137) ([Amos Bird](https://github.com/amosbird))。

#### バグ修正 {#bug-fix}


* `positionCaseInsensitiveUTF8` や `countSubstringsCaseInsensitiveUTF8` のような UTF-8 文字列に対する大文字小文字を区別しない検索用関数が、ごくまれなケースで実際には一致していない部分文字列を検出してしまうことがありましたが、修正されました。 [#30663](https://github.com/ClickHouse/ClickHouse/pull/30663) ([tavplubix](https://github.com/tavplubix))。
* 暗号化ディスク上の空ファイルからの読み取り処理を修正。 [#30494](https://github.com/ClickHouse/ClickHouse/pull/30494) ([Vitaly Baranov](https://github.com/vitlibar)).
* 設定 `legacy_column_name_of_tuple_literal = 0` が有効な分散クエリにおいて、`IN` への選言チェーンの変換（設定 `optimize_min_equality_disjunction_chain_length` によって制御）を修正しました。 [#28658](https://github.com/ClickHouse/ClickHouse/pull/28658) ([Anton Popov](https://github.com/CurtizJ)).
* `insert_allow_materialized_columns=0` の場合でも、分散テーブルのシャーディングキーとしてマテリアライズドカラムを使用できるようにしました。 [#28637](https://github.com/ClickHouse/ClickHouse/pull/28637) ([Vitaly Baranov](https://github.com/vitlibar)).
* 結果セットに行が存在しない場合に、`TO` および `FROM` が指定された `ORDER BY ... WITH FILL` の挙動を修正しました。 [#30888](https://github.com/ClickHouse/ClickHouse/pull/30888) ([Anton Popov](https://github.com/CurtizJ)).
* 2 つを超えるオペランドがある場合に、AND/OR 式で set インデックスが使用されない問題を修正しました。これにより [#30416](https://github.com/ClickHouse/ClickHouse/issues/30416) が解決されます。 [#30887](https://github.com/ClickHouse/ClickHouse/pull/30887) ([Amos Bird](https://github.com/amosbird))。
* ハッシュ関数を用いたプロジェクションのマテリアライズ時に発生するクラッシュを修正しました。これにより [#30861](https://github.com/ClickHouse/ClickHouse/issues/30861) が解決されます。この問題は [https://github.com/ClickHouse/ClickHouse/pull/28560](https://github.com/ClickHouse/ClickHouse/pull/28560) と類似しており、ヘッダーが空であることに関する不変条件を正しく理解していなかったことに起因します。 [#30877](https://github.com/ClickHouse/ClickHouse/pull/30877)（[Amos Bird](https://github.com/amosbird)）。
* `ReplicatedMergeTree` において、ZooKeeper パスから補助 ZooKeeper 名を抽出する処理のあいまいさを解消しました。以前は、ZooKeeper パスにコロンが含まれている場合、サーバーが `Unknown auxiliary ZooKeeper name` エラーで起動に失敗することがありました。これは [#29052](https://github.com/ClickHouse/ClickHouse/issues/29052) の修正です。また、先頭がスラッシュで始まらない ZooKeeper パスを指定することは以前は許可されていましたが、現在は非推奨となっており、そのようなパスで新しいテーブルを作成することはできません。補助 ZooKeeper 名にスラッシュやコロンを含めることも許可されなくなりました。 [#30822](https://github.com/ClickHouse/ClickHouse/pull/30822) ([tavplubix](https://github.com/tavplubix))。
* 何らかの理由で `localBackup` が失敗した場合に、一時ディレクトリをクリーンアップするようにしました。 [#30797](https://github.com/ClickHouse/ClickHouse/pull/30797) ([ianton-ru](https://github.com/ianton-ru)).
* 非レプリケートな `MergeTree` において、`REPLACE/MOVE PARTITION` とバックグラウンドマージの間のレースコンディションを修正しました。これにより、移動／置換されたデータの一部がパーティション内に残ってしまう可能性がありました。 [#29327](https://github.com/ClickHouse/ClickHouse/issues/29327) を修正します。 [#30717](https://github.com/ClickHouse/ClickHouse/pull/30717) ([tavplubix](https://github.com/tavplubix))。
* 常に真となる PREWHERE の場合、PREWHERE を WHERE に置き換えるよう修正しました。 [#30668](https://github.com/ClickHouse/ClickHouse/pull/30668) ([Azat Khuzhin](https://github.com/azat)).
* Limit push down 最適化により `Cannot find column` エラーが発生する可能性がありました。 [#30438](https://github.com/ClickHouse/ClickHouse/issues/30438) を修正しました。 [#30562](https://github.com/ClickHouse/ClickHouse/pull/30562) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `isNotNull`/`isNull` を `IS [NOT] NULL` に書き換える際に不足していた括弧を追加しました（`isNotNull(1)+isNotNull(2)` のようなクエリが正しく動作するように修正）。 [#30520](https://github.com/ClickHouse/ClickHouse/pull/30520) ([Azat Khuzhin](https://github.com/azat)).
* 同一テーブルへのスカラーサブクエリを含む `ALTER` で発生するデッドロックを修正し、[#30461](https://github.com/ClickHouse/ClickHouse/issues/30461) をクローズしました。 [#30492](https://github.com/ClickHouse/ClickHouse/pull/30492)（[Vladimir C](https://github.com/vdimir)）。
* REPLACE PARTITION の実行中にセッションの有効期限が切れた場合に発生する可能性があったセグメンテーションフォルトを修正しました。 [#30432](https://github.com/ClickHouse/ClickHouse/pull/30432) ([tavplubix](https://github.com/tavplubix)).
* `IN (subquery)` のような条件を持つクエリで、集計プロジェクションが適用されている場合に誤った結果が返されることがありました。プロジェクションに対する集合の作成処理を修正しました。 [#30310](https://github.com/ClickHouse/ClickHouse/pull/30310) ([Amos Bird](https://github.com/amosbird)).
* Projection が有効な場合の JOIN クエリにおけるカラム別名の解決を修正しました。これにより [#30146](https://github.com/ClickHouse/ClickHouse/issues/30146) が修正されました。[#30293](https://github.com/ClickHouse/ClickHouse/pull/30293)（[Amos Bird](https://github.com/amosbird)）。
* `replaceRegexpAll` 関数の不具合をいくつか修正。[#30292](https://github.com/ClickHouse/ClickHouse/pull/30292)（[Memo](https://github.com/Joeywzr)）。
* ComplexKeyHashedDictionary、ComplexKeySparseHashedDictionary がレイアウト設定から `preallocate` オプションを正しくパースするように修正。 [#30246](https://github.com/ClickHouse/ClickHouse/pull/30246) ([Maksim Kita](https://github.com/kitaisreal)).
* `[I]LIKE` 関数を修正。[#28661](https://github.com/ClickHouse/ClickHouse/issues/28661) をクローズ。[#30244](https://github.com/ClickHouse/ClickHouse/pull/30244)（[Nikolay Degterinsky](https://github.com/evillique)）。
* multiIf における shortcircuit と lowcardinality に起因するクラッシュを修正。 [#30243](https://github.com/ClickHouse/ClickHouse/pull/30243) ([Raúl Marín](https://github.com/Algunenano)).
* FlatDictionary と HashedDictionary において、nullable 属性向けの bytes&#95;allocated の計算を修正。[#30238](https://github.com/ClickHouse/ClickHouse/pull/30238)（[Maksim Kita](https://github.com/kitaisreal)）。
* 複数の `JOIN` で数値で始まる識別子を許可。 [#30230](https://github.com/ClickHouse/ClickHouse/pull/30230) ([Vladimir C](https://github.com/vdimir)).
* `MergeTree` からの読み取り時に `max_read_buffer_size = 0`（ユーザーが自ら進んで危険な設定にしている場合）を指定した場合の問題を修正しました（`Can't adjust last granule` や `LOGICAL_ERROR` の例外、さらにはデータ損失を引き起こす可能性があります）。 [#30192](https://github.com/ClickHouse/ClickHouse/pull/30192) ([Azat Khuzhin](https://github.com/azat)).
* `min_bytes_to_use_direct_io` 使用時の `pread_fake_async`/`pread_threadpool` を修正。 [#30191](https://github.com/ClickHouse/ClickHouse/pull/30191) ([Azat Khuzhin](https://github.com/azat)).
* `INSERT SELECT` が Nullable 列に基づく MATERIALIZED 列を誤って埋めてしまう問題を修正。 [#30189](https://github.com/ClickHouse/ClickHouse/pull/30189) ([Azat Khuzhin](https://github.com/azat)).
* 関数 `initializeAggregation` で Nullable 引数をサポートしました。 [#30177](https://github.com/ClickHouse/ClickHouse/pull/30177) ([Anton Popov](https://github.com/CurtizJ)).
* `GLOBAL IN` および `WITH TOTALS` を含むクエリで発生する `Port is already connected` エラーを修正。21.9 および 21.10 のみ。 [#30086](https://github.com/ClickHouse/ClickHouse/pull/30086) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* MergeTree における MOVE PARTITION とマージ／ミューテーション間のレースコンディションを修正。 [#30074](https://github.com/ClickHouse/ClickHouse/pull/30074) ([Azat Khuzhin](https://github.com/azat)).
* ドロップした `Memory` データベースがサーバー再起動後に再び現れる可能性があった問題を修正しました（[#29795](https://github.com/ClickHouse/ClickHouse/issues/29795)）。また、クラウド環境では残ったデータを手動で削除できないため、`Ordinary` データベースをドロップする際に発生する `Directory not empty` エラーへの対処策として、`force_remove_data_recursively_on_drop` 設定を追加しました。[#30054](https://github.com/ClickHouse/ClickHouse/pull/30054)（[tavplubix](https://github.com/tavplubix)）。
* `tuple()` によって発生していたサンプルのクラッシュを修正。[#30004](https://github.com/ClickHouse/ClickHouse/issues/30004) をクローズ。[#30016](https://github.com/ClickHouse/ClickHouse/pull/30016)（[flynn](https://github.com/ucasfl)）。
* issue のクローズを試みる: [#29965](https://github.com/ClickHouse/ClickHouse/issues/29965)。[#29976](https://github.com/ClickHouse/ClickHouse/pull/29976)（[hexiaoting](https://github.com/hexiaoting)）。
* `FileChecker` と `StorageLog` / `StorageStripeLog` 間で発生し得るデータレースを修正。 [#29959](https://github.com/ClickHouse/ClickHouse/pull/29959) ([Azat Khuzhin](https://github.com/azat)).
* `StorageLog` における `LogSink::writeMarks()` と `LogSource` の間のデータレースを修正。 [#29946](https://github.com/ClickHouse/ClickHouse/pull/29946) ([Azat Khuzhin](https://github.com/azat)).
* [https://github.com/ClickHouse/ClickHouse/pull/19544](https://github.com/ClickHouse/ClickHouse/pull/19544) で導入された MergeTree テーブルの同時クエリ数制限における、リソースリークの可能性がある問題を修正しました。 [#29879](https://github.com/ClickHouse/ClickHouse/pull/29879)（[Amos Bird](https://github.com/amosbird)）。
* システムテーブルの再作成チェックを修正（enum 値の変更を検出できない問題を解消）。 [#29857](https://github.com/ClickHouse/ClickHouse/pull/29857) ([Azat Khuzhin](https://github.com/azat)).
* MaterializedMySQL：MySQL への接続が失われた場合に、トランザクションの一部だけが処理されてしまう問題を修正しました。 [#29837](https://github.com/ClickHouse/ClickHouse/pull/29837) ([Håvard Kvålen](https://github.com/havardk))。
* カーネルのバグが原因と思われる、極めてまれなケースで発生し得る `Timeout exceeded: elapsed 18446744073.709553 seconds` エラーを回避します。[#29154](https://github.com/ClickHouse/ClickHouse/issues/29154) を修正。[#29811](https://github.com/ClickHouse/ClickHouse/pull/29811)（[tavplubix](https://github.com/tavplubix)）。
* `ATTACH TABLE ... FROM 'path'` クエリで、パスの代わりに非文字列リテラルが使用された場合に発生する誤ったキャストを修正しました。これにより、未初期化メモリが読み取られる可能性がありました。[#29790](https://github.com/ClickHouse/ClickHouse/pull/29790) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `GROUP BY` 中の `LowCardinality` への並行アクセスの処理を修正しました（`Buffer` テーブルと組み合わせた場合に問題を引き起こす可能性がありました）。 [#29782](https://github.com/ClickHouse/ClickHouse/pull/29782) ([Azat Khuzhin](https://github.com/azat)).
* 分散クエリにおいて、シャード上のバージョンが `<= 21.3` と `>= 21.4` で混在しており、`GROUP BY` キーがすべて固定サイズの複数列で構成され、かつ 2 段階集約が有効化されている場合（`group_by_two_level_threshold` および `group_by_two_level_threshold_bytes` を参照）、結果に同じキーを持つ複数行が含まれてしまう誤った `GROUP BY` の動作を修正しました。[#29580](https://github.com/ClickHouse/ClickHouse/issues/29580) を修正。[#29735](https://github.com/ClickHouse/ClickHouse/pull/29735)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* サーバー再起動時における `materialized_postgresql_tables_list` 設定時の誤った動作を修正しました。 [#28529](https://github.com/ClickHouse/ClickHouse/issues/28529) で報告。 [#29686](https://github.com/ClickHouse/ClickHouse/pull/29686)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* フィルタ述語内の条件がプッシュダウン最適化により失われる可能性がありました。 [#29625](https://github.com/ClickHouse/ClickHouse/pull/29625) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* エイリアスおよびショートサーキット式評価を伴う JIT 式コンパイルを修正。[#29403](https://github.com/ClickHouse/ClickHouse/issues/29403) をクローズ。[#29574](https://github.com/ClickHouse/ClickHouse/pull/29574)（[Maksim Kita](https://github.com/kitaisreal)）。
* `x.y.z...` のような誤ったテーブル識別子を `DEFAULT` 式で使用した場合に、`ALTER MODIFY` クエリでまれに発生するセグメンテーションフォルトを修正しました。[#29184](https://github.com/ClickHouse/ClickHouse/issues/29184) を修正。[#29573](https://github.com/ClickHouse/ClickHouse/pull/29573)（[alesapin](https://github.com/alesapin)）。
* `HAVING` の列が選択されていない場合の `GROUP BY WITH TOTALS HAVING` における nullptr デリファレンスを修正。 [#29553](https://github.com/ClickHouse/ClickHouse/pull/29553) ([Azat Khuzhin](https://github.com/azat)).
* Join テーブルエンジンのテーブルに対して、読み取りと書き込みを同時に行う際のデッドロックを回避しました。 [#29544](https://github.com/ClickHouse/ClickHouse/pull/29544) ([Raúl Marín](https://github.com/Algunenano)).
* `std::mismatch` の使用方法にバグがあったため、`pathStartsWith` チェックのバグを修正しました。`2 番目の範囲が 1 番目の範囲より短い場合、その動作は未定義です。` [#29531](https://github.com/ClickHouse/ClickHouse/pull/29531) ([Kseniia Sumarokova](https://github.com/kssenii))。
* ODBC ブリッジにおいて、エラー `Invalid cursor state` に対するリトライ処理を追加しました。このエラーはリトライ可能です。[#29473](https://github.com/ClickHouse/ClickHouse/issues/29473) をクローズします。 [#29518](https://github.com/ClickHouse/ClickHouse/pull/29518) ([Kseniia Sumarokova](https://github.com/kssenii))。
* `Lazy` データベースのロード時に発生していた誤ったテーブル名のパースを修正しました。 [#29456](https://github.com/ClickHouse/ClickHouse/issues/29456) を解決します。 [#29476](https://github.com/ClickHouse/ClickHouse/pull/29476)（[tavplubix](https://github.com/tavplubix)）。
* プッシュダウンされた `HAVING` 述語を含むサブクエリで発生しうる `Block structure mismatch` を修正しました。 [#29010](https://github.com/ClickHouse/ClickHouse/issues/29010) を修正。 [#29475](https://github.com/ClickHouse/ClickHouse/pull/29475)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 関数 greatest/least における論理エラー `Cannot capture columns` を修正。 [#29334](https://github.com/ClickHouse/ClickHouse/issues/29334) をクローズ。 [#29454](https://github.com/ClickHouse/ClickHouse/pull/29454)（[Kruglov Pavel](https://github.com/Avogar)）。
* RocksDB テーブルエンジン: 複数の DB オープン時に発生する競合状態を修正（CI 上でこの問題を引き起こしていたテストをいくつか再有効化）。 [#29393](https://github.com/ClickHouse/ClickHouse/pull/29393) ([Azat Khuzhin](https://github.com/azat)).
* 設定ミス時にレプリケートされたアクセスストレージが正常にシャットダウンされない問題を修正。 [#29388](https://github.com/ClickHouse/ClickHouse/pull/29388) ([Kevin Michel](https://github.com/kmichel-aiven))。
* メモリ安全ではないため、ウィンドウ関数 `nth_value` を削除しました。これにより [#29347](https://github.com/ClickHouse/ClickHouse/issues/29347) がクローズされました。 [#29348](https://github.com/ClickHouse/ClickHouse/pull/29348) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* プロジェクションパーツの垂直マージを修正しました。これにより、[#29253](https://github.com/ClickHouse/ClickHouse/issues/29253) が解決されます。この PR では、[https://github.com/ClickHouse/ClickHouse/pull/25165](https://github.com/ClickHouse/ClickHouse/pull/25165) で導入された、複数のプロジェクションのマージ／ミューテーションに関する問題も併せて修正しています。[#29337](https://github.com/ClickHouse/ClickHouse/pull/29337)（[Amos Bird](https://github.com/amosbird)）。
* 新しいレプリカを追加する際に、Replicated データベースでハングする DDL クエリが発生する問題を修正しました。 [#29328](https://github.com/ClickHouse/ClickHouse/pull/29328) ([Kevin Michel](https://github.com/kmichel-aiven)).
* 接続タイムアウト（`send_timeout` / `receive_timeout`）を修正。 [#29282](https://github.com/ClickHouse/ClickHouse/pull/29282)（[Azat Khuzhin](https://github.com/azat)）。
* `ReplicatedMergeTree` の新しいレプリカを作成または再作成する際に、テーブル列のいずれかが大文字小文字を区別しない関数を使用したデフォルト式を持つ場合に発生する可能性のある `Table columns structure in ZooKeeper is different from local table structure` 例外を修正しました。 [#29266](https://github.com/ClickHouse/ClickHouse/pull/29266) ([Anton Popov](https://github.com/CurtizJ))。
* 通常の `Database doesn't exist error` (`UNKNOWN_DATABASE`) を、`Attempt to read after eof` (`ATTEMPT_TO_READ_AFTER_EOF`) の代わりにクライアント（TCP 経由）へ送信します。 [#29229](https://github.com/ClickHouse/ClickHouse/pull/29229) ([Azat Khuzhin](https://github.com/azat)).
* Avro 入力フォーマットで LowCardinality(Nullable) 型のカラムに挿入する際に発生するセグメンテーションフォールトを修正。 [#29132](https://github.com/ClickHouse/ClickHouse/pull/29132) ([Kruglov Pavel](https://github.com/Avogar)).
* サーバー間シークレット使用時に以前の認証情報を再利用できないようにしました（そのクラスターに対して `interserver secret` が設定されている Distributed テーブルへの Buffer/Kafka 経由の INSERT 前に、その接続で以前に設定されたユーザーが再利用される可能性がありました）。 [#29060](https://github.com/ClickHouse/ClickHouse/pull/29060) ([Azat Khuzhin](https://github.com/azat)).
* 辞書との `JOIN` 時に `any_join_distinct_right_table_keys` を処理するようにし、[#29007](https://github.com/ClickHouse/ClickHouse/issues/29007) をクローズしました。[#29014](https://github.com/ClickHouse/ClickHouse/pull/29014)（[Vladimir C](https://github.com/vdimir)）。
* エイリアス列で `JOIN` した際に発生する「Not found column ... in block」エラーを修正しました。[#26980](https://github.com/ClickHouse/ClickHouse/issues/26980) をクローズ。[#29008](https://github.com/ClickHouse/ClickHouse/pull/29008)（[Vladimir C](https://github.com/vdimir)）。
* `GLOBAL IN` サブクエリで使用されるスレッド数を修正しました（[#19414](https://github.com/ClickHouse/ClickHouse/issues/19414) のバグ修正以降、単一スレッドで実行されていました）。[#28997](https://github.com/ClickHouse/ClickHouse/pull/28997)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* WITH FILL を含む場合の ORDER BY に対する不適切な最適化を修正しました。これにより [#28908](https://github.com/ClickHouse/ClickHouse/issues/28908) がクローズされます。また、[#26049](https://github.com/ClickHouse/ClickHouse/issues/26049) もクローズされます。 [#28910](https://github.com/ClickHouse/ClickHouse/pull/28910) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 定数を使用した場合に、高階配列関数（`arrayCompact` での `SIGSEGV`、`arrayDifference` および `arrayCumSumNonNegative` での `ILLEGAL_COLUMN`）が発生する問題を修正しました。 [#28904](https://github.com/ClickHouse/ClickHouse/pull/28904) ([Azat Khuzhin](https://github.com/azat)).
* `mutations_sync=2` 使用時のミューテーション待機処理を修正。 [#28889](https://github.com/ClickHouse/ClickHouse/pull/28889) ([Azat Khuzhin](https://github.com/azat))。
* 複数カラムを含む `IN` 句（例: `(k,v) IN ((1, 2))`）を使用した外部データベース（MySQL など）へのクエリを修正しました。 [#28888](https://github.com/ClickHouse/ClickHouse/pull/28888) ([Azat Khuzhin](https://github.com/azat)).
* ショートサーキット関数評価における `LowCardinality` のバグを修正。[#28884](https://github.com/ClickHouse/ClickHouse/issues/28884) をクローズ。 [#28887](https://github.com/ClickHouse/ClickHouse/pull/28887)（[Kruglov Pavel](https://github.com/Avogar)）。
* コンパクトパーツからのサブカラム読み取りを修正しました。 [#28873](https://github.com/ClickHouse/ClickHouse/pull/28873) ([Anton Popov](https://github.com/CurtizJ)).
* まれなケースでレプリカの不整合を引き起こす可能性があった `DROP PART` と `REPLACE/MOVE PARTITION` 間のレースコンディションを修正しました。 [#28864](https://github.com/ClickHouse/ClickHouse/pull/28864) ([tavplubix](https://github.com/tavplubix)).
* ショートサーキット評価を用いる式のコンパイルを修正。 [#28821](https://github.com/ClickHouse/ClickHouse/pull/28821) ([Azat Khuzhin](https://github.com/azat)).
* すべてのレプリカをハードリブートした後に、ごくまれに `ReplicatedMergeTree` のレプリカ間で不整合が発生する問題を修正しました。エラーは `Part ... intersects (previous|next) part ...` のように表示されます。 [#28817](https://github.com/ClickHouse/ClickHouse/pull/28817) ([alesapin](https://github.com/alesapin)).
* 接続の有効性をより慎重にチェックし、念のため `RabbitMQ` のシャットダウン時に発生するあらゆる例外も捕捉するようにしました。 [#28797](https://github.com/ClickHouse/ClickHouse/pull/28797) ([Kseniia Sumarokova](https://github.com/kssenii)).
* ReplicatedMergeTreeQueue における無害なレースコンディションを修正しました。ユーザーからは見えないはずですが、微妙なバグにつながる可能性があります。 [#28734](https://github.com/ClickHouse/ClickHouse/pull/28734) ([alesapin](https://github.com/alesapin)).
* 例外発生時に、部分的に作成された集約プロジェクションを伴う `SELECT` がクラッシュを引き起こす可能性がある問題を修正しました。 [#28700](https://github.com/ClickHouse/ClickHouse/pull/28700) ([Amos Bird](https://github.com/amosbird)).
* 分散テーブル作成時に、渡されたパラメータが不正な場合に発生するコアダンプを修正しました。 [#28686](https://github.com/ClickHouse/ClickHouse/pull/28686) ([Zhiyong Wang](https://github.com/ljcui))。
* system.processes テーブルに Settings.Names と Settings.Values のエイリアスを追加。 [#28685](https://github.com/ClickHouse/ClickHouse/pull/28685) ([Vitaly](https://github.com/orloffv)).
* S2 Geometry ライブラリのサポート：`s2RectAdd` および `s2RectContains` 関数で必要な引数の数を正しくしました。[#28663](https://github.com/ClickHouse/ClickHouse/pull/28663) ([Bharat Nallan](https://github.com/bharatnc))。
* Nullable または LowCardinality の主キーが使用されている場合に発生する不正な定数型変換を修正しました。 [#28636](https://github.com/ClickHouse/ClickHouse/pull/28636) ([Amos Bird](https://github.com/amosbird)).
* PREWHERE を使用して「Column is not under aggregate function and not in GROUP BY」エラーを修正（修正: [#28461](https://github.com/ClickHouse/ClickHouse/issues/28461)）。 [#28502](https://github.com/ClickHouse/ClickHouse/pull/28502)（[Azat Khuzhin](https://github.com/azat)）。

### ClickHouse リリース v21.10, 2021-10-16 {#clickhouse-release-v2110-2021-10-16}

#### 後方互換性のない変更 {#backward-incompatible-change-2}

- 以下のMergeTreeテーブルレベル設定: `replicated_max_parallel_sends`、`replicated_max_parallel_sends_for_table`、`replicated_max_parallel_fetches`、`replicated_max_parallel_fetches_for_table` は現在無効です。これらは正常に動作したことがなく、`max_replicated_fetches_network_bandwidth`、`max_replicated_sends_network_bandwidth`、`background_fetches_pool_size` に置き換えられました。[#28404](https://github.com/ClickHouse/ClickHouse/pull/28404) ([alesapin](https://github.com/alesapin))。

#### 新機能 {#new-feature-2}


- ラムダ式としてユーザー定義関数（UDF）を作成する機能を追加しました。構文：`CREATE FUNCTION {function_name} as ({parameters}) -> {function core}`。例：`CREATE FUNCTION plus_one as (a) -> a + 1`。作成者：@Realist007。[#27796](https://github.com/ClickHouse/ClickHouse/pull/27796) ([Maksim Kita](https://github.com/kitaisreal)) [#23978](https://github.com/ClickHouse/ClickHouse/pull/23978) ([Realist007](https://github.com/Realist007))。
- `Executable` ストレージエンジンと `executable` テーブル関数を追加しました。外部スクリプトによるストリーミング方式のデータ処理が可能になります。[#28102](https://github.com/ClickHouse/ClickHouse/pull/28102) ([Maksim Kita](https://github.com/kitaisreal)) ([ruct](https://github.com/ruct))。
- `ExecutablePool` ストレージエンジンを追加しました。`Executable` と同様ですが、長時間実行されるプロセスのプールを使用します。[#28518](https://github.com/ClickHouse/ClickHouse/pull/28518) ([Maksim Kita](https://github.com/kitaisreal))。
- `ALTER TABLE ... MATERIALIZE COLUMN` クエリを追加しました。[#27038](https://github.com/ClickHouse/ClickHouse/pull/27038) ([Vladimir Chebotarev](https://github.com/excitoon))。
- `s3` テーブル関数へのパーティション分割書き込みをサポートしました。[#23051](https://github.com/ClickHouse/ClickHouse/pull/23051) ([Vladimir Chebotarev](https://github.com/excitoon))。
- データのインポート/エクスポートにおいて、`lz4` 圧縮形式（`gz`、`bz2`、`xz`、`zstd` に加えて）をサポートしました。[#25310](https://github.com/ClickHouse/ClickHouse/pull/25310) ([Bharat Nallan](https://github.com/bharatnc))。
- 設定 `enable_positional_arguments` で位置引数を許可しました。解決：[#2592](https://github.com/ClickHouse/ClickHouse/issues/2592)。[#27530](https://github.com/ClickHouse/ClickHouse/pull/27530) ([Kseniia Sumarokova](https://github.com/kssenii))。
- s3 テーブルの `CREATE` クエリの `SETTINGS` 句でファイル形式に関連するユーザー設定を受け入れるようにしました。解決：[#27580](https://github.com/ClickHouse/ClickHouse/issues/27580)。[#28037](https://github.com/ClickHouse/ClickHouse/pull/28037) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- `RabbitMQ` エンジンで SSL 接続を許可しました。[#28365](https://github.com/ClickHouse/ClickHouse/pull/28365) ([Kseniia Sumarokova](https://github.com/kssenii))。
- サーバーポートを取得できる `getServerPort` 関数を追加しました。ポートがサーバーで使用されていない場合は例外をスローします。[#27900](https://github.com/ClickHouse/ClickHouse/pull/27900) ([Amos Bird](https://github.com/amosbird))。
- 「snowflake id」と `DateTime`、`DateTime64` 間の変換関数を追加しました。参照：[#27058](https://github.com/ClickHouse/ClickHouse/issues/27058)。[#27704](https://github.com/ClickHouse/ClickHouse/pull/27704) ([jasine](https://github.com/jasine))。
- `SHA512` 関数を追加しました。[#27830](https://github.com/ClickHouse/ClickHouse/pull/27830) ([zhanglistar](https://github.com/zhanglistar))。
- クエリのサンプルのみを query_log に書き込むことを可能にする `log_queries_probability` 設定を追加しました。解決：[#16609](https://github.com/ClickHouse/ClickHouse/issues/16609)。[#27527](https://github.com/ClickHouse/ClickHouse/pull/27527) ([Nikolay Degterinsky](https://github.com/evillique))。

#### 実験的機能 {#experimental-feature-2}


- 静的ファイルの形式でWebサーバー上に読み取り専用テーブルを保存するための`web`タイプのディスク。[#23982](https://github.com/ClickHouse/ClickHouse/issues/23982)を参照してください。[#25251](https://github.com/ClickHouse/ClickHouse/pull/25251) ([Kseniia Sumarokova](https://github.com/kssenii))。これは主に共有ストレージでの操作のテストを容易にし、データセットの簡単なインポートを可能にするために必要です。リリース21.11より前での使用は推奨されません。
- 新しいコマンド`BACKUP`と`RESTORE`を追加しました。[#21945](https://github.com/ClickHouse/ClickHouse/pull/21945) ([Vitaly Baranov](https://github.com/vitlibar))。これは開発中であり、現在のバージョンでの使用を想定していません。

#### パフォーマンスの改善 {#performance-improvement-2}

- `sumIf`および`countIf`集約関数を高速化しました。[#28272](https://github.com/ClickHouse/ClickHouse/pull/28272) ([Raúl Marín](https://github.com/Algunenano))。
- `minmax`インデックス用の仮想プロジェクションを作成しました。`allow_experimental_projection_optimization`が有効になっている場合、クエリは可能な限りデータを読み取る代わりにminmaxインデックスを使用するようになりました。[#26286](https://github.com/ClickHouse/ClickHouse/pull/26286) ([Amos Bird](https://github.com/amosbird))。
- `sequenceMatch`と`sequenceCount`に2つのチェックを導入し、シーケンスパターンの決定的な部分がイベントリストに存在しない場合に早期終了できるようにしました。この変更により、以前は操作上限に達して失敗していた多くのクエリが実行可能になり、全体的にパイプラインが高速化されます。[#27729](https://github.com/ClickHouse/ClickHouse/pull/27729) ([Jakub Kuklis](https://github.com/jkuklis))。
- 二項関数の常に単調な情報、特にゼロ以外の定数除算を使用してプライマリキー分析を強化しました。[#28302](https://github.com/ClickHouse/ClickHouse/pull/28302) ([Amos Bird](https://github.com/amosbird))。
- `hasAll`フィルタ条件がブルームフィルタのデータスキップインデックスを活用できるようにしました。[#27984](https://github.com/ClickHouse/ClickHouse/pull/27984) ([Braulio Valdivielso Martínez](https://github.com/BraulioVM))。
- テーブルの起動プロセスを遅延させることで、データパーツの読み込みを高速化しました。[#28313](https://github.com/ClickHouse/ClickHouse/pull/28313) ([Amos Bird](https://github.com/amosbird))。
- `WHERE`から`PREWHERE`に移動される条件が過剰になる可能性がある問題を修正しました(この最適化は設定`optimize_move_to_prewhere`によって制御されます)。[#28139](https://github.com/ClickHouse/ClickHouse/pull/28139) ([lthaooo](https://github.com/lthaooo))。
- `optimize_distributed_group_by_sharding_key`をデフォルトで有効にしました。[#28105](https://github.com/ClickHouse/ClickHouse/pull/28105) ([Azat Khuzhin](https://github.com/azat))。

#### 改善 {#improvement-2}


* `Distributed` テーブルを作成する前にクラスター名をチェックし、誤ったクラスター名でテーブルを作成できないようにしました。 [#27832](https://github.com/ClickHouse/ClickHouse/issues/27832) を修正。 [#27927](https://github.com/ClickHouse/ClickHouse/pull/27927)（[tavplubix](https://github.com/tavplubix)）。
* 集約関数 `quantileBFloat16Weighted` を、他の quantile...Weighted 関数と同様に追加しました。これにより [#27745](https://github.com/ClickHouse/ClickHouse/issues/27745) がクローズされます。[#27758](https://github.com/ClickHouse/ClickHouse/pull/27758)（[Ivan Novitskiy](https://github.com/RedClusive)）。
* 属性リストが空のディクショナリを作成できるようにしました。 [#27905](https://github.com/ClickHouse/ClickHouse/pull/27905) ([Maksim Kita](https://github.com/kitaisreal)).
* `clickhouse-client` にパスワードのリセット方法に関する対話型ドキュメントを追加しました。これは、ユーザーが ClickHouse をインストールしてパスワードを設定した直後に忘れてしまった場合などのシナリオで役立ちます。[#27750](https://github.com/ClickHouse/ClickHouse/issues/27750) を参照してください。[#27903](https://github.com/ClickHouse/ClickHouse/pull/27903)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `JSONAsString` 入力形式で、データが配列に入っている場合にも対応しました。 [#25517](https://github.com/ClickHouse/ClickHouse/issues/25517) をクローズ。 [#25633](https://github.com/ClickHouse/ClickHouse/pull/25633) ([Kruglov Pavel](https://github.com/Avogar))。
* `system.replicas` テーブルに新しい列 `last_queue_update_exception` を追加。 [#26843](https://github.com/ClickHouse/ClickHouse/pull/26843) ([nvartolomei](https://github.com/nvartolomei)).
* `MaterializedPostgreSQL` テーブルでフェイルオーバー時の再接続をサポートしました。[#28529](https://github.com/ClickHouse/ClickHouse/issues/28529) をクローズ。[#28614](https://github.com/ClickHouse/ClickHouse/pull/28614)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 初回のサーバー起動時に一意なサーバー UUID を生成します。 [#20089](https://github.com/ClickHouse/ClickHouse/pull/20089) ([Bharat Nallan](https://github.com/bharatnc))。
* `MySQL` エンジン向けに `connection_wait_timeout` 設定を導入（デフォルトは 5 秒、0 は待機しないことを意味する）。[#28474](https://github.com/ClickHouse/ClickHouse/pull/28474)（[Azat Khuzhin](https://github.com/azat)）。
* 不正な引数で `MaterializedPostgreSQL` を作成できないようにしました。 [#28423](https://github.com/ClickHouse/ClickHouse/issues/28423) をクローズしました。 [#28430](https://github.com/ClickHouse/ClickHouse/pull/28430)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 縦方向マージでは、事前定義された「rows&#95;sources」の代わりに実際の一時ファイルを使用するようにしました。これにより、一時ディスク上に不要なディレクトリが生成されなくなります。 [#28299](https://github.com/ClickHouse/ClickHouse/pull/28299) ([Amos Bird](https://github.com/amosbird)).
* HDFS との連携設定のため、`clickhouse-server.service` で環境変数 `LIBHDFS3_CONF` を export する代わりに、サーバー設定で `libhdfs3_conf` を指定できるようにしました。 [#28268](https://github.com/ClickHouse/ClickHouse/pull/28268) ([Zhichang Yu](https://github.com/yuzhichang)).
* 一時状態にあるパーツの削除処理を修正し、予期しない例外（`Part %name% doesn't exist`）が発生しうる問題を解消しました。 [#23661](https://github.com/ClickHouse/ClickHouse/issues/23661) を修正。 [#28221](https://github.com/ClickHouse/ClickHouse/pull/28221) [#28221](https://github.com/ClickHouse/ClickHouse/issues/28221)（[Azat Khuzhin](https://github.com/azat)）。
* `zookeeper_log.address` を修正（この PR の最初のパッチ以前はアドレスが常に `::` だった）し、このカラムに対する `getpeername(2)` の呼び出し回数を削減します（`zookeeper_log` にエントリが追加されるたびに `getpeername()` が呼び出されるため、これを避けるためにアドレスを zookeeper クライアント内にキャッシュします）。 [#28212](https://github.com/ClickHouse/ClickHouse/pull/28212) ([Azat Khuzhin](https://github.com/azat)).
* `[]` 演算子のインデックスと `Map` 型のキーとの間で、暗黙的な型変換をサポートするようにしました（例: 異なる `Int` 型、`String` と `FixedString`）。 [#28096](https://github.com/ClickHouse/ClickHouse/pull/28096) ([Anton Popov](https://github.com/CurtizJ))。
* PostgreSQL テーブルエンジンまたはテーブル関数への挿入時に `ON CONFLICT` 句をサポート。 [#27727](https://github.com/ClickHouse/ClickHouse/issues/27727) をクローズ。 [#28081](https://github.com/ClickHouse/ClickHouse/pull/28081) ([Kseniia Sumarokova](https://github.com/kssenii))。
* `Enum` データ型に対する制約を緩和し、互換性のあるデータをアタッチできるようにしました。 [#26672](https://github.com/ClickHouse/ClickHouse/issues/26672) をクローズしました。 [#28028](https://github.com/ClickHouse/ClickHouse/pull/28028)（[Dmitry Novik](https://github.com/novikd)）。
* 空集合に対する定数キーでのグループ化時の動作を制御するための設定 `empty_result_for_aggregation_by_constant_keys_on_empty_set` を追加しました。これは、[#6842](https://github.com/ClickHouse/ClickHouse/issues/6842) の以前の動作を復元するためのものです。[#27932](https://github.com/ClickHouse/ClickHouse/pull/27932)（[Amos Bird](https://github.com/amosbird)）。
* `replication_wait_for_inactive_replica_timeout` 設定を追加しました。これにより、非アクティブなレプリカが `ALTER` / `OPTIMZE` / `TRUNCATE` クエリを実行するまでどのくらい待機するかを指定できます（デフォルトは 120 秒）。`replication_alter_partitions_sync` が 2 の場合に、一部のレプリカが `replication_wait_for_inactive_replica_timeout` 秒を超えて非アクティブなままの場合は、`UNFINISHED` がスローされます。 [#27931](https://github.com/ClickHouse/ClickHouse/pull/27931) ([tavplubix](https://github.com/tavplubix)).
* 複数の引数を取る関数を適用できるようにするため、`APPLY` 列トランスフォーマーでのラムダ引数をサポートしました。これは [#27877](https://github.com/ClickHouse/ClickHouse/issues/27877) に対応するものです。[#27901](https://github.com/ClickHouse/ClickHouse/pull/27901)（[Amos Bird](https://github.com/amosbird)）。
* `tcp_keep_alive_timeout` をデフォルトで有効にしました。 [#27882](https://github.com/ClickHouse/ClickHouse/pull/27882) ([Azat Khuzhin](https://github.com/azat)).
* リモートサーバーが異常終了した場合のリモートクエリのキャンセル処理を改善。 [#27881](https://github.com/ClickHouse/ClickHouse/pull/27881) ([Azat Khuzhin](https://github.com/azat)).
* 大きな S3 オブジェクトにはマルチパートコピーアップロードを使用します。 [#27858](https://github.com/ClickHouse/ClickHouse/pull/27858) ([ianton-ru](https://github.com/ianton-ru)).
* ライブラリ辞書パスでのシンボリックリンクの辿行を許可。 [#27815](https://github.com/ClickHouse/ClickHouse/pull/27815) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `ALTER MODIFY COLUM` で列の型を `T` から `Nullable(T)` に変更する際に、もはや mutation を必要としません。 [#27787](https://github.com/ClickHouse/ClickHouse/pull/27787) ([victorgao](https://github.com/kafka1991)).
* `ReadBufferFromS3` でエラーを黙って無視せず、遅延をカウントするようにします。 [#27484](https://github.com/ClickHouse/ClickHouse/pull/27484) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 実際の TTL アクションを実行せずにメタデータのみを再計算することで、`ALTER ... MATERIALIZE TTL` を改善しました。 [#27019](https://github.com/ClickHouse/ClickHouse/pull/27019) ([lthaooo](https://github.com/lthaooo)).
* EOF の直前に改行がなくても、カスタムトップレベルドメインのリストを読み取れるようにしました。 [#28213](https://github.com/ClickHouse/ClickHouse/pull/28213) ([Azat Khuzhin](https://github.com/azat)).

#### バグ修正 {#bug-fix-1}


* `carbon-clickhouse` から圧縮データを読み込む際に &quot;attempt to read after end of file&quot; により失敗するケースを修正しました。[#26149](https://github.com/ClickHouse/ClickHouse/issues/26149) をクローズ。 [#28150](https://github.com/ClickHouse/ClickHouse/pull/28150) ([FArthur-cmd](https://github.com/FArthur-cmd)).
* `ON CLUSTER` 句を伴う `GRANT WITH REPLACE` ステートメントを実行する際のアクセス権限チェックを修正。 このPRは修正 [#27001](https://github.com/ClickHouse/ClickHouse/pull/27701) をさらに改善します。 [#27983](https://github.com/ClickHouse/ClickHouse/pull/27983) ([Vitaly Baranov](https://github.com/vitlibar))。
* `LowCardinality(UUID)` 型のカラムに対して `extremes = 1` を指定した `SELECT` を実行できるようにした。 [#27918](https://github.com/ClickHouse/ClickHouse/pull/27918) ([Vitaly Baranov](https://github.com/vitlibar)).
* 負の数に対する PostgreSQL 形式のキャスト（`::` 演算子）の動作を修正。 [#27876](https://github.com/ClickHouse/ClickHouse/pull/27876)（[Anton Popov](https://github.com/CurtizJ)）。
* [#26864](https://github.com/ClickHouse/ClickHouse/pull/26864) 以降。`NamedSessionStorage` のシャットダウン処理を修正: `NamedSessionStorage` に保存されているセッションコンテキストは、グローバルコンテキストを破棄する前に破棄されるようになりました。[#27875](https://github.com/ClickHouse/ClickHouse/pull/27875)（[Vitaly Baranov](https://github.com/vitlibar)）。
* `windowFunnel` の「strict」モードのバグ修正。[#27469](https://github.com/ClickHouse/ClickHouse/issues/27469) を修正します。 [#27563](https://github.com/ClickHouse/ClickHouse/pull/27563) ([achimbab](https://github.com/achimbab)).
* 切り詰められた `bzip2` アーカイブを読み込む際に発生する無限ループを修正。 [#28543](https://github.com/ClickHouse/ClickHouse/pull/28543) ([Azat Khuzhin](https://github.com/azat)).
* `MaterializedMySQL` の内部 DDL における `DROP TABLE` で UUID が競合する問題を修正しました。MaterializedMySQL は実験的な機能です。 [#28533](https://github.com/ClickHouse/ClickHouse/pull/28533) ([Azat Khuzhin](https://github.com/azat)).
* `Nested` カラムと、名前にドットを含み、`Nested` と同じプレフィックスを持つスカラーカラム（例: `n.id UInt32, n.arr1 Array(UInt64), n.arr2 Array(UInt64)`）を持つテーブルに対して `SELECT` を実行する際に発生する `There is no subcolumn` エラーを修正しました。 [#28531](https://github.com/ClickHouse/ClickHouse/pull/28531) ([Anton Popov](https://github.com/CurtizJ)).
* `ReplicatedVersionedCollapsingMergeTree` に対する ALTER の後に `Existing table metadata in ZooKeeper differs in sorting key expression.` というエラーが発生しうるバグを修正。[#28515](https://github.com/ClickHouse/ClickHouse/issues/28515) を修正。[#28528](https://github.com/ClickHouse/ClickHouse/pull/28528) ([alesapin](https://github.com/alesapin))。
* 分散DDLキューのバックグラウンド処理において、ZooKeeperのウォッチがリークする可能性のある（軽微な）問題を修正しました。[#26036](https://github.com/ClickHouse/ClickHouse/issues/26036) をクローズ。[#28446](https://github.com/ClickHouse/ClickHouse/pull/28446)（[tavplubix](https://github.com/tavplubix)）。
* `MaterializedPostgreSQL` エンジンにおけるテーブル名のクオート漏れを修正。 [#28316](https://github.com/ClickHouse/ClickHouse/issues/28316) をクローズ。 [#28433](https://github.com/ClickHouse/ClickHouse/pull/28433)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* nullable カラムにおける非結合行の誤った動作を修正。[#27691](https://github.com/ClickHouse/ClickHouse/issues/27691) をクローズ。[#28349](https://github.com/ClickHouse/ClickHouse/pull/28349)（[vdimir](https://github.com/vdimir)）。
* すべてのキー列が使用されていない場合の NOT IN インデックス最適化を修正しました。これにより [#28120](https://github.com/ClickHouse/ClickHouse/issues/28120) が解決されます。[#28315](https://github.com/ClickHouse/ClickHouse/pull/28315)（[Amos Bird](https://github.com/amosbird)）。
* 空のパートに置き換えられた新しいパートが原因で、パート同士が重なってしまう問題を修正しました。 [#28310](https://github.com/ClickHouse/ClickHouse/pull/28310) ([Azat Khuzhin](https://github.com/azat)).
* `optimize_read_in_order` 設定が有効な状態で、`ORDER BY` を含むクエリおよび `Merge` テーブルで発生していた結果の不整合を修正しました。 [#28266](https://github.com/ClickHouse/ClickHouse/pull/28266) ([Anton Popov](https://github.com/CurtizJ)).
* `Nullable(LowCardinality)` 型を含むクエリで、設定 `extremes` が 1 に設定されている場合に発生し得る未初期化メモリの読み取りを修正しました。[#28165](https://github.com/ClickHouse/ClickHouse/issues/28165) を修正。[#28205](https://github.com/ClickHouse/ClickHouse/pull/28205) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `projections` に対する複数の小規模な修正。詳細な説明は PR を参照してください。 [#28178](https://github.com/ClickHouse/ClickHouse/pull/28178) ([Amos Bird](https://github.com/amosbird)).
* コンテキスト／設定リローダーのシャットダウン順序の誤りにより、シャットダウン時にごくまれに発生していたセグメンテーションフォールトを修正しました。 [#28088](https://github.com/ClickHouse/ClickHouse/pull/28088) ([nvartolomei](https://github.com/nvartolomei)).
* 関数 `JSONExtract` における `Nullable(String)` 型の null 値の扱いを修正しました。これにより [#27929](https://github.com/ClickHouse/ClickHouse/issues/27929) および [#27930](https://github.com/ClickHouse/ClickHouse/issues/27930) が解消されます。この問題は [https://github.com/ClickHouse/ClickHouse/pull/25452](https://github.com/ClickHouse/ClickHouse/pull/25452) で導入されました。 [#27939](https://github.com/ClickHouse/ClickHouse/pull/27939) ([Amos Bird](https://github.com/amosbird))。
* 新しい `clickhouse-keeper` ツールに対する複数の修正。クライアントがリクエストに対するレスポンスより先に watch レスポンスを受け取ってしまう、`clickhouse-keeper` のまれなバグを修正しました。[#28197](https://github.com/ClickHouse/ClickHouse/pull/28197) ([alesapin](https://github.com/alesapin))。子ノードに対する `set` リクエストでリスト watch（`getChildren`）がトリガーされてしまう、`clickhouse-keeper` の不正な動作を修正しました。[#28190](https://github.com/ClickHouse/ClickHouse/pull/28190) ([alesapin](https://github.com/alesapin))。`clickhouse-keeper` の設定変更が原因でログが失われたりサーバーがハングしたりする可能性がある、まれなケースを修正しました。[#28360](https://github.com/ClickHouse/ClickHouse/pull/28360) ([alesapin](https://github.com/alesapin))。`rotate_logs_interval` を短くした際に、ログが延々と出力され続ける可能性がある `clickhouse-keeper` のバグを修正しました。[#28152](https://github.com/ClickHouse/ClickHouse/pull/28152) ([alesapin](https://github.com/alesapin))。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-2}

- ストレステストでThread Fuzzerを有効化しました。Thread FuzzerはClickHouseの機能で、スレッドスケジューリングのより多くの組み合わせをテストし、潜在的な問題をより多く発見できるようにします。これにより[#9813](https://github.com/ClickHouse/ClickHouse/issues/9813)、[#9814](https://github.com/ClickHouse/ClickHouse/issues/9814)、[#9515](https://github.com/ClickHouse/ClickHouse/issues/9515)、[#9516](https://github.com/ClickHouse/ClickHouse/issues/9516)がクローズされました。[#27538](https://github.com/ClickHouse/ClickHouse/pull/27538) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- テスト環境用の新しいログレベル`test`を追加しました。デフォルトの`trace`よりもさらに詳細な出力を行います。[#28559](https://github.com/ClickHouse/ClickHouse/pull/28559) ([alesapin](https://github.com/alesapin))。
- CMake設定段階でgitステータス情報を出力するようにしました。[#28047](https://github.com/ClickHouse/ClickHouse/pull/28047) ([Braulio Valdivielso Martínez](https://github.com/BraulioVM))。
- デフォルトのリポジトリ(archive.ubuntu.com)がCIから応答しないため、ubuntu aptリポジトリを一時的にミラーru.archive.ubuntu.comに切り替えました。[#28016](https://github.com/ClickHouse/ClickHouse/pull/28016) ([Ilya Yatsishin](https://github.com/qoega))。

### ClickHouseリリース v21.9, 2021-09-09 {#clickhouse-release-v219-2021-09-09}

#### 後方互換性のない変更 {#backward-incompatible-change-3}


- `Decimal`型のテキスト表現において末尾のゼロを出力しないようになりました。例: スケール6の小数値の場合、`1.230000`ではなく`1.23`が出力されます。これにより[#15794](https://github.com/ClickHouse/ClickHouse/issues/15794)が解決されます。アプリケーションが末尾のゼロに依存していた場合、わずかな非互換性が生じる可能性があります。出力フォーマットでのシリアライゼーションは`output_format_decimal_trailing_zeros`設定で制御できます。`toString`の実装とStringへのキャストは無条件で変更されます。[#27680](https://github.com/ClickHouse/ClickHouse/pull/27680) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 異なるパラメータで生成された集約関数の状態に対して、`-Merge`コンビネータを持つパラメトリック集約関数を適用できないようになりました。例えば、`fooState(42)(x)`の状態は`fooMerge(s)`や`fooMerge(123)(s)`では確定できず、`fooMerge(42)(s)`のようにパラメータを明示的に指定し、かつ一致している必要があります。これは、確定処理でのみパラメータを使用する`quantile`や`sequence*`などの特殊な集約関数には影響しません。[#26847](https://github.com/ClickHouse/ClickHouse/pull/26847) ([tavplubix](https://github.com/tavplubix))。
- clickhouse-localにおいて、ポート番号を持つローカルアドレスを常にリモートとして扱うようになりました。[#26736](https://github.com/ClickHouse/ClickHouse/pull/26736) ([Raúl Marín](https://github.com/Algunenano))。
- 式の名前と同一のカラムエイリアスを持つ複雑なクエリにおいて、不正なキャストが発生する問題を修正しました。これにより[#25447](https://github.com/ClickHouse/ClickHouse/issues/25447)と[#26914](https://github.com/ClickHouse/ClickHouse/issues/26914)が解決されます。この修正により後方互換性の問題が生じる可能性があります: 同一の名前を持つ異なる式が存在する場合、例外がスローされます。`enable_optimize_predicate_expression`が設定されている場合、まれなケースで動作しなくなる可能性があります。[#26639](https://github.com/ClickHouse/ClickHouse/pull/26639) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- スカラーサブクエリは、その型が`Nullable`になり得る場合、常に`Nullable`な結果を返すようになりました。これは、サブクエリが空の場合、結果が`Null`になる必要があるためです。以前は、型推論がスカラーサブクエリを実行せず、非Nullable型を使用する可能性があったため、互換性のない型に関するエラーが発生することがありました。`Nullable`に変換できない空の結果を持つスカラーサブクエリ(`Array`や`Tuple`など)は、エラーをスローするようになりました。[#25411](https://github.com/ClickHouse/ClickHouse/issues/25411)を修正。[#26423](https://github.com/ClickHouse/ClickHouse/pull/26423) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- ヒアドキュメントの構文を導入しました。例: `SELECT $doc$ VALUE $doc$`。[#26671](https://github.com/ClickHouse/ClickHouse/pull/26671) ([Maksim Kita](https://github.com/kitaisreal))。この変更は、クエリ内に`$`を含む識別子がある場合、後方互換性がありません[#28768](https://github.com/ClickHouse/ClickHouse/issues/28768)。
- インデックスが`isNull`や`isNotNull`を含むNullable型を処理できるようになりました。[#12433](https://github.com/ClickHouse/ClickHouse/pull/12433)、[#12455](https://github.com/ClickHouse/ClickHouse/pull/12455) ([Amos Bird](https://github.com/amosbird))、[#27250](https://github.com/ClickHouse/ClickHouse/pull/27250) ([Azat Khuzhin](https://github.com/azat))。ただし、これはディスク上のフォーマット変更を伴うため、新しいサーバーは古いデータを読み取れますが、古いサーバーは読み取れません。また、`MINMAX`データスキッピングインデックスを使用している場合、新しいインデックスの拡張子が`.idx2`になる(以前は`.idx`)ため、`Data after mutation/merge is not byte-identical`エラーが発生する可能性があります。つまり、既存のすべてのレプリカの更新を遅らせるべきではありません。そうしないと、古いレプリカ(<21.9)が21.9+の新しいレプリカからデータをダウンロードした場合、ダウンロードしたパートにインデックスを適用できなくなります。

#### 新機能 {#new-feature-3}


* ショートサーキット関数評価を実装し、[#12587](https://github.com/ClickHouse/ClickHouse/issues/12587) をクローズ。ショートサーキット関数評価を制御するための設定 `short_circuit_function_evaluation` を追加。[#23367](https://github.com/ClickHouse/ClickHouse/pull/23367)（[Kruglov Pavel](https://github.com/Avogar)）。
* INTERSECT、EXCEPT、ANY、ALL 演算子のサポートを追加しました。 [#24757](https://github.com/ClickHouse/ClickHouse/pull/24757) ([Kirill Ershov](https://github.com/zdikov)). ([Kseniia Sumarokova](https://github.com/kssenii)).
* AES-CTR アルゴリズムを使用した仮想ファイルシステムレベルでの暗号化（保存データの暗号化）のサポートを追加しました。 [#24206](https://github.com/ClickHouse/ClickHouse/pull/24206) ([Latysheva Alexandra](https://github.com/alexelex)). ([Vitaly Baranov](https://github.com/vitlibar)) [#26733](https://github.com/ClickHouse/ClickHouse/pull/26733) [#26377](https://github.com/ClickHouse/ClickHouse/pull/26377) [#26465](https://github.com/ClickHouse/ClickHouse/pull/26465).
* 類義語拡張に、トークン化、ステミング、レンマ化および検索のための自然言語処理 (NLP) 関数を追加しました。 [#24997](https://github.com/ClickHouse/ClickHouse/pull/24997) ([Nikolay Degterinsky](https://github.com/evillique)).
* S2 Geometry ライブラリとの統合を追加しました。 [#24980](https://github.com/ClickHouse/ClickHouse/pull/24980) ([Andr0901](https://github.com/Andr0901)). ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* SQLite テーブルエンジン、テーブル関数、データベースエンジンを追加しました。 [#24194](https://github.com/ClickHouse/ClickHouse/pull/24194) ([Arslan Gumerov](https://github.com/g-arslan)). ([Kseniia Sumarokova](https://github.com/kssenii)).
* `MySQL`、`PostgreSQL`、`ClickHouse`、`JDBC`、`Cassandra` の辞書ソースでカスタムクエリをサポートしました。[#1270](https://github.com/ClickHouse/ClickHouse/issues/1270) をクローズ。[#26995](https://github.com/ClickHouse/ClickHouse/pull/26995)（[Maksim Kita](https://github.com/kitaisreal)）。
* ZooKeeper を通じて、ユーザー、ロール、行ポリシー、クォータおよび設定プロファイルの共有（レプリケート）ストレージを追加しました。 [#27426](https://github.com/ClickHouse/ClickHouse/pull/27426) ([Kevin Michel](https://github.com/kmichel-aiven)).
* `INTO OUTFILE` において、圧縮アルゴリズムを自動選択する圧縮機能を追加しました。[#3473](https://github.com/ClickHouse/ClickHouse/issues/3473) をクローズ。[#27134](https://github.com/ClickHouse/ClickHouse/pull/27134)（[Filatenkov Artur](https://github.com/FArthur-cmd)）。
* `SELECT ... INTO OUTFILE` と同様に `INSERT ... FROM INFILE` を追加しました。 [#27655](https://github.com/ClickHouse/ClickHouse/pull/27655) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* `complex_key_range_hashed` 辞書を追加しました。 [#22029](https://github.com/ClickHouse/ClickHouse/issues/22029) をクローズします。 [#27629](https://github.com/ClickHouse/ClickHouse/pull/27629)（[Maksim Kita](https://github.com/kitaisreal)）。
* JOIN の ON 句で式をサポート。 [#21868](https://github.com/ClickHouse/ClickHouse/issues/21868) をクローズ。 [#24420](https://github.com/ClickHouse/ClickHouse/pull/24420) ([Vladimir C](https://github.com/vdimir))。
* クライアントがサーバーに接続すると、サーバー側ですでに収集されているすべての警告情報を受け取ります（オプション `--no-warnings` で無効化できます）。サーバー構成に関する警告を収集するために `system.warnings` テーブルを追加しました。 [#26246](https://github.com/ClickHouse/ClickHouse/pull/26246) ([Filatenkov Artur](https://github.com/FArthur-cmd)). [#26282](https://github.com/ClickHouse/ClickHouse/pull/26282) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* 集約関数のパラメータで `WITH` および `SELECT` からの定数式を使用できるようにしました。[#10945](https://github.com/ClickHouse/ClickHouse/issues/10945) をクローズしました。 [#27531](https://github.com/ClickHouse/ClickHouse/pull/27531)（[abel-cheng](https://github.com/abel-cheng)）。
* 名前付きタプルをペアの配列に変換する関数 `tupleToNameValuePairs` を追加しました。 [#27505](https://github.com/ClickHouse/ClickHouse/pull/27505)（[Braulio Valdivielso Martínez](https://github.com/BraulioVM)）。
* インポート／エクスポート用の `bzip2` 圧縮方式のサポートを追加。 [#22428](https://github.com/ClickHouse/ClickHouse/issues/22428) をクローズ。 [#27377](https://github.com/ClickHouse/ClickHouse/pull/27377)（[Nikolay Degterinsky](https://github.com/evillique)）。
* `bitmapSubsetOffsetLimit(bitmap, offset, cardinality_limit)` 関数を追加しました。`offset` からのオフセット位置から開始し、結果を `cardinality_limit` に制限したビットマップのサブセットを作成します。 [#27234](https://github.com/ClickHouse/ClickHouse/pull/27234) ([DHBin](https://github.com/DHBin)).
* `system.users` に `default_database` 列を追加しました。 [#27054](https://github.com/ClickHouse/ClickHouse/pull/27054) ([kevin wan](https://github.com/MaxWk)).
* テーブル関数 &#39;cluster&#39; および &#39;clusterAllReplicas&#39; 内で `cluster` マクロをサポートしました。 [#26913](https://github.com/ClickHouse/ClickHouse/pull/26913) ([polyprogrammist](https://github.com/PolyProgrammist)).
* 新しい関数 `currentRoles()`, `enabledRoles()`, `defaultRoles()` を追加しました。[#26780](https://github.com/ClickHouse/ClickHouse/pull/26780)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 新しい関数 `currentProfiles()`, `enabledProfiles()`, `defaultProfiles()` を追加。[#26714](https://github.com/ClickHouse/ClickHouse/pull/26714)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 現在のクエリの (initial&#95;)query&#95;id を返す関数を追加しました。これにより [#23682](https://github.com/ClickHouse/ClickHouse/issues/23682) がクローズされました。[#26410](https://github.com/ClickHouse/ClickHouse/pull/26410) ([Alexey Boykov](https://github.com/mathalex)).
* `REPLACE GRANT` 機能を追加しました。 [#26384](https://github.com/ClickHouse/ClickHouse/pull/26384) ([Caspian](https://github.com/Cas-pian))。
* `EXPLAIN` クエリに `EXPLAIN ESTIMATE ...` モードが追加され、MergeTree テーブルから読み取られる行数、マーク、およびパーツに関する情報を表示できるようになりました。[#23941](https://github.com/ClickHouse/ClickHouse/issues/23941) をクローズ。[#26131](https://github.com/ClickHouse/ClickHouse/pull/26131) ([fastio](https://github.com/fastio))。
* `system.zookeeper_log` テーブルを追加しました。ZooKeeper クライアントによるすべての操作がこのテーブルにログとして記録されます。[#25449](https://github.com/ClickHouse/ClickHouse/issues/25449) を実装。[#26129](https://github.com/ClickHouse/ClickHouse/pull/26129)（[tavplubix](https://github.com/tavplubix)）。
* `HDFS` ストレージ上の `ReplicatedMergeTree` 向けゼロコピー・レプリケーション。 [#25918](https://github.com/ClickHouse/ClickHouse/pull/25918) ([Zhichang Yu](https://github.com/yuzhichang)).
* `Arrow`、`ORC` および `Parquet` の入力フォーマットで、`Nested` 型を構造体の配列として挿入できるようにしました。 [#25902](https://github.com/ClickHouse/ClickHouse/pull/25902) ([Kruglov Pavel](https://github.com/Avogar)).
* 新しいデータ型 `Date32` を追加（データを Int32 として保存）、`DateTime64` と同じ日付範囲をサポートし、Parquet の date32 を ClickHouse の `Date32` へロードすることをサポート、新しい関数 `toDate32` を `toDate` 同様に追加。 [#25774](https://github.com/ClickHouse/ClickHouse/pull/25774) ([LiuNeng](https://github.com/liuneng1994)).
* ユーザーごとにデフォルトデータベースを設定できるようにしました。 [#25268](https://github.com/ClickHouse/ClickHouse/issues/25268)。 [#25687](https://github.com/ClickHouse/ClickHouse/pull/25687) ([kevin wan](https://github.com/MaxWk))。
* `MongoDB` エンジンにオプションパラメータを追加し、接続文字列オプションを受け付けて SSL 接続をサポートできるようにしました。[#21189](https://github.com/ClickHouse/ClickHouse/issues/21189) をクローズ。[#21041](https://github.com/ClickHouse/ClickHouse/issues/21041) をクローズ。[#22045](https://github.com/ClickHouse/ClickHouse/pull/22045)（[Omar Bazaraa](https://github.com/OmarBazaraa)）。

#### 実験的機能 {#experimental-feature-3}

- カラムを圧縮する代わりに暗号化する圧縮コーデック `AES_128_GCM_SIV` を追加しました。[#19896](https://github.com/ClickHouse/ClickHouse/pull/19896) ([PHO](https://github.com/depressed-pho))。書き直される予定のため、使用しないでください。
- `MaterializeMySQL` を `MaterializedMySQL` に名称変更しました。[#26822](https://github.com/ClickHouse/ClickHouse/pull/26822) ([tavplubix](https://github.com/tavplubix))。

#### パフォーマンス改善 {#performance-improvement-3}

- `clock_gettime` システムコールの回数を削減することで、`max_execution_time = 0` の場合の高速クエリのパフォーマンスを改善しました。[#27325](https://github.com/ClickHouse/ClickHouse/pull/27325) ([filimonov](https://github.com/filimonov))。
- 日時関連の比較を特殊化してパフォーマンスを向上させました。これにより [#27083](https://github.com/ClickHouse/ClickHouse/issues/27083) が修正されます。[#27122](https://github.com/ClickHouse/ClickHouse/pull/27122) ([Amos Bird](https://github.com/amosbird))。
- 同じファイルの同時読み取りでファイルディスクリプタを共有するようにしました。Linux上では顕著なパフォーマンスの違いはありませんが、一般的なサーバーでは開かれるファイル数が大幅に（10〜100倍）削減され、運用が容易になります。[#26214](https://github.com/ClickHouse/ClickHouse/issues/26214) を参照してください。[#26768](https://github.com/ClickHouse/ClickHouse/pull/26768) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 多数のカラムを持つテーブルからの読み取りを必要とする短いクエリのレイテンシを改善しました。[#26371](https://github.com/ClickHouse/ClickHouse/pull/26371) ([Anton Popov](https://github.com/CurtizJ))。
- クエリ分析時にインデックス用のセットを構築しないようにしました。[#26365](https://github.com/ClickHouse/ClickHouse/pull/26365) ([Raúl Marín](https://github.com/Algunenano))。
- ネイティブ表現を持つNullable整数型のSUMをベクトル化しました（[David Manzanares](https://github.com/davidmanzanares)、[Raúl Marín](https://github.com/Algunenano)）。[#26248](https://github.com/ClickHouse/ClickHouse/pull/26248) ([Raúl Marín](https://github.com/Algunenano))。
- `Enum` 型のカラムを含む式をコンパイルするようにしました。[#26237](https://github.com/ClickHouse/ClickHouse/pull/26237) ([Maksim Kita](https://github.com/kitaisreal))。
- 集約関数 `groupBitOr`、`groupBitAnd`、`groupBitXor` をコンパイルするようにしました。[#26161](https://github.com/ClickHouse/ClickHouse/pull/26161) ([Maksim Kita](https://github.com/kitaisreal))。
- 空のDEFAULTカラムを読み取る際のブロックサイズ予測を改善し、メモリ使用量を向上させました。[#17317](https://github.com/ClickHouse/ClickHouse/issues/17317) をクローズします。[#25917](https://github.com/ClickHouse/ClickHouse/pull/25917) ([Vladimir Chebotarev](https://github.com/excitoon))。
- `ORDER BY primary_key` を使用するクエリにおいて、メモリ使用量と読み取り行数を削減しました。[#25721](https://github.com/ClickHouse/ClickHouse/pull/25721) ([Anton Popov](https://github.com/CurtizJ))。
- `distributed_push_down_limit` をデフォルトで有効にしました。[#27104](https://github.com/ClickHouse/ClickHouse/pull/27104) ([Azat Khuzhin](https://github.com/azat))。
- timeZoneが定数値の場合に `toTimeZone` を単調にし、次のようなSQLを使用する際のパーティションプルーニングをサポートしました。[#26261](https://github.com/ClickHouse/ClickHouse/pull/26261) ([huangzhaowei](https://github.com/SaintBacchus))。

#### 改善 {#improvement-3}


* ウィンドウ関数を本番利用可能としてマークし、`allow_experimental_window_functions` 設定を削除しました。 [#27184](https://github.com/ClickHouse/ClickHouse/pull/27184) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* 分単位でないタイムゾーンオフセットとの互換性を改善しました。 [#27080](https://github.com/ClickHouse/ClickHouse/pull/27080) ([Raúl Marín](https://github.com/Algunenano)).
* `File` テーブル内のファイルディスクリプタが通常ファイルである場合、そのファイルから複数回読み取ることを許可します。これにより、標準入力が `clickhouse-local --query "SELECT * FROM table UNION ALL SELECT * FROM table" ... < file` のような通常ファイルである場合に、`clickhouse-local` が標準入力から（複数の SELECT クエリやサブクエリを通じて）複数回読み取ることが可能になります。これにより [#11124](https://github.com/ClickHouse/ClickHouse/issues/11124) がクローズされました。([alexey-milovidov](https://github.com/alexey-milovidov)) との共同作業。[#25960](https://github.com/ClickHouse/ClickHouse/pull/25960) ([BoloniniD](https://github.com/BoloniniD))。
* 重複したインデックス解析を削除し、投影解析中に発生しうる不正な `LIMIT` チェックを回避します。 [#27742](https://github.com/ClickHouse/ClickHouse/pull/27742) ([Amos Bird](https://github.com/amosbird)).
* HTTP リクエストのボディでクエリパラメータを渡せるようにしました。 [#27706](https://github.com/ClickHouse/ClickHouse/pull/27706) ([Hermano Lustosa](https://github.com/hllustosa)).
* パーティション式での `arrayJoin` の使用を禁止。 [#27648](https://github.com/ClickHouse/ClickHouse/pull/27648) ([Raúl Marín](https://github.com/Algunenano)).
* 認証に失敗した場合にクライアントの IP アドレスをログ出力するようにした。 [#27514](https://github.com/ClickHouse/ClickHouse/pull/27514) ([Misko Lee](https://github.com/imiskolee)).
* GRPC プロトコルでのバイナリデータには、文字列ではなくバイト列を使用するようにしました。 [#27431](https://github.com/ClickHouse/ClickHouse/pull/27431) ([Vitaly Baranov](https://github.com/vitlibar))。
* HTTP ポートが設定されていない状態で、ユーザーが TCP ポートに HTTP リクエストを送信しようとした場合に、エラーメッセージ付きのレスポンスを返すようにしました。 [#27385](https://github.com/ClickHouse/ClickHouse/pull/27385) ([Braulio Valdivielso Martínez](https://github.com/BraulioVM))。
* 内部使用向けの `_CAST` 関数を追加しました。この関数は型の Nullable 性を保持しませんが、内部用ではないキャストは設定 `cast_keep_nullable` に従って Nullable 性を保持します。[#12636](https://github.com/ClickHouse/ClickHouse/issues/12636) をクローズ。[#27382](https://github.com/ClickHouse/ClickHouse/pull/27382)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 設定 `log_formatted_queries` を追加し、フォーマット済みクエリを追加で `system.query_log` に記録できるようにしました。これは正規化済みクエリの解析に有用です。`normalizeQuery` や `normalizeQueryKeepNames` といった関数は、パフォーマンス向上のためにクエリのパースやフォーマットを行わないためです。 [#27380](https://github.com/ClickHouse/ClickHouse/pull/27380) ([Amos Bird](https://github.com/amosbird))。
* Hyperscan 関連の関数（`multiMatchAny` など）で巨大な正規表現が使用されるのを防ぐために、`max_hyperscan_regexp_length` と `max_hyperscan_regexp_total_length` の 2 つの設定を追加しました。 [#27378](https://github.com/ClickHouse/ClickHouse/pull/27378) ([Amos Bird](https://github.com/amosbird)).
* ビットマップ集約関数が消費するメモリが、メモリ制限の対象として考慮されるようになりました。これにより [#26555](https://github.com/ClickHouse/ClickHouse/issues/26555) が解決されました。 [#27252](https://github.com/ClickHouse/ClickHouse/pull/27252) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* S3 プロキシリゾルバーに 10 秒のキャッシュを追加。 [#27216](https://github.com/ClickHouse/ClickHouse/pull/27216) ([ianton-ru](https://github.com/ianton-ru)).
* グローバルミューテックスを、正規表現ごとの個別のミューテックスに分割しました。これにより、大規模な正規表現の構築によって他の関連スレッドがブロックされるのを防ぎます。 [#27211](https://github.com/ClickHouse/ClickHouse/pull/27211) ([Amos Bird](https://github.com/amosbird)).
* PostgreSQL データベースエンジン向けのスキーマをサポート。 [#27166](https://github.com/ClickHouse/ClickHouse/issues/27166) をクローズ。 [#27198](https://github.com/ClickHouse/ClickHouse/pull/27198)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* clickhouse-client でメモリ使用量を追跡。 [#27191](https://github.com/ClickHouse/ClickHouse/pull/27191) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* クエリが開始に失敗した場合でも `system.query_log` に `query_kind` を記録するようにしました。 [#27182](https://github.com/ClickHouse/ClickHouse/pull/27182) ([Amos Bird](https://github.com/amosbird)).
* テーブル `system.replicas` に、レプリカ名をレプリカのアクティブ状態にマッピングするカラム `replica_is_active` を追加しました。 [#27138](https://github.com/ClickHouse/ClickHouse/issues/27138) をクローズしました。 [#27180](https://github.com/ClickHouse/ClickHouse/pull/27180)（[Maksim Kita](https://github.com/kitaisreal)）。
* Web UI でサーバー URI を介してクエリ設定を渡せるようにしました。 [#27177](https://github.com/ClickHouse/ClickHouse/pull/27177) ([kolsys](https://github.com/kolsys)).
* `MaxPushedDDLEntryID` という新しいメトリクスを追加しました。これは、現在のノードが ZooKeeper にプッシュした DDL エントリ ID の最大値を表します。 [#27174](https://github.com/ClickHouse/ClickHouse/pull/27174) ([Fuwang Hu](https://github.com/fuwhu)).
* `clickhouse-keeper` が znode を作成する際の存在条件の判定と空文字列ノードの判定を改善しました。 [#27125](https://github.com/ClickHouse/ClickHouse/pull/27125) ([小路](https://github.com/nicelulu))。
* Merge JOIN は右側の空集合を正しく処理します。 [#27078](https://github.com/ClickHouse/ClickHouse/pull/27078) ([Vladimir C](https://github.com/vdimir)).
* 関数をシャードレベルの定数として扱えるようになりました。これは、分散テーブルのコンテキストで実行された場合は通常のカラムを生成し、それ以外の場合は定数値を生成することを意味します。代表的な関数としては、`hostName()`, `tcpPort()`, `version()`, `buildId()`, `uptime()` などがあります。 [#27020](https://github.com/ClickHouse/ClickHouse/pull/27020) ([Amos Bird](https://github.com/amosbird))。
* `extractAllGroupsHorizontal` を更新しました。省略可能な 3 番目の引数で、行ごとのマッチ数の上限を設定できるようになりました。 [#26961](https://github.com/ClickHouse/ClickHouse/pull/26961) ([Vasily Nemkov](https://github.com/Enmk))。
* `system.rocksdb` テーブルを通じて `RocksDB` の統計情報を公開します。ClickHouse の設定 (`rocksdb...` キー) から RocksDB のオプションを読み込みます。注意: ClickHouse は RocksDB に依存しておらず、これは追加の統合ストレージエンジンの 1 つにすぎません。 [#26821](https://github.com/ClickHouse/ClickHouse/pull/26821) ([Azat Khuzhin](https://github.com/azat)).
* 内部の RocksDB ログを簡潔化。注意: ClickHouse は RocksDB に依存しておらず、これは追加の統合ストレージエンジンの 1 つに過ぎません。これにより [#26252](https://github.com/ClickHouse/ClickHouse/issues/26252) がクローズされました。[#26789](https://github.com/ClickHouse/ClickHouse/pull/26789) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* デフォルトロールの変更は、新規セッションにのみ影響します。 [#26759](https://github.com/ClickHouse/ClickHouse/pull/26759) ([Vitaly Baranov](https://github.com/vitlibar)).
* docker ではデフォルトで Watchdog が無効化されました。ctrl+c が処理されない問題を修正。 [#26757](https://github.com/ClickHouse/ClickHouse/pull/26757) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* `SET PROFILE` は、指定されたプロファイルに制約が設定されている場合、それらの制約にも適用されるようになりました。 [#26730](https://github.com/ClickHouse/ClickHouse/pull/26730) ([Vitaly Baranov](https://github.com/vitlibar))。
* `KILL QUERY` リクエストの処理を改善しました。 [#26675](https://github.com/ClickHouse/ClickHouse/pull/26675) ([Raúl Marín](https://github.com/Algunenano)).
* `mapPopulatesSeries` 関数が `Map` 型をサポートしました。 [#26663](https://github.com/ClickHouse/ClickHouse/pull/26663) ([Ildus Kurbangaliev](https://github.com/ildus))。
* `skip_unavailable_shards` 使用時に発生していた過剰な（2倍の）接続試行を修正しました。 [#26658](https://github.com/ClickHouse/ClickHouse/pull/26658) ([Azat Khuzhin](https://github.com/azat))。
* 接続が失敗した場合（EMFILE など）に `clickhouse-benchmark` がハングしないようにしました。 [#26656](https://github.com/ClickHouse/ClickHouse/pull/26656) ([Azat Khuzhin](https://github.com/azat)).
* Kafka エンジンで使用可能なスレッド数を増やしました。 [#26642](https://github.com/ClickHouse/ClickHouse/pull/26642) ([feihengye](https://github.com/feihengye)).
* `clickhouse-benchmark` にラウンドロビンのサポートを追加しました（統計レポートを除き、通常のマルチホスト／ポート実行と違いはありません）。 [#26607](https://github.com/ClickHouse/ClickHouse/pull/26607) ([Azat Khuzhin](https://github.com/azat)).
* `clickhouse-local` を使用した DDL クエリで、実行可能ディクショナリ（`executable`、`executable_pool`）を作成できるようになりました。[#22355](https://github.com/ClickHouse/ClickHouse/issues/22355) をクローズ。[#26510](https://github.com/ClickHouse/ClickHouse/pull/26510)（[Maksim Kita](https://github.com/kitaisreal)）。
* `mysql` および `postgresql` 互換プロトコルハンドラー向けにクライアントクエリ種別を設定します。 [#26498](https://github.com/ClickHouse/ClickHouse/pull/26498) ([anneji-dev](https://github.com/anneji-dev)).
* `distributed_push_down_limit=1` を使用して、`SELECT * FROM dist ORDER BY key LIMIT 10` のようなクエリに対してシャード側で `LIMIT` を適用します。`SELECT DISTINCT shading_key FROM dist ORDER BY key` のようなクエリに対しては、`Distinct` / `LIMIT BY` のステップを実行しないようにします。これにより、`distributed_push_down_limit` が `optimize_distributed_group_by_sharding_key` 最適化によって尊重されるようになりました。 [#26466](https://github.com/ClickHouse/ClickHouse/pull/26466) ([Azat Khuzhin](https://github.com/azat)).
* protobuf を 3.17.3 に更新しました。変更履歴は [https://github.com/protocolbuffers/protobuf/releases](https://github.com/protocolbuffers/protobuf/releases) で確認できます。[#26424](https://github.com/ClickHouse/ClickHouse/pull/26424)（[Ilya Yatsishin](https://github.com/qoega)）。
* 大規模クラスタでテイルレイテンシを軽減するための `use_hedged_requests` 設定を有効化しました。 [#26380](https://github.com/ClickHouse/ClickHouse/pull/26380) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* ユーザーの許可ホスト一覧に存在しないホストが指定された場合の挙動を改善。 [#26368](https://github.com/ClickHouse/ClickHouse/pull/26368) ([ianton-ru](https://github.com/ianton-ru)).
* `CREATE TABLE` から `Distributed` ディレクトリモニターの設定を行えるようにしました（例: `CREATE TABLE dist (key Int) Engine=Distributed(cluster, db, table) SETTINGS monitor_batch_inserts=1` など）。 [#26336](https://github.com/ClickHouse/ClickHouse/pull/26336) ([Azat Khuzhin](https://github.com/azat)).
* Web UI のサーバーアドレスが Web UI のオリジンと異なる場合、そのサーバーアドレスを Web UI の履歴 URL に保存するようにしました。これにより [#26044](https://github.com/ClickHouse/ClickHouse/issues/26044) がクローズされました。 [#26322](https://github.com/ClickHouse/ClickHouse/pull/26322)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `sleep` / `sleepEachRow` のプロファイル用呼び出しにイベントを追加。 [#26320](https://github.com/ClickHouse/ClickHouse/pull/26320) ([Raúl Marín](https://github.com/Algunenano)).
* 異なるクラスタ間でシャードの接続を再利用できるようにします。また、`cluster` テーブル関数を使用する際に新規接続の作成を回避します。 [#26318](https://github.com/ClickHouse/ClickHouse/pull/26318) ([Amos Bird](https://github.com/amosbird)).
* デフォルト値を持つパラメータによって、古い一時ディレクトリを削除する処理の実行間隔を制御できるようにしました。 [#26212](https://github.com/ClickHouse/ClickHouse/issues/26212)。 [#26313](https://github.com/ClickHouse/ClickHouse/pull/26313) ([fastio](https://github.com/fastio))。
* 関数 `range` によって生成されるデータ量の安全のためのしきい値を調整できる設定 `function_range_max_elements_in_block` を追加しました。これにより [#26303](https://github.com/ClickHouse/ClickHouse/issues/26303) がクローズされました。 [#26305](https://github.com/ClickHouse/ClickHouse/pull/26305) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* サンプリング時ではなくテーブル作成時にハッシュ関数をチェックするようにしました。MergeTree に設定を追加し、誤ったサンプリング列でテーブルが作成されていてもサンプリングが一度も使われない場合には、例外を発生させずにサーバーを起動できるよう、この設定を無効化できるようにしました。 [#26256](https://github.com/ClickHouse/ClickHouse/pull/26256) ([zhaoyu](https://github.com/zxc111)).
* `output_format_avro_string_column_pattern` 設定を追加し、指定した String カラムを、デフォルトの bytes ではなく string として Avro に出力できるようにしました。[#22414](https://github.com/ClickHouse/ClickHouse/issues/22414) を実装。 [#26245](https://github.com/ClickHouse/ClickHouse/pull/26245)（[Ilya Golshtein](https://github.com/ilejn)）。
* `Log` および `TinyLog` テーブル向けに、`system.columns` テーブルへ列サイズに関する情報を追加。これにより [#9001](https://github.com/ClickHouse/ClickHouse/issues/9001) がクローズされました。 [#26241](https://github.com/ClickHouse/ClickHouse/pull/26241) ([Nikolay Degterinsky](https://github.com/evillique))。
* カスタムディスク構成があり、一部のディスク上に `detached` ディレクトリが存在しない場合でも、`system.detached_parts` テーブルをクエリするときに例外をスローしないようにしました。これにより [#26078](https://github.com/ClickHouse/ClickHouse/issues/26078) がクローズされました。[#26236](https://github.com/ClickHouse/ClickHouse/pull/26236)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `now()`, `today()` のような定数式を含む、キー内の非決定論的関数をチェックします。これにより [#25875](https://github.com/ClickHouse/ClickHouse/issues/25875) がクローズされます。また、[#11333](https://github.com/ClickHouse/ClickHouse/issues/11333) もクローズされます。[#26235](https://github.com/ClickHouse/ClickHouse/pull/26235)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* PostgreSQL テーブルエンジンで timestamp および timestamptz データ型を `DateTime64` に変換。 [#26234](https://github.com/ClickHouse/ClickHouse/pull/26234) ([jasine](https://github.com/jasine)).
* プロジェクションに対して積極的な `IN` インデックス解析を適用し、より良いプロジェクション候補を選択できるようにしました。 [#26218](https://github.com/ClickHouse/ClickHouse/pull/26218) ([Amos Bird](https://github.com/amosbird)).
* スカラ関数が渡された場合、IN に対する GLOBAL キーワードを不要にしました。以前のバージョンでは、ユーザーが `GLOBAL IN f(x)` を指定すると例外がスローされていました。 [#26217](https://github.com/ClickHouse/ClickHouse/pull/26217) ([Amos Bird](https://github.com/amosbird)).
* 例外メッセージにエラー ID（`BAD_ARGUMENTS` のようなもの）を追加しました。これにより [#25862](https://github.com/ClickHouse/ClickHouse/issues/25862) がクローズされました。 [#26172](https://github.com/ClickHouse/ClickHouse/pull/26172)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* clickhouse-local の `--progress` オプションで不正な出力が行われる問題を修正しました。プログレスバーは 100% に達した時点でクリアされます（`clickhouse-client` と同様です）。[#17484](https://github.com/ClickHouse/ClickHouse/issues/17484) をクローズ。[#26128](https://github.com/ClickHouse/ClickHouse/pull/26128)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `merge_selecting_sleep_ms` 設定を追加。 [#26120](https://github.com/ClickHouse/ClickHouse/pull/26120) ([lthaooo](https://github.com/lthaooo)).
* 1 ブロックの先読みを伴う複雑な Linux AIO の使用を廃止し、代わりに O&#95;DIRECT を用いたシンプルな同期 IO に置き換えました。以前のバージョンでは、`max_threads` が 1 より大きい場合、設定 `min_bytes_to_use_direct_io` が正しく動作しないことがありました。クエリに対してはデフォルトで無効、大規模なマージに対してはデフォルトで有効となっているダイレクト IO での読み取りは、これまでより効率の低い方法で動作するようになります。これにより [#25997](https://github.com/ClickHouse/ClickHouse/issues/25997) が解決されました。 [#26003](https://github.com/ClickHouse/ClickHouse/pull/26003)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `REPLACE TABLE` クエリで `Distributed` テーブルをフラッシュする。[#24566](https://github.com/ClickHouse/ClickHouse/issues/24566) を解決。新しいテーブルへの挿入が失敗した場合、`[CREATE OR] REPLACE TABLE ... AS SELECT` クエリでテーブルを置き換えたり（または作成したり）しないようにする。[#23175](https://github.com/ClickHouse/ClickHouse/issues/23175) を解決。[#25895](https://github.com/ClickHouse/ClickHouse/pull/25895)（[tavplubix](https://github.com/tavplubix)）。
* `system.query&#95;log` に `views` 列を追加し、そのクエリで実行された（マテリアライズドまたはライブ）ビューの名前を含めるようにしました。クエリの実行中に実行された各ビューに関する情報を保持する新しいログテーブル（`system.query_views_log`）を追加しました。ビューの実行方法を変更しました。ビューの実行中に例外がスローされた場合、すでに開始されているビューは完了するまで実行を継続します。これは以前は `parallel&#95;view&#95;processing=true` の場合の動作でしたが、今後は常にこの動作になります。依存ビューはコンテキストに対して読み取り進捗を報告するようになりました。 [#25714](https://github.com/ClickHouse/ClickHouse/pull/25714) ([Raúl Marín](https://github.com/Algunenano)).
* 分散クエリの実行完了後に、接続のドレインを非同期で行うようにしました。新しいサーバー設定 `max_threads_for_connection_collector` が追加され、バックグラウンドで接続を回収するワーカー数を指定できます。プールが一杯の場合、接続は同期的にドレインされますが、以前とは少し動作が変わっています。クライアントに EOS を送信した後にドレインが行われ、クエリは十分なデータを受信した時点ですぐに成功となり、例外はクライアントにスローされるのではなくログに記録されます。設定 `drain_timeout`（デフォルトは 3 秒）を追加しました。接続ドレインは、タイムアウトに達すると接続を切断します。[#25674](https://github.com/ClickHouse/ClickHouse/pull/25674)（[Amos Bird](https://github.com/amosbird)）。
* 設定ファイルで複数の include をサポート。ユーザー設定やリモートサーバー設定を複数のソースから読み込むことが可能です。`from_zk`、`from_env`、または `incl` 属性を指定した `<include />` 要素を記述するだけで、その場所が対応する内容に置き換えられます。[#24404](https://github.com/ClickHouse/ClickHouse/pull/24404)（[nvartolomei](https://github.com/nvartolomei)）。
* `insert_distributed_one_random_shard = 1` を使用した分散テーブルへの複数ブロック挿入の不具合を修正しました。これはマイナーな機能です。改善としてマークしました。 [#23140](https://github.com/ClickHouse/ClickHouse/pull/23140) ([Amos Bird](https://github.com/amosbird))。
* `Map` 型で `LowCardinality` および `FixedString` のキー/値をサポートしました。 [#21543](https://github.com/ClickHouse/ClickHouse/pull/21543) ([hexiaoting](https://github.com/hexiaoting)).
* ローカルディスク設定の再読み込みを有効化。 [#19526](https://github.com/ClickHouse/ClickHouse/pull/19526) ([taiyang-li](https://github.com/taiyang-li))。

#### バグ修正 {#bug-fix-2}


* レプリカの不整合を引き起こす可能性のあるバグをいくつか修正しました。 [#27808](https://github.com/ClickHouse/ClickHouse/pull/27808) ([tavplubix](https://github.com/tavplubix)).
* `DROP PART` において、`Unexpected merged part intersects drop range` というエラーを引き起こす可能性のあるまれなバグを修正しました。 [#27807](https://github.com/ClickHouse/ClickHouse/pull/27807) ([alesapin](https://github.com/alesapin))。
* Kafka から NULL（tombstone）メッセージが送られてきた場合に、一部のフォーマットでクラッシュする問題を防止。 [#19255](https://github.com/ClickHouse/ClickHouse/issues/19255) をクローズ。 [#27794](https://github.com/ClickHouse/ClickHouse/pull/27794)（[filimonov](https://github.com/filimonov)）。
* サブクエリ内での `UNION DISTINCT` 使用時のカラムフィルタリングを修正しました。[#27578](https://github.com/ClickHouse/ClickHouse/issues/27578) をクローズ。[#27689](https://github.com/ClickHouse/ClickHouse/pull/27689)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `arrayHas` のような関数が、`DateTime` や `DateTime64` などの異なる非数値型に対する Nullable な LowCardinality 配列に適用されたときに発生する不正な型キャストを修正しました。以前のバージョンでは誤ったキャストが行われていましたが、新しいバージョンでは例外がスローされます。これにより [#26330](https://github.com/ClickHouse/ClickHouse/issues/26330) がクローズされました。 [#27682](https://github.com/ClickHouse/ClickHouse/pull/27682) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* postgresql テーブル関数が接続をクローズしない問題を修正しました。[#26088](https://github.com/ClickHouse/ClickHouse/issues/26088) をクローズします。 [#27662](https://github.com/ClickHouse/ClickHouse/pull/27662) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `Unexpected merged part ... intersecting drop range ...` エラーの別の発生ケースを修正しました。 [#27656](https://github.com/ClickHouse/ClickHouse/pull/27656) ([tavplubix](https://github.com/tavplubix))。
* `Distributed` テーブルでエイリアス列に関連するエラーを修正。 [#27652](https://github.com/ClickHouse/ClickHouse/pull/27652) ([Vladimir C](https://github.com/vdimir)).
* `max_memory_usage*` を 0 以外の値に設定した後、再び 0（無制限）に戻すことができませんでしたが、修正されました。 [#27638](https://github.com/ClickHouse/ClickHouse/pull/27638) ([tavplubix](https://github.com/tavplubix)).
* コンポーネントから時間値を構築する際に発生していたアンダーフローを修正しました。 [#27193](https://github.com/ClickHouse/ClickHouse/issues/27193) をクローズしました。 [#27605](https://github.com/ClickHouse/ClickHouse/pull/27605) ([Vasily Nemkov](https://github.com/Enmk)).
* 一部のパーツに欠損カラムが含まれている場合に、プロジェクションのマテリアライズ中にクラッシュする問題を修正しました。これにより [#27512](https://github.com/ClickHouse/ClickHouse/issues/27512) が修正されます。 [#27528](https://github.com/ClickHouse/ClickHouse/pull/27528) ([Amos Bird](https://github.com/amosbird))。
* メトリクス `BackgroundMessageBrokerSchedulePoolTask` を修正。おそらくタイプミス。 [#27452](https://github.com/ClickHouse/ClickHouse/pull/27452) ([Ben](https://github.com/benbiti)).
* シャード数ゼロ時の集約を伴う分散クエリを修正しました。 [#27427](https://github.com/ClickHouse/ClickHouse/pull/27427) ([Azat Khuzhin](https://github.com/azat)).
* `/proc/meminfo` に KB 接尾辞が含まれない場合の互換性対応。 [#27361](https://github.com/ClickHouse/ClickHouse/pull/27361) ([Mike Kot](https://github.com/myrrc))。
* 行レベルセキュリティ、PREWHERE、および LowCardinality フィルタを使用するクエリで誤った結果が返される問題を修正しました。[#27179](https://github.com/ClickHouse/ClickHouse/issues/27179) を修正。[#27329](https://github.com/ClickHouse/ClickHouse/pull/27329)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 旧構文で作成された MergeTree テーブルに対するパーティション ID の検証が誤っていた問題を修正しました。 [#27328](https://github.com/ClickHouse/ClickHouse/pull/27328) ([tavplubix](https://github.com/tavplubix))。
* 並列フォーマット（CSV / TSV）使用時の MySQL プロトコルを修正しました。 [#27326](https://github.com/ClickHouse/ClickHouse/pull/27326) ([Raúl Marín](https://github.com/Algunenano)).
* サンプリングを伴うクエリで発生する `Cannot find column` エラーを修正しました。[#24574](https://github.com/ClickHouse/ClickHouse/issues/24574) で導入された問題です。[#26522](https://github.com/ClickHouse/ClickHouse/issues/26522) を解決します。[#27301](https://github.com/ClickHouse/ClickHouse/pull/27301)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 一部のクエリで、`PREWHERE` 句内の `LowCardinality` に対して発生する `Expected ColumnLowCardinality, got UInt8` や `Bad cast from type DB::ColumnVector<char8_t> to DB::ColumnLowCardinality` といったエラーを修正しました。さらに重要な点として、エラーメッセージ内に空白がない問題も修正しました。[#23515](https://github.com/ClickHouse/ClickHouse/issues/23515) を修正。[#27298](https://github.com/ClickHouse/ClickHouse/pull/27298)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `distributed_group_by_no_merge = 2` と `distributed_push_down_limit = 1`、または `optimize_distributed_group_by_sharding_key = 1` と `LIMIT BY` および `LIMIT OFFSET` の組み合わせに関する問題を修正しました。 [#27249](https://github.com/ClickHouse/ClickHouse/pull/27249) ([Azat Khuzhin](https://github.com/azat))。これらは誰も使用していないと思われる、かなりマイナーな設定の組み合わせです。
* 非レプリケートの MergeTree で、無効なパーティションにより停止していたミューテーションを修正しました。 [#27248](https://github.com/ClickHouse/ClickHouse/pull/27248) ([Azat Khuzhin](https://github.com/azat)).
* あいまいな場合、ラムダ関数は他のエイリアスや識別子よりも引数を優先して解釈します。 [#27235](https://github.com/ClickHouse/ClickHouse/pull/27235) ([Raúl Marín](https://github.com/Algunenano)).
* マージ結合のカラム構造を修正し、[#27091](https://github.com/ClickHouse/ClickHouse/issues/27091) をクローズしました。[#27217](https://github.com/ClickHouse/ClickHouse/pull/27217)（[Vladimir C](https://github.com/vdimir)）。
* まれに `system.detached_parts` テーブルに一部のパーツについて誤った情報が含まれる場合がありましたが、この問題は修正されました。 [#27114](https://github.com/ClickHouse/ClickHouse/issues/27114) を修正。 [#27183](https://github.com/ClickHouse/ClickHouse/pull/27183)（[tavplubix](https://github.com/tavplubix)）。
* 空の配列を渡した場合に `multiSearch*` 関数で未初期化メモリが使用される問題を修正し、[#27169](https://github.com/ClickHouse/ClickHouse/issues/27169) をクローズ。[#27181](https://github.com/ClickHouse/ClickHouse/pull/27181)（[Vladimir C](https://github.com/vdimir)）。
* GRPCServer の同期処理を修正。この PR は [#27024](https://github.com/ClickHouse/ClickHouse/issues/27024) を修正します。[#27064](https://github.com/ClickHouse/ClickHouse/pull/27064)（[Vitaly Baranov](https://github.com/vitlibar)）。
* `cache`、`complex_key_cache`、`ssd_cache`、`complex_key_ssd_cache` の設定パースを修正しました。`allow_read_expired_keys`、`max_update_queue_size`、`update_queue_push_timeout_milliseconds`、`query_wait_timeout_milliseconds` の各オプションが、`cache` 以外のタイプの辞書ではパースされていませんでした。 [#27032](https://github.com/ClickHouse/ClickHouse/pull/27032) ([Maksim Kita](https://github.com/kitaisreal)).
* DROP&#95;RANGE との競合状態により発生しうるミューテーションスタックを修正。 [#27002](https://github.com/ClickHouse/ClickHouse/pull/27002) ([Azat Khuzhin](https://github.com/azat)).
* `ALTER TABLE ... PARTITION ID xxx` のようなクエリで指定されたパーティション ID が、正しく有効な値であるか検証されるようになりました。 [#25718](https://github.com/ClickHouse/ClickHouse/issues/25718) を修正。 [#26963](https://github.com/ClickHouse/ClickHouse/pull/26963)（[alesapin](https://github.com/alesapin)）。
* 一部のケースで、複数の `JOIN` を使用した際に発生する「Unknown column name」エラーを修正し、[#26899](https://github.com/ClickHouse/ClickHouse/issues/26899) をクローズ。[#26957](https://github.com/ClickHouse/ClickHouse/pull/26957)（[Vladimir C](https://github.com/vdimir)）。
* カスタム TLD の読み取りを修正（小さいバッファまたは大きなファイルの場合に処理が停止してしまう問題を解消）。 [#26948](https://github.com/ClickHouse/ClickHouse/pull/26948) ([Azat Khuzhin](https://github.com/azat)).
* `DEFAULT` 列が、`DEFAULT` 式を持たない他の非 `MATERIALIZED` 列を参照している場合に発生するエラー `Missing columns: 'xxx'` を修正しました。[#26591](https://github.com/ClickHouse/ClickHouse/issues/26591) を解決。[#26900](https://github.com/ClickHouse/ClickHouse/pull/26900)（[alesapin](https://github.com/alesapin)）。
* `library` 辞書ソース用の `library-bridge` における辞書キーの読み込みを修正しました。 [#26834](https://github.com/ClickHouse/ClickHouse/pull/26834) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 一部のコンビネータを適用すると、集約関数のパラメータが失われ、`Conversion from AggregateFunction(topKArray, Array(String)) to AggregateFunction(topKArray(10), Array(String)) is not supported` のような例外が発生することがありました。これは修正されています。 [#26196](https://github.com/ClickHouse/ClickHouse/issues/26196) および [#26433](https://github.com/ClickHouse/ClickHouse/issues/26433) を修正します。 [#26814](https://github.com/ClickHouse/ClickHouse/pull/26814) ([tavplubix](https://github.com/tavplubix))。
* `system.part_log` の `REMOVE_PART` に `event_time_microseconds` の値を追加しました。以前のバージョンでは設定されていませんでした。 [#26720](https://github.com/ClickHouse/ClickHouse/pull/26720) ([Azat Khuzhin](https://github.com/azat)).
* `ReplicatedMergeTree` テーブルのシャットダウン時にデータを削除しないようにして、データとメタデータの不整合が発生しないようにしました。 [#26716](https://github.com/ClickHouse/ClickHouse/pull/26716) ([nvartolomei](https://github.com/nvartolomei)).
* `SET ROLE` が正しく動作しない場合がありましたが、この PR で修正されました。 [#26707](https://github.com/ClickHouse/ClickHouse/pull/26707) ([Vitaly Baranov](https://github.com/vitlibar)).
* 並列フォーマットのためのいくつかの修正（[https://github.com/ClickHouse/ClickHouse/issues/26694](https://github.com/ClickHouse/ClickHouse/issues/26694)）。[#26703](https://github.com/ClickHouse/ClickHouse/pull/26703)（[Raúl Marín](https://github.com/Algunenano)）。
* ウィンドウ関数における潜在的な `nullptr` の逆参照を修正しました。これにより [#25276](https://github.com/ClickHouse/ClickHouse/issues/25276) が解決されます。[#26668](https://github.com/ClickHouse/ClickHouse/pull/26668)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* 空の `clickhouse-client` 履歴ファイルについて、（3 年前のバージョンの `clickhouse-client` のフォーマットからのアップグレード時に行われる）履歴ファイル変換処理を修正。 [#26589](https://github.com/ClickHouse/ClickHouse/pull/26589) ([Azat Khuzhin](https://github.com/azat)).
* groupBitmapAnd/Or/Xor の誤った関数名を修正しました（一部の場面で誤って表示される場合がありました）。[#26557](https://github.com/ClickHouse/ClickHouse/pull/26557)（[Amos Bird](https://github.com/amosbird)）。
* clickhouse-server の Docker エントリポイント内の `chown` コマンドのチェックを更新しました。これにより、Kubernetes 上でクラスタ Pod の再起動が失敗（またはタイムアウト）するバグが修正されました。 [#26545](https://github.com/ClickHouse/ClickHouse/pull/26545) ([Ky Li](https://github.com/Kylinrix))。
* `RabbitMQ` のセットアップが開始されていない場合に、`RabbitMQ` のシャットダウン時にクラッシュが発生する問題を修正しました。 [#26504](https://github.com/ClickHouse/ClickHouse/issues/26504) をクローズ。 [#26529](https://github.com/ClickHouse/ClickHouse/pull/26529)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `CREATE DICTIONARY` クエリで辞書名またはデータベース名がクォートされている場合に発生する問題を修正。[#26491](https://github.com/ClickHouse/ClickHouse/issues/26491) をクローズ。[#26508](https://github.com/ClickHouse/ClickHouse/pull/26508)（[Maksim Kita](https://github.com/kitaisreal)）。
* 列エイリアスの書き換え後に壊れていたカラム名の解決を修正しました。これにより [#26432](https://github.com/ClickHouse/ClickHouse/issues/26432) が解決されます。[#26475](https://github.com/ClickHouse/ClickHouse/pull/26475)（[Amos Bird](https://github.com/amosbird)）。
* いくつかのファジングで検出された msan クラッシュを修正しました。 [#22517](https://github.com/ClickHouse/ClickHouse/issues/22517) を修正します。 [#26428](https://github.com/ClickHouse/ClickHouse/pull/26428)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `partial_merge_join` のクローズ時に発生する、無限に続く非結合ブロックストリームを修正 [#26325](https://github.com/ClickHouse/ClickHouse/issues/26325)。[#26374](https://github.com/ClickHouse/ClickHouse/pull/26374)（[Vladimir C](https://github.com/vdimir)）。
* 削除済みユーザーとしてログインした際に発生する可能性のあるクラッシュを修正しました。このPRは [#26073](https://github.com/ClickHouse/ClickHouse/issues/26073) を修正します。 [#26363](https://github.com/ClickHouse/ClickHouse/pull/26363) ([Vitaly Baranov](https://github.com/vitlibar)).
* 複数カラムに対して `optimize_distributed_group_by_sharding_key` を修正（`optimize_skip_unused_shards=1` / `allow_nondeterministic_optimize_skip_unused_shards=1` かつ、シャーディングキー式に複数カラムが含まれる場合に誤った結果が生じる問題を修正）。[#26353](https://github.com/ClickHouse/ClickHouse/pull/26353)（[Azat Khuzhin](https://github.com/azat)）。
* 失われたレプリカのリカバリ処理において、レプリカの不整合を引き起こす可能性があったまれなバグを修正しました。 [#26321](https://github.com/ClickHouse/ClickHouse/pull/26321) ([tavplubix](https://github.com/tavplubix)).
* 内部バッファの末尾にエスケープシーケンスが存在する場合の zstd デコンプレッション（テーブルデータとは無関係な、zstd フレーミング形式でのインポート／エクスポート用）を修正しました。[#26013](https://github.com/ClickHouse/ClickHouse/issues/26013) をクローズ。[#26314](https://github.com/ClickHouse/ClickHouse/pull/26314)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* totals を伴う join における論理エラーを修正し、[#26017](https://github.com/ClickHouse/ClickHouse/issues/26017) をクローズ。[#26250](https://github.com/ClickHouse/ClickHouse/pull/26250)（[Vladimir C](https://github.com/vdimir)）。
* `system.stack_trace` テーブルの `thread_name` 列から不要な改行を削除しました。これにより [#24124](https://github.com/ClickHouse/ClickHouse/issues/24124) が修正されました。[#26210](https://github.com/ClickHouse/ClickHouse/pull/26210)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 複数の `untuple` 式が使用された場合に発生する可能性のあるクラッシュを修正しました。 [#26179](https://github.com/ClickHouse/ClickHouse/pull/26179) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Enum にゼロの値がない場合、Nullable Enum の `toString` で例外をスローしないようにし、[#25806](https://github.com/ClickHouse/ClickHouse/issues/25806) をクローズしました。 [#26123](https://github.com/ClickHouse/ClickHouse/pull/26123)（[Vladimir C](https://github.com/vdimir)）。
* クエリ実行中に例外が発生した際に、ClickHouse が送信する MySQL プロトコルパケット内の誤った `sequence_id` を修正しました。この問題により、MySQL クライアントが ClickHouse サーバーへの接続をリセットしてしまう可能性がありました。[#21184](https://github.com/ClickHouse/ClickHouse/issues/21184) を修正します。[#26051](https://github.com/ClickHouse/ClickHouse/pull/26051)（[tavplubix](https://github.com/tavplubix)）。
* `cutToFirstSignificantSubdomainCustom()` / `cutToFirstSignificantSubdomainCustomWithWWW()` / `firstSignificantSubdomainCustom()` が const に対して誤った型を返し、その結果 `optimize_skip_unused_shards` が動作しない不具合を修正。 [#26041](https://github.com/ClickHouse/ClickHouse/pull/26041) ([Azat Khuzhin](https://github.com/azat)).
* `prewhere` を伴う通常の `projection` を使用する際に発生し得るヘッダーの不整合を修正します。これにより [#26020](https://github.com/ClickHouse/ClickHouse/issues/26020) が解決されます。 [#26038](https://github.com/ClickHouse/ClickHouse/pull/26038)（[Amos Bird](https://github.com/amosbird)）。
* remote() 用の関数を伴わない列からの sharding&#95;key を修正（以前は `select * from remote('127.1', system.one, dummy)` が `Unknown column: dummy, there are only columns .` エラーを引き起こしていた）。[#25824](https://github.com/ClickHouse/ClickHouse/pull/25824)（[Azat Khuzhin](https://github.com/azat)）。
* `MaterializeMySQL` からの `SELECT` 実行時に発生していた `Not found column ...` および `Missing column ...` エラーを修正しました。 [#23708](https://github.com/ClickHouse/ClickHouse/issues/23708)、[#24830](https://github.com/ClickHouse/ClickHouse/issues/24830)、[#25794](https://github.com/ClickHouse/ClickHouse/issues/25794) を解決。 [#25822](https://github.com/ClickHouse/ClickHouse/pull/25822)（[tavplubix](https://github.com/tavplubix)）。
* 非 UInt64 型に対する `optimize_skip_unused_shards_rewrite_in` の動作を修正しました（最終的に誤ったシャードを選択したり、`Cannot infer type of an empty tuple` や `Function tuple requires at least one argument` をスローする可能性がありました）。 [#25798](https://github.com/ClickHouse/ClickHouse/pull/25798) ([Azat Khuzhin](https://github.com/azat)).

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-3}

- ステートフルおよびステートレステストをランダムなタイムゾーンで実行するようになりました。修正 [#12439](https://github.com/ClickHouse/ClickHouse/issues/12439)。Protobuf形式でStringをDateTimeとして読み取り、DateTimeをStringとして書き込む際にタイムゾーンが尊重されるようになりました。ArrowおよびParquet形式でUInt16をDateTimeとして読み取る際、DateがArrowおよびParquetではUInt16としてシリアライズされるため、まずDateとして扱った後、DateTimeのタイムゾーンを考慮してDateTimeに変換されるようになりました。GraphiteMergeTreeが時刻の丸め処理でタイムゾーンを尊重するようになりました。修正 [#5098](https://github.com/ClickHouse/ClickHouse/issues/5098)。作成者: @alexey-milovidov。[#15408](https://github.com/ClickHouse/ClickHouse/pull/15408) ([alesapin](https://github.com/alesapin))。
- `clickhouse-test`が[Jinja2](https://jinja.palletsprojects.com/en/3.0.x/templates/#synopsis)テンプレートを使用したSQLテストをサポートするようになりました。[#26579](https://github.com/ClickHouse/ClickHouse/pull/26579) ([Vladimir C](https://github.com/vdimir))。
- `clang-13`でのビルドサポートを追加しました。これにより [#27705](https://github.com/ClickHouse/ClickHouse/issues/27705) が解決されます。[#27714](https://github.com/ClickHouse/ClickHouse/pull/27714) ([alexey-milovidov](https://github.com/alexey-milovidov))。[#27777](https://github.com/ClickHouse/ClickHouse/pull/27777) ([Sergei Semin](https://github.com/syominsergey))
- 特定のCPU命令セットを使用する/しないビルドのためのCMakeオプションを追加しました。これは [#17469](https://github.com/ClickHouse/ClickHouse/issues/17469) および [#27509](https://github.com/ClickHouse/ClickHouse/issues/27509) に対応するものです。[#27508](https://github.com/ClickHouse/ClickHouse/pull/27508) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 動的ライブラリ使用時の補助プログラムのリンクを修正しました。[#26958](https://github.com/ClickHouse/ClickHouse/pull/26958) ([Raúl Marín](https://github.com/Algunenano))。
- RocksDBを`2021-07-16` masterに更新しました。[#26411](https://github.com/ClickHouse/ClickHouse/pull/26411) ([alexey-milovidov](https://github.com/alexey-milovidov))。

### ClickHouseリリース v21.8, 2021-08-12 {#clickhouse-release-v218-2021-08-12}

#### アップグレード時の注意事項 {#upgrade-notes}

- 新バージョンではシステムログテーブル(`system.query_log`、`system.query_thread_log`、`system.processes`、`system.opentelemetry_span_log`)に`Map`データ型を使用しています。これらのテーブルは新しいデータ型で自動作成されます。古いクエリをサポートするために仮想カラムが作成されます。解決 [#18698](https://github.com/ClickHouse/ClickHouse/issues/18698)。[#23934](https://github.com/ClickHouse/ClickHouse/pull/23934)、[#25773](https://github.com/ClickHouse/ClickHouse/pull/25773) ([hexiaoting](https://github.com/hexiaoting)、[sundy-li](https://github.com/sundy-li)、[Maksim Kita](https://github.com/kitaisreal))。バージョン21.8から古いバージョンに_ダウングレード_する場合は、ログを含むシステムテーブルを手動でクリーンアップする必要があります。`/var/lib/clickhouse/data/system/*_log`を確認してください。

#### 新機能 {#new-features}


- SQL/JSON標準の一部のサポートを追加しました。[#24148](https://github.com/ClickHouse/ClickHouse/pull/24148) ([l1tsolaiki](https://github.com/l1tsolaiki), [Kseniia Sumarokova](https://github.com/kssenii))。
- 一般的なシステムメトリクス(`system.asynchronous_metrics`および`system.asynchronous_metric_log`内)の収集を追加しました。対象はCPU使用率、ディスク使用率、メモリ使用率、IO、ネットワーク、ファイル、ロードアベレージ、CPU周波数、温度センサー、EDACカウンター、システム稼働時間です。また、スケジューリングジッターとメトリクス収集に費やされた時間に関するメトリクスも追加されました。ClickHouseにおける`atop`と同様に動作し、追加のツールがインストールされていない場合でも監視データへのアクセスを可能にします。[#9430](https://github.com/ClickHouse/ClickHouse/issues/9430)をクローズしました。[#24416](https://github.com/ClickHouse/ClickHouse/pull/24416) ([alexey-milovidov](https://github.com/alexey-milovidov), [Yegor Levankov](https://github.com/elevankoff))。
- MaterializedPostgreSQLテーブルエンジンとデータベースエンジンを追加しました。このデータベースエンジンは、データベース全体またはデータベーステーブルの任意のサブセットのレプリケーションを可能にします。[#20470](https://github.com/ClickHouse/ClickHouse/pull/20470) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 新しい関数`leftPad()`、`rightPad()`、`leftPadUTF8()`、`rightPadUTF8()`を追加しました。[#26075](https://github.com/ClickHouse/ClickHouse/pull/26075) ([Vitaly Baranov](https://github.com/vitlibar))。
- `ADD INDEX`コマンドに`FIRST`キーワードを追加し、インデックスリストの先頭にインデックスを追加できるようにしました。[#25904](https://github.com/ClickHouse/ClickHouse/pull/25904) ([xjewer](https://github.com/xjewer))。
- 既存のデータスキッピングインデックスに関する情報を含む`system.data_skipping_indices`テーブルを導入しました。[#7659](https://github.com/ClickHouse/ClickHouse/issues/7659)をクローズしました。[#25693](https://github.com/ClickHouse/ClickHouse/pull/25693) ([Dmitry Novik](https://github.com/novikd))。
- `bin`/`unbin`関数を追加しました。[#25609](https://github.com/ClickHouse/ClickHouse/pull/25609) ([zhaoyu](https://github.com/zxc111))。
- `mapAdd`および`mapSubtract`関数で`Map`と`UInt128`、`Int128`、`UInt256`、`Int256`型のサポートを追加しました。[#25596](https://github.com/ClickHouse/ClickHouse/pull/25596) ([Ildus Kurbangaliev](https://github.com/ildus))。
- `DISTINCT ON (columns)`式のサポートを追加しました。[#25404](https://github.com/ClickHouse/ClickHouse/issues/25404)をクローズしました。[#25589](https://github.com/ClickHouse/ClickHouse/pull/25589) ([Zijie Lu](https://github.com/TszKitLo40))。
- カスタム設定をデフォルトにリセットし、テーブルのメタデータから削除する機能を追加しました。これにより、システム/設定のデフォルト値を知らなくても変更をロールバックできます。[#14449](https://github.com/ClickHouse/ClickHouse/issues/14449)をクローズしました。[#17769](https://github.com/ClickHouse/ClickHouse/pull/17769) ([xjewer](https://github.com/xjewer))。
- `EXPLAIN PIPELINE graph = 1`クエリが送信された場合、Web UIでパイプラインをグラフとして表示するようにしました。[#26067](https://github.com/ClickHouse/ClickHouse/pull/26067) ([alexey-milovidov](https://github.com/alexey-milovidov))。

#### パフォーマンスの改善 {#performance-improvements}

- 集約関数のコンパイルを追加しました。有効にするには`compile_aggregate_expressions`オプションを使用してください。[#24789](https://github.com/ClickHouse/ClickHouse/pull/24789) ([Maksim Kita](https://github.com/kitaisreal))。
- 多数の列を持つテーブルからの読み取りを必要とする短いクエリのレイテンシを改善しました。[#26371](https://github.com/ClickHouse/ClickHouse/pull/26371) ([Anton Popov](https://github.com/CurtizJ))。

#### 改善 {#improvements}


* システムログテーブル（`system.query_log`、`system.query_thread_log`、`system.processes`、`system.opentelemetry_span_log`）に `Map` データ型を使用します。これらのテーブルは新しいデータ型で自動作成されます。古いクエリとの互換性を保つために仮想列が作成されます。[#18698](https://github.com/ClickHouse/ClickHouse/issues/18698) をクローズ。[#23934](https://github.com/ClickHouse/ClickHouse/pull/23934)、[#25773](https://github.com/ClickHouse/ClickHouse/pull/25773)（[hexiaoting](https://github.com/hexiaoting)、[sundy-li](https://github.com/sundy-li)、[Maksim Kita](https://github.com/kitaisreal)）。
* 複合キーを持ち、そのキーが 1 つの属性だけで構成される辞書について、関数 `dictGet` と `dictHas` でキー式を `tuple` でラップする必要がないようにしました。 [#26130](https://github.com/ClickHouse/ClickHouse/pull/26130) ([Maksim Kita](https://github.com/kitaisreal))。
* `AggregateFunction` の状態に対して関数 `bin` / `hex` を実装しました。 [#26094](https://github.com/ClickHouse/ClickHouse/pull/26094) ([zhaoyu](https://github.com/zxc111)).
* `empty` 関数および `notEmpty` 関数で `UUID` 型の引数をサポートします。`UUID` がすべてゼロ（nil UUID）の場合は空と見なされます。[#3446](https://github.com/ClickHouse/ClickHouse/issues/3446) をクローズします。[#25974](https://github.com/ClickHouse/ClickHouse/pull/25974)（[zhaoyu](https://github.com/zxc111)）。
* MySQL プロトコルでの `SET SQL_SELECT_LIMIT` のサポートを追加。 [#17115](https://github.com/ClickHouse/ClickHouse/issues/17115) をクローズ。 [#25972](https://github.com/ClickHouse/ClickHouse/pull/25972)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* ネットワーク通信に関する計測を強化: 受信/送信バイト数のカウンタを追加し、受信/送信回数のゲージを追加しました。欠落していたドキュメントを追加しました。[#5897](https://github.com/ClickHouse/ClickHouse/issues/5897) をクローズしました。 [#25962](https://github.com/ClickHouse/ClickHouse/pull/25962) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 設定 `optimize_move_to_prewhere_if_final` を追加。クエリに `FINAL` が含まれている場合、最適化 `move_to_prewhere` は `optimize_move_to_prewhere` と `optimize_move_to_prewhere_if_final` の両方が有効な場合にのみ有効になります。[#8684](https://github.com/ClickHouse/ClickHouse/issues/8684) をクローズ。 [#25940](https://github.com/ClickHouse/ClickHouse/pull/25940)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* JOIN されたテーブルの複雑な引用付き識別子を許可。 [#17861](https://github.com/ClickHouse/ClickHouse/issues/17861) をクローズ。 [#25924](https://github.com/ClickHouse/ClickHouse/pull/25924)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `Nested` データ型で Unicode（例: 中国語、キリル文字）コンポーネントをサポート。 [#25594](https://github.com/ClickHouse/ClickHouse/issues/25594) をクローズ。 [#25923](https://github.com/ClickHouse/ClickHouse/pull/25923) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `quantiles*` 関数が `aggregate_functions_null_for_empty` で動作するようにしました。 [#25892](https://github.com/ClickHouse/ClickHouse/issues/25892) をクローズしました。 [#25919](https://github.com/ClickHouse/ClickHouse/pull/25919)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* パラメトリック集約関数のパラメータとして、リテラルだけでなく任意の定数式（例：`1 + 2`）を使用できるようにします。また、パラメトリック集約関数内で、（`{param:UInt8}` のような）パラメータ化クエリのクエリパラメータを使用できるようにします。 [#11607](https://github.com/ClickHouse/ClickHouse/issues/11607) をクローズします。 [#25910](https://github.com/ClickHouse/ClickHouse/pull/25910)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 不正な `Date` のパースを試みた際に、例外が正しくスローされるようにしました。 [#6481](https://github.com/ClickHouse/ClickHouse/issues/6481) をクローズ。 [#25909](https://github.com/ClickHouse/ClickHouse/pull/25909)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 設定ファイルで複数の include をサポートしました。ユーザー設定やリモートサーバー設定を複数のソースから取り込めます。`from_zk`、`from_env` または `incl` 属性を持つ `<include />` 要素を配置するだけで、その部分が対応する内容に置き換えられます。 [#24404](https://github.com/ClickHouse/ClickHouse/pull/24404) ([nvartolomei](https://github.com/nvartolomei))。
* `"null"` という名前のカラム（バッククォートまたは二重引用符で指定する必要があります）および `ON CLUSTER` を含むクエリのサポート。 [#24035](https://github.com/ClickHouse/ClickHouse/issues/24035) をクローズ。 [#25907](https://github.com/ClickHouse/ClickHouse/pull/25907)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `JSONExtract` で `LowCardinality`、`Decimal`、`UUID` をサポート。 [#24606](https://github.com/ClickHouse/ClickHouse/issues/24606) をクローズ。 [#25900](https://github.com/ClickHouse/ClickHouse/pull/25900)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 履歴ファイルを `readline` フォーマットから `replxx` フォーマットへ変換しました。[#25888](https://github.com/ClickHouse/ClickHouse/pull/25888) ([Azat Khuzhin](https://github.com/azat)).
* `DROP PART` 実行後、または空のパートのバックグラウンド削除後に、パート同士が交差してしまう可能性がある問題を修正。 [#25884](https://github.com/ClickHouse/ClickHouse/pull/25884) ([alesapin](https://github.com/alesapin)).
* `ReplicatedMergeTree` テーブルにおける失われたパーツの処理を改善。`ReplicationQueue` のまれな不整合を修正。[#10368](https://github.com/ClickHouse/ClickHouse/issues/10368) を修正。[#25820](https://github.com/ClickHouse/ClickHouse/pull/25820)（[alesapin](https://github.com/alesapin)）。
* 作業ディレクトリが読み取り不能な場合でも `clickhouse-client` を起動できるようにしました。 [#25817](https://github.com/ClickHouse/ClickHouse/pull/25817) ([ianton-ru](https://github.com/ianton-ru)).
* `Merge` ストレージで発生していた「No available columns」エラーを修正。 [#25801](https://github.com/ClickHouse/ClickHouse/pull/25801) ([Azat Khuzhin](https://github.com/azat)).
* MySQL エンジンが、MySQL と ClickHouse 間でのカラムコメントのやり取りをサポートするようになりました。 [#25795](https://github.com/ClickHouse/ClickHouse/pull/25795) ([Storozhuk Kostiantyn](https://github.com/sand6255))。
* 空集合に対する `GROUP BY` 定数の不整合な動作を修正。 [#6842](https://github.com/ClickHouse/ClickHouse/issues/6842) をクローズ。 [#25786](https://github.com/ClickHouse/ClickHouse/pull/25786)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `ReplicatedMergeTree` で `DROP PARTITION` および `TRUNCATE` を実行する際、対象パーティション内で既に実行中のマージをキャンセルするようにしました。 [#17151](https://github.com/ClickHouse/ClickHouse/issues/17151) を解決します。 [#25684](https://github.com/ClickHouse/ClickHouse/pull/25684) ([tavplubix](https://github.com/tavplubix)).
* MaterializeMySQL で ENUM` データ型をサポート。 [#25676](https://github.com/ClickHouse/ClickHouse/pull/25676) ([Storozhuk Kostiantyn](https://github.com/sand6255)).
* `JOIN` でのマテリアライズドカラムおよびエイリアスカラムのサポートを追加し、[#13274](https://github.com/ClickHouse/ClickHouse/issues/13274) をクローズ。[#25634](https://github.com/ClickHouse/ClickHouse/pull/25634)（[Vladimir C](https://github.com/vdimir)）。
* `ALTER TABLE ... DETACH` とバックグラウンドマージとの間で発生しうる論理的なレースコンディションを修正。 [#25605](https://github.com/ClickHouse/ClickHouse/pull/25605) ([Azat Khuzhin](https://github.com/azat))。
* `NetworkReceiveElapsedMicroseconds` メトリクスが、`INSERT` に対してクライアントからのデータを待機している時間を正しく含むように修正。 [#9958](https://github.com/ClickHouse/ClickHouse/issues/9958) をクローズ。 [#25602](https://github.com/ClickHouse/ClickHouse/pull/25602) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* S3 および HDFS での `TRUNCATE TABLE` をサポート。[#25530](https://github.com/ClickHouse/ClickHouse/issues/25530) をクローズ。[#25550](https://github.com/ClickHouse/ClickHouse/pull/25550)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* バックグラウンドジョブ（マージ、ミューテーション、フェッチ）の実行用プールにおけるスレッド数を変更するための、設定の動的リロードをサポートしました。 [#25548](https://github.com/ClickHouse/ClickHouse/pull/25548) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* `JSONExtract` を使用して、非文字列要素を文字列として抽出できるようにしました。これは [#25414](https://github.com/ClickHouse/ClickHouse/issues/25414) への対応です。 [#25452](https://github.com/ClickHouse/ClickHouse/pull/25452)（[Amos Bird](https://github.com/amosbird)）。
* `StorageMerge` の `Database` 引数で正規表現をサポート。 [#776](https://github.com/ClickHouse/ClickHouse/issues/776) をクローズ。 [#25064](https://github.com/ClickHouse/ClickHouse/pull/25064)（[flynn](https://github.com/ucasfl)）。
* Web UI: 値が URL のように見える場合は、自動的にリンクを生成します。 [#25965](https://github.com/ClickHouse/ClickHouse/pull/25965) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `systemd` を使用する Centos 8 などのシステムで `sudo service clickhouse-server start` が動作するようにしました。[#14298](https://github.com/ClickHouse/ClickHouse/issues/14298) をクローズ。[#17799](https://github.com/ClickHouse/ClickHouse/issues/17799) をクローズ。[#25921](https://github.com/ClickHouse/ClickHouse/pull/25921)（[alexey-milovidov](https://github.com/alexey-milovidov)）。

#### バグ修正 {#bug-fixes-1}


* 一部のケースで誤っていた `SET ROLE` を修正。 [#26707](https://github.com/ClickHouse/ClickHouse/pull/26707) ([Vitaly Baranov](https://github.com/vitlibar)).
* ウィンドウ関数における `nullptr` 参照の潜在的な問題を修正。[#25276](https://github.com/ClickHouse/ClickHouse/issues/25276) を修正。[#26668](https://github.com/ClickHouse/ClickHouse/pull/26668)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* `groupBitmapAnd/Or/Xor` の誤った関数名を修正。[#26557](https://github.com/ClickHouse/ClickHouse/pull/26557)（[Amos Bird](https://github.com/amosbird)）。
* RabbitMQ のセットアップが開始されていなかった場合に、RabbitMQ のシャットダウン時に発生していたクラッシュを修正しました。[#26504](https://github.com/ClickHouse/ClickHouse/issues/26504) をクローズします。 [#26529](https://github.com/ClickHouse/ClickHouse/pull/26529)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `CREATE DICTIONARY` クエリで、ディクショナリ名またはデータベース名がクオートされている場合に発生する問題を修正しました。 [#26491](https://github.com/ClickHouse/ClickHouse/issues/26491) をクローズ。 [#26508](https://github.com/ClickHouse/ClickHouse/pull/26508)（[Maksim Kita](https://github.com/kitaisreal)）。
* カラムのエイリアスを書き換えた後に壊れていた名前解決を修正。[#26432](https://github.com/ClickHouse/ClickHouse/issues/26432) を修正。[#26475](https://github.com/ClickHouse/ClickHouse/pull/26475)（[Amos Bird](https://github.com/amosbird)）。
* `partial_merge_join` のクローズ時に無限に続く非結合ブロックストリームが発生する問題を修正 [#26325](https://github.com/ClickHouse/ClickHouse/issues/26325)。[#26374](https://github.com/ClickHouse/ClickHouse/pull/26374)（[Vladimir C](https://github.com/vdimir)）。
* 削除済みユーザーとしてログインした際に発生する可能性があるクラッシュを修正しました。 [#26073](https://github.com/ClickHouse/ClickHouse/issues/26073) を修正。 [#26363](https://github.com/ClickHouse/ClickHouse/pull/26363)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 複数列に対する `optimize_distributed_group_by_sharding_key` を修正（シャーディングキー式に複数列が含まれる場合に、`optimize_skip_unused_shards=1` / `allow_nondeterministic_optimize_skip_unused_shards=1` 設定時に誤った結果が返される問題を修正）。[#26353](https://github.com/ClickHouse/ClickHouse/pull/26353)（[Azat Khuzhin](https://github.com/azat)）。
* `Date` から `DateTime`（または `DateTime64`）への `CAST` で、`DateTime` 型のタイムゾーンが使用されていませんでした。これは `Date` と `DateTime` の比較にも影響を与える可能性があります。`Date` と `DateTime` の共通型の推論でも、対応するタイムゾーンが使用されていませんでした。これにより、関数 `if` の結果や配列の構築結果に影響が生じていました。[#24128](https://github.com/ClickHouse/ClickHouse/issues/24128) をクローズします。[#24129](https://github.com/ClickHouse/ClickHouse/pull/24129)（[Maksim Kita](https://github.com/kitaisreal)）。
* 失われたレプリカの復旧時にレプリカの分岐を引き起こす可能性があったまれなバグを修正しました。 [#26321](https://github.com/ClickHouse/ClickHouse/pull/26321) ([tavplubix](https://github.com/tavplubix)).
* 内部バッファの末尾にエスケープシーケンスがある場合の zstd 伸長処理を修正。[#26013](https://github.com/ClickHouse/ClickHouse/issues/26013) をクローズ。[#26314](https://github.com/ClickHouse/ClickHouse/pull/26314)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `totals` を伴う `JOIN` における論理エラーを修正し、[#26017](https://github.com/ClickHouse/ClickHouse/issues/26017) をクローズ。[#26250](https://github.com/ClickHouse/ClickHouse/pull/26250)（[Vladimir C](https://github.com/vdimir)）。
* `system.stack_trace` テーブルの `thread_name` 列内の不要な改行を削除。 [#24124](https://github.com/ClickHouse/ClickHouse/issues/24124) を修正。 [#26210](https://github.com/ClickHouse/ClickHouse/pull/26210)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `LowCarinality` カラムを使った `joinGet` を修正し、[#25993](https://github.com/ClickHouse/ClickHouse/issues/25993) をクローズ。[#26118](https://github.com/ClickHouse/ClickHouse/pull/26118)（[Vladimir C](https://github.com/vdimir)）。
* `validate_polygons` 設定が無効な場合に `pointInPolygon` で発生しうるクラッシュを修正。 [#26113](https://github.com/ClickHouse/ClickHouse/pull/26113) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 存在しないリモートディレクトリを反復処理しようとした際に例外がスローされる問題を修正。 [#26087](https://github.com/ClickHouse/ClickHouse/pull/26087) ([ianton-ru](https://github.com/ianton-ru)).
* ZooKeeper クライアントでの `abort` により発生していたまれなサーバークラッシュを修正しました。 [#25813](https://github.com/ClickHouse/ClickHouse/issues/25813) を修正。 [#26079](https://github.com/ClickHouse/ClickHouse/pull/26079)（[alesapin](https://github.com/alesapin)）。
* 一部のケースにおいて、右側サブクエリ結合に対するスレッド数推定の誤りを修正。 [#24075](https://github.com/ClickHouse/ClickHouse/issues/24075) をクローズ。 [#26052](https://github.com/ClickHouse/ClickHouse/pull/26052)（[Vladimir C](https://github.com/vdimir)）。
* クエリ実行中に例外が発生した際に、ClickHouse が送信する MySQL プロトコルパケット内の誤った `sequence_id` を修正しました。これにより、MySQL クライアントが ClickHouse サーバーへの接続をリセットしてしまう可能性がありました。[#21184](https://github.com/ClickHouse/ClickHouse/issues/21184) を修正。[#26051](https://github.com/ClickHouse/ClickHouse/pull/26051)（[tavplubix](https://github.com/tavplubix)）。
* 通常のプロジェクションと `PREWHERE` を併用した際に発生し得るヘッダーの不一致を修正。 [#26020](https://github.com/ClickHouse/ClickHouse/issues/26020) を修正。 [#26038](https://github.com/ClickHouse/ClickHouse/pull/26038)（[Amos Bird](https://github.com/amosbird)）。
* 整数キーを持つ `Map` 型のフォーマットを `JSON` に修正。 [#25982](https://github.com/ClickHouse/ClickHouse/pull/25982) ([Anton Popov](https://github.com/CurtizJ)).
* クエリプロファイラーのスタックアンワインド中に発生し得るデッドロックを修正。[#25968](https://github.com/ClickHouse/ClickHouse/issues/25968) を修正。[#25970](https://github.com/ClickHouse/ClickHouse/pull/25970)（[Maksim Kita](https://github.com/kitaisreal)）。
* 不正な引数で `dictGet()` を呼び出した際に発生するクラッシュを修正しました。 [#25913](https://github.com/ClickHouse/ClickHouse/pull/25913) ([Vitaly Baranov](https://github.com/vitlibar)).
* PostgreSQL エンジンにおける `scram-sha-256` 認証を修正。[#24516](https://github.com/ClickHouse/ClickHouse/issues/24516) をクローズ。[#25906](https://github.com/ClickHouse/ClickHouse/pull/25906)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* バックグラウンドプールが満杯のときにバックグラウンドタスクで発生していた、異常に長いバックオフを修正しました。 [#25836](https://github.com/ClickHouse/ClickHouse/issues/25836) の修正。 [#25893](https://github.com/ClickHouse/ClickHouse/pull/25893)（[alesapin](https://github.com/alesapin)）。
* ARM の例外処理がデフォルト以外のページサイズでも動作するように修正しました。[#25512](https://github.com/ClickHouse/ClickHouse/issues/25512)、[#25044](https://github.com/ClickHouse/ClickHouse/issues/25044)、[#24901](https://github.com/ClickHouse/ClickHouse/issues/24901)、[#23183](https://github.com/ClickHouse/ClickHouse/issues/23183)、[#20221](https://github.com/ClickHouse/ClickHouse/issues/20221)、[#19703](https://github.com/ClickHouse/ClickHouse/issues/19703)、[#19028](https://github.com/ClickHouse/ClickHouse/issues/19028)、[#18391](https://github.com/ClickHouse/ClickHouse/issues/18391)、[#18121](https://github.com/ClickHouse/ClickHouse/issues/18121)、[#17994](https://github.com/ClickHouse/ClickHouse/issues/17994)、[#12483](https://github.com/ClickHouse/ClickHouse/issues/12483) を修正しました。[#25854](https://github.com/ClickHouse/ClickHouse/pull/25854) ([Maksim Kita](https://github.com/kitaisreal))。
* `remote()` 用の関数を伴わないカラムから sharding&#95;key を取得する処理を修正しました（以前は `select * from remote('127.1', system.one, dummy)` により `Unknown column: dummy, there are only columns .` エラーが発生していました）。[#25824](https://github.com/ClickHouse/ClickHouse/pull/25824)（[Azat Khuzhin](https://github.com/azat)）。
* `MaterializeMySQL` からの SELECT 時に発生していた `Not found column ...` および `Missing column ...` エラーを修正しました。[#23708](https://github.com/ClickHouse/ClickHouse/issues/23708)、[#24830](https://github.com/ClickHouse/ClickHouse/issues/24830)、[#25794](https://github.com/ClickHouse/ClickHouse/issues/25794) を解決。[#25822](https://github.com/ClickHouse/ClickHouse/pull/25822)（[tavplubix](https://github.com/tavplubix)）。
* 非 UInt64 型に対する `optimize_skip_unused_shards_rewrite_in` を修正しました（最終的に誤ったシャードが選択される、あるいは `Cannot infer type of an empty tuple` や `Function tuple requires at least one argument` がスローされる可能性がありました）。 [#25798](https://github.com/ClickHouse/ClickHouse/pull/25798) ([Azat Khuzhin](https://github.com/azat))。
* `ReplicatedMergeTree` テーブルに対する `DROP PART` クエリでまれに発生し、`Unexpected merged part intersecting drop range` というエラーメッセージを引き起こす可能性があったバグを修正しました。 [#25783](https://github.com/ClickHouse/ClickHouse/pull/25783) ([alesapin](https://github.com/alesapin)).
* `GROUP BY` 式を含む `TTL` において、パーツ内で最初に `TTL` が実行された後、それ以降は `TTL` が実行されなくなってしまう不具合を修正しました。 [#25743](https://github.com/ClickHouse/ClickHouse/pull/25743) ([alesapin](https://github.com/alesapin)).
* StorageMerge がエイリアスを持つテーブルにアクセスできるようにしました。 [#6051](https://github.com/ClickHouse/ClickHouse/issues/6051) をクローズ。[#25694](https://github.com/ClickHouse/ClickHouse/pull/25694)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 一部のケースで発生していた dict join の低速化を修正し、[#24209](https://github.com/ClickHouse/ClickHouse/issues/24209) をクローズ。[#25618](https://github.com/ClickHouse/ClickHouse/pull/25618)（[Vladimir C](https://github.com/vdimir)）。
* TTL 式に使用されているカラムに対する `ALTER MODIFY COLUMN` を修正しました。 [#25554](https://github.com/ClickHouse/ClickHouse/pull/25554) ([Anton Popov](https://github.com/CurtizJ)).
* 非 `UInt8` 型の `PREWHERE` におけるアサーションを修正し、[#19589](https://github.com/ClickHouse/ClickHouse/issues/19589) をクローズ。 [#25484](https://github.com/ClickHouse/ClickHouse/pull/25484)（[Vladimir C](https://github.com/vdimir)）。
* いくつかのファジングによって発見された msan クラッシュを修正。 [#22517](https://github.com/ClickHouse/ClickHouse/issues/22517) を修正。 [#26428](https://github.com/ClickHouse/ClickHouse/pull/26428)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `clickhouse-server` の Docker entrypoint 内で実行される `chown` コマンドのチェック処理を更新しました。これにより、Kubernetes 上で発生していた「cluster pod restart failed (or timeout)」エラーが解消されます。 [#26545](https://github.com/ClickHouse/ClickHouse/pull/26545) ([Ky Li](https://github.com/Kylinrix)).

### ClickHouse release v21.7, 2021-07-09 {#clickhouse-release-v217-2021-07-09}

#### 後方互換性のない変更 {#backward-incompatible-change-4}

- 明示的に定義された大規模なセットを使用するクエリのパフォーマンスが向上しました。互換性設定 `legacy_column_name_of_tuple_literal` が追加されました。21.7より前のバージョンからそれ以降のバージョンへクラスタのローリングアップデートを実行する際は、この設定を `true` にすることを推奨します。そうしないと、`IN` 句で明示的に定義されたセットを使用する分散クエリがアップデート中に失敗する可能性があります。[#25371](https://github.com/ClickHouse/ClickHouse/pull/25371) ([Anton Popov](https://github.com/CurtizJ))。
- clickhouse-keeper（ZooKeeperの実験的な代替実装）における最大バッファサイズの前方/後方互換性のない変更。本番環境への移行前の現時点で実施する方が、後で行うよりも望ましいです。[#25421](https://github.com/ClickHouse/ClickHouse/pull/25421) ([alesapin](https://github.com/alesapin))。

#### 新機能 {#new-feature-4}


- XMLの代替としてYAML形式での設定をサポート。[#3607](https://github.com/ClickHouse/ClickHouse/issues/3607)を解決。[#21858](https://github.com/ClickHouse/ClickHouse/pull/21858) ([BoloniniD](https://github.com/BoloniniD))。
- データが存在する可能性があるがZooKeeperメタデータが失われた場合に、レプリケートされたテーブルを復元する方法を提供。[#13458](https://github.com/ClickHouse/ClickHouse/issues/13458)を解決。[#13652](https://github.com/ClickHouse/ClickHouse/pull/13652) ([Mike Kot](https://github.com/myrrc))。
- Arrow/Parquet/ORCでの構造体とマップ、およびArrow入出力形式での辞書をサポート。新しい設定`output_format_arrow_low_cardinality_as_dictionary`を追加。[#24341](https://github.com/ClickHouse/ClickHouse/pull/24341) ([Kruglov Pavel](https://github.com/Avogar))。
- 辞書での`Array`型のサポートを追加。[#25119](https://github.com/ClickHouse/ClickHouse/pull/25119) ([Maksim Kita](https://github.com/kitaisreal))。
- 関数`bitPositionsToArray`を追加。[#23792](https://github.com/ClickHouse/ClickHouse/issues/23792)を解決。作成者 [Kevin Wan] (@MaxWk)。[#25394](https://github.com/ClickHouse/ClickHouse/pull/25394) ([Maksim Kita](https://github.com/kitaisreal))。
- 'Friday'や'April'のような名前を返す関数`dateName`を追加。作成者 [Daniil Kondratyev] (@dankondr)。[#25372](https://github.com/ClickHouse/ClickHouse/pull/25372) ([Maksim Kita](https://github.com/kitaisreal))。
- カラムをJSON表現にシリアライズする`toJSONString`関数を追加。[#25164](https://github.com/ClickHouse/ClickHouse/pull/25164) ([Amos Bird](https://github.com/amosbird))。
- `query_log`に2つの新しいカラム`initial_query_start_time`と`initial_query_start_time_microsecond`を追加。分散クエリの開始時刻を記録(該当する場合)。[#25022](https://github.com/ClickHouse/ClickHouse/pull/25022) ([Amos Bird](https://github.com/amosbird))。
- 集約関数`segmentLengthSum`を追加。[#24250](https://github.com/ClickHouse/ClickHouse/pull/24250) ([flynn](https://github.com/ucasfl))。
- すべてのIN/JOINをGLOBAL IN/JOINとしてデフォルト設定する新しいブール設定`prefer_global_in_and_join`を追加。[#23434](https://github.com/ClickHouse/ClickHouse/pull/23434) ([Amos Bird](https://github.com/amosbird))。
- `Join`テーブルエンジンでの`ALTER DELETE`クエリをサポート。[#23260](https://github.com/ClickHouse/ClickHouse/pull/23260) ([foolchi](https://github.com/foolchi))。
- 集約関数`quantileBFloat16`と、対応する`quantilesBFloat16`および`medianBFloat16`を追加。相対誤差が0.390625%以下の非常にシンプルで高速な分位数推定器。[#16641](https://github.com/ClickHouse/ClickHouse/issues/16641)を解決。[#23204](https://github.com/ClickHouse/ClickHouse/pull/23204) ([Ivan Novitskiy](https://github.com/RedClusive))。
- フロー分析に有用な`sequenceNextNode()`関数を実装。[#19766](https://github.com/ClickHouse/ClickHouse/pull/19766) ([achimbab](https://github.com/achimbab))。

#### 実験的機能 {#experimental-feature-4}

- HDFS上の仮想ファイルシステムのサポートを追加。[#11058](https://github.com/ClickHouse/ClickHouse/pull/11058) ([overshov](https://github.com/overshov)) ([Kseniia Sumarokova](https://github.com/kssenii))。
- clickhouse-keeper(ZooKeeperの実験的な代替)がZooKeeperライクな`digest` ACLをサポート。[#24448](https://github.com/ClickHouse/ClickHouse/pull/24448) ([alesapin](https://github.com/alesapin))。

#### パフォーマンス改善 {#performance-improvement-4}


- 一部の関数をサブカラムの読み取りに変換することで、読み取るデータ量を削減する最適化を追加しました。例えば、`col IS NULL` というステートメントはサブカラム `col.null` の読み取りに変換されます。この最適化は `optimize_functions_to_subcolumns` 設定で有効化できますが、現在はデフォルトでオフになっています。[#24406](https://github.com/ClickHouse/ClickHouse/pull/24406) ([Anton Popov](https://github.com/CurtizJ))。
- より多くのカラムを可能なエイリアス式に書き換えます。これにより、プロジェクションなどのより優れた最適化が可能になる場合があります。[#24405](https://github.com/ClickHouse/ClickHouse/pull/24405) ([Amos Bird](https://github.com/amosbird))。
- `bloom_filter` 型のインデックスを、定数配列を持つ `hasAny` 関数を含む式で使用できるようになりました。これにより以下が解決されます: [#24291](https://github.com/ClickHouse/ClickHouse/issues/24291)。[#24900](https://github.com/ClickHouse/ClickHouse/pull/24900) ([Vasily Nemkov](https://github.com/Enmk))。
- RabbitMQキューが空の場合に読み取り試行を再スケジュールするための指数バックオフを追加しました。(ClickHouseはRabbitMQからのデータインポートをサポートしています)。以下を解決します [#24340](https://github.com/ClickHouse/ClickHouse/issues/24340)。[#24415](https://github.com/ClickHouse/ClickHouse/pull/24415) ([Kseniia Sumarokova](https://github.com/kssenii))。

#### 改善 {#improvement-4}


* レプリケーションの帯域幅を制限できるようにしました。テーブルごとのレプリケーションでのフェッチ/送信の最大速度を制限するために、Replicated*MergeTree 用の設定 `max_replicated_fetches_network_bandwidth` と `max_replicated_sends_network_bandwidth` を追加しました。すべてのテーブルに対するレプリケーションの最大速度を制限するために、サーバー全体の設定（`default` ユーザープロファイル内）として `max_replicated_fetches_network_bandwidth_for_server` と `max_replicated_sends_network_bandwidth_for_server` を追加しました。これらの設定は厳密に守られるとは限りません。デフォルトでは無効です。[#1821](https://github.com/ClickHouse/ClickHouse/issues/1821) を修正しました。 [#24573](https://github.com/ClickHouse/ClickHouse/pull/24573)（[alesapin](https://github.com/alesapin)）。
* ODBC および Library ブリッジに対するリソース制約とアイソレーションを追加。ブリッジプロセスには、専用の `clickhouse-bridge` グループおよびユーザーを使用。ブリッジが OOM killer の最初の対象となるように `oom_score_adj` を設定。最大 RSS を 1 GiB に設定。 [#23861](https://github.com/ClickHouse/ClickHouse/issues/23861) をクローズ。 [#25280](https://github.com/ClickHouse/ClickHouse/pull/25280)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* メインの `clickhouse` バイナリへの単独の `clickhouse-keeper` シンボリックリンクを追加しました。これにより、メインの clickhouse サーバーを起動せずにコーディネーションを実行できるようになりました。 [#24059](https://github.com/ClickHouse/ClickHouse/pull/24059) ([alesapin](https://github.com/alesapin)).
* `VIEW` へのクエリに対してグローバル設定を使用するようにしました。`VIEW` へのクエリがローカル設定を使用していたため、`CREATE VIEW` と `SELECT` で設定が異なる場合にエラーが発生していた動作を修正しました。現在では、`VIEW` はこれらの変更された設定を使用しませんが、`CREATE VIEW` クエリの `SETTINGS` セクションで追加の設定を渡すことは引き続き可能です。[#20551](https://github.com/ClickHouse/ClickHouse/issues/20551) をクローズ。[#24095](https://github.com/ClickHouse/ClickHouse/pull/24095)（[Vladimir](https://github.com/vdimir)）。
* サーバー起動時に、パーティション ID が不正なパーツは削除されることはなく、常にデタッチされます。 [#25070](https://github.com/ClickHouse/ClickHouse/issues/25070)。 [#25166](https://github.com/ClickHouse/ClickHouse/pull/25166) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* バックグラウンドスケジュールプールのサイズを 128（`background_schedule_pool_size` 設定）に増やしました。これにより、ZooKeeper 接続が遅い場合にレプリケーションキューがハングするのを回避できます。 [#25072](https://github.com/ClickHouse/ClickHouse/pull/25072) ([alesapin](https://github.com/alesapin)).
* バックグラウンドで一度にマージできるパーツ数を制限する MergeTree 設定 `max_parts_to_merge_at_once` を追加しました。`OPTIMIZE FINAL` クエリには影響しません。[#1820](https://github.com/ClickHouse/ClickHouse/issues/1820) を修正します。[#24496](https://github.com/ClickHouse/ClickHouse/pull/24496)（[alesapin](https://github.com/alesapin)）。
* パーティションプルーニングで `NOT IN` 演算子が使用できるようになりました。[#24894](https://github.com/ClickHouse/ClickHouse/pull/24894)（[Amos Bird](https://github.com/amosbird)）。
* `127.0.1.1` のような IPv4 アドレスをローカルとして認識します。これは賛否両論ある変更であり、[#23504](https://github.com/ClickHouse/ClickHouse/issues/23504) をクローズします。Michael Filimonov がこの機能をテストします。[#24316](https://github.com/ClickHouse/ClickHouse/pull/24316) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* MaterializeMySQL（実験的な機能）で作成された ClickHouse データベースには、マテリアライズ対象となった MySQL データベースに含まれていたすべてのカラムコメントが含まれるようになりました。 [#25199](https://github.com/ClickHouse/ClickHouse/pull/25199) ([Storozhuk Kostiantyn](https://github.com/sand6255)).
* MySQL ストレージエンジンに設定（`connection_auto_close` / `connection_max_tries` / `connection_pool_size`）を追加しました。[#24146](https://github.com/ClickHouse/ClickHouse/pull/24146)（[Azat Khuzhin](https://github.com/azat)）。
* Distributed エンジンの起動時間を改善しました。 [#25663](https://github.com/ClickHouse/ClickHouse/pull/25663) ([Azat Khuzhin](https://github.com/azat)).
* Distributed テーブルの改善。internal&#95;replication=true の場合に dirname から replica を削除しました（これにより、任意の数の replica を持つ cluster から Distributed への INSERT が可能になります。以前は replica は 15 個までしかサポートされておらず、それ以上では非同期ブロック用ディレクトリの作成時に ENAMETOOLONG により失敗していました）。 [#25513](https://github.com/ClickHouse/ClickHouse/pull/25513) ([Azat Khuzhin](https://github.com/azat)).
* `LowCardinality` に対して `Interval` 型のサポートを追加しました。これは一部の式の中間値に必要です。[#21730](https://github.com/ClickHouse/ClickHouse/issues/21730) をクローズ。[#25410](https://github.com/ClickHouse/ClickHouse/pull/25410)（[Vladimir](https://github.com/vdimir)）。
* `sequenceMatch` 関数および `sequenceCount` 関数の時間条件で `==` 演算子が使用できるようになりました。例: sequenceMatch(&#39;(?1)(?t==1)(?2)&#39;)(time, data = 1, data = 2)。 [#25299](https://github.com/ClickHouse/ClickHouse/pull/25299) ([Christophe Kalenzaga](https://github.com/mga-chka)).
* 設定 `http_max_fields`、`http_max_field_name_size`、`http_max_field_value_size` を追加。 [#25296](https://github.com/ClickHouse/ClickHouse/pull/25296) ([Ivan](https://github.com/abyss7))。
* `if` 関数が、その分岐で `Decimal` 型および `Int` 型をサポートするようになりました。これにより [#20549](https://github.com/ClickHouse/ClickHouse/issues/20549) がクローズされます。また、[#10142](https://github.com/ClickHouse/ClickHouse/issues/10142) もクローズされます。 [#25283](https://github.com/ClickHouse/ClickHouse/pull/25283) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `clickhouse-client` のプロンプトを更新し、再接続時にメッセージを表示するようにしました。これにより [#10577](https://github.com/ClickHouse/ClickHouse/issues/10577) が解決されました。 [#25281](https://github.com/ClickHouse/ClickHouse/pull/25281) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 集約関数 `topK` におけるメモリトラッキングを修正しました。これにより [#25259](https://github.com/ClickHouse/ClickHouse/issues/25259) がクローズされます。 [#25260](https://github.com/ClickHouse/ClickHouse/pull/25260) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* IDN ホスト（例: `example.рф`）に対して `topLevelDomain` を修正しました。これまでそのようなホストでは空文字列が返されていました。[#25103](https://github.com/ClickHouse/ClickHouse/pull/25103) ([Azat Khuzhin](https://github.com/azat)).
* 実行時に Linux カーネルのバージョンを検出します（`async_socket_for_remote` / `use_hedged_requests` に必要となる入れ子の epoll を正しく動作させるため。これがない場合、リモートクエリがハングする可能性があります）。[#25067](https://github.com/ClickHouse/ClickHouse/pull/25067)（[Azat Khuzhin](https://github.com/azat) による）。
* 分散クエリにおいて `optimize_skip_unused_shards=1` の場合、`(シャーディングキー) IN (要素が1つだけのタプル)` のような条件でもシャードをスキップできるようにしました（複数要素を持つタプルはすでにサポートされていましたが、要素が1つだけのタプルはリテラルとしてパースされていたため動作していませんでした）。 [#24930](https://github.com/ClickHouse/ClickHouse/pull/24930) ([Amos Bird](https://github.com/amosbird))。
* S3 エラーのログメッセージを改善し、キーやバケットが空の場合でも余分な空白が入らないようにしました。 [#24897](https://github.com/ClickHouse/ClickHouse/pull/24897) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 一部のクエリでは複数回のセマンティック解析が必要になります。この場合は、`IN` 用に構築したセットを再利用してみてください。 [#24874](https://github.com/ClickHouse/ClickHouse/pull/24874) ([Amos Bird](https://github.com/amosbird)).
* 大規模クラスタで同期的な分散挿入を行う際に `max_thread_pool_size` を使い切ってしまう可能性があるため、`insert_distributed_sync` でも `max_distributed_connections` を尊重するようにしました。 [#24754](https://github.com/ClickHouse/ClickHouse/pull/24754) ([Azat Khuzhin](https://github.com/azat)).
* スカラーサブクエリで `Limit for rows or bytes to read exceeded` のようなエラーが隠蔽されないようにしました。 [#24545](https://github.com/ClickHouse/ClickHouse/pull/24545) ([nvartolomei](https://github.com/nvartolomei)).
* String から Int へのパーサーをより厳密にし、`toInt64('+')` が例外を送出するようにしました。 [#24475](https://github.com/ClickHouse/ClickHouse/pull/24475) ([Amos Bird](https://github.com/amosbird)).
* `SSD_CACHE` を DDL クエリで作成する場合は、`user_files` ディレクトリ内でのみ作成できます。 [#24466](https://github.com/ClickHouse/ClickHouse/pull/24466) ([Maksim Kita](https://github.com/kitaisreal))。
* PostgreSQL との互換モードで、`INSERT` クエリにおいてデフォルト以外のスキーマを指定できるようにしました。 [#24149](https://github.com/ClickHouse/ClickHouse/issues/24149) をクローズ。 [#24413](https://github.com/ClickHouse/ClickHouse/pull/24413) ([Kseniia Sumarokova](https://github.com/kssenii)).
* IPv6 アドレスの解決を修正しました（例：`select * from remote('[::1]', system.one)` が正しく動作するように修正）。[#24319](https://github.com/ClickHouse/ClickHouse/pull/24319)（[Azat Khuzhin](https://github.com/azat)）。
* 複数行モードでサブクエリを含む FROM 句末尾の空白を修正し、クエリの出力も、人間にとってより読みやすい形になるようにわずかに変更します。 [#24151](https://github.com/ClickHouse/ClickHouse/pull/24151) ([Azat Khuzhin](https://github.com/azat))。
* Distributed テーブルの改善。`distributed_directory_monitor_split_batch_on_failure`（デフォルトでは OFF）により、失敗時（メモリ制限、破損などが原因）に分散バッチを分割できるようになりました。 [#23864](https://github.com/ClickHouse/ClickHouse/pull/23864) ([Azat Khuzhin](https://github.com/azat)).
* `Join` テーブルエンジンでのカラム名の衝突を処理。[#20309](https://github.com/ClickHouse/ClickHouse/issues/20309) をクローズ。[#23769](https://github.com/ClickHouse/ClickHouse/pull/23769)（[Vladimir](https://github.com/vdimir)）。
* `clickhouse-local` の `File` テーブルエンジンと、データが stdin から渡される場合の `clickhouse-client` における INSERT クエリで、進捗状況を表示するようにしました。 [#18209](https://github.com/ClickHouse/ClickHouse/issues/18209) をクローズします。 [#23656](https://github.com/ClickHouse/ClickHouse/pull/23656) ([Kseniia Sumarokova](https://github.com/kssenii))。
* `clickhouse-copier` のバグ修正および改善。互換性のある異なるスキーマを持つテーブルのコピーを許可。 [#9159](https://github.com/ClickHouse/ClickHouse/issues/9159) をクローズ。ReplacingMergeTree をコピーするためのテストを追加。 [#22711](https://github.com/ClickHouse/ClickHouse/issues/22711) をクローズ。カラムの TTL および Data Skipping Indices をサポート。内部の Distributed テーブルを作成する際には単にそれらを削除する（基礎となるテーブル側には TTL と skipping indices が残る）。 [#19384](https://github.com/ClickHouse/ClickHouse/issues/19384) をクローズ。MATERIALIZED カラムおよび ALIAS カラムのコピーを許可。いくつかのケース（例: このカラムが PRIMARY KEY に含まれる場合）では有用となり得る。タスク設定でプロパティ `allow_to_copy_alias_and_materialized_columns` を true に設定することで、これを許可できるようになった。 [#9177](https://github.com/ClickHouse/ClickHouse/issues/9177) をクローズ。 [#11007] ([https://github.com/ClickHouse/ClickHouse/issues/11007](https://github.com/ClickHouse/ClickHouse/issues/11007)) をクローズ。 [#9514](https://github.com/ClickHouse/ClickHouse/issues/9514) をクローズ。タスク設定にプロパティ `allow_to_drop_target_partitions` を追加し、補助テーブルを移動する前に元のテーブルのパーティションをドロップできるようにした。 [#20957](https://github.com/ClickHouse/ClickHouse/issues/20957) をクローズ。`OPTIMIZE DEDUPLICATE` クエリを廃止。このハックは、`ALTER TABLE MOVE PARTITION` が何度もリトライされ、かつプレーンな MergeTree テーブルには重複排除がないために必要だった。 [#17966](https://github.com/ClickHouse/ClickHouse/issues/17966) をクローズ。`task_path + /status` のパスにある ZooKeeper ノードに JSON 形式で進捗を書き込む。 [#20955](https://github.com/ClickHouse/ClickHouse/issues/20955) をクローズ。引数なしの ReplicatedTables をサポート。 [#24834](https://github.com/ClickHouse/ClickHouse/issues/24834) をクローズ。[#23518](https://github.com/ClickHouse/ClickHouse/pull/23518) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* S3 からの読み取り再試行の間に、バックオフ付きのスリープを追加しました。 [#23461](https://github.com/ClickHouse/ClickHouse/pull/23461) ([Vladimir Chebotarev](https://github.com/excitoon)).
* `Distributed` テーブルへの INSERT で、`insert_allow_materialized_columns`（マテリアライズドカラムを許可する）設定が尊重されるようにしました。 [#23349](https://github.com/ClickHouse/ClickHouse/pull/23349) ([Azat Khuzhin](https://github.com/azat)).
* 分散クエリで LIMIT のプッシュダウンが可能になりました。 [#23027](https://github.com/ClickHouse/ClickHouse/pull/23027) ([Azat Khuzhin](https://github.com/azat)).
* 複数の S3 ボリュームでのゼロコピー・レプリケーションを修正（[#22679](https://github.com/ClickHouse/ClickHouse/issues/22679) を解決）。[#22864](https://github.com/ClickHouse/ClickHouse/pull/22864)（[ianton-ru](https://github.com/ianton-ru)）。
* ユーザーがオペレーティングシステムに任意の空きポートを要求した際に、実際にバインドされたポート番号を特定してログメッセージに表示するようにしました。 [#25569](https://github.com/ClickHouse/ClickHouse/pull/25569) ([bnaecker](https://github.com/bnaecker)).
* 一部のケースで `attndims` が正しく動作しないことにより、Postgres の配列変換が n 次元配列ではなく String 型になってしまうことがあった問題を修正しました。 [#24804](https://github.com/ClickHouse/ClickHouse/issues/24804) をクローズ。 [#25538](https://github.com/ClickHouse/ClickHouse/pull/25538)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* MySQL、PostgreSQL、ODBC 向けのタイムゾーン付き `DateTime` の変換を修正。[#5057](https://github.com/ClickHouse/ClickHouse/issues/5057) をクローズ。[#25528](https://github.com/ClickHouse/ClickHouse/pull/25528)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 異なるテーブルごとに `KILL MUTATION` を区別するようにしました（予期しない `Cancelled mutating parts` エラーを修正）。 [#25025](https://github.com/ClickHouse/ClickHouse/pull/25025) ([Azat Khuzhin](https://github.com/azat)).
* S3 仮想ファイルシステム（開発中の実験的機能）で、バケットのルートを S3 ディスクとして宣言できるようにしました。 [#24898](https://github.com/ClickHouse/ClickHouse/pull/24898) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 分散テーブルでサブカラム（例: `Tuple` の要素）を読み取れるようにしました。 [#24472](https://github.com/ClickHouse/ClickHouse/pull/24472) ([Anton Popov](https://github.com/CurtizJ))。
* MySQL 互換プロトコル向けの機能: `user` 関数が正しい出力を返すようにしました。[#25697](https://github.com/ClickHouse/ClickHouse/pull/25697)。[#25697](https://github.com/ClickHouse/ClickHouse/pull/25697)（[sundyli](https://github.com/sundy-li)）。

#### バグ修正 {#bug-fix-3}


* 後方互換性を改善しました。パーティションキーで使用されている場合は旧バージョンの `modulo` 関数を使用します。 [#23508](https://github.com/ClickHouse/ClickHouse/issues/23508) をクローズ。 [#24157](https://github.com/ClickHouse/ClickHouse/pull/24157) ([Kseniia Sumarokova](https://github.com/kssenii)).
* メモリの少ないサーバーで、ごくまれに発生し、再起動しない限りマージを実行できなくなる不具合を修正しました。おそらく [#24603](https://github.com/ClickHouse/ClickHouse/issues/24603) も修正されています。[#24872](https://github.com/ClickHouse/ClickHouse/pull/24872)（[alesapin](https://github.com/alesapin)）。
* 同時実行される `alter move/replace partition` 中のレプリケーションキューで発生する、極めてまれなエラー `Tagging already tagged part` を修正しました。おそらく [#22142](https://github.com/ClickHouse/ClickHouse/issues/22142) も修正されています。[#24961](https://github.com/ClickHouse/ClickHouse/pull/24961)（[alesapin](https://github.com/alesapin)）。
* 他の集約関数の集約関数状態をさらに集約して、集約関数状態を計算する際に発生しうるクラッシュの問題を修正しました（実用的なユースケースではありません）。[#24523](https://github.com/ClickHouse/ClickHouse/issues/24523) を参照してください。[#25015](https://github.com/ClickHouse/ClickHouse/pull/25015)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* クエリ `SYSTEM RESTART REPLICA` または `SYSTEM SYNC REPLICA` が終了しない場合の動作を修正しました。これは、RAM 容量が極端に少ないサーバーで発生していた問題です。 [#24457](https://github.com/ClickHouse/ClickHouse/pull/24457) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* ZooKeeper クライアントが clickhouse-server 内でハングする可能性のあるバグを修正しました。 [#24721](https://github.com/ClickHouse/ClickHouse/pull/24721) ([alesapin](https://github.com/alesapin)).
* ZooKeeper への接続が失われ、その後接続を復旧したあとにレプリカがクローンされた場合、そのレプリカのレプリケーションキューに古いエントリが含まれることがあります。レプリケーションキューに交差する仮想パーツが含まれている場合に発生していた失敗アサーションを修正しました。これは、一部のデータパーツが失われた場合にまれに発生する可能性があります。プロセスを終了する代わりにログにエラーを出力するようにしました。 [#24777](https://github.com/ClickHouse/ClickHouse/pull/24777) ([tavplubix](https://github.com/tavplubix)).
* クエリプランの式プッシュダウン最適化において失われていた `WHERE` 条件を修正しました（`query_plan_filter_push_down = 1` をデフォルト値として設定）。[#25368](https://github.com/ClickHouse/ClickHouse/issues/25368) を修正。[#25370](https://github.com/ClickHouse/ClickHouse/pull/25370)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* TTL を伴うマージ後にパーツ同士が重なってしまう可能性のあるバグを修正: `Part all_40_40_0 is covered by all_40_40_1 but should be merged into all_40_41_1. This shouldn't happen often.`. [#25549](https://github.com/ClickHouse/ClickHouse/pull/25549) ([alesapin](https://github.com/alesapin)).
* ZooKeeper への接続が失われた場合、`ReplicatedMergeTree` テーブルは再接続を試みる前にバックグラウンド処理の完了を待つことがありました。この問題は修正され、現在はバックグラウンド処理が強制的に停止されるようになりました。 [#25306](https://github.com/ClickHouse/ClickHouse/pull/25306) ([tavplubix](https://github.com/tavplubix)).
* 配列が主キーで使用されている場合の `ARRAY JOIN` を含むクエリで発生する `Key expression contains comparison between inconvertible types` エラーを修正しました。[#8247](https://github.com/ClickHouse/ClickHouse/issues/8247) を解決。[#25546](https://github.com/ClickHouse/ClickHouse/pull/25546)（[Anton Popov](https://github.com/CurtizJ)）。
* `WITH TOTALS` および `WITH FILL` を含むクエリで誤った合計値が返される問題を修正。[#20872](https://github.com/ClickHouse/ClickHouse/issues/20872) を修正。[#25539](https://github.com/ClickHouse/ClickHouse/pull/25539)（[Anton Popov](https://github.com/CurtizJ)）。
* `system.clusters` をクエリしている最中にクラスター設定を再読み込みすると発生するデータ競合を修正。 [#25737](https://github.com/ClickHouse/ClickHouse/pull/25737) ([Amos Bird](https://github.com/amosbird)).
* データベース間で `Distributed` テーブルを移動する際に発生していた `No such file or directory` エラーを修正しました。 [#24971](https://github.com/ClickHouse/ClickHouse/issues/24971) を解決。 [#25667](https://github.com/ClickHouse/ClickHouse/pull/25667)（[tavplubix](https://github.com/tavplubix)）。
* ソースパーティションが空の場合、まれに `REPLACE PARTITION` が無視されることがありました。この問題は修正されました。 [#24869](https://github.com/ClickHouse/ClickHouse/issues/24869) を修正。 [#25665](https://github.com/ClickHouse/ClickHouse/pull/25665)（[tavplubix](https://github.com/tavplubix)）。
* `Replicated` データベースエンジンにおいて、ごくまれに一部のレプリカがキューに入っている DDL クエリをスキップしてしまう可能性があったバグを修正しました。 [#24805](https://github.com/ClickHouse/ClickHouse/pull/24805) ([tavplubix](https://github.com/tavplubix)).
* クエリなしで `EXPLAIN AST` を実行した際に発生するヌルポインター参照を修正。 [#25631](https://github.com/ClickHouse/ClickHouse/pull/25631) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 空のパーツの自動削除を待機する処理を修正しました。これが原因でバックグラウンドプールが完全に埋まり、レプリケーションが停止してしまう可能性がありました。 [#23315](https://github.com/ClickHouse/ClickHouse/pull/23315) ([Anton Popov](https://github.com/CurtizJ)).
* S3 仮想ファイルシステムに保存されているテーブルのリストア処理を修正しました（これは実験的機能であり、本番環境での利用はまだ想定されていません）。 [#25601](https://github.com/ClickHouse/ClickHouse/pull/25601) ([ianton-ru](https://github.com/ianton-ru)).
* `Decimal256` を使用している場合に `Arrow` フォーマットで発生する `nullptr` デリファレンスを修正。`Arrow` フォーマットに `Decimal256` のサポートを追加。[#25531](https://github.com/ClickHouse/ClickHouse/pull/25531)（[Kruglov Pavel](https://github.com/Avogar)）。
* 前処理済み設定ファイル名の先頭に付いていた過剰なアンダースコアを修正。 [#25431](https://github.com/ClickHouse/ClickHouse/pull/25431) ([Vitaly Baranov](https://github.com/vitlibar)).
* `clickhouse-copier` ツールの修正: copier 用のタスク設定で sharding&#95;key が存在しない場合に発生するセグメンテーションフォルトを修正。[#25419](https://github.com/ClickHouse/ClickHouse/pull/25419) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* フォーマット済みクエリを正しくクオートすることで、DDL で使用された場合の `REPLACE` 列トランスフォーマを修正しました。これにより [#23925](https://github.com/ClickHouse/ClickHouse/issues/23925) が修正されます。[#25391](https://github.com/ClickHouse/ClickHouse/pull/25391)（[Amos Bird](https://github.com/amosbird)）。
* `quantileDeterministic` 関数および類似の関数で非決定的な動作が発生する可能性があった問題を修正しました。これにより [#20480](https://github.com/ClickHouse/ClickHouse/issues/20480) がクローズされました。[#25313](https://github.com/ClickHouse/ClickHouse/pull/25313)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `SummingMergeTree` で `SimpleAggregateFunction(LowCardinality)` をサポートするようにしました。 [#25134](https://github.com/ClickHouse/ClickHouse/issues/25134) を修正。 [#25300](https://github.com/ClickHouse/ClickHouse/pull/25300)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 例外メッセージ「Cannot sum Array/Tuple in min/maxMap」に関する論理エラーを修正。 [#25298](https://github.com/ClickHouse/ClickHouse/pull/25298) ([Kruglov Pavel](https://github.com/Avogar)).
* `LowCardinality` 引数が IN で使用されたクエリで発生していたエラー `Bad cast from type DB::ColumnLowCardinality to DB::ColumnVector<char8_t>` を修正しました（このバグは 21.6 で導入されました）。[#25187](https://github.com/ClickHouse/ClickHouse/issues/25187) を修正。[#25290](https://github.com/ClickHouse/ClickHouse/pull/25290)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* NULL 非許容カラムに対する `joinGetOrNull` の誤った動作を修正しました。これにより [#24261](https://github.com/ClickHouse/ClickHouse/issues/24261) が修正されました。 [#25288](https://github.com/ClickHouse/ClickHouse/pull/25288)（[Amos Bird](https://github.com/amosbird)）。
* 大きな整数における誤った動作と UBSan レポートを修正しました。以前のバージョンでは `CAST(1e19 AS UInt128)` はゼロを返していました。 [#25279](https://github.com/ClickHouse/ClickHouse/pull/25279) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* CSVWithNames 形式を使用して列の一部のみを挿入する際に発生していたエラーを修正しました。 [#25129](https://github.com/ClickHouse/ClickHouse/issues/25129) を修正。 [#25169](https://github.com/ClickHouse/ClickHouse/pull/25169) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* `FINAL` を伴う `SELECT` でテーブルの projection を使用しないでください。これはまだサポートされていません。 [#25163](https://github.com/ClickHouse/ClickHouse/pull/25163) ([Amos Bird](https://github.com/amosbird))。
* パーティションキーで `UUID` を使用しているテーブルにおいて、21.5 へのアップデート後に発生しうるパーツ消失の可能性を修正しました（パーティションキーで `UUID` を使用することは推奨されません）。[#25070](https://github.com/ClickHouse/ClickHouse/issues/25070) を修正しました。[#25127](https://github.com/ClickHouse/ClickHouse/pull/25127)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `joined_subquery_requires_alias = 0` を指定したクロス結合を含むクエリで発生するクラッシュを修正。[#24011](https://github.com/ClickHouse/ClickHouse/issues/24011) を修正。[#25082](https://github.com/ClickHouse/ClickHouse/pull/25082)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `mapContains` 関数で定数のマップを扱う際に発生し、`empty column was returned by function mapContains` というエラーを引き起こしていたバグを修正。[#25077](https://github.com/ClickHouse/ClickHouse/issues/25077) をクローズ。[#25080](https://github.com/ClickHouse/ClickHouse/pull/25080)（[Kruglov Pavel](https://github.com/Avogar)）。
* `a UInt32 ALIAS a + 1` や `b UInt32 MATERIALIZED b` のように、自分自身を参照するカラムを持つテーブルを作成できないようにしました。[#24910](https://github.com/ClickHouse/ClickHouse/issues/24910)、[#24292](https://github.com/ClickHouse/ClickHouse/issues/24292) を修正。[#25059](https://github.com/ClickHouse/ClickHouse/pull/25059)（[alesapin](https://github.com/alesapin)）。
* *空でない* `GROUP BY` キーを持つアグリゲートプロジェクションを使用して、*空の* キーによる `GROUP BY` を含むクエリを実行した際に誤った結果が返される問題を修正。 [#25055](https://github.com/ClickHouse/ClickHouse/pull/25055) ([Amos Bird](https://github.com/amosbird))。
* Protobuf 形式における分割されたネストされたメッセージのシリアライズを修正しました。この PR は [#24647](https://github.com/ClickHouse/ClickHouse/issues/24647) を修正します。[#25000](https://github.com/ClickHouse/ClickHouse/pull/25000)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 分散クエリにおける `LIMIT` / `OFFSET` の設定を修正（リモートノードでは無視するように変更）。[#24940](https://github.com/ClickHouse/ClickHouse/pull/24940)（[Azat Khuzhin](https://github.com/azat)）。
* `Arrow` フォーマットにおけるヒープバッファオーバーフローが発生しうる問題を修正しました。 [#24922](https://github.com/ClickHouse/ClickHouse/pull/24922) ([Kruglov Pavel](https://github.com/Avogar)).
* DiskS3 からファイルを読み込む際に発生する可能性のあるエラー「Cannot read from istream at offset 0」を修正しました（S3 仮想ファイルシステムは開発中の実験的機能であり、本番環境では使用しないでください）。 [#24885](https://github.com/ClickHouse/ClickHouse/pull/24885) ([Pavel Kovalenko](https://github.com/Jokser)).
* 分散マテリアライズドビューを `JOIN` する際に発生する「Missing columns」例外を修正。[#24870](https://github.com/ClickHouse/ClickHouse/pull/24870)（[Azat Khuzhin](https://github.com/azat)）。
* PostgreSQL 互換プロトコルで `NULL` 値を許可しました。[#22622](https://github.com/ClickHouse/ClickHouse/issues/22622) をクローズ。[#24857](https://github.com/ClickHouse/ClickHouse/pull/24857)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* ミューテーションがまだメモリに読み込まれていない状態でミューテーションの完了待ちをしている際に、例外 `Mutation was killed` がクライアントにスローされてしまう可能性があるバグを修正。 [#24809](https://github.com/ClickHouse/ClickHouse/pull/24809) ([alesapin](https://github.com/alesapin)).
* 乱数生成器の状態のデシリアライズにおけるバグを修正しました。このバグにより、`AggregateFunction(groupArraySample(N), T))` などの一部のデータ型が非決定的に動作する可能性がありました。 [#24538](https://github.com/ClickHouse/ClickHouse/pull/24538) ([tavplubix](https://github.com/tavplubix)).
* 他の集計状態に対する uniqXXXXStates の構築を禁止。[#24523](https://github.com/ClickHouse/ClickHouse/pull/24523)（[Raúl Marín](https://github.com/Algunenano)）。その後、関連する問題の根本原因を解消することで、再び構築を許可。（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `CREATE .. AS SELECT` クエリにおけるタプルの扱いを修正。 [#24464](https://github.com/ClickHouse/ClickHouse/pull/24464) ([Anton Popov](https://github.com/CurtizJ)).
* `Buffer` テーブルにおける合計バイト数の計算を修正しました。現在の ClickHouse バージョンでは、バッファのフラッシュ中に `total_writes.bytes` カウンタが過剰に減少してしまいます。その結果、カウンタがオーバーフローし、フラッシュ後しばらくすると `totalBytes` が約 17.44 EB といった値を返すことがあります。 [#24450](https://github.com/ClickHouse/ClickHouse/pull/24450) ([DimasKovas](https://github.com/DimasKovas))。
* toWeek 関数の単調性に関する誤った情報を修正しました。これにより [#24422](https://github.com/ClickHouse/ClickHouse/issues/24422) が解決されます。このバグは [https://github.com/ClickHouse/ClickHouse/pull/5212](https://github.com/ClickHouse/ClickHouse/pull/5212) で導入され、その後、より高度なパーティションプルーナーによって顕在化しました。 [#24446](https://github.com/ClickHouse/ClickHouse/pull/24446) ([Amos Bird](https://github.com/amosbird))。
* ユーザー認証が LDAP で管理されている場合、LDAP グループが存在しないローカルロールにマッピングされているときに LDAP ロールの（再）マッピング処理中に発生しうるデッドロックの問題を修正しました。 [#24431](https://github.com/ClickHouse/ClickHouse/pull/24431) ([Denis Glazachev](https://github.com/traceon)).
* 「multipart/form-data」メッセージにおいて、境界の前にある CRLF を境界の一部として扱うようにしました。 [#23905](https://github.com/ClickHouse/ClickHouse/issues/23905) を修正。 [#24399](https://github.com/ClickHouse/ClickHouse/pull/24399) ([Ivan](https://github.com/abyss7))。
* 偽のパーツが交差している場合の `DROP PARTITION` の動作を修正しました。まれに、現在のブロック番号より大きい mutation version を持つパーツが存在することがあります。 [#24321](https://github.com/ClickHouse/ClickHouse/pull/24321) ([Amos Bird](https://github.com/amosbird))。
* `Ordinary` データベースから `Atomic` データベースへマテリアライズドビューを移動する際のバグ（`RENAME TABLE` クエリ）を修正しました。これにより、マテリアライズドビューと一緒に内部テーブルも新しいデータベースへ移動されるようになりました。 [#23926](https://github.com/ClickHouse/ClickHouse/issues/23926) を修正。 [#24309](https://github.com/ClickHouse/ClickHouse/pull/24309) ([tavplubix](https://github.com/tavplubix))。
* 空の HTTP ヘッダーを許可。 [#23901](https://github.com/ClickHouse/ClickHouse/issues/23901) を修正。 [#24285](https://github.com/ClickHouse/ClickHouse/pull/24285)（[Ivan](https://github.com/abyss7)）。
* Memory テーブルでのミューテーション (ALTER UPDATE/DELETE) の正しい処理。 [#24274](https://github.com/ClickHouse/ClickHouse/issues/24274) をクローズ。 [#24275](https://github.com/ClickHouse/ClickHouse/pull/24275) ([flynn](https://github.com/ucasfl))。
* JOIN の出力における列の LowCardinality プロパティを入力と同じにし、[#23351](https://github.com/ClickHouse/ClickHouse/issues/23351) と [#20315](https://github.com/ClickHouse/ClickHouse/issues/20315) をクローズ。[#24061](https://github.com/ClickHouse/ClickHouse/pull/24061)（[Vladimir](https://github.com/vdimir)）。
* Kafka テーブルの修正。Engine = Kafka の場合に、同じコンシューマーが以前に空の assignment だった場合、フェイルオーバー時にコンシュームを開始できないバグを修正しました。[#21118](https://github.com/ClickHouse/ClickHouse/issues/21118) をクローズします。 [#21267](https://github.com/ClickHouse/ClickHouse/pull/21267) ([filimonov](https://github.com/filimonov)).

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-4}

- CIに`darwin-aarch64`(Mac M1 / Apple Silicon)ビルドを追加 [#25560](https://github.com/ClickHouse/ClickHouse/pull/25560) ([Ivan](https://github.com/abyss7)) し、ドキュメントとウェブサイトへのリンクを配置 ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 実行可能ファイルへのバイナリリソースのクロスプラットフォーム埋め込みを追加。Illumosで動作します。[#25146](https://github.com/ClickHouse/ClickHouse/pull/25146) ([bnaecker](https://github.com/bnaecker))。
- ファジングを改善するため、ストレステストにjoin関連のオプションを追加。[#25200](https://github.com/ClickHouse/ClickHouse/pull/25200) ([Vladimir](https://github.com/vdimir))。
- macOSでs3モジュールを使用したビルドを有効化 [#25217](https://github.com/ClickHouse/ClickHouse/issues/25217)。[#25218](https://github.com/ClickHouse/ClickHouse/pull/25218) ([kevin wan](https://github.com/MaxWk))。
- JDBCブリッジをカバーする統合テストケースを追加。[#25047](https://github.com/ClickHouse/ClickHouse/pull/25047) ([Zhichun Wu](https://github.com/zhicwu))。
- 統合テスト設定はディクショナリに対して特別な処理を行います。残りのディクショナリの手動設定を削除しました。[#24728](https://github.com/ClickHouse/ClickHouse/pull/24728) ([Ilya Yatsishin](https://github.com/qoega))。
- YAMLParserクラスのlibfuzzerテストを追加。[#24480](https://github.com/ClickHouse/ClickHouse/pull/24480) ([BoloniniD](https://github.com/BoloniniD))。
- 統合テストの実行にUbuntu 20.04を使用するようになり、統合テストの実行に使用されるdocker-composeのバージョンは1.28.2に更新されました。環境変数がdocker-composeで有効になりました。test_dictionaries_all_layouts_separate_sourcesを並列実行可能なように再構築しました。[#20393](https://github.com/ClickHouse/ClickHouse/pull/20393) ([Ilya Yatsishin](https://github.com/qoega))。
- インストールスクリプトのTOCTOUエラーを修正。[#25277](https://github.com/ClickHouse/ClickHouse/pull/25277) ([alexey-milovidov](https://github.com/alexey-milovidov))。

### ClickHouseリリース21.6、2021-06-05 {#clickhouse-release-216-2021-06-05}

#### 後方互換性のない変更 {#backward-incompatible-change-5}

- uniqState / uniqHLL12State / uniqCombinedState / uniqCombined64Stateは`UUID`型と互換性のない状態を生成します。[#33607](https://github.com/ClickHouse/ClickHouse/issues/33607)。

#### アップグレード時の注意事項 {#upgrade-notes-1}

- `zstd`圧縮ライブラリがv1.5.0に更新されました。レプリケーション時に「チェックサムが一致しません」というメッセージが表示される場合があります。これらのメッセージは圧縮アルゴリズムの更新により予期されるものであり、無視して構いません。これらのメッセージは情報提供のためのものであり、望ましくない動作を示すものではありません。
- 設定`compile_expressions`がデフォルトで有効になりました。さまざまなシナリオで十分にテストされていますが、サーバーで望ましくない動作が見られる場合は、この設定をオフにしてみてください。
- `UUID`型の値は整数と比較できません。例えば、`uuid != 0`と書く代わりに`uuid != '00000000-0000-0000-0000-000000000000'`と記述してください。

#### 新機能 {#new-feature-5}


* Postgres 風のキャスト演算子（`::`）を追加。例: `[1, 2]::Array(UInt8)`, `0.1::Decimal(4, 4)`, `number::UInt16`。 [#23871](https://github.com/ClickHouse/ClickHouse/pull/23871) ([Anton Popov](https://github.com/CurtizJ)).
* 大きな整数を本番利用に耐えうる形にしました。`UInt128` データ型をサポートしました。`Decimal256` データ型に関する既知の問題を修正しました。辞書で大きな整数をサポートしました。大きな整数に対する `gcd` / `lcm` 関数をサポートしました。配列検索および条件関数で大きな整数をサポートしました。`LowCardinality(UUID)` をサポートしました。`generateRandom` テーブル関数および `clickhouse-obfuscator` で大きな整数をサポートしました。スカラー副問い合わせから `UUID` を返す際のエラーを修正しました。これにより [#7834](https://github.com/ClickHouse/ClickHouse/issues/7834) が修正されます。これにより [#23936](https://github.com/ClickHouse/ClickHouse/issues/23936) が修正されます。これにより [#4176](https://github.com/ClickHouse/ClickHouse/issues/4176) が修正されます。これにより [#24018](https://github.com/ClickHouse/ClickHouse/issues/24018) が修正されます。後方互換性のない変更: `UUID` 型の値は整数と比較できなくなりました。例えば、`uuid != 0` と記述する代わりに `uuid != '00000000-0000-0000-0000-000000000000'` と記述してください。[#23631](https://github.com/ClickHouse/ClickHouse/pull/23631)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `Arrow`、`Parquet`、`ORC` 形式でのデータの挿入および選択において `Array` データ型をサポートしました。 [#21770](https://github.com/ClickHouse/ClickHouse/pull/21770) ([taylor12805](https://github.com/taylor12805)).
* テーブルコメント機能を実装。[#23225](https://github.com/ClickHouse/ClickHouse/issues/23225) をクローズ。[#23548](https://github.com/ClickHouse/ClickHouse/pull/23548)（[flynn](https://github.com/ucasFL)）。
* `clickhouse-local` で DDL クエリを使用した辞書の作成をサポート。 [#22354](https://github.com/ClickHouse/ClickHouse/issues/22354) をクローズ。`DETACH DICTIONARY PERMANENTLY` をサポートに追加。`Atomic` データベースエンジン向けに `EXCHANGE DICTIONARIES` をサポートに追加。`RENAME DICTIONARY` を使用してデータベース間で辞書を移動する機能をサポートに追加。 [#23436](https://github.com/ClickHouse/ClickHouse/pull/23436)（[Maksim Kita](https://github.com/kitaisreal)）。
* ClickHouse で [Theta Sketch](https://datasketches.apache.org/docs/Theta/ThetaSketchFramework.html) をサポートするため、集約関数 `uniqTheta` を追加しました。[#23894](https://github.com/ClickHouse/ClickHouse/pull/23894)。[#22609](https://github.com/ClickHouse/ClickHouse/pull/22609)（[Ping Yu](https://github.com/pingyu)）。
* 関数 `splitByRegexp` を追加。 [#24077](https://github.com/ClickHouse/ClickHouse/pull/24077) ([abel-cheng](https://github.com/abel-cheng)).
* 配列をパラメータとして受け取り、その配列内のすべての要素の積を返す関数 `arrayProduct` を追加しました。 [#21613](https://github.com/ClickHouse/ClickHouse/issues/21613) をクローズ。 [#23782](https://github.com/ClickHouse/ClickHouse/pull/23782)（[Maksim Kita](https://github.com/kitaisreal)）。
* `system.stack_trace` に `thread_name` カラムを追加。これにより [#23256](https://github.com/ClickHouse/ClickHouse/issues/23256) がクローズされました。 [#24124](https://github.com/ClickHouse/ClickHouse/pull/24124) ([abel-cheng](https://github.com/abel-cheng)).
* `insert_null_as_default` = 1 の場合、`INSERT ... SELECT` および `INSERT ... SELECT ... UNION ALL ...` クエリで NULL の代わりにデフォルト値を挿入します。[#22832](https://github.com/ClickHouse/ClickHouse/issues/22832) をクローズ。[#23524](https://github.com/ClickHouse/ClickHouse/pull/23524)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `clickhouse-local` に `--progress` オプションによる進行状況表示のサポートを追加。 [#23196](https://github.com/ClickHouse/ClickHouse/pull/23196) ([Egor Savin](https://github.com/Amesaru))。
* `http` 辞書ソースに、`Content-Encoding` HTTP ヘッダーで指定される HTTP 圧縮のサポートを追加しました。これにより [#8912](https://github.com/ClickHouse/ClickHouse/issues/8912) が修正されました。[#23946](https://github.com/ClickHouse/ClickHouse/pull/23946)（[FArthur-cmd](https://github.com/FArthur-cmd)）。
* `SYSTEM QUERY RELOAD MODEL`、`SYSTEM QUERY RELOAD MODELS` を追加。[#18722](https://github.com/ClickHouse/ClickHouse/issues/18722) をクローズ。[#23182](https://github.com/ClickHouse/ClickHouse/pull/23182)（[Maksim Kita](https://github.com/kitaisreal)）。
* `EXPLAIN PLAN` クエリ向けに `json` 設定（ブール値、デフォルトは 0）を追加しました。有効にすると、クエリの出力は単一の `JSON` 行になります。不要なエスケープ処理を避けるため、`TSVRaw` フォーマットの使用を推奨します。 [#23082](https://github.com/ClickHouse/ClickHouse/pull/23082) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `EXPLAIN PIPELINE` クエリに設定 `indexes`（boolean、デフォルトでは無効）を追加しました。有効化すると、使用されたインデックスに加えて、適用された各インデックスについてフィルタリングされたパーツ数とグラニュール数を表示します。`MergeTree*` テーブルでサポートされます。 [#22352](https://github.com/ClickHouse/ClickHouse/pull/22352) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* LDAP：Active Directory グループを ClickHouse ロールにマッピングする際に使用するユーザー DN 検出機能を実装しました。 [#22228](https://github.com/ClickHouse/ClickHouse/pull/22228) ([Denis Glazachev](https://github.com/traceon)).
* 連続する行同士の差分を合計し、タイムスタンプを保持することでマージ時の順序を維持する新しい集約関数 `deltaSumTimestamp`。[#21888](https://github.com/ClickHouse/ClickHouse/pull/21888)（[Russ Frank](https://github.com/rf)）。
* S3 向けに、Docker 環境で正しく動作する、より安全性の低い IMDS 認証情報プロバイダーを追加しました。 [#21852](https://github.com/ClickHouse/ClickHouse/pull/21852) ([Vladimir Chebotarev](https://github.com/excitoon)).
* `indexHint` 関数を再度追加しました。[#21238](https://github.com/ClickHouse/ClickHouse/issues/21238) の対応です。[#9542](https://github.com/ClickHouse/ClickHouse/pull/9542) をリバートし、[#9540](https://github.com/ClickHouse/ClickHouse/issues/9540) を修正します。[#21304](https://github.com/ClickHouse/ClickHouse/pull/21304)（[Amos Bird](https://github.com/amosbird)）。

#### 実験的機能 {#experimental-feature-5}

- `MergeTree*`テーブルに`PROJECTION`サポートを追加しました。[#20202](https://github.com/ClickHouse/ClickHouse/pull/20202) ([Amos Bird](https://github.com/amosbird))。

#### パフォーマンス改善 {#performance-improvement-5}

- `compile_expressions`設定をデフォルトで有効化しました。この設定が有効な場合、単純な関数と演算子の組み合わせは実行時にLLVMによってネイティブコードにコンパイルされます。[#8482](https://github.com/ClickHouse/ClickHouse/pull/8482) ([Maksim Kita](https://github.com/kitaisreal), [alexey-milovidov](https://github.com/alexey-milovidov))。注意: 問題が発生した場合は、このオプションを無効にしてください。
- `re2`ライブラリを更新しました。正規表現マッチングのパフォーマンスが向上しました。また、このPRはgcc-11との互換性を追加します。[#24196](https://github.com/ClickHouse/ClickHouse/pull/24196) ([Raúl Marín](https://github.com/Algunenano))。
- ORC入力フォーマットをストライプ単位で読み込むように変更しました。これにより、ファイルサイズが大きい場合にテーブル全体を一度にメモリに読み込むことによるメモリ消費を削減します。[#23102](https://github.com/ClickHouse/ClickHouse/pull/23102) ([Chao Ma](https://github.com/godliness))。
- クエリ内の集約関数`sum`、`count`、`avg`を単一の集約関数に統合しました。この最適化は`optimize_fuse_sum_count_avg`設定で制御されます。これは新しい集約関数`sumCount`で実装されています。この関数は`sum`と`count`の2つのフィールドを持つタプルを返します。[#21337](https://github.com/ClickHouse/ClickHouse/pull/21337) ([hexiaoting](https://github.com/hexiaoting))。
- `zstd`をv1.5.0に更新しました。圧縮のパフォーマンスが一桁パーセント向上しました。[#24135](https://github.com/ClickHouse/ClickHouse/pull/24135) ([Raúl Marín](https://github.com/Algunenano))。注意: レプリケーション時に「チェックサムが一致しません」というメッセージが表示される場合があります。これらのメッセージは圧縮アルゴリズムの更新により予期されるものであり、無視して構いません。
- `Buffer`テーブルのパフォーマンスを改善しました: `Buffer`エンジンのtotal_bytes/total_rowsに対してロックを取得しないようにしました。[#24066](https://github.com/ClickHouse/ClickHouse/pull/24066) ([Azat Khuzhin](https://github.com/azat))。
- hashed/sparse_hashed辞書の事前割り当てサポートを復元しました。[#23979](https://github.com/ClickHouse/ClickHouse/pull/23979) ([Azat Khuzhin](https://github.com/azat))。
- `async_socket_for_remote`をデフォルトで有効化しました(大規模なファンアウトを持つDistributedテーブルのクエリ時のスレッド数を削減)。[#23683](https://github.com/ClickHouse/ClickHouse/pull/23683) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。

#### 改善 {#improvement-5}


* MergeTree テーブルファミリーに `_partition_value` 仮想カラムを追加しました。これはパーティションを決定的に絞り込むために使用できます。ミューテーション用のパーティションマッチャーを実装するために必要です。 [#23673](https://github.com/ClickHouse/ClickHouse/pull/23673) ([Amos Bird](https://github.com/amosbird))。
* S3 ストレージおよびディスク向けに `region` パラメーターを追加しました。 [#23846](https://github.com/ClickHouse/ClickHouse/pull/23846) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 異なるロギングチャネルごとに、個別のログレベルを設定できるようにしました。 [#19569](https://github.com/ClickHouse/ClickHouse/issues/19569) をクローズ。 [#23857](https://github.com/ClickHouse/ClickHouse/pull/23857)（[filimonov](https://github.com/filimonov)）。
* `DateTime` 演算で、明示的にタイムゾーンが指定されていない場合は、デフォルトのタイムゾーンを保持するようにしました。例えば、タイムゾーンなしの `DateTime` 型の値に 1 秒を加算した場合、その型はタイムゾーンなしの `DateTime` のままです。以前のバージョンでは、戻り値のデータ型にデフォルトのタイムゾーンが明示的に設定され、`DateTime(&#39;something&#39;)` となっていました。これにより [#4854](https://github.com/ClickHouse/ClickHouse/issues/4854) が解決されました。 [#23392](https://github.com/ClickHouse/ClickHouse/pull/23392) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `MySQL` ストレージでデータベース名の代わりに空文字列を指定できるようにしました。クエリにはデフォルトデータベースが使用されます。以前のバージョンでは `SELECT` クエリに対してのみ動作しており、今回 `INSERT` のサポートも追加されました。これにより [#19281](https://github.com/ClickHouse/ClickHouse/issues/19281) がクローズされます。これは `Sphinx` やその他の MySQL 互換の外部データベースを扱う際に有用です。 [#23319](https://github.com/ClickHouse/ClickHouse/pull/23319) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `quantile(s)TDigest` を修正しました。tdunning/t-digest 3.2+ に従い、単一セントロイドに対する特別な処理を追加しました。また、アルゴリズムの旧バージョンの実装におけるセントロイドの過度な圧縮に関するバグも修正しました。 [#23314](https://github.com/ClickHouse/ClickHouse/pull/23314) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 関数 `now64` でオプションのタイムゾーン引数がサポートされるようになりました。 [#24091](https://github.com/ClickHouse/ClickHouse/pull/24091) ([Vasily Nemkov](https://github.com/Enmk))。
* `clickhouse-client` のインタラクティブモードで、データの途中に表示されるプログレスバーがターミナル上の表示中データの一部を上書きしてしまうことがある問題を修正しました。これにより [#19283](https://github.com/ClickHouse/ClickHouse/issues/19283) がクローズされました。 [#23050](https://github.com/ClickHouse/ClickHouse/pull/23050) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* simdjson においてメモリアロケーションに失敗した際に発生するクラッシュを修正しました。 [https://github.com/simdjson/simdjson/pull/1567](https://github.com/simdjson/simdjson/pull/1567)。非常にまれなバグであるため、改善としてマークしています。 [#24147](https://github.com/ClickHouse/ClickHouse/pull/24147) ([Amos Bird](https://github.com/amosbird))。
* ストレージのシャットダウンまで辞書を保持します（これにより、サーバーシャットダウン時に `Buffer` エンジンの最終フラッシュで発生し得る `external dictionary 'DICT' not found` エラーを回避できます）。 [#24068](https://github.com/ClickHouse/ClickHouse/pull/24068) ([Azat Khuzhin](https://github.com/azat)).
* テーブルをシャットダウンする前に（同一データベース内で）`Buffer` テーブルをフラッシュし、基盤となるテーブルがすでにデタッチされていることに起因するブロックの破棄（ログ内の `Destination table default.a_data_01870 doesn't exist. Block of data is discarded` エラー）を回避します。 [#24067](https://github.com/ClickHouse/ClickHouse/pull/24067) ([Azat Khuzhin](https://github.com/azat)).
* これにより、`prefer_column_name_to_alias = 1` は `group by`、`having`、`order by` に対してもカラム名を優先するようになります。これによって [#23882](https://github.com/ClickHouse/ClickHouse/issues/23882) が修正されました。[#24022](https://github.com/ClickHouse/ClickHouse/pull/24022)（[Amos Bird](https://github.com/amosbird)）。
* `DateTime64` での `ORDER BY WITH FILL` をサポートしました。 [#24016](https://github.com/ClickHouse/ClickHouse/pull/24016) ([kevin wan](https://github.com/MaxWk))。
* `ReplacingMergeTree` で `DateTime64` をバージョン列として使用できるようにしました。 [#23992](https://github.com/ClickHouse/ClickHouse/pull/23992) ([kevin wan](https://github.com/MaxWk))。
* サーバー起動時に OS 名、カーネルバージョン、および CPU アーキテクチャに関する情報をログ出力します。 [#23988](https://github.com/ClickHouse/ClickHouse/pull/23988) ([Azat Khuzhin](https://github.com/azat)).
* `postgresql` ディクショナリソースでテーブルスキーマを指定できるようにしました。 [#23958](https://github.com/ClickHouse/ClickHouse/issues/23958) をクローズ。 [#23980](https://github.com/ClickHouse/ClickHouse/pull/23980)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `Enum` 要素の名前に対してヒントを追加しました（タイポがある場合に候補名を提案します）。[#17112](https://github.com/ClickHouse/ClickHouse/issues/17112) をクローズしました。[#23919](https://github.com/ClickHouse/ClickHouse/pull/23919)（[flynn](https://github.com/ucasFL)）。
* 辞書に対して、値が見つかった割合（found rate、値が見つかった比率）を測定します（`system.dictionaries` の `found_rate` を参照）。 [#23916](https://github.com/ClickHouse/ClickHouse/pull/23916) ([Azat Khuzhin](https://github.com/azat))。
* テーブル設定 `rabbitmq_queue_settings_list` を通じて、特定のキュー設定を追加できるようにしました（[#23737](https://github.com/ClickHouse/ClickHouse/issues/23737) および [#23918](https://github.com/ClickHouse/ClickHouse/issues/23918) をクローズ）。ユーザーが RabbitMQ のセットアップ全体を制御できるようにしました。テーブル設定 `rabbitmq_queue_consume` が `1` に設定されている場合、RabbitMQ テーブルエンジンは指定されたキューに接続するだけで、exchange・キュー・バインディングの宣言など、RabbitMQ のコンシューマ側で行うセットアップは実行しません（[#21757](https://github.com/ClickHouse/ClickHouse/issues/21757) をクローズ）。RabbitMQ テーブルが削除された際のクリーンアップ処理を改善しました。テーブルが宣言したキューおよび、テーブルによって作成されたすべてのバインド済み exchange を削除します。[#23887](https://github.com/ClickHouse/ClickHouse/pull/23887)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `system.distribution_queue` に `broken_data_files` / `broken_data_compressed_bytes` を追加しました。Distributed テーブルへの非同期挿入で破損としてマークされたファイル数を示すメトリクス (`BrokenDistributedFilesToInsert`) を追加しました。 [#23885](https://github.com/ClickHouse/ClickHouse/pull/23885) ([Azat Khuzhin](https://github.com/azat)).
* `system.tables` へのクエリで ZooKeeper にアクセスしなくなりました。 [#23793](https://github.com/ClickHouse/ClickHouse/pull/23793) ([Fuwang Hu](https://github.com/fuwhu)).
* `OPTIMIZE` クエリに対して `lock_acquire_timeout_for_background_operations` が適用されるようにしました。 [#23623](https://github.com/ClickHouse/ClickHouse/pull/23623) ([Azat Khuzhin](https://github.com/azat)).
* 新しい `SYSTEM RESTART DISK` SQL コマンドにより、実行中に `S3` ディスク設定を変更できるようになりました。 [#23429](https://github.com/ClickHouse/ClickHouse/pull/23429) ([Pavel Kovalenko](https://github.com/Jokser))。
* ユーザーが誤って `max_distributed_connections` をゼロに設定してしまった場合、`Distributed` テーブルへのすべてのクエリは「logical error」を含むメッセージとともに例外をスローします。しかし、これは実際には想定された動作であり論理エラーではないため、例外メッセージはやや不正確でした。この結果、論理エラーが一切発生しないことを保証するための当社の CI 環境におけるチェックも発動していました。今後は、ゼロに誤設定された `max_distributed_connections` は最小許容値（1）として扱うことにします。 [#23348](https://github.com/ClickHouse/ClickHouse/pull/23348) ([Azat Khuzhin](https://github.com/azat)).
* デフォルトで `min_bytes_to_use_mmap_io` を無効にします。[#23322](https://github.com/ClickHouse/ClickHouse/pull/23322)（[Azat Khuzhin](https://github.com/azat)）。
* `join_use_nulls` で `LowCardinality` の NULL 対応をサポートし、[#15101](https://github.com/ClickHouse/ClickHouse/issues/15101) をクローズ。[#23237](https://github.com/ClickHouse/ClickHouse/pull/23237)（[vdimir](https://github.com/vdimir)）。
* `S3` ディスクで、`MergeTree` パーツを `detached` ディレクトリに復元できるようになりました。 [#23112](https://github.com/ClickHouse/ClickHouse/pull/23112) ([Pavel Kovalenko](https://github.com/Jokser)).
* S3 での HTTP 接続切断時の再試行。 [#22988](https://github.com/ClickHouse/ClickHouse/pull/22988) ([Vladimir Chebotarev](https://github.com/excitoon)).
* MySQL テーブルエンジン、ディクショナリソース、および MaterializeMySQL における少量データの取得向けに、設定 `external_storage_max_read_rows` と `external_storage_max_read_bytes` を追加しました。 [#22697](https://github.com/ClickHouse/ClickHouse/pull/22697) ([TCeason](https://github.com/TCeason)).
* `MaterializeMySQL`（実験的機能）：以前は、SQL の非互換性により MySQL 5.7.9 はサポートされていませんでした。現在は、MySQL パラメータの検証を MaterializeMySQL に任せるようになりました。 [#23413](https://github.com/ClickHouse/ClickHouse/pull/23413) ([TCeason](https://github.com/TCeason))。
* 分散テーブルでのサブカラムの読み取りを有効にしました。[#24472](https://github.com/ClickHouse/ClickHouse/pull/24472)（[Anton Popov](https://github.com/CurtizJ)）。
* `CREATE .. AS SELECT` クエリでのタプルの扱いを修正。 [#24464](https://github.com/ClickHouse/ClickHouse/pull/24464) ([Anton Popov](https://github.com/CurtizJ)).
* `Kafka` テーブルでの `Parquet` フォーマット対応。 [#23412](https://github.com/ClickHouse/ClickHouse/pull/23412) ([Chao Ma](https://github.com/godliness))。

#### バグ修正 {#bug-fix-4}


* パーティションキーおよびプライマリキーで使用される場合、`modulo` 関数の古いバージョンを使用するようにしました。[#23508](https://github.com/ClickHouse/ClickHouse/issues/23508) をクローズします。 [#24157](https://github.com/ClickHouse/ClickHouse/pull/24157)（[Kseniia Sumarokova](https://github.com/kssenii)）。これは以前のリリースにおける後方互換性問題の原因となっていました。
* `SYSTEM RESTART REPLICA` または `SYSTEM SYNC REPLICA` クエリが無限に処理されてしまう不具合を修正しました。これは、RAM が極めて少ないサーバーで発生することが確認されました。 [#24457](https://github.com/ClickHouse/ClickHouse/pull/24457) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* `toWeek` 関数の誤った単調性を修正しました。これにより [#24422](https://github.com/ClickHouse/ClickHouse/issues/24422) が解消されました。このバグは [#5212](https://github.com/ClickHouse/ClickHouse/pull/5212) で導入され、その後、より高機能なパーティションプルーナーによって顕在化しました。[#24446](https://github.com/ClickHouse/ClickHouse/pull/24446)（[Amos Bird](https://github.com/amosbird)）。
* 偽のパーツと交差する場合の `DROP PARTITION` を修正しました。まれなケースとして、現在のブロック番号より大きいミューテーションバージョンを持つパーツが存在することがあります。 [#24321](https://github.com/ClickHouse/ClickHouse/pull/24321) ([Amos Bird](https://github.com/amosbird)).
* `Ordinary` データベースから `Atomic` データベースへのマテリアライズドビューの移動時（`RENAME TABLE` クエリ）のバグを修正しました。これにより、マテリアライズドビューと一緒に内部テーブルも新しいデータベースに移動されるようになりました。[#23926](https://github.com/ClickHouse/ClickHouse/issues/23926) を修正します。 [#24309](https://github.com/ClickHouse/ClickHouse/pull/24309)（[tavplubix](https://github.com/tavplubix)）。
* クライアントリクエストで空の HTTP ヘッダーを許可するようにしました。[#23901](https://github.com/ClickHouse/ClickHouse/issues/23901) を修正。 [#24285](https://github.com/ClickHouse/ClickHouse/pull/24285)（[Ivan](https://github.com/abyss7)）。
* `Memory` テーブルのミューテーション失敗を防ぐために `max_threads = 1` を設定。 [#24274](https://github.com/ClickHouse/ClickHouse/issues/24274) をクローズ。 [#24275](https://github.com/ClickHouse/ClickHouse/pull/24275) ([flynn](https://github.com/ucasFL)).
* `Memory` テーブルの実装におけるタイポを修正しました。このバグは [#15127](https://github.com/ClickHouse/ClickHouse/issues/15127) で導入されました。[#24192](https://github.com/ClickHouse/ClickHouse/issues/24192) をクローズします。 [#24193](https://github.com/ClickHouse/ClickHouse/pull/24193)（[张中南](https://github.com/plugine)）。
* クエリ実行中に `HDFS` へアクセスできなくなった場合に発生するサーバーの異常終了を修正しました。[#24117](https://github.com/ClickHouse/ClickHouse/issues/24117) をクローズ。[#24191](https://github.com/ClickHouse/ClickHouse/pull/24191)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 定数条件付きで `Nested` 列を更新する際に発生していたクラッシュを修正。 [#24183](https://github.com/ClickHouse/ClickHouse/pull/24183) ([hexiaoting](https://github.com/hexiaoting)).
* 高負荷時に RBAC で発生する可能性のあったレースコンディションを修正しました。この PR は [#24090](https://github.com/ClickHouse/ClickHouse/issues/24090)、[#24134](https://github.com/ClickHouse/ClickHouse/issues/24134)、[#24176](https://github.com/ClickHouse/ClickHouse/pull/24176) を修正します（[Vitaly Baranov](https://github.com/vitlibar)）。
* 書き込みリクエスト（INSERT/ALTER など）を処理できてしまう、不完全に初期化されたテーブルが発生し得るという、まれなバグを修正しました。今後このようなテーブルは readonly モードになります。 [#24122](https://github.com/ClickHouse/ClickHouse/pull/24122) ([alesapin](https://github.com/alesapin)).
* 問題修正: `SELECT xxx FINAL` を伴う `EXPLAIN PIPELINE` で誤ったパイプラインが表示される不具合を修正しました。 ([hexiaoting](https://github.com/hexiaoting)).
* `WHERE` で定数の `DateTime` 値と `DateTime64` 列を使用した際の問題を修正しました。 [#24100](https://github.com/ClickHouse/ClickHouse/pull/24100) ([Vasily Nemkov](https://github.com/Enmk))。
* merge JOIN のクラッシュを修正し、[#24010](https://github.com/ClickHouse/ClickHouse/issues/24010) をクローズ。[#24013](https://github.com/ClickHouse/ClickHouse/pull/24013)（[vdimir](https://github.com/vdimir)）。
* 一部の `ALTER PARTITION` クエリで、レプリケーションキュー内に `Part A intersects previous part B` や `Unexpected merged part C intersecting drop range D` というエラーが発生することがありました。これは修正されました。 [#23296](https://github.com/ClickHouse/ClickHouse/issues/23296) を修正。 [#23997](https://github.com/ClickHouse/ClickHouse/pull/23997) ([tavplubix](https://github.com/tavplubix))。
* 外部 GROUP BY とオーバーフローロウで発生する SIGSEGV を修正しました（`SELECT FROM GROUP BY WITH TOTALS SETTINGS max_bytes_before_external_group_by>0, max_rows_to_group_by>0, group_by_overflow_mode='any', totals_mode='before_having'` のようなクエリ）。 [#23962](https://github.com/ClickHouse/ClickHouse/pull/23962) ([Azat Khuzhin](https://github.com/azat)).
* ソースに重複がある `CACHE` 辞書に対するキー関連メトリクスの計測処理を修正しました（`DictCacheKeysRequestedMiss` のオーバーフローを引き起こしていました）。 [#23929](https://github.com/ClickHouse/ClickHouse/pull/23929) ([Azat Khuzhin](https://github.com/azat)).
* `PostgreSQL` エンジンのコネクションプールの実装を修正。[#23897](https://github.com/ClickHouse/ClickHouse/issues/23897) をクローズ。[#23909](https://github.com/ClickHouse/ClickHouse/pull/23909)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `GROUP BY` と集約関数が通常の関数でラップされている場合における `distributed_group_by_no_merge = 2` の動作を修正しました（[#23546](https://github.com/ClickHouse/ClickHouse/issues/23546) で不具合が発生していました）。`distributed_group_by_no_merge = 2` をウィンドウ関数と併用しようとした場合には例外をスローするようにしました。ウィンドウ関数を含むクエリでは `optimize_distributed_group_by_sharding_key` を無効化しました。[#23906](https://github.com/ClickHouse/ClickHouse/pull/23906)（[Azat Khuzhin](https://github.com/azat)）。
* `s3` テーブル関数の修正: HTTP エラーの扱いを改善しました。これまで HTTP エラーのレスポンスボディは無視されていました。 [#23844](https://github.com/ClickHouse/ClickHouse/pull/23844) ([Vladimir Chebotarev](https://github.com/excitoon)).
* `s3` テーブル関数の修正: URI の扱いを改善しました。`+` 記号を含む URL との非互換性を修正し、そのようなキーを持つデータをこれまで読み取れなかった問題を解消しました。 [#23822](https://github.com/ClickHouse/ClickHouse/pull/23822) ([Vladimir Chebotarev](https://github.com/excitoon)).
* `GLOBAL IN/JOIN` と `use_hedged_requests` を使用するクエリで発生する `Can't initialize pipeline with empty pipe` エラーを修正。 [#23431](https://github.com/ClickHouse/ClickHouse/issues/23431) を解決。 [#23805](https://github.com/ClickHouse/ClickHouse/pull/23805)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* マテリアライズドビューから参照されている場合に `CLEAR COLUMN` が動作しない問題を修正。[#23764](https://github.com/ClickHouse/ClickHouse/issues/23764) をクローズ。[#23781](https://github.com/ClickHouse/ClickHouse/pull/23781)（[flynn](https://github.com/ucasFL)）。
* `Values` フォーマット使用時に HDFS から読み込む際の解放後ヒープ使用 (use-after-free) を修正。 [#23761](https://github.com/ClickHouse/ClickHouse/pull/23761) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Distributed への INSERT 時に、何らかの例外が発生した場合に起こりうる「Cannot schedule a task」エラーを回避します。 [#23744](https://github.com/ClickHouse/ClickHouse/pull/23744) ([Azat Khuzhin](https://github.com/azat)).
* `ReplicatedMergeTree` レプリカの古い状態からのリカバリに関するバグを修正しました。レプリカのダウンタイム中に `ALTER` クエリが実行されていた場合、一部のメタデータ更新が古い状態のレプリカによって無視される可能性がありました。 [#23742](https://github.com/ClickHouse/ClickHouse/pull/23742) ([tavplubix](https://github.com/tavplubix)).
* `Join` と `WITH TOTALS` に関するバグを修正し、[#17718](https://github.com/ClickHouse/ClickHouse/issues/17718) をクローズ。[#23549](https://github.com/ClickHouse/ClickHouse/pull/23549)（[vdimir](https://github.com/vdimir)）。
* `UNION` を含むクエリで、filter-pushdown 最適化の後に発生する可能性があった `Block structure mismatch` エラーを修正しました。 [#23029](https://github.com/ClickHouse/ClickHouse/issues/23029) を解決。 [#23359](https://github.com/ClickHouse/ClickHouse/pull/23359) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 設定 `optimize_skip_unused_shards_rewrite_in` が有効な場合に型変換を追加しました。これにより MSan レポートで報告されていた問題が修正されます。[#23219](https://github.com/ClickHouse/ClickHouse/pull/23219) ([Azat Khuzhin](https://github.com/azat))。
* ネストされたサブカラムを更新する際に不足していたチェックを追加し、Issue [#22353](https://github.com/ClickHouse/ClickHouse/issues/22353) をクローズしました。 [#22503](https://github.com/ClickHouse/ClickHouse/pull/22503)（[hexiaoting](https://github.com/hexiaoting)）。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-5}

- Illumosでのビルドをサポート。[#24144](https://github.com/ClickHouse/ClickHouse/pull/24144)。Solaris派生オペレーティングシステムでのビルドサポートを追加。[#23746](https://github.com/ClickHouse/ClickHouse/pull/23746) ([bnaecker](https://github.com/bnaecker))。
- ハッシュテーブルのベンチマークを追加。GoogleのSwiss Tableを含む(当社の特定の使用シナリオではClickHouseハッシュマップより遅いことが判明)。[#24111](https://github.com/ClickHouse/ClickHouse/pull/24111) ([Maksim Kita](https://github.com/kitaisreal))。
- librdkafkaを1.6.0-RC3から1.6.1に更新。[#23874](https://github.com/ClickHouse/ClickHouse/pull/23874) ([filimonov](https://github.com/filimonov))。
- `asynchronous-unwind-tables`を常に明示的に有効化。AArch64でのクエリプロファイラの問題を修正する可能性がある。[#23602](https://github.com/ClickHouse/ClickHouse/pull/23602) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- ロケールとファイルシステムの順序への依存を回避。これにより再現可能なビルドが可能になる。[#23600](https://github.com/ClickHouse/ClickHouse/pull/23600) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- ビルドから非決定性の原因を除去。異なる時点でのビルドがバイト単位で同一のバイナリを生成するようになった。[#22113](https://github.com/ClickHouse/ClickHouse/issues/22113)を部分的に対処。[#23559](https://github.com/ClickHouse/ClickHouse/pull/23559) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- (Zoo)Keeperのベンチマーク用シンプルツールを追加。[#23038](https://github.com/ClickHouse/ClickHouse/pull/23038) ([alesapin](https://github.com/alesapin))。


## ClickHouse release 21.5, 2021-05-20 {#clickhouse-release-215-2021-05-20}

#### 後方互換性のない変更 {#backward-incompatible-change-6}

- 整数が浮動小数点データ型で正確に表現できない場合の、整数と浮動小数点数の比較動作を変更しました。新しいバージョンでは、丸め誤差が発生するため比較結果はfalseを返します。例:`9223372036854775808.0 != 9223372036854775808`。これは、数値`9223372036854775808`が浮動小数点数として正確に表現できないためです(`9223372036854775808.0`は`9223372036854776000.0`に丸められます)。しかし、以前のバージョンでは、浮動小数点数`9223372036854776000.0`をUInt64に変換すると`9223372036854775808`になるため、比較結果は数値が等しいとして返されていました。参考までに、Pythonプログラミング言語もこれらの数値を等しいものとして扱います。しかし、この動作はCPUモデルに依存していた(範囲外の一部の数値についてAMD64とAArch64で異なる結果)ため、比較をより正確にしました。整数が浮動小数点型で正確に表現される場合にのみ、整数と浮動小数点数を等しいものとして扱います。[#22595](https://github.com/ClickHouse/ClickHouse/pull/22595) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 単一の`Tuple`引数に対する`argMin`と`argMax`のサポートを削除しました。コードがメモリセーフではありませんでした。この機能は誤って追加されたものであり、ユーザーにとって混乱を招くものでした。これらの関数は後で異なる名前で再導入される可能性があります。これにより[#22384](https://github.com/ClickHouse/ClickHouse/issues/22384)が修正され、[#17359](https://github.com/ClickHouse/ClickHouse/issues/17359)が取り消されます。[#23393](https://github.com/ClickHouse/ClickHouse/pull/23393) ([alexey-milovidov](https://github.com/alexey-milovidov))。

#### 新機能 {#new-feature-6}

- 関数`dictGetChildren(dictionary, key)`、`dictGetDescendants(dictionary, key, level)`を追加しました。関数`dictGetChildren`は、すべての子要素をインデックスの配列として返します。これは`dictGetHierarchy`の逆変換です。関数`dictGetDescendants`は、`dictGetChildren`を`level`回再帰的に適用した場合と同様に、すべての子孫を返します。`level`値がゼロの場合は無限大と同等です。`dictGetHierarchy`、`dictIsIn`関数のパフォーマンスを改善しました。[#14656](https://github.com/ClickHouse/ClickHouse/issues/14656)をクローズします。[#22096](https://github.com/ClickHouse/ClickHouse/pull/22096) ([Maksim Kita](https://github.com/kitaisreal))。
- 関数`dictGetOrNull`を追加しました。`dictGet`と同様に動作しますが、辞書内にキーが見つからなかった場合は`Null`を返します。[#22375](https://github.com/ClickHouse/ClickHouse/issues/22375)をクローズします。[#22413](https://github.com/ClickHouse/ClickHouse/pull/22413) ([Maksim Kita](https://github.com/kitaisreal))。
- テーブル関数`s3Cluster`を追加しました。これにより、指定されたクラスタのすべてのノードで`s3`からのファイルを並列処理できます。[#22012](https://github.com/ClickHouse/ClickHouse/pull/22012) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- MySQL/PostgreSQLテーブルエンジン/テーブル関数でレプリカとシャードのサポートを追加しました。`SELECT * FROM mysql('host{1,2}-{1|2}', ...)`のように記述できます。[#20969](https://github.com/ClickHouse/ClickHouse/issues/20969)をクローズします。[#22217](https://github.com/ClickHouse/ClickHouse/pull/22217) ([Kseniia Sumarokova](https://github.com/kssenii))。
- `ALTER TABLE ... FETCH PART ...`クエリを追加しました。`FETCH PARTITION`と似ていますが、1つのパートのみを取得します。[#22706](https://github.com/ClickHouse/ClickHouse/pull/22706) ([turbo jason](https://github.com/songenjie))。
- `Distributed`テーブルへの再帰クエリの深さを制限する設定`max_distributed_depth`を追加しました。[#20229](https://github.com/ClickHouse/ClickHouse/issues/20229)をクローズします。[#21942](https://github.com/ClickHouse/ClickHouse/pull/21942) ([flynn](https://github.com/ucasFL))。


#### パフォーマンス改善 {#performance-improvement-6}

- AVX2の動的ディスパッチにより`intDiv`のパフォーマンスを改善しました。これにより[#22314](https://github.com/ClickHouse/ClickHouse/issues/22314)が解決されます。[#23000](https://github.com/ClickHouse/ClickHouse/pull/23000) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- ローカルファイル以外のソース(URLなど)からの`ArrowStream`入力フォーマットの読み取りパフォーマンスを改善しました。[#22673](https://github.com/ClickHouse/ClickHouse/pull/22673) ([nvartolomei](https://github.com/nvartolomei))。
- ネイティブプロトコル経由でlocalhost(clickhouse-clientまたは分散クエリによるサーバー間通信)とやり取りする際、デフォルトで圧縮を無効化しました。これにより一部のインポート/エクスポート操作のパフォーマンスが向上する可能性があります。これにより[#22234](https://github.com/ClickHouse/ClickHouse/issues/22234)が解決されます。[#22237](https://github.com/ClickHouse/ClickHouse/pull/22237) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 分散クエリのIN句の右辺から、シャードに属さない値を除外するようにしました(`optimize_skip_unused_shards_rewrite_in`配下で、デフォルトで有効化されていますが、`optimize_skip_unused_shards`が依然として必要です)。[#21511](https://github.com/ClickHouse/ClickHouse/pull/21511) ([Azat Khuzhin](https://github.com/azat))。
- ファイル型テーブルエンジンおよびParquet、Arrow、ORCなどのカラム指向フォーマットで、列のサブセットを読み取る際のパフォーマンスを改善しました。これにより[#issue:20129](https://github.com/ClickHouse/ClickHouse/issues/20129)が解決されます。[#21302](https://github.com/ClickHouse/ClickHouse/pull/21302) ([keenwolf](https://github.com/keen-wolf))。
- バージョン21.1以前のように、より多くの条件を`PREWHERE`に移動できるようにしました(内部ヒューリスティックの調整)。移動される条件が不十分な場合、パフォーマンスが低下する可能性がありました。[#23397](https://github.com/ClickHouse/ClickHouse/pull/23397) ([Anton Popov](https://github.com/CurtizJ))。
- ODBC接続のパフォーマンスを改善し、バックログにあったすべての未解決の問題を修正しました。`Poco::ODBC`の代わりに`nanodbc`ライブラリを使用しています。[#9678](https://github.com/ClickHouse/ClickHouse/issues/9678)が解決されます。ODBCテーブルエンジンにDateTime64とDecimal\*のサポートを追加しました。[#21961](https://github.com/ClickHouse/ClickHouse/issues/21961)が解決されます。キリル文字のテキストが切り捨てられる問題を修正しました。[#16246](https://github.com/ClickHouse/ClickHouse/issues/16246)が解決されます。ODBCブリッジ用の接続プールを追加しました。[#21972](https://github.com/ClickHouse/ClickHouse/pull/21972) ([Kseniia Sumarokova](https://github.com/kssenii))。

#### 改善 {#improvement-6}


* `max_uri_size`（HTTP インターフェイスにおける URL の最大サイズ）のデフォルト値を 1 MiB に引き上げました。これにより [#21197](https://github.com/ClickHouse/ClickHouse/issues/21197) がクローズされました。 [#22997](https://github.com/ClickHouse/ClickHouse/pull/22997)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `background_fetches_pool_size` を、本番環境での頻繁な小規模挿入や ZooKeeper クラスターが遅い場合の利用により適した値である `8` に設定しました。 [#22945](https://github.com/ClickHouse/ClickHouse/pull/22945) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* FlatDictionary に `initial_array_size` と `max_array_size` オプションを追加しました。 [#22521](https://github.com/ClickHouse/ClickHouse/pull/22521) ([Maksim Kita](https://github.com/kitaisreal))。
* レプリケートされていない MergeTree での挿入の重複排除のために、新しい設定 `non_replicated_deduplication_window` を追加しました。 [#22514](https://github.com/ClickHouse/ClickHouse/pull/22514) ([alesapin](https://github.com/alesapin)).
* 設定のリロード時に `CatBoost` モデル設定ファイルへのパスを更新するように変更。 [#22434](https://github.com/ClickHouse/ClickHouse/pull/22434) ([Kruglov Pavel](https://github.com/Avogar)).
* 辞書で `Decimal256` 型のサポートを追加しました。`Decimal256` は実験的な機能です。[#20979](https://github.com/ClickHouse/ClickHouse/issues/20979) をクローズ。[#22960](https://github.com/ClickHouse/ClickHouse/pull/22960)（[Maksim Kita](https://github.com/kitaisreal)）。
* `async_socket_for_remote` をデフォルトで有効にしました（分散クエリに使用する OS スレッド数を削減します）。 [#23683](https://github.com/ClickHouse/ClickHouse/pull/23683) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `quantile(s)TDigest` を修正しました。tdunning/t-digest 3.2+ に従い、単一セントロイドに対する特別な処理を追加しました。また、アルゴリズムの旧バージョン実装におけるセントロイドの過剰圧縮に関するバグも修正しました。 [#23314](https://github.com/ClickHouse/ClickHouse/pull/23314) ([Vladimir Chebotarev](https://github.com/excitoon)).
* MySQL との互換性のため、関数名 `unhex` を大文字小文字を区別しないようにしました。 [#23229](https://github.com/ClickHouse/ClickHouse/pull/23229) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 配列要素の型が異なる一般的なケースに対して、`arrayHasAny`、`arrayHasAll`、`has`、`indexOf`、`countEqual` 関数を実装しました。以前のバージョンでは、`arrayHasAny`、`arrayHasAll` 関数は false を返し、`has`、`indexOf`、`countEqual` は例外をスローしていました。さらに、`has` などの関数で `Decimal` 型およびビッグ整数型のサポートを追加しました。これにより [#20272](https://github.com/ClickHouse/ClickHouse/issues/20272) がクローズされました。 [#23044](https://github.com/ClickHouse/ClickHouse/pull/23044) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 関数 `extractAllGroupsHorizontal` の結果で許可されるマッチ数の上限値を引き上げました。 [#23036](https://github.com/ClickHouse/ClickHouse/pull/23036) ([Vasily Nemkov](https://github.com/Enmk))。
* 1 ノードだけのクラスタでは `optimize_skip_unused_shards` を実行しないようにしました。 [#22999](https://github.com/ClickHouse/ClickHouse/pull/22999) ([Azat Khuzhin](https://github.com/azat)).
* ZooKeeper の実験的なドロップイン代替である clickhouse-keeper を SSL で実行できるようになりました。設定項目 `keeper_server.tcp_port_secure` は、クライアントと keeper-server 間のセキュアな通信に使用できます。`keeper_server.raft_configuration.secure` は、ノード間の内部セキュア通信を有効にするために使用できます。[#22992](https://github.com/ClickHouse/ClickHouse/pull/22992) ([alesapin](https://github.com/alesapin))。
* `Buffer` テーブルに対して、バッファをバックグラウンドでのみフラッシュできる機能を追加しました。 [#22986](https://github.com/ClickHouse/ClickHouse/pull/22986) ([Azat Khuzhin](https://github.com/azat))。
* WHERE 句に NULL を含む条件で MergeTree テーブルから SELECT を実行した際に、まれに例外がスローされることがありました。この問題は [#20019](https://github.com/ClickHouse/ClickHouse/issues/20019) を解決しました。[#22978](https://github.com/ClickHouse/ClickHouse/pull/22978)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* AWS 用 Poco HTTP クライアントのエラー処理を修正しました。 [#22973](https://github.com/ClickHouse/ClickHouse/pull/22973) ([kreuzerkrieg](https://github.com/kreuzerkrieg))。
* `ReplicatedMergeTree` で `max_part_removal_threads` を正しく尊重するようにしました。 [#22971](https://github.com/ClickHouse/ClickHouse/pull/22971) ([Azat Khuzhin](https://github.com/azat)).
* MergeTree 設定 `inactive_parts_to_throw_insert = 0` と `inactive_parts_to_delay_insert &gt; 0` の組み合わせで発生する、分かりにくいコーナーケースを修正。 [#22947](https://github.com/ClickHouse/ClickHouse/pull/22947) ([Azat Khuzhin](https://github.com/azat)).
* `dateDiff` が `DateTime64` の引数でも動作するようになりました（`DateTime` の範囲外の値にも対応） [#22931](https://github.com/ClickHouse/ClickHouse/pull/22931) ([Vasily Nemkov](https://github.com/Enmk))。
* MaterializeMySQL（実験的機能）：ビューを含む MySQL データベースをエラーなくレプリケートできるようになりました。これは、ビューを無視することで実現しています。 [#22760](https://github.com/ClickHouse/ClickHouse/pull/22760) ([Christian](https://github.com/cfroystad)).
* PostgreSQL プロトコル経由で RBAC の行ポリシーを利用できるようにしました。 [#22658](https://github.com/ClickHouse/ClickHouse/issues/22658) をクローズ。PostgreSQL プロトコルは、設定でデフォルト有効になっています。 [#22755](https://github.com/ClickHouse/ClickHouse/pull/22755)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* Buffer レイヤーロックの待機に要した時間を計測するメトリクスを追加。 [#22725](https://github.com/ClickHouse/ClickHouse/pull/22725) ([Azat Khuzhin](https://github.com/azat)).
* VIEW 定義で CTE を使用できるようにしました。これにより [#22491](https://github.com/ClickHouse/ClickHouse/issues/22491) がクローズされました。 [#22657](https://github.com/ClickHouse/ClickHouse/pull/22657) ([Amos Bird](https://github.com/amosbird))。
* 前のプログラムがターミナルに不要な表示を残していた場合に、`clickhouse-client` で画面の残りを消去してカーソルを表示するようにしました。これにより [#16518](https://github.com/ClickHouse/ClickHouse/issues/16518) がクローズされました。 [#22634](https://github.com/ClickHouse/ClickHouse/pull/22634) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 非 x86&#95;64 プラットフォームにおいても一貫した動作をするように `round` 関数を修正しました。1/2 の端数は最近接の偶数に丸める（Banker&#39;s rounding）方式を使用します。 [#22582](https://github.com/ClickHouse/ClickHouse/pull/22582) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Distributed テーブルから送信されるデータブロックの構造を正しく検査するようにしました。 [#22325](https://github.com/ClickHouse/ClickHouse/pull/22325) ([Azat Khuzhin](https://github.com/azat)).
* `kafka_handle_error_mode` 設定で制御される Kafka エラーを、Kafka エンジンの仮想カラムに出力できるようにしました。 [#21850](https://github.com/ClickHouse/ClickHouse/pull/21850) ([fastio](https://github.com/fastio)).
* `visitParam/visitParamExtract{UInt, Int, Bool, Float, Raw, String}` に `simpleJSONExtract/simpleJSONHas` のエイリアスを追加しました。[#21383](https://github.com/ClickHouse/ClickHouse/issues/21383) を修正。[#21519](https://github.com/ClickHouse/ClickHouse/pull/21519)（[fastio](https://github.com/fastio)）。
* ライブラリディクショナリソース用に `clickhouse-library-bridge` を追加。 [#9502](https://github.com/ClickHouse/ClickHouse/issues/9502) をクローズ。 [#21509](https://github.com/ClickHouse/ClickHouse/pull/21509)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* マテリアライズドビューで参照されているカラムの削除を禁止。 [#21164](https://github.com/ClickHouse/ClickHouse/issues/21164) をクローズ。 [#21303](https://github.com/ClickHouse/ClickHouse/pull/21303)（[flynn](https://github.com/ucasFL)）。
* 動的なインターサーバー認証情報をサポート（ダウンタイムなしで認証情報をローテーション可能）。 [#14113](https://github.com/ClickHouse/ClickHouse/pull/14113) ([johnskopis](https://github.com/johnskopis)).
* `Arrow` および `ArrowStream` 形式メッセージを使用する Kafka ストレージのサポートを追加。 [#23415](https://github.com/ClickHouse/ClickHouse/pull/23415) ([Chao Ma](https://github.com/godliness)).
* 例外メッセージ内で不足していたセミコロンを修正しました。この例外メッセージは、ユーザーにとって読みづらく感じられる可能性があります。 [#23208](https://github.com/ClickHouse/ClickHouse/pull/23208) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `LowCardinality` 型に関する一部の例外メッセージで不足していた空白文字を修正しました。 [#23207](https://github.com/ClickHouse/ClickHouse/pull/23207) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 一部の値が `Markdown` 形式の表セル内で中央揃えで表示されていましたが、現在はそうではありません。 [#23096](https://github.com/ClickHouse/ClickHouse/pull/23096) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* clickhouse-client のサジェストから不要な詳細情報を削除しました。これにより [#22158](https://github.com/ClickHouse/ClickHouse/issues/22158) がクローズされました。 [#23040](https://github.com/ClickHouse/ClickHouse/pull/23040) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* sparse&#95;hashed 辞書に対して、system.dictionaries の `bytes_allocated` フィールドが正しく計算されるように修正しました。 [#22867](https://github.com/ClickHouse/ClickHouse/pull/22867) ([Azat Khuzhin](https://github.com/azat))。
* MergeTree からの逆順読み取り時における概算総行数の計算を修正。 [#22726](https://github.com/ClickHouse/ClickHouse/pull/22726) ([Azat Khuzhin](https://github.com/azat)).
* `clickhouse` ソースを使用する辞書が自分自身を参照するように設定できてしまい、無限ループが発生する可能性があった問題を修正。[#14314](https://github.com/ClickHouse/ClickHouse/issues/14314) をクローズ。[#22479](https://github.com/ClickHouse/ClickHouse/pull/22479)（[Maksim Kita](https://github.com/kitaisreal)）。

#### バグ修正 {#bug-fix-5}


* ヘッジリクエストに対する複数の修正。設定 `use_hedged_requests` が有効な場合に、`GLOBAL IN/JOIN` を含むクエリで発生していた `Can't initialize pipeline with empty pipe` エラーを修正。 [#23431](https://github.com/ClickHouse/ClickHouse/issues/23431) を修正。 [#23805](https://github.com/ClickHouse/ClickHouse/pull/23805) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。クラッシュを引き起こす原因となっていたヘッジ接続でのレースコンディションを修正。これにより [#22161](https://github.com/ClickHouse/ClickHouse/issues/22161) が修正されました。 [#22443](https://github.com/ClickHouse/ClickHouse/pull/22443) ([Kruglov Pavel](https://github.com/Avogar))。リモートクエリから `unknown packet` を受信した場合（`async_socket_for_remote` が有効なとき）に発生しうるクラッシュを修正。 [#21167](https://github.com/ClickHouse/ClickHouse/issues/21167) を修正。 [#23309](https://github.com/ClickHouse/ClickHouse/pull/23309) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `input_format_with_names_use_header` 設定を無効化した際に、CSVWithNames フォーマットでの入力データがすべて破棄されてしまう挙動を修正しました。これにより [#22406](https://github.com/ClickHouse/ClickHouse/issues/22406) が修正されました。 [#23202](https://github.com/ClickHouse/ClickHouse/pull/23202) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* リモート JDBC ブリッジの接続タイムアウト問題を修正しました。[#9609](https://github.com/ClickHouse/ClickHouse/issues/9609) をクローズ。[#23771](https://github.com/ClickHouse/ClickHouse/pull/23771)（[Maksim Kita](https://github.com/kitaisreal)、[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `update_field` が指定されている場合の `complex_key_hashed` の初期読み込みロジックを修正します。 [#23800](https://github.com/ClickHouse/ClickHouse/issues/23800) をクローズ。 [#23824](https://github.com/ClickHouse/ClickHouse/pull/23824)（[Maksim Kita](https://github.com/kitaisreal)）。
* `PREWHERE` と行ポリシーフィルタの両方が有効で、結果が空になる場合に発生していたクラッシュを修正しました。 [#23763](https://github.com/ClickHouse/ClickHouse/pull/23763) ([Amos Bird](https://github.com/amosbird)).
* INSERT を Distributed テーブルに対して実行する際に（何らかの例外が発生した場合に）起こり得る「Cannot schedule a task」エラーを回避しました。 [#23744](https://github.com/ClickHouse/ClickHouse/pull/23744) ([Azat Khuzhin](https://github.com/azat)).
* 集約関数 `mannWhitneyUTest` において、両方のサンプルの値が完全に同一である場合にスローされる例外を追加しました。これにより [#23646](https://github.com/ClickHouse/ClickHouse/issues/23646) が修正されました。 [#23654](https://github.com/ClickHouse/ClickHouse/pull/23654) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* HTTP 経由でデータを挿入する際にサーバー障害によって例外が発生していた問題を修正しました。これにより [#23512](https://github.com/ClickHouse/ClickHouse/issues/23512) が解決されました。 [#23643](https://github.com/ClickHouse/ClickHouse/pull/23643) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 一部のエスケープシーケンスを含む `LIKE` 式が誤って解釈される問題を修正しました。 [#23610](https://github.com/ClickHouse/ClickHouse/pull/23610) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 再起動 / 停止コマンドがハングする問題を修正しました。 [#20214](https://github.com/ClickHouse/ClickHouse/issues/20214) をクローズしました。 [#23552](https://github.com/ClickHouse/ClickHouse/pull/23552)（[filimonov](https://github.com/filimonov)）。
* `SELECT` クエリで複数の `JOIN` がある場合の `COLUMNS` マッチャーを修正しました。 [#22736](https://github.com/ClickHouse/ClickHouse/issues/22736) をクローズしました。 [#23501](https://github.com/ClickHouse/ClickHouse/pull/23501) ([Maksim Kita](https://github.com/kitaisreal)).
* `ReplacingMergeTree` のパラメータとしてカラム自身が使用されている場合に、そのカラムのデフォルト値を変更するとクラッシュする問題を修正しました。 [#23483](https://github.com/ClickHouse/ClickHouse/pull/23483) ([hexiaoting](https://github.com/hexiaoting)).
* `ReplacingMergeTree` における垂直マージのコーナーケースを修正しました。まれなケースで、`Incomplete granules are not allowed while blocks are granules size` のような例外とともにマージが失敗する可能性がありました。 [#23459](https://github.com/ClickHouse/ClickHouse/pull/23459) ([Anton Popov](https://github.com/CurtizJ)).
* 空の配列リテラルから、次元が 1 より大きい配列 (例: `CAST([] AS Array(Array(String)))`) へのキャストができないバグを修正しました。 [#14476](https://github.com/ClickHouse/ClickHouse/issues/14476) をクローズ。 [#23456](https://github.com/ClickHouse/ClickHouse/pull/23456) ([Maksim Kita](https://github.com/kitaisreal))。
* カウンターのリセット後に `deltaSum` 集約関数が誤った結果を返す不具合を修正しました。 [#23437](https://github.com/ClickHouse/ClickHouse/pull/23437) ([Russ Frank](https://github.com/rf)).
* マルチディスク構成で `ReplicatedMergeTree` テーブルの作成に失敗した場合に発生していた `Cannot unlink file` エラーを修正しました。これにより [#21755](https://github.com/ClickHouse/ClickHouse/issues/21755) がクローズされました。 [#23433](https://github.com/ClickHouse/ClickHouse/pull/23433) ([tavplubix](https://github.com/tavplubix))。
* 仮想カラムに基づくパーティションプルーニング時に生成される、非互換な定数式を修正しました。これにより [https://github.com/ClickHouse/ClickHouse/pull/21401#discussion&#95;r611888913](https://github.com/ClickHouse/ClickHouse/pull/21401#discussion_r611888913) が解決されました。 [#23366](https://github.com/ClickHouse/ClickHouse/pull/23366) ([Amos Bird](https://github.com/amosbird))。
* `join_algorithm` が `auto` に設定されていて、Dictionary を使った Join を実行した場合に発生していたクラッシュを修正しました。[#23002](https://github.com/ClickHouse/ClickHouse/issues/23002) をクローズ。 [#23312](https://github.com/ClickHouse/ClickHouse/pull/23312) ([Vladimir](https://github.com/vdimir))。
* パーティションプルーニング時に `NOT` 条件を緩めないようにしました。これにより [#23305](https://github.com/ClickHouse/ClickHouse/issues/23305) と [#21539](https://github.com/ClickHouse/ClickHouse/issues/21539) が修正されます。 [#23310](https://github.com/ClickHouse/ClickHouse/pull/23310) ([Amos Bird](https://github.com/amosbird))。
* 古いブロックのバックグラウンドクリーンアップにおける、非常にまれなレースコンディションを修正しました。これにより、重複排除ウィンドウの末端に近すぎる場合に、ブロックが重複排除されない可能性がありました。 [#23301](https://github.com/ClickHouse/ClickHouse/pull/23301) ([tavplubix](https://github.com/tavplubix))。
* ReplicatedMergeTree テーブルの作成と削除の間で、ごくまれに発生する（分散）レースコンディションを修正しました。これにより、レプリケーテッドテーブルの作成を試みた際に `node doesn't exist` のような例外が発生する可能性がありました。 [#21419](https://github.com/ClickHouse/ClickHouse/issues/21419) を修正。 [#23294](https://github.com/ClickHouse/ClickHouse/pull/23294)（[tavplubix](https://github.com/tavplubix)）。
* 主キーが最初の属性でない場合に、DDL から作成される simple key 辞書の問題を修正しました。 [#23236](https://github.com/ClickHouse/ClickHouse/issues/23236) の修正。 [#23262](https://github.com/ClickHouse/ClickHouse/pull/23262)（[Maksim Kita](https://github.com/kitaisreal)）。
* テーブル内に長いカラム名が多数存在する場合の ODBC からの読み取りを修正しました。[#8853](https://github.com/ClickHouse/ClickHouse/issues/8853) をクローズしました。[#23215](https://github.com/ClickHouse/ClickHouse/pull/23215)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* MaterializeMySQL（実験的機能）：キー列に対する条件を指定して `MaterializeMySQL` から `SELECT` した際に発生していた `Not found column` エラーを修正しました。 [#22432](https://github.com/ClickHouse/ClickHouse/issues/22432) を解決。 [#23200](https://github.com/ClickHouse/ClickHouse/pull/23200)（[tavplubix](https://github.com/tavplubix)）。
* 副問い合わせが定数に最適化された場合のエイリアス処理を修正。[#22924](https://github.com/ClickHouse/ClickHouse/issues/22924) を修正。[#10401](https://github.com/ClickHouse/ClickHouse/issues/10401) を修正。[#23191](https://github.com/ClickHouse/ClickHouse/pull/23191)（[Maksim Kita](https://github.com/kitaisreal)）。
* `data_type_default_nullable` 設定が `default` プロファイルで有効化されている場合にサーバーの起動に失敗することがありましたが、修正されました。[#22573](https://github.com/ClickHouse/ClickHouse/issues/22573) を修正。[#23185](https://github.com/ClickHouse/ClickHouse/pull/23185)（[tavplubix](https://github.com/tavplubix)）。
* 現在の接続数の誤った計上が原因で、シャットダウン時にクラッシュする問題を修正しました。 [#23154](https://github.com/ClickHouse/ClickHouse/pull/23154) ([Vitaly Baranov](https://github.com/vitlibar))。
* Atomic データベースからデタッチして再アタッチした後、マテリアライズドビューからの SELECT 時に `Table .inner_id... doesn't exist` エラーが発生する問題を修正しました。 [#23047](https://github.com/ClickHouse/ClickHouse/pull/23047) ([tavplubix](https://github.com/tavplubix)).
* `untuple` を使用するサブクエリで発生する可能性がある `Cannot find column in ActionsDAG result` エラーを修正。[#22290](https://github.com/ClickHouse/ClickHouse/issues/22290) を修正。[#22991](https://github.com/ClickHouse/ClickHouse/pull/22991)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* NULL 値を許容する `Map` 型の定数カラムの扱いを修正しました。 [#22939](https://github.com/ClickHouse/ClickHouse/pull/22939) ([Anton Popov](https://github.com/CurtizJ)).
* `DateTime64` に対する `formatDateTime()` と「%C」書式指定子を修正し、大きな値およびスケールが 0 でない場合における `toDateTime64()` の動作を修正しました。 [#22937](https://github.com/ClickHouse/ClickHouse/pull/22937) ([Vasily Nemkov](https://github.com/Enmk))。
* ウィンドウ関数と併用した `mannWhitneyUTest` および `rankCorr` によりクラッシュが発生する問題を修正しました。これにより [#22728](https://github.com/ClickHouse/ClickHouse/issues/22728) が解決されました。 [#22876](https://github.com/ClickHouse/ClickHouse/pull/22876) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* LIVE VIEW（実験的機能）：`TemporaryLiveViewCleaner` における TEMPORARY LIVE VIEW の DROP/CREATE 操作が並行実行された際にハングする可能性があった問題を修正しました。[参照](https://gist.github.com/vzakaznikov/0c03195960fc86b56bfe2bc73a90019e)。[#22858](https://github.com/ClickHouse/ClickHouse/pull/22858)（[Vitaly Baranov](https://github.com/vitlibar)）。
* フィルター列が集約で使用されている場合の `HAVING` のプッシュダウンを修正しました。 [#22763](https://github.com/ClickHouse/ClickHouse/pull/22763) ([Anton Popov](https://github.com/CurtizJ)).
* OOM 例外発生時に Zookeeper リクエストがハングする可能性があった問題を修正しました。[#22438](https://github.com/ClickHouse/ClickHouse/issues/22438) を修正。[#22684](https://github.com/ClickHouse/ClickHouse/pull/22684) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* ReplicatedMergeTree テーブルエンジンにおいて、複数レプリカ間でのミューテーション完了待ちの動作を修正しました。以前は、他のレプリカでミューテーションが実際に実行される前に、`MUTATION`／`ALTER` クエリが完了してしまうことがありました。 [#22669](https://github.com/ClickHouse/ClickHouse/pull/22669) ([alesapin](https://github.com/alesapin))。
* `SELECT` 句に列を含まないネストした型を持つ `Log` において発生していた例外を修正。 [#22654](https://github.com/ClickHouse/ClickHouse/pull/22654) ([Azat Khuzhin](https://github.com/azat)).
* 補助的な AWS リクエストに対する無制限の待機を修正。 [#22594](https://github.com/ClickHouse/ClickHouse/pull/22594) ([Vladimir Chebotarev](https://github.com/excitoon)).
* クライアントが接続を非常に早い段階で閉じた場合に発生していたクラッシュの問題を修正しました [#22579](https://github.com/ClickHouse/ClickHouse/issues/22579)。[#22591](https://github.com/ClickHouse/ClickHouse/pull/22591)（[nvartolomei](https://github.com/nvartolomei)）。
* `Map` データ型（実験的機能）：分散クエリにおける `map` 関数の誤った書式設定を修正しました。 [#22588](https://github.com/ClickHouse/ClickHouse/pull/22588) ([foolchi](https://github.com/foolchi)).
* TSV フォーマットで、末尾に改行がない空文字列のデシリアライズを修正しました。これにより [#20244](https://github.com/ClickHouse/ClickHouse/issues/20244) がクローズされます。バージョンを更新せずに行える回避策としては、`input_format_null_as_default` を 0 に設定することです。古いバージョンでは 0 が設定されていました。 [#22527](https://github.com/ClickHouse/ClickHouse/pull/22527) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* Merge Join アルゴリズムにおける `LowCardinality` 型の列の誤ったキャストを修正しました。[#22386](https://github.com/ClickHouse/ClickHouse/issues/22386)、[#22388](https://github.com/ClickHouse/ClickHouse/issues/22388) をクローズしました。[#22510](https://github.com/ClickHouse/ClickHouse/pull/22510)（[Vladimir](https://github.com/vdimir)）。
* `tokenbf_v1` フルテキストインデックスで、読み取り時にバッファオーバーフローが発生する可能性がありました。余分なバイトは使用されませんが、この読み取り操作がまれにクラッシュにつながる場合があります。この変更により [#19233](https://github.com/ClickHouse/ClickHouse/issues/19233) が解決されました。[#22421](https://github.com/ClickHouse/ClickHouse/pull/22421)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* HTTP チャンクサイズの制限を廃止。 [#21907](https://github.com/ClickHouse/ClickHouse/issues/21907) を修正。 [#22322](https://github.com/ClickHouse/ClickHouse/pull/22322)（[Ivan](https://github.com/abyss7)）。
* `optimize_aggregation_in_order` が有効で、テーブル内に多数のパーツが存在する場合にデータの集約漏れを引き起こすバグを修正しました。`optimize_aggregation_in_order` が有効な状態での集約処理のパフォーマンスをわずかに改善しました。 [#21889](https://github.com/ClickHouse/ClickHouse/pull/21889) ([Anton Popov](https://github.com/CurtizJ)).
* テーブル関数 `view` が列として使用されているかをチェックします。これは #20350 を補完する変更です。 [#21465](https://github.com/ClickHouse/ClickHouse/pull/21465) ([Amos Bird](https://github.com/amosbird))。
* `JOIN` と集約を含むクエリで `Merge` エンジンのテーブルに対して発生する「unknown column」エラーを修正。[#18368](https://github.com/ClickHouse/ClickHouse/issues/18368), [#22226](https://github.com/ClickHouse/ClickHouse/issues/22226) をクローズ。[#21370](https://github.com/ClickHouse/ClickHouse/pull/21370)（[Vladimir](https://github.com/vdimir)）。
* プッシュダウン最適化における名前の衝突を修正しました。これにより FULL JOIN 後の `WHERE` 句でのフィルタリングが誤った結果になる問題が発生していました。[#20497](https://github.com/ClickHouse/ClickHouse/issues/20497) をクローズ。[#20622](https://github.com/ClickHouse/ClickHouse/pull/20622)（[Vladimir](https://github.com/vdimir)）。
* `quorum_parallel=1` の `quorum insert` が重複排除の影響で実際には「クォーラム」になっていなかった、極めてまれなバグを修正しました。 [#18215](https://github.com/ClickHouse/ClickHouse/pull/18215) ([filimonov](https://github.com/filimonov) - 報告, [alesapin](https://github.com/alesapin) - 修正)。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-6}

- CI でステートレステストを並列実行するようにしました。[#22300](https://github.com/ClickHouse/ClickHouse/pull/22300) ([alesapin](https://github.com/alesapin))。
- Debian パッケージを簡素化しました。これにより [#21698](https://github.com/ClickHouse/ClickHouse/issues/21698) が修正されます。[#22976](https://github.com/ClickHouse/ClickHouse/pull/22976) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- Apple M1 での ClickHouse ビルドのサポートを追加しました。[#21639](https://github.com/ClickHouse/ClickHouse/pull/21639) ([changvvb](https://github.com/changvvb))。
- macOS 向けの ClickHouse Keeper ビルドを修正しました。[#22860](https://github.com/ClickHouse/ClickHouse/pull/22860) ([alesapin](https://github.com/alesapin))。
- AArch64 プラットフォームでの一部のテストを修正しました。[#22596](https://github.com/ClickHouse/ClickHouse/pull/22596) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- パフォーマンス向上の可能性のため、関数アライメントを追加しました。[#21431](https://github.com/ClickHouse/ClickHouse/pull/21431) ([Danila Kutenin](https://github.com/danlark1))。
- amd64 と aarch64 (qemu) で同一の結果を出力するように一部のテストを調整しました。結果は実装固有の CPU 動作に依存していました。[#22590](https://github.com/ClickHouse/ClickHouse/pull/22590) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- x86_64 でのみクエリプロファイリングを許可するようにしました。詳細は [#15174](https://github.com/ClickHouse/ClickHouse/issues/15174#issuecomment-812954965) および [#15638](https://github.com/ClickHouse/ClickHouse/issues/15638#issuecomment-703805337) を参照してください。これにより [#15638](https://github.com/ClickHouse/ClickHouse/issues/15638) がクローズされます。[#22580](https://github.com/ClickHouse/ClickHouse/pull/22580) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `USE_INTERNAL_XZ_LIBRARY=OFF` CMake オプションを使用して、バンドルされていない xz (lzma) でのビルドを可能にしました。[#22571](https://github.com/ClickHouse/ClickHouse/pull/22571) ([Kfir Itzhak](https://github.com/mastertheknife))。
- `ppc64le` でバンドルされた `openldap` を有効化しました。[#22487](https://github.com/ClickHouse/ClickHouse/pull/22487) ([Kfir Itzhak](https://github.com/mastertheknife))。
- `ppc64le` で互換性のないライブラリ(通常はプラットフォーム固有)を無効化しました。[#22475](https://github.com/ClickHouse/ClickHouse/pull/22475) ([Kfir Itzhak](https://github.com/mastertheknife))。
- ClickHouse Keeper 用の Jepsen テストを CI に追加しました。[#22373](https://github.com/ClickHouse/ClickHouse/pull/22373) ([alesapin](https://github.com/alesapin))。
- [ヒーププロファイリング](https://github.com/jemalloc/jemalloc/wiki/Use-Case%3A-Heap-Profiling)のサポートを含めて `jemalloc` をビルドするようにしました。[#22834](https://github.com/ClickHouse/ClickHouse/pull/22834) ([nvartolomei](https://github.com/nvartolomei))。
- 別スレッドからのロック解除による rwlock unlock の未定義動作を `*Log` エンジンで回避しました。[#22583](https://github.com/ClickHouse/ClickHouse/pull/22583) ([Azat Khuzhin](https://github.com/azat))。
- TinyLog の rwlock を同じスレッドからロック解除することで未定義動作を修正しました。[#22560](https://github.com/ClickHouse/ClickHouse/pull/22560) ([Azat Khuzhin](https://github.com/azat))。


## ClickHouse リリース 21.4 {#clickhouse-release-214}

### ClickHouse リリース 21.4.1 2021-04-12 {#clickhouse-release-2141-2021-04-12}

#### 後方互換性のない変更 {#backward-incompatible-change-7}

- `toStartOfIntervalFunction` は時間間隔を午前0時に揃えるようになります(以前のバージョンでは Unix エポックの開始時刻に揃えられていました)。例えば、`toStartOfInterval(x, INTERVAL 11 HOUR)` は毎日を3つの間隔に分割します:`00:00:00..10:59:59`、`11:00:00..21:59:59`、`22:00:00..23:59:59`。この動作は実用的なニーズにより適しています。これにより [#9510](https://github.com/ClickHouse/ClickHouse/issues/9510) がクローズされます。[#22060](https://github.com/ClickHouse/ClickHouse/pull/22060) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- graphite ロールアップ設定における `Age` と `Precision` は、保持期間ごとに増加する必要があります。現在はこれがチェックされ、誤った設定は例外を発生させます。[#21496](https://github.com/ClickHouse/ClickHouse/pull/21496) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- カスタムトップレベルドメインリストに存在する3レベル以上のドメインに対して、`cutToFirstSignificantSubdomainCustom()`/`firstSignificantSubdomainCustom()` が誤った結果を返す問題を修正しました。これらのカスタムトップレベルドメインに一致する入力ドメインでは、第3レベルドメインが最初の有意なドメインと見なされていました。これは修正されました。この変更により、例えばシャーディングキーでこの関数が使用されている場合、非互換性が生じる可能性があります。[#21946](https://github.com/ClickHouse/ClickHouse/pull/21946) ([Azat Khuzhin](https://github.com/azat))。
- テーブル `system.dictionaries` のカラム `keys` は、カラム `key.names` と `key.types` に置き換えられました。`system.dictionaries` テーブルのカラム `key.names`、`key.types`、`attribute.names`、`attribute.types` は、ディクショナリのロードを必要としません。[#21884](https://github.com/ClickHouse/ClickHouse/pull/21884) ([Maksim Kita](https://github.com/kitaisreal))。
- `ALTER TABLE ATTACH PART[ITION]` コマンドを処理するレプリカは、他のレプリカからデータを取得する前に、自身の `detached/` フォルダを検索するようになりました。実装の詳細として、レプリケーションログに新しいコマンド `ATTACH_PART` が導入されました。パーツはチェックサムによって検索および比較されます。[#18978](https://github.com/ClickHouse/ClickHouse/pull/18978) ([Mike Kot](https://github.com/myrrc))。**注意**:
  - クラスタのアップグレード中は `ATTACH PART[ITION]` クエリが動作しない可能性があります。
  - 新しいバージョンで `ALTER ... ATTACH` クエリを実行した後、古い ClickHouse バージョンにロールバックすることはできません。古いサーバーはレプリケーションログ内の `ATTACH_PART` エントリを処理できないためです。
- このバージョンでは、空の `<remote_url_allow_hosts></remote_url_allow_hosts>` はリモートホストへのすべてのアクセスをブロックしますが、以前のバージョンでは何も行いませんでした。古い動作を維持したい場合で、設定ファイルに空の `remote_url_allow_hosts` 要素がある場合は、それを削除してください。[#20058](https://github.com/ClickHouse/ClickHouse/pull/20058) ([Vladimir Chebotarev](https://github.com/excitoon))。

#### 新機能 {#new-feature-7}


* `DateTime64` の扱える範囲を拡張し、1925 年から 2283 年までの日付をサポートしました。ゼロ日付（`1970-01-01`）付近での `DateTime` のサポートを改善しました。 [#9404](https://github.com/ClickHouse/ClickHouse/pull/9404) ([alexey-milovidov](https://github.com/alexey-milovidov), [Vasily Nemkov](https://github.com/Enmk))。拡張された日付範囲に対しては、すべての日時関数が動作するわけではありません。
* 事前設定済みユーザーおよび HTTP リクエストに対する Kerberos 認証（GSS-SPNEGO）のサポートを追加しました。 [#14995](https://github.com/ClickHouse/ClickHouse/pull/14995) ([Denis Glazachev](https://github.com/traceon)).
* `prefer_column_name_to_alias` 設定を追加し、エイリアスではなく元のカラム名を使用できるようにしました。これは一般的なデータベースのエイリアス規則との互換性を高めるために必要です。[#9715](https://github.com/ClickHouse/ClickHouse/issues/9715) および [#9887](https://github.com/ClickHouse/ClickHouse/issues/9887) に対応しています。[#22044](https://github.com/ClickHouse/ClickHouse/pull/22044)（[Amos Bird](https://github.com/amosbird)）。
* 関数 `dictGetChildren(dictionary, key)`、`dictGetDescendants(dictionary, key, level)` を追加しました。関数 `dictGetChildren` は、すべての子要素をインデックスの配列として返します。これは `dictGetHierarchy` の逆変換です。関数 `dictGetDescendants` は、`dictGetChildren` を `level` 回再帰的に適用した場合と同様に、すべての子孫要素を返します。`level` の値が 0 の場合は無限大と同等です。[#14656](https://github.com/ClickHouse/ClickHouse/issues/14656) をクローズ。[#22096](https://github.com/ClickHouse/ClickHouse/pull/22096) ([Maksim Kita](https://github.com/kitaisreal))。
* `executable_pool` 辞書ソースを追加。 [#14528](https://github.com/ClickHouse/ClickHouse/issues/14528) をクローズ。 [#21321](https://github.com/ClickHouse/ClickHouse/pull/21321)（[Maksim Kita](https://github.com/kitaisreal)）。
* テーブル関数 `dictionary` を追加しました。`Dictionary` エンジンと同様に動作します。[#21560](https://github.com/ClickHouse/ClickHouse/issues/21560) をクローズしました。[#21910](https://github.com/ClickHouse/ClickHouse/pull/21910)（[Maksim Kita](https://github.com/kitaisreal)）。
* `PolygonDictionary` 属性で `Nullable` 型をサポートします。 [#21890](https://github.com/ClickHouse/ClickHouse/pull/21890) ([Maksim Kita](https://github.com/kitaisreal)).
* DDL で作成されたディクショナリに対してデータベース名が指定されていない場合、関数 `dictGet` と `dictHas` は現在のデータベース名を使用するようになりました。 [#21632](https://github.com/ClickHouse/ClickHouse/issues/21632) をクローズ。 [#21859](https://github.com/ClickHouse/ClickHouse/pull/21859) ([Maksim Kita](https://github.com/kitaisreal)).
* 関数 `dictGetOrNull` を追加しました。`dictGet` と同様に動作しますが、辞書内にキーが見つからなかった場合は `Null` を返します。 [#22375](https://github.com/ClickHouse/ClickHouse/issues/22375) をクローズ。[#22413](https://github.com/ClickHouse/ClickHouse/pull/22413)（[Maksim Kita](https://github.com/kitaisreal)）。
* `ComplexKeyCache`、`SSDCache`、`SSDComplexKeyCache` 辞書に非同期更新を追加しました。`Cache`、`ComplexKeyCache`、`SSDCache`、`SSDComplexKeyCache` 辞書で `Nullable` 型をサポートしました。`dictGet`、`dictGetOrDefault` 関数で複数属性の取得をサポートしました。[#21517](https://github.com/ClickHouse/ClickHouse/issues/21517) を修正。[#20595](https://github.com/ClickHouse/ClickHouse/pull/20595)（[Maksim Kita](https://github.com/kitaisreal)）。
* `RangeHashedDictionary` で `dictHas` 関数をサポート。 [#6680](https://github.com/ClickHouse/ClickHouse/issues/6680) を修正。 [#19816](https://github.com/ClickHouse/ClickHouse/pull/19816)（[Maksim Kita](https://github.com/kitaisreal)）。
* `DateTime` または `DateTime64` データ型のタイムゾーン名を返す関数 `timezoneOf` を追加しました。これは [#9959](https://github.com/ClickHouse/ClickHouse/issues/9959) をクローズするものではありません。関数名の不整合を修正しました。エイリアスとして `timezone` および `timeZone`、さらに `toTimezone` および `toTimeZone`、`timezoneOf` および `timeZoneOf` を追加しました。 [#22001](https://github.com/ClickHouse/ClickHouse/pull/22001)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `CREATE/ALTER USER` コマンドに新しいオプション句 `GRANTEES` を追加しました。これは、このユーザーが「付与オプション付き」で必要なすべてのアクセス権を持っていることを条件に、このユーザーから権限付与を受けることが許可されているユーザーまたはロールを指定します。デフォルトでは `GRANTEES ANY` が使用され、付与オプションを持つユーザーは誰にでも権限を付与できることを意味します。構文: `CREATE USER ... GRANTEES {user | role | ANY | NONE} [,...] [EXCEPT {user | role} [,...]]`。 [#21641](https://github.com/ClickHouse/ClickHouse/pull/21641) ([Vitaly Baranov](https://github.com/vitlibar)).
* `system.clusters` に新しいカラム `slowdowns_count` を追加しました。ヘッジ付きリクエストを使用している場合、あるレプリカの応答が遅いために別のレプリカへ切り替えた回数を示します。また、`system.clusters` で `errors_count` の実際の値も表示するようにしました。 [#21480](https://github.com/ClickHouse/ClickHouse/pull/21480) ([Kruglov Pavel](https://github.com/Avogar)).
* `MergeTree*` エンジンに `_partition_id` 仮想列を追加しました。`_partition_id` によるパーティションのプルーニングを可能にしました。パーティション ID の文字列を計算するための `partitionID()` 関数を追加しました。 [#21401](https://github.com/ClickHouse/ClickHouse/pull/21401) ([Amos Bird](https://github.com/amosbird)).
* 指定された CIDR ネットワークプレフィックスに IPv4 または IPv6 アドレスが含まれているかを判定する関数 `isIPAddressInRange` を追加しました。 [#21329](https://github.com/ClickHouse/ClickHouse/pull/21329) ([PHO](https://github.com/depressed-pho)).
* 新しい SQL コマンド `ALTER TABLE 'table_name' UNFREEZE [PARTITION 'part_expr'] WITH NAME 'backup_name'` を追加しました。このコマンドは、すべてのディスクから「フリーズ」されたパーティションを正しく削除するために必要です。 [#21142](https://github.com/ClickHouse/ClickHouse/pull/21142) ([Pavel Kovalenko](https://github.com/Jokser)).
* JOIN に対する暗黙的なキー型変換をサポートしました。 [#19885](https://github.com/ClickHouse/ClickHouse/pull/19885) ([Vladimir](https://github.com/vdimir)).

#### 実験的機能 {#experimental-feature-6}

- 浮動小数点型に対するウィンドウ関数の`RANGE OFFSET`フレームをサポート。`lagInFrame`/`leadInFrame`ウィンドウ関数を実装しました。これらは`lag`/`lead`に類似していますが、ウィンドウフレームを考慮します。フレームが`between unbounded preceding and unbounded following`の場合は同一の動作となります。これにより[#5485](https://github.com/ClickHouse/ClickHouse/issues/5485)が解決されます。[#21895](https://github.com/ClickHouse/ClickHouse/pull/21895) ([Alexander Kuzmenkov](https://github.com/akuzm))。
- S3ストレージ上の`ReplicatedMergeTree`に対するゼロコピーレプリケーション。[#16240](https://github.com/ClickHouse/ClickHouse/pull/16240) ([ianton-ru](https://github.com/ianton-ru))。
- 既存のS3ディスクをバックアップ・リストア機能を持つスキーマに移行する機能を追加しました。[#22070](https://github.com/ClickHouse/ClickHouse/pull/22070) ([Pavel Kovalenko](https://github.com/Jokser))。

#### パフォーマンス改善 {#performance-improvement-7}

- `clickhouse-local`およびその他すべての箇所で並列フォーマットをサポートしました。[#21630](https://github.com/ClickHouse/ClickHouse/pull/21630) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- `CSVWithNames`および`TSVWithNames`形式の並列パースをサポートしました。これにより[#21085](https://github.com/ClickHouse/ClickHouse/issues/21085)が解決されます。[#21149](https://github.com/ClickHouse/ClickHouse/pull/21149) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 64 MiB以上のファイル範囲に対してmmap IOによる読み取りを有効化しました(設定`min_bytes_to_use_mmap_io`)。これにより適度なパフォーマンス改善が期待できます。[#22326](https://github.com/ClickHouse/ClickHouse/pull/22326) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `min_bytes_to_use_mmap_io`設定で読み取られるファイルのキャッシュを追加しました。設定値が小さい場合、頻繁なmmap/munmap呼び出しとそれに伴うページフォルトを回避することで、大幅な(2倍以上の)パフォーマンス改善を実現します。なお、mmap IOには本番環境での信頼性を低下させる重大な欠点があります(例:障害のあるディスクでのハングやSIGBUS、メモリ使用量の制御性の低下)。それでもベンチマークでは優れた結果を示します。[#22206](https://github.com/ClickHouse/ClickHouse/pull/22206) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- コーデック`NONE`使用時の不要なデータコピーを回避しました。なお、コーデック`NONE`はほとんど無用であり、常に圧縮を使用することを推奨します(デフォルトは`LZ4`)。一般的な認識とは異なり、圧縮を無効にしてもパフォーマンスが向上しない場合があります(逆効果の可能性もあります)。`NONE`コーデックが有用なケース:データが圧縮不可能な場合、合成ベンチマーク用。[#22145](https://github.com/ClickHouse/ClickHouse/pull/22145) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 小さい`max_rows_to_group_by`と`group_by_overflow_mode='any'`を使用した`GROUP BY`を高速化しました。[#21856](https://github.com/ClickHouse/ClickHouse/pull/21856) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- `SELECT ... FINAL ... WHERE`のようなクエリのパフォーマンスを最適化しました。`FINAL`を含むクエリで、ソートキーに含まれるカラムを`PREWHERE`に移動できるようになりました。[#21830](https://github.com/ClickHouse/ClickHouse/pull/21830) ([foolchi](https://github.com/foolchi))。
- `memcpy`を別の実装に置き換えることでパフォーマンスを改善しました。これにより[#18583](https://github.com/ClickHouse/ClickHouse/issues/18583)が解決されます。[#21520](https://github.com/ClickHouse/ClickHouse/pull/21520) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- ソートキーの順序での集計のパフォーマンスを改善しました(設定`optimize_aggregation_in_order`を有効化した場合)。[#19401](https://github.com/ClickHouse/ClickHouse/pull/19401) ([Anton Popov](https://github.com/CurtizJ))。

#### 改善 {#improvement-7}


* PostgreSQL テーブル／データベースエンジンおよび辞書ソース向けの接続プールを追加。 [#21444](https://github.com/ClickHouse/ClickHouse/issues/21444) が修正されるはずです。 [#21839](https://github.com/ClickHouse/ClickHouse/pull/21839) ([Kseniia Sumarokova](https://github.com/kssenii)).
* postgres ストレージ / テーブル関数で、デフォルト以外のテーブルスキーマをサポートするようにしました。 [#21701](https://github.com/ClickHouse/ClickHouse/issues/21701) をクローズ。 [#21711](https://github.com/ClickHouse/ClickHouse/pull/21711) ([Kseniia Sumarokova](https://github.com/kssenii))。
* Postgres 辞書ソースでレプリカ優先度をサポート。[#21710](https://github.com/ClickHouse/ClickHouse/pull/21710)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* マージツリーに新しい設定 `min_bytes_to_rebalance_partition_over_jbod` を追加しました。これにより、JBOD ボリューム内の複数ディスクに新しいパーツをバランス良く割り当てることができます。 [#16481](https://github.com/ClickHouse/ClickHouse/pull/16481) ([Amos Bird](https://github.com/amosbird))。
* `system.query_log` 内の該当クエリに対して、`query_kind` 列に `Grant`、`Revoke`、`System` の値を追加しました。 [#21102](https://github.com/ClickHouse/ClickHouse/pull/21102) ([Vasily Nemkov](https://github.com/Enmk)).
* レプリケーションに使用される HTTP 接続のタイムアウトを、他の HTTP タイムアウトとは別に個別設定できるようにしました。 [#20088](https://github.com/ClickHouse/ClickHouse/pull/20088) ([nvartolomei](https://github.com/nvartolomei)).
* サーバーがブロックを書き込んでいる最中に例外が発生した場合に、クライアント側で表示される例外メッセージを改善しました。以前のバージョンでは、クライアントが `Data compressed with different methods` のような誤解を招くメッセージを受け取る可能性がありました。 [#22427](https://github.com/ClickHouse/ClickHouse/pull/22427) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 失敗したフェッチパーツの後に発生する可能性がある `Directory tmp_fetch_XXX already exists` エラーを修正しました。すでに存在する場合は一時フェッチディレクトリを削除します。 [#14197](https://github.com/ClickHouse/ClickHouse/issues/14197) を修正。 [#22411](https://github.com/ClickHouse/ClickHouse/pull/22411)（[nvartolomei](https://github.com/nvartolomei)）。
* `UInt256` 引数を持つ関数 `range` に対する MSan レポートを修正しました（大きな整数のサポートは実験的です）。これにより [#22157](https://github.com/ClickHouse/ClickHouse/issues/22157) がクローズされました。 [#22387](https://github.com/ClickHouse/ClickHouse/pull/22387)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `system.processes` テーブルに `current_database` 列を追加しました。クエリが現在参照しているデータベースが含まれます。 [#22365](https://github.com/ClickHouse/ClickHouse/pull/22365) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* `clickhouse-client` に大文字・小文字を区別しない履歴検索/移動機能とサブワード単位のカーソル移動機能を追加。 [#22105](https://github.com/ClickHouse/ClickHouse/pull/22105) ([Amos Bird](https://github.com/amosbird)).
* `IN` 演算子の左辺が `(NULL, NULL)` のような NULL のタプルで、右辺が非 NULL のタプルである場合（例：`SELECT (NULL, NULL) IN ((0, 0), (3, 1))`）、互換性のない型に関する例外をスローするのではなく、0 を返すようになりました。この式は、`SELECT (NULL, NULL) = (8, 0) OR (NULL, NULL) = (3, 2) OR (NULL, NULL) = (0, 0) OR (NULL, NULL) = (3, 1)` のような式の最適化によって現れることもあります。これにより [#22017](https://github.com/ClickHouse/ClickHouse/issues/22017) が解決されました。 [#22063](https://github.com/ClickHouse/ClickHouse/pull/22063)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 使用している simdjson のバージョンを 0.9.1 に更新しました。これにより [#21984](https://github.com/ClickHouse/ClickHouse/issues/21984) が修正されます。[#22057](https://github.com/ClickHouse/ClickHouse/pull/22057)（[Vitaly Baranov](https://github.com/vitlibar)）。
* `CONNECTION_ID()` 関数と `VERSION()` 関数に、大文字小文字を区別しないエイリアスを追加しました。これにより [#22028](https://github.com/ClickHouse/ClickHouse/issues/22028) が修正されます。[#22042](https://github.com/ClickHouse/ClickHouse/pull/22042)（[Eugene Klimov](https://github.com/Slach)）。
* `windowFunnel` 関数にオプション `strict_increase` を追加し、各イベントを一度だけ計算できるようにしました（[#21835](https://github.com/ClickHouse/ClickHouse/issues/21835) を解決）。[#22025](https://github.com/ClickHouse/ClickHouse/pull/22025)（[Vladimir](https://github.com/vdimir)）。
* `MergeTree` テーブルのパーティションキーに `Date` または `DateTime` 列が含まれておらず、`DateTime64` 列がちょうど 1 つだけ含まれている場合、その値が `system.parts` および `system.parts_columns` テーブルの `min_time` および `max_time` 列に反映されるようにしました。また、`system.parts_columns` テーブルに `min_time` および `max_time` 列を追加しました（`system.parts` テーブルとの不整合がありました）。これにより [#18244](https://github.com/ClickHouse/ClickHouse/issues/18244) がクローズされました。 [#22011](https://github.com/ClickHouse/ClickHouse/pull/22011) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `clickhouse-copier` において、ヘルパーテーブルから宛先へのパーティション移動時に `replication_alter_partitions_sync=1` 設定をサポートしました。デフォルトのタイムアウトを短縮しました。 [#21911](https://github.com/ClickHouse/ClickHouse/issues/21911) を修正しました。 [#21912](https://github.com/ClickHouse/ClickHouse/pull/21912)（[turbo jason](https://github.com/songenjie)）。
* システムテーブルに `EmbeddedRocksDB` テーブルのデータディレクトリへのパスを表示するようにしました。 [#21903](https://github.com/ClickHouse/ClickHouse/pull/21903) ([tavplubix](https://github.com/tavplubix)).
* プロファイルイベント `HedgedRequestsChangeReplica` を追加し、データ読み取りタイムアウトの単位を秒からミリ秒に変更します。 [#21886](https://github.com/ClickHouse/ClickHouse/pull/21886) ([Kruglov Pavel](https://github.com/Avogar)).
* DiskS3（開発中の実験的機能）。キャッシュディスクを使用している場合に、移動先が空でないとディレクトリを移動できない不具合を修正しました。 [#21837](https://github.com/ClickHouse/ClickHouse/pull/21837) ([Pavel Kovalenko](https://github.com/Jokser))。
* Web UI における `Array` および `Map` データ型のフォーマットを改善しました。 [#21798](https://github.com/ClickHouse/ClickHouse/pull/21798) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 構成が変更された場合にのみクラスタを更新するようにしました。 [#21685](https://github.com/ClickHouse/ClickHouse/pull/21685) ([Kruglov Pavel](https://github.com/Avogar)).
* 分散 DDL クエリに対してクエリ設定およびセッション設定を伝播できるようにしました。これを有効にするには `distributed_ddl_entry_format_version` を 2 に設定します。`distributed_ddl_output_mode` 設定を追加しました。サポートされるモード: `none`、`throw`（デフォルト）、`null_status_on_timeout`、`never_throw`。`Replicated` データベースエンジンに対する各種の修正と改善を行いました。[#21535](https://github.com/ClickHouse/ClickHouse/pull/21535) ([tavplubix](https://github.com/tavplubix))。
* `PODArray` が要素サイズとして 16 の倍数でも約数でもない値でインスタンス化された場合、バッファオーバーフローが発生する可能性がありました。現在のリリースには、この不具合は存在しません。 [#21533](https://github.com/ClickHouse/ClickHouse/pull/21533) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `system.errors` に `last_error_time` / `last_error_message` / `last_error_stacktrace` / `remote` 列を追加。[#21529](https://github.com/ClickHouse/ClickHouse/pull/21529) ([Azat Khuzhin](https://github.com/azat))。
* `visitParam/visitParamExtract{UInt, Int, Bool, Float, Raw, String}` に `simpleJSONExtract/simpleJSONHas` のエイリアスを追加しました。#21383 を修正します。[#21519](https://github.com/ClickHouse/ClickHouse/pull/21519) ([fastio](https://github.com/fastio))。
* `optimize_skip_unused_shards` におけるシャーディングキー値の数を制限するための設定 `optimize_skip_unused_shards_limit` を追加。 [#21512](https://github.com/ClickHouse/ClickHouse/pull/21512) ([Azat Khuzhin](https://github.com/azat)).
* `clickhouse-format` を改良し、最後のクエリの後に余分なスペースやコメントがあっても例外をスローしないようにするとともに、データ付きの `ASTInsertQuery` をフォーマットする際には、わかりやすいメッセージとともに早期に例外をスローするようにしました。 [#21311](https://github.com/ClickHouse/ClickHouse/pull/21311) ([flynn](https://github.com/ucasFL))。
* データ型 `Map` における整数キーのサポートを改善。 [#21157](https://github.com/ClickHouse/ClickHouse/pull/21157) ([Anton Popov](https://github.com/CurtizJ)).
* MaterializeMySQL: 接続が失われた場合に MySQL への再接続を試みるようにしました。 [#20961](https://github.com/ClickHouse/ClickHouse/pull/20961) ([Håvard Kvålen](https://github.com/havardk)).
* `CROSS JOIN` を `INNER JOIN` に書き換え可能なケースをさらにサポートしました。 [#20392](https://github.com/ClickHouse/ClickHouse/pull/20392) ([Vladimir](https://github.com/vdimir))。
* `optimize_on_insert` 設定が有効な場合に、INSERT で空のパーツが作成されないようにしました。 [#20304](https://github.com/ClickHouse/ClickHouse/issues/20304) を修正。 [#20387](https://github.com/ClickHouse/ClickHouse/pull/20387)（[Kruglov Pavel](https://github.com/Avogar)）。
* `MaterializeMySQL`: `_version` 列に対して minmax スキッピングインデックスを追加。 [#20382](https://github.com/ClickHouse/ClickHouse/pull/20382) ([Stig Bakken](https://github.com/stigsb))。
* `clickhouse-format` にオプション `--backslash` を追加しました。これにより、整形されたクエリの各行の末尾にバックスラッシュを追加できます。 [#21494](https://github.com/ClickHouse/ClickHouse/pull/21494) ([flynn](https://github.com/ucasFL)).
* すでに対象となっている部分に対してミューテーションを実行しようとしても、ClickHouse は `LOGICAL_ERROR` 例外をスローしなくなりました。[#22013](https://github.com/ClickHouse/ClickHouse/issues/22013) を修正。[#22291](https://github.com/ClickHouse/ClickHouse/pull/22291)（[alesapin](https://github.com/alesapin)）。

#### バグ修正 {#bug-fix-6}


* `HedgedConnections` でパケットレシーバーをキャンセルする前にソケットを epoll から削除し、レースコンディションが発生する可能性を防ぎます。[#22161](https://github.com/ClickHouse/ClickHouse/issues/22161) を修正。 [#22443](https://github.com/ClickHouse/ClickHouse/pull/22443) ([Kruglov Pavel](https://github.com/Avogar))。
* 並列パース処理に不足していたメモリ使用量の計測を追加しました。以前のバージョンでは、結果セットに非常に大きなデータブロックが含まれている場合に OOM が発生する可能性がありました。これにより [#22008](https://github.com/ClickHouse/ClickHouse/issues/22008) が解決されました。[#22425](https://github.com/ClickHouse/ClickHouse/pull/22425)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `SELECT` に定数の `WHERE` 条件があり、ソーステーブルに名前が数字のみのカラムが存在する場合に発生する可能性のある例外を修正しました。 [#22270](https://github.com/ClickHouse/ClickHouse/pull/22270) ([LiuNeng](https://github.com/liuneng1994)).
* `use_hedged_requests=0` および `async_socket_for_remote=1` 設定時のクエリキャンセルの問題を修正。 [#22183](https://github.com/ClickHouse/ClickHouse/pull/22183) ([Azat Khuzhin](https://github.com/azat)).
* `InterserverIOHTTPHandler` での未捕捉例外を修正。 [#22146](https://github.com/ClickHouse/ClickHouse/pull/22146) ([Azat Khuzhin](https://github.com/azat)).
* 設定ファイルに `http_port` がない場合の Docker エントリポイントを修正しました。 [#22132](https://github.com/ClickHouse/ClickHouse/pull/22132) ([Ewout](https://github.com/devwout)).
* `TOTALS` と `arrayJoin` を伴う `JOIN` で発生する `Invalid number of rows in Chunk` エラーを修正しました。[#19303](https://github.com/ClickHouse/ClickHouse/issues/19303) をクローズします。[#22129](https://github.com/ClickHouse/ClickHouse/pull/22129)（[Vladimir](https://github.com/vdimir)）。
* Kafka からメッセージをポーリングするバックグラウンドスレッドプールの名前を修正しました。スレッドプールが壊れている Kafka エンジンは、メッセージキューからメッセージを消費しません。[#22122](https://github.com/ClickHouse/ClickHouse/pull/22122) ([fastio](https://github.com/fastio))。
* `ReplicatedMergeTree` テーブルエンジンに対する `OPTIMIZE` および `ALTER` クエリで待機が発生する問題を修正しました。テーブルが detach された場合や再起動された場合でも、クエリがハングしなくなりました。 [#22118](https://github.com/ClickHouse/ClickHouse/pull/22118) ([alesapin](https://github.com/alesapin)).
* バグのある Linux カーネル向けに `async_socket_for_remote` / `use_hedged_requests` を無効化しました。 [#22109](https://github.com/ClickHouse/ClickHouse/pull/22109) ([Azat Khuzhin](https://github.com/azat)).
* Docker entrypoint: `LOG_PATH` が空の場合に `.` に対する chown を避けるようにした。 [#22100](https://github.com/ClickHouse/ClickHouse/issues/22100) をクローズ。 [#22102](https://github.com/ClickHouse/ClickHouse/pull/22102) ([filimonov](https://github.com/filimonov)).
* 関数 `decrypt` には、`AEAD` モードで暗号化されたデータの最小サイズを検証する処理が欠けていました。これにより [#21897](https://github.com/ClickHouse/ClickHouse/issues/21897) がクローズされました。[#22064](https://github.com/ClickHouse/ClickHouse/pull/22064)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* まれなケースとして、`CollapsingMergeTree` のマージ処理により、`index_granularity + 1` 行を持つグラニュールが作成される場合があります。このため、[#18928](https://github.com/ClickHouse/ClickHouse/issues/18928) で追加された内部チェック（21.2 および 21.3 に影響）が、`Incomplete granules are not allowed while blocks are granules size` というエラーで失敗することがあります。このエラーにより、パーツをマージできませんでした。[#21976](https://github.com/ClickHouse/ClickHouse/pull/21976)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* ハッシュ型の外部ディクショナリを読み込む際にメモリ使用量が大幅に増加する可能性があった [#15454](https://github.com/ClickHouse/ClickHouse/issues/15454) をリバートしました。これにより [#21935](https://github.com/ClickHouse/ClickHouse/issues/21935) がクローズされます。 [#21948](https://github.com/ClickHouse/ClickHouse/pull/21948) ([Maksim Kita](https://github.com/kitaisreal)).
* ヘッジド接続の重複を防止（`Unknown packet 9 from server` エラー）。[#21941](https://github.com/ClickHouse/ClickHouse/pull/21941)（[Azat Khuzhin](https://github.com/azat)）。
* 一部のケースで、コンテンツタイプが「multipart/form-data」の HTTP POST リクエストの読み取り処理を修正しました。 [#21936](https://github.com/ClickHouse/ClickHouse/pull/21936) ([Ivan](https://github.com/abyss7))。
* ウィンドウ関数を含むクエリに対して主キー順読み出しの最適化が適用された場合に、誤った `ORDER BY` 結果が返される問題を修正。 [#21828](https://github.com/ClickHouse/ClickHouse/issues/21828) を修正。 [#21915](https://github.com/ClickHouse/ClickHouse/pull/21915)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* 最初の CatBoost モデル実行時に発生するデッドロックを修正。[#13832](https://github.com/ClickHouse/ClickHouse/issues/13832) をクローズ。[#21844](https://github.com/ClickHouse/ClickHouse/pull/21844)（[Kruglov Pavel](https://github.com/Avogar)）。
* `WHERE` または `HAVING` 条件が `GROUP BY` の前にプッシュされる場合に発生し得た誤ったクエリ結果（およびクラッシュの可能性）を修正しました。 [#21773](https://github.com/ClickHouse/ClickHouse/issues/21773) を修正。 [#21841](https://github.com/ClickHouse/ClickHouse/pull/21841)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `WriteBufferFromS3` のエラー処理とロギングを改善。 [#21836](https://github.com/ClickHouse/ClickHouse/pull/21836) ([Pavel Kovalenko](https://github.com/Jokser)).
* 二段階集約を使用している際に、`Distinct` コンビネータ付きの集約関数で発生しうるクラッシュを修正しました。これは [#18365](https://github.com/ClickHouse/ClickHouse/pull/18365) のフォローアップ修正です。実運用環境でのみ再現可能です。 [#21818](https://github.com/ClickHouse/ClickHouse/pull/21818) ([Amos Bird](https://github.com/amosbird))。
* スカラー副問い合わせのインデックス解析を修正しました。これにより、[#18896](https://github.com/ClickHouse/ClickHouse/pull/18896) で導入された問題 [#21717](https://github.com/ClickHouse/ClickHouse/issues/21717) が修正されました。[#21766](https://github.com/ClickHouse/ClickHouse/pull/21766)（[Amos Bird](https://github.com/amosbird)）。
* `Decimal` 列のサイズ（32 ビットまたは 64 ビット）が変わらない場合に、その型が変更されない `ALTER MODIFY COLUMN` クエリが `ReplicatedMerge` テーブルエンジンで発生するバグを修正しました。 [#21728](https://github.com/ClickHouse/ClickHouse/pull/21728) ([alesapin](https://github.com/alesapin)).
* `ReplicatedMergeTree` に対して `OPTIMIZE` と `DROP` が同時に実行された場合に、無限に待機し続ける可能性がある問題を修正。 [#21716](https://github.com/ClickHouse/ClickHouse/pull/21716) ([Azat Khuzhin](https://github.com/azat)).
* 定数の整数引数に対して、型 `Map` に対する関数 `arrayElement` の動作を修正しました。 [#21699](https://github.com/ClickHouse/ClickHouse/pull/21699) ([Anton Popov](https://github.com/CurtizJ)).
* `access_to_key_from_attributes` を使用する `ip_trie` で、存在しない属性を参照した際に発生する SIGSEGV を修正。 [#21692](https://github.com/ClickHouse/ClickHouse/pull/21692) ([Azat Khuzhin](https://github.com/azat)).
* サーバーは、`DDLWorker` と辞書の初期化が完了した後にのみ接続を受け付けるようになりました。 [#21676](https://github.com/ClickHouse/ClickHouse/pull/21676) ([Azat Khuzhin](https://github.com/azat)).
* `Join` 型テーブルのキーに対する型変換を追加しました（以前は SIGSEGV が発生していました）。 [#21646](https://github.com/ClickHouse/ClickHouse/pull/21646) ([Azat Khuzhin](https://github.com/azat)).
* `async_socket_for_remote=1` 使用時の分散リクエストのキャンセル処理を修正（例えば、複数シャードへの limit 付き単純な select、すなわち `select * from remote('127.{2,3}', system.numbers) limit 100`）。[#21643](https://github.com/ClickHouse/ClickHouse/pull/21643)（[Azat Khuzhin](https://github.com/azat)）。
* 水平マージに対して `fsync_part_directory` を修正しました。 [#21642](https://github.com/ClickHouse/ClickHouse/pull/21642) ([Azat Khuzhin](https://github.com/azat)).
* 外部データベースエンジン（MySQL、PostgreSQL）へのクエリにおいて、`WHERE` 句から結合先テーブルの未知の列を削除するようにしました。close [#14614](https://github.com/ClickHouse/ClickHouse/issues/14614)、close [#19288](https://github.com/ClickHouse/ClickHouse/issues/19288)（重複）、close [#19645](https://github.com/ClickHouse/ClickHouse/issues/19645)（重複）。[#21640](https://github.com/ClickHouse/ClickHouse/pull/21640)（[Vladimir](https://github.com/vdimir)）。
* `std::terminate` は、s3 へのデータ書き込み時にエラーが発生した場合に呼び出されていました。 [#21624](https://github.com/ClickHouse/ClickHouse/pull/21624) ([Vladimir](https://github.com/vdimir)).
* `optimize_skip_unused_shards` が有効で、シャードが 0 個の場合に発生しうる `Cannot find column` エラーを修正しました。 [#21579](https://github.com/ClickHouse/ClickHouse/pull/21579) ([Azat Khuzhin](https://github.com/azat)).
* クエリに定数の `WHERE` 条件があり、かつ設定 `optimize_skip_unused_shards` が有効になっている場合、すべてのシャードがスキップされ、クエリが誤って空の結果を返してしまう可能性がありました。 [#21550](https://github.com/ClickHouse/ClickHouse/pull/21550) ([Amos Bird](https://github.com/amosbird)).
* テーブル関数 `clusterAllReplicas` が誤った `_shard_num` を返す問題を修正。[#21481](https://github.com/ClickHouse/ClickHouse/issues/21481) をクローズ。[#21498](https://github.com/ClickHouse/ClickHouse/pull/21498)（[flynn](https://github.com/ucasFL)）。
* 設定を更新した後も S3 テーブルが古いクレデンシャルを保持してしまう問題を修正。 [#21457](https://github.com/ClickHouse/ClickHouse/pull/21457) ([Grigory Pervakov](https://github.com/GrigoryPervakov)).
* Poco の `SecureSocket` 内の SSL オブジェクトで発生していたレースコンディションを修正。 [#21456](https://github.com/ClickHouse/ClickHouse/pull/21456) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* `Kafka` 向けの `Avro` フォーマットのパースを修正。[#21437](https://github.com/ClickHouse/ClickHouse/issues/21437) を解決。[#21438](https://github.com/ClickHouse/ClickHouse/pull/21438)（[Ilya Golshtein](https://github.com/ilejn)）。
* セキュアソケットにおける受信および送信のタイムアウト処理とノンブロッキング読み取りを修正。 [#21429](https://github.com/ClickHouse/ClickHouse/pull/21429) ([Kruglov Pavel](https://github.com/Avogar)).
* `force_drop_table` フラグが `MATERIALIZED VIEW` に対して動作していませんでしたが、修正されました。 [#18943](https://github.com/ClickHouse/ClickHouse/issues/18943) を修正。 [#20626](https://github.com/ClickHouse/ClickHouse/pull/20626)（[tavplubix](https://github.com/tavplubix)）。
* `PredicateRewriteVisitor` における名前の衝突を修正しました。これにより、フル結合後の `WHERE` 句によるフィルタリングが誤って行われていました。[#20497](https://github.com/ClickHouse/ClickHouse/issues/20497) をクローズしました。[#20622](https://github.com/ClickHouse/ClickHouse/pull/20622)（[Vladimir](https://github.com/vdimir)）。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-7}


* ClickHouse Keeper 用の [Jepsen](https://github.com/jepsen-io/jepsen) テストを追加。 [#21677](https://github.com/ClickHouse/ClickHouse/pull/21677) ([alesapin](https://github.com/alesapin))。
* CI でステートレステストを並列実行する。[#22181](https://github.com/ClickHouse/ClickHouse/issues/22181) に依存。[#22300](https://github.com/ClickHouse/ClickHouse/pull/22300)（[alesapin](https://github.com/alesapin)）。
* [SQLancer](https://github.com/sqlancer/sqlancer) の CI 実行に対するステータスチェックを有効化しました。 [#22015](https://github.com/ClickHouse/ClickHouse/pull/22015) ([Ilya Yatsishin](https://github.com/qoega))。
* PowerPC ビルド向けの複数の準備: `ppc64le` で同梱の openldap を有効化。 [#22487](https://github.com/ClickHouse/ClickHouse/pull/22487) ([Kfir Itzhak](https://github.com/mastertheknife)).  `ppc64le` 上で Clang によるコンパイルを有効化。 [#22476](https://github.com/ClickHouse/ClickHouse/pull/22476) ([Kfir Itzhak](https://github.com/mastertheknife)). `ppc64le` 上での boost のコンパイルを修正。 [#22474](https://github.com/ClickHouse/ClickHouse/pull/22474) ([Kfir Itzhak](https://github.com/mastertheknife)). `ppc64le` 上で内部 CMake 変数 `CMAKE_ASM_COMPILE_OBJECT` が設定されていないという CMake エラーを修正。 [#22469](https://github.com/ClickHouse/ClickHouse/pull/22469) ([Kfir Itzhak](https://github.com/mastertheknife)). Fedora/RHEL/CentOS が `ppc64le` 上で `libclang_rt.builtins` を検出できない問題を修正。 [#22458](https://github.com/ClickHouse/ClickHouse/pull/22458) ([Kfir Itzhak](https://github.com/mastertheknife)).  `ppc64le` での `jemalloc` を用いたビルドを有効化。 [#22447](https://github.com/ClickHouse/ClickHouse/pull/22447) ([Kfir Itzhak](https://github.com/mastertheknife)). `ppc64le` 上での ClickHouse の設定埋め込みおよび cctz のタイムゾーン埋め込みを修正。 [#22445](https://github.com/ClickHouse/ClickHouse/pull/22445) ([Kfir Itzhak](https://github.com/mastertheknife)). `ppc64le` 上でのコンパイルを修正し、`ppc64le` で正しい命令ポインタレジスタを使用するように変更。 [#22430](https://github.com/ClickHouse/ClickHouse/pull/22430) ([Kfir Itzhak](https://github.com/mastertheknife)).
* `aarch64` 上で S3 (AWS) ライブラリを再度有効化しました。 [#22484](https://github.com/ClickHouse/ClickHouse/pull/22484) ([Kfir Itzhak](https://github.com/mastertheknife)).
* `ORC` フォーマットを読み込むには `tzdata` が必要なため、Docker コンテナに `tzdata` を追加しました。これにより [#14156](https://github.com/ClickHouse/ClickHouse/issues/14156) がクローズされました。 [#22000](https://github.com/ClickHouse/ClickHouse/pull/22000) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `clickhouse-server` イメージの Dockerfile に `deb_location` と `single_binary_location` の 2 つの引数を追加。[#21977](https://github.com/ClickHouse/ClickHouse/pull/21977)（[filimonov](https://github.com/filimonov)）。
* clang-tidy 使用時にアサーションを有効化することで、リリースビルドでも clang-tidy を使用できるようにしました。 [#21914](https://github.com/ClickHouse/ClickHouse/pull/21914) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* cmake スクリプトで検索対象とする `llvm-12` バイナリ名を追加。clang の警告を抑制するための暗黙的な定数変換を追加。CMake 3.19 でビルドできるようにサブモジュールを更新。`readpassphrase` ライブラリでのマクロ展開における再帰を抑制。clang の非推奨オプション `-fuse-ld` を `--ld-path` に変更。 [#21597](https://github.com/ClickHouse/ClickHouse/pull/21597) ([Ilya Yatsishin](https://github.com/qoega)).
* Docker Hub が非常に厳しいレート制限を有効にしたため、`docker/test/testflows/runner/dockerd-entrypoint.sh` を Yandex dockerhub-proxy を使うように更新 [#21551](https://github.com/ClickHouse/ClickHouse/pull/21551)（[vzakaznikov](https://github.com/vzakaznikov)）。
* macOS の共有ライブラリビルドを修正。 [#20184](https://github.com/ClickHouse/ClickHouse/pull/20184) ([nvartolomei](https://github.com/nvartolomei)).
* `zookeeper-dump-tree` に `ctime` オプションを追加しました。ノードの作成時刻をダンプできるようになりました。[#21842](https://github.com/ClickHouse/ClickHouse/pull/21842) ([Ilya](https://github.com/HumanUser))。





## ClickHouse リリース 21.3 (LTS) {#clickhouse-release-213-lts}

### ClickHouse リリース v21.3, 2021-03-12 {#clickhouse-release-v213-2021-03-12}

#### 後方互換性のない変更 {#backward-incompatible-change-8}

- 旧構文でテーブルTTLを指定したMergeTreeテーブルの作成は、単に無視されるため許可されなくなりました。既存テーブルのアタッチは引き続き可能です。[#20282](https://github.com/ClickHouse/ClickHouse/pull/20282) ([alesapin](https://github.com/alesapin))。
- すべての大文字小文字を区別しない関数名が正規の表現に書き換えられるようになりました。これは、プロジェクションクエリルーティング(今後追加される機能)に必要です。[#20174](https://github.com/ClickHouse/ClickHouse/pull/20174) ([Amos Bird](https://github.com/amosbird))。
- `TTL`の式が関数であり、`ORDER BY`キーと同じである場合の`TTL`作成を修正しました。`GROUP BY`を使用した`TTL`でプライマリキー列にカスタム集約を設定できるようになりました。後方互換性のない変更: `GROUP BY`に含まれず、明示的に設定されていないプライマリキー列に対して、TTLが期限切れになった際に`max`の代わりに`any`関数が適用されるようになりました。また、`WHERE`または`GROUP BY`を使用したTTLを使用している場合、ローリングアップデート中のマージ時に例外が発生する可能性があります。[#15450](https://github.com/ClickHouse/ClickHouse/pull/15450) ([Anton Popov](https://github.com/CurtizJ))。

#### 新機能 {#new-feature-8}


- ファイルエンジン設定を追加: `engine_file_empty_if_not_exists` および `engine_file_truncate_on_insert`。[#20620](https://github.com/ClickHouse/ClickHouse/pull/20620) ([M0r64n](https://github.com/M0r64n))。
- 連続する行間の差分を合計する集約関数 `deltaSum` を追加。[#20057](https://github.com/ClickHouse/ClickHouse/pull/20057) ([Russ Frank](https://github.com/rf))。
- `system.part_log` テーブルに新しいカラム `event_time_microseconds` を追加。[#20027](https://github.com/ClickHouse/ClickHouse/pull/20027) ([Bharat Nallan](https://github.com/bharatnc))。
- UTC からのオフセットを秒単位で返す関数 `timezoneOffset(datetime)` を追加。これにより [#issue:19850](https://github.com/ClickHouse/ClickHouse/issues/19850) が解決されます。[#19962](https://github.com/ClickHouse/ClickHouse/pull/19962) ([keenwolf](https://github.com/keen-wolf))。
- 分散テーブルから特定のシャードへのデータ挿入をサポートする設定 `insert_shard_id` を追加。[#19961](https://github.com/ClickHouse/ClickHouse/pull/19961) ([flynn](https://github.com/ucasFL))。
- 関数 `reinterpretAs` を更新し、大きな整数をサポート。[#19691](https://github.com/ClickHouse/ClickHouse/issues/19691) を修正。[#19858](https://github.com/ClickHouse/ClickHouse/pull/19858) ([Maksim Kita](https://github.com/kitaisreal))。
- S3 クライアントにサーバーサイド暗号化カスタマーキー(`x-amz-server-side-encryption-customer-(key/md5)` ヘッダー)のサポートを追加。[リンク](https://docs.aws.amazon.com/AmazonS3/latest/dev/ServerSideEncryptionCustomerKeys.html)を参照してください。[#19428](https://github.com/ClickHouse/ClickHouse/issues/19428) を解決。[#19748](https://github.com/ClickHouse/ClickHouse/pull/19748) ([Vladimir Chebotarev](https://github.com/excitoon))。
- `executable` ディクショナリソースに `implicit_key` オプションを追加。レコードが入力キーと同じ順序で提供される場合、各レコードのキーの出力を省略できます。[#14527](https://github.com/ClickHouse/ClickHouse/issues/14527) を実装。[#19677](https://github.com/ClickHouse/ClickHouse/pull/19677) ([Maksim Kita](https://github.com/kitaisreal))。
- クォータタイプ `query_selects` および `query_inserts` を追加。[#19603](https://github.com/ClickHouse/ClickHouse/pull/19603) ([JackyWoo](https://github.com/JackyWoo))。
- 関数 `extractTextFromHTML` を追加 [#19600](https://github.com/ClickHouse/ClickHouse/pull/19600) ([zlx19950903](https://github.com/zlx19950903))、([alexey-milovidov](https://github.com/alexey-milovidov))。
- `MergeTree*` エンジンを使用するテーブルに、クエリの同時実行制御のための2つの新しいテーブルレベル設定を追加。設定 `max_concurrent_queries` は、このテーブルに関連する同時実行クエリの数を制限します。設定 `min_marks_to_honor_max_concurrent_queries` は、クエリが少なくともこの数のマークを読み取る場合にのみ前述の設定を適用するよう指示します。[#19544](https://github.com/ClickHouse/ClickHouse/pull/19544) ([Amos Bird](https://github.com/amosbird))。
- user_files ディレクトリからファイルを文字列として読み取る関数 `file` を追加。これは `file` テーブル関数とは異なります。[#issue:18851](https://github.com/ClickHouse/ClickHouse/issues/18851) を実装。[#19204](https://github.com/ClickHouse/ClickHouse/pull/19204) ([keenwolf](https://github.com/keen-wolf))。

#### 実験的機能 {#experimental-feature-7}


- 実験的な `Replicated` データベースエンジンを追加しました。複数のホスト間でDDLクエリをレプリケートします。[#16193](https://github.com/ClickHouse/ClickHouse/pull/16193) ([tavplubix](https://github.com/tavplubix))。
- ウィンドウ関数の実験的サポートを導入しました。`allow_experimental_window_functions = 1` で有効化されます。これは予備的なアルファ品質の実装であり、本番環境での使用には適していません。また、将来のリリースで後方互換性のない変更が行われる予定です。サポートされている機能のリストについては、[ドキュメント](https://github.com/ClickHouse/ClickHouse/blob/master/docs/sql-reference/window-functions/index.md#experimental-window-functions)を参照してください。[#20337](https://github.com/ClickHouse/ClickHouse/pull/20337) ([Alexander Kuzmenkov](https://github.com/akuzm))。
- DiskS3のメタデータファイルをバックアップ/リストアする機能を追加しました。[#18377](https://github.com/ClickHouse/ClickHouse/pull/18377) ([Pavel Kovalenko](https://github.com/Jokser))。

#### パフォーマンス改善 {#performance-improvement-8}


* リモートクエリに対するヘッジ付きリクエスト。`use_hedged_requests` を有効化（デフォルトはオフ）すると、クエリに対して複数のレプリカへの接続を確立できるようになります。既存のレプリカへの接続が `hedged_connection_timeout` 以内に確立されなかった場合、または `receive_data_timeout` 以内にデータが受信されなかった場合に、新しい接続が開始されます。クエリは、空でない progress パケット（または `allow_changing_replica_until_first_data_packet` が有効な場合は data パケット）を最初に送信した接続を使用し、その他の接続はキャンセルされます。`max_parallel_replicas > 1` のクエリにも対応します。 [#19291](https://github.com/ClickHouse/ClickHouse/pull/19291)（[Kruglov Pavel](https://github.com/Avogar)）。これにより、非常に大規模なクラスターにおけるテイルレイテンシを大幅に削減できます。
* 行レベルセキュリティ式が指定されているテーブルでも `PREWHERE` がサポートされるようになり（対応する最適化も有効になり）ました。 [#19576](https://github.com/ClickHouse/ClickHouse/pull/19576) ([Denis Glazachev](https://github.com/traceon)).
* 設定 `distributed_aggregation_memory_efficient` はデフォルトで有効です。これにより分散クエリのメモリ使用量が削減され、パフォーマンスが向上します。 [#20599](https://github.com/ClickHouse/ClickHouse/pull/20599) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 固定長の複数キーに対する GROUP BY のパフォーマンスを改善。 [#20472](https://github.com/ClickHouse/ClickHouse/pull/20472) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* より厳密な別名指定により集約関数のパフォーマンスを向上。 [#19946](https://github.com/ClickHouse/ClickHouse/pull/19946) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 極端なケース（読み取り速度が 50 GB/秒 程度である場合）において、パイプラインの簡素化と、それに伴うパイプラインスケジューリングでのロック競合の削減により、`Memory` テーブルからの読み取りを高速化しました。 [#20468](https://github.com/ClickHouse/ClickHouse/pull/20468) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* HTTP サーバーを一部再実装し、受信および送信データのコピー回数を削減しました。これにより、HTTP 経由で長いレコードを挿入する際のパフォーマンスが最大 1.5 倍向上します。 [#19516](https://github.com/ClickHouse/ClickHouse/pull/19516) ([Ivan](https://github.com/abyss7)).
* `Memory` テーブル向けに `compress` 設定を追加しました。これを有効にすると、テーブルの RAM 使用量を抑えられます。マシン構成やデータセットによっては、SELECT がより高速になる場合もありますが、必ずしもそうとは限りません。これにより [#20093](https://github.com/ClickHouse/ClickHouse/issues/20093) がクローズされます。注意: Memory テーブルが MergeTree よりも遅くなる可能性がある理由としては、(1) 圧縮がないこと (2) ブロックサイズが固定であること (3) インデックスと PREWHERE がないこと... などが挙げられます。[#20168](https://github.com/ClickHouse/ClickHouse/pull/20168)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 集計処理におけるコードをわずかに改善しました。 [#20978](https://github.com/ClickHouse/ClickHouse/pull/20978) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* パフォーマンス向上のため、`intDiv` / `modulo` の特殊化を再度追加しました。これにより [#21293](https://github.com/ClickHouse/ClickHouse/issues/21293) が修正されます。このリグレッションは [https://github.com/ClickHouse/ClickHouse/pull/18145](https://github.com/ClickHouse/ClickHouse/pull/18145) にて導入されました。 [#21307](https://github.com/ClickHouse/ClickHouse/pull/21307)（[Amos Bird](https://github.com/amosbird)）。
* Memory テーブルに対して INSERT SELECT で挿入する場合、ブロックを過度にまとめすぎないようにしました。以前のバージョンでは、INSERT SELECT の後に Memory テーブル内で非効率なデータ表現が作成されていました。これにより [#13052](https://github.com/ClickHouse/ClickHouse/issues/13052) が解決されました。[#20169](https://github.com/ClickHouse/ClickHouse/pull/20169)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* DataType パーサーで、計算量が指数関数的になる可能性があったケースを少なくとも 1 件修正しました（fuzzer により検出）。これにより [#20096](https://github.com/ClickHouse/ClickHouse/issues/20096) がクローズされました。 [#20132](https://github.com/ClickHouse/ClickHouse/pull/20132)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `do_not_merge_across_partitions_select_final` 設定が 1 の場合に、レベル &gt; 0 の単一パートに対する FINAL 付き SELECT の並列実行を可能にしました。 [#19375](https://github.com/ClickHouse/ClickHouse/pull/19375) ([Kruglov Pavel](https://github.com/Avogar)).
* `system.parts` および `system.parts_columns` をクエリする際に、要求されたカラムのみを読み込むようにしました。[#19570](https://github.com/ClickHouse/ClickHouse/issues/19570) をクローズ。[#21035](https://github.com/ClickHouse/ClickHouse/pull/21035)（[Anmol Arora](https://github.com/anmolarora)）。
* `avg` 集約関数内の算術式に対して代数的最適化を行うようにしました。[#20092](https://github.com/ClickHouse/ClickHouse/issues/20092) をクローズ。[#20183](https://github.com/ClickHouse/ClickHouse/pull/20183)（[flynn](https://github.com/ucasFL)）。

#### 改善 {#improvement-8}


* テーブル関数で使用する圧縮方式を大文字小文字を区別しないようにしました。また、大文字のみがチェックされていた LZMA 圧縮方式を修正しました。 [#21416](https://github.com/ClickHouse/ClickHouse/pull/21416) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 非アクティブなパーツが多すぎる場合に、挿入処理を遅延させたりエラーをスローしたりするための 2 つの設定を追加しました。これは、サーバーがパーツのクリーンアップを十分な速度で実行できない場合に有用です。 [#20178](https://github.com/ClickHouse/ClickHouse/pull/20178) ([Amos Bird](https://github.com/amosbird)).
* mysql クライアントとの互換性を向上: 1. mysql jdbc 2. mycli。[#21367](https://github.com/ClickHouse/ClickHouse/pull/21367)（[Amos Bird](https://github.com/amosbird)）。
* マテリアライズドビューで参照されているカラムを削除できないように変更。[#21164](https://github.com/ClickHouse/ClickHouse/issues/21164) をクローズ。[#21303](https://github.com/ClickHouse/ClickHouse/pull/21303)（[flynn](https://github.com/ucasFL)）。
* MySQL 辞書ソースは、SSL/TLS 接続でときどき発生する予期しない接続障害（`Lost connection to MySQL server during query`）に対して再試行を行うようになりました。 [#21237](https://github.com/ClickHouse/ClickHouse/pull/21237) ([Alexander Kazakov](https://github.com/Akazz)).
* ユーザビリティの改善: `DateTime64` のパースをより一貫性のあるものにしました。サブ秒精度を持つ Unix タイムスタンプが、スケーリングされた整数（`1111111111.222` ではなく `1111111111222` のような形式）として指定されているケースを認識するようにしました。これにより [#13194](https://github.com/ClickHouse/ClickHouse/issues/13194) がクローズされました。 [#21053](https://github.com/ClickHouse/ClickHouse/pull/21053)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* distributed&#95;group&#95;by&#95;no&#95;merge 使用時に、ソート済みブロックのマージをイニシエーター側でのみ行うようにしました。 [#20882](https://github.com/ClickHouse/ClickHouse/pull/20882) ([Azat Khuzhin](https://github.com/azat)).
* MySQL ソース用の設定を読み込む際、ClickHouse は同じ優先度を持つレプリカのリストをランダム化し、MySQL エンドポイント選択におけるラウンドロビンロジックが正しく機能するようになりました。これにより [#20629](https://github.com/ClickHouse/ClickHouse/issues/20629) がクローズされました。 [#20632](https://github.com/ClickHouse/ClickHouse/pull/20632) ([Alexander Kazakov](https://github.com/Akazz))。
* 関数 &#39;reinterpretAs(x, Type)&#39; は &#39;reinterpret(x, Type)&#39; に名称変更されました。 [#20611](https://github.com/ClickHouse/ClickHouse/pull/20611) ([Maksim Kita](https://github.com/kitaisreal))。
* RabbitMQ エンジンで vhost をサポートしました [#20576](https://github.com/ClickHouse/ClickHouse/issues/20576)。 [#20596](https://github.com/ClickHouse/ClickHouse/pull/20596)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 配列とタプルを組み合わせたデータ型のシリアル化を改善しました。enum データ型と protobuf の enum 型との対応付けを改善しました。`Map` データ型のシリアル化を修正しました。省略された値は、デフォルト値が自動的に設定されるようになりました。 [#20506](https://github.com/ClickHouse/ClickHouse/pull/20506) ([Vitaly Baranov](https://github.com/vitlibar)).
* 分散DDLタスクの実行とDDLキューのクリーンアップとの間に存在していたレースコンディションを修正しました。これにより、アクティブなワーカーが存在する場合にはDDLタスクがZooKeeperから削除されなくなりました。[#20016](https://github.com/ClickHouse/ClickHouse/issues/20016) を修正。[#20448](https://github.com/ClickHouse/ClickHouse/pull/20448)（[tavplubix](https://github.com/tavplubix)）。
* alpine イメージで FQDN およびその他の DNS 関連関数が正しく動作するようにしました。 [#20336](https://github.com/ClickHouse/ClickHouse/pull/20336) ([filimonov](https://github.com/filimonov))。
* 明示的に禁止されている関数については、早期の定数畳み込みを行わないようにしました。 [#20303](https://github.com/ClickHouse/ClickHouse/pull/20303) ([Azat Khuzhin](https://github.com/azat)).
* 整数からDecimal型への暗黙的な変換は、整数値がDecimal型に収まらなくても成功してしまうことがありましたが、現在は `ARGUMENT_OUT_OF_BOUND` をスローするようになりました。 [#20232](https://github.com/ClickHouse/ClickHouse/pull/20232) ([tavplubix](https://github.com/tavplubix)).
* ロックを使用しない `SYSTEM FLUSH DISTRIBUTED`。 [#20215](https://github.com/ClickHouse/ClickHouse/pull/20215) ([Azat Khuzhin](https://github.com/azat)).
* `count(constant)`、`sum(1)` を `count()` に正規化しました。これはプロジェクションにおけるクエリルーティングに必要です。 [#20175](https://github.com/ClickHouse/ClickHouse/pull/20175) ([Amos Bird](https://github.com/amosbird)).
* ビットマップ関数で、すべてのネイティブ整数型をサポートしました。 [#20171](https://github.com/ClickHouse/ClickHouse/pull/20171) ([Amos Bird](https://github.com/amosbird)).
* `CacheDictionary`、`ComplexCacheDictionary`、`SSDCacheDictionary`、`SSDComplexKeyDictionary` を、基盤となるインデックスとして LRUHashMap を使用するように更新しました。 [#20164](https://github.com/ClickHouse/ClickHouse/pull/20164)（[Maksim Kita](https://github.com/kitaisreal)）。
* `access_management` 設定は、起動時に `CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT` を指定することで構成できるようになりました。デフォルトは無効（`0`）で、これは以前の値と同じです。 [#20139](https://github.com/ClickHouse/ClickHouse/pull/20139) ([Marquitos](https://github.com/sonirico)).
* DateTime64 用の `toDateTime64(toDate()/toDateTime())` を修正 — DateTime の動作に合わせるための DateTime64 のクランプ処理を実装。 [#20131](https://github.com/ClickHouse/ClickHouse/pull/20131) ([Azat Khuzhin](https://github.com/azat)).
* クォータに関する改善: `SHOW TABLES` はクォータ計算において、2 つのクエリではなく 1 つのクエリとして扱われるようになりました。`SYSTEM` クエリもクォータを消費するようになりました。クォータ消費におけるインターバルの終了時刻の計算を修正しました。 [#20106](https://github.com/ClickHouse/ClickHouse/pull/20106) ([Vitaly Baranov](https://github.com/vitlibar)).
* `system.zookeeper` テーブルで `path IN (set)` 式をサポートしました。 [#20105](https://github.com/ClickHouse/ClickHouse/pull/20105) ([小路](https://github.com/nicelulu)).
* `system.tables` 内で `MaterializeMySQL` テーブルの全詳細を表示できるようにしました。 [#20051](https://github.com/ClickHouse/ClickHouse/pull/20051) ([Stig Bakken](https://github.com/stigsb)).
* 実行可能ディクショナリにおけるデータレースを修正しました。これは、スクリプトが入力を無視してデータを返すという誤った使用時にのみ発生し得る問題でした。 [#20045](https://github.com/ClickHouse/ClickHouse/pull/20045) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* MYSQL&#95;OPT&#95;RECONNECT オプションの値は、mysql レプリカの config セクションにある &quot;opt&#95;reconnect&quot; パラメータで制御できるようになりました。 [#19998](https://github.com/ClickHouse/ClickHouse/pull/19998) ([Alexander Kazakov](https://github.com/Akazz))。
* ユーザーが `JSONExtract` 関数を `Float32` 型を指定して呼び出した場合、結果型への不正確な変換を許可します。たとえば、JSON 内の数値 `0.1` は倍精度であり、Float32 では正確に表現できませんが、それでもユーザーはその値を取得したいと考えます。以前のバージョンでは、変換が不正確であることを示すために、非 Nullable 型では 0、Nullable 型では NULL を返していました。このロジックは 100% 正しかったものの、ユーザーにとっては意外であり、問い合わせの原因になっていました。この変更により [#13962](https://github.com/ClickHouse/ClickHouse/issues/13962) が解決されました。 [#19960](https://github.com/ClickHouse/ClickHouse/pull/19960)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `Distributed` テーブルへの `INSERT` でブロック構造が一致しない場合に、その構造を変換する処理を追加しました。 [#19947](https://github.com/ClickHouse/ClickHouse/pull/19947) ([Azat Khuzhin](https://github.com/azat)).
* `system.distributed_ddl_queue` テーブルの改善。再起動後に MaxDDLEntryID を最後の値に初期化します。この PR 以前は、新しい DDLTask が処理されるまで MaxDDLEntryID は 0 のままでした。[#19924](https://github.com/ClickHouse/ClickHouse/pull/19924)（[Amos Bird](https://github.com/amosbird)）。
* `system.parts` に `MaterializeMySQL` テーブルを表示するようにしました。 [#19770](https://github.com/ClickHouse/ClickHouse/pull/19770) ([Stig Bakken](https://github.com/stigsb))。
* `Buffer` プロファイル用に個別の設定ディレクティブを追加。 [#19721](https://github.com/ClickHouse/ClickHouse/pull/19721) ([Azat Khuzhin](https://github.com/azat))。
* `JOIN` に関係しない条件を `WHERE` 句に移動します。 [#18720](https://github.com/ClickHouse/ClickHouse/issues/18720)。 [#19685](https://github.com/ClickHouse/ClickHouse/pull/19685) ([hexiaoting](https://github.com/hexiaoting))。
* 非同期送信の保留バイト数に基づいて `Distributed` への INSERT をスロットルできる機能を追加しました（`Distributed` エンジンに `bytes_to_delay_insert` / `max_delay_to_insert` および `bytes_to_throw_insert` 設定を追加しました）。 [#19673](https://github.com/ClickHouse/ClickHouse/pull/19673) ([Azat Khuzhin](https://github.com/azat)).
* デストラクタ内で書き込みエラーが無視されてしまうまれなケースをいくつか修正しました。 [#19451](https://github.com/ClickHouse/ClickHouse/pull/19451) ([Azat Khuzhin](https://github.com/azat)).
* 致命的なエラー発生時のスタックトレースにインラインフレームを表示します。 [#19317](https://github.com/ClickHouse/ClickHouse/pull/19317) ([Ivan](https://github.com/abyss7)).

#### バグ修正 {#bug-fix-7}


* 冗長な ZooKeeper への再接続と、単一の clickhouse サーバーに対して 2 つのアクティブセッションが同時に存在し得る問題を修正。どちらの問題も #14678 で導入されたもの。 [#21264](https://github.com/ClickHouse/ClickHouse/pull/21264) ([alesapin](https://github.com/alesapin))。
* `Values` フォーマットから `LowCardinality` カラムを持つテーブルへの挿入時に発生するエラー `Bad cast from type ... to DB::ColumnLowCardinality` を修正。#21140 を修正 [#21357](https://github.com/ClickHouse/ClickHouse/pull/21357)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 述語にテーブル自身が含まれている場合に、レプリケートされていない MergeTree テーブルエンジンに対する `ALTER DELETE` ミューテーションで発生するデッドロックを修正しました。[#20558](https://github.com/ClickHouse/ClickHouse/issues/20558) を修正。[#21477](https://github.com/ClickHouse/ClickHouse/pull/21477)（[alesapin](https://github.com/alesapin)）。
* 障害発生時に分散クエリで起きる SIGSEGV を修正。 [#21434](https://github.com/ClickHouse/ClickHouse/pull/21434) ([Azat Khuzhin](https://github.com/azat)).
* これにより、`ALTER MODIFY COLUMN` クエリはパーティションキー、スキップインデックス、TTL などの変更に対して正しく動作するようになりました。[#13675](https://github.com/ClickHouse/ClickHouse/issues/13675) を修正。[#21334](https://github.com/ClickHouse/ClickHouse/pull/21334)（[alesapin](https://github.com/alesapin)）。
* `join_use_nulls` とサブクエリからの `TOTALS` の結合に関するバグを修正しました。これにより [#19362](https://github.com/ClickHouse/ClickHouse/issues/19362) と [#21137](https://github.com/ClickHouse/ClickHouse/issues/21137) がクローズされました。 [#21248](https://github.com/ClickHouse/ClickHouse/pull/21248) ([vdimir](https://github.com/vdimir))。
* `UNION` を含むクエリに対する `EXPLAIN` で発生するクラッシュを修正。[#20876](https://github.com/ClickHouse/ClickHouse/issues/20876)、[#21170](https://github.com/ClickHouse/ClickHouse/issues/21170) を解決。[#21246](https://github.com/ClickHouse/ClickHouse/pull/21246)（[flynn](https://github.com/ucasFL)）。
* 現在、ミューテーションはそれをサポートするテーブルエンジン（MergeTree ファミリー、Memory、MaterializedView）でのみ許可されます。その他のエンジンでは、よりわかりやすいエラーが返されるようになりました。 [#21168](https://github.com/ClickHouse/ClickHouse/issues/21168) を修正。 [#21183](https://github.com/ClickHouse/ClickHouse/pull/21183)（[alesapin](https://github.com/alesapin)）。
* [#21112](https://github.com/ClickHouse/ClickHouse/issues/21112) を修正。`INSERT` クエリで、（一部のコールバックがわずかに遅延して到着した場合に）重複が発生する可能性があったバグを修正。[#21138](https://github.com/ClickHouse/ClickHouse/pull/21138) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 型が Nullable の場合に `input_format_null_as_default` が有効になるように修正しました。これにより [#21116](https://github.com/ClickHouse/ClickHouse/issues/21116) が解決されました。 [#21121](https://github.com/ClickHouse/ClickHouse/pull/21121)（[Amos Bird](https://github.com/amosbird)）。
* Tuple を Map にキャストする処理に関連するバグを修正しました。[#21029](https://github.com/ClickHouse/ClickHouse/issues/21029) をクローズします。 [#21120](https://github.com/ClickHouse/ClickHouse/pull/21120) ([hexiaoting](https://github.com/hexiaoting)).
* カスタム（デフォルト以外）の ZooKeeper クラスターを使用する Replicated*MergeTree を削除する際に発生していたメタデータリークを修正しました。 [#21119](https://github.com/ClickHouse/ClickHouse/pull/21119) ([fastio](https://github.com/fastio)).
* joinGet で LowCardinality キーを使用する際の型不一致の問題を修正します。これにより [#21114](https://github.com/ClickHouse/ClickHouse/issues/21114) が解決されます。[#21117](https://github.com/ClickHouse/ClickHouse/pull/21117)（[Amos Bird](https://github.com/amosbird)）。
* `Replicated(*)MergeTree` エンジンで他のパラメータを指定する必要がある場合に、`default_replica_path` と `default_replica_name` の値が無意味になっていた問題を修正。 [#21060](https://github.com/ClickHouse/ClickHouse/pull/21060) ([mxzlxy](https://github.com/mxzlxy)).
* 細工された範囲外の `DateTime64` 型の値をフォーマットする際に、境界外メモリアクセスが発生する可能性がありました。これにより [#20494](https://github.com/ClickHouse/ClickHouse/issues/20494) がクローズされました。これにより [#20543](https://github.com/ClickHouse/ClickHouse/issues/20543) がクローズされました。[#21023](https://github.com/ClickHouse/ClickHouse/pull/21023)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `join` ストレージへの並列挿入を禁止するようにしました。 [#21009](https://github.com/ClickHouse/ClickHouse/pull/21009) ([vdimir](https://github.com/vdimir)).
* `ALTER MODIFY COLUMN` が、失敗することが分かっているミューテーションを作成してしまう問題を修正しました。 [#21007](https://github.com/ClickHouse/ClickHouse/pull/21007) ([Anton Popov](https://github.com/CurtizJ)).
* [#9969](https://github.com/ClickHouse/ClickHouse/issues/9969) をクローズ。大きなデータサイズで、やや複雑な構造かつ JSON 出力フォーマットの場合に再現していた Brotli の HTTP 圧縮エラーを修正。リングバッファ内の「初期化されていないデータへのまれなアクセスの修正」を取り込むため、Brotli を最新バージョンに更新。[#20991](https://github.com/ClickHouse/ClickHouse/pull/20991)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* クエリのキャンセル時に発生する「Empty task was returned from async task queue」エラーを修正しました。 [#20881](https://github.com/ClickHouse/ClickHouse/pull/20881) ([Azat Khuzhin](https://github.com/azat))。
* MySQL 5.7 クライアントを使用して ClickHouse サーバーに接続したときに `USE database;` クエリが動作しなかった問題を修正しました。 [#18926](https://github.com/ClickHouse/ClickHouse/issues/18926) を修正。 [#20878](https://github.com/ClickHouse/ClickHouse/pull/20878) ([tavplubix](https://github.com/tavplubix))。
* 集約関数における `-Distinct` コンビネータと `-State` コンビネータの併用方法を修正。 [#20866](https://github.com/ClickHouse/ClickHouse/pull/20866) ([Anton Popov](https://github.com/CurtizJ)).
* `UNION DISTINCT` と `LIMIT` 句を含むサブクエリを修正。 [#20597](https://github.com/ClickHouse/ClickHouse/issues/20597) をクローズ。 [#20610](https://github.com/ClickHouse/ClickHouse/pull/20610)（[flynn](https://github.com/ucasFL)）。
* 辞書内に存在しないキーを検索するクエリにおいて、辞書の動作が一貫しない問題を修正しました。 [#20578](https://github.com/ClickHouse/ClickHouse/pull/20578) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* スカラーサブクエリおよびインデックス用サブクエリに対するスレッド数の設定を修正しました（[#19007](https://github.com/ClickHouse/ClickHouse/issues/19007) 以降は常に単一スレッドが使用されていました）。[#20457](https://github.com/ClickHouse/ClickHouse/issues/20457)、[#20512](https://github.com/ClickHouse/ClickHouse/issues/20512) を修正します。[#20550](https://github.com/ClickHouse/ClickHouse/pull/20550)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* リモートクエリから不明なパケットを受信した場合に発生し得るクラッシュを修正（[#17868](https://github.com/ClickHouse/ClickHouse/issues/17868) で導入された不具合）。[#20547](https://github.com/ClickHouse/ClickHouse/pull/20547)（[Azat Khuzhin](https://github.com/azat)）。
* async INSERT 用のディレクトリ名をパースする際に適切なチェックを追加しました（SIGSEGV を修正）。 [#20498](https://github.com/ClickHouse/ClickHouse/pull/20498) ([Azat Khuzhin](https://github.com/azat)).
* 浮動小数点キーで `transform` 関数が正しく動作しない問題を修正しました。[#20460](https://github.com/ClickHouse/ClickHouse/issues/20460) をクローズ。[#20479](https://github.com/ClickHouse/ClickHouse/pull/20479)（[flynn](https://github.com/ucasFL)）。
* WITH 句のエイリアスをサブクエリへ伝播する際に発生していた無限ループを修正。これにより [#20388](https://github.com/ClickHouse/ClickHouse/issues/20388) が解決されます。 [#20476](https://github.com/ClickHouse/ClickHouse/pull/20476)（[Amos Bird](https://github.com/amosbird)）。
* HTTP クライアントが切断されたときに発生するサーバーの異常終了を修正。 [#20464](https://github.com/ClickHouse/ClickHouse/pull/20464) ([Azat Khuzhin](https://github.com/azat)).
* `join_use_nulls=1` の場合に、`SELECT` の定数を含む `JOIN` で発生する `LOGICAL_ERROR` を修正。 [#20461](https://github.com/ClickHouse/ClickHouse/pull/20461) ([Azat Khuzhin](https://github.com/azat)).
* 式リスト内でテーブル関数 `view` が使用されているかを確認し、使用されていればエラーをスローします。これにより [#20342](https://github.com/ClickHouse/ClickHouse/issues/20342) が修正されます。 [#20350](https://github.com/ClickHouse/ClickHouse/pull/20350)（[Amos Bird](https://github.com/amosbird)）。
* RANGE&#95;HASHED() 辞書での不正なデリファレンスを回避するよう修正。[#20345](https://github.com/ClickHouse/ClickHouse/pull/20345)（[Azat Khuzhin](https://github.com/azat)）。
* `join_use_nulls=1` 使用時のヌルデリファレンスを修正。 [#20344](https://github.com/ClickHouse/ClickHouse/pull/20344) ([Azat Khuzhin](https://github.com/azat)).
* スケールが異なる2つの定数 Decimal 型同士の二項演算で誤った結果が返される問題を修正。 [#20283](https://github.com/ClickHouse/ClickHouse/issues/20283) を修正。 [#20339](https://github.com/ClickHouse/ClickHouse/pull/20339)（[Maksim Kita](https://github.com/kitaisreal)）。
* `ReplicatedMergeTree` テーブルエンジンファミリーにおいて、失敗したバックグラウンドタスクが過度に再試行される問題を修正しました。この問題により、ログ出力量の増加や CPU 負荷の上昇を招く可能性がありました。[#20203](https://github.com/ClickHouse/ClickHouse/issues/20203) を修正します。[#20335](https://github.com/ClickHouse/ClickHouse/pull/20335)（[alesapin](https://github.com/alesapin)）。
* `*CollapsingMergeTree` および `ReplacingMergeTree` テーブルエンジンのバージョン列に対する操作を `DROP` と `RENAME` のみに制限。 [#20300](https://github.com/ClickHouse/ClickHouse/pull/20300) ([alesapin](https://github.com/alesapin)).
* 破損した JSON の場合に、ファイル全体をメモリに読み込もうとしてアロケータから例外が発生していた問題を修正しました。 [#19719](https://github.com/ClickHouse/ClickHouse/issues/19719) を修正。 [#20286](https://github.com/ClickHouse/ClickHouse/pull/20286)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 垂直マージを許可していない `MergeTree` テーブルエンジンファミリーで、垂直マージを実行した際に発生する例外を修正しました。 [#20259](https://github.com/ClickHouse/ClickHouse/issues/20259) を修正します。 [#20279](https://github.com/ClickHouse/ClickHouse/pull/20279)（[alesapin](https://github.com/alesapin)）。
* シャットダウン中の設定リロード時にまれに発生するサーバークラッシュを修正。[#19689](https://github.com/ClickHouse/ClickHouse/issues/19689) を修正。[#20224](https://github.com/ClickHouse/ClickHouse/pull/20224)（[alesapin](https://github.com/alesapin)）。
* INSERT SELECT での CTE の扱いを修正しました。これにより [#20187](https://github.com/ClickHouse/ClickHouse/issues/20187) と [#20195](https://github.com/ClickHouse/ClickHouse/issues/20195) が解決されます。[#20211](https://github.com/ClickHouse/ClickHouse/pull/20211)（[Amos Bird](https://github.com/amosbird)）。
* [#19314](https://github.com/ClickHouse/ClickHouse/issues/19314) を修正。[#20156](https://github.com/ClickHouse/ClickHouse/pull/20156)（[Ivan](https://github.com/abyss7)）。
* 特殊なタイムゾーンを正しく処理できるように `toMinute` 関数を修正。 [#20149](https://github.com/ClickHouse/ClickHouse/pull/20149) ([keenwolf](https://github.com/keen-wolf)).
* `then` / `else` ブランチの結果が `Tuple` 型である `if` 関数を含むクエリの実行後に発生するサーバークラッシュを修正しました。`Tuple` 型には `Array` または別の複合型を含める必要があります。[#18356](https://github.com/ClickHouse/ClickHouse/issues/18356) を修正。[#20133](https://github.com/ClickHouse/ClickHouse/pull/20133)（[alesapin](https://github.com/alesapin)）。
* `MongoDB` テーブルエンジンは、データを読み取るときにのみ接続を確立するようになりました。`ATTACH TABLE` はこれ以上接続を試みません。[#20110](https://github.com/ClickHouse/ClickHouse/pull/20110)（[Vitaly Baranov](https://github.com/vitlibar)）。
* StorageJoin のバグを修正。 [#20079](https://github.com/ClickHouse/ClickHouse/pull/20079) ([vdimir](https://github.com/vdimir)).
* 負の数を小さい除数で割った際に剰余を計算する処理で、負の結果を格納するには結果のデータ型が十分なサイズではないケースを修正しました。これにより [#20052](https://github.com/ClickHouse/ClickHouse/issues/20052) がクローズされました。 [#20067](https://github.com/ClickHouse/ClickHouse/pull/20067) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* MaterializeMySQL: 複数テーブルを更新するステートメントのレプリケーションを修正。 [#20066](https://github.com/ClickHouse/ClickHouse/pull/20066) ([Håvard Kvålen](https://github.com/havardk)).
* 初期化スクリプトの実行中に Docker で発生する「Connection refused」エラーを防止。 [#20012](https://github.com/ClickHouse/ClickHouse/pull/20012) ([filimonov](https://github.com/filimonov)).
* `EmbeddedRocksDB` は実験的なストレージです。適切な型チェックが行われていない問題を修正し、コードを簡略化しました。これにより [#19967](https://github.com/ClickHouse/ClickHouse/issues/19967) がクローズされました。 [#19972](https://github.com/ClickHouse/ClickHouse/pull/19972) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 引数の型が Int32 以外の任意の整数型に対して `Nullable(T)` の場合、関数 `fromModifiedJulianDay` で発生していたセグメンテーションフォルトを修正しました。 [#19959](https://github.com/ClickHouse/ClickHouse/pull/19959) ([PHO](https://github.com/depressed-pho))。
* BloomFilter インデックスのクラッシュを修正。 [#19757](https://github.com/ClickHouse/ClickHouse/issues/19757) を修正。 [#19884](https://github.com/ClickHouse/ClickHouse/pull/19884)（[Maksim Kita](https://github.com/kitaisreal)）。
* system.text&#95;log が有効な場合にデッドロックが発生する可能性がありました。[#19874](https://github.com/ClickHouse/ClickHouse/issues/19874) を修正しました。 [#19875](https://github.com/ClickHouse/ClickHouse/pull/19875) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* dictGet() を含むデフォルト式を持つテーブルがある状態でもサーバーを起動できるように修正。辞書をロードせずに dictGet() の戻り値型を取得できるようにした。 [#19805](https://github.com/ClickHouse/ClickHouse/pull/19805) ([Vitaly Baranov](https://github.com/vitlibar)).
* `select` のみを実行した際に発生する clickhouse-client のアボート例外を修正しました。 [#19790](https://github.com/ClickHouse/ClickHouse/pull/19790) ([taiyang-li](https://github.com/taiyang-li)).
* 複数の clickhouse-copier を起動した場合に、デスティネーションテーブルへのパーツの移動が失敗することがあるバグを修正。 [#19743](https://github.com/ClickHouse/ClickHouse/pull/19743) ([madianjun](https://github.com/mdianjun)).
* `ON CLUSTER` クエリを実行するバックグラウンドスレッドが、削除されたレプリケーテッドテーブルの何らかの処理を待っている間にハングする可能性がありました。この問題は修正されました。 [#19684](https://github.com/ClickHouse/ClickHouse/pull/19684) ([yiguolei](https://github.com/yiguolei)).

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-8}

- AVX-2をグローバルに有効化してClickHouseをビルドできるようになりました。最新のCPUでわずかなパフォーマンス向上が得られます。本番環境での使用は推奨されず、現時点では公式ビルドとしてサポートされません。[#20180](https://github.com/ClickHouse/ClickHouse/pull/20180) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- Coverityで発見された問題の一部を修正しました。[#19964](https://github.com/ClickHouse/ClickHouse/issues/19964)を参照してください。[#20010](https://github.com/ClickHouse/ClickHouse/pull/20010) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- gdb下で変更されたバイナリでの起動を許可しました。以前のバージョンでは、起動前にgdbでブレークポイントを設定すると、整合性チェックの失敗によりサーバーが起動を拒否していました。[#21258](https://github.com/ClickHouse/ClickHouse/pull/21258) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- Kafkaの異なる圧縮方式に対するテストを追加しました。[#21111](https://github.com/ClickHouse/ClickHouse/pull/21111) ([filimonov](https://github.com/filimonov))。
- test_storage_kerberized_hdfsテストのポート競合を修正しました。[#19974](https://github.com/ClickHouse/ClickHouse/pull/19974) ([Ilya Yatsishin](https://github.com/qoega))。
- 統合テストでdockerの起動に失敗した際に`stdout`と`stderr`をログに出力するようにしました。このPR以前は、このケースで非常に短いエラーメッセージしか表示されず、問題の調査に役立ちませんでした。[#20631](https://github.com/ClickHouse/ClickHouse/pull/20631) ([Vitaly Baranov](https://github.com/vitlibar))。


## ClickHouse リリース 21.2 {#clickhouse-release-212}

### ClickHouse リリース v21.2.2.8-stable, 2021-02-07 {#clickhouse-release-v21228-stable-2021-02-07}

#### 後方互換性のない変更 {#backward-incompatible-change-9}

- ビット演算関数（`bitAnd`、`bitOr`など）は浮動小数点数の引数に対して使用できなくなりました。整数への明示的なキャストが必要です。[#19853](https://github.com/ClickHouse/ClickHouse/pull/19853) ([Azat Khuzhin](https://github.com/azat))。
- 浮動小数点数に対する`lcm`/`gcd`を禁止しました。[#19532](https://github.com/ClickHouse/ClickHouse/pull/19532) ([Azat Khuzhin](https://github.com/azat))。
- `OPTIMIZE TABLE`/マージのメモリ追跡を修正しました。`OPTIMIZE TABLE`/マージに対するクエリメモリ制限とサンプリングを考慮するようになりました。[#18772](https://github.com/ClickHouse/ClickHouse/pull/18772) ([Azat Khuzhin](https://github.com/azat))。
- パーティションキーとしての浮動小数点カラムを禁止しました。詳細は[#18421](https://github.com/ClickHouse/ClickHouse/issues/18421#event-4147046255)を参照してください。[#18464](https://github.com/ClickHouse/ClickHouse/pull/18464) ([hexiaoting](https://github.com/hexiaoting))。
- 型定義における過剰な括弧はサポートされなくなりました。例：`Array((UInt8))`。

#### 新機能 {#new-feature-9}


* `PostgreSQL` テーブルエンジンを追加（select/insert の両方に対応し、多次元配列をサポート）、テーブル関数としても利用可能に。`PostgreSQL` ディクショナリソースを追加。`PostgreSQL` データベースエンジンを追加。[#18554](https://github.com/ClickHouse/ClickHouse/pull/18554)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* データ型 `Nested` は任意のレベルの入れ子構造をサポートするようになりました。`Array` の `size0`、`Nullable` の `null`、`Tuple` 要素の名前といった複合型のサブカラムが導入され、カラム全体を読み込むことなくそれらを個別に読み出すことができます。 [#17310](https://github.com/ClickHouse/ClickHouse/pull/17310) ([Anton Popov](https://github.com/CurtizJ))。
* `FlatDictionary`、`HashedDictionary`、`ComplexKeyHashedDictionary`、`DirectDictionary`、`ComplexKeyDirectDictionary`、`RangeHashedDictionary` に `Nullable` のサポートを追加しました。 [#18236](https://github.com/ClickHouse/ClickHouse/pull/18236)（[Maksim Kita](https://github.com/kitaisreal)）。
* DDL ワーカーキュー内のクエリを表示する新しいテーブル `system.distributed_ddl_queue` を追加。 [#17656](https://github.com/ClickHouse/ClickHouse/pull/17656) ([Bharat Nallan](https://github.com/bharatnc))。
* LDAP ユーザーディレクトリのユーザーに対して、LDAP グループ名および属性値全般をローカルロールへマッピングできるようサポートを追加しました。 [#17211](https://github.com/ClickHouse/ClickHouse/pull/17211) ([Denis Glazachev](https://github.com/traceon)).
* テーブル関数 `cluster` への INSERT をサポートし、さらにテーブル関数 `remote` と `cluster` の両方で、シャーディングキーを指定してノード間にデータを分散できるようにしました。[#16752](https://github.com/ClickHouse/ClickHouse/issues/16752) をクローズ。[#18264](https://github.com/ClickHouse/ClickHouse/pull/18264) ([flynn](https://github.com/ucasFL))。
* XML の文字参照をデコードする関数 `decodeXMLComponent` を追加しました。例: `SELECT decodeXMLComponent('Hello,&quot;world&quot;!')` [#17659](https://github.com/ClickHouse/ClickHouse/issues/17659)。 [#18542](https://github.com/ClickHouse/ClickHouse/pull/18542)（[nauta](https://github.com/nautaa)）。
* 関数 `parseDateTimeBestEffortUSOrZero` と `parseDateTimeBestEffortUSOrNull` を追加しました。 [#19712](https://github.com/ClickHouse/ClickHouse/pull/19712) ([Maksim Kita](https://github.com/kitaisreal)).
* `sign` 数学関数を追加。 [#19527](https://github.com/ClickHouse/ClickHouse/pull/19527) ([flynn](https://github.com/ucasFL))。
* 使用された機能（関数、テーブルエンジンなど）に関する情報を system.query&#95;log に追加しました。 [#18495](https://github.com/ClickHouse/ClickHouse/issues/18495)。 [#19371](https://github.com/ClickHouse/ClickHouse/pull/19371)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 関数 `formatDateTime` が、日付を四半期としてフォーマットするための `%Q` 修飾子をサポートするようになりました。 [#19224](https://github.com/ClickHouse/ClickHouse/pull/19224) ([Jianmei Zhang](https://github.com/zhangjmruc))。
* Play UI で MetaKey+Enter ホットキーの割り当てに対応しました。 [#19012](https://github.com/ClickHouse/ClickHouse/pull/19012) ([sundyli](https://github.com/sundy-li)).
* map データ型向けに 3 つの関数を追加しました。1. `mapContains(map, key)` は、map のキーに第 2 引数 key が含まれるかどうかを確認します。2. `mapKeys(map)` は、すべてのキーを Array 形式で返します。3. `mapValues(map)` は、すべての値を Array 形式で返します。 [#18788](https://github.com/ClickHouse/ClickHouse/pull/18788) ([hexiaoting](https://github.com/hexiaoting))。
* [#18494](https://github.com/ClickHouse/ClickHouse/issues/18494) に関連して `log_comment` 設定を追加。 [#18549](https://github.com/ClickHouse/ClickHouse/pull/18549) ([Zijie Lu](https://github.com/TszKitLo40))。
* `argMin` および `argMax` 関数でタプル引数をサポートしました。 [#17359](https://github.com/ClickHouse/ClickHouse/pull/17359) ([Ildus Kurbangaliev](https://github.com/ildus)).
* `EXISTS VIEW` 構文をサポート。[#18552](https://github.com/ClickHouse/ClickHouse/pull/18552)（[Du Chuan](https://github.com/spongedu)）。
* `SELECT ALL` 構文を追加。 [#18706](https://github.com/ClickHouse/ClickHouse/issues/18706) をクローズ。 [#18723](https://github.com/ClickHouse/ClickHouse/pull/18723)（[flynn](https://github.com/ucasFL)）。

#### パフォーマンス改善 {#performance-improvement-9}

- `stat`システムコールの回数を削減することで、パーツの削除を高速化しました。これは以前存在していた最適化を復活させるものです。`IDisk`のインターフェースをより安全にしました。これにより[#19065](https://github.com/ClickHouse/ClickHouse/issues/19065)が解決されます。[#19086](https://github.com/ClickHouse/ClickHouse/pull/19086) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `WITH`文で宣言されたエイリアスがインデックス解析で適切に使用されるようになりました。`WITH column AS alias SELECT ... WHERE alias = ...`のようなクエリでインデックスが使用できるようになりました。[#18896](https://github.com/ClickHouse/ClickHouse/pull/18896) ([Amos Bird](https://github.com/amosbird))。
- `optimize_alias_column_prediction`を追加しました(デフォルトで有効)。これにより以下が実現されます: - パーティションプルーニングおよびセカンダリインデックスを使用したデータスキップ時に、WHERE句内のエイリアス列を考慮します; - optimize_trivial_countの単純なカウントクエリにおいて、WHERE句内のエイリアス列を考慮します; - optimize_aggregation_in_order/optimize_read_in_orderにおいて、GROUP BY/ORDER BY内のエイリアス列を考慮します。[#16995](https://github.com/ClickHouse/ClickHouse/pull/16995) ([sundyli](https://github.com/sundy-li))。
- 集約関数`sum`を高速化しました。この改善は合成ベンチマークでのみ確認でき、実用上はあまり効果がありません。[#19216](https://github.com/ClickHouse/ClickHouse/pull/19216) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- libc++を更新し、より優れたパフォーマンスを提供するために別のABIを使用するようにしました。[#18914](https://github.com/ClickHouse/ClickHouse/pull/18914) ([Danila Kutenin](https://github.com/danlark1))。
- 論理的に等価な場合、`sumIf()`および`sum(if())`関数を`countIf()`関数に書き換えるようにしました。[#17041](https://github.com/ClickHouse/ClickHouse/pull/17041) ([flynn](https://github.com/ucasFL))。
- S3接続に接続プールを使用するようにしました。これは`s3_max_connections`設定で制御されます。[#13405](https://github.com/ClickHouse/ClickHouse/pull/13405) ([Vladimir Chebotarev](https://github.com/excitoon))。
- 文字列カラムのより優れた圧縮によりスペースを節約するため、zstd longオプションのサポートを追加しました。[#17184](https://github.com/ClickHouse/ClickHouse/pull/17184) ([ygrek](https://github.com/ygrek))。
- 接続ごとの設定へのアクセスを削除することで、サーバーのレイテンシをわずかに改善しました。[#19863](https://github.com/ClickHouse/ClickHouse/pull/19863) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `Buffer`エンジンの複数レイヤーにおけるロック競合を削減しました。[#19379](https://github.com/ClickHouse/ClickHouse/pull/19379) ([Azat Khuzhin](https://github.com/azat))。
- クエリプランの`Filter`ステップを`Expression + Filter`のペアに分割することをサポートしました。`Expression + Expression`のマージ最適化([#17458](https://github.com/ClickHouse/ClickHouse/issues/17458))と組み合わせることで、`Filter`ステップ後の一部の式の実行を遅延させることができます。[#19253](https://github.com/ClickHouse/ClickHouse/pull/19253) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。

#### 改善 {#improvement-9}


* `table` から任意のカラムを 1 つだけ選択できる場合でも、`SELECT count() FROM table` を実行できるようになりました。この PR は [#10639](https://github.com/ClickHouse/ClickHouse/issues/10639) を修正します。[#18233](https://github.com/ClickHouse/ClickHouse/pull/18233)（[Vitaly Baranov](https://github.com/vitlibar)）。
* リモートの MySQL サーバーとやり取りする際の文字セットを `utf8mb4` に設定。 [#19795](https://github.com/ClickHouse/ClickHouse/issues/19795) を修正。 [#19800](https://github.com/ClickHouse/ClickHouse/pull/19800)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `S3` テーブル関数が `auto` 圧縮モード（自動検出）をサポートするようになりました。これにより [#18754](https://github.com/ClickHouse/ClickHouse/issues/18754) が解決されました。 [#19793](https://github.com/ClickHouse/ClickHouse/pull/19793)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* `formatReadableTimeDelta` 関数が無限大の引数を正しく出力するようにしました。以前のバージョンでは、実装依存の整数値への暗黙的な変換が行われていました。 [#19791](https://github.com/ClickHouse/ClickHouse/pull/19791) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* テーブル関数 `S3` は、リージョンを正確に特定できない場合にグローバルリージョンを使用するようになりました。これにより [#10998](https://github.com/ClickHouse/ClickHouse/issues/10998) がクローズされました。[#19750](https://github.com/ClickHouse/ClickHouse/pull/19750)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* 分散クエリで設定 `async_socket_for_remote` が有効な場合、テーブルで非常に深くネストしたデータ型（例: `Array(Array(Array(...more...)))`）を使用すると、少なくともデバッグビルド構成ではスタックオーバーフローが発生する可能性がありました。これは [#19108](https://github.com/ClickHouse/ClickHouse/issues/19108) を修正します。この変更により、わずかな後方互換性の非互換が導入されています。型定義内の過剰なかっこはサポートされなくなりました（例: `Array((UInt8))`）。[#19736](https://github.com/ClickHouse/ClickHouse/pull/19736)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* メッセージブローカー（RabbitMQ と Kafka）用の個別プールを追加。 [#19722](https://github.com/ClickHouse/ClickHouse/pull/19722) ([Azat Khuzhin](https://github.com/azat)).
* 非レプリケートな MergeTree において、`max_number_of_merges_with_ttl_in_pool` 制限をまれに超過してしまう問題（TTL を伴うマージが余分に割り当てられてしまう可能性がある）を修正しました。 [#19708](https://github.com/ClickHouse/ClickHouse/pull/19708) ([alesapin](https://github.com/alesapin)).
* Dictionary: 属性パース時のエラーメッセージを改善。 [#19678](https://github.com/ClickHouse/ClickHouse/pull/19678) ([Maksim Kita](https://github.com/kitaisreal)).
* 読み取り時のチェックサム検証を無効化するオプションを追加。プロダクション環境では決して使用すべきではありません。これを無効化しても、メリットは一切期待しないでください。実験やベンチマークのためにのみ使用される可能性があります。この設定は MergeTree ファミリーのテーブルにのみ適用されます。他のテーブルエンジンおよびネットワーク経由でデータを受信する場合には、チェックサムは常に検証されます。私の観察では、パフォーマンスの差はないか、あっても 0.5% 未満です。 [#19588](https://github.com/ClickHouse/ClickHouse/pull/19588) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 関数 `multiIf` で定数の結果をサポートしました。 [#19533](https://github.com/ClickHouse/ClickHouse/pull/19533) ([Maksim Kita](https://github.com/kitaisreal)).
* Map 型に対して length / empty / notEmpty 関数を有効化し、Map 内のキー数を返すようにしました。 [#19530](https://github.com/ClickHouse/ClickHouse/pull/19530) ([taiyang-li](https://github.com/taiyang-li)).
* `clickhouse-benchmark` に `--reconnect` オプションを追加しました。このオプションが指定されている場合、各リクエストの前に再接続を行います。これはテストのために必要です。 [#19872](https://github.com/ClickHouse/ClickHouse/pull/19872) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `.debug` ファイルの新しい配置場所に対応しました。これにより [#19348](https://github.com/ClickHouse/ClickHouse/issues/19348) が修正されました。 [#19520](https://github.com/ClickHouse/ClickHouse/pull/19520) ([Amos Bird](https://github.com/amosbird))。
* `toIPv6` 関数が `IPv4` アドレスも解析できるようになりました。 [#19518](https://github.com/ClickHouse/ClickHouse/pull/19518) ([Bharat Nallan](https://github.com/bharatnc)).
* `system.query_log`、`system.processes` などに `http_referer` フィールドを追加。これにより [#19389](https://github.com/ClickHouse/ClickHouse/issues/19389) がクローズされた。 [#19390](https://github.com/ClickHouse/ClickHouse/pull/19390)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* より多くの関数を大文字小文字を区別しないようにし、エイリアスを追加することで、MySQL との互換性を向上させました。 [#19387](https://github.com/ClickHouse/ClickHouse/pull/19387) ([Daniil Kondratyev](https://github.com/dankondr)).
* MergeTree パーツ（Wide/Compact/InMemory）タイプ向けメトリクスを追加。 [#19381](https://github.com/ClickHouse/ClickHouse/pull/19381) ([Azat Khuzhin](https://github.com/azat)).
* 任意の UID で Docker を実行できるようにしました。 [#19374](https://github.com/ClickHouse/ClickHouse/pull/19374) ([filimonov](https://github.com/filimonov)).
* Pretty 形式における `IPv4` データ型の値の誤った配置を修正しました。これまで右寄せになっていましたが、左寄せで配置されるようになりました。これにより [#19184](https://github.com/ClickHouse/ClickHouse/issues/19184) がクローズされます。[#19339](https://github.com/ClickHouse/ClickHouse/pull/19339)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `max_server_memory_usage` を再起動なしで変更できるようにしました。これにより [#18154](https://github.com/ClickHouse/ClickHouse/issues/18154) がクローズされました。 [#19186](https://github.com/ClickHouse/ClickHouse/pull/19186) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 特定の NaN 引数で関数 `bar` が呼び出された場合にスローされる例外が、以前のバージョンではやや誤解を招くものでした。これにより [#19088](https://github.com/ClickHouse/ClickHouse/issues/19088) が修正されています。 [#19107](https://github.com/ClickHouse/ClickHouse/pull/19107)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* clickhouse-server イメージ内の clickhouse ユーザーとグループの uid / gid を固定値 (101) に明示的に設定しました。 [#19096](https://github.com/ClickHouse/ClickHouse/pull/19096) ([filimonov](https://github.com/filimonov))。
* 巨大な文字列を含むデータの挿入時に発生していた `PeekableReadBuffer: Memory limit exceed` エラーを修正しました。 [#18690](https://github.com/ClickHouse/ClickHouse/issues/18690) に対応。 [#18979](https://github.com/ClickHouse/ClickHouse/pull/18979)（[tavplubix](https://github.com/tavplubix)）。
* Docker イメージ: clickhouse-server エントリーポイントのいくつかの改善。 [#18954](https://github.com/ClickHouse/ClickHouse/pull/18954) ([filimonov](https://github.com/filimonov))。
* `normalizeQueryKeepNames` と `normalizedQueryHashKeepNames` を追加し、長い名前を `?` でマスクせずにクエリを正規化できるようにしました。これにより、複雑なクエリログをより適切に分析できます。 [#18910](https://github.com/ClickHouse/ClickHouse/pull/18910) ([Amos Bird](https://github.com/amosbird))。
* 送信前に送信側で分散バッチのブロック単位のチェックサムを検証します（ファイルを二度読みせず、読み取り中にチェックサムを検証します）。これにより、送信側の .bin ファイルが切り詰められている場合に、受信側での INSERT がハングすることを防ぎます。バッチ INSERT のために .bin ファイルを二度読みすることを回避します（以前は squashing を考慮するために行数／バイト数を計算する必要がありましたが、現在はこの情報がヘッダーに含まれており、後方互換性は維持されています）。 [#18853](https://github.com/ClickHouse/ClickHouse/pull/18853) ([Azat Khuzhin](https://github.com/azat))。
* 集約関数の状態を含むテーブルに対する RIGHT および FULL JOIN の問題を修正しました。以前のバージョンでは、`cloneResized` メソッドに関する例外がスローされていました。 [#18818](https://github.com/ClickHouse/ClickHouse/pull/18818) ([templarzq](https://github.com/templarzq))。
* プレフィックスベースの S3 エンドポイント設定を追加しました。 [#18812](https://github.com/ClickHouse/ClickHouse/pull/18812) ([Vladimir Chebotarev](https://github.com/excitoon))。
* bitmapTransform、bitmapSubsetInRange、bitmapSubsetLimit、bitmapContains 関数で [UInt8, UInt16, UInt32, UInt64] 型の引数をサポートしました。これにより [#18713](https://github.com/ClickHouse/ClickHouse/issues/18713) が解決されます。[#18791](https://github.com/ClickHouse/ClickHouse/pull/18791)（[sundyli](https://github.com/sundy-li)）。
* CTE（Common Table Expressions）に対して、さらに別名を付けられるようにしました。`enable_global_with_statement = 1` の場合、同じレベルのサブクエリに CSE（Common Subexpressions Elimination）を伝播させます。これにより [#17378](https://github.com/ClickHouse/ClickHouse/issues/17378) が修正されます。また、[https://github.com/ClickHouse/ClickHouse/pull/16575#issuecomment-753416235](https://github.com/ClickHouse/ClickHouse/pull/16575#issuecomment-753416235) も修正されます。 [#18684](https://github.com/ClickHouse/ClickHouse/pull/18684)（[Amos Bird](https://github.com/amosbird)）。
* librdkafka を v1.6.0-RC2 に更新。 [#18668](https://github.com/ClickHouse/ClickHouse/issues/18668) を修正。[#18671](https://github.com/ClickHouse/ClickHouse/pull/18671)（[filimonov](https://github.com/filimonov)）。
* 予期しない例外が発生した場合、分散 DDL クエリの実行を担当するバックグラウンドスレッドを自動的に再起動するようにしました。 [#17991](https://github.com/ClickHouse/ClickHouse/issues/17991) を修正します。 [#18285](https://github.com/ClickHouse/ClickHouse/pull/18285) ([徐炘](https://github.com/weeds085490))。
* S3 のグローバルリージョンを利用するために AWS C++ SDK を更新しました。 [#17870](https://github.com/ClickHouse/ClickHouse/pull/17870) ([Vladimir Chebotarev](https://github.com/excitoon))。
* `LIVE VIEW` テーブルを作成する際に `WITH ... [AND] [PERIODIC] REFRESH [interval_in_sec]` 句が使用できるようになりました。 [#14822](https://github.com/ClickHouse/ClickHouse/pull/14822) ([vzakaznikov](https://github.com/vzakaznikov)).
* 古い構文で作成された `MergeTree` テーブルに対する `MODIFY TTL` クエリの実行を制限しました。以前はクエリ自体は成功していましたが、実際には何の効果もありませんでした。 [#19064](https://github.com/ClickHouse/ClickHouse/pull/19064) ([Anton Popov](https://github.com/CurtizJ)).

#### バグ修正 {#bug-fix-8}


* 定数引数を持つ二項関数のインデックス解析を修正し、誤ったクエリ結果が返される問題を解消しました。これにより [#18364](https://github.com/ClickHouse/ClickHouse/issues/18364) が修正されています。[#18373](https://github.com/ClickHouse/ClickHouse/pull/18373)（[Amos Bird](https://github.com/amosbird)）。
* `dictGet()` を含むデフォルト式を持つテーブルがある場合にサーバーを起動できない問題を修正しました。辞書をロードせずに `dictGet()` の戻り値の型を取得できるようにしました。 [#19805](https://github.com/ClickHouse/ClickHouse/pull/19805) ([Vitaly Baranov](https://github.com/vitlibar)).
* `then`/`else` ブランチの結果が `Tuple` 型である `if` 関数を含むクエリの実行後にサーバーがクラッシュする問題を修正しました。`Tuple` 型は `Array` または他の複合型を含んでいる必要があります。[#18356](https://github.com/ClickHouse/ClickHouse/issues/18356) を修正します。 [#20133](https://github.com/ClickHouse/ClickHouse/pull/20133)（[alesapin](https://github.com/alesapin)）。
* `MaterializeMySQL`（実験的機能）：複数テーブルを更新するステートメントに対するレプリケーションを修正。 [#20066](https://github.com/ClickHouse/ClickHouse/pull/20066) ([Håvard Kvålen](https://github.com/havardk))。
* 初期化スクリプトの実行中に Docker で発生する「Connection refused」エラーを防止。 [#20012](https://github.com/ClickHouse/ClickHouse/pull/20012) ([filimonov](https://github.com/filimonov)).
* `EmbeddedRocksDB` は実験的なストレージです。適切な型チェックが行われていない問題を修正しました。コードを簡素化しました。これにより [#19967](https://github.com/ClickHouse/ClickHouse/issues/19967) がクローズされます。 [#19972](https://github.com/ClickHouse/ClickHouse/pull/19972) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 引数の型が Int32 以外の任意の整数型に対する `Nullable(T)` の場合に、関数 `fromModifiedJulianDay` で発生していたセグメンテーションフォールトを修正しました。 [#19959](https://github.com/ClickHouse/ClickHouse/pull/19959) ([PHO](https://github.com/depressed-pho))。
* 関数 `greatCircleAngle` は以前のバージョンでは不正確な結果を返していました。これにより [#19769](https://github.com/ClickHouse/ClickHouse/issues/19769) が解決されています。[#19789](https://github.com/ClickHouse/ClickHouse/pull/19789)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* データ破損後に一部のレプリケートされた操作（ミューテーションなど）が特定のパーツを処理できなくなるという、まれなバグを修正。 [#19593](https://github.com/ClickHouse/ClickHouse/issues/19593) を修正。 [#19702](https://github.com/ClickHouse/ClickHouse/pull/19702)（[alesapin](https://github.com/alesapin)）。
* `ON CLUSTER` クエリを実行するバックグラウンドスレッドが、削除済みのレプリケーテッドテーブルが何らかの処理を行うのを待ってハングする可能性がありました。これは修正されました。 [#19684](https://github.com/ClickHouse/ClickHouse/pull/19684) ([yiguolei](https://github.com/yiguolei)).
* カラム記述のデシリアライズの誤りを修正しました。これにより、名前が `\` のカラムを持つテーブルへの INSERT が不可能になっていました。 [#19479](https://github.com/ClickHouse/ClickHouse/pull/19479) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* いずれかのファイルに空のデータブロックがある場合、分散バッチを破損としてマークするようにしました。 [#19449](https://github.com/ClickHouse/ClickHouse/pull/19449) ([Azat Khuzhin](https://github.com/azat)).
* `DROP/DETACH/REPLACE/MOVE PARTITION` の後にミューテーションがハングする可能性がある、非常にまれなバグを修正しました。これはほとんどのケースでは [#15537](https://github.com/ClickHouse/ClickHouse/issues/15537) によって部分的に修正されていました。 [#19443](https://github.com/ClickHouse/ClickHouse/pull/19443) ([tavplubix](https://github.com/tavplubix))。
* 発生し得るエラー `Extremes transform was already added to pipeline` を修正しました。[#14100](https://github.com/ClickHouse/ClickHouse/issues/14100) を解決。[#19430](https://github.com/ClickHouse/ClickHouse/pull/19430)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* デフォルト値が 0 以外の `JOIN` 型（例: 一部の `Enum`）におけるデフォルト値の扱いを修正しました。[#18197](https://github.com/ClickHouse/ClickHouse/issues/18197) をクローズ。[#19360](https://github.com/ClickHouse/ClickHouse/pull/19360)（[vdimir](https://github.com/vdimir)）。
* EOF 時に分散送信用ファイルを破損としてマークしないようにしました。 [#19290](https://github.com/ClickHouse/ClickHouse/pull/19290) ([Azat Khuzhin](https://github.com/azat)).
* `async_socket_for_remote` のパイプ FD のリークを修正。 [#19153](https://github.com/ClickHouse/ClickHouse/pull/19153) ([Azat Khuzhin](https://github.com/azat)).
* `ORC` フォーマットのファイルからの無限読み取りが発生する問題を修正（[#10580](https://github.com/ClickHouse/ClickHouse/issues/10580) で導入された不具合）。[#19095](https://github.com/ClickHouse/ClickHouse/issues/19095) を修正。[#19134](https://github.com/ClickHouse/ClickHouse/pull/19134)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* MergeTree データライターで、固定グラニュラリティサイズより大きいサイズのマークが作成されてしまう可能性のある問題を修正しました。 [#18913](https://github.com/ClickHouse/ClickHouse/issues/18913) を修正。 [#19123](https://github.com/ClickHouse/ClickHouse/pull/19123) ([alesapin](https://github.com/alesapin))。
* `LowCardinality(Nullable(...))` から圧縮コーデックを読み取れず、`Attempt to read after EOF` という例外をスローして ClickHouse が起動できなかったバグを修正しました。[#18340](https://github.com/ClickHouse/ClickHouse/issues/18340) を修正。[#19101](https://github.com/ClickHouse/ClickHouse/pull/19101) ([alesapin](https://github.com/alesapin))。
* `tupleHammingDistance` の実装を簡素化しました。同じ長さの任意のタプルをサポートします。 [#19029](https://github.com/ClickHouse/ClickHouse/issues/19029) を修正。 [#19084](https://github.com/ClickHouse/ClickHouse/pull/19084)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* Enum 型の引数に対して `groupUniqArray` が正しい型を返すようにしました。これにより [#17875](https://github.com/ClickHouse/ClickHouse/issues/17875) がクローズされました。[#19019](https://github.com/ClickHouse/ClickHouse/pull/19019)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `LowCardinality` 引数とともに関数 `ignore` を使用した場合に発生する可能性がある `Expected single dictionary argument for function` エラーを修正。[#14275](https://github.com/ClickHouse/ClickHouse/issues/14275) を修正。[#19016](https://github.com/ClickHouse/ClickHouse/pull/19016)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `TinyLog` エンジンを使用するテーブルへの `LowCardinality` 列の挿入処理を修正しました。 [#18629](https://github.com/ClickHouse/ClickHouse/issues/18629) を修正します。 [#19010](https://github.com/ClickHouse/ClickHouse/pull/19010)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* JOIN の軽微な問題を修正: JOIN が const カラムをマテリアライズしようとしますが、コード側ではそれらが別の箇所で用意されるのを前提としていました。 [#18982](https://github.com/ClickHouse/ClickHouse/pull/18982) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* `optimize_move_functions_out_of_any` を無効化します。この最適化は常に正しいとは限らないためです。これにより [#18051](https://github.com/ClickHouse/ClickHouse/issues/18051) がクローズされます。また、[#18973](https://github.com/ClickHouse/ClickHouse/issues/18973) もクローズされます。[#18981](https://github.com/ClickHouse/ClickHouse/pull/18981)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* クエリプランの `Expression` ステップのマージによって発生する可能性のある例外 `QueryPipeline stream: different number of columns` を修正しました。[#18190](https://github.com/ClickHouse/ClickHouse/issues/18190) を修正。[#18980](https://github.com/ClickHouse/ClickHouse/pull/18980)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* シャットダウン時にごくまれに発生するデッドロックを修正。 [#18977](https://github.com/ClickHouse/ClickHouse/pull/18977) ([tavplubix](https://github.com/tavplubix)).
* サーバーのメモリ不足時にまれに発生していたクラッシュを修正しました。 [#18976](https://github.com/ClickHouse/ClickHouse/pull/18976) ([tavplubix](https://github.com/tavplubix)).
* `ALTER TABLE ... DROP PART 'part_name'` クエリが、パーティション全体の重複排除ブロックをすべて削除してしまう不正な動作を修正しました。 [#18874](https://github.com/ClickHouse/ClickHouse/issues/18874) を修正します。 [#18969](https://github.com/ClickHouse/ClickHouse/pull/18969)（[alesapin](https://github.com/alesapin)）。
* 問題 [#18894](https://github.com/ClickHouse/ClickHouse/issues/18894) を修正。Looker のような BI ツールによって自動生成されることが多い長いカラムエイリアス（`table.column` 形式）が長いテーブル名と一致する場合に例外が発生しないよう、チェックを追加しました。 [#18968](https://github.com/ClickHouse/ClickHouse/pull/18968) ([Daniel Qin](https://github.com/mathfool))。
* エラー `Task was not found in task queue` を修正（`async_socket_for_remote = 1` の場合にのみ、リモートクエリで発生し得る）。 [#18964](https://github.com/ClickHouse/ClickHouse/pull/18964) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 一部のエスケープされたテキストを含む `mutation`（例: `ALTER ... UPDATE e = CAST('foo', 'Enum8(\'foo\' = 1')`）が誤ってシリアライズされていたバグを修正しました。[#18878](https://github.com/ClickHouse/ClickHouse/issues/18878) を修正。[#18944](https://github.com/ClickHouse/ClickHouse/pull/18944)（[alesapin](https://github.com/alesapin)）。
* ATTACH PARTITION はミューテーションをリセットします。 [#18804](https://github.com/ClickHouse/ClickHouse/issues/18804)。 [#18935](https://github.com/ClickHouse/ClickHouse/pull/18935) ([fastio](https://github.com/fastio))。
* `bitmapOrCardinality` によって `nullptr` 参照が発生する可能性のある問題を修正しました。これにより [#18911](https://github.com/ClickHouse/ClickHouse/issues/18911) がクローズされます。 [#18912](https://github.com/ClickHouse/ClickHouse/pull/18912) ([sundyli](https://github.com/sundy-li)).
* `Nullable(String)` から `Nullable(Decimal(P, S))` への `CAST` を試みた際に発生していた `Attempt to read after eof` エラーを修正しました。これにより、nullable な文字列から decimal をパースできない場合、`CAST` 関数は `NULL` を返すようになりました。[#7690](https://github.com/ClickHouse/ClickHouse/issues/7690) を修正しました。[#18718](https://github.com/ClickHouse/ClickHouse/pull/18718)（[Winter Zhang](https://github.com/zhang2014)）。
* MySQL エンジンにおけるデータ型変換の不具合を修正。 [#18124](https://github.com/ClickHouse/ClickHouse/pull/18124) ([bo zeng](https://github.com/mis98zb)).
* `select` のみを実行している際に発生する clickhouse-client のアボート例外を修正。[#19790](https://github.com/ClickHouse/ClickHouse/pull/19790) ([taiyang-li](https://github.com/taiyang-li)).

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-9}

- CI で [SQLancer](https://twitter.com/RiggerManuel/status/1352345625480884228) (論理的 SQL ファザー) を実行。[#19006](https://github.com/ClickHouse/ClickHouse/pull/19006) ([Ilya Yatsishin](https://github.com/qoega))。
- Query Fuzzer が新しく追加されたテストをより広範囲にファジングするようになりました。これにより [#18916](https://github.com/ClickHouse/ClickHouse/issues/18916) が解決されます。[#19185](https://github.com/ClickHouse/ClickHouse/pull/19185) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- より優れたファジングのために [Big List of Naughty Strings](https://github.com/minimaxir/big-list-of-naughty-strings/) と統合。[#19480](https://github.com/ClickHouse/ClickHouse/pull/19480) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- MSan を使用した統合テストの実行を追加。[#18974](https://github.com/ClickHouse/ClickHouse/pull/18974) ([alesapin](https://github.com/alesapin))。
- cyrus-sasl と musl における MemorySanitizer エラーを修正。[#19821](https://github.com/ClickHouse/ClickHouse/pull/19821) ([Ilya Yatsishin](https://github.com/qoega))。
- `positionCaseInsensitiveUTF8` 関数における引数チェックの不足により address sanitizer がトリガーされる問題を修正。[#19720](https://github.com/ClickHouse/ClickHouse/pull/19720) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 統合テストにおける docker-compose の --project-directory を削除。docker コンテナからのログフォーマットを修正。[#19706](https://github.com/ClickHouse/ClickHouse/pull/19706) ([Ilya Yatsishin](https://github.com/qoega))。
- 統合テスト用の macros.xml の生成を容易化。dicttoxml からの過剰なログ出力を廃止。dicttoxml プロジェクトは 5 年以上活動していません。[#19697](https://github.com/ClickHouse/ClickHouse/pull/19697) ([Ilya Yatsishin](https://github.com/qoega))。
- 環境変数 `CLICKHOUSE_WATCHDOG_ENABLE` を介して watchdog を明示的に有効化または無効化できるようになりました。デフォルトでは、サーバーがターミナルに接続されていない場合に有効化されます。[#19522](https://github.com/ClickHouse/ClickHouse/pull/19522) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- arm64 上で Kafka サポートを有効にした ClickHouse のビルドが可能になりました。[#19369](https://github.com/ClickHouse/ClickHouse/pull/19369) ([filimonov](https://github.com/filimonov))。
- ssl なしで librdkafka をビルドできるようになりました。[#19337](https://github.com/ClickHouse/ClickHouse/pull/19337) ([filimonov](https://github.com/filimonov))。
- FreeBSD ビルドにおける Kafka 入力を復元。[#18924](https://github.com/ClickHouse/ClickHouse/pull/18924) ([Alexandre Snarskii](https://github.com/snar))。
- テーブル関数 `VALUES` における潜在的な nullptr 参照を修正。[#19357](https://github.com/ClickHouse/ClickHouse/pull/19357) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `arrayElement` 関数、`substring`、および `arraySum` における UBSan レポートを回避。[#19305](https://github.com/ClickHouse/ClickHouse/issues/19305) を修正。[#19287](https://github.com/ClickHouse/ClickHouse/issues/19287) を修正。これにより [#19336](https://github.com/ClickHouse/ClickHouse/issues/19336) が解決されます。[#19347](https://github.com/ClickHouse/ClickHouse/pull/19347) ([alexey-milovidov](https://github.com/alexey-milovidov))。


## ClickHouse リリース 21.1 {#clickhouse-release-211}

### ClickHouse リリース v21.1.3.32-stable, 2021-02-03 {#clickhouse-release-v211332-stable-2021-02-03}

#### バグ修正 {#bug-fix-9}


* BloomFilter インデックスのクラッシュを修正。 [#19757](https://github.com/ClickHouse/ClickHouse/issues/19757) を解決。 [#19884](https://github.com/ClickHouse/ClickHouse/pull/19884)（[Maksim Kita](https://github.com/kitaisreal)）。
* `UNION DISTINCT` サブクエリへの述語プッシュダウン時に発生していたクラッシュを修正しました。これにより [#19855](https://github.com/ClickHouse/ClickHouse/issues/19855) が解決されます。 [#19861](https://github.com/ClickHouse/ClickHouse/pull/19861) ([Amos Bird](https://github.com/amosbird))。
* UInt8 が 127 を超える値に対するフィルタリングを修正。 [#19799](https://github.com/ClickHouse/ClickHouse/pull/19799) ([Anton Popov](https://github.com/CurtizJ))。
* 以前のバージョンでは、関数 `arrayEnumerateUniq` に対して異常な引数を指定すると、クラッシュや無限ループを引き起こす可能性がありました。これにより [#19787](https://github.com/ClickHouse/ClickHouse/issues/19787) が解決されました。[#19788](https://github.com/ClickHouse/ClickHouse/pull/19788)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 算術型と文字列型の厳密な比較を行った際に発生していたスタックオーバーフローを修正しました。 [#19773](https://github.com/ClickHouse/ClickHouse/pull/19773) ([tavplubix](https://github.com/tavplubix)).
* `WHERE` または `PREWHERE` でネストされたカラム名が使用された場合に発生するクラッシュを修正しました。 [#19755](https://github.com/ClickHouse/ClickHouse/issues/19755) を修正。 [#19763](https://github.com/ClickHouse/ClickHouse/pull/19763)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `bitmapAndnot` 関数で発生するセグメンテーションフォールトを修正。 [#19668](https://github.com/ClickHouse/ClickHouse/issues/19668) に対応。 [#19713](https://github.com/ClickHouse/ClickHouse/pull/19713) ([Maksim Kita](https://github.com/kitaisreal))。
* 大きな整数を扱う一部の関数でセグメンテーションフォルトが発生する可能性があります。大きな整数は実験的な機能です。これにより [#19667](https://github.com/ClickHouse/ClickHouse/issues/19667) がクローズされます。 [#19672](https://github.com/ClickHouse/ClickHouse/pull/19672) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `LowCardinality` 引数に対する `neighbor` 関数の誤った結果を修正しました。[#10333](https://github.com/ClickHouse/ClickHouse/issues/10333) を解決。[#19617](https://github.com/ClickHouse/ClickHouse/pull/19617)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 切断後の `Connection` における `CompressedWriteBuffer` の use-after-free を修正。[#19599](https://github.com/ClickHouse/ClickHouse/pull/19599)（[Azat Khuzhin](https://github.com/azat)）。
* `DROP/DETACH TABLE table ON CLUSTER cluster SYNC` クエリがハングする可能性がある問題を修正しました。 [#19568](https://github.com/ClickHouse/ClickHouse/issues/19568) を修正。 [#19572](https://github.com/ClickHouse/ClickHouse/pull/19572)（[tavplubix](https://github.com/tavplubix)）。
* `CREATE DICTIONARY` クエリでの `id` 式を修正。 [#19571](https://github.com/ClickHouse/ClickHouse/pull/19571) ([Maksim Kita](https://github.com/kitaisreal)).
* merge&#95;tree&#95;min&#95;rows&#95;for&#95;concurrent&#95;read/merge&#95;tree&#95;min&#95;bytes&#95;for&#95;concurrent&#95;read が 0/UINT64&#95;MAX に設定されている場合に発生する SIGSEGV を修正しました。 [#19528](https://github.com/ClickHouse/ClickHouse/pull/19528) ([Azat Khuzhin](https://github.com/azat)).
* `addMonth` 関数が特定の細工された引数で呼び出された場合に、メモリ読み取り時のバッファオーバーフローが発生する可能性がありました。これにより [#19441](https://github.com/ClickHouse/ClickHouse/issues/19441) が修正されました。また [#19413](https://github.com/ClickHouse/ClickHouse/issues/19413) も修正されました。[#19472](https://github.com/ClickHouse/ClickHouse/pull/19472)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* IV として空文字列が渡された場合、encrypt/decrypt 関数で未初期化メモリの読み取りが行われる可能性がありました。これにより [#19391](https://github.com/ClickHouse/ClickHouse/issues/19391) が解決されました。 [#19397](https://github.com/ClickHouse/ClickHouse/pull/19397) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Uber H3 ライブラリにおけるバッファオーバーフローが発生する可能性のある問題を修正しました。詳細は [https://github.com/uber/h3/issues/392](https://github.com/uber/h3/issues/392) を参照してください。これにより [#19219](https://github.com/ClickHouse/ClickHouse/issues/19219) がクローズされました。 [#19383](https://github.com/ClickHouse/ClickHouse/pull/19383) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `system.parts` の `state` 列を修正（列の並び順が不正なため、この列をクエリすると `LOGICAL_ERROR` が発生していた問題を修正）。 [#19346](https://github.com/ClickHouse/ClickHouse/pull/19346) ([Azat Khuzhin](https://github.com/azat)).
* マテリアライズドビューとそのターゲットテーブルの構造が異なる場合に、集約処理で誤った結果やセグメンテーションフォールトが発生する可能性があった問題を修正しました。 [#18063](https://github.com/ClickHouse/ClickHouse/issues/18063) を修正。[#19322](https://github.com/ClickHouse/ClickHouse/pull/19322)（[tavplubix](https://github.com/tavplubix)）。
* `Cannot convert column now64() because it is constant but values of constants are different in source and result` というエラーを修正。[#7156](https://github.com/ClickHouse/ClickHouse/issues/7156) の続き。[#19316](https://github.com/ClickHouse/ClickHouse/pull/19316)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `ALTER` と `DROP` クエリが ReplicatedMergeTree テーブルの処理中に同時に実行されるとハングすることがあるバグを修正。[#19237](https://github.com/ClickHouse/ClickHouse/pull/19237) ([alesapin](https://github.com/alesapin)).
* `Template` または `CustomSeparated` フォーマットを使用して HTTP インターフェイス経由でデータを挿入する際に発生していた `There is no checkpoint` エラーを修正しました。[#19021](https://github.com/ClickHouse/ClickHouse/issues/19021) を修正。 [#19072](https://github.com/ClickHouse/ClickHouse/pull/19072)（[tavplubix](https://github.com/tavplubix)）。
* 解析段階において、結果を計算できない場合はサブクエリに対する定数畳み込みを無効化しました。 [#18446](https://github.com/ClickHouse/ClickHouse/pull/18446) ([Azat Khuzhin](https://github.com/azat)).
* `MOVE` や `REPLACE PARTITION` の後、またはまれなケースとして `DETACH` や `DROP PARTITION` の後に、ミューテーションが存在しないパーツを待ち続けてハングすることがありました。修正済みです。 [#15537](https://github.com/ClickHouse/ClickHouse/pull/15537) ([tavplubix](https://github.com/tavplubix)).

### ClickHouse リリース v21.1.2.15-stable 2021-01-18 {#clickhouse-release-v211215-stable-2021-01-18}

#### 後方互換性のない変更 {#backward-incompatible-change-10}

- 設定 `input_format_null_as_default` がデフォルトで有効になりました。[#17525](https://github.com/ClickHouse/ClickHouse/pull/17525) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 設定ファイルからのプロファイル設定に対する制約チェックを実施します。users.xml に対応する制約を満たさない設定が含まれている場合、サーバーの起動に失敗します。[#18486](https://github.com/ClickHouse/ClickHouse/pull/18486) ([tavplubix](https://github.com/tavplubix))。
- データパーツに影響を与えるストレージ設定（`write_final_mark` および `enable_mixed_granularity_parts`）を `ALTER MODIFY SETTING` で変更することを制限しました。[#18306](https://github.com/ClickHouse/ClickHouse/pull/18306) ([Amos Bird](https://github.com/amosbird))。
- `insert_quorum_parallel` をデフォルトで 1 に設定しました。これは「シーケンシャル」クォーラム挿入よりも大幅に使いやすくなっています。ただし、シーケンシャル一貫性に依存している場合は、この設定を 0 に戻す必要があります。[#17567](https://github.com/ClickHouse/ClickHouse/pull/17567) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `sumburConsistentHash` 関数を削除しました。これにより [#18120](https://github.com/ClickHouse/ClickHouse/issues/18120) がクローズされます。[#18656](https://github.com/ClickHouse/ClickHouse/pull/18656) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 集約関数 `timeSeriesGroupSum`、`timeSeriesGroupRateSum` を削除しました。これらは動作していなかったためです。これにより [#16869](https://github.com/ClickHouse/ClickHouse/issues/16869) が修正されます。これらの関数を正常に使用できていた場合は、feedback@clickhouse.com までメールでお知らせください。[#17423](https://github.com/ClickHouse/ClickHouse/pull/17423) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- toUnixTimestamp(Date()) を禁止しました（以前は Date の UInt16 表現を返していました）。[#17376](https://github.com/ClickHouse/ClickHouse/pull/17376) ([Azat Khuzhin](https://github.com/azat))。
- `avg` および `avgWeighted` 関数で拡張整数型（`Int128`、`Int256`、`UInt256`）の使用を許可しました。また、`avgWeighted` 関数で値と重みに異なる型（整数、小数、浮動小数点）を使用できるようになりました。これは後方互換性のない変更です。現在、`avg` および `avgWeighted` 関数は常に `Float64` を返します（ドキュメントに記載されている通り）。この変更以前は、`Decimal` 引数の戻り値の型も `Decimal` でした。[#15419](https://github.com/ClickHouse/ClickHouse/pull/15419) ([Mike](https://github.com/myrrc))。
- 式 `toUUID(N)` は動作しなくなりました。`toUUID('00000000-0000-0000-0000-000000000000')` に置き換えてください。この変更は、N がゼロでない場合の `toUUID(N)` の非自明な結果に起因しています。
- 不正な「key usage」を持つ SSL 証明書は拒否されます。以前のバージョンでは動作していました。詳細は [#19262](https://github.com/ClickHouse/ClickHouse/issues/19262) を参照してください。
- デフォルト設定から置換ファイル（`/etc/metrika.xml`）への `incl` 参照が削除されました（`<remote_servers>`、`<zookeeper>`、`<macros>`、`<compression>`、`<networks>`）。置換ファイルを使用していて、これらの暗黙的な参照に依存していた場合は、更新前に `incl="..."` 属性を持つ対応するセクションを追加して、手動で明示的に戻す必要があります。詳細は [#18740](https://github.com/ClickHouse/ClickHouse/pull/18740) ([alexey-milovidov](https://github.com/alexey-milovidov)) を参照してください。

#### 新機能 {#new-feature-10}


* ClickHouse に gRPC プロトコルを実装。 [#15111](https://github.com/ClickHouse/ClickHouse/pull/15111) ([Vitaly Baranov](https://github.com/vitlibar)).
* 複数の ZooKeeper クラスターの使用を可能にしました。 [#17070](https://github.com/ClickHouse/ClickHouse/pull/17070) ([fastio](https://github.com/fastio)).
* `REPLACE TABLE` および `CREATE OR REPLACE TABLE` クエリを実装しました。 [#18521](https://github.com/ClickHouse/ClickHouse/pull/18521) ([tavplubix](https://github.com/tavplubix))。
* `UNION DISTINCT` を実装し、プレーンな `UNION` 句はデフォルトで `UNION DISTINCT` として扱うようにしました。`UNION ALL` として扱う、またはモードの明示的な指定を必須にできる設定 `union_default_mode` を追加しました。[#16338](https://github.com/ClickHouse/ClickHouse/pull/16338)（[flynn](https://github.com/ucasFL)）。
* 関数 `accurateCastOrNull` を追加しました。これにより [#10290](https://github.com/ClickHouse/ClickHouse/issues/10290) がクローズされました。`x IN (subquery)` 式での型変換を追加しました。これにより [#10266](https://github.com/ClickHouse/ClickHouse/issues/10266) がクローズされました。[#16724](https://github.com/ClickHouse/ClickHouse/pull/16724)（[Maksim Kita](https://github.com/kitaisreal)）。
* IP Dictionary は `IPv4` / `IPv6` 型を直接サポートします。 [#17571](https://github.com/ClickHouse/ClickHouse/pull/17571) ([vdimir](https://github.com/vdimir))。
* IP Dictionary がキーのフェッチをサポートするようになりました。[#18241](https://github.com/ClickHouse/ClickHouse/issues/18241) を解決。[#18480](https://github.com/ClickHouse/ClickHouse/pull/18480)（[vdimir](https://github.com/vdimir)）。
* データのインポートおよびエクスポートで `*.zst` の圧縮/解凍をサポートしました。これにより、`file()` 関数で `*.zst` を使用できるようになり、HTTP クライアントで `Content-encoding: zstd` を利用できるようになります。これによって [#16791 ](https://github.com/ClickHouse/ClickHouse/issues/16791) がクローズされました。[#17144](https://github.com/ClickHouse/ClickHouse/pull/17144)（[Abi Palagashvili](https://github.com/fibersel)）。
* `mannWitneyUTest`、`studentTTest`、`welchTTest` 集約関数を追加しました。`rankCorr` を少しリファクタリングしました。 [#16883](https://github.com/ClickHouse/ClickHouse/pull/16883)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 関数 `countMatches` / `countMatchesCaseInsensitive` を追加しました。 [#17459](https://github.com/ClickHouse/ClickHouse/pull/17459) ([Azat Khuzhin](https://github.com/azat))。
* `countSubstrings()` / `countSubstringsCaseInsensitive()` / `countSubstringsCaseInsensitiveUTF8()` を実装（部分文字列の出現回数をカウント）。 [#17347](https://github.com/ClickHouse/ClickHouse/pull/17347) ([Azat Khuzhin](https://github.com/azat)).
* 使用されたデータベース、テーブル、カラムに関する情報を `system.query_log` に追加。`query_kind` および `normalized_query_hash` フィールドを追加。[#17726](https://github.com/ClickHouse/ClickHouse/pull/17726)（[Amos Bird](https://github.com/amosbird)）。
* 設定 `optimize_on_insert` を追加。有効化されている場合、INSERT されたデータブロックに対して、そのブロックに対してマージが実行された場合と同じ変換（例: Replacing、Collapsing、Aggregating など）を行います。この設定はデフォルトで有効です。これはマテリアライズドビューおよび MaterializeMySQL の動作に影響を与える可能性があります（詳細な説明を参照）。[#10683](https://github.com/ClickHouse/ClickHouse/issues/10683) をクローズ。[#16954](https://github.com/ClickHouse/ClickHouse/pull/16954)（[Kruglov Pavel](https://github.com/Avogar)）。
* HDFS 向け Kerberos 認証。[#16621](https://github.com/ClickHouse/ClickHouse/pull/16621)（[Ilya Golshtein](https://github.com/ilejn)）。
* `system.settings` のパラメータを表示するための `SHOW SETTINGS` ステートメントがサポートされました。`SHOW CHANGED SETTINGS` と `LIKE/ILIKE` 句もサポートされています。 [#18056](https://github.com/ClickHouse/ClickHouse/pull/18056) ([Jianmei Zhang](https://github.com/zhangjmruc))。
* 関数 `position` は、SQL 互換性のために `POSITION(needle IN haystack)` 構文をサポートするようになりました。これにより [#18701](https://github.com/ClickHouse/ClickHouse/issues/18701) がクローズされました。... [#18779](https://github.com/ClickHouse/ClickHouse/pull/18779)（[Jianmei Zhang](https://github.com/zhangjmruc)）。
* MergeTree ファミリーのテーブル向けに、新しいストレージ設定 `max_partitions_to_read` が追加されました。これは、1 つのクエリでアクセスできるパーティション数の最大値を制限します。この制約を必ず適用するためのユーザー設定 `force_max_partition_limit` も追加されています。[#18712](https://github.com/ClickHouse/ClickHouse/pull/18712) ([Amos Bird](https://github.com/amosbird))。
* 挿入されたパーツについて、`system.part_log` に `query_id` 列を追加しました。[#10097](https://github.com/ClickHouse/ClickHouse/issues/10097) をクローズ。[#18644](https://github.com/ClickHouse/ClickHouse/pull/18644) ([flynn](https://github.com/ucasFL))。
* `CREATE TABLE t1 (x String) ENGINE = Memory AS SELECT 1;` のように、カラム指定を伴う `CREATE TABLE AS SELECT` を許可。 [#18060](https://github.com/ClickHouse/ClickHouse/pull/18060) ([Maksim Kita](https://github.com/kitaisreal)).
* 集約関数 `arrayMin`、`arrayMax`、`arrayAvg` を追加しました。 [#18032](https://github.com/ClickHouse/ClickHouse/pull/18032) ([Maksim Kita](https://github.com/kitaisreal))。
* `ATTACH TABLE name FROM 'path/to/data/' (col1 Type1, ...` クエリを実装しました。指定された構造で新しいテーブルを作成し、`user_files` 内の指定ディレクトリからテーブルデータを関連付けます。 [#17903](https://github.com/ClickHouse/ClickHouse/pull/17903) ([tavplubix](https://github.com/tavplubix)).
* StorageMemory にミューテーションのサポートを追加。これにより [#9117](https://github.com/ClickHouse/ClickHouse/issues/9117) がクローズされます。[#15127](https://github.com/ClickHouse/ClickHouse/pull/15127) ([flynn](https://github.com/ucasFL))。
* `EXISTS DATABASE name` 構文をサポートしました。 [#18458](https://github.com/ClickHouse/ClickHouse/pull/18458) ([Du Chuan](https://github.com/spongedu)).
* MySQL と同様に、組み込み関数 `isIPv4String` および `isIPv6String` をサポート。 [ClickHouse の比較ビュー](https://github.com/ClickHouse/ClickHouse/compare/master...spongedu:support_is_ipv4?expand=1). [#18349](https://github.com/ClickHouse/ClickHouse/pull/18349) ([Du Chuan](https://github.com/spongedu)).
* 新しい設定 `insert_distributed_one_random_shard = 1` を追加し、ディストリビューテッドキーなしでマルチシャード構成のディストリビューテッドテーブルに挿入できるようにしました。 [#18294](https://github.com/ClickHouse/ClickHouse/pull/18294) ([Amos Bird](https://github.com/amosbird))。
* `min_compress_block_size` と `max_compress_block_size` 設定を MergeTreeSettings に追加しました。これらはグローバル設定よりも優先され、設定されている場合に有効になります。close [13890](https://github.com/ClickHouse/ClickHouse/issues/13890)。[#17867](https://github.com/ClickHouse/ClickHouse/pull/17867)（[flynn](https://github.com/ucasFL)）。
* 64 ビット Roaring Bitmap のサポートを追加しました。 [#17858](https://github.com/ClickHouse/ClickHouse/pull/17858) ([Andy Yang](https://github.com/andyyzh))。
* `OPTIMIZE ... DEDUPLICATE` 構文を拡張し、重複をチェックする列のリストを明示的に指定できるようにしました（または、アスタリスクやカラム変換子を用いて暗黙的に指定できるようにしました）。... [#17846](https://github.com/ClickHouse/ClickHouse/pull/17846) ([Vasily Nemkov](https://github.com/Enmk)).
* 関数 `toModifiedJulianDay`、`fromModifiedJulianDay`、`toModifiedJulianDayOrNull`、`fromModifiedJulianDayOrNull` を追加しました。これらの関数は、プロレプティック・グレゴリオ暦の日付と修正ユリウス日 (Modified Julian Day) 番号との間の相互変換を行います。 [#17750](https://github.com/ClickHouse/ClickHouse/pull/17750) ([PHO](https://github.com/depressed-pho))。
* カスタム TLD リストを使用できるようにしました: 関数 `firstSignificantSubdomainCustom`、`cutToFirstSignificantSubdomainCustom` を追加しました。 [#17748](https://github.com/ClickHouse/ClickHouse/pull/17748) ([Azat Khuzhin](https://github.com/azat)).
* ネイティブな TCP インターフェイスをラップする `PROXYv1` プロトコルのサポートを追加しました。クォータをプロキシ経由で転送された IP アドレスをキーとして設定できるようにしました（`PROXYv1` アドレスおよび HTTP インターフェイスの `X-Forwarded-For` に適用されます）。これは、信頼できるプロキシ（例: Cloudflare）経由でのみ ClickHouse へのアクセスを提供しつつ、ユーザーの元の IP アドレスごとにリソースを計上したい場合に有用です。この変更により [#17268](https://github.com/ClickHouse/ClickHouse/issues/17268) が修正されました。[#17707](https://github.com/ClickHouse/ClickHouse/pull/17707)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `clickhouse-client` でコマンド編集用に `EDITOR` を開けるようになりました。`Alt-Shift-E`。 [#17665](https://github.com/ClickHouse/ClickHouse/pull/17665) ([Amos Bird](https://github.com/amosbird))。
* 文字列を XML のテキストノードまたは属性に埋め込む際に必要な文字のエスケープを行う関数 `encodeXMLComponent` を追加。 [#17659](https://github.com/ClickHouse/ClickHouse/pull/17659) ([nauta](https://github.com/nautaa)).
* `DETACH TABLE/VIEW ... PERMANENTLY` 構文を導入しました。これにより、サーバー再起動後に、そのテーブルは明示的に要求されない限り自動的に再度利用可能な状態にはならず、短い構文の ATTACH TABLE を使って再アタッチできます。[#5555](https://github.com/ClickHouse/ClickHouse/issues/5555) を実装し、[#13850](https://github.com/ClickHouse/ClickHouse/issues/13850) を修正しました。[#17642](https://github.com/ClickHouse/ClickHouse/pull/17642)（[filimonov](https://github.com/filimonov)）。
* MergeTree テーブル内の行数、バイト数、パーツ数の合計に関する非同期メトリクスを追加。これにより [#11714](https://github.com/ClickHouse/ClickHouse/issues/11714) が修正されます。 [#17639](https://github.com/ClickHouse/ClickHouse/pull/17639)（[flynn](https://github.com/ucasFL)）。
* SQL 外でのページネーションのための設定 `limit` と `offset` を追加: [#16176](https://github.com/ClickHouse/ClickHouse/issues/16176) これらは API を構築する際に有用です。これら 2 つの設定は、`select * from (your_original_select_query) t limit xxx offset xxx;` が追加されたかのように SELECT クエリに影響します。 [#17633](https://github.com/ClickHouse/ClickHouse/pull/17633) ([hexiaoting](https://github.com/hexiaoting))。
* 新しい集約コンビネータ `-SimpleState` を追加し、クエリ経由で `SimpleAggregateFunction` 型を構築できるようにしました。これは AggregatingMergeTree エンジンのマテリアライズドビューを定義する際に有用であり、プロジェクションにも役立ちます。 [#16853](https://github.com/ClickHouse/ClickHouse/pull/16853) ([Amos Bird](https://github.com/amosbird)).
* `clickhouse-client` と `clickhouse-local` に `queries-file` パラメータを追加。 [#15930](https://github.com/ClickHouse/ClickHouse/pull/15930) ([Maksim Kita](https://github.com/kitaisreal)).
* `clickhouse-benchmark` に `query` パラメータを追加しました。 [#17832](https://github.com/ClickHouse/ClickHouse/pull/17832) ([Maksim Kita](https://github.com/kitaisreal))。
* `EXPLAIN AST` が `SELECT` 以外のクエリもサポートするようになりました。 [#18136](https://github.com/ClickHouse/ClickHouse/pull/18136) ([taiyang-li](https://github.com/taiyang-li)).

#### 実験的機能 {#experimental-feature-8}

- テキストのn-gramとshingleのminHashおよびsimHashを計算する関数を追加しました。これらは準重複検索を目的としています。また、`bitHammingDistance`および`tupleHammingDistance`関数も追加されました。[#7649](https://github.com/ClickHouse/ClickHouse/pull/7649) ([flynn](https://github.com/ucasFL))。
- 新しいデータ型`Map`を追加しました。[#1841](https://github.com/ClickHouse/ClickHouse/issues/1841)を参照してください。Mapの初期バージョンは、キーと値の`String`型のみをサポートしています。[#15806](https://github.com/ClickHouse/ClickHouse/pull/15806) ([hexiaoting](https://github.com/hexiaoting))。
- ANTLR4ランタイムに基づき、EBNF文法から生成された代替SQLパーサーを実装しました。[#11298](https://github.com/ClickHouse/ClickHouse/pull/11298) ([Ivan](https://github.com/abyss7))。

#### パフォーマンス改善 {#performance-improvement-10}


* メモリ消費を抑え、いくつかのケースでのパフォーマンスを向上させ、バグを修正した新しい IP Dictionary 実装。 [#16804](https://github.com/ClickHouse/ClickHouse/pull/16804) ([vdimir](https://github.com/vdimir)).
* データエクスポートのための並列フォーマット処理。 [#11617](https://github.com/ClickHouse/ClickHouse/pull/11617) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* LDAP 統合: LDAP サーバー接続設定に `verification_cooldown` パラメータを追加し、成功した「bind」試行を任意の期間キャッシュできるようにしました。 [#15988](https://github.com/ClickHouse/ClickHouse/pull/15988) ([Denis Glazachev](https://github.com/traceon)).
* `clickhouse-local` をシステムテーブルなしで実行できるようにする `--no-system-table` オプションを追加しました。これにより、起動時に数十ミリ秒程度の時間がかかることのある `DateLUT` の初期化を回避できます。 [#18899](https://github.com/ClickHouse/ClickHouse/pull/18899) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `windowFunnel` 関数のパフォーマンスを向上させるために、`AggregateFunctionWindowFunnelData` 内の `PODArray` を `PODArrayWithStackMemory` に置き換え。 [#18817](https://github.com/ClickHouse/ClickHouse/pull/18817) ([flynn](https://github.com/ucasFL)).
* 同期 `INSERT` による `Distributed` テーブルへの挿入時に、空のブロックをシャードへ送信しないようにしました。これにより [#14571](https://github.com/ClickHouse/ClickHouse/issues/14571) がクローズされました。 [#18775](https://github.com/ClickHouse/ClickHouse/pull/18775) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* StorageMemory の読み取りを最適化しました。 [#18052](https://github.com/ClickHouse/ClickHouse/pull/18052) ([Maksim Kita](https://github.com/kitaisreal)).
* float から文字列への変換で ryu の代わりに Dragonbox アルゴリズムを使用するよう変更しました。これにより、float から文字列への変換のパフォーマンスが大幅に向上します。 [#17831](https://github.com/ClickHouse/ClickHouse/pull/17831) ([Maksim Kita](https://github.com/kitaisreal)).
* `IPv6CIDRToRange` の実装を高速化しました。 [#17569](https://github.com/ClickHouse/ClickHouse/pull/17569) ([vdimir](https://github.com/vdimir)).
* `remerge_sort_lowered_memory_bytes_ratio` 設定を追加（再マージ後のメモリ使用量がこの比率まで減少しない場合、再マージは無効化されます）。 [#17539](https://github.com/ClickHouse/ClickHouse/pull/17539) ([Azat Khuzhin](https://github.com/azat)).
* PK 内で SimpleAggregateFunction(String) を使用する AggregatingMergeTree のパフォーマンスを改善しました。 [#17109](https://github.com/ClickHouse/ClickHouse/pull/17109) ([Azat Khuzhin](https://github.com/azat)).
* これにより `-If` コンビネーターのデバーチャル化が行われ、`count` が正しくベクトル化されました。[この PR](https://github.com/ClickHouse/ClickHouse/pull/17041) に対応しています。[#17043](https://github.com/ClickHouse/ClickHouse/pull/17043)（[Amos Bird](https://github.com/amosbird)）。
* 非常に多数の `MergeTree` テーブルにまたがる `Merge` テーブルからの読み取り性能を改善しました。[#7748](https://github.com/ClickHouse/ClickHouse/issues/7748) を修正。[#16988](https://github.com/ClickHouse/ClickHouse/pull/16988)（[Anton Popov](https://github.com/CurtizJ)）。
* 関数 `repeat` のパフォーマンスを向上しました。 [#16937](https://github.com/ClickHouse/ClickHouse/pull/16937) ([satanson](https://github.com/satanson)).
* float のパース性能をわずかに改善しました。 [#16809](https://github.com/ClickHouse/ClickHouse/pull/16809) ([Maksim Kita](https://github.com/kitaisreal)).
* `OPTIMIZE TABLE ... FINAL` において、マージ済みパーティションをスキップできるようにしました。 [#15939](https://github.com/ClickHouse/ClickHouse/pull/15939) ([Kruglov Pavel](https://github.com/Avogar)).
* 浮動小数点数をパースするために、[Daniel Lemire の fast&#95;float](https://github.com/lemire/fast_float) と統合しました。 [#16787](https://github.com/ClickHouse/ClickHouse/pull/16787) ([Maksim Kita](https://github.com/kitaisreal))。ただし、ClickHouse のラフな float パーサーと比べて依然として性能が劣るため、まだ有効化されていません。
* max&#95;distributed&#95;connections を修正（`prefer_localhost_replica = 1` および `max_threads != max_distributed_connections` に影響）。[#17848](https://github.com/ClickHouse/ClickHouse/pull/17848)（[Azat Khuzhin](https://github.com/azat)）。
* S3 にデータを送信する際に、シングルパートアップロード／マルチパートアップロードを自動的に選択するようになりました。シングルパートアップロードは、新しい設定 `max_single_part_upload_size` で制御されます。 [#17934](https://github.com/ClickHouse/ClickHouse/pull/17934) ([Pavel Kovalenko](https://github.com/Jokser))。
* `PipelineExecutor` における非同期タスクのサポート。リモートクエリ用の非同期ソケットの初期サポート。[#17868](https://github.com/ClickHouse/ClickHouse/pull/17868)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* カラムのサイズが不明な場合でも、コンパクトパーツで `optimize_move_to_prewhere` 最適化を使用できるようにしました。 [#17330](https://github.com/ClickHouse/ClickHouse/pull/17330) ([Anton Popov](https://github.com/CurtizJ))。

#### 改善 {#improvement-10}


* `TinyLog` または `Log` テーブルエンジンを使用するテーブルに対して、自身への `INSERT SELECT` を実行する際に発生するデッドロックを回避します。これにより [#6802](https://github.com/ClickHouse/ClickHouse/issues/6802) がクローズされます。これにより [#18691](https://github.com/ClickHouse/ClickHouse/issues/18691) がクローズされます。これにより [#16812](https://github.com/ClickHouse/ClickHouse/issues/16812) がクローズされます。これにより [#14570](https://github.com/ClickHouse/ClickHouse/issues/14570) がクローズされます。[#15260](https://github.com/ClickHouse/ClickHouse/pull/15260)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* [MySQL](https://dev.mysql.com/doc/refman/5.7/en/show-create-view.html) と同様に `SHOW CREATE VIEW name` 構文をサポートしました。[#18095](https://github.com/ClickHouse/ClickHouse/pull/18095) ([Du Chuan](https://github.com/spongedu))。
* `Decimal * Float` 型、またはその逆のすべてのクエリが許可されており、集約クエリ（例: `SELECT sum(decimal_field * 1.1)` や `SELECT dec_col * float_col`）も含まれます。結果の型は Float32 または Float64 です。[#18145](https://github.com/ClickHouse/ClickHouse/pull/18145)（[Mike](https://github.com/myrrc)）。
* 簡易版 Web UI を改良：履歴を追加；共有機能を追加；異なるリクエスト間のレースコンディションを回避；リクエスト処理中および完了のインジケーターを追加；favicon を追加；`textarea` にフォーカスがない場合も Ctrl+Enter を検知。 [#17293](https://github.com/ClickHouse/ClickHouse/pull/17293) [#17770](https://github.com/ClickHouse/ClickHouse/pull/17770) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* clickhouse-server が ZooKeeper サーバーに `close` リクエストを送信しませんでした。 [#16837](https://github.com/ClickHouse/ClickHouse/pull/16837) ([alesapin](https://github.com/alesapin)).
* 極端に低いメモリ制限（`max_memory_usage = 1` / `max_untracked_memory = 1`）の場合にサーバーが異常終了しないようにしました。 [#17453](https://github.com/ClickHouse/ClickHouse/pull/17453) ([Azat Khuzhin](https://github.com/azat)).
* 異なるイベントに同一のタイムスタンプがある場合における `windowFunnel` 関数の非決定的な結果を修正。 [#18884](https://github.com/ClickHouse/ClickHouse/pull/18884) ([Fuwang Hu](https://github.com/fuwhu))。
* Docker: `clickhouse-server` の Docker イメージにおいて、`clickhouse` ユーザーとグループの `uid` / `gid` を固定値 (101) に明示的に設定しました。 [#19096](https://github.com/ClickHouse/ClickHouse/pull/19096) ([filimonov](https://github.com/filimonov)).
* `Distributed` テーブルへの非同期 `INSERT`：MergeTree ファミリーと同様に、新しい設定が 2 つ追加されました。- `fsync_after_insert` - 挿入ごとに fsync を実行します。INSERT のパフォーマンスが低下します。- `fsync_directories` - すべての操作（書き込み、リネームなど）の後に、一時ディレクトリ（非同期 `INSERT` のみに使用）に対して fsync を実行します。 [#18864](https://github.com/ClickHouse/ClickHouse/pull/18864) ([Azat Khuzhin](https://github.com/azat)).
* `SYSTEM KILL` コマンドが Docker で動作するようになりました。これにより [#18847](https://github.com/ClickHouse/ClickHouse/issues/18847) がクローズされました。[#18848](https://github.com/ClickHouse/ClickHouse/pull/18848) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `FETCH PARTITION` 実行時に zk パス内のマクロを展開するようにしました。 [#18839](https://github.com/ClickHouse/ClickHouse/pull/18839) ([fastio](https://github.com/fastio))。
* これらの `ALTER` コマンドはレプリケートされないため、すべてのレプリカに対して `ALTER TABLE &lt;replicated_table&gt; ON CLUSTER MODIFY SETTING ...` を適用してください。 [#18789](https://github.com/ClickHouse/ClickHouse/pull/18789) ([Amos Bird](https://github.com/amosbird)).
* カラムトランスフォーマー `EXCEPT` で、文字列を正規表現マッチャーとして受け付けられるようにしました。これにより [#18685](https://github.com/ClickHouse/ClickHouse/issues/18685) が解決されます。 [#18699](https://github.com/ClickHouse/ClickHouse/pull/18699) ([Amos Bird](https://github.com/amosbird))。
* SummingMergeTree における SimpleAggregateFunction を修正しました。これにより、現在は AggregateFunction と同様に動作します。以前のバージョンでは、どの集計関数であるかに関係なく値が単純に合計されていました。この修正により [#18564](https://github.com/ClickHouse/ClickHouse/issues/18564)、 [#8052](https://github.com/ClickHouse/ClickHouse/issues/8052)、 [#18637](https://github.com/ClickHouse/ClickHouse/pull/18637) が解決されます（[Amos Bird](https://github.com/amosbird)）。`SummingMergeTree` における `SimpleAggregateFunction` の利用に関する別の修正です。この修正により [#18676](https://github.com/ClickHouse/ClickHouse/issues/18676)、 [#18677](https://github.com/ClickHouse/ClickHouse/pull/18677) が解決されます（[Amos Bird](https://github.com/amosbird)）。
* 関数 bar の最後の引数が NaN の場合に、アロケータ内部で発生していたアサーションエラーを修正しました。現在は単純な ClickHouse の例外がスローされます。これにより [#17876](https://github.com/ClickHouse/ClickHouse/issues/17876) が修正されました。 [#18520](https://github.com/ClickHouse/ClickHouse/pull/18520) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 一部のツールで、例外メッセージの後に改行が入らないという使い勝手の問題を修正しました。 [#18444](https://github.com/ClickHouse/ClickHouse/pull/18444) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* プライマリキーおよびパーティションキーの列型を `LowCardinality(Type)` から `Type` へ、またその逆へ変更できる機能を追加しました。さらに、プライマリキーの列型を `EnumX` から `IntX` 型へ変更できる機能を追加しました。 [#5604](https://github.com/ClickHouse/ClickHouse/issues/5604) を修正。 [#18362](https://github.com/ClickHouse/ClickHouse/pull/18362)（[alesapin](https://github.com/alesapin)）。
* `untuple` によるフィールドアクセスを実装しました。 [#18133](https://github.com/ClickHouse/ClickHouse/issues/18133). [#18309](https://github.com/ClickHouse/ClickHouse/pull/18309) ([hexiaoting](https://github.com/hexiaoting)).
* 配列がネストした CSV としてシリアライズされた配列を含む文字列として表現されている場合に、その CSV から `Array` フィールドをパースできるようにしました。例: `"[""Hello"", ""world"", ""42"""" TV""]"` は `['Hello', 'world', '42" TV']` としてパースされます。CSV 内で、外側の波括弧で囲まれていない文字列として書かれた配列もパースできるようにしました。例: `"'Hello', 'world', '42"" TV'"` は `['Hello', 'world', '42" TV']` としてパースされます。[#18271](https://github.com/ClickHouse/ClickHouse/pull/18271) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* MergeTree の wide part に対する自動調整型 granularity 計算を改善。 [#18223](https://github.com/ClickHouse/ClickHouse/pull/18223) ([alesapin](https://github.com/alesapin)).
* これで `clickhouse install` が Mac でも動作するようになりました。このプラットフォームには procfs が存在しないことが問題でした。[#18201](https://github.com/ClickHouse/ClickHouse/pull/18201) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* `SHOW ...` クエリ構文に対するヒントを改善。 [#18183](https://github.com/ClickHouse/ClickHouse/pull/18183) ([Du Chuan](https://github.com/spongedu)).
* 配列集約関数 `arrayMin`、`arrayMax`、`arraySum`、`arrayAvg` が `Int128`、`Int256`、`UInt256` をサポート。 [#18147](https://github.com/ClickHouse/ClickHouse/pull/18147) ([Maksim Kita](https://github.com/kitaisreal)).
* Set および Join のストレージ設定に `disk` を追加。[#18112](https://github.com/ClickHouse/ClickHouse/pull/18112) ([Grigory Pervakov](https://github.com/GrigoryPervakov))。
* アクセス制御: 以降は、テーブル関数 `merge()` がデータを取得する各テーブルに対して、現在のユーザーが `SELECT` 権限を持っている必要があります。この PR は [#16964](https://github.com/ClickHouse/ClickHouse/issues/16964) を修正します。 [#18104](https://github.com/ClickHouse/ClickHouse/pull/18104) [#17983](https://github.com/ClickHouse/ClickHouse/pull/17983) ([Vitaly Baranov](https://github.com/vitlibar))。
* 一時テーブルは、作成されたセッション内でのみ、システムテーブル `system.tables` および `system.columns` に表示されるようになりました。内部データベース `_temporary_and_external_tables` はこれらのシステムテーブルから非表示となり、その代わりに一時テーブルは、データベース名が空で `is_temporary` フラグが設定されたテーブルとして表示されるようになりました。 [#18014](https://github.com/ClickHouse/ClickHouse/pull/18014) ([Vitaly Baranov](https://github.com/vitlibar))。
* ターミナルウィンドウのサイズ変更時に発生する clickhouse-client の表示上の問題を修正。 [#18009](https://github.com/ClickHouse/ClickHouse/pull/18009) ([Amos Bird](https://github.com/amosbird))。
* クライアントが接続を切断した際のイベントについて、ログ出力レベルを Warning から Information に引き下げました。 [#18005](https://github.com/ClickHouse/ClickHouse/pull/18005) ([filimonov](https://github.com/filimonov)).
* DiskS3 用に、ファイルシステムから空または不正なメタデータファイルを強制的に削除するようにしました。S3 は実験的な機能です。 [#17935](https://github.com/ClickHouse/ClickHouse/pull/17935) ([Pavel Kovalenko](https://github.com/Jokser))。
* アクセス制御: `allow_introspection_functions=0` はイントロスペクション関数の使用を禁止しますが、それらに対する権限付与を禁止しなくなりました（被付与者がその権限を実際に利用できるようにするには、自身で `allow_introspection_functions=1` を設定する必要があります）。同様に、`allow_ddl=0` は DDL コマンドの使用を禁止しますが、それらに対する権限付与を禁止しなくなりました。 [#17908](https://github.com/ClickHouse/ClickHouse/pull/17908) ([Vitaly Baranov](https://github.com/vitlibar)).
* ユーザビリティの向上: カラム名のヒント。 [#17112](https://github.com/ClickHouse/ClickHouse/issues/17112)。 [#17857](https://github.com/ClickHouse/ClickHouse/pull/17857) ([fastio](https://github.com/fastio))。
* 2 つのマージテーブルが互いのデータを読み取ろうとする場合に、診断情報を追加。 [#17854](https://github.com/ClickHouse/ClickHouse/pull/17854) ([徐炘](https://github.com/weeds085490)).
* ClickHouse の Docker イメージを使用してスクリプトを実行する際に、タイムアウト値を上書きできるようにしました。 [#17818](https://github.com/ClickHouse/ClickHouse/pull/17818) ([Guillaume Tassery](https://github.com/YiuRULE))。
* システムログテーブルのエンジン定義の構文をチェックし、いくつかの設定ミスを防ぎます。この構文チェックは意味解析までは行わないため、存在しないカラムや式関数といった誤りは、テーブルが実際に作成されるまで検出されません。[#17739](https://github.com/ClickHouse/ClickHouse/pull/17739)（[Du Chuan](https://github.com/spongedu)）。
* 接続がない場合に `RabbitMQ` テーブル初期化時に例外をスローしていた挙動を削除しました（バックグラウンドで再接続が行われるようになりました）。 [#17709](https://github.com/ClickHouse/ClickHouse/pull/17709) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Buffer のフラッシュ中にサーバーのメモリ制限が無視されないようにしました。 [#17646](https://github.com/ClickHouse/ClickHouse/pull/17646) ([Azat Khuzhin](https://github.com/azat)).
* use-after-free エラーを修正するため、RocksDB をパッチ適用済みバージョン（ClickHouse-Extras 由来）に切り替えました。 [#17643](https://github.com/ClickHouse/ClickHouse/pull/17643) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 並列パース時の例外メッセージにオフセット情報を追加しました。これにより [#17457](https://github.com/ClickHouse/ClickHouse/issues/17457) が修正されました。 [#17641](https://github.com/ClickHouse/ClickHouse/pull/17641) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* INSERT クエリの途中で「Too many parts」エラーをスローしないようにする。 [#17566](https://github.com/ClickHouse/ClickHouse/pull/17566) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* ALTER クエリの UPDATE 文でクエリパラメータを使用できるようにしました。 [#10976](https://github.com/ClickHouse/ClickHouse/issues/10976) を修正。 [#17563](https://github.com/ClickHouse/ClickHouse/pull/17563)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* クエリ難読化機能：識別子名として一部の SQL キーワードが使用されないように回避。 [#17526](https://github.com/ClickHouse/ClickHouse/pull/17526) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `DDLWorker` が実行した DDL エントリの現在の最大値をサーバーメトリクスとしてエクスポートします。これにより、`DDLWorker` がどこかでハングしていないかを確認しやすくなります。 [#17464](https://github.com/ClickHouse/ClickHouse/pull/17464) ([Amos Bird](https://github.com/amosbird))。
* すべてのサーバー上の現在のスレッドについて、非同期メトリクスをエクスポートします。[この](https://github.com/ClickHouse-Extras/poco/pull/28)ような問題の追跡に役立ちます。[#17463](https://github.com/ClickHouse/ClickHouse/pull/17463)（[Amos Bird](https://github.com/amosbird)）。
* 設定 `asterisk_include_materialized_columns` と `asterisk_include_alias_columns` が有効な場合、ワイルドカードクエリに MATERIALIZED / ALIAS などの動的カラムを含めるようにしました。 [#17462](https://github.com/ClickHouse/ClickHouse/pull/17462) ([Ken Chen](https://github.com/chenziliang)).
* `config.xml` の `<ttl>` 属性を使用して [TTL](/engines/table-engines/mergetree-family/mergetree/#mergetree-table-ttl) を指定し、[system log tables](/operations/system-tables/) から古いエントリを削除できるようにしました。 [#17438](https://github.com/ClickHouse/ClickHouse/pull/17438) ([Du Chuan](https://github.com/spongedu))。
* 今後は、MySQL および PostgreSQL プロトコル経由でサーバーに送られるクエリには、それぞれ固有のインターフェース種別が割り当てられます（テーブル `system.query_log` の `interface` 列で確認できます）。MySQL には `4`、PostgreSQL には `5` が使用され、以前使用されていた `1` はネイティブプロトコル専用として使用されるようになりました。[#17437](https://github.com/ClickHouse/ClickHouse/pull/17437)（[Vitaly Baranov](https://github.com/vitlibar)）。
* `INSERT ... SELECT ... SETTINGS` クエリの `SETTINGS` 句の解析を修正。[#17414](https://github.com/ClickHouse/ClickHouse/pull/17414)（[Azat Khuzhin](https://github.com/azat)）。
* RadixSort におけるメモリの計上を正しく行うようにしました。 [#17412](https://github.com/ClickHouse/ClickHouse/pull/17412) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* サーバーの `receiveHello` に EOF チェックを追加し、`Attempt to read after eof` 例外が発生しないようにしました。 [#17365](https://github.com/ClickHouse/ClickHouse/pull/17365) ([Kruglov Pavel](https://github.com/Avogar)).
* bigint 変換時に発生し得るスタックオーバーフローを回避しました。ビッグインテジャーは実験的機能です。 [#17269](https://github.com/ClickHouse/ClickHouse/pull/17269) ([flynn](https://github.com/ucasFL)).
* `set` インデックスが `GLOBAL IN` でも動作するようになりました。これにより [#17232](https://github.com/ClickHouse/ClickHouse/issues/17232) と [#5576](https://github.com/ClickHouse/ClickHouse/issues/5576) が修正されました。 [#17253](https://github.com/ClickHouse/ClickHouse/pull/17253)（[Amos Bird](https://github.com/amosbird)）。
* S3 ストレージへのリクエストに対する HTTP リダイレクト回数の上限を追加しました（`s3_max_redirects`）。 [#17220](https://github.com/ClickHouse/ClickHouse/pull/17220) ([ianton-ru](https://github.com/ianton-ru)).
* `-OrNull` コンビネータを `-If`、`-Merge`、`-MergeState`、`-State` コンビネータと組み合わせて使用する場合は、`-OrNull` を先頭に付ける必要があります。 [#16935](https://github.com/ClickHouse/ClickHouse/pull/16935) ([flynn](https://github.com/ucasFL))。
* HTTP プロキシおよび HTTPS S3 エンドポイントの構成をサポートしました。 [#16861](https://github.com/ClickHouse/ClickHouse/pull/16861) ([Pavel Kovalenko](https://github.com/Jokser)).
* S3 クライアントに、環境変数、`~/.aws`、および `AssumeRole` を利用した適切な認証を追加しました。 [#16856](https://github.com/ClickHouse/ClickHouse/pull/16856) ([Vladimir Chebotarev](https://github.com/excitoon)).
* OpenTelemetry のスパンをさらに追加。スパンデータを Zipkin にエクスポートする方法の例を追加。 [#16535](https://github.com/ClickHouse/ClickHouse/pull/16535) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Cache dictionaries: 取得時のコールバックとロックを完全に廃止しました。キーは「not found」と「expired」に分けず、クエリ実行中は同じマップ内に保存されます。 [#14958](https://github.com/ClickHouse/ClickHouse/pull/14958) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* `fsync_part_directory`/`fsync_after_insert`/`in_memory_parts_insert_sync`（実験的機能）が正しく動作していなかった問題を修正しました。 [#18845](https://github.com/ClickHouse/ClickHouse/pull/18845) ([Azat Khuzhin](https://github.com/azat)).
* `MaterializeMySQL` エンジンの入れ子になったデータベースで `Atomic` エンジンを使用できるようにしました。 [#14849](https://github.com/ClickHouse/ClickHouse/pull/14849) ([tavplubix](https://github.com/tavplubix)).

#### バグ修正 {#bug-fix-10}


* 非常にまれなケースでサーバーが接続を受け付けなくなる問題を修正しました。 [#17542](https://github.com/ClickHouse/ClickHouse/pull/17542) (Amos Bird, [alexey-milovidov](https://github.com/alexey-milovidov)).
* 定数引数を持つ二項関数のインデックス解析を修正し、誤ったクエリ結果が返される問題を解消しました。これにより [#18364](https://github.com/ClickHouse/ClickHouse/issues/18364) が修正されました。 [#18373](https://github.com/ClickHouse/ClickHouse/pull/18373) ([Amos Bird](https://github.com/amosbird))。
* インデックス比較の型が異なる場合に誤ったインデックス解析が行われる可能性がある問題を修正しました。これにより、[#17122](https://github.com/ClickHouse/ClickHouse/issues/17122) が修正されます。[#17145](https://github.com/ClickHouse/ClickHouse/pull/17145)（[Amos Bird](https://github.com/amosbird)）。
* マージ時の AIO を用いた書き込みを無効化しました。これは、マージ中にプライマリキー列で極めてまれにデータ破損が発生する可能性があるためです。 [#18481](https://github.com/ClickHouse/ClickHouse/pull/18481) ([alesapin](https://github.com/alesapin)).
* ワイドパーツからコンパクトパーツへのマージを制限しました。垂直マージの場合に結果のパーツが壊れてしまう問題がありました。[#18381](https://github.com/ClickHouse/ClickHouse/pull/18381) ([Anton Popov](https://github.com/CurtizJ)).
* `MergeTree*` からの読み取り時に、リードバックオフ（ログ内のメッセージ `<Debug> MergeTreeReadPool: Will lower number of threads`）が発生した場合に、クエリ結果が不完全になる可能性がある問題を修正。[#16423](https://github.com/ClickHouse/ClickHouse/issues/16423) で導入された不具合。[#18137](https://github.com/ClickHouse/ClickHouse/issues/18137) を修正。[#18216](https://github.com/ClickHouse/ClickHouse/pull/18216)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `rocksdb` ライブラリにおける use-after-free バグを修正。 [#18862](https://github.com/ClickHouse/ClickHouse/pull/18862) ([sundyli](https://github.com/sundy-li)).
* `ORC` 形式のファイルからの無限読み取りが発生する問題を修正（[#10580](https://github.com/ClickHouse/ClickHouse/issues/10580) で導入された問題）。[#19095](https://github.com/ClickHouse/ClickHouse/issues/19095) を修正。[#19134](https://github.com/ClickHouse/ClickHouse/pull/19134)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 固定グラニュラリティサイズよりも大きいサイズのマークが生成されてしまう可能性があった MergeTree データライターのバグを修正しました。 [#18913](https://github.com/ClickHouse/ClickHouse/issues/18913) を修正。 [#19123](https://github.com/ClickHouse/ClickHouse/pull/19123)（[alesapin](https://github.com/alesapin)）。
* `LowCardinality(Nullable(...))` から圧縮コーデックを読み取れず、`Attempt to read after EOF` という例外をスローしていた起動時のバグを修正しました。[#18340](https://github.com/ClickHouse/ClickHouse/issues/18340) を解決。[#19101](https://github.com/ClickHouse/ClickHouse/pull/19101)（[alesapin](https://github.com/alesapin)）。
* 古い構文で作成された `MergeTree` テーブルに対する `MODIFY TTL` クエリを禁止しました。以前はクエリ自体は成功していましたが、実際には何の効果もありませんでした。 [#19064](https://github.com/ClickHouse/ClickHouse/pull/19064) ([Anton Popov](https://github.com/CurtizJ)).
* Enum 型の引数に対して `groupUniqArray` が正しい型を返すようにしました。これにより [#17875](https://github.com/ClickHouse/ClickHouse/issues/17875) がクローズされます。[#19019](https://github.com/ClickHouse/ClickHouse/pull/19019)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 関数 `ignore` を `LowCardinality` 引数とともに使用した場合に発生しうる `Expected single dictionary argument for function` エラーを修正。[#14275](https://github.com/ClickHouse/ClickHouse/issues/14275) を解決。 [#19016](https://github.com/ClickHouse/ClickHouse/pull/19016)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `TinyLog` エンジンを使用するテーブルへの `LowCardinality` 列の挿入処理を修正しました。 [#18629](https://github.com/ClickHouse/ClickHouse/issues/18629) を修正します。 [#19010](https://github.com/ClickHouse/ClickHouse/pull/19010) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `JOIN` が `const` 列をマテリアライズしようとしますが、こちらのコードはそれらが別の場所にあることを前提としています。 [#18982](https://github.com/ClickHouse/ClickHouse/pull/18982) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* `optimize_move_functions_out_of_any` を無効化しました。この最適化は常に正しいとは限らないためです。これにより [#18051](https://github.com/ClickHouse/ClickHouse/issues/18051) がクローズされます。[#18973](https://github.com/ClickHouse/ClickHouse/issues/18973) もクローズされます。[#18981](https://github.com/ClickHouse/ClickHouse/pull/18981)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* クエリプランの `Expression` ステップのマージによって発生し得る例外 `QueryPipeline stream: different number of columns` を修正しました。[#18190](https://github.com/ClickHouse/ClickHouse/issues/18190) を解決。[#18980](https://github.com/ClickHouse/ClickHouse/pull/18980)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* シャットダウン時にごくまれに発生するデッドロックを修正しました。 [#18977](https://github.com/ClickHouse/ClickHouse/pull/18977) ([tavplubix](https://github.com/tavplubix)).
* `ALTER TABLE ... DROP PART 'part_name'` クエリによって、パーティション全体の重複排除ブロックがすべて削除されてしまう不正な動作を修正しました。 [#18874](https://github.com/ClickHouse/ClickHouse/issues/18874) を修正。 [#18969](https://github.com/ClickHouse/ClickHouse/pull/18969)（[alesapin](https://github.com/alesapin)）。
* Attach partition はミューテーションをリセットすべきです。[#18804](https://github.com/ClickHouse/ClickHouse/issues/18804)。[#18935](https://github.com/ClickHouse/ClickHouse/pull/18935)（[fastio](https://github.com/fastio)）。
* `bitmapOrCardinality` に起因して発生し得る nullptr デリファレンスの問題を修正しました。これにより [#18911](https://github.com/ClickHouse/ClickHouse/issues/18911) がクローズされます。[#18912](https://github.com/ClickHouse/ClickHouse/pull/18912)（[sundyli](https://github.com/sundy-li)）。
* `clickhouse-local` のシャットダウン時に発生する可能性のあったハングを修正しました。これにより [#18891](https://github.com/ClickHouse/ClickHouse/issues/18891) が解決されます。 [#18893](https://github.com/ClickHouse/ClickHouse/pull/18893) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `x IN table` という形式の式が含まれている場合、外部データベース (MySQL, ODBC, JDBC) 向けのクエリが誤って書き換えられていました。これにより [#9756](https://github.com/ClickHouse/ClickHouse/issues/9756) が修正されました。 [#18876](https://github.com/ClickHouse/ClickHouse/pull/18876) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `Nullable` 型を扱う単項関数での `If` コンビネータを修正。 [#18806](https://github.com/ClickHouse/ClickHouse/pull/18806) ([Azat Khuzhin](https://github.com/azat))。
* 設定 `network_compression_method` がグローバルにデフォルト以外の値に設定されている場合に、非同期分散 INSERT がサーバーによって拒否され得る問題を修正しました。これにより [#18741](https://github.com/ClickHouse/ClickHouse/issues/18741) が解決されました。 [#18776](https://github.com/ClickHouse/ClickHouse/pull/18776)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `Nullable(String)` から `Nullable(Decimal(P, S))` へ `CAST` しようとした際に発生していた `Attempt to read after eof` エラーを修正しました。`CAST` 関数は、nullable な文字列から小数をパースできない場合に `NULL` を返すようになりました。[#7690](https://github.com/ClickHouse/ClickHouse/issues/7690) を修正。[#18718](https://github.com/ClickHouse/ClickHouse/pull/18718)（[Winter Zhang](https://github.com/zhang2014)）。
* ログ出力に関する軽微な問題を修正。 [#18717](https://github.com/ClickHouse/ClickHouse/pull/18717) ([sundyli](https://github.com/sundy-li)).
* 古い構文で作成された `ReplicatedMergeTree` テーブルで、空のパーツを削除できない問題を修正。 [#18582](https://github.com/ClickHouse/ClickHouse/issues/18582) を修正。 [#18614](https://github.com/ClickHouse/ClickHouse/pull/18614)（[Anton Popov](https://github.com/CurtizJ)）。
* 異なる値で日付がオーバーフローしていた以前のバグを修正しました。`Date` 型の値の上限を厳密に「2106-02-07」とし、「2106-02-07」より大きい日付は値 0 にキャストするようにしました。 [#18565](https://github.com/ClickHouse/ClickHouse/pull/18565) ([hexiaoting](https://github.com/hexiaoting)).
* MySQL からのレプリケーションで FixedString データ型をサポート。MySQL からのレプリケーションは実験的機能です。このパッチは [#18450](https://github.com/ClickHouse/ClickHouse/issues/18450) を修正し、[#6556](https://github.com/ClickHouse/ClickHouse/issues/6556) も修正します。 [#18553](https://github.com/ClickHouse/ClickHouse/pull/18553) ([awesomeleo](https://github.com/awesomeleo)).
* `RIGHT` または `FULL` join を含むサブクエリの後で `ORDER BY` を使用した際に発生する可能性のある `Pipeline stuck` エラーを修正しました。 [#18550](https://github.com/ClickHouse/ClickHouse/pull/18550) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 対応する mutation の kill 後に `ALTER` クエリがハングする可能性のあるバグを修正。thread fuzzer により発見。[#18518](https://github.com/ClickHouse/ClickHouse/pull/18518) ([alesapin](https://github.com/alesapin)).
* `parseDateTimeBestEffort` 関数で午前12時 (`12AM`) を正しくサポート。これにより [#18402](https://github.com/ClickHouse/ClickHouse/issues/18402) が修正されました。 [#18449](https://github.com/ClickHouse/ClickHouse/pull/18449) ([vladimir-golovchenko](https://github.com/vladimir-golovchenko))。
* `Nullable(String)` 型の引数に対して `toType(...)` 関数（`toDate`、`toUInt32` など）を実行した際に発生していた `value is too short` エラーを修正しました。これらの関数は、パースエラー時に例外をスローするのではなく `NULL` を返すようになりました。 [#7673](https://github.com/ClickHouse/ClickHouse/issues/7673) を修正。 [#18445](https://github.com/ClickHouse/ClickHouse/pull/18445)（[tavplubix](https://github.com/tavplubix)）。
* `SHOW TABLES` の想定外の動作を修正。 [#18431](https://github.com/ClickHouse/ClickHouse/pull/18431) ([fastio](https://github.com/fastio)).
* 修正 -SimpleState コンビネータが互換性のない引数型と戻り値型を生成していた問題を修正。 [#18404](https://github.com/ClickHouse/ClickHouse/pull/18404) ([Amos Bird](https://github.com/amosbird)).
* `Set` および `Join` テーブルの同時利用と `system.tables` からの SELECT の併用時に発生しうる競合状態を修正。 [#18385](https://github.com/ClickHouse/ClickHouse/pull/18385) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* テーブル `system.settings_profile_elements` のデータ挿入処理を修正。 このPRは [#18231](https://github.com/ClickHouse/ClickHouse/issues/18231) を修正します。 [#18379](https://github.com/ClickHouse/ClickHouse/pull/18379)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 二段階集約を使用している際に、`Distinct` コンビネータを持つ集約関数で発生しうるクラッシュを修正。[#17682](https://github.com/ClickHouse/ClickHouse/issues/17682) を修正。[#18365](https://github.com/ClickHouse/ClickHouse/pull/18365)（[Anton Popov](https://github.com/CurtizJ)）。
* デュアルスタック IPv4/IPv6 を持つマシン上で、サーバーから `clickhouse-odbc-bridge` プロセスに到達できなくなる問題を修正しました。ODBC 辞書の更新が不正なクエリで実行される、または odbc-bridge プロセスのクラッシュを引き起こす問題を修正しました。おそらく [#14489](https://github.com/ClickHouse/ClickHouse/issues/14489) をクローズします。 [#18278](https://github.com/ClickHouse/ClickHouse/pull/18278) ([Denis Glazachev](https://github.com/traceon))。
* アクセス制御: ユーザーがテーブル内の少なくとも 1 列に対するアクセス権を持っている場合、`SELECT count() FROM table` を実行できるようになりました。この PR により [#10639](https://github.com/ClickHouse/ClickHouse/issues/10639) が修正されました。 [#18233](https://github.com/ClickHouse/ClickHouse/pull/18233)（[Vitaly Baranov](https://github.com/vitlibar)）。
* アクセス制御: `SELECT JOIN` には、結合される各テーブルに対する `SELECT` 権限が必要になりました。この PR は [#17654](https://github.com/ClickHouse/ClickHouse/issues/17654) を修正します。 [#18232](https://github.com/ClickHouse/ClickHouse/pull/18232)（[Vitaly Baranov](https://github.com/vitlibar)）。
* Enum 型と Int 型の間のキー比較を修正しました。これにより [#17989](https://github.com/ClickHouse/ClickHouse/issues/17989) が解決されます。[#18214](https://github.com/ClickHouse/ClickHouse/pull/18214)（[Amos Bird](https://github.com/amosbird)）。
* MySQL からのレプリケーション（実験的機能）。[#18186](https://github.com/ClickHouse/ClickHouse/issues/18186) を修正。[#16372](https://github.com/ClickHouse/ClickHouse/issues/16372) を修正。MaterializeMySQL データベースエンジンにおけるユニークキー変換の問題を修正。[#18211](https://github.com/ClickHouse/ClickHouse/pull/18211)（[Winter Zhang](https://github.com/zhang2014)）。
* `WITH FILL` と `WITH TIES` を両方含むクエリにおける動作の不整合を修正しました [#17466](https://github.com/ClickHouse/ClickHouse/issues/17466)。[#18188](https://github.com/ClickHouse/ClickHouse/pull/18188)（[hexiaoting](https://github.com/hexiaoting)）。
* 最後の列でパースエラーが発生した場合に、デフォルト値の行を挿入できるように修正。[#17712](https://github.com/ClickHouse/ClickHouse/issues/17712) を修正。[#18182](https://github.com/ClickHouse/ClickHouse/pull/18182)（[Jianmei Zhang](https://github.com/zhangjmruc)）。
* 設定プロファイルを設定しようとした際に発生していた `Unknown setting profile` エラーを修正。[#18167](https://github.com/ClickHouse/ClickHouse/pull/18167)（[tavplubix](https://github.com/tavplubix)）。
* クエリ `MODIFY COLUMN ... REMOVE TTL` が実際にはカラムの TTL を削除しない不具合を修正。 [#18130](https://github.com/ClickHouse/ClickHouse/pull/18130) ([alesapin](https://github.com/alesapin))。
* S3 URL のパース時に発生していた `std::out_of_range: basic_string` を修正しました。 [#18059](https://github.com/ClickHouse/ClickHouse/pull/18059) ([Vladimir Chebotarev](https://github.com/excitoon)).
* `DateTime64` と `Date` の比較処理を修正。[#13804](https://github.com/ClickHouse/ClickHouse/issues/13804) および [#11222](https://github.com/ClickHouse/ClickHouse/issues/11222) を解決。... [#18050](https://github.com/ClickHouse/ClickHouse/pull/18050)（[Vasily Nemkov](https://github.com/Enmk)）。
* MySQL からのレプリケーション（実験的機能）：[#15187](https://github.com/ClickHouse/ClickHouse/issues/15187) を修正し、[#17912](https://github.com/ClickHouse/ClickHouse/issues/17912) を修正、MaterializeMySQL 向けの MySQL プレフィックスインデックス変換をサポートしました。[#17944](https://github.com/ClickHouse/ClickHouse/pull/17944)（[Winter Zhang](https://github.com/zhang2014)）。
* `logger.size` パラメータに 2^32 より大きい数値を設定してサーバーログのローテーションを設定した場合、ログが正しくローテーションされていませんでした。この問題を修正しました。 [#17905](https://github.com/ClickHouse/ClickHouse/pull/17905) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* クエリに ARRAY JOIN が含まれている場合（つまりクエリが実際には自明ではない場合）、単純なクエリ最適化によって誤った結果が生成されていました。 [#17887](https://github.com/ClickHouse/ClickHouse/pull/17887) ([sundyli](https://github.com/sundy-li)).
* `topK` 集約関数で発生する可能性のあったセグメンテーションフォルトを修正しました。これにより [#17404](https://github.com/ClickHouse/ClickHouse/issues/17404) がクローズされます。[#17845](https://github.com/ClickHouse/ClickHouse/pull/17845)（[Maksim Kita](https://github.com/kitaisreal)）。
* WAL（実験的機能）：`in_memory_parts_enable_wal` が無効化されている場合、WAL からパーツを復元しないようにしました。 [#17802](https://github.com/ClickHouse/ClickHouse/pull/17802) ([detailyang](https://github.com/detailyang))。
* 削除対象テーブルの最大サイズに関する例外メッセージが正しく表示されていませんでした。 [#17764](https://github.com/ClickHouse/ClickHouse/pull/17764) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `Distributed` テーブルへの挿入時に空き領域が不足している場合に発生する可能性があったセグメンテーションフォルトを修正しました。 [#17737](https://github.com/ClickHouse/ClickHouse/pull/17737) ([tavplubix](https://github.com/tavplubix)).
* ClickHouse が MySQL サーバーへの接続を再開できない不具合を修正。 [#17681](https://github.com/ClickHouse/ClickHouse/pull/17681) ([Alexander Kazakov](https://github.com/Akazz)).
* Windows: Windows Subsystem for Linux 上で ClickHouse を実行している場合に、`Atomic` データベースで `RENAME` クエリを実行すると発生していた `Function not implemented` エラーを修正しました。[#17661](https://github.com/ClickHouse/ClickHouse/issues/17661) の修正。[#17664](https://github.com/ClickHouse/ClickHouse/pull/17664)（[tavplubix](https://github.com/tavplubix)）。
* `pool_size` &gt; 1 のときのレースコンディションにより、`ON CLUSTER` クエリの実行時にクラスタが循環（クロス）レプリケーションされているかどうかが誤って判定される場合がありました。これは修正されました。 [#17640](https://github.com/ClickHouse/ClickHouse/pull/17640) ([tavplubix](https://github.com/tavplubix))。
* サーバーがデーモンモードで動作しているときに `system.stack_trace` テーブルが空になってしまう問題を修正。 [#17630](https://github.com/ClickHouse/ClickHouse/pull/17630) ([Amos Bird](https://github.com/amosbird))。
* MergeTree テーブルでバックグラウンドにおいて `fmt::v7::format_error` 例外をログに記録できるようになりました。これにより [#17613](https://github.com/ClickHouse/ClickHouse/issues/17613) が修正されました。 [#17615](https://github.com/ClickHouse/ClickHouse/pull/17615) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `clickhouse-client` を対話モードで複数行クエリとともに使用した場合、単一行コメントが誤ってクエリの終わりまで拡張されていました。これにより [#13654](https://github.com/ClickHouse/ClickHouse/issues/13654) が修正されました。[#17565](https://github.com/ClickHouse/ClickHouse/pull/17565)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 異なるレプリカ上で対応する `mutation` が `KILL` された場合に `ALTER` クエリがハングする問題を修正。 [#16953](https://github.com/ClickHouse/ClickHouse/issues/16953) を解決。 [#17499](https://github.com/ClickHouse/ClickHouse/pull/17499)（[alesapin](https://github.com/alesapin)）。
* ClickHouse による mark cache サイズの見積もりが小さすぎた場合のメモリ計上の問題を修正しました。これは、mark を含む非常に小さいファイルが多数存在する場合に発生することがあります。 [#17496](https://github.com/ClickHouse/ClickHouse/pull/17496) ([alesapin](https://github.com/alesapin))。
* 設定 `optimize_redundant_functions_in_order_by` 有効時の `ORDER BY` の動作を修正。 [#17471](https://github.com/ClickHouse/ClickHouse/pull/17471) ([Anton Popov](https://github.com/CurtizJ)).
* 誤った最適化により `DISTINCT` 後に発生し得た重複を修正しました。 [#17294](https://github.com/ClickHouse/ClickHouse/issues/17294) を修正。 [#17296](https://github.com/ClickHouse/ClickHouse/pull/17296)（[li chengxiang](https://github.com/chengxianglibra)）。 [#17439](https://github.com/ClickHouse/ClickHouse/pull/17439)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* *MergeTree テーブルのバックグラウンドタスクにおける高い CPU 使用率の問題を修正。 [#17416](https://github.com/ClickHouse/ClickHouse/pull/17416) ([tavplubix](https://github.com/tavplubix))。
* `LowCardinality` 型を含む `JOIN` テーブルからの読み取り時に発生し得るクラッシュを修正しました。[#17228](https://github.com/ClickHouse/ClickHouse/issues/17228) を解決。[#17397](https://github.com/ClickHouse/ClickHouse/pull/17397)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* MySQL からのレプリケーション（実験的機能）：MySQL の SHOW ステートメントとのヘッダー不一致を修正。[#16835](https://github.com/ClickHouse/ClickHouse/issues/16835)、[#17366](https://github.com/ClickHouse/ClickHouse/pull/17366)（[Winter Zhang](https://github.com/zhang2014)）。
* 述語オプティマイザでの非決定的関数の扱いを修正しました。これにより [#17244](https://github.com/ClickHouse/ClickHouse/issues/17244) が解決されます。[#17273](https://github.com/ClickHouse/ClickHouse/pull/17273)（[Winter Zhang](https://github.com/zhang2014)）。
* `LIMIT` を含む Distributed クエリで発生する可能性のある `Unexpected packet Data received from client` エラーを修正しました。 [#17254](https://github.com/ClickHouse/ClickHouse/pull/17254) ([Azat Khuzhin](https://github.com/azat))。
* サブクエリ内に `const` 列が存在する場合の set インデックスの不正な無効化を修正しました。これにより [#17246](https://github.com/ClickHouse/ClickHouse/issues/17246) が修正されます。[#17249](https://github.com/ClickHouse/ClickHouse/pull/17249)（[Amos Bird](https://github.com/amosbird)）。
* clickhouse-copier: 非パーティション化テーブル向けの修正 [#15235](https://github.com/ClickHouse/ClickHouse/issues/15235)。 [#17248](https://github.com/ClickHouse/ClickHouse/pull/17248) ([Qi Chen](https://github.com/kaka11chen))。
* S3 ディスク上に保存されたパーツに対して、動作しない可能性があったミューテーションを修正しました（実験的機能）。 [#17227](https://github.com/ClickHouse/ClickHouse/pull/17227) ([Pavel Kovalenko](https://github.com/Jokser))。
* `fuzzBits` 関数のバグ修正。関連する issue: [#16980](https://github.com/ClickHouse/ClickHouse/issues/16980)。[#17051](https://github.com/ClickHouse/ClickHouse/pull/17051)（[hexiaoting](https://github.com/hexiaoting)）。
* `OFFSET` のみを含むクエリに対して `optimize_distributed_group_by_sharding_key` を修正しました。 [#16996](https://github.com/ClickHouse/ClickHouse/pull/16996) ([Azat Khuzhin](https://github.com/azat)).
* `Distributed` テーブルに対する `Merge` テーブルからの JOIN を含むクエリを修正。 [#16993](https://github.com/ClickHouse/ClickHouse/pull/16993) ([Azat Khuzhin](https://github.com/azat)).
* 単調関数を用いた `ORDER BY` の最適化を修正しました。[#16107](https://github.com/ClickHouse/ClickHouse/issues/16107) を修正。[#16956](https://github.com/ClickHouse/ClickHouse/pull/16956)（[Anton Popov](https://github.com/CurtizJ)）。
* 異なるスケールを持つ `DateTime64` 型同士の誤った比較処理を修正。[#16655](https://github.com/ClickHouse/ClickHouse/issues/16655) ... [#16952](https://github.com/ClickHouse/ClickHouse/pull/16952) を修正（[Vasily Nemkov](https://github.com/Enmk)）。
* `optimize_aggregators_of_group_by_keys` 設定を有効にした場合の `GROUP BY` と `JOIN` の最適化を修正しました。 [#12604](https://github.com/ClickHouse/ClickHouse/issues/12604) を修正します。 [#16951](https://github.com/ClickHouse/ClickHouse/pull/16951) ([Anton Popov](https://github.com/CurtizJ))。
* SHOW ACCESS クエリの細かな修正。 [#16866](https://github.com/ClickHouse/ClickHouse/pull/16866) ([tavplubix](https://github.com/tavplubix))。
* パーティション述語を伴う場合に `optimize_trivial_count_query` 設定を有効化した際の動作を修正しました。 [#16767](https://github.com/ClickHouse/ClickHouse/pull/16767) ([Azat Khuzhin](https://github.com/azat)).
* MySQL ワイヤープロトコル経由の INSERT クエリに対して、影響を受けた行数を返すようにしました。以前の ClickHouse は常に 0 を返していましたが、これを修正しました。[#16605](https://github.com/ClickHouse/ClickHouse/issues/16605) を修正。[#16715](https://github.com/ClickHouse/ClickHouse/pull/16715)（[Winter Zhang](https://github.com/zhang2014)）。
* 最適化された単純な count クエリおよび system テーブルに対して、`select_sequential_consistency` によって発生していた一貫性のない動作を修正しました。 [#16309](https://github.com/ClickHouse/ClickHouse/pull/16309) ([Hao Chen](https://github.com/haoch)).
* 存在しないカラムに対して `REPLACE` カラムトランスフォーマーが動作した場合にエラーをスローするようにしました。 [#16183](https://github.com/ClickHouse/ClickHouse/pull/16183) ([hexiaoting](https://github.com/hexiaoting)).
* RIGHT/FULL JOIN において、等価結合ではない ON 式が指定された場合に例外をスローするようにしました。 [#15162](https://github.com/ClickHouse/ClickHouse/pull/15162) ([Artem Zuikov](https://github.com/4ertus2)).

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-10}


* ClickHouse バイナリに対する簡易な整合性チェックを追加しました。これにより、ストレージ媒体上のビットロットや RAM 内のビット反転など、ハードウェア障害に起因する破損を検出できます。 [#18811](https://github.com/ClickHouse/ClickHouse/pull/18811) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `OpenSSL` を `BoringSSL` に変更しました。これにより sanitizer による問題を回避できます。これによって [#12490](https://github.com/ClickHouse/ClickHouse/issues/12490) が修正されます。これによって [#17502](https://github.com/ClickHouse/ClickHouse/issues/17502) が修正されます。これによって [#12952](https://github.com/ClickHouse/ClickHouse/issues/12952) が修正されます。[#18129](https://github.com/ClickHouse/ClickHouse/pull/18129)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `Sys/V` init スクリプトを簡素化しました。Ubuntu 12.04 以前のバージョンでは動作していませんでした。 [#17428](https://github.com/ClickHouse/ClickHouse/pull/17428) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `./clickhouse install` スクリプトを多数改善しました。 [#17421](https://github.com/ClickHouse/ClickHouse/pull/17421) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* ClickHouse は、擬似的な ZooKeeper として振る舞えるようになりました。現在、ストレージ実装はインメモリのハッシュテーブルとしてのみ保持されており、サーバーは ZooKeeper プロトコルを一部のみサポートしています。 [#16877](https://github.com/ClickHouse/ClickHouse/pull/16877) ([alesapin](https://github.com/alesapin)).
* TestKeeperStorage（ZooKeeper のモック）における dead list watch の削除処理を修正。 [#18065](https://github.com/ClickHouse/ClickHouse/pull/18065) ([alesapin](https://github.com/alesapin)).
* フォールトインジェクション用の `SYSTEM SUSPEND` コマンドを追加しました。フェイルオーバーテストを容易に行うために使用できます。これにより [#15979](https://github.com/ClickHouse/ClickHouse/issues/15979) がクローズされました。 [#18850](https://github.com/ClickHouse/ClickHouse/pull/18850) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* ClickHouse を `lld` でリンクした際に build id を生成するようにしました。私の環境では `lld` はデフォルトでは build id を生成しないことが分かりました。build id はクラッシュレポートおよびイントロスペクションに使用されます。 [#18808](https://github.com/ClickHouse/ClickHouse/pull/18808) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* スタイルチェックにおける shellcheck のエラーを修正。[#18566](https://github.com/ClickHouse/ClickHouse/pull/18566)（[Ilya Yatsishin](https://github.com/qoega)）。
* タイムゾーン情報を 2020e に更新。 [#18531](https://github.com/ClickHouse/ClickHouse/pull/18531) ([alesapin](https://github.com/alesapin))。
* codespell の警告を修正。スタイルチェックを複数のパートに分割。スタイルチェック用 Docker イメージを更新。 [#18463](https://github.com/ClickHouse/ClickHouse/pull/18463) ([Ilya Yatsishin](https://github.com/qoega)).
* ドキュメント内に残ったコンフリクトマーカーを自動的に検出するチェックを追加。 [#18332](https://github.com/ClickHouse/ClickHouse/pull/18332) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* ステートレステストのフレークチェックのために Thread Fuzzer を有効化。 [#18299](https://github.com/ClickHouse/ClickHouse/pull/18299) ([alesapin](https://github.com/alesapin)).
* スレッドセーフでない関数 `strerror` を使用しないようにしました。 [#18204](https://github.com/ClickHouse/ClickHouse/pull/18204) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `anchore/scan-action@main` workflow action を更新しました（ブランチが `master` から `main` に変更されました）。[#18192](https://github.com/ClickHouse/ClickHouse/pull/18192)（[Stig Bakken](https://github.com/stigsb)）。
* 現在 `clickhouse-test` は、タイムアウト付きでデータベースの DROP/CREATE を行うようになりました。 [#18098](https://github.com/ClickHouse/ClickHouse/pull/18098) ([alesapin](https://github.com/alesapin)).
* ステートレステスト向けに Pytest フレームワークの実験的なサポートを有効化。 [#17902](https://github.com/ClickHouse/ClickHouse/pull/17902) ([Ivan](https://github.com/abyss7))。
* 統合テストで最新の Docker デーモンバージョンを使用するようになりました。 [#17671](https://github.com/ClickHouse/ClickHouse/pull/17671) ([alesapin](https://github.com/alesapin))。
* Sentry が有効になっている場合、公式ビルドかどうか、およびメモリ、CPU、空きディスク容量に関する情報を Sentry に送信します。Sentry は ClickHouse の開発者を支援するためのオプトイン機能です。これにより [#17279](https://github.com/ClickHouse/ClickHouse/issues/17279) がクローズされました。 [#17543](https://github.com/ClickHouse/ClickHouse/pull/17543) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* clickhouse-copier のコード内に未初期化の変数がありました。 [#17363](https://github.com/ClickHouse/ClickHouse/pull/17363) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* [#17309](https://github.com/ClickHouse/ClickHouse/issues/17309) に関連する [1 件の MSan レポート](https://clickhouse-test-reports.s3.yandex.net/17309/065cd002578f2e8228f12a2744bd40c970065e0c/stress_test_\(memory\)/stderr.log) を修正。 [#17344](https://github.com/ClickHouse/ClickHouse/pull/17344)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* Arrow Flight ライブラリにおける IPv6 関連の問題を修正しました。詳細は[コメント](https://github.com/ClickHouse/ClickHouse/pull/16243#issuecomment-720830294)を参照してください。 [#16664](https://github.com/ClickHouse/ClickHouse/pull/16664) ([Zhanna](https://github.com/FawnD2)).
* いくつかの `libc` 関数を、プロセスを終了させるトラップに置き換えるライブラリを追加しました。 [#16366](https://github.com/ClickHouse/ClickHouse/pull/16366) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* スタックオーバーフローが発生した場合にサーバーログに診断情報を出力し、`clickhouse-client` にエラーメッセージを送信します。これにより [#14840](https://github.com/ClickHouse/ClickHouse/issues/14840) がクローズされます。 [#16346](https://github.com/ClickHouse/ClickHouse/pull/16346) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* これにより、ほぼすべてのステートレスな機能テストを並列実行できるようになりました。 [#15236](https://github.com/ClickHouse/ClickHouse/pull/15236) ([alesapin](https://github.com/alesapin)).
* `librdkafka` の snappy 伸長処理で発生していたデータ破損を修正しました（gcc10 ビルドでのみ問題となっていましたが、公式ビルドではすでに clang を使用しているため、少なくとも最近の公式リリースには影響しません）。 [#18053](https://github.com/ClickHouse/ClickHouse/pull/18053) ([Azat Khuzhin](https://github.com/azat))。
* サーバーが OOM キラーによって終了された場合、ログにメッセージを出力するようにしました。 [#13516](https://github.com/ClickHouse/ClickHouse/pull/13516) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* PODArray: 引数として (`nullptr`, 0) を指定した `memcpy` 呼び出しを回避（UBSan レポートを修正）。これにより [#18525](https://github.com/ClickHouse/ClickHouse/issues/18525) が修正されました。 [#18526](https://github.com/ClickHouse/ClickHouse/pull/18526) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* DDLWorker 内での ZooKeeper パス連結処理をわずかに改善。 [#17767](https://github.com/ClickHouse/ClickHouse/pull/17767) ([Bharat Nallan](https://github.com/bharatnc))。
* デバッグファイルからシンボルを再読み込みできるようにしました。この PR では build-id に関する問題も修正しています。 [#17637](https://github.com/ClickHouse/ClickHouse/pull/17637) ([Amos Bird](https://github.com/amosbird))。





## [2020年の変更履歴](./2020.md) {#changelog-for-2020}
