---
slug: /whats-new/changelog/2024
sidebar_position: 3
sidebar_label: '2024'
title: '2024年 変更履歴'
description: '2024年の変更履歴'
keywords: ['ClickHouse 2024', '変更履歴 2024', 'リリースノート', 'バージョン履歴', '新機能']
doc_type: 'changelog'
---

### 目次 {#table-of-contents}
**[ClickHouse リリース v24.12, 2024-12-19](/whats-new/changelog/2024#a-id2412a-clickhouse-release-2412-2024-12-19)**<br/>
**[ClickHouse リリース v24.11, 2024-11-26](/whats-new/changelog/2024#a-id2411a-clickhouse-release-2411-2024-11-26)**<br/>
**[ClickHouse リリース v24.10, 2024-10-31](/whats-new/changelog/2024#a-id2410a-clickhouse-release-2410-2024-10-31)**<br/>
**[ClickHouse リリース v24.9, 2024-09-26](/whats-new/changelog/2024#a-id249a-clickhouse-release-249-2024-09-26)**<br/>
**[ClickHouse リリース v24.8 LTS, 2024-08-20](/whats-new/changelog/2024#a-id248a-clickhouse-release-248-lts-2024-08-20)**<br/>
**[ClickHouse リリース v24.7, 2024-07-30](/whats-new/changelog/2024#a-id247a-clickhouse-release-247-2024-07-30)**<br/>
**[ClickHouse リリース v24.6, 2024-07-01](/whats-new/changelog/2024#a-id246a-clickhouse-release-246-2024-07-01)**<br/>
**[ClickHouse リリース v24.5, 2024-05-30](/whats-new/changelog/2024#a-id245a-clickhouse-release-245-2024-05-30)**<br/>
**[ClickHouse リリース v24.4, 2024-04-30](/whats-new/changelog/2024#a-id244a-clickhouse-release-244-2024-04-30)**<br/>
**[ClickHouse リリース v24.3 LTS, 2024-03-26](/whats-new/changelog/2024#a-id243a-clickhouse-release-243-lts-2024-03-27)**<br/>
**[ClickHouse リリース v24.2, 2024-02-29](/whats-new/changelog/2024#a-id242a-clickhouse-release-242-2024-02-29)**<br/>
**[ClickHouse リリース v24.1, 2024-01-30](/whats-new/changelog/2024#a-id241a-clickhouse-release-241-2024-01-30)**<br/>
**[2023年の変更履歴](/whats-new/changelog/2023/)**<br/>

### <a id="2412"></a> ClickHouse リリース 24.12, 2024-12-19 {#a-id2412a-clickhouse-release-2412-2024-12-19}

#### 後方互換性のない変更 {#backward-incompatible-change}
* 関数 `greatest` および `least` は、これまでは引数のいずれかが NULL の場合に NULL を返していましたが、現在は NULL 入力値を無視します。例えば、`SELECT greatest(1, 2, NULL)` は現在 2 を返します。これにより PostgreSQL と互換の動作になりますが、一方で NULL を返す MySQL との互換性は失われます。以前の動作を維持するには、設定 `least_greatest_legacy_null_behavior`（デフォルト: `false`）を `true` に設定してください。 [#65519](https://github.com/ClickHouse/ClickHouse/pull/65519) [#73344](https://github.com/ClickHouse/ClickHouse/pull/73344) ([kevinyhzou](https://github.com/KevinyhZou)).
* 新しい MongoDB 統合がデフォルトになりました。従来の MongoDB ドライバ（Poco ドライバをベースとする）を使用する場合は、サーバー設定 `use_legacy_mongodb_integration` を有効にしてください。 [#73359](https://github.com/ClickHouse/ClickHouse/pull/73359) ([Kirill Nikiforov](https://github.com/allmazz)).



#### 新機能 {#new-feature}

* `JSON`/`Dynamic`/`Variant` 型を experimental 機能から beta 段階へ移行しました。[#72294](https://github.com/ClickHouse/ClickHouse/pull/72294)（[Pavel Kruglov](https://github.com/Avogar)）。さらに、この変更を含むすべての修正を 24.11 にもバックポートしました。
* [Iceberg data storage](https://iceberg.apache.org/spec/#file-system-operations) フォーマットのスキーマ進化機能により、ユーザーはテーブルのスキーマを柔軟に変更できます。カラム順序やカラム名、単純な型の拡張は、内部的に透過的に変更されます。[#69445](https://github.com/ClickHouse/ClickHouse/pull/69445)（[Daniil Ivanik](https://github.com/divanik)）。
* Iceberg REST Catalog との統合: Iceberg という名前の新しいデータベースエンジンにより、Iceberg REST Catalog 全体を ClickHouse から利用できるようになりました。 [#71542](https://github.com/ClickHouse/ClickHouse/pull/71542) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `MergeTree` テーブルのプライマリインデックスにキャッシュを追加しました（テーブル設定 `use_primary_key_cache` で有効化可能）。プライマリインデックスに対して遅延読み込みとキャッシュが有効な場合、（mark キャッシュと同様に）常にメモリ上に保持するのではなく、必要に応じてキャッシュへ読み込まれるようになります。さらに、データパーツの insert / merge / fetch 実行時およびテーブルの再起動時に、プライマリインデックスを事前にウォームアップする機能を追加しました（設定 `prewarm_primary_key_cache` で有効化可能）。これにより、共有ストレージ上の巨大なテーブルでもメモリ使用量を抑えることができ、1 千兆行を超えるテーブルで検証済みです。 [#72102](https://github.com/ClickHouse/ClickHouse/pull/72102) ([Anton Popov](https://github.com/CurtizJ)). [#72750](https://github.com/ClickHouse/ClickHouse/pull/72750) ([Alexander Gololobov](https://github.com/davenger)).
* `SYSTEM LOAD PRIMARY KEY` コマンドを実装し、指定されたテーブルのすべてのパーツ、またはテーブルが指定されていない場合はすべてのテーブルについて、プライマリインデックスをロードできるようにしました。これはベンチマークに役立ち、クエリ実行時の追加レイテンシーを防ぐのに役立ちます。[#66252](https://github.com/ClickHouse/ClickHouse/pull/66252) [#67733](https://github.com/ClickHouse/ClickHouse/pull/67733) ([ZAWA&#95;ll](https://github.com/Zawa-ll))。
* `MergeTree` テーブルを `ReplicatedMergeTree` として、またその逆に `ReplicatedMergeTree` テーブルを `MergeTree` としてアタッチできるクエリを追加しました：`ATTACH TABLE ... AS REPLICATED` および `ATTACH TABLE ... AS NOT REPLICATED`。 [#65401](https://github.com/ClickHouse/ClickHouse/pull/65401)（[Kirill](https://github.com/kirillgarbar)）。
* HTTP レスポンスヘッダーをカスタマイズできる新しい設定 `http_response_headers` が追加されました。例えば、データベースに保存されている画像をブラウザで直接表示させることができます。これにより [#59620](https://github.com/ClickHouse/ClickHouse/issues/59620) がクローズされました。[#72656](https://github.com/ClickHouse/ClickHouse/pull/72656)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* `DateTime64` を秒単位の精度を持つ `Int64` 値に変換する関数 `toUnixTimestamp64Second` を追加しました。これにより、日付が Unix エポックより前の場合に負の値を返せるようになります。 [#70597](https://github.com/ClickHouse/ClickHouse/pull/70597) ([zhanglistar](https://github.com/zhanglistar)). [#73146](https://github.com/ClickHouse/ClickHouse/pull/73146) ([Robert Schulze](https://github.com/rschu1ze)).
* 新しい設定 `enforce_index_structure_match_on_partition_manipulation` を追加し、ソーステーブルのプロジェクションとセカンダリインデックスのセットがターゲットテーブルのそれらの部分集合である場合に `ATTACH` を許可できるようにしました。 [#70602](https://github.com/ClickHouse/ClickHouse/issues/70602) をクローズしました。 [#70603](https://github.com/ClickHouse/ClickHouse/pull/70603) ([zwy991114](https://github.com/zwy991114))。
* 構文 `ALTER USER {ADD|MODIFY|DROP SETTING}`、`ALTER USER {ADD|DROP PROFILE}` を追加し、同様の構文を `ALTER ROLE` および `ALTER PROFILE` にも追加しました。これにより、設定セット全体を置き換えるのではなく、設定を変更できるようになりました。 [#72050](https://github.com/ClickHouse/ClickHouse/pull/72050) ([pufit](https://github.com/pufit)).
* `arrayPRAUC` 関数を追加しました。この関数は Precision-Recall 曲線に対する AUC（Area Under the Curve）を計算します。 [#72073](https://github.com/ClickHouse/ClickHouse/pull/72073) ([Emmanuel](https://github.com/emmanuelsdias))。
* `indexOfAssumeSorted` 関数を配列型向けに追加しました。非減少順にソートされた配列に対する検索を最適化します。効果が現れるのは、非常に大きな配列（10万要素を超える）です。 [#72517](https://github.com/ClickHouse/ClickHouse/pull/72517) ([Eric Kurbanov](https://github.com/erickurbanov)).
* 集約関数 `groupConcat` の第2引数として、区切り文字をオプションで指定できるようにしました。 [#72540](https://github.com/ClickHouse/ClickHouse/pull/72540) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* `translate` 関数は、`from` 引数が `to` 引数より多くの文字を含む場合に、文字の削除をサポートするようになりました。例: `SELECT translate('clickhouse', 'clickhouse', 'CLICK')` は、現在 `CLICK` を返します。[#71441](https://github.com/ClickHouse/ClickHouse/pull/71441)（[shuai.xu](https://github.com/shuai-xu)）。



#### 実験的機能 {#experimental-features}
* 新しい MergeTree の設定項目 `allow_experimental_reverse_key` が追加され、MergeTree のソートキーで降順ソートをサポートするようになりました。これは、特に TopN クエリを含む時系列分析に有用です。使用例：`ENGINE = MergeTree ORDER BY (time DESC, key)` - `time` フィールドを降順にソートします。[#71095](https://github.com/ClickHouse/ClickHouse/pull/71095)（[Amos Bird](https://github.com/amosbird)）。



#### パフォーマンスの向上 {#performance-improvement}

* JOIN のリオーダリング。クエリプランにおいて、結合のどちらの側のテーブルを inner（build）テーブルとして扱うかを選択できるオプションを追加しました。これは `query_plan_join_swap_table` によって制御され、`auto` に設定できます。このモードでは、ClickHouse は行数が最も少ないテーブルを選択しようとします。 [#71577](https://github.com/ClickHouse/ClickHouse/pull/71577) ([Vladimir Cherkasov](https://github.com/vdimir))。
* `join_algorithm` 設定が `default` の場合は（適用可能な場合）、`parallel_hash` アルゴリズムが使用されるようになりました。`parallel_hash` が使用できない場合には、従来の 2 つの代替手段（`direct` と `hash`）が引き続き候補として考慮されます。 [#70788](https://github.com/ClickHouse/ClickHouse/pull/70788) ([Nikita Taranov](https://github.com/nickitat))。
* `WHERE` 式および `ON` 式から共通部分式を抽出して、結合時に使用されるハッシュテーブルの数を削減するオプションを追加しました。これは、JOIN の ON 句の条件に AND で結合された共通部分があり、それが異なる OR 節の中に現れる場合に有効です。`optimize_extract_common_expressions = 1` で有効化できます。 [#71537](https://github.com/ClickHouse/ClickHouse/pull/71537) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* `SELECT` で、インデックス付きカラムが `LowCardinality(String)` に CAST されている場合でもインデックスを利用できるようにします。これは、あるテーブルが `String` 型を持ち、別のテーブルが `LowCardinality(String)` 型を持つようなテーブルを含む Merge テーブル上でクエリを実行する場合に発生し得ます。 [#71598](https://github.com/ClickHouse/ClickHouse/pull/71598) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
* 並列レプリカとローカルプランが有効な状態でクエリを実行する際、ワーカー側ではインデックス解析を行いません。コーディネーターは、自身側（クエリの起点ノード）でのインデックス解析に基づいて、ワーカーが読み取る範囲を選択します。これにより、並列レプリカを用いた短いクエリでも、単一ノードでのクエリと同等の低レイテンシーを実現できます。 [#72109](https://github.com/ClickHouse/ClickHouse/pull/72109) ([Igor Nikonov](https://github.com/devcrafter)).
* オブジェクトストレージディスクでの `clickhouse disks remove --recursive` のメモリ使用量を削減しました。 [#67323](https://github.com/ClickHouse/ClickHouse/pull/67323) ([Kirill](https://github.com/kirillgarbar))。
* コンパクトパーツ内の単一カラムからサブカラムを読み取る際の最適化を、[#57631](https://github.com/ClickHouse/ClickHouse/pull/57631) で導入されたものに基づき復元しました。これは誤って削除されていました。 [#72285](https://github.com/ClickHouse/ClickHouse/pull/72285) ([Pavel Kruglov](https://github.com/Avogar))。
* コンパレータ内の仮想関数呼び出しを除去することで、`LowCardinality(String)` カラムのソートを高速化しました。 [#72337](https://github.com/ClickHouse/ClickHouse/pull/72337) ([Alexander Gololobov](https://github.com/davenger)).
* いくつかの単純なデータ型向けに `argMin`/`argMax` 関数を最適化しました。 [#72350](https://github.com/ClickHouse/ClickHouse/pull/72350) ([alesapin](https://github.com/alesapin)).
* メモリトラッカーで共有ロックを使用してロックを最適化し、ロック競合を減らすことで、CPU コア数が非常に多いシステムでのパフォーマンスを向上させました。 [#72375](https://github.com/ClickHouse/ClickHouse/pull/72375) ([Jiebin Sun](https://github.com/jiebinn)).
* 新しい設定 `use_async_executor_for_materialized_views` を追加しました。マテリアライズドビューのクエリを非同期（必要に応じてマルチスレッド）で実行し、INSERT 時のビュー処理を高速化できますが、より多くのメモリを消費します。 [#72497](https://github.com/ClickHouse/ClickHouse/pull/72497) ([alesapin](https://github.com/alesapin)).
* データ型 `AggregateFunction` および分散クエリにおける集約関数状態のデシリアライズのパフォーマンスを改善しました。`RowBinary` フォーマットの解析パフォーマンスもわずかに向上しました。 [#72818](https://github.com/ClickHouse/ClickHouse/pull/72818) ([Anton Popov](https://github.com/CurtizJ)).
* 読み取り時のメモリ消費を抑えるため、テーブルキーの順序に従って並列レプリカで読み取り範囲を分割するようにしました。 [#72173](https://github.com/ClickHouse/ClickHouse/pull/72173) ([JIaQi](https://github.com/JiaQiTang98)).
* 挿入バッチ内のパーティションキーが単一の値に揃っている場合に、MergeTree への挿入を高速化しました。 [#72348](https://github.com/ClickHouse/ClickHouse/pull/72348) ([alesapin](https://github.com/alesapin))。
* バックアップからの復元時に、テーブル作成を並列に実行できるようにしました。このPR以前は、`RESTORE` コマンドは常に単一スレッドでテーブルを作成しており、多数のテーブルを含むバックアップでは処理に時間がかかる場合がありました。 [#72427](https://github.com/ClickHouse/ClickHouse/pull/72427) ([Vitaly Baranov](https://github.com/vitlibar)).
* マークキャッシュが大きい場合、それを破棄する処理には無視できない時間がかかることがあります。この間にコンテキストのミューテックスを保持したままだと、他の多くの処理がブロックされ、新しいクライアント接続でさえミューテックスが解放されるまで確立できません。そもそも同期のためにこのミューテックスを保持する必要はなく、`shared_ptr` を介してキャッシュへのローカル参照を持っていれば十分です。[#72749](https://github.com/ClickHouse/ClickHouse/pull/72749)（[Alexander Gololobov](https://github.com/davenger)）。





#### 改善 {#improvement}

* `allow_experimental_join_condition` 設定を削除し、非等値条件がデフォルトで許可されるようにしました。 [#69910](https://github.com/ClickHouse/ClickHouse/pull/69910) ([Vladimir Cherkasov](https://github.com/vdimir))。
* サーバー設定ファイル（users.xml）の内容がクライアントにも適用されるようになりました。`date_time_output_format` などのフォーマット設定に便利です。 [#71178](https://github.com/ClickHouse/ClickHouse/pull/71178) ([Michael Kolupaev](https://github.com/al13n321))。
* サーバー／ユーザーのメモリ使用量に応じて、`GROUP BY` / `ORDER BY` を自動的にディスクへオフロードします。`max_bytes_ratio_before_external_group_by` / `max_bytes_ratio_before_external_sort` クエリ設定で制御できます。[#71406](https://github.com/ClickHouse/ClickHouse/pull/71406)（[Azat Khuzhin](https://github.com/azat)）。
* 新しいキャンセル処理ロジックを追加しました。`CancellationChecker` は開始されたすべてのクエリのタイムアウトを監視し、タイムアウトに達した時点でそれらを停止します。 [#69880](https://github.com/ClickHouse/ClickHouse/pull/69880) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
* `Object` から `JSON` への `ALTER` をサポートし、非推奨となった `Object` 型から容易に移行できるようになりました。 [#71784](https://github.com/ClickHouse/ClickHouse/pull/71784) ([Pavel Kruglov](https://github.com/Avogar)).
* Enum に存在しない未知の値を set に含めることを許可。[#72662](https://github.com/ClickHouse/ClickHouse/issues/72662) を修正。[#72686](https://github.com/ClickHouse/ClickHouse/pull/72686)（[zhanglistar](https://github.com/zhanglistar)）。
* `Enum` データ型に対して文字列検索用演算子（例: LIKE）をサポートし、[#72661](https://github.com/ClickHouse/ClickHouse/issues/72661) を実装しました。[#72732](https://github.com/ClickHouse/ClickHouse/pull/72732)（[zhanglistar](https://github.com/zhanglistar)）。
* 意味のない `ALTER USER` クエリが受理されていました。[#71227](https://github.com/ClickHouse/ClickHouse/issues/71227) を修正。[#71286](https://github.com/ClickHouse/ClickHouse/pull/71286)（[Arthur Passos](https://github.com/arthurpassos)）。
* 分散テーブルの `INSERT ... SELECT` のプランを構築する際に `prefer_locahost_replica` を考慮するようにしました。[#72190](https://github.com/ClickHouse/ClickHouse/pull/72190) ([filimonov](https://github.com/filimonov)).
* Azure は Iceberg 仕様に違反し、誤って Iceberg v1 を Iceberg v2 とラベル付けしていました。この問題については[こちらで説明されています](https://github.com/ClickHouse/ClickHouse/issues/72091)。Azure Iceberg Writer は、仕様に違反する Iceberg メタデータファイル（およびマニフェストファイル）を作成します。その結果、（Azure がそのように書き込んでいるため）v2 リーダーで v1 の Iceberg フォーマットのメタデータを読み取ろうとすることになり、マニフェストファイル内に対応するフィールドが作成されていない場合にはエラーを発生させるようにしました。[#72277](https://github.com/ClickHouse/ClickHouse/pull/72277)（[Daniil Ivanik](https://github.com/divanik)）。
* クエリで `UNION [ALL]` を使用した `CREATE MATERIALIZED VIEW` が利用できるようになりました。挙動は `JOIN` を用いたマテリアライズドビューと同様で、`SELECT` 式内の最初のテーブルだけが挿入のトリガーとして機能し、他のすべてのテーブルは無視されます。ただし、最初のテーブルへの参照が複数ある場合（例: 自身との UNION）には、それらはすべて挿入されたデータブロックとして処理されます。 [#72347](https://github.com/ClickHouse/ClickHouse/pull/72347) ([alesapin](https://github.com/alesapin)).
* ClickHouse を辞書のソースとして使用する場合のソースクエリ検証を追加しました。 [#72548](https://github.com/ClickHouse/ClickHouse/pull/72548) ([Alexey Katsman](https://github.com/alexkats))。
* ClickHouse が設定の再読み込み時にも ZooKeeper の変更を認識できるようにしました。 [#72593](https://github.com/ClickHouse/ClickHouse/pull/72593) ([Azat Khuzhin](https://github.com/azat)).
* キャッシュされたマークのメモリ使用量の推定を改善し、キャッシュ全体のメモリ使用量を削減しました。 [#72630](https://github.com/ClickHouse/ClickHouse/pull/72630) ([Antonio Andelic](https://github.com/antonio2368)).
* 新しい `StartupScriptsExecutionState` メトリクスを追加しました。このメトリクスは 3 つの値を取り、0 = スタートアップスクリプトがまだ完了していない、1 = スタートアップスクリプトが正常に実行された、2 = スタートアップスクリプトが失敗した、を表します。このメトリクスは、特にベース構成のリリース後に、クラウド環境でスタートアップスクリプトが正常に実行されているかどうかを把握するために必要です。[#72637](https://github.com/ClickHouse/ClickHouse/pull/72637)（[Miсhael Stetsyuk](https://github.com/mstetsyuk)）。
* 新しい `MergeTreeIndexGranularityInternalArraysTotalSize` メトリクスを `system.metrics` に追加します。このメトリクスは、大規模なデータセットを持ち、高い影響を受けやすいインスタンスを特定するために必要です。
* レプリケーテッドテーブル作成時の再試行処理を追加しました。 [#72682](https://github.com/ClickHouse/ClickHouse/pull/72682) ([Vitaly Baranov](https://github.com/vitlibar)).
* 非アクティブなパーツのバイト数も含めた総バイト数をカウントするために、`system.tables` に `total_bytes_with_inactive` を追加しました。 [#72690](https://github.com/ClickHouse/ClickHouse/pull/72690) ([Kai Zhu](https://github.com/nauu))。
* MergeTree の設定を `system.settings_changes` に追加。[#72694](https://github.com/ClickHouse/ClickHouse/pull/72694) ([Raúl Marín](https://github.com/Algunenano))。
* `notEmpty` 関数に JSON 型のサポートを追加しました。 [#72741](https://github.com/ClickHouse/ClickHouse/pull/72741) ([Pavel Kruglov](https://github.com/Avogar))。
* GCS S3 エラー `AuthenticationRequired` のパースをサポートしました。 [#72753](https://github.com/ClickHouse/ClickHouse/pull/72753) ([Vitaly Baranov](https://github.com/vitlibar)).
* 関数 `ifNull` および `coalesce` で `Dynamic` 型をサポート。[#72772](https://github.com/ClickHouse/ClickHouse/pull/72772) ([Pavel Kruglov](https://github.com/Avogar))。
* 関数 `toFloat64`/`touInt32` などで `Dynamic` をサポートしました。 [#72989](https://github.com/ClickHouse/ClickHouse/pull/72989) ([Pavel Kruglov](https://github.com/Avogar))。
* S3 リクエスト設定である `http_max_fields`、`http_max_field_name_size`、`http_max_field_value_size` を追加し、バックアップまたはリストアの実行時に S3 API レスポンスを解析する際にこれらを使用するようにしました。[#72778](https://github.com/ClickHouse/ClickHouse/pull/72778) ([Vitaly Baranov](https://github.com/vitlibar))。
* Storage S3(Azure)Queue において、このメタデータを最後に使用していたテーブルが削除された後にのみ、Keeper 内のテーブルメタデータを削除するようにしました。 [#72810](https://github.com/ClickHouse/ClickHouse/pull/72810) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `JoinBuildTableRowCount`/`JoinProbeTableRowCount/JoinResultRowCount` のプロファイルイベントを追加しました。 [#72842](https://github.com/ClickHouse/ClickHouse/pull/72842) ([Vladimir Cherkasov](https://github.com/vdimir)).
* MergeTree のソートキーおよびスキップインデックスでサブカラムをサポートできるようにしました。 [#72644](https://github.com/ClickHouse/ClickHouse/pull/72644) ([Pavel Kruglov](https://github.com/Avogar)).





#### バグ修正（公式安定版リリースにおけるユーザー可視の不具合） {#bug-fix-user-visible-misbehavior-in-an-official-stable-release}

* MergeTree で互いに交差している可能性のあるパーツを修正（オブジェクトストレージ上での操作などにより、パーツを detached ディレクトリに移動する操作が失敗した後）。 [#70476](https://github.com/ClickHouse/ClickHouse/pull/70476) ([Azat Khuzhin](https://github.com/azat)).
* テーブル名が長すぎる場合のエラー検出を修正し、最大長を通知する診断メッセージを出力するようにしました。新しい関数 `getMaxTableNameLengthForDatabase` を追加しました。 [#70810](https://github.com/ClickHouse/ClickHouse/pull/70810) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* `clickhouse-library-bridge`（安全ではないライブラリを実行するためのプログラム）がクラッシュした後に残存するゾンビプロセスを修正しました。 [#71301](https://github.com/ClickHouse/ClickHouse/pull/71301) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* `plain_rewritable` ディスクでディレクトリの作成に失敗した際のトランザクションロールバック中に NoSuchKey エラーが発生する問題を修正。 [#71439](https://github.com/ClickHouse/ClickHouse/pull/71439) ([Julia Kartseva](https://github.com/jkartseva)).
* `Pretty` JSON 形式における `Dynamic` 値のシリアル化を修正。[#71923](https://github.com/ClickHouse/ClickHouse/pull/71923)（[Pavel Kruglov](https://github.com/Avogar)）。
* `File`/`S3`/`URL`/`HDFS`/`Azure` エンジンの `CREATE` クエリに、推論されたフォーマット名を含めるようにしました。以前はサーバーが再起動されるたびにフォーマット名が再推論され、指定されたデータファイルが削除されていると、サーバー起動時にエラーが発生していました。 [#72108](https://github.com/ClickHouse/ClickHouse/pull/72108) ([Pavel Kruglov](https://github.com/Avogar)).
* 古いアナライザで `JOIN ON` 句内の式に UDF を使用する際に発生していたバグを修正。 [#72179](https://github.com/ClickHouse/ClickHouse/pull/72179) ([Raúl Marín](https://github.com/Algunenano)).
* `StorageObjectStorage` のいくつかの小さなバグを修正し、`use_hive_partitioning` をデフォルトで有効にしました。 [#72185](https://github.com/ClickHouse/ClickHouse/pull/72185) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* `min_age_to_force_merge_on_partition_only` が、すでに単一パーツにマージ済みの同じパーティションを繰り返しマージしようとして行き詰まり、複数パーツを持つパーティションをマージしない問題を修正しました。 [#72209](https://github.com/ClickHouse/ClickHouse/pull/72209) ([Christoph Wurm](https://github.com/cwurm)).
* 疎なカラムを処理する際に、まれに発生していた `SimpleSquashingChunksTransform` のクラッシュを修正しました。 [#72226](https://github.com/ClickHouse/ClickHouse/pull/72226) ([Vladimir Cherkasov](https://github.com/vdimir)).
* `GraceHashJoin` におけるデータレースを修正しました。これが原因で、結合結果から一部の行が欠落する可能性がありました。 [#72233](https://github.com/ClickHouse/ClickHouse/pull/72233) ([Nikita Taranov](https://github.com/nickitat))。
* `enable_block_number_column` 設定が有効な場合の、マテリアライズド `_block_number` カラムを使用する `ALTER DELETE` クエリの問題を修正しました。 [#72261](https://github.com/ClickHouse/ClickHouse/pull/72261) ([Anton Popov](https://github.com/CurtizJ)).
* `ColumnDynamic::dumpStructure()` が同時に呼び出される場合（例: `ConcurrentHashJoin` コンストラクタ内）に発生していたデータ競合を修正しました。 [#72278](https://github.com/ClickHouse/ClickHouse/pull/72278) ([Nikita Taranov](https://github.com/nickitat)).
* `ORDER BY ... WITH FILL` で列が重複している場合に発生する可能性がある `LOGICAL_ERROR` を修正。 [#72387](https://github.com/ClickHouse/ClickHouse/pull/72387) ([Vladimir Cherkasov](https://github.com/vdimir)).
* `optimize_functions_to_subcolumns` を適用した後に、いくつかのケースで発生していた型の不整合を修正しました。 [#72394](https://github.com/ClickHouse/ClickHouse/pull/72394) ([Anton Popov](https://github.com/CurtizJ)).
* `AWS_CONTAINER_AUTHORIZATION_TOKEN_PATH` の代わりに `AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE` を使用するようにしました。 [#71074](https://github.com/ClickHouse/ClickHouse/issues/71074) を修正。 [#72397](https://github.com/ClickHouse/ClickHouse/pull/72397)（[Konstantin Bogdanov](https://github.com/thevar1able)）。
* `BACKUP DATABASE db EXCEPT TABLES db.table` クエリのパースに失敗する問題を修正。 [#72429](https://github.com/ClickHouse/ClickHouse/pull/72429) ([Konstantin Bogdanov](https://github.com/thevar1able))。
* 空の `Variant` を作成できないようにしました。 [#72454](https://github.com/ClickHouse/ClickHouse/pull/72454) ([Pavel Kruglov](https://github.com/Avogar))。
* `system.merges` での `result_part_path` の不正な形式を修正。[#72567](https://github.com/ClickHouse/ClickHouse/pull/72567)（[Konstantin Bogdanov](https://github.com/thevar1able)）。
* 要素が 1 つだけの glob パターン（`{file}` など）の解析を修正しました。 [#72572](https://github.com/ClickHouse/ClickHouse/pull/72572) ([Konstantin Bogdanov](https://github.com/thevar1able))。
* `ARRAY JOIN` を含む分散クエリにおいて、フォロワーサーバー向けのクエリ生成を修正しました。これにより [#69276](https://github.com/ClickHouse/ClickHouse/issues/69276) を解決します。[#72608](https://github.com/ClickHouse/ClickHouse/pull/72608)（[Dmitry Novik](https://github.com/novikd)）。
* `DateTime64` と `DateTime64` の `IN` 演算が結果を返さないバグを修正。 [#72640](https://github.com/ClickHouse/ClickHouse/pull/72640) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* `flatten_nested=0` で作成されたテーブルを持つ Replicated データベースに新しいレプリカを追加する際のメタデータの不整合を修正しました。 [#72685](https://github.com/ClickHouse/ClickHouse/pull/72685) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Keeper の内部通信向けの高度な SSL 設定を修正しました。 [#72730](https://github.com/ClickHouse/ClickHouse/pull/72730) ([Antonio Andelic](https://github.com/antonio2368))。
* S3Queue の unordered モードで、`tracked_files_limit` の設定値が S3 ファイルの出現頻度より小さい場合に発生する「No such key」エラーを修正しました。 [#72738](https://github.com/ClickHouse/ClickHouse/pull/72738) ([Kseniia Sumarokova](https://github.com/kssenii)).
* ローカルに該当ユーザーが存在しない場合に `RemoteQueryExecutor` でスローされる例外を修正。 [#72759](https://github.com/ClickHouse/ClickHouse/pull/72759)（[Andrey Zvonov](https://github.com/zvonand)）。
* `enable_block_number_column` 設定が有効な場合に、マテリアライズド `_block_number` 列を持つミューテーションの不具合を修正しました。 [#72854](https://github.com/ClickHouse/ClickHouse/pull/72854) ([Anton Popov](https://github.com/CurtizJ)).
* バックアップに空のファイルが含まれている場合でも、プレーンな書き換え可能ディスクを使用したバックアップ/リストアが正しく動作するように修正。 [#72858](https://github.com/ClickHouse/ClickHouse/pull/72858) ([Kseniia Sumarokova](https://github.com/kssenii)).
* DistributedAsyncInsertDirectoryQueue で挿入を適切にキャンセルするように修正。 [#72885](https://github.com/ClickHouse/ClickHouse/pull/72885) ([Antonio Andelic](https://github.com/antonio2368)).
* 不正なデータをスパース列にパースする際にクラッシュする問題を修正しました（設定 `enable_parsing_to_custom_serialization` を有効にしている場合に発生する可能性があります）。 [#72891](https://github.com/ClickHouse/ClickHouse/pull/72891) ([Anton Popov](https://github.com/CurtizJ)).
* バックアップの復元中に発生する可能性のあるクラッシュを修正。 [#72947](https://github.com/ClickHouse/ClickHouse/pull/72947) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `ON` 句に不等条件フィルタを含む複雑な条件式を持つクエリで発生する可能性があった `parallel_hash` JOIN メソッドのバグを修正しました。 [#72993](https://github.com/ClickHouse/ClickHouse/pull/72993) ([Nikita Taranov](https://github.com/nickitat)).
* JSON のパース時にはデフォルトのフォーマット設定を使用して、不正なデシリアライズを防ぎます。 [#73043](https://github.com/ClickHouse/ClickHouse/pull/73043) ([Pavel Kruglov](https://github.com/Avogar)).
* サポートされていないストレージを使用するトランザクションで発生していたクラッシュを修正。 [#73045](https://github.com/ClickHouse/ClickHouse/pull/73045) ([Raúl Marín](https://github.com/Algunenano)).
* `MemoryTracking` と `MemoryResident` の差が増え続ける場合に起こりうる、メモリトラッキングの過大推定を修正。 [#73081](https://github.com/ClickHouse/ClickHouse/pull/73081) ([Azat Khuzhin](https://github.com/azat)).
* Tuple のパース中に、重複した JSON キーがないかをチェックするようにしました。以前は、パース中に論理エラー `Invalid number of rows in Chunk` が発生する可能性がありました。 [#73082](https://github.com/ClickHouse/ClickHouse/pull/73082) ([Pavel Kruglov](https://github.com/Avogar)).



#### ビルド／テスト／パッケージングの改善 {#buildtestingpackaging-improvement}
* これまで `/utils` フォルダ内に保存され、ソースからの手動コンパイルが必要だった小さなユーティリティは、すべてメインの ClickHouse バンドルの一部になりました。これにより次の課題が解決されます: [#72404](https://github.com/ClickHouse/ClickHouse/issues/72404)。[#72426](https://github.com/ClickHouse/ClickHouse/pull/72426)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 22.3 で導入された `/etc/systemd/system/clickhouse-server.service` の削除処理を廃止しました。[#39323](https://github.com/ClickHouse/ClickHouse/issues/39323)。[#72259](https://github.com/ClickHouse/ClickHouse/pull/72259)（[Mikhail f. Shiryaev](https://github.com/Felixoid)）。
* メモリ／CPU 制限によるコンパイル失敗を避けるため、大きな翻訳単位を分割しました。[#72352](https://github.com/ClickHouse/ClickHouse/pull/72352)（[Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)）。
* OSX: 照合順序、文字セット変換、その他のローカリゼーション機能を有効にするため、ICU サポート付きでビルドするようにしました。[#73083](https://github.com/ClickHouse/ClickHouse/pull/73083)（[Raúl Marín](https://github.com/Algunenano)）。

### <a id="2411"></a> ClickHouse リリース 24.11, 2024-11-26 {#a-id2411a-clickhouse-release-2411-2024-11-26}

#### 後方互換性のない変更 {#backward-incompatible-change-1}
* システムテーブル `generate_series` および `generateSeries` を削除しました。これらは誤って次の課題で追加されたものです: [#59390](https://github.com/ClickHouse/ClickHouse/issues/59390)。[#71091](https://github.com/ClickHouse/ClickHouse/pull/71091)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* `StorageExternalDistributed` を削除しました。これにより [#70600](https://github.com/ClickHouse/ClickHouse/issues/70600) がクローズされます。[#71176](https://github.com/ClickHouse/ClickHouse/pull/71176)（[flynn](https://github.com/ucasfl)）。
* テーブルエンジン Kafka、NATS、RabbitMQ は、`SOURCES` 階層内でそれぞれ専用の権限で管理されるようになりました。これらのエンジンタイプでテーブルを作成するデフォルト以外のデータベースユーザーには、該当する権限を付与してください。[#71250](https://github.com/ClickHouse/ClickHouse/pull/71250)（[Christoph Wurm](https://github.com/cwurm)）。
* （サブクエリを含む）ミューテーションクエリ全体を、実行前に検査するようにしました。これにより、誤って無効なクエリを実行してしまい、有効なミューテーションをブロックする不要なミューテーションが蓄積されることを防ぎます。[#71300](https://github.com/ClickHouse/ClickHouse/pull/71300)（[Christoph Wurm](https://github.com/cwurm)）。
* ファイルシステムキャッシュの設定 `skip_download_if_exceeds_query_cache` を `filesystem_cache_skip_download_if_exceeds_per_query_cache_write_limit` に名称変更しました。[#71578](https://github.com/ClickHouse/ClickHouse/pull/71578)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `deltaSumTimestamp` における `Enum` および `UInt128`、`UInt256` 引数のサポートを削除しました。また、`deltaSumTimestamp` の 2 番目（「timestamp」）引数としての `Int8`、`UInt8`、`Int16`、`UInt16` のサポートも削除しました。[#71790](https://github.com/ClickHouse/ClickHouse/pull/71790)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* Dictionary ストレージ、dictionary テーブル関数、または辞書自体に対する直接の `SELECT` によって辞書からデータを直接取得する場合、辞書に対する `SELECT` 権限または `dictGet` 権限のいずれかを持っていれば十分になりました。これは ACL 回避を防ぐこれまでの試み（https://github.com/ClickHouse/ClickHouse/pull/57362 および https://github.com/ClickHouse/ClickHouse/pull/65359）と整合するものであり、後者を後方互換にするものでもあります。[#72051](https://github.com/ClickHouse/ClickHouse/pull/72051)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。



#### 実験的機能 {#experimental-feature}
* `allow_feature_tier` をグローバルスイッチとして実装し、すべての実験的 / ベータ機能を無効化できるようにしました。 [#71841](https://github.com/ClickHouse/ClickHouse/pull/71841) [#71145](https://github.com/ClickHouse/ClickHouse/pull/71145) ([Raúl Marín](https://github.com/Algunenano)).
* JSON サブカラム用ファイル内の特殊文字がエスケープされていないことに起因して `No such file or directory` が発生しうる問題を修正しました。 [#71182](https://github.com/ClickHouse/ClickHouse/pull/71182) ([Pavel Kruglov](https://github.com/Avogar)).
* String から JSON への `ALTER` をサポートしました。この PR により、JSON および Dynamic 型のシリアル化方式が新バージョン V2 に変更されます。旧バージョン V1 も、設定 `merge_tree_use_v1_object_and_dynamic_serialization` を有効化することで引き続き使用できます（アップグレード時に、問題なくバージョンをロールバックできるようにする目的で使用できます）。 [#70442](https://github.com/ClickHouse/ClickHouse/pull/70442) ([Pavel Kruglov](https://github.com/Avogar)).
* JSON 文字列とのシリアル化 / デシリアル化を通じて、Map/Tuple/Object から新しい JSON への単純な CAST を実装しました。 [#71320](https://github.com/ClickHouse/ClickHouse/pull/71320) ([Pavel Kruglov](https://github.com/Avogar)).
* 予期しない結果につながる可能性があるため、デフォルトでは ORDER BY/GROUP BY/PARTITION BY/PRIMARY KEY で Variant/Dynamic 型を許可しないようにしました。 [#69731](https://github.com/ClickHouse/ClickHouse/pull/69731) ([Pavel Kruglov](https://github.com/Avogar)).
* 混乱を避けるため、min/max 関数で Dynamic/Variant 型を禁止しました。 [#71761](https://github.com/ClickHouse/ClickHouse/pull/71761) ([Pavel Kruglov](https://github.com/Avogar)).

#### 新機能 {#new-feature-1}
* ワークロードおよびリソース管理を記述するための SQL 構文を追加しました。https://clickhouse.com/docs/operations/workload-scheduling. [#69187](https://github.com/ClickHouse/ClickHouse/pull/69187) ([Sergei Trifonov](https://github.com/serxa)).
* 新しいデータ型 `BFloat16` を追加しました。これは 8 ビットの指数部・符号・7 ビットの仮数部を持つ 16 ビット浮動小数点数を表します。これにより [#44206](https://github.com/ClickHouse/ClickHouse/issues/44206) がクローズされます。また [#49937](https://github.com/ClickHouse/ClickHouse/issues/49937) もクローズされます。 [#64712](https://github.com/ClickHouse/ClickHouse/pull/64712) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* 現在のユーザー / ロールに特定の権限が付与されているか、対応するテーブル / カラムがメモリ上に存在するかを確認するための `CHECK GRANT` クエリを追加しました。 [#68885](https://github.com/ClickHouse/ClickHouse/pull/68885) ([Unalian](https://github.com/Unalian)).
* `iceberg[S3;HDFS;Azure]Cluster`, `deltaLakeCluster`, `hudiCluster` テーブル関数を追加しました。 [#72045](https://github.com/ClickHouse/ClickHouse/pull/72045) ([Mikhail Artemenko](https://github.com/Michicosun)).
* http_handlers（`dynamic_query_handler`/`predefined_query_handler`）で user/password（ユーザー名 / パスワード）を設定できる機能を追加しました。 [#70725](https://github.com/ClickHouse/ClickHouse/pull/70725) ([Azat Khuzhin](https://github.com/azat)).
* ORDER BY WITH FILL 演算子において staleness 句をサポートしました。 [#71151](https://github.com/ClickHouse/ClickHouse/pull/71151) ([Mikhail Artemenko](https://github.com/Michicosun)).
* 各認証方式ごとに個別の有効期限を持てるようにし、ユーザーエンティティからは削除しました。 [#70090](https://github.com/ClickHouse/ClickHouse/pull/70090) ([Arthur Passos](https://github.com/arthurpassos)).
* 新しい関数 `parseDateTime64`, `parseDateTime64OrNull`, `parseDateTime64OrZero` を追加しました。既存の `parseDateTime`（およびそのバリアント）と比較して、これらは `DateTime` ではなく `DateTime64` 型の値を返します。 [#71581](https://github.com/ClickHouse/ClickHouse/pull/71581) ([kevinyhzou](https://github.com/KevinyhZou)).



#### パフォーマンスの向上 {#performance-improvement-1}

* パート内の粒度が一定である場合のインデックス粒度値に対するメモリ使用量を最適化しました。パートに対して常に一定の粒度を選択できる設定（`use_const_adaptive_granularity`）を追加し、その場合にメモリ使用量が常に最適化されるようにしました。これにより、共有ストレージ上に数兆行規模の大きなワークロードがある場合でも、データパートのメタデータ（インデックス粒度の値）によるメモリ使用量の継続的な増加を防ぐことができます。[#71786](https://github.com/ClickHouse/ClickHouse/pull/71786)（[Anton Popov](https://github.com/CurtizJ)）。
* `join_algorithm = 'parallel_hash'` 使用時には、並列処理のためにスレッド間で分配する際に、入力ブロックの列をコピーしないようにしました。 [#67782](https://github.com/ClickHouse/ClickHouse/pull/67782) ([Nikita Taranov](https://github.com/nickitat)).
* 互いに交差しないパーツに対する `Replacing` マージアルゴリズムの最適化。 [#70977](https://github.com/ClickHouse/ClickHouse/pull/70977) ([Anton Popov](https://github.com/CurtizJ)).
* metrics および system.detached&#95;parts において、readonly ディスクおよび write-once ディスク上の detached parts を一覧表示しないようにしました。 [#71086](https://github.com/ClickHouse/ClickHouse/pull/71086) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* 重い非同期メトリクスをデフォルトでは計算しないようにしました。この機能は [#40332](https://github.com/ClickHouse/ClickHouse/issues/40332) で導入されましたが、ごく一部の顧客にしか必要とされない重いバックグラウンドジョブを常時走らせるのは好ましくありません。[#71087](https://github.com/ClickHouse/ClickHouse/pull/71087)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* `plain_rewritable` ディスクの場合は、ディレクトリを一覧表示するときにオブジェクトストレージ API を呼び出さないでください。コスト効率が悪くなる可能性があります。代わりに、ファイル名の一覧をメモリに保持してください。このアプローチのトレードオフとして、初回ロード時間とファイル名を保持するために必要なメモリが増加します。 [#70823](https://github.com/ClickHouse/ClickHouse/pull/70823) ([Julia Kartseva](https://github.com/jkartseva)).
* クリティカルセクションを短縮することで、`system.query_metric_log` の収集間隔におけるパフォーマンスと精度を改善しました。 [#71473](https://github.com/ClickHouse/ClickHouse/pull/71473) ([Pablo Marcos](https://github.com/pamarcos)).
* 仮想行を生成することで順序どおりの読み込みを最適化し、特に複数のパーツが存在する場合のマージソート中に読み取る必要があるデータ量を削減しました。 [#62125](https://github.com/ClickHouse/ClickHouse/pull/62125) ([Shichao Jin](https://github.com/jsc0218)).
* サーバー設定 `async_load_system_database` を追加しました。これにより、system データベースの読み込みが完了していなくてもサーバーを起動できるようになります。system テーブルが多数存在する場合に、ClickHouse の起動をより高速化するのに役立ちます。[#69847](https://github.com/ClickHouse/ClickHouse/pull/69847)（[Sergei Trifonov](https://github.com/serxa)）。
* `clickhouse-compressor` に `--threads` パラメーターを追加し、データを並列に圧縮できるようにしました。 [#70860](https://github.com/ClickHouse/ClickHouse/pull/70860) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* `prewarm_mark_cache` という設定を追加しました。これにより、テーブルへの挿入、マージ、パーツのフェッチ時およびテーブルの起動時に、マークが mark cache に読み込まれるようになります。 [#71053](https://github.com/ClickHouse/ClickHouse/pull/71053) ([Anton Popov](https://github.com/CurtizJ)).
* MergeTree テーブルエンジンファミリーのメモリフットプリントを削減するため、メモリ内の index&#95;granularity 配列を実際の使用量に合わせて縮小するようにしました。 [#71595](https://github.com/ClickHouse/ClickHouse/pull/71595) ([alesapin](https://github.com/alesapin)).
* ディスクを介さない読み取りに対してファイルシステムキャッシュ設定 `boundary_alignment` を無効化し、キャッシュを用いたスタンドアロンのリモートファイルからの読み取りパフォーマンスを改善しました。 [#71827](https://github.com/ClickHouse/ClickHouse/pull/71827) ([Kseniia Sumarokova](https://github.com/kssenii))。
* `SELECT * FROM table LIMIT ...` のようなクエリでは、実際には利用されないパートインデックスまで読み込まれていました。 [#71866](https://github.com/ClickHouse/ClickHouse/pull/71866) ([Alexander Gololobov](https://github.com/davenger)).
* `parallel_replicas_local_plan` をデフォルトで有効化しました。クエリの発行元で完全なローカルプランを構築することで、リソース消費を抑えつつ parallel replicas のパフォーマンスを向上させ、さらなるクエリ最適化を行える余地が生まれます。 [#70171](https://github.com/ClickHouse/ClickHouse/pull/70171) ([Igor Nikonov](https://github.com/devcrafter))。





#### 改善 {#improvement-1}

* `ch queries.sql` のようにファイルを引数として指定して ClickHouse を使用できるようにしました。 [#71589](https://github.com/ClickHouse/ClickHouse/pull/71589) ([Raúl Marín](https://github.com/Algunenano)).
* `Vertical` フォーマット（クエリの末尾を `\G` で終えることでも有効化されます）は、次のような Pretty フォーマットの機能を利用できるようになりました: - 数値の千単位区切りの強調表示 - 読みやすい数値の補足情報の出力。[#71630](https://github.com/ClickHouse/ClickHouse/pull/71630) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* クエリの発行元からクラスタ内の他のノードへ外部ユーザーロールをプッシュできるようにしました。外部認証基盤（LDAP など）へのアクセス権が発行元ノードのみにある場合に有用です。 [#70332](https://github.com/ClickHouse/ClickHouse/pull/70332) ([Andrey Zvonov](https://github.com/zvonand)).
* 集約関数 `any` に対して、`anyRespectNulls`、`firstValueRespectNulls`、`anyValueRespectNulls` というエイリアスを追加しました。また、集約関数 `anyLast` に対しては `anyLastRespectNulls` と `lastValueRespectNulls` というエイリアスも追加しました。これにより、`anyLast_respect_nullsStateIf` ではなく `SELECT anyLastRespectNullsStateIf` のように、アンダースコア混在ではないキャメルケースのみの、より自然な構文を使用できるようになります。 [#71403](https://github.com/ClickHouse/ClickHouse/pull/71403) ([Peter Nguyen](https://github.com/petern48))。
* `date_time_utc` 設定パラメータを追加し、JSON ログフォーマットで RFC 3339/ISO8601 形式の UTC 日時をサポートするようにしました。[#71560](https://github.com/ClickHouse/ClickHouse/pull/71560) ([Ali](https://github.com/xogoodnow))。
* ユーザー認証用の S3 エンドポイント向けに新しいヘッダー種別（`access_header`）を追加しました。これにより、優先度が最も低いアクセスヘッダーを設定でき、この値は他のソース（例えばテーブルスキーマや名前付きコレクション）からの `access_key_id` によって上書きされます。 [#71011](https://github.com/ClickHouse/ClickHouse/pull/71011) ([MikhailBurdukov](https://github.com/MikhailBurdukov))。
* 定数配列および定数としてキャプチャされた引数を取る高階関数は、定数を返すようになりました。 [#58400](https://github.com/ClickHouse/ClickHouse/pull/58400) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* クエリプランのステップ名（`EXPLAIN PLAN json=1`）およびパイプラインのプロセッサ名（`EXPLAIN PIPELINE compact=0,graph=1`）に、一意の ID が末尾のサフィックスとして付与されるようになりました。これにより、プロセッサプロファイラの出力および OpenTelemetry トレースを、EXPLAIN の出力と対応付けられるようになりました。 [#63518](https://github.com/ClickHouse/ClickHouse/pull/63518) ([qhsong](https://github.com/qhsong)).
* Azure Blob Storage にオブジェクトを書き込んだ後、そのオブジェクトが存在するかを確認するオプションを追加しました。これは `check_objects_after_upload` の設定によって制御されます。 [#64847](https://github.com/ClickHouse/ClickHouse/pull/64847) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* `clickhouse-local` のデフォルトデータベースとして `Atomic` を使用するようにしました。 [#50647](https://github.com/ClickHouse/ClickHouse/issues/50647) の項目 1 および 5 に対応しています。 [#44817](https://github.com/ClickHouse/ClickHouse/issues/44817) をクローズします。 [#68024](https://github.com/ClickHouse/ClickHouse/pull/68024)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* クライアントにエラーを通知するために、例外は HTTP プロトコルに違反します。 [#68800](https://github.com/ClickHouse/ClickHouse/pull/68800) ([Sema Checherinda](https://github.com/CheSema)).
* replica&#95;dir を作成し、DDLWorker でレプリカをアクティブとしてマークすることで、分散DDLクエリを実行しているホストを報告するようにしました。 [#69658](https://github.com/ClickHouse/ClickHouse/pull/69658) ([tuanpach](https://github.com/tuanpach)).
* distributed&#95;ddl&#95;output&#95;mode が *&#95;only&#95;active に設定されている場合、ON CLUSTER を指定したデータベースクエリではアクティブなレプリカのみを待機するようにしました。 [#69660](https://github.com/ClickHouse/ClickHouse/pull/69660) ([tuanpach](https://github.com/tuanpach)).
* `ON CLUSTER` バックアップおよびリストア時のエラーハンドリングとキャンセル処理の改善: - あるホストでバックアップまたはリストアが失敗した場合、他のホスト上の処理は自動的にキャンセルされます - 一部のホストが失敗し他のホストが処理を続行した場合でも、不可解なエラーが出力されることがないようにしました - あるホストでバックアップまたはリストアがキャンセルされた場合、他のホスト上の処理も自動的にキャンセルされます - `test_disallow_concurrency` に関する問題を修正しました。これにより同時実行の無効化がより適切に動作するようになりました - バックアップおよびリストアは ZooKeeper 切断に対する耐性が、これまでよりはるかに高くなりました。 [#70027](https://github.com/ClickHouse/ClickHouse/pull/70027) ([Vitaly Baranov](https://github.com/vitlibar)).
* S3Queue ストレージにおいて、特定の設定に対する `ALTER TABLE ... MODIFY/RESET SETTING ...` のサポートを追加しました。 [#70811](https://github.com/ClickHouse/ClickHouse/pull/70811) ([Kseniia Sumarokova](https://github.com/kssenii))。
* サーバー証明書のリロード手順と同様に、クライアント証明書もリロードできるようになりました。 [#70997](https://github.com/ClickHouse/ClickHouse/pull/70997) ([Roman Antonov](https://github.com/Romeo58rus)).
* クライアントの履歴サイズを設定可能にし、デフォルトサイズを増やしました。 [#71014](https://github.com/ClickHouse/ClickHouse/pull/71014) ([Jiří Kozlovský](https://github.com/jirislav)).
* Parquet ネイティブリーダーでの Boolean 型サポート。 [#71055](https://github.com/ClickHouse/ClickHouse/pull/71055) ([Arthur Passos](https://github.com/arthurpassos))。
* S3 とのやり取り時に、「Malformed message」など、より多くの種類のエラーを再試行対象としました。 [#71088](https://github.com/ClickHouse/ClickHouse/pull/71088) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* S3 に関する一部のメッセージのログレベルを引き下げました。 [#71090](https://github.com/ClickHouse/ClickHouse/pull/71090) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* スペースを含む HDFS ファイルへの書き込みをサポートしました。[#71105](https://github.com/ClickHouse/ClickHouse/pull/71105) ([exmy](https://github.com/exmy))。
* レプリケートされたテーブル、辞書、およびビューの数を制限する設定を追加しました。 [#71179](https://github.com/ClickHouse/ClickHouse/pull/71179) ([Kirill](https://github.com/kirillgarbar)).
* `AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE` が利用可能な場合は、`AWS_CONTAINER_AUTHORIZATION_TOKEN` ではなく `AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE` を使用します。[#71074](https://github.com/ClickHouse/ClickHouse/issues/71074) を修正。[#71269](https://github.com/ClickHouse/ClickHouse/pull/71269)（[Konstantin Bogdanov](https://github.com/thevar1able)）。
* ReplicatedMergeTree の再起動スレッドから、metadata&#95;version ZooKeeper ノードの作成を削除しました。このノードを作成する必要があるのは、ユーザーが 20.4 より前のバージョンから、直接 24.10 より後のバージョンへアップグレードした場合だけです。ClickHouse は 1 年以上の期間にまたがるアップグレードをサポートしていないため、ノードを作成するのではなく、例外をスローしてユーザーに段階的にアップグレードするよう求めるべきです。[#71385](https://github.com/ClickHouse/ClickHouse/pull/71385) ([Miсhael Stetsyuk](https://github.com/mstetsyuk))。
* ホストごとのダッシュボード `Overview (host)` と `Cloud overview (host)` を高度なダッシュボードに追加しました。 [#71422](https://github.com/ClickHouse/ClickHouse/pull/71422) ([alesapin](https://github.com/alesapin)).
* `clickhouse-local` はデフォルトで暗黙の SELECT を使用しており、電卓として利用できます。暗黙の SELECT モードにおける構文ハイライトを改善しました。 [#71620](https://github.com/ClickHouse/ClickHouse/pull/71620) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* コマンドラインアプリケーションでは、複数ステートメントでも構文がハイライト表示されます。 [#71622](https://github.com/ClickHouse/ClickHouse/pull/71622) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* コマンドラインアプリケーションは、エラー時に非ゼロの終了コードを返すようになります。以前のバージョンでは、`disks` アプリケーションはエラー時にも終了コード 0 を返し、他のアプリケーションもエラーコード 256（`PARTITION_ALREADY_EXISTS`）および 512（`SET_NON_GRANTED_ROLE`）に対して終了コード 0 を返していました。 [#71623](https://github.com/ClickHouse/ClickHouse/pull/71623) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* ユーザー／グループが ID で指定された場合、`clickhouse su` は失敗していました。このパッチにより、`UID:GID` 形式の指定も受け付けるように修正されました。 [#71626](https://github.com/ClickHouse/ClickHouse/pull/71626) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* `filesystem_cache_prefer_bigger_buffer_size` 設定により、ファイルシステムキャッシュのメモリバッファサイズ拡大を無効化できるようにしました。 [#71640](https://github.com/ClickHouse/ClickHouse/pull/71640) ([Kseniia Sumarokova](https://github.com/kssenii)).
* ファイルシステムキャッシュにおけるバックグラウンドダウンロードの最大ファイルセグメントサイズ用として、個別の設定 `background_download_max_file_segment_size` を追加しました。 [#71648](https://github.com/ClickHouse/ClickHouse/pull/71648) ([Kseniia Sumarokova](https://github.com/kssenii)).
* JSON 型のパースをわずかに改善しました。JSON パスに対応する現在のブロック内に複数種類の値が含まれている場合、特別なベストエフォートの順序で型を試し、最適な型を選択するようにしました。 [#71785](https://github.com/ClickHouse/ClickHouse/pull/71785) ([Pavel Kruglov](https://github.com/Avogar)).
* 以前は `system.asynchronous_metrics` から読み取る際、並行して実行中の更新処理が完了するまで待機していました。システムに高い負荷がかかっている場合、これには長い時間がかかる可能性があります。この変更により、これまでに収集された値を常に読み取れるようになりました。 [#71798](https://github.com/ClickHouse/ClickHouse/pull/71798) ([Alexander Gololobov](https://github.com/davenger)).
* S3Queue と AzureQueue: `polling_max_timeout_ms` を 10 分、`polling_backoff_ms` を 30 秒に設定。 [#71817](https://github.com/ClickHouse/ClickHouse/pull/71817) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `history` 期間中に `HostResolver` を 3 回更新するようにしました。 [#71863](https://github.com/ClickHouse/ClickHouse/pull/71863) ([Sema Checherinda](https://github.com/CheSema)).
* 高度なダッシュボード用の HTML ページに、`system.dashboards` テーブル内のダッシュボードを選択するためのドロップダウンセレクターを追加しました。 [#72081](https://github.com/ClickHouse/ClickHouse/pull/72081) ([Sergei Trifonov](https://github.com/serxa)).
* 認可後にデフォルトデータベースが存在することを確認するようにしました。[#71097](https://github.com/ClickHouse/ClickHouse/issues/71097) を修正。[#71140](https://github.com/ClickHouse/ClickHouse/pull/71140)（[Konstantin Bogdanov](https://github.com/thevar1able)）。





#### バグ修正（公式安定版リリースにおけるユーザー可視の不具合） {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-1}

* `ATTACH PART` クエリの実行中に重複排除されたパーツが、`attaching_` プレフィックスが付いたまま残ることはなくなりました。 [#65636](https://github.com/ClickHouse/ClickHouse/pull/65636) ([Kirill](https://github.com/kirillgarbar))。
* `IN` 関数で DateTime64 の精度が失われていた不具合を修正。 [#67230](https://github.com/ClickHouse/ClickHouse/pull/67230) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* `ORDER BY ... WITH FILL` で `IGNORE/RESPECT NULLS` を使用する関数において発生する可能性がある論理エラーを修正し、[#57609](https://github.com/ClickHouse/ClickHouse/issues/57609) をクローズしました。 [#68234](https://github.com/ClickHouse/ClickHouse/pull/68234)（[Vladimir Cherkasov](https://github.com/vdimir)）。
* メモリ制限に達した場合に、フォーマット `Native` を使用する非同期挿入で発生しうる稀な論理エラーを修正しました。 [#68965](https://github.com/ClickHouse/ClickHouse/pull/68965) ([Anton Popov](https://github.com/CurtizJ)).
* EPHEMERAL 列の CREATE TABLE 文内の COMMENT を修正。 [#70458](https://github.com/ClickHouse/ClickHouse/pull/70458) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* LowCardinality(Nullable) を使用した JSONExtract の論理エラーを修正。 [#70549](https://github.com/ClickHouse/ClickHouse/pull/70549) ([Pavel Kruglov](https://github.com/Avogar)).
* 同じ zk path を持つ別のレプリカが存在する場合でも、system drop replica zkpath を実行できるようにしました。 [#70642](https://github.com/ClickHouse/ClickHouse/pull/70642) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* AggregateFunctionGroupArraySorted のクラッシュおよびメモリリークを修正。 [#70820](https://github.com/ClickHouse/ClickHouse/pull/70820) ([Michael Kolupaev](https://github.com/al13n321)).
* URL エンジンで、ユーザー指定ヘッダーにより Content-Type を上書きできるようにした。 [#70859](https://github.com/ClickHouse/ClickHouse/pull/70859) ([Artem Iurin](https://github.com/ortyomka)).
* `StorageS3Queue` の論理エラー「Cannot create a persistent node in /processed since it already exists」を修正しました。 [#70984](https://github.com/ClickHouse/ClickHouse/pull/70984) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 特定の状況下で名前付きセッションが終了せず、ハングし続ける問題を修正しました。 [#70998](https://github.com/ClickHouse/ClickHouse/pull/70998) ([Márcio Martins](https://github.com/marcio-absmartly)).
* projection の lightweight delete の rebuild オプションで &#95;row&#95;exists 列が考慮されていなかったバグを修正。 [#71089](https://github.com/ClickHouse/ClickHouse/pull/71089) ([Shichao Jin](https://github.com/jsc0218)).
* Oracle Linux UEK 6.10 上で実行する際に発生する `AT_* is out of range` という問題を修正。 [#71109](https://github.com/ClickHouse/ClickHouse/pull/71109) ([Örjan Fors](https://github.com/op)).
* 予期しないレースコンディションが原因で `system.query_metric_log` に記録される値が誤っていた問題を修正しました。 [#71124](https://github.com/ClickHouse/ClickHouse/pull/71124) ([Pablo Marcos](https://github.com/pamarcos)).
* quantileExactWeightedInterpolated の集約関数名の不一致を修正しました。このバグは [https://github.com/ClickHouse/ClickHouse/pull/69619](https://github.com/ClickHouse/ClickHouse/pull/69619) の変更で発生しました。cc @Algunenano。[#71168](https://github.com/ClickHouse/ClickHouse/pull/71168)（[李扬](https://github.com/taiyang-li)）。
* 関数比較時に Dynamic を用いた場合に発生する bad&#95;weak&#95;ptr 例外を修正。 [#71183](https://github.com/ClickHouse/ClickHouse/pull/71183) ([Pavel Kruglov](https://github.com/Avogar)).
* 7z ファイルの読み取りがローカルマシン上で行われていることを確認します。 [#71184](https://github.com/ClickHouse/ClickHouse/pull/71184) ([Daniil Ivanik](https://github.com/divanik)).
* HTTP および Async Inserts を介した Native フォーマットにおいて、フォーマット設定が無視される問題を修正。 [#71193](https://github.com/ClickHouse/ClickHouse/pull/71193) ([Pavel Kruglov](https://github.com/Avogar)).
* `use_query_cache = 1` を設定して実行される SELECT クエリは、システムテーブル名がリテラルとして出現しても拒否されなくなりました。例えば、`SELECT * FROM users WHERE name = 'system.metrics' SETTINGS use_query_cache = true;` は今では正常に動作します。 [#71254](https://github.com/ClickHouse/ClickHouse/pull/71254) ([Robert Schulze](https://github.com/rschu1ze)).
* `enable_filesystem_cache=1` が有効化されているにもかかわらず、ストレージ設定内のディスクにキャッシュ設定が存在しない場合に発生していたメモリ使用量増加のバグを修正しました。 [#71261](https://github.com/ClickHouse/ClickHouse/pull/71261) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Dynamic column からの LowCardinality 辞書のデシリアライズ時に発生する可能性のあるエラー「Cannot read all data」を修正します。[#71299](https://github.com/ClickHouse/ClickHouse/pull/71299) ([Pavel Kruglov](https://github.com/Avogar)).
* クライアントにおける並列出力フォーマットのクリーンアップが不完全だった問題を修正。 [#71304](https://github.com/ClickHouse/ClickHouse/pull/71304) ([Raúl Marín](https://github.com/Algunenano)).
* 名前付きコレクションで不足していたエスケープ解除処理を追加しました。この修正がないと clickhouse-server は起動できません。 [#71308](https://github.com/ClickHouse/ClickHouse/pull/71308) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* ネイティブプロトコル経由で空ブロックを含む非同期挿入の問題を修正。 [#71312](https://github.com/ClickHouse/ClickHouse/pull/71312) ([Anton Popov](https://github.com/CurtizJ)).
* 誤ったワイルドカード権限を付与した場合にASTのフォーマットが不整合になる問題を修正 [#71309](https://github.com/ClickHouse/ClickHouse/issues/71309)。[#71332](https://github.com/ClickHouse/ClickHouse/pull/71332)（[pufit](https://github.com/pufit)）。
* `std::terminate` の発生を避けるため、データパーツのデストラクタに try/catch を追加しました。 [#71364](https://github.com/ClickHouse/ClickHouse/pull/71364) ([alesapin](https://github.com/alesapin)).
* JSON の型ヒントで疑わしい型や実験的な型を検査するようにしました。 [#71369](https://github.com/ClickHouse/ClickHouse/pull/71369) ([Pavel Kruglov](https://github.com/Avogar)).
* Linux 以外の OS でもメモリワーカースレッドを起動するようにしました（[#71051](https://github.com/ClickHouse/ClickHouse/issues/71051) の修正）。[#71384](https://github.com/ClickHouse/ClickHouse/pull/71384)（[Alexandre Snarskii](https://github.com/snar)）。
* Variant カラムを含む Chunk で発生する「Invalid number of rows」エラーを修正。 [#71388](https://github.com/ClickHouse/ClickHouse/pull/71388) ([Pavel Kruglov](https://github.com/Avogar)).
* 古い PostgreSQL バージョンで列 &quot;attgenerated&quot; が存在しないエラーを修正し、[#60651](https://github.com/ClickHouse/ClickHouse/issues/60651) を修正。[#71396](https://github.com/ClickHouse/ClickHouse/pull/71396)（[0xMihalich](https://github.com/0xMihalich)）。
* サーバーログをスパムしないように、失敗した認証試行は `ERROR` レベルではなく `DEBUG` レベルで記録されるようになりました。 [#71405](https://github.com/ClickHouse/ClickHouse/pull/71405) ([Robert Schulze](https://github.com/rschu1ze)).
* 誤った引数（例: `NULL`）を渡した場合に `mongodb` テーブル関数がクラッシュする問題を修正しました。[#71426](https://github.com/ClickHouse/ClickHouse/pull/71426) ([Vladimir Cherkasov](https://github.com/vdimir))。
* optimize&#95;rewrite&#95;array&#95;exists&#95;to&#95;has 有効時に発生するクラッシュを修正。 [#71432](https://github.com/ClickHouse/ClickHouse/pull/71432) ([Raúl Marín](https://github.com/Algunenano)).
* `max_insert_delayed_streams_for_parallel_write` 設定の INSERT 時の使用方法を修正しました。以前は正しく動作しておらず、複数のパーティションにデータを書き込む INSERT において、高いメモリ使用量を引き起こす可能性がありました。 [#71474](https://github.com/ClickHouse/ClickHouse/pull/71474) ([Anton Popov](https://github.com/CurtizJ)).
* `WHERE` 句内に `arrayJoin` が現れる可能性がある場合に発生しうる、旧アナライザでの `Argument for function must be constant` エラーを修正しました。[https://github.com/ClickHouse/ClickHouse/pull/65414](https://github.com/ClickHouse/ClickHouse/pull/65414) によるリグレッションです。[#71476](https://github.com/ClickHouse/ClickHouse/pull/71476)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 0 列の SortCursor でクラッシュが発生しないように修正（旧アナライザー）。 [#71494](https://github.com/ClickHouse/ClickHouse/pull/71494) ([Raúl Marín](https://github.com/Algunenano)).
* 初期化されていない ORC データが原因で発生する Date32 の範囲外エラーを修正しました。詳細は [https://github.com/apache/incubator-gluten/issues/7823](https://github.com/apache/incubator-gluten/issues/7823) を参照してください。 [#71500](https://github.com/ClickHouse/ClickHouse/pull/71500)（[李扬](https://github.com/taiyang-li)）。
* Dynamic 型および JSON 型に対して、ワイドパートにおけるカウント用カラムのサイズを修正しました。[#71526](https://github.com/ClickHouse/ClickHouse/pull/71526) ([Pavel Kruglov](https://github.com/Avogar)).
* マテリアライズドビュー内のクエリが CTE とともに `IN` を使用している場合を Analyzer が正しく処理できるよう修正。[#65598](https://github.com/ClickHouse/ClickHouse/issues/65598) をクローズ。[#71538](https://github.com/ClickHouse/ClickHouse/pull/71538)（[Maksim Kita](https://github.com/kitaisreal)）。
* 制約内で UDF を使用した際にクラッシュしないようにしました。 [#71541](https://github.com/ClickHouse/ClickHouse/pull/71541) ([Raúl Marín](https://github.com/Algunenano)).
* 範囲外の場合、bitShift 関数でエラーをスローするのではなく、0 またはデフォルトの文字を返すようにしました。 [#71580](https://github.com/ClickHouse/ClickHouse/pull/71580) ([Pablo Marcos](https://github.com/pamarcos)).
* 特定のエンジンと併用したマテリアライズドビュー使用時に発生するサーバークラッシュを修正。 [#71593](https://github.com/ClickHouse/ClickHouse/pull/71593) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* 定数配列へのエイリアスを含むネストしたデータ構造に対して array join を行うと、ヌルポインタ参照が発生していました。これにより [#71677](https://github.com/ClickHouse/ClickHouse/issues/71677) が解決されました。[#71678](https://github.com/ClickHouse/ClickHouse/pull/71678)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 空のタプルで ALTER を実行すると発生する LOGICAL&#95;ERROR を修正。これにより [#71647](https://github.com/ClickHouse/ClickHouse/issues/71647) が解決されます。[#71679](https://github.com/ClickHouse/ClickHouse/pull/71679)（[Amos Bird](https://github.com/amosbird)）。
* NOT IN 演算子の場合は、パーティションカラムに対する述語内の定数セットを変換しないようにしました。 [#71695](https://github.com/ClickHouse/ClickHouse/pull/71695) ([Eduard Karacharov](https://github.com/korowa)).
* Docker init スクリプトの失敗ログメッセージを、より分かりやすくするために修正。 [#71734](https://github.com/ClickHouse/ClickHouse/pull/71734) ([Андрей](https://github.com/andreineustroev)).
* LowCardinality(Nullable) から Dynamic への CAST の挙動を修正しました。以前は `Bad cast from type DB::ColumnVector<int> to DB::ColumnNullable` というエラーが発生する可能性がありました。 [#71742](https://github.com/ClickHouse/ClickHouse/pull/71742) ([Pavel Kruglov](https://github.com/Avogar))。
* WHERE 句で DateTime64 型の主キーに対して `toDayOfWeek` を使用した場合に発生する例外を修正。 [#71849](https://github.com/ClickHouse/ClickHouse/pull/71849) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* スパース列へのパース後のデフォルト値補完処理を修正しました。 [#71854](https://github.com/ClickHouse/ClickHouse/pull/71854) ([Anton Popov](https://github.com/CurtizJ)).
* 分散テーブルで入力が ALIAS の場合に発生していた GROUPING 関数のエラーを修正しました。[#68602](https://github.com/ClickHouse/ClickHouse/issues/68602)。[#71855](https://github.com/ClickHouse/ClickHouse/pull/71855)（[Vladimir Cherkasov](https://github.com/vdimir)）。
* `allow_experimental_join_condition` 使用時にクラッシュが発生する可能性があった問題を修正し、[#71693](https://github.com/ClickHouse/ClickHouse/issues/71693) をクローズしました。[#71857](https://github.com/ClickHouse/ClickHouse/pull/71857)（[Vladimir Cherkasov](https://github.com/vdimir)）。
* `WITH TIES` 句を使用していて、十分な行を返さない可能性があった SELECT 文を修正しました。 [#71886](https://github.com/ClickHouse/ClickHouse/pull/71886) ([wxybear](https://github.com/wxybear))
* `arrayWithConstant` の評価で、カラムが配列サイズの上限を超えていると誤って判断されることにより発生する `TOO_LARGE_ARRAY_SIZE` 例外を修正しました。 [#71894](https://github.com/ClickHouse/ClickHouse/pull/71894) ([Udi](https://github.com/udiz)).
* `clickhouse-benchmark` が 1 秒を超えるクエリに対して誤ったメトリクスを報告していました。 [#71898](https://github.com/ClickHouse/ClickHouse/pull/71898) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* clickhouse-client における進捗インジケーターと進捗テーブル間のデータ競合を修正しました。この問題は FROM INFILE が使用される場合に発生します。INSERT クエリ中のキーストロークをインターセプトして、進捗テーブルの表示をトグルできるようにしました。 [#71901](https://github.com/ClickHouse/ClickHouse/pull/71901) ([Julia Kartseva](https://github.com/jkartseva)).
* クラスタ自動検出に補助 Keeper を使用できるようにしました。 [#71911](https://github.com/ClickHouse/ClickHouse/pull/71911) ([Anton Ivashkin](https://github.com/ianton-ru)).
* 24.6 で正しく動作していなかった system.s3/azure&#95;queue&#95;log の rows&#95;processed カラムを修正。[#69975](https://github.com/ClickHouse/ClickHouse/issues/69975) をクローズ。[#71946](https://github.com/ClickHouse/ClickHouse/pull/71946)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `s3` / `s3Cluster` 関数が不完全な結果を返したり、例外をスローしたりする可能性があったケースを修正しました。これは、S3 URI でグロブパターン（`pattern/*` のようなもの）を使用し、かつキー `pattern/` を持つ空のオブジェクトが存在している場合に発生していました（そのようなオブジェクトは S3 コンソールによって自動的に作成されます）。また、設定項目 `s3_skip_empty_files` のデフォルト値を `false` から `true` に変更しました。[#71947](https://github.com/ClickHouse/ClickHouse/pull/71947)（[Nikita Taranov](https://github.com/nickitat)）。
* clickhouse-client の構文ハイライトで発生していたクラッシュを修正しました。 [#71864](https://github.com/ClickHouse/ClickHouse/issues/71864) をクローズしました。 [#71949](https://github.com/ClickHouse/ClickHouse/pull/71949) ([Nikolay Degterinsky](https://github.com/evillique))。
* `MergeTree` テーブルの `ORDER BY` で、最初の引数が定数のバイナリ単調関数を使用した場合に発生する `Illegal type` エラーを修正。 [#71941](https://github.com/ClickHouse/ClickHouse/issues/71941) を修正。 [#71966](https://github.com/ClickHouse/ClickHouse/pull/71966)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* サブクエリ内で使用される EXPLAIN AST では SELECT クエリのみを許可しました。その他の種類のクエリを使用すると、論理エラー（&#39;Bad cast from type DB::ASTCreateQuery to DB::ASTSelectWithUnionQuery&#39; または `Inconsistent AST formatting`）が発生します。 [#71982](https://github.com/ClickHouse/ClickHouse/pull/71982) ([Pavel Kruglov](https://github.com/Avogar)).
* `clickhouse-client` でレコードを挿入する際、クライアントはサーバーからカラムの定義情報を読み取ります。しかし、本来は [statistics, ttl, settings] の順序であるべきところ、誤った順序で記述してしまうバグがありました。[#71991](https://github.com/ClickHouse/ClickHouse/pull/71991) ([Han Fei](https://github.com/hanfei1991))。
* `format_alter_commands_with_parentheses` が有効な場合に、`MOVE PARTITION ... TO TABLE ...` の ALTER コマンドのフォーマットを修正しました。 [#72080](https://github.com/ClickHouse/ClickHouse/pull/72080) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* 並列レプリカを使用するクエリにおける RIGHT / FULL JOIN の不具合を修正しました。これにより、RIGHT JOIN は並列レプリカで実行できるようになりました（右テーブルの読み取りが分散されます）。FULL JOIN はノード間で並列化できないため、ローカルで実行されます。 [#71162](https://github.com/ClickHouse/ClickHouse/pull/71162) ([Igor Nikonov](https://github.com/devcrafter))。
* 制限されたシステムコールが原因で、Docker コンテナ内の ClickHouse が stderr に &quot;get&#95;mempolicy: Operation not permitted&quot; を出力していた問題を修正しました。 [#70900](https://github.com/ClickHouse/ClickHouse/pull/70900) ([filimonov](https://github.com/filimonov)).
* `attach` スレッドではなく、再起動スレッド内で ZooKeeper の `metadata_version` レコードを修正するようにしました。 [#70297](https://github.com/ClickHouse/ClickHouse/pull/70297) ([Miсhael Stetsyuk](https://github.com/mstetsyuk))。
* これはサポート対象外であり、今後完全に削除される予定の「zero-copy」レプリケーションに対する修正です。zero-copy レプリケーションを使用する ReplicatedMergeTree で、その blob を使用しているノードが存在する場合は、その blob を削除しないようにしました。 [#71186](https://github.com/ClickHouse/ClickHouse/pull/71186) ([Antonio Andelic](https://github.com/antonio2368)).
* これはサポートされておらず、今後完全に削除される予定の「zero-copy」レプリケーションに対する修正です。Keeper が利用できない場合のデータ損失の可能性を防ぐため、パーツを zero-copy ディスクに移動する前に zero-copy の共有ロックを取得するようにしました。 [#71845](https://github.com/ClickHouse/ClickHouse/pull/71845) ([Aleksei Filatov](https://github.com/aalexfvk))。



### <a id="2410"></a> ClickHouse リリース 24.10, 2024-10-31 {#a-id2410a-clickhouse-release-2410-2024-10-31}

#### 互換性のない変更 {#backward-incompatible-change-2}
* サブクエリがかっこで囲まれている場合、`UNION` を含むクエリチェーンで `FORMAT` の前に `SETTINGS` を記述できるようになりました。これにより [#39712](https://github.com/ClickHouse/ClickHouse/issues/39712) が解決されます。さらに、1つのクエリ内で `SETTINGS` 句が連続して2回指定されている場合の動作を変更しました。対応するサブクエリに最も近い `SETTINGS` 句が優先されます。以前のバージョンでは、より外側の `SETTINGS` 句が内側よりも優先される場合がありました。 [#68614](https://github.com/ClickHouse/ClickHouse/pull/68614) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* デフォルトで `[PRE]WHERE` 句に含まれるフィルタ条件の並べ替えが許可されるようになりました。これは `allow_reorder_prewhere_conditions` を `false` に設定することで無効化できます。 [#70657](https://github.com/ClickHouse/ClickHouse/pull/70657) ([Nikita Taranov](https://github.com/nickitat)).
* ライセンスが非互換な `idxd-config` ライブラリを削除しました。これに伴い、実験的な Intel DeflateQPL コーデックも削除されました。 [#70987](https://github.com/ClickHouse/ClickHouse/pull/70987) ([Alexey Milovidov](https://github.com/alexey-milovidov)).



#### 新機能 {#new-feature-2}

* ワイルドカード接頭辞を持つテーブルへのアクセスを許可できるようにしました。`GRANT SELECT ON db.table_pefix_* TO user`。 [#65311](https://github.com/ClickHouse/ClickHouse/pull/65311)（[pufit](https://github.com/pufit)）。
* クエリの実行中にスペースバーを押すと、クライアントは詳細なメトリクスを含むリアルタイムのテーブルを表示します。`clickhouse-client` では、新しい `--progress-table` オプションによってこれをグローバルに有効化できます。新しい `--enable-progress-table-toggle` オプションは `--progress-table` に関連付けられており、Ctrl+Space を押すことで進捗テーブルの描画を切り替えます。 [#63689](https://github.com/ClickHouse/ClickHouse/pull/63689) ([Maria Khristenko](https://github.com/mariaKhr))、[#70423](https://github.com/ClickHouse/ClickHouse/pull/70423) ([Julia Kartseva](https://github.com/jkartseva))。
* ETag とファイルパスから生成したハッシュをキャッシュキーとして使用し、オブジェクトストレージ用テーブルエンジンおよびデータレイク向けに読み込むファイルをキャッシュできるようにしました。 [#70135](https://github.com/ClickHouse/ClickHouse/pull/70135) ([Kseniia Sumarokova](https://github.com/kssenii)).
* クエリ `CREATE TABLE ... CLONE AS ...` を用いたテーブル作成をサポートします。これは、ソーステーブルのスキーマをクローンし、その後すべてのパーティションを新しく作成されたテーブルにアタッチします。この機能は `MergeTree` ファミリーのテーブルでのみサポートされます。[#65015](https://github.com/ClickHouse/ClickHouse/issues/65015) をクローズします。 [#69091](https://github.com/ClickHouse/ClickHouse/pull/69091) ([tuanpach](https://github.com/tuanpach))。
* 新しいシステムテーブル `system.query_metric_log` を追加しました。これは、個々のクエリごとに `system.events` テーブルから取得したメモリおよびメトリクス値の履歴を保持し、定期的にディスクにフラッシュします。 [#66532](https://github.com/ClickHouse/ClickHouse/pull/66532) ([Pablo Marcos](https://github.com/pamarcos))。
* 簡単な SELECT クエリは、暗黙の SELECT を使用して電卓スタイルの式を有効にする形で記述できます（例: `ch "1 + 2"`）。これは新しい設定項目 `implicit_select` によって制御されます。 [#68502](https://github.com/ClickHouse/ClickHouse/pull/68502) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* フォーマット変換のためのショートカットとして `--copy` モードを clickhouse local でサポートしました [#68503](https://github.com/ClickHouse/ClickHouse/issues/68503)。[#68583](https://github.com/ClickHouse/ClickHouse/pull/68583)（[Denis Hananein](https://github.com/denis-hananein)）。
* `/merges` パスで利用できる、マージを可視化するための組み込み HTML ページを追加しました。 [#70821](https://github.com/ClickHouse/ClickHouse/pull/70821) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* `arrayUnion` 関数のサポートを追加しました。 [#68989](https://github.com/ClickHouse/ClickHouse/pull/68989) ([Peter Nguyen](https://github.com/petern48))。
* パラメータ付き SQL エイリアスを許可。[#50665](https://github.com/ClickHouse/ClickHouse/pull/50665)（[Anton Kozlov](https://github.com/tonickkozlov)）。
* 新しい集約関数 `quantileExactWeightedInterpolated` が追加されました。これは `quantileExactWeighted` に基づく補間を行うバージョンです。すでに `quantileExactInterpolatedWeighted` があるのに、なぜ新しい `quantileExactWeightedInterpolated` が必要なのかと疑問に思うかもしれません。その理由は、新しい関数の方が既存のものよりも高い精度を持つためです。これは Spark との互換性のためのものです。 [#69619](https://github.com/ClickHouse/ClickHouse/pull/69619) ([李扬](https://github.com/taiyang-li))。
* 新しい関数 `arrayElementOrNull` を追加しました。配列インデックスが範囲外の場合、または Map のキーが存在しない場合に `NULL` を返します。 [#69646](https://github.com/ClickHouse/ClickHouse/pull/69646) ([李扬](https://github.com/taiyang-li))。
* `config.xml` ファイル内に新たに追加された `message_regexp` および `message_regexp_negative` フィールドを通じて正規表現を指定し、ログをフィルタリングできるようにしました。ログ出力は、開発者にとって直感的な体験を提供するため、カラー装飾なしの整形テキストに対して適用されます。[#69657](https://github.com/ClickHouse/ClickHouse/pull/69657) ([Peter Nguyen](https://github.com/petern48))。
* `RIPEMD160` 関数を追加しました。この関数は文字列の RIPEMD-160 暗号学的ハッシュ値を計算します。例: `SELECT HEX(RIPEMD160('The quick brown fox jumps over the lazy dog'))` は `37F332F68DB77BD9D7EDD4969571AD671CF9DD3B` を返します。 [#70087](https://github.com/ClickHouse/ClickHouse/pull/70087) ([Dergousov Maxim](https://github.com/m7kss1))。
* `HDFS` 上の `Iceberg` テーブルの読み込みをサポートします。 [#70268](https://github.com/ClickHouse/ClickHouse/pull/70268) ([flynn](https://github.com/ucasfl))
* `WITH ... INSERT` 形式の CTE をサポートするようになりました。以前は `INSERT ... WITH ...` のみをサポートしていました。 [#70593](https://github.com/ClickHouse/ClickHouse/pull/70593) ([Shichao Jin](https://github.com/jsc0218)).
* MongoDB 連携: すべての MongoDB 型のサポート、MongoDB 側での WHERE および ORDER BY ステートメントのサポート、MongoDB でサポートされない式に対する制限。なお、新しい連携はデフォルトで無効になっているため、使用するにはサーバー設定で `<use_legacy_mongodb_integration>` を `false` に設定してください。[#63279](https://github.com/ClickHouse/ClickHouse/pull/63279) ([Kirill Nikiforov](https://github.com/allmazz))。
* カスタム設定が現在のプロファイル内に見つからない場合に、例外をスローせずにデフォルト値を返す新しい関数 `getSettingOrDefault` が追加されました。 [#69917](https://github.com/ClickHouse/ClickHouse/pull/69917) ([Shankar](https://github.com/shiyer7474)).



#### 実験的機能 {#experimental-feature-1}
* リフレッシュ可能なマテリアライズドビューが本番利用可能になりました。[#70550](https://github.com/ClickHouse/ClickHouse/pull/70550)（[Michael Kolupaev](https://github.com/al13n321)）。リフレッシュ可能なマテリアライズドビューは、Replicated データベースでもサポートされるようになりました。[#60669](https://github.com/ClickHouse/ClickHouse/pull/60669)（[Michael Kolupaev](https://github.com/al13n321)）。
* Parallel replicas は experimental から beta に移行しました。parallel replicas アルゴリズムの動作を制御する設定が再設計されました。簡単におさらいすると、ClickHouse には複数のレプリカを用いた並列読み取りのための 4 種類のアルゴリズムがあり、これは設定 `parallel_replicas_mode` に反映されています。デフォルト値は `read_tasks` です。さらに、トグル型の設定 `enable_parallel_replicas` が追加されました。[#63151](https://github.com/ClickHouse/ClickHouse/pull/63151)（[Alexey Milovidov](https://github.com/alexey-milovidov)）、（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* `Dynamic` 内部の型に対して実行することで、ほとんどの関数で `Dynamic` 型をサポートしました。[#69691](https://github.com/ClickHouse/ClickHouse/pull/69691)（[Pavel Kruglov](https://github.com/Avogar)）。
* 設定 `input_format_binary_read_json_as_string/output_format_binary_write_json_as_string` を有効にすると、`RowBinary` フォーマットにおいて `JSON` 型をバイナリ文字列として読み書きできるようになりました。[#70288](https://github.com/ClickHouse/ClickHouse/pull/70288)（[Pavel Kruglov](https://github.com/Avogar)）。
* Native フォーマットで `JSON` 列を単一の String 列としてシリアライズ/デシリアライズできるようになりました。出力には設定 `output_format_native_write_json_as_string` を使用します。入力では、列データの前にシリアライズバージョン `1` を指定します。[#70312](https://github.com/ClickHouse/ClickHouse/pull/70312)（[Pavel Kruglov](https://github.com/Avogar)）。
* MergeTree テーブルに対して特別な（実験的な）マージセレクターモードを導入しました。これは、パーツ数の上限に近いパーティションに対して、より積極的に動作するようにします。`merge_selector_use_blurry_base` という MergeTree レベルの設定で制御されます。[#70645](https://github.com/ClickHouse/ClickHouse/pull/70645)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* Avro の `Union` 型と ClickHouse の `Variant` 型間の汎用的なシリアライズ/デシリアライズを実装しました。[#69713](https://github.com/ClickHouse/ClickHouse/issues/69713) を解決します。[#69712](https://github.com/ClickHouse/ClickHouse/pull/69712)（[Jiří Kozlovský](https://github.com/jirislav)）。



#### パフォーマンスの向上 {#performance-improvement-2}

* `IDisk` と `IObjectStorage` をリファクタリングしてパフォーマンスを向上しました。`plain` および `plain_rewritable` オブジェクトストレージ上のテーブルがより高速に初期化されます。[#68146](https://github.com/ClickHouse/ClickHouse/pull/68146) ([Alexey Milovidov](https://github.com/alexey-milovidov), [Julia Kartseva](https://github.com/jkartseva))。plain&#95;rewritable ディスク上でファイルまたはディレクトリの存在確認を行う際、コスト効率が悪くなり得るため LIST オブジェクトストレージ API を呼び出さないようにしました。[#70852](https://github.com/ClickHouse/ClickHouse/pull/70852) ([Julia Kartseva](https://github.com/jkartseva))。plain&#95;rewritable ディスクにおけるオブジェクトストレージ HEAD API のリクエスト数を削減しました。[#70915](https://github.com/ClickHouse/ClickHouse/pull/70915) ([Julia Kartseva](https://github.com/jkartseva))。
* データを直接スパースカラムにパースする機能を追加しました。 [#69828](https://github.com/ClickHouse/ClickHouse/pull/69828) ([Anton Popov](https://github.com/CurtizJ)).
* 欠損値が多いフォーマット（例: `JSONEachRow`）の解析パフォーマンスを改善しました。 [#69875](https://github.com/ClickHouse/ClickHouse/pull/69875) ([Anton Popov](https://github.com/CurtizJ)).
* Parquet の row group の並列読み取りと、シングルスレッドモードでの row group の先読みをサポートします。[#69862](https://github.com/ClickHouse/ClickHouse/pull/69862) ([LiuNeng](https://github.com/liuneng1994)).
* `pointInPolygon` に minmax インデックスのサポートを追加。[#62085](https://github.com/ClickHouse/ClickHouse/pull/62085) ([JackyWoo](https://github.com/JackyWoo))。
* Parquet ファイルの読み取り時にブルームフィルターを使用します。 [#62966](https://github.com/ClickHouse/ClickHouse/pull/62966) ([Arthur Passos](https://github.com/arthurpassos))。
* INSERT が SELECT に影響しないようにするため、パーツのリネームをロックフリー化しました（パーツロックによる影響を回避）。通常の状況で `fsync_part_directory` を有効にした場合、INSERT と並行して実行される SELECT の QPS が 2 倍に向上し、重負荷時には効果はさらに大きくなります。なお、現時点では `ReplicatedMergeTree` のみが対象です。 [#64955](https://github.com/ClickHouse/ClickHouse/pull/64955) ([Azat Khuzhin](https://github.com/azat))。
* `materialize ttl` で `ttl_only_drop_parts` の設定を反映し、TTL を再計算してパーツを空のパーツに置き換えて削除する際に必要な列だけを読み込むようにしました。 [#65488](https://github.com/ClickHouse/ClickHouse/pull/65488) ([Andrey Zvonov](https://github.com/zvonand)).
* ThreadPool におけるスレッド生成処理を最適化し、ロック競合を最小限に抑えました。スレッド生成はクリティカルセクションの外側で実行されるようになり、高負荷時のジョブスケジューリングおよびスレッド管理における遅延を回避します。これにより、高い同時実行負荷下でも ClickHouse の応答性が大幅に向上します。 [#68694](https://github.com/ClickHouse/ClickHouse/pull/68694) ([filimonov](https://github.com/filimonov)).
* `ORC` 形式から `LowCardinality` 文字列カラムを読み取れるようにしました。 [#69481](https://github.com/ClickHouse/ClickHouse/pull/69481) ([李扬](https://github.com/taiyang-li))
* `part_log`、`query_views_log`、`filesystem_cache_log` などのシステムログ内の `ProfileEvents` で `LowCardinality` を使用するようにしました。 [#70152](https://github.com/ClickHouse/ClickHouse/pull/70152) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* `fromUnixTimestamp`/`toUnixTimestamp` 関数のパフォーマンスを向上。[#71042](https://github.com/ClickHouse/ClickHouse/pull/71042)（[kevinyhzou](https://github.com/KevinyhZou)）。
* ブロッキング I/O を扱う際に、サーバー全体でページキャッシュからのノンブロッキング読み取りを無効化しないようにしました。特定のファイルシステム（例: tmpfs）のみが `preadv2` システムコールをサポートしておらず、他はサポートしている場合に、これがパフォーマンス低下を引き起こしていました。 [#70299](https://github.com/ClickHouse/ClickHouse/pull/70299) ([Antonio Andelic](https://github.com/antonio2368)).
* `ALTER TABLE .. REPLACE PARTITION` は、他のパーティションで発生している mutation や merge の完了を待機しなくなりました。 [#59138](https://github.com/ClickHouse/ClickHouse/pull/59138) ([Vasily Nemkov](https://github.com/Enmk)).
* Keeper から ACL を同期するときには検証を行わないようにしました。作成時には既に検証されています。本来はそれほど問題にはなりませんが、ユーザーが数万、あるいはそれ以上作成されている環境では、不要なハッシュ検証によってサーバー起動中に（Keeper からすべてを同期するため）、処理が完了するまでに長時間かかる場合があります。[#70644](https://github.com/ClickHouse/ClickHouse/pull/70644)（[Raúl Marín](https://github.com/Algunenano)）。





#### 改善 {#improvement-2}

* `CREATE TABLE AS` は、`PRIMARY KEY`、`ORDER BY`、およびそれらに類似する句（`MergeTree` テーブルのもの）をコピーします。[#69739](https://github.com/ClickHouse/ClickHouse/pull/69739) ([sakulali](https://github.com/sakulali))。
* Keeper で 64-bit XID のサポートを追加しました。`use_xid_64` 設定値で有効化できます。[#69908](https://github.com/ClickHouse/ClickHouse/pull/69908)（[Antonio Andelic](https://github.com/antonio2368)）。
* Bool 型の設定に対するコマンドライン引数は、引数に値が指定されなかった場合に true に設定されます（例: `clickhouse-client --optimize_aggregation_in_order --query "SELECT 1"`）。 [#70459](https://github.com/ClickHouse/ClickHouse/pull/70459) ([davidtsuk](https://github.com/davidtsuk))。
* ほぼ満杯のディスクへの挿入を防ぐため、ユーザーレベル設定 `min_free_disk_bytes_to_perform_insert` および `min_free_disk_perform_to_throw_insert` を追加しました。 [#69755](https://github.com/ClickHouse/ClickHouse/pull/69755) ([Marco Vilas Boas](https://github.com/marco-vb)).
* 設定に対する組み込みドキュメントは、ウェブサイト上のドキュメントよりも必ず詳細かつ完全なものになります。これは、ウェブサイトのドキュメントを常にソースコードから自動生成するようにするための最初のステップです。これは長期的には次のような効果があります。- すべての設定項目が必ず網羅されることが保証される; - 既定値（デフォルト値）が古くなることがなくなる; - 各 ClickHouse バージョンごとにこのドキュメントを生成できる; - インターネット接続がなくてもサーバー自身がドキュメントを表示できるようになる。ウェブサイト上のドキュメントをソースコードから生成する。[#70289](https://github.com/ClickHouse/ClickHouse/pull/70289) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* 関数 `replace` で空の needle を許可し、PostgreSQL と同じ動作にしました。[#69918](https://github.com/ClickHouse/ClickHouse/pull/69918)（[zhanglistar](https://github.com/zhanglistar)）。
* 関数 `replaceRegexp*` で空の検索パターンを使用できるようにしました。 [#70053](https://github.com/ClickHouse/ClickHouse/pull/70053) ([zhanglistar](https://github.com/zhanglistar)).
* `data/database_name/` ディレクトリ内のテーブルに対するシンボリックリンクは、デフォルトディスク上の `store/...` ディレクトリではなく、ストレージポリシーに応じてテーブルデータの実際のパスを指すように作成されるようになりました。 [#61777](https://github.com/ClickHouse/ClickHouse/pull/61777) ([Kirill](https://github.com/kirillgarbar)).
* `JSON` から `Enum` フィールドをパースする際、整数値を表す文字列は対応する `Enum` 要素として解釈されます。これにより [#65119](https://github.com/ClickHouse/ClickHouse/issues/65119) が解決されました。 [#66801](https://github.com/ClickHouse/ClickHouse/pull/66801) ([scanhex12](https://github.com/scanhex12))。
* 空文字列を対象とする `TRIM` の `LEADING` または `TRAILING` を、何もしない操作として扱うようにしました。 [#67792](https://github.com/ClickHouse/ClickHouse/issues/67792) をクローズ。 [#68455](https://github.com/ClickHouse/ClickHouse/pull/68455)（[Peter Nguyen](https://github.com/petern48)）。
* `cast(timestamp as String)` の Spark との互換性を改善しました。 [#69179](https://github.com/ClickHouse/ClickHouse/pull/69179) ([Wenzheng Liu](https://github.com/lwz9103)).
* `enable_analyzer` が `true` に設定されている場合、定数式の計算には常に新しいアナライザーを使用します。定数式に対して `SELECT` クエリを使用しなくても、`executable` テーブル関数の引数を計算できるようにしました。 [#69292](https://github.com/ClickHouse/ClickHouse/pull/69292) ([Dmitry Novik](https://github.com/novikd))。
* 識別子に特殊文字を使用できないようにする設定項目 `enable_secure_identifiers` を追加しました。 [#69411](https://github.com/ClickHouse/ClickHouse/pull/69411) ([tuanpach](https://github.com/tuanpach)).
* `SHOW CREATE TABLE` クエリ結果における識別子の引用動作を定義するために `show_create_query_identifier_quoting_rule` を追加しました。指定可能な値: - `user_display`: 識別子がキーワードである場合。 - `when_necessary`: 識別子が `{"distinct", "all", "table"}` のいずれかであり、かつカラム名やディクショナリの属性名など、あいまいさを引き起こしうる場合。 - `always`: 常に識別子を引用符で囲みます。 [#69448](https://github.com/ClickHouse/ClickHouse/pull/69448) ([tuanpach](https://github.com/tuanpach)).
* アクセスエンティティの依存関係の復元処理を改善 [#69563](https://github.com/ClickHouse/ClickHouse/pull/69563) ([Vitaly Baranov](https://github.com/vitlibar))。
* `clickhouse-client` やその他の CLI アプリケーションを実行したときに、サーバーの過負荷が原因で起動が遅くなり、その間に `SELECT` のようなクエリの入力を開始すると、これまでのバージョンではウェルカムメッセージを表示する前に、ターミナルのエコーに残っていた内容が表示されてしまい、`ClickHouse local version 24.10.1.1.` ではなく `SELECTClickHouse local version 24.10.1.1.` のように表示されていました。この問題は修正されました。これにより [#31696](https://github.com/ClickHouse/ClickHouse/issues/31696) がクローズされました。[#69856](https://github.com/ClickHouse/ClickHouse/pull/69856) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* `system.replicas` テーブルに新しいカラム `readonly_duration` を追加しました。アラートで、実際の readonly レプリカと sentinel レプリカを区別できるようにするために必要です。 [#69871](https://github.com/ClickHouse/ClickHouse/pull/69871) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* `join_output_by_rowlist_perkey_rows_threshold` 設定の型を符号なし整数型に変更しました。 [#69886](https://github.com/ClickHouse/ClickHouse/pull/69886) ([kevinyhzou](https://github.com/KevinyhZou))。
* OpenTelemetry のスパンログを拡張し、クエリ設定を含めるようにしました。 [#70011](https://github.com/ClickHouse/ClickHouse/pull/70011) ([sharathks118](https://github.com/sharathks118)).
* 高階配列関数でラムダ式の結果型が期待される型と異なる場合の診断情報を追加しました。 [#70093](https://github.com/ClickHouse/ClickHouse/pull/70093) ([ttanay](https://github.com/ttanay)).
* Keeper の改善: クラスター変更時のロックを軽減。 [#70275](https://github.com/ClickHouse/ClickHouse/pull/70275) ([Antonio Andelic](https://github.com/antonio2368)).
* `SHOW GRANTS` コマンドに `WITH IMPLICIT` と `FINAL` キーワードを追加しました。暗黙的な権限付与に関する軽微なバグを修正しました（[#70094](https://github.com/ClickHouse/ClickHouse/issues/70094)）。 [#70293](https://github.com/ClickHouse/ClickHouse/pull/70293) ([pufit](https://github.com/pufit))。
* MergeTree の設定に `compatibility` を反映するようにしました。`compatibility` の値はサーバー起動時に `default` プロファイルから取得され、それに応じてデフォルトの MergeTree 設定が変更されます。その後に `compatibility` 設定を変更しても、MergeTree の設定には影響しません。 [#70322](https://github.com/ClickHouse/ClickHouse/pull/70322) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* サーバー間通信中のエラー発生時に、大きな HTTP レスポンスボディが大量に出力されてログを埋め尽くしてしまわないようにします。 [#70487](https://github.com/ClickHouse/ClickHouse/pull/70487) ([Vladimir Cherkasov](https://github.com/vdimir)).
* 一度に移動できるパーツの数の上限を制御する新しい設定 `max_parts_to_move` を追加しました。 [#70520](https://github.com/ClickHouse/ClickHouse/pull/70520) ([Vladimir Cherkasov](https://github.com/vdimir)).
* 特定のログメッセージが出力される頻度を制限しました。 [#70601](https://github.com/ClickHouse/ClickHouse/pull/70601) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* `PART` 修飾子付きの `CHECK TABLE` がクライアントで誤った形式で表示されていました。[#70660](https://github.com/ClickHouse/ClickHouse/pull/70660) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Parquet ネイティブ writer でカラムインデックスとオフセットインデックスを書き込めるようにしました。 [#70669](https://github.com/ClickHouse/ClickHouse/pull/70669) ([LiuNeng](https://github.com/liuneng1994)).
* `DateTime64` のマイクロ秒およびタイムゾーンを含む値を joda 構文でパースできるようにしました（「joda」は日付と時刻向けの代表的な Java ライブラリであり、「joda 構文」はそのライブラリ固有の書式指定スタイルです）。 [#70737](https://github.com/ClickHouse/ClickHouse/pull/70737) ([kevinyhzou](https://github.com/KevinyhZou)).
* クラウドストレージが[バッチ削除 (batch delete)](https://docs.aws.amazon.com/AmazonS3/latest/API/API_DeleteObjects.html)をサポートしているかどうかを判別するアプローチを変更しました。 [#70786](https://github.com/ClickHouse/ClickHouse/pull/70786) ([Vitaly Baranov](https://github.com/vitlibar))。
* ネイティブリーダーでの Parquet page v2 のサポート。[#70807](https://github.com/ClickHouse/ClickHouse/pull/70807) ([Arthur Passos](https://github.com/arthurpassos))。
* テーブルに `storage_policy` と `disk` の両方が設定されているかどうかを確認するチェックを追加しました。`disk` 設定を使用している場合に、新しいストレージポリシーが既存のものと互換性があるかどうかを確認するチェックも追加しました。 [#70839](https://github.com/ClickHouse/ClickHouse/pull/70839) ([Kirill](https://github.com/kirillgarbar))。
* `system.s3_queue_settings` と `system.azure_queue_settings` を追加。 [#70841](https://github.com/ClickHouse/ClickHouse/pull/70841) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 関数 `base58Encode` と `base58Decode` は、`FixedString` 型の引数を受け取れるようになりました。例：`SELECT base58Encode(toFixedString('plaintext', 9));`。[#70846](https://github.com/ClickHouse/ClickHouse/pull/70846)（[Faizan Patel](https://github.com/faizan2786)）。
* パートログのすべてのエントリタイプに `partition` カラムを追加しました。以前は一部のエントリに対してのみ設定されていました。これにより [#70819](https://github.com/ClickHouse/ClickHouse/issues/70819) が解決されました。[#70848](https://github.com/ClickHouse/ClickHouse/pull/70848)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* `system.part_log` に `MergeStart` および `MutateStart` イベントを追加し、マージの分析と可視化に役立つようにしました。 [#70850](https://github.com/ClickHouse/ClickHouse/pull/70850) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* マージ元ソースパーツ数に関するプロファイルイベントを追加しました。これにより、本番環境で MergeTree のファンアウトを監視できます。[#70908](https://github.com/ClickHouse/ClickHouse/pull/70908)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* バックグラウンドでのファイルシステムキャッシュへのダウンロードが再度有効になりました。 [#70929](https://github.com/ClickHouse/ClickHouse/pull/70929) ([Nikita Taranov](https://github.com/nickitat)).
* プロフェッショナル用途専用として、`Trivial` という名前の新しいマージセレクタアルゴリズムを追加しました。これは `Simple` マージセレクタよりも性能が劣ります。[#70969](https://github.com/ClickHouse/ClickHouse/pull/70969) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* アトミックな `CREATE OR REPLACE VIEW` のサポートを追加。 [#70536](https://github.com/ClickHouse/ClickHouse/pull/70536) ([tuanpach](https://github.com/tuanpach))
* 集約関数 `windowFunnel` に `strict_once` モードを追加し、複数の条件に一致する場合に同一イベントが複数回カウントされるのを防ぎました。 [#21835](https://github.com/ClickHouse/ClickHouse/issues/21835) をクローズ。 [#69738](https://github.com/ClickHouse/ClickHouse/pull/69738) ([Vladimir Cherkasov](https://github.com/vdimir)).





#### バグ修正（公式安定版リリースにおけるユーザー可視の不具合） {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-2}

* グローバルコンテキストオブジェクトで設定の更新を適用するようにしました。これにより、[#62308](https://github.com/ClickHouse/ClickHouse/issues/62308) のような問題が修正されます。[#62944](https://github.com/ClickHouse/ClickHouse/pull/62944)（[Amos Bird](https://github.com/amosbird)）。
* `ReadSettings` がユーザーが設定した値を使用せず、デフォルト値のみが使用されていた問題を修正しました。 [#65625](https://github.com/ClickHouse/ClickHouse/pull/65625) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 符号付き引数を使用する際の `sumMapFiltered` における型不一致の問題を修正。[#58408](https://github.com/ClickHouse/ClickHouse/pull/58408) ([Chen768959](https://github.com/Chen768959))。
* オプションのタイムゾーン引数が渡された場合における、toHour 系の変換関数の単調性の問題を修正しました。 [#60264](https://github.com/ClickHouse/ClickHouse/pull/60264) ([Amos Bird](https://github.com/amosbird)).
* `Merge` テーブルに対する `supportsPrewhere` チェックを緩和しました。これにより [#61064](https://github.com/ClickHouse/ClickHouse/issues/61064) を修正しました。このチェックは [#60082](https://github.com/ClickHouse/ClickHouse/issues/60082) において過度に厳格化されていました。[#61091](https://github.com/ClickHouse/ClickHouse/pull/61091)（[Amos Bird](https://github.com/amosbird)）。
* `concurrent_threads_soft_limit_num` の制限を正しく適用できるように、`use_concurrency_control` 設定の扱いを修正しました。これにより、以前は正しく機能していなかった同時実行制御がデフォルトで有効になります。[#61473](https://github.com/ClickHouse/ClickHouse/pull/61473) ([Sergei Trifonov](https://github.com/serxa))。
* `IS NULL` チェックが（`NOT` などの）他の関数の内部にある場合に誤った結果を招く可能性のある、`JOIN ON` 節の誤った最適化を修正しました。 [#67915](https://github.com/ClickHouse/ClickHouse/issues/67915) をクローズしました。 [#68049](https://github.com/ClickHouse/ClickHouse/pull/68049)（[Vladimir Cherkasov](https://github.com/vdimir)）。
* テーブルの `CREATE` クエリを不正なものにしてしまうような `ALTER` クエリを防止します。 [#68574](https://github.com/ClickHouse/ClickHouse/pull/68574) ([János Benjamin Antal](https://github.com/antaljanosbenjamin))。
* タプルおよび配列に対する `negate` (`-`) および `NOT` 関数の AST フォーマットの不整合を修正。 [#68600](https://github.com/ClickHouse/ClickHouse/pull/68600) ([Vladimir Cherkasov](https://github.com/vdimir)).
* デシリアライズ時に不完全な型が `Dynamic` に挿入される問題を修正しました。これが原因で `Parameter out of bound` エラーが発生する可能性がありました。 [#69291](https://github.com/ClickHouse/ClickHouse/pull/69291) ([Pavel Kruglov](https://github.com/Avogar)).
* ゼロコピー レプリケーション（実験的機能であり、本番環境での使用は推奨されません）：ゼロコピー対応の ReplicatedMergeTree において、`restore replica` 実行後に発生する無限ループを修正しました。 [#69293](https://github.com/CljmnickHouse/ClickHouse/pull/69293) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* ストレージエンジン `S3Queue` において、`processing_threads_num` のデフォルト値を CPU コア数に戻しました。 [#69384](https://github.com/ClickHouse/ClickHouse/pull/69384) ([Kseniia Sumarokova](https://github.com/kssenii)).
* ネストされた repeated フィールドを持つ protobuf をネストされたカラムにシリアライズ／デシリアライズする際に、try/catch フローを経由しないようにしました（[#41971](https://github.com/ClickHouse/ClickHouse/issues/41971) を修正）。[#69556](https://github.com/ClickHouse/ClickHouse/pull/69556)（[Eliot Hautefeuille](https://github.com/hileef)）。
* PostgreSQL エンジンで FixedString 型カラムへの挿入時に発生していたクラッシュを修正。 [#69584](https://github.com/ClickHouse/ClickHouse/pull/69584) ([Pavel Kruglov](https://github.com/Avogar)).
* `create view t as (with recursive 42 as ttt select ttt);` を実行したときに発生していたクラッシュを修正。 [#69676](https://github.com/ClickHouse/ClickHouse/pull/69676) ([Han Fei](https://github.com/hanfei1991)).
* 値の型が DateTime64 の場合に `maxMapState` が &#39;Bad get&#39; をスローしていた不具合を修正。 [#69787](https://github.com/ClickHouse/ClickHouse/pull/69787) ([Michael Kolupaev](https://github.com/al13n321)).
* `useDefaultImplementationForLowCardinalityColumns` をオーバーライドして `true` を返すようにし、`LowCardinality` カラムに対する `getSubcolumn` を修正しました。 [#69831](https://github.com/ClickHouse/ClickHouse/pull/69831) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* 分散テーブルの DROP が失敗した場合に発生する、恒久的にブロックされた分散送信の問題を修正しました。 [#69843](https://github.com/ClickHouse/ClickHouse/pull/69843) ([Azat Khuzhin](https://github.com/azat)).
* WITH FILL と NaN キーを含む、キャンセルできないクエリを修正します。これにより [#69261](https://github.com/ClickHouse/ClickHouse/issues/69261) がクローズされます。[#69845](https://github.com/ClickHouse/ClickHouse/pull/69845)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 旧互換値を使用するアナライザーのデフォルトを修正。 [#69895](https://github.com/ClickHouse/ClickHouse/pull/69895) ([Raúl Marín](https://github.com/Algunenano)).
* 古いテーブルの DROP 処理中に実行される `CREATE OR REPLACE VIEW` において、依存関係をチェックしないようにしました。以前は、再作成されるビューに依存するテーブルが存在する場合、`CREATE OR REPLACE` クエリが失敗していました。[#69907](https://github.com/ClickHouse/ClickHouse/pull/69907) ([Pavel Kruglov](https://github.com/Avogar))。
* Decimal 関連の修正。[#69730](https://github.com/ClickHouse/ClickHouse/issues/69730) を解決。[#69978](https://github.com/ClickHouse/ClickHouse/pull/69978)（[Arthur Passos](https://github.com/arthurpassos)）。
* これで、パラメータ化されたビューでも DEFINER/INVOKER を利用できるようになりました。 [#69984](https://github.com/ClickHouse/ClickHouse/pull/69984) ([pufit](https://github.com/pufit)).
* ビューの DEFINER 句のパースを修正。 [#69985](https://github.com/ClickHouse/ClickHouse/pull/69985) ([pufit](https://github.com/pufit)).
* `Date` または `Date32` 引数を持つクエリの結果がタイムゾーン設定によって変化する可能性があった不具合を修正しました。 [#70036](https://github.com/ClickHouse/ClickHouse/pull/70036) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* ネストされたビューと `WHERE` 句を含むクエリで発生する `Block structure mismatch` エラーを修正します。[#66209](https://github.com/ClickHouse/ClickHouse/issues/66209) を修正。[#70054](https://github.com/ClickHouse/ClickHouse/pull/70054)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `tuple` 関数を評価する際に、異なる名前付きタプル間で列を再利用しないようにしました。これにより [#70022](https://github.com/ClickHouse/ClickHouse/issues/70022) を修正しました。[#70103](https://github.com/ClickHouse/ClickHouse/pull/70103)（[Amos Bird](https://github.com/amosbird)）。
* 範囲内のリテラルを置換する際に誤った LOGICAL&#95;ERROR が発生していた問題を修正。 [#70122](https://github.com/ClickHouse/ClickHouse/pull/70122) ([Pablo Marcos](https://github.com/pamarcos)).
* Nullable(Nothing) 型を持つテーブルが作成されないようにするため、ALTER TABLE MODIFY COLUMN/QUERY の実行時に Nullable(Nothing) 型をチェックするようにしました。 [#70123](https://github.com/ClickHouse/ClickHouse/pull/70123) ([Pavel Kruglov](https://github.com/Avogar)).
* 不正な `JOIN ... ON *` クエリに対して適切なエラーメッセージを出力するようにし、[#68650](https://github.com/ClickHouse/ClickHouse/issues/68650) をクローズ。[#70124](https://github.com/ClickHouse/ClickHouse/pull/70124)（[Vladimir Cherkasov](https://github.com/vdimir)）。
* スキップインデックス使用時に誤った結果が返る問題を修正。 [#70127](https://github.com/ClickHouse/ClickHouse/pull/70127) ([Raúl Marín](https://github.com/Algunenano)).
* ColumnObject/ColumnTuple の decompress メソッドにおけるデータレースを修正し、解放後ヒープ使用 (heap use after free) が発生しうる問題を防止しました。 [#70137](https://github.com/ClickHouse/ClickHouse/pull/70137) ([Pavel Kruglov](https://github.com/Avogar)).
* Dynamic 型を伴う ALTER COLUMN でハングする可能性のあった問題を修正。 [#70144](https://github.com/ClickHouse/ClickHouse/pull/70144) ([Pavel Kruglov](https://github.com/Avogar)).
* これにより、ClickHouse は再試行可能とみなすエラーの種類が増え、そのようなエラーが発生してもデータパーツを破損としてマークしなくなります。 [#70145](https://github.com/ClickHouse/ClickHouse/pull/70145) ([alesapin](https://github.com/alesapin))。
* JSON サブカラム用 Dynamic 型の作成時に正しい `max_types` パラメータを使用するようにしました。 [#70147](https://github.com/ClickHouse/ClickHouse/pull/70147) ([Pavel Kruglov](https://github.com/Avogar)).
* bcrypt パスワード認証方式を使用するユーザーについて、`system.query_log` にパスワードが表示される不具合を修正しました。 [#70148](https://github.com/ClickHouse/ClickHouse/pull/70148) ([Nikolay Degterinsky](https://github.com/evillique)).
* ネイティブインターフェイスのイベントカウンター（InterfaceNativeSendBytes）を修正しました。 [#70153](https://github.com/ClickHouse/ClickHouse/pull/70153) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* JSON 列に関連して発生する可能性のあるクラッシュを修正しました。 [#70172](https://github.com/ClickHouse/ClickHouse/pull/70172) ([Pavel Kruglov](https://github.com/Avogar)).
* arrayMin および arrayMax に関する複数の問題を修正しました。 [#70207](https://github.com/ClickHouse/ClickHouse/pull/70207) ([Raúl Marín](https://github.com/Algunenano)).
* JSON 型パーサーで設定項目 allow&#95;simdjson が正しく反映されるようにしました。[#70218](https://github.com/ClickHouse/ClickHouse/pull/70218) ([Pavel Kruglov](https://github.com/Avogar))。
* `INTERSECT` を含む 2 つの SELECT 文を使ってマテリアライズドビューを作成する際に発生するヌルポインタデリファレンスの不具合を修正しました。例: `CREATE MATERIALIZED VIEW v0 AS (SELECT 1) INTERSECT (SELECT 1);`。 [#70264](https://github.com/ClickHouse/ClickHouse/pull/70264) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* スタートアップスクリプトでグローバル設定を変更しないでください。以前は、スタートアップスクリプト内で設定を変更すると、その設定がグローバル設定として変更されていました。 [#70310](https://github.com/ClickHouse/ClickHouse/pull/70310) ([Antonio Andelic](https://github.com/antonio2368))。
* `Dynamic` 型に対する `ALTER` 操作で、`max_types` パラメータを小さくした際にサーバークラッシュを引き起こす可能性があった問題を修正。 [#70328](https://github.com/ClickHouse/ClickHouse/pull/70328) ([Pavel Kruglov](https://github.com/Avogar)).
* WITH FILL の誤った使用時に発生するクラッシュを修正。 [#70338](https://github.com/ClickHouse/ClickHouse/pull/70338) ([Raúl Marín](https://github.com/Algunenano))。
* `SYSTEM DROP FORMAT SCHEMA CACHE FOR Protobuf` における use-after-free が発生し得る問題を修正しました。 [#70358](https://github.com/ClickHouse/ClickHouse/pull/70358) ([Azat Khuzhin](https://github.com/azat)).
* GROUP BY で JSON サブオブジェクト内のサブカラムを扱う際に発生していたクラッシュを修正。 [#70374](https://github.com/ClickHouse/ClickHouse/pull/70374) ([Pavel Kruglov](https://github.com/Avogar))。
* パートに行がない場合は、vertical マージのためにそのパートをプリフェッチしないようにしました。 [#70452](https://github.com/ClickHouse/ClickHouse/pull/70452) ([Antonio Andelic](https://github.com/antonio2368)).
* lambda 関数を使用した WHERE 句で発生していたクラッシュを修正。 [#70464](https://github.com/ClickHouse/ClickHouse/pull/70464) ([Raúl Marín](https://github.com/Algunenano)).
* セカンダリレプリカ上で、データベース `Replicated` を使用しており、かつテーブル関数のソースが利用できない場合に、`CREATE ... AS table_function(...)` によるテーブル作成が行えない問題を修正。[#70511](https://github.com/ClickHouse/ClickHouse/pull/70511)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `wait_for_async_insert=1` の場合、非同期インサートのすべての出力を無視します。 [#62644](https://github.com/ClickHouse/ClickHouse/issues/62644) をクローズします。 [#70530](https://github.com/ClickHouse/ClickHouse/pull/70530) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* system.remote&#95;data&#95;paths からシャドウディレクトリを走査する際に frozen&#95;metadata.txt を無視するようにしました。 [#70590](https://github.com/ClickHouse/ClickHouse/pull/70590) ([Aleksei Filatov](https://github.com/aalexfvk)).
* アラインされていないメモリ上でステートフルなウィンドウ関数を作成してしまう問題を修正しました。 [#70631](https://github.com/ClickHouse/ClickHouse/pull/70631) ([Raúl Marín](https://github.com/Algunenano)).
* `Array` 型の列を空でないデフォルト式付きで追加した後に発生する、`SELECT` クエリやマージ処理におけるまれなクラッシュを修正しました。 [#70695](https://github.com/ClickHouse/ClickHouse/pull/70695) ([Anton Popov](https://github.com/CurtizJ)).
* `INSERT INTO TABLE FUNCTION s3` がクエリ設定を尊重するようになりました。 [#70696](https://github.com/ClickHouse/ClickHouse/pull/70696) ([Vladimir Cherkasov](https://github.com/vdimir)).
* サポートされていないフィールドのスキップが有効な場合に、Protobuf スキーマ推論時に発生する無限再帰を修正。[#70697](https://github.com/ClickHouse/ClickHouse/pull/70697) ([Raúl Marín](https://github.com/Algunenano)).
* `enable_named_columns_in_function_tuple` をデフォルトで無効化しました。 [#70833](https://github.com/ClickHouse/ClickHouse/pull/70833) ([Raúl Marín](https://github.com/Algunenano)).
* S3Queue テーブルエンジンの設定 `processing_threads_num` が、サーバー上の CPU コア数から算出された場合に有効に機能しない問題を修正しました。 [#70837](https://github.com/ClickHouse/ClickHouse/pull/70837) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 集約状態での名前付きタプル引数を正規化しました。これにより、[#69732](https://github.com/ClickHouse/ClickHouse/issues/69732) が修正されます。 [#70853](https://github.com/ClickHouse/ClickHouse/pull/70853) ([Amos Bird](https://github.com/amosbird))。
* 2 レベルのハッシュテーブルにおける負のゼロが原因の論理エラーを修正しました。これにより [#70973](https://github.com/ClickHouse/ClickHouse/issues/70973) が解決されます。[#70979](https://github.com/ClickHouse/ClickHouse/pull/70979)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 分散レプリカおよび並列レプリカでの `limit by` と `limit with ties` の動作を修正。[#70880](https://github.com/ClickHouse/ClickHouse/pull/70880) ([Nikita Taranov](https://github.com/nickitat)).



### <a id="249"></a> ClickHouse リリース 24.9, 2024-09-26 {#a-id249a-clickhouse-release-249-2024-09-26}

#### 後方互換性のない変更 {#backward-incompatible-change-3}
* `a[b].c` のような式が名前付きタプルに対してサポートされるようになり、`expr().name` のように、任意の式に対する名前付き添字もサポートされるようになりました。これは JSON の処理に有用です。この変更により [#54965](https://github.com/ClickHouse/ClickHouse/issues/54965) がクローズされました。以前のバージョンでは、`expr().name` 形式の式は `tupleElement(expr(), name)` としてパースされ、クエリアナライザーは対応するタプル要素ではなく列 `name` を検索していました。一方、新しいバージョンではこれが `tupleElement(expr(), 'name')` に変更されました。ほとんどの場合、以前のバージョンでは正しく動作していませんでしたが、この変更が非互換性を引き起こしうる、非常にまれなシナリオを想定することは可能です。例えば、タプル要素名を、タプル要素の名前とは異なる名前を持つ列またはエイリアスに格納していた場合です: `SELECT 'b' AS a, CAST([tuple(123)] AS 'Array(Tuple(b UInt8))') AS t, t[1].a`。そのようなクエリを使用している可能性は非常に低いですが、それでもこの変更は潜在的に後方互換性がないものとしてマークする必要があります。 [#68435](https://github.com/ClickHouse/ClickHouse/pull/68435)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 設定 `print_pretty_type_names` が有効な場合、`SHOW CREATE TABLE` ステートメント、`formatQuery` 関数、`clickhouse-client` および `clickhouse-local` のインタラクティブモードにおいて、`Tuple` データ型を見やすい形式で出力するようになりました。以前のバージョンでは、この設定は `DESCRIBE` クエリと `toTypeName` にのみ適用されていました。この変更により [#65753](https://github.com/ClickHouse/ClickHouse/issues/65753) がクローズされました。 [#68492](https://github.com/ClickHouse/ClickHouse/pull/68492)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* `Replicated` データベースでテーブルを作成する際に、UUID を明示的に指定することを許可しないようにしました。また、Replicated データベース内の *MergeTree テーブルに対して、Keeper パスおよびレプリカ名を明示的に指定することも許可しないようにしました。これにより、新しい設定 `database_replicated_allow_explicit_uuid` が導入され、`database_replicated_allow_replicated_engine_arguments` の型が `Bool` から `UInt64` に変更されました。 [#66104](https://github.com/ClickHouse/ClickHouse/pull/66104)（[Alexander Tokmakov](https://github.com/tavplubix)）。



#### 新機能 {#new-feature-3}

* ユーザーが一つだけでなく複数の認証方法を持てるようにします。認証方法を、最後に追加された方法にリセットできるようにします。24.8 のインスタンスを動かしつつ、しばらくの間 24.9 のインスタンスも併用したい場合は、その期間中は互換性の問題を避けるために `max_authentication_methods_per_user` = 1 に設定しておくことを推奨します。[#65277](https://github.com/ClickHouse/ClickHouse/pull/65277) ([Arthur Passos](https://github.com/arthurpassos))。
* `ATTACH PARTITION ALL FROM` のサポートを追加。[#61987](https://github.com/ClickHouse/ClickHouse/pull/61987)（[Kirill Nikiforov](https://github.com/allmazz)）。
* `input_format_json_empty_as_default` 設定を追加しました。この設定を有効にすると、JSON 入力内の空フィールドをデフォルト値として扱うようになります。[#59339](https://github.com/ClickHouse/ClickHouse/issues/59339) をクローズしました。[#66782](https://github.com/ClickHouse/ClickHouse/pull/66782)（[Alexis Arnaud](https://github.com/a-a-f)）。
* 文字列の一部を別の文字列で置き換える関数 `overlay` および `overlayUTF8` を追加しました。例：`SELECT overlay('Hello New York', 'Jersey', 11)` は `Hello New Jersey` を返します。[#66933](https://github.com/ClickHouse/ClickHouse/pull/66933) ([李扬](https://github.com/taiyang-li)).
* パーティションに対する軽量削除のサポートを追加：`DELETE FROM [db.]table [ON CLUSTER cluster] [IN PARTITION partition_expr] WHERE expr; ` [#67805](https://github.com/ClickHouse/ClickHouse/pull/67805)（[sunny](https://github.com/sunny19930321)）。
* `Interval` データ型において、秒や分など異なる単位の値を比較できるようにし、比較前にそれらを最小上位型へ変換するようにしました。[#68057](https://github.com/ClickHouse/ClickHouse/pull/68057) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
* CREATE 文において `IF NOT EXISTS` の動作をデフォルトにするため、`create_if_not_exists` 設定を追加しました。 [#68164](https://github.com/ClickHouse/ClickHouse/pull/68164) ([Peter Nguyen](https://github.com/petern48)).
* Azure およびローカル環境で `Iceberg` テーブルを読み込みできるようにしました。 [#68210](https://github.com/ClickHouse/ClickHouse/pull/68210) ([Daniil Ivanik](https://github.com/divanik))。
* クエリキャッシュのエントリをタグ指定で削除できるようになりました。たとえば、`SELECT 1 SETTINGS use_query_cache = true, query_cache_tag = 'abc'` によって作成されたクエリキャッシュエントリは、`SYSTEM DROP QUERY CACHE TAG 'abc'` で削除できます。 [#68477](https://github.com/ClickHouse/ClickHouse/pull/68477) ([Michał Tabaszewski](https://github.com/pinsvin00))。
* 名前付きコレクションにストレージ暗号化を追加しました。 [#68615](https://github.com/ClickHouse/ClickHouse/pull/68615) ([Pablo Marcos](https://github.com/pamarcos))
* `URL` テーブルエンジンに仮想カラム `_headers` を追加し、[#65026](https://github.com/ClickHouse/ClickHouse/issues/65026) をクローズ。 [#68867](https://github.com/ClickHouse/ClickHouse/pull/68867)（[flynn](https://github.com/ucasfl)）。
* 利用可能なプロジェクションを追跡するために `system.projections` テーブルを追加しました。 [#68901](https://github.com/ClickHouse/ClickHouse/pull/68901) ([Jordi Villar](https://github.com/jrdi)).
* Spark 互換性のために、新しい関数 `arrayZipUnaligned`（Spark では `arrays_zip` という名前）を追加しました。これは元の `arrayZip` に基づいており、長さの揃っていない配列も許可します。 [#69030](https://github.com/ClickHouse/ClickHouse/pull/69030) ([李扬](https://github.com/taiyang-li))。
* ノードをアトミックにコピー／移動するための Keeper クライアント向けコマンドラインアプリケーションに `cp`／`mv` コマンドを追加しました。[#69034](https://github.com/ClickHouse/ClickHouse/pull/69034) ([Mikhail Artemenko](https://github.com/Michicosun)).
* 関数 `arrayAUC` に引数 `scale`（デフォルト: `true`）を追加し、正規化処理をスキップできるようにしました（issue [#69609](https://github.com/ClickHouse/ClickHouse/issues/69609)）。 [#69717](https://github.com/ClickHouse/ClickHouse/pull/69717)（[gabrielmcg44](https://github.com/gabrielmcg44)）。



#### 実験的機能 {#experimental-feature-2}
* 設定 `input_format_try_infer_variants` を追加しました。これにより、テキストフォーマットのスキーマ推論時に、列/配列要素に対して複数の候補となる型が存在する場合に `Variant` 型を推論できるようになります。 [#63798](https://github.com/ClickHouse/ClickHouse/pull/63798) ([Shaun Struwig](https://github.com/Blargian)).
* JSON 列の型コンテンツをより詳細に調査するために、集約関数 `distinctDynamicTypes`/`distinctJSONPaths`/`distinctJSONPathsAndTypes` を追加しました。 [#68463](https://github.com/ClickHouse/ClickHouse/pull/68463) ([Kruglov Pavel](https://github.com/Avogar)).
* コンシステントハッシュにより並列レプリカ間でマークの分配単位を決定する新しいアルゴリズムを導入しました。さまざまな読み取りパターンに応じて異なる数のマークを選択することで、パフォーマンスを向上させます。 [#68424](https://github.com/ClickHouse/ClickHouse/pull/68424) ([Nikita Taranov](https://github.com/nickitat)).
* 以前は、並列レプリカのアナウンス処理におけるパーツ重複排除ロジックの計算量は O(n^2) であり、多数のパーツ（またはパーティション）を持つテーブルでは無視できない時間がかかる可能性がありました。この変更により、計算量は O(n*log(n)) になります。 [#69596](https://github.com/ClickHouse/ClickHouse/pull/69596) ([Alexander Gololobov](https://github.com/davenger)).
* 更新可能なマテリアライズドビューの改善: テーブル全体を上書きするのではなく既存テーブルに行を追加するための append モード（`... REFRESH EVERY 1 MINUTE APPEND ...`）、再試行（デフォルトでは無効で、クエリの SETTINGS セクションで設定）、現在実行中のリフレッシュが完了するまで待機する `SYSTEM WAIT VIEW <name>` クエリ、その他の修正が含まれます。 [#58934](https://github.com/ClickHouse/ClickHouse/pull/58934) ([Michael Kolupaev](https://github.com/al13n321)).
* 新しい（実験的な）統計タイプとして `min_max` を追加しました。これは、数値列に対する範囲述語（例: `x < 100`）の選択度推定をサポートします。 [#67013](https://github.com/ClickHouse/ClickHouse/pull/67013) ([JackyWoo](https://github.com/JackyWoo)).
* Variant/Dynamic 列に対する castOrDefault を改善し、内部型同士がまったく変換不可能な場合でも動作するようにしました。 [#67150](https://github.com/ClickHouse/ClickHouse/pull/67150) ([Kruglov Pavel](https://github.com/Avogar)).
* 一部の列のみのレプリケーションが MaterializedPostgreSQL を通じて利用可能になりました。 [#33748](https://github.com/ClickHouse/ClickHouse/issues/33748) をクローズします。 [#69092](https://github.com/ClickHouse/ClickHouse/pull/69092) ([Kruglov Kirill](https://github.com/1on)).



#### パフォーマンスの改善 {#performance-improvement-3}
* Hive パーティション用に必要なファイルのみを読み込むように実装しました。[#68963](https://github.com/ClickHouse/ClickHouse/pull/68963) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* LEFT または INNER ハッシュ JOIN でテーブルキーが密な場合に、右側のテーブルをキーで並べ替えることで JOIN のパフォーマンスを向上しました。[#60341](https://github.com/ClickHouse/ClickHouse/pull/60341) ([kevinyhzou](https://github.com/KevinyhZou)).
* 行リストを遅延追加することで、ALL JOIN のパフォーマンスを向上しました。[#63677](https://github.com/ClickHouse/ClickHouse/pull/63677) ([kevinyhzou](https://github.com/KevinyhZou)).
* 再起動を高速化するため、ブートプロセス中にファイルシステムキャッシュのメタデータを非同期に読み込むようにしました（設定 `load_metadata_asynchronously` で制御可能）。[#65736](https://github.com/ClickHouse/ClickHouse/pull/65736) ([Daniel Pozo Escalona](https://github.com/danipozo)).
* 関数 `array` および `map` を最適化し、いくつかの一般的なケースを大幅に高速に処理できるようにしました。[#67707](https://github.com/ClickHouse/ClickHouse/pull/67707) ([李扬](https://github.com/taiyang-li)).
* 特に列に NULL が含まれない場合に、ORC 文字列の読み取りを軽微な最適化によって高速化しました。[#67794](https://github.com/ClickHouse/ClickHouse/pull/67794) ([李扬](https://github.com/taiyang-li)).
* マージ処理ステップのスケジューリングによるオーバーヘッドを削減することで、マージ全体のパフォーマンスを改善しました。[#68016](https://github.com/ClickHouse/ClickHouse/pull/68016) ([Anton Popov](https://github.com/CurtizJ)).
* プロファイルが設定されておらず、クレデンシャルも設定されておらず、かつ IMDS が利用できない場合（例: クラウド外のマシンからパブリックバケットをクエリする場合）に S3 へのリクエストを高速化しました。これにより [#52771](https://github.com/ClickHouse/ClickHouse/issues/52771) をクローズしました。[#68082](https://github.com/ClickHouse/ClickHouse/pull/68082) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* 一部のケースでのパフォーマンス向上のために、`RowInputFormatWithNamesAndTypes` 内のフォーマットリーダーをデバーチャル化しました。[#68437](https://github.com/ClickHouse/ClickHouse/pull/68437) ([李扬](https://github.com/taiyang-li)).
* CPU 使用率を最大化するため、`uniq` 集約関数で group by キーにより集約する際に並列マージを追加しました。[#68441](https://github.com/ClickHouse/ClickHouse/pull/68441) ([Jiebin Sun](https://github.com/jiebinn)).
* ユーザーが `ORC` 出力フォーマットで文字列列に対して辞書エンコードを有効化できるようにするため、設定 `output_format_orc_dictionary_key_size_threshold` を追加しました。これにより、出力される `ORC` ファイルサイズが削減され、読み取りパフォーマンスが大幅に向上します。[#68591](https://github.com/ClickHouse/ClickHouse/pull/68591) ([李扬](https://github.com/taiyang-li)).
* ノードとその配下のすべてのサブツリーを削除する新しい Keeper リクエスト RemoveRecursive を導入しました。[#69332](https://github.com/ClickHouse/ClickHouse/pull/69332) ([Mikhail Artemenko](https://github.com/Michicosun)).
* ベクター類似性インデックスを持つテーブルへの挿入パフォーマンスを、ベクターインデックスへのデータ追加を並列化することで高速化しました。[#69493](https://github.com/ClickHouse/ClickHouse/pull/69493) ([flynn](https://github.com/ucasfl)).
* 適応的な書き込みバッファサイズを使用することで、JSON への挿入時のメモリ使用量を削減しました。ワイドパート内の JSON 列によって作成される多くのファイルは少量のデータしか含まず、それらに 1MB のバッファを割り当てるのは意味がありません。[#69272](https://github.com/ClickHouse/ClickHouse/pull/69272) ([Kruglov Pavel](https://github.com/Avogar)).
* クエリが過剰にスレッドを生成することを避けるため、並行ハッシュ JOIN のスレッドプールでスレッドを返却しないようにしました。[#69406](https://github.com/ClickHouse/ClickHouse/pull/69406) ([Duc Canh Le](https://github.com/canhld94)).



#### 改善 {#improvement-3}

* CREATE TABLE AS は、PRIMARY KEY や ORDER BY などの句もコピーするようになりました。現在は MergeTree 系のテーブルエンジンのみサポートしています。 [#69076](https://github.com/ClickHouse/ClickHouse/pull/69076) ([sakulali](https://github.com/sakulali)).
* 小さなエンティティのパースに関連するコードベースの一部を強化しました。以下の（軽微な）バグを発見して修正しました。- `DeltaLake` テーブルが Bool でパーティション分割されている場合、パーティション値が常に false として解釈される問題。- `ExternalDistributed` テーブルが、指定されたアドレスのうち単一のシャードしか使用していなかった問題。`max_threads` 設定値などが `auto(N)` ではなく `'auto(N)'` として出力されていた問題も修正しました。 [#52503](https://github.com/ClickHouse/ClickHouse/pull/52503) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* CPU 使用量の算出において、システム全体のメトリクスではなく cgroup 固有のメトリクスを使用するよう変更しました。 [#62003](https://github.com/ClickHouse/ClickHouse/pull/62003) ([Nikita Taranov](https://github.com/nickitat)).
* リモート S3 ディスク向けの I/O スケジューリングは、`bandwidth_limit` によるスロットリングの問題を解消するため、（S3 リクエスト全体ではなく）HTTP ソケットストリーム単位で行われるようになりました。 [#65182](https://github.com/ClickHouse/ClickHouse/pull/65182) ([Sergei Trifonov](https://github.com/serxa))。
* 関数 `upperUTF8` と `lowerUTF8` は以前、キリル文字のみ大文字化／小文字化に対応していました。この制限は解消され、任意の言語の文字に対して大文字化／小文字化を行えるようになりました。例: `SELECT upperUTF8('Süden')` は現在 `SÜDEN` を返します。 [#65761](https://github.com/ClickHouse/ClickHouse/pull/65761) ([李扬](https://github.com/taiyang-li)).
* projection を持つテーブルで lightweight delete が実行される場合、これまでは lightweight delete が行われようとしたときに例外を送出する（デフォルト）か、projection を削除するかの 2 つの選択肢しかありませんでしたが、新たに lightweight delete を実行したうえで projection を再構築するという第 3 のオプションが追加されました。 [#66169](https://github.com/ClickHouse/ClickHouse/pull/66169) ([jsc0218](https://github.com/jsc0218)).
* 2 つのオプション（`dns_allow_resolve_names_to_ipv4` と `dns_allow_resolve_names_to_ipv6`）が追加され、接続を IP ファミリーごとにブロックできるようになりました。 [#66895](https://github.com/ClickHouse/ClickHouse/pull/66895) ([MikhailBurdukov](https://github.com/MikhailBurdukov))
* clickhouse-client で Ctrl-Z を無視するかどうかを設定可能にしました（ignore&#95;shell&#95;suspend）。 [#67134](https://github.com/ClickHouse/ClickHouse/pull/67134) ([Azat Khuzhin](https://github.com/azat)).
* JSON 出力フォーマットにおける UTF-8 検証を改善しました。結果データ内の特定のバイト列に対しても、有効な JSON が生成されることを保証します。[#67938](https://github.com/ClickHouse/ClickHouse/pull/67938) ([mwoenker](https://github.com/mwoenker)).
* マージおよびミューテーション用のプロファイルイベントを追加し、より詳細な解析が行えるようにしました。 [#68015](https://github.com/ClickHouse/ClickHouse/pull/68015) ([Anton Popov](https://github.com/CurtizJ)).
* ODBC: サーバー構成から `http_max_tries` を取得するようにしました。 [#68128](https://github.com/ClickHouse/ClickHouse/pull/68128) ([Rodolphe Dugé de Bernonville](https://github.com/RodolpheDuge)).
* X.509 の SubjectAltName 拡張内のユーザー識別でワイルドカードをサポートしました。 [#68236](https://github.com/ClickHouse/ClickHouse/pull/68236) ([Marco Vilas Boas](https://github.com/marco-vb)).
* 日時のスキーマ推論を改善しました。`DateTime64` は、日時に小数部がある場合にのみ使用され、それ以外の場合は通常の `DateTime` が使用されます。Date/DateTime の推論は、特に `date_time_input_format='best_effort'` のときに、文字列から日時を誤って推論してしまうコーナーケースを避けるため、より厳密になりました。[#68382](https://github.com/ClickHouse/ClickHouse/pull/68382)（[Kruglov Pavel](https://github.com/Avogar)）。
* 辞書から named collections 用の古いコードを削除し、DDL で作成された named collections を辞書で使用できるようにする新しいコードに置き換えました。[#60936](https://github.com/ClickHouse/ClickHouse/issues/60936) をクローズし、[#36890](https://github.com/ClickHouse/ClickHouse/issues/36890) をクローズしました。[#68412](https://github.com/ClickHouse/ClickHouse/pull/68412)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 外部 HTTP 認証器には、（デフォルトで設定されている）HTTP/1.0 の代わりに HTTP/1.1 を使用します。[#68456](https://github.com/ClickHouse/ClickHouse/pull/68456) ([Aleksei Filatov](https://github.com/aalexfvk)).
* スレッドプールの内部解析用の新しいメトリクスセットを追加し、スレッドプールのパフォーマンスと動作に関するより深い洞察を得られるようにしました。 [#68674](https://github.com/ClickHouse/ClickHouse/pull/68674) ([filimonov](https://github.com/filimonov)).
* `Values` フォーマットを使用する非同期挿入でクエリパラメータをサポートするようになりました。 [#68741](https://github.com/ClickHouse/ClickHouse/pull/68741) ([Anton Popov](https://github.com/CurtizJ)).
* `dateTrunc` と `toStartOfInterval` が `Date32` をサポートするようになりました。 [#68874](https://github.com/ClickHouse/ClickHouse/pull/68874) ([LiuNeng](https://github.com/liuneng1994)).
* `system.processors_profile_log` に `plan_step_name` および `plan_step_description` 列を追加。 [#68954](https://github.com/ClickHouse/ClickHouse/pull/68954) ([Alexander Gololobov](https://github.com/davenger))。
* 埋め込み辞書にスペイン語対応を追加。 [#69035](https://github.com/ClickHouse/ClickHouse/pull/69035) ([Vasily Okunev](https://github.com/VOkunev)).
* 短い障害情報メッセージに CPU アーキテクチャ情報を追加。 [#69037](https://github.com/ClickHouse/ClickHouse/pull/69037) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* リトライ中に新しい Keeper 接続を確立できない場合、クエリはより早く失敗するようになりました。[#69148](https://github.com/ClickHouse/ClickHouse/pull/69148) ([Raúl Marín](https://github.com/Algunenano))
* DatabaseFactory を更新し、ユーザー定義データベースエンジンでも、StorageFactory と同様に引数・設定・テーブルのオーバーライドを指定できるようにしました。 [#69201](https://github.com/ClickHouse/ClickHouse/pull/69201) ([NikBarykin](https://github.com/NikBarykin)).
* すべての外部テーブルエンジンおよび関数を `Null` エンジンに置き換える復元モード（`restore_replace_external_engines_to_null`、`restore_replace_external_table_functions_to_null` 設定）は、テーブルに SETTINGS がある場合に失敗していました。現在は、この場合テーブル定義から SETTINGS を削除するようになり、そのようなテーブルも復元できるようになりました。 [#69253](https://github.com/ClickHouse/ClickHouse/pull/69253) ([Ilya Yatsishin](https://github.com/qoega))。
* CLICKHOUSE&#95;PASSWORD が ClickHouse イメージのエントリーポイント内で XML 用に正しくエスケープされるよう修正されました。 [#69301](https://github.com/ClickHouse/ClickHouse/pull/69301) ([aohoyd](https://github.com/aohoyd)).
* `arrayZip`/`arrayZipUnaligned` で空の引数を受け付けるようにしました。これは [https://github.com/ClickHouse/ClickHouse/pull/65887](https://github.com/ClickHouse/ClickHouse/pull/65887) における `concat` と同様の対応です。Gluten CH Backend における Spark との互換性のための変更です。[#69576](https://github.com/ClickHouse/ClickHouse/pull/69576)（[李扬](https://github.com/taiyang-li)）。
* Keeper の内部通信に対して、パスフレーズ付き秘密鍵など、より高度な SSL オプションをサポートしました。 [#69582](https://github.com/ClickHouse/ClickHouse/pull/69582) ([Antonio Andelic](https://github.com/antonio2368)).
* 多くのパーツやパーティションを持つ大きなテーブルでは、インデックスの解析にかなりの時間がかかることがあります。この変更により、その段階で重いクエリを強制終了できるようになります。 [#69606](https://github.com/ClickHouse/ClickHouse/pull/69606) ([Alexander Gololobov](https://github.com/davenger)).
* `gcs` テーブル関数で機密情報のマスキングに対応しました。 [#69611](https://github.com/ClickHouse/ClickHouse/pull/69611) ([Vitaly Baranov](https://github.com/vitlibar)).
* 行数が減少するマージ時に projection を再構築。 [#62364](https://github.com/ClickHouse/ClickHouse/pull/62364) ([cangyin](https://github.com/cangyin)).





#### バグ修正（公式安定版リリースにおけるユーザー可視の不具合） {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-3}

* 実験的かつサポート対象外の MaterializedPostgreSQL エンジンで、pg のデータベース名に「-」が含まれている場合のテーブルアタッチ時の問題を修正しました。 [#62730](https://github.com/ClickHouse/ClickHouse/pull/62730) ([takakawa](https://github.com/takakawa)).
* 実験的かつ完全にサポート対象外の MaterializedPostgreSQL エンジンにおいて、adnum の順序が乱れている場合の生成列に関するエラーを修正しました [#63161](https://github.com/ClickHouse/ClickHouse/issues/63161)。実験的かつ完全にサポート対象外の MaterializedPostgreSQL において、テーブルに生成列が存在する場合の、`nextval` 式をデフォルトとする id 列に関するエラーを修正しました。`[a-z1-9-]` 以外の記号を含む publication を DROP する際のエラーを修正しました。 [#67664](https://github.com/ClickHouse/ClickHouse/pull/67664) ([Kruglov Kirill](https://github.com/1on))。
* 左側テーブルの `Nullable` 列をサポートするよう Storage Join を拡張し、[#61247](https://github.com/ClickHouse/ClickHouse/issues/61247) をクローズ。[#66926](https://github.com/ClickHouse/ClickHouse/pull/66926)（[vdimir](https://github.com/vdimir)）。
* `IN` 演算子に `Decimal()` への変換が含まれている場合に、parallel replicas 使用時（クエリの分散実行時も同様）に誤ったクエリ結果が返る問題を修正。新しい analyzer によって導入されたバグ。 [#67234](https://github.com/ClickHouse/ClickHouse/pull/67234) ([Igor Nikonov](https://github.com/devcrafter)).
* `ALTER MODIFY ORDER BY` によりメタデータの不整合が発生する問題を修正しました。 [#67436](https://github.com/ClickHouse/ClickHouse/pull/67436) ([iceFireser](https://github.com/iceFireser))。
* 関数 `fromModifiedJulianDay` の上限値を修正します。本来は `9999-12-31` であるべきところを、誤って `9999-01-01` に設定していました。[#67583](https://github.com/ClickHouse/ClickHouse/pull/67583)（[PHO](https://github.com/depressed-pho)）。
* インデックスがタプルの先頭にない場合の `IN` クエリの不具合を修正。 [#67626](https://github.com/ClickHouse/ClickHouse/pull/67626) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* `RoleCache` の有効期限の扱いを修正。[#67748](https://github.com/ClickHouse/ClickHouse/pull/67748)（[Vitaly Baranov](https://github.com/vitlibar)）。
* ビューへのフラッシュの遅さにより window view でブロックが欠落する問題を修正。 [#67983](https://github.com/ClickHouse/ClickHouse/pull/67983) ([Raúl Marín](https://github.com/Algunenano))
* 不正な日付フォーマットに起因する MSan の問題を修正。 [#68105](https://github.com/ClickHouse/ClickHouse/pull/68105) ([JackyWoo](https://github.com/JackyWoo)).
* Parquet ファイル内のデータ型が要求された型と大きく異なる場合（例: `... FROM file('a.parquet', Parquet, 'x String')` だが、ファイル側では `x Int64`）に、Parquet のフィルタリング処理がクラッシュする不具合を修正しました。この修正を適用していない場合は、回避策として `input_format_parquet_filter_push_down = 0` を使用してください。 [#68131](https://github.com/ClickHouse/ClickHouse/pull/68131) ([Michael Kolupaev](https://github.com/al13n321))。
* `lag`/`lead` で、[#67091](https://github.com/ClickHouse/ClickHouse/issues/67091) によって導入されたクラッシュを修正。[#68262](https://github.com/ClickHouse/ClickHouse/pull/68262)（[lgbo](https://github.com/lgbo-ustc)）。
* クエリがキャンセルされた際に Postgres がクラッシュする問題の修正を試みました。[#68288](https://github.com/ClickHouse/ClickHouse/pull/68288) ([Kseniia Sumarokova](https://github.com/kssenii)).
* [https://github.com/ClickHouse/ClickHouse/pull/61984](https://github.com/ClickHouse/ClickHouse/pull/61984) 以降でも、`schema_inference_make_columns_nullable=0` は Parquet/Arrow フォーマットにおいてカラムを `Nullable` にしてしまう場合があります。この変更は後方互換性がないもので、ユーザーは動作の変化に気付きました。この PR により、`schema_inference_make_columns_nullable=0` は従来どおり（`Nullable` カラムは推論されない）に動作するようになり、さらにこの設定に新しい値 `auto` を導入します。`auto` を指定すると、データに null 許容性に関する情報がある場合にのみカラムを `Nullable` にします。 [#68298](https://github.com/ClickHouse/ClickHouse/pull/68298) ([Kruglov Pavel](https://github.com/Avogar)).
* [#50868](https://github.com/ClickHouse/ClickHouse/issues/50868) を修正。分散クエリ内のネストされたサブクエリから返される小さい DateTime64 の定数値が誤って NULL に変換されており、その結果、エラーや誤ったクエリ結果を引き起こす可能性がありました。[#68323](https://github.com/ClickHouse/ClickHouse/pull/68323)（[Shankar](https://github.com/shiyer7474)）。
* クエリ `SYSTEM SYNC REPLICA` で欠落していた同期レプリカモードを修正しました。 [#68326](https://github.com/ClickHouse/ClickHouse/pull/68326) ([Duc Canh Le](https://github.com/canhld94)).
* キー条件の不具合を修正。[#68354](https://github.com/ClickHouse/ClickHouse/pull/68354)（[Han Fei](https://github.com/hanfei1991)）。
* LDAP 外部ユーザーディレクトリで使用されているロールを削除または名前を変更するとクラッシュする問題を修正。 [#68355](https://github.com/ClickHouse/ClickHouse/pull/68355) ([Andrey Zvonov](https://github.com/zvonand)).
* system.view&#95;refreshes の Progress 列で値が 1 を超えてしまう問題を修正 [#68377](https://github.com/ClickHouse/ClickHouse/issues/68377)。[#68378](https://github.com/ClickHouse/ClickHouse/pull/68378)（[megao](https://github.com/jetgm)）。
* 正規表現のフラグを正しく処理するようにしました。 [#68389](https://github.com/ClickHouse/ClickHouse/pull/68389) ([Han Fei](https://github.com/hanfei1991)).
* PostgreSQL スタイルのキャスト演算子（`::`）が、SQL スタイルの 16 進数およびバイナリ文字列リテラル（例：`SELECT x'414243'::String`）に対しても正しく動作するようになりました。これにより、[#68324](https://github.com/ClickHouse/ClickHouse/issues/68324) が解決されました。[#68482](https://github.com/ClickHouse/ClickHouse/pull/68482)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* [https://github.com/ClickHouse/ClickHouse/pull/68131](https://github.com/ClickHouse/ClickHouse/pull/68131) へのマイナーなパッチ。[#68494](https://github.com/ClickHouse/ClickHouse/pull/68494)（[Chang chen](https://github.com/baibaichen)）。
* [#68239](https://github.com/ClickHouse/ClickHouse/issues/68239) 整数 `n` を指定した `SAMPLE n` の不具合を修正。[#68499](https://github.com/ClickHouse/ClickHouse/pull/68499)（[Denis Hananein](https://github.com/denis-hananein)）。
* `mann-whitney-utest` において、2 つの分布のサイズが等しくない場合のバグを修正。 [#68556](https://github.com/ClickHouse/ClickHouse/pull/68556) ([Han Fei](https://github.com/hanfei1991))。
* 予期しない再起動後、破損パーツに覆われているパーツの処理が異常で ReplicatedMergeTree のレプリケーションを開始できない問題を修正。 [#68584](https://github.com/ClickHouse/ClickHouse/pull/68584) ([baolin](https://github.com/baolinhuang)).
* 空の配列またはタプルに関数 `sipHash64Keyed`、`sipHash128Keyed`、`sipHash128ReferenceKeyed` を適用した際に発生していた `LOGICAL_ERROR` を修正。 [#68630](https://github.com/ClickHouse/ClickHouse/pull/68630) ([Robert Schulze](https://github.com/rschu1ze))。
* 複数カラムにインデックスを作成した場合、フルテキストインデックスが誤ったカラムをフィルタリングしてしまうことがありました。これは、異なるカラム間で `row_id` をリセットしていなかったためです。再現手順は tests/queries/0&#95;stateless/03228&#95;full&#95;text&#95;with&#95;multi&#95;col.sql にあります。この修正がないと問題が発生します。[#68644](https://github.com/ClickHouse/ClickHouse/pull/68644) ([siyuan](https://github.com/linkwk7))。
* replica&#95;name 中の無効な文字 &#39;\t&#39; および &#39;\n&#39; を修正し、Replicated テーブル作成時に LogEntry 内の「source replica」が誤ってパースされる問題を解消しました。Issue [#68640](https://github.com/ClickHouse/ClickHouse/issues/68640) で言及。[#68645](https://github.com/ClickHouse/ClickHouse/pull/68645) ([Zhigao Hong](https://github.com/zghong))。
* 分散テーブルに、バージョン 24.3 までは利用可能だった仮想カラム ` _table` と `_database` を再度追加しました。 [#68672](https://github.com/ClickHouse/ClickHouse/pull/68672) ([Anton Popov](https://github.com/CurtizJ)).
* Variant 列の permutation 中に発生する可能性のあるエラー `Size of permutation (0) is less than required (...)` を修正。 [#68681](https://github.com/ClickHouse/ClickHouse/pull/68681) ([Kruglov Pavel](https://github.com/Avogar)).
* 新しい JSON 列に関連して発生する可能性のある `DB::Exception: Block structure mismatch in joined block stream: different columns:` エラーを修正します。 [#68686](https://github.com/ClickHouse/ClickHouse/pull/68686) ([Kruglov Pavel](https://github.com/Avogar)).
* 関数 `sipHash(64/128)Keyed` において、キーとして配列を持つ Map をハッシュ化する際の、マテリアライズされた定数キーの扱いに関する不具合を修正。[#68731](https://github.com/ClickHouse/ClickHouse/pull/68731)（[Salvatore Mesoraca](https://github.com/aiven-sal) による変更）。
* `ColumnsDescription::toString` が各カラムを同一の `IAST::FormatState` オブジェクトを使用してフォーマットするようにします。これにより、ディスクおよび ZooKeeper に書き込まれるカラムメタデータの形式が統一されます。 [#68733](https://github.com/ClickHouse/ClickHouse/pull/68733) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* GROUPING SETS における集約データのマージ処理を修正。[#68744](https://github.com/ClickHouse/ClickHouse/pull/68744) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* レプリケーテッド MergeTree を作成し、カラムを `ALTER` してから `MODIFY STATISTICS` を実行した際に発生していた論理エラーを修正。 [#68820](https://github.com/ClickHouse/ClickHouse/pull/68820) ([Han Fei](https://github.com/hanfei1991)).
* アナライザにおけるサブクエリからの動的サブカラム解決処理を修正。 [#68824](https://github.com/ClickHouse/ClickHouse/pull/68824) ([Kruglov Pavel](https://github.com/Avogar)).
* DeltaLake における複合型メタデータの解析を修正。[#68739](https://github.com/ClickHouse/ClickHouse/issues/68739) をクローズ。[#68836](https://github.com/ClickHouse/ClickHouse/pull/68836)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 非同期挿入において、テーブルのメタデータが（`ALTER ADD/MODIFY COLUMN` クエリによって）挿入後からテーブルへのフラッシュ前の間に変更された場合でも正しく動作するように修正しました。 [#68837](https://github.com/ClickHouse/ClickHouse/pull/68837) ([Anton Popov](https://github.com/CurtizJ))。
* `array` に空のタプルを渡したときに発生していた予期しない例外を修正。これにより [#68618](https://github.com/ClickHouse/ClickHouse/issues/68618) が修正されました。 [#68848](https://github.com/ClickHouse/ClickHouse/pull/68848)（[Amos Bird](https://github.com/amosbird)）。
* 純粋なメタデータのみの mutation コマンドの解析を修正。 [#68935](https://github.com/ClickHouse/ClickHouse/pull/68935) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* anyHeavy の状態をマージする際に誤った結果が生じる可能性があった問題を修正。 [#68950](https://github.com/ClickHouse/ClickHouse/pull/68950) ([Raúl Marín](https://github.com/Algunenano)).
* 設定 `optimize_functions_to_subcolumns` が有効な場合のマテリアライズドビューへの書き込みを修正しました。 [#68951](https://github.com/ClickHouse/ClickHouse/pull/68951) ([Anton Popov](https://github.com/CurtizJ)).
* const Dynamic 列メソッドでは serializations キャッシュを使用しないでください。集計中に未初期化の値の使用や、さらにはレースコンディションを引き起こす可能性があります。 [#68953](https://github.com/ClickHouse/ClickHouse/pull/68953) ([Kruglov Pavel](https://github.com/Avogar)).
* JSON 型のパース時に、一部のケースでデフォルトとして `null` を挿入すべきところでパースエラーが発生していた問題を修正。 [#68955](https://github.com/ClickHouse/ClickHouse/pull/68955) ([Kruglov Pavel](https://github.com/Avogar)).
* 一部の圧縮レスポンスで `Content-Encoding` ヘッダーが送信されない問題を修正。 [#64802](https://github.com/ClickHouse/ClickHouse/issues/64802)。 [#68975](https://github.com/ClickHouse/ClickHouse/pull/68975) ([Konstantin Bogdanov](https://github.com/thevar1able))。
* パスが誤って連結されて `//` が含まれてしまうケースがあったため、パスの正規化によってこの問題を解決しました。 [#69066](https://github.com/ClickHouse/ClickHouse/pull/69066) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
* 空の async insert が発生した場合に論理エラーが起きる問題を修正しました。 [#69080](https://github.com/ClickHouse/ClickHouse/pull/69080) ([Han Fei](https://github.com/hanfei1991)).
* クエリキャンセル時に clickhouse-client の進行状況表示で発生していたデータレースを修正しました。 [#69081](https://github.com/ClickHouse/ClickHouse/pull/69081) ([Sergei Trifonov](https://github.com/serxa)).
* コサイン距離を距離関数として使用した場合に、実験的なベクトル類似度インデックスが利用されない不具合を修正。 [#69090](https://github.com/ClickHouse/ClickHouse/pull/69090) ([flynn](https://github.com/ucasfl))。
* この変更では、初回の作成処理中にサーバー障害が発生した後に Replicated データベースを再作成しようとするとエラーが発生する可能性があった問題に対処します。 [#69102](https://github.com/ClickHouse/ClickHouse/pull/69102) ([Miсhael Stetsyuk](https://github.com/mstetsyuk))。
* `input_format_csv_try_infer_numbers_from_strings = 1` のときに、文字列から Bool 型を推論しません。文字列から bool 値を読み取ることは許可されていないためです。 [#69109](https://github.com/ClickHouse/ClickHouse/pull/69109) ([Kruglov Pavel](https://github.com/Avogar)).
* `--multiquery` が有効な場合、クライアント側で発生していた `EXPLAIN AST INSERT` クエリのパースエラーを修正。 [#69123](https://github.com/ClickHouse/ClickHouse/pull/69123) ([wxybear](https://github.com/wxybear))。
* サブクエリ内の `UNION` 句が、並列レプリカを使用するクエリで正しく処理されず、LOGICAL&#95;ERROR `Duplicate announcement received for replica` を引き起こしていました。 [#69146](https://github.com/ClickHouse/ClickHouse/pull/69146) ([Igor Nikonov](https://github.com/devcrafter)).
* s3Cluster における structure 引数の伝播処理を修正しました。以前は、s3Cluster 内のレプリカにクエリを送信する際に、カラムの `DEFAULT` 式が失われてしまう可能性がありました。[#69147](https://github.com/ClickHouse/ClickHouse/pull/69147)（[Kruglov Pavel](https://github.com/Avogar)）。
* 式から宛先型への変換時に、Values フォーマットの設定が反映されるようにしました。 [#69149](https://github.com/ClickHouse/ClickHouse/pull/69149) ([Kruglov Pavel](https://github.com/Avogar)).
* 読み取り専用ユーザーで `clickhouse-client --queries-file` が動作するよう修正しました（以前は readonly モードで `Cannot modify 'log_comment' setting in readonly mode` により失敗していました）。 [#69175](https://github.com/ClickHouse/ClickHouse/pull/69175) ([Azat Khuzhin](https://github.com/azat)).
* 早期に終了したプロセスにパイプされた場合の clickhouse-client におけるデータ競合を修正しました。 [#69186](https://github.com/ClickHouse/ClickHouse/pull/69186) ([vdimir](https://github.com/vdimir)).
* JSON/Dynamic 型に対する `uniq` 関数および `GROUP BY` の誤った結果を修正。 [#69203](https://github.com/ClickHouse/ClickHouse/pull/69203) ([Kruglov Pavel](https://github.com/Avogar)).
* 非同期挿入時の INFILE フォーマット検出を修正しました。FORMAT 句でフォーマットが明示的に指定されていない場合、INFILE のファイル拡張子からフォーマットを検出できるようになりました。 [#69237](https://github.com/ClickHouse/ClickHouse/pull/69237) ([Julia Kartseva](https://github.com/jkartseva)).
* [この issue](https://github.com/ClickHouse/ClickHouse/pull/59946#issuecomment-1943653197) 以降、本番環境では相当数のテーブルレプリカにおいて、`metadata_version` ノードの値が `0` であり、かつ対応するテーブルの `metadata` ノードのバージョンとは異なる、という状態になっており、これによりそのようなレプリカ上では `alter` クエリが失敗します。 [#69274](https://github.com/ClickHouse/ClickHouse/pull/69274) ([Miсhael Stetsyuk](https://github.com/mstetsyuk))。
* Fields での問題を回避するため、Dynamic 型を primary key として安全でない型としてマークしました。 [#69311](https://github.com/ClickHouse/ClickHouse/pull/69311) ([Kruglov Pavel](https://github.com/Avogar)).
* アクセスエンティティの依存関係の復元処理を改善。 [#69346](https://github.com/ClickHouse/ClickHouse/pull/69346) ([Vitaly Baranov](https://github.com/vitlibar)).
* 挿入用の接続を取得する際に、すべての接続試行が失敗した場合に発生していた未定義動作を修正。 [#69390](https://github.com/ClickHouse/ClickHouse/pull/69390) ([Pablo Marcos](https://github.com/pamarcos))。
* [#69135](https://github.com/ClickHouse/ClickHouse/issues/69135) をクローズ。`cross` join で結合済みデータを再利用しようとしているが、これは現時点の ClickHouse では起こり得ない。そのため、`have_compressed` は `reuseJoinedData` に残しておく方が良い。[#69404](https://github.com/ClickHouse/ClickHouse/pull/69404)（[lgbo](https://github.com/lgbo-ustc)）。
* パラメータとしてスパースカラムが渡された場合に、`materialize()` 関数がカラム全体を返すようにしました。 [#69429](https://github.com/ClickHouse/ClickHouse/pull/69429) ([Alexander Gololobov](https://github.com/davenger)).
* 関数 `sqidDecode` で発生していた `LOGICAL_ERROR` を修正しました（[#69450](https://github.com/ClickHouse/ClickHouse/issues/69450)）。[#69451](https://github.com/ClickHouse/ClickHouse/pull/69451)（[Robert Schulze](https://github.com/rschu1ze)）。
* バージョン 24.6 における s3queue の問題に対する簡易的な修正、または Replicated データベースを使ったクエリの作成。 [#69454](https://github.com/ClickHouse/ClickHouse/pull/69454) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `INSERT INTO ... SELECT` や `CREATE TABLE AS SELECT` クエリでのスカッシュ処理によりメモリ消費量が過大になっていた問題を修正しました。 [#69469](https://github.com/ClickHouse/ClickHouse/pull/69469) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* テーブル名にドットが含まれている場合でも、`SHOW COLUMNS` と `SHOW INDEX` ステートメントが正しく動作するようになりました。[#69514](https://github.com/ClickHouse/ClickHouse/pull/69514) ([Salvatore Mesoraca](https://github.com/aiven-sal))。
* `overflow` モードが `throw` 以外に設定されたクエリに対するクエリキャッシュの使用はできなくなりました。これにより、途中で打ち切られた不正確なクエリ結果がクエリキャッシュに保存されてしまう可能性のある状況を防ぎます。(issue [#67476](https://github.com/ClickHouse/ClickHouse/issues/67476))。[#69549](https://github.com/ClickHouse/ClickHouse/pull/69549)（[Robert Schulze](https://github.com/rschu1ze)）。
* `prewhere` への移動時に条件の元の順序を維持するようになりました。以前は順序が変わることがあり、順序が重要な場合にクエリが失敗する可能性がありました。 [#69560](https://github.com/ClickHouse/ClickHouse/pull/69560) ([Kruglov Pavel](https://github.com/Avogar))。
* ZNOAUTH エラー発生後に Keeper の複数リクエストの前処理を修正。 [#69627](https://github.com/ClickHouse/ClickHouse/pull/69627) ([Antonio Andelic](https://github.com/antonio2368)).
* 新しいレプリカを作成する際、DatabaseReplicated で TTL に WHERE 句を指定した場合に発生していた可能性のある METADATA&#95;MISMATCH を修正しました。 [#69736](https://github.com/ClickHouse/ClickHouse/pull/69736) ([Nikolay Degterinsky](https://github.com/evillique)).
* `StorageS3(Azure)Queue` の設定項目 `tracked_file_ttl_sec` を修正しました。`tracked_file_ttl_sec` というキーで Keeper に書き込んでいましたが、読み込み時には誤って `tracked_files_ttl_sec` として読んでおり、これはタイポによる不具合でした。 [#69742](https://github.com/ClickHouse/ClickHouse/pull/69742) ([Kseniia Sumarokova](https://github.com/kssenii)).
* gethyperrectangleforrowgroup において tryconvertfieldtotype を使用するようにしました。 [#69745](https://github.com/ClickHouse/ClickHouse/pull/69745) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* 「Fix prewhere without columns and without adaptive index granularity (almost w/o anything)」をリバートしました。リバートした変更により、古い ClickHouse リリース（おそらく 2021 年以前）で生成されたデータパーツを読み取る際に、いくつかのエラーが発生する可能性があります。[#68897](https://github.com/ClickHouse/ClickHouse/pull/68897) ([Alexander Gololobov](https://github.com/davenger)).



### <a id="248"></a> ClickHouse リリース 24.8 LTS, 2024-08-20 {#a-id248a-clickhouse-release-248-lts-2024-08-20}

#### 後方互換性のない変更 {#backward-incompatible-change-4}
* `clickhouse-client` と `clickhouse-local` は、従来の単一クエリモードではなく、デフォルトでマルチクエリモードになりました。例えば、これまでは `clickhouse-client -q "SELECT 1; SELECT 2"` を実行するには `--multiquery`（または `-n`）を付与する必要がありましたが、現在はそのまま動作します。これにより `--multiquery/-n` スイッチは不要になりました。マルチクエリ文内の INSERT クエリは、その FORMAT 句に基づいて特別に扱われます。FORMAT が `VALUES`（もっとも一般的なケース）の場合、INSERT 文の終端はクエリ末尾のセミコロン `;` で表されます。その他すべての FORMAT（例: `CSV` や `JSONEachRow`）では、INSERT 文の終端はクエリ末尾の 2 つの改行 `\n\n` で表されます。 [#63898](https://github.com/ClickHouse/ClickHouse/pull/63898) ([FFish](https://github.com/wxybear)).
* 以前のバージョンでは、`LowCardinality` データ型に対して、そのデータ型名に `WithDictionary` を付ける代替構文を使用することができました。これは初期のワーキング実装であり、ドキュメント化も公開もされていませんでした。現在、この構文は非推奨となりました。この構文を使用している場合は、テーブルに対して ALTER を実行し、データ型名を `LowCardinality` に変更する必要があります。 [#66842](https://github.com/ClickHouse/ClickHouse/pull/66842) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* 分散先テーブルと組み合わせて使用されるストレージ `Buffer` における論理エラーを修正しました。これは後方互換性のない変更です。分散先テーブルと `Buffer` を使用しているクエリで、対象テーブルがクエリ内に複数回（例: セルフジョイン）登場する場合、それらのクエリは動作しなくなる可能性があります。 [#67015](https://github.com/ClickHouse/ClickHouse/pull/67015) ([vdimir](https://github.com/vdimir)).
* 以前のバージョンでは、Gamma 関数に基づく乱数分布関数（Chi-Squared、Student、Fisher など）を、ゼロに近い負の引数で呼び出すと、計算が非常に長引くか無限ループに陥る可能性がありました。新しいバージョンでは、これらの関数をゼロまたは負の引数で呼び出すと、例外がスローされます。これにより [#67297](https://github.com/ClickHouse/ClickHouse/issues/67297) が解決されました。 [#67326](https://github.com/ClickHouse/ClickHouse/pull/67326) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* システムテーブル `text_log` がデフォルトで有効になりました。これは以前のバージョンとの完全な互換性を保っていますが、ローカルディスクのディスク使用量がわずかに増加することに気付くかもしれません（このシステムテーブルが占有するディスク容量はごくわずかです）。 [#67428](https://github.com/ClickHouse/ClickHouse/pull/67428) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* 以前のバージョンでは、`arrayWithConstant` は非常に大きな配列を生成するよう要求された場合に遅くなる可能性がありました。新しいバージョンでは、配列あたり 1 GB に制限されました。これにより [#32754](https://github.com/ClickHouse/ClickHouse/issues/32754) が解決されました。 [#67741](https://github.com/ClickHouse/ClickHouse/pull/67741) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* REPLACE 修飾子のフォーマットを修正しました（括弧の省略を禁止）。 [#67774](https://github.com/ClickHouse/ClickHouse/pull/67774) ([Azat Khuzhin](https://github.com/azat)).
* [#68349](https://github.com/ClickHouse/ClickHouse/issues/68349) でバックポート済み: `Dynamic` 型を再実装しました。動的データ型の上限に達した場合でも、新しい型は String にキャストされるのではなく、バイナリエンコードされたデータ型情報を持つ特別なデータ構造にバイナリ形式で保存されます。これにより、`Dynamic` カラムに一度でも挿入された任意の型を、サブカラムとして読み出すことができるようになりました。 [#68132](https://github.com/ClickHouse/ClickHouse/pull/68132) ([Kruglov Pavel](https://github.com/Avogar)).



#### 新機能 {#new-feature-4}

* 特定のエンジンにおけるマージ処理時のプロジェクションおよび `OPTIMIZE DEDUPLICATE` クエリの挙動を制御するために、新たな `MergeTree` 設定 `deduplicate_merge_projection_mode` を追加しました。サポートされるオプションは、`throw`（*MergeTree エンジンでプロジェクションが完全にはサポートされていない場合に例外をスローする）、`drop`（一貫した形でマージできない場合にマージ中のプロジェクションを削除する）、`rebuild`（プロジェクションを最初から再構築する。これは高コストな処理です）です。[#66672](https://github.com/ClickHouse/ClickHouse/pull/66672)（[jsc0218](https://github.com/jsc0218)）。
* S3 テーブルエンジンに `_etag` 仮想カラムを追加。 [#65312](https://github.com/ClickHouse/ClickHouse/issues/65312) を修正。 [#65386](https://github.com/ClickHouse/ClickHouse/pull/65386)（[skyoct](https://github.com/skyoct)）。
* クエリキャッシュにタグ（ネームスペース）機構を追加しました。タグの異なる同一クエリは、クエリキャッシュ上では別物として扱われます。例: `SELECT 1 SETTINGS use_query_cache = 1, query_cache_tag = 'abc'` と `SELECT 1 SETTINGS use_query_cache = 1, query_cache_tag = 'def'` は、別々のクエリキャッシュエントリを作成するようになりました。 [#68235](https://github.com/ClickHouse/ClickHouse/pull/68235) ([sakulali](https://github.com/sakulali))。
* 左テーブルと右テーブルの両方のカラムを含む不等号条件（例: `t1.y < t2.y`）で使用できる JOIN strictness のバリアントをさらにサポートしました（`LEFT/RIGHT SEMI/ANTI/ANY JOIN` など。設定 `allow_experimental_join_condition` を参照）。[#64281](https://github.com/ClickHouse/ClickHouse/pull/64281)（[lgbo](https://github.com/lgbo-ustc)）。
* さまざまなエンジン（`File`、`URL`、`S3`、`AzureBlobStorage`、`HDFS`）に対して Hive 形式のパーティショニングを解釈します。Hive 形式のパーティショニングでは、データをパーティション化されたサブディレクトリに整理することで、大規模なデータセットのクエリおよび管理を効率化します。現在は、適切な名前とデータを持つ仮想カラムを作成するのみを行います。後続の PR にて、適切なデータフィルタリング（パフォーマンス向上）が導入される予定です。[#65997](https://github.com/ClickHouse/ClickHouse/pull/65997)（[Yarik Briukhovetskyi](https://github.com/yariks5s)）。
* Spark との互換性のために関数 `printf` を追加しました（既存の `format` 関数も使用できます）。[#66257](https://github.com/ClickHouse/ClickHouse/pull/66257)（[李扬](https://github.com/taiyang-li)）。
* テストに役立つよう、外部エンジンおよびテーブル関数を `Null` エンジンに置き換えるためのオプション `restore_replace_external_engines_to_null` と `restore_replace_external_table_functions_to_null` を追加しました。これは RESTORE と明示的なテーブル作成の両方で動作します。 [#66536](https://github.com/ClickHouse/ClickHouse/pull/66536) ([Ilya Yatsishin](https://github.com/qoega)).
* 関数 `readWKTLineString` を使用して、`WKT` 形式の `MULTILINESTRING` ジオメトリの読み取りをサポートしました。 [#67647](https://github.com/ClickHouse/ClickHouse/pull/67647) ([Jacob Reckhard](https://github.com/jacobrec)).
* 新しいテーブル関数 `fuzzQuery` を追加しました。この関数は、指定したクエリ文字列をランダムに変形したものを生成できます。例: `SELECT query FROM fuzzQuery('SELECT 1') LIMIT 5;`。 [#67655](https://github.com/ClickHouse/ClickHouse/pull/67655) ([pufit](https://github.com/pufit))。
* 切り離されたすべてのパーティションを削除するための `ALTER TABLE ... DROP DETACHED PARTITION ALL` クエリを追加しました。 [#67885](https://github.com/ClickHouse/ClickHouse/pull/67885) ([Duc Canh Le](https://github.com/canhld94)).
* 新しい設定 `rows_before_aggregation` が有効になっている場合、クエリのレスポンスに `rows_before_aggregation_at_least` 統計情報を追加しました。この統計情報は、集約前に読み取られた行数を表します。分散クエリのコンテキストでは、`limit` なしで `group by` や `max` 集約関数を使用する場合、`rows_before_aggregation_at_least` はクエリによってヒットした行数を反映します。 [#66084](https://github.com/ClickHouse/ClickHouse/pull/66084) ([morning-color](https://github.com/morning-color)).
* `Join` テーブルで `OPTIMIZE` クエリをサポートし、メモリ使用量を削減できるようにしました。 [#67883](https://github.com/ClickHouse/ClickHouse/pull/67883) ([Duc Canh Le](https://github.com/canhld94)).
* URL に `&run=1` を追加すると、Play でクエリを即時に実行できるようになりました [#66457](https://github.com/ClickHouse/ClickHouse/pull/66457) ([Aleksandr Musorin](https://github.com/AVMusorin))。



#### 実験的機能 {#experimental-feature-3}
* 新しい `JSON` データ型を実装しました。[#66444](https://github.com/ClickHouse/ClickHouse/pull/66444) ([Kruglov Pavel](https://github.com/Avogar)).
* 新しい `TimeSeries` テーブルエンジンを追加しました。[#64183](https://github.com/ClickHouse/ClickHouse/pull/64183) ([Vitaly Baranov](https://github.com/vitlibar)).
* 新しい実験的な `Kafka` ストレージエンジンを追加し、オフセットを Kafka にコミットする代わりに Keeper に保存できるようにしました。これにより、キューからの消費に対して、ClickHouse テーブルへのコミットがアトミックになります。[#57625](https://github.com/ClickHouse/ClickHouse/pull/57625) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* 並列レプリカに対して、適応的（読み取るカラムサイズに依存することを意味する）な読み取りタスクサイズの計算方法を使用します。[#60377](https://github.com/ClickHouse/ClickHouse/pull/60377) ([Nikita Taranov](https://github.com/nickitat)).
* 統計タイプ `count_min`（count-min sketch）を追加しました。`col = 'val'` のような等価述語に対する選択度推定を提供します。サポートされるデータ型は string、date、datetime、および数値型です。[#65521](https://github.com/ClickHouse/ClickHouse/pull/65521) ([JackyWoo](https://github.com/JackyWoo)).

#### パフォーマンスの改善 {#performance-improvement-4}
* `optimize_functions_to_subcolumns` 設定をデフォルトで有効化しました。[#68053](https://github.com/ClickHouse/ClickHouse/pull/68053) ([Anton Popov](https://github.com/CurtizJ)).
* `plain_rewritable` ディスクディレクトリのメタデータを、オブジェクトストレージ内の MergeTree データとは分離して `__meta` レイアウトに保存するようにしました。`plain_rewritable` ディスクをフラットなディレクトリ構造に移行しました。[#65751](https://github.com/ClickHouse/ClickHouse/pull/65751) ([Julia Kartseva](https://github.com/jkartseva)).
* `String`/`Array`/`Map`/`Variant`/`Dynamic` 型に対して、すべてのサブカラム用に必要なメモリを事前に確保することで、`INSERT` クエリで発生するカラムの squashing（結合）処理を改善しました。[#67043](https://github.com/ClickHouse/ClickHouse/pull/67043) ([Kruglov Pavel](https://github.com/Avogar)).
* `SYSTEM FLUSH LOGS` を高速化し、シャットダウン時にログをフラッシュするようにしました。[#67472](https://github.com/ClickHouse/ClickHouse/pull/67472) ([Sema Checherinda](https://github.com/CheSema)).
* マージ処理のスケジューリング段階のオーバーヘッドを削減することで、マージ全体のパフォーマンスを改善しました。[#68016](https://github.com/ClickHouse/ClickHouse/pull/68016) ([Anton Popov](https://github.com/CurtizJ)).
* `DROP DATABASE` クエリにおけるテーブル削除を高速化するため、`database_catalog_drop_table_concurrency` のデフォルト値を 16 に引き上げました。[#67228](https://github.com/ClickHouse/ClickHouse/pull/67228) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* ORC 書き込み時に、配列カラムに対して過剰な容量を割り当てないように変更しました。Array カラムでのパフォーマンスが 15% 向上しました。[#67879](https://github.com/ClickHouse/ClickHouse/pull/67879) ([李扬](https://github.com/taiyang-li)).
* 非レプリケート MergeTree テーブルに対するミューテーションを大幅に高速化しました。[#66911](https://github.com/ClickHouse/ClickHouse/pull/66911) [#66909](https://github.com/ClickHouse/ClickHouse/pull/66909) ([Alexey Milovidov](https://github.com/alexey-milovidov)).



#### 改善 {#improvement-4}

* `allow_experimental_analyzer` の設定は `enable_analyzer` に名称変更されました。古い名前はエイリアスとして残されています。これは、Analyzer がもはやベータ版ではなく、本番利用が正式にサポートされるようになったことを意味します。 [#66438](https://github.com/ClickHouse/ClickHouse/pull/66438) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 日時のスキーマ推論を改善しました。現在は、日時に小数部がある場合にのみ DateTime64 が使用され、それ以外の場合は通常の DateTime が使用されます。Date/DateTime の推論は、特に `date_time_input_format='best_effort'` の場合に、コーナーケースで文字列から日時を誤って推論してしまうことを避けるため、より厳密になりました。[#68382](https://github.com/ClickHouse/ClickHouse/pull/68382)（[Kruglov Pavel](https://github.com/Avogar)）。
* ClickHouse サーバーは新しい設定項目 `max_keep_alive_requests` をサポートするようになりました。サーバーへの keep-alive HTTP 接続に対しては `keep_alive_timeout` と連動して動作します。アイドルタイムアウトがまだ発生していない場合でも、その接続を通じて処理されたリクエスト数が `max_keep_alive_requests` を超えると、その接続はサーバーによってクローズされます。 [#61793](https://github.com/ClickHouse/ClickHouse/pull/61793) ([Nikita Taranov](https://github.com/nickitat))。
* 高度なダッシュボードにおける各種改善。これにより [#67697](https://github.com/ClickHouse/ClickHouse/issues/67697) がクローズされました。これにより [#63407](https://github.com/ClickHouse/ClickHouse/issues/63407) がクローズされました。これにより [#51129](https://github.com/ClickHouse/ClickHouse/issues/51129) がクローズされました。これにより [#61204](https://github.com/ClickHouse/ClickHouse/issues/61204) がクローズされました。[#67701](https://github.com/ClickHouse/ClickHouse/pull/67701)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* Distributed テーブルを作成する際に REMOTE への GRANT は不要で、Distributed エンジンへの GRANT だけで十分です。 [#65419](https://github.com/ClickHouse/ClickHouse/pull/65419) ([jsc0218](https://github.com/jsc0218)).
* keeper 用のログを上書きできるよう、Docker イメージで明示的に指定しないようにしました。 [#65564](https://github.com/ClickHouse/ClickHouse/pull/65564) ([Azat Khuzhin](https://github.com/azat)).
* `BACKUP` クエリおよび `RESTORE` クエリ向けに `use_same_password_for_base_backup` 設定を導入し、パスワードで保護されたアーカイブに対してインクリメンタル バックアップを作成および復元できるようにしました。 [#66214](https://github.com/ClickHouse/ClickHouse/pull/66214) ([Samuele](https://github.com/sguerrini97)).
* `ATTACH` クエリに対しては `async_load_databases` を無視するようにしました（以前は、テーブルがアタッチされる前に `ATTACH` が返る可能性がありました）。 [#66240](https://github.com/ClickHouse/ClickHouse/pull/66240) ([Azat Khuzhin](https://github.com/azat)).
* リソース不足により接続が拒否された場合のログおよびメトリクスを追加しました。 [#66410](https://github.com/ClickHouse/ClickHouse/pull/66410) ([Alexander Tokmakov](https://github.com/tavplubix))。
* MongoDB エンジンで正しい `UUID` 型をサポートしました。 [#66671](https://github.com/ClickHouse/ClickHouse/pull/66671) ([Azat Khuzhin](https://github.com/azat)).
* レプリケーション遅延および復旧時間のメトリクスを追加。 [#66703](https://github.com/ClickHouse/ClickHouse/pull/66703) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* `DiskS3NoSuchKeyErrors` メトリクスを追加しました。 [#66704](https://github.com/ClickHouse/ClickHouse/pull/66704) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* すべてのテーブルエンジンで `COMMENT` 句が動作するようにしました。 [#66832](https://github.com/ClickHouse/ClickHouse/pull/66832) ([Joe Lynch](https://github.com/joelynch)).
* 関数 `mapFromArrays` は、最初の引数として `Map(K, V)` を受け取れるようになりました。例えば、`SELECT mapFromArrays(map('a', 4, 'b', 4), ['aa', 'bb'])` は、`{('a',4):'aa',('b',4):'bb'}` を返すようになりました。また、第 1 引数が Array の場合、実際の配列の要素値が `NULL` でない限り、型として `Array(Nullable(T))` や `Array(LowCardinality(Nullable(T)))` も使用できるようになりました。 [#67103](https://github.com/ClickHouse/ClickHouse/pull/67103) ([李扬](https://github.com/taiyang-li)).
* `clickhouse-local` が `~/.clickhouse-local` から設定を読み込むようにしました。 [#67135](https://github.com/ClickHouse/ClickHouse/pull/67135) ([Azat Khuzhin](https://github.com/azat))。
* 設定 `input_format_orc_read_use_writer_time_zone` の名称を `input_format_orc_reader_timezone` に変更し、ユーザーがリーダー側のタイムゾーンを設定できるようにしました。 [#67175](https://github.com/ClickHouse/ClickHouse/pull/67175) ([kevinyhzou](https://github.com/KevinyhZou)).
* HTTP 接続確立直後にピア側によって接続がリセットされた場合の `Socket is not connected` エラーのレベルを下げました。[#34218](https://github.com/ClickHouse/ClickHouse/issues/34218)。[#67177](https://github.com/ClickHouse/ClickHouse/pull/67177)（[vdimir](https://github.com/vdimir)）。
* 設定ファイルから `system.dashboards` 用のダッシュボードを読み込めるようにしました（いったん設定すると、デフォルトのダッシュボード プリセットを上書きします）。 [#67232](https://github.com/ClickHouse/ClickHouse/pull/67232) ([Azat Khuzhin](https://github.com/azat)).
* SQL のウィンドウ関数は一般的にスネークケースで記述されます。ClickHouse は `camelCase` を使用するため、新しいエイリアス `denseRank()` と `percentRank()` が作成されました。これらの新しい関数は、元の `dense_rank()` および `percent_rank()` 関数とまったく同じように呼び出すことができます。スネークケースと camelCase の両方の構文が引き続き使用可能です。各関数に対する新しいテストも追加されました。これにより [#67042](https://github.com/ClickHouse/ClickHouse/issues/67042) がクローズされます。 [#67334](https://github.com/ClickHouse/ClickHouse/pull/67334) ([Peter Nguyen](https://github.com/petern48))。
* 設定ファイルの形式が `.xml`、`.yml`、`.yaml` でない場合、自動検出します。ファイルが &lt; で始まる場合は XML の可能性があり、そうでない場合は YAML の可能性があります。これはパイプから設定ファイルを渡すときに便利です: `clickhouse-server --config-file <(echo "hello: world")`。[#67391](https://github.com/ClickHouse/ClickHouse/pull/67391)（[sakulali](https://github.com/sakulali)）。
* Functions `formatDateTime` と `formatDateTimeInJodaSyntax` は、format パラメータを省略可能なものとして扱うようになりました。指定されていない場合、フォーマット文字列 `%Y-%m-%d %H:%i:%s` および `yyyy-MM-dd HH:mm:ss` が使用されます。例: `SELECT parseDateTime('2021-01-04 23:12:34')` は、現在 DateTime 値 `2021-01-04 23:12:34` を返します（以前は例外をスローしていました）。 [#67399](https://github.com/ClickHouse/ClickHouse/pull/67399) ([Robert Schulze](https://github.com/rschu1ze)).
* KeeperMap で、タイムアウトまたは接続断により失敗した Keeper へのリクエストを自動的に再試行するようにしました。 [#67448](https://github.com/ClickHouse/ClickHouse/pull/67448) ([Antonio Andelic](https://github.com/antonio2368)).
* ClickHouse の再起動後でもスタックトレースを適切に解析およびシンボル解決できるよう、Aarch64 Linux ビルドに `-no-pie` オプションを追加しました。 [#67916](https://github.com/ClickHouse/ClickHouse/pull/67916) ([filimonov](https://github.com/filimonov)).
* マージおよびミューテーション向けのプロファイルイベントを追加し、内部状態の把握を容易にしました。 [#68015](https://github.com/ClickHouse/ClickHouse/pull/68015) ([Anton Popov](https://github.com/CurtizJ)).
* レプリケートされていない `MergeTree` 用の不要なログを削除しました。 [#68238](https://github.com/ClickHouse/ClickHouse/pull/68238) ([Daniil Ivanik](https://github.com/divanik)).



#### ビルド／テスト／パッケージングの改善 {#buildtestingpackaging-improvement-1}
* 統合テストのフレークチェックで、テスト内の問題をより多く発見しテストの信頼性を高めるため、各テストケースを複数回実行するようになりました。同一の環境でテストケースを複数回実行するために `pytest-repeat` ライブラリを使用しています。テストに合格させるには、テストケースの最後にテーブルやそのほかのエンティティをクリーンアップすることが重要です。必要なコンテナを一度だけ起動すればよいため、この繰り返し実行のほうが pytest を複数回実行するよりもはるかに高速です。[#66986](https://github.com/ClickHouse/ClickHouse/pull/66986)（[Ilya Yatsishin](https://github.com/qoega)）。
* ClickHouse の開発で CLion を利用できるようにしました。以前のバージョンでは、CLion はキー入力のたびに 1 分ほどフリーズしていました。これにより [#66994](https://github.com/ClickHouse/ClickHouse/issues/66994) がクローズされます。[#66995](https://github.com/ClickHouse/ClickHouse/pull/66995)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* getauxval: 新しい Linux カーネルで ASLR のエントロピーが高いことにより、sanitizer の再実行時にクラッシュする問題を回避しました。[#67081](https://github.com/ClickHouse/ClickHouse/pull/67081)（[Raúl Marín](https://github.com/Algunenano)）。
* クライアントコードの一部を単一のファイルに切り出し、デバッグビルドであっても可能な限り高い最適化レベルを適用しました。これにより [#65745](https://github.com/ClickHouse/ClickHouse/issues/65745) がクローズされます。[#67215](https://github.com/ClickHouse/ClickHouse/pull/67215)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。



#### バグ修正 {#bug-fix}

* 実験的な Variant データ型にのみ該当します。Variant と AggregateFunction 型の組み合わせで発生していたクラッシュを修正しました。[#67122](https://github.com/ClickHouse/ClickHouse/pull/67122) ([Kruglov Pavel](https://github.com/Avogar))。
* 接続が空の場合の DistributedAsyncInsert のクラッシュを修正。 [#67219](https://github.com/ClickHouse/ClickHouse/pull/67219) ([Pablo Marcos](https://github.com/pamarcos))。
* `tuple()` 引数を指定した場合に `uniq` および `uniqTheta` がクラッシュする問題を修正しました。 [#67303](https://github.com/ClickHouse/ClickHouse/issues/67303) をクローズしました。 [#67306](https://github.com/ClickHouse/ClickHouse/pull/67306)（[flynn](https://github.com/ucasfl)）。
* [#66026](https://github.com/ClickHouse/ClickHouse/issues/66026) を修正しました。`ReplaceTableNodeToDummyVisitor` において、未解決のテーブル関数の引数を走査しないようにしました。[#67522](https://github.com/ClickHouse/ClickHouse/pull/67522)（[Dmitry Novik](https://github.com/novikd)）。
* `JSONMergePatch` 関数で発生しうるスタックオーバーフローを修正しました。以前の名前が不適切だったため、この関数名を `jsonMergePatch` から `JSONMergePatch` に変更しました。以前の名前も互換性維持のために残されています。関数内のエラー診断を改善しました。これにより [#67304](https://github.com/ClickHouse/ClickHouse/issues/67304) が解決されます。[#67756](https://github.com/ClickHouse/ClickHouse/pull/67756)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 細工されたクエリにより `hopEnd`、`hopStart`、`tumbleEnd`、`tumbleStart` を通じてサーバーがクラッシュしていた NULL ポインタ参照の問題を修正しました。 [#68098](https://github.com/ClickHouse/ClickHouse/pull/68098) ([Salvatore Mesoraca](https://github.com/aiven-sal))。
* サブクエリを使用したフィルタリング時に一部の system テーブルで発生していた `Not-ready Set` の問題を修正しました。 [#66018](https://github.com/ClickHouse/ClickHouse/pull/66018) ([Michael Kolupaev](https://github.com/al13n321)).
* `ALTER ADD COLUMN` クエリ実行後にサブカラムを読み取る際の不具合を修正しました。 [#66243](https://github.com/ClickHouse/ClickHouse/pull/66243) ([Anton Popov](https://github.com/CurtizJ)).
* `PostgreSQL` などのエンジンを使用する外部データベースに送信されるクエリ内のブール値リテラルを修正しました。 [#66282](https://github.com/ClickHouse/ClickHouse/pull/66282) ([vdimir](https://github.com/vdimir)).
* JOIN ON 句内の別名付き式を含むクエリのフォーマットを修正しました。例: `... JOIN t2 ON (x = y) AS e ORDER BY x` は `... JOIN t2 ON ((x = y) AS e) ORDER BY x` とフォーマットされるべきです。 [#66312](https://github.com/ClickHouse/ClickHouse/pull/66312) ([vdimir](https://github.com/vdimir))。
* inter-server secret 用の `cluster()` を修正し、以前と同様に `initial user` を保持するようにしました。 [#66364](https://github.com/ClickHouse/ClickHouse/pull/66364) ([Azat Khuzhin](https://github.com/azat))。
* null を含む Array フィールドを Array(Variant) に変換する際に発生する可能性のある実行時エラーを修正。 [#66727](https://github.com/ClickHouse/ClickHouse/pull/66727) ([Kruglov Pavel](https://github.com/Avogar)).
* Context::getDDLWorker においてまれに発生するデッドロックの修正。 [#66843](https://github.com/ClickHouse/ClickHouse/pull/66843) ([Alexander Gololobov](https://github.com/davenger)).
* 不完全な DROP 操作の後に KeeperMap テーブルを作成する処理を修正しました。 [#66865](https://github.com/ClickHouse/ClickHouse/pull/66865) ([Antonio Andelic](https://github.com/antonio2368)).
* `s3_plain_rewritable` ディスクへのリストア中に発生する破損したパーツに関するエラーを修正。 [#66881](https://github.com/ClickHouse/ClickHouse/pull/66881) ([Vitaly Baranov](https://github.com/vitlibar)).
* まれなケースで、ディスク上の予期しない projection により、ClickHouse が一部のパーツを壊れていると誤判定してしまうことがありました。現在は修正されています。 [#66898](https://github.com/ClickHouse/ClickHouse/pull/66898) ([alesapin](https://github.com/alesapin)).
* スキーマ推論における無効なフォーマット検出を修正し、論理エラー「Format {} doesn&#39;t support schema inference」の発生を防止しました。[#66899](https://github.com/ClickHouse/ClickHouse/pull/66899) ([Kruglov Pavel](https://github.com/Avogar))。
* 並列レプリカ使用時のクエリキャンセル時に発生する可能性のあるデッドロックを修正しました。 [#66905](https://github.com/ClickHouse/ClickHouse/pull/66905) ([Nikita Taranov](https://github.com/nickitat)).
* `database_replicated_allow_heavy_create` が設定されている場合でも、`CREATE AS SELECT` を禁止するようにしました。23.12 では無条件に禁止されており、未リリースの 24.7 ではこの設定が有効な場合に誤って許可されていました。 [#66980](https://github.com/ClickHouse/ClickHouse/pull/66980) ([vdimir](https://github.com/vdimir))。
* `numbers` から読み取る際、`max_rows_to_read` の上限が設定されていると、誤って例外がスローされる可能性がありました。これにより [#66992](https://github.com/ClickHouse/ClickHouse/issues/66992) がクローズされました。 [#66996](https://github.com/ClickHouse/ClickHouse/pull/66996)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* lagInFrame および leadInFrame のウィンドウ関数に対して適切な型変換を追加し、msan テストを修正。 [#67091](https://github.com/ClickHouse/ClickHouse/pull/67091) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* TRUNCATE DATABASE が DROP DATABASE クエリと同様にレプリケーションを停止してしまっていた問題を修正しました。 [#67129](https://github.com/ClickHouse/ClickHouse/pull/67129) ([Alexander Tokmakov](https://github.com/tavplubix)).
* `clickhouse-local` でクライアントコンテキストを分離して使用するようにしました。 [#67133](https://github.com/ClickHouse/ClickHouse/pull/67133) ([Vitaly Baranov](https://github.com/vitlibar))。
* 1 シャードのみの構成で `Distributed` テーブル経由で `Merge` テーブルを読み出すクエリにおいて、エラー `Cannot convert column because it is non constant in source stream but must be constant in result.` が発生する問題を修正しました。 [#67146](https://github.com/ClickHouse/ClickHouse/pull/67146) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `enable_order_by_all` 無効時および並列レプリカ（分散クエリを含む）における `ORDER BY all` の動作を正しくしました。 [#67153](https://github.com/ClickHouse/ClickHouse/pull/67153) ([Igor Nikonov](https://github.com/devcrafter)).
* スキーマキャッシュにおけるスキーマ推論用の `input&#95;format&#95;max&#95;bytes&#95;to&#95;read&#95;for&#95;schema&#95;inference` の誤った使用方法を修正しました。 [#67157](https://github.com/ClickHouse/ClickHouse/pull/67157) ([Kruglov Pavel](https://github.com/Avogar)).
* GROUP BY で単一の Nullable キーを使用している際に例外が発生した場合に、`count distinct` で発生していたメモリリークを修正しました。 [#67171](https://github.com/ClickHouse/ClickHouse/pull/67171) ([Jet He](https://github.com/compasses)).
* OUTER JOIN を INNER JOIN に変換してしまっていた最適化のエラーを修正しました。これにより [#67156](https://github.com/ClickHouse/ClickHouse/issues/67156) および [#66447](https://github.com/ClickHouse/ClickHouse/issues/66447) がクローズされます。このバグは [https://github.com/ClickHouse/ClickHouse/pull/62907](https://github.com/ClickHouse/ClickHouse/pull/62907) で導入されました。[#67178](https://github.com/ClickHouse/ClickHouse/pull/67178)（[Maksim Kita](https://github.com/kitaisreal)）。
* エラー `Conversion from AggregateFunction(name, Type) to AggregateFunction(name, Nullable(Type)) is not supported` を修正。バグの原因は `optimize_rewrite_aggregate_function_with_if` 最適化でした。[#67112](https://github.com/ClickHouse/ClickHouse/issues/67112) を修正。[#67229](https://github.com/ClickHouse/ClickHouse/pull/67229)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `IN` 関数の左辺に空のタプルを使用した場合にクエリがハングしてしまう問題を修正。 [#67295](https://github.com/ClickHouse/ClickHouse/pull/67295) ([Duc Canh Le](https://github.com/canhld94)).
* 未知のフィールドをスキップする際にスタックオーバーフローを引き起こす、非常に深くネストした JSON データを作成できていました。これにより [#67292](https://github.com/ClickHouse/ClickHouse/issues/67292) が解決されました。[#67324](https://github.com/ClickHouse/ClickHouse/pull/67324)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 起動時に発生した例外の後に ReplicatedMergeTree テーブルをアタッチする処理を修正。 [#67360](https://github.com/ClickHouse/ClickHouse/pull/67360) ([Antonio Andelic](https://github.com/antonio2368)).
* `Aggregator` でスレッドグループからのデタッチ処理を誤っていたために発生していたセグメンテーションフォルトを修正。 [#67385](https://github.com/ClickHouse/ClickHouse/pull/67385) ([Antonio Andelic](https://github.com/antonio2368)).
* PK に非決定的関数が指定されているもう一つのケースを修正しました。 [#67395](https://github.com/ClickHouse/ClickHouse/pull/67395) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `(k=2)=(k=2)` や `has([1,2,3], k)` のようなやや特殊な条件でクエリが誤動作してしまう `bloom_filter` インデックスの問題を修正しました。 [#67423](https://github.com/ClickHouse/ClickHouse/pull/67423) ([Michael Kolupaev](https://github.com/al13n321))。
* アーカイブでない場合は、`::` を含むファイル名や URI を正しくパースするようにしました。 [#67433](https://github.com/ClickHouse/ClickHouse/pull/67433) ([Antonio Andelic](https://github.com/antonio2368)).
* WriteBuffer がキャンセルされた場合に ~WriteBufferFromS3 内でタスクを待機する処理を修正。 [#67459](https://github.com/ClickHouse/ClickHouse/pull/67459) ([Kseniia Sumarokova](https://github.com/kssenii)).
* RESTORE の実行中に一時パーツディレクトリが削除されないよう保護しました。 [#67491](https://github.com/ClickHouse/ClickHouse/pull/67491) ([Vitaly Baranov](https://github.com/vitlibar)).
* ネストされた短絡評価関数の実行を修正。 [#67520](https://github.com/ClickHouse/ClickHouse/pull/67520) ([Kruglov Pavel](https://github.com/Avogar)).
* `Logical error: Expected the argument №N of type T to have X rows, but it has 0` を修正しました。新しいアナライザーの使用時に、`GROUP BY` 句内の定数式を含むリモートクエリでこのエラーが発生する可能性がありました。 [#67536](https://github.com/ClickHouse/ClickHouse/pull/67536) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `NULL` を含むタプルでの結合の修正: 新しいアナライザーを使用した場合に、`JOIN ON` 句内で `NULL` を含むタプルを使う一部のクエリが誤った結果を返す問題を修正しました。 [#67538](https://github.com/ClickHouse/ClickHouse/pull/67538) ([vdimir](https://github.com/vdimir)).
* 削除不可のキャッシュが満杯の場合における FileCache::freeSpaceRatioKeepingThreadFunc() の冗長な再スケジュールを修正。 [#67540](https://github.com/ClickHouse/ClickHouse/pull/67540) ([Kseniia Sumarokova](https://github.com/kssenii)).
* HTTP インターフェイス経由でのストリーム系エンジン（Kafka、RabbitMQ、NATS）への挿入処理を修正。 [#67554](https://github.com/ClickHouse/ClickHouse/pull/67554) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* 小さい `DateTime64` 値に対して誤った結果を返していた関数 `toStartOfWeek` の不具合を修正しました。 [#67558](https://github.com/ClickHouse/ClickHouse/pull/67558) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* 再帰CTEを使用するビュー作成の不具合を修正。 [#67587](https://github.com/ClickHouse/ClickHouse/pull/67587) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* ファイルシステムキャッシュで発生する `Logical error: 'file_offset_of_buffer_end &lt;= read_until_position'` を修正しました。[#57508](https://github.com/ClickHouse/ClickHouse/issues/57508) をクローズします。[#67623](https://github.com/ClickHouse/ClickHouse/pull/67623)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* [#62282](https://github.com/ClickHouse/ClickHouse/issues/62282) を修正しました。`convertFieldToString()` の呼び出しを削除し、データ型ごとのシリアライズ用コードを追加しました。パラメータ化ビューの置換機能は、パラメータ値がデータ型インスタンスを返す関数または式である場合、複数のデータ型に対して正しく動作していませんでした。[#67654](https://github.com/ClickHouse/ClickHouse/pull/67654)（[Shankar](https://github.com/shiyer7474)）。
* `percent_rank` がクラッシュする問題を修正。`percent_rank` のデフォルトのフレーム種別を `range unbounded preceding and unbounded following` に変更。`IWindowFunction` のデフォルトのウィンドウフレームが考慮されるようになり、これにより SQL でウィンドウフレーム定義のないウィンドウ関数も、それぞれ適切な `WindowTransfomer` に配置できるようになった。[#67661](https://github.com/ClickHouse/ClickHouse/pull/67661) ([lgbo](https://github.com/lgbo-ustc)).
* UNION を使用する SQL UDF のリロード処理を修正しました。以前は、サーバーを再起動すると UDF が無効になってしまうことがありました。 [#67665](https://github.com/ClickHouse/ClickHouse/pull/67665) ([Antonio Andelic](https://github.com/antonio2368))。
* Tuples および Maps を引数に取る `if` 関数で、実験的な Variant 型と設定 `use_variant_as_common_type` を有効にした際に発生しうる論理エラー「Unexpected return type from if」を修正しました。 [#67687](https://github.com/ClickHouse/ClickHouse/pull/67687) ([Kruglov Pavel](https://github.com/Avogar)).
* Linux カーネルのバグにより、クエリが `TimerDescriptor::drain` 内でハングする場合があります。この問題の修正により [#37686](https://github.com/ClickHouse/ClickHouse/issues/37686) がクローズされました。 [#67702](https://github.com/ClickHouse/ClickHouse/pull/67702)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* `RESTORE ON CLUSTER` コマンドの完了時の挙動を修正しました。 [#67720](https://github.com/ClickHouse/ClickHouse/pull/67720) ([Vitaly Baranov](https://github.com/vitlibar)).
* ロード中に CANNOT&#95;SCHEDULE&#95;TASK が発生した場合に辞書がハングする問題を修正。 [#67751](https://github.com/ClickHouse/ClickHouse/pull/67751) ([Azat Khuzhin](https://github.com/azat)).
* `c` に対して Bloom filter インデックスがある場合の `SELECT count() FROM t WHERE cast(c = 1 or c = 9999 AS Bool) SETTINGS use_skip_indexes=1` のようなクエリが、正しく動作するようになりました。 [#67781](https://github.com/ClickHouse/ClickHouse/pull/67781) ([jsc0218](https://github.com/jsc0218)).
* 一部のクエリで、キーおよびフィルタなしの集約に対して誤った集約結果が返される問題を修正しました。 [#67419](https://github.com/ClickHouse/ClickHouse/issues/67419)。 [#67804](https://github.com/ClickHouse/ClickHouse/pull/67804)（[vdimir](https://github.com/vdimir)）。
* ALTER 文の ADD/MODIFY COLUMN で、実験的または疑わしいデータ型を検証するようにしました。 [#67911](https://github.com/ClickHouse/ClickHouse/pull/67911) ([Kruglov Pavel](https://github.com/Avogar)).
* 分散クエリでの定数畳み込み後の DateTime64 のパースを修正し、[#66773](https://github.com/ClickHouse/ClickHouse/issues/66773) をクローズしました。[#67920](https://github.com/ClickHouse/ClickHouse/pull/67920)（[vdimir](https://github.com/vdimir)）。
* 述語内に非決定的関数が含まれている場合に `count()` が不正な結果を返す問題を修正。 [#67922](https://github.com/ClickHouse/ClickHouse/pull/67922) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* 使用可能な CPU 数が制限されているコンテナ化環境において、最大スレッド数のソフトリミットの計算を修正しました。 [#67963](https://github.com/ClickHouse/ClickHouse/pull/67963) ([Robert Schulze](https://github.com/rschu1ze)).
* ClickHouse は、`checksums.txt` には存在するがディスク上には存在しない projection があっても、そのパーツを破損しているとは見なさなくなりました。 [#68003](https://github.com/ClickHouse/ClickHouse/pull/68003) ([alesapin](https://github.com/alesapin)).
* 新しい analyzer を用いた mutation において、変更されていないパーツをスキップする処理を修正しました。以前は analyzer を有効にしていると、述語上は影響しないはずの mutation によって、そのパーツ内のデータが書き換えられてしまう可能性がありました。 [#68052](https://github.com/ClickHouse/ClickHouse/pull/68052) ([Anton Popov](https://github.com/CurtizJ)).
* `OFFSET` を使用するサブクエリでソートを削除してしまう誤った最適化を取り除きました。[#67906](https://github.com/ClickHouse/ClickHouse/issues/67906) を修正。[#68099](https://github.com/ClickHouse/ClickHouse/pull/68099)（[Graham Campbell](https://github.com/GrahamCampbell)）。
* 集約プロジェクションの最適化において発生する `Block structure mismatch in AggregatingStep stream: different types` を修正しようと試みました。 [#68107](https://github.com/ClickHouse/ClickHouse/pull/68107) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* クエリがキャンセルされた際に Postgres がクラッシュする問題の修正を試みました。 [#68288](https://github.com/ClickHouse/ClickHouse/pull/68288) ([Kseniia Sumarokova](https://github.com/kssenii)).
* クエリ `SYSTEM SYNC REPLICA` の不足していた同期レプリカモードを修正。 [#68326](https://github.com/ClickHouse/ClickHouse/pull/68326) ([Duc Canh Le](https://github.com/canhld94)).



### <a id="247"></a> ClickHouse リリース 24.7, 2024-07-30 {#a-id247a-clickhouse-release-247-2024-07-30}

#### 後方互換性のない変更 {#backward-incompatible-change-5}
* Replicated データベースでは、`CRATE MATERIALIZED VIEW ... ENGINE Replicated*MergeTree POPULATE AS SELECT ...` を禁止しました。 [#63963](https://github.com/ClickHouse/ClickHouse/pull/63963) ([vdimir](https://github.com/vdimir)).
* `clickhouse-keeper-client` は、`ls '/hello/world'` のような文字列リテラル内のパスのみを受け付け、`ls /hello/world` のようなクォートされていないパスは受け付けません。 [#65494](https://github.com/ClickHouse/ClickHouse/pull/65494) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* メトリクス `KeeperOutstandingRequets` は `KeeperOutstandingRequests` に名前が変更されました。 [#66206](https://github.com/ClickHouse/ClickHouse/pull/66206) ([Robert Schulze](https://github.com/rschu1ze)).
* `system.functions` テーブルから `is_deterministic` フィールドを削除しました。 [#66630](https://github.com/ClickHouse/ClickHouse/pull/66630) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* 関数 `tuple` は、クエリ内で名前付きタプルの構築を試みるようになりました（`enable_named_columns_in_function_tuple` で制御）。タプルから名前を抽出する関数 `tupleNames` を追加しました。 [#54881](https://github.com/ClickHouse/ClickHouse/pull/54881) ([Amos Bird](https://github.com/amosbird)).
* マテリアライズドビューに対する重複排除の動作を変更しました。次のような多くのケースが修正されています。- 宛先テーブルで、データが 2 つ以上のブロックに分割されており、そのブロックが並列に挿入された際に重複として扱われるケース。- マテリアライズドビュー (MV) の宛先テーブルで、等価なブロックが重複排除されるケース。これは、集約の実行により、異なる入力データに対して MV が同じデータを結果として頻繁に生成する場合に発生します。- MV の宛先テーブルで、異なる MV から来た等価なブロックが重複排除されるケース。 [#61601](https://github.com/ClickHouse/ClickHouse/pull/61601) ([Sema Checherinda](https://github.com/CheSema)).
* 関数 `bitShiftLeft` および `bitShitfRight` は、シフト位置が範囲外の場合にエラーを返すようになりました。 [#65838](https://github.com/ClickHouse/ClickHouse/pull/65838) ([Pablo Marcos](https://github.com/pamarcos)).



#### 新機能 {#new-feature-5}
* `full_sorting_join` アルゴリズムに対する `ASOF JOIN` のサポートを追加。[#55051](https://github.com/ClickHouse/ClickHouse/pull/55051) ([vdimir](https://github.com/vdimir)).
* `clickhouse-client` で JWT 認証をサポート（ClickHouse Cloud でのみ利用可能）。[#62829](https://github.com/ClickHouse/ClickHouse/pull/62829) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* SQL 関数 `changeYear`, `changeMonth`, `changeDay`, `changeHour`, `changeMinute`, `changeSecond` を追加。例えば `SELECT changeMonth(toDate('2024-06-14'), 7)` は日付 `2024-07-14` を返します。[#63186](https://github.com/ClickHouse/ClickHouse/pull/63186) ([cucumber95](https://github.com/cucumber95)).
* 起動スクリプトを導入し、起動段階で事前設定済みクエリを実行できるようにしました。[#64889](https://github.com/ClickHouse/ClickHouse/pull/64889) ([pufit](https://github.com/pufit)).
* クライアント設定で `accept_invalid_certificate` をサポートし、自己署名証明書で動作するサーバーに対して、クライアントがセキュアな TCP で接続できるようにしました。対応する `openSSL` クライアント設定 `verificationMode=none` + `invalidCertificateHandler.name=AcceptCertificateHandler` の省略形として利用できます。[#65238](https://github.com/ClickHouse/ClickHouse/pull/65238) ([peacewalker122](https://github.com/peacewalker122)).
* `system.errors` テーブルからのエラー値の履歴を保持し、定期的にディスクへフラッシュする `system.error_log` を追加。[#65381](https://github.com/ClickHouse/ClickHouse/pull/65381) ([Pablo Marcos](https://github.com/pamarcos)).
* 集約関数 `groupConcat` を追加。`arrayStringConcat( groupArray(column), ',')` とほぼ同じです。2 つのパラメータ（文字列の区切り文字と処理する要素数）を受け取ることができます。[#65451](https://github.com/ClickHouse/ClickHouse/pull/65451) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Azure Queue ストレージを追加。[#65458](https://github.com/ClickHouse/ClickHouse/pull/65458) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Parquet ファイルにページインデックスを書き込むかどうかを無効化/有効化する新しい設定を追加。[#65475](https://github.com/ClickHouse/ClickHouse/pull/65475) ([lgbo](https://github.com/lgbo-ustc)).
* コンソール（有効になっている場合）へのログレベルを制御するための `logger.console_log_level` サーバー設定を導入。[#65559](https://github.com/ClickHouse/ClickHouse/pull/65559) ([Azat Khuzhin](https://github.com/azat)).
* テーブル関数 `file` で、ディレクトリパスの末尾にワイルドカード `*` を自動的に付加。[#66019](https://github.com/ClickHouse/ClickHouse/pull/66019) ([Zhidong (David) Guo](https://github.com/Gun9niR)).
* クライアントの非インタラクティブモードに `--memory-usage` オプションを追加。[#66393](https://github.com/ClickHouse/ClickHouse/pull/66393) ([vdimir](https://github.com/vdimir)).
* `clickhouse-disks` 用のインタラクティブクライアントを作成し、ローカルディレクトリからローカルディスクを追加できるようにしました。[#64446](https://github.com/ClickHouse/ClickHouse/pull/64446) ([Daniil Ivanik](https://github.com/divanik)).
* プロジェクションを持つテーブルで `LIGHTWEIGHT DELETE` が発生した場合、ユーザーは例外を投げる（デフォルト）か、プロジェクションを削除するかを選択できます。[#65594](https://github.com/ClickHouse/ClickHouse/pull/65594) ([jsc0218](https://github.com/jsc0218)).
* すべての detached（切り離された）テーブルに関する主要な情報を含む system テーブルを追加。[#65400](https://github.com/ClickHouse/ClickHouse/pull/65400) ([Konstantin Morozov](https://github.com/k-morozov)).



#### 実験的機能 {#experimental-feature-4}
* `Variant` データ型のバイナリシリアル化を変更しました。単一のバリアントのみ、または NULL 値のみを持つグラニュールで同じ判別子を繰り返し書き込まないようにするため、`compact` モードを追加しました。デフォルトで有効な MergeTree 設定 `use_compact_variant_discriminators_serialization` を追加しました。Variant 型は依然として実験的であり、シリアル化形式に後方互換性のない変更が入ることは許容される点に注意してください。 [#62774](https://github.com/ClickHouse/ClickHouse/pull/62774) ([Kruglov Pavel](https://github.com/Avogar)).
* clickhouse-keeper 用にディスクベースのバックエンドストレージをサポートしました。 [#56626](https://github.com/ClickHouse/ClickHouse/pull/56626) ([Han Fei](https://github.com/hanfei1991)).
* JSONExtract 関数をリファクタリングし、実験的な Dynamic 型を含む、より多くの型をサポートしました。 [#66046](https://github.com/ClickHouse/ClickHouse/pull/66046) ([Kruglov Pavel](https://github.com/Avogar)).
* `Variant` および `Dynamic` のサブカラムに対して null map サブカラムをサポートしました。 [#66178](https://github.com/ClickHouse/ClickHouse/pull/66178) ([Kruglov Pavel](https://github.com/Avogar)).
* 変更された `Memory` テーブルからの `Dynamic` サブカラムの読み取りを修正しました。以前は、Dynamic 型の `max_types` パラメータが ALTER 文によって Memory テーブルで変更された場合、その後のサブカラムの読み取りで誤った結果が返される可能性がありました。 [#66066](https://github.com/ClickHouse/ClickHouse/pull/66066) ([Kruglov Pavel](https://github.com/Avogar)).
* カスタムキーの parallel replicas 使用時に `cluster_for_parallel_replicas` をサポートしました。これにより、MergeTree テーブルでカスタムキーと parallel replicas を併用できるようになります。 [#65453](https://github.com/ClickHouse/ClickHouse/pull/65453) ([Antonio Andelic](https://github.com/antonio2368)).



#### パフォーマンスの改善 {#performance-improvement-5}
* int から string への変換アルゴリズムを、より高速なもの（amdn/itoa の修正版から jeaiii/itoa の修正版）に置き換えました。 [#61661](https://github.com/ClickHouse/ClickHouse/pull/61661) ([Raúl Marín](https://github.com/Algunenano)).
* join（`parallel_hash` アルゴリズム）で作成されるハッシュテーブルのサイズを収集してキャッシュするようにしました。この情報は、後続のクエリ実行においてハッシュテーブルを事前確保するために使用され、ハッシュテーブルのリサイズにかかる時間を削減します。 [#64553](https://github.com/ClickHouse/ClickHouse/pull/64553) ([Nikita Taranov](https://github.com/nickitat)).
* バッファリングを用いることで、`ORDER BY` 主キーと、高い選択性を持つ条件を含む `WHERE` 句を伴うクエリを最適化しました。これは設定 `read_in_order_use_buffering`（デフォルトで有効）で制御され、クエリのメモリ使用量が増加する可能性があります。 [#64607](https://github.com/ClickHouse/ClickHouse/pull/64607) ([Anton Popov](https://github.com/CurtizJ)).
* `plain_rewritable` メタデータの読み込み性能を改善しました。 [#65634](https://github.com/ClickHouse/ClickHouse/pull/65634) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* 読み取り専用ディスク上でテーブルをアタッチする際に、古くなったパーツを読み込まないことで、リソース消費を削減しました。 [#65635](https://github.com/ClickHouse/ClickHouse/pull/65635) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Set インデックスに対して minmax ハイパーレクタングルをサポートしました。 [#65676](https://github.com/ClickHouse/ClickHouse/pull/65676) ([AntiTopQuark](https://github.com/AntiTopQuark)).
* 古くなったパーツのプライマリインデックスをアンロードして、総メモリ使用量を削減しました。 [#65852](https://github.com/ClickHouse/ClickHouse/pull/65852) ([Anton Popov](https://github.com/CurtizJ)).
* パターンがメタ文字、パターンクラス、フラグ、グルーピング文字などを含まない単純なものである場合、`replaceRegexpAll` と `replaceRegexpOne` 関数が大幅に高速になりました（Taiyang Li に感謝します）。 [#66185](https://github.com/ClickHouse/ClickHouse/pull/66185) ([Robert Schulze](https://github.com/rschu1ze)).
* S3 リクエスト: クエリ用のリトライ時間を短縮し、バックアップ用のリトライ回数を増やしました。クエリでは 8.5 分・100 回のリトライ、バックアップ復元では 1.2 時間・1000 回のリトライとなります。 [#65232](https://github.com/ClickHouse/ClickHouse/pull/65232) ([Sema Checherinda](https://github.com/CheSema)).
* クエリプランに対する LIMIT の最適化をサポートしました。PostgreSQL ストレージおよびテーブル関数に対する LIMIT のプッシュダウンもサポートしました。 [#65454](https://github.com/ClickHouse/ClickHouse/pull/65454) ([Maksim Kita](https://github.com/kitaisreal)).
* ZooKeeper のロードバランシングを改善しました。`fallback_session_lifetime` に関わらず、最適なノードが利用可能になるまで現在のセッションは期限切れになりません。AZ を考慮したバランシングをサポートしました。 [#65570](https://github.com/ClickHouse/ClickHouse/pull/65570) ([Alexander Tokmakov](https://github.com/tavplubix)).
* DatabaseCatalog が、最大で database_catalog_drop_table_concurrency 個のスレッドを使用してテーブルをより高速に削除するようになりました。 [#66065](https://github.com/ClickHouse/ClickHouse/pull/66065) ([Sema Checherinda](https://github.com/CheSema)).



#### 改善 {#improvement-5}

* ZooKeeper の負荷分散を改善しました。`fallback_session_lifetime` に関わらず、最適なノードが利用可能になるまで現在のセッションが失効しないようになりました。AZ（アベイラビリティゾーン）を考慮したバランシングをサポートしました。 [#65570](https://github.com/ClickHouse/ClickHouse/pull/65570) ([Alexander Tokmakov](https://github.com/tavplubix))。
* 設定 `optimize_trivial_insert_select` はデフォルトで無効になっています。多くの場合、この設定は有利に働きます。ただし、INSERT SELECT の実行が遅くなったりメモリ使用量が増加している場合は、再度有効化するか、`SET compatibility = '24.6'` を実行してください。 [#58970](https://github.com/ClickHouse/ClickHouse/pull/58970) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* `clickhouse-client` または `clickhouse-local` がクラッシュした場合にスタックトレースと診断情報を出力するようになりました。 [#61109](https://github.com/ClickHouse/ClickHouse/pull/61109) ([Alexander Tokmakov](https://github.com/tavplubix)).
* `SHOW INDEX | INDEXES | INDICES | KEYS` の結果は、以前はプライマリキーのカラム名でソートされていました。この動作は直感的ではなかったため、現在はプライマリキーを構成するカラムのプライマリキー内での位置順でソートされるようになりました。 [#61131](https://github.com/ClickHouse/ClickHouse/pull/61131) ([Robert Schulze](https://github.com/rschu1ze))。
* マテリアライズドビューに対する重複排除の動作を変更し、次のような多くのケースを修正しました。- 宛先テーブル上で、データが 2 つ以上のブロックに分割され、それらのブロックが並行して挿入されたときに重複として扱われてしまうケース。- MV の宛先テーブル上で、集約処理により異なる入力データから同一の結果データが頻繁に生成されることで、同一ブロックが重複排除されてしまうケース。- MV の宛先テーブル上で、異なる MV から来た同一ブロックが重複排除されてしまうケース。 [#61601](https://github.com/ClickHouse/ClickHouse/pull/61601) ([Sema Checherinda](https://github.com/CheSema)).
* パーティション化された DeltaLake データの読み取りをサポートしました。データ本体ではなくメタデータを読み取ることで DeltaLake のスキーマを推論します。 [#63201](https://github.com/ClickHouse/ClickHouse/pull/63201) ([Kseniia Sumarokova](https://github.com/kssenii))。
* Composable Protocols において、TLS レイヤーは `certificateFile` と `privateKeyFile` パラメータのみを受け付けます。 [https://clickhouse.com/docs/operations/settings/composable-protocols](https://clickhouse.com/docs/operations/settings/composable-protocols)。 [#63985](https://github.com/ClickHouse/ClickHouse/pull/63985) ([Anton Ivashkin](https://github.com/ianton-ru))。
* WHERE 句の評価で主キーを使用する SELECT クエリの数を示すプロファイルイベント `SelectQueriesWithPrimaryKeyUsage` を追加しました。 [#64492](https://github.com/ClickHouse/ClickHouse/pull/64492) ([0x01f](https://github.com/0xfei)).
* `StorageS3Queue` に関連する修正と改善。サーバー上の物理 CPU コア数に応じて `s3queue_processing_threads_num` のデフォルト値を自動的に決定するように変更（以前のデフォルト値である 1 の代わり）。`s3queue_loading_retries` のデフォルト値を 10 に設定。`system.s3queue` の exception カラムで発生しうる曖昧な「Uncaught exception」を修正。`MEMORY_LIMIT_EXCEEDED` 例外発生時にはリトライ回数を増やさないように変更。ファイルが挿入されていない状態でコミットされることを避けるため、ファイルのコミット処理をテーブルへの挿入が完全に終了した後のステージに移動。コミットおよびフラッシュのタイミングをより細かく制御できるように、`s3queue_max_processed_files_before_commit`、`s3queue_max_processed_rows_before_commit`、`s3queue_max_processed_bytes_before_commit`、`s3queue_max_processing_time_sec_before_commit` 設定を追加。 [#65046](https://github.com/ClickHouse/ClickHouse/pull/65046) ([Kseniia Sumarokova](https://github.com/kssenii)).
* パラメータ化されたビュー関数でエイリアスをサポート（新しい analyzer のみ）。 [#65190](https://github.com/ClickHouse/ClickHouse/pull/65190) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Azure Blob Storage のログ内に含まれるアカウントキーをマスクするよう更新しました。 [#65273](https://github.com/ClickHouse/ClickHouse/pull/65273) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* フィルター式が `PARTITION BY` 式の一部である場合における `IN` 述語のパーティションプルーニング。[#65335](https://github.com/ClickHouse/ClickHouse/pull/65335)（[Eduard Karacharov](https://github.com/korowa)）。
* `arrayMin`/`arrayMax` は、比較可能なあらゆるデータ型に適用可能になりました。 [#65455](https://github.com/ClickHouse/ClickHouse/pull/65455) ([pn](https://github.com/chloro-pn))。
* cgroups v2 におけるメモリ使用量の計測を改善し、ページキャッシュが占める分を除外するようにしました。 [#65470](https://github.com/ClickHouse/ClickHouse/pull/65470) ([Nikita Taranov](https://github.com/nickitat)).
* EmbeddedRocksDB テーブルに挿入するためにチャンクをシリアライズする際、行ごとにフォーマット設定を作成しないようにしました。 [#65474](https://github.com/ClickHouse/ClickHouse/pull/65474) ([Duc Canh Le](https://github.com/canhld94)).
* `clickhouse-local` のプロンプトを `:)` のみに短縮しました。`getFQDNOrHostName()` は macOS では実行に時間がかかり、そもそも `clickhouse-local` のプロンプトにホスト名を表示する必要もないためです。 [#65510](https://github.com/ClickHouse/ClickHouse/pull/65510) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* 低性能な仮想マシン上での per-CPU arenas に関する jemalloc のメッセージ出力を抑制しました。 [#65532](https://github.com/ClickHouse/ClickHouse/pull/65532) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* デフォルトでファイルシステムキャッシュのバックグラウンドダウンロードを無効化しました。バックグラウンドダウンロードスレッドを使用すると、バッファはクエリコンテキスト内で確保される一方で、メモリの解放がクエリコンテキスト外で実行されるため、メモリ制限超過が発生する可能性のある問題を修正した後に、再度有効化する予定です。加えて、バックグラウンドワーカーがダウンロードするデータの最大サイズを定義するための個別の設定を追加する必要があります（現在は `max_file_segment_size` によって制限されていますが、これは大きすぎる可能性があります）。 [#65534](https://github.com/ClickHouse/ClickHouse/pull/65534)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* ClickHouse が設定を再読み込みする間隔を指定できる新しい設定オプション `<config_reload_interval_ms>` を追加しました。 [#65545](https://github.com/ClickHouse/ClickHouse/pull/65545) ([alesapin](https://github.com/alesapin))。
* ClickHouse のデータ型向けにバイナリエンコーディングを実装し、その仕様をドキュメントに追加しました。Dynamic binary serialization でこれを使用し、設定で RowBinaryWithNamesAndTypes および Native フォーマットでも利用できるようにしました。 [#65546](https://github.com/ClickHouse/ClickHouse/pull/65546) ([Kruglov Pavel](https://github.com/Avogar)).
* サーバー設定項目 `compiled_expression_cache_size` と `compiled_expression_cache_elements_size` が `system.server_settings` に表示されるようになりました。 [#65584](https://github.com/ClickHouse/ClickHouse/pull/65584) ([Robert Schulze](https://github.com/rschu1ze)).
* x509 の SubjectAltName 拡張に基づくユーザー識別のサポートを追加。 [#65626](https://github.com/ClickHouse/ClickHouse/pull/65626) ([Anton Kozlov](https://github.com/tonickkozlov))。
* `clickhouse-local` は、設定ファイル内の `max_server_memory_usage` と `max_server_memory_usage_to_ram_ratio` の値を使用します。また、`clickhouse-server` と同様に、デフォルトでシステムメモリの 90% を最大メモリ使用量として設定します。[#65697](https://github.com/ClickHouse/ClickHouse/pull/65697)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* ファイルを ClickHouse にバックアップするためのスクリプトを追加しました。 [#65699](https://github.com/ClickHouse/ClickHouse/pull/65699) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* クエリキャンセルをサポートする PostgreSQL ソース。 [#65722](https://github.com/ClickHouse/ClickHouse/pull/65722) ([Maksim Kita](https://github.com/kitaisreal)).
* 分散クエリで `allow_experimental_analyzer` をイニシエータ側で制御できるようにしました。これにより、異なるバージョンが混在するクラスタでの運用時の互換性と正確性が保証されます。 [#65777](https://github.com/ClickHouse/ClickHouse/pull/65777) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Keeper で cgroup の CPU 制限を順守するようになりました。 [#65819](https://github.com/ClickHouse/ClickHouse/pull/65819) ([Antonio Andelic](https://github.com/antonio2368)).
* 引数なしで `concat` 関数を使用できるようにしました（`:) select concat();`）。[#65887](https://github.com/ClickHouse/ClickHouse/pull/65887)（[李扬](https://github.com/taiyang-li)）。
* `clickhouse-local` で名前付きコレクションを制御可能にしました。 [#65973](https://github.com/ClickHouse/ClickHouse/pull/65973) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Azure 関連のプロファイルイベントを改善しました。 [#65999](https://github.com/ClickHouse/ClickHouse/pull/65999) ([alesapin](https://github.com/alesapin)).
* ライターのタイムゾーンを用いた ORC ファイルの読み取りをサポート。 [#66025](https://github.com/ClickHouse/ClickHouse/pull/66025) ([kevinyhzou](https://github.com/KevinyhZou)).
* PostgreSQL への接続を制御するための設定を追加しました。設定 `postgresql_connection_attempt_timeout` は、接続 URL の `connect_timeout` パラメータに渡される値を指定します。設定 `postgresql_connection_pool_retries` は、PostgreSQL エンドポイントへの接続を確立するための再試行回数を指定します。[#66232](https://github.com/ClickHouse/ClickHouse/pull/66232) ([Dmitry Novik](https://github.com/novikd))。
* `system.processors_profile_log` における `input_wait_elapsed_us` / `elapsed_us` の値の不正確さを軽減しました。 [#66239](https://github.com/ClickHouse/ClickHouse/pull/66239) ([Azat Khuzhin](https://github.com/azat)).
* ファイルシステムキャッシュ向けの ProfileEvents を改善。[#66249](https://github.com/ClickHouse/ClickHouse/pull/66249)（[zhukai](https://github.com/nauu)）。
* レプリケートされたストレージで名前付きコレクションを管理する際に、クエリ内の `ON CLUSTER` 句を無視できるようにする設定を追加しました。 [#66288](https://github.com/ClickHouse/ClickHouse/pull/66288) ([MikhailBurdukov](https://github.com/MikhailBurdukov))。
* 関数 `generateSnowflakeID` では、大規模クラスタでの ID の重複を防ぐために、マシンID をパラメータとして指定できるようになりました。 [#66374](https://github.com/ClickHouse/ClickHouse/pull/66374) ([ZAWA&#95;ll](https://github.com/Zawa-ll)).
* インタラクティブモードでの `Ctrl+Z` によるサスペンドを無効化しました。これはよくある落とし穴であり、ほとんどのユーザーにとっては期待される動作ではありません。ターミナルアプリケーションをバックグラウンドにサスペンドできることを便利だと感じるのは、ごく一部の極めて特殊なパワーユーザーだけかもしれませんが、私はそのようなユーザーを知りません。[#66511](https://github.com/ClickHouse/ClickHouse/pull/66511)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 辞書における主キーの型を検証するオプションを追加しました。このオプションがない場合、simple レイアウトでは任意のカラム型が暗黙的に UInt64 に変換されます。 [#66595](https://github.com/ClickHouse/ClickHouse/pull/66595) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).





#### バグ修正（公式安定版リリースにおけるユーザー可視の不具合） {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-4}

* CREATE/REPLACE/RENAME/EXCHANGE クエリにおける循環依存関係をチェックし、循環依存がある場合には例外をスローするようにしました。以前は、このような循環依存がサーバー起動時にデッドロックを引き起こす可能性がありました。また、依存関係の作成処理に関するいくつかのバグも修正しました。 [#65405](https://github.com/ClickHouse/ClickHouse/pull/65405) ([Kruglov Pavel](https://github.com/Avogar))
* 関数呼び出しにおける `LowCardinality` 列の想定外のサイズを修正。 [#65298](https://github.com/ClickHouse/ClickHouse/pull/65298) ([Raúl Marín](https://github.com/Algunenano)).
* maxIntersections で発生していたクラッシュを修正。 [#65689](https://github.com/ClickHouse/ClickHouse/pull/65689) ([Raúl Marín](https://github.com/Algunenano))。
* 再起動後にリセットされていたユーザー定義の `VALID UNTIL` 句を修正しました。 [#66409](https://github.com/ClickHouse/ClickHouse/pull/66409) ([Nikolay Degterinsky](https://github.com/evillique))。
* `SHOW MERGES` の残り時間列を修正しました。 [#66735](https://github.com/ClickHouse/ClickHouse/pull/66735) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* `Query was cancelled` が clickhouse-client に 2 回出力されてしまうことがありました。この動作は修正されました。 [#66005](https://github.com/ClickHouse/ClickHouse/pull/66005) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* MySQL の NULL フィールドを ClickHouse の NOT NULL フィールドにマッピングする TABLE OVERRIDE を指定して `MaterializedMySQL`（サポート対象外の実験的機能）を使用した際に発生していたクラッシュを修正しました。 [#54649](https://github.com/ClickHouse/ClickHouse/pull/54649) ([Filipp Ozinov](https://github.com/bakwc)).
* `PREWHERE` 式がどの列も読み込まず、テーブルが adaptive index granularity を使用していない（非常に古いテーブル）場合に発生する論理エラーを修正。 [#59173](https://github.com/ClickHouse/ClickHouse/pull/59173) ([Alexander Gololobov](https://github.com/davenger)).
* クエリのキャンセル時に使用されるキャンセルバッファに関するバグを修正。 [#64478](https://github.com/ClickHouse/ClickHouse/pull/64478) ([Sema Checherinda](https://github.com/CheSema)).
* columns.txt が存在しない場合に、メタデータから parts カラムを補完する処理を修正。 [#64757](https://github.com/ClickHouse/ClickHouse/pull/64757) ([Azat Khuzhin](https://github.com/azat)).
* `ALTER TABLE ... ON CLUSTER ... MODIFY SQL SECURITY` でクラッシュが発生する問題を修正しました。 [#64957](https://github.com/ClickHouse/ClickHouse/pull/64957) ([pufit](https://github.com/pufit)).
* AccessControl の破棄時に発生するクラッシュを修正: 明示的なシャットダウン処理を追加。 [#64993](https://github.com/ClickHouse/ClickHouse/pull/64993) ([Vitaly Baranov](https://github.com/vitlibar))。
* 関数 `uniq*` の引数にある単射関数を再帰的に除去するように修正しました。これは以前は正しく動作していましたが、新しいアナライザーでは動作しなくなっていました。[#65140](https://github.com/ClickHouse/ClickHouse/pull/65140)（[Duc Canh Le](https://github.com/canhld94)）。
* CTE を使用したクエリで予期しないプロジェクション名が付与される問題を修正。[#65267](https://github.com/ClickHouse/ClickHouse/pull/65267)（[wudidapaopao](https://github.com/wudidapaopao)）。
* `Dictionary` テーブルエンジンまたは直接クエリで辞書にアクセスする際に、`dictGet` 権限を必要とします。 [#65359](https://github.com/ClickHouse/ClickHouse/pull/65359) ([Joe Lynch](https://github.com/joelynch)).
* インクリメンタルバックアップでのユーザー固有の S3 認証の問題を修正。 [#65481](https://github.com/ClickHouse/ClickHouse/pull/65481) ([Antonio Andelic](https://github.com/antonio2368)).
* `read-in-order` 最適化が有効になっている場合、`FINAL` を含むクエリでは `non-intersecting-parts` 最適化を無効化するようにしました。そうしないと、誤ったクエリ結果が返される可能性がありました。回避策として、この修正がマージされるまでは `do_not_merge_across_partitions_select_final` と `split_parts_ranges_into_intersecting_and_non_intersecting_final` を無効にしてください。[#65505](https://github.com/ClickHouse/ClickHouse/pull/65505)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `Index out of bound for blob metadata` という例外が、list バッチ内のすべてのファイルがフィルタ処理により除外された場合に発生していた問題を修正しました。 [#65523](https://github.com/ClickHouse/ClickHouse/pull/65523) ([Kseniia Sumarokova](https://github.com/kssenii)).
* projection の重複排除マージにおける NOT&#95;FOUND&#95;COLUMN&#95;IN&#95;BLOCK エラーを修正。 [#65573](https://github.com/ClickHouse/ClickHouse/pull/65573) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* MergeJoin のバグを修正しました。疎シリアライゼーションのカラムが、必要な変換が実行されていないにもかかわらず、ネストされた型のカラムとして扱われてしまう可能性がありました。 [#65632](https://github.com/ClickHouse/ClickHouse/pull/65632) ([Nikita Taranov](https://github.com/nickitat)).
* 互換性レベル &#39;23.4&#39; が正しく適用されていなかったバグを修正しました。 [#65737](https://github.com/ClickHouse/ClickHouse/pull/65737) ([cw5121](https://github.com/cw5121)).
* NULL 値を許容するフィールドを含む ODBC テーブルを修正。 [#65738](https://github.com/ClickHouse/ClickHouse/pull/65738) ([Rodolphe Dugé de Bernonville](https://github.com/RodolpheDuge)).
* 致命的なエラー発生時に発生し得る `TCPHandler` のデータレースを修正しました。 [#65744](https://github.com/ClickHouse/ClickHouse/pull/65744) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `parseDateTime` 関数の `%F` および `%D` プレースホルダに関する不正な例外を修正。 [#65768](https://github.com/ClickHouse/ClickHouse/pull/65768) ([Antonio Andelic](https://github.com/antonio2368)).
* `PostgreSQL` から読み取るクエリの場合、`ClickHouse` クエリが終了したら内部の `PostgreSQL` クエリをキャンセルします。そうしないと、内部の `PostgreSQL` クエリが終了するまで `ClickHouse` クエリをキャンセルできません。 [#65771](https://github.com/ClickHouse/ClickHouse/pull/65771) ([Maksim Kita](https://github.com/kitaisreal)).
* 古いアナライザーと `dictGetOrDefault` を併用している場合の短絡評価ロジックのバグを修正。 [#65802](https://github.com/ClickHouse/ClickHouse/pull/65802) ([jsc0218](https://github.com/jsc0218))。
* `EmbeddedRocksDB` での TTL 書き込みにより SST ファイルが破損するバグを修正しました。 [#65816](https://github.com/ClickHouse/ClickHouse/pull/65816) ([Duc Canh Le](https://github.com/canhld94)).
* 関数 `bitTest`、`bitTestAll`、`bitTestAny` は、指定されたビットインデックスが範囲外の場合にエラーを返すようになりました [#65818](https://github.com/ClickHouse/ClickHouse/pull/65818) ([Pablo Marcos](https://github.com/pamarcos))。
* `join_any_take_last_row` の設定は、ハッシュ結合を使用するすべてのクエリでサポートされます。 [#65820](https://github.com/ClickHouse/ClickHouse/pull/65820) ([vdimir](https://github.com/vdimir))。
* `IS NULL` チェックを含む JOIN 条件の処理を改善しました（たとえば `ON (a = b AND (a IS NOT NULL) AND (b IS NOT NULL) ) OR ( (a IS NULL) AND (b IS NULL) )` は `ON a <=> b` に書き換えられます）。`IS NULL` 以外の条件も存在する場合に誤った最適化が行われていた問題を修正しました。 [#65835](https://github.com/ClickHouse/ClickHouse/pull/65835) ([vdimir](https://github.com/vdimir)).
* S3Queue で増え続けるメモリ使用量を修正。 [#65839](https://github.com/ClickHouse/ClickHouse/pull/65839) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `arrayAUC` の同点の扱いを修正し、sklearn と同じになるようにしました。 [#65840](https://github.com/ClickHouse/ClickHouse/pull/65840) ([gabrielmcg44](https://github.com/gabrielmcg44))。
* MySQL サーバープロトコルにおける TLS 接続の潜在的な問題を修正しました。 [#65917](https://github.com/ClickHouse/ClickHouse/pull/65917) ([Azat Khuzhin](https://github.com/azat)).
* MySQL クライアントプロトコルの TLS 接続で発生する可能性がある問題を修正しました。 [#65938](https://github.com/ClickHouse/ClickHouse/pull/65938) ([Azat Khuzhin](https://github.com/azat)).
* `SSL_ERROR_WANT_READ`/`SSL_ERROR_WANT_WRITE` をタイムアウトが 0 のときに正しく処理するよう修正。 [#65941](https://github.com/ClickHouse/ClickHouse/pull/65941) ([Azat Khuzhin](https://github.com/azat)).
* スキーマ推論キャッシュに、不足していた `input_format_csv_skip_first_lines` / `input_format_tsv_skip_first_lines` / `input_format_csv_try_infer_numbers_from_strings` / `input_format_csv_try_infer_strings_from_quoted_tuples` の各設定を追加しました。これらは結果のスキーマが変わり得るためです。これにより、これらの設定を変更した場合にスキーマ推論の結果が誤ることを防ぎます。 [#65980](https://github.com/ClickHouse/ClickHouse/pull/65980) ([Kruglov Pavel](https://github.com/Avogar)).
* Column &#95;size は S3 engine および S3 table function では、アーカイブ自体のサイズではなく、アーカイブ内のファイルサイズを表します。 [#65993](https://github.com/ClickHouse/ClickHouse/pull/65993) ([Daniil Ivanik](https://github.com/divanik)).
* analyzer における動的サブカラムの解決を修正し、動的サブカラムの読み取り時にカラム全体を読み込まないようにしました。 [#66004](https://github.com/ClickHouse/ClickHouse/pull/66004) ([Kruglov Pavel](https://github.com/Avogar)).
* from&#95;env に対する replace オーバーライド使用時の設定のマージ処理を修正。 [#66034](https://github.com/ClickHouse/ClickHouse/pull/66034) ([Azat Khuzhin](https://github.com/azat)).
* シャットダウン中に `GRPCServer` がハングする可能性がある問題を修正しました。 [#66061](https://github.com/ClickHouse/ClickHouse/pull/66061) ([Vitaly Baranov](https://github.com/vitlibar))。
* `LowCardinality` の非定数引数を取る関数 `has` におけるいくつかのケースを修正しました。 [#66088](https://github.com/ClickHouse/ClickHouse/pull/66088) ([Anton Popov](https://github.com/CurtizJ)).
* `groupArrayIntersect` の修正。`merge()` 関数内で誤った動作をしていました。数値データおよび汎用データに対する `deserialise()` の動作も修正しました。 [#66103](https://github.com/ClickHouse/ClickHouse/pull/66103) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* `unbin`/`unhex` の実装における固定バッファのバッファオーバーフロー不具合を修正しました。 [#66106](https://github.com/ClickHouse/ClickHouse/pull/66106) ([Nikita Taranov](https://github.com/nickitat)).
* [#64760](https://github.com/ClickHouse/ClickHouse/issues/64760) で導入された `merge-filters` 最適化を無効化しました。これは、最適化によって 2 つのフィルター式がマージされる際にショートサーキット評価が行われないと、例外が発生する可能性があるためです。[#66126](https://github.com/ClickHouse/ClickHouse/pull/66126)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* Avro 仕様で現在は許可されている負のブロックサイズの配列としてエンコードされた Avro ファイルを、サーバーがパースできなかった問題を修正しました。[#66130](https://github.com/ClickHouse/ClickHouse/pull/66130)（[Serge Klochkov](https://github.com/slvrtrn)）。
* ZooKeeper クライアントのバグを修正しました。ZooKeeper からハードウェアエラーを受信した後、セッションが使用不能な状態で停止してしまうことがありました。例えば、ClickHouse Keeper の &quot;soft memory limit&quot; が原因で発生する可能性があります。 [#66140](https://github.com/ClickHouse/ClickHouse/pull/66140) ([Alexander Tokmakov](https://github.com/tavplubix)).
* SumIfToCountIfVisitor と符号付き整数に関する不具合を修正。 [#66146](https://github.com/ClickHouse/ClickHouse/pull/66146) ([Raúl Marín](https://github.com/Algunenano)).
* 分散クエリの結果からデータが欠落する稀なケースを修正しました。 [#66174](https://github.com/ClickHouse/ClickHouse/pull/66174) ([vdimir](https://github.com/vdimir)).
* StorageDeltaLake でメタデータフィールドの解析順序を修正。 [#66211](https://github.com/ClickHouse/ClickHouse/pull/66211) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `distributed_ddl_output_mode` の `none_only_active` モードでは `TIMEOUT_EXCEEDED` をスローしないようにしました。 [#66218](https://github.com/ClickHouse/ClickHouse/pull/66218) ([Alexander Tokmakov](https://github.com/tavplubix)).
* インデックスを使用できない場合の `system.numbers_mt` に対する LIMIT 句の処理を修正。 [#66231](https://github.com/ClickHouse/ClickHouse/pull/66231) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Docker などのコンテナ内でサーバーを実行している場合に、cgroups v2 によって指定された使用可能な CPU コア数の上限を ClickHouse サーバーが正しく検出できるように修正しました。より詳しく言うと、コンテナはしばしば名前が空の root cgroup 内でプロセスを実行しますが、その場合、ClickHouse は cgroups v2 によって設定された CPU 制限を無視していました。[#66237](https://github.com/ClickHouse/ClickHouse/pull/66237) ([filimonov](https://github.com/filimonov))。
* 制約内で `IN` を使うサブクエリを使用した場合に発生する `Not-ready set` エラーを修正。 [#66261](https://github.com/ClickHouse/ClickHouse/pull/66261) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* S3 または Azure Blob Storage へのコピー時のエラー報告を修正。[#66295](https://github.com/ClickHouse/ClickHouse/pull/66295) ([Vitaly Baranov](https://github.com/vitlibar)).
* watchdog がアンリンク（ローテーション）されたログファイルのディスクリプタを保持しないようにしました。 [#66334](https://github.com/ClickHouse/ClickHouse/pull/66334) ([Aleksei Filatov](https://github.com/aalexfvk)).
* logicalexpressionoptimizerpass が定数の論理型情報を失ってしまう不具合を修正。 [#66344](https://github.com/ClickHouse/ClickHouse/pull/66344) ([pn](https://github.com/chloro-pn)).
* `group_by_use_nulls=true` および新しいアナライザーの使用時に発生する `Column identifier is already registered` エラーを修正。 [#66400](https://github.com/ClickHouse/ClickHouse/pull/66400) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 外部エンジン（PostgreSQL など）のテーブルを結合およびフィルタするクエリで、過度に積極的なフィルタプッシュダウンにより誤った結果が返る可能性がある問題を修正しました。今後は、外部テーブルとの外部結合の場合、`WHERE` 句の条件は外部データベースにプッシュダウンされません。 [#66402](https://github.com/ClickHouse/ClickHouse/pull/66402) ([vdimir](https://github.com/vdimir))。
* クロス結合に不足していたカラムのマテリアライゼーションを追加しました。 [#66413](https://github.com/ClickHouse/ClickHouse/pull/66413) ([lgbo](https://github.com/lgbo-ustc)).
* 新しいアナライザーが有効な状態で `GROUP BY` キーに定数式を含むクエリを実行した際に発生する `Cannot find column` エラーを修正。 [#66433](https://github.com/ClickHouse/ClickHouse/pull/66433) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Npy 形式からのインポートする際に、配列のネストレベルが不正な場合に発生しうる論理エラーを回避し、その他の種類のエラーに対するテストを修正。 [#66461](https://github.com/ClickHouse/ClickHouse/pull/66461) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* 述語に非決定的関数が含まれている場合に count() の結果が誤ったものになる不具合を修正。 [#66510](https://github.com/ClickHouse/ClickHouse/pull/66510) ([Duc Canh Le](https://github.com/canhld94)).
* `Allocator::realloc` におけるメモリ使用量の追跡を正しく行うようにしました。 [#66548](https://github.com/ClickHouse/ClickHouse/pull/66548) ([Antonio Andelic](https://github.com/antonio2368)).
* 空のタプルをハッシュ化する際に未初期化メモリを読み取ってしまう不具合を修正。 [#66562](https://github.com/ClickHouse/ClickHouse/pull/66562) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* `WINDOW` を含むクエリで不正な結果が返される問題を修正しました。これは、`PARTITION` 列が疎なシリアライゼーション形式であり、かつウィンドウ関数が並列実行される場合に発生する可能性がありました。 [#66579](https://github.com/ClickHouse/ClickHouse/pull/66579) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* ローカルストレージにおける名前付きコレクションの削除処理を修正。 [#66599](https://github.com/ClickHouse/ClickHouse/pull/66599) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* `ColumnTuple::insertManyFrom` で `column_length` が更新されない問題を修正します。 [#66626](https://github.com/ClickHouse/ClickHouse/pull/66626) ([lgbo](https://github.com/lgbo-ustc))。
* `(column IS NULL)` という式を含むクエリで発生する `Unknown identifier` および `Column is not under aggregate function` エラーを修正しました。このバグは analyzer を無効化した場合にのみ発生し、[#65088](https://github.com/ClickHouse/ClickHouse/issues/65088) で報告されました。[#66654](https://github.com/ClickHouse/ClickHouse/pull/66654)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 新しいアナライザーを使用している場合に、スカラーサブクエリが `IN` の第1引数として使用されていると発生していた `Method getResultType is not supported for QUERY query node` エラーを修正しました。 [#66655](https://github.com/ClickHouse/ClickHouse/pull/66655) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* variant サブカラムの読み取り中に発生する可能性のある PARAMETER&#95;OUT&#95;OF&#95;BOUND エラーを修正。 [#66659](https://github.com/ClickHouse/ClickHouse/pull/66659) ([Kruglov Pavel](https://github.com/Avogar))。
* カラム削除後にまれに発生するマージ処理がハングする問題を修正しました。 [#66707](https://github.com/ClickHouse/ClickHouse/pull/66707) ([Raúl Marín](https://github.com/Algunenano)).
* リモートソースからの `INSERT SELECT` 時のアサーション `isUniqTypes` を修正しました。 [#66722](https://github.com/ClickHouse/ClickHouse/pull/66722) ([Sema Checherinda](https://github.com/CheSema))。
* PrometheusRequestHandler の論理エラーを修正。 [#66621](https://github.com/ClickHouse/ClickHouse/pull/66621) ([Vitaly Baranov](https://github.com/vitlibar))。
* fuzzer によって検出された `indexHint` 関数名の大文字小文字の問題を修正。[#66286](https://github.com/ClickHouse/ClickHouse/pull/66286) ([Anton Popov](https://github.com/CurtizJ))。
* &#39;create table b empty as a&#39; の AST のフォーマットを修正。 [#64951](https://github.com/ClickHouse/ClickHouse/pull/64951) ([Michael Kolupaev](https://github.com/al13n321)).



### <a id="246"></a> ClickHouse リリース 24.6, 2024-07-01 {#a-id246a-clickhouse-release-246-2024-07-01}

#### 後方互換性のない変更 {#backward-incompatible-change-6}
* データベースとテーブルの非同期ロードをデフォルトで有効化しました。`async_load_databases` については config.xml を参照してください。この変更は完全に互換性がありますが、動作の違いを生む可能性があります。`async_load_databases` が以前のバージョンと同様に false の場合、すべてのテーブルがロード完了するまでサーバーは接続を受け付けません。新しいバージョンのように `async_load_databases` が true の場合、すべてのテーブルがロードされる前にサーバーが接続を受け付けることができます。まだロードされていないテーブルに対してクエリが実行された場合、そのテーブルのロード完了まで待機しなければならず、これにはかなりの時間がかかることがあります。ロードバランサー配下の大規模な分散システムの一部である場合、この挙動の違いがサーバーの動作に影響する可能性があります。前者のケースでは、ロードバランサーは接続拒否を受け取り、すばやく別のサーバーへフェイルオーバーできます。後者のケースでは、ロードバランサーはまだテーブルをロード中のサーバーに接続してしまい、そのクエリのレイテンシーが高くなります。さらに、多数のクエリが待機状態に蓄積すると、それらが一斉に処理を開始する「thundering herd」問題を引き起こす可能性があります。これは高負荷な分散バックエンドでのみ違いを生む可能性があります。この問題を回避するには `async_load_databases` の値を false に設定してください。[#57695](https://github.com/ClickHouse/ClickHouse/pull/57695)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* `MergeTree` テーブルに対して、`replace_long_file_name_to_hash` 設定がデフォルトで有効化されました。[#64457](https://github.com/ClickHouse/ClickHouse/pull/64457)（[Anton Popov](https://github.com/CurtizJ)）。この設定は完全に互換性があり、アップグレード時に特別な対応は不要です。この新しいデータ形式は 23.9 以降のすべてのバージョンでサポートされています。この設定を有効化すると、バージョン 23.8 以前へのダウングレードはできなくなります。
* 一部の不正なクエリは、パースの段階でもっと早く失敗するようになりました。注意: 文字列リテラルなしで `kql` テーブル関数に渡されたインライン KQL 式（実験的な Kusto 言語）のサポートを無効化しました。例: `kql('garbage | trash')` や `kql($$garbage | trash$$)` ではなく `kql(garbage | trash)` のような呼び出しです。この機能は意図せず導入されたものであり、存在すべきではありません。[#61500](https://github.com/ClickHouse/ClickHouse/pull/61500)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* ストレージ `S3Queue` の `Ordered` モードにおける並列処理を再設計しました。この PR は、`s3queue_processing_threads_num` または `s3queue_total_shards_num` 設定を使用していた場合、Ordered モードとの後方互換性がありません。`s3queue_total_shards_num` 設定は削除されました。以前は `s3queue_allow_experimental_sharded_mode` のもとでのみ使用することが許可されていましたが、これは現在非推奨です。新しい設定 `s3queue_buckets` が追加されました。[#64349](https://github.com/ClickHouse/ClickHouse/pull/64349)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 新しい関数 `snowflakeIDToDateTime`, `snowflakeIDToDateTime64`, `dateTimeToSnowflakeID`, `dateTime64ToSnowflakeID` が追加されました。既存の `snowflakeToDateTime`, `snowflakeToDateTime64`, `dateTimeToSnowflake`, `dateTime64ToSnowflake` 関数と異なり、新しい関数は `generateSnowflakeID` 関数と互換性があります。つまり、`generateSnowflakeID` によって生成された snowflake ID を受け取り、`generateSnowflakeID` と同じ型（`UInt64`）の snowflake ID を生成します。さらに、新しい関数は `generateSnowflakeID` と同様に UNIX エポック（いわゆる 1970-01-01）をデフォルトとします。必要に応じて、異なるエポック、たとえば Twitter/X のエポックである 2010-11-04（UNIX エポックからの経過ミリ秒として 1288834974657）を渡すことができます。古い変換関数は非推奨であり、移行期間後に削除される予定です。これらをそれでも使用したい場合は、設定 `allow_deprecated_snowflake_conversion_functions` を有効にしてください。[#64948](https://github.com/ClickHouse/ClickHouse/pull/64948)（[Robert Schulze](https://github.com/rschu1ze)）。



#### 新機能 {#new-feature-6}

* ClickHouse Keeper に名前付きコレクションを格納できるようにしました。 [#64574](https://github.com/ClickHouse/ClickHouse/pull/64574) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 空のタプルのサポートを追加。 [#55061](https://github.com/ClickHouse/ClickHouse/pull/55061) ([Amos Bird](https://github.com/amosbird)).
* Hilbert 曲線のエンコードおよびデコード関数を追加。 [#60156](https://github.com/ClickHouse/ClickHouse/pull/60156) ([Artem Mustafin](https://github.com/Artemmm91)).
* `hilbertEncode` を用いたインデックス分析のサポートを追加しました。 [#64662](https://github.com/ClickHouse/ClickHouse/pull/64662) ([Artem Mustafin](https://github.com/Artemmm91)).
* 関数 `readWKTLineString` を使用して、WKT 形式の `LINESTRING` ジオメトリを読み取る機能を追加しました。 [#62519](https://github.com/ClickHouse/ClickHouse/pull/62519) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 別のディスク上のパーツをアタッチできるようにしました。 [#63087](https://github.com/ClickHouse/ClickHouse/pull/63087) ([Unalian](https://github.com/Unalian)).
* Twitter 形式の Snowflake ID を生成するための新しい SQL 関数 `generateSnowflakeID` を追加しました。 [#63577](https://github.com/ClickHouse/ClickHouse/pull/63577) ([Danila Puzov](https://github.com/kazalika))。
* マージやミューテーションおよびその他のワークロード間でのリソースの使用方法と共有方法を制御するための `merge_workload` と `mutation_workload` 設定を追加しました。 [#64061](https://github.com/ClickHouse/ClickHouse/pull/64061) ([Sergei Trifonov](https://github.com/serxa)).
* `=` 演算子を使用して `IPv4` 型と `IPv6` 型を比較できるようにしました。 [#64292](https://github.com/ClickHouse/ClickHouse/pull/64292) ([Francisco J. Jurado Moreno](https://github.com/Beetelbrox))。
* 2項演算の数学関数（`pow`、`atan2`、`max2`、`min2`、`hypot`）で `Decimal` 型の引数をサポートしました。 [#64582](https://github.com/ClickHouse/ClickHouse/pull/64582) ([Mikhail Gorshkov](https://github.com/mgorshkov)).
* SQL 関数 `parseReadableSize`（および `OrNull` と `OrZero` の各バリアント）を追加しました。 [#64742](https://github.com/ClickHouse/ClickHouse/pull/64742) ([Francisco J. Jurado Moreno](https://github.com/Beetelbrox))。
* サーバー設定 `max_table_num_to_throw` と `max_database_num_to_throw` を追加し、`CREATE` クエリで作成されるデータベースおよびテーブルの数を制限します。 [#64781](https://github.com/ClickHouse/ClickHouse/pull/64781) ([Xu Jia](https://github.com/XuJia0210))。
* `s3` / `file` / `hdfs` / `url` / `azureBlobStorage` などのファイル系ストレージに `_time` 仮想カラムを追加。 [#64947](https://github.com/ClickHouse/ClickHouse/pull/64947) ([Ilya Golshtein](https://github.com/ilejn))。
* 新しい関数 `base64URLEncode`、`base64URLDecode`、`tryBase64URLDecode` を追加しました。 [#64991](https://github.com/ClickHouse/ClickHouse/pull/64991) ([Mikhail Gorshkov](https://github.com/mgorshkov)).
* 新しい関数 `editDistanceUTF8` を追加しました。この関数は 2 つの UTF-8 文字列間の[編集距離](https://en.wikipedia.org/wiki/Edit_distance)を計算します。[#65269](https://github.com/ClickHouse/ClickHouse/pull/65269)（[LiuNeng](https://github.com/liuneng1994)）。
* カスタム HTTP ハンドラーで独自のレスポンスヘッダーをサポートできるように、`http_response_headers` 設定を追加しました。 [#63562](https://github.com/ClickHouse/ClickHouse/pull/63562) ([Grigorii](https://github.com/GSokol)).
* クエリ結果を無限ループで返すための新しいテーブル関数 `loop` を追加しました。 [#63452](https://github.com/ClickHouse/ClickHouse/pull/63452) ([Sariel](https://github.com/sarielwxm))。テスト用途に有用です。
* `system.query_log` に `used_privileges` と `missing_privileges` という 2 つの新しいカラムを追加しました。`used_privileges` にはクエリ実行中にチェックされた権限が格納され、`missing_privileges` には必要だが不足している権限が含まれます。 [#64597](https://github.com/ClickHouse/ClickHouse/pull/64597) ([Alexey Katsman](https://github.com/alexkats)).
* `output_format_pretty_display_footer_column_names` という設定が追加されました。有効化すると、行数の多いテーブル（デフォルトでは 50 行）ではテーブル末尾にカラム名を表示します。最小行数のしきい値は `output_format_pretty_display_footer_column_names_min_rows` によって制御されます。 [#65144](https://github.com/ClickHouse/ClickHouse/pull/65144) ([Shaun Struwig](https://github.com/Blargian)).



#### 実験的機能 {#experimental-feature-5}
* 「異なる値の個数」型の統計情報を導入しました。[#59357](https://github.com/ClickHouse/ClickHouse/pull/59357) ([Han Fei](https://github.com/hanfei1991)).
* ReplicatedMergeTree 向けの統計情報をサポートしました。[#64934](https://github.com/ClickHouse/ClickHouse/pull/64934) ([Han Fei](https://github.com/hanfei1991)).
* `Replicated` データベースに「replica group」が設定されている場合、すべてのグループのレプリカを含むクラスタを自動的に作成するようにしました。[#64312](https://github.com/ClickHouse/ClickHouse/pull/64312) ([Alexander Tokmakov](https://github.com/tavplubix)).
* 範囲フィルタを使用する際に、動的シャード構成での parallel replicas によるクエリの並列化方法を制御できるよう、`parallel_replicas_custom_key_range_lower` と `parallel_replicas_custom_key_range_upper` 設定を追加しました。[#64604](https://github.com/ClickHouse/ClickHouse/pull/64604) ([josh-hildred](https://github.com/josh-hildred)).



#### パフォーマンスの向上 {#performance-improvement-6}

* `PRIMARY KEY` で定義された順序を維持しつつ、サイズを最適化するために挿入時に行を並べ替えられる機能を追加しました。これは設定 `optimize_row_order` によって制御されます（デフォルトではオフ）。[#63578](https://github.com/ClickHouse/ClickHouse/pull/63578)（[Igor Markelov](https://github.com/ElderlyPassionFruit)）。
* ネイティブな Parquet リーダーを追加し、Parquet バイナリを直接 ClickHouse のカラムに読み込めるようにしました。これは設定 `input_format_parquet_use_native_reader` によって制御されます（デフォルトは無効）。[#60361](https://github.com/ClickHouse/ClickHouse/pull/60361)（[ZhiHong Zhang](https://github.com/copperybean)）。
* クエリフィルターが MergeTree テーブルから正確な範囲を選択できる場合に、trivial count の部分的な最適化をサポートします。 [#60463](https://github.com/ClickHouse/ClickHouse/pull/60463) ([Amos Bird](https://github.com/amosbird))。
* 複数スレッドの `INSERT` における最大メモリ使用量を、複数スレッドのチャンクを単一の transform でまとめて収集することで削減しました。 [#61047](https://github.com/ClickHouse/ClickHouse/pull/61047) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
* 固定メモリ割り当てを使用して余分なバッファの割り当てを回避することで、Azure オブジェクトストレージ使用時のメモリ使用量を削減します。 [#63160](https://github.com/ClickHouse/ClickHouse/pull/63160) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* `ColumnNullable::size` における仮想関数呼び出しの回数を削減。 [#60556](https://github.com/ClickHouse/ClickHouse/pull/60556) ([HappenLee](https://github.com/HappenLee)).
* 正規表現引数が1文字のみの場合に `splitByRegexp` を高速化しました。 [#62696](https://github.com/ClickHouse/ClickHouse/pull/62696) ([Robert Schulze](https://github.com/rschu1ze)).
* 使用されたキーの最小値と最大値を追跡することで、8ビットおよび16ビットのキーによる集計を高速化します。これにより、確認が必要なセルの数を減らすことができます。 [#62746](https://github.com/ClickHouse/ClickHouse/pull/62746) ([Jiebin Sun](https://github.com/jiebinn)).
* 左辺が `LowCardinality` で右辺が定数の集合である場合の `IN` 演算子の処理を最適化しました。 [#64060](https://github.com/ClickHouse/ClickHouse/pull/64060) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
* `ConcurrentHashJoin` 内部のハッシュテーブルの初期化と破棄にスレッドプールを使用します。 [#64241](https://github.com/ClickHouse/ClickHouse/pull/64241) ([Nikita Taranov](https://github.com/nickitat))。
* スパースカラムを含むテーブルにおける縦方向マージを最適化しました。 [#64311](https://github.com/ClickHouse/ClickHouse/pull/64311) ([Anton Popov](https://github.com/CurtizJ)).
* 垂直マージ時にリモートファイルシステムからデータをプリフェッチできるようにしました。これにより、データをリモートファイルシステムに保存しているテーブルでの垂直マージのレイテンシが改善されます。 [#64314](https://github.com/ClickHouse/ClickHouse/pull/64314) ([Anton Popov](https://github.com/CurtizJ)).
* `ColumnSparse::filter` の `isDefault` への冗長な呼び出しを削減して、パフォーマンスを改善しました。 [#64426](https://github.com/ClickHouse/ClickHouse/pull/64426) ([Jiebin Sun](https://github.com/jiebinn))。
* 複数の非同期 `getChildren` リクエストを行うことで、keeper-client コマンド `find_super_nodes` および `find_big_family` を高速化しました。 [#64628](https://github.com/ClickHouse/ClickHouse/pull/64628) ([Alexander Gololobov](https://github.com/davenger)).
* NULL を許容する数値型引数に対する関数 `least` / `greatest` を改善しました。 [#64668](https://github.com/ClickHouse/ClickHouse/pull/64668) ([KevinyhZou](https://github.com/KevinyhZou)).
* クエリプラン内の連続する 2 つのフィルタリングステップをマージできるようにしました。これにより、親ステップからフィルター条件をプッシュダウンできる場合、フィルタープッシュダウンの最適化が向上します。 [#64760](https://github.com/ClickHouse/ClickHouse/pull/64760) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* vertical final 実装における不適切な最適化を削除し、vertical final アルゴリズムをデフォルトで再度有効にしました。 [#64783](https://github.com/ClickHouse/ClickHouse/pull/64783) ([Duc Canh Le](https://github.com/canhld94)).
* フィルタ式から ALIAS ノードを削除します。これにより、新しいアナライザー使用時に `PREWHERE` 句を含むクエリのパフォーマンスがわずかに向上します。 [#64793](https://github.com/ClickHouse/ClickHouse/pull/64793) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* OpenSSL のセッションキャッシュを再度有効にしました。 [#65111](https://github.com/ClickHouse/ClickHouse/pull/65111) ([Robert Schulze](https://github.com/rschu1ze)).
* 挿入時にスキップインデックスおよび統計量をマテリアライズしないようにする設定（`materialize_skip_indexes_on_insert` と `materialize_statistics_on_insert`）を追加しました。 [#64391](https://github.com/ClickHouse/ClickHouse/pull/64391) ([Anton Popov](https://github.com/CurtizJ))。
* 割り当てられたメモリサイズを用いて row group サイズを計算し、単一スレッドモードにおける Parquet writer のピークメモリを削減するようにしました。 [#64424](https://github.com/ClickHouse/ClickHouse/pull/64424) ([LiuNeng](https://github.com/liuneng1994))。
* 疎なカラムのイテレータを改善し、`size` の呼び出し回数を削減しました。 [#64497](https://github.com/ClickHouse/ClickHouse/pull/64497) ([Jiebin Sun](https://github.com/jiebinn)).
* Azure Blob Storage へのバックアップ時に server-side copy を使用する条件を更新。 [#64518](https://github.com/ClickHouse/ClickHouse/pull/64518) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* 多数の skip index を持つテーブルの縦方向マージにおけるメモリ使用量を最適化しました。 [#64580](https://github.com/ClickHouse/ClickHouse/pull/64580) ([Anton Popov](https://github.com/CurtizJ)).





#### 改善 {#improvement-6}

* システムテーブルに対して `SHOW CREATE TABLE` を実行すると、そのテーブルが何のために必要なのかを説明する、テーブルごとに固有の便利なコメントが表示されるようになりました。 [#63788](https://github.com/ClickHouse/ClickHouse/pull/63788) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 関数 `round()`, `roundBankers()`, `floor()`, `ceil()` および `trunc()` の第2引数（scale）は、定数である必要がなくなり、非 const の値を指定できるようになりました。 [#64798](https://github.com/ClickHouse/ClickHouse/pull/64798) ([Mikhail Gorshkov](https://github.com/mgorshkov))。
* 新しいディスクを追加した際に、`Distributed` テーブルのストレージポリシーをホットリロードできるようにしました。[#58285](https://github.com/ClickHouse/ClickHouse/pull/58285) ([Duc Canh Le](https://github.com/canhld94)).
* 高負荷状態のサービスでスレッドをスケジューリングする際に、MergeTree インデックス解析中に発生する可能性のあるデッドロックを回避しました。 [#59427](https://github.com/ClickHouse/ClickHouse/pull/59427) ([Sean Haynes](https://github.com/seandhaynes)).
* S3 プロキシのサポートおよびトンネリングに関する軽微なコーナーケースの修正をいくつか行いました。 [#63427](https://github.com/ClickHouse/ClickHouse/pull/63427) ([Arthur Passos](https://github.com/arthurpassos)).
* io&#95;uring の再送に関する可視性を向上させました。プロファイルイベント名を `IOUringSQEsResubmits` から `IOUringSQEsResubmitsAsync` に変更し、新しいイベント `IOUringSQEsResubmitsSync` を追加しました。[#63699](https://github.com/ClickHouse/ClickHouse/pull/63699)（[Tomer Shafir](https://github.com/tomershafir)）。
* メタデータストレージ用ディスク上の空き領域を確保しておくための新しい設定 `metadata_keep_free_space_bytes` を追加しました。 [#64128](https://github.com/ClickHouse/ClickHouse/pull/64128) ([MikhailBurdukov](https://github.com/MikhailBurdukov))。
* `plain_rewritable` メタデータストレージによって作成および削除されたディレクトリ数と、ローカルとリモートを対応付けるインメモリマップ内のエントリ数を追跡するためのメトリクスを追加しました。 [#64175](https://github.com/ClickHouse/ClickHouse/pull/64175) ([Julia Kartseva](https://github.com/jkartseva)).
* クエリキャッシュは、クエリ本体が同じでも設定が異なる場合は別のクエリとして扱うようになりました。これにより、`limit` や `additional_table_filters` などの異なる設定がクエリ結果に影響するケースでの堅牢性が向上します。 [#64205](https://github.com/ClickHouse/ClickHouse/pull/64205) ([Robert Schulze](https://github.com/rschu1ze)).
* オブジェクトストレージで非標準のエラーコード `QpsLimitExceeded` をリトライ可能なエラーとして扱えるようにしました。 [#64225](https://github.com/ClickHouse/ClickHouse/pull/64225) ([Sema Checherinda](https://github.com/CheSema)).
* このテーブル用の ZooKeeper パスが既に存在する場合、MergeTree テーブルをレプリケーテッドテーブルに変換できないようにしました。 [#64244](https://github.com/ClickHouse/ClickHouse/pull/64244) ([Kirill](https://github.com/kirillgarbar)).
* 平均出力ブロックのバイト数を制御するための新しい設定 `input_format_parquet_prefer_block_bytes` を追加し、`input_format_parquet_max_block_size` のデフォルト値を 65409 に変更しました。 [#64427](https://github.com/ClickHouse/ClickHouse/pull/64427) ([LiuNeng](https://github.com/liuneng1994)).
* `no_proxy` 環境変数および ClickHouse のプロキシ設定で指定されたホストを、プロキシ経由から除外できるようにしました。 [#63314](https://github.com/ClickHouse/ClickHouse/pull/63314) ([Arthur Passos](https://github.com/arthurpassos))。
* Keeper を常に、グローバルスレッドプールに十分な数のスレッドを確保した状態で起動するようにしました。 [#64444](https://github.com/ClickHouse/ClickHouse/pull/64444) ([Duc Canh Le](https://github.com/canhld94)).
* ユーザー設定のパラメータは、オブジェクトストレージ上の `MergeTree` に対するマージおよびミューテーションには影響しません。[#64456](https://github.com/ClickHouse/ClickHouse/pull/64456) ([alesapin](https://github.com/alesapin))。
* オブジェクトストレージで、非標準のエラーコード `TotalQpsLimitExceeded` を再試行可能なエラーとしてサポートしました。 [#64520](https://github.com/ClickHouse/ClickHouse/pull/64520) ([Sema Checherinda](https://github.com/CheSema)).
* オープンソース版と ClickHouse Cloud 版の両方の Advanced Dashboard を更新し、「Maximum concurrent network connections」のチャートを含めました。 [#64610](https://github.com/ClickHouse/ClickHouse/pull/64610) ([Thom O&#39;Connor](https://github.com/thomoco))。
* `zeros_mt` と `generateRandom` の進捗表示を改善。 [#64804](https://github.com/ClickHouse/ClickHouse/pull/64804) ([Raúl Marín](https://github.com/Algunenano)).
* 非同期メトリクス `jemalloc.profile.active` を追加し、サンプリングが現在有効かどうかを確認できるようにしました。これは prof.active に加わる有効化のための仕組みであり、呼び出しスレッドがサンプリングを行うには両方が有効である必要があります。 [#64842](https://github.com/ClickHouse/ClickHouse/pull/64842) ([Unalian](https://github.com/Unalian)).
* `allow_experimental_join_condition` の重要フラグを削除しました。このフラグが原因で、異なるバージョンが混在するクラスターにおいて分散クエリが正常に実行されない場合がありました。 [#65008](https://github.com/ClickHouse/ClickHouse/pull/65008) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* サーバーの非同期メトリクスとして `DiskGetObjectThrottler*` および `DiskGetObjectThrottler*` を追加しました。これらは、ディスク設定 `s3_max_get_rps` および `s3_max_put_rps` で定義された 1 秒あたりのリクエスト数のレート制限と、ディスクのスロットリング制限に達することなく送信可能な現在利用可能なリクエスト数を反映します。メトリクスは、制限が設定されている各ディスクごとに定義されます。[#65050](https://github.com/ClickHouse/ClickHouse/pull/65050)（[Sergei Trifonov](https://github.com/serxa)）。
* `Poco::ThreadPool` 用のグローバルトレースコレクターを初期化（Keeper などで必要）。[#65239](https://github.com/ClickHouse/ClickHouse/pull/65239) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `bcrypt_hash` でユーザーを作成する際にバリデーションを追加しました。[#65242](https://github.com/ClickHouse/ClickHouse/pull/65242)（[Raúl Marín](https://github.com/Algunenano)）。
* `PREWHERE` の実行中および実行後に読み取られた行数を示すプロファイルイベントを追加。 [#64198](https://github.com/ClickHouse/ClickHouse/pull/64198) ([Nikita Taranov](https://github.com/nickitat)).
* 並列レプリカ利用時に `EXPLAIN PLAN` にクエリを表示。 [#64298](https://github.com/ClickHouse/ClickHouse/pull/64298) ([vdimir](https://github.com/vdimir)).
* `allow_deprecated_functions` を `allow_deprecated_error_prone_window_functions` に名称変更しました。 [#64358](https://github.com/ClickHouse/ClickHouse/pull/64358) ([Raúl Marín](https://github.com/Algunenano)).
* `file` テーブル関数においても、ファイルディスクリプタに対して `max_read_buffer_size` 設定が適用されるようにしました。 [#64532](https://github.com/ClickHouse/ClickHouse/pull/64532) ([Azat Khuzhin](https://github.com/azat)).
* サポートされていないストレージに対しては、マテリアライズドビューであってもトランザクションを無効化しました。 [#64918](https://github.com/ClickHouse/ClickHouse/pull/64918) ([alesapin](https://github.com/alesapin)).
* 旧アナライザにおける `QUALIFY` 句の使用を禁止しました。旧アナライザは `QUALIFY` を無視していたため、ミューテーションで意図しないデータ削除が発生しうる問題がありました。 [#65356](https://github.com/ClickHouse/ClickHouse/pull/65356) ([Dmitry Novik](https://github.com/novikd))。





#### バグ修正（公式安定版リリースにおけるユーザー可視の不具合） {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-5}

* Apache ORC ライブラリのバグが修正されました: すべてのプラットフォームにおける符号なし型および ARM 上の Int8 について、書き込み時の ORC 統計量の計算が正しく行われるようになりました。 [#64563](https://github.com/ClickHouse/ClickHouse/pull/64563) ([Michael Kolupaev](https://github.com/al13n321))。
* ClickHouse における CSV 形式の Tuple の処理および解釈の動作を、元の挙動に戻しました。この変更により、実質的に [https://github.com/ClickHouse/ClickHouse/pull/60994](https://github.com/ClickHouse/ClickHouse/pull/60994) はリバートされ、その挙動は `output_format_csv_serialize_tuple_into_separate_columns`、`input_format_csv_deserialize_separate_columns_into_tuple`、`input_format_csv_try_infer_strings_from_quoted_tuples` といった一部の設定でのみ有効になります。[#65170](https://github.com/ClickHouse/ClickHouse/pull/65170)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 特定の状況において、ユーザーが必要な権限付与なしにデフォルトデータベースに対する自分の権限を昇格できてしまう権限エラーを修正しました。 [#64769](https://github.com/ClickHouse/ClickHouse/pull/64769) ([pufit](https://github.com/pufit))。
* UniqInjectiveFunctionsEliminationPass と uniqCombined が原因のクラッシュが発生する問題を修正。 [#65188](https://github.com/ClickHouse/ClickHouse/pull/65188) ([Raúl Marín](https://github.com/Algunenano)).
* セッション終了時にダイジェスト不一致を引き起こしていた ClickHouse Keeper のバグを修正しました。 [#65198](https://github.com/ClickHouse/ClickHouse/pull/65198) ([Aleksei Filatov](https://github.com/aalexfvk))。
* Distinct コンビネータに対して正しいメモリアラインメントを使用するよう修正しました。以前は、このコンビネータを使用した際に、不正なメモリ割り当てが原因でクラッシュが発生する可能性がありました。 [#65379](https://github.com/ClickHouse/ClickHouse/pull/65379) ([Antonio Andelic](https://github.com/antonio2368))。
* `DISTINCT` とウィンドウ関数でクラッシュが発生する問題を修正。 [#64767](https://github.com/ClickHouse/ClickHouse/pull/64767) ([Igor Nikonov](https://github.com/devcrafter)).
* IN 句および indexHint() 使用時に &#39;set&#39; スキップインデックスが動作しない問題を修正しました。 [#62083](https://github.com/ClickHouse/ClickHouse/pull/62083)（[Michael Kolupaev](https://github.com/al13n321)）。
* パラメータ化ビューの値を代入する際に関数を実行できるようにしました。 [#63502](https://github.com/ClickHouse/ClickHouse/pull/63502) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Parquet のメモリトラッキングを修正しました。 [#63584](https://github.com/ClickHouse/ClickHouse/pull/63584) ([Michael Kolupaev](https://github.com/al13n321))。
* `Tuple(Map(LowCardinality(String), String), ...)` 型の列読み取りの不具合を修正しました。 [#63956](https://github.com/ClickHouse/ClickHouse/pull/63956) ([Anton Popov](https://github.com/CurtizJ))。
* 異なる型（expression と function）からなる循環エイリアスに対して発生する `Cyclic aliases` エラーを修正しました。 [#63993](https://github.com/ClickHouse/ClickHouse/pull/63993) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* この修正により、クエリパイプライン内の各ビューごとに、正しい definer を持つ適切に再定義されたコンテキストが使用されます。 [#64079](https://github.com/ClickHouse/ClickHouse/pull/64079) ([pufit](https://github.com/pufit))。
* Fix analyzer: INTERPOLATE 使用時に発生していた &quot;Not found column&quot; エラーを修正しました。 [#64096](https://github.com/ClickHouse/ClickHouse/pull/64096) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* ファイルが存在するディスクとは異なる認証情報を使用する S3 バケットへのバックアップ作成の問題を修正しました。 [#64153](https://github.com/ClickHouse/ClickHouse/pull/64153) ([Antonio Andelic](https://github.com/antonio2368)).
* クエリキャッシュは、異なるデータベースに対する同一の2つのクエリを、別のものとして扱うようになりました。以前の動作では、テーブルの読み取り権限が不足している場合でも、その制限を回避するために悪用されるおそれがありました。 [#64199](https://github.com/ClickHouse/ClickHouse/pull/64199) ([Robert Schulze](https://github.com/rschu1ze)).
* StatusFile 内の ~WriteBufferFromFileDescriptor で、捕捉されない例外によりプロセスがアボートする可能性のある問題を修正。 [#64206](https://github.com/ClickHouse/ClickHouse/pull/64206) ([Kruglov Pavel](https://github.com/Avogar))。
* `ARRAY JOIN` を使用する分散クエリで発生していた `duplicate alias` エラーを修正しました。 [#64226](https://github.com/ClickHouse/ClickHouse/pull/64226) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 文字列から整数への意図しない accurateCast を修正。 [#64255](https://github.com/ClickHouse/ClickHouse/pull/64255) ([wudidapaopao](https://github.com/wudidapaopao)).
* OR グループに相互排他的な原子条件が含まれている場合の CNF の単純化を修正しました。 [#64256](https://github.com/ClickHouse/ClickHouse/pull/64256) ([Eduard Karacharov](https://github.com/korowa)).
* Query Tree のサイズ検証を修正しました。 [#64377](https://github.com/ClickHouse/ClickHouse/pull/64377) ([Dmitry Novik](https://github.com/novikd)).
* `PREWHERE` を使用した `Buffer` テーブルで発生する `Logical error: Bad cast` を修正しました。 [#64388](https://github.com/ClickHouse/ClickHouse/pull/64388) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `blob_storage_log` をオブジェクトストレージ上に格納している場合に、再帰的なログ出力が発生しないようにしました。 [#64393](https://github.com/ClickHouse/ClickHouse/pull/64393) ([vdimir](https://github.com/vdimir)).
* デフォルト式を含むテーブルに対する `CREATE TABLE AS` クエリを修正しました。 [#64455](https://github.com/ClickHouse/ClickHouse/pull/64455) ([Anton Popov](https://github.com/CurtizJ)).
* Nullable キーを持つテーブルに対する ORDER BY ... NULLS FIRST / LAST 句使用時の `optimize_read_in_order` の挙動を修正しました。 [#64483](https://github.com/ClickHouse/ClickHouse/pull/64483) ([Eduard Karacharov](https://github.com/korowa)).
* `GLOBAL IN` へのエイリアスを使用するクエリで発生する `Expression nodes list expected 1 projection names` および `Unknown expression or identifier` エラーを修正。 [#64517](https://github.com/ClickHouse/ClickHouse/pull/64517) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `GROUP BY` キーに定数CTEを含む分散クエリで発生していた `Cannot find column` エラーを修正しました。 [#64519](https://github.com/ClickHouse/ClickHouse/pull/64519) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* バックアップからの復元が、まだ復元されていない definer を持つ MV の作成によってブロックされ、その結果発生するクラッシュループを修正。 [#64595](https://github.com/ClickHouse/ClickHouse/pull/64595) ([pufit](https://github.com/pufit)).
* フォーマッターが生成する文字列の長さが奇数で、かつ最後の文字が `0` の場合における関数 `formatDateTimeInJodaSyntax` の出力を修正しました。たとえば、`SELECT formatDateTimeInJodaSyntax(toDate('2012-05-29'), 'D')` は、以前は `15` を返していましたが、現在は正しく `150` を返します。 [#64614](https://github.com/ClickHouse/ClickHouse/pull/64614) ([LiuNeng](https://github.com/liuneng1994)).
* `-If` コンビネータがすでに使用されている場合は、集約を書き換えないよう修正しました。[#64638](https://github.com/ClickHouse/ClickHouse/pull/64638) ([Dmitry Novik](https://github.com/novikd)).
* float の型推論を修正（バッファが小さい場合、つまり `--max_read_buffer_size 1` のとき）。 [#64641](https://github.com/ClickHouse/ClickHouse/pull/64641) ([Azat Khuzhin](https://github.com/azat)).
* 式を使用したTTLが正しく動作しなくなる可能性があった不具合を修正しました。 [#64694](https://github.com/ClickHouse/ClickHouse/pull/64694) ([alesapin](https://github.com/alesapin)).
* 新しいアナライザで、常に真となる `WHERE` および `PREWHERE` の式を削除してしまう問題を修正しました。 [#64695](https://github.com/ClickHouse/ClickHouse/pull/64695) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `startsWith`、`endsWith`、`match`、`multiSearchAny` の結果でフィルタリングする際に、トークンベースのテキストインデックス（`ngrambf`、`full_text`）によって不要な部分まで除去されてしまう問題を修正しました。 [#64720](https://github.com/ClickHouse/ClickHouse/pull/64720) ([Eduard Karacharov](https://github.com/korowa)).
* `UTF8::computeWidth` 関数における ANSI CSI エスケープシーケンス処理の誤った動作を修正します。[#64756](https://github.com/ClickHouse/ClickHouse/pull/64756) ([Shaun Struwig](https://github.com/Blargian))。
* サブクエリにまたがって `ORDER BY` / `LIMIT BY` が誤って削除される不具合を修正。 [#64766](https://github.com/ClickHouse/ClickHouse/pull/64766) ([Raúl Marín](https://github.com/Algunenano)).
* 混在した結合条件に含まれる `set` に対するサブクエリを用いる（実験的な）非等値結合を修正しました。 [#64775](https://github.com/ClickHouse/ClickHouse/pull/64775) ([lgbo](https://github.com/lgbo-ustc)).
* `plain_rewritable` ディスク上のローカルキャッシュで発生していたクラッシュを修正。[#64778](https://github.com/ClickHouse/ClickHouse/pull/64778) ([Julia Kartseva](https://github.com/jkartseva))。
* Keeper の修正: `mntr` コマンドが `zk_latest_snapshot_size` の正しい値を返すように修正。 [#64784](https://github.com/ClickHouse/ClickHouse/pull/64784) ([Antonio Andelic](https://github.com/antonio2368)).
* `Nested` 列による `ARRAY JOIN` を含む分散クエリで発生する `Cannot find column` エラーを修正しました。[#64755](https://github.com/ClickHouse/ClickHouse/issues/64755) の問題を解決。[#64801](https://github.com/ClickHouse/ClickHouse/pull/64801)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* SLRU キャッシュポリシーのメモリリークを修正。 [#64803](https://github.com/ClickHouse/ClickHouse/pull/64803) ([Kseniia Sumarokova](https://github.com/kssenii)).
* S3 からデータを読み取るクエリ、HTTP プロトコル経由のクエリ、非同期 INSERT など、いくつかの種類のクエリで発生する可能性があった不正確なメモリトラッキングを修正しました。 [#64844](https://github.com/ClickHouse/ClickHouse/pull/64844) ([Anton Popov](https://github.com/CurtizJ)).
* `PREWHERE` を使用してマテリアライズドビューからデータを読み取るクエリで、マテリアライズドビューのカラムの型がソーステーブルと異なる場合に発生する `Block structure mismatch` エラーを修正しました。[#64611](https://github.com/ClickHouse/ClickHouse/issues/64611) を修正。[#64855](https://github.com/ClickHouse/ClickHouse/pull/64855)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* サブクエリ付きの TTL を持つテーブル + レプリケートされたデータベース + 並列レプリカ + analyzer の組み合わせで、まれに発生するクラッシュを修正しました。発生頻度は非常に低いものの、サブクエリ付きの TTL の使用は避けてください。 [#64858](https://github.com/ClickHouse/ClickHouse/pull/64858) ([alesapin](https://github.com/alesapin)).
* 大きな削除バッチ処理時に `blob_storage_log` で `Delete` イベントが重複して記録される問題を修正しました。 [#64924](https://github.com/ClickHouse/ClickHouse/pull/64924) ([vdimir](https://github.com/vdimir)).
* [Zoo]Keeper からの設定インクルードを含む構成で、サーバー起動後に発生する可能性があった [Zoo]Keeper の `Session moved to another server` エラーを修正しました。 [#64986](https://github.com/ClickHouse/ClickHouse/pull/64986) ([Alexander Tokmakov](https://github.com/tavplubix)).
* [https://github.com/ClickHouse/ClickHouse/pull/54211](https://github.com/ClickHouse/ClickHouse/pull/54211) でパラメータ付き VIEW に対して正しく動作していなかった `ALTER MODIFY COMMENT` クエリを修正。[#65031](https://github.com/ClickHouse/ClickHouse/pull/65031) ([Nikolay Degterinsky](https://github.com/evillique))。
* `cluster_secure_connection` パラメータが有効な場合の DatabaseReplicated における `host_id` の扱いを修正しました。以前は、このパラメータが有効化されていても、DatabaseReplicated によってクラスター内で作成されるすべての接続が安全な接続になっていませんでした。[#65054](https://github.com/ClickHouse/ClickHouse/pull/65054)（[Nikolay Degterinsky](https://github.com/evillique)）。
* StorageMerge に対する `PREWHERE` 最適化後に発生していた `Not-ready Set` エラーを修正。 [#65057](https://github.com/ClickHouse/ClickHouse/pull/65057) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* ファイルライクなストレージで確定済みバッファへの書き込みを避けるようにしました。 [#65063](https://github.com/ClickHouse/ClickHouse/pull/65063) ([Kruglov Pavel](https://github.com/Avogar)).
* 循環エイリアスが存在する場合にクエリの実行時間が無限になる可能性のある問題を修正。[#64849](https://github.com/ClickHouse/ClickHouse/issues/64849) を修正。 [#65081](https://github.com/ClickHouse/ClickHouse/pull/65081) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 新しい analyzer での `INTERPOLATE (alias)` を使用したリモートクエリで発生する `Unknown expression identifier` エラーを修正。[#64636](https://github.com/ClickHouse/ClickHouse/issues/64636) を修正。[#65090](https://github.com/ClickHouse/ClickHouse/pull/65090)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 集約処理の外側に算術演算をプッシュダウンする最適化を修正しました。新しいアナライザでは、この最適化が1回だけしか適用されていませんでした。 [#65104](https://github.com/ClickHouse/ClickHouse/pull/65104) ([Dmitry Novik](https://github.com/novikd)).
* 新しいアナライザーにおける集約関数名の書き換え処理を修正。 [#65110](https://github.com/ClickHouse/ClickHouse/pull/65110) ([Dmitry Novik](https://github.com/novikd))。
* クライアントソケットからリクエストボディ（またはその一部）を読み取る際に受信タイムアウトが発生した場合、200 OK ではなく 5xx を返すようにしました。 [#65118](https://github.com/ClickHouse/ClickHouse/pull/65118) ([Julian Maicher](https://github.com/jmaicher)).
* ヘッジリクエストで発生する可能性のあるクラッシュを修正。 [#65206](https://github.com/ClickHouse/ClickHouse/pull/65206) ([Azat Khuzhin](https://github.com/azat)).
* Hashed および Hashed&#95;Array 辞書のショートサーキット評価におけるバグを修正しました。このバグにより、未初期化の数値が読み出され、さまざまなエラーを引き起こす可能性がありました。 [#65256](https://github.com/ClickHouse/ClickHouse/pull/65256) ([jsc0218](https://github.com/jsc0218)).
* このPRでは、定数（IN 演算子の第2引数）の型が、IN 演算子の型変換処理の間じゅう常に保持・参照されるようにします。そうしないと、型情報が失われて一部の変換（たとえば DateTime から Date への変換）が失敗する可能性があります。これにより、[#64487](https://github.com/ClickHouse/ClickHouse/issues/64487) が修正されます。[#65315](https://github.com/ClickHouse/ClickHouse/pull/65315)（[pn](https://github.com/chloro-pn)）。



#### ビルド／テスト／パッケージングの改善 {#buildtestingpackaging-improvement-2}
* LLVM XRay のサポートを追加。[#64592](https://github.com/ClickHouse/ClickHouse/pull/64592) [#64837](https://github.com/ClickHouse/ClickHouse/pull/64837) ([Tomer Shafir](https://github.com/tomershafir)).
* s3/hdfs/azure ストレージ実装を、IObjectStorage と連携する単一クラスに統合。同様に *Cluster、データレイクおよび Queue ストレージも統合。[#59767](https://github.com/ClickHouse/ClickHouse/pull/59767) ([Kseniia Sumarokova](https://github.com/kssenii)).
* MergeTreeData と DataPart への依存関係を除去するために data part writer をリファクタリング。[#63620](https://github.com/ClickHouse/ClickHouse/pull/63620) ([Alexander Gololobov](https://github.com/davenger)).
* `KeyCondition` とキー解析をリファクタリングして、PartitionPruner および trivial count 最適化を改善。これは [#60463](https://github.com/ClickHouse/ClickHouse/issues/60463) から分離されたもの。[#61459](https://github.com/ClickHouse/ClickHouse/pull/61459) ([Amos Bird](https://github.com/amosbird)).
* すべての関数が正しいサイズのカラムで呼び出されていることを検証するアサーションを導入。[#63723](https://github.com/ClickHouse/ClickHouse/pull/63723) ([Raúl Marín](https://github.com/Algunenano)).
* ClickHouse サーバーデーモンを起動するために `rc` init スクリプトを使用する際、`network` サービスを必須としました。[#60650](https://github.com/ClickHouse/ClickHouse/pull/60650) ([Chun-Sheng, Li](https://github.com/peter279k)).
* 一部の遅いテストのサイズを縮小。[#64387](https://github.com/ClickHouse/ClickHouse/pull/64387) [#64452](https://github.com/ClickHouse/ClickHouse/pull/64452) ([Raúl Marín](https://github.com/Algunenano)).
* keeper-bench を使用して ZooKeeper ログをリプレイ。[#62481](https://github.com/ClickHouse/ClickHouse/pull/62481) ([Antonio Andelic](https://github.com/antonio2368)).

### <a id="245"></a> ClickHouse リリース 24.5, 2024-05-30 {#a-id245a-clickhouse-release-245-2024-05-30}

#### 後方互換性のない変更 {#backward-incompatible-change-7}
* 「inverted indexes」を、技術色を抑えたよりユーザーフレンドリーな名称である「full-text indexes」に改名。この変更により内部テーブルメタデータも変更され、既存の（実験的な） inverted indexes を持つテーブルは壊れます。アップグレード前にこれらのインデックスを必ず削除し、アップグレード後に再作成してください。[#62884](https://github.com/ClickHouse/ClickHouse/pull/62884) ([Robert Schulze](https://github.com/rschu1ze)).
* 関数 `neighbor`, `runningAccumulate`, `runningDifferenceStartingWithFirstValue`, `runningDifference` の使用は、エラーを招きやすいため非推奨となりました。代わりに適切なウィンドウ関数を使用すべきです。これらを再度有効にするには、`allow_deprecated_error_prone_window_functions = 1` を設定するか、`compatibility = '24.4'` 以下を設定してください。[#63132](https://github.com/ClickHouse/ClickHouse/pull/63132) ([Nikita Taranov](https://github.com/nickitat)).
* 多数のカラムが存在し、多くのデータベースまたはテーブルに `SHOW TABLES` 権限が付与されていない場合でも、`system.columns` からのクエリがより高速に動作するようになりました。以前のバージョンでは、対応するテーブルに `SHOW TABLES` を付与せずに個々のカラムに `SHOW COLUMNS` を付与した場合、`system.columns` テーブルにはそれらのカラムが表示されていましたが、新バージョンではそのテーブル全体がスキップされますので注意してください。クエリを低速化していた「Access granted」と「Access denied」のトレースログメッセージを削除しました。[#63439](https://github.com/ClickHouse/ClickHouse/pull/63439) ([Alexey Milovidov](https://github.com/alexey-milovidov)).



#### 新機能 {#new-feature-7}

* `application/x-www-form-urlencoded` 形式で単一レコードを読み書きするための `Form` フォーマットを追加しました。 [#60199](https://github.com/ClickHouse/ClickHouse/pull/60199) ([Shaun Struwig](https://github.com/Blargian))。
* CROSS JOIN での圧縮を可能にしました。 [#60459](https://github.com/ClickHouse/ClickHouse/pull/60459) ([p1rattttt](https://github.com/p1rattttt)).
* サイズが制限を超えた場合、一時ファイル内で `CROSS JOIN` を実行できるようにしました。 [#63432](https://github.com/ClickHouse/ClickHouse/pull/63432) ([p1rattttt](https://github.com/p1rattttt)).
* 左テーブルと右テーブル両方のカラムを含む不等条件（例: `t1.y < t2.y`）を用いた `JOIN` をサポートするようになりました。有効化するには、`SET allow_experimental_join_condition = 1` を実行します。[#60920](https://github.com/ClickHouse/ClickHouse/pull/60920)（[lgbo](https://github.com/lgbo-ustc)）。
* Map では、キーとして `Float32`、`Float64`、`Array(T)`、`Map(K, V)`、`Tuple(T1, T2, ...)` を使用できるようになりました。これにより [#54537](https://github.com/ClickHouse/ClickHouse/issues/54537) がクローズされました。[#59318](https://github.com/ClickHouse/ClickHouse/pull/59318)（[李扬](https://github.com/taiyang-li)）。
* RocksDB の組み込み memtable に依存する代わりに SST ファイルを作成して取り込むことで、`EmbeddedRocksDB` への一括ロード機能を導入しました。これにより、特に StorageEmbeddedRocksDB テーブルへの長時間実行される INSERT クエリにおいて、インポート速度が向上します。また、`EmbeddedRocksDB` のテーブル設定も導入しました。 [#59163](https://github.com/ClickHouse/ClickHouse/pull/59163) [#63324](https://github.com/ClickHouse/ClickHouse/pull/63324) ([Duc Canh Le](https://github.com/canhld94)).
* ユーザーは、設定項目 `input_format_tsv_crlf_end_of_line` を使用することで、TSV 形式の入力で行末としての CRLF をパースできるようになりました。 [#56257](https://github.com/ClickHouse/ClickHouse/issues/56257) をクローズしました。 [#59747](https://github.com/ClickHouse/ClickHouse/pull/59747)（[Shaun Struwig](https://github.com/Blargian)）。
* 省略されたフィールドに NULL 値を設定するよう強制する新しい設定 `input_format_force_null_for_omitted_fields`。 [#60887](https://github.com/ClickHouse/ClickHouse/pull/60887)（[Constantine Peresypkin](https://github.com/pkit)）。
* これまで、S3 ストレージと s3 テーブル関数は、tarball、zip、7z などのアーカイブファイルからの `SELECT` をサポートしていませんでしたが、現在では、S3 上のアーカイブ内ファイルを順に処理できるようになりました。 [#62259](https://github.com/ClickHouse/ClickHouse/pull/62259) ([Daniil Ivanik](https://github.com/divanik))。
* 条件関数 `clamp` をサポートしました。 [#62377](https://github.com/ClickHouse/ClickHouse/pull/62377) ([skyoct](https://github.com/skyoct)).
* `NPy` 出力形式を追加。[#62430](https://github.com/ClickHouse/ClickHouse/pull/62430)（[豪肥肥](https://github.com/HowePa)）。
* `TSVRaw` の同義語として `Raw` フォーマットを追加。 [#63394](https://github.com/ClickHouse/ClickHouse/pull/63394) ([Unalian](https://github.com/Unalian)).
* バージョン 7 の UUID（タイムスタンプベースでランダム要素を含む）を生成する新しい SQL 関数 `generateUUIDv7` を追加しました。さらに、UUID からバイト列を抽出する新しい関数 `UUIDToNum` と、バージョン 7 の UUID からタイムスタンプ成分を抽出する新しい関数 `UUIDv7ToDateTime` も追加しました。 [#62852](https://github.com/ClickHouse/ClickHouse/pull/62852) ([Alexey Petrunyaka](https://github.com/pet74alex)).
* Linux および macOS では、プログラムの stdout が圧縮拡張子を持つファイルにリダイレクトされている場合、（何もしないのではなく）対応する圧縮方式で出力を圧縮するようになりました（`INTO OUTFILE` と同様の動作になります）。[#63662](https://github.com/ClickHouse/ClickHouse/pull/63662) ([v01dXYZ](https://github.com/v01dXYZ))。
* 多数のテーブルがアタッチされている場合に表示される警告を、テーブル・ビュー・ディクショナリを区別できるように変更しました。 [#64180](https://github.com/ClickHouse/ClickHouse/pull/64180) ([Francisco J. Jurado Moreno](https://github.com/Beetelbrox)).
* ClickHouse サーバーの `azureBlobStorage` 関数で Azure Workload Identity を使用して Azure Blob Storage に対して認証できるようサポートしました。設定ファイルで `use_workload_identity` パラメータが有効になっている場合、認証には [Workload Identity](https://github.com/Azure/azure-sdk-for-cpp/tree/main/sdk/identity/azure-identity#authenticate-azure-hosted-applications) が使用されます。 [#57881](https://github.com/ClickHouse/ClickHouse/pull/57881)（[Vinay Suryadevara](https://github.com/vinay92-ch)）。
* TTL 情報を `system.parts_columns` テーブルに追加しました。 [#63200](https://github.com/ClickHouse/ClickHouse/pull/63200) ([litlig](https://github.com/litlig)).



#### 実験的機能 {#experimental-features-1}
* 事前にすべての型を把握していなくても、任意の型の値を格納できる `Dynamic` データ型を実装しました。`Dynamic` 型は設定 `allow_experimental_dynamic_type` によって利用可能です。参考: [#54864](https://github.com/ClickHouse/ClickHouse/issues/54864)、[#63058](https://github.com/ClickHouse/ClickHouse/pull/63058)（[Kruglov Pavel](https://github.com/Avogar)）。
* MySQL への接続なしで `MaterializedMySQL` データベースを作成できるようにしました。[#63397](https://github.com/ClickHouse/ClickHouse/pull/63397)（[Kirill](https://github.com/kirillgarbar)）。
* ある DDL タスクが同じエラーで連続して `max_retries_before_automatic_recovery` 回（デフォルトでは 100 回）以上失敗した場合に、Replicated データベースのレプリカを自動的に「失われた」とマークし、リカバリを開始するようにしました。また、エントリ実行の初期段階で例外がスローされた場合に、DDL エントリがスキップされる可能性があった不具合も修正しました。[#63549](https://github.com/ClickHouse/ClickHouse/pull/63549)（[Alexander Tokmakov](https://github.com/tavplubix)）。
* `StorageS3Queue` において、失敗したファイルも `s3queue_tracked_file_ttl_sec` および `s3queue_traked_files_limit` のカウントに含めるようにしました。[#63638](https://github.com/ClickHouse/ClickHouse/pull/63638)（[Kseniia Sumarokova](https://github.com/kssenii)）。



#### パフォーマンスの改善 {#performance-improvement-7}
* ファイルシステムキャッシュ内での競合を削減しました（パート 4）。バックグラウンドで追加のエビクションを行うことで（`keep_free_space_size(elements)_ratio` によって制御）、ファイルシステムキャッシュが限界まで埋まらないようにできます。これにより、クエリのための空き領域予約（`tryReserve` メソッド）にかかるプレッシャーを軽減できます。また、可能な限りロックフリーな方法で実装しており、通常のキャッシュ利用をブロックしない想定です。[#61250](https://github.com/ClickHouse/ClickHouse/pull/61250)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `INSERT` 実行中に、新しく作成された projection ブロックのマージをスキップします。[#59405](https://github.com/ClickHouse/ClickHouse/pull/59405)（[Nikita Taranov](https://github.com/nickitat)）。
* 文字列関数 `...UTF8` について、入力文字列がすべて ASCII 文字の場合は ASCII として処理します。https://github.com/apache/doris/pull/29799 に触発されています。全体として 1.07～1.62 倍の高速化が得られました。いくつかのケースではピークメモリ使用量も減少しています。[#61632](https://github.com/ClickHouse/ClickHouse/pull/61632)（[李扬](https://github.com/taiyang-li)）。
* StorageS3 におけるセレクション（`{}`）グロブのパフォーマンスを改善しました。[#62120](https://github.com/ClickHouse/ClickHouse/pull/62120)（[Andrey Zvonov](https://github.com/zvonand)）。
* HostResolver が同じ IP アドレスを複数回保持していました。リモートホストが複数の IP を持ち、何らかの理由（たとえばファイアウォールルール）で一部の IP へのアクセスのみ許可され、他が禁止されている場合、禁止された IP のレコードのうち最初のものだけが失敗としてマークされ、各試行でこれらの IP が選択される可能性が残り（そして再度失敗します）。さらに、これを修正したとしても、120 秒ごとに DNS キャッシュが破棄されるため、IP が再び選択され得ます。[#62652](https://github.com/ClickHouse/ClickHouse/pull/62652)（[Anton Ivashkin](https://github.com/ianton-ru)）。
* 新しい設定 `prefer_merge_sort_block_bytes` を追加し、多数のカラムがある場合のマージ時にメモリ使用量を制御しつつ、ソートを 2 倍高速化できるようにしました。[#62904](https://github.com/ClickHouse/ClickHouse/pull/62904)（[LiuNeng](https://github.com/liuneng1994)）。
* `clickhouse-local` がより高速に起動するようになりました。以前のバージョンでは、一時ディレクトリが誤って削除されていませんでしたが、現在は削除されます。これにより [#62941](https://github.com/ClickHouse/ClickHouse/issues/62941) がクローズされます。[#63074](https://github.com/ClickHouse/ClickHouse/pull/63074)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 新しいアナライザに対するマイクロ最適化を行いました。[#63429](https://github.com/ClickHouse/ClickHouse/pull/63429)（[Raúl Marín](https://github.com/Algunenano)）。
* `DateTime` が `DateTime64` と比較される場合でもインデックス解析が動作するようになりました。これにより [#63441](https://github.com/ClickHouse/ClickHouse/issues/63441) がクローズされます。[#63443](https://github.com/ClickHouse/ClickHouse/pull/63443) [#63532](https://github.com/ClickHouse/ClickHouse/pull/63532)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* `set` 型インデックスについて、不要なデータを削除することで少し（約 1.5 倍）高速化しました。[#64098](https://github.com/ClickHouse/ClickHouse/pull/64098)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* ファイルシステムキャッシュへの書き込み時にデータをコピーしないようにしました。[#63401](https://github.com/ClickHouse/ClickHouse/pull/63401)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* Azure Blob Storage を利用したバックアップで multicopy を使用するようになりました。[#64116](https://github.com/ClickHouse/ClickHouse/pull/64116)（[alesapin](https://github.com/alesapin)）。
* 異なるコンテナ間であっても、Azure に対してネイティブコピーを使用できるようにしました。[#64154](https://github.com/ClickHouse/ClickHouse/pull/64154)（[alesapin](https://github.com/alesapin)）。
* Azure に対するネイティブコピーをついに有効化しました。[#64182](https://github.com/ClickHouse/ClickHouse/pull/64182)（[alesapin](https://github.com/alesapin)）。



#### 改善 {#improvement-7}

* `clickhouse-local` と、そのショートカットである `clickhouse` および `ch` で、クエリ文字列またはクエリを含むファイルを位置引数として指定して実行できるようにしました。例: `ch "SELECT 1"`, `ch --param_test Hello "SELECT {test:String}"`, `ch query.sql`。これにより [#62361](https://github.com/ClickHouse/ClickHouse/issues/62361) がクローズされました。 [#63081](https://github.com/ClickHouse/ClickHouse/pull/63081)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* ローカルおよび Azure (azure&#95;blob&#95;storage) のオブジェクトストレージで plain&#95;rewritable メタデータを有効にしました。 [#63365](https://github.com/ClickHouse/ClickHouse/pull/63365) ([Julia Kartseva](https://github.com/jkartseva)).
* 英語スタイルの Unicode 引用符（例: “Hello”、&#39;world&#39;）をサポートします。一般的には疑問の余地がありますが、Google Docs などのワードプロセッサでクエリを入力する場合には便利です。これにより [#58634](https://github.com/ClickHouse/ClickHouse/issues/58634) がクローズされました。[#63381](https://github.com/ClickHouse/ClickHouse/pull/63381)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* INSERT クエリのカラムリストで末尾のカンマを許可しました。例えば、`INSERT INTO test (a, b, c, ) VALUES ...` のように記述できます。[#63803](https://github.com/ClickHouse/ClickHouse/pull/63803)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* `Regexp` フォーマット向けの例外メッセージを改善。 [#63804](https://github.com/ClickHouse/ClickHouse/pull/63804) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* `Values` 形式で末尾のカンマを許容するようになりました。たとえば、次のクエリが使用できます: `INSERT INTO test (a, b, c) VALUES (4, 5, 6,);`。 [#63810](https://github.com/ClickHouse/ClickHouse/pull/63810) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* RabbitMQ が破損したメッセージに nack を返すようにしました。[#45350](https://github.com/ClickHouse/ClickHouse/issues/45350) をクローズしました。[#60312](https://github.com/ClickHouse/ClickHouse/pull/60312)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* デバッグ情報の解釈中に、（サンプリングクエリプロファイラ使用時などの）非同期スタックのアンワインド処理で発生していたクラッシュを修正しました。これにより [#60460](https://github.com/ClickHouse/ClickHouse/issues/60460) がクローズされました。 [#60468](https://github.com/ClickHouse/ClickHouse/pull/60468) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* ディスクとストレージの場合で、S3 エラー &#39;no key&#39; のメッセージを区別しました。 [#61108](https://github.com/ClickHouse/ClickHouse/pull/61108) ([Sema Checherinda](https://github.com/CheSema)).
* プログレスバーは、`system.zeros`、`system.zeros_mt` からの `LIMIT` 句を含む単純なクエリでも動作し（すでに `system.numbers` および `system.numbers_mt` では動作しています）、`generateRandom` テーブル関数でも動作するようになります。さらに、レコードの総数が `max_rows_to_read` の上限を超えている場合には、より早い時点で例外をスローします。これにより [#58183](https://github.com/ClickHouse/ClickHouse/issues/58183) がクローズされます。 [#61823](https://github.com/ClickHouse/ClickHouse/pull/61823) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* YAML 設定における「Merge Key」対応（YAML のちょっと変わった機能なので、あまり気にしないでください）。 [#62685](https://github.com/ClickHouse/ClickHouse/pull/62685) ([Azat Khuzhin](https://github.com/azat)).
* Replicated ソースで非決定的関数が使用された場合のエラーメッセージを改善しました。 [#62896](https://github.com/ClickHouse/ClickHouse/pull/62896) ([Grégoire Pineau](https://github.com/lyrixx)).
* `remote` による Distributed over Distributed 用 interserver secret を修正。[#63013](https://github.com/ClickHouse/ClickHouse/pull/63013)（[Azat Khuzhin](https://github.com/azat)）。
* YAML ファイルで `include_from` がサポートされました。ただし、代わりに `config.d` を使用することを推奨します。[#63106](https://github.com/ClickHouse/ClickHouse/pull/63106)（[Eduard Karacharov](https://github.com/korowa)）。
* skim の候補から選択した後でも、ターミナルにそれまでの内容を残すようにしました。 [#63261](https://github.com/ClickHouse/ClickHouse/pull/63261) ([FlameFactory](https://github.com/FlameFactory)).
* Pretty フォーマットや `visibleWidth` 関数でのフィールド幅計算時に、ANSI エスケープシーケンスが正しく無視されるようになりました。 [#63270](https://github.com/ClickHouse/ClickHouse/pull/63270) ([Shaun Struwig](https://github.com/Blargian))。
* 必要に応じて、エラーコード `NUMBER_OF_ARGUMENTS_DOESNT_MATCH` の使用箇所を、より適切なエラーコードに更新しました。 [#63406](https://github.com/ClickHouse/ClickHouse/pull/63406) ([Yohann Jardin](https://github.com/yohannj)).
* `os_user` と `client_hostname` が、clickhouse-client のコマンドライン補完候補を取得するクエリに対して正しく設定されるようになりました。これにより [#63430](https://github.com/ClickHouse/ClickHouse/issues/63430) が解決されました。 [#63433](https://github.com/ClickHouse/ClickHouse/pull/63433) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* `max_block_size` が 0 に設定されている場合、自動的にデフォルト値に補正されるようにしました。 [#63587](https://github.com/ClickHouse/ClickHouse/pull/63587) ([Antonio Andelic](https://github.com/antonio2368)).
* バイナリの変更が検出された際の自動リネームを容易にするため、`trace_log` に `build_id` の `ALIAS` 列を追加しました。これは [#52086](https://github.com/ClickHouse/ClickHouse/issues/52086) への対応です。[#63656](https://github.com/ClickHouse/ClickHouse/pull/63656)（[Zimu Li](https://github.com/woodlzm)）。
* オブジェクトストレージディスクで `truncate` 操作を有効にしました。 [#63693](https://github.com/ClickHouse/ClickHouse/pull/63693) ([MikhailBurdukov](https://github.com/MikhailBurdukov))。
* キーワード一覧の読み込みはサーバーのリビジョンに依存するようになったため、古いバージョンの ClickHouse サーバーでは無効化されます。CC @azat。 [#63786](https://github.com/ClickHouse/ClickHouse/pull/63786) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* ClickHouse のディスクでは、実際のメタデータ形式のバージョンを取得するためにサーバー設定を読み取る必要があります。 [#63831](https://github.com/ClickHouse/ClickHouse/pull/63831) ([Sema Checherinda](https://github.com/CheSema)).
* stdout が TTY でない場合は、pretty 形式の制限（`output_format_pretty_max_rows`/`output_format_pretty_max_value_width`）を無効化します。[#63942](https://github.com/ClickHouse/ClickHouse/pull/63942)（[Azat Khuzhin](https://github.com/azat)）。
* AWS Lambda 環境で ClickHouse を使用する場合にも、例外処理が正しく機能するようになりました。著者: [Alexey Coolnev](https://github.com/acoolnev)。[#64014](https://github.com/ClickHouse/ClickHouse/pull/64014)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* HTTP 経由で渡された無効な圧縮データの場合は、`CORRUPTED_DATA` ではなく `CANNOT_DECOMPRESS` をスローするように変更。 [#64036](https://github.com/ClickHouse/ClickHouse/pull/64036) ([vdimir](https://github.com/vdimir)).
* Pretty フォーマットにおける「単一の大きな数値」に関するヒントが、Nullable 型および LowCardinality 型でも機能するようになりました。これにより [#61993](https://github.com/ClickHouse/ClickHouse/issues/61993) が解決されました。 [#64084](https://github.com/ClickHouse/ClickHouse/pull/64084) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* インデックスを用いたパーツのフィルタリング処理の周辺に、メトリクス、ログ、およびスレッド名を追加しました。 [#64130](https://github.com/ClickHouse/ClickHouse/pull/64130) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* `ATTACH` では `allow_suspicious_primary_key` を無視し、`ALTER` では検証するようにしました。 [#64202](https://github.com/ClickHouse/ClickHouse/pull/64202) ([Azat Khuzhin](https://github.com/azat)).



#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-3}
* ClickHouse は clang-18 でビルドされるようになりました。clang-tidy-18 による多数の新しいチェックが有効化されました。[#60469](https://github.com/ClickHouse/ClickHouse/pull/60469) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* ClickHouse の新しいプラットフォームとして loongarch64 を実験的にサポートしました。[#63733](https://github.com/ClickHouse/ClickHouse/pull/63733) ([qiangxuhui](https://github.com/qiangxuhui)).
* Dockerfile は https://github.com/docker-library/official-images/pull/15846 で Docker 公式ライブラリによるレビューを受けました。[#63400](https://github.com/ClickHouse/ClickHouse/pull/63400) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* CI 上のすべてのビルドで、各翻訳単位内のすべてのシンボルに関する情報を CI データベースに収集するようにしました。これにより [#63494](https://github.com/ClickHouse/ClickHouse/issues/63494) が解決されます。[#63495](https://github.com/ClickHouse/ClickHouse/pull/63495) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Apache Datasketches ライブラリを更新しました。これにより [#63858](https://github.com/ClickHouse/ClickHouse/issues/63858) が解決されます。[#63923](https://github.com/ClickHouse/ClickHouse/pull/63923) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* バイナリのクロスコンパイル時に、aarch64 Linux 向けの gRPC サポートを有効にしました。[#64072](https://github.com/ClickHouse/ClickHouse/pull/64072) ([alesapin](https://github.com/alesapin)).
* aarch64 上での SIGSEGV 発生時のアンワインド処理を修正しました（signal 用スタックが小さいことが原因）。[#64058](https://github.com/ClickHouse/ClickHouse/pull/64058) ([Azat Khuzhin](https://github.com/azat)).



#### バグ修正 {#bug-fix-1}

* デフォルトで `enable_vertical_final` 設定を無効にしました。この機能にはバグがあるため、使用しないでください: [#64543](https://github.com/ClickHouse/ClickHouse/issues/64543)。[#64544](https://github.com/ClickHouse/ClickHouse/pull/64544)（[Alexander Tokmakov](https://github.com/tavplubix)）。
* 複数シャード環境でのバックアップ作成処理を修正 [#57684](https://github.com/ClickHouse/ClickHouse/pull/57684) ([Vitaly Baranov](https://github.com/vitlibar)).
* `CREATE` クエリのカラムリストからマテリアライズドビュー (MV) の内部テーブルへ `projections` / `indexes` / `primary key` を渡す処理を修正 [#59183](https://github.com/ClickHouse/ClickHouse/pull/59183)（[Azat Khuzhin](https://github.com/azat)）。
* boundRatio の誤ったマージを修正 [#60532](https://github.com/ClickHouse/ClickHouse/pull/60532) ([Tao Wang](https://github.com/wangtZJU))。
* `const` な low-cardinality 列に対して一部の関数を呼び出すとクラッシュする問題を修正 [#61966](https://github.com/ClickHouse/ClickHouse/pull/61966) ([Michael Kolupaev](https://github.com/al13n321))。
* adaptive granularity を使用していないテーブルで FINAL を使用したクエリが誤った結果を返す問題を修正 [#62432](https://github.com/ClickHouse/ClickHouse/pull/62432) ([Duc Canh Le](https://github.com/canhld94)).
* メモリコントローラー用の cgroups v2 サポートの検出処理を改善 [#62903](https://github.com/ClickHouse/ClickHouse/pull/62903) ([Robert Schulze](https://github.com/rschu1ze))。
* クライアントにおける外部テーブルの後続利用を修正 [#62964](https://github.com/ClickHouse/ClickHouse/pull/62964) ([Azat Khuzhin](https://github.com/azat)).
* `untuple` 関数と未解決のラムダ式によるクラッシュを修正 [#63131](https://github.com/ClickHouse/ClickHouse/pull/63131) ([Raúl Marín](https://github.com/Algunenano))。
* サーバーが接続待ちを開始するタイミングが早すぎた問題を修正 [#63181](https://github.com/ClickHouse/ClickHouse/pull/63181) ([alesapin](https://github.com/alesapin)).
* DROP PART コマンド実行後の再起動時に重複するパーツを修正 [#63202](https://github.com/ClickHouse/ClickHouse/pull/63202) ([Han Fei](https://github.com/hanfei1991)).
* 起動時に SQL セキュリティのデフォルト設定を正しく読み込むようにしました [#63209](https://github.com/ClickHouse/ClickHouse/pull/63209) ([pufit](https://github.com/pufit)).
* JOIN フィルタのプッシュダウンにおける filter join の問題を修正 [#63234](https://github.com/ClickHouse/ClickHouse/pull/63234) ([Maksim Kita](https://github.com/kitaisreal)).
* AzureObjectStorage::listObjects で発生する無限ループを修正 [#63257](https://github.com/ClickHouse/ClickHouse/pull/63257) ([Julia Kartseva](https://github.com/jkartseva)).
* CROSS JOIN が join&#95;algorithm 設定を無視するようになりました [#63273](https://github.com/ClickHouse/ClickHouse/pull/63273) ([vdimir](https://github.com/vdimir))。
* WriteBufferToFileSegment と StatusFile の finalize を修正 [#63346](https://github.com/ClickHouse/ClickHouse/pull/63346) ([vdimir](https://github.com/vdimir)).
* まれなケースにおいて ALTER 実行後に発生する SELECT クエリの論理エラーを修正しました [#63353](https://github.com/ClickHouse/ClickHouse/pull/63353) ([alesapin](https://github.com/alesapin)).
* `session_timezone` を使用して `X-ClickHouse-Timezone` ヘッダーを修正 [#63377](https://github.com/ClickHouse/ClickHouse/pull/63377)（[Andrey Zvonov](https://github.com/zvonand)）。
* グループ化クエリで WITH ROLLUP と LowCardinality 型を使用する際に発生するデバッグアサートを修正  [#63398](https://github.com/ClickHouse/ClickHouse/pull/63398) ([Raúl Marín](https://github.com/Algunenano)).
* group&#95;by&#95;use&#95;nulls に関する細かな修正 [#63405](https://github.com/ClickHouse/ClickHouse/pull/63405) ([vdimir](https://github.com/vdimir))。
* テーブルメタデータからプロジェクションが削除されているが、パート側には依然としてプロジェクションが残っている場合のプロジェクションパートのバックアップ／リストアを修正しました [#63426](https://github.com/ClickHouse/ClickHouse/pull/63426) ([Kseniia Sumarokova](https://github.com/kssenii)).
* MySQL 辞書ソースを修正 [#63481](https://github.com/ClickHouse/ClickHouse/pull/63481) ([vdimir](https://github.com/vdimir))。
* データがない場合に AsyncInsertFlush で QueryFinish を挿入 [#63483](https://github.com/ClickHouse/ClickHouse/pull/63483) ([Raúl Marín](https://github.com/Algunenano)).
* 修正: system.query&#95;log において used&#95;dictionaries が空になっていた問題 [#63487](https://github.com/ClickHouse/ClickHouse/pull/63487) ([Eduard Karacharov](https://github.com/korowa)).
* `MergeTreePrefetchedReadPool` の安全性を向上 [#63513](https://github.com/ClickHouse/ClickHouse/pull/63513) ([Antonio Andelic](https://github.com/antonio2368)).
* Sentry を有効化した状態で終了時に発生していたクラッシュを修正（Sentry より先に OpenSSL が破棄されることが原因） [#63548](https://github.com/ClickHouse/ClickHouse/pull/63548) ([Azat Khuzhin](https://github.com/azat)).
* Keyed hashing を使用する Array および Map のサポートを修正 [#63628](https://github.com/ClickHouse/ClickHouse/pull/63628) ([Salvatore Mesoraca](https://github.com/aiven-sal))。
* Parquet および（おそらく）StorageMerge 向けフィルタープッシュダウン処理を修正 [#63642](https://github.com/ClickHouse/ClickHouse/pull/63642) ([Michael Kolupaev](https://github.com/al13n321)).
* ZooKeeper パスが既に存在する場合は Replicated への変換を行わないようにした [#63670](https://github.com/ClickHouse/ClickHouse/pull/63670) ([Kirill](https://github.com/kirillgarbar))。
* Analyzer: ビューが必要な列のみを読み込むように改善 [#63688](https://github.com/ClickHouse/ClickHouse/pull/63688) ([Maksim Kita](https://github.com/kitaisreal)).
* Analyzer: WINDOW の再定義を禁止 [#63694](https://github.com/ClickHouse/ClickHouse/pull/63694) ([Dmitry Novik](https://github.com/novikd)).
* 実験的な Replicated データベースにおいて flatten&#95;nested に不具合がありました。 [#63695](https://github.com/ClickHouse/ClickHouse/pull/63695) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* [#63653](https://github.com/ClickHouse/ClickHouse/issues/63653) [#63722](https://github.com/ClickHouse/ClickHouse/pull/63722) を修正しました ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* Array(Nothing) から Map(Nothing, Nothing) へキャストできるようにした [#63753](https://github.com/ClickHouse/ClickHouse/pull/63753) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* partial&#95;merge 結合における ILLEGAL&#95;COLUMN エラーを修正 [#63755](https://github.com/ClickHouse/ClickHouse/pull/63755) ([vdimir](https://github.com/vdimir))。
* 修正: ウィンドウ関数における冗長な distinct を削除 [#63776](https://github.com/ClickHouse/ClickHouse/pull/63776) ([Igor Nikonov](https://github.com/devcrafter)).
* SYSTEM UNLOAD PRIMARY KEY の使用時に発生し得るクラッシュを修正 [#63778](https://github.com/ClickHouse/ClickHouse/pull/63778) ([Raúl Marín](https://github.com/Algunenano))。
* 重複した循環エイリアスを含むクエリを修正。[#63791](https://github.com/ClickHouse/ClickHouse/pull/63791) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `TokenIterator` を本来あるべき通り遅延評価（lazy）にしました [#63801](https://github.com/ClickHouse/ClickHouse/pull/63801) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* S3 URI の `endpoint_subpath` 設定を追加 [#63806](https://github.com/ClickHouse/ClickHouse/pull/63806) ([Julia Kartseva](https://github.com/jkartseva)).
* `ParallelReadBuffer` でのデッドロックを修正 [#63814](https://github.com/ClickHouse/ClickHouse/pull/63814) ([Antonio Andelic](https://github.com/antonio2368))。
* JOIN フィルターのプッシュダウンにおける等価列の問題を修正 [#63819](https://github.com/ClickHouse/ClickHouse/pull/63819) ([Maksim Kita](https://github.com/kitaisreal))。
* Lazy データベースにおいて DROP 実行後にすべてのディスクからデータを削除するようにしました。 [#63848](https://github.com/ClickHouse/ClickHouse/pull/63848) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* 並列レプリカと新しいアナライザを使用してマテリアライズドビュー (MV) から読み取る際に誤った結果が返される問題を修正しました [#63861](https://github.com/ClickHouse/ClickHouse/pull/63861) ([Nikita Taranov](https://github.com/nickitat))。
* keeper-client の `find_super_nodes` および `find_big_family` コマンドに関する修正 [#63862](https://github.com/ClickHouse/ClickHouse/pull/63862) ([Alexander Gololobov](https://github.com/davenger))。
* Lambda 実行名を更新 [#63864](https://github.com/ClickHouse/ClickHouse/pull/63864) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* CPU/Real プロファイラが原因の SIGSEGV を修正 [#63865](https://github.com/ClickHouse/ClickHouse/pull/63865) ([Azat Khuzhin](https://github.com/azat))。
* `EXPLAIN CURRENT TRANSACTION` クエリを修正 [#63926](https://github.com/ClickHouse/ClickHouse/pull/63926)（[Anton Popov](https://github.com/CurtizJ)）。
* アナライザーを修正: 無限再帰状態（turtles all the way down）を解消… [#63930](https://github.com/ClickHouse/ClickHouse/pull/63930) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* `plain_rewritable` ディスクに対して一部の ALTER TABLE コマンドを許可するようにした [#63933](https://github.com/ClickHouse/ClickHouse/pull/63933)（[Julia Kartseva](https://github.com/jkartseva)）。
* 分散環境での再帰CTEに関する修正 [#63939](https://github.com/ClickHouse/ClickHouse/pull/63939)（[Maksim Kita](https://github.com/kitaisreal)）。
* Analyzer: COLUMNS の解決処理を修正 [#63962](https://github.com/ClickHouse/ClickHouse/pull/63962) ([Dmitry Novik](https://github.com/novikd)).
* analyzer での LIMIT BY および skip&#95;unused&#95;shards のサポート [#63983](https://github.com/ClickHouse/ClickHouse/pull/63983) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* experimental Kusto 関連の一部の出来の悪い実装に対する修正 [#63992](https://github.com/ClickHouse/ClickHouse/pull/63992) ([Yong Wang](https://github.com/kashwy))。
* 信頼できないバイナリ入力のデシリアライズを、より安全な方法で行うようにしました [#64024](https://github.com/ClickHouse/ClickHouse/pull/64024) ([Robert Schulze](https://github.com/rschu1ze)).
* MergeTree ファミリー以外のテーブルを参照する Distributed テーブルに対して、設定 `final` = 1 が指定されたクエリの解析を修正しました。 [#64037](https://github.com/ClickHouse/ClickHouse/pull/64037) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* recoverLostReplica に不足していた設定を追加 [#64040](https://github.com/ClickHouse/ClickHouse/pull/64040) ([Raúl Marín](https://github.com/Algunenano))。
* アナライザーを使用して SQL のセキュリティアクセスチェックを修正 [#64079](https://github.com/ClickHouse/ClickHouse/pull/64079) ([pufit](https://github.com/pufit))。
* アナライザーを修正: DAG では補間式のみを使用するように変更 [#64096](https://github.com/ClickHouse/ClickHouse/pull/64096) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Azure バックアップが（非ネイティブコピーの場合に）`max_upload_part_size` ではなく 1 MiB（読み取りバッファサイズ）単位でマルチパートブロックを書き込んでいた問題を修正 [#64117](https://github.com/ClickHouse/ClickHouse/pull/64117) ([Kseniia Sumarokova](https://github.com/kssenii)).
* バックアップコピー時のフォールバック処理を正しく行うよう修正 [#64153](https://github.com/ClickHouse/ClickHouse/pull/64153) ([Antonio Andelic](https://github.com/antonio2368)).
* CREATE TABLE をマテリアライズドビューとして実行する際に発生する LOGICAL&#95;ERROR を防止 [#64174](https://github.com/ClickHouse/ClickHouse/pull/64174) ([Raúl Marín](https://github.com/Algunenano)).
* Query Cache: 異なるデータベースに対する同一クエリを別物として扱うようにしました [#64199](https://github.com/ClickHouse/ClickHouse/pull/64199) ([Robert Schulze](https://github.com/rschu1ze))。
* Keeper では `text_log` を無視 [#64218](https://github.com/ClickHouse/ClickHouse/pull/64218) ([Antonio Andelic](https://github.com/antonio2368))。
* 論理エラーを修正: prewhere を使用した Buffer テーブルでの不正なキャスト。 [#64388](https://github.com/ClickHouse/ClickHouse/pull/64388) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).



### <a id="244"></a> ClickHouse リリース 24.4, 2024-04-30 {#a-id244a-clickhouse-release-244-2024-04-30}

#### アップグレードに関する注意事項 {#upgrade-notes}
* `clickhouse-odbc-bridge` と `clickhouse-library-bridge` は別々のパッケージになりました。これにより [#61677](https://github.com/ClickHouse/ClickHouse/issues/61677) がクローズされました。[#62114](https://github.com/ClickHouse/ClickHouse/pull/62114) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* 実験的機能であるレプリカからの並列読み取り用の `max_parallel_replicas` を、`0` に設定できないようにしました（`0` には意味がないため）。[#60140](https://github.com/ClickHouse/ClickHouse/issues/60140) をクローズしました。[#61201](https://github.com/ClickHouse/ClickHouse/pull/61201) ([Kruglov Pavel](https://github.com/Avogar)).
* 非推奨となった `LIVE VIEW` 機能の一部である `INSERT WATCH` クエリのサポートを削除しました。[#62382](https://github.com/ClickHouse/ClickHouse/pull/62382) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* `optimize_monotonous_functions_in_order_by` 設定を削除しました。[#63004](https://github.com/ClickHouse/ClickHouse/pull/63004) ([Raúl Marín](https://github.com/Algunenano)).
* `Replicated` データベースエンジンから experimental タグを削除しました。現在は Beta 段階です。[#62937](https://github.com/ClickHouse/ClickHouse/pull/62937) ([Justin de Guzman](https://github.com/justindeguzman)).



#### 新機能 {#new-feature-8}
* 再帰 CTE をサポートしました。[#62074](https://github.com/ClickHouse/ClickHouse/pull/62074) ([Maksim Kita](https://github.com/kitaisreal))。
* `QUALIFY` 句をサポートしました。[#47819](https://github.com/ClickHouse/ClickHouse/issues/47819) をクローズします。[#62619](https://github.com/ClickHouse/ClickHouse/pull/62619) ([Maksim Kita](https://github.com/kitaisreal))。
* テーブルエンジンに対して権限付与が可能になり、既存ユーザーの動作には影響しません。[#60117](https://github.com/ClickHouse/ClickHouse/pull/60117) ([jsc0218](https://github.com/jsc0218))。
* INSERT 操作をサポートし、ローカルにメタデータを保存する必要がない、書き換え可能な S3 ディスクを追加しました。[#61116](https://github.com/ClickHouse/ClickHouse/pull/61116) ([Julia Kartseva](https://github.com/jkartseva))。主なユースケースは system テーブルです。
* クライアントでの入力中の構文ハイライトが、構文レベルで動作するようになりました（以前は字句解析レベルで動作していました）。[#62123](https://github.com/ClickHouse/ClickHouse/pull/62123) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* `DROP TABLE a, b, c` のように、複数テーブルを同時に削除することをサポートしました。[#58705](https://github.com/ClickHouse/ClickHouse/pull/58705) ([zhongyuankai](https://github.com/zhongyuankai))。
* `ALTER MODIFY SETTING` による memory テーブル設定の変更をサポートしました。例: `ALTER TABLE memory MODIFY SETTING min_rows_to_keep = 100, max_rows_to_keep = 1000;`。[#62039](https://github.com/ClickHouse/ClickHouse/pull/62039) ([zhongyuankai](https://github.com/zhongyuankai))。
* HTTP インターフェイスに `role` クエリパラメータを追加しました。これは `SET ROLE x` と同様に動作し、ステートメントを実行する前にロールを適用します。これにより、HTTP インターフェイスでは複数ステートメントが許可されておらず、`SET ROLE x` とステートメント本体を同時に送信できないという制限を回避できます。この方法で複数ロールを設定することも可能です（例: `?role=x&role=y`）。これは `SET ROLE x, y` と同等です。[#62669](https://github.com/ClickHouse/ClickHouse/pull/62669) ([Serge Klochkov](https://github.com/slvrtrn))。
* テーブルのプライマリキーによるメモリ使用量を解放するための `SYSTEM UNLOAD PRIMARY KEY` を追加しました。[#62738](https://github.com/ClickHouse/ClickHouse/pull/62738) ([Pablo Marcos](https://github.com/pamarcos))。
* `system.text_log` に `value1`, `value2`, ..., `value10` カラムを追加しました。これらのカラムには、メッセージのフォーマットに使用された値が格納されます。[#59619](https://github.com/ClickHouse/ClickHouse/pull/59619) ([Alexey Katsman](https://github.com/alexkats))。
* 挿入時に割り当てられた、ブロック内での元の行番号を保持する永続的な仮想カラム `_block_offset` を追加しました。カラム `_block_offset` の永続化は、MergeTree 設定 `enable_block_offset_column` によって有効化できます。パーツの最小ブロック番号またはパーツのミューテーションバージョンのいずれかを保持する仮想カラム `_part_data_version` を追加しました。永続的な仮想カラム `_block_number` は、もはや実験的とは見なされません。[#60676](https://github.com/ClickHouse/ClickHouse/pull/60676) ([Anton Popov](https://github.com/CurtizJ))。
* 設定 `input_format_json_throw_on_bad_escape_sequence` を追加しました。これを無効にすると、JSON 入力形式で不正なエスケープシーケンスをそのまま保存できます。[#61889](https://github.com/ClickHouse/ClickHouse/pull/61889) ([Kruglov Pavel](https://github.com/Avogar))。



#### パフォーマンスの向上 {#performance-improvement-8}

* 同値集合を用いた JOIN フィルタのプッシュダウンの改善。 [#61216](https://github.com/ClickHouse/ClickHouse/pull/61216) ([Maksim Kita](https://github.com/kitaisreal)).
* `JOIN` の後のフィルタによって常にデフォルト値の行が除外される場合、`OUTER JOIN` を `INNER JOIN` に変換する最適化を行います。この最適化は設定 `query_plan_convert_outer_join_to_inner_join` で制御でき、デフォルトで有効になっています。[#62907](https://github.com/ClickHouse/ClickHouse/pull/62907) ([Maksim Kita](https://github.com/kitaisreal)).
* AWS S3 向けの改善です。クライアントはサーバーにヘッダー &#39;Keep-Alive: timeout=X&#39; を送信する必要があります。クライアントがそのヘッダーを含むサーバーからのレスポンスを受信した場合、サーバーから送られた値を使用する必要があります。また、クライアント側では、接続クローズ時のレースコンディションを避けるために、有効期限が近い接続は使用しないほうが望ましいです。 [#62249](https://github.com/ClickHouse/ClickHouse/pull/62249) ([Sema Checherinda](https://github.com/CheSema)).
* SELECT クエリに対するミューテーションのオーバーヘッドを削減 (v2)。 [#60856](https://github.com/ClickHouse/ClickHouse/pull/60856) ([Azat Khuzhin](https://github.com/azat)).
* PODArray でより頻繁に呼び出される関数が、強制的にインライン展開されるようになりました。 [#61144](https://github.com/ClickHouse/ClickHouse/pull/61144) ([李扬](https://github.com/taiyang-li))
* 必須列をすべて読み込み終えた時点でオブジェクトの残りの部分をスキップして JSON の解析を高速化。 [#62210](https://github.com/ClickHouse/ClickHouse/pull/62210) ([lgbo](https://github.com/lgbo-ustc)).
* file/s3/hdfs/url/... テーブル関数におけるファイルからの単純な INSERT SELECT クエリを改善。並列パースに使用されるスレッド数を制御するための個別の max&#95;parsing&#95;threads 設定を追加。[#62404](https://github.com/ClickHouse/ClickHouse/pull/62404) ([Kruglov Pavel](https://github.com/Avogar)).
* 関数 `to_utc_timestamp` と `from_utc_timestamp` は、約 2 倍高速になりました。[#62583](https://github.com/ClickHouse/ClickHouse/pull/62583) ([KevinyhZou](https://github.com/KevinyhZou))。
* `parseDateTimeOrNull`、`parseDateTimeOrZero`、`parseDateTimeInJodaSyntaxOrNull`、`parseDateTimeInJodaSyntaxOrZero` 関数は、入力の大半がパース不能な値である場合に、従来より大幅に高速 (10倍〜1000倍) に実行されるようになりました。 [#62634](https://github.com/ClickHouse/ClickHouse/pull/62634) ([LiuNeng](https://github.com/liuneng1994))。
* `system.query_cache` に対する SELECT クエリは、クエリキャッシュに多数のエントリ（例: 100,000 件超）が含まれている場合に、これまでよりも目に見えて高速になりました。 [#62671](https://github.com/ClickHouse/ClickHouse/pull/62671) ([Robert Schulze](https://github.com/rschu1ze)).
* ファイルシステムキャッシュでの競合を低減（パート3）：空き領域の予約を試行する際に、ロックなしでファイルシステムからの削除を実行。 [#61163](https://github.com/ClickHouse/ClickHouse/pull/61163) ([Kseniia Sumarokova](https://github.com/kssenii)).
* ファイルシステムキャッシュの動的なサイズ変更を高速化しました。 [#61723](https://github.com/ClickHouse/ClickHouse/pull/61723) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `INVALIDATE_QUERY` を使用する辞書ソースは、起動時に 2 回再読み込みされなくなりました。[#62050](https://github.com/ClickHouse/ClickHouse/pull/62050) ([vdimir](https://github.com/vdimir))。
* 主キーを含むブール式の後ろに冗長な `= 1` または `= 0` が追加された場合に、プライマリインデックスが使用されない問題を修正しました。例えば、`SELECT * FROM <table> WHERE <primary-key> IN (<value>) = 1` と `SELECT * FROM <table> WHERE <primary-key> NOT IN (<value>) = 0` は、本来プライマリインデックスを使用できるにもかかわらず、いずれもフルテーブルスキャンを行ってしまいます。 [#62142](https://github.com/ClickHouse/ClickHouse/pull/62142) ([josh-hildred](https://github.com/josh-hildred)).
* `system.remote_data_paths` からのチャンクを、全結果を 1 つの大きなチャンクに蓄積するのではなく、チャンクのストリームとして返すようにしました。これにより、メモリ使用量を抑えつつ、途中経過を表示し、クエリをキャンセルできるようになります。 [#62613](https://github.com/ClickHouse/ClickHouse/pull/62613) ([Alexander Gololobov](https://github.com/davenger)).



#### 実験的機能 {#experimental-feature-6}
* `azure_allow_parallel_part_upload` 設定で制御される Azure Blob Storage 向けの並列書き込みバッファをサポートしました。 [#62534](https://github.com/ClickHouse/ClickHouse/pull/62534) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* ユーザ空間ページキャッシュが静的 Web ストレージ（`disk(type = web)`）でも動作するようになりました。有効にするにはクライアント設定 `use_page_cache_for_disks_without_file_cache=1` を使用してください。 [#61911](https://github.com/ClickHouse/ClickHouse/pull/61911) ([Michael Kolupaev](https://github.com/al13n321)).
* `Variant` 型において Bool 型および数値型のバリアントを疑わしいものとして扱わないようにしました。 [#61999](https://github.com/ClickHouse/ClickHouse/pull/61999) ([Kruglov Pavel](https://github.com/Avogar)).
* パース処理を用いることで String から `Variant` への変換を改善しました。 [#62005](https://github.com/ClickHouse/ClickHouse/pull/62005) ([Kruglov Pavel](https://github.com/Avogar)).
* JSONExtract 関数で `Variant` をサポートしました。 [#62014](https://github.com/ClickHouse/ClickHouse/pull/62014) ([Kruglov Pavel](https://github.com/Avogar)).
* 型 `Variant` を比較可能としてマークし、主キーで使用できるようにしました。 [#62693](https://github.com/ClickHouse/ClickHouse/pull/62693) ([Kruglov Pavel](https://github.com/Avogar)).



#### 改善 {#improvement-8}

* 利便性のため、`SELECT * FROM numbers()` は、`SELECT * FROM system.numbers` と同様に、制限なしで動作するようになりました。 [#61969](https://github.com/ClickHouse/ClickHouse/pull/61969) ([YenchangChan](https://github.com/YenchangChan))。
* Kafka の設定に対して、コンシューマー / プロデューサー用の別々のタグを導入しました。これにより、コンシューマー向けのプロパティがプロデューサーインスタンスに、あるいはその逆に指定された場合に、librdkafka（多くのバグを抱えた品質の良くない C ライブラリ）から出る警告を防ぎます（例: `Configuration property session.timeout.ms is a consumer property and will be ignored by this producer instance`）。Closes: [#58983](https://github.com/ClickHouse/ClickHouse/issues/58983)。[#58956](https://github.com/ClickHouse/ClickHouse/pull/58956)（[Aleksandr Musorin](https://github.com/AVMusorin)）。
* 関数 `date_diff` と `age` は、結果をマイクロ秒精度ではなくナノ秒精度で計算するようになりました。また、`unit` パラメータに指定できる値として `nanosecond`（または `nanoseconds`、`ns`）も利用可能になりました。[#61409](https://github.com/ClickHouse/ClickHouse/pull/61409)（[Austin Kothig](https://github.com/kothiga)）。
* `date_trunc` にナノ秒、マイクロ秒、ミリ秒の単位を追加しました。 [#62335](https://github.com/ClickHouse/ClickHouse/pull/62335) ([Misz606](https://github.com/Misz606))。
* 証明書を再読み込みする際に、証明書チェーンも再読み込みするようにしました。 [#61671](https://github.com/ClickHouse/ClickHouse/pull/61671) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* レプリカパスにアクティブなレプリカが存在する場合は、そのレプリカパスに対するテーブルの ATTACH を許可しないことで、エラー [#60432](https://github.com/ClickHouse/ClickHouse/issues/60432) の発生を防ぐようにしました。[#61876](https://github.com/ClickHouse/ClickHouse/pull/61876)（[Arthur Passos](https://github.com/arthurpassos)）。
* `clickhouse-local` に `input` のサポートを実装。 [#61923](https://github.com/ClickHouse/ClickHouse/pull/61923) ([Azat Khuzhin](https://github.com/azat)).
* `strictness` が `ANY` の `Join` テーブルエンジンは、再読み込み後も結果が一貫するようになりました。同じキーを持つ複数行が挿入された場合、最初の行が優先されます（以前は、テーブル読み込み時にランダムに選択されていました）。[#51027](https://github.com/ClickHouse/ClickHouse/issues/51027) をクローズ。[#61972](https://github.com/ClickHouse/ClickHouse/pull/61972) ([vdimir](https://github.com/vdimir))。
* Apache Arrow スキーマから Nullable 列型を自動的に推論するようにしました。 [#61984](https://github.com/ClickHouse/ClickHouse/pull/61984) ([Maksim Kita](https://github.com/kitaisreal)).
* 集約処理中に集約状態の並列マージをキャンセルできるようにしました。例: `uniqExact`。 [#61992](https://github.com/ClickHouse/ClickHouse/pull/61992) ([Maksim Kita](https://github.com/kitaisreal)).
* `system.keywords` を使用してサジェストを補完し、内部のあらゆる箇所でもそれらを使用するようにします。 [#62000](https://github.com/ClickHouse/ClickHouse/pull/62000) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* `ReplicatedMergeTree` に対する `OPTIMIZE FINAL` は、現在進行中のマージ処理が完了するまで待機してから、最終マージのスケジューリングを再度試みるようになりました。これにより、通常の `MergeTree` の挙動により近づきます。 [#62067](https://github.com/ClickHouse/ClickHouse/pull/62067) ([Nikita Taranov](https://github.com/nickitat))。
* Hive のテキストファイルからデータを読み込む際、テキストファイルの最初の行を基に入力フィールド数を再設定していましたが、最初の行のフィールド数が Hive テーブルの定義と一致しない場合があります。例えば、Hive テーブルが `test_tbl(a Int32, b Int32, c Int32)` のように 3 カラムで定義されているにもかかわらず、テキストファイルの最初の行に 2 フィールドしかない場合、この状況では入力フィールド数は 2 に再設定されます。その後、テキストファイルの次の行に 3 フィールドが存在しても、3 番目のフィールドは読み取られず、デフォルト値の 0 が設定されてしまいますが、これは正しくありません。[#62086](https://github.com/ClickHouse/ClickHouse/pull/62086)（[KevinyhZou](https://github.com/KevinyhZou)）。
* `CREATE AS` はテーブルのコメントをコピーします。 [#62117](https://github.com/ClickHouse/ClickHouse/pull/62117) ([Pablo Marcos](https://github.com/pamarcos))。
* テーブル zookeeper にクエリの進行状況を追加。[#62152](https://github.com/ClickHouse/ClickHouse/pull/62152)（[JackyWoo](https://github.com/JackyWoo)）。
* トレースコレクタ（Real と CPU）をサーバー全体で有効化できるようにしました。 [#62189](https://github.com/ClickHouse/ClickHouse/pull/62189) ([alesapin](https://github.com/alesapin)).
* 設定 `lightweight_deletes_sync` を追加しました（デフォルト値: 2 - すべてのレプリカが同期的に処理を完了するまで待機）。これは設定 `mutations_sync` に似ていますが、軽量削除の動作にのみ影響します。 [#62195](https://github.com/ClickHouse/ClickHouse/pull/62195) ([Anton Popov](https://github.com/CurtizJ)).
* カスタム設定の値を解析する際に、ブール値と整数を区別するようにしました: `SET custom_a = true; SET custom_b = 1;`。 [#62206](https://github.com/ClickHouse/ClickHouse/pull/62206) ([Vitaly Baranov](https://github.com/vitlibar)).
* AWS PrivateLink インターフェイスエンドポイント経由での S3 アクセスに対応しました。[#60021](https://github.com/ClickHouse/ClickHouse/issues/60021)、[#31074](https://github.com/ClickHouse/ClickHouse/issues/31074)、[#53761](https://github.com/ClickHouse/ClickHouse/issues/53761) がクローズされました。[#62208](https://github.com/ClickHouse/ClickHouse/pull/62208)（[Arthur Passos](https://github.com/arthurpassos)）。
* 存在しない場合は、clickhouse-client で UDF 用のディレクトリを作成しなくなりました。これにより [#59597](https://github.com/ClickHouse/ClickHouse/issues/59597) が解決されました。[#62366](https://github.com/ClickHouse/ClickHouse/pull/62366)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* クエリキャッシュは、システムテーブル（`system.*`、`information_schema.*`、`INFORMATION_SCHEMA.*`）に対するクエリ結果をキャッシュしなくなりました。 [#62376](https://github.com/ClickHouse/ClickHouse/pull/62376) ([Robert Schulze](https://github.com/rschu1ze)).
* `MOVE PARTITION TO TABLE` クエリは、パーツ数の上限を超えないように遅延される場合や、`TOO_MANY_PARTS` 例外がスローされる場合があります。`INSERT` クエリと同様に、同じ設定および制限が適用されます（`max_parts_in_total`、`parts_to_delay_insert`、`parts_to_throw_insert`、`inactive_parts_to_throw_insert`、`inactive_parts_to_delay_insert`、`max_avg_part_size_for_too_many_parts`、`min_delay_to_insert_ms`、`max_delay_to_insert` 設定を参照）。[#62420](https://github.com/ClickHouse/ClickHouse/pull/62420)（[Sergei Trifonov](https://github.com/serxa)）。
* macOS におけるデフォルトのインストールディレクトリを `/usr/bin` から `/usr/local/bin` に変更しました。これは、macOS El Capitan（2015）で導入された Apple の System Integrity Protection により、`sudo` を使用しても `/usr/bin` へ書き込みできないようになっているためです。 [#62489](https://github.com/ClickHouse/ClickHouse/pull/62489) ([haohang](https://github.com/yokofly)).
* transform が常に最初の一致を返すようにしました。 [#62518](https://github.com/ClickHouse/ClickHouse/pull/62518) ([Raúl Marín](https://github.com/Algunenano))。
* システムテーブル `blob_storage_log` に不足していた `hostname` 列を追加しました。 [#62456](https://github.com/ClickHouse/ClickHouse/pull/62456) ([Jayme Bird](https://github.com/jaymebrd))。
* 他の system テーブルとの整合性を保つため、`system.backup_log` に `event_time` 列が追加されました。 [#62541](https://github.com/ClickHouse/ClickHouse/pull/62541) ([Jayme Bird](https://github.com/jaymebrd)).
* テーブル `system.backup_log` は、他の `_log` テーブルエンジンと同様に、`event_date, event_time` からなる「default」のソートキーを持つようになりました。 [#62667](https://github.com/ClickHouse/ClickHouse/pull/62667) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* `RESTORE` 実行時にテーブルの DEFAULT 式が評価されないようにしました。 [#62601](https://github.com/ClickHouse/ClickHouse/pull/62601) ([Vitaly Baranov](https://github.com/vitlibar)).
* S3 ストレージおよびバックアップについても、S3 ディスクと同じ既定の keep alive 設定が必要です。 [#62648](https://github.com/ClickHouse/ClickHouse/pull/62648) ([Sema Checherinda](https://github.com/CheSema)).
* 単一のテーブルを利用する複数のコンシューマからのログメッセージを区別できるようにするため、librdkafka（多くのバグで悪名高い C 言語ライブラリ）のクライアント識別子をログメッセージに追加しました。 [#62813](https://github.com/ClickHouse/ClickHouse/pull/62813) ([János Benjamin Antal](https://github.com/antaljanosbenjamin))。
* Replicated データベースの ZooKeeper パスで、特殊マクロ `{uuid}` および `{database}` を使用できるようにしました。 [#62818](https://github.com/ClickHouse/ClickHouse/pull/62818) ([Vitaly Baranov](https://github.com/vitlibar)).
* HTTP リクエストで異なる認証スキームでもクォータキーを使用できるようにしました。 [#62842](https://github.com/ClickHouse/ClickHouse/pull/62842) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `clickhouse client` および `clickhouse local` のコマンドライン引数 `--help` による出力の冗長性を減らしました。従来の出力は今後、`--help --verbose` によって生成されます。 [#62973](https://github.com/ClickHouse/ClickHouse/pull/62973) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
* `log_bin_use_v1_row_events` は MySQL 8.3 で削除され、これに合わせて実験的な `MaterializedMySQL` エンジンを調整しました [#60479](https://github.com/ClickHouse/ClickHouse/issues/60479)。[#63101](https://github.com/ClickHouse/ClickHouse/pull/63101)（[Eugene Klimov](https://github.com/Slach)）。著者: Nikolay Yankin。





#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-4}

* Rust の依存関係をベンダリングし、（遊び目的の小規模な機能に使っている）Rust コードを、C++ と同様にまともな方法でビルドできるようにしました。 [#62297](https://github.com/ClickHouse/ClickHouse/pull/62297) ([Raúl Marín](https://github.com/Algunenano)).
* ClickHouse は BoringSSL の代わりに OpenSSL 3.2 を使用するようになりました。 [#59870](https://github.com/ClickHouse/ClickHouse/pull/59870) ([Robert Schulze](https://github.com/rschu1ze))。なお、OpenSSL は一般的にエンジニアリング文化の面では劣っており（sanitizer のレポートが複数存在し、こちらでパッチを適用する必要があったり、生成ファイルを多用する複雑なビルドシステムであったりします）が、互換性はより優れています。
* ストレステストでは `DROP` クエリを 1/2 の確率で無視し、Memory/JOIN テーブルに対するアップグレードチェックでは `DROP` を無視する代わりに `TRUNCATE` を使用するようにしました。 [#61476](https://github.com/ClickHouse/ClickHouse/pull/61476) ([Kruglov Pavel](https://github.com/Avogar)).
* Keeper の Docker イメージから /etc/clickhouse-keeper および /var/log/clickhouse-keeper のボリュームを削除しました。 [#61683](https://github.com/ClickHouse/ClickHouse/pull/61683) ([Tristan](https://github.com/Tristan971)).
* Analyzerがデフォルトで有効になったことで関連性を失ったすべての問題に対するテストを追加しました。 解決: [#55794](https://github.com/ClickHouse/ClickHouse/issues/55794) 解決: [#49472](https://github.com/ClickHouse/ClickHouse/issues/49472) 解決: [#44414](https://github.com/ClickHouse/ClickHouse/issues/44414) 解決: [#13843](https://github.com/ClickHouse/ClickHouse/issues/13843) 解決: [#55803](https://github.com/ClickHouse/ClickHouse/issues/55803) 解決: [#48308](https://github.com/ClickHouse/ClickHouse/issues/48308) 解決: [#45535](https://github.com/ClickHouse/ClickHouse/issues/45535) 解決: [#44365](https://github.com/ClickHouse/ClickHouse/issues/44365) 解決: [#44153](https://github.com/ClickHouse/ClickHouse/issues/44153) 解決: [#42399](https://github.com/ClickHouse/ClickHouse/issues/42399) 解決: [#27115](https://github.com/ClickHouse/ClickHouse/issues/27115) 解決: [#23162](https://github.com/ClickHouse/ClickHouse/issues/23162) 解決: [#15395](https://github.com/ClickHouse/ClickHouse/issues/15395) 解決: [#15411](https://github.com/ClickHouse/ClickHouse/issues/15411) 解決: [#14978](https://github.com/ClickHouse/ClickHouse/issues/14978) 解決: [#17319](https://github.com/ClickHouse/ClickHouse/issues/17319) 解決: [#11813](https://github.com/ClickHouse/ClickHouse/issues/11813) 解決: [#13210](https://github.com/ClickHouse/ClickHouse/issues/13210) 解決: [#23053](https://github.com/ClickHouse/ClickHouse/issues/23053) 解決: [#37729](https://github.com/ClickHouse/ClickHouse/issues/37729) 解決: [#32639](https://github.com/ClickHouse/ClickHouse/issues/32639) 解決: [#9954](https://github.com/ClickHouse/ClickHouse/issues/9954) 解決: [#41964](https://github.com/ClickHouse/ClickHouse/issues/41964) 解決: [#54317](https://github.com/ClickHouse/ClickHouse/issues/54317) 解決: [#7520](https://github.com/ClickHouse/ClickHouse/issues/7520) 解決: [#36973](https://github.com/ClickHouse/ClickHouse/issues/36973) 解決: [#40955](https://github.com/ClickHouse/ClickHouse/issues/40955) 解決: [#19687](https://github.com/ClickHouse/ClickHouse/issues/19687) 解決: [#23104](https://github.com/ClickHouse/ClickHouse/issues/23104) 解決: [#21584](https://github.com/ClickHouse/ClickHouse/issues/21584) 解決: [#23344](https://github.com/ClickHouse/ClickHouse/issues/23344) 解決: [#22627](https://github.com/ClickHouse/ClickHouse/issues/22627) 解決: [#10276](https://github.com/ClickHouse/ClickHouse/issues/10276) 解決: [#19687](https://github.com/ClickHouse/ClickHouse/issues/19687) 解決: [#4567](https://github.com/ClickHouse/ClickHouse/issues/4567) 解決: [#17710](https://github.com/ClickHouse/ClickHouse/issues/17710) 解決: [#11068](https://github.com/ClickHouse/ClickHouse/issues/11068) 解決: [#24395](https://github.com/ClickHouse/ClickHouse/issues/24395) 解決: [#23416](https://github.com/ClickHouse/ClickHouse/issues/23416) 解決: [#23162](https://github.com/ClickHouse/ClickHouse/issues/23162) 解決: [#25655](https://github.com/ClickHouse/ClickHouse/issues/25655) 解決: [#11757](https://github.com/ClickHouse/ClickHouse/issues/11757) 解決: [#6571](https://github.com/ClickHouse/ClickHouse/issues/6571) 解決: [#4432](https://github.com/ClickHouse/ClickHouse/issues/4432) 解決: [#8259](https://github.com/ClickHouse/ClickHouse/issues/8259) 解決: [#9233](https://github.com/ClickHouse/ClickHouse/issues/9233) 解決: [#14699](https://github.com/ClickHouse/ClickHouse/issues/14699) 解決: [#27068](https://github.com/ClickHouse/ClickHouse/issues/27068) 解決: [#28687](https://github.com/ClickHouse/ClickHouse/issues/28687) 解決: [#28777](https://github.com/ClickHouse/ClickHouse/issues/28777) 解決: [#29734](https://github.com/ClickHouse/ClickHouse/issues/29734) 解決: [#61238](https://github.com/ClickHouse/ClickHouse/issues/61238) 解決: [#33825](https://github.com/ClickHouse/ClickHouse/issues/33825) 解決: [#35608](https://github.com/ClickHouse/ClickHouse/issues/35608) 解決: [#29838](https://github.com/ClickHouse/ClickHouse/issues/29838) 解決: [#35652](https://github.com/ClickHouse/ClickHouse/issues/35652) 解決: [#36189](https://github.com/ClickHouse/ClickHouse/issues/36189) 解決: [#39634](https://github.com/ClickHouse/ClickHouse/issues/39634) 解決: [#47432](https://github.com/ClickHouse/ClickHouse/issues/47432) 解決: [#54910](https://github.com/ClickHouse/ClickHouse/issues/54910) 解決: [#57321](https://github.com/ClickHouse/ClickHouse/issues/57321) 解決: [#59154](https://github.com/ClickHouse/ClickHouse/issues/59154) 解決: [#61014](https://github.com/ClickHouse/ClickHouse/issues/61014) 解決: [#61950](https://github.com/ClickHouse/ClickHouse/issues/61950) 解決: [#55647](https://github.com/ClickHouse/ClickHouse/issues/55647) 解決: [#61947](https://github.com/ClickHouse/ClickHouse/issues/61947). [#62185](https://github.com/ClickHouse/ClickHouse/pull/62185) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* アナライザで修正済み、または既に関連性がなくなった issue から、さらにテストを追加。 Closes: [#58985](https://github.com/ClickHouse/ClickHouse/issues/58985) Closes: [#59549](https://github.com/ClickHouse/ClickHouse/issues/59549) Closes: [#36963](https://github.com/ClickHouse/ClickHouse/issues/36963) Closes: [#39453](https://github.com/ClickHouse/ClickHouse/issues/39453) Closes: [#56521](https://github.com/ClickHouse/ClickHouse/issues/56521) Closes: [#47552](https://github.com/ClickHouse/ClickHouse/issues/47552) Closes: [#56503](https://github.com/ClickHouse/ClickHouse/issues/56503) Closes: [#59101](https://github.com/ClickHouse/ClickHouse/issues/59101) Closes: [#50271](https://github.com/ClickHouse/ClickHouse/issues/50271) Closes: [#54954](https://github.com/ClickHouse/ClickHouse/issues/54954) Closes: [#56466](https://github.com/ClickHouse/ClickHouse/issues/56466) Closes: [#11000](https://github.com/ClickHouse/ClickHouse/issues/11000) Closes: [#10894](https://github.com/ClickHouse/ClickHouse/issues/10894) Closes: [https://github.com/ClickHouse/ClickHouse/issues/448](https://github.com/ClickHouse/ClickHouse/issues/448) Closes: [#8030](https://github.com/ClickHouse/ClickHouse/issues/8030) Closes: [#32139](https://github.com/ClickHouse/ClickHouse/issues/32139) Closes: [#47288](https://github.com/ClickHouse/ClickHouse/issues/47288) Closes: [#50705](https://github.com/ClickHouse/ClickHouse/issues/50705) Closes: [#54511](https://github.com/ClickHouse/ClickHouse/issues/54511) Closes: [#55466](https://github.com/ClickHouse/ClickHouse/issues/55466) Closes: [#58500](https://github.com/ClickHouse/ClickHouse/issues/58500) Closes: [#39923](https://github.com/ClickHouse/ClickHouse/issues/39923) Closes: [#39855](https://github.com/ClickHouse/ClickHouse/issues/39855) Closes: [#4596](https://github.com/ClickHouse/ClickHouse/issues/4596) Closes: [#47422](https://github.com/ClickHouse/ClickHouse/issues/47422) Closes: [#33000](https://github.com/ClickHouse/ClickHouse/issues/33000) Closes: [#14739](https://github.com/ClickHouse/ClickHouse/issues/14739) Closes: [#44039](https://github.com/ClickHouse/ClickHouse/issues/44039) Closes: [#8547](https://github.com/ClickHouse/ClickHouse/issues/8547) Closes: [#22923](https://github.com/ClickHouse/ClickHouse/issues/22923) Closes: [#23865](https://github.com/ClickHouse/ClickHouse/issues/23865) Closes: [#29748](https://github.com/ClickHouse/ClickHouse/issues/29748) Closes: [#4222](https://github.com/ClickHouse/ClickHouse/issues/4222). [#62457](https://github.com/ClickHouse/ClickHouse/pull/62457) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* OpenSSL が動的リンクされている場合のビルドエラーを修正しました（注: これは通常はサポートされておらず、IBM の s390x プラットフォームにのみ必要です）。 [#62888](https://github.com/ClickHouse/ClickHouse/pull/62888) ([Harry Lee](https://github.com/HarryLeeIBM))。





#### バグ修正（公式安定版リリースにおけるユーザー可視の不具合） {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-6}

* クォーラム挿入トランザクションの取り消し時に発生するロジックエラーを修正。[#61953](https://github.com/ClickHouse/ClickHouse/pull/61953)（[Han Fei](https://github.com/hanfei1991)）。
* COUNT(*) で FILTER 句を使用した場合に発生するパーサーエラーを修正 [#61357](https://github.com/ClickHouse/ClickHouse/pull/61357) ([Duc Canh Le](https://github.com/canhld94))。
* `group_by_use_nulls`、grouping sets、analyzer、materialize/constant における論理エラーを修正 [#61567](https://github.com/ClickHouse/ClickHouse/pull/61567) ([Kruglov Pavel](https://github.com/Avogar))。
* 移動済みパーツを削除する前にマージをキャンセルするように変更 [#61610](https://github.com/ClickHouse/ClickHouse/pull/61610) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Apache Arrow における abort の問題を修正 [#61720](https://github.com/ClickHouse/ClickHouse/pull/61720) ([Kruglov Pavel](https://github.com/Avogar)).
* 特定のディスクに対応する正しいパス上で `convert_to_replicated` フラグを検索するようにしました [#61769](https://github.com/ClickHouse/ClickHouse/pull/61769) ([Kirill](https://github.com/kirillgarbar))。
* distributed&#95;foreground&#95;insert/distributed&#95;background&#95;insert&#95;batch における接続のデータ競合が発生する可能性を修正しました [#61867](https://github.com/ClickHouse/ClickHouse/pull/61867) ([Azat Khuzhin](https://github.com/azat)).
* 行ベースの入力形式でスキップできるように、CANNOT&#95;PARSE&#95;ESCAPE&#95;SEQUENCE エラーを解析エラーとして扱うようにした [#61883](https://github.com/ClickHouse/ClickHouse/pull/61883) ([Kruglov Pavel](https://github.com/Avogar)).
* http&#95;wait&#95;end&#95;of&#95;query が使用されている場合に、HTTP の出力フォーマットで例外メッセージを書き出す処理を修正 [#61951](https://github.com/ClickHouse/ClickHouse/pull/61951) ([Kruglov Pavel](https://github.com/Avogar))。
* LowCardinality と JSONExtact 関数を組み合わせた場合の正しい修正 [#61957](https://github.com/ClickHouse/ClickHouse/pull/61957)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* Row Policy に式がない場合に Engine Merge がクラッシュする [#61971](https://github.com/ClickHouse/ClickHouse/pull/61971)（[Ilya Golshtein](https://github.com/ilejn)）。
* WriteBufferAzureBlobStorage のデストラクタで発生する未処理の例外を修正 [#61988](https://github.com/ClickHouse/ClickHouse/pull/61988) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* ReplicatedMergeTree におけるカラム定義なしの CREATE TABLE を修正 [#62040](https://github.com/ClickHouse/ClickHouse/pull/62040) ([Azat Khuzhin](https://github.com/azat)).
* 複合シャーディングキー利用時の `optimize_skip_unused_shards_rewrite_in` を修正 [#62047](https://github.com/ClickHouse/ClickHouse/pull/62047) ([Azat Khuzhin](https://github.com/azat)).
* リダイレクト時に ReadWriteBufferFromHTTP が適切な Host ヘッダーを設定するようにしました [#62068](https://github.com/ClickHouse/ClickHouse/pull/62068) ([Sema Checherinda](https://github.com/CheSema))。
* 外部テーブルでデータ型 Bool をパースできなかった問題を修正 [#62115](https://github.com/ClickHouse/ClickHouse/pull/62115) ([Duc Canh Le](https://github.com/canhld94)).
* Analyzer: クエリパラメータの解決を修正 [#62186](https://github.com/ClickHouse/ClickHouse/pull/62186) ([Dmitry Novik](https://github.com/novikd))。
* 読み取り専用モード時のパーツの復元処理を修正 [#62207](https://github.com/ClickHouse/ClickHouse/pull/62207) ([Vitaly Baranov](https://github.com/vitlibar)).
* SQL UDF を含むインデックス定義で発生していたクラッシュを修正 [#62225](https://github.com/ClickHouse/ClickHouse/pull/62225) ([vdimir](https://github.com/vdimir))。
* analyzer での generateRandom における NULL のランダムシードを修正。 [#62248](https://github.com/ClickHouse/ClickHouse/pull/62248) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Distinct Transform における const 列の処理を正しく行うようにしました [#62250](https://github.com/ClickHouse/ClickHouse/pull/62250) ([Antonio Andelic](https://github.com/antonio2368)).
* FINAL 修飾子を含むクエリ向けの Parts Splitter を修正 [#62268](https://github.com/ClickHouse/ClickHouse/pull/62268)（[Nikita Taranov](https://github.com/nickitat)）。
* Analyzer: パラメータ化ビューへのエイリアス解決を修正 [#62274](https://github.com/ClickHouse/ClickHouse/pull/62274) ([Dmitry Novik](https://github.com/novikd)).
* Analyzer: 親スコープからの名前解決を修正 [#62281](https://github.com/ClickHouse/ClickHouse/pull/62281) ([Dmitry Novik](https://github.com/novikd))。
* nullable な非ネイティブ数値カラムに対する `argMax` を修正 [#62285](https://github.com/ClickHouse/ClickHouse/pull/62285) ([Raúl Marín](https://github.com/Algunenano))。
* Ordinary データベースにおけるマテリアライズドビューの BACKUP および RESTORE の動作を修正 [#62295](https://github.com/ClickHouse/ClickHouse/pull/62295) ([Vitaly Baranov](https://github.com/vitlibar)).
* Context 内のスカラーにおけるデータ競合を修正 [#62305](https://github.com/ClickHouse/ClickHouse/pull/62305) ([Kruglov Pavel](https://github.com/Avogar))。
* マテリアライズドビューの主キーを修正 [#62319](https://github.com/ClickHouse/ClickHouse/pull/62319) ([Murat Khairulin](https://github.com/mxwell)).
* マルチスレッドの `INSERT` パイプラインをサポートしていないテーブルに対しては構築しないようにしました [#62333](https://github.com/ClickHouse/ClickHouse/pull/62333) ([vdimir](https://github.com/vdimir))。
* 分散クエリで位置指定引数を扱う analyzer を修正 [#62362](https://github.com/ClickHouse/ClickHouse/pull/62362) ([flynn](https://github.com/ucasfl)).
* analyzer の Merge エンジンにおける additional&#95;table&#95;filters のフィルタープッシュダウンを修正 [#62398](https://github.com/ClickHouse/ClickHouse/pull/62398) ([Kruglov Pavel](https://github.com/Avogar))。
* analyzer で GLOBAL IN テーブルクエリを修正。 [#62409](https://github.com/ClickHouse/ClickHouse/pull/62409) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* パーティション書き込み時に s3/hdfs/azure エンジンで設定 truncate&#95;on&#95;insert/create&#95;new&#95;file&#95;on&#95;insert が反映されるようにしました [#62425](https://github.com/ClickHouse/ClickHouse/pull/62425) ([Kruglov Pavel](https://github.com/Avogar)).
* AzureBlobStorage のバックアップの復元パスを修正 [#62447](https://github.com/ClickHouse/ClickHouse/pull/62447) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
* SimpleSquashingChunksTransform を修正 [#62451](https://github.com/ClickHouse/ClickHouse/pull/62451) ([Nikita Taranov](https://github.com/nickitat))。
* ネストされたラムダ式のキャプチャを修正。 [#62462](https://github.com/ClickHouse/ClickHouse/pull/62462) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 再帰型を含む Protobuf 読み込み時のクラッシュを回避 [#62506](https://github.com/ClickHouse/ClickHouse/pull/62506) ([Raúl Marín](https://github.com/Algunenano)).
* 1 つのパーティションを自身に移動する処理で発生していたバグを修正 [#62524](https://github.com/ClickHouse/ClickHouse/pull/62524) ([helifu](https://github.com/helifu))。
* LIMIT句におけるスカラーサブクエリを修正 [#62567](https://github.com/ClickHouse/ClickHouse/pull/62567) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 実験的かつサポート対象外の Hive エンジンで発生していたセグメンテーションフォルトを修正しました。そもそもこのエンジンはあまり気に入っていませんが [#62578](https://github.com/ClickHouse/ClickHouse/pull/62578)（[Nikolay Degterinsky](https://github.com/evillique)）。
* groupArraySorted のメモリリークを修正 [#62597](https://github.com/ClickHouse/ClickHouse/pull/62597) ([Antonio Andelic](https://github.com/antonio2368))。
* largestTriangleThreeBuckets のクラッシュを修正 [#62646](https://github.com/ClickHouse/ClickHouse/pull/62646) ([Raúl Marín](https://github.com/Algunenano)).
* より高い解像度向けに tumble[Start,End] と hop[Start,End] を修正 [#62705](https://github.com/ClickHouse/ClickHouse/pull/62705) ([Jordi Villar](https://github.com/jrdi))。
* argMin/argMax コンビネータの状態を修正 [#62708](https://github.com/ClickHouse/ClickHouse/pull/62708) ([Raúl Marín](https://github.com/Algunenano)).
* キャッシュロック競合の最適化によりキャッシュ内の一時データ処理が失敗する問題を修正 [#62715](https://github.com/ClickHouse/ClickHouse/pull/62715) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 関数 `mergeTreeIndex` で発生するクラッシュを修正 [#62762](https://github.com/ClickHouse/ClickHouse/pull/62762)（[Anton Popov](https://github.com/CurtizJ)）。
* fix: update: ネストされたマテリアライズド列: サイズチェックの修正 [#62773](https://github.com/ClickHouse/ClickHouse/pull/62773) ([Eliot Hautefeuille](https://github.com/hileef)).
* analyzer を使用した CTE で FINAL 修飾子が考慮されない問題を修正 [#62811](https://github.com/ClickHouse/ClickHouse/pull/62811) ([Duc Canh Le](https://github.com/canhld94))。
* 関数 `formatRow` が `JSON` フォーマットおよび HTTP インターフェイス使用時にクラッシュする問題を修正 [#62840](https://github.com/ClickHouse/ClickHouse/pull/62840) ([Anton Popov](https://github.com/CurtizJ))。
* Azure: エンドポイントオブジェクトからの最終 URL の構築処理を修正 [#62850](https://github.com/ClickHouse/ClickHouse/pull/62850) ([Daniel Pozo Escalona](https://github.com/danipozo)).
* GCD コーデックを修正 [#62853](https://github.com/ClickHouse/ClickHouse/pull/62853) ([Nikita Taranov](https://github.com/nickitat)).
* ハイパーレクタングルにおける LowCardinality(Nullable) キーの問題を修正 [#62866](https://github.com/ClickHouse/ClickHouse/pull/62866) ([Amos Bird](https://github.com/amosbird))。
* 入力値が UInt32 を超える場合における Joda 構文での fromUnixtimestamp の問題を修正 [#62901](https://github.com/ClickHouse/ClickHouse/pull/62901) ([KevinyhZou](https://github.com/KevinyhZou))。
* sum(nullable) に対して optimize&#95;rewrite&#95;aggregate&#95;function&#95;with&#95;if を無効化しました [#62912](https://github.com/ClickHouse/ClickHouse/pull/62912) ([Raúl Marín](https://github.com/Algunenano)).
* ソーステーブルとカラム型が異なる StorageBuffer に対する PREWHERE を修正。 [#62916](https://github.com/ClickHouse/ClickHouse/pull/62916) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* キャッシュ内の一時データによるキャッシュキー用ディレクトリ作成失敗時の誤った処理を修正 [#62925](https://github.com/ClickHouse/ClickHouse/pull/62925) ([Kseniia Sumarokova](https://github.com/kssenii)).
* gRPC: IPv6 ピアとの接続時のクラッシュを修正 [#62978](https://github.com/ClickHouse/ClickHouse/pull/62978) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* レプリケーションフェッチ中に発生し得る CHECKSUM&#95;DOESNT&#95;MATCH（など）を修正 [#62987](https://github.com/ClickHouse/ClickHouse/pull/62987) ([Azat Khuzhin](https://github.com/azat)).
* キャッシュ内の一時データで未処理例外により終了してしまう問題を修正 [#62998](https://github.com/ClickHouse/ClickHouse/pull/62998) ([Kseniia Sumarokova](https://github.com/kssenii)).
* optimize&#95;rewrite&#95;aggregate&#95;function&#95;with&#95;if における暗黙的キャストを修正 [#62999](https://github.com/ClickHouse/ClickHouse/pull/62999) ([Raúl Marín](https://github.com/Algunenano))。
* ~RestorerFromBackup の未処理例外を修正 [#63040](https://github.com/ClickHouse/ClickHouse/pull/63040) ([Vitaly Baranov](https://github.com/vitlibar))。
* セカンダリクエリでは `GROUP BY` キーからサーバー定数を削除しないようにしました。 [#63047](https://github.com/ClickHouse/ClickHouse/pull/63047) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 関数 `abs` の単調性に関する誤った判定を修正 [#63097](https://github.com/ClickHouse/ClickHouse/pull/63097) ([Duc Canh Le](https://github.com/canhld94))。
* MongoDB エンジンで SSL ハンドシェイク用のサーバー名を設定 [#63122](https://github.com/ClickHouse/ClickHouse/pull/63122) ([Alexander Gololobov](https://github.com/davenger))。
* MongoDB のワイヤプロトコルバージョンチェックで、データベース名 &quot;config&quot; の代わりにユーザー指定のデータベースを使用するようにした [#63126](https://github.com/ClickHouse/ClickHouse/pull/63126) ([Alexander Gololobov](https://github.com/davenger))。



### <a id="243"></a> ClickHouse 24.3 LTS リリース, 2024-03-27 {#a-id243a-clickhouse-release-243-lts-2024-03-27}



#### アップグレード時の注意事項 {#upgrade-notes-1}

* `allow_experimental_analyzer` 設定はデフォルトで有効になっており、クエリ解析を互換性と機能面がより充実した新しい実装に切り替えます。「analyzer」機能は experimental ではなく beta とみなされます。従来の動作に戻したい場合は、`compatibility` を `24.2` に設定するか、`allow_experimental_analyzer` 設定を無効にしてください。[YouTube の動画を視聴する](https://www.youtube.com/watch?v=zhrOYQpgvkk)。
* ClickHouse は、通常は UTF-8 である String データ型に任意のバイナリデータを格納できます。一方、Parquet/ORC/Arrow の String は UTF-8 のみをサポートします。そのため、ClickHouse の String データ型に対して Arrow で使用するデータ型として、String か Binary かを選択できるようになっています。これは `output_format_parquet_string_as_string`、`output_format_orc_string_as_string`、`output_format_arrow_string_as_string` という設定で制御されます。Binary を使う方がより正確で互換性も高いものの、多くの場合はデフォルトで String を使用する方がユーザーの期待に合致します。Parquet/ORC/Arrow は lz4 や zstd を含む多くの圧縮方式をサポートしており、ClickHouse はそれらすべての圧縮方式をサポートしています。一部の性能の劣るツールは、高速な `lz4` 圧縮方式をサポートしていないため、デフォルトでは `zstd` を設定しています。これは `output_format_parquet_compression_method`、`output_format_orc_compression_method`、`output_format_arrow_compression_method` という設定で制御されます。Parquet と ORC についてはデフォルトを `zstd` に変更しましたが、Arrow については変更していません（低レベル用途向けであることを重視しているためです）。[#61817](https://github.com/ClickHouse/ClickHouse/pull/61817)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 新しい ClickHouse バージョンでは、関数 `geoDistance`、`greatCircleDistance`、`greatCircleAngle` は、すべての引数が Float64 の場合、内部計算および戻り値の型として 64 ビット倍精度浮動小数点データ型を使用します。この変更により、[#58476](https://github.com/ClickHouse/ClickHouse/issues/58476) が解決されます。以前のバージョンでは、これらの関数は常に Float32 を使用していました。`geo_distance_returns_float64_on_float64_arguments` を `false` に設定するか、`compatibility` を `24.2` 以前に設定することで、従来の動作に切り替えることができます。[#61848](https://github.com/ClickHouse/ClickHouse/pull/61848)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。[Geet Patel](https://github.com/geetptl) との共同作業。
* インメモリデータパーツはバージョン 23.5 から非推奨となり、バージョン 23.10 以降はサポートされていません。このリリースで、残っていたコードが削除されました。[#55186](https://github.com/ClickHouse/ClickHouse/issues/55186) および [#45409](https://github.com/ClickHouse/ClickHouse/issues/45409) の継続対応です。インメモリデータパーツは、バージョン 23.5 より前かつ、MergeTree テーブルに対して対応する SETTINGS を明示的に指定して手動で有効化した場合にのみ利用可能だったため、実際に使用されている可能性は低いと考えられます。インメモリデータパーツが存在するか確認するには、次のクエリを実行します: `SELECT part_type, count() FROM system.parts GROUP BY part_type ORDER BY part_type`。インメモリデータパーツの使用を無効化するには、`ALTER TABLE ... MODIFY SETTING min_bytes_for_compact_part = DEFAULT, min_rows_for_compact_part = DEFAULT` を実行します。古い ClickHouse リリースからアップグレードする前に、インメモリデータパーツが存在しないことをまず確認してください。インメモリデータパーツが存在する場合は、最初にそれらを無効化し、その後インメモリデータパーツがなくなるまで待ってからアップグレードを続行してください。[#61127](https://github.com/ClickHouse/ClickHouse/pull/61127) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* `system.zookeeper` テーブル内の列名を `duration_ms` から `duration_microseconds` に変更し、実際には持続時間がマイクロ秒単位であることを反映しました。 [#60774](https://github.com/ClickHouse/ClickHouse/pull/60774) ([Duc Canh Le](https://github.com/canhld94))。
* クエリレベル設定 `async_insert` と `deduplicate_blocks_in_dependent_materialized_views` が同時に有効になっている場合、受信される INSERT クエリを拒否します。この挙動は設定 `throw_if_deduplication_in_dependent_materialized_views_enabled_with_async_insert` によって制御されており、デフォルトで有効です。これは [https://github.com/ClickHouse/ClickHouse/pull/59699](https://github.com/ClickHouse/ClickHouse/pull/59699) の続きであり、[https://github.com/ClickHouse/ClickHouse/pull/59915](https://github.com/ClickHouse/ClickHouse/pull/59915) のブロッカーを解消するために必要な変更です。[#60888](https://github.com/ClickHouse/ClickHouse/pull/60888)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* ユーティリティ `clickhouse-copier` は GitHub 上の別リポジトリ [https://github.com/ClickHouse/copier](https://github.com/ClickHouse/copier) に移動されました。バンドルには同梱されなくなりましたが、引き続き個別にダウンロードして利用できます。これにより、次の issue がクローズされます: [#60734](https://github.com/ClickHouse/ClickHouse/issues/60734) これにより、次の issue がクローズされます: [#60540](https://github.com/ClickHouse/ClickHouse/issues/60540) これにより、次の issue がクローズされます: [#60250](https://github.com/ClickHouse/ClickHouse/issues/60250) これにより、次の issue がクローズされます: [#52917](https://github.com/ClickHouse/ClickHouse/issues/52917) これにより、次の issue がクローズされます: [#51140](https://github.com/ClickHouse/ClickHouse/issues/51140) これにより、次の issue がクローズされます: [#47517](https://github.com/ClickHouse/ClickHouse/issues/47517) これにより、次の issue がクローズされます: [#47189](https://github.com/ClickHouse/ClickHouse/issues/47189) これにより、次の issue がクローズされます: [#46598](https://github.com/ClickHouse/ClickHouse/issues/46598) これにより、次の issue がクローズされます: [#40257](https://github.com/ClickHouse/ClickHouse/issues/40257) これにより、次の issue がクローズされます: [#36504](https://github.com/ClickHouse/ClickHouse/issues/36504) これにより、次の issue がクローズされます: [#35485](https://github.com/ClickHouse/ClickHouse/issues/35485) これにより、次の issue がクローズされます: [#33702](https://github.com/ClickHouse/ClickHouse/issues/33702) これにより、次の issue がクローズされます: [#26702](https://github.com/ClickHouse/ClickHouse/issues/26702)。
* MySQL との互換性を高めるために、互換用エイリアス `locate` はデフォルトで引数 `(needle, haystack[, start_pos])` を受け付けるようになりました。以前の挙動である `(haystack, needle[, start_pos])` は、`function_locate_has_mysql_compatible_argument_order = 0` を設定することで元に戻せます。 [#61092](https://github.com/ClickHouse/ClickHouse/pull/61092) ([Robert Schulze](https://github.com/rschu1ze)).
* `MergeTree` テーブルの `ORDER BY` 句で `SimpleAggregateFunction` をデフォルトで禁止しました（`AggregateFunction` が禁止されているのと同様ですが、`SimpleAggregateFunction` が禁止される理由は、それらが比較不能なためです）。これらを許可するには `allow_suspicious_primary_key` を使用してください。 [#61399](https://github.com/ClickHouse/ClickHouse/pull/61399) ([Azat Khuzhin](https://github.com/azat)).
* `Ordinary` データベースエンジンは非推奨になりました。サーバーがこれを使用している場合、clickhouse-client で警告が表示されます。この変更により [#52229](https://github.com/ClickHouse/ClickHouse/issues/52229) がクローズされました。[#56942](https://github.com/ClickHouse/ClickHouse/pull/56942)（[shabroo](https://github.com/shabroo)）。



#### 新機能 {#new-feature-9}
* バックアップの読み書きで `zip` に加えて `tar` をサポートしました。[#59535](https://github.com/ClickHouse/ClickHouse/pull/59535) ([josh-hildred](https://github.com/josh-hildred)).
* S3 Express バケットのサポートを実装しました。[#59965](https://github.com/ClickHouse/ClickHouse/pull/59965) ([Nikita Taranov](https://github.com/nickitat)).
* 別のディスクからパーツをアタッチできるようにしました（ハードリンクではなくコピーを使用）。[#60112](https://github.com/ClickHouse/ClickHouse/pull/60112) ([Unalian](https://github.com/Unalian)).
* サイズ上限付きの `Memory` テーブル: `min_bytes_to_keep, max_bytes_to_keep, min_rows_to_keep, max_rows_to_keep` の各設定で制御されます。[#60612](https://github.com/ClickHouse/ClickHouse/pull/60612) ([Jake Bamrah](https://github.com/JakeBamrah)).
* 待機中クエリ数と実行中クエリ数に対する個別の制限を追加しました。`async_load_databases` により待機しているクエリ数を制限する新しいサーバー設定 `max_waiting_queries` を追加しました。既存の実行中クエリ数の制限には、待機中クエリは含まれなくなりました。[#61053](https://github.com/ClickHouse/ClickHouse/pull/61053) ([Sergei Trifonov](https://github.com/serxa)).
* パーサーに含まれるすべてのキーワードを保持するテーブル `system.keywords` を追加しました。主に、ファジングや構文ハイライトをより良くするために使用されます。[#51808](https://github.com/ClickHouse/ClickHouse/pull/51808) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* `ATTACH PARTITION ALL` をサポートしました。[#61107](https://github.com/ClickHouse/ClickHouse/pull/61107) ([Kirill Nikiforov](https://github.com/allmazz)).
* 新しい関数 `getClientHTTPHeader` を追加しました。これにより [#54665](https://github.com/ClickHouse/ClickHouse/issues/54665) がクローズされます。@lingtaolf との共著です。[#61820](https://github.com/ClickHouse/ClickHouse/pull/61820) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* `generate_series` をテーブル関数として追加しました（既存の `numbers` 関数に対する PostgreSQL 互換エイリアス）。この関数は自然数の等差数列からなるテーブルを生成します。[#59390](https://github.com/ClickHouse/ClickHouse/pull/59390) ([divanik](https://github.com/divanik)).
* `topK`/`topkWeighed` 用のモードを追加し、値の個数とその誤差を返せるようにしました。[#54508](https://github.com/ClickHouse/ClickHouse/pull/54508) ([UnamedRus](https://github.com/UnamedRus)).
* `DateTime` または `DateTime64` 型の値についてミリ秒部分を返す関数 `toMillisecond` を追加しました。[#60281](https://github.com/ClickHouse/ClickHouse/pull/60281) ([Shaun Struwig](https://github.com/Blargian)).
* clickhouse-server 向けに HTTP リダイレクトハンドラを設定できるようにしました。たとえば、`/` を Play UI にリダイレクトさせることができます。[#60390](https://github.com/ClickHouse/ClickHouse/pull/60390) ([Alexey Milovidov](https://github.com/alexey-milovidov)).



#### パフォーマンスの向上 {#performance-improvement-9}

* 不要で高コストなメモリコピーを省くために、`dotProduct` 関数を最適化しました。[#60928](https://github.com/ClickHouse/ClickHouse/pull/60928)（[Robert Schulze](https://github.com/rschu1ze)）。
* 256ビット整数の出力を30倍高速化。 [#61100](https://github.com/ClickHouse/ClickHouse/pull/61100) ([Raúl Marín](https://github.com/Algunenano)).
* テーブルのプライマリキーにほとんど役に立たないカラムが含まれている場合は、それらをメモリに保持しないでください。これは、新しい設定 `primary_key_ratio_of_unique_prefix_values_to_skip_suffix_columns` によって制御され、デフォルト値は `0.9` です。つまり、複合プライマリキーにおいて、あるカラムの値が全体の少なくとも 90% の行で変化する場合、そのカラム以降のカラムはメモリに読み込まれません。 [#60255](https://github.com/ClickHouse/ClickHouse/pull/60255) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* 複数の `Nullable` 列を扱う場合のシリアライズ済み集約メソッドの性能を向上しました。 [#55809](https://github.com/ClickHouse/ClickHouse/pull/55809) ([Amos Bird](https://github.com/amosbird)).
* Lazy が ALL JOIN のパフォーマンスを向上させるために JSON 出力を生成するようになりました。 [#58278](https://github.com/ClickHouse/ClickHouse/pull/58278) ([LiuNeng](https://github.com/liuneng1994)).
* AWS S3 などの外部サービスへの HTTP/HTTPS 接続を、あらゆる用途で再利用できるようにしました。レスポンスが 3xx や 4xx の場合でも同様です。 [#58845](https://github.com/ClickHouse/ClickHouse/pull/58845) ([Sema Checherinda](https://github.com/CheSema))。
* 集約関数 `argMin` / `argMax` / `any` / `anyLast` / `anyHeavy`、および `ORDER BY {u8/u16/u32/u64/i8/i16/u32/i64) LIMIT 1` クエリの改善。[#58640](https://github.com/ClickHouse/ClickHouse/pull/58640)（[Raúl Marín](https://github.com/Algunenano)）。
* カラムフィルタに対する単純な最適化。一部のケースでは、ピークメモリ使用量を元の44%まで削減できます。 [#59698](https://github.com/ClickHouse/ClickHouse/pull/59698) ([李扬](https://github.com/taiyang-li))。
* 結果型の実体型が数値型である場合に、`multiIf` 関数をカラムナ形式で実行します。 [#60384](https://github.com/ClickHouse/ClickHouse/pull/60384) ([李扬](https://github.com/taiyang-li))。
* ミューテックスを高速化（ほぼ 2 倍）。 [#60823](https://github.com/ClickHouse/ClickHouse/pull/60823) ([Azat Khuzhin](https://github.com/azat)).
* 分散クエリの終了時に複数の接続を並列にドレインするように変更。 [#60845](https://github.com/ClickHouse/ClickHouse/pull/60845) ([lizhuoyu5](https://github.com/lzydmxy)).
* `Nullable` な数値列または `Nullable` な文字列列間のデータ移動を最適化し、一部のマイクロベンチマークを改善しました。 [#60846](https://github.com/ClickHouse/ClickHouse/pull/60846) ([李扬](https://github.com/taiyang-li)).
* ファイルシステムキャッシュに対する操作におけるロック競合の影響が小さくなりました。 [#61066](https://github.com/ClickHouse/ClickHouse/pull/61066) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* 誤ったコンパイラの最適化を防ぐことで、ARRAY JOIN とその他の JOIN を最適化しました。[#61074](https://github.com/ClickHouse/ClickHouse/issues/61074) をクローズしました。 [#61075](https://github.com/ClickHouse/ClickHouse/pull/61075)（[李扬](https://github.com/taiyang-li)）。
* 構文エラーを含むクエリにおいて、`COLUMNS` マッチャーに正規表現が含まれている場合、その正規表現は本来一度だけコンパイルされるべきところ、パーサーのバックトラッキングのたびに毎回コンパイルされていました。これは根本的な誤りでした。コンパイル済みの正規表現は AST に格納されていました。しかし AST の A は「abstract（抽象）」を意味し、重量級オブジェクトを含むべきではありません。AST の一部はパース中に生成および破棄される可能性があり、大量のバックトラッキングを伴う場合もあります。これによりパース処理が低速化し、その結果として読み取り専用ユーザーによる DoS を許してしまいます。しかし主な問題は、これが fuzzer による進捗を妨げることです。 [#61543](https://github.com/ClickHouse/ClickHouse/pull/61543)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 単一の値に対する IN 演算子を最適化する新しい analyzer パスを追加しました。 [#61564](https://github.com/ClickHouse/ClickHouse/pull/61564) ([LiuNeng](https://github.com/liuneng1994)).
* DNSResolver は、解決済み IP アドレスの集合をシャッフルし、AWS S3 の複数エンドポイントを一様に利用できるようにします。 [#60965](https://github.com/ClickHouse/ClickHouse/pull/60965) ([Sema Checherinda](https://github.com/CheSema))。



#### 実験的機能 {#experimental-feature-7}
* Azure Blob Storage 向けの並列読み取りをサポートしました。これにより、実験的な Azure オブジェクトストレージのパフォーマンスが向上します。 [#61503](https://github.com/ClickHouse/ClickHouse/pull/61503) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* S3 と同様に、Azure Blob Storage 向けの非同期 `WriteBuffer` を追加しました。これにより、実験的な Azure オブジェクトストレージのパフォーマンスが向上します。 [#59929](https://github.com/ClickHouse/ClickHouse/pull/59929) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Azure Blob Storage を使用する際、バックアップ I/O にマネージド ID を使用するようにしました。さらに、存在しないコンテナを ClickHouse が作成しようとするのを防ぐための設定を追加しました。コンテナの作成にはストレージアカウントレベルでの権限が必要です。 [#61785](https://github.com/ClickHouse/ClickHouse/pull/61785) ([Daniel Pozo Escalona](https://github.com/danipozo)).
* 並列レプリカで `IN` 句のサブクエリを使用できるようにする設定 `parallel_replicas_allow_in_with_subquery = 1` を追加しました。 [#60950](https://github.com/ClickHouse/ClickHouse/pull/60950) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 「ゼロコピー」レプリケーションに関する変更: テーブルが削除されるとき、そのテーブルに関連するすべてのゼロコピー ロックを削除する必要があります。これらのロックを含むディレクトリも削除する必要があります。 [#57575](https://github.com/ClickHouse/ClickHouse/pull/57575) ([Sema Checherinda](https://github.com/CheSema)).



#### 改善 {#improvement-9}

* デフォルトのテーブルエンジンとして `MergeTree` を使うようにしました。 [#60524](https://github.com/ClickHouse/ClickHouse/pull/60524) ([Alexey Milovidov](https://github.com/alexey-milovidov))
* デフォルトで `output_format_pretty_row_numbers` を有効にしました。これにより使い勝手が向上します。 [#61791](https://github.com/ClickHouse/ClickHouse/pull/61791) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* 以前のバージョンでは、Pretty フォーマットでの一部の数値表示が十分に「きれい」ではありませんでした。 [#61794](https://github.com/ClickHouse/ClickHouse/pull/61794) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* `SHOW CREATE TABLE` クエリの結果など、結果セットに単一の値しか含まれない場合、Pretty 形式での長い値は途中で切り詰められなくなりました。 [#61795](https://github.com/ClickHouse/ClickHouse/pull/61795) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* `clickhouse-local` と同様に、`clickhouse-client` でも `--format` オプションのエイリアスとして `--output-format` オプションを受け付けるようになりました。これにより [#59848](https://github.com/ClickHouse/ClickHouse/issues/59848) がクローズされました。 [#61797](https://github.com/ClickHouse/ClickHouse/pull/61797) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* `stdout` が端末であり、出力フォーマットが指定されていない場合、`clickhouse-client` などのツールは対話モードと同様に、デフォルトで `PrettyCompact` を使用します。`clickhouse-client` と `clickhouse-local` は、入力および出力フォーマットに関するコマンドライン引数を一貫した方法で処理します。これにより [#61272](https://github.com/ClickHouse/ClickHouse/issues/61272) が解決されました。 [#61800](https://github.com/ClickHouse/ClickHouse/pull/61800) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* Pretty フォーマットで数値の桁グループをアンダースコアで区切って表示し、可読性を向上しました。これは新しい設定項目 `output_format_pretty_highlight_digit_groups` によって制御されます。 [#61802](https://github.com/ClickHouse/ClickHouse/pull/61802) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* `SYSTEM FLUSH DISTRIBUTED` によって初期の INSERT 設定を上書きできるようにしました。 [#61832](https://github.com/ClickHouse/ClickHouse/pull/61832) ([Azat Khuzhin](https://github.com/azat)).
* プロセッサのプロファイリング（ソートや集約などに費やした時間と入出力バイト数）をデフォルトで有効化。 [#61096](https://github.com/ClickHouse/ClickHouse/pull/61096) ([Azat Khuzhin](https://github.com/azat)).
* Filesystem データベースで、フォーマット拡張子のないファイルをサポートしました。 [#60795](https://github.com/ClickHouse/ClickHouse/pull/60795) ([Kruglov Pavel](https://github.com/Avogar)).
* すべてのフォーマット名の大文字・小文字を区別しないようにしました。たとえば、Tsv でも TSV でも tsv でも、あるいは rowbinary でも同じように扱われます。[#60420](https://github.com/ClickHouse/ClickHouse/pull/60420)（[豪肥肥](https://github.com/HowePa)）。今後もできれば正しく表記していただけるとありがたいです（例: `JSON` 😇 であって `Json` 🤮 ではなく）が、お好みの表記でも問題ありません。
* `distributed_ddl_output_mode` 設定に `none_only_active` モードを追加しました。 [#60340](https://github.com/ClickHouse/ClickHouse/pull/60340) ([Alexander Tokmakov](https://github.com/tavplubix)).
* 高度なダッシュボードで、複数系列の折れ線グラフの配色がわずかに改善されました。 [#60391](https://github.com/ClickHouse/ClickHouse/pull/60391) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Advanced ダッシュボードでは、スクロールしてもコントロールが常に表示されるようになりました。これにより、上までスクロールし直さずに新しいチャートを追加できます。 [#60692](https://github.com/ClickHouse/ClickHouse/pull/60692) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* マテリアライズドビューに対して `MODIFY COLUMN` クエリを実行する際は、すべてのカラムが存在することを確認するために内部テーブルの構造を確認してください。 [#47427](https://github.com/ClickHouse/ClickHouse/pull/47427) ([sunny](https://github.com/sunny19930321))。
* `String` 型と `Enum` 型は、配列、`UNION` クエリ、条件式など、同じコンテキストで使用できます。これにより [#60726](https://github.com/ClickHouse/ClickHouse/issues/60726) が解決されました。[#60727](https://github.com/ClickHouse/ClickHouse/pull/60727)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* クエリ処理のための外部データの構造内で Enum を宣言できるようにしました（これはクエリに対して提供できる、その場で作成される一時テーブルです）。 [#57857](https://github.com/ClickHouse/ClickHouse/pull/57857)（[Duc Canh Le](https://github.com/canhld94)）。
* マージ対象のパーツを選択する際に軽量削除行を考慮し、生成されるパーツのディスクサイズをより正確に見積もれるようにしました。 [#58223](https://github.com/ClickHouse/ClickHouse/pull/58223) ([Zhuo Qiu](https://github.com/jewelzqiu)).
* より多くのシステムテーブルのカラムにコメントを追加しました。[https://github.com/ClickHouse/ClickHouse/pull/58356](https://github.com/ClickHouse/ClickHouse/pull/58356) の続きです。[#59016](https://github.com/ClickHouse/ClickHouse/pull/59016)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* これにより `PREWHERE` で仮想カラムを使用できるようになりました。`_part_offset` のような非定数の仮想カラムに対して有効です。[#59033](https://github.com/ClickHouse/ClickHouse/pull/59033)（[Amos Bird](https://github.com/amosbird)）。仮想カラムの全体的な使い勝手が向上しました。`PREWHERE` で仮想カラムを使用することが許可されるようになりました（`_part_offset` のような非定数の仮想カラムに対して有効です）。また、設定 `describe_include_virtual_columns` を有効にした `DESCRIBE` クエリにおいて、カラムのコメントとして仮想カラムの組み込みドキュメントを参照できるようになりました。[#60205](https://github.com/ClickHouse/ClickHouse/pull/60205)（[Anton Popov](https://github.com/CurtizJ)）。
* 固定キーを使用する代わりに、オブジェクトストレージがオブジェクト削除可否を判定するためのキーを生成するようになりました。 [#59495](https://github.com/ClickHouse/ClickHouse/pull/59495) ([Sema Checherinda](https://github.com/CheSema)).
* オブジェクトストレージタイプとして「local&#95;blob&#95;storage」の代わりに「local」を許可できるようにした。 [#60165](https://github.com/ClickHouse/ClickHouse/pull/60165) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `DETACH`／サーバーシャットダウン時および `SYSTEM FLUSH DISTRIBUTED` 実行時に、Distributed エンジンの保留中の INSERT ブロックを並列でフラッシュするようにしました（並列実行は、そのテーブルにマルチディスクポリシーが設定されている場合にのみ機能します（現状の Distributed エンジン内のテーブルはすべてこれに該当します））。 [#60225](https://github.com/ClickHouse/ClickHouse/pull/60225) ([Azat Khuzhin](https://github.com/azat)).
* マージ時に read-through キャッシュを強制するための設定を追加しました。 [#60308](https://github.com/ClickHouse/ClickHouse/pull/60308) ([Kseniia Sumarokova](https://github.com/kssenii)).
* MySQL 互換プロトコルの改善。Issue [#57598](https://github.com/ClickHouse/ClickHouse/issues/57598) では、トランザクション処理に関する挙動の違いが指摘されています。アクティブなトランザクションが存在しない状態で発行された COMMIT/ROLLBACK 文が、MySQL の挙動とは異なりエラーとして報告されていました。[#60338](https://github.com/ClickHouse/ClickHouse/pull/60338)（[PapaToemmsn](https://github.com/PapaToemmsn)）。
* `substring` 関数に新しいエイリアス `byteSlice` が追加されました。 [#60494](https://github.com/ClickHouse/ClickHouse/pull/60494) ([Robert Schulze](https://github.com/rschu1ze)).
* あいまいさを減らすため、サーバー設定 `dns_cache_max_size` の名称を `dns_cache_max_entries` に変更しました。 [#60500](https://github.com/ClickHouse/ClickHouse/pull/60500) ([Kirill Nikiforov](https://github.com/allmazz)).
* `SHOW INDEX | INDEXES | INDICES | KEYS` は、もはやプライマリキー列でソートしなくなりました（この動作は直感的ではありませんでした）。[#60514](https://github.com/ClickHouse/ClickHouse/pull/60514)（[Robert Schulze](https://github.com/rschu1ze)）。
* Keeper の改善点: データ損失を防ぐため、不正なスナップショットが検出された場合は起動時に異常終了するようにしました。 [#60537](https://github.com/ClickHouse/ClickHouse/pull/60537) ([Antonio Andelic](https://github.com/antonio2368)).
* tzdata を 2024a に更新しました。 [#60768](https://github.com/ClickHouse/ClickHouse/pull/60768) ([Raúl Marín](https://github.com/Algunenano)).
* Keeper の改善: 設定で `leadership_expiry_ms` をサポートするようにしました。 [#60806](https://github.com/ClickHouse/ClickHouse/pull/60806) ([Brokenice0415](https://github.com/Brokenice0415)).
* 設定 `input_format_try_infer_exponent_floats` に関わらず、JSON フォーマットで指数表記の数値を常に推論するようにしました。JSON オブジェクトから Named Tuple を推論する際に、例外をスローする代わりに曖昧なパスに String 型を使用できるようにする設定 `input_format_json_use_string_type_for_ambiguous_paths_in_named_tuples_inference_from_objects` を追加しました。 [#60808](https://github.com/ClickHouse/ClickHouse/pull/60808) ([Kruglov Pavel](https://github.com/Avogar)).
* MySQL で一般的に使用される `START TRANSACTION` 構文のサポートを追加し、[https://github.com/ClickHouse/ClickHouse/discussions/60865](https://github.com/ClickHouse/ClickHouse/discussions/60865) を解決しました。[#60886](https://github.com/ClickHouse/ClickHouse/pull/60886)（[Zach Naimon](https://github.com/ArctypeZach)）。
* `null` を最大値または最小値として扱えるように、full-sorting merge join アルゴリズム向けのフラグを追加しました。これにより、Apache Spark などの他の SQL システムと動作の互換性を持たせることができます。 [#60896](https://github.com/ClickHouse/ClickHouse/pull/60896) ([loudongfeng](https://github.com/loudongfeng)).
* `clickhouse-client` と `clickhouse-local` で、ファイル拡張子から出力フォーマットを自動判別できるようにしました。 [#61036](https://github.com/ClickHouse/ClickHouse/pull/61036) ([豪肥肥](https://github.com/HowePa)).
* Linux の cgroup 値が変更された場合に、実行時にメモリ制限を更新するようになりました。 [#61049](https://github.com/ClickHouse/ClickHouse/pull/61049) ([Han Fei](https://github.com/hanfei1991)).
* 誤って追加漏れとなっていた関数 `toUInt128OrZero` を追加しました（このミスは [https://github.com/ClickHouse/ClickHouse/pull/945](https://github.com/ClickHouse/ClickHouse/pull/945) に関連しています）。互換性エイリアスである `FROM_UNIXTIME` と `DATE_FORMAT`（これらは ClickHouse 固有のものではなく、MySQL 互換性のためだけに存在します）を、SQL 互換エイリアスに求められるとおり、大文字小文字を区別しないようにしました。 [#61114](https://github.com/ClickHouse/ClickHouse/pull/61114)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* アクセスチェックを改善し、対象ユーザーが（より広い権限に包含されているだけで）取り消し対象の権限自体は個別には保持していない場合でも、その権限を取り消せるようにしました。例: `GRANT SELECT ON *.* TO user1; REVOKE SELECT ON system.* FROM user1;`。[#61115](https://github.com/ClickHouse/ClickHouse/pull/61115)（[pufit](https://github.com/pufit)）。
* `Nullable` 列に対する `has()` 関数の動作を修正（[#60214](https://github.com/ClickHouse/ClickHouse/issues/60214) を修正）。[#61249](https://github.com/ClickHouse/ClickHouse/pull/61249)（[Mikhail Koviazin](https://github.com/mkmkme)）。
* 現在、サブツリー `<include from_zk="/path" merge="true">` に対する設定の置換で、属性 `merge="true"` を指定できるようになりました。\
  この属性が指定されている場合、ClickHouse はサブツリーを既存の設定とマージします。指定されていない場合のデフォルト動作は、新しい内容を設定に追記することです。 [#61299](https://github.com/ClickHouse/ClickHouse/pull/61299) ([alesapin](https://github.com/alesapin))。
* 仮想メモリマッピング用の非同期メトリクス `VMMaxMapCount` と `VMNumMaps` を追加。 [#60662](https://github.com/ClickHouse/ClickHouse/issues/60662) をクローズ。 [#61354](https://github.com/ClickHouse/ClickHouse/pull/61354)（[Tuan Pham Anh](https://github.com/tuanpavn)）。
* 一時データを作成するすべての箇所で `temporary_files_codec` 設定を使用するようにしました。たとえば、外部メモリでのソートや外部メモリでの GROUP BY などです。以前は `partial_merge` JOIN アルゴリズムでのみ機能していました。 [#61456](https://github.com/ClickHouse/ClickHouse/pull/61456) ([Maksim Kita](https://github.com/kitaisreal))。
* クエリパースの複雑さを制限できる新しい設定 `max_parser_backtracks` を追加。 [#61502](https://github.com/ClickHouse/ClickHouse/pull/61502)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* ファイルシステムキャッシュの動的リサイズ時の競合を軽減。 [#61524](https://github.com/ClickHouse/ClickHouse/pull/61524) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 今後書き換えられる予定のため、StorageS3 queue の sharded モードを禁止しました。 [#61537](https://github.com/ClickHouse/ClickHouse/pull/61537) ([Kseniia Sumarokova](https://github.com/kssenii)).
* タイプミスを修正し、`use_leagcy_max_level` を `use_legacy_max_level` に変更しました。 [#61545](https://github.com/ClickHouse/ClickHouse/pull/61545) ([William Schoeffel](https://github.com/wiledusc))。
* `system.blob_storage_log` 内の重複エントリをいくつか削除しました。 [#61622](https://github.com/ClickHouse/ClickHouse/pull/61622) ([YenchangChan](https://github.com/YenchangChan)).
* MySQL 互換のために `current_user` 関数を互換エイリアスとして追加しました。 [#61770](https://github.com/ClickHouse/ClickHouse/pull/61770) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* x86-64 / ARM 混在クラスタにおける浮動小数点の集約関数状態の不整合を修正 [#60610](https://github.com/ClickHouse/ClickHouse/pull/60610) ([Harry Lee](https://github.com/HarryLeeIBM)).



#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-5}
* リアルタイムクエリプロファイラが AArch64 でも動作するようになりました。以前のバージョンでは、プログラムが syscall 内で時間を費やしていない場合にのみ動作していました。 [#60807](https://github.com/ClickHouse/ClickHouse/pull/60807) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* ClickHouse のバージョンが Docker ラベルに追加されました。これにより [#54224](https://github.com/ClickHouse/ClickHouse/issues/54224) がクローズされました。 [#60949](https://github.com/ClickHouse/ClickHouse/pull/60949) ([Nikolay Monkov](https://github.com/nikmonkov)).
* `prqlc` を 0.11.3 にアップグレードしました。 [#60616](https://github.com/ClickHouse/ClickHouse/pull/60616) ([Maximilian Roos](https://github.com/max-sixty)).
* `clickhouse-local` に汎用的なクエリテキストファザーを追加しました。 [#61508](https://github.com/ClickHouse/ClickHouse/pull/61508) ([Alexey Milovidov](https://github.com/alexey-milovidov)).



#### バグ修正（公式安定版リリースにおけるユーザー可視の不具合） {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-7}

* MergeTree において finished&#95;mutations&#95;to&#95;keep=0 の動作を修正（ドキュメントでは 0 はすべてを保持することを意味するとされているため）[#60031](https://github.com/ClickHouse/ClickHouse/pull/60031)（[Azat Khuzhin](https://github.com/azat)）。
* FINAL 最適化に問題がありました。著者は次のように述べています: &quot;PartsSplitter invalid ranges for the same part&quot;. [#60041](https://github.com/ClickHouse/ClickHouse/pull/60041) ([Maksim Kita](https://github.com/kitaisreal)).
* 実験的機能でありサポート対象外の Apache Hive に不具合がありました。[#60262](https://github.com/ClickHouse/ClickHouse/pull/60262) ([shanfengp](https://github.com/Aed-p)).
* 実験的な parallel replicas 機能に対する改善: parallel replicas が変更された場合に再解析を強制するようにしました [#60362](https://github.com/ClickHouse/ClickHouse/pull/60362) ([Raúl Marín](https://github.com/Algunenano))。
* 新しいディスク構成オプションにおける plain メタデータ型の扱いを修正 [#60396](https://github.com/ClickHouse/ClickHouse/pull/60396)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* mapContainsKeyLike における論理エラー「Cannot capture column because it has incompatible type」を修正 [#60451](https://github.com/ClickHouse/ClickHouse/pull/60451)（[Kruglov Pavel](https://github.com/Avogar)）。
* CREATE TABLE のスカラーサブクエリを計算しないようにしました。 [#60464](https://github.com/ClickHouse/ClickHouse/pull/60464) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* エラーにより多数の行がスキップされる場合の並列パース時に発生するデッドロックを修正 [#60516](https://github.com/ClickHouse/ClickHouse/pull/60516) ([Kruglov Pavel](https://github.com/Avogar)).
* 実験的な KQL (Kusto) サポートに不具合があったため、`max_query_size_for_kql_compound_operator` を修正しました: [#60534](https://github.com/ClickHouse/ClickHouse/pull/60534) ([Yong Wang](https://github.com/kashwy))。
* Keeper の修正：コミットログの待機にタイムアウトを追加 [#60544](https://github.com/ClickHouse/ClickHouse/pull/60544) ([Antonio Andelic](https://github.com/antonio2368))。
* 日付型に対して数値に関するヒントを出力しないようにしました [#60577](https://github.com/ClickHouse/ClickHouse/pull/60577) ([Raúl Marín](https://github.com/Algunenano))。
* フィルタで非決定的関数を使用する場合の MergeTree からの読み取りを修正 [#60586](https://github.com/ClickHouse/ClickHouse/pull/60586) ([Kruglov Pavel](https://github.com/Avogar))。
* 不正な互換性設定値型に起因する論理エラーを修正 [#60596](https://github.com/ClickHouse/ClickHouse/pull/60596) ([Kruglov Pavel](https://github.com/Avogar)).
* fix(prql): 堅牢なパニックハンドラ [#60615](https://github.com/ClickHouse/ClickHouse/pull/60615) ([Maximilian Roos](https://github.com/max-sixty)).
* `intDiv` の decimal 型および date 型の引数に対する処理を修正 [#60672](https://github.com/ClickHouse/ClickHouse/pull/60672) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* 修正: ALTER MODIFY クエリで CTE を展開 [#60682](https://github.com/ClickHouse/ClickHouse/pull/60682) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Atomic/Ordinary 以外のデータベースエンジン（例: Memory）向けの system.parts を修正 [#60689](https://github.com/ClickHouse/ClickHouse/pull/60689) ([Azat Khuzhin](https://github.com/azat))。
* パラメータ化ビューで発生する &quot;Invalid storage definition in metadata file&quot; エラーを修正 [#60708](https://github.com/ClickHouse/ClickHouse/pull/60708) ([Azat Khuzhin](https://github.com/azat)).
* CompressionCodecMultiple のバッファオーバーフローを修正 [#60731](https://github.com/ClickHouse/ClickHouse/pull/60731) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* SQL/JSON から無効な値を除去 [#60738](https://github.com/ClickHouse/ClickHouse/pull/60738) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* 集約関数 quantileGK から不正なアサーションを削除 [#60740](https://github.com/ClickHouse/ClickHouse/pull/60740) ([李扬](https://github.com/taiyang-li))。
* streams を 1 に設定して insert-select および insert&#95;deduplication&#95;token のバグを修正 [#60745](https://github.com/ClickHouse/ClickHouse/pull/60745)（[Jordi Villar](https://github.com/jrdi)）。
* サポートされていないマルチパートアップロード操作でカスタムメタデータヘッダーを設定できないようにしました [#60748](https://github.com/ClickHouse/ClickHouse/pull/60748) ([Francisco J. Jurado Moreno](https://github.com/Beetelbrox)).
* toStartOfInterval 関数を修正 [#60763](https://github.com/ClickHouse/ClickHouse/pull/60763) ([Andrey Zvonov](https://github.com/zvonand)).
* arrayEnumerateRanked で発生するクラッシュを修正 [#60764](https://github.com/ClickHouse/ClickHouse/pull/60764) ([Raúl Marín](https://github.com/Algunenano))。
* INSERT SELECT JOIN で `input()` を使用した際に発生するクラッシュの不具合を修正 [#60765](https://github.com/ClickHouse/ClickHouse/pull/60765) ([Kruglov Pavel](https://github.com/Avogar))。
* サブクエリで異なる allow&#95;experimental&#95;analyzer の値を使用した際にクラッシュする問題を修正 [#60770](https://github.com/ClickHouse/ClickHouse/pull/60770) ([Dmitry Novik](https://github.com/novikd))。
* S3 からの読み取り時の再帰処理を削除 [#60849](https://github.com/ClickHouse/ClickHouse/pull/60849) ([Antonio Andelic](https://github.com/antonio2368))。
* HashedDictionaryParallelLoader でエラー時にハングアップする可能性がある不具合を修正 [#60926](https://github.com/ClickHouse/ClickHouse/pull/60926) ([vdimir](https://github.com/vdimir))。
* Replicated データベースにおける非同期 RESTORE の修正（実験的機能） [#60934](https://github.com/ClickHouse/ClickHouse/pull/60934) ([Antonio Andelic](https://github.com/antonio2368))。
* ネイティブプロトコル経由での `Log` テーブルへの非同期インサート時に発生するデッドロックを修正 [#61055](https://github.com/ClickHouse/ClickHouse/pull/61055) ([Anton Popov](https://github.com/CurtizJ)).
* RangeHashedDictionary における dictGetOrDefault のデフォルト引数の遅延実行の問題を修正 [#61196](https://github.com/ClickHouse/ClickHouse/pull/61196) ([Kruglov Pavel](https://github.com/Avogar))。
* groupArraySorted の複数の不具合を修正 [#61203](https://github.com/ClickHouse/ClickHouse/pull/61203) ([Raúl Marín](https://github.com/Algunenano))。
* スタンドアロンバイナリにおける Keeper の再設定を修正 [#61233](https://github.com/ClickHouse/ClickHouse/pull/61233) ([Antonio Andelic](https://github.com/antonio2368))。
* S3 エンジンにおける `session_token` の扱いを修正 [#61234](https://github.com/ClickHouse/ClickHouse/pull/61234) ([Kruglov Pavel](https://github.com/Avogar)).
* 集約関数 `uniqExact` が誤った結果を返す可能性のある問題を修正 [#61257](https://github.com/ClickHouse/ClickHouse/pull/61257) ([Anton Popov](https://github.com/CurtizJ))。
* SHOW DATABASE のバグを修正 [#61269](https://github.com/ClickHouse/ClickHouse/pull/61269) ([Raúl Marín](https://github.com/Algunenano))。
* RabbitMQ ストレージの MATERIALIZED 列に関する論理エラーを修正 [#61320](https://github.com/ClickHouse/ClickHouse/pull/61320) ([vdimir](https://github.com/vdimir)).
* CREATE OR REPLACE DICTIONARY を修正 [#61356](https://github.com/ClickHouse/ClickHouse/pull/61356) ([Vitaly Baranov](https://github.com/vitlibar))。
* 外部の ON CLUSTER を使用する ATTACH クエリを修正 [#61365](https://github.com/ClickHouse/ClickHouse/pull/61365) ([Nikolay Degterinsky](https://github.com/evillique))。
* Nullable キーに対する連続キー最適化の不具合を修正 [#61393](https://github.com/ClickHouse/ClickHouse/pull/61393) ([Anton Popov](https://github.com/CurtizJ)).
* Actions DAG の分割に起因する問題を修正 [#61458](https://github.com/ClickHouse/ClickHouse/pull/61458) ([Raúl Marín](https://github.com/Algunenano))。
* 失敗した RESTORE の終了処理を修正 [#61466](https://github.com/ClickHouse/ClickHouse/pull/61466) ([Vitaly Baranov](https://github.com/vitlibar))。
* 互換性設定を使用して async&#95;insert&#95;use&#95;adaptive&#95;busy&#95;timeout を正しく無効化する [#61468](https://github.com/ClickHouse/ClickHouse/pull/61468) ([Raúl Marín](https://github.com/Algunenano)).
* restore プールでのキューイングを許可 [#61475](https://github.com/ClickHouse/ClickHouse/pull/61475) ([Nikita Taranov](https://github.com/nickitat))。
* UUID を使用して system.parts を読み取る際の不整合を修正。 [#61479](https://github.com/ClickHouse/ClickHouse/pull/61479) ([Dan Wu](https://github.com/wudanzy)).
* ALTER QUERY MODIFY SQL SECURITY を修正 [#61480](https://github.com/ClickHouse/ClickHouse/pull/61480) ([pufit](https://github.com/pufit))。
* ウィンドウビュー（実験的機能）で発生していたクラッシュを修正 [#61526](https://github.com/ClickHouse/ClickHouse/pull/61526) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* 非ネイティブ整数値を扱う `repeat` の不具合を修正 [#61527](https://github.com/ClickHouse/ClickHouse/pull/61527) ([Antonio Andelic](https://github.com/antonio2368)).
* クライアントの`-s`引数を修正 [#61530](https://github.com/ClickHouse/ClickHouse/pull/61530) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
* arrayPartialReverseSort のクラッシュを修正 [#61539](https://github.com/ClickHouse/ClickHouse/pull/61539) ([Raúl Marín](https://github.com/Algunenano))。
* const position を指定した文字列検索の不具合を修正 [#61547](https://github.com/ClickHouse/ClickHouse/pull/61547) ([Antonio Andelic](https://github.com/antonio2368)).
* DateTime64 で使用したときにエラーが発生していた addDays を修正 [#61561](https://github.com/ClickHouse/ClickHouse/pull/61561) ([Shuai li](https://github.com/loneylee)).
* JSONExtract で LowCardinality 型の入力を不許可にする [#61617](https://github.com/ClickHouse/ClickHouse/pull/61617) ([Julia Kartseva](https://github.com/jkartseva))。
* 重複排除を伴う非同期挿入に対する `system.part_log` の修正 [#61620](https://github.com/ClickHouse/ClickHouse/pull/61620) ([Antonio Andelic](https://github.com/antonio2368))。
* system.parts での `Non-ready set` 例外を修正。[#61666](https://github.com/ClickHouse/ClickHouse/pull/61666)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* REPLACE&#95;RANGE における actual&#95;part&#95;name を修正 (`Entry actual part isn't empty yet`) [#61675](https://github.com/ClickHouse/ClickHouse/pull/61675) ([Alexander Tokmakov](https://github.com/tavplubix)).
* 不正な UTF-8 に関する `multiSearchAllPositionsCaseInsensitiveUTF8` の sanitizer からのレポートを修正 [#61749](https://github.com/ClickHouse/ClickHouse/pull/61749)（[pufit](https://github.com/pufit)）。
* Nullable カラムで RANGE フレームがサポートされていないという不具合を修正。 [#61766](https://github.com/ClickHouse/ClickHouse/pull/61766) ([YuanLiu](https://github.com/ditgittube)).



### <a id="242"></a> ClickHouse リリース 24.2, 2024-02-29 {#a-id242a-clickhouse-release-242-2024-02-29}

#### 後方互換性のない変更 {#backward-incompatible-change-8}
* ネストした型内の疑わしい/実験的なデータ型を検証するようにしました。以前は、Array/Tuple/Map のようなネストした型内では、そのような型（JSON を除く）を検証していませんでした。[#59385](https://github.com/ClickHouse/ClickHouse/pull/59385)（[Kruglov Pavel](https://github.com/Avogar)）。
* スレッド数とブロックサイズに対する妥当性チェックを追加しました。[#60138](https://github.com/ClickHouse/ClickHouse/pull/60138)（[Raúl Marín](https://github.com/Algunenano)）。
* デフォルトでは指数表記の浮動小数点数を推論しないようにしました。以前の動作を復元する設定 `input_format_try_infer_exponent_floats` を追加しました（デフォルトは無効）。[#59476](https://github.com/ClickHouse/ClickHouse/issues/59476) をクローズします。[#59500](https://github.com/ClickHouse/ClickHouse/pull/59500)（[Kruglov Pavel](https://github.com/Avogar)）。
* ALTER 操作を丸括弧で囲めるようにしました。括弧の出力は設定 `format_alter_operations_with_parentheses` で制御できます。デフォルトでは、フォーマット済みクエリにおいて括弧は出力されます。これは、フォーマット済みの ALTER 操作をメタデータ（例: ミューテーション）として一部の箇所に保存しているためです。この新しい構文により、ALTER 操作がリストで終わる一部のクエリが明確になります。例: `ALTER TABLE x MODIFY TTL date GROUP BY a, b, DROP COLUMN c` は、旧構文では正しくパースできません。新しい構文では、クエリ `ALTER TABLE x (MODIFY TTL date GROUP BY a, b), (DROP COLUMN c)` は明確です。旧バージョンはこの新しい構文を読み取れないため、新しい構文を使用すると、単一のクラスター内で新旧バージョンの ClickHouse を混在させている場合に問題が発生する可能性があります。[#59532](https://github.com/ClickHouse/ClickHouse/pull/59532)（[János Benjamin Antal](https://github.com/antaljanosbenjamin)）。
* マテリアライズドビューに関するセキュリティ問題を修正しました。この問題により、ユーザーは必要な権限なしにテーブルへ挿入できていました。この修正では、ユーザーがマテリアライズドビューだけでなく、その背後にあるすべてのテーブルへの挿入権限も持っているかを検証します。これは、以前は動作していた一部のクエリが、現在は `Not enough privileges` で失敗し得ることを意味します。この問題に対処するため、本リリースではビュー向けの新機能として SQL セキュリティを導入しています https://clickhouse.com/docs/sql-reference/statements/create/view#sql_security 。[#54901](https://github.com/ClickHouse/ClickHouse/pull/54901) [#60439](https://github.com/ClickHouse/ClickHouse/pull/60439)（[pufit](https://github.com/pufit)）。



#### 新機能 {#new-feature-10}

* ビューやマテリアライズドビューで定義者ユーザーを指定できる新しい構文を追加しました。これにより、基礎となるテーブルに対して明示的に権限を付与しなくても、ビューからの SELECT/INSERT を実行できるようになります。つまり、ビュー側で権限をカプセル化できるようになります。 [#54901](https://github.com/ClickHouse/ClickHouse/pull/54901) [#60439](https://github.com/ClickHouse/ClickHouse/pull/60439) ([pufit](https://github.com/pufit)).
* スキーマ推論中に、`file/s3/hdfs/url/azureBlobStorage` エンジンでファイル形式が不明な場合は、自動的にファイル形式を検出しようとするようにしました。 [#50576](https://github.com/ClickHouse/ClickHouse/issues/50576) をクローズします。 [#59092](https://github.com/ClickHouse/ClickHouse/pull/59092)（[Kruglov Pavel](https://github.com/Avogar)）。
* 非同期挿入タイムアウトの自動調整機能を実装しました。次の設定を追加しました: async&#95;insert&#95;poll&#95;timeout&#95;ms、async&#95;insert&#95;use&#95;adaptive&#95;busy&#95;timeout、async&#95;insert&#95;busy&#95;timeout&#95;min&#95;ms、async&#95;insert&#95;busy&#95;timeout&#95;max&#95;ms、async&#95;insert&#95;busy&#95;timeout&#95;increase&#95;rate、async&#95;insert&#95;busy&#95;timeout&#95;decrease&#95;rate。[#58486](https://github.com/ClickHouse/ClickHouse/pull/58486)（[Julia Kartseva](https://github.com/jkartseva)）。
* 連続したログイン失敗回数に対する上限クォータを設定できるようにしました。 [#54737](https://github.com/ClickHouse/ClickHouse/pull/54737) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
* 新しい集約関数 `groupArrayIntersect`。[#49862](https://github.com/ClickHouse/ClickHouse/issues/49862) のフォローアップ。[#59598](https://github.com/ClickHouse/ClickHouse/pull/59598)（[Yarik Briukhovetskyi](https://github.com/yariks5s)）。
* `AzureBlobStorage` のバックアップおよびリストアをサポート。 [#50747](https://github.com/ClickHouse/ClickHouse/issues/50747) を解決。[#56988](https://github.com/ClickHouse/ClickHouse/pull/56988)（[SmitaRKulkarni](https://github.com/SmitaRKulkarni)）。
* ユーザーは、`format_template_row` の代替として、クエリ内で `format_schema_rows_template` を使用してテンプレート文字列を直接指定できるようになりました。[#31363](https://github.com/ClickHouse/ClickHouse/issues/31363) をクローズしました。[#59088](https://github.com/ClickHouse/ClickHouse/pull/59088)（[Shaun Struwig](https://github.com/Blargian)）。
* さまざまな種類の MergeTree テーブルを自動的に Replicated エンジンへ変換する機能を実装しました。テーブルのデータディレクトリ（`/clickhouse/store/xxx/xxxyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy/`）内に空の `convert_to_replicated` というファイルを作成すると、次回サーバー起動時にそのテーブルが自動的に変換されます。 [#57798](https://github.com/ClickHouse/ClickHouse/pull/57798) ([Kirill](https://github.com/kirillgarbar))。
* 空のパーティションに関連する ZooKeeper ノードを削除するクエリ `ALTER TABLE table FORGET PARTITION partition` を追加しました。 [#59507](https://github.com/ClickHouse/ClickHouse/pull/59507) ([Sergei Trifonov](https://github.com/serxa))。これは上級者向けの機能です。
* NATS テーブルエンジンで JWT 資格情報ファイルのサポートを追加。 [#59543](https://github.com/ClickHouse/ClickHouse/pull/59543) ([Nickolaj Jepsen](https://github.com/nickolaj-jepsen)).
* DNS に関する問題のデバッグに役立つ `system.dns_cache` テーブルを実装しました。 [#59856](https://github.com/ClickHouse/ClickHouse/pull/59856) ([Kirill Nikiforov](https://github.com/allmazz))。
* コーデック `LZ4HC` は、新たに圧縮レベル 2 をサポートするようになりました。これは、以前の最小レベルである 3 より高速ですが、その代わり圧縮率は低くなります。以前のバージョンでは、`LZ4HC(2)` 以下の指定はすべて `LZ4HC(3)` と同一でした。著者: [Cyan4973](https://github.com/Cyan4973)。[#60090](https://github.com/ClickHouse/ClickHouse/pull/60090)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* `system.dns_cache` テーブルを実装しました。DNS 関連の問題のデバッグに役立ちます。新しいサーバー設定 `dns_cache_max_size` を追加しました。 [#60257](https://github.com/ClickHouse/ClickHouse/pull/60257) ([Kirill Nikiforov](https://github.com/allmazz))。
* `merge` テーブル関数で、`merge(['db_name', ] 'tables_regexp')` のような単一引数版をサポートしました。 [#60372](https://github.com/ClickHouse/ClickHouse/pull/60372) ([豪肥肥](https://github.com/HowePa))。
* 負の位置引数をサポートします。[#57736](https://github.com/ClickHouse/ClickHouse/issues/57736) をクローズします。[#58292](https://github.com/ClickHouse/ClickHouse/pull/58292)（[flynn](https://github.com/ucasfl)）。
* `user` キーを使用して、config 内の特定の S3 設定ごとに許可するユーザーのセットを指定できるようにしました。 [#60144](https://github.com/ClickHouse/ClickHouse/pull/60144) ([Antonio Andelic](https://github.com/antonio2368))。
* テーブル関数 `mergeTreeIndex` を追加しました。`MergeTree` テーブルの index ファイルおよび marks ファイルの内容を表し、テーブルの内部構造を調査する用途で使用できます。構文: `mergeTreeIndex(database, table, [with_marks = true])`。ここで `database.table` は、`MergeTree` エンジンを持つ既存のテーブルです。[#58140](https://github.com/ClickHouse/ClickHouse/pull/58140)（[Anton Popov](https://github.com/CurtizJ)）。



#### 実験的機能 {#experimental-feature-8}
* Tukey's fences アルゴリズムを使用して系列データの外れ値を検出する関数 `seriesOutliersDetectTukey` を追加しました。[#58632](https://github.com/ClickHouse/ClickHouse/pull/58632) ([Bhavna Jindal](https://github.com/bhavnajindal))。この関数の動作は次回のパッチリリースで変更される予定であることに注意してください。
* 各行に対して Variant 型名を持つ Enum を返す関数 `variantType` を追加しました。[#59398](https://github.com/ClickHouse/ClickHouse/pull/59398) ([Kruglov Pavel](https://github.com/Avogar))。
* 並列レプリカ（analyzer 使用時のみ）に対して `LEFT JOIN`、`ALL INNER JOIN`、および単純なサブクエリをサポートしました。新しい設定 `parallel_replicas_prefer_local_join` は、ローカルの `JOIN` 実行（デフォルト）と `GLOBAL JOIN` のどちらを選択するかを制御します。すべてのテーブルは、`cluster_for_parallel_replicas` に属するすべてのレプリカ上に存在している必要があります。新しい設定 `min_external_table_block_size_rows` と `min_external_table_block_size_bytes` は、一時テーブルに送信される小さなブロックをまとめるために使用されます（analyzer 使用時のみ）。[#58916](https://github.com/ClickHouse/ClickHouse/pull/58916) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 新しいレプリカの追加または復旧中に、`Replicated` データベース内でテーブルを同時に作成できるようにしました。[#59277](https://github.com/ClickHouse/ClickHouse/pull/59277) ([Konstantin Bogdanov](https://github.com/thevar1able))。
* `Variant` 値に対する比較演算子と、`Variant` カラムへの適切な Field の挿入を実装しました。デフォルトでは、類似した Variant 型を持つ `Variant` 型の作成は許可されません（設定 `allow_suspicious_variant_types` により許可できます）。[#59996](https://github.com/ClickHouse/ClickHouse/issues/59996) をクローズしました。[#59850](https://github.com/ClickHouse/ClickHouse/issues/59850) をクローズしました。[#60198](https://github.com/ClickHouse/ClickHouse/pull/60198) ([Kruglov Pavel](https://github.com/Avogar))。
* CTE を用いた並列レプリカ JOIN（analyzer 未使用）を無効化しました。[#59239](https://github.com/ClickHouse/ClickHouse/pull/59239) ([Raúl Marín](https://github.com/Algunenano))。



#### パフォーマンスの向上 {#performance-improvement-10}

* Primary keyのメモリ使用量が少なくなりました。 [#60049](https://github.com/ClickHouse/ClickHouse/pull/60049) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* プライマリキーおよび一部のその他の操作におけるメモリ使用量を改善しました。 [#60050](https://github.com/ClickHouse/ClickHouse/pull/60050) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* テーブルのプライマリキーは、最初のアクセス時に遅延ロードでメモリに読み込まれます。これは、新しい MergeTree の設定 `primary_key_lazy_load` によって制御され、デフォルトで有効になっています。これにはいくつかの利点があります。- 使用されないテーブルについてはロードされないこと。- メモリが不足している場合、サーバ起動時ではなく最初の使用時に例外がスローされること。これにはいくつかの欠点もあります。- プライマリキーのロードにかかるレイテンシが、接続を受け付ける前ではなく最初のクエリ時に発生するため、理論的には「thundering herd」問題を引き起こす可能性があること。これにより [#11188](https://github.com/ClickHouse/ClickHouse/issues/11188) がクローズされました。 [#60093](https://github.com/ClickHouse/ClickHouse/pull/60093)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* ベクトル検索用のベクトル化距離関数。 [#58866](https://github.com/ClickHouse/ClickHouse/pull/58866) ([Robert Schulze](https://github.com/rschu1ze)).
* ベクトル検索に有用なベクトル化関数 `dotProduct`。[#60202](https://github.com/ClickHouse/ClickHouse/pull/60202)（[Robert Schulze](https://github.com/rschu1ze)）。
* `dictGetOrDefault` 関数に短絡評価機能を追加し、[#52098](https://github.com/ClickHouse/ClickHouse/issues/52098) をクローズ。 [#57767](https://github.com/ClickHouse/ClickHouse/pull/57767)（[jsc0218](https://github.com/jsc0218)）。
* Keeper の改善: `latest_logs_cache_size_threshold` と `commit_logs_cache_size_threshold` によって制御される、メモリ内にキャッシュするログ量に上限を設けました。 [#59460](https://github.com/ClickHouse/ClickHouse/pull/59460) ([Antonio Andelic](https://github.com/antonio2368)).
* Keeper の改善: データノードのサイズをさらに削減。 [#59592](https://github.com/ClickHouse/ClickHouse/pull/59592) ([Antonio Andelic](https://github.com/antonio2368)).
* 結果型が `Float*/Decimal*/*Int*` の場合の `if` 関数におけるブランチミスを引き続き最適化。[https://github.com/ClickHouse/ClickHouse/pull/57885](https://github.com/ClickHouse/ClickHouse/pull/57885) のフォローアップ。[#59148](https://github.com/ClickHouse/ClickHouse/pull/59148)（[李扬](https://github.com/taiyang-li)）。
* 入力型が `Map` の場合の `if` 関数を最適化し、最大で約 10 倍の高速化を達成しました。 [#59413](https://github.com/ClickHouse/ClickHouse/pull/59413) ([李扬](https://github.com/taiyang-li)).
* `Int8` 型のパフォーマンスを、strict aliasing を実装することで改善しました（`UInt8` および他のすべての整数型ではすでに実装済みです）。 [#59485](https://github.com/ClickHouse/ClickHouse/pull/59485) ([Raúl Marín](https://github.com/Algunenano))。
* bigint 型および big decimal 型に対する sum/avg を条件付きで最適化し、分岐予測ミスを減らしてパフォーマンスを向上。 [#59504](https://github.com/ClickHouse/ClickHouse/pull/59504) ([李扬](https://github.com/taiyang-li)).
* アクティブなミューテーション実行中の SELECT クエリのパフォーマンスを改善。 [#59531](https://github.com/ClickHouse/ClickHouse/pull/59531) ([Azat Khuzhin](https://github.com/azat)).
* AVX2 を使用して関数 `isNotNull` を最適化。[#59621](https://github.com/ClickHouse/ClickHouse/pull/59621) ([李扬](https://github.com/taiyang-li))。
* ソート済みまたはほぼソート済みのデータに対する ASOF JOIN のパフォーマンスを改善しました。 [#59731](https://github.com/ClickHouse/ClickHouse/pull/59731) ([Maksim Kita](https://github.com/kitaisreal)).
* `async_insert_max_data_size` の以前のデフォルト値であった 1 MB は小さすぎることが判明しました。新しいデフォルト値は 10 MiB になります。[#59536](https://github.com/ClickHouse/ClickHouse/pull/59536) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* RESTORE コマンドの実行時に、バックアップ内のテーブルメタデータの読み取りで複数スレッドを使用するようにしました。 [#60040](https://github.com/ClickHouse/ClickHouse/pull/60040) ([Vitaly Baranov](https://github.com/vitlibar)).
* `StorageBuffer` が 1 つより多くのシャードを持つ場合（`num_layers` &gt; 1）、バックグラウンドでのフラッシュ処理は、複数スレッドで全シャードに対して同時に実行されるようになりました。 [#60111](https://github.com/ClickHouse/ClickHouse/pull/60111) ([alesapin](https://github.com/alesapin)).





#### 改善 {#improvement-10}

* 出力形式が `Pretty` フォーマットで、ブロックが 100 万を超える単一の数値のみで構成されている場合、読みやすい形式の数値がテーブルの右側に表示されます。 [#60379](https://github.com/ClickHouse/ClickHouse/pull/60379) ([rogeryk](https://github.com/rogeryk))。
* 設定 `split_parts_ranges_into_intersecting_and_non_intersecting_final` と `split_intersecting_parts_ranges_into_layers_final` を追加しました。これらの設定は、`FINAL` を伴うクエリ向けの最適化を無効化するために必要であり、デバッグ用途にのみ必要です。[#59705](https://github.com/ClickHouse/ClickHouse/pull/59705)（[Maksim Kita](https://github.com/kitaisreal)）。実際にはそれだけではなく、パフォーマンスを犠牲にする代わりにメモリ使用量を抑えるためにも利用できます。
* 設定名 `extract_kvp_max_pairs_per_row` を `extract_key_value_pairs_max_pairs_per_row` に変更しました。この設定名に含まれていた不要な省略表現は [https://github.com/ClickHouse/ClickHouse/pull/43606](https://github.com/ClickHouse/ClickHouse/pull/43606) で導入されたものです。この設定に関するドキュメントを修正しました。[#59683](https://github.com/ClickHouse/ClickHouse/pull/59683)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。[#59960](https://github.com/ClickHouse/ClickHouse/pull/59960)（[jsc0218](https://github.com/jsc0218)）。
* `DEFAULT` または `MATERIALIZED` 式を持つカラムに対して `ALTER COLUMN MATERIALIZE` を実行した場合、処理が本来のセマンティクスどおりに動作するようになりました。 [#58023](https://github.com/ClickHouse/ClickHouse/pull/58023) ([Duc Canh Le](https://github.com/canhld94)).
* `MUTATION` 実行中に発生するエラーに対して指数バックオフ処理を有効化しました。これにより、CPU 使用率、メモリ使用量、およびログファイルサイズを削減できます。 [#58036](https://github.com/ClickHouse/ClickHouse/pull/58036) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* `InitialQuery` プロファイルイベントをカウントするための改善を追加。 [#58195](https://github.com/ClickHouse/ClickHouse/pull/58195) ([Unalian](https://github.com/Unalian))。
* `storage_configuration` で `volume_priority` を定義できるようになりました。 [#58533](https://github.com/ClickHouse/ClickHouse/pull/58533) ([Andrey Zvonov](https://github.com/zvonand)).
* `T64` コーデックで `Date32` 型のサポートを追加。 [#58738](https://github.com/ClickHouse/ClickHouse/pull/58738) ([Hongbin Ma](https://github.com/binmahone)).
* 複数の要素を含む型で末尾のカンマを許可しました。 [#59119](https://github.com/ClickHouse/ClickHouse/pull/59119) ([Aleksandr Musorin](https://github.com/AVMusorin)).
* Distributed テーブルエンジンの設定を（MergeTree の設定と同様に）サーバーの設定ファイル内で指定できるようになりました。例: `<distributed> <flush_on_detach>false</flush_on_detach> </distributed>`。 [#59291](https://github.com/ClickHouse/ClickHouse/pull/59291) ([Azat Khuzhin](https://github.com/azat))。
* `system.zookeeper` を読み取る際に、切断やセッション有効期限切れが発生した場合にリトライするようになりました。これは、特にフォルトインジェクションによる切断が存在する状況で、`system.zookeeper` テーブルから多数の行を読み取る場合に有用です。 [#59388](https://github.com/ClickHouse/ClickHouse/pull/59388) ([Alexander Gololobov](https://github.com/davenger))。
* `input_format_values_interpret_expressions=0` の場合、先頭にゼロが付いた数値を 8 進数として解釈しないようにしました。 [#59403](https://github.com/ClickHouse/ClickHouse/pull/59403) ([Joanna Hulboj](https://github.com/jh0x)).
* 起動時および設定ファイルが変更されるたびに、ClickHouse は合計メモリトラッカーのハードリミットを更新します。これらのリミットは、各種サーバー設定および（Linux 上の）cgroup の制限に基づいて計算されます。以前は、`/sys/fs/cgroup/memory.max`（cgroup v2 用）の設定がハードコードされていました。その結果、`/sys/fs/cgroup/my/nested/group/memory.max` のようなネストされたグループ（階層）に対して設定された cgroup v2 のメモリリミットは無視されていました。この問題はすでに修正されています。v1 のメモリリミットの動作は変更されていません。[#59435](https://github.com/ClickHouse/ClickHouse/pull/59435)（[Robert Schulze](https://github.com/rschu1ze)）。
* `INSERT` 実行時に、PK／プロジェクション／セカンダリインデックスの計算に費やされた時間を計測できるよう、新しいプロファイルイベントを追加しました。 [#59436](https://github.com/ClickHouse/ClickHouse/pull/59436) ([Nikita Taranov](https://github.com/nickitat)).
* `S3Queue` の `Ordered` モードにおいて、作成時に設定 `s3queue_last_processed_path` を使用して開始位置を指定できるようにしました。 [#59446](https://github.com/ClickHouse/ClickHouse/pull/59446) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `clickhouse-local` の `system.tables` でもシステムテーブルのコメントが利用できるようになりました。 [#59493](https://github.com/ClickHouse/ClickHouse/pull/59493) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* `system.zookeeper` テーブル: 以前は結果全体をメモリ上に蓄積し、1 つの大きなチャンクとして返していました。この変更により、`system.zookeeper` から多数の行を読み取る際のメモリ消費を削減し、中間進捗（これまでに読み込まれた行数）を表示できるようにし、結果セットが大きい場合でも接続タイムアウトに達するのを回避できるようになります。 [#59545](https://github.com/ClickHouse/ClickHouse/pull/59545) ([Alexander Gololobov](https://github.com/davenger)).
* これにより、ダッシュボードは URL の #hash の圧縮状態と非圧縮状態の両方を解釈できるようになりました（後方互換性の維持）。[#59124](https://github.com/ClickHouse/ClickHouse/issues/59124) の続きです。[#59548](https://github.com/ClickHouse/ClickHouse/pull/59548) ([Amos Bird](https://github.com/amosbird))。
* Intel QPL（コーデック `DEFLATE_QPL` で使用）を v1.3.1 から v1.4.0 に更新しました。また、ポーリングのタイムアウト機構のバグも修正しました。一部のケースで、タイムアウトが発生してもタイムアウトが正しく動作せず、その結果 IAA と CPU がバッファを同時に処理してしまう可能性があることが分かったためです。現状では、IAA コーデックのステータスが QPL&#95;STS&#95;BEING&#95;PROCESSED ではないことを確認してから、SW コーデックへのフォールバックを行うようにするのが望ましいです。 [#59551](https://github.com/ClickHouse/ClickHouse/pull/59551) ([jasperzhu](https://github.com/jinjunzh)).
* ClickHouse Cloud では、シームレスなアップグレードが自動的に行われるため、サーバーバージョンに関する警告を表示しないようにしました。 [#59657](https://github.com/ClickHouse/ClickHouse/pull/59657) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* 自己解凍処理後、一時バイナリはコピーではなく移動されるようになりました。 [#59661](https://github.com/ClickHouse/ClickHouse/pull/59661) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Apple macOS におけるスタックのアンワインド処理を修正。これにより [#53653](https://github.com/ClickHouse/ClickHouse/issues/53653) をクローズ。[#59690](https://github.com/ClickHouse/ClickHouse/pull/59690)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* ユーザーが `max_parser_depth` 設定を非常に大きな値に誤って設定している場合でも、パーサーでスタックオーバーフローを検出するようにしました。これにより [#59622](https://github.com/ClickHouse/ClickHouse/issues/59622) がクローズされました。[#59697](https://github.com/ClickHouse/ClickHouse/pull/59697)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。[#60434](https://github.com/ClickHouse/ClickHouse/pull/60434)
* Kafka ストレージにおける、XML と SQL から作成された名前付きコレクションの挙動を統一しました。 [#59710](https://github.com/ClickHouse/ClickHouse/pull/59710) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* `merge_max_block_size_bytes` が十分に小さい値に設定されていて、テーブルに幅の広い行（文字列やタプル）を含む場合、バックグラウンドマージが無限ループに陥る可能性がありました。この挙動は修正されました。[https://github.com/ClickHouse/ClickHouse/pull/59340](https://github.com/ClickHouse/ClickHouse/pull/59340) のフォローアップです。 [#59812](https://github.com/ClickHouse/ClickHouse/pull/59812)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* CREATE TABLE で明示的に指定されている場合は、replica&#95;path で uuid を許可するようにしました。 [#59908](https://github.com/ClickHouse/ClickHouse/pull/59908) ([Azat Khuzhin](https://github.com/azat)).
* `system.tables` システムテーブルに ReplicatedMergeTree テーブル用の `metadata_version` 列を追加しました。 [#59942](https://github.com/ClickHouse/ClickHouse/pull/59942) ([Maksim Kita](https://github.com/kitaisreal)).
* Keeper の改善: Prometheus には Keeper 関連のメトリクス／イベントのみを送信するように変更。 [#59945](https://github.com/ClickHouse/ClickHouse/pull/59945) ([Antonio Andelic](https://github.com/antonio2368)).
* ダッシュボードは、アップグレード後に system テーブルの構造が変更された場合でも、異なる ClickHouse バージョンのメトリクスを表示します。[#59967](https://github.com/ClickHouse/ClickHouse/pull/59967) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* ファイルから AZ 情報を読み込めるようにしました。 [#59976](https://github.com/ClickHouse/ClickHouse/pull/59976) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Keeper の改善: ディスク関連の操作での失敗時のリトライ処理を追加。 [#59980](https://github.com/ClickHouse/ClickHouse/pull/59980) ([Antonio Andelic](https://github.com/antonio2368)).
* 新しい設定 `backups.remove_backup_files_after_failure` を追加しました: `<clickhouse> <backups> <remove_backup_files_after_failure>true</remove_backup_files_after_failure> </backups> </clickhouse>`。 [#60002](https://github.com/ClickHouse/ClickHouse/pull/60002)（[Vitaly Baranov](https://github.com/vitlibar)）。
* GCP が HTTP エラーコード `GATEWAY_TIMEOUT` を伴う `Internal Error` を返した場合に備えて、S3 ファイルの GCP フォールバック処理をバッファコピーを行う方式に変更しました。 [#60164](https://github.com/ClickHouse/ClickHouse/pull/60164) ([Maksim Kita](https://github.com/kitaisreal)).
* `ULIDStringToDateTime` のショートサーキット実行に対応しました。 [#60211](https://github.com/ClickHouse/ClickHouse/pull/60211) ([Juan Madurga](https://github.com/jlmadurga)).
* `system.backups` および `system.backup_log` テーブルに `query_id` カラムを追加しました。`error` カラムにエラーのスタックトレースを追加しました。 [#60220](https://github.com/ClickHouse/ClickHouse/pull/60220) ([Maksim Kita](https://github.com/kitaisreal))。
* MySQL ポート経由の接続では、QuickSight をそのまま利用できるようにするために、設定 `prefer_column_name_to_alias = 1` が自動的に有効化されて動作するようになりました。あわせて、設定 `mysql_map_string_to_text_in_show_columns` および `mysql_map_fixed_string_to_text_in_show_columns` もデフォルトで有効になり、こちらも MySQL 接続にのみ影響します。これにより、より多くの BI ツールとの互換性が向上します。 [#60365](https://github.com/ClickHouse/ClickHouse/pull/60365) ([Robert Schulze](https://github.com/rschu1ze)).
* チャートが互いに重なって表示される問題を引き起こしていた JavaScript コード内のレースコンディションを修正。 [#60392](https://github.com/ClickHouse/ClickHouse/pull/60392) ([Alexey Milovidov](https://github.com/alexey-milovidov)).



#### ビルド / テスト / パッケージングの改善 {#buildtestingpackaging-improvement-6}
* イントロスペクション付きでカバレッジ収集を行うビルドおよびテストを追加しました。[#56102](https://github.com/ClickHouse/ClickHouse/issues/56102) の継続です。[#58792](https://github.com/ClickHouse/ClickHouse/pull/58792) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* CMake のクロスコンパイル用ツールチェーン変数が設定されている場合に、`corrosion-cmake` 内の Rust ツールチェーンを更新するようにしました。[#59309](https://github.com/ClickHouse/ClickHouse/pull/59309) ([Aris Tritas](https://github.com/aris-aiven)).
* ASTLiterals にいくつかのファジングを追加しました。[#59383](https://github.com/ClickHouse/ClickHouse/pull/59383) ([Raúl Marín](https://github.com/Algunenano)).
* ClickHouse コンテナの起動時に毎回 initdb スクリプトを実行したい場合は、環境変数 `CLICKHOUSE_ALWAYS_RUN_INITDB_SCRIPTS` を設定する必要があります。[#59808](https://github.com/ClickHouse/ClickHouse/pull/59808) ([Alexander Nikolaev](https://github.com/AlexNik)).
* 汎用的な ClickHouse コンポーネント（server / client / ... など）を無効化する機能を削除しましたが、ODBC や keeper など追加のライブラリを必要とするものについては引き続き無効化可能なままにしています。[#59857](https://github.com/ClickHouse/ClickHouse/pull/59857) ([Azat Khuzhin](https://github.com/azat)).
* Query fuzzer は、クエリ内の SETTINGS もファジング対象とするようになりました。[#60087](https://github.com/ClickHouse/ClickHouse/pull/60087) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* clang-19（master）で ClickHouse をビルドするためのサポートを追加しました。[#60448](https://github.com/ClickHouse/ClickHouse/pull/60448) ([Alexey Milovidov](https://github.com/alexey-milovidov)).



#### バグ修正（公式安定版リリースにおけるユーザー可視の不具合） {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-8}

* TTL WHERE で発生していた「Non-ready set」エラーを修正。 [#57430](https://github.com/ClickHouse/ClickHouse/pull/57430) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `quantilesGK` 関数のバグを修正 [#58216](https://github.com/ClickHouse/ClickHouse/pull/58216) ([李扬](https://github.com/taiyang-li))。
* Decimal 引数に対する `intDiv` の誤った動作を修正 [#59243](https://github.com/ClickHouse/ClickHouse/pull/59243) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* `FixedString` 型入力時の `translate` の不具合を修正 [#59356](https://github.com/ClickHouse/ClickHouse/pull/59356) ([Raúl Marín](https://github.com/Algunenano)).
* Keeper におけるダイジェスト計算を修正 [#59439](https://github.com/ClickHouse/ClickHouse/pull/59439)（[Antonio Andelic](https://github.com/antonio2368)）。
* デバッグシンボルを含まないバイナリのスタックトレースを修正 [#59444](https://github.com/ClickHouse/ClickHouse/pull/59444) ([Azat Khuzhin](https://github.com/azat)).
* カラム固有設定がある場合の `ASTAlterCommand::formatImpl` を修正... [#59445](https://github.com/ClickHouse/ClickHouse/pull/59445) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Analyzer により `SELECT * FROM [...] ORDER BY ALL` を修正 [#59462](https://github.com/ClickHouse/ClickHouse/pull/59462)（[zhongyuankai](https://github.com/zhongyuankai)）。
* 分散クエリのキャンセル中に発生する可能性のある未捕捉例外を修正 [#59487](https://github.com/ClickHouse/ClickHouse/pull/59487) ([Azat Khuzhin](https://github.com/azat)).
* 複合型に対して、`MAX` が `permutation` と同じルールを使用するように変更しました [#59498](https://github.com/ClickHouse/ClickHouse/pull/59498)（[Raúl Marín](https://github.com/Algunenano)）。
* `update_insert_deduplication_token_in_dependent_materialized_views` を渡す場合のコーナーケースを修正 [#59544](https://github.com/ClickHouse/ClickHouse/pull/59544) ([Jordi Villar](https://github.com/jrdi)).
* 空の値に対する arrayElement / map の結果が誤っていた問題を修正 [#59594](https://github.com/ClickHouse/ClickHouse/pull/59594) ([Raúl Marín](https://github.com/Algunenano))。
* topK において空の状態をマージする際に発生するクラッシュを修正 [#59603](https://github.com/ClickHouse/ClickHouse/pull/59603) ([Raúl Marín](https://github.com/Algunenano))。
* 定数シャーディングキーを持つ分散テーブルを修正 [#59606](https://github.com/ClickHouse/ClickHouse/pull/59606)（[Vitaly Baranov](https://github.com/vitlibar)）。
* WingFuzz で検出された KQL の問題を修正 [#59626](https://github.com/ClickHouse/ClickHouse/pull/59626) ([Yong Wang](https://github.com/kashwy))。
* AsynchronousBoundedReadBuffer で発生するエラー「Read beyond last offset」を修正 [#59630](https://github.com/ClickHouse/ClickHouse/pull/59630) ([Vitaly Baranov](https://github.com/vitlibar))。
* RewriteSumFunctionWithSumAndCountVisitor で関数エイリアスを保持 [#59658](https://github.com/ClickHouse/ClickHouse/pull/59658)（[Raúl Marín](https://github.com/Algunenano)）。
* 初回以外のクエリにおける開始時刻を修正 [#59662](https://github.com/ClickHouse/ClickHouse/pull/59662) ([Raúl Marín](https://github.com/Algunenano)).
* `minmax` スキップインデックスで引数の型を検証するようにしました [#59733](https://github.com/ClickHouse/ClickHouse/pull/59733) ([Anton Popov](https://github.com/CurtizJ))。
* FixedString を入力とする leftPad / rightPad 関数の不具合を修正 [#59739](https://github.com/ClickHouse/ClickHouse/pull/59739) ([Raúl Marín](https://github.com/Algunenano))。
* 関数 `countMatches` における AST fuzzer の問題を修正 [#59752](https://github.com/ClickHouse/ClickHouse/pull/59752) ([Robert Schulze](https://github.com/rschu1ze)).
* RabbitMQ：ack も nack も行われないメッセージが存在する問題を修正 [#59775](https://github.com/ClickHouse/ClickHouse/pull/59775) ([Kseniia Sumarokova](https://github.com/kssenii))。
* StorageURL がクエリ実行の一部を単一スレッドで行ってしまっていた問題を修正 [#59833](https://github.com/ClickHouse/ClickHouse/pull/59833) ([Michael Kolupaev](https://github.com/al13n321))。
* S3Queue: 未初期化の値を修正 [#59897](https://github.com/ClickHouse/ClickHouse/pull/59897) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 丸括弧で囲まれたパーティション式の構文解析を修正 [#59901](https://github.com/ClickHouse/ClickHouse/pull/59901) ([János Benjamin Antal](https://github.com/antaljanosbenjamin))。
* HTTP 経由で JSONColumnsWithMetadata フォーマットを使用した際に発生するクラッシュを修正 [#59925](https://github.com/ClickHouse/ClickHouse/pull/59925) ([Kruglov Pavel](https://github.com/Avogar))。
* Analyzer で戻り値が異なる場合は sum を count に書き換えないようにしました [#59926](https://github.com/ClickHouse/ClickHouse/pull/59926) ([Azat Khuzhin](https://github.com/azat)).
* UniqExactSet の読み取り時のクラッシュを修正 [#59928](https://github.com/ClickHouse/ClickHouse/pull/59928)（[Maksim Kita](https://github.com/kitaisreal)）。
* ReplicatedMergeTree の無効な metadata&#95;version の修正 [#59946](https://github.com/ClickHouse/ClickHouse/pull/59946) ([Maksim Kita](https://github.com/kitaisreal))。
* `StorageDistributed` のデータレースを修正 [#59987](https://github.com/ClickHouse/ClickHouse/pull/59987) ([Nikita Taranov](https://github.com/nickitat))。
* Docker: オプションが有効な場合にのみ初期化スクリプトを実行するように変更 [#59991](https://github.com/ClickHouse/ClickHouse/pull/59991) ([jktng](https://github.com/jktng))
* `SQLite` への INSERT 文におけるシングルクォートの扱いを修正（シングルクォートをバックスラッシュではなく、シングルクォートを重ねてエスケープするように変更）[#60015](https://github.com/ClickHouse/ClickHouse/pull/60015) ([Azat Khuzhin](https://github.com/azat)).
* `arrayFold` のいくつかの論理エラーを修正 [#60022](https://github.com/ClickHouse/ClickHouse/pull/60022)（[Raúl Marín](https://github.com/Algunenano)）。
* カラムエイリアスを削除してしまっていた `optimize_uniq_to_count` を修正 [#60026](https://github.com/ClickHouse/ClickHouse/pull/60026) ([Raúl Marín](https://github.com/Algunenano)).
* S3Queue テーブル削除時に発生する可能性のある例外を修正 [#60036](https://github.com/ClickHouse/ClickHouse/pull/60036) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 単一リテラルに対する NOT の書式を修正 [#60042](https://github.com/ClickHouse/ClickHouse/pull/60042) ([Raúl Marín](https://github.com/Algunenano)).
* DDLLogEntry でハードコードされた 4096 の代わりにコンテキストの max&#95;query&#95;size を使用するようにした [#60083](https://github.com/ClickHouse/ClickHouse/pull/60083) ([Kruglov Pavel](https://github.com/Avogar))。
* `table` という名前のテーブルを含むクエリの不整合なフォーマットを修正しました。構造が線形でない `UNION ALL`、`INTERSECT`、`EXCEPT` を含むクエリの誤ったフォーマットを修正しました。これにより #52349 がクローズされます。`SYSTEM ... DROP FILESYSTEM CACHE`、`SYSTEM ... REFRESH/START/STOP/CANCEL/TEST VIEW`、`SYSTEM ENABLE/DISABLE FAILPOINT` を含む `SYSTEM` クエリの誤ったフォーマットを修正しました。パラメータ付き DDL クエリのフォーマットを修正しました。`DESCRIBE FILESYSTEM CACHE` クエリのフォーマットを修正しました。`SET param_...`（パラメータを設定するクエリ）の誤ったフォーマットを修正しました。`CREATE INDEX` クエリの誤ったフォーマットを修正しました。`CREATE USER` および同様のクエリの不整合なフォーマットを修正しました。`CREATE SETTINGS PROFILE` の不整合なフォーマットを修正しました。`ALTER ... MODIFY REFRESH` の誤ったフォーマットを修正しました。フレームオフセットが式である場合のウィンドウ関数の不整合なフォーマットを修正しました。`plus` などの演算子を実装する関数の後で `RESPECT NULLS` および `IGNORE NULLS` が使われていた場合の不整合なフォーマットを修正しました。`SYSTEM SYNC REPLICA ... LIGHTWEIGHT FROM ...` のひどいフォーマットを修正しました。`GROUP BY GROUPING SETS ... WITH ROLLUP/CUBE/TOTALS` を含む無効なクエリの不整合なフォーマットを修正しました。`GRANT CURRENT GRANTS` の不整合なフォーマットを修正しました。`CREATE TABLE (... COLLATE)` の不整合なフォーマットを修正しました。加えて、サブクエリ内の `EXPLAIN` の誤ったフォーマットを修正しました（#60102）。ラムダ関数の誤ったフォーマットを修正しました（#60012）。今後この種の問題を見逃さないようにするためのチェックを追加しました。[#60095](https://github.com/ClickHouse/ClickHouse/pull/60095)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* サブクエリ内の EXPLAIN のフォーマットの不整合を修正 [#60102](https://github.com/ClickHouse/ClickHouse/pull/60102) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Nullable における cosineDistance のクラッシュを修正 [#60150](https://github.com/ClickHouse/ClickHouse/pull/60150) ([Raúl Marín](https://github.com/Algunenano)).
* 文字列表現の bool 値を真の bool 型にキャストできるようにしました [#60160](https://github.com/ClickHouse/ClickHouse/pull/60160)（[Robert Schulze](https://github.com/rschu1ze)）。
* `system.s3queue_log` を修正 [#60166](https://github.com/ClickHouse/ClickHouse/pull/60166) ([Kseniia Sumarokova](https://github.com/kssenii))。
* Nullable な集約関数名を持つ arrayReduce を修正 [#60188](https://github.com/ClickHouse/ClickHouse/pull/60188) ([Raúl Marín](https://github.com/Algunenano)).
* `S3Queue` の機密情報を非表示化 [#60233](https://github.com/ClickHouse/ClickHouse/pull/60233) ([Kseniia Sumarokova](https://github.com/kssenii)).
* HTTP 例外コードを修正。[#60252](https://github.com/ClickHouse/ClickHouse/pull/60252)（[Austin Kothig](https://github.com/kothiga)）。
* S3Queue: バグを修正（不安定だった test&#95;storage&#95;s3&#95;queue/test.py::test&#95;shards&#95;distributed テストも併せて修正） [#60282](https://github.com/ClickHouse/ClickHouse/pull/60282) ([Kseniia Sumarokova](https://github.com/kssenii)).
* IPv6 アドレスを扱うハッシュ関数における未初期化値の使用と不正な結果を修正 [#60359](https://github.com/ClickHouse/ClickHouse/pull/60359) ([Kruglov Pavel](https://github.com/Avogar))。
* null 引数を扱う際の `OptimizeDateOrDateTimeConverterWithPreimageVisitor` を修正 [#60453](https://github.com/ClickHouse/ClickHouse/pull/60453) ([Raúl Marín](https://github.com/Algunenano))。
* KQL または PRQL 方言のクライアントから送信された分散テーブルクエリがレプリカ上で実行できない軽微なバグを修正しました。 [#59674](https://github.com/ClickHouse/ClickHouse/issues/59674)。 [#60470](https://github.com/ClickHouse/ClickHouse/pull/60470) ([Alexey Milovidov](https://github.com/alexey-milovidov)) [#59674](https://github.com/ClickHouse/ClickHouse/pull/59674) ([Austin Kothig](https://github.com/kothiga))。



### <a id="241"></a> ClickHouse リリース 24.1, 2024-01-30 {#a-id241a-clickhouse-release-241-2024-01-30}

#### 後方互換性のない変更 {#backward-incompatible-change-9}
* 設定 `print_pretty_type_names` がデフォルトで有効になりました。以前の挙動を維持したい場合はこの設定を無効にするか、`SET compatibility = '23.12'` を実行してください。 [#57726](https://github.com/ClickHouse/ClickHouse/pull/57726) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* MergeTree の設定 `clean_deleted_rows` は非推奨となり、もはや効果はありません。`OPTIMIZE` に対する `CLEANUP` キーワードはデフォルトでは許可されません（`allow_experimental_replacing_merge_with_cleanup` が有効な場合を除く）。 [#58316](https://github.com/ClickHouse/ClickHouse/pull/58316) ([Alexander Tokmakov](https://github.com/tavplubix)).
* 関数 `reverseDNSQuery` は利用できなくなりました。これにより [#58368](https://github.com/ClickHouse/ClickHouse/issues/58368) がクローズされます。 [#58369](https://github.com/ClickHouse/ClickHouse/pull/58369) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* 設定ファイル内のアクセス制御を改善するために、さまざまな変更を有効化しました。これらの変更は動作に影響を与えるため、`access_control_improvements` セクションの `config.xml` を確認してください。よく分からない場合は、設定ファイル内の値を前バージョンのままにしておいてください。 [#58584](https://github.com/ClickHouse/ClickHouse/pull/58584) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* NaN 値に対する `sumMapFiltered` の動作を改善しました。NaN 値は（以前のようにランダムではなく）末尾に配置され、任意の値とは異なるものとして扱われます。また、`-0` は `0` と等しいものとして扱われるようになりました。0 の値は破棄されるため、`-0` の値も破棄されます。 [#58959](https://github.com/ClickHouse/ClickHouse/pull/58959) ([Raúl Marín](https://github.com/Algunenano)).
* 関数 `visibleWidth` はドキュメントに記載されているとおりに動作するようになります。以前のバージョンでは、`lengthUTF8` 関数と同様に、文字列シリアライズ後のコードポイントを単純にカウントするだけで、ゼロ幅文字や結合文字、全角文字、タブ、削除文字を考慮していませんでした。現在はそれに合わせて動作が変更されています。以前の挙動を維持したい場合は、`function_visible_width_behavior` を `0` に設定するか、`compatibility` を `23.12` 以下に設定してください。 [#59022](https://github.com/ClickHouse/ClickHouse/pull/59022) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* 次の 2 つのバグが修正されるまで、`Kusto` 方言は無効化されています: [#59037](https://github.com/ClickHouse/ClickHouse/issues/59037) および [#59036](https://github.com/ClickHouse/ClickHouse/issues/59036)。 [#59305](https://github.com/ClickHouse/ClickHouse/pull/59305) ([Alexey Milovidov](https://github.com/alexey-milovidov)). `Kusto` を使用しようとすると、必ず例外が発生します。
* `FINAL` 修飾子のより効率的な実装では、`max_threads = 1` の場合であっても順序が保持されることはもはや保証されません。以前の挙動に依存している場合は、`enable_vertical_final` を 0 に設定するか、`compatibility` を `23.12` 以下に設定してください。



#### 新機能 {#new-feature-11}

* 他のデータ型の共用体（ユニオン）を表す Variant データ型を実装。型 `Variant(T1, T2, ..., TN)` は、この型の各行が `T1`、`T2`、…、`TN` のいずれかの型、またはいずれの型でもない（`NULL` 値）を値として持つことを意味します。Variant 型は設定 `allow_experimental_variant_type` を有効にすると利用できます。参考: [#54864](https://github.com/ClickHouse/ClickHouse/issues/54864)。[#58047](https://github.com/ClickHouse/ClickHouse/pull/58047)（[Kruglov Pavel](https://github.com/Avogar)）。
* 特定の設定（現在は `min_compress_block_size` と `max_compress_block_size`）を、対応するテーブルレベルの設定より優先されるカラムレベルで指定できるようになりました。例: `CREATE TABLE tab (col String SETTINGS (min_compress_block_size = 81920, max_compress_block_size = 163840)) ENGINE = MergeTree ORDER BY tuple();`。 [#55201](https://github.com/ClickHouse/ClickHouse/pull/55201)（[Duc Canh Le](https://github.com/canhld94)）。
* `quantileDD` 集約関数と、それに対応する `quantilesDD` および `medianDD` を追加しました。DDSketch [https://www.vldb.org/pvldb/vol12/p2195-masson.pdf](https://www.vldb.org/pvldb/vol12/p2195-masson.pdf) に基づく実装です。 ### ユーザー向け変更のドキュメント項目。[#56342](https://github.com/ClickHouse/ClickHouse/pull/56342)（[Srikanth Chekuri](https://github.com/srikanthccv)）。
* 任意の種類のオブジェクトストレージおよびメタデータ型を設定できるようにしました。 [#58357](https://github.com/ClickHouse/ClickHouse/pull/58357) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `distributed_ddl_output_mode` に `null_status_on_timeout_only_active` と `throw_only_active` のモードを追加し、非アクティブなレプリカを待たずに済むようにしました。 [#58350](https://github.com/ClickHouse/ClickHouse/pull/58350) ([Alexander Tokmakov](https://github.com/tavplubix))。
* 部分配列を生成する関数 `arrayShingles` を追加しました。例えば、`arrayShingles([1, 2, 3, 4, 5], 3)` は `[[1,2,3],[2,3,4],[3,4,5]]` を返します。 [#58396](https://github.com/ClickHouse/ClickHouse/pull/58396) ([Zheng Miao](https://github.com/zenmiao7)).
* IDNA 標準に従って国際化ドメイン名を ASCII 文字列表現に変換する際に有用な関数 `punycodeEncode`、`punycodeDecode`、`idnaEncode`、`idnaDecode` を追加しました。 [#58454](https://github.com/ClickHouse/ClickHouse/pull/58454) ([Robert Schulze](https://github.com/rschu1ze)).
* 文字列の類似度を計算する関数 `dramerauLevenshteinDistance`、`jaroSimilarity`、`jaroWinklerSimilarity` を追加しました。 [#58531](https://github.com/ClickHouse/ClickHouse/pull/58531) ([Robert Schulze](https://github.com/rschu1ze)).
* 出力の圧縮レベルを変更するための `output_format_compression_level` と、圧縮ウィンドウのサイズを明示的に設定し、出力の圧縮方式が `zstd` の場合に zstd 圧縮のロングレンジモードを有効にするための `output_format_compression_zstd_window_log` の 2 つの設定を追加しました。`INTO OUTFILE` およびテーブル関数 `file`、`url`、`hdfs`、`s3`、`azureBlobStorage` への書き込み時に適用されます。 [#58539](https://github.com/ClickHouse/ClickHouse/pull/58539) ([Duc Canh Le](https://github.com/canhld94)).
* 出力先がターミナルでない場合、Pretty フォーマットで ANSI エスケープシーケンスを自動的に無効化するようにしました。設定 `output_format_pretty_color` に新しい `auto` モードを追加しました。 [#58614](https://github.com/ClickHouse/ClickHouse/pull/58614) ([Shaun Struwig](https://github.com/Blargian)).
* [Sqids](https://sqids.org/) をデコードする関数 `sqidDecode` を追加しました。 [#58544](https://github.com/ClickHouse/ClickHouse/pull/58544) ([Robert Schulze](https://github.com/rschu1ze))。
* JSON 入力フォーマットで Bool 型の値を String 型として読み取れるようにしました。これはデフォルトで有効になっている `input_format_json_read_bools_as_strings` 設定で制御されます。 [#58561](https://github.com/ClickHouse/ClickHouse/pull/58561) ([Kruglov Pavel](https://github.com/Avogar))。
* 時系列データを季節成分、トレンド成分、残差成分に分解する関数 `seriesDecomposeSTL` を追加しました。 [#57078](https://github.com/ClickHouse/ClickHouse/pull/57078) ([Bhavna Jindal](https://github.com/bhavnajindal)).
* MaterializedMySQL 向けに MySQL Binlog クライアントを導入: binlog 接続 1 つで複数のデータベースを扱えるようになりました。 [#57323](https://github.com/ClickHouse/ClickHouse/pull/57323) ([Val Doroshchuk](https://github.com/valbok))。
* Intel QuickAssist Technology (QAT) は、ハードウェアアクセラレーションされた圧縮および暗号化機能を提供します。ClickHouse に新しい圧縮コーデック `ZSTD_QAT` が追加され、zstd 圧縮に QAT を利用できるようになりました。このコーデックは [Intel&#39;s QATlib](https://github.com/intel/qatlib) と [Inte&#39;s QAT ZSTD Plugin](https://github.com/intel/QAT-ZSTD-Plugin) を使用します。現時点では、ハードウェアで加速できるのは圧縮のみであり（QAT の初期化に失敗した場合にはソフトウェアのフォールバックが動作します）、伸長処理は常にソフトウェアで実行されます。[#57509](https://github.com/ClickHouse/ClickHouse/pull/57509) ([jasperzhu](https://github.com/jinjunzh))。
* S3 ディスク用のオブジェクトストレージキーを生成する新しい方式を実装しました。これにより、ディスク定義内の `key_template` オプションを使って、`re2` 正規表現構文に基づいてフォーマットを定義できるようになりました。 [#57663](https://github.com/ClickHouse/ClickHouse/pull/57663) ([Sema Checherinda](https://github.com/CheSema))。
* テーブル system.dropped&#95;tables&#95;parts には、system.dropped&#95;tables テーブル（DROP されたがまだ削除されていないテーブル）のパーツが含まれます。 [#58038](https://github.com/ClickHouse/ClickHouse/pull/58038) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
* テーブルにアタッチできるマテリアライズドビューの数を制限する設定 `max_materialized_views_size_for_table` を追加。 [#58068](https://github.com/ClickHouse/ClickHouse/pull/58068) ([zhongyuankai](https://github.com/zhongyuankai)).
* `clickhouse-format` の改善点：INSERT クエリでの `VALUES` 句のサポート、コメントのサポート（出力するには `--comments` を使用）、長いクエリのみを複数行に整形するための `--max_line_length` オプションのサポート。[#58246](https://github.com/ClickHouse/ClickHouse/pull/58246) ([vdimir](https://github.com/vdimir))。
* `clickhouse-local` で `system.parts` を含むすべての system テーブルをアタッチします。これにより [#58312](https://github.com/ClickHouse/ClickHouse/issues/58312) が解決されます。[#58359](https://github.com/ClickHouse/ClickHouse/pull/58359)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 関数 `transform` における `Enum` データ型サポートの追加。これにより [#58241](https://github.com/ClickHouse/ClickHouse/issues/58241) がクローズされました。[#58360](https://github.com/ClickHouse/ClickHouse/pull/58360)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* テーブル `system.database_engines` を追加。[#58390](https://github.com/ClickHouse/ClickHouse/pull/58390)（[Bharat Nallan](https://github.com/bharatnc)）。データベースエンジンをコードベース内で独立して登録できるようにする。[#58365](https://github.com/ClickHouse/ClickHouse/pull/58365)（[Bharat Nallan](https://github.com/bharatnc)）。インタプリタを独立して登録できるようにする。[#58443](https://github.com/ClickHouse/ClickHouse/pull/58443)（[Bharat Nallan](https://github.com/bharatnc)）。
* `SYSTEM SYNC REPLICA LIGHTWEIGHT` クエリに `FROM <Replicas>` 修飾子を追加しました。`FROM` 修飾子を使用することで、指定されたソースレプリカ、および ZooKeeper に存在しないレプリカや `source_replica` が空のレプリカに対してのみ、フェッチおよび drop-range を待機するようになります。 [#58393](https://github.com/ClickHouse/ClickHouse/pull/58393) ([Jayme Bird](https://github.com/jaymebrd)).
* 設定 `update_insert_deduplication_token_in_dependent_materialized_views` を追加しました。この設定により、依存するマテリアライズドビューへの挿入時に、テーブル識別子を用いて INSERT の重複排除トークンを更新できるようになりました。[#59165](https://github.com/ClickHouse/ClickHouse/issues/59165) をクローズ。[#59238](https://github.com/ClickHouse/ClickHouse/pull/59238) ([Maksim Kita](https://github.com/kitaisreal))。
* 非同期メトリクスを更新する `SYSTEM RELOAD ASYNCHRONOUS METRICS` ステートメントを追加しました。主にテストや開発用途で役立ちます。 [#53710](https://github.com/ClickHouse/ClickHouse/pull/53710) ([Robert Schulze](https://github.com/rschu1ze)).





#### パフォーマンスの向上 {#performance-improvement-11}

* 並列レプリカのためのコーディネーションが、より高い並列性とキャッシュ局所性を実現するように書き換えられました。数百のレプリカにおける線形スケーラビリティについてテスト済みです。さらに、順序どおりの読み取りもサポートされました。[#57968](https://github.com/ClickHouse/ClickHouse/pull/57968)（[Nikita Taranov](https://github.com/nickitat)）。
* HTTP ベースの送信バッファリングを ClickHouse ネイティブのバッファに置き換え。インターフェイス向けにバイト数を計測するメトリクスを追加。[#56064](https://github.com/ClickHouse/ClickHouse/pull/56064) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* 分散クエリでは、`uniqExact` の大規模な集約状態が並列にマージされます。 [#59009](https://github.com/ClickHouse/ClickHouse/pull/59009) ([Nikita Taranov](https://github.com/nickitat))。
* `MergeTree` テーブル読み込み後のメモリ使用量を削減。[#59290](https://github.com/ClickHouse/ClickHouse/pull/59290) ([Anton Popov](https://github.com/CurtizJ)).
* バーティカルマージ時のメモリ使用量を削減。 [#59340](https://github.com/ClickHouse/ClickHouse/pull/59340) ([Anton Popov](https://github.com/CurtizJ)).
* Keeper の起動時に大量のメモリを消費してしまうケースを、さらに多くの状況で回避できるようにしました。 [#58455](https://github.com/ClickHouse/ClickHouse/pull/58455) ([Antonio Andelic](https://github.com/antonio2368)).
* Keeper の改善: 保存ノードのメモリ使用量を削減。 [#59002](https://github.com/ClickHouse/ClickHouse/pull/59002) ([Antonio Andelic](https://github.com/antonio2368)).
* よりキャッシュ効率に優れた最終実装。挙動変更に関する注意: 以前は、`FINAL` 修飾子を持ち、単一ストリーム（例: `max_threads = 1`）で読み取るクエリは、`ORDER BY` 句が明示的に指定されていなくてもソートされた出力を生成していました。`enable_vertical_final = true` の場合（デフォルトで有効）、これはもはや保証されません。[#54366](https://github.com/ClickHouse/ClickHouse/pull/54366)（[Duc Canh Le](https://github.com/canhld94)）。
* たとえば S3 からの読み取りに使用される `ReadBufferFromIStream` において、不要なコピー処理を回避しました。[#56961](https://github.com/ClickHouse/ClickHouse/pull/56961) ([Nikita Taranov](https://github.com/nickitat))。
* 入力が Array(Map) / Array(Array(Num)) / Array(Array(String)) / Array(BigInt) / Array(Decimal) の場合に、`arrayElement` 関数を最適化しました。以前の実装では不要なメモリアロケーションが多く発生していました。この最適化により、とくに入力型が Array(Map) の場合に最大で約 6 倍の高速化が見込めます。 [#56403](https://github.com/ClickHouse/ClickHouse/pull/56403) ([李扬](https://github.com/taiyang-li)).
* コンパクトパーツから複数のサブカラムを読み込む際、カラムを1回だけ読み取るようにした。 [#57631](https://github.com/ClickHouse/ClickHouse/pull/57631) ([Kruglov Pavel](https://github.com/Avogar)).
* `sum(column + constant)` 関数の AST を書き換えます。これは Analyzer における最適化パスとして利用できます [#57853](https://github.com/ClickHouse/ClickHouse/pull/57853)（[Jiebin Sun](https://github.com/jiebinn)）。
* 関数 `match` の評価で、スキップインデックス `ngrambf_v1` および `tokenbf_v1` が利用されるようになりました。 [#57882](https://github.com/ClickHouse/ClickHouse/pull/57882) ([凌涛](https://github.com/lingtaolf)).
* 関数 `match` の評価にインバーテッドインデックスが利用されるようになりました。 [#58284](https://github.com/ClickHouse/ClickHouse/pull/58284) ([凌涛](https://github.com/lingtaolf))。
* MergeTree の `FINAL` は、同じ non-L0 パーツ内にある行を比較しなくなりました。 [#58142](https://github.com/ClickHouse/ClickHouse/pull/58142) ([Duc Canh Le](https://github.com/canhld94)).
* `iota` 呼び出し（配列を連番で埋める処理）の高速化。 [#58271](https://github.com/ClickHouse/ClickHouse/pull/58271) ([Raúl Marín](https://github.com/Algunenano))。
* 数値以外の型に対する MIN/MAX の高速化。[#58334](https://github.com/ClickHouse/ClickHouse/pull/58334) ([Raúl Marín](https://github.com/Algunenano))。
* フィルターの組み合わせ（マルチステージ PREWHERE など）を、BMI2/SSE イントリンシックを用いて最適化 [#58800](https://github.com/ClickHouse/ClickHouse/pull/58800)（[Zhiguo Zhou](https://github.com/ZhiguoZh)）。
* `clickhouse-local` で使用するスレッド数を 1 つ減らしました。 [#58968](https://github.com/ClickHouse/ClickHouse/pull/58968) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* 型が Nullable の場合の `multiIf` 関数のパフォーマンスを改善しました。 [#57745](https://github.com/ClickHouse/ClickHouse/pull/57745) ([KevinyhZou](https://github.com/KevinyhZou)).
* 未使用の jemalloc ページをパージするための `SYSTEM JEMALLOC PURGE` と、プロファイラが有効な場合に jemalloc プロファイルを制御するための `SYSTEM JEMALLOC [ ENABLE | DISABLE | FLUSH ] PROFILE` を追加しました。Keeper には jemalloc 関連の 4LW コマンドとして、jemalloc の統計情報をダンプする `jmst`、およびプロファイラが有効な場合に jemalloc プロファイルを制御する `jmfp`、`jmep`、`jmdp` を追加しました。[#58665](https://github.com/ClickHouse/ClickHouse/pull/58665) ([Antonio Andelic](https://github.com/antonio2368))。
* S3 へのバックアップにおけるメモリ使用量を削減。 [#58962](https://github.com/ClickHouse/ClickHouse/pull/58962) ([Vitaly Baranov](https://github.com/vitlibar))。





#### 改善 {#improvement-11}

* すべての system テーブルのカラムにコメント（簡潔な説明）を追加しました。これにはいくつか理由があります。- system テーブルは頻繁に利用しており、特定のカラムの目的や意味を開発者が理解するのが非常に難しい場合があります。- system テーブルは（新しいものを追加したり既存のものを変更したりと）頻繁に変更されるため、そのドキュメントは常に最新ではありません。たとえば、[`system.parts`](/operations/system-tables/parts) のドキュメントページを見てください。多くのカラムが記載されていません。- 将来的には、ClickHouse から直接ドキュメントを生成できるようにしたいと考えています。[#58356](https://github.com/ClickHouse/ClickHouse/pull/58356)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* `PASTE JOIN` 用のサブクエリについて、エイリアスなしでもクエリを実行できるようにしました。 [#58654](https://github.com/ClickHouse/ClickHouse/pull/58654) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* macOS 上での `MySQL` / `MariaDB` 連携を有効化。これにより [#21191](https://github.com/ClickHouse/ClickHouse/issues/21191) がクローズされた。[#46316](https://github.com/ClickHouse/ClickHouse/pull/46316) ([Alexey Milovidov](https://github.com/alexey-milovidov)) ([Robert Schulze](https://github.com/rschu1ze))。
* `max_rows_in_set_to_optimize_join` をデフォルトで無効化しました。 [#56396](https://github.com/ClickHouse/ClickHouse/pull/56396) ([vdimir](https://github.com/vdimir)).
* `ON CLUSTER` DDL クエリおよび Replicated データベースエンジンにおいて、ホスト名の解決を行わないようにできる設定パラメータ `<host_name>` を追加しました。これにより、クラスター定義の変更があった場合にキューが詰まってしまう可能性を軽減します。[#57573](https://github.com/ClickHouse/ClickHouse/issues/57573) をクローズしました。[#57603](https://github.com/ClickHouse/ClickHouse/pull/57603)（[Nikolay Degterinsky](https://github.com/evillique)）。
* ファイルシステムキャッシュ用の `load_metadata_threads` を 16 に増やしました。これによりサーバーの起動が高速化されます。 [#57732](https://github.com/ClickHouse/ClickHouse/pull/57732) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* マージ／ミューテーションの帯域を制限できる機能を追加（`max_mutations_bandwidth_for_server` / `max_merges_bandwidth_for_server`）。[#57877](https://github.com/ClickHouse/ClickHouse/pull/57877)（[Azat Khuzhin](https://github.com/azat)）。
* システムテーブル `system.server_settings` において、未ドキュメントだった boolean 型カラム `is_hot_reloadable` を、`No`、`Yes`、`IncreaseOnly`、`DecreaseOnly` の値を取る Enum8 型カラム `changeable_without_restart` に置き換えました。また、このカラムについてもドキュメント化しました。 [#58029](https://github.com/ClickHouse/ClickHouse/pull/58029) ([skyoct](https://github.com/skyoct)).
* クラスタ検出でユーザー名とパスワードの設定をサポートするようにし、[#58063](https://github.com/ClickHouse/ClickHouse/issues/58063) を解決しました。[#58123](https://github.com/ClickHouse/ClickHouse/pull/58123)（[vdimir](https://github.com/vdimir)）。
* `ALTER TABLE ... PART` でクエリパラメータをサポートしました。 [#58297](https://github.com/ClickHouse/ClickHouse/pull/58297) ([Azat Khuzhin](https://github.com/azat)).
* Kafka テーブル向けのコンシューマーをオンデマンドで作成しつつ、最後の利用から一定期間（`kafka_consumers_pool_ttl_ms`）は保持するようにしました。これにより、`system.kafka_consumers` の統計に関する問題（Kafka テーブルから誰も読み取らない場合にコンシューム処理が行われず、その結果、メモリが解放されずにリークし続け、テーブルのデタッチが遅くなる問題）が修正されます。また、この PR により `system.kafka_consumers` の統計が再びデフォルトで有効になります。 [#58310](https://github.com/ClickHouse/ClickHouse/pull/58310) ([Azat Khuzhin](https://github.com/azat)).
* `sparkbar` のエイリアスとして `sparkBar` を追加しました。 [#58335](https://github.com/ClickHouse/ClickHouse/pull/58335) ([凌涛](https://github.com/lingtaolf))。
* アップロード後に `GCS` へ `ComposeObject` リクエストを送信しないようにする。 [#58343](https://github.com/ClickHouse/ClickHouse/pull/58343) ([Azat Khuzhin](https://github.com/azat)).
* 構成 XML ファイルで、名前にドットを含むキーを正しく扱えるようにしました。 [#58354](https://github.com/ClickHouse/ClickHouse/pull/58354) ([Azat Khuzhin](https://github.com/azat))。
* 関数 `format` が定数引数に対して定数を返すようにしました。これにより、[#58355](https://github.com/ClickHouse/ClickHouse/issues/58355) が解決しました。[#58358](https://github.com/ClickHouse/ClickHouse/pull/58358)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* `max_execution_time` と `max_estimated_execution_time` を分離するため、設定項目 `max_estimated_execution_time` を追加。 [#58402](https://github.com/ClickHouse/ClickHouse/pull/58402) ([Zhang Yifan](https://github.com/zhangyifan27)).
* 無効なデータベースエンジン名が指定された場合にヒントを表示するようにしました。 [#58444](https://github.com/ClickHouse/ClickHouse/pull/58444) ([Bharat Nallan](https://github.com/bharatnc)).
* Arrow 辞書内のインデックス型をより細かく制御するための設定を追加しました。Arrow の推奨に従い、デフォルトで符号付き整数型をインデックスに使用します。[#57401](https://github.com/ClickHouse/ClickHouse/issues/57401) をクローズしました。[#58519](https://github.com/ClickHouse/ClickHouse/pull/58519)（[Kruglov Pavel](https://github.com/Avogar)）。
* [#58575](https://github.com/ClickHouse/ClickHouse/issues/58575) を実装し、Docker イメージの実行時に `CLICKHOUSE_PASSWORD_FILE` 環境変数をサポート。 [#58583](https://github.com/ClickHouse/ClickHouse/pull/58583)（[Eyal Halpern Shalev](https://github.com/Eyal-Shalev)）。
* 一部のクエリを実行する際に、多数のストリームを使ってデータを読み取る必要がある場合、以前は `"Paste JOIN requires sorted tables only"` というエラーがスローされていました。現在は、そのようなケースではストリーム数が 1 に調整されます。 [#58608](https://github.com/ClickHouse/ClickHouse/pull/58608) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
* INVALID&#95;IDENTIFIER エラー時のメッセージを改善。 [#58703](https://github.com/ClickHouse/ClickHouse/pull/58703) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* normalizeQuery における符号付き数値リテラルの扱いを改善しました。 [#58710](https://github.com/ClickHouse/ClickHouse/pull/58710) ([Salvatore Mesoraca](https://github.com/aiven-sal))。
* MySQL の Point データ型のサポートを追加しました。 [#58721](https://github.com/ClickHouse/ClickHouse/pull/58721) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Float32 カラムと const 文字列を比較する際には、文字列を Float64 ではなく Float32 として解釈するようにしました。[#58724](https://github.com/ClickHouse/ClickHouse/pull/58724) ([Raúl Marín](https://github.com/Algunenano))。
* S3 互換性を改善し、ECloud EOS ストレージのサポートを追加。 [#58786](https://github.com/ClickHouse/ClickHouse/pull/58786) ([xleoken](https://github.com/xleoken)).
* `KILL QUERY` でバックアップおよびリストアをキャンセルできるようになりました。この PR により、実行中のバックアップおよびリストアが `system.processes` に表示されるようになりました。さらに、サーバー設定に新しい設定項目 `shutdown_wait_backups_and_restores`（デフォルト = true）が追加され、サーバーのシャットダウン時に、実行中のすべてのバックアップおよびリストアの完了を待つか、ただちにキャンセルするかを制御できるようになりました。[#58804](https://github.com/ClickHouse/ClickHouse/pull/58804)（[Vitaly Baranov](https://github.com/vitlibar)）。
* AvroフォーマットでZSTDコーデックをサポートしました。[#58735](https://github.com/ClickHouse/ClickHouse/issues/58735) をクローズ。 [#58805](https://github.com/ClickHouse/ClickHouse/pull/58805) ([flynn](https://github.com/ucasfl)).
* MySQL インターフェイスで `net_write_timeout` および `net_read_timeout` 設定がサポートされるようになりました。`net_write_timeout` は ClickHouse のネイティブ設定である `send_timeout` に、同様に `net_read_timeout` は `receive_timeout` にマッピングされます。MySQL の `sql_select_limit` 設定が、ステートメント全体が大文字で記述されている場合にのみ設定可能だった問題を修正しました。[#58835](https://github.com/ClickHouse/ClickHouse/pull/58835) ([Serge Klochkov](https://github.com/slvrtrn)).
* 同じ名前の dictionary と table を作成しようとして競合が発生した場合に出力される例外メッセージを改善しました。 [#58841](https://github.com/ClickHouse/ClickHouse/pull/58841) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* カスタムディスク（SQL から作成したもの）の場合は、サーバー設定で `filesystem_caches_path`（すべてのファイルシステムキャッシュに共通のディレクトリプレフィックス）または `custom_cached_disks_base_directory`（カスタムディスクから作成されたファイルシステムキャッシュ専用の共通ディレクトリプレフィックス）のいずれかが指定されていることを確認してください。`custom_cached_disks_base_directory` はカスタムディスクに対して `filesystem_caches_path` よりも優先され、前者が存在しない場合にのみ `filesystem_caches_path` が使用されます。ファイルシステムキャッシュ設定の `path` は必ずそのディレクトリ配下である必要があり、そうでない場合はディスクの作成を防ぐために例外がスローされます。これは、古いバージョンで作成されたディスクが存在し、その後サーバーをアップグレードした場合には影響しません。この場合、サーバーが正常に起動できるように、例外はスローされません。`custom_cached_disks_base_directory` はデフォルトのサーバー設定に `/var/lib/clickhouse/caches/` として追加されています。[#57825](https://github.com/ClickHouse/ClickHouse/issues/57825) をクローズ。[#58869](https://github.com/ClickHouse/ClickHouse/pull/58869)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* MySQL インターフェイスが `SHOW WARNINGS` / `SHOW COUNT(*) WARNINGS` クエリに対応しましたが、返される結果は常に空集合です。[#58929](https://github.com/ClickHouse/ClickHouse/pull/58929) ([Serge Klochkov](https://github.com/slvrtrn))。
* 並列分散 `INSERT SELECT` を実行する際に、利用できないレプリカをスキップするようになりました。 [#58931](https://github.com/ClickHouse/ClickHouse/pull/58931) ([Alexander Tokmakov](https://github.com/tavplubix)).
* ログレベルを単語でわかりやすく表示しつつ、構造化ログの JSON 形式によるフォーマットを有効化しました。 [#58936](https://github.com/ClickHouse/ClickHouse/pull/58936) ([Tim Liou](https://github.com/wheatdog)).
* MySQL インターフェイスが、データ型エイリアスを通じて `CAST(x AS SIGNED)` および `CAST(x AS UNSIGNED)` ステートメントをサポートするようになりました。`SIGNED` は Int64 の、`UNSIGNED` は UInt64 のエイリアスです。これにより、Looker Studio などの BI ツールとの互換性が向上します。 [#58954](https://github.com/ClickHouse/ClickHouse/pull/58954) ([Serge Klochkov](https://github.com/slvrtrn))。
* 作業ディレクトリを Docker コンテナ内のデータパスに変更しました。 [#58975](https://github.com/ClickHouse/ClickHouse/pull/58975) ([cangyin](https://github.com/cangyin))。
* Azure Blob Storage 向けの設定 `azure_max_unexpected_write_error_retries` を追加しました。これは設定ファイルの azure セクションからも設定できます。 [#59001](https://github.com/ClickHouse/ClickHouse/pull/59001) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* 壊れたデータレイクテーブルが存在していてもサーバーを起動できるようにしました。[#58625](https://github.com/ClickHouse/ClickHouse/issues/58625) をクローズ。[#59080](https://github.com/ClickHouse/ClickHouse/pull/59080)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `Iceberg` テーブルエンジンにおけるスキーマ進化を無視し、テーブル作成時にユーザーが指定したスキーマ、またはテーブル作成時にメタデータから解析された最新のスキーマを用いて、すべてのデータを読み出せるようにします。これは、デフォルトでは無効になっている `iceberg_engine_ignore_schema_evolution` 設定によって制御されます。この設定を有効にすると、スキーマが進化している場合でもすべてのデータファイルが同一スキーマで読み取られるため、結果が不正確になる可能性がある点に注意してください。 [#59133](https://github.com/ClickHouse/ClickHouse/pull/59133) ([Kruglov Pavel](https://github.com/Avogar))。
* 読み取り専用／一度限り書き込みのストレージに対してミュータブルな操作（`INSERT` / `ALTER` / `OPTIMIZE` / ...）を禁止し、適切な `TABLE_IS_READ_ONLY` エラーを返すようにしました（不要な残り物を避けるため）。`CREATE` / `ATTACH` 時に、一度限り書き込みディスク上に不要なファイル（`format_version.txt`）が残らないようにしました。`ReplicatedMergeTree` に対する `DROP` を（`MergeTree` と同様に）無視するようにしました。`s3_plain`（`MetadataStorageFromPlainObjectStorage::iterateDirectory`）上のディレクトリ反復処理を修正しました。読み取り専用ディスクは `web` ディスクであり、一度限り書き込みディスクは `s3_plain` であることに注意してください。 [#59170](https://github.com/ClickHouse/ClickHouse/pull/59170) ([Azat Khuzhin](https://github.com/azat)).
* 実験的な `_block_number` カラムにおいて、`ALTER` と `merge` を複雑に組み合わせた場合に論理エラーを引き起こす可能性があるバグを修正しました。[#56202](https://github.com/ClickHouse/ClickHouse/issues/56202) を修正し、[#58601](https://github.com/ClickHouse/ClickHouse/issues/58601) を置き換えます。[#59295](https://github.com/ClickHouse/ClickHouse/pull/59295)（[alesapin](https://github.com/alesapin)）。
* Play UI が JSON 内で例外が返された場合にそれを正しく認識できるようになりました。[#52853](https://github.com/ClickHouse/ClickHouse/issues/52853) への調整です。[#59303](https://github.com/ClickHouse/ClickHouse/pull/59303)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* `/binary` HTTP ハンドラーでは、クエリ文字列内で user と host を指定でき、必要に応じて password も指定できます。[#59311](https://github.com/ClickHouse/ClickHouse/pull/59311)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 圧縮インメモリテーブルに対するバックアップをサポートします。この変更により [#57893](https://github.com/ClickHouse/ClickHouse/issues/57893) がクローズされます。[#59315](https://github.com/ClickHouse/ClickHouse/pull/59315)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* `BACKUP` および `RESTORE` クエリで `FORMAT` 句がサポートされるようになりました。 [#59338](https://github.com/ClickHouse/ClickHouse/pull/59338) ([Vitaly Baranov](https://github.com/vitlibar)).
* 関数 `concatWithSeparator` は、これまで `String` と `FixedString` 型の引数のみをサポートしていましたが、任意の引数型をサポートするようになりました。たとえば、`SELECT concatWithSeparator('.', 'number', 1)` は `number.1` を返すようになりました。 [#59341](https://github.com/ClickHouse/ClickHouse/pull/59341)（[Robert Schulze](https://github.com/rschu1ze)）。



#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-7}
* clickhouse バイナリのエイリアスを改善しました（現在は、渡された引数に応じて `ch` / `clickhouse` が `clickhouse-local` または `clickhouse` になります）、さらに新しいエイリアス向けの bash 補完を追加しました。 [#58344](https://github.com/ClickHouse/ClickHouse/pull/58344) ([Azat Khuzhin](https://github.com/azat)).
* すべての設定変更が設定変更履歴に反映されていることを確認するため、CI に設定変更チェックを追加しました。 [#58555](https://github.com/ClickHouse/ClickHouse/pull/58555) ([Kruglov Pavel](https://github.com/Avogar)).
* stateful テストで、S3 から直接アタッチされたテーブルを使用するようにしました。 [#58791](https://github.com/ClickHouse/ClickHouse/pull/58791) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* `fuzzer.log` 全体を、最後の 100k 行ではなくアーカイブとして保存するようにしました。`tail -n 100000` によってテーブル定義を含む行が削除されてしまうことがよくあります。例: [#58821](https://github.com/ClickHouse/ClickHouse/pull/58821) ([Dmitry Novik](https://github.com/novikd)).
* macOS の Aarch64 で Rust を有効化しました（これにより、クライアントで skim を使ったあいまい検索と PRQL 言語が利用可能になりますが、darwin 上で ClickHouse をホストしている人はほとんどいないと思うので、主にクライアントでのあいまい検索のためと言えるでしょう）。 [#59272](https://github.com/ClickHouse/ClickHouse/pull/59272) ([Azat Khuzhin](https://github.com/azat)).
* x86_64 と ARM が混在するクラスタにおける集計の問題を修正しました。 [#59132](https://github.com/ClickHouse/ClickHouse/pull/59132) ([Harry Lee](https://github.com/HarryLeeIBM)).

#### バグ修正（公式安定版リリースにおけるユーザーから見て明らかな誤動作） {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-9}



* ネストされた LowCardinality 用の結合キーの変換を追加 [#51550](https://github.com/ClickHouse/ClickHouse/pull/51550) ([vdimir](https://github.com/vdimir))。
* flatten&#95;nested=1 の場合、すべての Array(Tuple) ではなく、ネイティブな Nested 型のみをフラット化するようにしました [#56132](https://github.com/ClickHouse/ClickHouse/pull/56132) ([Kruglov Pavel](https://github.com/Avogar))。
* 挿入時にプロジェクションと `aggregate_functions_null_for_empty` 設定の組み合わせで発生するバグを修正しました。 [#56944](https://github.com/ClickHouse/ClickHouse/pull/56944) ([Amos Bird](https://github.com/amosbird))。
* 古くなったプロファイル UUID に起因する可能性のある例外を修正しました [#57263](https://github.com/ClickHouse/ClickHouse/pull/57263) ([Vasily Nemkov](https://github.com/Enmk))。
* StreamingFormatExecutor における読み取りバッファーの処理を修正 [#57438](https://github.com/ClickHouse/ClickHouse/pull/57438)（[Kruglov Pavel](https://github.com/Avogar)）。
* ビューへのプッシュ時に、ターゲットテーブルが削除済みの MV を無視するようにしました [#57520](https://github.com/ClickHouse/ClickHouse/pull/57520) ([Kruglov Pavel](https://github.com/Avogar))。
* ALTER&#95;METADATA と MERGE&#95;PARTS 間で発生し得るレースコンディションを排除しました [#57755](https://github.com/ClickHouse/ClickHouse/pull/57755) ([Azat Khuzhin](https://github.com/azat))。
* ROLLUP を伴う GROUP BY での式順序に関するバグを修正 [#57786](https://github.com/ClickHouse/ClickHouse/pull/57786) ([Chen768959](https://github.com/Chen768959)).
* 廃止された「zero-copy」レプリケーション機能に対する修正: 壊れた detached part を含むレプリカを削除した際に失われていた blob の問題を修正 [#58333](https://github.com/ClickHouse/ClickHouse/pull/58333)（[Alexander Tokmakov](https://github.com/tavplubix)）。
* ユーザーが user&#95;files&#95;path 内のシンボリックリンクを利用できるようにしました [#58447](https://github.com/ClickHouse/ClickHouse/pull/58447) ([Duc Canh Le](https://github.com/canhld94))。
* graphite テーブルに agg 関数が存在しない場合に発生していたクラッシュを修正 [#58453](https://github.com/ClickHouse/ClickHouse/pull/58453) ([Duc Canh Le](https://github.com/canhld94))。
* マテリアライズドビューで複数回の読み取りを行えるようにするため、StorageKafka からの読み取りを遅延させました [#58477](https://github.com/ClickHouse/ClickHouse/pull/58477) ([János Benjamin Antal](https://github.com/antaljanosbenjamin))。
* パーツ同士が交差してしまうおかしなケースを修正 [#58482](https://github.com/ClickHouse/ClickHouse/pull/58482) ([Alexander Tokmakov](https://github.com/tavplubix))。
* LIMIT のみのクエリで MergeTreePrefetchedReadPool を無効化 [#58505](https://github.com/ClickHouse/ClickHouse/pull/58505) ([Maksim Kita](https://github.com/kitaisreal))。
* 復元中も通常のデータベースを有効化 [#58520](https://github.com/ClickHouse/ClickHouse/pull/58520) ([Jihyuk Bok](https://github.com/tomahawk28)).
* ORC/Parquet/... 向けの Apache Hive スレッドプールによる読み取り処理を修正。 [#58537](https://github.com/ClickHouse/ClickHouse/pull/58537) ([sunny](https://github.com/sunny19930321)).
* `system.backup_log` の `base_backup_name` カラム内に含まれる認証情報をマスクする [#58550](https://github.com/ClickHouse/ClickHouse/pull/58550)（[Daniel Pozo Escalona](https://github.com/danipozo)）。
* ミリ秒およびマイクロ秒単位の値の丸めに対応した `toStartOfInterval` [#58557](https://github.com/ClickHouse/ClickHouse/pull/58557)（[Yarik Briukhovetskyi](https://github.com/yariks5s)）。
* ConcurrentHashJoin での `max_joined_block_rows` の無効化 [#58595](https://github.com/ClickHouse/ClickHouse/pull/58595) ([vdimir](https://github.com/vdimir)).
* 旧アナライザでの Nullable を使った JOIN を修正 [#58596](https://github.com/ClickHouse/ClickHouse/pull/58596) ([vdimir](https://github.com/vdimir))。
* `makeDateTime64`: 非定数の fraction 引数を許可するように変更 [#58597](https://github.com/ClickHouse/ClickHouse/pull/58597) ([Robert Schulze](https://github.com/rschu1ze)).
* インラインフレームのシンボル化中に発生し得る NULL ポインタ逆参照を修正 [#58607](https://github.com/ClickHouse/ClickHouse/pull/58607) ([Azat Khuzhin](https://github.com/azat))。
* 再作成されたユーザーやロール切り替え時のクエリキャッシュエントリの分離性を改善 [#58611](https://github.com/ClickHouse/ClickHouse/pull/58611) ([Robert Schulze](https://github.com/rschu1ze)).
* 投影の最適化時に不正になっていたパーティションキー解析を修正 [#58638](https://github.com/ClickHouse/ClickHouse/pull/58638) ([Amos Bird](https://github.com/amosbird)).
* クエリキャッシュ: ユーザーごとのクォータの問題を修正 [#58731](https://github.com/ClickHouse/ClickHouse/pull/58731) ([Robert Schulze](https://github.com/rschu1ze)).
* 並列ウィンドウ関数のストリームパーティショニングを修正 [#58739](https://github.com/ClickHouse/ClickHouse/pull/58739) ([Dmitry Novik](https://github.com/novikd))。
* addBatchLookupTable8 内で例外スロー時に `destroy` が二重に呼び出される問題を修正 [#58745](https://github.com/ClickHouse/ClickHouse/pull/58745) ([Raúl Marín](https://github.com/Algunenano))。
* シャットダウン中に Keeper がリクエストを処理しないようにする [#58765](https://github.com/ClickHouse/ClickHouse/pull/58765) ([Antonio Andelic](https://github.com/antonio2368))。
* `SlabsPolygonIndex::find` におけるヌルポインタ逆参照を修正 [#58771](https://github.com/ClickHouse/ClickHouse/pull/58771) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
* LowCardinality(Nullable) カラム用の JSONExtract 関数を修正 [#58808](https://github.com/ClickHouse/ClickHouse/pull/58808) ([vdimir](https://github.com/vdimir))。
* CREATE および DROP によって大量のテーブルを作成・削除する際に、メモリ使用量が想定外に増加してしまう問題の修正。 [#58831](https://github.com/ClickHouse/ClickHouse/pull/58831) ([Maksim Kita](https://github.com/kitaisreal)).
* マテリアライズドビュー（MV）における複数 read file ログストレージ [#58877](https://github.com/ClickHouse/ClickHouse/pull/58877)（[János Benjamin Antal](https://github.com/antaljanosbenjamin)）。
* S3 のアクセスキー ID に対する制限。 [#58900](https://github.com/ClickHouse/ClickHouse/pull/58900) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* suggestions 読み込み中に発生する可能性のある clickhouse-local のクラッシュを修正 [#58907](https://github.com/ClickHouse/ClickHouse/pull/58907) ([Kruglov Pavel](https://github.com/Avogar))。
* `indexHint` 使用時にクラッシュする問題を修正 [#58911](https://github.com/ClickHouse/ClickHouse/pull/58911) ([Dmitry Novik](https://github.com/novikd))。
* サーバー再起動後に StorageURL がヘッダーを保持しない問題を修正 [#58933](https://github.com/ClickHouse/ClickHouse/pull/58933) ([Michael Kolupaev](https://github.com/al13n321))。
* Analyzer: 挿入ブロックを用いたストレージの置換を修正 [#58958](https://github.com/ClickHouse/ClickHouse/pull/58958) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
* ReadBufferFromZipArchive のシーク処理を修正 [#58966](https://github.com/ClickHouse/ClickHouse/pull/58966) ([Michael Kolupaev](https://github.com/al13n321)).
* 実験的な inverted index 向けの修正（本番環境では使用しないでください）：inverted index に対する `DROP INDEX` が、永続化領域から関連するすべてのファイルを削除するようになりました [#59040](https://github.com/ClickHouse/ClickHouse/pull/59040) ([mochi](https://github.com/MochiXu))。
* query&#95;factories&#95;info におけるデータレースを修正 [#59049](https://github.com/ClickHouse/ClickHouse/pull/59049) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 「Too many redirects」エラーに対する再試行を無効化 [#59099](https://github.com/ClickHouse/ClickHouse/pull/59099) ([skyoct](https://github.com/skyoct)).
* 未起動のデータベースのシャットダウン時に発生するデッドロックを修正 [#59137](https://github.com/ClickHouse/ClickHouse/pull/59137) ([Sergei Trifonov](https://github.com/serxa)).
* 修正: 分散クエリにおける `LIMIT BY` と `LIMIT` の扱い [#59153](https://github.com/ClickHouse/ClickHouse/pull/59153) ([Igor Nikonov](https://github.com/devcrafter)).
* `toString` の NULL 許容タイムゾーン値で発生するクラッシュを修正 [#59190](https://github.com/ClickHouse/ClickHouse/pull/59190) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
* 不正なファイルパスが指定された場合に Iceberg メタデータで発生する異常終了を修正 [#59275](https://github.com/ClickHouse/ClickHouse/pull/59275) ([Kruglov Pavel](https://github.com/Avogar)).
* Rust ターゲットの select で使用するアーキテクチャ名を修正 [#59307](https://github.com/ClickHouse/ClickHouse/pull/59307) ([p1rattttt](https://github.com/p1rattttt)).
* IN 句のサブクエリを使用して `system.tables` をクエリする際に発生する「not-ready set」に関する論理エラーを修正。 [#59351](https://github.com/ClickHouse/ClickHouse/pull/59351) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).





## [2023 年の変更履歴](/whats-new/changelog/2023) {#changelog-for-2023}
