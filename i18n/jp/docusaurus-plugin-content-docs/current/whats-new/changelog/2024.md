---
slug: /whats-new/changelog/2024
sidebar_position: 3
sidebar_label: "2024"
title: "2024年変更履歴"
description: "2024年の変更履歴"
keywords:
  [
    "ClickHouse 2024",
    "changelog 2024",
    "リリースノート",
    "バージョン履歴",
    "新機能"
  ]
doc_type: "changelog"
---

### 目次 {#table-of-contents}

**[ClickHouse release v24.12, 2024-12-19](/whats-new/changelog/2024#a-id2412a-clickhouse-release-2412-2024-12-19)**<br/>
**[ClickHouse release v24.11, 2024-11-26](/whats-new/changelog/2024#a-id2411a-clickhouse-release-2411-2024-11-26)**<br/>
**[ClickHouse release v24.10, 2024-10-31](/whats-new/changelog/2024#a-id2410a-clickhouse-release-2410-2024-10-31)**<br/>
**[ClickHouse release v24.9, 2024-09-26](/whats-new/changelog/2024#a-id249a-clickhouse-release-249-2024-09-26)**<br/>
**[ClickHouse release v24.8 LTS, 2024-08-20](/whats-new/changelog/2024#a-id248a-clickhouse-release-248-lts-2024-08-20)**<br/>
**[ClickHouse release v24.7, 2024-07-30](/whats-new/changelog/2024#a-id247a-clickhouse-release-247-2024-07-30)**<br/>
**[ClickHouse release v24.6, 2024-07-01](/whats-new/changelog/2024#a-id246a-clickhouse-release-246-2024-07-01)**<br/>
**[ClickHouse release v24.5, 2024-05-30](/whats-new/changelog/2024#a-id245a-clickhouse-release-245-2024-05-30)**<br/>
**[ClickHouse release v24.4, 2024-04-30](/whats-new/changelog/2024#a-id244a-clickhouse-release-244-2024-04-30)**<br/>
**[ClickHouse release v24.3 LTS, 2024-03-26](/whats-new/changelog/2024#a-id243a-clickhouse-release-243-lts-2024-03-27)**<br/>
**[ClickHouse release v24.2, 2024-02-29](/whats-new/changelog/2024#a-id242a-clickhouse-release-242-2024-02-29)**<br/>
**[ClickHouse release v24.1, 2024-01-30](/whats-new/changelog/2024#a-id241a-clickhouse-release-241-2024-01-30)**<br/>
**[2023年の変更履歴](/whats-new/changelog/2023/)**<br/>

### <a id="2412"></a> ClickHouse release 24.12, 2024-12-19 {#a-id2412a-clickhouse-release-2412-2024-12-19}

#### 後方互換性のない変更 {#backward-incompatible-change}

- 関数`greatest`と`least`は、NULL入力値を無視するようになりました。以前は引数の1つがNULLの場合にNULLを返していました。例えば、`SELECT greatest(1, 2, NULL)`は現在2を返します。これによりPostgreSQLとの互換性が保たれますが、同時にNULLを返すMySQLとの互換性が失われます。以前の動作を維持するには、設定`least_greatest_legacy_null_behavior`(デフォルト: `false`)を`true`に設定してください。[#65519](https://github.com/ClickHouse/ClickHouse/pull/65519) [#73344](https://github.com/ClickHouse/ClickHouse/pull/73344) ([kevinyhzou](https://github.com/KevinyhZou))。
- 新しいMongoDB統合がデフォルトになりました。レガシーMongoDBドライバー(Pocoドライバーベース)を使用したいユーザーは、サーバー設定`use_legacy_mongodb_integration`を有効にできます。[#73359](https://github.com/ClickHouse/ClickHouse/pull/73359) ([Kirill Nikiforov](https://github.com/allmazz))。


#### 新機能 {#new-feature}

- `JSON`/`Dynamic`/`Variant`型を実験的機能からベータ版に移行しました。[#72294](https://github.com/ClickHouse/ClickHouse/pull/72294) ([Pavel Kruglov](https://github.com/Avogar))。すべての修正とこの変更を24.11にもバックポートしました。
- [Icebergデータストレージ](https://iceberg.apache.org/spec/#file-system-operations)形式のスキーマ進化により、ユーザーはテーブルのスキーマを変更するための広範なオプションを利用できます。カラムの順序、カラム名、および単純な型拡張を内部的に変更できます。[#69445](https://github.com/ClickHouse/ClickHouse/pull/69445) ([Daniil Ivanik](https://github.com/divanik))。
- Iceberg REST Catalogとの統合:Icebergという名前の新しいデータベースエンジンで、カタログ全体をClickHouseに統合します。[#71542](https://github.com/ClickHouse/ClickHouse/pull/71542) ([Kseniia Sumarokova](https://github.com/kssenii))。
- `MergeTree`テーブルのプライマリインデックス用のキャッシュを追加しました(テーブル設定`use_primary_key_cache`で有効化可能)。プライマリインデックスに対して遅延ロードとキャッシュが有効な場合、メモリに永続的に保持する代わりに、オンデマンドでキャッシュにロードされます(マークキャッシュと同様)。データパーツの挿入/マージ/フェッチ時およびテーブルの再起動時にプライマリインデックスのプリウォームを追加しました(設定`prewarm_primary_key_cache`で有効化可能)。これにより、共有ストレージ上の巨大なテーブルでのメモリ使用量を削減でき、1000兆レコードを超えるテーブルでテストしました。[#72102](https://github.com/ClickHouse/ClickHouse/pull/72102) ([Anton Popov](https://github.com/CurtizJ))。[#72750](https://github.com/ClickHouse/ClickHouse/pull/72750) ([Alexander Gololobov](https://github.com/davenger))。
- 指定されたテーブルのすべてのパーツ、またはテーブルが指定されていない場合はすべてのテーブルのプライマリインデックスをロードする`SYSTEM LOAD PRIMARY KEY`コマンドを実装しました。これはベンチマークやクエリ実行中の余分なレイテンシを防ぐのに役立ちます。[#66252](https://github.com/ClickHouse/ClickHouse/pull/66252) [#67733](https://github.com/ClickHouse/ClickHouse/pull/67733) ([ZAWA_ll](https://github.com/Zawa-ll))。
- `MergeTree`テーブルを`ReplicatedMergeTree`として、またはその逆としてアタッチできるクエリを追加しました:`ATTACH TABLE ... AS REPLICATED`および`ATTACH TABLE ... AS NOT REPLICATED`。[#65401](https://github.com/ClickHouse/ClickHouse/pull/65401) ([Kirill](https://github.com/kirillgarbar))。
- HTTPレスポンスヘッダーをカスタマイズできる新しい設定`http_response_headers`を追加しました。例えば、データベースに保存されている画像をブラウザにレンダリングさせることができます。これにより[#59620](https://github.com/ClickHouse/ClickHouse/issues/59620)が解決されます。[#72656](https://github.com/ClickHouse/ClickHouse/pull/72656) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `DateTime64`を固定秒精度の`Int64`値に変換する関数`toUnixTimestamp64Second`を追加しました。これにより、日付がUnixエポック以前の場合に負の値を返すことができます。[#70597](https://github.com/ClickHouse/ClickHouse/pull/70597) ([zhanglistar](https://github.com/zhanglistar))。[#73146](https://github.com/ClickHouse/ClickHouse/pull/73146) ([Robert Schulze](https://github.com/rschu1ze))。
- ソーステーブルのプロジェクションとセカンダリインデックスのセットがターゲットテーブルのサブセットである場合にアタッチを許可する新しい設定`enforce_index_structure_match_on_partition_manipulation`を追加しました。[#70602](https://github.com/ClickHouse/ClickHouse/issues/70602)を解決します。[#70603](https://github.com/ClickHouse/ClickHouse/pull/70603) ([zwy991114](https://github.com/zwy991114))。
- ALTER USER `{ADD|MODIFY|DROP SETTING}`、ALTER USER `{ADD|DROP PROFILE}`の構文を追加しました。ALTER ROLEおよびALTER PROFILEについても同様です。これにより、すべての設定セットを置き換える代わりに、変更できるようになります。[#72050](https://github.com/ClickHouse/ClickHouse/pull/72050) ([pufit](https://github.com/pufit))。
- 適合率-再現率曲線のAUC(曲線下面積)を計算する`arrayPRAUC`関数を追加しました。[#72073](https://github.com/ClickHouse/ClickHouse/pull/72073) ([Emmanuel](https://github.com/emmanuelsdias))。
- 配列型用の`indexOfAssumeSorted`関数を追加しました。非減少順にソートされた配列の場合に検索を最適化します。効果は非常に大きな配列(100,000要素以上)で現れます。[#72517](https://github.com/ClickHouse/ClickHouse/pull/72517) ([Eric Kurbanov](https://github.com/erickurbanov))。
- 集約関数`groupConcat`のオプションの第2引数として区切り文字を使用できるようになりました。[#72540](https://github.com/ClickHouse/ClickHouse/pull/72540) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- 関数`translate`は、`from`引数が`to`引数よりも多くの文字を含む場合に文字削除をサポートするようになりました。例:`SELECT translate('clickhouse', 'clickhouse', 'CLICK')`は`CLICK`を返すようになりました。[#71441](https://github.com/ClickHouse/ClickHouse/pull/71441) ([shuai.xu](https://github.com/shuai-xu))。

#### 実験的機能 {#experimental-features}

- MergeTreeのソートキーで降順ソートをサポートする新しい設定`allow_experimental_reverse_key`。時系列分析、特にTopNクエリで有用です。使用例：`ENGINE = MergeTree ORDER BY (time DESC, key)` - `time`フィールドを降順でソート。[#71095](https://github.com/ClickHouse/ClickHouse/pull/71095) ([Amos Bird](https://github.com/amosbird))。


#### パフォーマンス改善 {#performance-improvement}

- JOIN の並び替え。クエリプランにおいて内部(ビルド)テーブルとして機能する結合の側を選択するオプションが追加されました。これは `query_plan_join_swap_table` で制御され、`auto` に設定できます。このモードでは、ClickHouse は行数が最も少ないテーブルを選択しようとします。[#71577](https://github.com/ClickHouse/ClickHouse/pull/71577) ([Vladimir Cherkasov](https://github.com/vdimir))。
- `join_algorithm` 設定が `default` に設定されている場合、`parallel_hash` アルゴリズムが(該当する場合)使用されるようになりました。`parallel_hash` が使用できない場合は、以前の2つの代替手段(`direct` と `hash`)が引き続き考慮されます。[#70788](https://github.com/ClickHouse/ClickHouse/pull/70788) ([Nikita Taranov](https://github.com/nickitat))。
- 結合中に使用されるハッシュテーブルの数を減らすために、`WHERE` および `ON` 式から共通式を抽出するオプションが追加されました。これは、JOIN ON 条件が異なる OR 部分の AND 内に共通部分を持つ場合に有効です。`optimize_extract_common_expressions = 1` で有効化できます。[#71537](https://github.com/ClickHouse/ClickHouse/pull/71537) ([János Benjamin Antal](https://github.com/antaljanosbenjamin))。
- インデックス付きカラムが `LowCardinality(String)` にキャストされる場合に `SELECT` でインデックスを使用できるようになりました。これは、一部のテーブルが `String` を持ち、一部が `LowCardinality(String)` を持つ Merge テーブルに対してクエリを実行する場合に該当します。[#71598](https://github.com/ClickHouse/ClickHouse/pull/71598) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- 並列レプリカとローカルプランが有効な状態でのクエリ実行中、ワーカーではインデックス解析を実行しません。コーディネーターは、自身の側(クエリ開始側)でのインデックス解析に基づいて、ワーカーが読み取る範囲を選択します。これにより、並列レプリカを使用する短いクエリが、シングルノードクエリと同程度の低レイテンシを実現します。[#72109](https://github.com/ClickHouse/ClickHouse/pull/72109) ([Igor Nikonov](https://github.com/devcrafter))。
- オブジェクトストレージディスクにおける `clickhouse disks remove --recursive` のメモリ使用量が削減されました。[#67323](https://github.com/ClickHouse/ClickHouse/pull/67323) ([Kirill](https://github.com/kirillgarbar))。
- [#57631](https://github.com/ClickHouse/ClickHouse/pull/57631) からのコンパクトパートにおける単一カラムのサブカラム読み取りの最適化を復元しました。誤って削除されていました。[#72285](https://github.com/ClickHouse/ClickHouse/pull/72285) ([Pavel Kruglov](https://github.com/Avogar))。
- コンパレータ内の呼び出しを非仮想化することで、`LowCardinality(String)` カラムのソートを高速化しました。[#72337](https://github.com/ClickHouse/ClickHouse/pull/72337) ([Alexander Gololobov](https://github.com/davenger))。
- 一部の単純なデータ型に対して関数 `argMin`/`argMax` を最適化しました。[#72350](https://github.com/ClickHouse/ClickHouse/pull/72350) ([alesapin](https://github.com/alesapin))。
- メモリトラッカーにおける共有ロックでのロック処理を最適化し、ロック競合を削減しました。これにより、CPU 数が非常に多いシステムでのパフォーマンスが向上します。[#72375](https://github.com/ClickHouse/ClickHouse/pull/72375) ([Jiebin Sun](https://github.com/jiebinn))。
- 新しい設定 `use_async_executor_for_materialized_views` が追加されました。マテリアライズドビュークエリの非同期および潜在的にマルチスレッド実行を使用し、INSERT 中のビュー処理を高速化できますが、より多くのメモリを消費します。[#72497](https://github.com/ClickHouse/ClickHouse/pull/72497) ([alesapin](https://github.com/alesapin))。
- 集約関数の状態のデシリアライゼーションのパフォーマンスが向上しました(データ型 `AggregateFunction` および分散クエリにおいて)。フォーマット `RowBinary` の解析パフォーマンスがわずかに向上しました。[#72818](https://github.com/ClickHouse/ClickHouse/pull/72818) ([Anton Popov](https://github.com/CurtizJ))。
- 並列レプリカでの読み取り時に、テーブルのキーの順序で範囲を分割し、読み取り中のメモリ消費を削減しました。[#72173](https://github.com/ClickHouse/ClickHouse/pull/72173) ([JIaQi](https://github.com/JiaQiTang98))。
- 挿入されるバッチ内にパーティションキーの単一値がある場合の、マージツリーへの挿入を高速化しました。[#72348](https://github.com/ClickHouse/ClickHouse/pull/72348) ([alesapin](https://github.com/alesapin))。
- バックアップからの復元時にテーブルを並列作成する機能を実装しました。この PR 以前は、`RESTORE` コマンドは常に1つのスレッドでテーブルを作成していたため、多数のテーブルを含むバックアップの場合に遅くなる可能性がありました。[#72427](https://github.com/ClickHouse/ClickHouse/pull/72427) ([Vitaly Baranov](https://github.com/vitlibar))。
- マークキャッシュが大きい場合、その削除には顕著な時間がかかる可能性があります。この間にコンテキストミューテックスを保持すると、多くの他のアクティビティがブロックされ、解放されるまで新しいクライアント接続さえ確立できません。このミューテックスの保持は同期のために実際には必要なく、共有ポインタを介してキャッシュへのローカル参照を持つだけで十分です。[#72749](https://github.com/ClickHouse/ClickHouse/pull/72749) ([Alexander Gololobov](https://github.com/davenger))。





#### 改善 {#improvement}

- `allow_experimental_join_condition` 設定を削除し、非等価条件をデフォルトで許可します。[#69910](https://github.com/ClickHouse/ClickHouse/pull/69910) ([Vladimir Cherkasov](https://github.com/vdimir))。
- サーバー設定（users.xml）の設定がクライアントにも適用されるようになりました。フォーマット設定（例：`date_time_output_format`）に有用です。[#71178](https://github.com/ClickHouse/ClickHouse/pull/71178) ([Michael Kolupaev](https://github.com/al13n321))。
- サーバー/ユーザーのメモリ使用量に基づいて、`GROUP BY`/`ORDER BY` を自動的にディスクに書き出します。`max_bytes_ratio_before_external_group_by`/`max_bytes_ratio_before_external_sort` クエリ設定で制御されます。[#71406](https://github.com/ClickHouse/ClickHouse/pull/71406) ([Azat Khuzhin](https://github.com/azat))。
- 新しいキャンセルロジックを追加：`CancellationChecker` は開始されたすべてのクエリのタイムアウトをチェックし、タイムアウトに達すると停止します。[#69880](https://github.com/ClickHouse/ClickHouse/pull/69880) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- `Object` から `JSON` への ALTER をサポートし、非推奨の Object 型から簡単に移行できるようになりました。[#71784](https://github.com/ClickHouse/ClickHouse/pull/71784) ([Pavel Kruglov](https://github.com/Avogar))。
- Enum に存在しない未知の値をセットで許可します。修正 [#72662](https://github.com/ClickHouse/ClickHouse/issues/72662)。[#72686](https://github.com/ClickHouse/ClickHouse/pull/72686) ([zhanglistar](https://github.com/zhanglistar))。
- `Enum` データ型に対する文字列検索演算子（例：LIKE）をサポートします。実装 [#72661](https://github.com/ClickHouse/ClickHouse/issues/72661)。[#72732](https://github.com/ClickHouse/ClickHouse/pull/72732) ([zhanglistar](https://github.com/zhanglistar))。
- 意味のない ALTER USER クエリが受け入れられていました。修正 [#71227](https://github.com/ClickHouse/ClickHouse/issues/71227)。[#71286](https://github.com/ClickHouse/ClickHouse/pull/71286) ([Arthur Passos](https://github.com/arthurpassos))。
- 分散 `INSERT ... SELECT` のプラン構築時に `prefer_locahost_replica` を尊重します。[#72190](https://github.com/ClickHouse/ClickHouse/pull/72190) ([filimonov](https://github.com/filimonov))。
- Azure は Iceberg 仕様に違反し、Iceberg v1 を誤って Iceberg v2 としてラベル付けしていました。この問題は[こちらで説明されています](https://github.com/ClickHouse/ClickHouse/issues/72091)。Azure Iceberg Writer は仕様に違反する Iceberg メタデータファイル（およびマニフェストファイル）を作成します。現在、v2 リーダーで v1 Iceberg フォーマットのメタデータを読み取ろうと試み（彼らがそのように書き込むため）、マニフェストファイルに対応するフィールドを作成しなかった場合にエラーを追加しました。[#72277](https://github.com/ClickHouse/ClickHouse/pull/72277) ([Daniil Ivanik](https://github.com/divanik))。
- クエリ内で `UNION [ALL]` を使用した `CREATE MATERIALIZED VIEW` が許可されるようになりました。動作は `JOIN` を使用したマテリアライズドビューと同じです：`SELECT` 式の最初のテーブルのみが挿入のトリガーとして機能し、他のすべてのテーブルは無視されます。ただし、最初のテーブルへの参照が多数ある場合（例：自身との UNION）、それらすべてが挿入されたデータブロックとして処理されます。[#72347](https://github.com/ClickHouse/ClickHouse/pull/72347) ([alesapin](https://github.com/alesapin))。
- ClickHouse がディクショナリのソースとして使用される場合のソースクエリ検証を追加しました。[#72548](https://github.com/ClickHouse/ClickHouse/pull/72548) ([Alexey Katsman](https://github.com/alexkats))。
- 設定の再読み込み時に ClickHouse が ZooKeeper の変更を確実に認識するようにしました。[#72593](https://github.com/ClickHouse/ClickHouse/pull/72593) ([Azat Khuzhin](https://github.com/azat))。
- キャッシュされたマークのメモリ使用量の推定を改善し、キャッシュの総メモリ使用量を削減しました。[#72630](https://github.com/ClickHouse/ClickHouse/pull/72630) ([Antonio Andelic](https://github.com/antonio2368))。
- 新しい `StartupScriptsExecutionState` メトリックを追加しました。このメトリックは3つの値を持ちます：0 = 起動スクリプトがまだ完了していない、1 = 起動スクリプトが正常に実行された、2 = 起動スクリプトが失敗した。このメトリックは、特に基本設定へのリリース後に、クラウドで起動スクリプトが正常に実行されているかどうかを知る必要があるため必要です。[#72637](https://github.com/ClickHouse/ClickHouse/pull/72637) ([Miсhael Stetsyuk](https://github.com/mstetsyuk))。
- 新しい `MergeTreeIndexGranularityInternalArraysTotalSize` メトリックを `system.metrics` に追加しました。このメトリックは、高い
- レプリケートされたテーブルの作成にリトライを追加しました。[#72682](https://github.com/ClickHouse/ClickHouse/pull/72682) ([Vitaly Baranov](https://github.com/vitlibar))。
- 非アクティブなパートの総バイト数をカウントするために、`system.tables` に `total_bytes_with_inactive` を追加しました。[#72690](https://github.com/ClickHouse/ClickHouse/pull/72690) ([Kai Zhu](https://github.com/nauu))。
- MergeTree 設定を `system.settings_changes` に追加しました。[#72694](https://github.com/ClickHouse/ClickHouse/pull/72694) ([Raúl Marín](https://github.com/Algunenano))。
- `notEmpty` 関数で JSON 型をサポートしました。[#72741](https://github.com/ClickHouse/ClickHouse/pull/72741) ([Pavel Kruglov](https://github.com/Avogar))。
- GCS S3 エラー `AuthenticationRequired` の解析をサポートしました。[#72753](https://github.com/ClickHouse/ClickHouse/pull/72753) ([Vitaly Baranov](https://github.com/vitlibar))。
- 関数 `ifNull` および `coalesce` で `Dynamic` 型をサポートしました。[#72772](https://github.com/ClickHouse/ClickHouse/pull/72772) ([Pavel Kruglov](https://github.com/Avogar))。
- 関数 `toFloat64`/`touInt32`/等で `Dynamic` をサポートしました。[#72989](https://github.com/ClickHouse/ClickHouse/pull/72989) ([Pavel Kruglov](https://github.com/Avogar))。
- S3 リクエスト設定 `http_max_fields`、`http_max_field_name_size`、`http_max_field_value_size` を追加し、バックアップ作成またはリストア中の S3 API レスポンスの解析時に使用します。[#72778](https://github.com/ClickHouse/ClickHouse/pull/72778) ([Vitaly Baranov](https://github.com/vitlibar))。
- Storage S3(Azure)Queue の keeper 内のテーブルメタデータは、このメタデータを使用する最後のテーブルが削除された後にのみ削除されます。[#72810](https://github.com/ClickHouse/ClickHouse/pull/72810) ([Kseniia Sumarokova](https://github.com/kssenii))。
- `JoinBuildTableRowCount`/`JoinProbeTableRowCount/JoinResultRowCount` プロファイルイベントを追加しました。[#72842](https://github.com/ClickHouse/ClickHouse/pull/72842) ([Vladimir Cherkasov](https://github.com/vdimir))。
- MergeTree のソートキーとスキップインデックスでサブカラムをサポートしました。[#72644](https://github.com/ClickHouse/ClickHouse/pull/72644) ([Pavel Kruglov](https://github.com/Avogar))。





#### バグ修正（公式安定版リリースにおけるユーザーに見える不具合） {#bug-fix-user-visible-misbehavior-in-an-official-stable-release}

- MergeTreeにおいて、パートをdetachedディレクトリに移動する操作が失敗した後(オブジェクトストレージ上の操作が原因の可能性あり)に発生し得るパートの交差を修正しました。[#70476](https://github.com/ClickHouse/ClickHouse/pull/70476) ([Azat Khuzhin](https://github.com/azat))。
- テーブル名が長すぎる場合のエラー検出を修正しました。最大長を示す診断メッセージを提供します。新しい関数`getMaxTableNameLengthForDatabase`を追加しました。[#70810](https://github.com/ClickHouse/ClickHouse/pull/70810) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- `clickhouse-library-bridge`(安全でないライブラリを実行できるプログラム)のクラッシュ後に発生するゾンビプロセスを修正しました。[#71301](https://github.com/ClickHouse/ClickHouse/pull/71301) ([MikhailBurdukov](https://github.com/MikhailBurdukov))。
- `plain_rewritable`ディスクでディレクトリの作成が失敗した際のトランザクションロールバック中に発生するNoSuchKeyエラーを修正しました。[#71439](https://github.com/ClickHouse/ClickHouse/pull/71439) ([Julia Kartseva](https://github.com/jkartseva))。
- `Pretty` JSON形式における`Dynamic`値のシリアライゼーションを修正しました。[#71923](https://github.com/ClickHouse/ClickHouse/pull/71923) ([Pavel Kruglov](https://github.com/Avogar))。
- `File`/`S3`/`URL`/`HDFS`/`Azure`エンジンのCREATEクエリに推論されたフォーマット名を追加しました。以前は、サーバーが再起動されるたびにフォーマット名が推論されており、指定されたデータファイルが削除されていた場合、サーバー起動時にエラーが発生していました。[#72108](https://github.com/ClickHouse/ClickHouse/pull/72108) ([Pavel Kruglov](https://github.com/Avogar))。
- 旧アナライザーでJOIN ON式にUDFを使用する際のバグを修正しました。[#72179](https://github.com/ClickHouse/ClickHouse/pull/72179) ([Raúl Marín](https://github.com/Algunenano))。
- `StorageObjectStorage`のいくつかの小さなバグを修正しました。`use_hive_partitioning`をデフォルトで有効にする必要があります。[#72185](https://github.com/ClickHouse/ClickHouse/pull/72185) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- `min_age_to_force_merge_on_partition_only`が、すでに単一パートにマージされた同じパーティションを繰り返しマージしようとしてスタックし、複数のパートを持つパーティションをマージしないバグを修正しました。[#72209](https://github.com/ClickHouse/ClickHouse/pull/72209) ([Christoph Wurm](https://github.com/cwurm))。
- スパースカラムを処理する際にまれに発生する`SimpleSquashingChunksTransform`のクラッシュを修正しました。[#72226](https://github.com/ClickHouse/ClickHouse/pull/72226) ([Vladimir Cherkasov](https://github.com/vdimir))。
- `GraceHashJoin`におけるデータ競合を修正しました。この競合により、JOIN出力で一部の行が欠落する可能性がありました。[#72233](https://github.com/ClickHouse/ClickHouse/pull/72233) ([Nikita Taranov](https://github.com/nickitat))。
- マテリアライズされた`_block_number`カラムを使用した`ALTER DELETE`クエリを修正しました(設定`enable_block_number_column`が有効な場合)。[#72261](https://github.com/ClickHouse/ClickHouse/pull/72261) ([Anton Popov](https://github.com/CurtizJ))。
- `ColumnDynamic::dumpStructure()`が同時に呼び出された際のデータ競合を修正しました(例: `ConcurrentHashJoin`コンストラクタ内)。[#72278](https://github.com/ClickHouse/ClickHouse/pull/72278) ([Nikita Taranov](https://github.com/nickitat))。
- `ORDER BY ... WITH FILL`で重複カラムがある場合に発生し得る`LOGICAL_ERROR`を修正しました。[#72387](https://github.com/ClickHouse/ClickHouse/pull/72387) ([Vladimir Cherkasov](https://github.com/vdimir))。
- `optimize_functions_to_subcolumns`を適用した後のいくつかのケースにおける型の不一致を修正しました。[#72394](https://github.com/ClickHouse/ClickHouse/pull/72394) ([Anton Popov](https://github.com/CurtizJ))。
- `AWS_CONTAINER_AUTHORIZATION_TOKEN_PATH`の代わりに`AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE`を使用するようにしました。[#71074](https://github.com/ClickHouse/ClickHouse/issues/71074)を修正します。[#72397](https://github.com/ClickHouse/ClickHouse/pull/72397) ([Konstantin Bogdanov](https://github.com/thevar1able))。
- `BACKUP DATABASE db EXCEPT TABLES db.table`クエリの解析失敗を修正しました。[#72429](https://github.com/ClickHouse/ClickHouse/pull/72429) ([Konstantin Bogdanov](https://github.com/thevar1able))。
- 空の`Variant`の作成を許可しないようにしました。[#72454](https://github.com/ClickHouse/ClickHouse/pull/72454) ([Pavel Kruglov](https://github.com/Avogar))。
- `system.merges`における`result_part_path`の無効なフォーマットを修正しました。[#72567](https://github.com/ClickHouse/ClickHouse/pull/72567) ([Konstantin Bogdanov](https://github.com/thevar1able))。
- 単一要素のglobの解析を修正しました(`{file}`など)。[#72572](https://github.com/ClickHouse/ClickHouse/pull/72572) ([Konstantin Bogdanov](https://github.com/thevar1able))。
- `ARRAY JOIN`を含む分散クエリの場合のフォロワーサーバーに対するクエリ生成を修正しました。[#69276](https://github.com/ClickHouse/ClickHouse/issues/69276)を修正します。[#72608](https://github.com/ClickHouse/ClickHouse/pull/72608) ([Dmitry Novik](https://github.com/novikd))。
- DateTime64 IN DateTime64が何も返さないバグを修正しました。[#72640](https://github.com/ClickHouse/ClickHouse/pull/72640) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- `flatten_nested=0`で作成されたテーブルを持つReplicatedデータベースに新しいレプリカを追加する際のメタデータの不整合を修正しました。[#72685](https://github.com/ClickHouse/ClickHouse/pull/72685) ([Alexander Tokmakov](https://github.com/tavplubix))。
- Keeperの内部通信における高度なSSL設定を修正しました。[#72730](https://github.com/ClickHouse/ClickHouse/pull/72730) ([Antonio Andelic](https://github.com/antonio2368))。
- S3Queueの順序なしモードで、`tracked_files_limit`設定がS3ファイルの出現率より小さい場合に発生する「No such key」エラーを修正しました。[#72738](https://github.com/ClickHouse/ClickHouse/pull/72738) ([Kseniia Sumarokova](https://github.com/kssenii))。
- ユーザーがローカルに存在しない場合にRemoteQueryExecutorでスローされる例外を修正しました。[#72759](https://github.com/ClickHouse/ClickHouse/pull/72759) ([Andrey Zvonov](https://github.com/zvonand))。
- マテリアライズされた`_block_number`カラムを使用したミューテーションを修正しました(設定`enable_block_number_column`が有効な場合)。[#72854](https://github.com/ClickHouse/ClickHouse/pull/72854) ([Anton Popov](https://github.com/CurtizJ))。
- バックアップに空のファイルが含まれる場合のplain rewritableディスクでのバックアップ/リストアを修正しました。[#72858](https://github.com/ClickHouse/ClickHouse/pull/72858) ([Kseniia Sumarokova](https://github.com/kssenii))。
- DistributedAsyncInsertDirectoryQueueでのインサートを適切にキャンセルするようにしました。[#72885](https://github.com/ClickHouse/ClickHouse/pull/72885) ([Antonio Andelic](https://github.com/antonio2368))。
- スパースカラムへの不正なデータの解析中に発生するクラッシュを修正しました(設定`enable_parsing_to_custom_serialization`が有効な場合に発生する可能性があります)。[#72891](https://github.com/ClickHouse/ClickHouse/pull/72891) ([Anton Popov](https://github.com/CurtizJ))。
- バックアップリストア中に発生し得るクラッシュを修正しました。[#72947](https://github.com/ClickHouse/ClickHouse/pull/72947) ([Kseniia Sumarokova](https://github.com/kssenii))。
- `parallel_hash` JOINメソッドにおいて、クエリの`ON`句に不等式フィルタを含む複雑な条件がある場合に発生し得るバグを修正しました。[#72993](https://github.com/ClickHouse/ClickHouse/pull/72993) ([Nikita Taranov](https://github.com/nickitat))。
- JSON解析中にデフォルトのフォーマット設定を使用して、デシリアライゼーションの破損を回避するようにしました。[#73043](https://github.com/ClickHouse/ClickHouse/pull/73043) ([Pavel Kruglov](https://github.com/Avogar))。
- サポートされていないストレージを使用したトランザクションでのクラッシュを修正しました。[#73045](https://github.com/ClickHouse/ClickHouse/pull/73045) ([Raúl Marín](https://github.com/Algunenano))。
- メモリトラッキングの過大評価の可能性を修正しました(`MemoryTracking`と`MemoryResident`の差が増加し続ける場合)。[#73081](https://github.com/ClickHouse/ClickHouse/pull/73081) ([Azat Khuzhin](https://github.com/azat))。
- Tuple解析中に重複するJSONキーをチェックするようにしました。以前は、解析中に論理エラー`Invalid number of rows in Chunk`が発生する可能性がありました。[#73082](https://github.com/ClickHouse/ClickHouse/pull/73082) ([Pavel Kruglov](https://github.com/Avogar))。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement}

- 以前は `/utils` フォルダに格納され、ソースからの手動コンパイルが必要だったすべての小規模ユーティリティが、メインのClickHouseバンドルの一部になりました。これにより以下の問題がクローズされます: [#72404](https://github.com/ClickHouse/ClickHouse/issues/72404)。[#72426](https://github.com/ClickHouse/ClickHouse/pull/72426) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 22.3で導入された `/etc/systemd/system/clickhouse-server.service` の削除を廃止しました [#39323](https://github.com/ClickHouse/ClickHouse/issues/39323)。[#72259](https://github.com/ClickHouse/ClickHouse/pull/72259) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- メモリ/CPU制限によるコンパイル失敗を回避するため、大規模な翻訳単位を分割しました。[#72352](https://github.com/ClickHouse/ClickHouse/pull/72352) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
- OSX: ICUサポートを有効にしてビルドし、照合順序、文字セット変換、その他のローカライゼーション機能を利用可能にしました。[#73083](https://github.com/ClickHouse/ClickHouse/pull/73083) ([Raúl Marín](https://github.com/Algunenano))。

### <a id="2411"></a> ClickHouseリリース24.11、2024-11-26 {#a-id2411a-clickhouse-release-2411-2024-11-26}

#### 後方互換性のない変更 {#backward-incompatible-change-1}

- システムテーブル `generate_series` と `generateSeries` を削除しました。これらは誤って追加されたものです: [#59390](https://github.com/ClickHouse/ClickHouse/issues/59390)。[#71091](https://github.com/ClickHouse/ClickHouse/pull/71091) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `StorageExternalDistributed` を削除しました。[#70600](https://github.com/ClickHouse/ClickHouse/issues/70600)をクローズします。[#71176](https://github.com/ClickHouse/ClickHouse/pull/71176) ([flynn](https://github.com/ucasfl))。
- テーブルエンジンKafka、NATS、RabbitMQは、`SOURCES` 階層内で独自の権限でカバーされるようになりました。これらのエンジンタイプでテーブルを作成するデフォルト以外のデータベースユーザーに権限を追加してください。[#71250](https://github.com/ClickHouse/ClickHouse/pull/71250) ([Christoph Wurm](https://github.com/cwurm))。
- 実行前にミューテーションクエリ全体をチェックします(サブクエリを含む)。これにより、無効なクエリを誤って実行し、有効なミューテーションをブロックするデッドミューテーションが蓄積されることを防ぎます。[#71300](https://github.com/ClickHouse/ClickHouse/pull/71300) ([Christoph Wurm](https://github.com/cwurm))。
- ファイルシステムキャッシュ設定 `skip_download_if_exceeds_query_cache` を `filesystem_cache_skip_download_if_exceeds_per_query_cache_write_limit` に名称変更しました。[#71578](https://github.com/ClickHouse/ClickHouse/pull/71578) ([Kseniia Sumarokova](https://github.com/kssenii))。
- `deltaSumTimestamp` における `Enum`、`UInt128`、`UInt256` 引数のサポートを削除しました。`deltaSumTimestamp` の第2引数("timestamp")における `Int8`、`UInt8`、`Int16`、`UInt16` のサポートを削除しました。[#71790](https://github.com/ClickHouse/ClickHouse/pull/71790) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- Dictionaryストレージ、ディクショナリテーブル関数、またはディクショナリ自体からの直接SELECTを使用してディクショナリから直接データを取得する場合、ディクショナリに対する `SELECT` 権限または `dictGet` 権限があれば十分になりました。これは、ACLバイパスを防ぐための以前の試み(https://github.com/ClickHouse/ClickHouse/pull/57362 および https://github.com/ClickHouse/ClickHouse/pull/65359)と整合性を取るものです。また、後者を後方互換性のあるものにします。[#72051](https://github.com/ClickHouse/ClickHouse/pull/72051) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。


#### 実験的機能 {#experimental-feature}

- すべての実験的機能/ベータ機能を無効化するグローバルスイッチとして`allow_feature_tier`を実装しました。[#71841](https://github.com/ClickHouse/ClickHouse/pull/71841) [#71145](https://github.com/ClickHouse/ClickHouse/pull/71145) ([Raúl Marín](https://github.com/Algunenano))。
- JSONサブカラム用ファイル内のエスケープされていない特殊記号による`No such file or directory`エラーの可能性を修正しました。[#71182](https://github.com/ClickHouse/ClickHouse/pull/71182) ([Pavel Kruglov](https://github.com/Avogar))。
- StringからJSONへのalterをサポートしました。このPRはJSONおよびDynamic型のシリアライゼーションを新バージョンV2に変更します。旧バージョンV1は設定`merge_tree_use_v1_object_and_dynamic_serialization`を有効にすることで引き続き使用できます(アップグレード中に問題なくバージョンをロールバックできるようにするために使用可能)。[#70442](https://github.com/ClickHouse/ClickHouse/pull/70442) ([Pavel Kruglov](https://github.com/Avogar))。
- JSON文字列からのシリアライゼーション/デシリアライゼーションを通じて、Map/Tuple/Objectから新しいJSONへの単純なCASTを実装しました。[#71320](https://github.com/ClickHouse/ClickHouse/pull/71320) ([Pavel Kruglov](https://github.com/Avogar))。
- 予期しない結果につながる可能性があるため、デフォルトではORDER BY/GROUP BY/PARTITION BY/PRIMARY KEYでVariant/Dynamic型を許可しないようにしました。[#69731](https://github.com/ClickHouse/ClickHouse/pull/69731) ([Pavel Kruglov](https://github.com/Avogar))。
- 混乱を避けるため、min/max関数でDynamic/Variant型を禁止しました。[#71761](https://github.com/ClickHouse/ClickHouse/pull/71761) ([Pavel Kruglov](https://github.com/Avogar))。

#### 新機能 {#new-feature-1}

- ワークロードとリソース管理を記述するためのSQL構文を追加しました。https://clickhouse.com/docs/operations/workload-scheduling。[#69187](https://github.com/ClickHouse/ClickHouse/pull/69187) ([Sergei Trifonov](https://github.com/serxa))。
- 新しいデータ型`BFloat16`は、8ビット指数部、符号、7ビット仮数部を持つ16ビット浮動小数点数を表します。これにより[#44206](https://github.com/ClickHouse/ClickHouse/issues/44206)がクローズされます。これにより[#49937](https://github.com/ClickHouse/ClickHouse/issues/49937)がクローズされます。[#64712](https://github.com/ClickHouse/ClickHouse/pull/64712) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 現在のユーザー/ロールに特定の権限が付与されているか、および対応するテーブル/カラムがメモリ内に存在するかを確認するための`CHECK GRANT`クエリを追加しました。[#68885](https://github.com/ClickHouse/ClickHouse/pull/68885) ([Unalian](https://github.com/Unalian))。
- `iceberg[S3;HDFS;Azure]Cluster`、`deltaLakeCluster`、`hudiCluster`テーブル関数を追加しました。[#72045](https://github.com/ClickHouse/ClickHouse/pull/72045) ([Mikhail Artemenko](https://github.com/Michicosun))。
- http_handlers(`dynamic_query_handler`/`predefined_query_handler`用)でユーザー/パスワードを設定する機能を追加しました。[#70725](https://github.com/ClickHouse/ClickHouse/pull/70725) ([Azat Khuzhin](https://github.com/azat))。
- ORDER BY WITH FILL演算子でstaleness句のサポートを追加しました。[#71151](https://github.com/ClickHouse/ClickHouse/pull/71151) ([Mikhail Artemenko](https://github.com/Michicosun))。
- 各認証方法が独自の有効期限を持つことを許可し、ユーザーエンティティから削除しました。[#70090](https://github.com/ClickHouse/ClickHouse/pull/70090) ([Arthur Passos](https://github.com/arthurpassos))。
- 新しい関数`parseDateTime64`、`parseDateTime64OrNull`、`parseDateTime64OrZero`を追加しました。既存の関数`parseDateTime`(およびその派生)と比較して、これらは`DateTime`の代わりに`DateTime64`型の値を返します。[#71581](https://github.com/ClickHouse/ClickHouse/pull/71581) ([kevinyhzou](https://github.com/KevinyhZou))。


#### パフォーマンス改善 {#performance-improvement-1}

- パート内でグラニュラリティが一定の場合、インデックスグラニュラリティ値のメモリ使用量を最適化しました。パートに対して常に一定のグラニュラリティを選択する機能(設定 `use_const_adaptive_granularity`)を追加し、メモリ内で常に最適化されることを保証します。大規模なワークロード(共有ストレージ内の数兆行)において、データパートのメタデータ(インデックスグラニュラリティ値)によるメモリ使用量の継続的な増加を回避するのに役立ちます。[#71786](https://github.com/ClickHouse/ClickHouse/pull/71786) ([Anton Popov](https://github.com/CurtizJ))。
- `join_algorithm = 'parallel_hash'` の場合、並列処理のためにスレッド間で分散する際に、入力ブロックの列をコピーしなくなりました。[#67782](https://github.com/ClickHouse/ClickHouse/pull/67782) ([Nikita Taranov](https://github.com/nickitat))。
- 交差しないパートに対する `Replacing` マージアルゴリズムを最適化しました。[#70977](https://github.com/ClickHouse/ClickHouse/pull/70977) ([Anton Popov](https://github.com/CurtizJ))。
- メトリクスおよび system.detached_parts において、読み取り専用および書き込み1回のディスクからデタッチされたパートをリストしないようにしました。[#71086](https://github.com/ClickHouse/ClickHouse/pull/71086) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- デフォルトでは重い非同期メトリクスを計算しないようにしました。この機能は [#40332](https://github.com/ClickHouse/ClickHouse/issues/40332) で導入されましたが、単一の顧客のためだけに必要な重いバックグラウンドジョブを持つことは適切ではありません。[#71087](https://github.com/ClickHouse/ClickHouse/pull/71087) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `plain_rewritable` ディスクの場合: ディレクトリをリストする際にオブジェクトストレージ API を呼び出さないようにしました。これはコスト効率が悪い可能性があるためです。代わりに、ファイル名のリストをメモリに保存します。トレードオフとして、初期ロード時間の増加とファイル名を保存するために必要なメモリが増加します。[#70823](https://github.com/ClickHouse/ClickHouse/pull/70823) ([Julia Kartseva](https://github.com/jkartseva))。
- クリティカルリージョンを削減することで、`system.query_metric_log` の収集間隔のパフォーマンスと精度を向上させました。[#71473](https://github.com/ClickHouse/ClickHouse/pull/71473) ([Pablo Marcos](https://github.com/pamarcos))。
- 仮想行を生成することによる順序読み取り最適化により、マージソート中に読み取られるデータ量が削減されます。特に複数のパートが存在する場合に有用です。[#62125](https://github.com/ClickHouse/ClickHouse/pull/62125) ([Shichao Jin](https://github.com/jsc0218))。
- システムデータベースが完全にロードされていない状態でサーバーを起動できるサーバー設定 `async_load_system_database` を追加しました。これにより、多数のシステムテーブルが存在する場合に ClickHouse をより高速に起動できます。[#69847](https://github.com/ClickHouse/ClickHouse/pull/69847) ([Sergei Trifonov](https://github.com/serxa))。
- `clickhouse-compressor` に `--threads` パラメータを追加しました。これにより、データを並列で圧縮できます。[#70860](https://github.com/ClickHouse/ClickHouse/pull/70860) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 設定 `prewarm_mark_cache` を追加しました。これにより、挿入、マージ、パートのフェッチ、およびテーブルの起動時にマークをマークキャッシュにロードできます。[#71053](https://github.com/ClickHouse/ClickHouse/pull/71053) ([Anton Popov](https://github.com/CurtizJ))。
- MergeTree テーブルエンジンファミリーのメモリフットプリントを削減するために、メモリ内の index_granularity 配列を縮小してフィットさせるようにしました。[#71595](https://github.com/ClickHouse/ClickHouse/pull/71595) ([alesapin](https://github.com/alesapin))。
- 非ディスク読み取りに対してファイルシステムキャッシュ設定 `boundary_alignment` をオフにしました。これにより、キャッシュを使用したスタンドアロンリモートファイルからの読み取りパフォーマンスが向上します。[#71827](https://github.com/ClickHouse/ClickHouse/pull/71827) ([Kseniia Sumarokova](https://github.com/kssenii))。
- `SELECT * FROM table LIMIT ...` のようなクエリは、使用されていない場合でもパートインデックスをロードしていました。[#71866](https://github.com/ClickHouse/ClickHouse/pull/71866) ([Alexander Gololobov](https://github.com/davenger))。
- `parallel_replicas_local_plan` をデフォルトで有効にしました。クエリイニシエーター上で本格的なローカルプランを構築することで、リソース消費を抑えながら並列レプリカのパフォーマンスが向上し、より多くのクエリ最適化を適用する機会が提供されます。[#70171](https://github.com/ClickHouse/ClickHouse/pull/70171) ([Igor Nikonov](https://github.com/devcrafter))。





#### 改善 {#improvement-1}

- `ch queries.sql`のようにファイル引数を指定してClickHouseを使用できるようになりました。[#71589](https://github.com/ClickHouse/ClickHouse/pull/71589) ([Raúl Marín](https://github.com/Algunenano))。
- `Vertical`フォーマット(クエリの末尾に`\G`を付けることでも有効化されます)に、Prettyフォーマットの機能が追加されました:数値の千の位のグループをハイライト表示し、読みやすい数値のヒントを出力します。[#71630](https://github.com/ClickHouse/ClickHouse/pull/71630) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- クエリ発行元から外部ユーザーロールをクラスタ内の他のノードにプッシュします。発行元のみが外部認証システム(LDAPなど)にアクセスできる場合に有用です。[#70332](https://github.com/ClickHouse/ClickHouse/pull/70332) ([Andrey Zvonov](https://github.com/zvonand))。
- 集約関数`any`に対して`anyRespectNulls`、`firstValueRespectNulls`、`anyValueRespectNulls`のエイリアスを追加しました。また、集約関数`anyLast`に対して`anyLastRespectNulls`と`lastValueRespectNulls`のエイリアスを追加しました。これにより、キャメルケースとアンダースコアが混在した構文ではなく、より自然なキャメルケースのみの構文を使用できます。例えば、`anyLast_respect_nullsStateIf`の代わりに`SELECT anyLastRespectNullsStateIf`を使用できます。[#71403](https://github.com/ClickHouse/ClickHouse/pull/71403) ([Peter Nguyen](https://github.com/petern48))。
- `date_time_utc`設定パラメータを追加し、JSONログフォーマットでRFC 3339/ISO8601形式のUTC日時をサポートできるようにしました。[#71560](https://github.com/ClickHouse/ClickHouse/pull/71560) ([Ali](https://github.com/xogoodnow))。
- S3エンドポイントのユーザー認証用に新しいヘッダータイプ(`access_header`)を追加しました。これにより、最も低い優先度でアクセスヘッダーを取得でき、他のソース(テーブルスキーマや名前付きコレクションなど)からの`access_key_id`で上書きされます。[#71011](https://github.com/ClickHouse/ClickHouse/pull/71011) ([MikhailBurdukov](https://github.com/MikhailBurdukov))。
- 定数配列と定数のキャプチャ引数を持つ高階関数は定数を返すようになりました。[#58400](https://github.com/ClickHouse/ClickHouse/pull/58400) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- クエリプランのステップ名(`EXPLAIN PLAN json=1`)とパイプラインプロセッサ名(`EXPLAIN PIPELINE compact=0,graph=1`)に、サフィックスとして一意のIDが付与されるようになりました。これにより、プロセッサプロファイラの出力やOpenTelemetryトレースをEXPLAIN出力と照合できます。[#63518](https://github.com/ClickHouse/ClickHouse/pull/63518) ([qhsong](https://github.com/qhsong))。
- Azure Blob Storageへの書き込み後にオブジェクトが存在するかを確認するオプションを追加しました。これは`check_objects_after_upload`設定で制御されます。[#64847](https://github.com/ClickHouse/ClickHouse/pull/64847) ([Smita Kulkarni](https://github.com/SmitaRKulkarni))。
- `clickhouse-local`でデフォルトで`Atomic`データベースを使用するようになりました。[#50647](https://github.com/ClickHouse/ClickHouse/issues/50647)の項目1と5に対応しています。[#44817](https://github.com/ClickHouse/ClickHouse/issues/44817)をクローズします。[#68024](https://github.com/ClickHouse/ClickHouse/pull/68024) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- エラーをクライアントに通知するため、例外がHTTPプロトコルを中断するようになりました。[#68800](https://github.com/ClickHouse/ClickHouse/pull/68800) ([Sema Checherinda](https://github.com/CheSema))。
- replica_dirを作成し、DDLWorkerでレプリカをアクティブとしてマークすることで、分散DDLクエリを実行しているホストを報告します。[#69658](https://github.com/ClickHouse/ClickHouse/pull/69658) ([tuanpach](https://github.com/tuanpach))。
- distributed_ddl_output_modeが\*\_only_activeに設定されている場合、database ON CLUSTERクエリではアクティブなレプリカのみを待機します。[#69660](https://github.com/ClickHouse/ClickHouse/pull/69660) ([tuanpach](https://github.com/tuanpach))。
- `ON CLUSTER`バックアップとリストアのエラー処理とキャンセル処理を改善しました:1つのホストでバックアップまたはリストアが失敗した場合、他のホストでも自動的にキャンセルされます - 一部のホストが失敗し他のホストが作業を続行したことによる奇妙なエラーは発生しません - 1つのホストでバックアップまたはリストアがキャンセルされた場合、他のホストでも自動的にキャンセルされます - `test_disallow_concurrency`の問題を修正し、並行処理の無効化がより適切に機能するようになりました - バックアップとリストアがZooKeeperの切断に対してより耐性を持つようになりました。[#70027](https://github.com/ClickHouse/ClickHouse/pull/70027) ([Vitaly Baranov](https://github.com/vitlibar))。
- ストレージS3Queueの特定の設定に対して`ALTER TABLE ... MODIFY/RESET SETTING ...`をサポートしました。[#70811](https://github.com/ClickHouse/ClickHouse/pull/70811) ([Kseniia Sumarokova](https://github.com/kssenii))。
- サーバー証明書の再読み込み手順と同じ方法でクライアント証明書を再読み込みする機能を追加しました。[#70997](https://github.com/ClickHouse/ClickHouse/pull/70997) ([Roman Antonov](https://github.com/Romeo58rus))。
- クライアント履歴サイズを設定可能にし、デフォルトサイズを増加しました。[#71014](https://github.com/ClickHouse/ClickHouse/pull/71014) ([Jiří Kozlovský](https://github.com/jirislav))。
- Parquetネイティブリーダーでブール型をサポートしました。[#71055](https://github.com/ClickHouse/ClickHouse/pull/71055) ([Arthur Passos](https://github.com/arthurpassos))。
- S3との通信時に「Malformed message」などのより多くのエラーを再試行するようになりました。[#71088](https://github.com/ClickHouse/ClickHouse/pull/71088) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- S3に関する一部のメッセージのログレベルを下げました。[#71090](https://github.com/ClickHouse/ClickHouse/pull/71090) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- スペースを含むHDFSファイルの書き込みをサポートしました。[#71105](https://github.com/ClickHouse/ClickHouse/pull/71105) ([exmy](https://github.com/exmy))。
- レプリケートされたテーブル、ディクショナリ、ビューの数を制限する設定を追加しました。[#71179](https://github.com/ClickHouse/ClickHouse/pull/71179) ([Kirill](https://github.com/kirillgarbar))。
- `AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE`が利用可能な場合、`AWS_CONTAINER_AUTHORIZATION_TOKEN`の代わりにそれを使用します。[#71074](https://github.com/ClickHouse/ClickHouse/issues/71074)を修正します。[#71269](https://github.com/ClickHouse/ClickHouse/pull/71269) ([Konstantin Bogdanov](https://github.com/thevar1able))。
- ReplicatedMergeTree再起動スレッドからmetadata_version ZooKeeperノードの作成を削除しました。このノードを作成する必要がある唯一のシナリオは、ユーザーが20.4より前のバージョンから24.10より後のバージョンに直接更新した場合です。ClickHouseは1年以上にわたるアップグレードをサポートしていないため、ノードを作成する代わりに例外をスローし、ユーザーに段階的な更新を求めるべきです。[#71385](https://github.com/ClickHouse/ClickHouse/pull/71385) ([Miсhael Stetsyuk](https://github.com/mstetsyuk))。
- 高度なダッシュボードにホスト別ダッシュボード`Overview (host)`と`Cloud overview (host)`を追加しました。[#71422](https://github.com/ClickHouse/ClickHouse/pull/71422) ([alesapin](https://github.com/alesapin))。
- `clickhouse-local`はデフォルトで暗黙的なSELECTを使用し、電卓として使用できます。暗黙的なSELECTモードの構文ハイライトを改善しました。[#71620](https://github.com/ClickHouse/ClickHouse/pull/71620) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- コマンドラインアプリケーションは複数ステートメントに対しても構文をハイライトするようになりました。[#71622](https://github.com/ClickHouse/ClickHouse/pull/71622) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- コマンドラインアプリケーションはエラー時に非ゼロの終了コードを返すようになりました。以前のバージョンでは、`disks`アプリケーションはエラー時にゼロを返し、他のアプリケーションはエラー256(`PARTITION_ALREADY_EXISTS`)と512(`SET_NON_GRANTED_ROLE`)に対してゼロを返していました。[#71623](https://github.com/ClickHouse/ClickHouse/pull/71623) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- ユーザー/グループがIDとして指定された場合、`clickhouse su`が失敗していました。このパッチにより`UID:GID`も受け入れるように修正されました。[#71626](https://github.com/ClickHouse/ClickHouse/pull/71626) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- `filesystem_cache_prefer_bigger_buffer_size`設定により、ファイルシステムキャッシュのメモリバッファ増加を無効化できるようになりました。[#71640](https://github.com/ClickHouse/ClickHouse/pull/71640) ([Kseniia Sumarokova](https://github.com/kssenii))。
- ファイルシステムキャッシュのバックグラウンドダウンロード最大ファイルセグメントサイズ用に、個別の設定`background_download_max_file_segment_size`を追加しました。[#71648](https://github.com/ClickHouse/ClickHouse/pull/71648) ([Kseniia Sumarokova](https://github.com/kssenii))。
- JSON型の解析をわずかに改善しました:JSONパスの現在のブロックに複数の型の値が含まれている場合、特別なベストエフォート順序で型を試行し、最適な型を選択するようにしました。[#71785](https://github.com/ClickHouse/ClickHouse/pull/71785) ([Pavel Kruglov](https://github.com/Avogar))。
- 以前は`system.asynchronous_metrics`からの読み取りは、並行更新の完了を待機していました。システムが高負荷の場合、これには長時間かかることがあります。この変更により、以前に収集された値を常に読み取れるようになりました。[#71798](https://github.com/ClickHouse/ClickHouse/pull/71798) ([Alexander Gololobov](https://github.com/davenger))。
- S3QueueとAzureQueue:`polling_max_timeout_ms`を10分、`polling_backoff_ms`を30秒に設定しました。[#71817](https://github.com/ClickHouse/ClickHouse/pull/71817) ([Kseniia Sumarokova](https://github.com/kssenii))。
- `history`期間中に`HostResolver`を3回更新します。[#71863](https://github.com/ClickHouse/ClickHouse/pull/71863) ([Sema Checherinda](https://github.com/CheSema))。
- 高度なダッシュボードHTMLページに、`system.dashboards`テーブルからダッシュボードを選択するドロップダウンセレクタを追加しました。[#72081](https://github.com/ClickHouse/ClickHouse/pull/72081) ([Sergei Trifonov](https://github.com/serxa))。
- 認証後にデフォルトデータベースが存在するかを確認します。[#71097](https://github.com/ClickHouse/ClickHouse/issues/71097)を修正します。[#71140](https://github.com/ClickHouse/ClickHouse/pull/71140) ([Konstantin Bogdanov](https://github.com/thevar1able))。





#### バグ修正（公式安定版リリースにおけるユーザーに見える不具合） {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-1}

- The parts deduplicated during `ATTACH PART` query don't get stuck with the `attaching_` prefix anymore. [#65636](https://github.com/ClickHouse/ClickHouse/pull/65636) ([Kirill](https://github.com/kirillgarbar)).
- Fix for the bug when DateTime64 losing precision for the `IN` function. [#67230](https://github.com/ClickHouse/ClickHouse/pull/67230) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fix possible logical error when using functions with `IGNORE/RESPECT NULLS` in `ORDER BY ... WITH FILL`, close [#57609](https://github.com/ClickHouse/ClickHouse/issues/57609). [#68234](https://github.com/ClickHouse/ClickHouse/pull/68234) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Fixed rare logical errors in asynchronous inserts with format `Native` in case of reached memory limit. [#68965](https://github.com/ClickHouse/ClickHouse/pull/68965) ([Anton Popov](https://github.com/CurtizJ)).
- Fix COMMENT in CREATE TABLE for EPHEMERAL column. [#70458](https://github.com/ClickHouse/ClickHouse/pull/70458) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix logical error in JSONExtract with LowCardinality(Nullable). [#70549](https://github.com/ClickHouse/ClickHouse/pull/70549) ([Pavel Kruglov](https://github.com/Avogar)).
- Allow system drop replica zkpath when there is another replica with the same zk path. [#70642](https://github.com/ClickHouse/ClickHouse/pull/70642) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
- Fix a crash and a leak in AggregateFunctionGroupArraySorted. [#70820](https://github.com/ClickHouse/ClickHouse/pull/70820) ([Michael Kolupaev](https://github.com/al13n321)).
- Add ability to override Content-Type by user headers in the URL engine. [#70859](https://github.com/ClickHouse/ClickHouse/pull/70859) ([Artem Iurin](https://github.com/ortyomka)).
- Fix logical error in `StorageS3Queue` "Cannot create a persistent node in /processed since it already exists". [#70984](https://github.com/ClickHouse/ClickHouse/pull/70984) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fixed named sessions not being closed and hanging on forever under certain circumstances. [#70998](https://github.com/ClickHouse/ClickHouse/pull/70998) ([Márcio Martins](https://github.com/marcio-absmartly)).
- Fix the bug that didn't consider \_row_exists column in rebuild option of projection lightweight delete. [#71089](https://github.com/ClickHouse/ClickHouse/pull/71089) ([Shichao Jin](https://github.com/jsc0218)).
- Fix `AT_* is out of range` problem when running on Oracle Linux UEK 6.10. [#71109](https://github.com/ClickHouse/ClickHouse/pull/71109) ([Örjan Fors](https://github.com/op)).
- Fix wrong value in system.query_metric_log due to unexpected race condition. [#71124](https://github.com/ClickHouse/ClickHouse/pull/71124) ([Pablo Marcos](https://github.com/pamarcos)).
- Fix mismatched aggreage function name of quantileExactWeightedInterpolated. The bug was introduced in https://github.com/ClickHouse/ClickHouse/pull/69619. cc @Algunenano. [#71168](https://github.com/ClickHouse/ClickHouse/pull/71168) ([李扬](https://github.com/taiyang-li)).
- Fix bad_weak_ptr exception with Dynamic in functions comparison. [#71183](https://github.com/ClickHouse/ClickHouse/pull/71183) ([Pavel Kruglov](https://github.com/Avogar)).
- Checks that read 7z file is on a local machine. [#71184](https://github.com/ClickHouse/ClickHouse/pull/71184) ([Daniil Ivanik](https://github.com/divanik)).
- Fix ignoring format settings in Native format via HTTP and Async Inserts. [#71193](https://github.com/ClickHouse/ClickHouse/pull/71193) ([Pavel Kruglov](https://github.com/Avogar)).
- SELECT queries run with setting `use_query_cache = 1` are no longer rejected if the name of a system table appears as a literal, e.g. `SELECT * FROM users WHERE name = 'system.metrics' SETTINGS use_query_cache = true;` now works. [#71254](https://github.com/ClickHouse/ClickHouse/pull/71254) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix bug of memory usage increase if enable_filesystem_cache=1, but disk in storage configuration did not have any cache configuration. [#71261](https://github.com/ClickHouse/ClickHouse/pull/71261) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix possible error "Cannot read all data" erros during deserialization of LowCardinality dictionary from Dynamic column. [#71299](https://github.com/ClickHouse/ClickHouse/pull/71299) ([Pavel Kruglov](https://github.com/Avogar)).
- Fix incomplete cleanup of parallel output format in the client. [#71304](https://github.com/ClickHouse/ClickHouse/pull/71304) ([Raúl Marín](https://github.com/Algunenano)).
- Added missing unescaping in named collections. Without fix clickhouse-server can't start. [#71308](https://github.com/ClickHouse/ClickHouse/pull/71308) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
- Fix async inserts with empty blocks via native protocol. [#71312](https://github.com/ClickHouse/ClickHouse/pull/71312) ([Anton Popov](https://github.com/CurtizJ)).
- Fix inconsistent AST formatting when granting wrong wildcard grants [#71309](https://github.com/ClickHouse/ClickHouse/issues/71309). [#71332](https://github.com/ClickHouse/ClickHouse/pull/71332) ([pufit](https://github.com/pufit)).
- Add try/catch to data parts destructors to avoid std::terminate. [#71364](https://github.com/ClickHouse/ClickHouse/pull/71364) ([alesapin](https://github.com/alesapin)).
- Check suspicious and experimental types in JSON type hints. [#71369](https://github.com/ClickHouse/ClickHouse/pull/71369) ([Pavel Kruglov](https://github.com/Avogar)).
- Start memory worker thread on non-Linux OS too (fixes [#71051](https://github.com/ClickHouse/ClickHouse/issues/71051)). [#71384](https://github.com/ClickHouse/ClickHouse/pull/71384) ([Alexandre Snarskii](https://github.com/snar)).
- Fix error Invalid number of rows in Chunk with the Variant column. [#71388](https://github.com/ClickHouse/ClickHouse/pull/71388) ([Pavel Kruglov](https://github.com/Avogar)).
- Fix error column "attgenerated" does not exist for older PostgreSQL versions, fix [#60651](https://github.com/ClickHouse/ClickHouse/issues/60651). [#71396](https://github.com/ClickHouse/ClickHouse/pull/71396) ([0xMihalich](https://github.com/0xMihalich)).
- To avoid spamming the server logs, failing authentication attempts are now logged at level `DEBUG` instead of `ERROR`. [#71405](https://github.com/ClickHouse/ClickHouse/pull/71405) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix crash in `mongodb` table function when passing wrong arguments (e.g. `NULL`). [#71426](https://github.com/ClickHouse/ClickHouse/pull/71426) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Fix crash with optimize_rewrite_array_exists_to_has. [#71432](https://github.com/ClickHouse/ClickHouse/pull/71432) ([Raúl Marín](https://github.com/Algunenano)).
- Fixed the usage of setting `max_insert_delayed_streams_for_parallel_write` in inserts. Previously it worked incorrectly which could lead to high memory usage in inserts which write data into several partitions. [#71474](https://github.com/ClickHouse/ClickHouse/pull/71474) ([Anton Popov](https://github.com/CurtizJ)).
- Fix possible error `Argument for function must be constant` (old analyzer) in case when arrayJoin can apparently appear in `WHERE` condition. Regression after https://github.com/ClickHouse/ClickHouse/pull/65414. [#71476](https://github.com/ClickHouse/ClickHouse/pull/71476) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Prevent crash in SortCursor with 0 columns (old analyzer). [#71494](https://github.com/ClickHouse/ClickHouse/pull/71494) ([Raúl Marín](https://github.com/Algunenano)).
- Fix Date32 out of range caused by uninitialized ORC data. For more details, refer to https://github.com/apache/incubator-gluten/issues/7823. [#71500](https://github.com/ClickHouse/ClickHouse/pull/71500) ([李扬](https://github.com/taiyang-li)).
- Fix counting column size in wide part for Dynamic and JSON types. [#71526](https://github.com/ClickHouse/ClickHouse/pull/71526) ([Pavel Kruglov](https://github.com/Avogar)).
- Analyzer fix when query inside materialized view uses IN with CTE. Closes [#65598](https://github.com/ClickHouse/ClickHouse/issues/65598). [#71538](https://github.com/ClickHouse/ClickHouse/pull/71538) ([Maksim Kita](https://github.com/kitaisreal)).
- Avoid crash when using a UDF in a constraint. [#71541](https://github.com/ClickHouse/ClickHouse/pull/71541) ([Raúl Marín](https://github.com/Algunenano)).
- Return 0 or default char instead of throwing an error in bitShift functions in case of out of bounds. [#71580](https://github.com/ClickHouse/ClickHouse/pull/71580) ([Pablo Marcos](https://github.com/pamarcos)).
- Fix server crashes while using materialized view with certain engines. [#71593](https://github.com/ClickHouse/ClickHouse/pull/71593) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
- Array join with a nested data structure, which contains an alias to a constant array was leading to a null pointer dereference. This closes [#71677](https://github.com/ClickHouse/ClickHouse/issues/71677). [#71678](https://github.com/ClickHouse/ClickHouse/pull/71678) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix LOGICAL_ERROR when doing ALTER with empty tuple. This fixes [#71647](https://github.com/ClickHouse/ClickHouse/issues/71647). [#71679](https://github.com/ClickHouse/ClickHouse/pull/71679) ([Amos Bird](https://github.com/amosbird)).
- Don't transform constant set in predicates over partition columns in case of NOT IN operator. [#71695](https://github.com/ClickHouse/ClickHouse/pull/71695) ([Eduard Karacharov](https://github.com/korowa)).
- Fix docker init script fail log message for more clean understanding. [#71734](https://github.com/ClickHouse/ClickHouse/pull/71734) ([Андрей](https://github.com/andreineustroev)).
- Fix CAST from LowCardinality(Nullable) to Dynamic. Previously it could lead to error `Bad cast from type DB::ColumnVector<int> to DB::ColumnNullable`. [#71742](https://github.com/ClickHouse/ClickHouse/pull/71742) ([Pavel Kruglov](https://github.com/Avogar)).
- Fix exception for toDayOfWeek on WHERE condition with primary key of DateTime64 type. [#71849](https://github.com/ClickHouse/ClickHouse/pull/71849) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fixed filling of defaults after parsing into sparse columns. [#71854](https://github.com/ClickHouse/ClickHouse/pull/71854) ([Anton Popov](https://github.com/CurtizJ)).
- Fix GROUPING function error when input is ALIAS on distributed table, close [#68602](https://github.com/ClickHouse/ClickHouse/issues/68602). [#71855](https://github.com/ClickHouse/ClickHouse/pull/71855) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Fix possible crash when using `allow_experimental_join_condition`, close [#71693](https://github.com/ClickHouse/ClickHouse/issues/71693). [#71857](https://github.com/ClickHouse/ClickHouse/pull/71857) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Fixed select statements that use `WITH TIES` clause which might not return enough rows. [#71886](https://github.com/ClickHouse/ClickHouse/pull/71886) ([wxybear](https://github.com/wxybear)).
- Fix the TOO_LARGE_ARRAY_SIZE exception caused when a column of arrayWithConstant evaluation is mistaken to cross the array size limit. [#71894](https://github.com/ClickHouse/ClickHouse/pull/71894) ([Udi](https://github.com/udiz)).
- `clickhouse-benchmark` reported wrong metrics for queries taking longer than one second. [#71898](https://github.com/ClickHouse/ClickHouse/pull/71898) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix data race between the progress indicator and the progress table in clickhouse-client. This issue is visible when FROM INFILE is used. Intercept keystrokes during INSERT queries to toggle progress table display. [#71901](https://github.com/ClickHouse/ClickHouse/pull/71901) ([Julia Kartseva](https://github.com/jkartseva)).
- Use auxiliary keepers for cluster autodiscovery. [#71911](https://github.com/ClickHouse/ClickHouse/pull/71911) ([Anton Ivashkin](https://github.com/ianton-ru)).
- Fix rows_processed column in system.s3/azure_queue_log broken in 24.6. Closes [#69975](https://github.com/ClickHouse/ClickHouse/issues/69975). [#71946](https://github.com/ClickHouse/ClickHouse/pull/71946) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fixed case when `s3`/`s3Cluster` functions could return incomplete result or throw an exception. It involved using glob pattern in s3 uri (like `pattern/*`) and an empty object should exist with the key `pattern/` (such objects automatically created by S3 Console). Also default value for setting `s3_skip_empty_files` changed from `false` to `true` by default. [#71947](https://github.com/ClickHouse/ClickHouse/pull/71947) ([Nikita Taranov](https://github.com/nickitat)).
- Fix a crash in clickhouse-client syntax highlighting. Closes [#71864](https://github.com/ClickHouse/ClickHouse/issues/71864). [#71949](https://github.com/ClickHouse/ClickHouse/pull/71949) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix `Illegal type` error for `MergeTree` tables with binary monotonic function in `ORDER BY` when the first argument is constant. Fixes [#71941](https://github.com/ClickHouse/ClickHouse/issues/71941). [#71966](https://github.com/ClickHouse/ClickHouse/pull/71966) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Allow only SELECT queries in EXPLAIN AST used inside subquery. Other types of queries lead to logical error: 'Bad cast from type DB::ASTCreateQuery to DB::ASTSelectWithUnionQuery' or `Inconsistent AST formatting`. [#71982](https://github.com/ClickHouse/ClickHouse/pull/71982) ([Pavel Kruglov](https://github.com/Avogar)).
- When insert a record by `clickhouse-client`, client will read column descriptions from server. but there was a bug that we wrote the descritions with a wrong order , it should be [statistics, ttl, settings]. [#71991](https://github.com/ClickHouse/ClickHouse/pull/71991) ([Han Fei](https://github.com/hanfei1991)).
- Fix formatting of `MOVE PARTITION ... TO TABLE ...` alter commands when `format_alter_commands_with_parentheses` is enabled. [#72080](https://github.com/ClickHouse/ClickHouse/pull/72080) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fixes RIGHT / FULL joins in queries with parallel replicas. Now, RIGHT joins can be executed with parallel replicas (right table reading is distributed). FULL joins can't be parallelized among nodes, - executed locally. [#71162](https://github.com/ClickHouse/ClickHouse/pull/71162) ([Igor Nikonov](https://github.com/devcrafter)).
- Fix the issue where ClickHouse in Docker containers printed "get_mempolicy: Operation not permitted" into stderr due to restricted syscalls. [#70900](https://github.com/ClickHouse/ClickHouse/pull/70900) ([filimonov](https://github.com/filimonov)).
- Fix the metadata_version record in ZooKeeper in restarting thread rather than in attach thread. [#70297](https://github.com/ClickHouse/ClickHouse/pull/70297) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- This is a fix for "zero-copy" replication, which is unsupported and will be removed entirely. Don't delete a blob when there are nodes using it in ReplicatedMergeTree with zero-copy replication. [#71186](https://github.com/ClickHouse/ClickHouse/pull/71186) ([Antonio Andelic](https://github.com/antonio2368)).
- This is a fix for "zero-copy" replication, which is unsupported and will be removed entirely. Acquiring zero-copy shared lock before moving a part to zero-copy disk to prevent possible data loss if Keeper is unavailable. [#71845](https://github.com/ClickHouse/ClickHouse/pull/71845) ([Aleksei Filatov](https://github.com/aalexfvk)).

### <a id="2410"></a> ClickHouse release 24.10, 2024-10-31 {#a-id2410a-clickhouse-release-2410-2024-10-31}

#### 後方互換性のない変更 {#backward-incompatible-change-2}

- サブクエリが括弧内にある場合、`UNION`を使用したクエリチェーンで`FORMAT`の前に`SETTINGS`を記述できるようになりました。これにより[#39712](https://github.com/ClickHouse/ClickHouse/issues/39712)が解決されます。クエリ内でSETTINGS句が連続して2回指定されている場合の動作が変更されました。最も近いSETTINGS句が対応するサブクエリに対して優先されるようになります。以前のバージョンでは、最も外側のSETTINGS句が内側のものよりも優先される可能性がありました。[#68614](https://github.com/ClickHouse/ClickHouse/pull/68614) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `[PRE]WHERE`句のフィルタ条件の並べ替えがデフォルトで許可されるようになりました。`allow_reorder_prewhere_conditions`を`false`に設定することで無効化できます。[#70657](https://github.com/ClickHouse/ClickHouse/pull/70657) ([Nikita Taranov](https://github.com/nickitat))。
- 互換性のないライセンスを持つ`idxd-config`ライブラリを削除しました。これにより、実験的なIntel DeflateQPLコーデックも削除されます。[#70987](https://github.com/ClickHouse/ClickHouse/pull/70987) ([Alexey Milovidov](https://github.com/alexey-milovidov))。


#### 新機能 {#new-feature-2}

- ワイルドカードプレフィックスへのアクセス権限付与が可能になりました。`GRANT SELECT ON db.table_pefix_* TO user`。[#65311](https://github.com/ClickHouse/ClickHouse/pull/65311) ([pufit](https://github.com/pufit))。
- クエリ実行中にスペースバーを押すと、クライアントは詳細なメトリクスを含むリアルタイムテーブルを表示します。clickhouse-clientの新しい`--progress-table`オプションでグローバルに有効化できます。新しい`--enable-progress-table-toggle`オプションは`--progress-table`オプションに関連付けられており、制御キー(スペース)を押すことで進捗テーブルの表示を切り替えます。[#63689](https://github.com/ClickHouse/ClickHouse/pull/63689) ([Maria Khristenko](https://github.com/mariaKhr))、[#70423](https://github.com/ClickHouse/ClickHouse/pull/70423) ([Julia Kartseva](https://github.com/jkartseva))。
- オブジェクトストレージテーブルエンジンとデータレイクの読み取りファイルを、ETag + ファイルパスからのハッシュをキャッシュキーとして使用してキャッシュできるようになりました。[#70135](https://github.com/ClickHouse/ClickHouse/pull/70135) ([Kseniia Sumarokova](https://github.com/kssenii))。
- クエリによるテーブル作成をサポート:`CREATE TABLE ... CLONE AS ...`。ソーステーブルのスキーマを複製し、すべてのパーティションを新しく作成されたテーブルにアタッチします。この機能は`MergeTree`ファミリーのテーブルでのみサポートされます。[#65015](https://github.com/ClickHouse/ClickHouse/issues/65015)を解決。[#69091](https://github.com/ClickHouse/ClickHouse/pull/69091) ([tuanpach](https://github.com/tuanpach))。
- 新しいシステムテーブル`system.query_metric_log`を追加。個別のクエリに対するsystem.eventsテーブルからのメモリとメトリクス値の履歴を含み、定期的にディスクにフラッシュされます。[#66532](https://github.com/ClickHouse/ClickHouse/pull/66532) ([Pablo Marcos](https://github.com/pamarcos))。
- 単純なSELECTクエリは暗黙的なSELECTで記述でき、計算機スタイルの式を有効にします(例:`ch "1 + 2"`)。これは新しい設定`implicit_select`で制御されます。[#68502](https://github.com/ClickHouse/ClickHouse/pull/68502) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- clickhouse localでフォーマット変換のショートカットとして`--copy`モードをサポート[#68503](https://github.com/ClickHouse/ClickHouse/issues/68503)。[#68583](https://github.com/ClickHouse/ClickHouse/pull/68583) ([Denis Hananein](https://github.com/denis-hananein))。
- マージを視覚化するための組み込みHTMLページを追加。`/merges`パスで利用可能です。[#70821](https://github.com/ClickHouse/ClickHouse/pull/70821) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `arrayUnion`関数のサポートを追加。[#68989](https://github.com/ClickHouse/ClickHouse/pull/68989) ([Peter Nguyen](https://github.com/petern48))。
- パラメータ化されたSQLエイリアスが使用可能になりました。[#50665](https://github.com/ClickHouse/ClickHouse/pull/50665) ([Anton Kozlov](https://github.com/tonickkozlov))。
- 新しい集約関数`quantileExactWeightedInterpolated`を追加。quantileExactWeightedに基づく補間バージョンです。既に`quantileExactInterpolatedWeighted`があるのになぜ新しい`quantileExactWeightedInterpolated`が必要なのか疑問に思う方もいるかもしれません。理由は新しいものの方が古いものより正確だからです。これはSpark互換性のためです。[#69619](https://github.com/ClickHouse/ClickHouse/pull/69619) ([李扬](https://github.com/taiyang-li))。
- 新しい関数`arrayElementOrNull`を追加。配列インデックスが範囲外の場合やMapキーが見つからない場合に`NULL`を返します。[#69646](https://github.com/ClickHouse/ClickHouse/pull/69646) ([李扬](https://github.com/taiyang-li))。
- ユーザーが`config.xml`ファイルの新しい`message_regexp`および`message_regexp_negative`フィールドを通じて正規表現を指定し、ログをフィルタリングできるようになりました。ログは最も直感的な開発者体験のために、フォーマットされた色なしテキストに適用されます。[#69657](https://github.com/ClickHouse/ClickHouse/pull/69657) ([Peter Nguyen](https://github.com/petern48))。
- `RIPEMD160`関数を追加。文字列のRIPEMD-160暗号化ハッシュを計算します。例:`SELECT HEX(RIPEMD160('The quick brown fox jumps over the lazy dog'))`は`37F332F68DB77BD9D7EDD4969571AD671CF9DD3B`を返します。[#70087](https://github.com/ClickHouse/ClickHouse/pull/70087) ([Dergousov Maxim](https://github.com/m7kss1))。
- `HDFS`上の`Iceberg`テーブルの読み取りをサポート。[#70268](https://github.com/ClickHouse/ClickHouse/pull/70268) ([flynn](https://github.com/ucasfl))。
- `WITH ... INSERT`形式のCTEをサポート。以前は`INSERT ... WITH ...`のみをサポートしていました。[#70593](https://github.com/ClickHouse/ClickHouse/pull/70593) ([Shichao Jin](https://github.com/jsc0218))。
- MongoDB統合:すべてのMongoDBタイプのサポート、MongoDB側でのWHEREおよびORDER BY文のサポート、MongoDBでサポートされていない式の制限。新しい統合はデフォルトで無効になっていることに注意してください。使用するには、サーバー設定で`<use_legacy_mongodb_integration>`を`false`に設定してください。[#63279](https://github.com/ClickHouse/ClickHouse/pull/63279) ([Kirill Nikiforov](https://github.com/allmazz))。
- 新しい関数`getSettingOrDefault`を追加。カスタム設定が現在のプロファイルに見つからない場合にデフォルト値を返し、例外を回避します。[#69917](https://github.com/ClickHouse/ClickHouse/pull/69917) ([Shankar](https://github.com/shiyer7474))。

#### 実験的機能 {#experimental-feature-1}

- リフレッシュ可能なマテリアライズドビューが本番環境対応になりました。[#70550](https://github.com/ClickHouse/ClickHouse/pull/70550) ([Michael Kolupaev](https://github.com/al13n321))。リフレッシュ可能なマテリアライズドビューがレプリケートデータベースでサポートされるようになりました。[#60669](https://github.com/ClickHouse/ClickHouse/pull/60669) ([Michael Kolupaev](https://github.com/al13n321))。
- パラレルレプリカが実験的機能からベータ版に移行しました。パラレルレプリカアルゴリズムの動作を制御する設定が再設計されました。概要:ClickHouseには複数のレプリカを使用した並列読み取りのための4つの異なるアルゴリズムがあり、これは設定`parallel_replicas_mode`に反映されています。デフォルト値は`read_tasks`です。さらに、トグルスイッチ設定`enable_parallel_replicas`が追加されました。[#63151](https://github.com/ClickHouse/ClickHouse/pull/63151) ([Alexey Milovidov](https://github.com/alexey-milovidov))、([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- `Dynamic`型内の内部型に対して実行することで、ほとんどの関数で`Dynamic`型をサポートしました。[#69691](https://github.com/ClickHouse/ClickHouse/pull/69691) ([Pavel Kruglov](https://github.com/Avogar))。
- 設定`input_format_binary_read_json_as_string/output_format_binary_write_json_as_string`により、`RowBinary`形式で`JSON`型をバイナリ文字列として読み書きできるようになりました。[#70288](https://github.com/ClickHouse/ClickHouse/pull/70288) ([Pavel Kruglov](https://github.com/Avogar))。
- Native形式で`JSON`カラムを単一のStringカラムとしてシリアライズ/デシリアライズできるようになりました。出力には設定`output_format_native_write_json_as_string`を使用します。入力には、カラムデータの前にシリアライゼーションバージョン`1`を使用します。[#70312](https://github.com/ClickHouse/ClickHouse/pull/70312) ([Pavel Kruglov](https://github.com/Avogar))。
- MergeTreeテーブル用のマージセレクタの特別な(実験的)モードを導入しました。これにより、パート数の制限に近いパーティションに対してより積極的にマージを実行します。MergeTreeレベルの設定`merge_selector_use_blurry_base`で制御されます。[#70645](https://github.com/ClickHouse/ClickHouse/pull/70645) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- Avroの`Union`とClickHouseの`Variant`型間の汎用的なシリアライズ/デシリアライズを実装しました。[#69713](https://github.com/ClickHouse/ClickHouse/issues/69713)を解決します。[#69712](https://github.com/ClickHouse/ClickHouse/pull/69712) ([Jiří Kozlovský](https://github.com/jirislav))。


#### パフォーマンス改善 {#performance-improvement-2}

- パフォーマンス向上のため`IDisk`と`IObjectStorage`をリファクタリングしました。`plain`および`plain_rewritable`オブジェクトストレージのテーブル初期化が高速化されます。[#68146](https://github.com/ClickHouse/ClickHouse/pull/68146) ([Alexey Milovidov](https://github.com/alexey-milovidov), [Julia Kartseva](https://github.com/jkartseva))。plain rewritableディスク上でファイルやディレクトリの存在を確認する際、コスト効率が悪いためLISTオブジェクトストレージAPIを呼び出さないようにしました。[#70852](https://github.com/ClickHouse/ClickHouse/pull/70852) ([Julia Kartseva](https://github.com/jkartseva))。plain_rewritableディスクにおけるオブジェクトストレージHEAD APIリクエスト数を削減しました。[#70915](https://github.com/ClickHouse/ClickHouse/pull/70915) ([Julia Kartseva](https://github.com/jkartseva))。
- スパースカラムへ直接データをパースする機能を追加しました。[#69828](https://github.com/ClickHouse/ClickHouse/pull/69828) ([Anton Popov](https://github.com/CurtizJ))。
- 欠損値が多いフォーマット(例:`JSONEachRow`)のパースパフォーマンスを改善しました。[#69875](https://github.com/ClickHouse/ClickHouse/pull/69875) ([Anton Popov](https://github.com/CurtizJ))。
- Parquet行グループの並列読み取りと、シングルスレッドモードでの行グループのプリフェッチをサポートしました。[#69862](https://github.com/ClickHouse/ClickHouse/pull/69862) ([LiuNeng](https://github.com/liuneng1994))。
- `pointInPolygon`のminmaxインデックスをサポートしました。[#62085](https://github.com/ClickHouse/ClickHouse/pull/62085) ([JackyWoo](https://github.com/JackyWoo))。
- Parquetファイル読み取り時にブルームフィルタを使用するようにしました。[#62966](https://github.com/ClickHouse/ClickHouse/pull/62966) ([Arthur Passos](https://github.com/arthurpassos))。
- INSERTがSELECTに影響を与えないよう(パーツロックによる)、ロックフリーのパーツリネームを実装しました(通常の状況で`fsync_part_directory`を使用した場合、INSERTと並行したSELECTのQPSが2倍に向上し、高負荷時にはさらに効果が大きくなります)。現時点では`ReplicatedMergeTree`のみが対象です。[#64955](https://github.com/ClickHouse/ClickHouse/pull/64955) ([Azat Khuzhin](https://github.com/azat))。
- `materialize ttl`で`ttl_only_drop_parts`を尊重するようにしました。TTLの再計算に必要なカラムのみを読み取り、パーツを空のものに置き換えることでドロップします。[#65488](https://github.com/ClickHouse/ClickHouse/pull/65488) ([Andrey Zvonov](https://github.com/zvonand))。
- ThreadPoolでのスレッド作成を最適化し、ロック競合を最小化しました。スレッド作成はクリティカルセクションの外で実行されるようになり、高負荷条件下でのジョブスケジューリングとスレッド管理の遅延を回避します。これにより、高い同時負荷下でClickHouseの応答性が大幅に向上します。[#68694](https://github.com/ClickHouse/ClickHouse/pull/68694) ([filimonov](https://github.com/filimonov))。
- `ORC`から`LowCardinality`文字列カラムの読み取りを有効にしました。[#69481](https://github.com/ClickHouse/ClickHouse/pull/69481) ([李扬](https://github.com/taiyang-li))。
- `part_log`、`query_views_log`、`filesystem_cache_log`などのシステムログの`ProfileEvents`に`LowCardinality`を使用するようにしました。[#70152](https://github.com/ClickHouse/ClickHouse/pull/70152) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `fromUnixTimestamp`/`toUnixTimestamp`関数のパフォーマンスを改善しました。[#71042](https://github.com/ClickHouse/ClickHouse/pull/71042) ([kevinyhzou](https://github.com/KevinyhZou))。
- ブロッキングI/Oからの読み取り時に、サーバー全体でページキャッシュからのノンブロッキング読み取りを無効にしないようにしました。これにより、単一のファイルシステム(例:tmpfs)が`preadv2`システムコールをサポートしていない一方で他のファイルシステムがサポートしている場合のパフォーマンス低下を防ぎます。[#70299](https://github.com/ClickHouse/ClickHouse/pull/70299) ([Antonio Andelic](https://github.com/antonio2368))。
- `ALTER TABLE .. REPLACE PARTITION`は、他のパーティションで発生するミューテーション/マージを待機しなくなりました。[#59138](https://github.com/ClickHouse/ClickHouse/pull/59138) ([Vasily Nemkov](https://github.com/Enmk))。
- KeeperからACLを同期する際に検証を行わないようにしました。作成時に検証されています。それほど重要ではありませんが、数万以上のユーザーが作成されているインストール環境では、不要なハッシュ検証がサーバー起動時に完了するまで長時間かかる可能性があります(keeperからすべてを同期します)。[#70644](https://github.com/ClickHouse/ClickHouse/pull/70644) ([Raúl Marín](https://github.com/Algunenano))。





#### 改善 {#improvement-2}

- `CREATE TABLE AS` will copy `PRIMARY KEY`, `ORDER BY`, and similar clauses (of `MergeTree` tables). [#69739](https://github.com/ClickHouse/ClickHouse/pull/69739) ([sakulali](https://github.com/sakulali)).
- Support 64-bit XID in Keeper. It can be enabled with the `use_xid_64` configuration value. [#69908](https://github.com/ClickHouse/ClickHouse/pull/69908) ([Antonio Andelic](https://github.com/antonio2368)).
- Command-line arguments for Bool settings are set to true when no value is provided for the argument (e.g. `clickhouse-client --optimize_aggregation_in_order --query "SELECT 1"`). [#70459](https://github.com/ClickHouse/ClickHouse/pull/70459) ([davidtsuk](https://github.com/davidtsuk)).
- Added user-level settings `min_free_disk_bytes_to_perform_insert` and `min_free_disk_perform_to_throw_insert` to prevent insertions on disks that are almost full. [#69755](https://github.com/ClickHouse/ClickHouse/pull/69755) ([Marco Vilas Boas](https://github.com/marco-vb)).
- Embedded documentation for settings will be strictly more detailed and complete than the documentation on the website. This is the first step before making the website documentation always auto-generated from the source code. This has long-standing implications: - it will be guaranteed to have every setting; - there is no chance of having default values obsolete; - we can generate this documentation for each ClickHouse version; - the documentation can be displayed by the server itself even without Internet access. Generate the docs on the website from the source code. [#70289](https://github.com/ClickHouse/ClickHouse/pull/70289) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Allow empty needle in the function `replace`, the same behavior with PostgreSQL. [#69918](https://github.com/ClickHouse/ClickHouse/pull/69918) ([zhanglistar](https://github.com/zhanglistar)).
- Allow empty needle in functions `replaceRegexp*`. [#70053](https://github.com/ClickHouse/ClickHouse/pull/70053) ([zhanglistar](https://github.com/zhanglistar)).
- Symbolic links for tables in the `data/database_name/` directory are created for the actual paths to the table's data, depending on the storage policy, instead of the `store/...` directory on the default disk. [#61777](https://github.com/ClickHouse/ClickHouse/pull/61777) ([Kirill](https://github.com/kirillgarbar)).
- While parsing an `Enum` field from `JSON`, a string containing an integer will be interpreted as the corresponding `Enum` element. This closes [#65119](https://github.com/ClickHouse/ClickHouse/issues/65119). [#66801](https://github.com/ClickHouse/ClickHouse/pull/66801) ([scanhex12](https://github.com/scanhex12)).
- Allow `TRIM` -ing `LEADING` or `TRAILING` empty string as a no-op. Closes [#67792](https://github.com/ClickHouse/ClickHouse/issues/67792). [#68455](https://github.com/ClickHouse/ClickHouse/pull/68455) ([Peter Nguyen](https://github.com/petern48)).
- Improve compatibility of `cast(timestamp as String)` with Spark. [#69179](https://github.com/ClickHouse/ClickHouse/pull/69179) ([Wenzheng Liu](https://github.com/lwz9103)).
- Always use the new analyzer to calculate constant expressions when `enable_analyzer` is set to `true`. Support calculation of `executable` table function arguments without using `SELECT` query for constant expressions. [#69292](https://github.com/ClickHouse/ClickHouse/pull/69292) ([Dmitry Novik](https://github.com/novikd)).
- Add a setting `enable_secure_identifiers` to disallow identifiers with special characters. [#69411](https://github.com/ClickHouse/ClickHouse/pull/69411) ([tuanpach](https://github.com/tuanpach)).
- Add `show_create_query_identifier_quoting_rule` to define identifier quoting behavior in the `SHOW CREATE TABLE` query result. Possible values: - `user_display`: When the identifiers is a keyword. - `when_necessary`: When the identifiers is one of `{"distinct", "all", "table"}` and when it could lead to ambiguity: column names, dictionary attribute names. - `always`: Always quote identifiers. [#69448](https://github.com/ClickHouse/ClickHouse/pull/69448) ([tuanpach](https://github.com/tuanpach)).
- Improve restoring of access entities' dependencies [#69563](https://github.com/ClickHouse/ClickHouse/pull/69563) ([Vitaly Baranov](https://github.com/vitlibar)).
- If you run `clickhouse-client` or other CLI application, and it starts up slowly due to an overloaded server, and you start typing your query, such as `SELECT`, the previous versions will display the remaining of the terminal echo contents before printing the greetings message, such as `SELECTClickHouse local version 24.10.1.1.` instead of `ClickHouse local version 24.10.1.1.`. Now it is fixed. This closes [#31696](https://github.com/ClickHouse/ClickHouse/issues/31696). [#69856](https://github.com/ClickHouse/ClickHouse/pull/69856) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Add new column `readonly_duration` to the `system.replicas` table. Needed to be able to distinguish actual readonly replicas from sentinel ones in alerts. [#69871](https://github.com/ClickHouse/ClickHouse/pull/69871) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- Change the type of `join_output_by_rowlist_perkey_rows_threshold` setting type to unsigned integer. [#69886](https://github.com/ClickHouse/ClickHouse/pull/69886) ([kevinyhzou](https://github.com/KevinyhZou)).
- Enhance OpenTelemetry span logging to include query settings. [#70011](https://github.com/ClickHouse/ClickHouse/pull/70011) ([sharathks118](https://github.com/sharathks118)).
- Add diagnostic info about higher-order array functions if lambda result type is unexpected. [#70093](https://github.com/ClickHouse/ClickHouse/pull/70093) ([ttanay](https://github.com/ttanay)).
- Keeper improvement: less locking during cluster changes. [#70275](https://github.com/ClickHouse/ClickHouse/pull/70275) ([Antonio Andelic](https://github.com/antonio2368)).
- Add `WITH IMPLICIT` and `FINAL` keywords to the `SHOW GRANTS` command. Fix a minor bug with implicit grants: [#70094](https://github.com/ClickHouse/ClickHouse/issues/70094). [#70293](https://github.com/ClickHouse/ClickHouse/pull/70293) ([pufit](https://github.com/pufit)).
- Respect `compatibility` for MergeTree settings. The `compatibility` value is taken from the `default` profile on server startup, and default MergeTree settings are changed accordingly. Further changes of the `compatibility` setting do not affect MergeTree settings. [#70322](https://github.com/ClickHouse/ClickHouse/pull/70322) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Avoid spamming the logs with large HTTP response bodies in case of errors during inter-server communication. [#70487](https://github.com/ClickHouse/ClickHouse/pull/70487) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Added a new setting `max_parts_to_move` to control the maximum number of parts that can be moved at once. [#70520](https://github.com/ClickHouse/ClickHouse/pull/70520) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Limit the frequency of certain log messages. [#70601](https://github.com/ClickHouse/ClickHouse/pull/70601) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- `CHECK TABLE` with `PART` qualifier was incorrectly formatted in the client. [#70660](https://github.com/ClickHouse/ClickHouse/pull/70660) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Support writing the column index and the offset index using parquet native writer. [#70669](https://github.com/ClickHouse/ClickHouse/pull/70669) ([LiuNeng](https://github.com/liuneng1994)).
- Support parsing `DateTime64` for microsecond and timezone in joda syntax ("joda" is a popular Java library for date and time, and the "joda syntax" is that library's style). [#70737](https://github.com/ClickHouse/ClickHouse/pull/70737) ([kevinyhzou](https://github.com/KevinyhZou)).
- Changed an approach to figure out if a cloud storage supports [batch delete](https://docs.aws.amazon.com/AmazonS3/latest/API/API_DeleteObjects.html) or not. [#70786](https://github.com/ClickHouse/ClickHouse/pull/70786) ([Vitaly Baranov](https://github.com/vitlibar)).
- Support for Parquet page v2 in the native reader. [#70807](https://github.com/ClickHouse/ClickHouse/pull/70807) ([Arthur Passos](https://github.com/arthurpassos)).
- A check if table has both `storage_policy` and `disk` set. A check if a new storage policy is compatible with an old one when using `disk` setting is added. [#70839](https://github.com/ClickHouse/ClickHouse/pull/70839) ([Kirill](https://github.com/kirillgarbar)).
- Add `system.s3_queue_settings` and `system.azure_queue_settings`. [#70841](https://github.com/ClickHouse/ClickHouse/pull/70841) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Functions `base58Encode` and `base58Decode` now accept arguments of type `FixedString`. Example: `SELECT base58Encode(toFixedString('plaintext', 9));`. [#70846](https://github.com/ClickHouse/ClickHouse/pull/70846) ([Faizan Patel](https://github.com/faizan2786)).
- Add the `partition` column to every entry type of the part log. Previously, it was set only for some entries. This closes [#70819](https://github.com/ClickHouse/ClickHouse/issues/70819). [#70848](https://github.com/ClickHouse/ClickHouse/pull/70848) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Add `MergeStart` and `MutateStart` events into `system.part_log` which helps with merges analysis and visualization. [#70850](https://github.com/ClickHouse/ClickHouse/pull/70850) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Add a profile event about the number of merged source parts. It allows the monitoring of the fanout of the merge tree in production. [#70908](https://github.com/ClickHouse/ClickHouse/pull/70908) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Background downloads to the filesystem cache were enabled back. [#70929](https://github.com/ClickHouse/ClickHouse/pull/70929) ([Nikita Taranov](https://github.com/nickitat)).
- Add a new merge selector algorithm, named `Trivial`, for professional usage only. It is worse than the `Simple` merge selector. [#70969](https://github.com/ClickHouse/ClickHouse/pull/70969) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Support for atomic `CREATE OR REPLACE VIEW`. [#70536](https://github.com/ClickHouse/ClickHouse/pull/70536) ([tuanpach](https://github.com/tuanpach))
- Added `strict_once` mode to aggregate function `windowFunnel` to avoid counting one event several times in case it matches multiple conditions, close [#21835](https://github.com/ClickHouse/ClickHouse/issues/21835). [#69738](https://github.com/ClickHouse/ClickHouse/pull/69738) ([Vladimir Cherkasov](https://github.com/vdimir)).





#### バグ修正（公式安定版リリースにおけるユーザーに影響する不具合） {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-2}

- Apply configuration updates in global context object. It fixes issues like [#62308](https://github.com/ClickHouse/ClickHouse/issues/62308). [#62944](https://github.com/ClickHouse/ClickHouse/pull/62944) ([Amos Bird](https://github.com/amosbird)).
- Fix `ReadSettings` not using user set values, because defaults were only used. [#65625](https://github.com/ClickHouse/ClickHouse/pull/65625) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix type mismatch issue in `sumMapFiltered` when using signed arguments. [#58408](https://github.com/ClickHouse/ClickHouse/pull/58408) ([Chen768959](https://github.com/Chen768959)).
- Fix toHour-like conversion functions' monotonicity when optional time zone argument is passed. [#60264](https://github.com/ClickHouse/ClickHouse/pull/60264) ([Amos Bird](https://github.com/amosbird)).
- Relax `supportsPrewhere` check for `Merge` tables. This fixes [#61064](https://github.com/ClickHouse/ClickHouse/issues/61064). It was hardened unnecessarily in [#60082](https://github.com/ClickHouse/ClickHouse/issues/60082). [#61091](https://github.com/ClickHouse/ClickHouse/pull/61091) ([Amos Bird](https://github.com/amosbird)).
- Fix `use_concurrency_control` setting handling for proper `concurrent_threads_soft_limit_num` limit enforcing. This enables concurrency control by default because previously it was broken. [#61473](https://github.com/ClickHouse/ClickHouse/pull/61473) ([Sergei Trifonov](https://github.com/serxa)).
- Fix incorrect `JOIN ON` section optimization in case of `IS NULL` check under any other function (like `NOT`) that may lead to wrong results. Closes [#67915](https://github.com/ClickHouse/ClickHouse/issues/67915). [#68049](https://github.com/ClickHouse/ClickHouse/pull/68049) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Prevent `ALTER` queries that would make the `CREATE` query of tables invalid. [#68574](https://github.com/ClickHouse/ClickHouse/pull/68574) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fix inconsistent AST formatting for `negate` (`-`) and `NOT` functions with tuples and arrays. [#68600](https://github.com/ClickHouse/ClickHouse/pull/68600) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Fix insertion of incomplete type into `Dynamic` during deserialization. It could lead to `Parameter out of bound` errors. [#69291](https://github.com/ClickHouse/ClickHouse/pull/69291) ([Pavel Kruglov](https://github.com/Avogar)).
- Zero-copy replication, which is experimental and should not be used in production: fix inf loop after `restore replica` in the replicated merge tree with zero copy. [#69293](https://github.com/CljmnickHouse/ClickHouse/pull/69293) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
- Return back default value of `processing_threads_num` as number of cpu cores in storage `S3Queue`. [#69384](https://github.com/ClickHouse/ClickHouse/pull/69384) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Bypass try/catch flow when de/serializing nested repeated protobuf to nested columns (fixes [#41971](https://github.com/ClickHouse/ClickHouse/issues/41971)). [#69556](https://github.com/ClickHouse/ClickHouse/pull/69556) ([Eliot Hautefeuille](https://github.com/hileef)).
- Fix crash during insertion into FixedString column in PostgreSQL engine. [#69584](https://github.com/ClickHouse/ClickHouse/pull/69584) ([Pavel Kruglov](https://github.com/Avogar)).
- Fix crash when executing `create view t as (with recursive 42 as ttt select ttt);`. [#69676](https://github.com/ClickHouse/ClickHouse/pull/69676) ([Han Fei](https://github.com/hanfei1991)).
- Fixed `maxMapState` throwing 'Bad get' if value type is DateTime64. [#69787](https://github.com/ClickHouse/ClickHouse/pull/69787) ([Michael Kolupaev](https://github.com/al13n321)).
- Fix `getSubcolumn` with `LowCardinality` columns by overriding `useDefaultImplementationForLowCardinalityColumns` to return `true`. [#69831](https://github.com/ClickHouse/ClickHouse/pull/69831) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- Fix permanent blocked distributed sends if a DROP of distributed table failed. [#69843](https://github.com/ClickHouse/ClickHouse/pull/69843) ([Azat Khuzhin](https://github.com/azat)).
- Fix non-cancellable queries containing WITH FILL with NaN keys. This closes [#69261](https://github.com/ClickHouse/ClickHouse/issues/69261). [#69845](https://github.com/ClickHouse/ClickHouse/pull/69845) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix analyzer default with old compatibility value. [#69895](https://github.com/ClickHouse/ClickHouse/pull/69895) ([Raúl Marín](https://github.com/Algunenano)).
- Don't check dependencies during CREATE OR REPLACE VIEW during DROP of old table. Previously CREATE OR REPLACE query failed when there are dependent tables of the recreated view. [#69907](https://github.com/ClickHouse/ClickHouse/pull/69907) ([Pavel Kruglov](https://github.com/Avogar)).
- Something for Decimal. Fixes [#69730](https://github.com/ClickHouse/ClickHouse/issues/69730). [#69978](https://github.com/ClickHouse/ClickHouse/pull/69978) ([Arthur Passos](https://github.com/arthurpassos)).
- Now DEFINER/INVOKER will work with parameterized views. [#69984](https://github.com/ClickHouse/ClickHouse/pull/69984) ([pufit](https://github.com/pufit)).
- Fix parsing for view's definers. [#69985](https://github.com/ClickHouse/ClickHouse/pull/69985) ([pufit](https://github.com/pufit)).
- Fixed a bug when the timezone could change the result of the query with a `Date` or `Date32` arguments. [#70036](https://github.com/ClickHouse/ClickHouse/pull/70036) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fixes `Block structure mismatch` for queries with nested views and `WHERE` condition. Fixes [#66209](https://github.com/ClickHouse/ClickHouse/issues/66209). [#70054](https://github.com/ClickHouse/ClickHouse/pull/70054) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Avoid reusing columns among different named tuples when evaluating `tuple` functions. This fixes [#70022](https://github.com/ClickHouse/ClickHouse/issues/70022). [#70103](https://github.com/ClickHouse/ClickHouse/pull/70103) ([Amos Bird](https://github.com/amosbird)).
- Fix wrong LOGICAL_ERROR when replacing literals in ranges. [#70122](https://github.com/ClickHouse/ClickHouse/pull/70122) ([Pablo Marcos](https://github.com/pamarcos)).
- Check for Nullable(Nothing) type during ALTER TABLE MODIFY COLUMN/QUERY to prevent tables with such data type. [#70123](https://github.com/ClickHouse/ClickHouse/pull/70123) ([Pavel Kruglov](https://github.com/Avogar)).
- Proper error message for illegal query `JOIN ... ON *` , close [#68650](https://github.com/ClickHouse/ClickHouse/issues/68650). [#70124](https://github.com/ClickHouse/ClickHouse/pull/70124) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Fix wrong result with skipping index. [#70127](https://github.com/ClickHouse/ClickHouse/pull/70127) ([Raúl Marín](https://github.com/Algunenano)).
- Fix data race in ColumnObject/ColumnTuple decompress method that could lead to heap use after free. [#70137](https://github.com/ClickHouse/ClickHouse/pull/70137) ([Pavel Kruglov](https://github.com/Avogar)).
- Fix possible hung in ALTER COLUMN with Dynamic type. [#70144](https://github.com/ClickHouse/ClickHouse/pull/70144) ([Pavel Kruglov](https://github.com/Avogar)).
- Now ClickHouse will consider more errors as retriable and will not mark data parts as broken in case of such errors. [#70145](https://github.com/ClickHouse/ClickHouse/pull/70145) ([alesapin](https://github.com/alesapin)).
- Use correct `max_types` parameter during Dynamic type creation for JSON subcolumn. [#70147](https://github.com/ClickHouse/ClickHouse/pull/70147) ([Pavel Kruglov](https://github.com/Avogar)).
- Fix the password being displayed in `system.query_log` for users with bcrypt password authentication method. [#70148](https://github.com/ClickHouse/ClickHouse/pull/70148) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix event counter for the native interface (InterfaceNativeSendBytes). [#70153](https://github.com/ClickHouse/ClickHouse/pull/70153) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix possible crash related to JSON columns. [#70172](https://github.com/ClickHouse/ClickHouse/pull/70172) ([Pavel Kruglov](https://github.com/Avogar)).
- Fix multiple issues with arrayMin and arrayMax. [#70207](https://github.com/ClickHouse/ClickHouse/pull/70207) ([Raúl Marín](https://github.com/Algunenano)).
- Respect setting allow_simdjson in the JSON type parser. [#70218](https://github.com/ClickHouse/ClickHouse/pull/70218) ([Pavel Kruglov](https://github.com/Avogar)).
- Fix a null pointer dereference on creating a materialized view with two selects and an `INTERSECT`, e.g. `CREATE MATERIALIZED VIEW v0 AS (SELECT 1) INTERSECT (SELECT 1);`. [#70264](https://github.com/ClickHouse/ClickHouse/pull/70264) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Don't modify global settings with startup scripts. Previously, changing a setting in a startup script would change it globally. [#70310](https://github.com/ClickHouse/ClickHouse/pull/70310) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix ALTER of `Dynamic` type with reducing max_types parameter that could lead to server crash. [#70328](https://github.com/ClickHouse/ClickHouse/pull/70328) ([Pavel Kruglov](https://github.com/Avogar)).
- Fix crash when using WITH FILL incorrectly. [#70338](https://github.com/ClickHouse/ClickHouse/pull/70338) ([Raúl Marín](https://github.com/Algunenano)).
- Fix possible use-after-free in `SYSTEM DROP FORMAT SCHEMA CACHE FOR Protobuf`. [#70358](https://github.com/ClickHouse/ClickHouse/pull/70358) ([Azat Khuzhin](https://github.com/azat)).
- Fix crash during GROUP BY JSON sub-object subcolumn. [#70374](https://github.com/ClickHouse/ClickHouse/pull/70374) ([Pavel Kruglov](https://github.com/Avogar)).
- Don't prefetch parts for vertical merges if part has no rows. [#70452](https://github.com/ClickHouse/ClickHouse/pull/70452) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix crash in WHERE with lambda functions. [#70464](https://github.com/ClickHouse/ClickHouse/pull/70464) ([Raúl Marín](https://github.com/Algunenano)).
- Fix table creation with `CREATE ... AS table_function(...)` with database `Replicated` and unavailable table function source on secondary replica. [#70511](https://github.com/ClickHouse/ClickHouse/pull/70511) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Ignore all output on async insert with `wait_for_async_insert=1`. Closes [#62644](https://github.com/ClickHouse/ClickHouse/issues/62644). [#70530](https://github.com/ClickHouse/ClickHouse/pull/70530) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Ignore frozen_metadata.txt while traversing shadow directory from system.remote_data_paths. [#70590](https://github.com/ClickHouse/ClickHouse/pull/70590) ([Aleksei Filatov](https://github.com/aalexfvk)).
- Fix creation of stateful window functions on misaligned memory. [#70631](https://github.com/ClickHouse/ClickHouse/pull/70631) ([Raúl Marín](https://github.com/Algunenano)).
- Fixed rare crashes in `SELECT`-s and merges after adding a column of `Array` type with non-empty default expression. [#70695](https://github.com/ClickHouse/ClickHouse/pull/70695) ([Anton Popov](https://github.com/CurtizJ)).
- Insert into table function s3 will respect query settings. [#70696](https://github.com/ClickHouse/ClickHouse/pull/70696) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Fix infinite recursion when inferring a protobuf schema when skipping unsupported fields is enabled. [#70697](https://github.com/ClickHouse/ClickHouse/pull/70697) ([Raúl Marín](https://github.com/Algunenano)).
- Disable enable_named_columns_in_function_tuple by default. [#70833](https://github.com/ClickHouse/ClickHouse/pull/70833) ([Raúl Marín](https://github.com/Algunenano)).
- Fix S3Queue table engine setting processing_threads_num not being effective in case it was deduced from the number of cpu cores on the server. [#70837](https://github.com/ClickHouse/ClickHouse/pull/70837) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Normalize named tuple arguments in aggregation states. This fixes [#69732](https://github.com/ClickHouse/ClickHouse/issues/69732) . [#70853](https://github.com/ClickHouse/ClickHouse/pull/70853) ([Amos Bird](https://github.com/amosbird)).
- Fix a logical error due to negative zeros in the two-level hash table. This closes [#70973](https://github.com/ClickHouse/ClickHouse/issues/70973). [#70979](https://github.com/ClickHouse/ClickHouse/pull/70979) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix `limit by`, `limit with ties` for distributed and parallel replicas. [#70880](https://github.com/ClickHouse/ClickHouse/pull/70880) ([Nikita Taranov](https://github.com/nickitat)).

### <a id="249"></a> ClickHouse リリース 24.9, 2024-09-26 {#a-id249a-clickhouse-release-249-2024-09-26}

#### 後方互換性のない変更 {#backward-incompatible-change-3}

- 名前付きタプルに対して `a[b].c` のような式がサポートされ、任意の式からの名前付き添字(例: `expr().name`)も使用できるようになりました。これはJSON処理に有用です。この変更により [#54965](https://github.com/ClickHouse/ClickHouse/issues/54965) が解決されます。以前のバージョンでは、`expr().name` という形式の式は `tupleElement(expr(), name)` として解析され、クエリアナライザは対応するタプル要素ではなく `name` という列を検索していました。新しいバージョンでは、これが `tupleElement(expr(), 'name')` に変更されました。ほとんどの場合、以前のバージョンは動作していませんでしたが、この変更が非互換性を引き起こす可能性のある非常に特殊なシナリオが考えられます。それは、タプル要素の名前を、タプル要素の名前とは異なる名前の列またはエイリアスに格納していた場合です: `SELECT 'b' AS a, CAST([tuple(123)] AS 'Array(Tuple(b UInt8))') AS t, t[1].a`。このようなクエリを使用していた可能性は極めて低いですが、念のためこの変更を潜在的に後方互換性がないものとしてマークしています。[#68435](https://github.com/ClickHouse/ClickHouse/pull/68435) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 設定 `print_pretty_type_names` が有効な場合、`SHOW CREATE TABLE` ステートメント、`formatQuery` 関数、および `clickhouse-client` と `clickhouse-local` のインタラクティブモードで `Tuple` データ型が整形された形式で出力されるようになりました。以前のバージョンでは、この設定は `DESCRIBE` クエリと `toTypeName` にのみ適用されていました。この変更により [#65753](https://github.com/ClickHouse/ClickHouse/issues/65753) が解決されます。[#68492](https://github.com/ClickHouse/ClickHouse/pull/68492) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `Replicated` データベースでテーブルを作成する際にUUIDを明示的に指定することができなくなりました。また、Replicatedデータベース内の \*MergeTree テーブルに対してKeeperパスとレプリカ名を明示的に指定することもできません。この変更により、新しい設定 `database_replicated_allow_explicit_uuid` が導入され、`database_replicated_allow_replicated_engine_arguments` の型がBoolからUInt64に変更されました。[#66104](https://github.com/ClickHouse/ClickHouse/pull/66104) ([Alexander Tokmakov](https://github.com/tavplubix))。


#### 新機能 {#new-feature-3}

- ユーザーが1つだけでなく複数の認証方法を持つことができるようになりました。認証方法を最後に追加された方法にリセットすることも可能です。24.8と24.9のインスタンスをしばらく並行して実行する場合は、潜在的な非互換性を避けるため、その期間中は `max_authentication_methods_per_user` = 1 に設定することを推奨します。[#65277](https://github.com/ClickHouse/ClickHouse/pull/65277) ([Arthur Passos](https://github.com/arthurpassos))。
- `ATTACH PARTITION ALL FROM` のサポートを追加しました。[#61987](https://github.com/ClickHouse/ClickHouse/pull/61987) ([Kirill Nikiforov](https://github.com/allmazz))。
- `input_format_json_empty_as_default` 設定を追加しました。有効にすると、JSON入力の空フィールドをデフォルト値として扱います。[#59339](https://github.com/ClickHouse/ClickHouse/issues/59339) をクローズします。[#66782](https://github.com/ClickHouse/ClickHouse/pull/66782) ([Alexis Arnaud](https://github.com/a-a-f))。
- 文字列の一部を別の文字列で置き換える関数 `overlay` と `overlayUTF8` を追加しました。例: `SELECT overlay('Hello New York', 'Jersey', 11)` は `Hello New Jersey` を返します。[#66933](https://github.com/ClickHouse/ClickHouse/pull/66933) ([李扬](https://github.com/taiyang-li))。
- パーティション内での軽量削除のサポートを追加しました `DELETE FROM [db.]table [ON CLUSTER cluster] [IN PARTITION partition_expr] WHERE expr; ` [#67805](https://github.com/ClickHouse/ClickHouse/pull/67805) ([sunny](https://github.com/sunny19930321))。
- 異なるドメイン(秒や分など)の `Interval` データ型の値の比較を実装しました。これにより、最小の上位型に変換されるようになりました。[#68057](https://github.com/ClickHouse/ClickHouse/pull/68057) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- CREATE文で `IF NOT EXISTS` の動作をデフォルトにする `create_if_not_exists` 設定を追加しました。[#68164](https://github.com/ClickHouse/ClickHouse/pull/68164) ([Peter Nguyen](https://github.com/petern48))。
- AzureおよびローカルでIcebergテーブルを読み取ることが可能になりました。[#68210](https://github.com/ClickHouse/ClickHouse/pull/68210) ([Daniil Ivanik](https://github.com/divanik))。
- クエリキャッシュエントリをタグで削除できるようになりました。例えば、`SELECT 1 SETTINGS use_query_cache = true, query_cache_tag = 'abc'` で作成されたクエリキャッシュエントリは、`SYSTEM DROP QUERY CACHE TAG 'abc'` で削除できます。[#68477](https://github.com/ClickHouse/ClickHouse/pull/68477) ([Michał Tabaszewski](https://github.com/pinsvin00))。
- 名前付きコレクションのストレージ暗号化を追加しました。[#68615](https://github.com/ClickHouse/ClickHouse/pull/68615) ([Pablo Marcos](https://github.com/pamarcos))。
- `URL` テーブルエンジンに仮想カラム `_headers` を追加しました。[#65026](https://github.com/ClickHouse/ClickHouse/issues/65026) をクローズします。[#68867](https://github.com/ClickHouse/ClickHouse/pull/68867) ([flynn](https://github.com/ucasfl))。
- 利用可能なプロジェクションを追跡するための `system.projections` テーブルを追加しました。[#68901](https://github.com/ClickHouse/ClickHouse/pull/68901) ([Jordi Villar](https://github.com/jrdi))。
- Spark互換性のための新しい関数 `arrayZipUnaligned` を追加しました(Sparkでは `arrays_zip` という名前です)。元の `arrayZip` をベースに、整列していない配列を許可します。[#69030](https://github.com/ClickHouse/ClickHouse/pull/69030) ([李扬](https://github.com/taiyang-li))。
- keeperクライアントコマンドラインアプリケーションに、ノードをアトミックにコピー/移動する `cp`/`mv` コマンドを追加しました。[#69034](https://github.com/ClickHouse/ClickHouse/pull/69034) ([Mikhail Artemenko](https://github.com/Michicosun))。
- 関数 `arrayAUC` に引数 `scale` (デフォルト: `true`) を追加しました。これにより正規化ステップをスキップできます(issue [#69609](https://github.com/ClickHouse/ClickHouse/issues/69609))。[#69717](https://github.com/ClickHouse/ClickHouse/pull/69717) ([gabrielmcg44](https://github.com/gabrielmcg44))。

#### 実験的機能 {#experimental-feature-2}

- テキスト形式のスキーマ推論時に、カラムや配列要素に複数の型候補がある場合に`Variant`型を推論できるようにする設定`input_format_try_infer_variants`を追加しました。[#63798](https://github.com/ClickHouse/ClickHouse/pull/63798) ([Shaun Struwig](https://github.com/Blargian))。
- JSONカラム型の内容をより詳細に調査するための集約関数`distinctDynamicTypes`/`distinctJSONPaths`/`distinctJSONPathsAndTypes`を追加しました。[#68463](https://github.com/ClickHouse/ClickHouse/pull/68463) ([Kruglov Pavel](https://github.com/Avogar))。
- 一貫性ハッシュによる並列レプリカ間のマーク分散単位を決定する新しいアルゴリズムを実装しました。読み取りパターンに応じて異なる数のマークを選択することでパフォーマンスを向上させます。[#68424](https://github.com/ClickHouse/ClickHouse/pull/68424) ([Nikita Taranov](https://github.com/nickitat))。
- 以前は並列レプリカのアナウンス処理におけるパート重複排除ロジックのアルゴリズム計算量がO(n^2)であり、多数のパート(またはパーティション)を持つテーブルでは顕著な時間を要する可能性がありました。この変更により計算量をO(n\*log(n))に改善しました。[#69596](https://github.com/ClickHouse/ClickHouse/pull/69596) ([Alexander Gololobov](https://github.com/davenger))。
- リフレッシュ可能なマテリアライズドビューの改善: テーブル全体を上書きする代わりに既存のテーブルに行を追加する追記モード(`... REFRESH EVERY 1 MINUTE APPEND ...`)、リトライ機能(デフォルトでは無効、クエリのSETTINGSセクションで設定)、現在実行中のリフレッシュを待機する`SYSTEM WAIT VIEW <name>`クエリ、その他の修正を実施しました。[#58934](https://github.com/ClickHouse/ClickHouse/pull/58934) ([Michael Kolupaev](https://github.com/al13n321))。
- 新しい(実験的な)統計情報の種類として`min_max`を追加しました。数値カラムに対する範囲述語(例: `x < 100`)の推定をサポートします。[#67013](https://github.com/ClickHouse/ClickHouse/pull/67013) ([JackyWoo](https://github.com/JackyWoo))。
- Variant/DynamicカラムからのcastOrDefaultを改善し、内部型が全く変換できない場合でも動作するようにしました。[#67150](https://github.com/ClickHouse/ClickHouse/pull/67150) ([Kruglov Pavel](https://github.com/Avogar))。
- MaterializedPostgreSQLを通じてカラムのサブセットのレプリケーションが利用可能になりました。[#33748](https://github.com/ClickHouse/ClickHouse/issues/33748)をクローズします。[#69092](https://github.com/ClickHouse/ClickHouse/pull/69092) ([Kruglov Kirill](https://github.com/1on))。


#### パフォーマンス改善 {#performance-improvement-3}

- Hiveパーティショニングにおいて、必要なファイルのみを読み取る機能を実装しました。[#68963](https://github.com/ClickHouse/ClickHouse/pull/68963) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- LEFTまたはINNERハッシュ結合において、テーブルキーが密である場合に右テーブルをキーで再配置することで、JOINのパフォーマンスを向上させました。[#60341](https://github.com/ClickHouse/ClickHouse/pull/60341) ([kevinyhzou](https://github.com/KevinyhZou))。
- 行のリストを遅延追加することで、ALL JOINのパフォーマンスを向上させました。[#63677](https://github.com/ClickHouse/ClickHouse/pull/63677) ([kevinyhzou](https://github.com/KevinyhZou))。
- 再起動を高速化するため、起動プロセス中にファイルシステムキャッシュメタデータを非同期で読み込むようにしました(設定`load_metadata_asynchronously`で制御)。[#65736](https://github.com/ClickHouse/ClickHouse/pull/65736) ([Daniel Pozo Escalona](https://github.com/danipozo))。
- 関数`array`と`map`を最適化し、特定の一般的なケースをより高速に処理できるようにしました。[#67707](https://github.com/ClickHouse/ClickHouse/pull/67707) ([李扬](https://github.com/taiyang-li))。
- ORC文字列の読み取りを最適化しました。特にカラムにNULLが含まれていない場合に効果的です。[#67794](https://github.com/ClickHouse/ClickHouse/pull/67794) ([李扬](https://github.com/taiyang-li))。
- マージのスケジューリングステップのオーバーヘッドを削減することで、マージ全体のパフォーマンスを向上させました。[#68016](https://github.com/ClickHouse/ClickHouse/pull/68016) ([Anton Popov](https://github.com/CurtizJ))。
- プロファイルが設定されておらず、認証情報が設定されておらず、IMDSが利用できない場合(例えば、クラウド外のマシンからパブリックバケットにクエリを実行する場合)のS3へのリクエストを高速化しました。これにより[#52771](https://github.com/ClickHouse/ClickHouse/issues/52771)が解決されます。[#68082](https://github.com/ClickHouse/ClickHouse/pull/68082) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `RowInputFormatWithNamesAndTypes`のフォーマットリーダーを非仮想化し、パフォーマンスを向上させました。[#68437](https://github.com/ClickHouse/ClickHouse/pull/68437) ([李扬](https://github.com/taiyang-li))。
- GROUP BYキーで集計する際に`uniq`集計関数の並列マージを追加し、CPU使用率を最大化しました。[#68441](https://github.com/ClickHouse/ClickHouse/pull/68441) ([Jiebin Sun](https://github.com/jiebinn))。
- 設定`output_format_orc_dictionary_key_size_threshold`を追加し、`ORC`出力フォーマットで文字列カラムの辞書エンコーディングを有効にできるようにしました。これにより、出力される`ORC`ファイルサイズが削減され、読み取りパフォーマンスが大幅に向上します。[#68591](https://github.com/ClickHouse/ClickHouse/pull/68591) ([李扬](https://github.com/taiyang-li))。
- ノードとそのすべてのサブツリーを削除する新しいKeeperリクエストRemoveRecursiveを導入しました。[#69332](https://github.com/ClickHouse/ClickHouse/pull/69332) ([Mikhail Artemenko](https://github.com/Michicosun))。
- ベクトル類似性インデックスを持つテーブルへの挿入パフォーマンスを、ベクトルインデックスへのデータ追加を並列化することで高速化しました。[#69493](https://github.com/ClickHouse/ClickHouse/pull/69493) ([flynn](https://github.com/ucasfl))。
- 適応型書き込みバッファサイズを使用することで、JSONへの挿入時のメモリ使用量を削減しました。ワイドパートのJSONカラムによって作成される多くのファイルには少量のデータしか含まれておらず、それらに1MBのバッファを割り当てる必要はありません。[#69272](https://github.com/ClickHouse/ClickHouse/pull/69272) ([Kruglov Pavel](https://github.com/Avogar))。
- 並行ハッシュ結合スレッドプールでスレッドを返却しないようにし、クエリが過度にスレッドを生成することを回避しました。[#69406](https://github.com/ClickHouse/ClickHouse/pull/69406) ([Duc Canh Le](https://github.com/canhld94))。


#### 改善 {#improvement-3}

- CREATE TABLE AS が PRIMARY KEY、ORDER BY、および類似の句をコピーするようになりました。現在は MergeTree ファミリーのテーブルエンジンのみをサポートしています。[#69076](https://github.com/ClickHouse/ClickHouse/pull/69076) ([sakulali](https://github.com/sakulali))。
- 小規模エンティティの解析に関連するコードベースの一部を強化しました。以下の(軽微な)バグが発見され、修正されました: - `DeltaLake` テーブルが Bool でパーティション化されている場合、パーティション値が常に false として解釈される; - `ExternalDistributed` テーブルが提供されたアドレスの中で単一のシャードのみを使用していた; `max_threads` 設定などの値が `auto(N)` ではなく `'auto(N)'` として出力されていた。[#52503](https://github.com/ClickHouse/ClickHouse/pull/52503) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- CPU 使用率の計測にシステム全体のメトリクスではなく cgroup 固有のメトリクスを使用するようになりました。[#62003](https://github.com/ClickHouse/ClickHouse/pull/62003) ([Nikita Taranov](https://github.com/nickitat))。
- リモート S3 ディスクの IO スケジューリングが、`bandwidth_limit` スロットリングの問題を解決するために、S3 リクエスト全体ではなく HTTP ソケットストリームのレベルで行われるようになりました。[#65182](https://github.com/ClickHouse/ClickHouse/pull/65182) ([Sergei Trifonov](https://github.com/serxa))。
- 関数 `upperUTF8` および `lowerUTF8` は以前、キリル文字の大文字/小文字変換のみが可能でした。この制限が解除され、任意の言語の文字を大文字/小文字変換できるようになりました。例: `SELECT upperUTF8('Süden')` は `SÜDEN` を返すようになりました。[#65761](https://github.com/ClickHouse/ClickHouse/pull/65761) ([李扬](https://github.com/taiyang-li))。
- プロジェクションを持つテーブルで軽量削除が発生する場合、ユーザーは例外をスローする(デフォルト)か、軽量削除が発生する際にプロジェクションを削除するかを選択できましたが、第三の選択肢として、軽量削除を実行した後にプロジェクションを再構築するオプションが追加されました。[#66169](https://github.com/ClickHouse/ClickHouse/pull/66169) ([jsc0218](https://github.com/jsc0218))。
- 接続の IP ファミリーをブロックできるように、2つのオプション(`dns_allow_resolve_names_to_ipv4` および `dns_allow_resolve_names_to_ipv6`)が追加されました。[#66895](https://github.com/ClickHouse/ClickHouse/pull/66895) ([MikhailBurdukov](https://github.com/MikhailBurdukov))。
- clickhouse-client で Ctrl-Z の無視を設定可能(ignore_shell_suspend)にしました。[#67134](https://github.com/ClickHouse/ClickHouse/pull/67134) ([Azat Khuzhin](https://github.com/azat))。
- JSON 出力フォーマットでの UTF-8 検証を改善しました。結果データに特定のバイトシーケンスが含まれる場合でも、有効な JSON が生成されることを保証します。[#67938](https://github.com/ClickHouse/ClickHouse/pull/67938) ([mwoenker](https://github.com/mwoenker))。
- より良い内部監視のために、マージとミューテーションのプロファイルイベントを追加しました。[#68015](https://github.com/ClickHouse/ClickHouse/pull/68015) ([Anton Popov](https://github.com/CurtizJ))。
- ODBC: サーバー設定から http_max_tries を取得するようになりました。[#68128](https://github.com/ClickHouse/ClickHouse/pull/68128) ([Rodolphe Dugé de Bernonville](https://github.com/RodolpheDuge))。
- X.509 SubjectAltName 拡張でのユーザー識別にワイルドカードサポートを追加しました。[#68236](https://github.com/ClickHouse/ClickHouse/pull/68236) ([Marco Vilas Boas](https://github.com/marco-vb))。
- 日時のスキーマ推論を改善しました。`DateTime64` は日時に小数部分がある場合のみ使用され、それ以外の場合は通常の DateTime が使用されるようになりました。Date/DateTime の推論はより厳格になり、特に `date_time_input_format='best_effort'` の場合、コーナーケースで文字列から日時を推論することを回避します。[#68382](https://github.com/ClickHouse/ClickHouse/pull/68382) ([Kruglov Pavel](https://github.com/Avogar))。
- ディクショナリから名前付きコレクションの古いコードを削除し、DDL で作成された名前付きコレクションをディクショナリで使用できる新しいコードに置き換えました。[#60936](https://github.com/ClickHouse/ClickHouse/issues/60936)、[#36890](https://github.com/ClickHouse/ClickHouse/issues/36890) をクローズします。[#68412](https://github.com/ClickHouse/ClickHouse/pull/68412) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 外部 HTTP 認証機能に対して、HTTP/1.0(デフォルトで設定)の代わりに HTTP/1.1 を使用するようになりました。[#68456](https://github.com/ClickHouse/ClickHouse/pull/68456) ([Aleksei Filatov](https://github.com/aalexfvk))。
- スレッドプールの内部監視のための新しいメトリクスセットを追加し、スレッドプールのパフォーマンスと動作に関するより深い洞察を提供します。[#68674](https://github.com/ClickHouse/ClickHouse/pull/68674) ([filimonov](https://github.com/filimonov))。
- フォーマット `Values` を使用した非同期挿入でクエリパラメータをサポートしました。[#68741](https://github.com/ClickHouse/ClickHouse/pull/68741) ([Anton Popov](https://github.com/CurtizJ))。
- `dateTrunc` および `toStartOfInterval` で `Date32` をサポートしました。[#68874](https://github.com/ClickHouse/ClickHouse/pull/68874) ([LiuNeng](https://github.com/liuneng1994))。
- `system.processors_profile_log` に `plan_step_name` および `plan_step_description` カラムを追加しました。[#68954](https://github.com/ClickHouse/ClickHouse/pull/68954) ([Alexander Gololobov](https://github.com/davenger))。
- 組み込みディクショナリでスペイン語をサポートしました。[#69035](https://github.com/ClickHouse/ClickHouse/pull/69035) ([Vasily Okunev](https://github.com/VOkunev))。
- 短い障害情報メッセージに CPU アーキテクチャを追加しました。[#69037](https://github.com/ClickHouse/ClickHouse/pull/69037) ([Konstantin Bogdanov](https://github.com/thevar1able))。
- リトライ中に新しい Keeper 接続を確立できない場合、クエリがより早く失敗するようになりました。[#69148](https://github.com/ClickHouse/ClickHouse/pull/69148) ([Raúl Marín](https://github.com/Algunenano))。
- Database Factory を更新し、ユーザー定義のデータベースエンジンが引数、設定、テーブルオーバーライドを持つことができるようにしました(StorageFactory と同様)。[#69201](https://github.com/ClickHouse/ClickHouse/pull/69201) ([NikBarykin](https://github.com/NikBarykin))。
- すべての外部テーブルエンジンと関数を `Null` エンジンに置き換える復元モード(`restore_replace_external_engines_to_null`、`restore_replace_external_table_functions_to_null` 設定)は、テーブルに SETTINGS がある場合に失敗していました。この場合にテーブル定義から設定を削除し、そのようなテーブルの復元を可能にするようになりました。[#69253](https://github.com/ClickHouse/ClickHouse/pull/69253) ([Ilya Yatsishin](https://github.com/qoega))。
- clickhouse イメージのエントリーポイントで、CLICKHOUSE_PASSWORD が XML 用に正しくエスケープされるようになりました。[#69301](https://github.com/ClickHouse/ClickHouse/pull/69301) ([aohoyd](https://github.com/aohoyd))。
- https://github.com/ClickHouse/ClickHouse/pull/65887 で concat が行ったように、`arrayZip`/`arrayZipUnaligned` で空の引数を許可しました。これは Gluten CH Backend での Spark 互換性のためです。[#69576](https://github.com/ClickHouse/ClickHouse/pull/69576) ([李扬](https://github.com/taiyang-li))。
- Keeper の内部通信でより高度な SSL オプション(例: パスフレーズ付きの秘密鍵)をサポートしました。[#69582](https://github.com/ClickHouse/ClickHouse/pull/69582) ([Antonio Andelic](https://github.com/antonio2368))。
- インデックス解析は、多数のパートやパーティションを持つ大きなテーブルでは顕著な時間がかかる場合があります。この変更により、その段階で重いクエリを強制終了できるようになります。[#69606](https://github.com/ClickHouse/ClickHouse/pull/69606) ([Alexander Gololobov](https://github.com/davenger))。
- `gcs` テーブル関数で機密情報をマスキングするようになりました。[#69611](https://github.com/ClickHouse/ClickHouse/pull/69611) ([Vitaly Baranov](https://github.com/vitlibar))。
- 行数を削減するマージに対してプロジェクションを再構築するようになりました。[#62364](https://github.com/ClickHouse/ClickHouse/pull/62364) ([cangyin](https://github.com/cangyin))。





#### バグ修正（公式安定版リリースにおけるユーザーに見える不具合） {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-3}

- Fix attaching table when pg dbname contains "-" in the experimental and unsupported MaterializedPostgreSQL engine. [#62730](https://github.com/ClickHouse/ClickHouse/pull/62730) ([takakawa](https://github.com/takakawa)).
- Fixed error on generated columns in the experimental and totally unsupported MaterializedPostgreSQL engine when adnum ordering is broken [#63161](https://github.com/ClickHouse/ClickHouse/issues/63161). Fixed error on id column with nextval expression as default in the experimental and totally unsupported MaterializedPostgreSQL when there are generated columns in table. Fixed error on dropping publication with symbols except \[a-z1-9-\]. [#67664](https://github.com/ClickHouse/ClickHouse/pull/67664) ([Kruglov Kirill](https://github.com/1on)).
- Storage Join to support Nullable columns in the left table, close [#61247](https://github.com/ClickHouse/ClickHouse/issues/61247). [#66926](https://github.com/ClickHouse/ClickHouse/pull/66926) ([vdimir](https://github.com/vdimir)).
- Incorrect query result with parallel replicas (distribute queries as well) when `IN` operator contains conversion to Decimal(). The bug was introduced with the new analyzer. [#67234](https://github.com/ClickHouse/ClickHouse/pull/67234) ([Igor Nikonov](https://github.com/devcrafter)).
- Fix the problem that alter modify order by causes inconsistent metadata. [#67436](https://github.com/ClickHouse/ClickHouse/pull/67436) ([iceFireser](https://github.com/iceFireser)).
- Fix the upper bound of the function `fromModifiedJulianDay`. It was supposed to be `9999-12-31` but was mistakenly set to `9999-01-01`. [#67583](https://github.com/ClickHouse/ClickHouse/pull/67583) ([PHO](https://github.com/depressed-pho)).
- Fix when the index is not at the beginning of the tuple during `IN` query. [#67626](https://github.com/ClickHouse/ClickHouse/pull/67626) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fix expiration in `RoleCache`. [#67748](https://github.com/ClickHouse/ClickHouse/pull/67748) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix window view missing blocks due to slow flush to view. [#67983](https://github.com/ClickHouse/ClickHouse/pull/67983) ([Raúl Marín](https://github.com/Algunenano)).
- Fix MSan issue caused by incorrect date format. [#68105](https://github.com/ClickHouse/ClickHouse/pull/68105) ([JackyWoo](https://github.com/JackyWoo)).
- Fixed crash in Parquet filtering when data types in the file substantially differ from requested types (e.g. `... FROM file('a.parquet', Parquet, 'x String')`, but the file has `x Int64`). Without this fix, use `input_format_parquet_filter_push_down = 0` as a workaround. [#68131](https://github.com/ClickHouse/ClickHouse/pull/68131) ([Michael Kolupaev](https://github.com/al13n321)).
- Fix crash in `lag`/`lead` which is introduced in [#67091](https://github.com/ClickHouse/ClickHouse/issues/67091). [#68262](https://github.com/ClickHouse/ClickHouse/pull/68262) ([lgbo](https://github.com/lgbo-ustc)).
- Try fix postgres crash when query is cancelled. [#68288](https://github.com/ClickHouse/ClickHouse/pull/68288) ([Kseniia Sumarokova](https://github.com/kssenii)).
- After https://github.com/ClickHouse/ClickHouse/pull/61984 `schema_inference_make_columns_nullable=0` still can make columns `Nullable` in Parquet/Arrow formats. The change was backward incompatible and users noticed the changes in the behaviour. This PR makes `schema_inference_make_columns_nullable=0` to work as before (no Nullable columns will be inferred) and introduces new value `auto` for this setting that will make columns `Nullable` only if data has information about nullability. [#68298](https://github.com/ClickHouse/ClickHouse/pull/68298) ([Kruglov Pavel](https://github.com/Avogar)).
- Fixes [#50868](https://github.com/ClickHouse/ClickHouse/issues/50868). Small DateTime64 constant values returned by a nested subquery inside a distributed query were wrongly transformed to Nulls, thus causing errors and possible incorrect query results. [#68323](https://github.com/ClickHouse/ClickHouse/pull/68323) ([Shankar](https://github.com/shiyer7474)).
- Fix missing sync replica mode in query `SYSTEM SYNC REPLICA`. [#68326](https://github.com/ClickHouse/ClickHouse/pull/68326) ([Duc Canh Le](https://github.com/canhld94)).
- Fix bug in key condition. [#68354](https://github.com/ClickHouse/ClickHouse/pull/68354) ([Han Fei](https://github.com/hanfei1991)).
- Fix crash on drop or rename a role that is used in LDAP external user directory. [#68355](https://github.com/ClickHouse/ClickHouse/pull/68355) ([Andrey Zvonov](https://github.com/zvonand)).
- Fix Progress column value of system.view_refreshes greater than 1 [#68377](https://github.com/ClickHouse/ClickHouse/issues/68377). [#68378](https://github.com/ClickHouse/ClickHouse/pull/68378) ([megao](https://github.com/jetgm)).
- Process regexp flags correctly. [#68389](https://github.com/ClickHouse/ClickHouse/pull/68389) ([Han Fei](https://github.com/hanfei1991)).
- PostgreSQL-style cast operator (`::`) works correctly even for SQL-style hex and binary string literals (e.g., `SELECT x'414243'::String`). This closes [#68324](https://github.com/ClickHouse/ClickHouse/issues/68324). [#68482](https://github.com/ClickHouse/ClickHouse/pull/68482) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Minor patch for https://github.com/ClickHouse/ClickHouse/pull/68131. [#68494](https://github.com/ClickHouse/ClickHouse/pull/68494) ([Chang chen](https://github.com/baibaichen)).
- Fix [#68239](https://github.com/ClickHouse/ClickHouse/issues/68239) SAMPLE n where n is an integer. [#68499](https://github.com/ClickHouse/ClickHouse/pull/68499) ([Denis Hananein](https://github.com/denis-hananein)).
- Fix bug in mann-whitney-utest when the size of two districutions are not equal. [#68556](https://github.com/ClickHouse/ClickHouse/pull/68556) ([Han Fei](https://github.com/hanfei1991)).
- After unexpected restart, fail to start replication of ReplicatedMergeTree due to abnormal handling of covered-by-broken part. [#68584](https://github.com/ClickHouse/ClickHouse/pull/68584) ([baolin](https://github.com/baolinhuang)).
- Fix `LOGICAL_ERROR`s when functions `sipHash64Keyed`, `sipHash128Keyed`, or `sipHash128ReferenceKeyed` are applied to empty arrays or tuples. [#68630](https://github.com/ClickHouse/ClickHouse/pull/68630) ([Robert Schulze](https://github.com/rschu1ze)).
- Full text index may filter out wrong columns when index multiple columns, it didn't reset row_id between different columns, the reproduce procedure is in tests/queries/0_stateless/03228_full_text_with_multi_col.sql. Without this. [#68644](https://github.com/ClickHouse/ClickHouse/pull/68644) ([siyuan](https://github.com/linkwk7)).
- Fix invalid character '\t' and '\n' in replica_name when creating a Replicated table, which causes incorrect parsing of 'source replica' in LogEntry. Mentioned in issue [#68640](https://github.com/ClickHouse/ClickHouse/issues/68640). [#68645](https://github.com/ClickHouse/ClickHouse/pull/68645) ([Zhigao Hong](https://github.com/zghong)).
- Added back virtual columns ` _table` and `_database` to distributed tables. They were available until version 24.3. [#68672](https://github.com/ClickHouse/ClickHouse/pull/68672) ([Anton Popov](https://github.com/CurtizJ)).
- Fix possible error `Size of permutation (0) is less than required (...)` during Variant column permutation. [#68681](https://github.com/ClickHouse/ClickHouse/pull/68681) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix possible error `DB::Exception: Block structure mismatch in joined block stream: different columns:` with new JSON column. [#68686](https://github.com/ClickHouse/ClickHouse/pull/68686) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix issue with materialized constant keys when hashing maps with arrays as keys in functions `sipHash(64/128)Keyed`. [#68731](https://github.com/ClickHouse/ClickHouse/pull/68731) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
- Make `ColumnsDescription::toString` format each column using the same `IAST::FormatState object`. This results in uniform columns metadata being written to disk and ZooKeeper. [#68733](https://github.com/ClickHouse/ClickHouse/pull/68733) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- Fix merging of aggregated data for grouping sets. [#68744](https://github.com/ClickHouse/ClickHouse/pull/68744) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix logical error, when we create a replicated merge tree, alter a column and then execute modify statistics. [#68820](https://github.com/ClickHouse/ClickHouse/pull/68820) ([Han Fei](https://github.com/hanfei1991)).
- Fix resolving dynamic subcolumns from subqueries in analyzer. [#68824](https://github.com/ClickHouse/ClickHouse/pull/68824) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix complex types metadata parsing in DeltaLake. Closes [#68739](https://github.com/ClickHouse/ClickHouse/issues/68739). [#68836](https://github.com/ClickHouse/ClickHouse/pull/68836) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fixed asynchronous inserts in case when metadata of table is changed (by `ALTER ADD/MODIFY COLUMN` queries) after insert but before flush to the table. [#68837](https://github.com/ClickHouse/ClickHouse/pull/68837) ([Anton Popov](https://github.com/CurtizJ)).
- Fix unexpected exception when passing empty tuple in array. This fixes [#68618](https://github.com/ClickHouse/ClickHouse/issues/68618). [#68848](https://github.com/ClickHouse/ClickHouse/pull/68848) ([Amos Bird](https://github.com/amosbird)).
- Fix parsing pure metadata mutations commands. [#68935](https://github.com/ClickHouse/ClickHouse/pull/68935) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fix possible wrong result during anyHeavy state merge. [#68950](https://github.com/ClickHouse/ClickHouse/pull/68950) ([Raúl Marín](https://github.com/Algunenano)).
- Fixed writing to Materialized Views with enabled setting `optimize_functions_to_subcolumns`. [#68951](https://github.com/ClickHouse/ClickHouse/pull/68951) ([Anton Popov](https://github.com/CurtizJ)).
- Don't use serializations cache in const Dynamic column methods. It could let to use-of-uninitialized value or even race condition during aggregations. [#68953](https://github.com/ClickHouse/ClickHouse/pull/68953) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix parsing error when null should be inserted as default in some cases during JSON type parsing. [#68955](https://github.com/ClickHouse/ClickHouse/pull/68955) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix `Content-Encoding` not sent in some compressed responses. [#64802](https://github.com/ClickHouse/ClickHouse/issues/64802). [#68975](https://github.com/ClickHouse/ClickHouse/pull/68975) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- There were cases when path was concatenated incorrectly and had the `//` part in it, solving this problem using path normalization. [#69066](https://github.com/ClickHouse/ClickHouse/pull/69066) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fix logical error when we have empty async insert. [#69080](https://github.com/ClickHouse/ClickHouse/pull/69080) ([Han Fei](https://github.com/hanfei1991)).
- Fixed data race of progress indication in clickhouse-client during query canceling. [#69081](https://github.com/ClickHouse/ClickHouse/pull/69081) ([Sergei Trifonov](https://github.com/serxa)).
- Fix a bug that the vector similarity index (currently experimental) was not utilized when used with cosine distance as distance function. [#69090](https://github.com/ClickHouse/ClickHouse/pull/69090) ([flynn](https://github.com/ucasfl)).
- This change addresses an issue where attempting to create a Replicated database again after a server failure during the initial creation process could result in error. [#69102](https://github.com/ClickHouse/ClickHouse/pull/69102) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- Don't infer Bool type from String in CSV when `input_format_csv_try_infer_numbers_from_strings = 1` because we don't allow reading bool values from strings. [#69109](https://github.com/ClickHouse/ClickHouse/pull/69109) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix explain ast insert queries parsing errors on client when `--multiquery` is enabled. [#69123](https://github.com/ClickHouse/ClickHouse/pull/69123) ([wxybear](https://github.com/wxybear)).
- `UNION` clause in subqueries wasn't handled correctly in queries with parallel replicas and lead to LOGICAL_ERROR `Duplicate announcement received for replica`. [#69146](https://github.com/ClickHouse/ClickHouse/pull/69146) ([Igor Nikonov](https://github.com/devcrafter)).
- Fix propogating structure argument in s3Cluster. Previously the `DEFAULT` expression of the column could be lost when sending the query to the replicas in s3Cluster. [#69147](https://github.com/ClickHouse/ClickHouse/pull/69147) ([Kruglov Pavel](https://github.com/Avogar)).
- Respect format settings in Values format during conversion from expression to the destination type. [#69149](https://github.com/ClickHouse/ClickHouse/pull/69149) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix `clickhouse-client --queries-file` for readonly users (previously fails with `Cannot modify 'log_comment' setting in readonly mode`). [#69175](https://github.com/ClickHouse/ClickHouse/pull/69175) ([Azat Khuzhin](https://github.com/azat)).
- Fix data race in clickhouse-client when it's piped to a process that terminated early. [#69186](https://github.com/ClickHouse/ClickHouse/pull/69186) ([vdimir](https://github.com/vdimir)).
- Fix incorrect results of Fix uniq and GROUP BY for JSON/Dynamic types. [#69203](https://github.com/ClickHouse/ClickHouse/pull/69203) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix the INFILE format detection for asynchronous inserts. If the format is not explicitly defined in the FORMAT clause, it can be detected from the INFILE file extension. [#69237](https://github.com/ClickHouse/ClickHouse/pull/69237) ([Julia Kartseva](https://github.com/jkartseva)).
- After [this issue](https://github.com/ClickHouse/ClickHouse/pull/59946#issuecomment-1943653197) there are quite a few table replicas in production such that their `metadata_version` node value is both equal to `0` and is different from the respective table's `metadata` node version. This leads to `alter` queries failing on such replicas. [#69274](https://github.com/ClickHouse/ClickHouse/pull/69274) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- Mark Dynamic type as not safe primary key type to avoid issues with Fields. [#69311](https://github.com/ClickHouse/ClickHouse/pull/69311) ([Kruglov Pavel](https://github.com/Avogar)).
- Improve restoring of access entities' dependencies. [#69346](https://github.com/ClickHouse/ClickHouse/pull/69346) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix undefined behavior when all connection attempts fail getting a connection for insertions. [#69390](https://github.com/ClickHouse/ClickHouse/pull/69390) ([Pablo Marcos](https://github.com/pamarcos)).
- Close [#69135](https://github.com/ClickHouse/ClickHouse/issues/69135). If we try to reuse joined data for `cross` join, but this could not happen in ClickHouse at present. It's better to keep `have_compressed` in `reuseJoinedData`. [#69404](https://github.com/ClickHouse/ClickHouse/pull/69404) ([lgbo](https://github.com/lgbo-ustc)).
- Make `materialize()` function return full column when parameter is a sparse column. [#69429](https://github.com/ClickHouse/ClickHouse/pull/69429) ([Alexander Gololobov](https://github.com/davenger)).
- Fixed a `LOGICAL_ERROR` with function `sqidDecode` ([#69450](https://github.com/ClickHouse/ClickHouse/issues/69450)). [#69451](https://github.com/ClickHouse/ClickHouse/pull/69451) ([Robert Schulze](https://github.com/rschu1ze)).
- Quick fix for s3queue problem on 24.6 or create query with database replicated. [#69454](https://github.com/ClickHouse/ClickHouse/pull/69454) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fixed case when memory consumption was too high because of the squashing in `INSERT INTO ... SELECT` or `CREATE TABLE AS SELECT` queries. [#69469](https://github.com/ClickHouse/ClickHouse/pull/69469) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Statements `SHOW COLUMNS` and `SHOW INDEX` now work properly if the table has dots in its name. [#69514](https://github.com/ClickHouse/ClickHouse/pull/69514) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
- Usage of the query cache for queries with an overflow mode != 'throw' is now disallowed. This prevents situations where potentially truncated and incorrect query results could be stored in the query cache. (issue [#67476](https://github.com/ClickHouse/ClickHouse/issues/67476)). [#69549](https://github.com/ClickHouse/ClickHouse/pull/69549) ([Robert Schulze](https://github.com/rschu1ze)).
- Keep original order of conditions during move to prewhere. Previously the order could change and it could lead to failing queries when the order is important. [#69560](https://github.com/ClickHouse/ClickHouse/pull/69560) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix Keeper multi-request preprocessing after ZNOAUTH error. [#69627](https://github.com/ClickHouse/ClickHouse/pull/69627) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix METADATA_MISMATCH that might have happened due to TTL with a WHERE clause in DatabaseReplicated when creating a new replica. [#69736](https://github.com/ClickHouse/ClickHouse/pull/69736) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix `StorageS3(Azure)Queue` settings `tracked_file_ttl_sec`. We wrote it to keeper with key `tracked_file_ttl_sec`, but read as `tracked_files_ttl_sec`, which was a typo. [#69742](https://github.com/ClickHouse/ClickHouse/pull/69742) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Use tryconvertfieldtotype in gethyperrectangleforrowgroup. [#69745](https://github.com/ClickHouse/ClickHouse/pull/69745) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- Revert "Fix prewhere without columns and without adaptive index granularity (almost w/o anything)"'. Due to the reverted changes some errors might happen when reading data parts produced by old CH releases (presumably 2021 or older). [#68897](https://github.com/ClickHouse/ClickHouse/pull/68897) ([Alexander Gololobov](https://github.com/davenger)).

### <a id="248"></a> ClickHouse リリース 24.8 LTS, 2024-08-20 {#a-id248a-clickhouse-release-248-lts-2024-08-20}

#### 後方互換性のない変更 {#backward-incompatible-change-4}

- `clickhouse-client` と `clickhouse-local` は、デフォルトでマルチクエリモード(シングルクエリモードではなく)になりました。例えば、`clickhouse-client -q "SELECT 1; SELECT 2"` が動作するようになりましたが、以前はユーザーが `--multiquery`(または `-n`)を追加する必要がありました。`--multiquery/-n` スイッチは廃止されました。マルチクエリステートメント内の INSERT クエリは、FORMAT 句に基づいて特別に処理されます。FORMAT が `VALUES`(最も一般的なケース)の場合、INSERT ステートメントの終わりはクエリの末尾のセミコロン `;` で表されます。その他すべての FORMAT(例: `CSV` や `JSONEachRow`)の場合、INSERT ステートメントの終わりはクエリの末尾の2つの改行 `\n\n` で表されます。[#63898](https://github.com/ClickHouse/ClickHouse/pull/63898) ([FFish](https://github.com/wxybear))。
- 以前のバージョンでは、データ型名に `WithDictionary` を追加することで `LowCardinality` データ型の代替構文を使用することが可能でした。これは初期の動作実装であり、文書化されたことも公開されたこともありませんでした。現在、これは非推奨となっています。この構文を使用している場合は、テーブルを ALTER してデータ型を `LowCardinality` に変更する必要があります。[#66842](https://github.com/ClickHouse/ClickHouse/pull/66842) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 分散先テーブルと共に使用されるストレージ `Buffer` の論理エラーを修正しました。これは後方互換性のない変更です。分散先テーブルと共に `Buffer` を使用するクエリは、テーブルがクエリ内に複数回出現する場合(例: 自己結合)、動作しなくなる可能性があります。[#67015](https://github.com/ClickHouse/ClickHouse/pull/67015) ([vdimir](https://github.com/vdimir))。
- 以前のバージョンでは、ガンマ関数に基づくランダム分布の関数(カイ二乗分布、スチューデント分布、フィッシャー分布など)をゼロに近い負の引数で呼び出すと、長時間の計算または無限ループが発生していました。新しいバージョンでは、これらの関数をゼロまたは負の引数で呼び出すと例外が発生します。これにより [#67297](https://github.com/ClickHouse/ClickHouse/issues/67297) が解決されます。[#67326](https://github.com/ClickHouse/ClickHouse/pull/67326) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- システムテーブル `text_log` はデフォルトで有効になっています。これは以前のバージョンと完全に互換性がありますが、ローカルディスクのディスク使用量がわずかに増加することに気付く場合があります(このシステムテーブルはごくわずかなディスク容量を使用します)。[#67428](https://github.com/ClickHouse/ClickHouse/pull/67428) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 以前のバージョンでは、`arrayWithConstant` は非常に大きな配列の生成を要求された場合に遅くなることがありました。新しいバージョンでは、配列あたり 1 GB に制限されています。これにより [#32754](https://github.com/ClickHouse/ClickHouse/issues/32754) が解決されます。[#67741](https://github.com/ClickHouse/ClickHouse/pull/67741) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- REPLACE 修飾子のフォーマットを修正しました(括弧の省略を禁止)。[#67774](https://github.com/ClickHouse/ClickHouse/pull/67774) ([Azat Khuzhin](https://github.com/azat))。
- [#68349](https://github.com/ClickHouse/ClickHouse/issues/68349) にバックポート: `Dynamic` 型を再実装しました。動的データ型の制限に達した場合、新しい型は String にキャストされず、バイナリエンコードされたデータ型を持つバイナリ形式の特別なデータ構造に格納されます。これにより、`Dynamic` カラムに挿入されたすべての型をサブカラムとして読み取ることができるようになりました。[#68132](https://github.com/ClickHouse/ClickHouse/pull/68132) ([Kruglov Pavel](https://github.com/Avogar))。


#### 新機能 {#new-feature-4}

- 新しい`MergeTree`設定`deduplicate_merge_projection_mode`を追加し、マージ時のプロジェクション（特定のエンジン用）および`OPTIMIZE DEDUPLICATE`クエリを制御できるようにしました。サポートされるオプション：`throw`（プロジェクションが\*MergeTreeエンジンで完全にサポートされていない場合に例外をスロー）、`drop`（一貫してマージできない場合、マージ中にプロジェクションを削除）、`rebuild`（プロジェクションをゼロから再構築する重い操作）。[#66672](https://github.com/ClickHouse/ClickHouse/pull/66672) ([jsc0218](https://github.com/jsc0218))。
- S3テーブルエンジンに`_etag`仮想カラムを追加しました。修正：[#65312](https://github.com/ClickHouse/ClickHouse/issues/65312)。[#65386](https://github.com/ClickHouse/ClickHouse/pull/65386) ([skyoct](https://github.com/skyoct))。
- クエリキャッシュにタグ付け（名前空間）メカニズムを追加しました。異なるタグを持つ同じクエリは、クエリキャッシュによって異なるものとして扱われます。例：`SELECT 1 SETTINGS use_query_cache = 1, query_cache_tag = 'abc'`と`SELECT 1 SETTINGS use_query_cache = 1, query_cache_tag = 'def'`は、異なるクエリキャッシュエントリを作成するようになりました。[#68235](https://github.com/ClickHouse/ClickHouse/pull/68235) ([sakulali](https://github.com/sakulali))。
- 左右両方のテーブルのカラムを含む不等条件を持つJOIN厳密性のより多くのバリエーション（`LEFT/RIGHT SEMI/ANTI/ANY JOIN`）をサポートしました。例：`t1.y < t2.y`（設定`allow_experimental_join_condition`を参照）。[#64281](https://github.com/ClickHouse/ClickHouse/pull/64281) ([lgbo](https://github.com/lgbo-ustc))。
- 異なるエンジン（`File`、`URL`、`S3`、`AzureBlobStorage`、`HDFS`）でHiveスタイルのパーティショニングを解釈できるようにしました。Hiveスタイルのパーティショニングは、データをパーティション化されたサブディレクトリに整理し、大規模なデータセットのクエリと管理を効率化します。現在は、適切な名前とデータを持つ仮想カラムのみを作成します。後続のPRで適切なデータフィルタリング（パフォーマンス向上）が導入される予定です。[#65997](https://github.com/ClickHouse/ClickHouse/pull/65997) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- Spark互換性のために関数`printf`を追加しました（ただし、既存の`format`関数も使用できます）。[#66257](https://github.com/ClickHouse/ClickHouse/pull/66257) ([李扬](https://github.com/taiyang-li))。
- テストに役立つ、外部エンジンとtable_enginesを`Null`エンジンに置き換えるオプション`restore_replace_external_engines_to_null`と`restore_replace_external_table_functions_to_null`を追加しました。RESTOREと明示的なテーブル作成で機能します。[#66536](https://github.com/ClickHouse/ClickHouse/pull/66536) ([Ilya Yatsishin](https://github.com/qoega))。
- 関数`readWKTLineString`を使用して`WKT`形式の`MULTILINESTRING`ジオメトリを読み取るサポートを追加しました。[#67647](https://github.com/ClickHouse/ClickHouse/pull/67647) ([Jacob Reckhard](https://github.com/jacobrec))。
- 新しいテーブル関数`fuzzQuery`を追加しました。この関数は、指定されたクエリ文字列にランダムなバリエーションを加えて変更できます。例：`SELECT query FROM fuzzQuery('SELECT 1') LIMIT 5;`。[#67655](https://github.com/ClickHouse/ClickHouse/pull/67655) ([pufit](https://github.com/pufit))。
- すべてのデタッチされたパーティションを削除するクエリ`ALTER TABLE ... DROP DETACHED PARTITION ALL`を追加しました。[#67885](https://github.com/ClickHouse/ClickHouse/pull/67885) ([Duc Canh Le](https://github.com/canhld94))。
- 新しい設定`rows_before_aggregation`が有効な場合、クエリレスポンスに`rows_before_aggregation_at_least`統計を追加しました。この統計は、集約前に読み取られた行数を表します。分散クエリのコンテキストでは、`limit`なしで`group by`または`max`集約関数を使用する場合、`rows_before_aggregation_at_least`はクエリによってヒットした行数を反映できます。[#66084](https://github.com/ClickHouse/ClickHouse/pull/66084) ([morning-color](https://github.com/morning-color))。
- `Join`テーブルで`OPTIMIZE`クエリをサポートし、メモリフットプリントを削減できるようにしました。[#67883](https://github.com/ClickHouse/ClickHouse/pull/67883) ([Duc Canh Le](https://github.com/canhld94))。
- URLに`&run=1`を追加すると、playでクエリを即座に実行できるようにしました。[#66457](https://github.com/ClickHouse/ClickHouse/pull/66457) ([Aleksandr Musorin](https://github.com/AVMusorin))。

#### 実験的機能 {#experimental-feature-3}

- 新しい`JSON`データ型を実装しました。[#66444](https://github.com/ClickHouse/ClickHouse/pull/66444) ([Kruglov Pavel](https://github.com/Avogar))。
- 新しい`TimeSeries`テーブルエンジンを追加しました。[#64183](https://github.com/ClickHouse/ClickHouse/pull/64183) ([Vitaly Baranov](https://github.com/vitlibar))。
- オフセットをKafkaにコミットする代わりにKeeperに保存する新しい実験的な`Kafka`ストレージエンジンを追加しました。これにより、キューからの消費に関してClickHouseテーブルへのコミットがアトミックになります。[#57625](https://github.com/ClickHouse/ClickHouse/pull/57625) ([János Benjamin Antal](https://github.com/antaljanosbenjamin))。
- 並列レプリカに対して適応的な読み取りタスクサイズ計算方式(読み取るカラムサイズに応じて変化)を使用するようにしました。[#60377](https://github.com/ClickHouse/ClickHouse/pull/60377) ([Nikita Taranov](https://github.com/nickitat))。
- `col = 'val'`のような等価述語の選択性推定を提供する統計タイプ`count_min`(count-minスケッチ)を追加しました。サポートされるデータ型は文字列、日付、日時、および数値型です。[#65521](https://github.com/ClickHouse/ClickHouse/pull/65521) ([JackyWoo](https://github.com/JackyWoo))。

#### パフォーマンス改善 {#performance-improvement-4}

- 設定`optimize_functions_to_subcolumns`がデフォルトで有効になりました。[#68053](https://github.com/ClickHouse/ClickHouse/pull/68053) ([Anton Popov](https://github.com/CurtizJ))。
- `plain_rewritable`ディスクのディレクトリメタデータを、オブジェクトストレージ内のマージツリーデータとは別に`__meta`レイアウトに保存するようにしました。`plain_rewritable`ディスクをフラットなディレクトリ構造に移行しました。[#65751](https://github.com/ClickHouse/ClickHouse/pull/65751) ([Julia Kartseva](https://github.com/jkartseva))。
- すべてのサブカラムに対して必要なメモリを事前に確保することで、`String`/`Array`/`Map`/`Variant`/`Dynamic`型のカラム圧縮(INSERTクエリで発生する操作)を改善しました。[#67043](https://github.com/ClickHouse/ClickHouse/pull/67043) ([Kruglov Pavel](https://github.com/Avogar))。
- `SYSTEM FLUSH LOGS`とシャットダウン時のログフラッシュを高速化しました。[#67472](https://github.com/ClickHouse/ClickHouse/pull/67472) ([Sema Checherinda](https://github.com/CheSema))。
- マージのスケジューリングステップのオーバーヘッドを削減することで、マージの全体的なパフォーマンスを改善しました。[#68016](https://github.com/ClickHouse/ClickHouse/pull/68016) ([Anton Popov](https://github.com/CurtizJ))。
- `DROP DATABASE`クエリのテーブル削除を高速化し、`database_catalog_drop_table_concurrency`のデフォルト値を16に増やしました。[#67228](https://github.com/ClickHouse/ClickHouse/pull/67228) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- ORC書き込み時に配列カラムに対して過剰な容量を割り当てないようにしました。配列カラムのパフォーマンスが15%向上しました。[#67879](https://github.com/ClickHouse/ClickHouse/pull/67879) ([李扬](https://github.com/taiyang-li))。
- 非レプリケートMergeTreeのミューテーションを大幅に高速化しました。[#66911](https://github.com/ClickHouse/ClickHouse/pull/66911) [#66909](https://github.com/ClickHouse/ClickHouse/pull/66909) ([Alexey Milovidov](https://github.com/alexey-milovidov))。


#### 改善 {#improvement-4}

- 設定 `allow_experimental_analyzer` は `enable_analyzer` に名称変更されました。旧名称はエイリアスとして保持されています。これは、Analyzerがベータ版ではなくなり、本番環境に完全に昇格したことを示しています。[#66438](https://github.com/ClickHouse/ClickHouse/pull/66438) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 日時のスキーマ推論を改善しました。DateTime64は日時に小数部分がある場合のみ使用され、それ以外の場合は通常のDateTimeが使用されます。Date/DateTimeの推論はより厳格になり、特に `date_time_input_format='best_effort'` の場合、コーナーケースで文字列から日時を推論することを回避します。[#68382](https://github.com/ClickHouse/ClickHouse/pull/68382) ([Kruglov Pavel](https://github.com/Avogar))。
- ClickHouseサーバーは新しい設定 `max_keep_alive_requests` をサポートするようになりました。サーバーへのkeep-alive HTTP接続では、`keep_alive_timeout` と連携して動作します。アイドルタイムアウトが期限切れになっていなくても、指定された接続を通じて `max_keep_alive_requests` を超えるリクエストが既に実行されている場合、サーバーによって接続が閉じられます。[#61793](https://github.com/ClickHouse/ClickHouse/pull/61793) ([Nikita Taranov](https://github.com/nickitat))。
- 高度なダッシュボードにさまざまな改善を加えました。これにより [#67697](https://github.com/ClickHouse/ClickHouse/issues/67697) がクローズされます。これにより [#63407](https://github.com/ClickHouse/ClickHouse/issues/63407) がクローズされます。これにより [#51129](https://github.com/ClickHouse/ClickHouse/issues/51129) がクローズされます。これにより [#61204](https://github.com/ClickHouse/ClickHouse/issues/61204) がクローズされます。[#67701](https://github.com/ClickHouse/ClickHouse/pull/67701) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- Distributedテーブルを作成する際にREMOTEの権限を要求しないようにしました。Distributedエンジンの権限があれば十分です。[#65419](https://github.com/ClickHouse/ClickHouse/pull/65419) ([jsc0218](https://github.com/jsc0218))。
- Dockerイメージでkeeperのログを明示的に渡さないようにし、オーバーライドを可能にしました。[#65564](https://github.com/ClickHouse/ClickHouse/pull/65564) ([Azat Khuzhin](https://github.com/azat))。
- `BACKUP` および `RESTORE` クエリに `use_same_password_for_base_backup` 設定を導入し、パスワード保護されたアーカイブへの増分バックアップの作成と復元を可能にしました。[#66214](https://github.com/ClickHouse/ClickHouse/pull/66214) ([Samuele](https://github.com/sguerrini97))。
- `ATTACH` クエリで `async_load_databases` を無視するようにしました(以前は、テーブルがアタッチされる前にATTACHが戻ることが可能でした)。[#66240](https://github.com/ClickHouse/ClickHouse/pull/66240) ([Azat Khuzhin](https://github.com/azat))。
- 拒否された接続(リソースが不足している場合)のログとメトリクスを追加しました。[#66410](https://github.com/ClickHouse/ClickHouse/pull/66410) ([Alexander Tokmakov](https://github.com/tavplubix))。
- MongoDBエンジンで適切な `UUID` 型をサポートしました。[#66671](https://github.com/ClickHouse/ClickHouse/pull/66671) ([Azat Khuzhin](https://github.com/azat))。
- レプリケーション遅延と復旧時間のメトリクスを追加しました。[#66703](https://github.com/ClickHouse/ClickHouse/pull/66703) ([Miсhael Stetsyuk](https://github.com/mstetsyuk))。
- `DiskS3NoSuchKeyErrors` メトリクスを追加しました。[#66704](https://github.com/ClickHouse/ClickHouse/pull/66704) ([Miсhael Stetsyuk](https://github.com/mstetsyuk))。
- すべてのテーブルエンジンで `COMMENT` 句が機能することを保証しました。[#66832](https://github.com/ClickHouse/ClickHouse/pull/66832) ([Joe Lynch](https://github.com/joelynch))。
- 関数 `mapFromArrays` は第1引数として `Map(K, V)` を受け入れるようになりました。例えば、`SELECT mapFromArrays(map('a', 4, 'b', 4), ['aa', 'bb'])` が動作し、`{('a',4):'aa',('b',4):'bb'}` を返します。また、第1引数が配列の場合、実際の配列値が `NULL` でない限り、`Array(Nullable(T))` または `Array(LowCardinality(Nullable(T)))` 型も使用できるようになりました。[#67103](https://github.com/ClickHouse/ClickHouse/pull/67103) ([李扬](https://github.com/taiyang-li))。
- `clickhouse-local` の設定を `~/.clickhouse-local` から読み込むようにしました。[#67135](https://github.com/ClickHouse/ClickHouse/pull/67135) ([Azat Khuzhin](https://github.com/azat))。
- 設定 `input_format_orc_read_use_writer_time_zone` を `input_format_orc_reader_timezone` に名称変更し、ユーザーがリーダーのタイムゾーンを設定できるようにしました。[#67175](https://github.com/ClickHouse/ClickHouse/pull/67175) ([kevinyhzou](https://github.com/KevinyhZou))。
- 接続後すぐにピアによってHTTP接続がリセットされた場合の `Socket is not connected` エラーのレベルを下げました。[#34218](https://github.com/ClickHouse/ClickHouse/issues/34218) をクローズします。[#67177](https://github.com/ClickHouse/ClickHouse/pull/67177) ([vdimir](https://github.com/vdimir))。
- 設定から `system.dashboards` のダッシュボードを読み込む機能を追加しました(設定されると、デフォルトのダッシュボードプリセットを上書きします)。[#67232](https://github.com/ClickHouse/ClickHouse/pull/67232) ([Azat Khuzhin](https://github.com/azat))。
- SQLのウィンドウ関数は伝統的にスネークケースです。ClickHouseは `camelCase` を使用するため、新しいエイリアス `denseRank()` と `percentRank()` が作成されました。これらの新しい関数は、元の `dense_rank()` および `percent_rank()` 関数とまったく同じように呼び出すことができます。スネークケースとキャメルケースの両方の構文が引き続き使用可能です。各関数の新しいテストも追加されました。これにより [#67042](https://github.com/ClickHouse/ClickHouse/issues/67042) がクローズされます。[#67334](https://github.com/ClickHouse/ClickHouse/pull/67334) ([Peter Nguyen](https://github.com/petern48))。
- `.xml`、`.yml`、または `.yaml` でない場合、設定ファイル形式を自動検出します。ファイルが &lt; で始まる場合はXMLの可能性があり、それ以外の場合はYAMLの可能性があります。これは、パイプから設定ファイルを提供する場合に便利です: `clickhouse-server --config-file <(echo "hello: world")`。[#67391](https://github.com/ClickHouse/ClickHouse/pull/67391) ([sakulali](https://github.com/sakulali))。
- 関数 `formatDateTime` と `formatDateTimeInJodaSyntax` は、フォーマットパラメータをオプションとして扱うようになりました。指定されていない場合、フォーマット文字列 `%Y-%m-%d %H:%i:%s` と `yyyy-MM-dd HH:mm:ss` が想定されます。例: `SELECT parseDateTime('2021-01-04 23:12:34')` は DateTime値 `2021-01-04 23:12:34` を返すようになりました(以前は例外がスローされていました)。[#67399](https://github.com/ClickHouse/ClickHouse/pull/67399) ([Robert Schulze](https://github.com/rschu1ze))。
- タイムアウトまたは接続喪失が原因で発生した場合、KeeperMapでKeeperリクエストを自動的に再試行します。[#67448](https://github.com/ClickHouse/ClickHouse/pull/67448) ([Antonio Andelic](https://github.com/antonio2368))。
- Aarch64 Linuxビルドに `-no-pie` を追加し、ClickHouse再起動後のスタックトレースの適切なイントロスペクションとシンボル化を可能にしました。[#67916](https://github.com/ClickHouse/ClickHouse/pull/67916) ([filimonov](https://github.com/filimonov))。
- より良いイントロスペクションのために、マージとミューテーションのプロファイルイベントを追加しました。[#68015](https://github.com/ClickHouse/ClickHouse/pull/68015) ([Anton Popov](https://github.com/CurtizJ))。
- 非レプリケート `MergeTree` の不要なログを削除しました。[#68238](https://github.com/ClickHouse/ClickHouse/pull/68238) ([Daniil Ivanik](https://github.com/divanik))。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-1}

- 統合テストの不安定性チェックでは、各テストケースを複数回実行してテスト内のより多くの問題を発見し、信頼性を向上させます。同じ環境でテストケースを複数回実行するために`pytest-repeat`ライブラリを使用しています。テストケースを成功させるには、最後にテーブルやその他のエンティティをクリーンアップすることが重要です。必要なコンテナを一度だけ起動するため、繰り返し実行は複数のpytestの実行よりもはるかに高速に動作します。[#66986](https://github.com/ClickHouse/ClickHouse/pull/66986) ([Ilya Yatsishin](https://github.com/qoega))。
- ClickHouseでのCLionの使用のブロックを解除しました。以前のバージョンでは、CLionがキー入力のたびに1分間フリーズしていました。これにより [#66994](https://github.com/ClickHouse/ClickHouse/issues/66994) が解決されます。[#66995](https://github.com/ClickHouse/ClickHouse/pull/66995) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- getauxval: 新しいLinuxカーネルにおける高いASLRエントロピーによるサニタイザー再実行時のクラッシュを回避しました。[#67081](https://github.com/ClickHouse/ClickHouse/pull/67081) ([Raúl Marín](https://github.com/Algunenano))。
- クライアントコードの一部を単一のファイルに抽出し、デバッグビルドであっても可能な限り最高レベルの最適化を適用しました。これにより [#65745](https://github.com/ClickHouse/ClickHouse/issues/65745) が解決されます。[#67215](https://github.com/ClickHouse/ClickHouse/pull/67215) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。


#### バグ修正 {#bug-fix}

- Only relevant to the experimental Variant data type. Fix crash with Variant + AggregateFunction type. [#67122](https://github.com/ClickHouse/ClickHouse/pull/67122) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix crash in DistributedAsyncInsert when connection is empty. [#67219](https://github.com/ClickHouse/ClickHouse/pull/67219) ([Pablo Marcos](https://github.com/pamarcos)).
- Fix crash of `uniq` and `uniqTheta ` with `tuple()` argument. Closes [#67303](https://github.com/ClickHouse/ClickHouse/issues/67303). [#67306](https://github.com/ClickHouse/ClickHouse/pull/67306) ([flynn](https://github.com/ucasfl)).
- Fixes [#66026](https://github.com/ClickHouse/ClickHouse/issues/66026). Avoid unresolved table function arguments traversal in `ReplaceTableNodeToDummyVisitor`. [#67522](https://github.com/ClickHouse/ClickHouse/pull/67522) ([Dmitry Novik](https://github.com/novikd)).
- Fix potential stack overflow in `JSONMergePatch` function. Renamed this function from `jsonMergePatch` to `JSONMergePatch` because the previous name was wrong. The previous name is still kept for compatibility. Improved diagnostic of errors in the function. This closes [#67304](https://github.com/ClickHouse/ClickHouse/issues/67304). [#67756](https://github.com/ClickHouse/ClickHouse/pull/67756) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fixed a NULL pointer dereference, triggered by a specially crafted query, that crashed the server via hopEnd, hopStart, tumbleEnd, and tumbleStart. [#68098](https://github.com/ClickHouse/ClickHouse/pull/68098) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
- Fixed `Not-ready Set` in some system tables when filtering using subqueries. [#66018](https://github.com/ClickHouse/ClickHouse/pull/66018) ([Michael Kolupaev](https://github.com/al13n321)).
- Fixed reading of subcolumns after `ALTER ADD COLUMN` query. [#66243](https://github.com/ClickHouse/ClickHouse/pull/66243) ([Anton Popov](https://github.com/CurtizJ)).
- Fix boolean literals in query sent to external database (for engines like `PostgreSQL`). [#66282](https://github.com/ClickHouse/ClickHouse/pull/66282) ([vdimir](https://github.com/vdimir)).
- Fix formatting of query with aliased JOIN ON expression, e.g. `... JOIN t2 ON (x = y) AS e ORDER BY x` should be formatted as `... JOIN t2 ON ((x = y) AS e) ORDER BY x`. [#66312](https://github.com/ClickHouse/ClickHouse/pull/66312) ([vdimir](https://github.com/vdimir)).
- Fix cluster() for inter-server secret (preserve initial user as before). [#66364](https://github.com/ClickHouse/ClickHouse/pull/66364) ([Azat Khuzhin](https://github.com/azat)).
- Fix possible runtime error while converting Array field with nulls to Array(Variant). [#66727](https://github.com/ClickHouse/ClickHouse/pull/66727) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix for occasional deadlock in Context::getDDLWorker. [#66843](https://github.com/ClickHouse/ClickHouse/pull/66843) ([Alexander Gololobov](https://github.com/davenger)).
- Fix creating KeeperMap table after an incomplete drop. [#66865](https://github.com/ClickHouse/ClickHouse/pull/66865) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix broken part error while restoring to a `s3_plain_rewritable` disk. [#66881](https://github.com/ClickHouse/ClickHouse/pull/66881) ([Vitaly Baranov](https://github.com/vitlibar)).
- In rare cases ClickHouse could consider parts as broken because of some unexpected projections on disk. Now it's fixed. [#66898](https://github.com/ClickHouse/ClickHouse/pull/66898) ([alesapin](https://github.com/alesapin)).
- Fix invalid format detection in schema inference that could lead to logical error Format {} doesn't support schema inference. [#66899](https://github.com/ClickHouse/ClickHouse/pull/66899) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix possible deadlock on query cancel with parallel replicas. [#66905](https://github.com/ClickHouse/ClickHouse/pull/66905) ([Nikita Taranov](https://github.com/nickitat)).
- Forbid create as select even when database_replicated_allow_heavy_create is set. It was unconditionally forbidden in 23.12 and accidentally allowed under the setting in unreleased 24.7. [#66980](https://github.com/ClickHouse/ClickHouse/pull/66980) ([vdimir](https://github.com/vdimir)).
- Reading from the `numbers` could wrongly throw an exception when the `max_rows_to_read` limit was set. This closes [#66992](https://github.com/ClickHouse/ClickHouse/issues/66992). [#66996](https://github.com/ClickHouse/ClickHouse/pull/66996) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Add proper type conversion to lagInFrame and leadInFrame window functions - fixes msan test. [#67091](https://github.com/ClickHouse/ClickHouse/pull/67091) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- TRUNCATE DATABASE used to stop replication as if it was a DROP DATABASE query, it's fixed. [#67129](https://github.com/ClickHouse/ClickHouse/pull/67129) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Use a separate client context in `clickhouse-local`. [#67133](https://github.com/ClickHouse/ClickHouse/pull/67133) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix error `Cannot convert column because it is non constant in source stream but must be constant in result.` for a query that reads from the `Merge` table over the `Distriburted` table with one shard. [#67146](https://github.com/ClickHouse/ClickHouse/pull/67146) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Correct behavior of `ORDER BY all` with disabled `enable_order_by_all` and parallel replicas (distributed queries as well). [#67153](https://github.com/ClickHouse/ClickHouse/pull/67153) ([Igor Nikonov](https://github.com/devcrafter)).
- Fix wrong usage of input_format_max_bytes_to_read_for_schema_inference in schema cache. [#67157](https://github.com/ClickHouse/ClickHouse/pull/67157) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix the memory leak for count distinct, when exception issued during group by single nullable key. [#67171](https://github.com/ClickHouse/ClickHouse/pull/67171) ([Jet He](https://github.com/compasses)).
- Fix an error in optimization which converts OUTER JOIN to INNER JOIN. This closes [#67156](https://github.com/ClickHouse/ClickHouse/issues/67156). This closes [#66447](https://github.com/ClickHouse/ClickHouse/issues/66447). The bug was introduced in https://github.com/ClickHouse/ClickHouse/pull/62907. [#67178](https://github.com/ClickHouse/ClickHouse/pull/67178) ([Maksim Kita](https://github.com/kitaisreal)).
- Fix error `Conversion from AggregateFunction(name, Type) to AggregateFunction(name, Nullable(Type)) is not supported`. The bug was caused by the `optimize_rewrite_aggregate_function_with_if` optimization. Fixes [#67112](https://github.com/ClickHouse/ClickHouse/issues/67112). [#67229](https://github.com/ClickHouse/ClickHouse/pull/67229) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix hung query when using empty tuple as lhs of function IN. [#67295](https://github.com/ClickHouse/ClickHouse/pull/67295) ([Duc Canh Le](https://github.com/canhld94)).
- It was possible to create a very deep nested JSON data that triggered stack overflow while skipping unknown fields. This closes [#67292](https://github.com/ClickHouse/ClickHouse/issues/67292). [#67324](https://github.com/ClickHouse/ClickHouse/pull/67324) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix attaching ReplicatedMergeTree table after exception during startup. [#67360](https://github.com/ClickHouse/ClickHouse/pull/67360) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix segfault caused by incorrectly detaching from thread group in `Aggregator`. [#67385](https://github.com/ClickHouse/ClickHouse/pull/67385) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix one more case when a non-deterministic function is specified in PK. [#67395](https://github.com/ClickHouse/ClickHouse/pull/67395) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fixed `bloom_filter` index breaking queries with mildly weird conditions like `(k=2)=(k=2)` or `has([1,2,3], k)`. [#67423](https://github.com/ClickHouse/ClickHouse/pull/67423) ([Michael Kolupaev](https://github.com/al13n321)).
- Correctly parse file name/URI containing `::` if it's not an archive. [#67433](https://github.com/ClickHouse/ClickHouse/pull/67433) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix wait for tasks in ~WriteBufferFromS3 in case WriteBuffer was cancelled. [#67459](https://github.com/ClickHouse/ClickHouse/pull/67459) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Protect temporary part directories from removing during RESTORE. [#67491](https://github.com/ClickHouse/ClickHouse/pull/67491) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix execution of nested short-circuit functions. [#67520](https://github.com/ClickHouse/ClickHouse/pull/67520) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix `Logical error: Expected the argument №N of type T to have X rows, but it has 0`. The error could happen in a remote query with constant expression in `GROUP BY` (with a new analyzer). [#67536](https://github.com/ClickHouse/ClickHouse/pull/67536) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix join on tuple with NULLs: Some queries with the new analyzer and `NULL` inside the tuple in the `JOIN ON` section returned incorrect results. [#67538](https://github.com/ClickHouse/ClickHouse/pull/67538) ([vdimir](https://github.com/vdimir)).
- Fix redundant reschedule of FileCache::freeSpaceRatioKeepingThreadFunc() in case of full non-evictable cache. [#67540](https://github.com/ClickHouse/ClickHouse/pull/67540) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix inserting into stream like engines (Kafka, RabbitMQ, NATS) through HTTP interface. [#67554](https://github.com/ClickHouse/ClickHouse/pull/67554) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fix for function `toStartOfWeek` which returned the wrong result with a small `DateTime64` value. [#67558](https://github.com/ClickHouse/ClickHouse/pull/67558) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fix creation of view with recursive CTE. [#67587](https://github.com/ClickHouse/ClickHouse/pull/67587) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix `Logical error: 'file_offset_of_buffer_end <= read_until_position'` in filesystem cache. Closes [#57508](https://github.com/ClickHouse/ClickHouse/issues/57508). [#67623](https://github.com/ClickHouse/ClickHouse/pull/67623) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fixes [#62282](https://github.com/ClickHouse/ClickHouse/issues/62282). Removed the call to `convertFieldToString()` and added datatype specific serialization code. Parameterized view substitution was broken for multiple datatypes when parameter value was a function or expression returning datatype instance. [#67654](https://github.com/ClickHouse/ClickHouse/pull/67654) ([Shankar](https://github.com/shiyer7474)).
- Fix crash on `percent_rank`. `percent_rank`'s default frame type is changed to `range unbounded preceding and unbounded following`. `IWindowFunction`'s default window frame is considered and now window functions without window frame definition in sql can be put into different `WindowTransfomer`s properly. [#67661](https://github.com/ClickHouse/ClickHouse/pull/67661) ([lgbo](https://github.com/lgbo-ustc)).
- Fix reloading SQL UDFs with UNION. Previously, restarting the server could make UDF invalid. [#67665](https://github.com/ClickHouse/ClickHouse/pull/67665) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix possible logical error "Unexpected return type from if" with experimental Variant type and enabled setting `use_variant_as_common_type ` in function if with Tuples and Maps. [#67687](https://github.com/ClickHouse/ClickHouse/pull/67687) ([Kruglov Pavel](https://github.com/Avogar)).
- Due to a bug in Linux Kernel, a query can hung in `TimerDescriptor::drain`. This closes [#37686](https://github.com/ClickHouse/ClickHouse/issues/37686). [#67702](https://github.com/ClickHouse/ClickHouse/pull/67702) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix completion of `RESTORE ON CLUSTER` command. [#67720](https://github.com/ClickHouse/ClickHouse/pull/67720) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix dictionary hang in case of CANNOT_SCHEDULE_TASK while loading. [#67751](https://github.com/ClickHouse/ClickHouse/pull/67751) ([Azat Khuzhin](https://github.com/azat)).
- Queries like `SELECT count() FROM t WHERE cast(c = 1 or c = 9999 AS Bool) SETTINGS use_skip_indexes=1` with bloom filter indexes on `c` now work correctly. [#67781](https://github.com/ClickHouse/ClickHouse/pull/67781) ([jsc0218](https://github.com/jsc0218)).
- Fix wrong aggregation result in some queries with aggregation without keys and filter, close [#67419](https://github.com/ClickHouse/ClickHouse/issues/67419). [#67804](https://github.com/ClickHouse/ClickHouse/pull/67804) ([vdimir](https://github.com/vdimir)).
- Validate experimental/suspicious data types in ALTER ADD/MODIFY COLUMN. [#67911](https://github.com/ClickHouse/ClickHouse/pull/67911) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix DateTime64 parsing after constant folding in distributed queries, close [#66773](https://github.com/ClickHouse/ClickHouse/issues/66773). [#67920](https://github.com/ClickHouse/ClickHouse/pull/67920) ([vdimir](https://github.com/vdimir)).
- Fix wrong `count()` result when there is non-deterministic function in predicate. [#67922](https://github.com/ClickHouse/ClickHouse/pull/67922) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fixed the calculation of the maximum thread soft limit in containerized environments where the usable CPU count is limited. [#67963](https://github.com/ClickHouse/ClickHouse/pull/67963) ([Robert Schulze](https://github.com/rschu1ze)).
- Now ClickHouse doesn't consider part as broken if projection doesn't exist on disk but exists in `checksums.txt`. [#68003](https://github.com/ClickHouse/ClickHouse/pull/68003) ([alesapin](https://github.com/alesapin)).
- Fixed skipping of untouched parts in mutations with new analyzer. Previously with enabled analyzer data in part could be rewritten by mutation even if mutation doesn't affect this part according to predicate. [#68052](https://github.com/ClickHouse/ClickHouse/pull/68052) ([Anton Popov](https://github.com/CurtizJ)).
- Removes an incorrect optimization to remove sorting in subqueries that use `OFFSET`. Fixes [#67906](https://github.com/ClickHouse/ClickHouse/issues/67906). [#68099](https://github.com/ClickHouse/ClickHouse/pull/68099) ([Graham Campbell](https://github.com/GrahamCampbell)).
- Attempt to fix `Block structure mismatch in AggregatingStep stream: different types` for aggregate projection optimization. [#68107](https://github.com/ClickHouse/ClickHouse/pull/68107) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Try fix postgres crash when query is cancelled. [#68288](https://github.com/ClickHouse/ClickHouse/pull/68288) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix missing sync replica mode in query `SYSTEM SYNC REPLICA`. [#68326](https://github.com/ClickHouse/ClickHouse/pull/68326) ([Duc Canh Le](https://github.com/canhld94)).

### <a id="247"></a> ClickHouse リリース 24.7, 2024-07-30 {#a-id247a-clickhouse-release-247-2024-07-30}

#### 後方互換性のない変更 {#backward-incompatible-change-5}

- Replicated データベースでの `CRATE MATERIALIZED VIEW ... ENGINE Replicated*MergeTree POPULATE AS SELECT ...` を禁止しました。[#63963](https://github.com/ClickHouse/ClickHouse/pull/63963) ([vdimir](https://github.com/vdimir))。
- `clickhouse-keeper-client` は、`ls '/hello/world'` のような文字列リテラルのパスのみを受け付けるようになり、`ls /hello/world` のような裸の文字列は受け付けなくなりました。[#65494](https://github.com/ClickHouse/ClickHouse/pull/65494) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- メトリック `KeeperOutstandingRequets` を `KeeperOutstandingRequests` に名称変更しました。[#66206](https://github.com/ClickHouse/ClickHouse/pull/66206) ([Robert Schulze](https://github.com/rschu1ze))。
- `system.functions` テーブルから `is_deterministic` フィールドを削除しました。[#66630](https://github.com/ClickHouse/ClickHouse/pull/66630) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 関数 `tuple` は、クエリ内で名前付きタプルの構築を試みるようになりました(`enable_named_columns_in_function_tuple` で制御)。タプルから名前を抽出する関数 `tupleNames` を導入しました。[#54881](https://github.com/ClickHouse/ClickHouse/pull/54881) ([Amos Bird](https://github.com/amosbird))。
- マテリアライズドビューの重複排除の動作を変更しました。以下のような多くのケースを修正しました: - 宛先テーブル: データが2つ以上のブロックに分割され、そのブロックが並列に挿入される際に重複とみなされる。- MV の宛先テーブル: 集約を実行することにより、MV が異なる入力データに対して同じデータを結果として生成することが多い場合、同一のブロックが重複排除される。- MV の宛先テーブル: 異なる MV から来た同一のブロックが重複排除される。[#61601](https://github.com/ClickHouse/ClickHouse/pull/61601) ([Sema Checherinda](https://github.com/CheSema))。
- 関数 `bitShiftLeft` と `bitShitfRight` は、範囲外のシフト位置に対してエラーを返すようになりました。[#65838](https://github.com/ClickHouse/ClickHouse/pull/65838) ([Pablo Marcos](https://github.com/pamarcos))。


#### 新機能 {#new-feature-5}

- `full_sorting_join`アルゴリズムに`ASOF JOIN`のサポートを追加しました。[#55051](https://github.com/ClickHouse/ClickHouse/pull/55051) ([vdimir](https://github.com/vdimir))。
- `clickhouse-client`でJWT認証をサポートしました(ClickHouse Cloudでのみ利用可能)。[#62829](https://github.com/ClickHouse/ClickHouse/pull/62829) ([Konstantin Bogdanov](https://github.com/thevar1able))。
- SQL関数`changeYear`、`changeMonth`、`changeDay`、`changeHour`、`changeMinute`、`changeSecond`を追加しました。例えば、`SELECT changeMonth(toDate('2024-06-14'), 7)`は日付`2024-07-14`を返します。[#63186](https://github.com/ClickHouse/ClickHouse/pull/63186) ([cucumber95](https://github.com/cucumber95))。
- 起動時に事前設定されたクエリを実行できる起動スクリプトを導入しました。[#64889](https://github.com/ClickHouse/ClickHouse/pull/64889) ([pufit](https://github.com/pufit))。
- クライアント設定で`accept_invalid_certificate`をサポートし、自己署名証明書で動作するサーバーにセキュアTCP経由でクライアントが接続できるようにしました。これは対応する`openSSL`クライアント設定`verificationMode=none` + `invalidCertificateHandler.name=AcceptCertificateHandler`の省略形として使用できます。[#65238](https://github.com/ClickHouse/ClickHouse/pull/65238) ([peacewalker122](https://github.com/peacewalker122))。
- `system.error_log`を追加しました。これは`system.errors`テーブルからのエラー値の履歴を含み、定期的にディスクにフラッシュされます。[#65381](https://github.com/ClickHouse/ClickHouse/pull/65381) ([Pablo Marcos](https://github.com/pamarcos))。
- 集約関数`groupConcat`を追加しました。`arrayStringConcat(groupArray(column), ',')`とほぼ同じです。2つのパラメータを受け取ることができます:文字列区切り文字と処理する要素数。[#65451](https://github.com/ClickHouse/ClickHouse/pull/65451) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- AzureQueueストレージを追加しました。[#65458](https://github.com/ClickHouse/ClickHouse/pull/65458) ([Kseniia Sumarokova](https://github.com/kssenii))。
- Parquetファイルへのページインデックスの書き込みを無効化/有効化する新しい設定を追加しました。[#65475](https://github.com/ClickHouse/ClickHouse/pull/65475) ([lgbo](https://github.com/lgbo-ustc))。
- コンソールへのログレベルを制御する(有効な場合)ための`logger.console_log_level`サーバー設定を導入しました。[#65559](https://github.com/ClickHouse/ClickHouse/pull/65559) ([Azat Khuzhin](https://github.com/azat))。
- テーブル関数`file`でディレクトリパスの末尾にワイルドカード`*`を自動的に追加するようにしました。[#66019](https://github.com/ClickHouse/ClickHouse/pull/66019) ([Zhidong (David) Guo](https://github.com/Gun9niR))。
- 非対話モードのクライアントに`--memory-usage`オプションを追加しました。[#66393](https://github.com/ClickHouse/ClickHouse/pull/66393) ([vdimir](https://github.com/vdimir))。
- clickhouse-disks用の対話型クライアントを作成し、ローカルディレクトリからローカルディスクを追加できるようにしました。[#64446](https://github.com/ClickHouse/ClickHouse/pull/64446) ([Daniil Ivanik](https://github.com/divanik))。
- プロジェクションを持つテーブルで軽量削除が発生した場合、ユーザーは例外をスローする(デフォルト)かプロジェクションを削除するかを選択できます。[#65594](https://github.com/ClickHouse/ClickHouse/pull/65594) ([jsc0218](https://github.com/jsc0218))。
- すべてのデタッチされたテーブルに関する主要情報を含むシステムテーブルを追加しました。[#65400](https://github.com/ClickHouse/ClickHouse/pull/65400) ([Konstantin Morozov](https://github.com/k-morozov))。


#### 実験的機能 {#experimental-feature-4}

- `Variant`データ型のバイナリシリアライゼーションを変更:単一バリアントまたはNULL値のみを含むグラニュールに対して同じ判別子を複数回書き込むことを回避するため、`compact`モードを追加しました。デフォルトで有効化されるMergeTree設定`use_compact_variant_discriminators_serialization`を追加しました。Variant型は依然として実験的であり、シリアライゼーションにおける後方互換性のない変更は許容されます。[#62774](https://github.com/ClickHouse/ClickHouse/pull/62774) ([Kruglov Pavel](https://github.com/Avogar))。
- clickhouse-keeperのディスク上バックエンドストレージをサポートしました。[#56626](https://github.com/ClickHouse/ClickHouse/pull/56626) ([Han Fei](https://github.com/hanfei1991))。
- JSONExtract関数をリファクタリングし、実験的なDynamic型を含むより多くの型をサポートしました。[#66046](https://github.com/ClickHouse/ClickHouse/pull/66046) ([Kruglov Pavel](https://github.com/Avogar))。
- `Variant`および`Dynamic`サブカラムに対してnullマップサブカラムをサポートしました。[#66178](https://github.com/ClickHouse/ClickHouse/pull/66178) ([Kruglov Pavel](https://github.com/Avogar))。
- 変更された`Memory`テーブルからの`Dynamic`サブカラムの読み取りを修正しました。以前は、alterによってMemoryテーブル内のDynamic型の`max_types`パラメータが変更された場合、その後のサブカラムの読み取りで誤った結果が返される可能性がありました。[#66066](https://github.com/ClickHouse/ClickHouse/pull/66066) ([Kruglov Pavel](https://github.com/Avogar))。
- カスタムキー並列レプリカを使用する際の`cluster_for_parallel_replicas`のサポートを追加しました。これにより、MergeTreeテーブルでカスタムキーを使用した並列レプリカを利用できるようになります。[#65453](https://github.com/ClickHouse/ClickHouse/pull/65453) ([Antonio Andelic](https://github.com/antonio2368))。


#### パフォーマンス改善 {#performance-improvement-5}

- 整数から文字列への変換アルゴリズムをより高速なものに置き換えました（修正版amdn/itoaから修正版jeaiii/itoaへ）。[#61661](https://github.com/ClickHouse/ClickHouse/pull/61661) ([Raúl Marín](https://github.com/Algunenano))。
- 結合（`parallel_hash`アルゴリズム）によって作成されるハッシュテーブルのサイズが収集およびキャッシュされるようになりました。この情報は、後続のクエリ実行時にハッシュテーブルの領域を事前割り当てし、ハッシュテーブルのリサイズにかかる時間を削減するために使用されます。[#64553](https://github.com/ClickHouse/ClickHouse/pull/64553) ([Nikita Taranov](https://github.com/nickitat))。
- バッファリングを使用することで、プライマリキーによる`ORDER BY`と高い選択性を持つ条件を含む`WHERE`句を持つクエリを最適化しました。これは設定`read_in_order_use_buffering`（デフォルトで有効）によって制御され、クエリのメモリ使用量が増加する可能性があります。[#64607](https://github.com/ClickHouse/ClickHouse/pull/64607) ([Anton Popov](https://github.com/CurtizJ))。
- `plain_rewritable`メタデータの読み込みパフォーマンスを改善しました。[#65634](https://github.com/ClickHouse/ClickHouse/pull/65634) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 読み取り専用ディスク上のテーブルのアタッチ時に、古いパートを読み込まないことでリソース使用量を削減しました。[#65635](https://github.com/ClickHouse/ClickHouse/pull/65635) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- Setインデックスに対するminmax超直方体をサポートしました。[#65676](https://github.com/ClickHouse/ClickHouse/pull/65676) ([AntiTopQuark](https://github.com/AntiTopQuark))。
- 古いパートのプライマリインデックスをアンロードして、総メモリ使用量を削減しました。[#65852](https://github.com/ClickHouse/ClickHouse/pull/65852) ([Anton Popov](https://github.com/CurtizJ))。
- 関数`replaceRegexpAll`と`replaceRegexpOne`は、パターンが単純な場合、つまりメタ文字、パターンクラス、フラグ、グループ化文字などを含まない場合に大幅に高速化されました（Taiyang Li氏に感謝）。[#66185](https://github.com/ClickHouse/ClickHouse/pull/66185) ([Robert Schulze](https://github.com/rschu1ze))。
- s3リクエスト：クエリのリトライ時間を短縮し、バックアップのリトライ回数を増加しました。クエリは8.5分で100回のリトライ、バックアップ復元は1.2時間で1000回のリトライとなります。[#65232](https://github.com/ClickHouse/ClickHouse/pull/65232) ([Sema Checherinda](https://github.com/CheSema))。
- クエリプランのLIMIT最適化をサポートしました。PostgreSQLストレージおよびテーブル関数に対するLIMITプッシュダウンをサポートしました。[#65454](https://github.com/ClickHouse/ClickHouse/pull/65454) ([Maksim Kita](https://github.com/kitaisreal))。
- ZooKeeperの負荷分散を改善しました。`fallback_session_lifetime`にかかわらず、最適なノードが利用可能になるまで現在のセッションは期限切れになりません。AZ対応の負荷分散のサポートを追加しました。[#65570](https://github.com/ClickHouse/ClickHouse/pull/65570) ([Alexander Tokmakov](https://github.com/tavplubix))。
- DatabaseCatalogは、最大database_catalog_drop_table_concurrency個のスレッドを使用することで、テーブルをより高速に削除します。[#66065](https://github.com/ClickHouse/ClickHouse/pull/66065) ([Sema Checherinda](https://github.com/CheSema))。


#### 改善 {#improvement-5}

- Improved ZooKeeper load balancing. The current session doesn't expire until the optimal nodes become available despite `fallback_session_lifetime`. Added support for AZ-aware balancing. [#65570](https://github.com/ClickHouse/ClickHouse/pull/65570) ([Alexander Tokmakov](https://github.com/tavplubix)).
- The setting `optimize_trivial_insert_select` is disabled by default. In most cases, it should be beneficial. Nevertheless, if you are seeing slower INSERT SELECT or increased memory usage, you can enable it back or `SET compatibility = '24.6'`. [#58970](https://github.com/ClickHouse/ClickHouse/pull/58970) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Print stacktrace and diagnostic info if `clickhouse-client` or `clickhouse-local` crashes. [#61109](https://github.com/ClickHouse/ClickHouse/pull/61109) ([Alexander Tokmakov](https://github.com/tavplubix)).
- The result of `SHOW INDEX | INDEXES | INDICES | KEYS` was previously sorted by the primary key column names. Since this was unintuitive, the result is now sorted by the position of the primary key columns within the primary key. [#61131](https://github.com/ClickHouse/ClickHouse/pull/61131) ([Robert Schulze](https://github.com/rschu1ze)).
- Change how deduplication for Materialized Views works. Fixed a lot of cases like: - on destination table: data is split for 2 or more blocks and that blocks is considered as duplicate when that block is inserted in parallel. - on MV destination table: the equal blocks are deduplicated, that happens when MV often produces equal data as a result for different input data due to performing aggregation. - on MV destination table: the equal blocks which comes from different MV are deduplicated. [#61601](https://github.com/ClickHouse/ClickHouse/pull/61601) ([Sema Checherinda](https://github.com/CheSema)).
- Support reading partitioned data DeltaLake data. Infer DeltaLake schema by reading metadata instead of data. [#63201](https://github.com/ClickHouse/ClickHouse/pull/63201) ([Kseniia Sumarokova](https://github.com/kssenii)).
- In composable protocols TLS layer accepted only `certificateFile` and `privateKeyFile` parameters. https://clickhouse.com/docs/operations/settings/composable-protocols. [#63985](https://github.com/ClickHouse/ClickHouse/pull/63985) ([Anton Ivashkin](https://github.com/ianton-ru)).
- Added profile event `SelectQueriesWithPrimaryKeyUsage` which indicates how many SELECT queries use the primary key to evaluate the WHERE clause. [#64492](https://github.com/ClickHouse/ClickHouse/pull/64492) ([0x01f](https://github.com/0xfei)).
- `StorageS3Queue` related fixes and improvements. Deduce a default value of `s3queue_processing_threads_num` according to the number of physical cpu cores on the server (instead of the previous default value as 1). Set default value of `s3queue_loading_retries` to 10. Fix possible vague "Uncaught exception" in exception column of `system.s3queue`. Do not increment retry count on `MEMORY_LIMIT_EXCEEDED` exception. Move files commit to a stage after insertion into table fully finished to avoid files being commited while not inserted. Add settings `s3queue_max_processed_files_before_commit`, `s3queue_max_processed_rows_before_commit`, `s3queue_max_processed_bytes_before_commit`, `s3queue_max_processing_time_sec_before_commit`, to better control commit and flush time. [#65046](https://github.com/ClickHouse/ClickHouse/pull/65046) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Support aliases in parametrized view function (only new analyzer). [#65190](https://github.com/ClickHouse/ClickHouse/pull/65190) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Updated to mask account key in logs in azureBlobStorage. [#65273](https://github.com/ClickHouse/ClickHouse/pull/65273) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Partition pruning for `IN` predicates when filter expression is a part of `PARTITION BY` expression. [#65335](https://github.com/ClickHouse/ClickHouse/pull/65335) ([Eduard Karacharov](https://github.com/korowa)).
- `arrayMin`/`arrayMax` can be applicable to all data types that are comparable. [#65455](https://github.com/ClickHouse/ClickHouse/pull/65455) ([pn](https://github.com/chloro-pn)).
- Improved memory accounting for cgroups v2 to exclude the amount occupied by the page cache. [#65470](https://github.com/ClickHouse/ClickHouse/pull/65470) ([Nikita Taranov](https://github.com/nickitat)).
- Do not create format settings for each row when serializing chunks to insert to EmbeddedRocksDB table. [#65474](https://github.com/ClickHouse/ClickHouse/pull/65474) ([Duc Canh Le](https://github.com/canhld94)).
- Reduce `clickhouse-local` prompt to just `:)`. `getFQDNOrHostName()` takes too long on macOS, and we don't want a hostname in the prompt for `clickhouse-local` anyway. [#65510](https://github.com/ClickHouse/ClickHouse/pull/65510) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Avoid printing a message from jemalloc about per-CPU arenas on low-end virtual machines. [#65532](https://github.com/ClickHouse/ClickHouse/pull/65532) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Disable filesystem cache background download by default. It will be enabled back when we fix the issue with possible "Memory limit exceeded" because memory deallocation is done outside of query context (while buffer is allocated inside of query context) if we use background download threads. Plus we need to add a separate setting to define max size to download for background workers (currently it is limited by max_file_segment_size, which might be too big). [#65534](https://github.com/ClickHouse/ClickHouse/pull/65534) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Add new option to config `<config_reload_interval_ms>` which allow to specify how often clickhouse will reload config. [#65545](https://github.com/ClickHouse/ClickHouse/pull/65545) ([alesapin](https://github.com/alesapin)).
- Implement binary encoding for ClickHouse data types and add its specification in docs. Use it in Dynamic binary serialization, allow to use it in RowBinaryWithNamesAndTypes and Native formats under settings. [#65546](https://github.com/ClickHouse/ClickHouse/pull/65546) ([Kruglov Pavel](https://github.com/Avogar)).
- Server settings `compiled_expression_cache_size` and `compiled_expression_cache_elements_size` are now shown in `system.server_settings`. [#65584](https://github.com/ClickHouse/ClickHouse/pull/65584) ([Robert Schulze](https://github.com/rschu1ze)).
- Add support for user identification based on x509 SubjectAltName extension. [#65626](https://github.com/ClickHouse/ClickHouse/pull/65626) ([Anton Kozlov](https://github.com/tonickkozlov)).
- `clickhouse-local` will respect the `max_server_memory_usage` and `max_server_memory_usage_to_ram_ratio` from the configuration file. It will also set the max memory usage to 90% of the system memory by default, like `clickhouse-server` does. [#65697](https://github.com/ClickHouse/ClickHouse/pull/65697) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Add a script to backup your files to ClickHouse. [#65699](https://github.com/ClickHouse/ClickHouse/pull/65699) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- PostgreSQL source to support query cancellations. [#65722](https://github.com/ClickHouse/ClickHouse/pull/65722) ([Maksim Kita](https://github.com/kitaisreal)).
- Make `allow_experimental_analyzer` be controlled by the initiator for distributed queries. This ensures compatibility and correctness during operations in mixed version clusters. [#65777](https://github.com/ClickHouse/ClickHouse/pull/65777) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Respect cgroup CPU limit in Keeper. [#65819](https://github.com/ClickHouse/ClickHouse/pull/65819) ([Antonio Andelic](https://github.com/antonio2368)).
- Allow to use `concat` function with empty arguments `:) select concat();`. [#65887](https://github.com/ClickHouse/ClickHouse/pull/65887) ([李扬](https://github.com/taiyang-li)).
- Allow controlling named collections in `clickhouse-local`. [#65973](https://github.com/ClickHouse/ClickHouse/pull/65973) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Improve Azure-related profile events. [#65999](https://github.com/ClickHouse/ClickHouse/pull/65999) ([alesapin](https://github.com/alesapin)).
- Support ORC file read by writer's time zone. [#66025](https://github.com/ClickHouse/ClickHouse/pull/66025) ([kevinyhzou](https://github.com/KevinyhZou)).
- Add settings to control connections to PostgreSQL. The setting `postgresql_connection_attempt_timeout` specifies the value passed to `connect_timeout` parameter of connection URL. The setting `postgresql_connection_pool_retries` specifies the number of retries to establish a connection to the PostgreSQL end-point. [#66232](https://github.com/ClickHouse/ClickHouse/pull/66232) ([Dmitry Novik](https://github.com/novikd)).
- Reduce inaccuracy of `input_wait_elapsed_us`/`elapsed_us` in the `system.processors_profile_log`. [#66239](https://github.com/ClickHouse/ClickHouse/pull/66239) ([Azat Khuzhin](https://github.com/azat)).
- Improve ProfileEvents for the filesystem cache. [#66249](https://github.com/ClickHouse/ClickHouse/pull/66249) ([zhukai](https://github.com/nauu)).
- Add settings to ignore the `ON CLUSTER` clause in queries for named collection management with the replicated storage. [#66288](https://github.com/ClickHouse/ClickHouse/pull/66288) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
- Function `generateSnowflakeID` now allows to specify a machine ID as a parameter to prevent collisions in large clusters. [#66374](https://github.com/ClickHouse/ClickHouse/pull/66374) ([ZAWA_ll](https://github.com/Zawa-ll)).
- Disable suspending on `Ctrl+Z` in interactive mode. This is a common trap and is not expected behavior for almost all users. I imagine only a few extreme power users could appreciate suspending terminal applications to the background, but I don't know any. [#66511](https://github.com/ClickHouse/ClickHouse/pull/66511) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Add option for validating the primary key type in Dictionaries. Without this option for simple layouts any column type will be implicitly converted to UInt64. [#66595](https://github.com/ClickHouse/ClickHouse/pull/66595) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).





#### バグ修正（公式安定版リリースにおけるユーザーに見える不具合） {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-4}

- Check cyclic dependencies on CREATE/REPLACE/RENAME/EXCHANGE queries and throw an exception if there is a cyclic dependency. Previously such cyclic dependencies could lead to a deadlock during server startup. Also fix some bugs in dependencies creation. [#65405](https://github.com/ClickHouse/ClickHouse/pull/65405) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix unexpected sizes of `LowCardinality` columns in function calls. [#65298](https://github.com/ClickHouse/ClickHouse/pull/65298) ([Raúl Marín](https://github.com/Algunenano)).
- Fix crash in maxIntersections. [#65689](https://github.com/ClickHouse/ClickHouse/pull/65689) ([Raúl Marín](https://github.com/Algunenano)).
- Fix the `VALID UNTIL` clause in the user definition resetting after a restart. [#66409](https://github.com/ClickHouse/ClickHouse/pull/66409) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix the remaining time column in `SHOW MERGES`. [#66735](https://github.com/ClickHouse/ClickHouse/pull/66735) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- `Query was cancelled` might have been printed twice in clickhouse-client. This behaviour is fixed. [#66005](https://github.com/ClickHouse/ClickHouse/pull/66005) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Fixed crash while using `MaterializedMySQL` (which is an unsupported, experimental feature) with TABLE OVERRIDE that maps MySQL NULL field into ClickHouse not NULL field. [#54649](https://github.com/ClickHouse/ClickHouse/pull/54649) ([Filipp Ozinov](https://github.com/bakwc)).
- Fix logical error when `PREWHERE` expression read no columns and table has no adaptive index granularity (very old table). [#59173](https://github.com/ClickHouse/ClickHouse/pull/59173) ([Alexander Gololobov](https://github.com/davenger)).
- Fix bug with the cancellation buffer when canceling a query. [#64478](https://github.com/ClickHouse/ClickHouse/pull/64478) ([Sema Checherinda](https://github.com/CheSema)).
- Fix filling parts columns from metadata (when columns.txt does not exists). [#64757](https://github.com/ClickHouse/ClickHouse/pull/64757) ([Azat Khuzhin](https://github.com/azat)).
- Fix crash for `ALTER TABLE ... ON CLUSTER ... MODIFY SQL SECURITY`. [#64957](https://github.com/ClickHouse/ClickHouse/pull/64957) ([pufit](https://github.com/pufit)).
- Fix crash on destroying AccessControl: add explicit shutdown. [#64993](https://github.com/ClickHouse/ClickHouse/pull/64993) ([Vitaly Baranov](https://github.com/vitlibar)).
- Eliminate injective function in argument of functions `uniq*` recursively. This used to work correctly but was broken in the new analyzer. [#65140](https://github.com/ClickHouse/ClickHouse/pull/65140) ([Duc Canh Le](https://github.com/canhld94)).
- Fix unexpected projection name when query with CTE. [#65267](https://github.com/ClickHouse/ClickHouse/pull/65267) ([wudidapaopao](https://github.com/wudidapaopao)).
- Require `dictGet` privilege when accessing dictionaries via direct query or the `Dictionary` table engine. [#65359](https://github.com/ClickHouse/ClickHouse/pull/65359) ([Joe Lynch](https://github.com/joelynch)).
- Fix user-specific S3 auth with incremental backups. [#65481](https://github.com/ClickHouse/ClickHouse/pull/65481) ([Antonio Andelic](https://github.com/antonio2368)).
- Disable `non-intersecting-parts` optimization for queries with `FINAL` in case of `read-in-order` optimization was enabled. This could lead to an incorrect query result. As a workaround, disable `do_not_merge_across_partitions_select_final` and `split_parts_ranges_into_intersecting_and_non_intersecting_final` before this fix is merged. [#65505](https://github.com/ClickHouse/ClickHouse/pull/65505) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix getting exception `Index out of bound for blob metadata` in case all files from list batch were filtered out. [#65523](https://github.com/ClickHouse/ClickHouse/pull/65523) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix NOT_FOUND_COLUMN_IN_BLOCK for deduplicate merge of projection. [#65573](https://github.com/ClickHouse/ClickHouse/pull/65573) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fixed bug in MergeJoin. Column in sparse serialisation might be treated as a column of its nested type though the required conversion wasn't performed. [#65632](https://github.com/ClickHouse/ClickHouse/pull/65632) ([Nikita Taranov](https://github.com/nickitat)).
- Fixed a bug that compatibility level '23.4' was not properly applied. [#65737](https://github.com/ClickHouse/ClickHouse/pull/65737) ([cw5121](https://github.com/cw5121)).
- Fix odbc table with nullable fields. [#65738](https://github.com/ClickHouse/ClickHouse/pull/65738) ([Rodolphe Dugé de Bernonville](https://github.com/RodolpheDuge)).
- Fix data race in `TCPHandler`, which could happen on fatal error. [#65744](https://github.com/ClickHouse/ClickHouse/pull/65744) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix invalid exceptions in function `parseDateTime` with `%F` and `%D` placeholders. [#65768](https://github.com/ClickHouse/ClickHouse/pull/65768) ([Antonio Andelic](https://github.com/antonio2368)).
- For queries that read from `PostgreSQL`, cancel the internal `PostgreSQL` query if the ClickHouse query is finished. Otherwise, `ClickHouse` query cannot be canceled until the internal `PostgreSQL` query is finished. [#65771](https://github.com/ClickHouse/ClickHouse/pull/65771) ([Maksim Kita](https://github.com/kitaisreal)).
- Fix a bug in short circuit logic when old analyzer and dictGetOrDefault is used. [#65802](https://github.com/ClickHouse/ClickHouse/pull/65802) ([jsc0218](https://github.com/jsc0218)).
- Fix a bug leads to EmbeddedRocksDB with TTL write corrupted SST files. [#65816](https://github.com/ClickHouse/ClickHouse/pull/65816) ([Duc Canh Le](https://github.com/canhld94)).
- Functions `bitTest`, `bitTestAll`, and `bitTestAny` now return an error if the specified bit index is out-of-bounds [#65818](https://github.com/ClickHouse/ClickHouse/pull/65818) ([Pablo Marcos](https://github.com/pamarcos)).
- Setting `join_any_take_last_row` is supported in any query with hash join. [#65820](https://github.com/ClickHouse/ClickHouse/pull/65820) ([vdimir](https://github.com/vdimir)).
- Better handling of join conditions involving `IS NULL` checks (for example `ON (a = b AND (a IS NOT NULL) AND (b IS NOT NULL) ) OR ( (a IS NULL) AND (b IS NULL) )` is rewritten to `ON a <=> b`), fix incorrect optimization when condition other then `IS NULL` are present. [#65835](https://github.com/ClickHouse/ClickHouse/pull/65835) ([vdimir](https://github.com/vdimir)).
- Fix growing memory usage in S3Queue. [#65839](https://github.com/ClickHouse/ClickHouse/pull/65839) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix tie handling in `arrayAUC` to match sklearn. [#65840](https://github.com/ClickHouse/ClickHouse/pull/65840) ([gabrielmcg44](https://github.com/gabrielmcg44)).
- Fix possible issues with MySQL server protocol TLS connections. [#65917](https://github.com/ClickHouse/ClickHouse/pull/65917) ([Azat Khuzhin](https://github.com/azat)).
- Fix possible issues with MySQL client protocol TLS connections. [#65938](https://github.com/ClickHouse/ClickHouse/pull/65938) ([Azat Khuzhin](https://github.com/azat)).
- Fix handling of `SSL_ERROR_WANT_READ`/`SSL_ERROR_WANT_WRITE` with zero timeout. [#65941](https://github.com/ClickHouse/ClickHouse/pull/65941) ([Azat Khuzhin](https://github.com/azat)).
- Add missing settings `input_format_csv_skip_first_lines/input_format_tsv_skip_first_lines/input_format_csv_try_infer_numbers_from_strings/input_format_csv_try_infer_strings_from_quoted_tuples` in schema inference cache because they can change the resulting schema. It prevents from incorrect result of schema inference with these settings changed. [#65980](https://github.com/ClickHouse/ClickHouse/pull/65980) ([Kruglov Pavel](https://github.com/Avogar)).
- Column \_size in s3 engine and s3 table function denotes the size of a file inside the archive, not a size of the archive itself. [#65993](https://github.com/ClickHouse/ClickHouse/pull/65993) ([Daniil Ivanik](https://github.com/divanik)).
- Fix resolving dynamic subcolumns in analyzer, avoid reading the whole column on dynamic subcolumn reading. [#66004](https://github.com/ClickHouse/ClickHouse/pull/66004) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix config merging for from_env with replace overrides. [#66034](https://github.com/ClickHouse/ClickHouse/pull/66034) ([Azat Khuzhin](https://github.com/azat)).
- Fix a possible hanging in `GRPCServer` during shutdown. [#66061](https://github.com/ClickHouse/ClickHouse/pull/66061) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fixed several cases in function `has` with non-constant `LowCardinality` arguments. [#66088](https://github.com/ClickHouse/ClickHouse/pull/66088) ([Anton Popov](https://github.com/CurtizJ)).
- Fix for `groupArrayIntersect`. It had incorrect behavior in the `merge()` function. Also, fixed behavior in `deserialise()` for numeric and general data. [#66103](https://github.com/ClickHouse/ClickHouse/pull/66103) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fixed buffer overflow bug in `unbin`/`unhex` implementation. [#66106](https://github.com/ClickHouse/ClickHouse/pull/66106) ([Nikita Taranov](https://github.com/nickitat)).
- Disable the `merge-filters` optimization introduced in [#64760](https://github.com/ClickHouse/ClickHouse/issues/64760). It may cause an exception if optimization merges two filter expressions and does not apply a short-circuit evaluation. [#66126](https://github.com/ClickHouse/ClickHouse/pull/66126) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fixed the issue when the server failed to parse Avro files with negative block size arrays encoded, which is now allowed by the Avro specification. [#66130](https://github.com/ClickHouse/ClickHouse/pull/66130) ([Serge Klochkov](https://github.com/slvrtrn)).
- Fixed a bug in ZooKeeper client: a session could get stuck in unusable state after receiving a hardware error from ZooKeeper. For example, this might happen due to "soft memory limit" in ClickHouse Keeper. [#66140](https://github.com/ClickHouse/ClickHouse/pull/66140) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix issue in SumIfToCountIfVisitor and signed integers. [#66146](https://github.com/ClickHouse/ClickHouse/pull/66146) ([Raúl Marín](https://github.com/Algunenano)).
- Fix rare case with missing data in the result of distributed query. [#66174](https://github.com/ClickHouse/ClickHouse/pull/66174) ([vdimir](https://github.com/vdimir)).
- Fix order of parsing metadata fields in StorageDeltaLake. [#66211](https://github.com/ClickHouse/ClickHouse/pull/66211) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Don't throw `TIMEOUT_EXCEEDED` for `none_only_active` mode of `distributed_ddl_output_mode`. [#66218](https://github.com/ClickHouse/ClickHouse/pull/66218) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix handling limit for `system.numbers_mt` when no index can be used. [#66231](https://github.com/ClickHouse/ClickHouse/pull/66231) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fixed how the ClickHouse server detects the maximum number of usable CPU cores as specified by cgroups v2 if the server runs in a container such as Docker. In more detail, containers often run their process in the root cgroup which has an empty name. In that case, ClickHouse ignored the CPU limits set by cgroups v2. [#66237](https://github.com/ClickHouse/ClickHouse/pull/66237) ([filimonov](https://github.com/filimonov)).
- Fix the `Not-ready set` error when a subquery with `IN` is used in the constraint. [#66261](https://github.com/ClickHouse/ClickHouse/pull/66261) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix error reporting while copying to S3 or AzureBlobStorage. [#66295](https://github.com/ClickHouse/ClickHouse/pull/66295) ([Vitaly Baranov](https://github.com/vitlibar)).
- Prevent watchdog from keeping descriptors of unlinked (rotated) log files. [#66334](https://github.com/ClickHouse/ClickHouse/pull/66334) ([Aleksei Filatov](https://github.com/aalexfvk)).
- Fix the bug that logicalexpressionoptimizerpass lost logical type of constant. [#66344](https://github.com/ClickHouse/ClickHouse/pull/66344) ([pn](https://github.com/chloro-pn)).
- Fix `Column identifier is already registered` error with `group_by_use_nulls=true` and new analyzer. [#66400](https://github.com/ClickHouse/ClickHouse/pull/66400) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix possible incorrect result for queries joining and filtering table external engine (like PostgreSQL), due to too aggressive filter pushdown. Since now, conditions from where section won't be send to external database in case of outer join with external table. [#66402](https://github.com/ClickHouse/ClickHouse/pull/66402) ([vdimir](https://github.com/vdimir)).
- Added missing column materialization for cross join. [#66413](https://github.com/ClickHouse/ClickHouse/pull/66413) ([lgbo](https://github.com/lgbo-ustc)).
- Fix `Cannot find column` error for queries with constant expression in `GROUP BY` key and new analyzer enabled. [#66433](https://github.com/ClickHouse/ClickHouse/pull/66433) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Avoid possible logical error during import from Npy format in case of bad array nesting level, fix testing of other kinds of errors. [#66461](https://github.com/ClickHouse/ClickHouse/pull/66461) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fix wrong count() result when there is non-deterministic function in predicate. [#66510](https://github.com/ClickHouse/ClickHouse/pull/66510) ([Duc Canh Le](https://github.com/canhld94)).
- Correctly track memory for `Allocator::realloc`. [#66548](https://github.com/ClickHouse/ClickHouse/pull/66548) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix reading of uninitialized memory when hashing empty tuples. [#66562](https://github.com/ClickHouse/ClickHouse/pull/66562) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix an invalid result for queries with `WINDOW`. This could happen when `PARTITION` columns have sparse serialization and window functions are executed in parallel. [#66579](https://github.com/ClickHouse/ClickHouse/pull/66579) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix removing named collections in local storage. [#66599](https://github.com/ClickHouse/ClickHouse/pull/66599) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fix `column_length` is not updated in `ColumnTuple::insertManyFrom`. [#66626](https://github.com/ClickHouse/ClickHouse/pull/66626) ([lgbo](https://github.com/lgbo-ustc)).
- Fix `Unknown identifier` and `Column is not under aggregate function` errors for queries with the expression `(column IS NULL).` The bug was triggered by [#65088](https://github.com/ClickHouse/ClickHouse/issues/65088), with the disabled analyzer only. [#66654](https://github.com/ClickHouse/ClickHouse/pull/66654) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix `Method getResultType is not supported for QUERY query node` error when scalar subquery was used as the first argument of IN (with new analyzer). [#66655](https://github.com/ClickHouse/ClickHouse/pull/66655) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix possible PARAMETER_OUT_OF_BOUND error during reading variant subcolumn. [#66659](https://github.com/ClickHouse/ClickHouse/pull/66659) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix rare case of stuck merge after drop column. [#66707](https://github.com/ClickHouse/ClickHouse/pull/66707) ([Raúl Marín](https://github.com/Algunenano)).
- Fix assertion `isUniqTypes` when insert select from remote sources. [#66722](https://github.com/ClickHouse/ClickHouse/pull/66722) ([Sema Checherinda](https://github.com/CheSema)).
- Fix logical error in PrometheusRequestHandler. [#66621](https://github.com/ClickHouse/ClickHouse/pull/66621) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix `indexHint` function case found by fuzzer. [#66286](https://github.com/ClickHouse/ClickHouse/pull/66286) ([Anton Popov](https://github.com/CurtizJ)).
- Fix AST formatting of 'create table b empty as a'. [#64951](https://github.com/ClickHouse/ClickHouse/pull/64951) ([Michael Kolupaev](https://github.com/al13n321)).

### <a id="246"></a> ClickHouse リリース 24.6, 2024-07-01 {#a-id246a-clickhouse-release-246-2024-07-01}

#### 後方互換性のない変更 {#backward-incompatible-change-6}

- データベースとテーブルの非同期ロードをデフォルトで有効化しました。config.xml の `async_load_databases` を参照してください。この変更は完全に互換性がありますが、動作に違いが生じる可能性があります。以前のバージョンのように `async_load_databases` が false の場合、サーバーはすべてのテーブルがロードされるまで接続を受け付けません。新しいバージョンのように `async_load_databases` が true の場合、サーバーはすべてのテーブルがロードされる前に接続を受け付けることができます。まだロードされていないテーブルに対してクエリが実行されると、テーブルのロードを待機しますが、これにはかなりの時間がかかる場合があります。ロードバランサー配下の大規模な分散システムの一部である場合、サーバーの動作が変わる可能性があります。前者のケースでは、ロードバランサーは接続拒否を受け取り、すぐに別のサーバーにフェイルオーバーできます。後者のケースでは、ロードバランサーはまだテーブルをロードしているサーバーに接続でき、クエリのレイテンシが高くなります。さらに、多くのクエリが待機状態で蓄積されると、それらが同時に処理を開始する際に「サンダリングハード」問題を引き起こす可能性があります。これは、高負荷の分散バックエンドでのみ影響があります。この問題を回避するには、`async_load_databases` の値を false に設定できます。[#57695](https://github.com/ClickHouse/ClickHouse/pull/57695) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `MergeTree` テーブルに対して設定 `replace_long_file_name_to_hash` がデフォルトで有効化されました。[#64457](https://github.com/ClickHouse/ClickHouse/pull/64457) ([Anton Popov](https://github.com/CurtizJ))。この設定は完全に互換性があり、アップグレード時にアクションは不要です。新しいデータ形式は 23.9 以降のすべてのバージョンでサポートされています。この設定を有効にした後は、バージョン 23.8 以前にダウングレードすることはできません。
- 一部の無効なクエリは、解析中により早く失敗するようになります。注意: 文字列リテラルなしで `kql` テーブル関数に配置された場合のインライン KQL 式(実験的な Kusto 言語)のサポートを無効化しました。例えば、`kql('garbage | trash')` や `kql($$garbage | trash$$)` ではなく `kql(garbage | trash)` のような場合です。この機能は意図せず導入されたものであり、存在すべきではありません。[#61500](https://github.com/ClickHouse/ClickHouse/pull/61500) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- ストレージ `S3Queue` の `Ordered` モードにおける並列処理を再設計しました。設定 `s3queue_processing_threads_num` または `s3queue_total_shards_num` を使用していた場合、この PR は Ordered モードに対して後方互換性がありません。設定 `s3queue_total_shards_num` は削除されました。以前は `s3queue_allow_experimental_sharded_mode` 配下でのみ使用が許可されていましたが、これは現在非推奨です。新しい設定 `s3queue_buckets` が追加されました。[#64349](https://github.com/ClickHouse/ClickHouse/pull/64349) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 新しい関数 `snowflakeIDToDateTime`、`snowflakeIDToDateTime64`、`dateTimeToSnowflakeID`、および `dateTime64ToSnowflakeID` が追加されました。既存の関数 `snowflakeToDateTime`、`snowflakeToDateTime64`、`dateTimeToSnowflake`、および `dateTime64ToSnowflake` とは異なり、新しい関数は関数 `generateSnowflakeID` と互換性があります。つまり、`generateSnowflakeID` によって生成された snowflake ID を受け入れ、`generateSnowflakeID` と同じ型(すなわち `UInt64`)の snowflake ID を生成します。さらに、新しい関数は `generateSnowflakeID` と同様に、デフォルトで UNIX エポック(すなわち 1970-01-01)を使用します。必要に応じて、異なるエポック、例えば Twitter/X のエポック 2010-11-04(すなわち UNIX エポックから 1288834974657 ミリ秒)を渡すことができます。古い変換関数は非推奨であり、移行期間後に削除されます。それでも使用する場合は、設定 `allow_deprecated_snowflake_conversion_functions` を有効にしてください。[#64948](https://github.com/ClickHouse/ClickHouse/pull/64948) ([Robert Schulze](https://github.com/rschu1ze))。


#### 新機能 {#new-feature-6}

- ClickHouse Keeperに名前付きコレクションを保存できるようになりました。[#64574](https://github.com/ClickHouse/ClickHouse/pull/64574) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 空のタプルをサポートしました。[#55061](https://github.com/ClickHouse/ClickHouse/pull/55061) ([Amos Bird](https://github.com/amosbird))。
- ヒルベルト曲線のエンコードおよびデコード関数を追加しました。[#60156](https://github.com/ClickHouse/ClickHouse/pull/60156) ([Artem Mustafin](https://github.com/Artemmm91))。
- `hilbertEncode`に対するインデックス解析のサポートを追加しました。[#64662](https://github.com/ClickHouse/ClickHouse/pull/64662) ([Artem Mustafin](https://github.com/Artemmm91))。
- 関数`readWKTLineString`を使用してWKT形式の`LINESTRING`ジオメトリを読み取るサポートを追加しました。[#62519](https://github.com/ClickHouse/ClickHouse/pull/62519) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 異なるディスクからパーツをアタッチできるようになりました。[#63087](https://github.com/ClickHouse/ClickHouse/pull/63087) ([Unalian](https://github.com/Unalian))。
- Twitter形式のSnowflake IDを生成するための新しいSQL関数`generateSnowflakeID`を追加しました。[#63577](https://github.com/ClickHouse/ClickHouse/pull/63577) ([Danila Puzov](https://github.com/kazalika))。
- マージ、ミューテーション、その他のワークロード間でリソースの利用と共有を制御するための`merge_workload`および`mutation_workload`設定を追加しました。[#64061](https://github.com/ClickHouse/ClickHouse/pull/64061) ([Sergei Trifonov](https://github.com/serxa))。
- `=`演算子を使用した`IPv4`型と`IPv6`型の比較のサポートを追加しました。[#64292](https://github.com/ClickHouse/ClickHouse/pull/64292) ([Francisco J. Jurado Moreno](https://github.com/Beetelbrox))。
- 二項数学関数(pow、atan2、max2、min2、hypot)で10進数引数をサポートしました。[#64582](https://github.com/ClickHouse/ClickHouse/pull/64582) ([Mikhail Gorshkov](https://github.com/mgorshkov))。
- SQL関数`parseReadableSize`(`OrNull`および`OrZero`バリアントを含む)を追加しました。[#64742](https://github.com/ClickHouse/ClickHouse/pull/64742) ([Francisco J. Jurado Moreno](https://github.com/Beetelbrox))。
- `CREATE`クエリで作成可能なデータベースまたはテーブルの数を制限するためのサーバー設定`max_table_num_to_throw`および`max_database_num_to_throw`を追加しました。[#64781](https://github.com/ClickHouse/ClickHouse/pull/64781) ([Xu Jia](https://github.com/XuJia0210))。
- ファイル系ストレージ(s3/file/hdfs/url/azureBlobStorage)に`_time`仮想カラムを追加しました。[#64947](https://github.com/ClickHouse/ClickHouse/pull/64947) ([Ilya Golshtein](https://github.com/ilejn))。
- 新しい関数`base64URLEncode`、`base64URLDecode`、`tryBase64URLDecode`を導入しました。[#64991](https://github.com/ClickHouse/ClickHouse/pull/64991) ([Mikhail Gorshkov](https://github.com/mgorshkov))。
- 2つのUTF8文字列間の[編集距離](https://en.wikipedia.org/wiki/Edit_distance)を計算する新しい関数`editDistanceUTF8`を追加しました。[#65269](https://github.com/ClickHouse/ClickHouse/pull/65269) ([LiuNeng](https://github.com/liuneng1994))。
- カスタムHTTPハンドラーでカスタムレスポンスヘッダーをサポートするための`http_response_headers`設定を追加しました。[#63562](https://github.com/ClickHouse/ClickHouse/pull/63562) ([Grigorii](https://github.com/GSokol))。
- クエリ結果を無限ループで返すことをサポートする新しいテーブル関数`loop`を追加しました。[#63452](https://github.com/ClickHouse/ClickHouse/pull/63452) ([Sariel](https://github.com/sarielwxm))。これはテストに有用です。
- `system.query_log`に2つの追加カラム`used_privileges`と`missing_privileges`を導入しました。`used_privileges`にはクエリ実行中にチェックされた権限が格納され、`missing_privileges`には不足している必要な権限が含まれます。[#64597](https://github.com/ClickHouse/ClickHouse/pull/64597) ([Alexey Katsman](https://github.com/alexkats))。
- 有効にすると長いテーブル(デフォルトでは50行)の末尾にカラム名を表示する設定`output_format_pretty_display_footer_column_names`を追加しました。最小行数の閾値は`output_format_pretty_display_footer_column_names_min_rows`で制御されます。[#65144](https://github.com/ClickHouse/ClickHouse/pull/65144) ([Shaun Struwig](https://github.com/Blargian))。

#### 実験的機能 {#experimental-feature-5}

- 「個別値の数」タイプの統計を導入しました。[#59357](https://github.com/ClickHouse/ClickHouse/pull/59357) ([Han Fei](https://github.com/hanfei1991))。
- ReplicatedMergeTreeで統計をサポートしました。[#64934](https://github.com/ClickHouse/ClickHouse/pull/64934) ([Han Fei](https://github.com/hanfei1991))。
- `Replicated`データベースに「レプリカグループ」が設定されている場合、すべてのグループのレプリカを含むクラスタを自動的に作成します。[#64312](https://github.com/ClickHouse/ClickHouse/pull/64312) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 範囲フィルタを使用する際に、動的シャードを持つ並列レプリカがクエリを並列化する方法を制御するための設定`parallel_replicas_custom_key_range_lower`および`parallel_replicas_custom_key_range_upper`を追加しました。[#64604](https://github.com/ClickHouse/ClickHouse/pull/64604) ([josh-hildred](https://github.com/josh-hildred))。


#### パフォーマンス改善 {#performance-improvement-6}

- `PRIMARY KEY`で設定された順序を維持しながら、サイズを最適化するために挿入時に行を再配置する機能を追加しました。この機能は設定`optimize_row_order`で制御されます(デフォルトではオフ)。[#63578](https://github.com/ClickHouse/ClickHouse/pull/63578) ([Igor Markelov](https://github.com/ElderlyPassionFruit))。
- ParquetバイナリをClickHouseカラムに直接読み込むことができるネイティブParquetリーダーを追加しました。この機能は設定`input_format_parquet_use_native_reader`で制御されます(デフォルトでは無効)。[#60361](https://github.com/ClickHouse/ClickHouse/pull/60361) ([ZhiHong Zhang](https://github.com/copperybean))。
- クエリフィルタがMergeTreeテーブルから正確な範囲を選択できる場合に、部分的な簡易カウント最適化をサポートしました。[#60463](https://github.com/ClickHouse/ClickHouse/pull/60463) ([Amos Bird](https://github.com/amosbird))。
- 複数スレッドのチャンクを単一の変換で収集することにより、マルチスレッド`INSERT`の最大メモリ使用量を削減しました。[#61047](https://github.com/ClickHouse/ClickHouse/pull/61047) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- 固定メモリ割り当てを使用し、追加バッファの割り当てを回避することで、Azureオブジェクトストレージ使用時のメモリ使用量を削減しました。[#63160](https://github.com/ClickHouse/ClickHouse/pull/63160) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
- `ColumnNullable::size`における仮想関数呼び出しの回数を削減しました。[#60556](https://github.com/ClickHouse/ClickHouse/pull/60556) ([HappenLee](https://github.com/HappenLee))。
- 正規表現引数が単一文字の場合の`splitByRegexp`を高速化しました。[#62696](https://github.com/ClickHouse/ClickHouse/pull/62696) ([Robert Schulze](https://github.com/rschu1ze))。
- 使用される最小キーと最大キーを追跡することで、8ビットおよび16ビットキーによる集約を高速化しました。これにより、検証が必要なセルの数を削減できます。[#62746](https://github.com/ClickHouse/ClickHouse/pull/62746) ([Jiebin Sun](https://github.com/jiebinn))。
- 左辺が`LowCardinality`で右辺が定数のセットである場合のIN演算子を最適化しました。[#64060](https://github.com/ClickHouse/ClickHouse/pull/64060) ([Zhiguo Zhou](https://github.com/ZhiguoZh))。
- `ConcurrentHashJoin`内でハッシュテーブルを初期化および破棄するためにスレッドプールを使用するようにしました。[#64241](https://github.com/ClickHouse/ClickHouse/pull/64241) ([Nikita Taranov](https://github.com/nickitat))。
- スパースカラムを持つテーブルにおける垂直マージを最適化しました。[#64311](https://github.com/ClickHouse/ClickHouse/pull/64311) ([Anton Popov](https://github.com/CurtizJ))。
- 垂直マージ中にリモートファイルシステムからのデータのプリフェッチを有効にしました。これにより、リモートファイルシステムにデータが保存されているテーブルでの垂直マージのレイテンシが改善されます。[#64314](https://github.com/ClickHouse/ClickHouse/pull/64314) ([Anton Popov](https://github.com/CurtizJ))。
- パフォーマンスを向上させるために、`ColumnSparse::filter`の`isDefault`への冗長な呼び出しを削減しました。[#64426](https://github.com/ClickHouse/ClickHouse/pull/64426) ([Jiebin Sun](https://github.com/jiebinn))。
- 複数の非同期getChildrenリクエストを実行することで、keeper-clientコマンド`find_super_nodes`および`find_big_family`を高速化しました。[#64628](https://github.com/ClickHouse/ClickHouse/pull/64628) ([Alexander Gololobov](https://github.com/davenger))。
- Nullable数値型引数に対する関数`least`/`greatest`を改善しました。[#64668](https://github.com/ClickHouse/ClickHouse/pull/64668) ([KevinyhZou](https://github.com/KevinyhZou))。
- クエリプランの連続する2つのフィルタリングステップのマージを許可しました。これにより、フィルタ条件が親ステップからプッシュダウンできる場合、フィルタプッシュダウン最適化が改善されます。[#64760](https://github.com/ClickHouse/ClickHouse/pull/64760) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 垂直final実装における不適切な最適化を削除し、垂直finalアルゴリズムをデフォルトで再度有効にしました。[#64783](https://github.com/ClickHouse/ClickHouse/pull/64783) ([Duc Canh Le](https://github.com/canhld94))。
- フィルタ式からALIASノードを削除しました。これにより、`PREWHERE`を使用するクエリのパフォーマンスがわずかに向上します(新しいアナライザを使用する場合)。[#64793](https://github.com/ClickHouse/ClickHouse/pull/64793) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- OpenSSLセッションキャッシングを再度有効にしました。[#65111](https://github.com/ClickHouse/ClickHouse/pull/65111) ([Robert Schulze](https://github.com/rschu1ze))。
- 挿入時のスキップインデックスと統計のマテリアライゼーションを無効にする設定(`materialize_skip_indexes_on_insert`および`materialize_statistics_on_insert`)を追加しました。[#64391](https://github.com/ClickHouse/ClickHouse/pull/64391) ([Anton Popov](https://github.com/CurtizJ))。
- 割り当てられたメモリサイズを使用して行グループサイズを計算し、シングルスレッドモードでのParquetライターのピークメモリを削減しました。[#64424](https://github.com/ClickHouse/ClickHouse/pull/64424) ([LiuNeng](https://github.com/liuneng1994))。
- `size`の呼び出しを削減するために、スパースカラムのイテレータを改善しました。[#64497](https://github.com/ClickHouse/ClickHouse/pull/64497) ([Jiebin Sun](https://github.com/jiebinn))。
- Azure Blob Storageへのバックアップにサーバーサイドコピーを使用する条件を更新しました。[#64518](https://github.com/ClickHouse/ClickHouse/pull/64518) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
- 多数のスキップインデックスを持つテーブルにおける垂直マージのメモリ使用量を最適化しました。[#64580](https://github.com/ClickHouse/ClickHouse/pull/64580) ([Anton Popov](https://github.com/CurtizJ))。





#### 改善 {#improvement-6}

- システムテーブルに対して実行される`SHOW CREATE TABLE`で、各テーブル固有の便利なコメントが表示されるようになり、そのテーブルが必要な理由が説明されます。[#63788](https://github.com/ClickHouse/ClickHouse/pull/63788) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 関数`round()`、`roundBankers()`、`floor()`、`ceil()`、`trunc()`の第2引数(スケール)に非定数を指定できるようになりました。[#64798](https://github.com/ClickHouse/ClickHouse/pull/64798) ([Mikhail Gorshkov](https://github.com/mgorshkov))。
- 新しいディスクを追加する際に、`Distributed`テーブルのストレージポリシーをホットリロードできるようになりました。[#58285](https://github.com/ClickHouse/ClickHouse/pull/58285) ([Duc Canh Le](https://github.com/canhld94))。
- 飽和状態のサービスでスレッドをスケジューリングする際に、MergeTreeインデックス解析中に発生する可能性のあるデッドロックを回避します。[#59427](https://github.com/ClickHouse/ClickHouse/pull/59427) ([Sean Haynes](https://github.com/seandhaynes))。
- S3プロキシサポートとトンネリングに関するいくつかの軽微なコーナーケースの修正。[#63427](https://github.com/ClickHouse/ClickHouse/pull/63427) ([Arthur Passos](https://github.com/arthurpassos))。
- io_uringの再送信の可視性を改善しました。プロファイルイベント`IOUringSQEsResubmits`を`IOUringSQEsResubmitsAsync`に名前変更し、新しいイベント`IOUringSQEsResubmitsSync`を追加しました。[#63699](https://github.com/ClickHouse/ClickHouse/pull/63699) ([Tomer Shafir](https://github.com/tomershafir))。
- メタデータストレージディスク上の空き容量を確保するための新しい設定`metadata_keep_free_space_bytes`を追加しました。[#64128](https://github.com/ClickHouse/ClickHouse/pull/64128) ([MikhailBurdukov](https://github.com/MikhailBurdukov))。
- `plain_rewritable`メタデータストレージによって作成および削除されたディレクトリの数、およびローカルからリモートへのインメモリマップ内のエントリ数を追跡するメトリクスを追加しました。[#64175](https://github.com/ClickHouse/ClickHouse/pull/64175) ([Julia Kartseva](https://github.com/jkartseva))。
- クエリキャッシュは、異なる設定を持つ同一のクエリを別のものとして扱うようになりました。これにより、異なる設定(例:`limit`や`additional_table_filters`)がクエリ結果に影響を与える場合の堅牢性が向上します。[#64205](https://github.com/ClickHouse/ClickHouse/pull/64205) ([Robert Schulze](https://github.com/rschu1ze))。
- オブジェクトストレージにおいて、非標準エラーコード`QpsLimitExceeded`を再試行可能なエラーとしてサポートしました。[#64225](https://github.com/ClickHouse/ClickHouse/pull/64225) ([Sema Checherinda](https://github.com/CheSema))。
- このテーブルのzookeeperパスが既に存在する場合、MergeTreeテーブルをレプリケーテッドに変換することを禁止しました。[#64244](https://github.com/ClickHouse/ClickHouse/pull/64244) ([Kirill](https://github.com/kirillgarbar))。
- 平均出力ブロックバイト数を制御するための新しい設定`input_format_parquet_prefer_block_bytes`を追加し、`input_format_parquet_max_block_size`のデフォルト値を65409に変更しました。[#64427](https://github.com/ClickHouse/ClickHouse/pull/64427) ([LiuNeng](https://github.com/liuneng1994))。
- `no_proxy`環境変数およびClickHouseプロキシ設定で指定されたホストに対して、プロキシをバイパスできるようになりました。[#63314](https://github.com/ClickHouse/ClickHouse/pull/63314) ([Arthur Passos](https://github.com/arthurpassos))。
- グローバルスレッドプールに十分な数のスレッドを確保してKeeperを常に起動するようになりました。[#64444](https://github.com/ClickHouse/ClickHouse/pull/64444) ([Duc Canh Le](https://github.com/canhld94))。
- ユーザー設定からの設定は、オブジェクトストレージ上の`MergeTree`のマージとミューテーションに影響を与えなくなりました。[#64456](https://github.com/ClickHouse/ClickHouse/pull/64456) ([alesapin](https://github.com/alesapin))。
- オブジェクトストレージにおいて、非標準エラーコード`TotalQpsLimitExceeded`を再試行可能なエラーとしてサポートしました。[#64520](https://github.com/ClickHouse/ClickHouse/pull/64520) ([Sema Checherinda](https://github.com/CheSema))。
- オープンソース版とClickHouse Cloud版の両方のAdvanced Dashboardを更新し、「最大同時ネットワーク接続数」のチャートを追加しました。[#64610](https://github.com/ClickHouse/ClickHouse/pull/64610) ([Thom O'Connor](https://github.com/thomoco))。
- `zeros_mt`と`generateRandom`の進捗レポートを改善しました。[#64804](https://github.com/ClickHouse/ClickHouse/pull/64804) ([Raúl Marín](https://github.com/Algunenano))。
- サンプリングが現在アクティブかどうかを示す非同期メトリクス`jemalloc.profile.active`を追加しました。これはprof.activeに加えたアクティベーションメカニズムであり、呼び出しスレッドがサンプリングを行うには両方がアクティブである必要があります。[#64842](https://github.com/ClickHouse/ClickHouse/pull/64842) ([Unalian](https://github.com/Unalian))。
- `allow_experimental_join_condition`の重要マークを削除しました。このマークは、バージョンが混在するクラスタでの分散クエリの正常な実行を妨げていた可能性があります。[#65008](https://github.com/ClickHouse/ClickHouse/pull/65008) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- サーバー非同期メトリクス`DiskGetObjectThrottler*`と`DiskGetObjectThrottler*`を追加しました。これらは、`s3_max_get_rps`および`s3_max_put_rps`ディスク設定で定義された秒あたりのリクエスト数制限と、ディスク上のスロットリング制限に達することなく送信できる現在利用可能なリクエスト数を反映します。メトリクスは、制限が設定されているすべてのディスクに対して定義されます。[#65050](https://github.com/ClickHouse/ClickHouse/pull/65050) ([Sergei Trifonov](https://github.com/serxa))。
- `Poco::ThreadPool`のグローバルトレースコレクターを初期化しました(Keeperなどに必要)。[#65239](https://github.com/ClickHouse/ClickHouse/pull/65239) ([Kseniia Sumarokova](https://github.com/kssenii))。
- `bcrypt_hash`を使用してユーザーを作成する際の検証を追加しました。[#65242](https://github.com/ClickHouse/ClickHouse/pull/65242) ([Raúl Marín](https://github.com/Algunenano))。
- `PREWHERE`の実行中および実行後に読み取られた行数のプロファイルイベントを追加しました。[#64198](https://github.com/ClickHouse/ClickHouse/pull/64198) ([Nikita Taranov](https://github.com/nickitat))。
- パラレルレプリカを使用した`EXPLAIN PLAN`でクエリを出力するようになりました。[#64298](https://github.com/ClickHouse/ClickHouse/pull/64298) ([vdimir](https://github.com/vdimir))。
- `allow_deprecated_functions`を`allow_deprecated_error_prone_window_functions`に名前変更しました。[#64358](https://github.com/ClickHouse/ClickHouse/pull/64358) ([Raúl Marín](https://github.com/Algunenano))。
- `file`テーブル関数において、ファイルディスクリプタに対しても`max_read_buffer_size`設定を尊重するようになりました。[#64532](https://github.com/ClickHouse/ClickHouse/pull/64532) ([Azat Khuzhin](https://github.com/azat))。
- マテリアライズドビューであっても、サポートされていないストレージに対してトランザクションを無効化しました。[#64918](https://github.com/ClickHouse/ClickHouse/pull/64918) ([alesapin](https://github.com/alesapin))。
- 旧アナライザーで`QUALIFY`句を禁止しました。旧アナライザーは`QUALIFY`を無視していたため、ミューテーション時に予期しないデータ削除につながる可能性がありました。[#65356](https://github.com/ClickHouse/ClickHouse/pull/65356) ([Dmitry Novik](https://github.com/novikd))。





#### バグ修正（公式安定版リリースにおけるユーザーに見える不具合） {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-5}

- A bug in Apache ORC library was fixed: Fixed ORC statistics calculation, when writing, for unsigned types on all platforms and Int8 on ARM. [#64563](https://github.com/ClickHouse/ClickHouse/pull/64563) ([Michael Kolupaev](https://github.com/al13n321)).
- Returned back the behaviour of how ClickHouse works and interprets Tuples in CSV format. This change effectively reverts https://github.com/ClickHouse/ClickHouse/pull/60994 and makes it available only under a few settings: `output_format_csv_serialize_tuple_into_separate_columns`, `input_format_csv_deserialize_separate_columns_into_tuple` and `input_format_csv_try_infer_strings_from_quoted_tuples`. [#65170](https://github.com/ClickHouse/ClickHouse/pull/65170) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Fix a permission error where a user in a specific situation can escalate their privileges on the default database without necessary grants. [#64769](https://github.com/ClickHouse/ClickHouse/pull/64769) ([pufit](https://github.com/pufit)).
- Fix crash with UniqInjectiveFunctionsEliminationPass and uniqCombined. [#65188](https://github.com/ClickHouse/ClickHouse/pull/65188) ([Raúl Marín](https://github.com/Algunenano)).
- Fix a bug in ClickHouse Keeper that causes digest mismatch during closing session. [#65198](https://github.com/ClickHouse/ClickHouse/pull/65198) ([Aleksei Filatov](https://github.com/aalexfvk)).
- Use correct memory alignment for Distinct combinator. Previously, crash could happen because of invalid memory allocation when the combinator was used. [#65379](https://github.com/ClickHouse/ClickHouse/pull/65379) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix crash with `DISTINCT` and window functions. [#64767](https://github.com/ClickHouse/ClickHouse/pull/64767) ([Igor Nikonov](https://github.com/devcrafter)).
- Fixed 'set' skip index not working with IN and indexHint(). [#62083](https://github.com/ClickHouse/ClickHouse/pull/62083) ([Michael Kolupaev](https://github.com/al13n321)).
- Support executing function during assignment of parameterized view value. [#63502](https://github.com/ClickHouse/ClickHouse/pull/63502) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Fixed parquet memory tracking. [#63584](https://github.com/ClickHouse/ClickHouse/pull/63584) ([Michael Kolupaev](https://github.com/al13n321)).
- Fixed reading of columns of type `Tuple(Map(LowCardinality(String), String), ...)`. [#63956](https://github.com/ClickHouse/ClickHouse/pull/63956) ([Anton Popov](https://github.com/CurtizJ)).
- Fix an `Cyclic aliases` error for cyclic aliases of different type (expression and function). [#63993](https://github.com/ClickHouse/ClickHouse/pull/63993) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- This fix will use a proper redefined context with the correct definer for each individual view in the query pipeline. [#64079](https://github.com/ClickHouse/ClickHouse/pull/64079) ([pufit](https://github.com/pufit)).
- Fix analyzer: "Not found column" error is fixed when using INTERPOLATE. [#64096](https://github.com/ClickHouse/ClickHouse/pull/64096) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix creating backups to S3 buckets with different credentials from the disk containing the file. [#64153](https://github.com/ClickHouse/ClickHouse/pull/64153) ([Antonio Andelic](https://github.com/antonio2368)).
- The query cache now considers two identical queries against different databases as different. The previous behavior could be used to bypass missing privileges to read from a table. [#64199](https://github.com/ClickHouse/ClickHouse/pull/64199) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix possible abort on uncaught exception in ~WriteBufferFromFileDescriptor in StatusFile. [#64206](https://github.com/ClickHouse/ClickHouse/pull/64206) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix `duplicate alias` error for distributed queries with `ARRAY JOIN`. [#64226](https://github.com/ClickHouse/ClickHouse/pull/64226) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix unexpected accurateCast from string to integer. [#64255](https://github.com/ClickHouse/ClickHouse/pull/64255) ([wudidapaopao](https://github.com/wudidapaopao)).
- Fixed CNF simplification, in case any OR group contains mutually exclusive atoms. [#64256](https://github.com/ClickHouse/ClickHouse/pull/64256) ([Eduard Karacharov](https://github.com/korowa)).
- Fix Query Tree size validation. [#64377](https://github.com/ClickHouse/ClickHouse/pull/64377) ([Dmitry Novik](https://github.com/novikd)).
- Fix `Logical error: Bad cast` for `Buffer` table with `PREWHERE`. [#64388](https://github.com/ClickHouse/ClickHouse/pull/64388) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Prevent recursive logging in `blob_storage_log` when it's stored on object storage. [#64393](https://github.com/ClickHouse/ClickHouse/pull/64393) ([vdimir](https://github.com/vdimir)).
- Fixed `CREATE TABLE AS` queries for tables with default expressions. [#64455](https://github.com/ClickHouse/ClickHouse/pull/64455) ([Anton Popov](https://github.com/CurtizJ)).
- Fixed `optimize_read_in_order` behaviour for ORDER BY ... NULLS FIRST / LAST on tables with nullable keys. [#64483](https://github.com/ClickHouse/ClickHouse/pull/64483) ([Eduard Karacharov](https://github.com/korowa)).
- Fix the `Expression nodes list expected 1 projection names` and `Unknown expression or identifier` errors for queries with aliases to `GLOBAL IN.`. [#64517](https://github.com/ClickHouse/ClickHouse/pull/64517) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix an error `Cannot find column` in distributed queries with constant CTE in the `GROUP BY` key. [#64519](https://github.com/ClickHouse/ClickHouse/pull/64519) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix the crash loop when restoring from backup is blocked by creating an MV with a definer that hasn't been restored yet. [#64595](https://github.com/ClickHouse/ClickHouse/pull/64595) ([pufit](https://github.com/pufit)).
- Fix the output of function `formatDateTimeInJodaSyntax` when a formatter generates an uneven number of characters and the last character is `0`. For example, `SELECT formatDateTimeInJodaSyntax(toDate('2012-05-29'), 'D')` now correctly returns `150` instead of previously `15`. [#64614](https://github.com/ClickHouse/ClickHouse/pull/64614) ([LiuNeng](https://github.com/liuneng1994)).
- Do not rewrite aggregation if `-If` combinator is already used. [#64638](https://github.com/ClickHouse/ClickHouse/pull/64638) ([Dmitry Novik](https://github.com/novikd)).
- Fix type inference for float (in case of small buffer, i.e. `--max_read_buffer_size 1`). [#64641](https://github.com/ClickHouse/ClickHouse/pull/64641) ([Azat Khuzhin](https://github.com/azat)).
- Fix bug which could lead to non-working TTLs with expressions. [#64694](https://github.com/ClickHouse/ClickHouse/pull/64694) ([alesapin](https://github.com/alesapin)).
- Fix removing the `WHERE` and `PREWHERE` expressions, which are always true (for the new analyzer). [#64695](https://github.com/ClickHouse/ClickHouse/pull/64695) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fixed excessive part elimination by token-based text indexes (`ngrambf` , `full_text`) when filtering by result of `startsWith`, `endsWith`, `match`, `multiSearchAny`. [#64720](https://github.com/ClickHouse/ClickHouse/pull/64720) ([Eduard Karacharov](https://github.com/korowa)).
- Fixes incorrect behaviour of ANSI CSI escaping in the `UTF8::computeWidth` function. [#64756](https://github.com/ClickHouse/ClickHouse/pull/64756) ([Shaun Struwig](https://github.com/Blargian)).
- Fix a case of incorrect removal of `ORDER BY` / `LIMIT BY` across subqueries. [#64766](https://github.com/ClickHouse/ClickHouse/pull/64766) ([Raúl Marín](https://github.com/Algunenano)).
- Fix (experimental) unequal join with subqueries for sets which are in the mixed join conditions. [#64775](https://github.com/ClickHouse/ClickHouse/pull/64775) ([lgbo](https://github.com/lgbo-ustc)).
- Fix crash in a local cache over `plain_rewritable` disk. [#64778](https://github.com/ClickHouse/ClickHouse/pull/64778) ([Julia Kartseva](https://github.com/jkartseva)).
- Keeper fix: return correct value for `zk_latest_snapshot_size` in `mntr` command. [#64784](https://github.com/ClickHouse/ClickHouse/pull/64784) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix `Cannot find column` in distributed query with `ARRAY JOIN` by `Nested` column. Fixes [#64755](https://github.com/ClickHouse/ClickHouse/issues/64755). [#64801](https://github.com/ClickHouse/ClickHouse/pull/64801) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix memory leak in slru cache policy. [#64803](https://github.com/ClickHouse/ClickHouse/pull/64803) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fixed possible incorrect memory tracking in several kinds of queries: queries that read any data from S3, queries via http protocol, asynchronous inserts. [#64844](https://github.com/ClickHouse/ClickHouse/pull/64844) ([Anton Popov](https://github.com/CurtizJ)).
- Fix the `Block structure mismatch` error for queries reading with `PREWHERE` from the materialized view when the materialized view has columns of different types than the source table. Fixes [#64611](https://github.com/ClickHouse/ClickHouse/issues/64611). [#64855](https://github.com/ClickHouse/ClickHouse/pull/64855) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix rare crash when table has TTL with subquery + database replicated + parallel replicas + analyzer. It's really rare, but please don't use TTLs with subqueries. [#64858](https://github.com/ClickHouse/ClickHouse/pull/64858) ([alesapin](https://github.com/alesapin)).
- Fix duplicating `Delete` events in `blob_storage_log` in case of large batch to delete. [#64924](https://github.com/ClickHouse/ClickHouse/pull/64924) ([vdimir](https://github.com/vdimir)).
- Fixed `Session moved to another server` error from [Zoo]Keeper that might happen after server startup when the config has includes from [Zoo]Keeper. [#64986](https://github.com/ClickHouse/ClickHouse/pull/64986) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix `ALTER MODIFY COMMENT` query that was broken for parameterized VIEWs in https://github.com/ClickHouse/ClickHouse/pull/54211. [#65031](https://github.com/ClickHouse/ClickHouse/pull/65031) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix `host_id` in DatabaseReplicated when `cluster_secure_connection` parameter is enabled. Previously all the connections within the cluster created by DatabaseReplicated were not secure, even if the parameter was enabled. [#65054](https://github.com/ClickHouse/ClickHouse/pull/65054) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fixing the `Not-ready Set` error after the `PREWHERE` optimization for StorageMerge. [#65057](https://github.com/ClickHouse/ClickHouse/pull/65057) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Avoid writing to finalized buffer in File-like storages. [#65063](https://github.com/ClickHouse/ClickHouse/pull/65063) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix possible infinite query duration in case of cyclic aliases. Fixes [#64849](https://github.com/ClickHouse/ClickHouse/issues/64849). [#65081](https://github.com/ClickHouse/ClickHouse/pull/65081) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix the `Unknown expression identifier` error for remote queries with `INTERPOLATE (alias)` (new analyzer). Fixes [#64636](https://github.com/ClickHouse/ClickHouse/issues/64636). [#65090](https://github.com/ClickHouse/ClickHouse/pull/65090) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix pushing arithmetic operations out of aggregation. In the new analyzer, optimization was applied only once. [#65104](https://github.com/ClickHouse/ClickHouse/pull/65104) ([Dmitry Novik](https://github.com/novikd)).
- Fix aggregate function name rewriting in the new analyzer. [#65110](https://github.com/ClickHouse/ClickHouse/pull/65110) ([Dmitry Novik](https://github.com/novikd)).
- Respond with 5xx instead of 200 OK in case of receive timeout while reading (parts of) the request body from the client socket. [#65118](https://github.com/ClickHouse/ClickHouse/pull/65118) ([Julian Maicher](https://github.com/jmaicher)).
- Fix possible crash for hedged requests. [#65206](https://github.com/ClickHouse/ClickHouse/pull/65206) ([Azat Khuzhin](https://github.com/azat)).
- Fix the bug in Hashed and Hashed_Array dictionary short circuit evaluation, which may read uninitialized number, leading to various errors. [#65256](https://github.com/ClickHouse/ClickHouse/pull/65256) ([jsc0218](https://github.com/jsc0218)).
- This PR ensures that the type of the constant(IN operator's second parameter) is always visible during the IN operator's type conversion process. Otherwise, losing type information may cause some conversions to fail, such as the conversion from DateTime to Date. This fixes ([#64487](https://github.com/ClickHouse/ClickHouse/issues/64487)). [#65315](https://github.com/ClickHouse/ClickHouse/pull/65315) ([pn](https://github.com/chloro-pn)).

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-2}

- LLVM XRayのサポートを追加。[#64592](https://github.com/ClickHouse/ClickHouse/pull/64592) [#64837](https://github.com/ClickHouse/ClickHouse/pull/64837) ([Tomer Shafir](https://github.com/tomershafir))。
- s3/hdfs/azureストレージの実装をIObjectStorageで動作する単一のクラスに統合。\*Cluster、データレイク、Queueストレージについても同様。[#59767](https://github.com/ClickHouse/ClickHouse/pull/59767) ([Kseniia Sumarokova](https://github.com/kssenii))。
- データパートライターをリファクタリングし、MergeTreeDataとDataPartへの依存関係を削除。[#63620](https://github.com/ClickHouse/ClickHouse/pull/63620) ([Alexander Gololobov](https://github.com/davenger))。
- `KeyCondition`とキー解析をリファクタリングし、PartitionPrunerとトリビアルカウント最適化を改善。これは[#60463](https://github.com/ClickHouse/ClickHouse/issues/60463)から分離されたもの。[#61459](https://github.com/ClickHouse/ClickHouse/pull/61459) ([Amos Bird](https://github.com/amosbird))。
- すべての関数が適切なサイズの列で呼び出されることを検証するアサーションを導入。[#63723](https://github.com/ClickHouse/ClickHouse/pull/63723) ([Raúl Marín](https://github.com/Algunenano))。
- `rc`初期化スクリプトを使用してClickHouseサーバーデーモンを起動する際に、`network`サービスを必須とするよう変更。[#60650](https://github.com/ClickHouse/ClickHouse/pull/60650) ([Chun-Sheng, Li](https://github.com/peter279k))。
- 一部の低速なテストのサイズを削減。[#64387](https://github.com/ClickHouse/ClickHouse/pull/64387) [#64452](https://github.com/ClickHouse/ClickHouse/pull/64452) ([Raúl Marín](https://github.com/Algunenano))。
- keeper-benchを使用してZooKeeperログを再生。[#62481](https://github.com/ClickHouse/ClickHouse/pull/62481) ([Antonio Andelic](https://github.com/antonio2368))。

### <a id="245"></a> ClickHouseリリース24.5、2024-05-30 {#a-id245a-clickhouse-release-245-2024-05-30}

#### 後方互換性のない変更 {#backward-incompatible-change-7}

- 「inverted indexes」を「full-text indexes」に名称変更。これはより技術的でなく、ユーザーフレンドリーな名称。この変更により内部テーブルメタデータも変更され、既存の（実験的な）inverted indexesを持つテーブルが破損する。アップグレード前にこれらのインデックスを削除し、アップグレード後に再作成すること。[#62884](https://github.com/ClickHouse/ClickHouse/pull/62884) ([Robert Schulze](https://github.com/rschu1ze))。
- 関数`neighbor`、`runningAccumulate`、`runningDifferenceStartingWithFirstValue`、`runningDifference`の使用を非推奨化（エラーが発生しやすいため）。代わりに適切なウィンドウ関数を使用すること。これらを再度有効にするには、`allow_deprecated_error_prone_window_functions = 1`を設定するか、`compatibility = '24.4'`以下に設定する。[#63132](https://github.com/ClickHouse/ClickHouse/pull/63132) ([Nikita Taranov](https://github.com/nickitat))。
- 列数が多い場合でも、多くのデータベースやテーブルに`SHOW TABLES`が許可されていない場合、`system.columns`からのクエリが高速化される。以前のバージョンでは、対応するテーブルに`SHOW TABLES`を許可せずに個別の列に`SHOW COLUMNS`を許可した場合、`system.columns`テーブルにこれらの列が表示されていたが、新しいバージョンではテーブル全体がスキップされる。クエリを遅延させていたトレースログメッセージ「Access granted」と「Access denied」を削除。[#63439](https://github.com/ClickHouse/ClickHouse/pull/63439) ([Alexey Milovidov](https://github.com/alexey-milovidov))。


#### 新機能 {#new-feature-7}

- `application/x-www-form-urlencoded`形式で単一レコードを読み書きするための`Form`フォーマットを追加しました。[#60199](https://github.com/ClickHouse/ClickHouse/pull/60199) ([Shaun Struwig](https://github.com/Blargian))。
- CROSS JOINで圧縮を行う機能を追加しました。[#60459](https://github.com/ClickHouse/ClickHouse/pull/60459) ([p1rattttt](https://github.com/p1rattttt))。
- サイズが制限を超える場合に、一時ファイルで`CROSS JOIN`を実行する機能を追加しました。[#63432](https://github.com/ClickHouse/ClickHouse/pull/63432) ([p1rattttt](https://github.com/p1rattttt))。
- 左右両方のテーブルの列を含む不等条件でのJOINをサポートしました。例：`t1.y < t2.y`。有効にするには、`SET allow_experimental_join_condition = 1`を設定してください。[#60920](https://github.com/ClickHouse/ClickHouse/pull/60920) ([lgbo](https://github.com/lgbo-ustc))。
- Mapのキーとして`Float32`、`Float64`、`Array(T)`、`Map(K, V)`、`Tuple(T1, T2, ...)`を使用できるようになりました。[#54537](https://github.com/ClickHouse/ClickHouse/issues/54537)をクローズします。[#59318](https://github.com/ClickHouse/ClickHouse/pull/59318) ([李扬](https://github.com/taiyang-li))。
- RocksDB組み込みのmemtableに依存する代わりに、SSTファイルを作成して取り込むことで、`EmbeddedRocksDB`へのバルクロードを導入しました。これにより、特にStorageEmbeddedRocksDBテーブルへの長時間実行されるINSERTクエリにおいて、インポート速度が向上します。また、`EmbeddedRocksDB`テーブル設定を導入しました。[#59163](https://github.com/ClickHouse/ClickHouse/pull/59163) [#63324](https://github.com/ClickHouse/ClickHouse/pull/63324) ([Duc Canh Le](https://github.com/canhld94))。
- `input_format_tsv_crlf_end_of_line`設定を使用して、TSV形式でCRLFを解析できるようになりました。[#56257](https://github.com/ClickHouse/ClickHouse/issues/56257)をクローズします。[#59747](https://github.com/ClickHouse/ClickHouse/pull/59747) ([Shaun Struwig](https://github.com/Blargian))。
- 省略されたフィールドに対してNULL値を強制する新しい設定`input_format_force_null_for_omitted_fields`を追加しました。[#60887](https://github.com/ClickHouse/ClickHouse/pull/60887) ([Constantine Peresypkin](https://github.com/pkit))。
- 以前、S3ストレージとs3テーブル関数は、tarball、zip、7zなどのアーカイブコンテナファイルからの選択をサポートしていませんでした。現在、S3内のアーカイブ内のファイルを反復処理できるようになりました。[#62259](https://github.com/ClickHouse/ClickHouse/pull/62259) ([Daniil Ivanik](https://github.com/divanik))。
- 条件関数`clamp`のサポートを追加しました。[#62377](https://github.com/ClickHouse/ClickHouse/pull/62377) ([skyoct](https://github.com/skyoct))。
- `NPy`出力フォーマットを追加しました。[#62430](https://github.com/ClickHouse/ClickHouse/pull/62430) ([豪肥肥](https://github.com/HowePa))。
- `TSVRaw`の同義語として`Raw`フォーマットを追加しました。[#63394](https://github.com/ClickHouse/ClickHouse/pull/63394) ([Unalian](https://github.com/Unalian))。
- バージョン7 UUID（タイムスタンプベースのUUIDとランダムコンポーネント）を生成する新しいSQL関数`generateUUIDv7`を追加しました。また、UUIDからバイトを抽出する新しい関数`UUIDToNum`と、UUIDバージョン7からタイムスタンプコンポーネントを抽出する新しい関数`UUIDv7ToDateTime`を追加しました。[#62852](https://github.com/ClickHouse/ClickHouse/pull/62852) ([Alexey Petrunyaka](https://github.com/pet74alex))。
- LinuxとmacOSで、プログラムのstdoutが圧縮拡張子を持つファイルにリダイレクトされている場合、何もしない代わりに対応する圧縮方式を使用します（`INTO OUTFILE`と同様の動作になります）。[#63662](https://github.com/ClickHouse/ClickHouse/pull/63662) ([v01dXYZ](https://github.com/v01dXYZ))。
- アタッチされたテーブル数が多い場合の警告を変更し、テーブル、ビュー、ディクショナリを区別するようにしました。[#64180](https://github.com/ClickHouse/ClickHouse/pull/64180) ([Francisco J. Jurado Moreno](https://github.com/Beetelbrox))。
- ClickHouseサーバーの`azureBlobStorage`関数で、Azure Workload identityを使用してAzure Blob Storageに対して認証するサポートを提供しました。設定で`use_workload_identity`パラメータが設定されている場合、認証に[workload identity](https://github.com/Azure/azure-sdk-for-cpp/tree/main/sdk/identity/azure-identity#authenticate-azure-hosted-applications)が使用されます。[#57881](https://github.com/ClickHouse/ClickHouse/pull/57881) ([Vinay Suryadevara](https://github.com/vinay92-ch))。
- `system.parts_columns`テーブルにTTL情報を追加しました。[#63200](https://github.com/ClickHouse/ClickHouse/pull/63200) ([litlig](https://github.com/litlig))。

#### 実験的機能 {#experimental-features-1}

- 事前にすべての型を把握していなくても、任意の型の値を格納できる`Dynamic`データ型を実装しました。`Dynamic`型は`allow_experimental_dynamic_type`設定で利用できます。参照: [#54864](https://github.com/ClickHouse/ClickHouse/issues/54864). [#63058](https://github.com/ClickHouse/ClickHouse/pull/63058) ([Kruglov Pavel](https://github.com/Avogar)).
- MySQLへの接続なしで`MaterializedMySQL`データベースを作成できるようになりました。[#63397](https://github.com/ClickHouse/ClickHouse/pull/63397) ([Kirill](https://github.com/kirillgarbar)).
- 同じエラーでDDLタスクが`max_retries_before_automatic_recovery`回(デフォルトは100回)連続して失敗した場合、Replicatedデータベースのレプリカを自動的に喪失としてマークし、リカバリを開始するようになりました。また、エントリ実行の初期段階で例外がスローされた際にDDLエントリがスキップされる可能性があったバグを修正しました。[#63549](https://github.com/ClickHouse/ClickHouse/pull/63549) ([Alexander Tokmakov](https://github.com/tavplubix)).
- `StorageS3Queue`の`s3queue_tracked_file_ttl_sec`と`s3queue_traked_files_limit`で失敗したファイルを計上するようになりました。[#63638](https://github.com/ClickHouse/ClickHouse/pull/63638) ([Kseniia Sumarokova](https://github.com/kssenii)).


#### パフォーマンス改善 {#performance-improvement-7}

- ファイルシステムキャッシュの競合を削減(パート4)。バックグラウンドで追加の退避処理を実行することで、ファイルシステムキャッシュを上限まで満たさないようにします(`keep_free_space_size(elements)_ratio`で制御)。これにより、クエリの領域予約(`tryReserve`メソッド)における負荷を軽減できます。また、可能な限りロックフリーな方法で実行されるため、通常のキャッシュ使用をブロックしません。[#61250](https://github.com/ClickHouse/ClickHouse/pull/61250) ([Kseniia Sumarokova](https://github.com/kssenii))。
- `INSERT`実行時に新しく作成されたプロジェクションブロックのマージをスキップします。[#59405](https://github.com/ClickHouse/ClickHouse/pull/59405) ([Nikita Taranov](https://github.com/nickitat))。
- 入力文字列がすべてASCII文字の場合、文字列関数`...UTF8`をASCII処理として実行します。https://github.com/apache/doris/pull/29799 から着想を得ました。全体的に1.07倍から1.62倍の高速化を実現しました。一部のケースではピークメモリ使用量も削減されています。[#61632](https://github.com/ClickHouse/ClickHouse/pull/61632) ([李扬](https://github.com/taiyang-li))。
- StorageS3における選択(`{}`)グロブのパフォーマンスを改善しました。[#62120](https://github.com/ClickHouse/ClickHouse/pull/62120) ([Andrey Zvonov](https://github.com/zvonand))。
- HostResolverが各IPアドレスを複数回保持していました。リモートホストが複数のIPを持ち、何らかの理由(例えばファイアウォールルール)で一部のIPへのアクセスが許可され、他のIPが禁止されている場合、禁止されたIPの最初のレコードのみが失敗としてマークされ、各試行でこれらのIPが選択される可能性があり(再び失敗します)。これを修正しても、120秒ごとにDNSキャッシュがドロップされ、IPが再び選択される可能性がありました。[#62652](https://github.com/ClickHouse/ClickHouse/pull/62652) ([Anton Ivashkin](https://github.com/ianton-ru))。
- 新しい設定`prefer_merge_sort_block_bytes`を追加し、メモリ使用量を制御し、多数のカラムがある場合のマージ時のソート処理を2倍高速化します。[#62904](https://github.com/ClickHouse/ClickHouse/pull/62904) ([LiuNeng](https://github.com/liuneng1994))。
- `clickhouse-local`の起動が高速化されます。以前のバージョンでは、誤って一時ディレクトリが削除されていませんでした。現在は削除されます。これにより[#62941](https://github.com/ClickHouse/ClickHouse/issues/62941)が解決されます。[#63074](https://github.com/ClickHouse/ClickHouse/pull/63074) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 新しいアナライザーのマイクロ最適化を実施しました。[#63429](https://github.com/ClickHouse/ClickHouse/pull/63429) ([Raúl Marín](https://github.com/Algunenano))。
- `DateTime`と`DateTime64`を比較する場合にインデックス解析が機能するようになります。これにより[#63441](https://github.com/ClickHouse/ClickHouse/issues/63441)が解決されます。[#63443](https://github.com/ClickHouse/ClickHouse/pull/63443) [#63532](https://github.com/ClickHouse/ClickHouse/pull/63532) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 不要な処理を削除することで、`set`型のインデックスを若干(約1.5倍)高速化しました。[#64098](https://github.com/ClickHouse/ClickHouse/pull/64098) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- ファイルシステムキャッシュへの書き込み時のデータコピーを削除しました。[#63401](https://github.com/ClickHouse/ClickHouse/pull/63401) ([Kseniia Sumarokova](https://github.com/kssenii))。
- Azure Blob Storageを使用したバックアップでマルチコピーを使用するようになります。[#64116](https://github.com/ClickHouse/ClickHouse/pull/64116) ([alesapin](https://github.com/alesapin))。
- 異なるコンテナ間でもAzureのネイティブコピーを使用できるようになります。[#64154](https://github.com/ClickHouse/ClickHouse/pull/64154) ([alesapin](https://github.com/alesapin))。
- Azureのネイティブコピーを最終的に有効化しました。[#64182](https://github.com/ClickHouse/ClickHouse/pull/64182) ([alesapin](https://github.com/alesapin))。


#### 改善 {#improvement-7}

- `clickhouse-local`とそのショートカット`clickhouse`および`ch`で、クエリまたはクエリファイルを位置引数として使用できるようになりました。例: `ch "SELECT 1"`, `ch --param_test Hello "SELECT {test:String}"`, `ch query.sql`。これにより[#62361](https://github.com/ClickHouse/ClickHouse/issues/62361)が解決されます。[#63081](https://github.com/ClickHouse/ClickHouse/pull/63081) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- ローカルおよびAzure (azure_blob_storage) オブジェクトストレージに対してplain_rewritableメタデータを有効化しました。[#63365](https://github.com/ClickHouse/ClickHouse/pull/63365) ([Julia Kartseva](https://github.com/jkartseva))。
- 英語スタイルのUnicode引用符(例: "Hello", 'world')をサポートしました。一般的には疑問の余地がありますが、Google Docsなどのワードプロセッサでクエリを入力する際に便利です。これにより[#58634](https://github.com/ClickHouse/ClickHouse/issues/58634)が解決されます。[#63381](https://github.com/ClickHouse/ClickHouse/pull/63381) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- INSERTクエリのカラムリストで末尾のカンマを許可するようになりました。例: `INSERT INTO test (a, b, c, ) VALUES ...`。[#63803](https://github.com/ClickHouse/ClickHouse/pull/63803) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `Regexp`フォーマットの例外メッセージを改善しました。[#63804](https://github.com/ClickHouse/ClickHouse/pull/63804) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `Values`フォーマットで末尾のカンマを許可するようになりました。例えば、次のクエリが許可されます: `INSERT INTO test (a, b, c) VALUES (4, 5, 6,);`。[#63810](https://github.com/ClickHouse/ClickHouse/pull/63810) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- rabbitmqで破損したメッセージをnackするようにしました。[#45350](https://github.com/ClickHouse/ClickHouse/issues/45350)を解決します。[#60312](https://github.com/ClickHouse/ClickHouse/pull/60312) ([Kseniia Sumarokova](https://github.com/kssenii))。
- デバッグ情報の解釈中に発生する非同期スタックアンワインド(サンプリングクエリプロファイラ使用時など)のクラッシュを修正しました。これにより[#60460](https://github.com/ClickHouse/ClickHouse/issues/60460)が解決されます。[#60468](https://github.com/ClickHouse/ClickHouse/pull/60468) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- ディスクとストレージの場合におけるs3エラー'no key'に対して異なるメッセージを表示するようにしました。[#61108](https://github.com/ClickHouse/ClickHouse/pull/61108) ([Sema Checherinda](https://github.com/CheSema))。
- `system.zeros`、`system.zeros_mt`(既に`system.numbers`と`system.numbers_mt`では動作しています)からのLIMITを使用した単純なクエリ、および`generateRandom`テーブル関数でプログレスバーが動作するようになりました。さらに、レコードの総数が`max_rows_to_read`制限を超える場合、より早く例外をスローします。これにより[#58183](https://github.com/ClickHouse/ClickHouse/issues/58183)が解決されます。[#61823](https://github.com/ClickHouse/ClickHouse/pull/61823) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- YAML設定での「Merge Key」をサポートしました(これはYAMLの奇妙な機能ですが、気にしないでください)。[#62685](https://github.com/ClickHouse/ClickHouse/pull/62685) ([Azat Khuzhin](https://github.com/azat))。
- Replicatedソースで非決定的関数が使用された場合のエラーメッセージを改善しました。[#62896](https://github.com/ClickHouse/ClickHouse/pull/62896) ([Grégoire Pineau](https://github.com/lyrixx))。
- `remote`からのDistributed over Distributedのサーバー間シークレットを修正しました。[#63013](https://github.com/ClickHouse/ClickHouse/pull/63013) ([Azat Khuzhin](https://github.com/azat))。
- YAMLファイルで`include_from`をサポートしました。ただし、`config.d`を使用する方が望ましいです。[#63106](https://github.com/ClickHouse/ClickHouse/pull/63106) ([Eduard Karacharov](https://github.com/korowa))。
- skim候補から選択した後、ターミナルに以前のデータを保持するようにしました。[#63261](https://github.com/ClickHouse/ClickHouse/pull/63261) ([FlameFactory](https://github.com/FlameFactory))。
- フィールドの幅(Prettyフォーマットまたは`visibleWidth`関数)がANSIエスケープシーケンスを正しく無視するようになりました。[#63270](https://github.com/ClickHouse/ClickHouse/pull/63270) ([Shaun Struwig](https://github.com/Blargian))。
- エラーコード`NUMBER_OF_ARGUMENTS_DOESNT_MATCH`の使用を、適切な場合により正確なエラーコードに更新しました。[#63406](https://github.com/ClickHouse/ClickHouse/pull/63406) ([Yohann Jardin](https://github.com/yohannj))。
- clickhouse-clientのコマンドライン候補のクエリに対して、`os_user`と`client_hostname`が正しく設定されるようになりました。これにより[#63430](https://github.com/ClickHouse/ClickHouse/issues/63430)が解決されます。[#63433](https://github.com/ClickHouse/ClickHouse/pull/63433) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `max_block_size`がゼロの場合、自動的にデフォルト値に修正するようにしました。[#63587](https://github.com/ClickHouse/ClickHouse/pull/63587) ([Antonio Andelic](https://github.com/antonio2368))。
- バイナリの変更を検出した際の自動リネームを容易にするため、trace_logにbuild_id ALIASカラムを追加しました。これは[#52086](https://github.com/ClickHouse/ClickHouse/issues/52086)に対処するものです。[#63656](https://github.com/ClickHouse/ClickHouse/pull/63656) ([Zimu Li](https://github.com/woodlzm))。
- オブジェクトストレージディスクに対してtruncate操作を有効化しました。[#63693](https://github.com/ClickHouse/ClickHouse/pull/63693) ([MikhailBurdukov](https://github.com/MikhailBurdukov))。
- キーワードリストの読み込みがサーバーのリビジョンに依存するようになり、古いバージョンのClickHouseサーバーでは無効化されます。CC @azat。[#63786](https://github.com/ClickHouse/ClickHouse/pull/63786) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- ClickHouseディスクは、実際のメタデータフォーマットバージョンを取得するためにサーバー設定を読み取る必要があります。[#63831](https://github.com/ClickHouse/ClickHouse/pull/63831) ([Sema Checherinda](https://github.com/CheSema))。
- stdoutがTTYでない場合、prettyフォーマットの制限(`output_format_pretty_max_rows`/`output_format_pretty_max_value_width`)を無効化しました。[#63942](https://github.com/ClickHouse/ClickHouse/pull/63942) ([Azat Khuzhin](https://github.com/azat))。
- ClickHouseがAWS Lambda内で使用される場合に例外処理が動作するようになりました。作成者: [Alexey Coolnev](https://github.com/acoolnev)。[#64014](https://github.com/ClickHouse/ClickHouse/pull/64014) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- HTTP経由で渡された無効な圧縮データに対して、`CORRUPTED_DATA`の代わりに`CANNOT_DECOMPRESS`をスローするようにしました。[#64036](https://github.com/ClickHouse/ClickHouse/pull/64036) ([vdimir](https://github.com/vdimir))。
- Prettyフォーマットでの単一の大きな数値に対するヒントが、NullableとLowCardinalityで動作するようになりました。これにより[#61993](https://github.com/ClickHouse/ClickHouse/issues/61993)が解決されます。[#64084](https://github.com/ClickHouse/ClickHouse/pull/64084) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- インデックスを使用したパーツフィルタリングに関するメトリクス、ログ、スレッド名を追加しました。[#64130](https://github.com/ClickHouse/ClickHouse/pull/64130) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `ATTACH`時に`allow_suspicious_primary_key`を無視し、`ALTER`時に検証するようにしました。[#64202](https://github.com/ClickHouse/ClickHouse/pull/64202) ([Azat Khuzhin](https://github.com/azat))。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-3}

- ClickHouseはclang-18でビルドされています。clang-tidy-18の多数の新しいチェックが有効化されました。[#60469](https://github.com/ClickHouse/ClickHouse/pull/60469) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- ClickHouseの新しいプラットフォームとしてloongarch64を実験的にサポートしました。[#63733](https://github.com/ClickHouse/ClickHouse/pull/63733) ([qiangxuhui](https://github.com/qiangxuhui))。
- Dockerfileがdocker公式ライブラリでレビューされました（https://github.com/docker-library/official-images/pull/15846）。[#63400](https://github.com/ClickHouse/ClickHouse/pull/63400) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- CI内のすべてのビルドについて、各翻訳単位内のすべてのシンボルに関する情報がCIデータベースに収集されます。これにより[#63494](https://github.com/ClickHouse/ClickHouse/issues/63494)が解決されます。[#63495](https://github.com/ClickHouse/ClickHouse/pull/63495) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- Apache Datasketchesライブラリを更新しました。これにより[#63858](https://github.com/ClickHouse/ClickHouse/issues/63858)が解決されます。[#63923](https://github.com/ClickHouse/ClickHouse/pull/63923) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- バイナリのクロスコンパイル時にaarch64 Linux向けのGRPCサポートを有効化しました。[#64072](https://github.com/ClickHouse/ClickHouse/pull/64072) ([alesapin](https://github.com/alesapin))。
- aarch64でのSIGSEGV時のアンワインドを修正しました（シグナル用のスタックが小さいことが原因）。[#64058](https://github.com/ClickHouse/ClickHouse/pull/64058) ([Azat Khuzhin](https://github.com/azat))。


#### バグ修正 {#bug-fix-1}

- Disabled `enable_vertical_final` setting by default. This feature should not be used because it has a bug: [#64543](https://github.com/ClickHouse/ClickHouse/issues/64543). [#64544](https://github.com/ClickHouse/ClickHouse/pull/64544) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix making backup when multiple shards are used [#57684](https://github.com/ClickHouse/ClickHouse/pull/57684) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix passing projections/indexes/primary key from columns list from CREATE query into inner table of MV [#59183](https://github.com/ClickHouse/ClickHouse/pull/59183) ([Azat Khuzhin](https://github.com/azat)).
- Fix boundRatio incorrect merge [#60532](https://github.com/ClickHouse/ClickHouse/pull/60532) ([Tao Wang](https://github.com/wangtZJU)).
- Fix crash when calling some functions on const low-cardinality columns [#61966](https://github.com/ClickHouse/ClickHouse/pull/61966) ([Michael Kolupaev](https://github.com/al13n321)).
- Fix queries with FINAL give wrong result when table does not use adaptive granularity [#62432](https://github.com/ClickHouse/ClickHouse/pull/62432) ([Duc Canh Le](https://github.com/canhld94)).
- Improve detection of cgroups v2 support for memory controllers [#62903](https://github.com/ClickHouse/ClickHouse/pull/62903) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix subsequent use of external tables in client [#62964](https://github.com/ClickHouse/ClickHouse/pull/62964) ([Azat Khuzhin](https://github.com/azat)).
- Fix crash with untuple and unresolved lambda [#63131](https://github.com/ClickHouse/ClickHouse/pull/63131) ([Raúl Marín](https://github.com/Algunenano)).
- Fix premature server listen for connections [#63181](https://github.com/ClickHouse/ClickHouse/pull/63181) ([alesapin](https://github.com/alesapin)).
- Fix intersecting parts when restarting after a DROP PART command [#63202](https://github.com/ClickHouse/ClickHouse/pull/63202) ([Han Fei](https://github.com/hanfei1991)).
- Correctly load SQL security defaults during startup [#63209](https://github.com/ClickHouse/ClickHouse/pull/63209) ([pufit](https://github.com/pufit)).
- JOIN filter push down filter join fix [#63234](https://github.com/ClickHouse/ClickHouse/pull/63234) ([Maksim Kita](https://github.com/kitaisreal)).
- Fix infinite loop in AzureObjectStorage::listObjects [#63257](https://github.com/ClickHouse/ClickHouse/pull/63257) ([Julia Kartseva](https://github.com/jkartseva)).
- CROSS join ignore join_algorithm setting [#63273](https://github.com/ClickHouse/ClickHouse/pull/63273) ([vdimir](https://github.com/vdimir)).
- Fix finalize WriteBufferToFileSegment and StatusFile [#63346](https://github.com/ClickHouse/ClickHouse/pull/63346) ([vdimir](https://github.com/vdimir)).
- Fix logical error during SELECT query after ALTER in rare case [#63353](https://github.com/ClickHouse/ClickHouse/pull/63353) ([alesapin](https://github.com/alesapin)).
- Fix `X-ClickHouse-Timezone` header with `session_timezone` [#63377](https://github.com/ClickHouse/ClickHouse/pull/63377) ([Andrey Zvonov](https://github.com/zvonand)).
- Fix debug assert when using grouping WITH ROLLUP and LowCardinality types [#63398](https://github.com/ClickHouse/ClickHouse/pull/63398) ([Raúl Marín](https://github.com/Algunenano)).
- Small fixes for group_by_use_nulls [#63405](https://github.com/ClickHouse/ClickHouse/pull/63405) ([vdimir](https://github.com/vdimir)).
- Fix backup/restore of projection part in case projection was removed from table metadata, but part still has projection [#63426](https://github.com/ClickHouse/ClickHouse/pull/63426) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix mysql dictionary source [#63481](https://github.com/ClickHouse/ClickHouse/pull/63481) ([vdimir](https://github.com/vdimir)).
- Insert QueryFinish on AsyncInsertFlush with no data [#63483](https://github.com/ClickHouse/ClickHouse/pull/63483) ([Raúl Marín](https://github.com/Algunenano)).
- Fix: empty used_dictionaries in system.query_log [#63487](https://github.com/ClickHouse/ClickHouse/pull/63487) ([Eduard Karacharov](https://github.com/korowa)).
- Make `MergeTreePrefetchedReadPool` safer [#63513](https://github.com/ClickHouse/ClickHouse/pull/63513) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix crash on exit with sentry enabled (due to openssl destroyed before sentry) [#63548](https://github.com/ClickHouse/ClickHouse/pull/63548) ([Azat Khuzhin](https://github.com/azat)).
- Fix Array and Map support with Keyed hashing [#63628](https://github.com/ClickHouse/ClickHouse/pull/63628) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
- Fix filter pushdown for Parquet and maybe StorageMerge [#63642](https://github.com/ClickHouse/ClickHouse/pull/63642) ([Michael Kolupaev](https://github.com/al13n321)).
- Prevent conversion to Replicated if zookeeper path already exists [#63670](https://github.com/ClickHouse/ClickHouse/pull/63670) ([Kirill](https://github.com/kirillgarbar)).
- Analyzer: views read only necessary columns [#63688](https://github.com/ClickHouse/ClickHouse/pull/63688) ([Maksim Kita](https://github.com/kitaisreal)).
- Analyzer: Forbid WINDOW redefinition [#63694](https://github.com/ClickHouse/ClickHouse/pull/63694) ([Dmitry Novik](https://github.com/novikd)).
- flatten_nested was broken with the experimental Replicated database. [#63695](https://github.com/ClickHouse/ClickHouse/pull/63695) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix [#63653](https://github.com/ClickHouse/ClickHouse/issues/63653) [#63722](https://github.com/ClickHouse/ClickHouse/pull/63722) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Allow cast from Array(Nothing) to Map(Nothing, Nothing) [#63753](https://github.com/ClickHouse/ClickHouse/pull/63753) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix ILLEGAL_COLUMN in partial_merge join [#63755](https://github.com/ClickHouse/ClickHouse/pull/63755) ([vdimir](https://github.com/vdimir)).
- Fix: remove redundant distinct with window functions [#63776](https://github.com/ClickHouse/ClickHouse/pull/63776) ([Igor Nikonov](https://github.com/devcrafter)).
- Fix possible crash with SYSTEM UNLOAD PRIMARY KEY [#63778](https://github.com/ClickHouse/ClickHouse/pull/63778) ([Raúl Marín](https://github.com/Algunenano)).
- Fix a query with duplicating cycling alias. [#63791](https://github.com/ClickHouse/ClickHouse/pull/63791) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Make `TokenIterator` lazy as it should be [#63801](https://github.com/ClickHouse/ClickHouse/pull/63801) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Add `endpoint_subpath` S3 URI setting [#63806](https://github.com/ClickHouse/ClickHouse/pull/63806) ([Julia Kartseva](https://github.com/jkartseva)).
- Fix deadlock in `ParallelReadBuffer` [#63814](https://github.com/ClickHouse/ClickHouse/pull/63814) ([Antonio Andelic](https://github.com/antonio2368)).
- JOIN filter push down equivalent columns fix [#63819](https://github.com/ClickHouse/ClickHouse/pull/63819) ([Maksim Kita](https://github.com/kitaisreal)).
- Remove data from all disks after DROP with Lazy database. [#63848](https://github.com/ClickHouse/ClickHouse/pull/63848) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
- Fix incorrect result when reading from MV with parallel replicas and new analyzer [#63861](https://github.com/ClickHouse/ClickHouse/pull/63861) ([Nikita Taranov](https://github.com/nickitat)).
- Fixes in `find_super_nodes` and `find_big_family` command of keeper-client [#63862](https://github.com/ClickHouse/ClickHouse/pull/63862) ([Alexander Gololobov](https://github.com/davenger)).
- Update lambda execution name [#63864](https://github.com/ClickHouse/ClickHouse/pull/63864) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix SIGSEGV due to CPU/Real profiler [#63865](https://github.com/ClickHouse/ClickHouse/pull/63865) ([Azat Khuzhin](https://github.com/azat)).
- Fix `EXPLAIN CURRENT TRANSACTION` query [#63926](https://github.com/ClickHouse/ClickHouse/pull/63926) ([Anton Popov](https://github.com/CurtizJ)).
- Fix analyzer: there's turtles all the way down... [#63930](https://github.com/ClickHouse/ClickHouse/pull/63930) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Allow certain ALTER TABLE commands for `plain_rewritable` disk [#63933](https://github.com/ClickHouse/ClickHouse/pull/63933) ([Julia Kartseva](https://github.com/jkartseva)).
- Recursive CTE distributed fix [#63939](https://github.com/ClickHouse/ClickHouse/pull/63939) ([Maksim Kita](https://github.com/kitaisreal)).
- Analyzer: Fix COLUMNS resolve [#63962](https://github.com/ClickHouse/ClickHouse/pull/63962) ([Dmitry Novik](https://github.com/novikd)).
- LIMIT BY and skip_unused_shards with analyzer [#63983](https://github.com/ClickHouse/ClickHouse/pull/63983) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- A fix for some trash (experimental Kusto) [#63992](https://github.com/ClickHouse/ClickHouse/pull/63992) ([Yong Wang](https://github.com/kashwy)).
- Deserialize untrusted binary inputs in a safer way [#64024](https://github.com/ClickHouse/ClickHouse/pull/64024) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix query analysis for queries with the setting `final` = 1 for Distributed tables over tables from other than the MergeTree family. [#64037](https://github.com/ClickHouse/ClickHouse/pull/64037) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Add missing settings to recoverLostReplica [#64040](https://github.com/ClickHouse/ClickHouse/pull/64040) ([Raúl Marín](https://github.com/Algunenano)).
- Fix SQL security access checks with analyzer [#64079](https://github.com/ClickHouse/ClickHouse/pull/64079) ([pufit](https://github.com/pufit)).
- Fix analyzer: only interpolate expression should be used for DAG [#64096](https://github.com/ClickHouse/ClickHouse/pull/64096) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix azure backup writing multipart blocks by 1 MiB (read buffer size) instead of `max_upload_part_size` (in non-native copy case) [#64117](https://github.com/ClickHouse/ClickHouse/pull/64117) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Correctly fallback during backup copy [#64153](https://github.com/ClickHouse/ClickHouse/pull/64153) ([Antonio Andelic](https://github.com/antonio2368)).
- Prevent LOGICAL_ERROR on CREATE TABLE as materialized view [#64174](https://github.com/ClickHouse/ClickHouse/pull/64174) ([Raúl Marín](https://github.com/Algunenano)).
- Query Cache: Consider identical queries against different databases as different [#64199](https://github.com/ClickHouse/ClickHouse/pull/64199) ([Robert Schulze](https://github.com/rschu1ze)).
- Ignore `text_log` for Keeper [#64218](https://github.com/ClickHouse/ClickHouse/pull/64218) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix Logical error: Bad cast for Buffer table with prewhere. [#64388](https://github.com/ClickHouse/ClickHouse/pull/64388) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).

### <a id="244"></a> ClickHouse release 24.4, 2024-04-30 {#a-id244a-clickhouse-release-244-2024-04-30}

#### アップグレード時の注意事項 {#upgrade-notes}

- `clickhouse-odbc-bridge`と`clickhouse-library-bridge`が別パッケージになりました。これにより[#61677](https://github.com/ClickHouse/ClickHouse/issues/61677)が解決されます。[#62114](https://github.com/ClickHouse/ClickHouse/pull/62114) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- max_parallel_replicas(レプリカからの実験的な並列読み取り用)を`0`に設定できないようにしました。意味がないためです。[#60140](https://github.com/ClickHouse/ClickHouse/issues/60140)を解決します。[#61201](https://github.com/ClickHouse/ClickHouse/pull/61201) ([Kruglov Pavel](https://github.com/Avogar))。
- `INSERT WATCH`クエリ(非推奨の`LIVE VIEW`機能の一部)のサポートを削除しました。[#62382](https://github.com/ClickHouse/ClickHouse/pull/62382) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `optimize_monotonous_functions_in_order_by`設定を削除しました。[#63004](https://github.com/ClickHouse/ClickHouse/pull/63004) ([Raúl Marín](https://github.com/Algunenano))。
- `Replicated`データベースエンジンから実験的タグを削除しました。現在はベータ段階です。[#62937](https://github.com/ClickHouse/ClickHouse/pull/62937) ([Justin de Guzman](https://github.com/justindeguzman))。


#### 新機能 {#new-feature-8}

- 再帰的CTEをサポート。[#62074](https://github.com/ClickHouse/ClickHouse/pull/62074) ([Maksim Kita](https://github.com/kitaisreal))。
- `QUALIFY`句をサポート。[#47819](https://github.com/ClickHouse/ClickHouse/issues/47819)をクローズ。[#62619](https://github.com/ClickHouse/ClickHouse/pull/62619) ([Maksim Kita](https://github.com/kitaisreal))。
- テーブルエンジンに対する権限付与が可能になりました。既存ユーザーの動作には影響しません。[#60117](https://github.com/ClickHouse/ClickHouse/pull/60117) ([jsc0218](https://github.com/jsc0218))。
- INSERT操作をサポートし、ローカルに保存されたメタデータを必要としない書き換え可能なS3ディスクを追加。[#61116](https://github.com/ClickHouse/ClickHouse/pull/61116) ([Julia Kartseva](https://github.com/jkartseva))。主な用途はシステムテーブル向けです。
- クライアントでの入力時の構文ハイライトが構文レベルで動作するようになりました(以前は字句解析レベルで動作していました)。[#62123](https://github.com/ClickHouse/ClickHouse/pull/62123) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `DROP TABLE a, b, c`のように複数のテーブルを同時に削除することをサポート。[#58705](https://github.com/ClickHouse/ClickHouse/pull/58705) ([zhongyuankai](https://github.com/zhongyuankai))。
- `ALTER MODIFY SETTING`を使用したメモリテーブル設定の変更をサポート。例: `ALTER TABLE memory MODIFY SETTING min_rows_to_keep = 100, max_rows_to_keep = 1000;`。[#62039](https://github.com/ClickHouse/ClickHouse/pull/62039) ([zhongyuankai](https://github.com/zhongyuankai))。
- HTTPインターフェースに`role`クエリパラメータを追加。`SET ROLE x`と同様に動作し、ステートメント実行前にロールを適用します。これにより、複数のステートメントが許可されず、`SET ROLE x`とステートメント自体を同時に送信できないというHTTPインターフェースの制限を克服できます。この方法で複数のロールを設定することも可能で、例えば`?role=x&role=y`は`SET ROLE x, y`と同等になります。[#62669](https://github.com/ClickHouse/ClickHouse/pull/62669) ([Serge Klochkov](https://github.com/slvrtrn))。
- テーブルのプライマリキーのメモリ使用量を解放する`SYSTEM UNLOAD PRIMARY KEY`を追加。[#62738](https://github.com/ClickHouse/ClickHouse/pull/62738) ([Pablo Marcos](https://github.com/pamarcos))。
- `system.text_log`に`value1`、`value2`、...、`value10`カラムを追加。これらのカラムには、メッセージのフォーマットに使用された値が含まれます。[#59619](https://github.com/ClickHouse/ClickHouse/pull/59619) ([Alexey Katsman](https://github.com/alexkats))。
- 挿入時に割り当てられたブロック内の元の行番号を保存する永続的仮想カラム`_block_offset`を追加。`_block_offset`カラムの永続性は、MergeTree設定`enable_block_offset_column`で有効化できます。パートの最小ブロック番号またはミューテーションバージョンを含む仮想カラム`_part_data_version`を追加。永続的仮想カラム`_block_number`は実験的機能とは見なされなくなりました。[#60676](https://github.com/ClickHouse/ClickHouse/pull/60676) ([Anton Popov](https://github.com/CurtizJ))。
- 設定`input_format_json_throw_on_bad_escape_sequence`を追加。これを無効にすると、JSON入力フォーマットで不正なエスケープシーケンスを保存できます。[#61889](https://github.com/ClickHouse/ClickHouse/pull/61889) ([Kruglov Pavel](https://github.com/Avogar))。


#### パフォーマンス改善 {#performance-improvement-8}

- 等価集合を使用したJOINフィルタプッシュダウンの改善。[#61216](https://github.com/ClickHouse/ClickHouse/pull/61216) ([Maksim Kita](https://github.com/kitaisreal))。
- JOIN後のフィルタが常にデフォルト値をフィルタリングする場合、OUTER JOINをINNER JOINに変換する最適化。この最適化は設定`query_plan_convert_outer_join_to_inner_join`で制御でき、デフォルトで有効です。[#62907](https://github.com/ClickHouse/ClickHouse/pull/62907) ([Maksim Kita](https://github.com/kitaisreal))。
- AWS S3の改善。クライアントはサーバーに'Keep-Alive: timeout=X'ヘッダーを送信する必要があります。クライアントがサーバーからそのヘッダーを含むレスポンスを受信した場合、サーバーからの値を使用する必要があります。また、接続クローズの競合を避けるため、有効期限が近い接続を使用しないことが推奨されます。[#62249](https://github.com/ClickHouse/ClickHouse/pull/62249) ([Sema Checherinda](https://github.com/CheSema))。
- SELECTに対するミューテーションのオーバーヘッドを削減（v2）。[#60856](https://github.com/ClickHouse/ClickHouse/pull/60856) ([Azat Khuzhin](https://github.com/azat))。
- PODArrayで頻繁に呼び出される関数が強制的にインライン化されるようになりました。[#61144](https://github.com/ClickHouse/ClickHouse/pull/61144) ([李扬](https://github.com/taiyang-li))。
- 必要なすべての列が読み取られた時点でオブジェクトの残りをスキップすることで、JSONの解析を高速化。[#62210](https://github.com/ClickHouse/ClickHouse/pull/62210) ([lgbo](https://github.com/lgbo-ustc))。
- file/s3/hdfs/url/...テーブル関数のファイルからの単純なinsert selectを改善。並列解析で使用されるスレッド数を制御するための個別のmax_parsing_threads設定を追加。[#62404](https://github.com/ClickHouse/ClickHouse/pull/62404) ([Kruglov Pavel](https://github.com/Avogar))。
- 関数`to_utc_timestamp`と`from_utc_timestamp`が約2倍高速になりました。[#62583](https://github.com/ClickHouse/ClickHouse/pull/62583) ([KevinyhZou](https://github.com/KevinyhZou))。
- 関数`parseDateTimeOrNull`、`parseDateTimeOrZero`、`parseDateTimeInJodaSyntaxOrNull`、`parseDateTimeInJodaSyntaxOrZero`は、入力に解析不可能な値が多く含まれる場合、大幅に高速化されました（10倍～1000倍）。[#62634](https://github.com/ClickHouse/ClickHouse/pull/62634) ([LiuNeng](https://github.com/liuneng1994))。
- クエリキャッシュに多数のエントリ（例:100,000以上）が含まれている場合、`system.query_cache`に対するSELECTが顕著に高速化されました。[#62671](https://github.com/ClickHouse/ClickHouse/pull/62671) ([Robert Schulze](https://github.com/rschu1ze))。
- ファイルシステムキャッシュの競合削減（パート3）:スペース予約試行時にロックなしでファイルシステムからの削除を実行。[#61163](https://github.com/ClickHouse/ClickHouse/pull/61163) ([Kseniia Sumarokova](https://github.com/kssenii))。
- ファイルシステムキャッシュの動的リサイズを高速化。[#61723](https://github.com/ClickHouse/ClickHouse/pull/61723) ([Kseniia Sumarokova](https://github.com/kssenii))。
- `INVALIDATE_QUERY`を持つディクショナリソースが起動時に2回リロードされないようになりました。[#62050](https://github.com/ClickHouse/ClickHouse/pull/62050) ([vdimir](https://github.com/vdimir))。
- プライマリキーを含むブール式の後に冗長な`= 1`または`= 0`が追加された場合にプライマリインデックスが使用されない問題を修正。例えば、`SELECT * FROM <table> WHERE <primary-key> IN (<value>) = 1`と`SELECT * FROM <table> WHERE <primary-key> NOT IN (<value>) = 0`の両方が、プライマリインデックスを使用できるにもかかわらず、フルテーブルスキャンを実行していました。[#62142](https://github.com/ClickHouse/ClickHouse/pull/62142) ([josh-hildred](https://github.com/josh-hildred))。
- `system.remote_data_paths`から結果全体を1つの大きなチャンクに蓄積する代わりに、チャンクのストリームを返すようになりました。これにより、メモリ消費量が削減され、中間進捗の表示とクエリのキャンセルが可能になります。[#62613](https://github.com/ClickHouse/ClickHouse/pull/62613) ([Alexander Gololobov](https://github.com/davenger))。

#### 実験的機能 {#experimental-feature-6}

- `azure_allow_parallel_part_upload`設定によって管理されるAzure Blob Storage向けの並列書き込みバッファをサポート。[#62534](https://github.com/ClickHouse/ClickHouse/pull/62534) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
- ユーザー空間ページキャッシュが静的Webストレージ(`disk(type = web)`)で動作するようになりました。有効にするには、クライアント設定`use_page_cache_for_disks_without_file_cache=1`を使用します。[#61911](https://github.com/ClickHouse/ClickHouse/pull/61911) ([Michael Kolupaev](https://github.com/al13n321))。
- `Variant`型において、Bool型と数値型のバリアントを疑わしいものとして扱わないようにしました。[#61999](https://github.com/ClickHouse/ClickHouse/pull/61999) ([Kruglov Pavel](https://github.com/Avogar))。
- パースを使用したStringから`Variant`へのより適切な変換を実装。[#62005](https://github.com/ClickHouse/ClickHouse/pull/62005) ([Kruglov Pavel](https://github.com/Avogar))。
- JSONExtract関数で`Variant`をサポート。[#62014](https://github.com/ClickHouse/ClickHouse/pull/62014) ([Kruglov Pavel](https://github.com/Avogar))。
- `Variant`型を比較可能としてマークし、プライマリキーで使用できるようにしました。[#62693](https://github.com/ClickHouse/ClickHouse/pull/62693) ([Kruglov Pavel](https://github.com/Avogar))。


#### 改善 {#improvement-8}

- 利便性のため、`SELECT * FROM numbers()` は `SELECT * FROM system.numbers` と同じように動作します（制限なし）。[#61969](https://github.com/ClickHouse/ClickHouse/pull/61969) ([YenchangChan](https://github.com/YenchangChan))。
- Kafka設定に個別のconsumer/producerタグを導入しました。これにより、librdkafka（多くのバグを持つ問題のあるCライブラリ）から、consumerプロパティがproducerインスタンスに指定された場合やその逆の場合に発生する警告（例：`Configuration property session.timeout.ms is a consumer property and will be ignored by this producer instance`）を回避できます。クローズ：[#58983](https://github.com/ClickHouse/ClickHouse/issues/58983)。[#58956](https://github.com/ClickHouse/ClickHouse/pull/58956) ([Aleksandr Musorin](https://github.com/AVMusorin))。
- 関数 `date_diff` と `age` は、マイクロ秒精度ではなくナノ秒精度で結果を計算するようになりました。また、`unit` パラメータの値として `nanosecond`（または `nanoseconds` または `ns`）を指定できるようになりました。[#61409](https://github.com/ClickHouse/ClickHouse/pull/61409) ([Austin Kothig](https://github.com/kothiga))。
- `date_trunc` にナノ秒、マイクロ秒、ミリ秒の単位を追加しました。[#62335](https://github.com/ClickHouse/ClickHouse/pull/62335) ([Misz606](https://github.com/Misz606))。
- 証明書の再読み込み時に証明書チェーンを再読み込みするようにしました。[#61671](https://github.com/ClickHouse/ClickHouse/pull/61671) ([Pervakov Grigorii](https://github.com/GrigoryPervakov))。
- そのレプリカパスにアクティブなレプリカが存在する場合、テーブルのアタッチを許可しないことで、エラー [#60432](https://github.com/ClickHouse/ClickHouse/issues/60432) を防止するようにしました。[#61876](https://github.com/ClickHouse/ClickHouse/pull/61876) ([Arthur Passos](https://github.com/arthurpassos))。
- `clickhouse-local` の `input` のサポートを実装しました。[#61923](https://github.com/ClickHouse/ClickHouse/pull/61923) ([Azat Khuzhin](https://github.com/azat))。
- strictness `ANY` を持つ `Join` テーブルエンジンは、再読み込み後も一貫性を保つようになりました。同じキーを持つ複数の行が挿入された場合、最初の行が優先されます（以前は、テーブル読み込み時にランダムに選択されていました）。クローズ [#51027](https://github.com/ClickHouse/ClickHouse/issues/51027)。[#61972](https://github.com/ClickHouse/ClickHouse/pull/61972) ([vdimir](https://github.com/vdimir))。
- Apache ArrowスキーマからNullableカラム型を自動的に推論するようにしました。[#61984](https://github.com/ClickHouse/ClickHouse/pull/61984) ([Maksim Kita](https://github.com/kitaisreal))。
- 集約中の集約状態の並列マージをキャンセルできるようにしました。例：`uniqExact`。[#61992](https://github.com/ClickHouse/ClickHouse/pull/61992) ([Maksim Kita](https://github.com/kitaisreal))。
- `system.keywords` を使用して候補を補完し、内部的にもすべての箇所で使用するようにしました。[#62000](https://github.com/ClickHouse/ClickHouse/pull/62000) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- `ReplicatedMergeTree` の `OPTIMIZE FINAL` は、現在アクティブなマージが完了するまで待機し、その後最終マージのスケジュールを再試行するようになりました。これにより、通常の `MergeTree` の動作により近づきます。[#62067](https://github.com/ClickHouse/ClickHouse/pull/62067) ([Nikita Taranov](https://github.com/nickitat))。
- hiveテキストファイルからデータを読み取る際、hiveテキストファイルの最初の行を使用して入力フィールド数をリサイズしていましたが、最初の行のフィールド数がhiveテーブルの定義と一致しない場合がありました。例えば、hiveテーブルが `test_tbl(a Int32, b Int32, c Int32)` のように3列で定義されているのに、テキストファイルの最初の行が2フィールドしかない場合、入力フィールドは2にリサイズされ、次の行に3フィールドがあっても、3番目のフィールドは読み取られずデフォルト値0が設定されてしまい、これは正しくありませんでした。この問題を修正しました。[#62086](https://github.com/ClickHouse/ClickHouse/pull/62086) ([KevinyhZou](https://github.com/KevinyhZou))。
- `CREATE AS` はテーブルのコメントをコピーするようにしました。[#62117](https://github.com/ClickHouse/ClickHouse/pull/62117) ([Pablo Marcos](https://github.com/pamarcos))。
- テーブルzookeeperにクエリの進行状況を追加しました。[#62152](https://github.com/ClickHouse/ClickHouse/pull/62152) ([JackyWoo](https://github.com/JackyWoo))。
- トレースコレクター（RealとCPU）をサーバー全体で有効にする機能を追加しました。[#62189](https://github.com/ClickHouse/ClickHouse/pull/62189) ([alesapin](https://github.com/alesapin))。
- 設定 `lightweight_deletes_sync`（デフォルト値：2 - すべてのレプリカを同期的に待機）を追加しました。これは設定 `mutations_sync` に似ていますが、軽量削除の動作にのみ影響します。[#62195](https://github.com/ClickHouse/ClickHouse/pull/62195) ([Anton Popov](https://github.com/CurtizJ))。
- カスタム設定の値を解析する際に、ブール値と整数を区別するようにしました：`SET custom_a = true; SET custom_b = 1;`。[#62206](https://github.com/ClickHouse/ClickHouse/pull/62206) ([Vitaly Baranov](https://github.com/vitlibar))。
- AWS Private Link InterfaceエンドポイントによるS3アクセスをサポートしました。クローズ [#60021](https://github.com/ClickHouse/ClickHouse/issues/60021)、[#31074](https://github.com/ClickHouse/ClickHouse/issues/31074)、[#53761](https://github.com/ClickHouse/ClickHouse/issues/53761)。[#62208](https://github.com/ClickHouse/ClickHouse/pull/62208) ([Arthur Passos](https://github.com/arthurpassos))。
- clickhouse-clientでUDF用のディレクトリが存在しない場合、作成しないようにしました。これにより [#59597](https://github.com/ClickHouse/ClickHouse/issues/59597) がクローズされます。[#62366](https://github.com/ClickHouse/ClickHouse/pull/62366) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- クエリキャッシュは、システムテーブル（`system.*`、`information_schema.*`、`INFORMATION_SCHEMA.*`）に対するクエリの結果をキャッシュしなくなりました。[#62376](https://github.com/ClickHouse/ClickHouse/pull/62376) ([Robert Schulze](https://github.com/rschu1ze))。
- `MOVE PARTITION TO TABLE` クエリは、パート数の制限を超えないように遅延させるか、`TOO_MANY_PARTS` 例外をスローできるようになりました。`INSERT` クエリと同じ設定と制限が適用されます（`max_parts_in_total`、`parts_to_delay_insert`、`parts_to_throw_insert`、`inactive_parts_to_throw_insert`、`inactive_parts_to_delay_insert`、`max_avg_part_size_for_too_many_parts`、`min_delay_to_insert_ms`、`max_delay_to_insert` 設定を参照）。[#62420](https://github.com/ClickHouse/ClickHouse/pull/62420) ([Sergei Trifonov](https://github.com/serxa))。
- macOSでのデフォルトインストールディレクトリを `/usr/bin` から `/usr/local/bin` に変更しました。これは、macOS El Capitan（2015年）で導入されたAppleのSystem Integrity Protectionが、`sudo` を使用しても `/usr/bin` への書き込みを防ぐために必要です。[#62489](https://github.com/ClickHouse/ClickHouse/pull/62489) ([haohang](https://github.com/yokofly))。
- transform関数が常に最初のマッチを返すようにしました。[#62518](https://github.com/ClickHouse/ClickHouse/pull/62518) ([Raúl Marín](https://github.com/Algunenano))。
- システムテーブル `blob_storage_log` に欠落していた `hostname` カラムを追加しました。[#62456](https://github.com/ClickHouse/ClickHouse/pull/62456) ([Jayme Bird](https://github.com/jaymebrd))。
- 他のシステムテーブルとの一貫性のため、`system.backup_log` に `event_time` カラムを追加しました。[#62541](https://github.com/ClickHouse/ClickHouse/pull/62541) ([Jayme Bird](https://github.com/jaymebrd))。
- テーブル `system.backup_log` は、他の `_log` テーブルエンジンと同様に、「デフォルト」のソートキー `event_date, event_time` を持つようになりました。[#62667](https://github.com/ClickHouse/ClickHouse/pull/62667) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- `RESTORE` の実行中にテーブルのDEFAULT式を評価しないようにしました。[#62601](https://github.com/ClickHouse/ClickHouse/pull/62601) ([Vitaly Baranov](https://github.com/vitlibar))。
- S3ストレージとバックアップも、s3ディスクと同じデフォルトのキープアライブ設定が必要です。[#62648](https://github.com/ClickHouse/ClickHouse/pull/62648) ([Sema Checherinda](https://github.com/CheSema))。
- librdkafka（多くのバグを持つ悪名高いCライブラリ）のクライアント識別子をログメッセージに追加し、単一テーブルの異なるコンシューマーからのログメッセージを区別できるようにしました。[#62813](https://github.com/ClickHouse/ClickHouse/pull/62813) ([János Benjamin Antal](https://github.com/antaljanosbenjamin))。
- ReplicatedデータベースのZooKeeperパスで特殊マクロ `{uuid}` と `{database}` を使用できるようにしました。[#62818](https://github.com/ClickHouse/ClickHouse/pull/62818) ([Vitaly Baranov](https://github.com/vitlibar))。
- HTTPリクエストで異なる認証スキームを持つクォータキーを許可するようにしました。[#62842](https://github.com/ClickHouse/ClickHouse/pull/62842) ([Kseniia Sumarokova](https://github.com/kssenii))。
- `clickhouse client` と `clickhouse local` のコマンドライン引数 `--help` の冗長性を削減しました。以前の出力は `--help --verbose` で生成されるようになりました。[#62973](https://github.com/ClickHouse/ClickHouse/pull/62973) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- `log_bin_use_v1_row_events` はMySQL 8.3で削除されたため、実験的な `MaterializedMySQL` エンジンをそれに合わせて調整しました [#60479](https://github.com/ClickHouse/ClickHouse/issues/60479)。[#63101](https://github.com/ClickHouse/ClickHouse/pull/63101) ([Eugene Klimov](https://github.com/Slach))。作成者：Nikolay Yankin。





#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-4}

- Rust依存関係をベンダリングし、Rustコード(話題性と楽しみのために使用しているマイナー機能用)をC++と同様に適切な方法でビルドできるようにしました。[#62297](https://github.com/ClickHouse/ClickHouse/pull/62297) ([Raúl Marín](https://github.com/Algunenano))。
- ClickHouseはBoringSSLの代わりにOpenSSL 3.2を使用するようになりました。[#59870](https://github.com/ClickHouse/ClickHouse/pull/59870) ([Robert Schulze](https://github.com/rschu1ze))。なお、OpenSSLは一般的にエンジニアリング文化が劣っています(パッチを適用する必要があったサニタイザーレポートの存在、生成ファイルを含む複雑なビルドシステムなど)が、互換性は優れています。
- ストレステストでDROPクエリを1/2の確率で無視し、Memory/JOINテーブルのアップグレードチェックではDROPを無視する代わりにTRUNCATEを使用するようにしました。[#61476](https://github.com/ClickHouse/ClickHouse/pull/61476) ([Kruglov Pavel](https://github.com/Avogar))。
- KeeperのDockerイメージから/etc/clickhouse-keeperおよび/var/log/clickhouse-keeperのボリュームを削除しました。[#61683](https://github.com/ClickHouse/ClickHouse/pull/61683) ([Tristan](https://github.com/Tristan971))。
- Analyzerがデフォルトで有効化されたことにより関連性がなくなったすべての問題に対するテストを追加しました。解決: [#55794](https://github.com/ClickHouse/ClickHouse/issues/55794) 解決: [#49472](https://github.com/ClickHouse/ClickHouse/issues/49472) 解決: [#44414](https://github.com/ClickHouse/ClickHouse/issues/44414) 解決: [#13843](https://github.com/ClickHouse/ClickHouse/issues/13843) 解決: [#55803](https://github.com/ClickHouse/ClickHouse/issues/55803) 解決: [#48308](https://github.com/ClickHouse/ClickHouse/issues/48308) 解決: [#45535](https://github.com/ClickHouse/ClickHouse/issues/45535) 解決: [#44365](https://github.com/ClickHouse/ClickHouse/issues/44365) 解決: [#44153](https://github.com/ClickHouse/ClickHouse/issues/44153) 解決: [#42399](https://github.com/ClickHouse/ClickHouse/issues/42399) 解決: [#27115](https://github.com/ClickHouse/ClickHouse/issues/27115) 解決: [#23162](https://github.com/ClickHouse/ClickHouse/issues/23162) 解決: [#15395](https://github.com/ClickHouse/ClickHouse/issues/15395) 解決: [#15411](https://github.com/ClickHouse/ClickHouse/issues/15411) 解決: [#14978](https://github.com/ClickHouse/ClickHouse/issues/14978) 解決: [#17319](https://github.com/ClickHouse/ClickHouse/issues/17319) 解決: [#11813](https://github.com/ClickHouse/ClickHouse/issues/11813) 解決: [#13210](https://github.com/ClickHouse/ClickHouse/issues/13210) 解決: [#23053](https://github.com/ClickHouse/ClickHouse/issues/23053) 解決: [#37729](https://github.com/ClickHouse/ClickHouse/issues/37729) 解決: [#32639](https://github.com/ClickHouse/ClickHouse/issues/32639) 解決: [#9954](https://github.com/ClickHouse/ClickHouse/issues/9954) 解決: [#41964](https://github.com/ClickHouse/ClickHouse/issues/41964) 解決: [#54317](https://github.com/ClickHouse/ClickHouse/issues/54317) 解決: [#7520](https://github.com/ClickHouse/ClickHouse/issues/7520) 解決: [#36973](https://github.com/ClickHouse/ClickHouse/issues/36973) 解決: [#40955](https://github.com/ClickHouse/ClickHouse/issues/40955) 解決: [#19687](https://github.com/ClickHouse/ClickHouse/issues/19687) 解決: [#23104](https://github.com/ClickHouse/ClickHouse/issues/23104) 解決: [#21584](https://github.com/ClickHouse/ClickHouse/issues/21584) 解決: [#23344](https://github.com/ClickHouse/ClickHouse/issues/23344) 解決: [#22627](https://github.com/ClickHouse/ClickHouse/issues/22627) 解決: [#10276](https://github.com/ClickHouse/ClickHouse/issues/10276) 解決: [#19687](https://github.com/ClickHouse/ClickHouse/issues/19687) 解決: [#4567](https://github.com/ClickHouse/ClickHouse/issues/4567) 解決: [#17710](https://github.com/ClickHouse/ClickHouse/issues/17710) 解決: [#11068](https://github.com/ClickHouse/ClickHouse/issues/11068) 解決: [#24395](https://github.com/ClickHouse/ClickHouse/issues/24395) 解決: [#23416](https://github.com/ClickHouse/ClickHouse/issues/23416) 解決: [#23162](https://github.com/ClickHouse/ClickHouse/issues/23162) 解決: [#25655](https://github.com/ClickHouse/ClickHouse/issues/25655) 解決: [#11757](https://github.com/ClickHouse/ClickHouse/issues/11757) 解決: [#6571](https://github.com/ClickHouse/ClickHouse/issues/6571) 解決: [#4432](https://github.com/ClickHouse/ClickHouse/issues/4432) 解決: [#8259](https://github.com/ClickHouse/ClickHouse/issues/8259) 解決: [#9233](https://github.com/ClickHouse/ClickHouse/issues/9233) 解決: [#14699](https://github.com/ClickHouse/ClickHouse/issues/14699) 解決: [#27068](https://github.com/ClickHouse/ClickHouse/issues/27068) 解決: [#28687](https://github.com/ClickHouse/ClickHouse/issues/28687) 解決: [#28777](https://github.com/ClickHouse/ClickHouse/issues/28777) 解決: [#29734](https://github.com/ClickHouse/ClickHouse/issues/29734) 解決: [#61238](https://github.com/ClickHouse/ClickHouse/issues/61238) 解決: [#33825](https://github.com/ClickHouse/ClickHouse/issues/33825) 解決: [#35608](https://github.com/ClickHouse/ClickHouse/issues/35608) 解決: [#29838](https://github.com/ClickHouse/ClickHouse/issues/29838) 解決: [#35652](https://github.com/ClickHouse/ClickHouse/issues/35652) 解決: [#36189](https://github.com/ClickHouse/ClickHouse/issues/36189) 解決: [#39634](https://github.com/ClickHouse/ClickHouse/issues/39634) 解決: [#47432](https://github.com/ClickHouse/ClickHouse/issues/47432) 解決: [#54910](https://github.com/ClickHouse/ClickHouse/issues/54910) 解決: [#57321](https://github.com/ClickHouse/ClickHouse/issues/57321) 解決: [#59154](https://github.com/ClickHouse/ClickHouse/issues/59154) 解決: [#61014](https://github.com/ClickHouse/ClickHouse/issues/61014) 解決: [#61950](https://github.com/ClickHouse/ClickHouse/issues/61950) 解決: [#55647](https://github.com/ClickHouse/ClickHouse/issues/55647) 解決: [#61947](https://github.com/ClickHouse/ClickHouse/issues/61947)。[#62185](https://github.com/ClickHouse/ClickHouse/pull/62185) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- Analyzerによって関連性がなくなった、または修正された問題からさらにテストを追加しました。解決: [#58985](https://github.com/ClickHouse/ClickHouse/issues/58985) 解決: [#59549](https://github.com/ClickHouse/ClickHouse/issues/59549) 解決: [#36963](https://github.com/ClickHouse/ClickHouse/issues/36963) 解決: [#39453](https://github.com/ClickHouse/ClickHouse/issues/39453) 解決: [#56521](https://github.com/ClickHouse/ClickHouse/issues/56521) 解決: [#47552](https://github.com/ClickHouse/ClickHouse/issues/47552) 解決: [#56503](https://github.com/ClickHouse/ClickHouse/issues/56503) 解決: [#59101](https://github.com/ClickHouse/ClickHouse/issues/59101) 解決: [#50271](https://github.com/ClickHouse/ClickHouse/issues/50271) 解決: [#54954](https://github.com/ClickHouse/ClickHouse/issues/54954) 解決: [#56466](https://github.com/ClickHouse/ClickHouse/issues/56466) 解決: [#11000](https://github.com/ClickHouse/ClickHouse/issues/11000) 解決: [#10894](https://github.com/ClickHouse/ClickHouse/issues/10894) 解決: https://github.com/ClickHouse/ClickHouse/issues/448 解決: [#8030](https://github.com/ClickHouse/ClickHouse/issues/8030) 解決: [#32139](https://github.com/ClickHouse/ClickHouse/issues/32139) 解決: [#47288](https://github.com/ClickHouse/ClickHouse/issues/47288) 解決: [#50705](https://github.com/ClickHouse/ClickHouse/issues/50705) 解決: [#54511](https://github.com/ClickHouse/ClickHouse/issues/54511) 解決: [#55466](https://github.com/ClickHouse/ClickHouse/issues/55466) 解決: [#58500](https://github.com/ClickHouse/ClickHouse/issues/58500) 解決: [#39923](https://github.com/ClickHouse/ClickHouse/issues/39923) 解決: [#39855](https://github.com/ClickHouse/ClickHouse/issues/39855) 解決: [#4596](https://github.com/ClickHouse/ClickHouse/issues/4596) 解決: [#47422](https://github.com/ClickHouse/ClickHouse/issues/47422) 解決: [#33000](https://github.com/ClickHouse/ClickHouse/issues/33000) 解決: [#14739](https://github.com/ClickHouse/ClickHouse/issues/14739) 解決: [#44039](https://github.com/ClickHouse/ClickHouse/issues/44039) 解決: [#8547](https://github.com/ClickHouse/ClickHouse/issues/8547) 解決: [#22923](https://github.com/ClickHouse/ClickHouse/issues/22923) 解決: [#23865](https://github.com/ClickHouse/ClickHouse/issues/23865) 解決: [#29748](https://github.com/ClickHouse/ClickHouse/issues/29748) 解決: [#4222](https://github.com/ClickHouse/ClickHouse/issues/4222)。[#62457](https://github.com/ClickHouse/ClickHouse/pull/62457) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- OpenSSLが動的にリンクされている場合のビルドエラーを修正しました(注:これは一般的にサポートされておらず、IBMのs390xプラットフォームでのみ必要です)。[#62888](https://github.com/ClickHouse/ClickHouse/pull/62888) ([Harry Lee](https://github.com/HarryLeeIBM))。





#### バグ修正（公式安定版リリースにおけるユーザーに見える不具合） {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-6}

- Fix logical-error when undoing quorum insert transaction. [#61953](https://github.com/ClickHouse/ClickHouse/pull/61953) ([Han Fei](https://github.com/hanfei1991)).
- Fix parser error when using COUNT(\*) with FILTER clause [#61357](https://github.com/ClickHouse/ClickHouse/pull/61357) ([Duc Canh Le](https://github.com/canhld94)).
- Fix logical error in `group_by_use_nulls` + grouping sets + analyzer + materialize/constant [#61567](https://github.com/ClickHouse/ClickHouse/pull/61567) ([Kruglov Pavel](https://github.com/Avogar)).
- Cancel merges before removing moved parts [#61610](https://github.com/ClickHouse/ClickHouse/pull/61610) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fix abort in Apache Arrow [#61720](https://github.com/ClickHouse/ClickHouse/pull/61720) ([Kruglov Pavel](https://github.com/Avogar)).
- Search for `convert_to_replicated` flag at the correct path corresponding to the specific disk [#61769](https://github.com/ClickHouse/ClickHouse/pull/61769) ([Kirill](https://github.com/kirillgarbar)).
- Fix possible connections data-race for distributed_foreground_insert/distributed_background_insert_batch [#61867](https://github.com/ClickHouse/ClickHouse/pull/61867) ([Azat Khuzhin](https://github.com/azat)).
- Mark CANNOT_PARSE_ESCAPE_SEQUENCE error as parse error to be able to skip it in row input formats [#61883](https://github.com/ClickHouse/ClickHouse/pull/61883) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix writing exception message in output format in HTTP when http_wait_end_of_query is used [#61951](https://github.com/ClickHouse/ClickHouse/pull/61951) ([Kruglov Pavel](https://github.com/Avogar)).
- Proper fix for LowCardinality together with JSONExtact functions [#61957](https://github.com/ClickHouse/ClickHouse/pull/61957) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Crash in Engine Merge if Row Policy does not have expression [#61971](https://github.com/ClickHouse/ClickHouse/pull/61971) ([Ilya Golshtein](https://github.com/ilejn)).
- Fix WriteBufferAzureBlobStorage destructor uncaught exception [#61988](https://github.com/ClickHouse/ClickHouse/pull/61988) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Fix CREATE TABLE without columns definition for ReplicatedMergeTree [#62040](https://github.com/ClickHouse/ClickHouse/pull/62040) ([Azat Khuzhin](https://github.com/azat)).
- Fix optimize_skip_unused_shards_rewrite_in for composite sharding key [#62047](https://github.com/ClickHouse/ClickHouse/pull/62047) ([Azat Khuzhin](https://github.com/azat)).
- ReadWriteBufferFromHTTP set right header host when redirected [#62068](https://github.com/ClickHouse/ClickHouse/pull/62068) ([Sema Checherinda](https://github.com/CheSema)).
- Fix external table cannot parse data type Bool [#62115](https://github.com/ClickHouse/ClickHouse/pull/62115) ([Duc Canh Le](https://github.com/canhld94)).
- Analyzer: Fix query parameter resolution [#62186](https://github.com/ClickHouse/ClickHouse/pull/62186) ([Dmitry Novik](https://github.com/novikd)).
- Fix restoring parts while readonly [#62207](https://github.com/ClickHouse/ClickHouse/pull/62207) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix crash in index definition containing SQL UDF [#62225](https://github.com/ClickHouse/ClickHouse/pull/62225) ([vdimir](https://github.com/vdimir)).
- Fixing NULL random seed for generateRandom with analyzer. [#62248](https://github.com/ClickHouse/ClickHouse/pull/62248) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Correctly handle const columns in Distinct Transfom [#62250](https://github.com/ClickHouse/ClickHouse/pull/62250) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix Parts Splitter for queries with the FINAL modifier [#62268](https://github.com/ClickHouse/ClickHouse/pull/62268) ([Nikita Taranov](https://github.com/nickitat)).
- Analyzer: Fix alias to parametrized view resolution [#62274](https://github.com/ClickHouse/ClickHouse/pull/62274) ([Dmitry Novik](https://github.com/novikd)).
- Analyzer: Fix name resolution from parent scopes [#62281](https://github.com/ClickHouse/ClickHouse/pull/62281) ([Dmitry Novik](https://github.com/novikd)).
- Fix argMax with nullable non native numeric column [#62285](https://github.com/ClickHouse/ClickHouse/pull/62285) ([Raúl Marín](https://github.com/Algunenano)).
- Fix BACKUP and RESTORE of a materialized view in Ordinary database [#62295](https://github.com/ClickHouse/ClickHouse/pull/62295) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix data race on scalars in Context [#62305](https://github.com/ClickHouse/ClickHouse/pull/62305) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix primary key in materialized view [#62319](https://github.com/ClickHouse/ClickHouse/pull/62319) ([Murat Khairulin](https://github.com/mxwell)).
- Do not build multithread insert pipeline for tables without support [#62333](https://github.com/ClickHouse/ClickHouse/pull/62333) ([vdimir](https://github.com/vdimir)).
- Fix analyzer with positional arguments in distributed query [#62362](https://github.com/ClickHouse/ClickHouse/pull/62362) ([flynn](https://github.com/ucasfl)).
- Fix filter pushdown from additional_table_filters in Merge engine in analyzer [#62398](https://github.com/ClickHouse/ClickHouse/pull/62398) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix GLOBAL IN table queries with analyzer. [#62409](https://github.com/ClickHouse/ClickHouse/pull/62409) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Respect settings truncate_on_insert/create_new_file_on_insert in s3/hdfs/azure engines during partitioned write [#62425](https://github.com/ClickHouse/ClickHouse/pull/62425) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix backup restore path for AzureBlobStorage [#62447](https://github.com/ClickHouse/ClickHouse/pull/62447) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Fix SimpleSquashingChunksTransform [#62451](https://github.com/ClickHouse/ClickHouse/pull/62451) ([Nikita Taranov](https://github.com/nickitat)).
- Fix capture of nested lambda. [#62462](https://github.com/ClickHouse/ClickHouse/pull/62462) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Avoid crash when reading protobuf with recursive types [#62506](https://github.com/ClickHouse/ClickHouse/pull/62506) ([Raúl Marín](https://github.com/Algunenano)).
- Fix a bug moving one partition from one to itself [#62524](https://github.com/ClickHouse/ClickHouse/pull/62524) ([helifu](https://github.com/helifu)).
- Fix scalar subquery in LIMIT [#62567](https://github.com/ClickHouse/ClickHouse/pull/62567) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix segfault in the experimental and unsupported Hive engine, which we don't like anyway [#62578](https://github.com/ClickHouse/ClickHouse/pull/62578) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix memory leak in groupArraySorted [#62597](https://github.com/ClickHouse/ClickHouse/pull/62597) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix crash in largestTriangleThreeBuckets [#62646](https://github.com/ClickHouse/ClickHouse/pull/62646) ([Raúl Marín](https://github.com/Algunenano)).
- Fix tumble\[Start,End\] and hop\[Start,End\] for bigger resolutions [#62705](https://github.com/ClickHouse/ClickHouse/pull/62705) ([Jordi Villar](https://github.com/jrdi)).
- Fix argMin/argMax combinator state [#62708](https://github.com/ClickHouse/ClickHouse/pull/62708) ([Raúl Marín](https://github.com/Algunenano)).
- Fix temporary data in cache failing because of cache lock contention optimization [#62715](https://github.com/ClickHouse/ClickHouse/pull/62715) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix crash in function `mergeTreeIndex` [#62762](https://github.com/ClickHouse/ClickHouse/pull/62762) ([Anton Popov](https://github.com/CurtizJ)).
- fix: update: nested materialized columns: size check fixes [#62773](https://github.com/ClickHouse/ClickHouse/pull/62773) ([Eliot Hautefeuille](https://github.com/hileef)).
- Fix FINAL modifier is not respected in CTE with analyzer [#62811](https://github.com/ClickHouse/ClickHouse/pull/62811) ([Duc Canh Le](https://github.com/canhld94)).
- Fix crash in function `formatRow` with `JSON` format and HTTP interface [#62840](https://github.com/ClickHouse/ClickHouse/pull/62840) ([Anton Popov](https://github.com/CurtizJ)).
- Azure: fix building final url from endpoint object [#62850](https://github.com/ClickHouse/ClickHouse/pull/62850) ([Daniel Pozo Escalona](https://github.com/danipozo)).
- Fix GCD codec [#62853](https://github.com/ClickHouse/ClickHouse/pull/62853) ([Nikita Taranov](https://github.com/nickitat)).
- Fix LowCardinality(Nullable) key in hyperrectangle [#62866](https://github.com/ClickHouse/ClickHouse/pull/62866) ([Amos Bird](https://github.com/amosbird)).
- Fix fromUnixtimestamp in joda syntax while the input value beyond UInt32 [#62901](https://github.com/ClickHouse/ClickHouse/pull/62901) ([KevinyhZou](https://github.com/KevinyhZou)).
- Disable optimize_rewrite_aggregate_function_with_if for sum(nullable) [#62912](https://github.com/ClickHouse/ClickHouse/pull/62912) ([Raúl Marín](https://github.com/Algunenano)).
- Fix PREWHERE for StorageBuffer with different source table column types. [#62916](https://github.com/ClickHouse/ClickHouse/pull/62916) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix temporary data in cache incorrectly processing failure of cache key directory creation [#62925](https://github.com/ClickHouse/ClickHouse/pull/62925) ([Kseniia Sumarokova](https://github.com/kssenii)).
- gRPC: fix crash on IPv6 peer connection [#62978](https://github.com/ClickHouse/ClickHouse/pull/62978) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Fix possible CHECKSUM_DOESNT_MATCH (and others) during replicated fetches [#62987](https://github.com/ClickHouse/ClickHouse/pull/62987) ([Azat Khuzhin](https://github.com/azat)).
- Fix terminate with uncaught exception in temporary data in cache [#62998](https://github.com/ClickHouse/ClickHouse/pull/62998) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix optimize_rewrite_aggregate_function_with_if implicit cast [#62999](https://github.com/ClickHouse/ClickHouse/pull/62999) ([Raúl Marín](https://github.com/Algunenano)).
- Fix unhandled exception in ~RestorerFromBackup [#63040](https://github.com/ClickHouse/ClickHouse/pull/63040) ([Vitaly Baranov](https://github.com/vitlibar)).
- Do not remove server constants from GROUP BY key for secondary query. [#63047](https://github.com/ClickHouse/ClickHouse/pull/63047) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix incorrect judgement of of monotonicity of function abs [#63097](https://github.com/ClickHouse/ClickHouse/pull/63097) ([Duc Canh Le](https://github.com/canhld94)).
- Set server name for SSL handshake in MongoDB engine [#63122](https://github.com/ClickHouse/ClickHouse/pull/63122) ([Alexander Gololobov](https://github.com/davenger)).
- Use user specified db instead of "config" for MongoDB wire protocol version check [#63126](https://github.com/ClickHouse/ClickHouse/pull/63126) ([Alexander Gololobov](https://github.com/davenger)).

### <a id="243"></a> ClickHouse リリース 24.3 LTS, 2024-03-27 {#a-id243a-clickhouse-release-243-lts-2024-03-27}


#### アップグレード時の注意事項 {#upgrade-notes-1}

- 設定 `allow_experimental_analyzer` がデフォルトで有効になり、クエリ解析が新しい実装に切り替わります。この実装は互換性と機能の完全性が向上しています。「analyzer」機能は実験的ではなくベータ版と見なされます。`compatibility` を `24.2` に設定するか、`allow_experimental_analyzer` 設定を無効にすることで、以前の動作に戻すことができます。[YouTubeの動画](https://www.youtube.com/watch?v=zhrOYQpgvkk)をご覧ください。
- ClickHouseのString型は任意のバイナリデータを許容しますが、通常はUTF-8です。Parquet/ORC/ArrowのStringsはUTF-8のみをサポートします。そのため、ClickHouseのString型に対してArrowのどのデータ型を使用するか(StringまたはBinary)を選択できます。これは設定 `output_format_parquet_string_as_string`、`output_format_orc_string_as_string`、`output_format_arrow_string_as_string` で制御されます。Binaryの方がより正確で互換性がありますが、デフォルトでStringを使用することで、ほとんどの場合ユーザーの期待に沿います。Parquet/ORC/Arrowはlz4やzstdを含む多くの圧縮方式をサポートしています。ClickHouseはすべての圧縮方式をサポートしています。一部の劣ったツールは高速な `lz4` 圧縮方式をサポートしていないため、デフォルトで `zstd` を設定しています。これは設定 `output_format_parquet_compression_method`、`output_format_orc_compression_method`、`output_format_arrow_compression_method` で制御されます。ParquetとORCのデフォルトを `zstd` に変更しましたが、Arrow(低レベルの使用を重視)は変更していません。[#61817](https://github.com/ClickHouse/ClickHouse/pull/61817) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 新しいClickHouseバージョンでは、関数 `geoDistance`、`greatCircleDistance`、`greatCircleAngle` は、すべての引数がFloat64の場合、内部計算と戻り値の型に64ビット倍精度浮動小数点データ型を使用します。これにより [#58476](https://github.com/ClickHouse/ClickHouse/issues/58476) が解決されます。以前のバージョンでは、これらの関数は常にFloat32を使用していました。`geo_distance_returns_float64_on_float64_arguments` を `false` に設定するか、`compatibility` を `24.2` 以前に設定することで、以前の動作に戻すことができます。[#61848](https://github.com/ClickHouse/ClickHouse/pull/61848) ([Alexey Milovidov](https://github.com/alexey-milovidov))。[Geet Patel](https://github.com/geetptl)との共著。
- 廃止されたインメモリデータパーツはバージョン23.5以降非推奨となり、バージョン23.10以降サポートされていません。現在、残りのコードが削除されました。[#55186](https://github.com/ClickHouse/ClickHouse/issues/55186) および [#45409](https://github.com/ClickHouse/ClickHouse/issues/45409) の続きです。インメモリデータパーツを使用している可能性は低いです。なぜなら、これらはバージョン23.5以前でのみ利用可能で、MergeTreeテーブルに対応するSETTINGSを指定して手動で有効にした場合のみ使用できたためです。インメモリデータパーツがあるかどうかを確認するには、次のクエリを実行してください: `SELECT part_type, count() FROM system.parts GROUP BY part_type ORDER BY part_type`。インメモリデータパーツの使用を無効にするには、`ALTER TABLE ... MODIFY SETTING min_bytes_for_compact_part = DEFAULT, min_rows_for_compact_part = DEFAULT` を実行してください。古いClickHouseリリースからアップグレードする前に、まずインメモリデータパーツがないことを確認してください。インメモリデータパーツが存在する場合は、まずそれらを無効にし、インメモリデータパーツがなくなるまで待ってからアップグレードを続行してください。[#61127](https://github.com/ClickHouse/ClickHouse/pull/61127) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `system.zookeeper` テーブルのカラム名を `duration_ms` から `duration_microseconds` に変更し、期間がマイクロ秒単位の解像度であることを反映しました。[#60774](https://github.com/ClickHouse/ClickHouse/pull/60774) ([Duc Canh Le](https://github.com/canhld94))。
- クエリレベルの設定 `async_insert` と `deduplicate_blocks_in_dependent_materialized_views` が同時に有効になっている場合、受信するINSERTクエリを拒否します。この動作は設定 `throw_if_deduplication_in_dependent_materialized_views_enabled_with_async_insert` で制御され、デフォルトで有効になっています。これは https://github.com/ClickHouse/ClickHouse/pull/59699 の続きであり、https://github.com/ClickHouse/ClickHouse/pull/59915 のブロックを解除するために必要です。[#60888](https://github.com/ClickHouse/ClickHouse/pull/60888) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- ユーティリティ `clickhouse-copier` はGitHub上の別リポジトリに移動されました: https://github.com/ClickHouse/copier。バンドルには含まれなくなりましたが、個別のダウンロードとして引き続き利用可能です。これにより以下が解決されます: [#60734](https://github.com/ClickHouse/ClickHouse/issues/60734)、[#60540](https://github.com/ClickHouse/ClickHouse/issues/60540)、[#60250](https://github.com/ClickHouse/ClickHouse/issues/60250)、[#52917](https://github.com/ClickHouse/ClickHouse/issues/52917)、[#51140](https://github.com/ClickHouse/ClickHouse/issues/51140)、[#47517](https://github.com/ClickHouse/ClickHouse/issues/47517)、[#47189](https://github.com/ClickHouse/ClickHouse/issues/47189)、[#46598](https://github.com/ClickHouse/ClickHouse/issues/46598)、[#40257](https://github.com/ClickHouse/ClickHouse/issues/40257)、[#36504](https://github.com/ClickHouse/ClickHouse/issues/36504)、[#35485](https://github.com/ClickHouse/ClickHouse/issues/35485)、[#33702](https://github.com/ClickHouse/ClickHouse/issues/33702)、[#26702](https://github.com/ClickHouse/ClickHouse/issues/26702)。
- MySQLとの互換性を高めるため、互換性エイリアス `locate` はデフォルトで引数 `(needle, haystack[, start_pos])` を受け入れるようになりました。以前の動作 `(haystack, needle, [, start_pos])` は、`function_locate_has_mysql_compatible_argument_order` を `0` に設定することで復元できます。[#61092](https://github.com/ClickHouse/ClickHouse/pull/61092) ([Robert Schulze](https://github.com/rschu1ze))。
- `MergeTree` テーブルの `ORDER BY` での `SimpleAggregateFunction` の使用をデフォルトで禁止しました(`AggregateFunction` が禁止されているのと同様ですが、比較可能でないため禁止されています)(許可するには `allow_suspicious_primary_key` を使用してください)。[#61399](https://github.com/ClickHouse/ClickHouse/pull/61399) ([Azat Khuzhin](https://github.com/azat))。
- `Ordinary` データベースエンジンは非推奨になりました。サーバーがこれを使用している場合、clickhouse-clientで警告が表示されます。これにより [#52229](https://github.com/ClickHouse/ClickHouse/issues/52229) が解決されます。[#56942](https://github.com/ClickHouse/ClickHouse/pull/56942) ([shabroo](https://github.com/shabroo))。

#### 新機能 {#new-feature-9}

- バックアップの読み書きを`tar`形式でサポート（`zip`に加えて）。[#59535](https://github.com/ClickHouse/ClickHouse/pull/59535) ([josh-hildred](https://github.com/josh-hildred))。
- S3 Expressバケットのサポートを実装。[#59965](https://github.com/ClickHouse/ClickHouse/pull/59965) ([Nikita Taranov](https://github.com/nickitat))。
- 異なるディスクからのパーツのアタッチを許可（ハードリンクの代わりにコピーを使用）。[#60112](https://github.com/ClickHouse/ClickHouse/pull/60112) ([Unalian](https://github.com/Unalian))。
- サイズ制限付き`Memory`テーブル：設定`min_bytes_to_keep`、`max_bytes_to_keep`、`min_rows_to_keep`、`max_rows_to_keep`により制御されます。[#60612](https://github.com/ClickHouse/ClickHouse/pull/60612) ([Jake Bamrah](https://github.com/JakeBamrah))。
- 待機中クエリと実行中クエリの数に対する個別の制限。`async_load_databases`により待機しているクエリ数を制限する新しいサーバー設定`max_waiting_queries`を追加しました。既存の実行中クエリ数の制限は、待機中クエリをカウントしなくなりました。[#61053](https://github.com/ClickHouse/ClickHouse/pull/61053) ([Sergei Trifonov](https://github.com/serxa))。
- パーサーのすべてのキーワードを含むテーブル`system.keywords`を追加しました。主にファジングと構文ハイライトの改善に必要であり、使用されます。[#51808](https://github.com/ClickHouse/ClickHouse/pull/51808) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- `ATTACH PARTITION ALL`のサポートを追加。[#61107](https://github.com/ClickHouse/ClickHouse/pull/61107) ([Kirill Nikiforov](https://github.com/allmazz))。
- 新しい関数`getClientHTTPHeader`を追加しました。これにより[#54665](https://github.com/ClickHouse/ClickHouse/issues/54665)がクローズされます。@lingtaolfとの共著。[#61820](https://github.com/ClickHouse/ClickHouse/pull/61820) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- テーブル関数として`generate_series`を追加（既存の`numbers`関数に対するPostgreSQL互換エイリアス）。この関数は自然数の等差数列を持つテーブルを生成します。[#59390](https://github.com/ClickHouse/ClickHouse/pull/59390) ([divanik](https://github.com/divanik))。
- `topK`/`topkWeighed`のサポートモードで、値のカウントとそのエラーを返すモードを追加。[#54508](https://github.com/ClickHouse/ClickHouse/pull/54508) ([UnamedRus](https://github.com/UnamedRus))。
- `DateTime`型または`DateTime64`型の値に対してミリ秒成分を返す関数`toMillisecond`を追加しました。[#60281](https://github.com/ClickHouse/ClickHouse/pull/60281) ([Shaun Struwig](https://github.com/Blargian))。
- clickhouse-serverのHTTPリダイレクトハンドラーの設定を許可。例えば、`/`をPlay UIにリダイレクトすることができます。[#60390](https://github.com/ClickHouse/ClickHouse/pull/60390) ([Alexey Milovidov](https://github.com/alexey-milovidov))。


#### パフォーマンス改善 {#performance-improvement-9}

- 不要で高コストなメモリコピーを省略するように`dotProduct`関数を最適化しました。[#60928](https://github.com/ClickHouse/ClickHouse/pull/60928) ([Robert Schulze](https://github.com/rschu1ze))。
- 256ビット整数の出力が30倍高速化されました。[#61100](https://github.com/ClickHouse/ClickHouse/pull/61100) ([Raúl Marín](https://github.com/Algunenano))。
- テーブルのプライマリキーにほとんど使用されないカラムが含まれている場合、それらをメモリに保持しないようにしました。これは新しい設定`primary_key_ratio_of_unique_prefix_values_to_skip_suffix_columns`で制御され、デフォルト値は`0.9`です。これは、複合プライマリキーにおいて、あるカラムが全体の少なくとも0.9の割合で値を変更する場合、その後のカラムはロードされないことを意味します。[#60255](https://github.com/ClickHouse/ClickHouse/pull/60255) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 複数の`Nullable`カラムを含む場合のシリアライズされた集約メソッドのパフォーマンスを改善しました。[#55809](https://github.com/ClickHouse/ClickHouse/pull/55809) ([Amos Bird](https://github.com/amosbird))。
- ALL JOINのパフォーマンスを向上させるため、JSONの出力を遅延構築するようにしました。[#58278](https://github.com/ClickHouse/ClickHouse/pull/58278) ([LiuNeng](https://github.com/liuneng1994))。
- AWS S3などの外部サービスとのHTTP/HTTPS接続を、すべてのユースケースで再利用可能にしました。レスポンスが3xxまたは4xxの場合でも再利用されます。[#58845](https://github.com/ClickHouse/ClickHouse/pull/58845) ([Sema Checherinda](https://github.com/CheSema))。
- 集約関数`argMin` / `argMax` / `any` / `anyLast` / `anyHeavy`、および`ORDER BY {u8/u16/u32/u64/i8/i16/u32/i64) LIMIT 1`クエリを改善しました。[#58640](https://github.com/ClickHouse/ClickHouse/pull/58640) ([Raúl Marín](https://github.com/Algunenano))。
- カラムのフィルタに対する軽微な最適化を行いました。一部のケースでは、ピークメモリを元の44%まで削減できます。[#59698](https://github.com/ClickHouse/ClickHouse/pull/59698) ([李扬](https://github.com/taiyang-li))。
- 結果型の基底型が数値の場合、`multiIf`関数をカラム形式で実行するようにしました。[#60384](https://github.com/ClickHouse/ClickHouse/pull/60384) ([李扬](https://github.com/taiyang-li))。
- mutexが高速化されました(ほぼ2倍)。[#60823](https://github.com/ClickHouse/ClickHouse/pull/60823) ([Azat Khuzhin](https://github.com/azat))。
- 分散クエリが終了する際に、複数の接続を並列でドレインするようにしました。[#60845](https://github.com/ClickHouse/ClickHouse/pull/60845) ([lizhuoyu5](https://github.com/lzydmxy))。
- Nullable数値またはNullable文字列のカラム間のデータ移動を最適化し、一部のマイクロベンチマークが改善されました。[#60846](https://github.com/ClickHouse/ClickHouse/pull/60846) ([李扬](https://github.com/taiyang-li))。
- ファイルシステムキャッシュの操作が、ロック競合の影響を受けにくくなりました。[#61066](https://github.com/ClickHouse/ClickHouse/pull/61066) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- コンパイラの誤った最適化を防ぐことで、array joinおよびその他のJOINを最適化しました。クローズ [#61074](https://github.com/ClickHouse/ClickHouse/issues/61074)。[#61075](https://github.com/ClickHouse/ClickHouse/pull/61075) ([李扬](https://github.com/taiyang-li))。
- 構文エラーを含むクエリが正規表現を伴う`COLUMNS`マッチャーを含んでいた場合、正規表現はパーサーのバックトラック中に毎回コンパイルされており、一度だけコンパイルされるべきところがそうなっていませんでした。これは根本的なエラーでした。コンパイルされた正規表現はASTに配置されていましたが、ASTのAは「抽象」を意味し、重量級のオブジェクトを含むべきではありません。ASTの一部は、大量のバックトラックを含む解析中に作成および破棄される可能性があります。これにより解析側で遅延が発生し、結果として読み取り専用ユーザーによるDoSが可能になります。しかし、主な問題はファザーの進行を妨げることです。[#61543](https://github.com/ClickHouse/ClickHouse/pull/61543) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 単一値に対するIN演算子を最適化する新しいアナライザパスを追加しました。[#61564](https://github.com/ClickHouse/ClickHouse/pull/61564) ([LiuNeng](https://github.com/liuneng1994))。
- DNSResolverが解決されたIPのセットをシャッフルするようにし、AWS S3の複数のエンドポイントを均等に利用できるようにしました。[#60965](https://github.com/ClickHouse/ClickHouse/pull/60965) ([Sema Checherinda](https://github.com/CheSema))。

#### 実験的機能 {#experimental-feature-7}

- Azure Blob Storageの並列読み取りをサポートしました。これにより、実験的なAzureオブジェクトストレージのパフォーマンスが向上します。[#61503](https://github.com/ClickHouse/ClickHouse/pull/61503) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
- S3と同様に、Azure Blob Storage用の非同期WriteBufferを追加しました。これにより、実験的なAzureオブジェクトストレージのパフォーマンスが向上します。[#59929](https://github.com/ClickHouse/ClickHouse/pull/59929) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
- Azure Blob Storageを使用する際、バックアップIOにマネージドIDを使用するようにしました。また、ストレージアカウントレベルの権限が必要となる、存在しないコンテナの作成をClickHouseが試行しないようにする設定を追加しました。[#61785](https://github.com/ClickHouse/ClickHouse/pull/61785) ([Daniel Pozo Escalona](https://github.com/danipozo))。
- 並列レプリカでIN句のサブクエリを使用できるようにする設定`parallel_replicas_allow_in_with_subquery = 1`を追加しました。[#60950](https://github.com/ClickHouse/ClickHouse/pull/60950) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 「ゼロコピー」レプリケーションの変更: テーブルが削除される際、そのテーブルに関連するすべてのゼロコピーロックを削除する必要があります。これらのロックを含むディレクトリも削除する必要があります。[#57575](https://github.com/ClickHouse/ClickHouse/pull/57575) ([Sema Checherinda](https://github.com/CheSema))。


#### 改善 {#improvement-9}

- Use `MergeTree` as a default table engine. [#60524](https://github.com/ClickHouse/ClickHouse/pull/60524) ([Alexey Milovidov](https://github.com/alexey-milovidov))
- Enable `output_format_pretty_row_numbers` by default. It is better for usability. [#61791](https://github.com/ClickHouse/ClickHouse/pull/61791) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- In the previous version, some numbers in Pretty formats were not pretty enough. [#61794](https://github.com/ClickHouse/ClickHouse/pull/61794) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- A long value in Pretty formats won't be cut if it is the single value in the resultset, such as in the result of the `SHOW CREATE TABLE` query. [#61795](https://github.com/ClickHouse/ClickHouse/pull/61795) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Similarly to `clickhouse-local`, `clickhouse-client` will accept the `--output-format` option as a synonym to the `--format` option. This closes [#59848](https://github.com/ClickHouse/ClickHouse/issues/59848). [#61797](https://github.com/ClickHouse/ClickHouse/pull/61797) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- If stdout is a terminal and the output format is not specified, `clickhouse-client` and similar tools will use `PrettyCompact` by default, similarly to the interactive mode. `clickhouse-client` and `clickhouse-local` will handle command line arguments for input and output formats in a unified fashion. This closes [#61272](https://github.com/ClickHouse/ClickHouse/issues/61272). [#61800](https://github.com/ClickHouse/ClickHouse/pull/61800) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Underscore digit groups in Pretty formats for better readability. This is controlled by a new setting, `output_format_pretty_highlight_digit_groups`. [#61802](https://github.com/ClickHouse/ClickHouse/pull/61802) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Add ability to override initial INSERT settings via `SYSTEM FLUSH DISTRIBUTED`. [#61832](https://github.com/ClickHouse/ClickHouse/pull/61832) ([Azat Khuzhin](https://github.com/azat)).
- Enable processors profiling (time spent/in and out bytes for sorting, aggregation, ...) by default. [#61096](https://github.com/ClickHouse/ClickHouse/pull/61096) ([Azat Khuzhin](https://github.com/azat)).
- Support files without format extension in Filesystem database. [#60795](https://github.com/ClickHouse/ClickHouse/pull/60795) ([Kruglov Pavel](https://github.com/Avogar)).
- Make all format names case insensitive, like Tsv, or TSV, or tsv, or even rowbinary. [#60420](https://github.com/ClickHouse/ClickHouse/pull/60420) ([豪肥肥](https://github.com/HowePa)). I appreciate if you will continue to write it correctly, e.g., `JSON` 😇, not `Json` 🤮, but we don't mind if you spell it as you prefer.
- Added `none_only_active` mode for `distributed_ddl_output_mode` setting. [#60340](https://github.com/ClickHouse/ClickHouse/pull/60340) ([Alexander Tokmakov](https://github.com/tavplubix)).
- The advanced dashboard has slightly better colors for multi-line graphs. [#60391](https://github.com/ClickHouse/ClickHouse/pull/60391) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- The Advanced dashboard now has controls always visible on scrolling. This allows you to add a new chart without scrolling up. [#60692](https://github.com/ClickHouse/ClickHouse/pull/60692) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- While running the `MODIFY COLUMN` query for materialized views, check the inner table's structure to ensure every column exists. [#47427](https://github.com/ClickHouse/ClickHouse/pull/47427) ([sunny](https://github.com/sunny19930321)).
- String types and Enums can be used in the same context, such as: arrays, UNION queries, conditional expressions. This closes [#60726](https://github.com/ClickHouse/ClickHouse/issues/60726). [#60727](https://github.com/ClickHouse/ClickHouse/pull/60727) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Allow declaring Enums in the structure of external data for query processing (this is an immediate temporary table that you can provide for your query). [#57857](https://github.com/ClickHouse/ClickHouse/pull/57857) ([Duc Canh Le](https://github.com/canhld94)).
- Consider lightweight deleted rows when selecting parts to merge, so the disk size of the resulting part will be estimated better. [#58223](https://github.com/ClickHouse/ClickHouse/pull/58223) ([Zhuo Qiu](https://github.com/jewelzqiu)).
- Added comments for columns for more system tables. Continuation of https://github.com/ClickHouse/ClickHouse/pull/58356. [#59016](https://github.com/ClickHouse/ClickHouse/pull/59016) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Now we can use virtual columns in PREWHERE. It's worthwhile for non-const virtual columns like `_part_offset`. [#59033](https://github.com/ClickHouse/ClickHouse/pull/59033) ([Amos Bird](https://github.com/amosbird)). Improved overall usability of virtual columns. Now it is allowed to use virtual columns in `PREWHERE` (it's worthwhile for non-const virtual columns like `_part_offset`). Now a builtin documentation is available for virtual columns as a comment of column in `DESCRIBE` query with enabled setting `describe_include_virtual_columns`. [#60205](https://github.com/ClickHouse/ClickHouse/pull/60205) ([Anton Popov](https://github.com/CurtizJ)).
- Instead of using a constant key, now object storage generates key for determining remove objects capability. [#59495](https://github.com/ClickHouse/ClickHouse/pull/59495) ([Sema Checherinda](https://github.com/CheSema)).
- Allow "local" as object storage type instead of "local_blob_storage". [#60165](https://github.com/ClickHouse/ClickHouse/pull/60165) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Parallel flush of pending INSERT blocks of Distributed engine on `DETACH`/server shutdown and `SYSTEM FLUSH DISTRIBUTED` (Parallelism will work only if you have multi-disk policy for a table (like everything in the Distributed engine right now)). [#60225](https://github.com/ClickHouse/ClickHouse/pull/60225) ([Azat Khuzhin](https://github.com/azat)).
- Add a setting to force read-through cache for merges. [#60308](https://github.com/ClickHouse/ClickHouse/pull/60308) ([Kseniia Sumarokova](https://github.com/kssenii)).
- An improvement for the MySQL compatibility protocol. The issue [#57598](https://github.com/ClickHouse/ClickHouse/issues/57598) mentions a variant behaviour regarding transaction handling. An issued COMMIT/ROLLBACK when no transaction is active is reported as an error contrary to MySQL behaviour. [#60338](https://github.com/ClickHouse/ClickHouse/pull/60338) ([PapaToemmsn](https://github.com/PapaToemmsn)).
- Function `substring` now has a new alias `byteSlice`. [#60494](https://github.com/ClickHouse/ClickHouse/pull/60494) ([Robert Schulze](https://github.com/rschu1ze)).
- Renamed server setting `dns_cache_max_size` to `dns_cache_max_entries` to reduce ambiguity. [#60500](https://github.com/ClickHouse/ClickHouse/pull/60500) ([Kirill Nikiforov](https://github.com/allmazz)).
- `SHOW INDEX | INDEXES | INDICES | KEYS` no longer sorts by the primary key columns (which was unintuitive). [#60514](https://github.com/ClickHouse/ClickHouse/pull/60514) ([Robert Schulze](https://github.com/rschu1ze)).
- Keeper improvement: abort during startup if an invalid snapshot is detected to avoid data loss. [#60537](https://github.com/ClickHouse/ClickHouse/pull/60537) ([Antonio Andelic](https://github.com/antonio2368)).
- Update tzdata to 2024a. [#60768](https://github.com/ClickHouse/ClickHouse/pull/60768) ([Raúl Marín](https://github.com/Algunenano)).
- Keeper improvement: support `leadership_expiry_ms` in Keeper's settings. [#60806](https://github.com/ClickHouse/ClickHouse/pull/60806) ([Brokenice0415](https://github.com/Brokenice0415)).
- Always infer exponential numbers in JSON formats regardless of the setting `input_format_try_infer_exponent_floats`. Add setting `input_format_json_use_string_type_for_ambiguous_paths_in_named_tuples_inference_from_objects` that allows to use String type for ambiguous paths instead of an exception during named Tuples inference from JSON objects. [#60808](https://github.com/ClickHouse/ClickHouse/pull/60808) ([Kruglov Pavel](https://github.com/Avogar)).
- Add support for `START TRANSACTION` syntax typically used in MySQL syntax, resolving https://github.com/ClickHouse/ClickHouse/discussions/60865. [#60886](https://github.com/ClickHouse/ClickHouse/pull/60886) ([Zach Naimon](https://github.com/ArctypeZach)).
- Add a flag for the full-sorting merge join algorithm to treat null as biggest/smallest. So the behavior can be compitable with other SQL systems, like Apache Spark. [#60896](https://github.com/ClickHouse/ClickHouse/pull/60896) ([loudongfeng](https://github.com/loudongfeng)).
- Support detect output format by file exctension in `clickhouse-client` and `clickhouse-local`. [#61036](https://github.com/ClickHouse/ClickHouse/pull/61036) ([豪肥肥](https://github.com/HowePa)).
- Update memory limit in runtime when Linux's CGroups value changed. [#61049](https://github.com/ClickHouse/ClickHouse/pull/61049) ([Han Fei](https://github.com/hanfei1991)).
- Add the function `toUInt128OrZero`, which was missed by mistake (the mistake is related to https://github.com/ClickHouse/ClickHouse/pull/945). The compatibility aliases `FROM_UNIXTIME` and `DATE_FORMAT` (they are not ClickHouse-native and only exist for MySQL compatibility) have been made case insensitive, as expected for SQL-compatibility aliases. [#61114](https://github.com/ClickHouse/ClickHouse/pull/61114) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Improvements for the access checks, allowing to revoke of unpossessed rights in case the target user doesn't have the revoking grants either. Example: `GRANT SELECT ON *.* TO user1; REVOKE SELECT ON system.* FROM user1;`. [#61115](https://github.com/ClickHouse/ClickHouse/pull/61115) ([pufit](https://github.com/pufit)).
- Fix `has()` function with `Nullable` column (fixes [#60214](https://github.com/ClickHouse/ClickHouse/issues/60214)). [#61249](https://github.com/ClickHouse/ClickHouse/pull/61249) ([Mikhail Koviazin](https://github.com/mkmkme)).
- Now it's possible to specify the attribute `merge="true"` in config substitutions for subtrees `<include from_zk="/path" merge="true">`. In case this attribute specified, clickhouse will merge subtree with existing configuration, otherwise default behavior is append new content to configuration. [#61299](https://github.com/ClickHouse/ClickHouse/pull/61299) ([alesapin](https://github.com/alesapin)).
- Add async metrics for virtual memory mappings: `VMMaxMapCount` & `VMNumMaps`. Closes [#60662](https://github.com/ClickHouse/ClickHouse/issues/60662). [#61354](https://github.com/ClickHouse/ClickHouse/pull/61354) ([Tuan Pham Anh](https://github.com/tuanpavn)).
- Use `temporary_files_codec` setting in all places where we create temporary data, for example external memory sorting and external memory GROUP BY. Before it worked only in `partial_merge` JOIN algorithm. [#61456](https://github.com/ClickHouse/ClickHouse/pull/61456) ([Maksim Kita](https://github.com/kitaisreal)).
- Add a new setting `max_parser_backtracks` which allows to limit the complexity of query parsing. [#61502](https://github.com/ClickHouse/ClickHouse/pull/61502) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Less contention during dynamic resize of the filesystem cache. [#61524](https://github.com/ClickHouse/ClickHouse/pull/61524) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Disallow sharded mode of StorageS3 queue, because it will be rewritten. [#61537](https://github.com/ClickHouse/ClickHouse/pull/61537) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fixed typo: from `use_leagcy_max_level` to `use_legacy_max_level`. [#61545](https://github.com/ClickHouse/ClickHouse/pull/61545) ([William Schoeffel](https://github.com/wiledusc)).
- Remove some duplicate entries in `system.blob_storage_log`. [#61622](https://github.com/ClickHouse/ClickHouse/pull/61622) ([YenchangChan](https://github.com/YenchangChan)).
- Added `current_user` function as a compatibility alias for MySQL. [#61770](https://github.com/ClickHouse/ClickHouse/pull/61770) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fix inconsistent floating point aggregate function states in mixed x86-64 / ARM clusters [#60610](https://github.com/ClickHouse/ClickHouse/pull/60610) ([Harry Lee](https://github.com/HarryLeeIBM)).

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-5}

- リアルタイムクエリプロファイラがAArch64で動作するようになりました。以前のバージョンでは、プログラムがシステムコール内で時間を消費していない場合にのみ動作していました。[#60807](https://github.com/ClickHouse/ClickHouse/pull/60807) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- ClickHouseバージョンがDockerラベルに追加されました。Closes [#54224](https://github.com/ClickHouse/ClickHouse/issues/54224)。[#60949](https://github.com/ClickHouse/ClickHouse/pull/60949) ([Nikolay Monkov](https://github.com/nikmonkov))。
- `prqlc`を0.11.3にアップグレードしました。[#60616](https://github.com/ClickHouse/ClickHouse/pull/60616) ([Maximilian Roos](https://github.com/max-sixty))。
- `clickhouse-local`に汎用クエリテキストファザーを追加しました。[#61508](https://github.com/ClickHouse/ClickHouse/pull/61508) ([Alexey Milovidov](https://github.com/alexey-milovidov))。


#### バグ修正（公式安定版リリースにおけるユーザーに見える不具合） {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-7}

- Fix finished_mutations_to_keep=0 for MergeTree (as docs says 0 is to keep everything) [#60031](https://github.com/ClickHouse/ClickHouse/pull/60031) ([Azat Khuzhin](https://github.com/azat)).
- Something was wrong with the FINAL optimization, here is how the author describes it: "PartsSplitter invalid ranges for the same part". [#60041](https://github.com/ClickHouse/ClickHouse/pull/60041) ([Maksim Kita](https://github.com/kitaisreal)).
- Something was wrong with Apache Hive, which is experimental and not supported. [#60262](https://github.com/ClickHouse/ClickHouse/pull/60262) ([shanfengp](https://github.com/Aed-p)).
- An improvement for experimental parallel replicas: force reanalysis if parallel replicas changed [#60362](https://github.com/ClickHouse/ClickHouse/pull/60362) ([Raúl Marín](https://github.com/Algunenano)).
- Fix usage of plain metadata type with new disks configuration option [#60396](https://github.com/ClickHouse/ClickHouse/pull/60396) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Try to fix logical error 'Cannot capture column because it has incompatible type' in mapContainsKeyLike [#60451](https://github.com/ClickHouse/ClickHouse/pull/60451) ([Kruglov Pavel](https://github.com/Avogar)).
- Avoid calculation of scalar subqueries for CREATE TABLE. [#60464](https://github.com/ClickHouse/ClickHouse/pull/60464) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix deadlock in parallel parsing when lots of rows are skipped due to errors [#60516](https://github.com/ClickHouse/ClickHouse/pull/60516) ([Kruglov Pavel](https://github.com/Avogar)).
- Something was wrong with experimental KQL (Kusto) support: fix `max_query_size_for_kql_compound_operator`: [#60534](https://github.com/ClickHouse/ClickHouse/pull/60534) ([Yong Wang](https://github.com/kashwy)).
- Keeper fix: add timeouts when waiting for commit logs [#60544](https://github.com/ClickHouse/ClickHouse/pull/60544) ([Antonio Andelic](https://github.com/antonio2368)).
- Don't output number tips for date types [#60577](https://github.com/ClickHouse/ClickHouse/pull/60577) ([Raúl Marín](https://github.com/Algunenano)).
- Fix reading from MergeTree with non-deterministic functions in filter [#60586](https://github.com/ClickHouse/ClickHouse/pull/60586) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix logical error on bad compatibility setting value type [#60596](https://github.com/ClickHouse/ClickHouse/pull/60596) ([Kruglov Pavel](https://github.com/Avogar)).
- fix(prql): Robust panic handler [#60615](https://github.com/ClickHouse/ClickHouse/pull/60615) ([Maximilian Roos](https://github.com/max-sixty)).
- Fix `intDiv` for decimal and date arguments [#60672](https://github.com/ClickHouse/ClickHouse/pull/60672) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fix: expand CTE in alter modify query [#60682](https://github.com/ClickHouse/ClickHouse/pull/60682) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix system.parts for non-Atomic/Ordinary database engine (i.e. Memory) [#60689](https://github.com/ClickHouse/ClickHouse/pull/60689) ([Azat Khuzhin](https://github.com/azat)).
- Fix "Invalid storage definition in metadata file" for parameterized views [#60708](https://github.com/ClickHouse/ClickHouse/pull/60708) ([Azat Khuzhin](https://github.com/azat)).
- Fix buffer overflow in CompressionCodecMultiple [#60731](https://github.com/ClickHouse/ClickHouse/pull/60731) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Remove nonsense from SQL/JSON [#60738](https://github.com/ClickHouse/ClickHouse/pull/60738) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Remove wrong assertion in aggregate function quantileGK [#60740](https://github.com/ClickHouse/ClickHouse/pull/60740) ([李扬](https://github.com/taiyang-li)).
- Fix insert-select + insert_deduplication_token bug by setting streams to 1 [#60745](https://github.com/ClickHouse/ClickHouse/pull/60745) ([Jordi Villar](https://github.com/jrdi)).
- Prevent setting custom metadata headers on unsupported multipart upload operations [#60748](https://github.com/ClickHouse/ClickHouse/pull/60748) ([Francisco J. Jurado Moreno](https://github.com/Beetelbrox)).
- Fix toStartOfInterval [#60763](https://github.com/ClickHouse/ClickHouse/pull/60763) ([Andrey Zvonov](https://github.com/zvonand)).
- Fix crash in arrayEnumerateRanked [#60764](https://github.com/ClickHouse/ClickHouse/pull/60764) ([Raúl Marín](https://github.com/Algunenano)).
- Fix crash when using input() in INSERT SELECT JOIN [#60765](https://github.com/ClickHouse/ClickHouse/pull/60765) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix crash with different allow_experimental_analyzer value in subqueries [#60770](https://github.com/ClickHouse/ClickHouse/pull/60770) ([Dmitry Novik](https://github.com/novikd)).
- Remove recursion when reading from S3 [#60849](https://github.com/ClickHouse/ClickHouse/pull/60849) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix possible stuck on error in HashedDictionaryParallelLoader [#60926](https://github.com/ClickHouse/ClickHouse/pull/60926) ([vdimir](https://github.com/vdimir)).
- Fix async RESTORE with Replicated database (experimental feature) [#60934](https://github.com/ClickHouse/ClickHouse/pull/60934) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix deadlock in async inserts to `Log` tables via native protocol [#61055](https://github.com/ClickHouse/ClickHouse/pull/61055) ([Anton Popov](https://github.com/CurtizJ)).
- Fix lazy execution of default argument in dictGetOrDefault for RangeHashedDictionary [#61196](https://github.com/ClickHouse/ClickHouse/pull/61196) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix multiple bugs in groupArraySorted [#61203](https://github.com/ClickHouse/ClickHouse/pull/61203) ([Raúl Marín](https://github.com/Algunenano)).
- Fix Keeper reconfig for standalone binary [#61233](https://github.com/ClickHouse/ClickHouse/pull/61233) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix usage of session_token in S3 engine [#61234](https://github.com/ClickHouse/ClickHouse/pull/61234) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix possible incorrect result of aggregate function `uniqExact` [#61257](https://github.com/ClickHouse/ClickHouse/pull/61257) ([Anton Popov](https://github.com/CurtizJ)).
- Fix bugs in show database [#61269](https://github.com/ClickHouse/ClickHouse/pull/61269) ([Raúl Marín](https://github.com/Algunenano)).
- Fix logical error in RabbitMQ storage with MATERIALIZED columns [#61320](https://github.com/ClickHouse/ClickHouse/pull/61320) ([vdimir](https://github.com/vdimir)).
- Fix CREATE OR REPLACE DICTIONARY [#61356](https://github.com/ClickHouse/ClickHouse/pull/61356) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix ATTACH query with external ON CLUSTER [#61365](https://github.com/ClickHouse/ClickHouse/pull/61365) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix consecutive keys optimization for nullable keys [#61393](https://github.com/ClickHouse/ClickHouse/pull/61393) ([Anton Popov](https://github.com/CurtizJ)).
- fix issue of actions dag split [#61458](https://github.com/ClickHouse/ClickHouse/pull/61458) ([Raúl Marín](https://github.com/Algunenano)).
- Fix finishing a failed RESTORE [#61466](https://github.com/ClickHouse/ClickHouse/pull/61466) ([Vitaly Baranov](https://github.com/vitlibar)).
- Disable async_insert_use_adaptive_busy_timeout correctly with compatibility settings [#61468](https://github.com/ClickHouse/ClickHouse/pull/61468) ([Raúl Marín](https://github.com/Algunenano)).
- Allow queuing in restore pool [#61475](https://github.com/ClickHouse/ClickHouse/pull/61475) ([Nikita Taranov](https://github.com/nickitat)).
- Fix an inconsistency when reading system.parts using UUID. [#61479](https://github.com/ClickHouse/ClickHouse/pull/61479) ([Dan Wu](https://github.com/wudanzy)).
- Fix ALTER QUERY MODIFY SQL SECURITY [#61480](https://github.com/ClickHouse/ClickHouse/pull/61480) ([pufit](https://github.com/pufit)).
- Fix a crash in window view (experimental feature) [#61526](https://github.com/ClickHouse/ClickHouse/pull/61526) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix `repeat` with non-native integers [#61527](https://github.com/ClickHouse/ClickHouse/pull/61527) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix client's `-s` argument [#61530](https://github.com/ClickHouse/ClickHouse/pull/61530) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Fix crash in arrayPartialReverseSort [#61539](https://github.com/ClickHouse/ClickHouse/pull/61539) ([Raúl Marín](https://github.com/Algunenano)).
- Fix string search with const position [#61547](https://github.com/ClickHouse/ClickHouse/pull/61547) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix addDays cause an error when used DateTime64 [#61561](https://github.com/ClickHouse/ClickHouse/pull/61561) ([Shuai li](https://github.com/loneylee)).
- Disallow LowCardinality input type for JSONExtract [#61617](https://github.com/ClickHouse/ClickHouse/pull/61617) ([Julia Kartseva](https://github.com/jkartseva)).
- Fix `system.part_log` for async insert with deduplication [#61620](https://github.com/ClickHouse/ClickHouse/pull/61620) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix a `Non-ready set` exception for system.parts. [#61666](https://github.com/ClickHouse/ClickHouse/pull/61666) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix actual_part_name for REPLACE_RANGE (`Entry actual part isn't empty yet`) [#61675](https://github.com/ClickHouse/ClickHouse/pull/61675) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix a sanitizer report in `multiSearchAllPositionsCaseInsensitiveUTF8` for incorrect UTF-8 [#61749](https://github.com/ClickHouse/ClickHouse/pull/61749) ([pufit](https://github.com/pufit)).
- Fix an observation that the RANGE frame is not supported for Nullable columns. [#61766](https://github.com/ClickHouse/ClickHouse/pull/61766) ([YuanLiu](https://github.com/ditgittube)).

### <a id="242"></a> ClickHouse リリース 24.2, 2024-02-29 {#a-id242a-clickhouse-release-242-2024-02-29}

#### 後方互換性のない変更 {#backward-incompatible-change-8}

- ネストされた型内の疑わしい型や実験的な型を検証するようになりました。以前は、Array/Tuple/Mapなどのネストされた型内でこのような型(JSONを除く)を検証していませんでした。[#59385](https://github.com/ClickHouse/ClickHouse/pull/59385) ([Kruglov Pavel](https://github.com/Avogar))。
- スレッド数とブロックサイズの妥当性チェックを追加しました。[#60138](https://github.com/ClickHouse/ClickHouse/pull/60138) ([Raúl Marín](https://github.com/Algunenano))。
- デフォルトでは指数表記の浮動小数点数を推論しないようになりました。以前の動作を復元する設定`input_format_try_infer_exponent_floats`を追加しました(デフォルトでは無効)。[#59476](https://github.com/ClickHouse/ClickHouse/issues/59476)をクローズします。[#59500](https://github.com/ClickHouse/ClickHouse/pull/59500) ([Kruglov Pavel](https://github.com/Avogar))。
- ALTER操作を括弧で囲むことができるようになりました。括弧の出力は`format_alter_operations_with_parentheses`設定で制御できます。デフォルトでは、フォーマットされたクエリで括弧が出力されます。これは、フォーマットされたALTER操作をメタデータとして一部の場所(例: mutations)に保存するためです。新しい構文により、ALTER操作がリストで終わる一部のクエリが明確になります。例: `ALTER TABLE x MODIFY TTL date GROUP BY a, b, DROP COLUMN c`は古い構文では適切に解析できません。新しい構文では、クエリ`ALTER TABLE x (MODIFY TTL date GROUP BY a, b), (DROP COLUMN c)`が明確です。古いバージョンは新しい構文を読み取ることができないため、単一のクラスタ内でClickHouseの新しいバージョンと古いバージョンが混在している場合、新しい構文を使用すると問題が発生する可能性があります。[#59532](https://github.com/ClickHouse/ClickHouse/pull/59532) ([János Benjamin Antal](https://github.com/antaljanosbenjamin))。
- マテリアライズドビューのセキュリティ問題を修正しました。この問題により、ユーザーは必要な権限なしでテーブルに挿入できていました。修正により、ユーザーがマテリアライズドビューだけでなく、すべての基礎となるテーブルにも挿入する権限を持っていることを検証するようになりました。これにより、以前は動作していた一部のクエリが、現在は`Not enough privileges`で失敗する可能性があります。この問題に対処するため、このリリースではビューのSQLセキュリティの新機能を導入しています https://clickhouse.com/docs/sql-reference/statements/create/view#sql_security。[#54901](https://github.com/ClickHouse/ClickHouse/pull/54901) [#60439](https://github.com/ClickHouse/ClickHouse/pull/60439) ([pufit](https://github.com/pufit))。


#### 新機能 {#new-feature-10}

- ビュー/マテリアライズドビューでdefinerユーザーを指定できる新しい構文を追加しました。これにより、基礎となるテーブルへの明示的な権限付与なしに、ビューからのselect/insertを実行できます。つまり、ビューが権限をカプセル化します。[#54901](https://github.com/ClickHouse/ClickHouse/pull/54901) [#60439](https://github.com/ClickHouse/ClickHouse/pull/60439) ([pufit](https://github.com/pufit))。
- `file/s3/hdfs/url/azureBlobStorage`エンジンでスキーマ推論中にファイル形式が不明な場合、自動的に検出を試みます。Closes [#50576](https://github.com/ClickHouse/ClickHouse/issues/50576)。[#59092](https://github.com/ClickHouse/ClickHouse/pull/59092) ([Kruglov Pavel](https://github.com/Avogar))。
- 非同期挿入タイムアウトの自動調整を実装しました。次の設定が導入されました: async_insert_poll_timeout_ms、async_insert_use_adaptive_busy_timeout、async_insert_busy_timeout_min_ms、async_insert_busy_timeout_max_ms、async_insert_busy_timeout_increase_rate、async_insert_busy_timeout_decrease_rate。[#58486](https://github.com/ClickHouse/ClickHouse/pull/58486) ([Julia Kartseva](https://github.com/jkartseva))。
- 最大連続ログイン失敗回数のクォータを設定できるようになりました。[#54737](https://github.com/ClickHouse/ClickHouse/pull/54737) ([Alexey Gerasimchuck](https://github.com/Demilivor))。
- 新しい集約関数`groupArrayIntersect`。フォローアップ: [#49862](https://github.com/ClickHouse/ClickHouse/issues/49862)。[#59598](https://github.com/ClickHouse/ClickHouse/pull/59598) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- `AzureBlobStorage`のバックアップ&リストアをサポートしました。Resolves [#50747](https://github.com/ClickHouse/ClickHouse/issues/50747)。[#56988](https://github.com/ClickHouse/ClickHouse/pull/56988) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
- ユーザーは`format_template_row`の代替として、`format_schema_rows_template`を使用してクエリ内でテンプレート文字列を直接指定できるようになりました。Closes [#31363](https://github.com/ClickHouse/ClickHouse/issues/31363)。[#59088](https://github.com/ClickHouse/ClickHouse/pull/59088) ([Shaun Struwig](https://github.com/Blargian))。
- 異なる種類のマージツリーテーブルをレプリケートエンジンに自動変換する機能を実装しました。テーブルのデータディレクトリ(`/clickhouse/store/xxx/xxxyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy/`)に空の`convert_to_replicated`ファイルを作成すると、次回のサーバー起動時にそのテーブルが自動的に変換されます。[#57798](https://github.com/ClickHouse/ClickHouse/pull/57798) ([Kirill](https://github.com/kirillgarbar))。
- 空のパーティションに関連するZooKeeperノードを削除する`ALTER TABLE table FORGET PARTITION partition`クエリを追加しました。[#59507](https://github.com/ClickHouse/ClickHouse/pull/59507) ([Sergei Trifonov](https://github.com/serxa))。これはエキスパートレベルの機能です。
- NATSテーブルエンジンでJWT認証情報ファイルをサポートしました。[#59543](https://github.com/ClickHouse/ClickHouse/pull/59543) ([Nickolaj Jepsen](https://github.com/nickolaj-jepsen))。
- DNS問題のデバッグに役立つ`system.dns_cache`テーブルを実装しました。[#59856](https://github.com/ClickHouse/ClickHouse/pull/59856) ([Kirill Nikiforov](https://github.com/allmazz))。
- コーデック`LZ4HC`は新しいレベル2を受け入れるようになりました。これは以前の最小レベル3よりも高速ですが、圧縮率は低下します。以前のバージョンでは、`LZ4HC(2)`以下は`LZ4HC(3)`と同じでした。作成者: [Cyan4973](https://github.com/Cyan4973)。[#60090](https://github.com/ClickHouse/ClickHouse/pull/60090) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- DNS問題のデバッグに役立つ`system.dns_cache`テーブルを実装しました。新しいサーバー設定dns_cache_max_size。[#60257](https://github.com/ClickHouse/ClickHouse/pull/60257) ([Kirill Nikiforov](https://github.com/allmazz))。
- `merge`テーブル関数の単一引数バージョン`merge(['db_name', ] 'tables_regexp')`をサポートしました。[#60372](https://github.com/ClickHouse/ClickHouse/pull/60372) ([豪肥肥](https://github.com/HowePa))。
- 負の位置引数をサポートしました。Closes [#57736](https://github.com/ClickHouse/ClickHouse/issues/57736)。[#58292](https://github.com/ClickHouse/ClickHouse/pull/58292) ([flynn](https://github.com/ucasfl))。
- 設定ファイルで`user`キーを使用して、特定のS3設定に対する許可ユーザーのセットを指定できるようになりました。[#60144](https://github.com/ClickHouse/ClickHouse/pull/60144) ([Antonio Andelic](https://github.com/antonio2368))。
- テーブル関数`mergeTreeIndex`を追加しました。これは`MergeTree`テーブルのインデックスとマークファイルの内容を表します。イントロスペクションに使用できます。構文: `mergeTreeIndex(database, table, [with_marks = true])`。ここで`database.table`は`MergeTree`エンジンを持つ既存のテーブルです。[#58140](https://github.com/ClickHouse/ClickHouse/pull/58140) ([Anton Popov](https://github.com/CurtizJ))。

#### 実験的機能 {#experimental-feature-8}

- Tukeyのフェンス法を使用して時系列データの外れ値を検出する関数`seriesOutliersDetectTukey`を追加しました。[#58632](https://github.com/ClickHouse/ClickHouse/pull/58632) ([Bhavna Jindal](https://github.com/bhavnajindal))。次のパッチリリースで動作が変更される予定であることに注意してください。
- 各行のバリアント型名を含むEnumを返す関数`variantType`を追加しました。[#59398](https://github.com/ClickHouse/ClickHouse/pull/59398) ([Kruglov Pavel](https://github.com/Avogar))。
- 並列レプリカに対して`LEFT JOIN`、`ALL INNER JOIN`、および単純なサブクエリをサポートしました(アナライザー使用時のみ)。新しい設定`parallel_replicas_prefer_local_join`は、ローカル`JOIN`実行(デフォルト)と`GLOBAL JOIN`のどちらを選択するかを決定します。すべてのテーブルは`cluster_for_parallel_replicas`の各レプリカに存在する必要があります。新しい設定`min_external_table_block_size_rows`と`min_external_table_block_size_bytes`は、一時テーブルに送信される小さなブロックをまとめるために使用されます(アナライザー使用時のみ)。[#58916](https://github.com/ClickHouse/ClickHouse/pull/58916) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 新しいレプリカの追加または復旧中に`Replicated`データベースでの同時テーブル作成を許可しました。[#59277](https://github.com/ClickHouse/ClickHouse/pull/59277) ([Konstantin Bogdanov](https://github.com/thevar1able))。
- `Variant`値の比較演算子と`Variant`カラムへの適切なField挿入を実装しました。デフォルトでは類似したバリアント型を持つ`Variant`型の作成を許可しません(設定`allow_suspicious_variant_types`で許可可能)。[#59996](https://github.com/ClickHouse/ClickHouse/issues/59996)を解決。[#59850](https://github.com/ClickHouse/ClickHouse/issues/59850)を解決。[#60198](https://github.com/ClickHouse/ClickHouse/pull/60198) ([Kruglov Pavel](https://github.com/Avogar))。
- CTEを使用した並列レプリカJOINを無効化しました(アナライザー非使用時) [#59239](https://github.com/ClickHouse/ClickHouse/pull/59239) ([Raúl Marín](https://github.com/Algunenano))。


#### パフォーマンス改善 {#performance-improvement-10}

- プライマリキーが使用するメモリ量が削減されます。[#60049](https://github.com/ClickHouse/ClickHouse/pull/60049) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- プライマリキーおよびその他の一部の操作におけるメモリ使用量が改善されます。[#60050](https://github.com/ClickHouse/ClickHouse/pull/60050) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- テーブルのプライマリキーは、最初のアクセス時に遅延ロードされるようになります。これは新しいMergeTree設定`primary_key_lazy_load`によって制御され、デフォルトで有効になっています。これにはいくつかの利点があります: - 使用されていないテーブルではロードされません; - メモリが不足している場合、サーバー起動時ではなく最初の使用時に例外がスローされます。これにはいくつかの欠点もあります: - プライマリキーのロードレイテンシは、接続を受け入れる前ではなく最初のクエリ時に発生します; これは理論的にはサンダリングハード問題を引き起こす可能性があります。これにより[#11188](https://github.com/ClickHouse/ClickHouse/issues/11188)がクローズされます。[#60093](https://github.com/ClickHouse/ClickHouse/pull/60093) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- ベクトル検索で使用される距離関数がベクトル化されました。[#58866](https://github.com/ClickHouse/ClickHouse/pull/58866) ([Robert Schulze](https://github.com/rschu1ze))。
- ベクトル検索に有用な`dotProduct`関数がベクトル化されました。[#60202](https://github.com/ClickHouse/ClickHouse/pull/60202) ([Robert Schulze](https://github.com/rschu1ze))。
- `dictGetOrDefault`関数にショートサーキット機能が追加されました。[#52098](https://github.com/ClickHouse/ClickHouse/issues/52098)をクローズします。[#57767](https://github.com/ClickHouse/ClickHouse/pull/57767) ([jsc0218](https://github.com/jsc0218))。
- Keeperの改善: `latest_logs_cache_size_threshold`および`commit_logs_cache_size_threshold`によって制御される一定量のログのみをメモリ内にキャッシュするようになりました。[#59460](https://github.com/ClickHouse/ClickHouse/pull/59460) ([Antonio Andelic](https://github.com/antonio2368))。
- Keeperの改善: データノードのサイズがさらに削減されました。[#59592](https://github.com/ClickHouse/ClickHouse/pull/59592) ([Antonio Andelic](https://github.com/antonio2368))。
- 結果型が`Float*/Decimal*/*Int*`の場合の`if`関数の分岐ミスの最適化を継続しました。https://github.com/ClickHouse/ClickHouse/pull/57885のフォローアップです。[#59148](https://github.com/ClickHouse/ClickHouse/pull/59148) ([李扬](https://github.com/taiyang-li))。
- 入力型が`Map`の場合の`if`関数を最適化し、最大約10倍の高速化を実現しました。[#59413](https://github.com/ClickHouse/ClickHouse/pull/59413) ([李扬](https://github.com/taiyang-li))。
- 厳密なエイリアシングを実装することで`Int8`型のパフォーマンスが向上しました（`UInt8`およびその他すべての整数型では既に実装済みです）。[#59485](https://github.com/ClickHouse/ClickHouse/pull/59485) ([Raúl Marín](https://github.com/Algunenano))。
- 分岐ミスを削減することで、bigintおよびbig decimal型の条件付きsum/avgのパフォーマンスを最適化しました。[#59504](https://github.com/ClickHouse/ClickHouse/pull/59504) ([李扬](https://github.com/taiyang-li))。
- アクティブなミューテーションがある場合のSELECTのパフォーマンスが向上しました。[#59531](https://github.com/ClickHouse/ClickHouse/pull/59531) ([Azat Khuzhin](https://github.com/azat))。
- AVX2を使用して`isNotNull`関数を最適化しました。[#59621](https://github.com/ClickHouse/ClickHouse/pull/59621) ([李扬](https://github.com/taiyang-li))。
- ソート済みまたはほぼソート済みのデータに対するASOF JOINのパフォーマンスが向上しました。[#59731](https://github.com/ClickHouse/ClickHouse/pull/59731) ([Maksim Kita](https://github.com/kitaisreal))。
- `async_insert_max_data_size`の以前のデフォルト値である1 MBは小さすぎることが判明しました。新しい値は10 MiBになります。[#59536](https://github.com/ClickHouse/ClickHouse/pull/59536) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- RESTOREコマンドの実行中にバックアップからテーブルのメタデータを読み取る際に、複数のスレッドを使用するようになりました。[#60040](https://github.com/ClickHouse/ClickHouse/pull/60040) ([Vitaly Baranov](https://github.com/vitlibar))。
- `StorageBuffer`が複数のシャード（`num_layers` > 1）を持つ場合、バックグラウンドフラッシュがすべてのシャードに対して複数のスレッドで同時に実行されるようになりました。[#60111](https://github.com/ClickHouse/ClickHouse/pull/60111) ([alesapin](https://github.com/alesapin))。





#### 改善 {#improvement-10}

- 出力フォーマットが`Pretty`形式で、ブロックが100万を超える単一の数値で構成されている場合、読みやすい数値がテーブルの右側に表示されます。[#60379](https://github.com/ClickHouse/ClickHouse/pull/60379) ([rogeryk](https://github.com/rogeryk))。
- 設定`split_parts_ranges_into_intersecting_and_non_intersecting_final`と`split_intersecting_parts_ranges_into_layers_final`を追加しました。これらの設定は`FINAL`を使用するクエリの最適化を無効にするために必要であり、デバッグ専用です。[#59705](https://github.com/ClickHouse/ClickHouse/pull/59705) ([Maksim Kita](https://github.com/kitaisreal))。実際にはそれだけでなく、パフォーマンスを犠牲にしてメモリ使用量を削減することもできます。
- 設定`extract_kvp_max_pairs_per_row`を`extract_key_value_pairs_max_pairs_per_row`に名称変更しました。この問題(設定名の不要な略語)はhttps://github.com/ClickHouse/ClickHouse/pull/43606で導入されました。この設定のドキュメントを修正しました。[#59683](https://github.com/ClickHouse/ClickHouse/pull/59683) ([Alexey Milovidov](https://github.com/alexey-milovidov))。[#59960](https://github.com/ClickHouse/ClickHouse/pull/59960) ([jsc0218](https://github.com/jsc0218))。
- `DEFAULT`または`MATERIALIZED`式を持つカラムに対して`ALTER COLUMN MATERIALIZE`を実行すると、セマンティクスに正確に従うようになりました。[#58023](https://github.com/ClickHouse/ClickHouse/pull/58023) ([Duc Canh Le](https://github.com/canhld94))。
- ミューテーション中のエラーに対する指数バックオフロジックを有効にしました。これによりCPU使用量、メモリ使用量、ログファイルサイズが削減されます。[#58036](https://github.com/ClickHouse/ClickHouse/pull/58036) ([MikhailBurdukov](https://github.com/MikhailBurdukov))。
- `InitialQuery`プロファイルイベントをカウントする改善を追加しました。[#58195](https://github.com/ClickHouse/ClickHouse/pull/58195) ([Unalian](https://github.com/Unalian))。
- `storage_configuration`で`volume_priority`を定義できるようになりました。[#58533](https://github.com/ClickHouse/ClickHouse/pull/58533) ([Andrey Zvonov](https://github.com/zvonand))。
- `T64`コーデックで`Date32`型のサポートを追加しました。[#58738](https://github.com/ClickHouse/ClickHouse/pull/58738) ([Hongbin Ma](https://github.com/binmahone))。
- 複数の項目を持つ型で末尾のカンマを許可するようになりました。[#59119](https://github.com/ClickHouse/ClickHouse/pull/59119) ([Aleksandr Musorin](https://github.com/AVMusorin))。
- Distributedテーブルエンジンの設定をサーバー設定ファイルで指定できるようになりました(MergeTree設定と同様)。例:`<distributed> <flush_on_detach>false</flush_on_detach> </distributed>`。[#59291](https://github.com/ClickHouse/ClickHouse/pull/59291) ([Azat Khuzhin](https://github.com/azat))。
- `system.zookeeper`の読み取り時に切断と期限切れセッションを再試行するようになりました。これは、特に障害注入された切断が存在する場合に`system.zookeeper`テーブルから多数の行を読み取る際に役立ちます。[#59388](https://github.com/ClickHouse/ClickHouse/pull/59388) ([Alexander Gololobov](https://github.com/davenger))。
- `input_format_values_interpret_expressions=0`の場合、先頭にゼロがある数値を8進数として解釈しないようになりました。[#59403](https://github.com/ClickHouse/ClickHouse/pull/59403) ([Joanna Hulboj](https://github.com/jh0x))。
- 起動時および設定ファイルが変更されるたびに、ClickHouseは合計メモリトラッカーのハードメモリ制限を更新します。これらの制限は、さまざまなサーバー設定とcgroups制限(Linux上)に基づいて計算されます。以前は、`/sys/fs/cgroup/memory.max`(cgroups v2用)の設定がハードコードされていました。その結果、ネストされたグループ(階層)に対して設定されたcgroup v2メモリ制限、例えば`/sys/fs/cgroup/my/nested/group/memory.max`は無視されていました。これが修正されました。v1メモリ制限の動作は変更されていません。[#59435](https://github.com/ClickHouse/ClickHouse/pull/59435) ([Robert Schulze](https://github.com/rschu1ze))。
- `INSERT`中にプライマリキー/プロジェクション/セカンダリインデックスの計算に費やされた時間を観測するための新しいプロファイルイベントを追加しました。[#59436](https://github.com/ClickHouse/ClickHouse/pull/59436) ([Nikita Taranov](https://github.com/nickitat))。
- 設定`s3queue_last_processed_path`を使用して、作成時にOrderedモードのS3Queueの開始点を定義できるようになりました。[#59446](https://github.com/ClickHouse/ClickHouse/pull/59446) ([Kseniia Sumarokova](https://github.com/kssenii))。
- `clickhouse-local`の`system.tables`でシステムテーブルのコメントも利用できるようにしました。[#59493](https://github.com/ClickHouse/ClickHouse/pull/59493) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- `system.zookeeper`テーブル:以前は結果全体がメモリに蓄積され、1つの大きなチャンクとして返されていました。この変更により、`system.zookeeper`から多数の行を読み取る際のメモリ消費量を削減し、中間進捗(これまでに読み取られた行数)を表示できるようにし、結果セットが大きい場合の接続タイムアウトを回避できるようになります。[#59545](https://github.com/ClickHouse/ClickHouse/pull/59545) ([Alexander Gololobov](https://github.com/davenger))。
- ダッシュボードがURLの#hashの圧縮状態と非圧縮状態の両方を理解するようになりました(後方互換性)。[#59124](https://github.com/ClickHouse/ClickHouse/issues/59124)の続きです。[#59548](https://github.com/ClickHouse/ClickHouse/pull/59548) ([Amos Bird](https://github.com/amosbird))。
- Intel QPL(コーデック`DEFLATE_QPL`で使用)をv1.3.1からv1.4.0にアップグレードしました。また、ポーリングタイムアウトメカニズムのバグを修正しました。同じケースでタイムアウトが正しく機能せず、タイムアウトが発生した場合、IAAとCPUがバッファを同時に処理する可能性があることを確認しました。現時点では、IAAコーデックのステータスがQPL_STS_BEING_PROCESSEDでないことを確認してから、SWコーデックにフォールバックする方が良いでしょう。[#59551](https://github.com/ClickHouse/ClickHouse/pull/59551) ([jasperzhu](https://github.com/jinjunzh))。
- ClickHouse Cloudではサーバーバージョンに関する警告を表示しないようにしました。ClickHouse Cloudはシームレスなアップグレードを自動的に処理するためです。[#59657](https://github.com/ClickHouse/ClickHouse/pull/59657) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 自己展開後、一時バイナリはコピーではなく移動されるようになりました。[#59661](https://github.com/ClickHouse/ClickHouse/pull/59661) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
- Apple macOSでのスタックアンワインディングを修正しました。これにより[#53653](https://github.com/ClickHouse/ClickHouse/issues/53653)がクローズされます。[#59690](https://github.com/ClickHouse/ClickHouse/pull/59690) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- ユーザーが`max_parser_depth`設定を非常に高い値に誤設定した場合でも、パーサーでスタックオーバーフローをチェックするようになりました。これにより[#59622](https://github.com/ClickHouse/ClickHouse/issues/59622)がクローズされます。[#59697](https://github.com/ClickHouse/ClickHouse/pull/59697) ([Alexey Milovidov](https://github.com/alexey-milovidov))。[#60434](https://github.com/ClickHouse/ClickHouse/pull/60434)
- KafkaストレージにおけるXMLおよびSQLで作成された名前付きコレクションの動作を統一しました。[#59710](https://github.com/ClickHouse/ClickHouse/pull/59710) ([Pervakov Grigorii](https://github.com/GrigoryPervakov))。
- `merge_max_block_size_bytes`が十分に小さく、テーブルに幅の広い行(文字列またはタプル)が含まれている場合、バックグラウンドマージが無限ループでスタックする可能性がありました。この動作を修正しました。https://github.com/ClickHouse/ClickHouse/pull/59340のフォローアップです。[#59812](https://github.com/ClickHouse/ClickHouse/pull/59812) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- CREATE TABLEで明示的に指定されている場合、replica_pathでuuidを許可するようになりました。[#59908](https://github.com/ClickHouse/ClickHouse/pull/59908) ([Azat Khuzhin](https://github.com/azat))。
- `system.tables`システムテーブルにReplicatedMergeTreeテーブルの`metadata_version`カラムを追加しました。[#59942](https://github.com/ClickHouse/ClickHouse/pull/59942) ([Maksim Kita](https://github.com/kitaisreal))。
- Keeperの改善:Prometheus向けにKeeper関連のメトリクス/イベントのみを送信するようにしました。[#59945](https://github.com/ClickHouse/ClickHouse/pull/59945) ([Antonio Andelic](https://github.com/antonio2368))。
- アップグレード後にシステムテーブルの構造が変更された場合でも、ダッシュボードは異なるClickHouseバージョン間でメトリクスを表示します。[#59967](https://github.com/ClickHouse/ClickHouse/pull/59967) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- ファイルからAZ情報を読み込めるようになりました。[#59976](https://github.com/ClickHouse/ClickHouse/pull/59976) ([Konstantin Bogdanov](https://github.com/thevar1able))。
- Keeperの改善:ディスク関連操作の失敗時に再試行を追加しました。[#59980](https://github.com/ClickHouse/ClickHouse/pull/59980) ([Antonio Andelic](https://github.com/antonio2368))。
- 新しい設定`backups.remove_backup_files_after_failure`を追加しました:`<clickhouse> <backups> <remove_backup_files_after_failure>true</remove_backup_files_after_failure> </backups> </clickhouse>`。[#60002](https://github.com/ClickHouse/ClickHouse/pull/60002) ([Vitaly Baranov](https://github.com/vitlibar))。
- GCPが`GATEWAY_TIMEOUT` HTTPエラーコードで`Internal Error`を返した場合、S3ファイルのGCPフォールバックをバッファコピーにコピーするようにしました。[#60164](https://github.com/ClickHouse/ClickHouse/pull/60164) ([Maksim Kita](https://github.com/kitaisreal))。
- `ULIDStringToDateTime`のショートサーキット実行を追加しました。[#60211](https://github.com/ClickHouse/ClickHouse/pull/60211) ([Juan Madurga](https://github.com/jlmadurga))。
- テーブル`system.backups`と`system.backup_log`に`query_id`カラムを追加しました。`error`カラムにエラースタックトレースを追加しました。[#60220](https://github.com/ClickHouse/ClickHouse/pull/60220) ([Maksim Kita](https://github.com/kitaisreal))。
- MySQLポート経由の接続は、QuickSightをすぐに使えるようにするため、設定`prefer_column_name_to_alias = 1`で自動的に実行されるようになりました。また、設定`mysql_map_string_to_text_in_show_columns`と`mysql_map_fixed_string_to_text_in_show_columns`がデフォルトで有効になり、MySQL接続のみに影響します。これにより、より多くのBIツールとの互換性が向上します。[#60365](https://github.com/ClickHouse/ClickHouse/pull/60365) ([Robert Schulze](https://github.com/rschu1ze))。
- JavaScriptコードの競合状態を修正し、チャートが重複して表示される問題を解決しました。[#60392](https://github.com/ClickHouse/ClickHouse/pull/60392) ([Alexey Milovidov](https://github.com/alexey-milovidov))。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-6}

- イントロスペクション機能を用いたカバレッジ収集を含むビルドとテストを追加しました。[#56102](https://github.com/ClickHouse/ClickHouse/issues/56102)の続きです。[#58792](https://github.com/ClickHouse/ClickHouse/pull/58792) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- CMakeクロスコンパイルツールチェーン変数が設定されている場合、`corrosion-cmake`内のRustツールチェーンを更新します。[#59309](https://github.com/ClickHouse/ClickHouse/pull/59309) ([Aris Tritas](https://github.com/aris-aiven))。
- ASTLiteralsにファジングを追加しました。[#59383](https://github.com/ClickHouse/ClickHouse/pull/59383) ([Raúl Marín](https://github.com/Algunenano))。
- ClickHouseコンテナの起動時に毎回initdbスクリプトを実行する場合は、環境変数CLICKHOUSE_ALWAYS_RUN_INITDB_SCRIPTSを初期化してください。[#59808](https://github.com/ClickHouse/ClickHouse/pull/59808) ([Alexander Nikolaev](https://github.com/AlexNik))。
- 汎用的なClickHouseコンポーネント(server/clientなど)を無効化する機能を削除しましたが、追加ライブラリを必要とするもの(ODBCやkeeperなど)は維持しています。[#59857](https://github.com/ClickHouse/ClickHouse/pull/59857) ([Azat Khuzhin](https://github.com/azat))。
- クエリファザーがクエリ内のSETTINGSをファジングするようになりました。[#60087](https://github.com/ClickHouse/ClickHouse/pull/60087) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- clang-19(master)を使用したClickHouseのビルドサポートを追加しました。[#60448](https://github.com/ClickHouse/ClickHouse/pull/60448) ([Alexey Milovidov](https://github.com/alexey-milovidov))。


#### バグ修正（公式安定版リリースにおけるユーザーに見える不具合） {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-8}

- Fix a "Non-ready set" error in TTL WHERE. [#57430](https://github.com/ClickHouse/ClickHouse/pull/57430) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix a bug in the `quantilesGK` function [#58216](https://github.com/ClickHouse/ClickHouse/pull/58216) ([李扬](https://github.com/taiyang-li)).
- Fix a wrong behavior with `intDiv` for Decimal arguments [#59243](https://github.com/ClickHouse/ClickHouse/pull/59243) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fix `translate` with FixedString input [#59356](https://github.com/ClickHouse/ClickHouse/pull/59356) ([Raúl Marín](https://github.com/Algunenano)).
- Fix digest calculation in Keeper [#59439](https://github.com/ClickHouse/ClickHouse/pull/59439) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix stacktraces for binaries without debug symbols [#59444](https://github.com/ClickHouse/ClickHouse/pull/59444) ([Azat Khuzhin](https://github.com/azat)).
- Fix `ASTAlterCommand::formatImpl` in case of column specific settings... [#59445](https://github.com/ClickHouse/ClickHouse/pull/59445) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fix `SELECT * FROM [...] ORDER BY ALL` with Analyzer [#59462](https://github.com/ClickHouse/ClickHouse/pull/59462) ([zhongyuankai](https://github.com/zhongyuankai)).
- Fix possible uncaught exception during distributed query cancellation [#59487](https://github.com/ClickHouse/ClickHouse/pull/59487) ([Azat Khuzhin](https://github.com/azat)).
- Make MAX use the same rules as permutation for complex types [#59498](https://github.com/ClickHouse/ClickHouse/pull/59498) ([Raúl Marín](https://github.com/Algunenano)).
- Fix corner case when passing `update_insert_deduplication_token_in_dependent_materialized_views` [#59544](https://github.com/ClickHouse/ClickHouse/pull/59544) ([Jordi Villar](https://github.com/jrdi)).
- Fix incorrect result of arrayElement / map on empty value [#59594](https://github.com/ClickHouse/ClickHouse/pull/59594) ([Raúl Marín](https://github.com/Algunenano)).
- Fix crash in topK when merging empty states [#59603](https://github.com/ClickHouse/ClickHouse/pull/59603) ([Raúl Marín](https://github.com/Algunenano)).
- Fix distributed table with a constant sharding key [#59606](https://github.com/ClickHouse/ClickHouse/pull/59606) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix KQL issue found by WingFuzz [#59626](https://github.com/ClickHouse/ClickHouse/pull/59626) ([Yong Wang](https://github.com/kashwy)).
- Fix error "Read beyond last offset" for AsynchronousBoundedReadBuffer [#59630](https://github.com/ClickHouse/ClickHouse/pull/59630) ([Vitaly Baranov](https://github.com/vitlibar)).
- Maintain function alias in RewriteSumFunctionWithSumAndCountVisitor [#59658](https://github.com/ClickHouse/ClickHouse/pull/59658) ([Raúl Marín](https://github.com/Algunenano)).
- Fix query start time on non initial queries [#59662](https://github.com/ClickHouse/ClickHouse/pull/59662) ([Raúl Marín](https://github.com/Algunenano)).
- Validate types of arguments for `minmax` skipping index [#59733](https://github.com/ClickHouse/ClickHouse/pull/59733) ([Anton Popov](https://github.com/CurtizJ)).
- Fix leftPad / rightPad function with FixedString input [#59739](https://github.com/ClickHouse/ClickHouse/pull/59739) ([Raúl Marín](https://github.com/Algunenano)).
- Fix AST fuzzer issue in function `countMatches` [#59752](https://github.com/ClickHouse/ClickHouse/pull/59752) ([Robert Schulze](https://github.com/rschu1ze)).
- RabbitMQ: fix having neither acked nor nacked messages [#59775](https://github.com/ClickHouse/ClickHouse/pull/59775) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix StorageURL doing some of the query execution in single thread [#59833](https://github.com/ClickHouse/ClickHouse/pull/59833) ([Michael Kolupaev](https://github.com/al13n321)).
- S3Queue: fix uninitialized value [#59897](https://github.com/ClickHouse/ClickHouse/pull/59897) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix parsing of partition expressions surrounded by parens [#59901](https://github.com/ClickHouse/ClickHouse/pull/59901) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fix crash in JSONColumnsWithMetadata format over HTTP [#59925](https://github.com/ClickHouse/ClickHouse/pull/59925) ([Kruglov Pavel](https://github.com/Avogar)).
- Do not rewrite sum to count if the return value differs in Analyzer [#59926](https://github.com/ClickHouse/ClickHouse/pull/59926) ([Azat Khuzhin](https://github.com/azat)).
- UniqExactSet read crash fix [#59928](https://github.com/ClickHouse/ClickHouse/pull/59928) ([Maksim Kita](https://github.com/kitaisreal)).
- ReplicatedMergeTree invalid metadata_version fix [#59946](https://github.com/ClickHouse/ClickHouse/pull/59946) ([Maksim Kita](https://github.com/kitaisreal)).
- Fix data race in `StorageDistributed` [#59987](https://github.com/ClickHouse/ClickHouse/pull/59987) ([Nikita Taranov](https://github.com/nickitat)).
- Docker: run init scripts when option is enabled rather than disabled [#59991](https://github.com/ClickHouse/ClickHouse/pull/59991) ([jktng](https://github.com/jktng)).
- Fix INSERT into `SQLite` with single quote (by escaping single quotes with a quote instead of backslash) [#60015](https://github.com/ClickHouse/ClickHouse/pull/60015) ([Azat Khuzhin](https://github.com/azat)).
- Fix several logical errors in `arrayFold` [#60022](https://github.com/ClickHouse/ClickHouse/pull/60022) ([Raúl Marín](https://github.com/Algunenano)).
- Fix optimize_uniq_to_count removing the column alias [#60026](https://github.com/ClickHouse/ClickHouse/pull/60026) ([Raúl Marín](https://github.com/Algunenano)).
- Fix possible exception from S3Queue table on drop [#60036](https://github.com/ClickHouse/ClickHouse/pull/60036) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix formatting of NOT with single literals [#60042](https://github.com/ClickHouse/ClickHouse/pull/60042) ([Raúl Marín](https://github.com/Algunenano)).
- Use max_query_size from context in DDLLogEntry instead of hardcoded 4096 [#60083](https://github.com/ClickHouse/ClickHouse/pull/60083) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix inconsistent formatting of queries containing tables named `table`. Fix wrong formatting of queries with `UNION ALL`, `INTERSECT`, and `EXCEPT` when their structure wasn't linear. This closes #52349. Fix wrong formatting of `SYSTEM` queries, including `SYSTEM ... DROP FILESYSTEM CACHE`, `SYSTEM ... REFRESH/START/STOP/CANCEL/TEST VIEW`, `SYSTEM ENABLE/DISABLE FAILPOINT`. Fix formatting of parameterized DDL queries. Fix the formatting of the `DESCRIBE FILESYSTEM CACHE` query. Fix incorrect formatting of the `SET param_...` (a query setting a parameter). Fix incorrect formatting of `CREATE INDEX` queries. Fix inconsistent formatting of `CREATE USER` and similar queries. Fix inconsistent formatting of `CREATE SETTINGS PROFILE`. Fix incorrect formatting of `ALTER ... MODIFY REFRESH`. Fix inconsistent formatting of window functions if frame offsets were expressions. Fix inconsistent formatting of `RESPECT NULLS` and `IGNORE NULLS` if they were used after a function that implements an operator (such as `plus`). Fix idiotic formatting of `SYSTEM SYNC REPLICA ... LIGHTWEIGHT FROM ...`. Fix inconsistent formatting of invalid queries with `GROUP BY GROUPING SETS ... WITH ROLLUP/CUBE/TOTALS`. Fix inconsistent formatting of `GRANT CURRENT GRANTS`. Fix inconsistent formatting of `CREATE TABLE (... COLLATE)`. Additionally, I fixed the incorrect formatting of `EXPLAIN` in subqueries (#60102). Fixed incorrect formatting of lambda functions (#60012). Added a check so there is no way to miss these abominations in the future. [#60095](https://github.com/ClickHouse/ClickHouse/pull/60095) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix inconsistent formatting of explain in subqueries [#60102](https://github.com/ClickHouse/ClickHouse/pull/60102) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix cosineDistance crash with Nullable [#60150](https://github.com/ClickHouse/ClickHouse/pull/60150) ([Raúl Marín](https://github.com/Algunenano)).
- Allow casting of bools in string representation to true bools [#60160](https://github.com/ClickHouse/ClickHouse/pull/60160) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix `system.s3queue_log` [#60166](https://github.com/ClickHouse/ClickHouse/pull/60166) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix arrayReduce with nullable aggregate function name [#60188](https://github.com/ClickHouse/ClickHouse/pull/60188) ([Raúl Marín](https://github.com/Algunenano)).
- Hide sensitive info for `S3Queue` [#60233](https://github.com/ClickHouse/ClickHouse/pull/60233) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix http exception codes. [#60252](https://github.com/ClickHouse/ClickHouse/pull/60252) ([Austin Kothig](https://github.com/kothiga)).
- S3Queue: fix a bug (also fixes flaky test_storage_s3_queue/test.py::test_shards_distributed) [#60282](https://github.com/ClickHouse/ClickHouse/pull/60282) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix use-of-uninitialized-value and invalid result in hashing functions with IPv6 [#60359](https://github.com/ClickHouse/ClickHouse/pull/60359) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix OptimizeDateOrDateTimeConverterWithPreimageVisitor with null arguments [#60453](https://github.com/ClickHouse/ClickHouse/pull/60453) ([Raúl Marín](https://github.com/Algunenano)).
- Fixed a minor bug that prevented distributed table queries sent from either KQL or PRQL dialect clients to be executed on replicas. [#59674](https://github.com/ClickHouse/ClickHouse/issues/59674). [#60470](https://github.com/ClickHouse/ClickHouse/pull/60470) ([Alexey Milovidov](https://github.com/alexey-milovidov)) [#59674](https://github.com/ClickHouse/ClickHouse/pull/59674) ([Austin Kothig](https://github.com/kothiga)).

### <a id="241"></a> ClickHouseリリース24.1、2024-01-30 {#a-id241a-clickhouse-release-241-2024-01-30}

#### 後方互換性のない変更 {#backward-incompatible-change-9}

- 設定`print_pretty_type_names`がデフォルトで有効になりました。以前の動作を維持するには、この設定を無効にするか、`SET compatibility = '23.12'`を実行してください。[#57726](https://github.com/ClickHouse/ClickHouse/pull/57726) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- MergeTree設定`clean_deleted_rows`は非推奨となり、効果がなくなりました。`OPTIMIZE`の`CLEANUP`キーワードはデフォルトでは使用できません(`allow_experimental_replacing_merge_with_cleanup`が有効な場合を除く)。[#58316](https://github.com/ClickHouse/ClickHouse/pull/58316) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 関数`reverseDNSQuery`は利用できなくなりました。これにより[#58368](https://github.com/ClickHouse/ClickHouse/issues/58368)がクローズされます。[#58369](https://github.com/ClickHouse/ClickHouse/pull/58369) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 設定ファイルのアクセス制御を改善するための様々な変更が有効になりました。これらの変更は動作に影響するため、`config.xml`の`access_control_improvements`セクションを確認してください。不明な点がある場合は、設定ファイルの値を以前のバージョンのままにしてください。[#58584](https://github.com/ClickHouse/ClickHouse/pull/58584) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- NaN値を含む`sumMapFiltered`の動作が改善されました。NaN値は(ランダムではなく)末尾に配置され、他のすべての値と異なるものとして扱われるようになりました。また、`-0`は`0`と等しいものとして扱われるようになり、0の値が破棄されるため、`-0`の値も破棄されます。[#58959](https://github.com/ClickHouse/ClickHouse/pull/58959) ([Raúl Marín](https://github.com/Algunenano))。
- 関数`visibleWidth`がドキュメントに従って動作するようになりました。以前のバージョンでは、`lengthUTF8`関数のように文字列のシリアライズ後のコードポイントを単純にカウントしていましたが、ゼロ幅文字や結合文字、全角文字、タブ、削除文字を考慮していませんでした。現在、動作はそれに応じて変更されています。以前の動作を維持したい場合は、`function_visible_width_behavior`を`0`に設定するか、`compatibility`を`23.12`以下に設定してください。[#59022](https://github.com/ClickHouse/ClickHouse/pull/59022) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `Kusto`ダイアレクトは、次の2つのバグが修正されるまで無効化されています:[#59037](https://github.com/ClickHouse/ClickHouse/issues/59037)および[#59036](https://github.com/ClickHouse/ClickHouse/issues/59036)。[#59305](https://github.com/ClickHouse/ClickHouse/pull/59305) ([Alexey Milovidov](https://github.com/alexey-milovidov))。`Kusto`を使用しようとすると例外が発生します。
- `FINAL`修飾子のより効率的な実装により、`max_threads = 1`の場合でも順序の保持が保証されなくなりました。以前の動作に依存していた場合は、`enable_vertical_final`を0に設定するか、`compatibility`を`23.12`に設定してください。


#### 新機能 {#new-feature-11}

- 他のデータ型の和集合を表すVariantデータ型を実装しました。`Variant(T1, T2, ..., TN)`型は、この型の各行が`T1`型、`T2`型、...、`TN`型のいずれか、またはそのいずれでもない値(`NULL`値)を持つことを意味します。Variant型は`allow_experimental_variant_type`設定で利用可能です。参照: [#54864](https://github.com/ClickHouse/ClickHouse/issues/54864). [#58047](https://github.com/ClickHouse/ClickHouse/pull/58047) ([Kruglov Pavel](https://github.com/Avogar)).
- 特定の設定(現在は`min_compress_block_size`と`max_compress_block_size`)をカラムレベルで指定できるようになり、対応するテーブルレベルの設定よりも優先されます。例: `CREATE TABLE tab (col String SETTINGS (min_compress_block_size = 81920, max_compress_block_size = 163840)) ENGINE = MergeTree ORDER BY tuple();`. [#55201](https://github.com/ClickHouse/ClickHouse/pull/55201) ([Duc Canh Le](https://github.com/canhld94)).
- `quantileDD`集約関数と、対応する`quantilesDD`および`medianDD`を追加しました。これはDDSketch https://www.vldb.org/pvldb/vol12/p2195-masson.pdf に基づいています。### ユーザー向け変更のドキュメントエントリ。[#56342](https://github.com/ClickHouse/ClickHouse/pull/56342) ([Srikanth Chekuri](https://github.com/srikanthccv)).
- あらゆる種類のオブジェクトストレージをあらゆる種類のメタデータ型で設定できるようになりました。[#58357](https://github.com/ClickHouse/ClickHouse/pull/58357) ([Kseniia Sumarokova](https://github.com/kssenii)).
- `distributed_ddl_output_mode`に`null_status_on_timeout_only_active`と`throw_only_active`モードを追加し、非アクティブなレプリカの待機を回避できるようにしました。[#58350](https://github.com/ClickHouse/ClickHouse/pull/58350) ([Alexander Tokmakov](https://github.com/tavplubix)).
- サブ配列を計算する`arrayShingles`関数を追加しました。例えば、`arrayShingles([1, 2, 3, 4, 5], 3)`は`[[1,2,3],[2,3,4],[3,4,5]]`を返します。[#58396](https://github.com/ClickHouse/ClickHouse/pull/58396) ([Zheng Miao](https://github.com/zenmiao7)).
- IDNA標準に従って国際ドメイン名をASCII表現に変換するのに便利な`punycodeEncode`、`punycodeDecode`、`idnaEncode`、`idnaDecode`関数を追加しました。[#58454](https://github.com/ClickHouse/ClickHouse/pull/58454) ([Robert Schulze](https://github.com/rschu1ze)).
- 文字列類似度関数`dramerauLevenshteinDistance`、`jaroSimilarity`、`jaroWinklerSimilarity`を追加しました。[#58531](https://github.com/ClickHouse/ClickHouse/pull/58531) ([Robert Schulze](https://github.com/rschu1ze)).
- 出力圧縮レベルを変更する`output_format_compression_level`と、圧縮ウィンドウサイズを明示的に設定し、出力圧縮方式が`zstd`の場合にzstd圧縮の長距離モードを有効にする`output_format_compression_zstd_window_log`の2つの設定を追加しました。`INTO OUTFILE`および`file`、`url`、`hdfs`、`s3`、`azureBlobStorage`テーブル関数への書き込み時に適用されます。[#58539](https://github.com/ClickHouse/ClickHouse/pull/58539) ([Duc Canh Le](https://github.com/canhld94)).
- 出力が端末でない場合、Pretty形式でANSIエスケープシーケンスを自動的に無効化します。`output_format_pretty_color`設定に新しい`auto`モードを追加しました。[#58614](https://github.com/ClickHouse/ClickHouse/pull/58614) ([Shaun Struwig](https://github.com/Blargian)).
- [Sqids](https://sqids.org/)をデコードする`sqidDecode`関数を追加しました。[#58544](https://github.com/ClickHouse/ClickHouse/pull/58544) ([Robert Schulze](https://github.com/rschu1ze)).
- JSON入力形式でBool値をStringとして読み取れるようにしました。これはデフォルトで有効になっている`input_format_json_read_bools_as_strings`設定で行われます。[#58561](https://github.com/ClickHouse/ClickHouse/pull/58561) ([Kruglov Pavel](https://github.com/Avogar)).
- 時系列を季節成分、トレンド成分、残差成分に分解する`seriesDecomposeSTL`関数を追加しました。[#57078](https://github.com/ClickHouse/ClickHouse/pull/57078) ([Bhavna Jindal](https://github.com/bhavnajindal)).
- MaterializedMySQL用のMySQL Binlogクライアントを導入しました: 複数のデータベースに対して1つのbinlog接続。[#57323](https://github.com/ClickHouse/ClickHouse/pull/57323) ([Val Doroshchuk](https://github.com/valbok)).
- Intel QuickAssist Technology (QAT)はハードウェアアクセラレーション圧縮と暗号化を提供します。ClickHouseにzstd圧縮にQATを利用する新しい圧縮コーデック`ZSTD_QAT`が追加されました。このコーデックは[IntelのQATlib](https://github.com/intel/qatlib)と[IntelのQAT ZSTDプラグイン](https://github.com/intel/QAT-ZSTD-Plugin)を使用します。現在、ハードウェアでアクセラレーションできるのは圧縮のみで(QATを初期化できない場合はソフトウェアフォールバックが作動します)、解凍は常にソフトウェアで実行されます。[#57509](https://github.com/ClickHouse/ClickHouse/pull/57509) ([jasperzhu](https://github.com/jinjunzh)).
- s3ディスク用のオブジェクトストレージキーの生成方法を新しく実装しました。ディスク記述の`key_template`オプションで`re2`正規表現構文を使用して形式を定義できるようになりました。[#57663](https://github.com/ClickHouse/ClickHouse/pull/57663) ([Sema Checherinda](https://github.com/CheSema)).
- system.dropped_tables_partsテーブルには、system.dropped_tablesテーブル(削除されたがまだ除去されていないテーブル)のパーツが含まれます。[#58038](https://github.com/ClickHouse/ClickHouse/pull/58038) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- テーブルにアタッチされるマテリアライズドビューの数を制限する`max_materialized_views_size_for_table`設定を追加しました。[#58068](https://github.com/ClickHouse/ClickHouse/pull/58068) ([zhongyuankai](https://github.com/zhongyuankai)).
- `clickhouse-format`の改善: `VALUES`を含むINSERTクエリのサポート、コメントのサポート(`--comments`を使用して出力)、長いクエリのみを複数行でフォーマットする`--max_line_length`オプションのサポート。[#58246](https://github.com/ClickHouse/ClickHouse/pull/58246) ([vdimir](https://github.com/vdimir)).
- `clickhouse-local`で`system.parts`を含むすべてのシステムテーブルをアタッチします。これにより[#58312](https://github.com/ClickHouse/ClickHouse/issues/58312)が解決されます。[#58359](https://github.com/ClickHouse/ClickHouse/pull/58359) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- `transform`関数で`Enum`データ型をサポートしました。これにより[#58241](https://github.com/ClickHouse/ClickHouse/issues/58241)が解決されます。[#58360](https://github.com/ClickHouse/ClickHouse/pull/58360) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- `system.database_engines`テーブルを追加しました。[#58390](https://github.com/ClickHouse/ClickHouse/pull/58390) ([Bharat Nallan](https://github.com/bharatnc)). コードベースでデータベースエンジンを独立して登録できるようにしました。[#58365](https://github.com/ClickHouse/ClickHouse/pull/58365) ([Bharat Nallan](https://github.com/bharatnc)). インタープリターを独立して登録できるようにしました。[#58443](https://github.com/ClickHouse/ClickHouse/pull/58443) ([Bharat Nallan](https://github.com/bharatnc)).
- `SYSTEM SYNC REPLICA LIGHTWEIGHT`クエリに`FROM <Replicas>`修飾子を追加しました。`FROM`修飾子を使用すると、指定されたソースレプリカ、およびzookeeperに存在しないレプリカまたはsource_replicaが空のレプリカに対してのみ、フェッチとドロップ範囲を待機します。[#58393](https://github.com/ClickHouse/ClickHouse/pull/58393) ([Jayme Bird](https://github.com/jaymebrd)).
- `update_insert_deduplication_token_in_dependent_materialized_views`設定を追加しました。この設定により、依存マテリアライズドビューへの挿入時に、挿入重複排除トークンをテーブル識別子で更新できます。[#59165](https://github.com/ClickHouse/ClickHouse/issues/59165)を解決します。[#59238](https://github.com/ClickHouse/ClickHouse/pull/59238) ([Maksim Kita](https://github.com/kitaisreal)).
- 非同期メトリクスを更新する`SYSTEM RELOAD ASYNCHRONOUS METRICS`ステートメントを追加しました。主にテストと開発に役立ちます。[#53710](https://github.com/ClickHouse/ClickHouse/pull/53710) ([Robert Schulze](https://github.com/rschu1ze)).





#### パフォーマンス改善 {#performance-improvement-11}

- 並列レプリカのコーディネーション機能が、並列性とキャッシュ局所性の向上のために書き直されました。数百のレプリカでの線形スケーラビリティがテストされています。また、順序付き読み取りのサポートも追加されました。[#57968](https://github.com/ClickHouse/ClickHouse/pull/57968) ([Nikita Taranov](https://github.com/nickitat))。
- HTTPアウトバウンドバッファリングをネイティブのClickHouseバッファに置き換えました。インターフェース用のバイトカウントメトリクスを追加しました。[#56064](https://github.com/ClickHouse/ClickHouse/pull/56064) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
- 分散クエリにおいて、`uniqExact`の大規模な集約状態が並列でマージされるようになりました。[#59009](https://github.com/ClickHouse/ClickHouse/pull/59009) ([Nikita Taranov](https://github.com/nickitat))。
- `MergeTree`テーブルからの読み取り後のメモリ使用量を削減しました。[#59290](https://github.com/ClickHouse/ClickHouse/pull/59290) ([Anton Popov](https://github.com/CurtizJ))。
- 垂直マージにおけるメモリ使用量を削減しました。[#59340](https://github.com/ClickHouse/ClickHouse/pull/59340) ([Anton Popov](https://github.com/CurtizJ))。
- より多くのケースでKeeper起動時の大量メモリ消費を回避しました。[#58455](https://github.com/ClickHouse/ClickHouse/pull/58455) ([Antonio Andelic](https://github.com/antonio2368))。
- Keeperの改善: 保存されたノードに対するKeeperのメモリ使用量を削減しました。[#59002](https://github.com/ClickHouse/ClickHouse/pull/59002) ([Antonio Andelic](https://github.com/antonio2368))。
- よりキャッシュフレンドリーなfinal実装。動作変更に関する注意: 以前は、単一ストリームで読み取る`FINAL`修飾子付きクエリ（例: `max_threads = 1`）は、明示的な`ORDER BY`句がなくてもソート済み出力を生成していました。`enable_vertical_final = true`の場合（デフォルトで有効）、これは保証されなくなりました。[#54366](https://github.com/ClickHouse/ClickHouse/pull/54366) ([Duc Canh Le](https://github.com/canhld94))。
- S3からの読み取りなどに使用される`ReadBufferFromIStream`での余分なコピーをバイパスしました。[#56961](https://github.com/ClickHouse/ClickHouse/pull/56961) ([Nikita Taranov](https://github.com/nickitat))。
- 入力がArray(Map)/Array(Array(Num)/Array(Array(String))/Array(BigInt)/Array(Decimal)の場合の配列要素関数を最適化しました。以前の実装では必要以上のメモリ割り当てが行われていました。特に入力タイプがArray(Map)の場合、最大約6倍の高速化が実現されます。[#56403](https://github.com/ClickHouse/ClickHouse/pull/56403) ([李扬](https://github.com/taiyang-li))。
- コンパクトパートにおいて、複数のサブカラムを読み取る際にカラムを一度だけ読み取るようにしました。[#57631](https://github.com/ClickHouse/ClickHouse/pull/57631) ([Kruglov Pavel](https://github.com/Avogar))。
- `sum(column + constant)`関数のASTを書き直しました。これはAnalyzerの最適化パスとして利用可能です。[#57853](https://github.com/ClickHouse/ClickHouse/pull/57853) ([Jiebin Sun](https://github.com/jiebinn))。
- `match`関数の評価で、スキッピングインデックス`ngrambf_v1`と`tokenbf_v1`が利用されるようになりました。[#57882](https://github.com/ClickHouse/ClickHouse/pull/57882) ([凌涛](https://github.com/lingtaolf))。
- `match`関数の評価で、転置インデックスが利用されるようになりました。[#58284](https://github.com/ClickHouse/ClickHouse/pull/58284) ([凌涛](https://github.com/lingtaolf))。
- MergeTreeの`FINAL`は、同じ非L0パートからの行を比較しなくなりました。[#58142](https://github.com/ClickHouse/ClickHouse/pull/58142) ([Duc Canh Le](https://github.com/canhld94))。
- iota呼び出し（連続する数値で配列を埋める処理）を高速化しました。[#58271](https://github.com/ClickHouse/ClickHouse/pull/58271) ([Raúl Marín](https://github.com/Algunenano))。
- 非数値型に対するMIN/MAXを高速化しました。[#58334](https://github.com/ClickHouse/ClickHouse/pull/58334) ([Raúl Marín](https://github.com/Algunenano))。
- BMI2/SSE組み込み関数を使用して、フィルタの組み合わせ（マルチステージPREWHEREなど）を最適化しました。[#58800](https://github.com/ClickHouse/ClickHouse/pull/58800) ([Zhiguo Zhou](https://github.com/ZhiguoZh))。
- `clickhouse-local`で使用するスレッド数を1つ削減しました。[#58968](https://github.com/ClickHouse/ClickHouse/pull/58968) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 型がNullableの場合の`multiIf`関数のパフォーマンスを改善しました。[#57745](https://github.com/ClickHouse/ClickHouse/pull/57745) ([KevinyhZou](https://github.com/KevinyhZou))。
- 未使用のjemallocページをパージするための`SYSTEM JEMALLOC PURGE`、プロファイラが有効な場合にjemallocプロファイルを制御するための`SYSTEM JEMALLOC [ ENABLE | DISABLE | FLUSH ] PROFILE`を追加しました。Keeperにjemalloc関連の4LWコマンドを追加: jemalloc統計をダンプするための`jmst`、プロファイラが有効な場合にjemallocプロファイルを制御するための`jmfp`、`jmep`、`jmdp`。[#58665](https://github.com/ClickHouse/ClickHouse/pull/58665) ([Antonio Andelic](https://github.com/antonio2368))。
- S3へのバックアップにおけるメモリ消費量を削減しました。[#58962](https://github.com/ClickHouse/ClickHouse/pull/58962) ([Vitaly Baranov](https://github.com/vitlibar))。





#### 改善 {#improvement-11}

- Added comments (brief descriptions) to all columns of system tables. There are several reasons for this: - We use system tables a lot, and sometimes it could be very difficult for developer to understand the purpose and the meaning of a particular column. - We change (add new ones or modify existing) system tables a lot and the documentation for them is always outdated. For example take a look at the documentation page for [`system.parts`](/operations/system-tables/parts). It misses a lot of columns - We would like to eventually generate documentation directly from ClickHouse. [#58356](https://github.com/ClickHouse/ClickHouse/pull/58356) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Allow queries without aliases for subqueries for `PASTE JOIN`. [#58654](https://github.com/ClickHouse/ClickHouse/pull/58654) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Enable `MySQL`/`MariaDB` integration on macOS. This closes [#21191](https://github.com/ClickHouse/ClickHouse/issues/21191). [#46316](https://github.com/ClickHouse/ClickHouse/pull/46316) ([Alexey Milovidov](https://github.com/alexey-milovidov)) ([Robert Schulze](https://github.com/rschu1ze)).
- Disable `max_rows_in_set_to_optimize_join` by default. [#56396](https://github.com/ClickHouse/ClickHouse/pull/56396) ([vdimir](https://github.com/vdimir)).
- Add `<host_name>` config parameter that allows avoiding resolving hostnames in ON CLUSTER DDL queries and Replicated database engines. This mitigates the possibility of the queue being stuck in case of a change in cluster definition. Closes [#57573](https://github.com/ClickHouse/ClickHouse/issues/57573). [#57603](https://github.com/ClickHouse/ClickHouse/pull/57603) ([Nikolay Degterinsky](https://github.com/evillique)).
- Increase `load_metadata_threads` to 16 for the filesystem cache. It will make the server start up faster. [#57732](https://github.com/ClickHouse/ClickHouse/pull/57732) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Add ability to throttle merges/mutations (`max_mutations_bandwidth_for_server`/`max_merges_bandwidth_for_server`). [#57877](https://github.com/ClickHouse/ClickHouse/pull/57877) ([Azat Khuzhin](https://github.com/azat)).
- Replaced undocumented (boolean) column `is_hot_reloadable` in system table `system.server_settings` by (Enum8) column `changeable_without_restart` with possible values `No`, `Yes`, `IncreaseOnly` and `DecreaseOnly`. Also documented the column. [#58029](https://github.com/ClickHouse/ClickHouse/pull/58029) ([skyoct](https://github.com/skyoct)).
- Cluster discovery supports setting username and password, close [#58063](https://github.com/ClickHouse/ClickHouse/issues/58063). [#58123](https://github.com/ClickHouse/ClickHouse/pull/58123) ([vdimir](https://github.com/vdimir)).
- Support query parameters in `ALTER TABLE ... PART`. [#58297](https://github.com/ClickHouse/ClickHouse/pull/58297) ([Azat Khuzhin](https://github.com/azat)).
- Create consumers for Kafka tables on the fly (but keep them for some period - `kafka_consumers_pool_ttl_ms`, since last used), this should fix problem with statistics for `system.kafka_consumers` (that does not consumed when nobody reads from Kafka table, which leads to live memory leak and slow table detach) and also this PR enables stats for `system.kafka_consumers` by default again. [#58310](https://github.com/ClickHouse/ClickHouse/pull/58310) ([Azat Khuzhin](https://github.com/azat)).
- `sparkBar` as an alias to `sparkbar`. [#58335](https://github.com/ClickHouse/ClickHouse/pull/58335) ([凌涛](https://github.com/lingtaolf)).
- Avoid sending `ComposeObject` requests after upload to `GCS`. [#58343](https://github.com/ClickHouse/ClickHouse/pull/58343) ([Azat Khuzhin](https://github.com/azat)).
- Correctly handle keys with dot in the name in configurations XMLs. [#58354](https://github.com/ClickHouse/ClickHouse/pull/58354) ([Azat Khuzhin](https://github.com/azat)).
- Make function `format` return constant on constant arguments. This closes [#58355](https://github.com/ClickHouse/ClickHouse/issues/58355). [#58358](https://github.com/ClickHouse/ClickHouse/pull/58358) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Adding a setting `max_estimated_execution_time` to separate `max_execution_time` and `max_estimated_execution_time`. [#58402](https://github.com/ClickHouse/ClickHouse/pull/58402) ([Zhang Yifan](https://github.com/zhangyifan27)).
- Provide a hint when an invalid database engine name is used. [#58444](https://github.com/ClickHouse/ClickHouse/pull/58444) ([Bharat Nallan](https://github.com/bharatnc)).
- Add settings for better control of indexes type in Arrow dictionary. Use signed integer type for indexes by default as Arrow recommends. Closes [#57401](https://github.com/ClickHouse/ClickHouse/issues/57401). [#58519](https://github.com/ClickHouse/ClickHouse/pull/58519) ([Kruglov Pavel](https://github.com/Avogar)).
- Implement [#58575](https://github.com/ClickHouse/ClickHouse/issues/58575) Support `CLICKHOUSE_PASSWORD_FILE ` environment variable when running the docker image. [#58583](https://github.com/ClickHouse/ClickHouse/pull/58583) ([Eyal Halpern Shalev](https://github.com/Eyal-Shalev)).
- When executing some queries, which require a lot of streams for reading data, the error `"Paste JOIN requires sorted tables only"` was previously thrown. Now the numbers of streams resize to 1 in that case. [#58608](https://github.com/ClickHouse/ClickHouse/pull/58608) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Better message for INVALID_IDENTIFIER error. [#58703](https://github.com/ClickHouse/ClickHouse/pull/58703) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Improved handling of signed numeric literals in normalizeQuery. [#58710](https://github.com/ClickHouse/ClickHouse/pull/58710) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
- Support Point data type for MySQL. [#58721](https://github.com/ClickHouse/ClickHouse/pull/58721) ([Kseniia Sumarokova](https://github.com/kssenii)).
- When comparing a Float32 column and a const string, read the string as Float32 (instead of Float64). [#58724](https://github.com/ClickHouse/ClickHouse/pull/58724) ([Raúl Marín](https://github.com/Algunenano)).
- Improve S3 compatibility, add ECloud EOS storage support. [#58786](https://github.com/ClickHouse/ClickHouse/pull/58786) ([xleoken](https://github.com/xleoken)).
- Allow `KILL QUERY` to cancel backups / restores. This PR also makes running backups and restores visible in `system.processes`. Also, there is a new setting in the server configuration now - `shutdown_wait_backups_and_restores` (default=true) which makes the server either wait on shutdown for all running backups and restores to finish or just cancel them. [#58804](https://github.com/ClickHouse/ClickHouse/pull/58804) ([Vitaly Baranov](https://github.com/vitlibar)).
- Avro format to support ZSTD codec. Closes [#58735](https://github.com/ClickHouse/ClickHouse/issues/58735). [#58805](https://github.com/ClickHouse/ClickHouse/pull/58805) ([flynn](https://github.com/ucasfl)).
- MySQL interface gained support for `net_write_timeout` and `net_read_timeout` settings. `net_write_timeout` is translated into the native `send_timeout` ClickHouse setting and, similarly, `net_read_timeout` into `receive_timeout`. Fixed an issue where it was possible to set MySQL `sql_select_limit` setting only if the entire statement was in upper case. [#58835](https://github.com/ClickHouse/ClickHouse/pull/58835) ([Serge Klochkov](https://github.com/slvrtrn)).
- A better exception message while conflict of creating dictionary and table with the same name. [#58841](https://github.com/ClickHouse/ClickHouse/pull/58841) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Make sure that for custom (created from SQL) disks ether `filesystem_caches_path` (a common directory prefix for all filesystem caches) or `custom_cached_disks_base_directory` (a common directory prefix for only filesystem caches created from custom disks) is specified in server config. `custom_cached_disks_base_directory` has higher priority for custom disks over `filesystem_caches_path`, which is used if the former one is absent. Filesystem cache setting `path` must lie inside that directory, otherwise exception will be thrown preventing disk to be created. This will not affect disks created on an older version and server was upgraded - then the exception will not be thrown to allow the server to successfully start). `custom_cached_disks_base_directory` is added to default server config as `/var/lib/clickhouse/caches/`. Closes [#57825](https://github.com/ClickHouse/ClickHouse/issues/57825). [#58869](https://github.com/ClickHouse/ClickHouse/pull/58869) ([Kseniia Sumarokova](https://github.com/kssenii)).
- MySQL interface gained compatibility with `SHOW WARNINGS`/`SHOW COUNT(*) WARNINGS` queries, though the returned result is always an empty set. [#58929](https://github.com/ClickHouse/ClickHouse/pull/58929) ([Serge Klochkov](https://github.com/slvrtrn)).
- Skip unavailable replicas when executing parallel distributed `INSERT SELECT`. [#58931](https://github.com/ClickHouse/ClickHouse/pull/58931) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Display word-descriptive log level while enabling structured log formatting in json. [#58936](https://github.com/ClickHouse/ClickHouse/pull/58936) ([Tim Liou](https://github.com/wheatdog)).
- MySQL interface gained support for `CAST(x AS SIGNED)` and `CAST(x AS UNSIGNED)` statements via data type aliases: `SIGNED` for Int64, and `UNSIGNED` for UInt64. This improves compatibility with BI tools such as Looker Studio. [#58954](https://github.com/ClickHouse/ClickHouse/pull/58954) ([Serge Klochkov](https://github.com/slvrtrn)).
- Change working directory to the data path in docker container. [#58975](https://github.com/ClickHouse/ClickHouse/pull/58975) ([cangyin](https://github.com/cangyin)).
- Added setting for Azure Blob Storage `azure_max_unexpected_write_error_retries` , can also be set from config under azure section. [#59001](https://github.com/ClickHouse/ClickHouse/pull/59001) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Allow server to start with broken data lake table. Closes [#58625](https://github.com/ClickHouse/ClickHouse/issues/58625). [#59080](https://github.com/ClickHouse/ClickHouse/pull/59080) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Allow to ignore schema evolution in the `Iceberg` table engine and read all data using schema specified by the user on table creation or latest schema parsed from metadata on table creation. This is done under a setting `iceberg_engine_ignore_schema_evolution` that is disabled by default. Note that enabling this setting can lead to incorrect result as in case of evolved schema all data files will be read using the same schema. [#59133](https://github.com/ClickHouse/ClickHouse/pull/59133) ([Kruglov Pavel](https://github.com/Avogar)).
- Prohibit mutable operations (`INSERT`/`ALTER`/`OPTIMIZE`/...) on read-only/write-once storages with a proper `TABLE_IS_READ_ONLY` error (to avoid leftovers). Avoid leaving left-overs on write-once disks (`format_version.txt`) on `CREATE`/`ATTACH`. Ignore `DROP` for `ReplicatedMergeTree` (so as for `MergeTree`). Fix iterating over `s3_plain` (`MetadataStorageFromPlainObjectStorage::iterateDirectory`). Note read-only is `web` disk, and write-once is `s3_plain`. [#59170](https://github.com/ClickHouse/ClickHouse/pull/59170) ([Azat Khuzhin](https://github.com/azat)).
- Fix bug in the experimental `_block_number` column which could lead to logical error during complex combination of `ALTER`s and `merge`s. Fixes [#56202](https://github.com/ClickHouse/ClickHouse/issues/56202). Replaces [#58601](https://github.com/ClickHouse/ClickHouse/issues/58601). [#59295](https://github.com/ClickHouse/ClickHouse/pull/59295) ([alesapin](https://github.com/alesapin)).
- Play UI understands when an exception is returned inside JSON. Adjustment for [#52853](https://github.com/ClickHouse/ClickHouse/issues/52853). [#59303](https://github.com/ClickHouse/ClickHouse/pull/59303) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- `/binary` HTTP handler allows to specify user, host, and optionally, password in the query string. [#59311](https://github.com/ClickHouse/ClickHouse/pull/59311) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Support backups for compressed in-memory tables. This closes [#57893](https://github.com/ClickHouse/ClickHouse/issues/57893). [#59315](https://github.com/ClickHouse/ClickHouse/pull/59315) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Support the `FORMAT` clause in `BACKUP` and `RESTORE` queries. [#59338](https://github.com/ClickHouse/ClickHouse/pull/59338) ([Vitaly Baranov](https://github.com/vitlibar)).
- Function `concatWithSeparator` now supports arbitrary argument types (instead of only `String` and `FixedString` arguments). For example, `SELECT concatWithSeparator('.', 'number', 1)` now returns `number.1`. [#59341](https://github.com/ClickHouse/ClickHouse/pull/59341) ([Robert Schulze](https://github.com/rschu1ze)).

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-7}

- clickhouseバイナリのエイリアスを改善（`ch`/`clickhouse`は引数に応じて`clickhouse-local`または`clickhouse`として動作）し、新しいエイリアスのbash補完を追加しました。[#58344](https://github.com/ClickHouse/ClickHouse/pull/58344) ([Azat Khuzhin](https://github.com/azat))。
- すべての設定変更が設定変更履歴に反映されていることを確認するため、CIに設定変更チェックを追加しました。[#58555](https://github.com/ClickHouse/ClickHouse/pull/58555) ([Kruglov Pavel](https://github.com/Avogar))。
- ステートフルテストでS3から直接アタッチされたテーブルを使用するようにしました。[#58791](https://github.com/ClickHouse/ClickHouse/pull/58791) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 最後の10万行ではなく、`fuzzer.log`全体をアーカイブとして保存するようにしました。`tail -n 100000`はテーブル定義の行を削除することがよくあります。例：[#58821](https://github.com/ClickHouse/ClickHouse/pull/58821) ([Dmitry Novik](https://github.com/novikd))。
- macOS（Aarch64）でRustを有効化しました（これによりクライアントにskimを使用したファジー検索とPRQL言語が追加されますが、darwinでClickHouseをホストする人はほとんどいないと思われるため、主にクライアントのファジー検索のための機能と言えます）。[#59272](https://github.com/ClickHouse/ClickHouse/pull/59272) ([Azat Khuzhin](https://github.com/azat))。
- x86_64とARMが混在するクラスタにおける集計の問題を修正しました。[#59132](https://github.com/ClickHouse/ClickHouse/pull/59132) ([Harry Lee](https://github.com/HarryLeeIBM))。

#### バグ修正（公式安定版リリースにおけるユーザーから見える不具合） {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-9}


* ネストされた LowCardinality に対する結合キーの変換を追加 [#51550](https://github.com/ClickHouse/ClickHouse/pull/51550) ([vdimir](https://github.com/vdimir))。
* flatten&#95;nested=1 の場合に、すべての Array(Tuple) ではなく、真の Nested 型のみをフラット化するようにしました [#56132](https://github.com/ClickHouse/ClickHouse/pull/56132) ([Kruglov Pavel](https://github.com/Avogar))。
* 挿入時のプロジェクションと `aggregate_functions_null_for_empty` 設定に関するバグを修正しました。 [#56944](https://github.com/ClickHouse/ClickHouse/pull/56944) ([Amos Bird](https://github.com/amosbird)).
* 古い `profile UUID` によって発生し得た例外を修正 [#57263](https://github.com/ClickHouse/ClickHouse/pull/57263) ([Vasily Nemkov](https://github.com/Enmk))。
* StreamingFormatExecutor における読み取りバッファの取り扱いを修正 [#57438](https://github.com/ClickHouse/ClickHouse/pull/57438) ([Kruglov Pavel](https://github.com/Avogar))。
* ビューへのプッシュ処理時に、対象テーブルが削除済みのマテリアライズドビューを無視するように変更 [#57520](https://github.com/ClickHouse/ClickHouse/pull/57520) ([Kruglov Pavel](https://github.com/Avogar))。
* ALTER&#95;METADATA と MERGE&#95;PARTS 間で発生し得るレースコンディションを排除 [#57755](https://github.com/ClickHouse/ClickHouse/pull/57755) ([Azat Khuzhin](https://github.com/azat)).
* `GROUP BY WITH ROLLUP` における式の順序バグを修正 [#57786](https://github.com/ClickHouse/ClickHouse/pull/57786) ([Chen768959](https://github.com/Chen768959)).
* 廃止された「zero-copy」レプリケーション機能に対する修正: 壊れた `detached` パーツを含むレプリカを削除した際に blob が失われる問題を修正 [#58333](https://github.com/ClickHouse/ClickHouse/pull/58333) ([Alexander Tokmakov](https://github.com/tavplubix))。
* ユーザーが `user_files_path` 内のシンボリックリンクを扱えるようになりました [#58447](https://github.com/ClickHouse/ClickHouse/pull/58447) ([Duc Canh Le](https://github.com/canhld94))。
* graphite テーブルに `agg` 関数がない場合に発生していたクラッシュを修正。 [#58453](https://github.com/ClickHouse/ClickHouse/pull/58453) ([Duc Canh Le](https://github.com/canhld94))。
* StorageKafka からの読み取りを遅延させ、マテリアライズドビューでの複数回の読み取りを可能にする [#58477](https://github.com/ClickHouse/ClickHouse/pull/58477)（[János Benjamin Antal](https://github.com/antaljanosbenjamin)）。
* 交差するパーツが発生していた不適切なケースを修正 [#58482](https://github.com/ClickHouse/ClickHouse/pull/58482) ([Alexander Tokmakov](https://github.com/tavplubix))。
* `LIMIT` のみを含むクエリに対して `MergeTreePrefetchedReadPool` を無効化 [#58505](https://github.com/ClickHouse/ClickHouse/pull/58505)（[Maksim Kita](https://github.com/kitaisreal)）。
* 復元中に通常のデータベースを有効にする [#58520](https://github.com/ClickHouse/ClickHouse/pull/58520) ([Jihyuk Bok](https://github.com/tomahawk28)).
* Apache Hive のスレッドプールによる ORC/Parquet/... の読み込みを修正 [#58537](https://github.com/ClickHouse/ClickHouse/pull/58537) ([sunny](https://github.com/sunny19930321)).
* `system.backup_log` の `base_backup_name` 列から認証情報をマスクするように変更 [#58550](https://github.com/ClickHouse/ClickHouse/pull/58550) ([Daniel Pozo Escalona](https://github.com/danipozo))。
* ミリ秒およびマイクロ秒の値を丸めるための `toStartOfInterval` [#58557](https://github.com/ClickHouse/ClickHouse/pull/58557)（[Yarik Briukhovetskyi](https://github.com/yariks5s)）。
* ConcurrentHashJoin で `max_joined_block_rows` を無効にする [#58595](https://github.com/ClickHouse/ClickHouse/pull/58595)（[vdimir](https://github.com/vdimir)）。
* 旧アナライザーにおける `Nullable` 使用時の `JOIN` を修正 [#58596](https://github.com/ClickHouse/ClickHouse/pull/58596) ([vdimir](https://github.com/vdimir)).
* `makeDateTime64`: 非 const の fraction 引数を許可 [#58597](https://github.com/ClickHouse/ClickHouse/pull/58597) ([Robert Schulze](https://github.com/rschu1ze)).
* インラインフレームのシンボル化中に発生しうる `NULL` デリファレンスを修正 [#58607](https://github.com/ClickHouse/ClickHouse/pull/58607) ([Azat Khuzhin](https://github.com/azat))。
* 再作成されたユーザーやロール切り替え時におけるクエリキャッシュエントリの分離を改善 [#58611](https://github.com/ClickHouse/ClickHouse/pull/58611) ([Robert Schulze](https://github.com/rschu1ze)).
* プロジェクション最適化の実行時に不正になっていたパーティションキー解析を修正 [#58638](https://github.com/ClickHouse/ClickHouse/pull/58638) ([Amos Bird](https://github.com/amosbird))。
* クエリキャッシュ: ユーザーごとのクォータを修正 [#58731](https://github.com/ClickHouse/ClickHouse/pull/58731) ([Robert Schulze](https://github.com/rschu1ze))。
* 並列ウィンドウ関数のストリームパーティショニングを修正 [#58739](https://github.com/ClickHouse/ClickHouse/pull/58739)（[Dmitry Novik](https://github.com/novikd)）。
* addBatchLookupTable8 内で、例外スロー時に発生する destroy の二重呼び出しを修正 [#58745](https://github.com/ClickHouse/ClickHouse/pull/58745) ([Raúl Marín](https://github.com/Algunenano)).
* シャットダウン中は Keeper でリクエストを処理しない [#58765](https://github.com/ClickHouse/ClickHouse/pull/58765) ([Antonio Andelic](https://github.com/antonio2368)).
* `SlabsPolygonIndex::find` におけるヌルポインタ参照を修正 [#58771](https://github.com/ClickHouse/ClickHouse/pull/58771) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* LowCardinality(Nullable) カラム向けの JSONExtract 関数を修正 [#58808](https://github.com/ClickHouse/ClickHouse/pull/58808) ([vdimir](https://github.com/vdimir))。
* CREATE および DROP で非常に多くのテーブルを作成する際に、メモリ使用量が予期せず蓄積していく問題を修正。 [#58831](https://github.com/ClickHouse/ClickHouse/pull/58831) ([Maksim Kita](https://github.com/kitaisreal)).
* mv における複数 read file ログのストレージ [#58877](https://github.com/ClickHouse/ClickHouse/pull/58877)（[János Benjamin Antal](https://github.com/antaljanosbenjamin)）。
* S3 用のアクセスキー ID の制限。 [#58900](https://github.com/ClickHouse/ClickHouse/pull/58900) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* clickhouse-local でサジェスト読み込み時に発生し得るクラッシュを修正 [#58907](https://github.com/ClickHouse/ClickHouse/pull/58907) ([Kruglov Pavel](https://github.com/Avogar))。
* `indexHint` 使用時に発生するクラッシュを修正 [#58911](https://github.com/ClickHouse/ClickHouse/pull/58911) ([Dmitry Novik](https://github.com/novikd))。
* サーバー再起動時に `StorageURL` がヘッダーを忘れてしまう問題を修正 [#58933](https://github.com/ClickHouse/ClickHouse/pull/58933) ([Michael Kolupaev](https://github.com/al13n321)).
* Analyzer: 挿入ブロックを用いたストレージの置換処理を修正 [#58958](https://github.com/ClickHouse/ClickHouse/pull/58958) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* ReadBufferFromZipArchive におけるシーク処理を修正 [#58966](https://github.com/ClickHouse/ClickHouse/pull/58966)（[Michael Kolupaev](https://github.com/al13n321)）。
* 実験的な inverted index に対する修正（本番環境では使用しないでください）：inverted index に対する `DROP INDEX` で、永続化領域から関連するすべてのファイルが削除されるようになりました [#59040](https://github.com/ClickHouse/ClickHouse/pull/59040) ([mochi](https://github.com/MochiXu))。
* query&#95;factories&#95;info のデータレースを修正 [#59049](https://github.com/ClickHouse/ClickHouse/pull/59049) ([Kseniia Sumarokova](https://github.com/kssenii)).
* &quot;Too many redirects&quot; エラーのリトライを無効化 [#59099](https://github.com/ClickHouse/ClickHouse/pull/59099) ([skyoct](https://github.com/skyoct)).
* 開始されていないデータベースのシャットダウン時に発生するデッドロックを修正 [#59137](https://github.com/ClickHouse/ClickHouse/pull/59137) ([Sergei Trifonov](https://github.com/serxa))。
* 修正: 分散クエリにおける `LIMIT BY` と `LIMIT` [#59153](https://github.com/ClickHouse/ClickHouse/pull/59153)（[Igor Nikonov](https://github.com/devcrafter)）。
* `toString` の nullable なタイムゾーンで発生するクラッシュを修正 [#59190](https://github.com/ClickHouse/ClickHouse/pull/59190) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
* 不正なファイルパスにより発生する Iceberg メタデータのアボートを修正 [#59275](https://github.com/ClickHouse/ClickHouse/pull/59275) ([Kruglov Pavel](https://github.com/Avogar)).
* Rust ターゲットの select におけるアーキテクチャ名を修正 [#59307](https://github.com/ClickHouse/ClickHouse/pull/59307) ([p1rattttt](https://github.com/p1rattttt))。
* IN 句内のサブクエリを伴う `system.tables` からのクエリにおいて、「not-ready セット」に関する論理エラーを修正。 [#59351](https://github.com/ClickHouse/ClickHouse/pull/59351) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。





## [2023年の変更履歴](/whats-new/changelog/2023) {#changelog-for-2023}
