---
slug: /managing-data/materialized-views-versus-projections
sidebar_label: 'マテリアライズドビューとプロジェクションの比較'
title: 'マテリアライズドビューとプロジェクション'
hide_title: false
description: 'ClickHouse におけるマテリアライズドビューとプロジェクションを、ユースケース、パフォーマンス、制約とあわせて比較する記事。'
doc_type: 'reference'
keywords: ['materialized views', 'projections', 'differences']
---

> ユーザーからよく寄せられる質問に、どのような場合にマテリアライズドビューを使用し、どのような場合に
> プロジェクションを使用すべきかというものがあります。本記事では、これら 2 つの機能の主な違いと、特定のシナリオでどちらを選択すべきかについて説明します。



## 主な違いの概要 {#key-differences}

以下の表は、さまざまな観点から見たマテリアライズドビューとプロジェクションの主な違いをまとめたものです。

| Aspect                                                                           | Materialized views                                                                                                                                                                                                                                                                                                                                                       | Projections                                                                                                                                                                                                                                                                                            |
|----------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Data storage and location                                                        | 結果を**別個の明示的なターゲットテーブル**に保存し、ソーステーブルへの挿入時に挿入トリガーとして動作します。                                                                                                                                                                                                                                                    | プロジェクションは最適化されたデータレイアウトを作成し、それらは物理的に**メインテーブルのデータと並んで保存**され、ユーザーからは見えません。                                                                                                                                                                  |
| Update mechanism                                                                 | （増分マテリアライズドビューの場合）ソーステーブルへの `INSERT` に対して**同期的に**動作します。注: リフレッシュ可能なマテリアライズドビューを使用して**スケジュール実行**することもできます。                                                                                                                                                                               | メインテーブルへの `INSERT` 時に、バックグラウンドで**非同期的**に更新されます。                                                                                                                                                                                                                            |
| Query interaction                                                                | マテリアライズドビューを利用する場合は、**ターゲットテーブルを直接クエリ**する必要があるため、クエリを作成する際にマテリアライズドビューの存在をユーザーが認識している必要があります。                                                                                                                                                                                        | プロジェクションは ClickHouse のクエリオプティマイザによって**自動的に選択**され、ユーザーがプロジェクションを利用するために、そのテーブルに対するクエリを変更する必要がないという意味で透過的です。バージョン 25.6 からは、複数のプロジェクションによるフィルタリングも可能です。 |
| Handling `UPDATE` / `DELETE`                                                     | マテリアライズドビューはソーステーブルについての知識を持たず、ソーステーブル_への_挿入トリガーとしてのみ動作するため、ソーステーブルに対する `UPDATE` や `DELETE` 操作に**自動的には反応しません**。これによりソーステーブルとターゲットテーブルの間でデータの不整合や陳腐化が発生する可能性があり、回避にはワークアラウンドや定期的なフルリフレッシュ（リフレッシュ可能なマテリアライズドビュー経由）が必要です。 | 既定では、（特に lightweight delete（軽量削除）において）**`DELETED` 行とは互換性がありません**。`lightweight_mutation_projection_mode`（v24.7+）を使用することで互換性を有効化できます。                                                                                                                                       |
| `JOIN` support                                                                   | 対応。リフレッシュ可能なマテリアライズドビューを用いて複雑な非正規化を行うことができます。増分マテリアライズドビューは、最も左側のテーブルへの挿入のみでトリガーされます。                                                                                                                                                                                                 | 非対応。プロジェクション定義内では、マテリアライズされたデータをフィルタリングするための `JOIN` 演算はサポートされていません。                                                                                                                                                                                             |
| `WHERE` clause in definition                                                     | 対応。マテリアライズ前にデータをフィルタリングするために `WHERE` 句を含めることができます。                                                                                                                                                                                                                                                                           | 非対応。プロジェクション定義内では、マテリアライズされたデータをフィルタリングするための `WHERE` 句はサポートされていません。                                                                                                                                                                                               |
| Chaining capabilities                                                            | 対応。あるマテリアライズドビューのターゲットテーブルを別のマテリアライズドビューのソースとして使用でき、多段パイプラインを構築できます。                                                                                                                                                                                                                          | 非対応。プロジェクションを連鎖させることはできません。                                                                                                                                                                                                                                                                     |
| Applicable table engines                                                         | さまざまなソーステーブルエンジンで使用できますが、ターゲットテーブルは通常 `MergeTree` ファミリです。                                                                                                                                                                                                                                                                  | `MergeTree` ファミリのテーブルエンジンでのみ**利用可能**です。                                                                                                                                                                                                                                               |
| Failure handling                                                                 | データ挿入時に失敗するとターゲットテーブル側でデータが失われるため、不整合が発生する可能性があります。                                                                                                                                                                                                                                                           | 障害はバックグラウンドで**サイレントに**処理されます。クエリでは、マテリアライズ済みパーツと未マテリアライズパーツを透過的に混在させることができます。                                                                                                                                                                                 |
| Operational overhead                                                             | 明示的なターゲットテーブルの作成と、しばしば手動でのバックフィルが必要です。`UPDATE`/`DELETE` との整合性維持には追加の複雑さが伴います。                                                                                                                                                                                                                                  | プロジェクションは自動的に管理され同期が保たれるため、一般に運用負荷は低くなります。                                                                                                                                                                                               |
| `FINAL` query compatibility                                                      | 概ね互換性がありますが、多くの場合、ターゲットテーブル側で `GROUP BY` が必要になります。                                                                                                                                                                                                                                                                              | `FINAL` クエリでは**動作しません**。                                                                                                                                                                                                                                                                  |
| Lazy materialization                                                             | 対応。                                                                                                                                                                                                                                                                                                                                                                  | マテリアライゼーション関連機能を使用する際は、プロジェクション互換性の問題を監視してください。`query_plan_optimize_lazy_materialization = false` を設定する必要がある場合があります。                                                                                                                                                |
| Parallel replicas                                                                | 対応。                                                                                                                                                                                                                                                                                                                                                                  | 非対応。                                                                                                                                                                                                                                                                                               |
| [`optimize_read_in_order`](/operations/settings/settings#optimize_read_in_order) | 対応。                                                                                                                                                                                                                                                                                                                                                                  | 対応。                                                                                                                                                                                                                                                                                                  |
| Lightweight updates and deletes                                                  | 対応。                                                                                                                                                                                                                                                                                                                                                                  | 非対応。                                                                                                                                                                                                                                                                                               |



## マテリアライズドビューとプロジェクションの比較 {#choose-between}

### マテリアライズドビューを選ぶべきケース {#choosing-materialized-views}

マテリアライズドビューの利用を検討すべきなのは次のような場合です:

- **リアルタイム ETL と多段階データパイプライン** を扱う場合: データ到着時に複雑な変換や集約を実行したり、ビューをチェインして複数ステージにわたってデータをルーティングする必要がある場合。
- **複雑な非正規化** が必要な場合: 複数のソース（テーブル、サブクエリ、ディクショナリ）からのデータを 1 つのクエリ最適化済みテーブルに事前結合する必要があり、特にリフレッシュ可能なマテリアライズドビューを使った定期的なフルリフレッシュが許容できる場合。
- **スキーマを明示的に制御したい** 場合: 事前計算済み結果用に、独自のスキーマとエンジンを持つ独立したターゲットテーブルが必要であり、データモデリングの柔軟性を高めたい場合。
- **インジェスト時にフィルタリングしたい** 場合: データがマテリアライズされる _前に_ フィルタリングし、ターゲットテーブルに書き込まれるデータ量を削減する必要がある場合。

### マテリアライズドビューを避けるべきケース {#avoid-materialized-views}

マテリアライズドビューの使用を避けることを検討すべきなのは次のような場合です:

- **ソースデータが頻繁に更新または削除される** 場合: ソーステーブルとターゲットテーブル間の整合性を維持するための追加戦略がないと、増分マテリアライズドビューが古くなり、不整合を起こす可能性があります。
- **シンプルさと自動最適化を優先したい** 場合: 別個のターゲットテーブルを管理したくない場合。

### プロジェクションを選ぶべきケース {#choosing-projections}

プロジェクションの利用を検討すべきなのは次のような場合です:

- **単一テーブルに対するクエリを最適化する** 場合: 主な目的が、単一のベーステーブルに対するクエリを高速化することであり、そのために別のソート順を提供したり、プライマリキーに含まれない列上のフィルタを最適化したり、単一テーブルに対する集約を事前計算したりする場合。
- **クエリの透過性** を求める場合: クエリを変更せずに元のテーブルを対象にし、ClickHouse がクエリごとに最適なデータレイアウトを選択することに任せたい場合。

### プロジェクションを避けるべきケース {#avoid-projections}

プロジェクションの使用を避けることを検討すべきなのは次のような場合です:

- **複雑なデータ変換や多段階 ETL が必要** な場合: プロジェクションは、その定義内で `JOIN` 演算をサポートせず、多段階パイプラインを構築するように変更することもできず、ウィンドウ関数や複雑な `CASE` 式など一部の SQL 機能も扱えません。そのため、複雑なデータ変換には適していません。
- **マテリアライズされるデータを明示的にフィルタリングする必要がある** 場合: プロジェクションは、その定義内で `WHERE` 句をサポートしておらず、プロジェクション自体にマテリアライズされるデータをフィルタリングできません。
- **MergeTree 以外のテーブルエンジンが使用されている** 場合: プロジェクションは `MergeTree` ファミリーのエンジンを使用するテーブルに対してのみ利用できます。
- `FINAL` クエリが不可欠な場合: プロジェクションは、重複排除のために使用されることがある `FINAL` クエリでは機能しません。
- [parallel replicas](/deployment-guides/parallel-replicas) が必要な場合: プロジェクションではサポートされていません。



## Summary {#summary}

マテリアライズドビューとプロジェクションは、どちらもクエリの最適化やデータ変換のための強力なツールであり、一般的には「どちらか一方を選ぶ」ものとして考えることは推奨しません。代わりに、これらを補完的に組み合わせて使用することで、クエリのパフォーマンスを最大限に引き出すことができます。そのため、ClickHouse でマテリアライズドビューとプロジェクションのどちらを選択するかは、具体的なユースケースやアクセスパターンに大きく依存します。

一般的な指針として、1 つ以上のソーステーブルからターゲットテーブルへデータを集約したり、大規模な複雑な変換処理を実行する必要がある場合には、マテリアライズドビューの利用を検討すべきです。マテリアライズドビューは、高コストな集約処理の負荷をクエリ実行時から挿入時へと移すのに非常に優れています。日次・月次のロールアップやリアルタイムダッシュボード、データサマリなどに最適な選択肢です。

一方で、テーブルのプライマリキー（ディスク上のデータの物理的な並び順を決定するカラム）とは異なるカラムでフィルタするクエリを最適化する必要がある場合には、プロジェクションを使用すべきです。特に、テーブルのプライマリキーをもはや変更できない状況や、アクセスパターンがプライマリキーで表現できる範囲よりも多様である場合に有用です。
