---
slug: /managing-data/materialized-views-versus-projections
sidebar_label: 'マテリアライズドビューとプロジェクション'
title: 'マテリアライズドビューとプロジェクションの比較'
hide_title: false
description: 'ClickHouse におけるマテリアライズドビューとプロジェクションについて、ユースケース、パフォーマンス、制約を含めて比較する記事。'
doc_type: 'reference'
keywords: ['materialized views', 'projections', 'differences']
---

> ユーザーからよく寄せられる質問として、マテリアライズドビューと
プロジェクションのどちらを使うべきか、というものがあります。この記事では、この 2 つの主な違いと、特定のシナリオでなぜ一方を他方より優先して選ぶべきなのかを解説します。



## 主な違いのまとめ {#key-differences}

以下の表は、マテリアライズドビューとプロジェクションの主な違いを、さまざまな観点から要約したものです。

| 項目                                                                           | マテリアライズドビュー                                                                                                                                                                                                                                                                                                                                                        | プロジェクション                                                                                                                                                                                                                                                                                            |
| -------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| データストレージと配置                                                        | ソーステーブルへの挿入時にインサートトリガーとして機能し、結果を**別の明示的なターゲットテーブル**に格納します。                                                                                                                                                                                                                                                                     | 最適化されたデータレイアウトを作成し、物理的に**メインテーブルデータと並んで格納**され、ユーザーからは見えません。                                                                                                                                                                  |
| 更新メカニズム                                                                 | ソーステーブルへの`INSERT`時に**同期的**に動作します(インクリメンタルマテリアライズドビューの場合)。注:リフレッシュ可能なマテリアライズドビューを使用して**スケジュール実行**することも可能です。                                                                                                                                                                                                | メインテーブルへの`INSERT`時にバックグラウンドで**非同期的**に更新されます。                                                                                                                                                                                                                            |
| クエリの相互作用                                                                | マテリアライズドビューを使用するには**ターゲットテーブルを直接クエリ**する必要があり、ユーザーはクエリを記述する際にマテリアライズドビューの存在を認識している必要があります。                                                                                                                                                                                         | ClickHouseのクエリオプティマイザによって**自動的に選択**され、ユーザーがプロジェクションを利用するためにテーブルへのクエリを変更する必要がないという意味で透過的です。バージョン25.6以降では、複数のプロジェクションによるフィルタリングも可能です。 |
| `UPDATE` / `DELETE`の処理                                                     | マテリアライズドビューはソーステーブルの情報を持たず、ソーステーブル_への_インサートトリガーとしてのみ機能するため、ソーステーブルに対する`UPDATE`または`DELETE`操作に**自動的に反応しません**。これにより、ソーステーブルとターゲットテーブル間でデータの陳腐化が発生する可能性があり、回避策または定期的な完全リフレッシュ(リフレッシュ可能なマテリアライズドビュー経由)が必要です。 | デフォルトでは、`DELETED`行と**互換性がありません**(特に軽量削除)。`lightweight_mutation_projection_mode`(v24.7以降)で互換性を有効にできます。                                                                                                                                                       |
| `JOIN`のサポート                                                                   | 対応。リフレッシュ可能なマテリアライズドビューは複雑な非正規化に使用できます。インクリメンタルマテリアライズドビューは最左テーブルの挿入時にのみトリガーされます。                                                                                                                                                                                                                      | 非対応。マテリアライズされたデータをフィルタリングするためのプロジェクション定義内で`JOIN`操作はサポートされていません。                                                                                                                                                                                             |
| 定義内の`WHERE`句                                                     | 対応。マテリアライズ前にデータをフィルタリングするために`WHERE`句を含めることができます。                                                                                                                                                                                                                                                                                               | 非対応。マテリアライズされたデータをフィルタリングするためのプロジェクション定義内で`WHERE`句はサポートされていません。                                                                                                                                                                                                               |
| チェーン機能                                                            | 対応。あるマテリアライズドビューのターゲットテーブルを別のマテリアライズドビューのソースにすることができ、多段階パイプラインを実現できます。                                                                                                                                                                                                                                           | 非対応。プロジェクションはチェーンできません。                                                                                                                                                                                                                                                                     |
| 適用可能なテーブルエンジン                                                         | さまざまなソーステーブルエンジンで使用できますが、ターゲットテーブルは通常`MergeTree`ファミリーです。                                                                                                                                                                                                                                                                   | `MergeTree`ファミリーのテーブルエンジンでのみ**利用可能**です。                                                                                                                                                                                                                                               |
| 障害処理                                                                 | データ挿入中の障害は、ターゲットテーブルでデータが失われることを意味し、不整合につながる可能性があります。                                                                                                                                                                                                                                                            | 障害はバックグラウンドで**静かに**処理されます。クエリはマテリアライズされた部分とマテリアライズされていない部分をシームレスに混在させることができます。                                                                                                                                                                 |
| 運用オーバーヘッド                                                             | 明示的なターゲットテーブルの作成と、多くの場合手動でのバックフィルが必要です。`UPDATE`/`DELETE`との整合性管理により複雑さが増します。                                                                                                                                                                                                                                   | 自動的に維持され同期が保たれ、一般的に運用負荷が低くなります。                                                                                                                                                                                                                               |
| `FINAL`クエリの互換性                                                      | 一般的に互換性がありますが、ターゲットテーブルで`GROUP BY`が必要になることがよくあります。                                                                                                                                                                                                                                                                                                   | `FINAL`クエリでは**動作しません**。                                                                                                                                                                                                                                                                  |
| 遅延マテリアライゼーション                                                             | 対応。                                                                                                                                                                                                                                                                                                                                                                      | マテリアライゼーション機能を使用する際は、プロジェクションの互換性の問題を監視してください。`query_plan_optimize_lazy_materialization = false`を設定する必要がある場合があります。                                                                                                                                                |
| パラレルレプリカ                                                                | 対応。                                                                                                                                                                                                                                                                                                                                                                      | 非対応。                                                                                                                                                                                                                                                                                                    |
| [`optimize_read_in_order`](/operations/settings/settings#optimize_read_in_order) | 対応。                                                                                                                                                                                                                                                                                                                                                                      | 対応。                                                                                                                                                                                                                                                                                                   |
| 軽量更新と削除                                                  | 対応。                                                                                                                                                                                                                                                                                                                                                                      | 非対応。                                                                                                                                                                                                                                                                                                    |


## マテリアライズドビューとプロジェクションの比較 {#choose-between}

### マテリアライズドビューを選択すべき場合 {#choosing-materialized-views}

以下の場合にマテリアライズドビューの使用を検討してください:

- **リアルタイムETLおよび多段階データパイプラインでの作業:** データ到着時に複雑な変換、集約、またはルーティングを実行する必要があり、ビューを連鎖させることで複数の段階にわたって処理する可能性がある場合。
- **複雑な非正規化が必要:** 複数のソース(テーブル、サブクエリ、またはディクショナリ)からのデータを単一のクエリ最適化されたテーブルに事前結合する必要があり、特にリフレッシュ可能なマテリアライズドビューを使用した定期的な完全更新が許容される場合。
- **明示的なスキーマ制御が必要:** 事前計算された結果に対して独自のスキーマとエンジンを持つ別個のターゲットテーブルが必要であり、データモデリングにおいてより大きな柔軟性を提供する場合。
- **取り込み時のフィルタリングが必要:** データがマテリアライズされる_前に_フィルタリングを行い、ターゲットテーブルに書き込まれるデータ量を削減する必要がある場合。

### マテリアライズドビューを避けるべき場合 {#avoid-materialized-views}

以下の場合にマテリアライズドビューの使用を避けることを検討してください:

- **ソースデータが頻繁に更新または削除される:** ソーステーブルとターゲットテーブル間の整合性を処理するための追加戦略がない場合、インクリメンタルマテリアライズドビューは古くなり、不整合が生じる可能性があります。
- **シンプルさと自動最適化が優先される:** 別個のターゲットテーブルの管理を避けたい場合。

### プロジェクションを選択すべき場合 {#choosing-projections}

以下の場合にプロジェクションの使用を検討してください:

- **単一テーブルのクエリ最適化:** 主な目的が、代替のソート順を提供したり、プライマリキーの一部ではないカラムに対するフィルタを最適化したり、単一テーブルの集約を事前計算することで、単一のベーステーブルに対するクエリを高速化することである場合。
- **クエリの透過性が必要:** クエリを変更せずに元のテーブルを対象とし、ClickHouseが特定のクエリに最適なデータレイアウトを選択することに依存したい場合。

### プロジェクションを避けるべき場合 {#avoid-projections}

以下の場合にプロジェクションの使用を避けることを検討してください:

- **複雑なデータ変換または多段階ETLが必要:** プロジェクションは定義内で`JOIN`操作をサポートせず、多段階パイプラインを構築するために変更することができず、ウィンドウ関数や複雑な`CASE`文などの一部のSQL機能を処理できません。そのため、複雑なデータ変換には適していません。
- **マテリアライズされたデータの明示的なフィルタリングが必要:** プロジェクションは、プロジェクション自体にマテリアライズされるデータをフィルタリングするための`WHERE`句を定義内でサポートしていません。
- **MergeTree以外のテーブルエンジンを使用している:** プロジェクションは`MergeTree`ファミリーのエンジンを使用するテーブルでのみ利用可能です。
- `FINAL`クエリが不可欠である: プロジェクションは`FINAL`クエリと連携せず、これは重複排除に使用されることがあります。
- [パラレルレプリカ](/deployment-guides/parallel-replicas)が必要である場合、プロジェクションではサポートされていません。


## まとめ {#summary}

マテリアライズドビューとプロジェクションは、クエリの最適化とデータ変換のための強力なツールであり、一般的には、どちらか一方を選択するという考え方は推奨しません。むしろ、これらを補完的に使用することで、クエリから最大限の効果を引き出すことができます。したがって、ClickHouseにおけるマテリアライズドビューとプロジェクションの選択は、具体的なユースケースとアクセスパターンによって決まります。

一般的な目安として、1つ以上のソーステーブルからターゲットテーブルへデータを集約する必要がある場合や、大規模な複雑な変換を実行する必要がある場合は、マテリアライズドビューの使用を検討すべきです。マテリアライズドビューは、負荷の高い集約処理をクエリ時から挿入時にシフトするのに優れています。日次または月次のロールアップ、リアルタイムダッシュボード、データサマリーに最適な選択肢です。

一方、ディスク上のデータの物理的な順序を決定するテーブルのプライマリキーで使用されている列とは異なる列でフィルタリングするクエリを最適化する必要がある場合は、プロジェクションを使用すべきです。プロジェクションは、テーブルのプライマリキーを変更できない場合や、アクセスパターンがプライマリキーで対応できる範囲よりも多様である場合に特に有用です。
