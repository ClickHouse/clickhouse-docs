---
description: 'SAMPLE句に関するドキュメント'
sidebar_label: 'SAMPLE'
slug: /sql-reference/statements/select/sample
title: 'SAMPLE句'
doc_type: 'reference'
---



# SAMPLE 句

`SAMPLE` 句は、概算の結果を返す `SELECT` クエリ処理を可能にします。

データサンプリングが有効な場合、クエリはすべてのデータではなく、ある割合のデータ（サンプル）に対してのみ実行されます。たとえば、すべての訪問に対する統計量を計算する必要があるとしても、全訪問のうち 1/10 のデータに対してクエリを実行し、その結果を 10 倍するだけで十分な場合があります。

近似クエリ処理は、次のような場合に有用です。

- 厳しいレイテンシ要件（100ms 未満など）がある一方で、それを満たすための追加ハードウェアリソースのコストを正当化できない場合。
- 生データがそもそも正確ではなく、近似によって品質が目立って低下しない場合。
- ビジネス要件として近似結果で十分な場合（コスト効率のため、または正確な結果をプレミアムユーザー向けに提供するためなど）。

:::note    
サンプリングが使用できるのは、[MergeTree](../../../engines/table-engines/mergetree-family/mergetree.md) ファミリーのテーブルのみであり、かつテーブル作成時にサンプリング式が指定されている場合に限られます（[MergeTree engine](../../../engines/table-engines/mergetree-family/mergetree.md#table_engine-mergetree-creating-a-table) を参照）。
:::

データサンプリングの特性は次のとおりです。

- データサンプリングは決定論的に動作する仕組みです。同じ `SELECT .. SAMPLE` クエリの結果は常に同じになります。
- サンプリングは異なるテーブル間でも一貫して動作します。単一のサンプリングキーを持つテーブルでは、同じ係数でのサンプルは常に、取り得るデータ全体の集合から同じ部分集合を選択します。たとえば、ユーザー ID のサンプルでは、複数のテーブルから取得する際にも、取り得るすべてのユーザー ID のうち同じ部分集合に対応する行が取得されます。これは、[IN](../../../sql-reference/operators/in.md) 句のサブクエリ内でサンプルを使用できることを意味します。また、[JOIN](../../../sql-reference/statements/select/join.md) 句を使ってサンプル同士を結合することもできます。
- サンプリングにより、ディスクから読み取るデータ量を削減できます。ただし、サンプリングキーを正しく指定する必要があります。詳細については、[Creating a MergeTree Table](../../../engines/table-engines/mergetree-family/mergetree.md#table_engine-mergetree-creating-a-table) を参照してください。

`SAMPLE` 句では、次の構文がサポートされています。

| SAMPLE Clause Syntax | Description                                                                                                                                                                                                                                    |
|----------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `SAMPLE k`   | ここで `k` は 0 から 1 までの数値です。クエリはデータの `k` の割合に対して実行されます。たとえば、`SAMPLE 0.1` はデータの 10% に対してクエリを実行します。[詳細](#sample-k)                                                                             |
| `SAMPLE n`    | ここで `n` は十分に大きな整数です。クエリは少なくとも `n` 行のサンプル（ただし、それを大きく超えない行数）に対して実行されます。たとえば、`SAMPLE 10000000` は最小 10,000,000 行に対してクエリを実行します。[詳細](#sample-n) |
| `SAMPLE k OFFSET m`  | ここで `k` と `m` は 0 から 1 までの数値です。クエリはデータの `k` の割合のサンプルに対して実行されます。サンプルに使用されるデータは `m` の割合だけオフセットされます。[詳細](#sample-k-offset-m)                                           |



## SAMPLE K {#sample-k}

ここで`k`は0から1までの数値です(分数表記と小数表記の両方がサポートされています)。例えば、`SAMPLE 1/2`または`SAMPLE 0.5`のように指定します。

`SAMPLE k`句では、データ全体の`k`の割合からサンプルが抽出されます。以下に例を示します:

```sql
SELECT
    Title,
    count() * 10 AS PageViews
FROM hits_distributed
SAMPLE 0.1
WHERE
    CounterID = 34
GROUP BY Title
ORDER BY PageViews DESC LIMIT 1000
```

この例では、クエリはデータ全体の0.1(10%)のサンプルに対して実行されます。集計関数の値は自動的に補正されないため、近似結果を得るには`count()`の値を手動で10倍する必要があります。


## SAMPLE N {#sample-n}

ここで `n` は十分に大きな整数です。例: `SAMPLE 10000000`

この場合、クエリは少なくとも `n` 行のサンプルに対して実行されます(ただし、これを大幅に超えることはありません)。例えば、`SAMPLE 10000000` は最低10,000,000行に対してクエリを実行します。

データ読み取りの最小単位は1つのグラニュール(そのサイズは `index_granularity` 設定で指定されます)であるため、グラニュールのサイズよりもはるかに大きなサンプルを設定することが推奨されます。

`SAMPLE n` 句を使用する場合、処理されたデータの相対的な割合は不明です。そのため、集計関数に乗算すべき係数もわかりません。近似結果を得るには、`_sample_factor` 仮想カラムを使用してください。

`_sample_factor` カラムには、動的に計算される相対係数が含まれています。このカラムは、指定されたサンプリングキーを持つテーブルを[作成](../../../engines/table-engines/mergetree-family/mergetree.md#table_engine-mergetree-creating-a-table)すると自動的に作成されます。`_sample_factor` カラムの使用例を以下に示します。

サイト訪問に関する統計情報を含む `visits` テーブルを考えてみましょう。最初の例は、ページビュー数の計算方法を示しています:

```sql
SELECT sum(PageViews * _sample_factor)
FROM visits
SAMPLE 10000000
```

次の例は、訪問総数の計算方法を示しています:

```sql
SELECT sum(_sample_factor)
FROM visits
SAMPLE 10000000
```

以下の例は、平均セッション時間の計算方法を示しています。平均値を計算する際には相対係数を使用する必要がないことに注意してください。

```sql
SELECT avg(Duration)
FROM visits
SAMPLE 10000000
```


## SAMPLE K OFFSET M {#sample-k-offset-m}

ここで、`k` と `m` は 0 から 1 の範囲の数値です。以下に例を示します。

**例 1**

```sql
SAMPLE 1/10
```

この例では、全データの 1/10 がサンプルとして抽出されます:

`[++------------]`

**例 2**

```sql
SAMPLE 1/10 OFFSET 1/2
```

ここでは、データの後半から 10% のサンプルが抽出されます。

`[------++------]`
