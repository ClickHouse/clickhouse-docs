---
description: '暗号化関数のドキュメント'
sidebar_label: '暗号化'
slug: /sql-reference/functions/encryption-functions
title: '暗号化関数'
keywords: ['encryption', 'regular functions', 'encrypt', 'decrypt']
doc_type: 'reference'
---



# 暗号化関数

これらの関数は、AES（Advanced Encryption Standard）アルゴリズムを使用したデータの暗号化と復号化を実装します。

鍵の長さは暗号化モードに依存します：`-128-`、`-192-`、`-256-`モードに対してそれぞれ`16`、`24`、`32`バイトです。

初期化ベクトルの長さは常に16バイトです（16バイトを超えるバイトは無視されます）。

<!--
The inner content of the tags below are replaced at doc framework build time with
docs generated from system.functions. Please do not modify or remove the tags.
See: https://github.com/ClickHouse/clickhouse-docs/blob/main/contribute/autogenerated-documentation-from-source.md
-->


<!--AUTOGENERATED_START-->

## aes_decrypt_mysql {#aes_decrypt_mysql}

導入バージョン: v20.12

MySQLの[`AES_ENCRYPT`](https://dev.mysql.com/doc/refman/8.0/en/encryption-functions.html#function_aes-encrypt)関数で暗号化されたデータを復号します。

同じ入力に対して[`decrypt`](#decrypt)と同じ平文を生成します。
`key`または`iv`が通常あるべき長さよりも長い場合、`aes_decrypt_mysql`はMySQLの`aes_decrypt`の動作に従い、`key`を「折りたたみ」、`IV`の余分なビットを無視します。

以下の復号モードをサポートしています:

- aes-128-ecb, aes-192-ecb, aes-256-ecb
- aes-128-cbc, aes-192-cbc, aes-256-cbc
- aes-128-cfb128
- aes-128-ofb, aes-192-ofb, aes-256-ofb

**構文**

```sql
aes_decrypt_mysql(mode, ciphertext, key[, iv])
```

**引数**

- `mode` — 復号モード。[`String`](/sql-reference/data-types/string)
- `ciphertext` — 復号する暗号化テキスト。[`String`](/sql-reference/data-types/string)
- `key` — 復号キー。[`String`](/sql-reference/data-types/string)
- `iv` — オプション。初期化ベクトル。[`String`](/sql-reference/data-types/string)

**戻り値**

復号された文字列を返します。[`String`](/sql-reference/data-types/string)

**例**

**MySQLデータの復号**

```sql title=Query
-- 以前にMySQLで暗号化したデータを復号してみましょう:
mysql> SET  block_encryption_mode='aes-256-ofb';
Query OK, 0 rows affected (0.00 sec)

mysql> SELECT aes_encrypt('Secret', '123456789101213141516171819202122', 'iviviviviviviviv123456') as ciphertext;
+------------------------+
| ciphertext             |
+------------------------+
| 0x24E9E4966469         |
+------------------------+
1 row in set (0.00 sec)

SELECT aes_decrypt_mysql('aes-256-ofb', unhex('24E9E4966469'), '123456789101213141516171819202122', 'iviviviviviviviv123456') AS plaintext
```

```response title=Response
┌─plaintext─┐
│ Secret    │
└───────────┘
```


## aes_encrypt_mysql {#aes_encrypt_mysql}

導入バージョン: v20.12

MySQLの`AES_ENCRYPT`関数と同じ方法でテキストを暗号化します。
生成された暗号文はMySQLの`AES_DECRYPT`関数で復号化できます。
同じ入力に対して`encrypt`関数と同じ暗号文を生成します。
`key`または`iv`が通常必要とされる長さよりも長い場合、`aes_encrypt_mysql`はMySQLの`aes_encrypt`と同じ動作を行い、`key`を「折りたたみ」、`iv`の超過ビットを無視します。

サポートされている暗号化モード:

- aes-128-ecb, aes-192-ecb, aes-256-ecb
- aes-128-cbc, aes-192-cbc, aes-256-cbc
- aes-128-ofb, aes-192-ofb, aes-256-ofb

**構文**

```sql
aes_encrypt_mysql(mode, plaintext, key[, iv])
```

**引数**

- `mode` — 暗号化モード。[`String`](/sql-reference/data-types/string)
- `plaintext` — 暗号化するテキスト。[`String`](/sql-reference/data-types/string)
- `key` — 暗号化キー。キーが`mode`で必要とされる長さよりも長い場合、MySQL固有のキー折りたたみが実行されます。[`String`](/sql-reference/data-types/string)
- `iv` — オプション。初期化ベクトル。最初の16バイトのみが考慮されます。[`String`](/sql-reference/data-types/string)

**戻り値**

暗号文のバイナリ文字列。[`String`](/sql-reference/data-types/string)

**例**

**同一入力の比較**

```sql title=Query
-- 同一の入力が与えられた場合、encryptとaes_encrypt_mysqlは同じ暗号文を生成します:
SELECT encrypt('aes-256-ofb', 'Secret', '12345678910121314151617181920212', 'iviviviviviviviv') = aes_encrypt_mysql('aes-256-ofb', 'Secret', '12345678910121314151617181920212', 'iviviviviviviviv') AS ciphertexts_equal;
```

```response title=Response
┌─ciphertexts_equal─┐
│                 1 │
└───────────────────┘
```

**長いキーでの暗号化の失敗**

```sql title=Query
-- ただし、keyまたはivが予想よりも長い場合、encryptは失敗します:
SELECT encrypt('aes-256-ofb', 'Secret', '123456789101213141516171819202122', 'iviviviviviviviv123');
```

```response title=Response
Received exception from server (version 22.6.1):
Code: 36. DB::Exception: Received from localhost:9000. DB::Exception: Invalid key size: 33 expected 32: While processing encrypt('aes-256-ofb', 'Secret', '123456789101213141516171819202122', 'iviviviviviviviv123').
```

**MySQL互換性**

```sql title=Query
-- aes_encrypt_mysqlはMySQL互換の出力を生成します:
SELECT hex(aes_encrypt_mysql('aes-256-ofb', 'Secret', '123456789101213141516171819202122', 'iviviviviviviviv123')) AS ciphertext;
```

```response title=Response
┌─ciphertext───┐
│ 24E9E4966469 │
└──────────────┘
```

**より長いIVでも同じ結果を生成**

```sql title=Query
-- さらに長いIVを指定しても同じ結果が生成されることに注意してください
SELECT hex(aes_encrypt_mysql('aes-256-ofb', 'Secret', '123456789101213141516171819202122', 'iviviviviviviviv123456')) AS ciphertext
```

```response title=Response
┌─ciphertext───┐
│ 24E9E4966469 │
└──────────────┘
```


## decrypt {#decrypt}

導入バージョン: v20.12

この関数は、以下のモードを使用してAES暗号化されたバイナリ文字列を復号化します:

- aes-128-ecb, aes-192-ecb, aes-256-ecb
- aes-128-cbc, aes-192-cbc, aes-256-cbc
- aes-128-ofb, aes-192-ofb, aes-256-ofb
- aes-128-gcm, aes-192-gcm, aes-256-gcm
- aes-128-ctr, aes-192-ctr, aes-256-ctr
- aes-128-cfb, aes-128-cfb1, aes-128-cfb8

**構文**

```sql
decrypt(mode, ciphertext, key[, iv, aad])
```

**引数**

- `mode` — 復号化モード。[`String`](/sql-reference/data-types/string)
- `ciphertext` — 復号化対象の暗号化テキスト。[`String`](/sql-reference/data-types/string)
- `key` — 復号化キー。[`String`](/sql-reference/data-types/string)
- `iv` — 初期化ベクトル。`-gcm`モードでは必須、その他のモードでは任意。[`String`](/sql-reference/data-types/string)
- `aad` — 追加認証データ。この値が正しくない場合、復号化は行われません。`-gcm`モードでのみ機能し、その他のモードでは例外がスローされます。[`String`](/sql-reference/data-types/string)

**戻り値**

復号化された平文を返します。[`String`](/sql-reference/data-types/string)

**例**

**暗号化データの正しい復号化**

```sql title=Query
-- encrypt関数の例で使用したテーブルを再利用
SELECT comment, hex(secret) FROM encryption_test;
```

```response title=Response
┌─comment──────────────┬─hex(secret)──────────────────────────────────┐
│ aes-256-gcm          │ A8A3CCBC6426CFEEB60E4EAE03D3E94204C1B09E0254 │
│ aes-256-gcm with AAD │ A8A3CCBC6426D9A1017A0A932322F1852260A4AD6837 │
└──────────────────────┴──────────────────────────────────────────────┘
┌─comment──────────────────────────┬─hex(secret)──────────────────────┐
│ aes-256-ofb no IV                │ B4972BDC4459                     │
│ aes-256-ofb no IV, different key │ 2FF57C092DC9                     │
│ aes-256-ofb with IV              │ 5E6CB398F653                     │
│ aes-256-cbc no IV                │ 1BC0629A92450D9E73A00E7D02CF4142 │
└──────────────────────────────────┴──────────────────────────────────┘
```

**暗号化データの誤った復号化**

```sql title=Query
SELECT comment, decrypt('aes-256-cfb128', secret, '12345678910121314151617181920212') AS plaintext FROM encryption_test
```

```response title=Response
-- データの一部のみが正しく復号化され、残りは文字化けしていることに注意してください。これは暗号化時に`mode`、`key`、または`iv`が異なっていたためです。
┌─comment──────────────┬─plaintext──┐
│ aes-256-gcm          │ OQ�E
                             �t�7T�\���\�   │
│ aes-256-gcm with AAD │ OQ�E
                             �\��si����;�o�� │
└──────────────────────┴────────────┘
┌─comment──────────────────────────┬─plaintext─┐
│ aes-256-ofb no IV                │ Secret    │
│ aes-256-ofb no IV, different key │ �4�
                                        �         │
│ aes-256-ofb with IV              │ ���6�~        │
│aes-256-cbc no IV                │ �2*4�h3c�4w��@
└──────────────────────────────────┴───────────┘
```


## encrypt {#encrypt}

導入バージョン: v20.12

以下のいずれかのモードでAESを使用して平文を暗号文に暗号化します:

- aes-128-ecb, aes-192-ecb, aes-256-ecb
- aes-128-cbc, aes-192-cbc, aes-256-cbc
- aes-128-ofb, aes-192-ofb, aes-256-ofb
- aes-128-gcm, aes-192-gcm, aes-256-gcm
- aes-128-ctr, aes-192-ctr, aes-256-ctr
- aes-128-cfb, aes-128-cfb1, aes-128-cfb8

**構文**

```sql
encrypt(mode, plaintext, key[, iv, aad])
```

**引数**

- `mode` — 暗号化モード。[`String`](/sql-reference/data-types/string)
- `plaintext` — 暗号化対象のテキスト。[`String`](/sql-reference/data-types/string)
- `key` — 暗号化キー。[`String`](/sql-reference/data-types/string)
- `iv` — 初期化ベクトル。`-gcm`モードでは必須、その他のモードでは省略可能。[`String`](/sql-reference/data-types/string)
- `aad` — 追加認証データ。暗号化されませんが、復号化に影響します。`-gcm`モードでのみ動作し、その他のモードでは例外をスローします。[`String`](/sql-reference/data-types/string)

**戻り値**

バイナリ文字列の暗号文を返します。[`String`](/sql-reference/data-types/string)

**例**

**暗号化の例**

```sql title=クエリ
CREATE TABLE encryption_test
(
    `comment` String,
    `secret` String
)
ENGINE = MergeTree;

INSERT INTO encryption_test VALUES
('aes-256-ofb no IV', encrypt('aes-256-ofb', 'Secret', '12345678910121314151617181920212')),
('aes-256-ofb no IV, different key', encrypt('aes-256-ofb', 'Secret', 'keykeykeykeykeykeykeykeykeykeyke')),
('aes-256-ofb with IV', encrypt('aes-256-ofb', 'Secret', '12345678910121314151617181920212', 'iviviviviviviviv')),
('aes-256-cbc no IV', encrypt('aes-256-cbc', 'Secret', '12345678910121314151617181920212'));

SELECT comment, hex(secret) FROM encryption_test;
```

```response title=レスポンス
┌─comment──────────────────────────┬─hex(secret)──────────────────────┐
│ aes-256-ofb no IV                │ B4972BDC4459                     │
│ aes-256-ofb no IV, different key │ 2FF57C092DC9                     │
│ aes-256-ofb with IV              │ 5E6CB398F653                     │
│ aes-256-cbc no IV                │ 1BC0629A92450D9E73A00E7D02CF4142 │
└──────────────────────────────────┴──────────────────────────────────┘
```

**GCMモードの例**

```sql title=クエリ
INSERT INTO encryption_test VALUES
('aes-256-gcm', encrypt('aes-256-gcm', 'Secret', '12345678910121314151617181920212', 'iviviviviviviviv')),

('aes-256-gcm with AAD', encrypt('aes-256-gcm', 'Secret', '12345678910121314151617181920212', 'iviviviviviviviv', 'aad'));

SELECT comment, hex(secret) FROM encryption_test WHERE comment LIKE '%gcm%';
```

```response title=レスポンス
┌─comment──────────────┬─hex(secret)──────────────────────────────────┐
│ aes-256-gcm          │ A8A3CCBC6426CFEEB60E4EAE03D3E94204C1B09E0254 │
│ aes-256-gcm with AAD │ A8A3CCBC6426D9A1017A0A932322F1852260A4AD6837 │
└──────────────────────┴──────────────────────────────────────────────┘
```


## tryDecrypt {#tryDecrypt}

導入バージョン: v22.10

`decrypt`関数と同様ですが、誤った鍵を使用して復号化に失敗した場合は`NULL`を返します。

**構文**

```sql
tryDecrypt(mode, ciphertext, key[, iv, aad])
```

**引数**

- `mode` — 復号化モード。[`String`](/sql-reference/data-types/string)
- `ciphertext` — 復号化対象の暗号化テキスト。[`String`](/sql-reference/data-types/string)
- `key` — 復号化鍵。[`String`](/sql-reference/data-types/string)
- `iv` — オプション。初期化ベクトル。`-gcm`モードでは必須、その他のモードではオプション。[`String`](/sql-reference/data-types/string)
- `aad` — オプション。追加認証データ。この値が正しくない場合は復号化されません。`-gcm`モードでのみ動作し、その他のモードでは例外をスローします。[`String`](/sql-reference/data-types/string)

**戻り値**

復号化された文字列を返します。復号化に失敗した場合は`NULL`を返します。[`Nullable(String)`](/sql-reference/data-types/nullable)

**例**

**テーブルの作成とデータの挿入**

```sql title=Query
-- user_idが一意のユーザーID、encryptedが暗号化された文字列フィールド、ivが復号化/暗号化用の初期化ベクトルであるテーブルを作成します。
-- ユーザーは自分のIDと暗号化フィールドを復号化するための鍵を知っていると仮定します:
CREATE TABLE decrypt_null
(
    dt DateTime,
    user_id UInt32,
    encrypted String,
    iv String
)
ENGINE = MergeTree;

-- データを挿入します:
INSERT INTO decrypt_null VALUES
('2022-08-02 00:00:00', 1, encrypt('aes-256-gcm', 'value1', 'keykeykeykeykeykeykeykeykeykey01', 'iv1'), 'iv1'),
('2022-09-02 00:00:00', 2, encrypt('aes-256-gcm', 'value2', 'keykeykeykeykeykeykeykeykeykey02', 'iv2'), 'iv2'),
('2022-09-02 00:00:01', 3, encrypt('aes-256-gcm', 'value3', 'keykeykeykeykeykeykeykeykeykey03', 'iv3'), 'iv3');

-- 1つの鍵で復号化を試みます
SELECT
    dt,
    user_id,
    tryDecrypt('aes-256-gcm', encrypted, 'keykeykeykeykeykeykeykeykeykey02', iv) AS value
FROM decrypt_null
ORDER BY user_id ASC
```

```response title=Response
┌──────────────────dt─┬─user_id─┬─value──┐
│ 2022-08-02 00:00:00 │       1 │ ᴺᵁᴸᴸ   │
│ 2022-09-02 00:00:00 │       2 │ value2 │
│ 2022-09-02 00:00:01 │       3 │ ᴺᵁᴸᴸ   │
└─────────────────────┴─────────┴────────┘
```

<!--AUTOGENERATED_END-->
