---
sidebar_label: 'クライアント'
sidebar_position: 2
keywords: ['clickhouse', 'java', 'client', 'integrate']
description: 'Java 用 ClickHouse コネクタ'
slug: /integrations/language-clients/java/client
title: 'Java クライアント'
doc_type: 'reference'
integration:
  - support_level: 'core'
  - category: 'language_client'
---

import ClientVersionDropdown from '@theme/ClientVersionDropdown/ClientVersionDropdown';
import Version from '@theme/ClientVersionDropdown/Version';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import WideTableWrapper from '@site/src/components/WideTableWrapper/WideTableWrapper';

<ClientVersionDropdown
  versions={[
{
'version': 'v0.8+'
},
{
'version': 'v0.7.x'
}
]}
>
  <Version>
    DBサーバーとそのプロトコルを通じて通信するためのJavaクライアントライブラリ。現在の実装では[HTTPインターフェース](/interfaces/http)のみをサポートしています。
    このライブラリは、サーバーへのリクエスト送信用の独自APIを提供します。また、異なるバイナリデータ形式(RowBinary* &amp; Native*)を扱うためのツールも提供します。

    ## セットアップ \{#setup\}

    * Maven Central（プロジェクトの Web ページ）: https://mvnrepository.com/artifact/com.clickhouse/client-v2
    * ナイトリービルド（リポジトリへのリンク）：https://central.sonatype.com/repository/maven-snapshots/
    * 旧Nightlyビルド用 Artifactory（リポジトリリンク）： https://s01.oss.sonatype.org/content/repositories/snapshots/

    <br />

    <Tabs groupId="client-setup">
      <TabItem value="maven" label="Maven">
        ```xml
        <dependency>
            <groupId>com.clickhouse</groupId>
            <artifactId>client-v2</artifactId>
            <version>0.9.4</version>
        </dependency>
        ```
      </TabItem>

      <TabItem value="gradle-kt" label="Gradle (Kotlin)">
        ```kotlin
        // https://mvnrepository.com/artifact/com.clickhouse/client-v2
        implementation("com.clickhouse:client-v2:0.9.4")
        ```
      </TabItem>

      <TabItem value="gradle" label="Gradle">
        ```groovy
        // https://mvnrepository.com/artifact/com.clickhouse/client-v2
        implementation 'com.clickhouse:client-v2:0.9.4'
        ```
      </TabItem>
    </Tabs>

    <br />

    ## 初期化 \{#initialization\}

    Clientオブジェクトは`com.clickhouse.client.api.Client.Builder#build()`によって初期化されます。各クライアントは独自のコンテキストを持ち、クライアント間でオブジェクトが共有されることはありません。
    Builderには、セットアップを簡単に行うための設定メソッドが用意されています。

    例:

    ```java showLineNumbers
     Client client = new Client.Builder()
                    .addEndpoint("https://clickhouse-cloud-instance:8443/")
                    .setUsername(user)
                    .setPassword(password)
                    .build();
    ```

    `Client`は`AutoCloseable`であり、不要になった時点で閉じる必要があります。

    ### 認証 \{#authentication\}

    認証は初期化フェーズでクライアントごとに設定されます。サポートされている認証方式は3つあります: パスワード、アクセストークン、SSL クライアント証明書による認証です。

    パスワード認証では、`setUsername(String)` と `setPassword(String)` を呼び出してユーザー名とパスワードを設定する必要があります:

    ```java showLineNumbers
     Client client = new Client.Builder()
            .addEndpoint("https://clickhouse-cloud-instance:8443/")
            .setUsername(user)
            .setPassword(password)
            .build();
    ```

    アクセストークンによる認証を行うには、`setAccessToken(String)` を呼び出してアクセストークンを設定します:

    ```java showLineNumbers
     Client client = new Client.Builder()
            .addEndpoint("https://clickhouse-cloud-instance:8443/")
            .setAccessToken(userAccessToken)
            .build();
    ```

    SSLクライアント証明書による認証を行うには、`setUsername(String)`、`useSSLAuthentication(boolean)`、`setClientCertificate(String)`、`setClientKey(String)`を呼び出して、ユーザー名の設定、SSL認証の有効化、クライアント証明書とクライアントキーの設定を行う必要があります:

    ```java showLineNumbers
    Client client = new Client.Builder()
            .useSSLAuthentication(true)
            .setUsername("some_user")
            .setClientCertificate("some_user.crt")
            .setClientKey("some_user.key")
    ```

    :::note
    SSL認証は、SSLライブラリから出力されるエラーの多くが十分な情報を提供しないため、本番環境でのトラブルシューティングが困難になる場合があります。例えば、クライアント証明書と秘密鍵が一致しない場合、サーバーは即座に接続を切断します(HTTPの場合、HTTPリクエストが送信される前の接続初期化段階で切断されるため、レスポンスは返されません)。

    証明書と鍵を検証するには、[openssl](https://docs.openssl.org/master/man1/openssl/)のようなツールを使用してください:

    * 鍵の整合性を確認します: `openssl rsa -in [key-file.key] -check -noout`
    * クライアント証明書の CN が対象ユーザーと一致していることを確認:
      * ユーザー証明書から CN を取得します - `openssl x509 -noout -subject -in [user.cert]`
      * 次のクエリを実行して、同じ値がデータベースに設定されていることを確認します: `select name, auth_type, auth_params from system.users where auth_type = 'ssl_certificate'`（このクエリでは、`auth_params` が `{"common_names":["some_user"]}` のような形式で出力されます）

    :::

    ## 設定 \{#configuration\}

    すべての設定はインスタンスメソッド(構成メソッドとも呼ばれる)によって定義され、各値のスコープとコンテキストが明確になります。
    主要な構成パラメータは単一のスコープ(クライアントまたはオペレーション)で定義され、相互に上書きされることはありません。

    設定はクライアント作成時に定義します。`com.clickhouse.client.api.Client.Builder`を参照してください。

    ## クライアント構成 \{#client-configuration\}

    <Tabs groupId="client-config">
      <TabItem value="接続" label="接続とエンドポイント">
        | Method                                                                  | Arguments                                                                | Description                                                      | Default   | Key                         |
        | ----------------------------------------------------------------------- | ------------------------------------------------------------------------ | ---------------------------------------------------------------- | --------- | --------------------------- |
        | `addEndpoint(String endpoint)`                                          | `endpoint` - URL 形式のサーバーアドレス                                             | 利用可能なサーバーのリストにサーバーエンドポイントを追加します。現在は 1 つのエンドポイントのみがサポートされています。    | `none`    | `none`                      |
        | `addEndpoint(Protocol protocol, String host, int port, boolean secure)` | `protocol` - 接続プロトコル<br />`host` - IP もしくはホスト名<br />`secure` - HTTPS を使用 | 利用可能なサーバーのリストにサーバーエンドポイントを追加します。現在は 1 つのエンドポイントのみがサポートされています。    | `none`    | `none`                      |
        | `enableConnectionPool(boolean enable)`                                  | `enable` - 有効/無効を切り替えるフラグ                                                | コネクションプールを有効にするかどうかを設定します。                                       | `true`    | `connection_pool_enabled`   |
        | `setMaxConnections(int maxConnections)`                                 | `maxConnections` - コネクション数                                               | 各サーバーエンドポイントに対してクライアントが開くことができる接続数の上限を設定します。                     | `10`      | `max_open_connections`      |
        | `setConnectionTTL(long timeout, ChronoUnit unit)`                       | `timeout` - タイムアウト値<br />`unit` - 時間単位                                   | 接続が非アクティブと見なされるまでの接続の有効期限 (TTL) を設定します。                          | `-1`      | `connection_ttl`            |
        | `setKeepAliveTimeout(long timeout, ChronoUnit unit)`                    | `timeout` - タイムアウト値<br />`unit` - 時間単位                                   | HTTP 接続の Keep-Alive タイムアウトを設定します。Keep-Alive を無効にするには `0` を設定します。 | -         | `http_keep_alive_timeout`   |
        | `setConnectionReuseStrategy(ConnectionReuseStrategy strategy)`          | `strategy` - `LIFO` または `FIFO`                                           | コネクションプールが使用する接続再利用戦略を選択します。                                     | `FIFO`    | `connection_reuse_strategy` |
        | `setDefaultDatabase(String database)`                                   | `database` - データベース名                                                     | デフォルトデータベースを設定します。                                               | `default` | `database`                  |
      </TabItem>

      <TabItem value="認証" label="認証">
        | Method                                               | Arguments                                | Description                                                                   | Default   | Key                   |
        | ---------------------------------------------------- | ---------------------------------------- | ----------------------------------------------------------------------------- | --------- | --------------------- |
        | `setUsername(String username)`                       | `username` - 認証用のユーザー名                   | 追加の設定によって選択される認証方式で使用するユーザー名を設定します                                            | `default` | `user`                |
        | `setPassword(String password)`                       | `password` - シークレット値                     | パスワード認証用のシークレットを設定し、その認証方式を選択します                                              | -         | `password`            |
        | `setAccessToken(String accessToken)`                 | `accessToken` - アクセストークン文字列              | アクセストークンを設定し、対応する認証方式での認証に使用されるようにします                                         | -         | `access_token`        |
        | `useSSLAuthentication(boolean useSSLAuthentication)` | `useSSLAuthentication` - SSL 認証を有効化するフラグ | SSL クライアント証明書を認証方式として使用するように設定します                                             | -         | `ssl_authentication`  |
        | `useHTTPBasicAuth(boolean useBasicAuth)`             | `useBasicAuth` - 有効/無効を切り替えるフラグ          | ユーザー名とパスワードによる認証において、Basic HTTP 認証を使用するかどうかを設定します。特殊文字を含むパスワードによる問題の解消に役立ちます。 | `true`    | `http_use_basic_auth` |
        | `useBearerTokenAuth(String bearerToken)`             | `bearerToken` - エンコード済み Bearer トークン      | Bearer 認証を使用するかどうかと、使用するトークンを指定します。トークンはそのまま送信されます。                           | -         | `bearer_token`        |
      </TabItem>

      <TabItem value="タイムアウト" label="タイムアウトと再試行">
        | Method                                                       | Arguments                                  | Description                                  | Default                                                      | Key                          |
        | ------------------------------------------------------------ | ------------------------------------------ | -------------------------------------------- | ------------------------------------------------------------ | ---------------------------- |
        | `setConnectTimeout(long timeout, ChronoUnit unit)`           | `timeout` - タイムアウト値<br />`unit` - 時間単位     | すべての発信側接続について、接続確立のタイムアウトを設定します。             | -                                                            | `connection_timeout`         |
        | `setConnectionRequestTimeout(long timeout, ChronoUnit unit)` | `timeout` - タイムアウト値<br />`unit` - 時間単位     | 接続要求のタイムアウトを設定します。これはプールから接続を取得する場合にのみ有効です。  | `10000`                                                      | `connection_request_timeout` |
        | `setSocketTimeout(long timeout, ChronoUnit unit)`            | `timeout` - タイムアウト値<br />`unit` - 時間単位     | 読み取りおよび書き込み操作に影響するソケットタイムアウトを設定します。          | `0`                                                          | `socket_timeout`             |
        | `setExecutionTimeout(long timeout, ChronoUnit timeUnit)`     | `timeout` - タイムアウト値<br />`timeUnit` - 時間単位 | クエリの最大実行時間を設定します。                            | `0`                                                          | `max_execution_time`         |
        | `retryOnFailures(ClientFaultCause ...causes)`                | `causes` - `ClientFaultCause` の enum 定数    | リカバリ可能／再試行可能な障害種別を設定します。                     | `NoHttpResponse` `ConnectTimeout` `ConnectionRequestTimeout` | `client_retry_on_failures`   |
        | `setMaxRetries(int maxRetries)`                              | `maxRetries` - 再試行回数                       | `retryOnFailures` で定義された障害に対する最大再試行回数を設定します。 | `3`                                                          | `retry`                      |
      </TabItem>

      <TabItem value="ソケット" label="ソケットオプション">
        | Method                               | Arguments             | Description                                                                           | Default | Key                  |
        | ------------------------------------ | --------------------- | ------------------------------------------------------------------------------------- | ------- | -------------------- |
        | `setSocketRcvbuf(long size)`         | `size` - バイト数         | TCP ソケットの受信バッファを設定します。このバッファは JVM メモリの外側に確保されます。                                      | `8196`  | `socket_rcvbuf`      |
        | `setSocketSndbuf(long size)`         | `size` - バイト数         | TCP ソケットの送信バッファを設定します。このバッファは JVM メモリの外側に確保されます。                                      | `8196`  | `socket_sndbuf`      |
        | `setSocketKeepAlive(boolean value)`  | `value` - 有効/無効を示すフラグ | すべての TCP ソケットに対してオプション `SO_KEEPALIVE` を設定します。TCP Keep-Alive は、接続の生存状態を確認する仕組みを有効にします。 | -       | `socket_keepalive`   |
        | `setSocketTcpNodelay(boolean value)` | `value` - 有効/無効を示すフラグ | すべての TCP ソケットに対してオプション `SO_NODELAY` を設定します。この TCP オプションにより、ソケットは可能な限り速やかにデータを送信します。   | -       | `socket_tcp_nodelay` |
        | `setSocketLinger(int secondsToWait)` | `secondsToWait` - 秒数  | クライアントによって作成されるすべての TCP ソケットの Linger 時間を設定します。                                        | -       | `socket_linger`      |
      </TabItem>

      <TabItem value="圧縮" label="圧縮">
        | Method                                    | Arguments               | Description                                               | Default | Key                                        |
        | ----------------------------------------- | ----------------------- | --------------------------------------------------------- | ------- | ------------------------------------------ |
        | `compressServerResponse(boolean enabled)` | `enabled` - 有効/無効を示すフラグ | サーバーがレスポンスを圧縮するかどうかを指定します。                                | `true`  | `compress`                                 |
        | `compressClientRequest(boolean enabled)`  | `enabled` - 有効/無効を示すフラグ | クライアントがリクエストを圧縮するかどうかを指定します。                              | `false` | `decompress`                               |
        | `useHttpCompression(boolean enabled)`     | `enabled` - 有効/無効を示すフラグ | 対応するオプションが有効な場合に、クライアント/サーバー間の通信で HTTP 圧縮を使用するかどうかを指定します。 | -       | -                                          |
        | `appCompressedData(boolean enabled)`      | `enabled` - 有効/無効を示すフラグ | 圧縮処理がアプリケーション側で行われることをクライアントに通知します。                       | `false` | `app_compressed_data`                      |
        | `setLZ4UncompressedBufferSize(int size)`  | `size` - バイト単位のサイズ      | 非圧縮データストリームを受信するバッファのサイズを設定します。                           | `65536` | `compression.lz4.uncompressed_buffer_size` |
        | `disableNativeCompression`                | `disable` - 無効化を示すフラグ   | ネイティブ圧縮を無効にします。`true` の場合、ネイティブ圧縮は無効になります。                | `false` | `disable_native_compression`               |
      </TabItem>

      <TabItem value="SSL" label="SSL/セキュリティ">
        | Method                                      | Arguments                 | Description                                                   | Default | Key                  |
        | ------------------------------------------- | ------------------------- | ------------------------------------------------------------- | ------- | -------------------- |
        | `setSSLTrustStore(String path)`             | `path` - ローカルシステム上のファイルパス | クライアントがサーバーホストの検証のために SSL トラストストアを使用するかどうかを設定します。             | -       | `trust_store`        |
        | `setSSLTrustStorePassword(String password)` | `password` - シークレット値      | `setSSLTrustStore` で指定した SSL トラストストアのロック解除に使用するパスワードを設定します。   | -       | `key_store_password` |
        | `setSSLTrustStoreType(String type)`         | `type` - truststore のタイプ名 | `setSSLTrustStore` で指定したトラストストアの種類を設定します。                     | -       | `key_store_type`     |
        | `setRootCertificate(String path)`           | `path` - ローカルシステム上のファイルパス | サーバーホストの検証に使用するルート (CA) 証明書をクライアントが利用するかどうかを設定します。            | -       | `sslrootcert`        |
        | `setClientCertificate(String path)`         | `path` - ローカルシステム上のファイルパス | SSL 接続の確立時および SSL 認証で使用するクライアント証明書のパスを設定します。                  | -       | `sslcert`            |
        | `setClientKey(String path)`                 | `path` - ローカルシステム上のファイルパス | サーバーとの SSL 通信を暗号化するために使用するクライアント秘密鍵を設定します。                    | -       | `ssl_key`            |
        | `sslSocketSNI(String sni)`                  | `sni` - サーバー名文字列          | SSL/TLS 接続において SNI (Server Name Indication) に使用するサーバー名を設定します。 | -       | `ssl_socket_sni`     |
      </TabItem>

      <TabItem value="プロキシ" label="プロキシ">
        | Method                                            | Arguments                                                               | Description                | Default | Key                                      |
        | ------------------------------------------------- | ----------------------------------------------------------------------- | -------------------------- | ------- | ---------------------------------------- |
        | `addProxy(ProxyType type, String host, int port)` | `type` - プロキシの種類<br />`host` - プロキシのホスト名または IP<br />`port` - プロキシのポート番号 | サーバーとの通信に使用するプロキシを設定します。   | -       | `proxy_type`, `proxy_host`, `proxy_port` |
        | `setProxyCredentials(String user, String pass)`   | `user` - プロキシのユーザー名<br />`pass` - パスワード                                 | プロキシ認証に使用するユーザー認証情報を設定します。 | -       | `proxy_user`, `proxy_password`           |
      </TabItem>

      <TabItem value="http" label="HTTP とヘッダー">
        | Method                                      | Arguments                                     | Description                            | Default | Key    |
        | ------------------------------------------- | --------------------------------------------- | -------------------------------------- | ------- | ------ |
        | `setHttpCookiesEnabled(boolean enabled)`    | `enabled` - 有効化/無効化するためのフラグ                   | HTTP Cookie を保持し、サーバーに送信するかどうかを設定します。  | -       | -      |
        | `httpHeader(String key, String value)`      | `key` - HTTP ヘッダーのキー<br />`value` - 文字列値      | 単一の HTTP ヘッダーの値を設定します。以前の値は上書きされます。    | `none`  | `none` |
        | `httpHeader(String key, Collection values)` | `key` - HTTP ヘッダーのキー<br />`values` - 文字列値のリスト | 単一の HTTP ヘッダーに複数の値を設定します。以前の値は上書きされます。 | `none`  | `none` |
        | `httpHeaders(Map headers)`                  | `headers` - HTTP ヘッダーを含むマップ                   | 複数の HTTP ヘッダーの値を一度に設定します。              | `none`  | `none` |
      </TabItem>

      <TabItem value="server-settings" label="サーバー設定">
        | Method                                          | Arguments                        | Description                                                                                       | Default | Key    |
        | ----------------------------------------------- | -------------------------------- | ------------------------------------------------------------------------------------------------- | ------- | ------ |
        | `serverSetting(String name, String value)`      | `name` - 設定名<br />`value` - 設定値  | 各クエリとともにサーバーへ渡す設定を指定します。個々の操作で指定された設定によって上書きされる場合があります。 [設定の一覧](/operations/settings/query-level) | `none`  | `none` |
        | `serverSetting(String name, Collection values)` | `name` - 設定名<br />`values` - 設定値 | サーバーへ複数の値を持つ設定を渡します。たとえば [roles](/interfaces/http#setting-role-with-query-parameters) などがあります。    | `none`  | `none` |
      </TabItem>

      <TabItem value="タイムゾーン" label="タイムゾーン">
        | Method                                         | Arguments                            | Description                                                                     | Default | Key                    |
        | ---------------------------------------------- | ------------------------------------ | ------------------------------------------------------------------------------- | ------- | ---------------------- |
        | `useServerTimeZone(boolean useServerTimeZone)` | `useServerTimeZone` - 有効/無効を切り替えるフラグ | クライアントが DateTime および Date カラム値をデコードする際に、サーバーのタイムゾーンを使用するかどうかを指定します。             | `true`  | `use_server_time_zone` |
        | `useTimeZone(String timeZone)`                 | `timeZone` - Java の有効なタイムゾーン ID      | 指定したタイムゾーンを、DateTime および Date カラム値をデコードする際に使用するかどうかを指定します。サーバーのタイムゾーン設定を上書きします。 | -       | `use_time_zone`        |
        | `setServerTimeZone(String timeZone)`           | `timeZone` - Java の有効なタイムゾーン ID      | サーバー側のタイムゾーンを設定します。デフォルトでは UTC タイムゾーンが使用されます。                                   | `UTC`   | `server_time_zone`     |
      </TabItem>

      <TabItem value="高度な" label="詳細設定">
        | Method                                                                    | Arguments                                                    | Description                                                                     | Default  | Key                          |
        | ------------------------------------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------------------------- | -------- | ---------------------------- |
        | `setOption(String key, String value)`                                     | `key` - 設定オプションのキー<br />`value` - オプション値                     | クライアントオプションの生の値を設定します。プロパティファイルから設定を読み込む場合に有用です。                                | -        | -                            |
        | `useAsyncRequests(boolean async)`                                         | `async` - 有効/無効を切り替えるフラグ                                     | クライアントがリクエストを別スレッドで実行するかどうかを設定します。アプリケーション側がマルチスレッド処理をより適切に制御できるため、デフォルトでは無効です。 | `false`  | `async`                      |
        | `setSharedOperationExecutor(ExecutorService executorService)`             | `executorService` - ExecutorService インスタンス                   | オペレーションタスク用の ExecutorService を設定します。                                            | `none`   | `none`                       |
        | `setClientNetworkBufferSize(int size)`                                    | `size` - バイト単位のサイズ                                           | ソケットとアプリケーション間でデータをコピーする際に使用される、アプリケーションメモリ空間内のバッファサイズを設定します。                   | `300000` | `client_network_buffer_size` |
        | `allowBinaryReaderToReuseBuffers(boolean reuse)`                          | `reuse` - 有効/無効を切り替えるフラグ                                     | 有効にした場合、リーダーは数値変換を行うために事前割り当てされたバッファを再利用します。数値データに対する GC プレッシャーを軽減します。          | -        | -                            |
        | `columnToMethodMatchingStrategy(ColumnToMethodMatchingStrategy strategy)` | `strategy` - マッチング戦略の実装                                      | DTO を登録する際に、DTO クラスフィールドと DB のカラムをマッチングするために使用するカスタム戦略を設定します。                   | `none`   | `none`                       |
        | `setClientName(String clientName)`                                        | `clientName` - アプリケーション名文字列                                  | 呼び出し元アプリケーションに関する追加情報を設定します。`User-Agent` ヘッダーとして渡されます。                          | -        | `client_name`                |
        | `registerClientMetrics(Object registry, String name)`                     | `registry` - Micrometer レジストリインスタンス<br />`name` - メトリクスグループ名 | Micrometer (https://micrometer.io/) のレジストリインスタンスにメトリクスを登録します。                   | -        | -                            |
        | `setServerVersion(String version)`                                        | `version` - サーバーバージョン文字列                                     | バージョン検出を行わないようにするため、サーバーバージョンを設定します。                                            | -        | `server_version`             |
        | `typeHintMapping(Map typeHintMapping)`                                    | `typeHintMapping` - 型ヒントのマップ                                 | ClickHouse 型に対する型ヒントのマッピングを設定します。例えば、多次元配列を Java のコンテナとして表現できるようにする場合などに使用します。  | -        | `type_hint_mapping`          |
      </TabItem>
    </Tabs>

    <br />

    ### サーバー設定 \{#server-settings\}

    サーバー側設定は、クライアント作成時に一度クライアントレベルで設定できます（`Builder`の`serverSetting`メソッドを参照）。また、操作レベルでも設定できます（操作設定クラスの`serverSetting`を参照）。

    ```java showLineNumbers
     try (Client client = new Client.Builder().addEndpoint(Protocol.HTTP, "localhost", mockServer.port(), false)
            .setUsername("default")
            .setPassword(ClickHouseServerForTest.getPassword())
            .compressClientRequest(true)

            // Client level
            .serverSetting("max_threads", "10")
            .serverSetting("async_insert", "1")
            .serverSetting("roles", Arrays.asList("role1", "role2"))

            .build()) {

    	// Operation level
    	QuerySettings querySettings = new QuerySettings();
    	querySettings.serverSetting("session_timezone", "Europe/Zurich");

    	...
    }
    ```

    ⚠️ `setOption`メソッド(`Client.Builder`または操作設定クラス)でオプションを設定する場合、サーバー設定名には`clickhouse_setting_`のプレフィックスを付ける必要があります。この場合、`com.clickhouse.client.api.ClientConfigProperties#serverSetting()`を使用すると便利です。

    ### カスタムHTTPヘッダー \{#custom-http-header\}

    カスタムHTTPヘッダーは、すべての操作（クライアントレベル）に対して設定することも、単一の操作（操作レベル）に対して設定することもできます。

    ```java showLineNumbers

    QuerySettings settings = new QuerySettings()
        .httpHeader(HttpHeaders.REFERER, clientReferer)
        .setQueryId(qId);

    ```

    `setOption`メソッド(`Client.Builder`または操作設定クラスのいずれか)でオプションを設定する場合、カスタムヘッダー名には`http_header_`のプレフィックスを付ける必要があります。この場合、`com.clickhouse.client.api.ClientConfigProperties#httpHeader()`メソッドが役立ちます。

    ## 共通定義 \{#common-definitions\}

    ### ClickHouseFormat \{#clickhouseformat\}

    [サポートされている形式](/interfaces/formats)の列挙型。ClickHouseがサポートするすべての形式を含みます。

    * `raw` - ユーザーは生データをトランスコードする必要があります
    * `full` - クライアント側でデータをトランスコードでき、生のデータストリームを受け入れます
    * `-` - このフォーマットでは ClickHouse がサポートしない操作

    このクライアントバージョンは以下をサポートします:

    | フォーマット                                                                                                       |  入力  |  出力  |
    | ------------------------------------------------------------------------------------------------------------ | :--: | :--: |
    | [TabSeparated](/interfaces/formats/TabSeparated)                                                             |  raw |  raw |
    | [TabSeparatedRaw](/interfaces/formats/TabSeparatedRaw)                                                       |  raw |  raw |
    | [TabSeparatedWithNames](/interfaces/formats/TabSeparatedWithNames)                                           |  raw |  raw |
    | [TabSeparatedWithNamesAndTypes](/interfaces/formats/TabSeparatedWithNamesAndTypes)                           |  raw |  raw |
    | [TabSeparatedRawWithNames](/interfaces/formats/TabSeparatedRawWithNames)                                     |  raw |  raw |
    | [TabSeparatedRawWithNamesAndTypes](/interfaces/formats/TabSeparatedRawWithNamesAndTypes)                     |  raw |  raw |
    | [Template](/interfaces/formats/Template)                                                                     |  raw |  raw |
    | [TemplateIgnoreSpaces](/interfaces/formats/TemplateIgnoreSpaces)                                             |  raw |   *  |
    | [CSV](/interfaces/formats/CSV)                                                                               |  raw |  raw |
    | [CSVWithNames](/interfaces/formats/CSVWithNames)                                                             |  raw |  raw |
    | [CSVWithNamesAndTypes](/interfaces/formats/CSVWithNamesAndTypes)                                             |  raw |  raw |
    | [CustomSeparated](/interfaces/formats/CustomSeparated)                                                       |  raw |  raw |
    | [CustomSeparatedWithNames](/interfaces/formats/CustomSeparatedWithNames)                                     |  raw |  raw |
    | [CustomSeparatedWithNamesAndTypes](/interfaces/formats/CustomSeparatedWithNamesAndTypes)                     |  raw |  raw |
    | [SQLInsert](/interfaces/formats/SQLInsert)                                                                   |   -  |  raw |
    | [Values](/interfaces/formats/Values)                                                                         |  raw |  raw |
    | [Vertical](/interfaces/formats/Vertical)                                                                     |   *  |  raw |
    | [JSON](/interfaces/formats/JSON)                                                                             |  raw |  raw |
    | [JSONAsString](/interfaces/formats/JSONAsString)                                                             |  raw |   -  |
    | [JSONAsObject](/interfaces/formats/JSONAsObject)                                                             |  raw |   *  |
    | [JSONStrings](/interfaces/formats/JSONStrings)                                                               |  raw |  raw |
    | [JSONColumns](/interfaces/formats/JSONColumns)                                                               |  raw |  raw |
    | [JSONColumnsWithMetadata](/interfaces/formats/JSONColumnsWithMetadata)                                       |  raw |  未加工 |
    | [JSONCompact](/interfaces/formats/JSONCompact)                                                               |  raw |  raw |
    | [JSONCompactStrings](/interfaces/formats/JSONCompactStrings)                                                 |   -  |  raw |
    | [JSONCompactColumns](/interfaces/formats/JSONCompactColumns)                                                 |  raw |  raw |
    | [JSONEachRow](/interfaces/formats/JSONEachRow)                                                               |  raw |  raw |
    | [PrettyJSONEachRow](/interfaces/formats/PrettyJSONEachRow)                                                   |   *  |  raw |
    | [JSONEachRowWithProgress](/interfaces/formats/JSONEachRowWithProgress)                                       |   -  |  raw |
    | [JSONStringsEachRow](/interfaces/formats/JSONStringsEachRow)                                                 |  raw |  raw |
    | [JSONStringsEachRowWithProgress](/interfaces/formats/JSONStringsEachRowWithProgress)                         |   *  |  raw |
    | [JSONCompactEachRow](/interfaces/formats/JSONCompactEachRow)                                                 |  raw |  raw |
    | [JSONCompactEachRowWithNames](/interfaces/formats/JSONCompactEachRowWithNames)                               |  raw |  raw |
    | [JSONCompactEachRowWithNamesAndTypes](/interfaces/formats/JSONCompactEachRowWithNamesAndTypes)               |  raw |  raw |
    | [JSONCompactStringsEachRow](/interfaces/formats/JSONCompactStringsEachRow)                                   |  raw |  raw |
    | [JSONCompactStringsEachRowWithNames](/interfaces/formats/JSONCompactStringsEachRowWithNames)                 |  raw |  raw |
    | [JSONCompactStringsEachRowWithNamesAndTypes](/interfaces/formats/JSONCompactStringsEachRowWithNamesAndTypes) |  raw |  raw |
    | [JSONObjectEachRow](/interfaces/formats/JSONObjectEachRow)                                                   |  raw |  raw |
    | [BSONEachRow](/interfaces/formats/BSONEachRow)                                                               |  raw |  raw |
    | [TSKV](/interfaces/formats/TSKV)                                                                             |  raw |  raw |
    | [Pretty](/interfaces/formats/Pretty)                                                                         |   -  |  raw |
    | [PrettyNoEscapes](/interfaces/formats/PrettyNoEscapes)                                                       |   *  |  raw |
    | [PrettyMonoBlock](/interfaces/formats/PrettyMonoBlock)                                                       |   -  |  raw |
    | [PrettyNoEscapesMonoBlock](/interfaces/formats/PrettyNoEscapesMonoBlock)                                     |   *  |  raw |
    | [PrettyCompact](/interfaces/formats/PrettyCompact)                                                           |   -  |  raw |
    | [PrettyCompactNoEscapes](/interfaces/formats/PrettyCompactNoEscapes)                                         |   *  |  raw |
    | [PrettyCompactMonoBlock](/interfaces/formats/PrettyCompactMonoBlock)                                         |   -  |  raw |
    | [PrettyCompactNoEscapesMonoBlock](/interfaces/formats/PrettyCompactNoEscapesMonoBlock)                       |   *  |  raw |
    | [PrettySpace](/interfaces/formats/PrettySpace)                                                               |   -  |  raw |
    | [PrettySpaceNoEscapes](/interfaces/formats/PrettySpaceNoEscapes)                                             |   *  |  raw |
    | [PrettySpaceMonoBlock](/interfaces/formats/PrettySpaceMonoBlock)                                             |   -  |  raw |
    | [PrettySpaceNoEscapesMonoBlock](/interfaces/formats/PrettySpaceNoEscapesMonoBlock)                           |   *  |  raw |
    | [Prometheus](/interfaces/formats/Prometheus)                                                                 |   -  |  raw |
    | [Protobuf](/interfaces/formats/Protobuf)                                                                     |  raw |  raw |
    | [ProtobufSingle](/interfaces/formats/ProtobufSingle)                                                         |  raw |  raw |
    | [ProtobufList](/interfaces/formats/ProtobufList)                                                             |  raw |  raw |
    | [Avro](/interfaces/formats/Avro)                                                                             |  raw |  raw |
    | [AvroConfluent](/interfaces/formats/AvroConfluent)                                                           |  raw |   *  |
    | [Parquet](/interfaces/formats/Parquet)                                                                       |  raw |  raw |
    | [ParquetMetadata](/interfaces/formats/ParquetMetadata)                                                       |  raw |   -  |
    | [Arrow](/interfaces/formats/Arrow)                                                                           |  raw |  raw |
    | [ArrowStream](/interfaces/formats/ArrowStream)                                                               |  raw |  raw |
    | [ORC](/interfaces/formats/ORC)                                                                               |  raw |  raw |
    | [One](/interfaces/formats/One)                                                                               |  raw |   *  |
    | [Npy](/interfaces/formats/Npy)                                                                               |  raw | 生データ |
    | [RowBinary](/interfaces/formats/RowBinary)                                                                   | full | full |
    | [RowBinaryWithNames](/interfaces/formats/RowBinaryWithNamesAndTypes)                                         | full | full |
    | [RowBinaryWithNamesAndTypes](/interfaces/formats/RowBinaryWithNamesAndTypes)                                 |  フル  |  フル  |
    | [RowBinaryWithDefaults](/interfaces/formats/RowBinaryWithDefaults)                                           | full |   -  |
    | [Native](/interfaces/formats/Native)                                                                         | full | 生データ |
    | [Null](/interfaces/formats/Null)                                                                             |   *  |  raw |
    | [XML](/interfaces/formats/XML)                                                                               |   -  |  raw |
    | [CapnProto](/interfaces/formats/CapnProto)                                                                   |  raw | 生データ |
    | [LineAsString](/interfaces/formats/LineAsString)                                                             |  raw |  raw |
    | [Regexp](/interfaces/formats/Regexp)                                                                         |  raw |   *  |
    | [RawBLOB](/interfaces/formats/RawBLOB)                                                                       |  raw |  raw |
    | [MsgPack](/interfaces/formats/MsgPack)                                                                       |  raw |  raw |
    | [MySQLDump](/interfaces/formats/MySQLDump)                                                                   |  raw |   -  |
    | [DWARF](/interfaces/formats/DWARF)                                                                           |  raw |   *  |
    | [Markdown](/interfaces/formats/Markdown)                                                                     |   -  |  未加工 |
    | [Form](/interfaces/formats/Form)                                                                             |  raw |   *  |

    ## Insert API \{#insert-api\}

    ### insert(String tableName, InputStream data, ClickHouseFormat format) \{#insertstring-tablename-inputstream-data-clickhouseformat-format\}

    指定されたフォーマットのバイト列を`InputStream`として受け取ります。`data`は`format`でエンコードされている必要があります。

    **署名**

    ```java
    CompletableFuture<InsertResponse> insert(String tableName, InputStream data, ClickHouseFormat format, InsertSettings settings)
    CompletableFuture<InsertResponse> insert(String tableName, InputStream data, ClickHouseFormat format)
    ```

    **パラメータ**

    `tableName` - 対象テーブル名。

    `data` - エンコードされたデータの入力ストリーム。

    `format` - データのエンコード形式。

    `settings` - リクエストの設定。

    **戻り値**

    `InsertResponse` 型の Future - 操作結果とサーバー側メトリクスなどの追加情報。

    **例**

    ```java showLineNumbers
    try (InputStream dataStream = getDataStream()) {
        try (InsertResponse response = client.insert(TABLE_NAME, dataStream, ClickHouseFormat.JSONEachRow,
                insertSettings).get(3, TimeUnit.SECONDS)) {

            log.info("Insert finished: {} rows written", response.getMetrics().getMetric(ServerMetrics.NUM_ROWS_WRITTEN).getLong());
        } catch (Exception e) {
            log.error("Failed to write JSONEachRow data", e);
            throw new RuntimeException(e);
        }
    }

    ```

    ### insert(String tableName, List&lt;?&gt; data, InsertSettings settings) \{#insertstring-tablename-listlt-data-insertsettings-settings\}

    データベースに書き込みリクエストを送信します。オブジェクトのリストは効率的な形式に変換され、サーバーに送信されます。リストアイテムのクラスは、`register(Class, TableSchema)` メソッドを使用して事前に登録しておく必要があります。

    **署名**

    ```java
    client.insert(String tableName, List<?> data, InsertSettings settings)
    client.insert(String tableName, List<?> data)
    ```

    **パラメータ**

    `tableName` - 対象テーブルの名前。

    `data` - DTO（Data Transfer Object）オブジェクトのコレクション。

    `settings` - リクエストの設定。

    **戻り値**

    `InsertResponse` 型の Future - 操作結果とサーバー側メトリクスなどの追加情報。

    **例**

    ```java showLineNumbers
    // Important step (done once) - register class to pre-compile object serializer according to the table schema.
    client.register(ArticleViewEvent.class, client.getTableSchema(TABLE_NAME));

    List<ArticleViewEvent> events = loadBatch();

    try (InsertResponse response = client.insert(TABLE_NAME, events).get()) {
        // handle response, then it will be closed and connection that served request will be released.
    }
    ```

    ### InsertSettings \{#insertsettings\}

    挿入操作の構成オプション。

    **構成方法**

    | メソッド                                            | 説明                                                                              |
    | ----------------------------------------------- | ------------------------------------------------------------------------------- |
    | `setQueryId(String queryId)`                    | 操作に割り当てられるクエリ ID を設定します。デフォルト値: `null`。                                         |
    | `setDeduplicationToken(String token)`           | 重複排除用トークンを設定します。このトークンはサーバーに送信され、クエリを識別するために使用できます。デフォルト: `null`。               |
    | `setInputStreamCopyBufferSize(int size)`        | コピー用バッファのサイズ。書き込み処理中に、ユーザー提供の入力ストリームから出力ストリームへデータをコピーするために使用されます。デフォルト: `8196`。 |
    | `serverSetting(String name, String value)`      | 操作に対するサーバーの個別設定を指定します。                                                          |
    | `serverSetting(String name, Collection values)` | 操作に対して複数の値を取る個別のサーバー設定を指定します。コレクションの要素は `String` 型の値である必要があります。                 |
    | `setDBRoles(Collection dbRoles)`                | 操作の実行前に設定する DB ロールを指定します。コレクションの要素は `String` 値でなければなりません。                       |
    | `setOption(String option, Object value)`        | 生の値として構成オプションを設定します。これはサーバー側の設定ではありません。                                         |

    ### InsertResponse \{#insertresponse\}

    挿入操作の結果を保持するレスポンスオブジェクト。サーバーからレスポンスを受信した場合にのみ利用可能です。

    :::note
    このオブジェクトは接続を解放するため、できるだけ早くクローズする必要があります。前のレスポンスのすべてのデータが完全に読み取られるまで、接続を再利用できないためです。
    :::

    | メソッド                            | 説明                                                    |
    | ------------------------------- | ----------------------------------------------------- |
    | `OperationMetrics getMetrics()` | 操作メトリクスを保持するオブジェクトを返します。                              |
    | `String getQueryId()`           | アプリケーション（操作設定経由、またはサーバーによって）この操作に割り当てられたクエリ ID を返します。 |

    ## クエリAPI \{#query-api\}

    ### query(String sqlQuery) \{#querystring-sqlquery\}

    `sqlQuery`をそのまま送信します。レスポンス形式はクエリ設定によって設定されます。`QueryResponse`は、サポートされている形式のリーダーによって消費されるべきレスポンスストリームへの参照を保持します。

    **署名**

    ```java
    CompletableFuture<QueryResponse> query(String sqlQuery, QuerySettings settings)
    CompletableFuture<QueryResponse> query(String sqlQuery)
    ```

    **パラメータ**

    `sqlQuery` - 単一のSQLステートメント。クエリはそのままサーバーに送信されます。

    `settings` - リクエストの設定。

    **戻り値**

    `QueryResponse`型のFuture - 結果データセットとサーバー側メトリクスなどの追加情報を含みます。データセットの使用後は、Responseオブジェクトをクローズする必要があります。

    **例**

    ```java
    final String sql = "select * from " + TABLE_NAME + " where title <> '' limit 10";

    // Default format is RowBinaryWithNamesAndTypesFormatReader so reader have all information about columns
    try (QueryResponse response = client.query(sql).get(3, TimeUnit.SECONDS);) {

        // Create a reader to access the data in a convenient way
        ClickHouseBinaryFormatReader reader = client.newBinaryFormatReader(response);

        while (reader.hasNext()) {
            reader.next(); // Read the next record from stream and parse it

            // get values
            double id = reader.getDouble("id");
            String title = reader.getString("title");
            String url = reader.getString("url");

            // collecting data
        }
    } catch (Exception e) {
        log.error("Failed to read data", e);
    }

    // put business logic outside of the reading block to release http connection asap.
    ```

    ### query(String sqlQuery, Map&lt;String, Object&gt; queryParams, QuerySettings settings) \{#querystring-sqlquery-mapltstring-object-queryparams-querysettings-settings\}

    `sqlQuery`をそのまま送信します。加えて、サーバーがSQL式をコンパイルできるように、クエリパラメータも送信します。

    **署名**

    ```java
    CompletableFuture<QueryResponse> query(String sqlQuery, Map<String, Object> queryParams, QuerySettings settings)
    ```

    **パラメータ**

    `sqlQuery` - プレースホルダー `{}` を含むSQL式。

    `queryParams` - サーバー上でSQL式を完成させるための変数マップ。

    `settings` - リクエストの設定。

    **戻り値**

    `QueryResponse`型のFuture - 結果データセットとサーバー側メトリクスなどの追加情報を含みます。データセットの使用後は、Responseオブジェクトをクローズする必要があります。

    **例**

    ```java showLineNumbers

    // define parameters. They will be sent to the server along with the request.
    Map<String, Object> queryParams = new HashMap<>();
    queryParams.put("param1", 2);

    try (QueryResponse response =
            client.query("SELECT * FROM " + table + " WHERE col1 >= {param1:UInt32}", queryParams, new QuerySettings()).get()) {

        // Create a reader to access the data in a convenient way
        ClickHouseBinaryFormatReader reader = client.newBinaryFormatReader(response);

        while (reader.hasNext()) {
            reader.next(); // Read the next record from stream and parse it

            // reading data
        }

    } catch (Exception e) {
        log.error("Failed to read data", e);
    }

    ```

    ### queryAll(String sqlQuery) \{#queryallstring-sqlquery\}

    `RowBinaryWithNamesAndTypes`形式でデータをクエリします。結果はコレクションとして返されます。読み取りパフォーマンスはリーダーと同じですが、データセット全体を保持するためにより多くのメモリが必要になります。

    **署名**

    ```java
    List<GenericRecord> queryAll(String sqlQuery)
    ```

    **パラメータ**

    `sqlQuery` - サーバーからデータをクエリするためのSQL式。

    **戻り値**

    結果データに行単位でアクセスできる`GenericRecord`オブジェクトのリストで表現される完全なデータセット。

    **例**

    ```java showLineNumbers
    try {
        log.info("Reading whole table and process record by record");
        final String sql = "select * from " + TABLE_NAME + " where title <> ''";

        // Read whole result set and process it record by record
        client.queryAll(sql).forEach(row -> {
            double id = row.getDouble("id");
            String title = row.getString("title");
            String url = row.getString("url");

            log.info("id: {}, title: {}, url: {}", id, title, url);
        });
    } catch (Exception e) {
        log.error("Failed to read data", e);
    }
    ```

    ### QuerySettings \{#querysettings\}

    クエリ操作の設定オプション。

    **構成方法**

    | メソッド                                              | 説明                                                                                                                       |
    | ------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------ |
    | `setQueryId(String queryId)`                      | 操作に割り当てるクエリ ID を設定します。                                                                                                   |
    | `setFormat(ClickHouseFormat format)`              | レスポンス形式を設定します。利用可能な形式の完全な一覧については `RowBinaryWithNamesAndTypes` を参照してください。                                                 |
    | `setMaxExecutionTime(Integer maxExecutionTime)`   | サーバー側での操作の最大実行時間を設定します。読み取りタイムアウトには影響しません。                                                                               |
    | `waitEndOfQuery(Boolean waitEndOfQuery)`          | レスポンスを返す前にクエリの終了を待機するようサーバーに要求します。                                                                                       |
    | `setUseServerTimeZone(Boolean useServerTimeZone)` | サーバーのタイムゾーン（クライアント側の設定を参照）が、操作結果内の日付/時刻型のパースに使用されます。デフォルトは `false` です。                                                   |
    | `setUseTimeZone(String timeZone)`                 | サーバーに対して、時刻変換に `timeZone` を使用するよう要求します。[session&#95;timezone](/operations/settings/settings#session_timezone) を参照してください。 |
    | `serverSetting(String name, String value)`        | 操作ごとに個別のサーバー設定を行います。                                                                                                     |
    | `serverSetting(String name, Collection values)`   | 操作時に複数の値を持つ個々のサーバー設定を構成します。コレクションの各要素は `String` 値である必要があります。                                                             |
    | `setDBRoles(Collection dbRoles)`                  | 操作を実行する前に有効化する DB ロールを設定します。コレクションの要素は `String` 値である必要があります。                                                             |
    | `setOption(String option, Object value)`          | 生形式で構成オプションを設定します。これはサーバー設定ではありません。                                                                                      |

    ### QueryResponse \{#queryresponse\}

    クエリ実行結果を保持するレスポンスオブジェクト。クライアントがサーバーからレスポンスを受信した場合にのみ利用可能です。

    :::note
    このオブジェクトは接続を解放するため、できるだけ早くクローズする必要があります。前のレスポンスのすべてのデータが完全に読み取られるまで、接続を再利用できないためです。
    :::

    | メソッド                            | 説明                                                 |
    | ------------------------------- | -------------------------------------------------- |
    | `ClickHouseFormat getFormat()`  | レスポンスデータのエンコード形式を返します。                             |
    | `InputStream getInputStream()`  | 指定された形式の非圧縮データのバイトストリームを返します。                      |
    | `OperationMetrics getMetrics()` | 操作メトリクスを表すオブジェクトを返します。                             |
    | `String getQueryId()`           | アプリケーション（操作設定またはサーバー）によってこの操作に割り当てられたクエリ ID を返します。 |
    | `TimeZone getTimeZone()`        | レスポンス内の Date/DateTime 型を処理する際に使用するタイムゾーンを返します。     |

    ### 例 \{#examples\}

    * サンプルコードは[リポジトリ](https://github.com/ClickHouse/clickhouse-java/tree/main/examples/client-v2)にあります。
    * Spring サービスの[実装例](https://github.com/ClickHouse/clickhouse-java/tree/main/examples/demo-service)を参照してください

    ## 共通 API \{#common-api\}

    ### getTableSchema(String table) \{#gettableschemastring-table\}

    `table`のテーブルスキーマを取得します。

    **署名**

    ```java
    TableSchema getTableSchema(String table)
    TableSchema getTableSchema(String table, String database)
    ```

    **パラメータ**

    `table` - スキーマデータを取得するテーブル名。

    `database` - 対象テーブルが定義されているデータベース。

    **戻り値**

    テーブルカラムのリストを含む`TableSchema`オブジェクトを返します。

    ### getTableSchemaFromQuery(String sql) \{#gettableschemafromquerystring-sql\}

    SQL文からスキーマを取得します。

    **署名**

    ```java
    TableSchema getTableSchemaFromQuery(String sql)
    ```

    **パラメータ**

    `sql` - スキーマを返す&quot;SELECT&quot; SQLステートメント。

    **戻り値**

    `sql`式に一致するカラムを含む`TableSchema`オブジェクトを返します。

    ### TableSchema \{#tableschema\}

    ### register(Class&lt;?&gt; clazz, TableSchema schema) \{#registerclasslt-clazz-tableschema-schema\}

    Java クラスが `schema` を使用してデータの書き込み/読み取りを行うためのシリアライゼーションおよびデシリアライゼーション層をコンパイルします。このメソッドは、getter/setter のペアと対応するカラムに対してシリアライザーとデシリアライザーを作成します。
    カラムの一致は、メソッド名から名前を抽出することで検出されます。例えば、`getFirstName` は カラム `first_name` または `firstname` に対応します。

    **署名**

    ```java
    void register(Class<?> clazz, TableSchema schema)
    ```

    **パラメータ**

    `clazz` - データの読み書きに使用するPOJOを表すクラス。

    `schema` - POJOプロパティとのマッチングに使用するデータスキーマ。

    **例**

    ```java showLineNumbers
    client.register(ArticleViewEvent.class, client.getTableSchema(TABLE_NAME));
    ```

    ## 使用例 \{#usage-examples\}

    完全なサンプルコードは、リポジトリの `example` [フォルダ](https://github.com/ClickHouse/clickhouse-java/tree/main/examples)に格納されています:

    * [client-v2](https://github.com/ClickHouse/clickhouse-java/tree/main/examples/client-v2) - 主要なサンプル一式です。
    * [demo-service](https://github.com/ClickHouse/clickhouse-java/tree/main/examples/demo-service) - Spring Boot アプリケーションにおけるクライアント利用例。
    * [demo-kotlin-service](https://github.com/ClickHouse/clickhouse-java/tree/main/examples/demo-kotlin-service) - Ktor（Kotlin）アプリケーションにおけるクライアントの使用例です。

    ## 移行ガイド \{#migration_guide\}

    旧クライアント(V1)は`com.clickhouse.client.ClickHouseClient#builder`を開始点として使用していました。新クライアント(V2)は`com.clickhouse.client.api.Client.Builder`を使用した同様のパターンを採用しています。主な相違点は以下の通りです:

    * 実装を取得するために service loader は使用しません。`com.clickhouse.client.api.Client` は、将来的にあらゆる種類の実装を扱うためのファサードクラスです。
    * 構成情報のソースが少なくなりました。1つはビルダーに渡されるもので、もう1つは操作設定（`QuerySettings`、`InsertSettings`）です。以前のバージョンではノードごとの構成があり、場合によっては環境変数を読み込んでいました。

    ### 設定パラメータの一致 \{#migration_from_v1_config\}

    V1には、設定に関連する3つの列挙型クラスがあります:

    * `com.clickhouse.client.config.ClickHouseDefaults` - ほとんどのユースケースで設定されることを想定したパラメータです。例えば `USER` や `PASSWORD` などがあります。
    * `com.clickhouse.client.config.ClickHouseClientOption` - クライアント専用の設定パラメータで、`HEALTH_CHECK_INTERVAL` などがあります。
    * `com.clickhouse.client.http.config.ClickHouseHttpOption` - HTTP インターフェイスに固有の設定パラメータ（例：`RECEIVE_QUERY_PROGRESS`）。

    これらはパラメータをグループ化し、明確に分離するように設計されていました。しかし、場合によっては混乱を招くことがありました(`com.clickhouse.client.config.ClickHouseDefaults#ASYNC`と`com.clickhouse.client.config.ClickHouseClientOption#ASYNC`の間に違いはあるのか)。 新しいV2クライアントは、すべてのクライアント設定オプションを格納する単一のDictionaryとして`com.clickhouse.client.api.Client.Builder`を使用します。すべての設定パラメータ名がリストされている`com.clickhouse.client.api.ClientConfigProperties`が存在します。

    以下の表は、新しいクライアントでサポートされている旧オプションと、その新しい意味を示しています。

    **凡例:** ✔ = サポート、✗ = 非サポート

    <Tabs groupId="v1-migration">
      <TabItem value="connection-auth" label="接続と認証">
        | V1 設定値                                                                           | V2 Builder メソッド                             | コメント               |
        | -------------------------------------------------------------------------------- | ------------------------------------------- | ------------------ |
        | `ClickHouseDefaults#HOST`                                                        | `Client.Builder#addEndpoint`                |                    |
        | `ClickHouseDefaults#PROTOCOL`                                                    | ✗                                           | V2 では HTTP のみをサポート |
        | `ClickHouseDefaults#DATABASE`<br />`ClickHouseClientOption#DATABASE`             | `Client.Builder#setDefaultDatabase`         |                    |
        | `ClickHouseDefaults#USER`                                                        | `Client.Builder#setUsername`                |                    |
        | `ClickHouseDefaults#PASSWORD`                                                    | `Client.Builder#setPassword`                |                    |
        | `ClickHouseClientOption#CONNECTION_TIMEOUT`                                      | `Client.Builder#setConnectTimeout`          |                    |
        | `ClickHouseClientOption#CONNECTION_TTL`                                          | `Client.Builder#setConnectionTTL`           |                    |
        | `ClickHouseHttpOption#MAX_OPEN_CONNECTIONS`                                      | `Client.Builder#setMaxConnections`          |                    |
        | `ClickHouseHttpOption#KEEP_ALIVE`<br />`ClickHouseHttpOption#KEEP_ALIVE_TIMEOUT` | `Client.Builder#setKeepAliveTimeout`        |                    |
        | `ClickHouseHttpOption#CONNECTION_REUSE_STRATEGY`                                 | `Client.Builder#setConnectionReuseStrategy` |                    |
        | `ClickHouseHttpOption#USE_BASIC_AUTHENTICATION`                                  | `Client.Builder#useHTTPBasicAuth`           |                    |
      </TabItem>

      <TabItem value="SSL" label="SSL とセキュリティ">
        | V1 Configuration                                       | V2 Builder Method                         | コメント                                          |
        | ------------------------------------------------------ | ----------------------------------------- | --------------------------------------------- |
        | `ClickHouseDefaults#SSL_CERTIFICATE_TYPE`              | ✗                                         |                                               |
        | `ClickHouseDefaults#SSL_KEY_ALGORITHM`                 | ✗                                         |                                               |
        | `ClickHouseDefaults#SSL_PROTOCOL`                      | ✗                                         |                                               |
        | `ClickHouseClientOption#SSL`                           | ✗                                         | `Client.Builder#addEndpoint` を参照              |
        | `ClickHouseClientOption#SSL_MODE`                      | ✗                                         |                                               |
        | `ClickHouseClientOption#SSL_ROOT_CERTIFICATE`          | `Client.Builder#setRootCertificate`       | `useSSLAuthentication` で SSL 認証を有効にします        |
        | `ClickHouseClientOption#SSL_CERTIFICATE`               | `Client.Builder#setClientCertificate`     |                                               |
        | `ClickHouseClientOption#SSL_KEY`                       | `Client.Builder#setClientKey`             |                                               |
        | `ClickHouseClientOption#KEY_STORE_TYPE`                | `Client.Builder#setSSLTrustStoreType`     |                                               |
        | `ClickHouseClientOption#TRUST_STORE`                   | `Client.Builder#setSSLTrustStore`         |                                               |
        | `ClickHouseClientOption#KEY_STORE_PASSWORD`            | `Client.Builder#setSSLTrustStorePassword` |                                               |
        | `ClickHouseClientOption#SSL_SOCKET_SNI`                | `Client.Builder#sslSocketSNI`             |                                               |
        | `ClickHouseClientOption#CUSTOM_SOCKET_FACTORY`         | ✗                                         |                                               |
        | `ClickHouseClientOption#CUSTOM_SOCKET_FACTORY_OPTIONS` | ✗                                         | SNI を設定するには `Client.Builder#sslSocketSNI` を参照 |
      </TabItem>

      <TabItem value="ソケット" label="ソケットオプション">
        | V1 設定                                       | V2 Builder メソッド                        | コメント |
        | ------------------------------------------- | -------------------------------------- | ---- |
        | `ClickHouseClientOption#SOCKET_TIMEOUT`     | `Client.Builder#setSocketTimeout`      |      |
        | `ClickHouseClientOption#SOCKET_REUSEADDR`   | `Client.Builder#setSocketReuseAddress` |      |
        | `ClickHouseClientOption#SOCKET_KEEPALIVE`   | `Client.Builder#setSocketKeepAlive`    |      |
        | `ClickHouseClientOption#SOCKET_LINGER`      | `Client.Builder#setSocketLinger`       |      |
        | `ClickHouseClientOption#SOCKET_IP_TOS`      | ✗                                      |      |
        | `ClickHouseClientOption#SOCKET_TCP_NODELAY` | `Client.Builder#setSocketTcpNodelay`   |      |
        | `ClickHouseClientOption#SOCKET_RCVBUF`      | `Client.Builder#setSocketRcvbuf`       |      |
        | `ClickHouseClientOption#SOCKET_SNDBUF`      | `Client.Builder#setSocketSndbuf`       |      |
      </TabItem>

      <TabItem value="圧縮" label="圧縮">
        | V1 設定項目                                       | V2 Builder メソッド                         | コメント                                               |
        | --------------------------------------------- | --------------------------------------- | -------------------------------------------------- |
        | `ClickHouseClientOption#COMPRESS`             | `Client.Builder#compressServerResponse` | `useHttpCompression` も参照                           |
        | `ClickHouseClientOption#DECOMPRESS`           | `Client.Builder#compressClientRequest`  | `useHttpCompression` も参照                           |
        | `ClickHouseClientOption#COMPRESS_ALGORITHM`   | ✗                                       | 非 HTTP では `LZ4` を使用。HTTP では `Accept-Encoding` を使用  |
        | `ClickHouseClientOption#DECOMPRESS_ALGORITHM` | ✗                                       | 非 HTTP では `LZ4` を使用。HTTP では `Content-Encoding` を使用 |
        | `ClickHouseClientOption#COMPRESS_LEVEL`       | ✗                                       |                                                    |
        | `ClickHouseClientOption#DECOMPRESS_LEVEL`     | ✗                                       |                                                    |
      </TabItem>

      <TabItem value="プロキシ" label="プロキシ">
        | V1 設定                                   | V2 ビルダーメソッド                          | コメント |
        | --------------------------------------- | ------------------------------------ | ---- |
        | `ClickHouseClientOption#PROXY_TYPE`     | `Client.Builder#addProxy`            |      |
        | `ClickHouseClientOption#PROXY_HOST`     | `Client.Builder#addProxy`            |      |
        | `ClickHouseClientOption#PROXY_PORT`     | `Client.Builder#addProxy`            |      |
        | `ClickHouseClientOption#PROXY_USERNAME` | `Client.Builder#setProxyCredentials` |      |
        | `ClickHouseClientOption#PROXY_PASSWORD` | `Client.Builder#setProxyCredentials` |      |
      </TabItem>

      <TabItem value="タイムアウトと再試行" label="タイムアウトとリトライ">
        | V1 の設定                                          | V2 ビルダー・メソッド                         | コメント                  |
        | ----------------------------------------------- | ------------------------------------ | --------------------- |
        | `ClickHouseClientOption#MAX_EXECUTION_TIME`     | `Client.Builder#setExecutionTimeout` |                       |
        | `ClickHouseClientOption#RETRY`                  | `Client.Builder#setMaxRetries`       | `retryOnFailures` も参照 |
        | `ClickHouseHttpOption#AHC_RETRY_ON_FAILURE`     | `Client.Builder#retryOnFailures`     |                       |
        | `ClickHouseClientOption#FAILOVER`               | ✗                                    |                       |
        | `ClickHouseClientOption#REPEAT_ON_SESSION_LOCK` | ✗                                    |                       |
        | `ClickHouseClientOption#SESSION_ID`             | ✗                                    |                       |
        | `ClickHouseClientOption#SESSION_CHECK`          | ✗                                    |                       |
        | `ClickHouseClientOption#SESSION_TIMEOUT`        | ✗                                    |                       |
      </TabItem>

      <TabItem value="タイムゾーン" label="タイムゾーン">
        | V1 設定                                                                                | V2 Builder メソッド                    | コメント |
        | ------------------------------------------------------------------------------------ | ---------------------------------- | ---- |
        | `ClickHouseDefaults#SERVER_TIME_ZONE`<br />`ClickHouseClientOption#SERVER_TIME_ZONE` | `Client.Builder#setServerTimeZone` |      |
        | `ClickHouseClientOption#USE_SERVER_TIME_ZONE`                                        | `Client.Builder#useServerTimeZone` |      |
        | `ClickHouseClientOption#USE_SERVER_TIME_ZONE_FOR_DATES`                              |                                    |      |
        | `ClickHouseClientOption#USE_TIME_ZONE`                                               | `Client.Builder#useTimeZone`       |      |
      </TabItem>

      <TabItem value="バッファ" label="バッファとパフォーマンス">
        | V1 Configuration                                | V2 Builder Method                           | コメント |
        | ----------------------------------------------- | ------------------------------------------- | ---- |
        | `ClickHouseClientOption#BUFFER_SIZE`            | `Client.Builder#setClientNetworkBufferSize` |      |
        | `ClickHouseClientOption#BUFFER_QUEUE_VARIATION` | ✗                                           |      |
        | `ClickHouseClientOption#READ_BUFFER_SIZE`       | ✗                                           |      |
        | `ClickHouseClientOption#WRITE_BUFFER_SIZE`      | ✗                                           |      |
        | `ClickHouseClientOption#REQUEST_CHUNK_SIZE`     | ✗                                           |      |
        | `ClickHouseClientOption#REQUEST_BUFFERING`      | ✗                                           |      |
        | `ClickHouseClientOption#RESPONSE_BUFFERING`     | ✗                                           |      |
        | `ClickHouseClientOption#MAX_BUFFER_SIZE`        | ✗                                           |      |
        | `ClickHouseClientOption#MAX_QUEUED_BUFFERS`     | ✗                                           |      |
        | `ClickHouseClientOption#MAX_QUEUED_REQUESTS`    | ✗                                           |      |
        | `ClickHouseClientOption#REUSE_VALUE_WRAPPER`    | ✗                                           |      |
      </TabItem>

      <TabItem value="スレッド処理" label="スレッドと非同期処理">
        | V1 設定                                                          | V2 Builder メソッド                   | コメント                             |
        | -------------------------------------------------------------- | --------------------------------- | -------------------------------- |
        | `ClickHouseDefaults#ASYNC`<br />`ClickHouseClientOption#ASYNC` | `Client.Builder#useAsyncRequests` |                                  |
        | `ClickHouseDefaults#MAX_SCHEDULER_THREADS`                     | ✗                                 | `setSharedOperationExecutor` を参照 |
        | `ClickHouseDefaults#MAX_THREADS`                               | ✗                                 | `setSharedOperationExecutor` を参照 |
        | `ClickHouseDefaults#THREAD_KEEPALIVE_TIMEOUT`                  | `setSharedOperationExecutor` を参照  |                                  |
        | `ClickHouseClientOption#MAX_THREADS_PER_CLIENT`                | ✗                                 |                                  |
        | `ClickHouseClientOption#MAX_CORE_THREAD_TTL`                   | ✗                                 |                                  |
      </TabItem>

      <TabItem value="HTTP ヘッダー" label="HTTP とヘッダー">
        | V1 の設定                                               | V2 Builder メソッド                | コメント                               |
        | ---------------------------------------------------- | ------------------------------ | ---------------------------------- |
        | `ClickHouseHttpOption#CUSTOM_HEADERS`                | `Client.Builder#httpHeaders`   |                                    |
        | `ClickHouseHttpOption#CUSTOM_PARAMS`                 | ✗                              | `Client.Builder#serverSetting` を参照 |
        | `ClickHouseClientOption#CLIENT_NAME`                 | `Client.Builder#setClientName` |                                    |
        | `ClickHouseHttpOption#CONNECTION_PROVIDER`           | ✗                              |                                    |
        | `ClickHouseHttpOption#DEFAULT_RESPONSE`              | ✗                              |                                    |
        | `ClickHouseHttpOption#SEND_HTTP_CLIENT_ID`           | ✗                              |                                    |
        | `ClickHouseHttpOption#AHC_VALIDATE_AFTER_INACTIVITY` | ✗                              | Apache HTTP Client 使用時は常に有効        |
      </TabItem>

      <TabItem value="format-query" label="フォーマット & クエリ">
        | V1 設定                                                            | V2 ビルダーメソッド         | コメント                                                                      |
        | ---------------------------------------------------------------- | ------------------- | ------------------------------------------------------------------------- |
        | `ClickHouseDefaults#FORMAT`<br />`ClickHouseClientOption#FORMAT` | ✗                   | 操作設定（`QuerySettings` および `InsertSettings`）に移動                             |
        | `ClickHouseClientOption#QUERY_ID`                                | ✗                   | `QuerySettings` および `InsertSettings` を参照                                  |
        | `ClickHouseClientOption#LOG_LEADING_COMMENT`                     | ✗                   | `QuerySettings#logComment` および `InsertSettings#logComment` を参照            |
        | `ClickHouseClientOption#MAX_RESULT_ROWS`                         | ✗                   | サーバー側の設定                                                                  |
        | `ClickHouseClientOption#RESULT_OVERFLOW_MODE`                    | ✗                   | サーバー側の設定                                                                  |
        | `ClickHouseHttpOption#RECEIVE_QUERY_PROGRESS`                    | ✗                   | サーバー側の設定                                                                  |
        | `ClickHouseHttpOption#WAIT_END_OF_QUERY`                         | ✗                   | サーバー側の設定                                                                  |
        | `ClickHouseHttpOption#REMEMBER_LAST_SET_ROLES`                   | `Client#setDBRoles` | 現在はランタイム設定。`QuerySettings#setDBRoles` および `InsertSettings#setDBRoles` も参照 |
      </TabItem>

      <TabItem value="ノードディスカバリ" label="ノードディスカバリと負荷分散">
        | V1 設定                                            | V2 ビルダー メソッド | コメント |
        | ------------------------------------------------ | ------------ | ---- |
        | `ClickHouseClientOption#AUTO_DISCOVERY`          | ✗            |      |
        | `ClickHouseClientOption#LOAD_BALANCING_POLICY`   | ✗            |      |
        | `ClickHouseClientOption#LOAD_BALANCING_TAGS`     | ✗            |      |
        | `ClickHouseClientOption#HEALTH_CHECK_INTERVAL`   | ✗            |      |
        | `ClickHouseClientOption#HEALTH_CHECK_METHOD`     | ✗            |      |
        | `ClickHouseClientOption#NODE_DISCOVERY_INTERVAL` | ✗            |      |
        | `ClickHouseClientOption#NODE_DISCOVERY_LIMIT`    | ✗            |      |
        | `ClickHouseClientOption#NODE_CHECK_INTERVAL`     | ✗            |      |
        | `ClickHouseClientOption#NODE_GROUP_SIZE`         | ✗            |      |
        | `ClickHouseClientOption#CHECK_ALL_NODES`         | ✗            |      |
      </TabItem>

      <TabItem value="その他" label="その他">
        | V1 構成                                                                            | V2 Builder メソッド                   | コメント            |
        | -------------------------------------------------------------------------------- | --------------------------------- | --------------- |
        | `ClickHouseDefaults#AUTO_SESSION`                                                | ✗                                 | セッション対応は見直し予定です |
        | `ClickHouseDefaults#BUFFERING`                                                   | ✗                                 |                 |
        | `ClickHouseDefaults#MAX_REQUESTS`                                                | ✗                                 |                 |
        | `ClickHouseDefaults#ROUNDING_MODE`                                               |                                   |                 |
        | `ClickHouseDefaults#SERVER_VERSION`<br />`ClickHouseClientOption#SERVER_VERSION` | `Client.Builder#setServerVersion` |                 |
        | `ClickHouseDefaults#SRV_RESOLVE`                                                 | ✗                                 |                 |
        | `ClickHouseClientOption#CUSTOM_SETTINGS`                                         |                                   |                 |
        | `ClickHouseClientOption#PRODUCT_NAME`                                            | ✗                                 | クライアント名を使用      |
        | `ClickHouseClientOption#RENAME_RESPONSE_COLUMN`                                  | ✗                                 |                 |
        | `ClickHouseClientOption#SERVER_REVISION`                                         | ✗                                 |                 |
        | `ClickHouseClientOption#TRANSACTION_TIMEOUT`                                     | ✗                                 |                 |
        | `ClickHouseClientOption#WIDEN_UNSIGNED_TYPES`                                    | ✗                                 |                 |
        | `ClickHouseClientOption#USE_BINARY_STRING`                                       | ✗                                 |                 |
        | `ClickHouseClientOption#USE_BLOCKING_QUEUE`                                      | ✗                                 |                 |
        | `ClickHouseClientOption#USE_COMPILATION`                                         | ✗                                 |                 |
        | `ClickHouseClientOption#USE_OBJECTS_IN_ARRAYS`                                   | ✗                                 |                 |
        | `ClickHouseClientOption#MAX_MAPPER_CACHE`                                        | ✗                                 |                 |
        | `ClickHouseClientOption#MEASURE_REQUEST_TIME`                                    | ✗                                 |                 |
      </TabItem>
    </Tabs>

    ### 一般的な違い \{#general-differences\}

    * Client V2 は移植性を高めるために、プロプライエタリなクラスへの依存を減らしています。たとえば、V2 はサーバーにデータを書き込む際に、任意の `java.io.InputStream` の実装と連携して動作します。
    * Client V2 の `async` 設定はデフォルトで `off` です。これは追加のスレッドを起動せず、アプリケーションからクライアントをより細かく制御できることを意味します。この設定は、ほとんどのユースケースでは `off` のままにしておくことを推奨します。`async` を有効にすると、リクエストごとに専用のスレッドが作成されます。これは、アプリケーション側で制御される executor を使用する場合にのみ有用です（`com.clickhouse.client.api.Client.Builder#setSharedOperationExecutor` を参照）。

    ### データの書き込み \{#writing-data\}

    * 任意の実装の `java.io.InputStream` を使用できます。V1 の `com.clickhouse.data.ClickHouseInputStream` もサポートされていますが、非推奨です。
    * 入力ストリームの終端が検出されると、適切に処理されます。その前に、リクエストの出力ストリームをクローズしておく必要があります。

    **V1 TSV形式データの挿入。**

    ```java
    InputStream inData = getInData();
    ClickHouseRequest.Mutation request = client.read(server)
            .write()
            .table(tableName)
            .format(ClickHouseFormat.TSV);
    ClickHouseConfig config = request.getConfig();
    CompletableFuture<ClickHouseResponse> future;
    try (ClickHousePipedOutputStream requestBody = ClickHouseDataStreamFactory.getInstance()
            .createPipedOutputStream(config)) {
        // start the worker thread which transfer data from the input into ClickHouse
        future = request.data(requestBody.getInputStream()).execute();

        // Copy data from inData stream to requestBody stream

        // We need to close the stream before getting a response
        requestBody.close();

        try (ClickHouseResponse response = future.get()) {
            ClickHouseResponseSummary summary = response.getSummary();
            Assert.assertEquals(summary.getWrittenRows(), numRows, "Num of written rows");
        }
    }

    ```

    **V2 TSV形式データの挿入。**

    ```java
    InputStream inData = getInData();
    InsertSettings settings = new InsertSettings().setInputStreamCopyBufferSize(8198 * 2); // set copy buffer size
    try (InsertResponse response = client.insert(tableName, inData, ClickHouseFormat.TSV, settings).get(30, TimeUnit.SECONDS)) {

      // Insert is complete at this point

    } catch (Exception e) {
     // Handle exception
    }
    ```

    * 呼び出すメソッドは 1 つだけで、追加のリクエストオブジェクトを作成する必要はありません。
    * すべてのデータのコピーが完了すると、リクエストボディのストリームは自動的にクローズされます。
    * 新しい低レベル API `com.clickhouse.client.api.Client#insert(java.lang.String, java.util.List<java.lang.String>, com.clickhouse.client.api.DataStreamWriter, com.clickhouse.data.ClickHouseFormat, com.clickhouse.client.api.insert.InsertSettings)` が利用可能です。`com.clickhouse.client.api.DataStreamWriter` は独自のデータ書き込みロジックを実装できるように設計されています。たとえば、キューからデータを読み取るといった用途に利用できます。

    ### データの読み取り \{#reading-data\}

    * データは既定で `RowBinaryWithNamesAndTypes` フォーマットで読み込まれます。現在、データバインディングが必要な場合にサポートされているのはこのフォーマットのみです。
    * データは、`List<GenericRecord> com.clickhouse.client.api.Client#queryAll(java.lang.String)` メソッドを使用して、レコードのコレクションとして読み取ることができます。このメソッドはデータをメモリ上に読み込み、接続を解放します。追加の処理は不要です。`GenericRecord` はデータへのアクセスを提供し、一部の変換処理を実装しています。

    ```java
    Collection<GenericRecord> records = client.queryAll("SELECT * FROM table");
    for (GenericRecord record : records) {
        int rowId = record.getInteger("rowID");
        String name = record.getString("name");
        LocalDateTime ts = record.getLocalDateTime("ts");
    }

    ```
  </Version>

  <Version>
    DBサーバーとそのプロトコルを通じて通信するためのJavaクライアントライブラリ。現在の実装では[HTTPインターフェース](/interfaces/http)のみをサポートしています。このライブラリは、サーバーへのリクエスト送信用の独自APIを提供します。

    :::warning 非推奨
    このライブラリは間もなく非推奨になります。新規プロジェクトには最新の[Java クライアント](/integrations/language-clients/java/client/client.mdx)を使用してください
    :::

    ## セットアップ \{#v1-setup\}

    <Tabs groupId="client-v1-setup">
      <TabItem value="maven" label="Maven">
        ```xml
        <!-- https://mvnrepository.com/artifact/com.clickhouse/clickhouse-http-client -->
        <dependency>
            <groupId>com.clickhouse</groupId>
            <artifactId>clickhouse-http-client</artifactId>
            <version>0.7.2</version>
        </dependency>
        ```
      </TabItem>

      <TabItem value="gradle-kt" label="Gradle (Kotlin)">
        ```kotlin
        // https://mvnrepository.com/artifact/com.clickhouse/clickhouse-http-client
        implementation("com.clickhouse:clickhouse-http-client:0.7.2")
        ```
      </TabItem>

      <TabItem value="gradle" label="Gradle">
        ```groovy
        // https://mvnrepository.com/artifact/com.clickhouse/clickhouse-http-client
        implementation 'com.clickhouse:clickhouse-http-client:0.7.2'
        ```
      </TabItem>
    </Tabs>

    バージョン `0.5.0` 以降、ドライバは新しいクライアント HTTP ライブラリを使用するため、依存関係として追加する必要があります。

    <Tabs groupId="client-v1-http-client">
      <TabItem value="maven" label="Maven">
        ```xml
        <!-- https://mvnrepository.com/artifact/org.apache.httpcomponents.client5/httpclient5 -->
        <dependency>
            <groupId>org.apache.httpcomponents.client5</groupId>
            <artifactId>httpclient5</artifactId>
            <version>5.3.1</version>
        </dependency>
        ```
      </TabItem>

      <TabItem value="gradle-kt" label="Gradle (Kotlin)">
        ```kotlin
        // https://mvnrepository.com/artifact/org.apache.httpcomponents.client5/httpclient5
        implementation("org.apache.httpcomponents.client5:httpclient5:5.3.1")
        ```
      </TabItem>

      <TabItem value="gradle" label="Gradle">
        ```groovy
        // https://mvnrepository.com/artifact/org.apache.httpcomponents.client5/httpclient5
        implementation 'org.apache.httpcomponents.client5:httpclient5:5.3.1'
        ```
      </TabItem>
    </Tabs>

    ## 初期化 \{#v1-initialization\}

    接続URL形式: `protocol://host[:port][/database][?param[=value][&param[=value]][#tag[,tag]]`、例:

    * `http://localhost:8443?ssl=true&sslmode=NONE`
    * `https://(https://explorer@play.clickhouse.com:443`

    単一ノードに接続する:

    ```java showLineNumbers
    ClickHouseNode server = ClickHouseNode.of("http://localhost:8123/default?compress=0");
    ```

    複数ノードのクラスタに接続する:

    ```java showLineNumbers
    ClickHouseNodes servers = ClickHouseNodes.of(
        "jdbc:ch:http://server1.domain,server2.domain,server3.domain/my_db"
        + "?load_balancing_policy=random&health_check_interval=5000&failover=2");
    ```

    ## クエリAPI \{#v1-query-api\}

    ```java showLineNumbers
    try (ClickHouseClient client = ClickHouseClient.newInstance(ClickHouseProtocol.HTTP);
         ClickHouseResponse response = client.read(servers)
            .format(ClickHouseFormat.RowBinaryWithNamesAndTypes)
            .query("select * from numbers limit :limit")
            .params(1000)
            .executeAndWait()) {
                ClickHouseResponseSummary summary = response.getSummary();
                long totalRows = summary.getTotalRowsToRead();
    }
    ```

    ## ストリーミングクエリAPI \{#v1-streaming-query-api\}

    ```java showLineNumbers
    try (ClickHouseClient client = ClickHouseClient.newInstance(ClickHouseProtocol.HTTP);
         ClickHouseResponse response = client.read(servers)
            .format(ClickHouseFormat.RowBinaryWithNamesAndTypes)
            .query("select * from numbers limit :limit")
            .params(1000)
            .executeAndWait()) {
                for (ClickHouseRecord r : response.records()) {
                int num = r.getValue(0).asInteger();
                // type conversion
                String str = r.getValue(0).asString();
                LocalDate date = r.getValue(0).asDate();
            }
    }
    ```

    [リポジトリ](https://github.com/ClickHouse/clickhouse-java/tree/main/examples/client)内の[完全なコード例](https://github.com/ClickHouse/clickhouse-java/blob/main/examples/client/src/main/java/com/clickhouse/examples/jdbc/Main.java#L73)を参照してください。

    ## Insert API \{#v1-insert-api\}

    ```java showLineNumbers

    try (ClickHouseClient client = ClickHouseClient.newInstance(ClickHouseProtocol.HTTP);
         ClickHouseResponse response = client.read(servers).write()
            .format(ClickHouseFormat.RowBinaryWithNamesAndTypes)
            .query("insert into my_table select c2, c3 from input('c1 UInt8, c2 String, c3 Int32')")
            .data(myInputStream) // `myInputStream` is source of data in RowBinary format
            .executeAndWait()) {
                ClickHouseResponseSummary summary = response.getSummary();
                summary.getWrittenRows();
    }
    ```

    [リポジトリ](https://github.com/ClickHouse/clickhouse-java/tree/main/examples/client)内の[完全なコード例](https://github.com/ClickHouse/clickhouse-java/blob/main/examples/client/src/main/java/com/clickhouse/examples/jdbc/Main.java#L39)を参照してください。

    **RowBinaryエンコーディング**

    RowBinary形式の詳細は、[こちらのページ](/interfaces/formats/RowBinaryWithNamesAndTypes)を参照してください。

    [コード](https://github.com/ClickHouse/clickhouse-kafka-connect/blob/main/src/main/java/com/clickhouse/kafka/connect/sink/db/ClickHouseWriter.java#L622)の例を参照してください。

    ## 機能 \{#v1-features\}

    ### 圧縮 \{#v1-compression\}

    クライアントはデフォルトでLZ4圧縮を使用します。これには以下の依存関係が必要です:

    <Tabs groupId="client-v1-compression-deps">
      <TabItem value="maven" label="Maven">
        ```xml
        <!-- https://mvnrepository.com/artifact/org.lz4/lz4-java -->
        <dependency>
            <groupId>org.lz4</groupId>
            <artifactId>lz4-java</artifactId>
            <version>1.8.0</version>
        </dependency>
        ```
      </TabItem>

      <TabItem value="gradle-kt" label="Gradle (Kotlin)">
        ```kotlin
        // https://mvnrepository.com/artifact/org.lz4/lz4-java
        implementation("org.lz4:lz4-java:1.8.0")
        ```
      </TabItem>

      <TabItem value="gradle" label="Gradle">
        ```groovy
        // https://mvnrepository.com/artifact/org.lz4/lz4-java
        implementation 'org.lz4:lz4-java:1.8.0'
        ```
      </TabItem>
    </Tabs>

    接続URLに`compress_algorithm=gzip`を設定することで、代わりにgzipを使用できます。

    あるいは、圧縮を無効化する方法がいくつかあります。

    1. 接続URLで `compress=0` を設定して無効化します: `http://localhost:8123/default?compress=0`
    2. クライアント設定で無効化する：

    ```java showLineNumbers
    ClickHouseClient client = ClickHouseClient.builder()
       .config(new ClickHouseConfig(Map.of(ClickHouseClientOption.COMPRESS, false)))
       .nodeSelector(ClickHouseNodeSelector.of(ClickHouseProtocol.HTTP))
       .build();
    ```

    各種圧縮オプションの詳細については、[圧縮ドキュメント](/data-compression/compression-modes)を参照してください。

    ### 複数のクエリ \{#v1-multiple-queries\}

    同一セッション内でワーカースレッドにて複数のクエリを順次実行する:

    ```java showLineNumbers
    CompletableFuture<List<ClickHouseResponseSummary>> future = ClickHouseClient.send(servers.apply(servers.getNodeSelector()),
        "create database if not exists my_base",
        "use my_base",
        "create table if not exists test_table(s String) engine=Memory",
        "insert into test_table values('1')('2')('3')",
        "select * from test_table limit 1",
        "truncate table test_table",
        "drop table if exists test_table");
    List<ClickHouseResponseSummary> results = future.get();
    ```

    ### 名前付きパラメータ \{#v1-named-parameters\}

    パラメータリスト内の位置に依存せず、名前でパラメータを渡すことができます。この機能は `params` 関数を使用して利用可能です。

    ```java showLineNumbers
    try (ClickHouseClient client = ClickHouseClient.newInstance(ClickHouseProtocol.HTTP);
         ClickHouseResponse response = client.read(servers)
            .format(ClickHouseFormat.RowBinaryWithNamesAndTypes)
            .query("select * from my_table where name=:name limit :limit")
            .params("Ben", 1000)
            .executeAndWait()) {
                //...
            }
    }
    ```

    :::note パラメータ
    `String`型を含むすべての`params`シグネチャ(`String`、`String[]`、`Map<String, String>`)は、渡されるキーが有効なClickHouse SQL文字列であることを前提としています。例えば:

    ```java showLineNumbers
    try (ClickHouseClient client = ClickHouseClient.newInstance(ClickHouseProtocol.HTTP);
         ClickHouseResponse response = client.read(servers)
            .format(ClickHouseFormat.RowBinaryWithNamesAndTypes)
            .query("select * from my_table where name=:name")
            .params(Map.of("name","'Ben'"))
            .executeAndWait()) {
                //...
            }
    }
    ```

    String オブジェクトを手動で ClickHouse SQL に解析したくない場合は、`com.clickhouse.data` に配置されているヘルパー関数 `ClickHouseValues.convertToSqlExpression` を使用できます:

    ```java showLineNumbers
    try (ClickHouseClient client = ClickHouseClient.newInstance(ClickHouseProtocol.HTTP);
         ClickHouseResponse response = client.read(servers)
            .format(ClickHouseFormat.RowBinaryWithNamesAndTypes)
            .query("select * from my_table where name=:name")
            .params(Map.of("name", ClickHouseValues.convertToSqlExpression("Ben's")))
            .executeAndWait()) {
                //...
            }
    }
    ```

    上記の例では、`ClickHouseValues.convertToSqlExpression`が内部のシングルクォートをエスケープし、変数を有効なシングルクォートで囲みます。

    `Integer`、`UUID`、`Array`、`Enum` などのその他の型は、`params` 内で自動的に変換されます。
    :::

    ## ノードディスカバリー \{#v1-node-discovery\}

    JavaクライアントはClickHouseノードを自動検出する機能を提供します。自動検出はデフォルトで無効になっています。手動で有効にするには、`auto_discovery`を`true`に設定します:

    ```java
    properties.setProperty("auto_discovery", "true");
    ```

    または接続URLで指定します:

    ```plaintext
    jdbc:ch://my-server/system?auto_discovery=true
    ```

    自動検出が有効になっている場合、接続URLにすべてのClickHouseノードを指定する必要はありません。URLに指定されたノードはシードとして扱われ、Javaクライアントはシステムテーブルおよび/またはclickhouse-keeperやzookeeperから追加のノードを自動的に検出します。

    以下のオプションは自動検出の設定を担当します:

    | プロパティ                           | デフォルト値  | 説明                                                                       |
    | ------------------------------- | ------- | ------------------------------------------------------------------------ |
    | auto&#95;discovery              | `false` | クライアントが system テーブルおよび/または clickhouse-keeper/zookeeper から追加ノードを検出するかどうか。 |
    | node&#95;discovery&#95;interval | `0`     | ノード検出の間隔（ミリ秒）。0 または負の値を指定すると一度だけ検出を行います。                                 |
    | node&#95;discovery&#95;limit    | `100`   | 同時に検出できるノードの最大数。ゼロ以下の値を指定した場合は上限なしを意味します。                                |

    ### ロードバランシング \{#v1-load-balancing\}

    Javaクライアントは、負荷分散ポリシーに従ってリクエストの送信先となるClickHouseノードを選択します。一般的に、負荷分散ポリシーは以下の処理を担当します:

    1. マネージドノードの一覧からノードを取得します。
    2. ノードの状態を管理する。
    3. （自動ディスカバリが有効な場合）ノードディスカバリ用のバックグラウンドプロセスを必要に応じてスケジュールし、ヘルスチェックを実行します。

    ロードバランシングを設定するオプションの一覧:

    | プロパティ                         | デフォルト                                    | 説明                                                                                                                                                                                                                                                                                                                                      |
    | ----------------------------- | ---------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
    | load&#95;balancing&#95;policy | `""`                                     | ロードバランシングポリシーとして指定できる値は次のとおりです: <li>`firstAlive` - リクエストは、管理対象ノードリストの最初の正常なノードに送信されます</li><li>`random` - リクエストは、管理対象ノードリストからランダムに選択されたノードに送信されます</li><li>`roundRobin` - リクエストは、管理対象ノードリスト内の各ノードに順番に送信されます</li><li>`ClickHouseLoadBalancingPolicy` を実装する完全修飾クラス名 - カスタムのロードバランシングポリシー</li>ポリシーが指定されていない場合、リクエストは管理対象ノードリストの最初のノードに送信されます |
    | load&#95;balancing&#95;tags   | `""`                                     | ノードを絞り込むためのロードバランシングタグ。リクエストは指定したタグを持つノードにのみ送信されます                                                                                                                                                                                                                                                                                      |
    | health&#95;check&#95;interval | `0`                                      | ヘルスチェックの間隔をミリ秒単位で指定します。0 以下の値は 1 回のみ実行することを意味します。                                                                                                                                                                                                                                                                                       |
    | health&#95;check&#95;method   | `ClickHouseHealthCheckMethod.SELECT_ONE` | ヘルスチェックの方式。次のいずれかを指定できます: <li>`ClickHouseHealthCheckMethod.SELECT_ONE` - `select 1` クエリを用いてチェック</li> <li>`ClickHouseHealthCheckMethod.PING` - プロトコル固有のチェックで、一般的により高速です</li>                                                                                                                                                             |
    | node&#95;check&#95;interval   | `0`                                      | ノードチェック間隔（ミリ秒単位）。負の値は 0 として扱われます。前回のチェックから指定した時間が経過している場合にノードのステータスがチェックされます。<br />`health_check_interval` と `node_check_interval` の違いは、`health_check_interval` オプションがノード（全ノードまたは障害ノード）のリストに対してステータスをチェックするバックグラウンドジョブをスケジューリングするのに対し、`node_check_interval` は特定のノードについて前回のチェックから経過していなければならない時間を指定する点です                                 |
    | check&#95;all&#95;nodes       | `false`                                  | すべてのノードを対象にヘルスチェックを行うか、障害が発生しているノードのみを対象にするかを指定します。                                                                                                                                                                                                                                                                                     |

    ### フェイルオーバーとリトライ \{#v1-failover-and-retry\}

    Javaクライアントは、失敗したクエリのフェイルオーバーおよびリトライ動作を設定するための構成オプションを提供します:

    | プロパティ                              | デフォルト値 | 説明                                                                                                                                                      |
    | ---------------------------------- | ------ | ------------------------------------------------------------------------------------------------------------------------------------------------------- |
    | failover                           | `0`    | 1 つのリクエストに対して許可されるフェイルオーバーの最大回数。0 または負の値の場合は、フェイルオーバーは行われません。フェイルオーバーでは、障害から復旧するために、失敗したリクエストを（負荷分散ポリシーに従って）別のノードに送信します。                                |
    | retry                              | `0`    | 1つのリクエストに対してリトライできる最大回数。0 または負の値の場合はリトライを行いません。リトライでは、ClickHouse サーバーが `NETWORK_ERROR` エラーコードを返した場合にのみ、同じノードに対してリクエストを再送信します                            |
    | repeat&#95;on&#95;session&#95;lock | `true` | セッションがロックされている間、`session_timeout` または `connect_timeout` に従ってタイムアウトに達するまで実行を繰り返すかどうか。ClickHouse サーバーが `SESSION_IS_LOCKED` エラーコードを返した場合、失敗したリクエストは再試行されます |

    ### カスタムHTTPヘッダーの追加 \{#v1-adding-custom-http-headers\}

    Javaクライアントは、リクエストにカスタムHTTPヘッダーを追加したい場合、HTTP/Sトランスポート層をサポートしています。
    `custom_http_headers`プロパティを使用してください。ヘッダーは`,`で区切り、ヘッダーのキーと値は`=`で区切る必要があります。

    ## Javaクライアントのサポート \{#v1-java-client-support\}

    ```java
    options.put("custom_http_headers", "X-ClickHouse-Quota=test, X-ClickHouse-Test=test");
    ```

    ## JDBC ドライバー \{#v1-jdbc-driver\}

    ```java
    properties.setProperty("custom_http_headers", "X-ClickHouse-Quota=test, X-ClickHouse-Test=test");
    ```
  </Version>
</ClientVersionDropdown>