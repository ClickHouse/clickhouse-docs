

import mysql_1 from '@site/static/images/_snippets/mysql1.png';
import mysql_2 from '@site/static/images/_snippets/mysql2.png';
import mysql_3 from '@site/static/images/_snippets/mysql3.png';
import mysql_4 from '@site/static/images/_snippets/mysql4.png';
import mysql_5 from '@site/static/images/_snippets/mysql5.png';
import Image from '@theme/IdealImage';
import {VerticalStepper} from "@clickhouse/click-ui/bundled";

<VerticalStepper headerLevel="h4">

#### `アプリを接続` を選択 {#select-connect-your-app}

ClickHouse Cloud Serviceを作成した後、`アプリを接続`画面で、ドロップダウンからMySQLを選択します。

<Image size="lg" img={mysql_1} alt="MySQLインターフェース選択ドロップダウンを示すClickHouse Cloudの認証情報画面" border />

#### MySQLインターフェースを有効にする {#enable-mysql-interface}

スイッチを切り替えて、この特定のサービスのためにMySQLインターフェースを有効にします。
これにより、このサービスのポート`3306`が公開され、ユニークなMySQLユーザー名を含むMySQL接続画面が表示されます。

<Image size="lg" img={mysql_2} alt="ClickHouse Cloud MySQLインターフェースを有効にする切り替えと接続詳細" border />

代わりに、既存のサービスに対してMySQLインターフェースを有効にするためには：

#### `接続` を選択 {#select-connect}

サービスが`実行中`の状態であることを確認し、MySQLインターフェースを有効にしたいサービスをクリックします。
左側のメニューから「接続」を選択します：

<Image size="lg" img={mysql_3} alt="接続オプションがハイライトされているClickHouse Cloudサービス接続画面" border />

#### `MySQL` を選択 {#choose-mysql}

ドロップダウンの `接続先` から `MySQL` を選択します。

<Image size="md" img={mysql_4} alt="MySQLオプション選択を示すClickHouse Cloud接続画面" border />

#### MySQLインターフェースを有効にする {#enable-mysql-interface}

スイッチを切り替えて、この特定のサービスのためにMySQLインターフェースを有効にします。
これにより、このサービスのポート`3306`が公開され、ユニークなMySQLユーザー名を含むMySQL接続画面が促されます。

</VerticalStepper>

<Image size="md" img={mysql_5} alt="接続詳細が表示されたMySQLインターフェースが有効なClickHouse Cloud接続画面" border />

## ClickHouse Cloudでの読み取り専用MySQLユーザーの作成 {#creating-multiple-mysql-users-in-clickhouse-cloud}

ClickHouse Cloudは、自動的に`mysql4<subdomain>`ユーザーを作成し、デフォルトのユーザーと同じパスワードを共有します。
`<subdomain>`部分は、あなたのClickHouse Cloudホスト名の最初の部分に対応しています。

このユーザー名の形式は、セキュアな接続を確立するツールとの互換性のために必要ですが、TLSハンドシェイクには[SNI (Server Name Indication)](https://www.cloudflare.com/learning/ssl/what-is-sni)データが含まれていません。
SNI情報がないと、システムは適切な内部ルーティングを実行できないため、ユーザー名に埋め込まれたサブドメインヒントが必要なルーティング情報を提供します。
MySQLコンソールクライアントは、この要件を持つツールの一例です。

:::tip
推奨されるベストプラクティスは、新しい読み取り専用MySQLユーザーを作成することです。
:::

:::note
`foobar.us-east1.aws.clickhouse.cloud`のようなClickHouse Cloudホスト名の場合、`<subdomain>`部分は`foobar`に等しく、カスタムMySQLユーザー名は`mysql4foobar_team1`のようになります。
:::

<VerticalStepper headerLevel="h4">

#### 読み取り専用設定プロファイルを作成 {#create-a-custom-settings-user}

[設定プロファイル](/sql-reference/statements/create/settings-profile)を作成して、あなたの読み取り専用ユーザーに適用し、
`readonly`設定を`1`に設定します：

```sql
CREATE SETTINGS PROFILE readonly_profile SETTINGS readonly = 1
```

#### 新しい読み取り専用MySQLユーザーを作成 {#create-a-readonly-mysql-user}

次の形式の名前の[ユーザーを作成](/sql-reference/statements/create/user)します：

```sql
mysql4<subdomain>_<username>
```

`readonly_profile`を新しいユーザーに適用し、パスワードがダブルSHA1形式であることを確認します。例えば：

```sql
CREATE USER mysql4foobar_readonly
IDENTIFIED WITH double_sha1_password BY 'YourPassword42$'
SETTINGS PROFILE 'readonly_profile';
```

#### 新しいユーザーに必要なテーブルへのアクセス権を付与 {#grant-the-new-user-the-necessary-permissions}

新しいユーザーに必要なテーブルまたはデータベースと対話するための権限を[付与](/sql-reference/statements/grant)します。
たとえば、`system.query_log`のみにアクセスを付与したい場合：

```sql
GRANT SELECT ON system.query_log TO mysql4foobar_readonly;
```

:::note
読み取り専用ユーザーの場合、アクセスしたいテーブルに対してのみ`SELECT`権限を付与することを確認してください。
:::

新しく作成されたユーザーは、MySQLインターフェースを使用してあなたのClickHouse Cloudサービスに接続するために使用できます。

</VerticalStepper>

### ClickHouse Cloudでの複数のMySQLユーザーのトラブルシューティング {#troubleshooting-multiple-mysql-users-in-clickhouse-cloud}

新しいMySQLユーザーを作成し、MySQL CLIクライアントを介して接続中に次のエラーが表示された場合：

```
ERROR 2013 (HY000): Lost connection to MySQL server at 'reading authorization packet', system error: 54
```

この場合、ユーザー名が`mysql4<subdomain>_<username>`形式に従っていることを確認してください、 ([上記](#creating-multiple-mysql-users-in-clickhouse-cloud) のように)。
