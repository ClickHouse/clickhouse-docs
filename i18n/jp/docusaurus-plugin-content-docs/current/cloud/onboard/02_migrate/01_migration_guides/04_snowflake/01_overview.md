---
sidebar_label: '概要'
slug: /migrations/snowflake-overview
description: 'Snowflake から ClickHouse への移行'
keywords: ['Snowflake']
title: 'Snowflake から ClickHouse への移行'
show_related_blogs: true
doc_type: 'guide'
---

import snowflake_architecture from '@site/static/images/cloud/onboard/discover/use_cases/snowflake_architecture.png';
import cloud_architecture from '@site/static/images/cloud/onboard/discover/use_cases/cloud_architecture.png';
import Image from '@theme/IdealImage';


# Snowflake から ClickHouse への移行

> このドキュメントでは、Snowflake から ClickHouse へのデータ移行について概要を説明します。

Snowflake は、主にレガシーなオンプレミスデータウェアハウスのワークロードをクラウドへ移行することに特化したクラウドデータウェアハウスです。大規模な長時間実行レポートを実行するよう最適化されています。データセットがクラウドへ移行されると、データ所有者は、このデータからさらにどのような価値を引き出せるか──たとえば、これらのデータセットを活用して、社内外向けのリアルタイムアプリケーションを構築できないか──を考え始めます。そうした段階になると、多くの場合、ClickHouse のようなリアルタイム分析向けに最適化されたデータベースが必要であることに気づきます。



## 比較 {#comparison}

このセクションでは、ClickHouseとSnowflakeの主要な機能を比較します。

### 類似点 {#similarities}

Snowflakeは、大量のデータの保存、処理、分析のためのスケーラブルで効率的なソリューションを提供するクラウドベースのデータウェアハウスプラットフォームです。

ClickHouseと同様に、Snowflakeは既存の技術をベースに構築されておらず、独自のSQLクエリエンジンとカスタムアーキテクチャに依存しています。

Snowflakeのアーキテクチャは、共有ストレージ(共有ディスク)アーキテクチャとシェアードナッシングアーキテクチャのハイブリッドとして説明されています。共有ストレージアーキテクチャとは、S3などのオブジェクトストアを使用してすべてのコンピュートノードからデータにアクセスできるアーキテクチャです。シェアードナッシングアーキテクチャとは、各コンピュートノードがクエリに応答するためにデータセット全体の一部をローカルに保存するアーキテクチャです。理論上、これは両方のモデルの長所を提供します。つまり、共有ディスクアーキテクチャのシンプルさとシェアードナッシングアーキテクチャのスケーラビリティです。

この設計は、主要なストレージメディアとしてオブジェクトストレージに根本的に依存しており、同時アクセス下でほぼ無限にスケールしながら、高い耐障害性とスケーラブルなスループット保証を提供します。

以下の[docs.snowflake.com](https://docs.snowflake.com/en/user-guide/intro-key-concepts)からの画像は、このアーキテクチャを示しています:

<Image img={snowflake_architecture} size='md' alt='Snowflakeアーキテクチャ' />

一方、オープンソースおよびクラウドホスト製品として、ClickHouseは共有ディスクアーキテクチャとシェアードナッシングアーキテクチャの両方でデプロイできます。後者はセルフマネージドデプロイメントで一般的です。CPUとメモリを容易にスケールできる一方で、シェアードナッシング構成は、特にメンバーシップ変更時に、従来のデータ管理の課題とデータレプリケーションのオーバーヘッドをもたらします。

このため、ClickHouse Cloudは、Snowflakeと概念的に類似した共有ストレージアーキテクチャを利用しています。データはS3やGCSなどのオブジェクトストアに一度(単一コピー)保存され、強力な冗長性保証を備えた事実上無限のストレージを提供します。各ノードは、このデータの単一コピーと、キャッシュ目的の独自のローカルSSDにアクセスできます。ノードは、必要に応じて追加のCPUおよびメモリリソースを提供するためにスケールできます。Snowflakeと同様に、S3のスケーラビリティ特性は、追加のノードが追加されてもクラスタ内の現在のノードで利用可能なI/Oスループットが影響を受けないようにすることで、共有ディスクアーキテクチャの従来の制限(ディスクI/Oとネットワークボトルネック)に対処します。

<Image img={cloud_architecture} size='md' alt='ClickHouse Cloudアーキテクチャ' />

### 相違点 {#differences}

基盤となるストレージフォーマットとクエリエンジンを除いて、これらのアーキテクチャはいくつかの微妙な点で異なります:

- Snowflakeのコンピュートリソースは、[ウェアハウス](https://docs.snowflake.com/en/user-guide/warehouses)の概念を通じて提供されます。
  これらは、それぞれ設定されたサイズの複数のノードで構成されます。Snowflakeはウェアハウスの具体的なアーキテクチャを公開していませんが、
  各ノードは8 vCPU、16GiB、および200GBのローカルストレージ(キャッシュ用)で構成されていると[一般的に理解されています](https://select.dev/posts/snowflake-warehouse-sizing)。
  ノード数はTシャツサイズに依存します。例えば、x-smallは1ノード、smallは2ノード、mediumは4ノード、largeは8ノードなどです。これらのウェアハウスはデータから独立しており、
  オブジェクトストレージ上に存在する任意のデータベースをクエリするために使用できます。アイドル状態でクエリ負荷がかかっていない場合、ウェアハウスは一時停止され、
  クエリを受信すると再開されます。ストレージコストは常に請求に反映されますが、ウェアハウスはアクティブな場合にのみ課金されます。

- ClickHouse Cloudは、ローカルキャッシュストレージを持つノードという同様の原則を利用しています。Tシャツサイズではなく、
  ユーザーは合計コンピュート量と利用可能なRAMを持つサービスをデプロイします。これは、クエリ負荷に基づいて(定義された制限内で)透過的に
  自動スケールします。各ノードのリソースを増減させる垂直スケーリング、またはノードの総数を増減させる水平スケーリングのいずれかです。ClickHouse
  Cloudノードは現在、Snowflakeの1:2とは異なり、1:1のCPU対メモリ比率を持っています。
  より緩い結合も可能ですが、Snowflakeウェアハウスとは異なり、サービスは現在データに結合されています。ノードはアイドル状態の場合は一時停止し、
  クエリを受けると再開します。ユーザーは必要に応じてサービスを手動でリサイズすることもできます。

- ClickHouse Cloudのクエリキャッシュは現在ノード固有ですが、Snowflakeのキャッシュはウェアハウスから独立したサービス層で提供されます。
  ベンチマークに基づくと、ClickHouse CloudのノードキャッシュはSnowflakeのキャッシュを上回ります。


- SnowflakeとClickHouse Cloudは、クエリの同時実行数を増やすためのスケーリングに異なるアプローチを採用しています。Snowflakeは[マルチクラスターウェアハウス](https://docs.snowflake.com/en/user-guide/warehouses-multicluster#benefits-of-multi-cluster-warehouses)として知られる機能を通じてこれに対処します。この機能により、ユーザーはウェアハウスにクラスターを追加できます。これはクエリレイテンシの改善にはつながりませんが、追加の並列化を提供し、より高いクエリ同時実行数を可能にします。ClickHouseは、垂直または水平スケーリングを通じてサービスにより多くのメモリとCPUを追加することでこれを実現します。本記事では、これらのサービスがより高い同時実行数にスケールする能力については検証せず、代わりにレイテンシに焦点を当てていますが、完全な比較のためにはこの作業が必要であることを認識しています。ただし、Snowflakeが[ウェアハウスで許可される同時クエリ数をデフォルトで8に明示的に制限している](https://docs.snowflake.com/en/sql-reference/parameters#max-concurrency-level)ことを考えると、ClickHouseはあらゆる同時実行テストで優れたパフォーマンスを発揮すると予想されます。比較すると、ClickHouse Cloudではノードあたり最大1000のクエリを実行できます。

- Snowflakeのデータセットに対する計算サイズの切り替え能力と、ウェアハウスの高速な再開時間により、アドホッククエリに優れた体験を提供します。データウェアハウスおよびデータレイクのユースケースにおいて、これは他のシステムに対する優位性となります。

### リアルタイム分析 {#real-time-analytics}

公開されている[ベンチマーク](https://benchmark.clickhouse.com/#system=+%E2%98%81w|%EF%B8%8Fr|C%20c|nfe&type=-&machine=-ca2|gl|6ax|6ale|3al&cluster_size=-&opensource=-&tuned=+n&metric=hot&queries=-)データに基づくと、ClickHouseはリアルタイム分析アプリケーションにおいて、以下の領域でSnowflakeを上回るパフォーマンスを発揮します:

- **クエリレイテンシ**: Snowflakeのクエリは、パフォーマンスを最適化するためにテーブルにクラスタリングが適用されている場合でも、より高いクエリレイテンシを示します。当社のテストでは、SnowflakeクラスタリングキーまたはClickHouseプライマリキーの一部であるフィルタが適用されるクエリにおいて、ClickHouseと同等のパフォーマンスを達成するために、Snowflakeは2倍以上の計算リソースを必要とします。Snowflakeの[永続的クエリキャッシュ](https://docs.snowflake.com/en/user-guide/querying-persisted-results)はこれらのレイテンシの課題の一部を相殺しますが、フィルタ条件がより多様な場合には効果がありません。このクエリキャッシュの有効性は、基盤となるデータの変更によってさらに影響を受ける可能性があり、テーブルが変更されるとキャッシュエントリが無効化されます。これは当社のアプリケーションのベンチマークには該当しませんが、実際のデプロイメントでは新しい最新のデータを挿入する必要があります。なお、ClickHouseのクエリキャッシュはノード固有であり、[トランザクション一貫性がない](https://clickhouse.com/blog/introduction-to-the-clickhouse-query-cache-and-design)ため、リアルタイム分析に[より適しています](https://clickhouse.com/blog/introduction-to-the-clickhouse-query-cache-and-design)。ユーザーは、[クエリごとの制御](/operations/settings/settings#use_query_cache)、[正確なサイズ](/operations/settings/settings#query_cache_max_size_in_bytes)、[クエリがキャッシュされるかどうか](/operations/settings/settings#enable_writes_to_query_cache)(期間または必要な実行回数の制限)、および[受動的にのみ使用されるかどうか](https://clickhouse.com/blog/introduction-to-the-clickhouse-query-cache-and-design#using-logs-and-settings)を制御する機能により、その使用を細かく制御できます。

- **低コスト**: Snowflakeウェアハウスは、クエリの非アクティブ期間後に一時停止するように設定できます。一時停止されると、料金は発生しません。実際には、この非アクティブチェックは[60秒までしか短縮できません](https://docs.snowflake.com/en/sql-reference/sql/alter-warehouse)。ウェアハウスは、クエリを受信すると数秒以内に自動的に再開されます。Snowflakeはウェアハウスが使用中の場合にのみリソースに対して課金するため、この動作はアドホッククエリのように頻繁にアイドル状態になるワークロードに適しています。


  しかし、多くのリアルタイム分析ワークロードでは、継続的なリアルタイムデータの取り込みと高頻度のクエリ実行が必要となり（カスタマー向けダッシュボードなど）、アイドル状態によるメリットを享受できません。これは、ウェアハウスを常にフルアクティブな状態に保ち、その間ずっと課金が発生することを意味します。その結果、アイドルによるコスト削減効果は相殺されるだけでなく、Snowflake が代替製品よりも高速に応答可能な状態へ復帰できることによるパフォーマンス上の優位性も意味を失います。このアクティブ状態の要件に、アクティブ状態における ClickHouse Cloud の 1 秒あたりコストの低さが加わることで、この種のワークロードに対しては、ClickHouse Cloud は総コストを大幅に低減できます。

* **機能の予測可能な料金:** マテリアライズドビューやクラスタリング（ClickHouse の `ORDER BY` に相当）といった機能は、リアルタイム分析のユースケースで最高レベルのパフォーマンスを実現するために不可欠です。これらの機能は Snowflake では追加課金の対象となり、クレジット単価を 1.5 倍に引き上げる上位ティアが必要になるだけでなく、予測の難しいバックグラウンドコストも発生します。例えば、マテリアライズドビューやクラスタリングにはバックグラウンドでのメンテナンスコストがかかりますが、その水準は事前に見積もるのが困難です。対照的に、ClickHouse Cloud では、これらの機能自体に追加コストは発生せず、挿入時に CPU およびメモリ使用量が増加するのみです。この増加分も、高頻度の挿入ワークロードといったユースケースを除けば、通常は無視できる程度です。ベンチマークでは、こうした違いに加え、クエリレイテンシの低さと高い圧縮率によって、ClickHouse ではコストが大幅に削減されることを確認しています。
