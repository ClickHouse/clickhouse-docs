---
slug: /cloud/get-started/cloud/use-cases/AI_ML
title: '機械学習'
description: 'ClickHouse が ML パイプライン全体で機械学習アプリケーションをどのように支えているかを学びます。'
keywords: ['use cases', 'Machine Learning', 'Generative AI']
sidebar_label: '機械学習'
doc_type: 'guide'
---

import machine_learning_data_layer from '@site/static/images/cloud/onboard/discover/use_cases/ml_data_layer.png'
import online_feature_store from '@site/static/images/cloud/onboard/discover/use_cases/ml_data_layer.png'
import Image from '@theme/IdealImage';


## 機械学習データレイヤー {#machine-learning-data-layer}

機械学習実務者の時間の80%がデータクリーニングに費やされるという話を聞いたことがあるでしょう。
この通説が真実かどうかに関わらず、変わらない事実は、データが機械学習の問題の中心にあるということです。最初から最後まで。
RAGパイプラインの構築、ファインチューニング、独自モデルのトレーニング、モデル性能の評価など、どのような作業においても、データがすべての問題の根幹です。

データ管理は複雑になりがちで、その結果、機械学習データ問題の特定の領域を解決することで生産性を向上させるように設計されたツールが急増しています。
多くの場合、これは汎用ソリューションの周りに抽象化レイヤーを設け、独自のインターフェースを提供することで、表面上は目の前の特定のサブ問題に適用しやすくする形をとります。
実質的には、特定のタスクの使いやすさとシンプルさを優先して、汎用ソリューションに存在する柔軟性を犠牲にすることになります。

<Image img={machine_learning_data_layer} size='sm' />

このアプローチにはいくつかの欠点があります。
特化したツール、製品、サービスの連鎖は、サポートアプリケーションコードと組み合わせた汎用ソリューションとは対照的に、必要以上にアーキテクチャの複雑さとデータコストが増大するリスクをもたらします。
気づかないうちに、それぞれが単一のステップにのみ使用される、際限のないツールとサービスのリストを抱えてしまうことは容易です。

これらのリスクには、2つの一般的な側面があります。

1. **学習、保守、切り替えコスト**

機械学習アーキテクチャは、さまざまなツールやコンポーネントで混雑し、学習と管理が困難な断片化された環境を生み出し、障害ポイントと費用の増加を招く可能性があります。

2. **データ重複と転送コスト**

機械学習パイプラインで複数の個別でありながら重複するデータシステムを使用すると、あるシステムから別のシステムへデータを移動する不要で、しばしばコストのかかるオーバーヘッドが発生する可能性があります。

このトレードオフの好例がベクトルデータベースです。
ベクトルデータベースは、ベクトルの保存と検索という非常に特化した機械学習タスク向けに設計されています。
これは一部のアーキテクチャでは正しい選択かもしれませんが、他のアーキテクチャでは、ベクトルデータベースは技術スタックへの不要な新規追加となる可能性があります。なぜなら、統合、管理、データの送受信を行うべきさらに別のシステムだからです。
最近の汎用データベースのほとんどは、標準で(またはプラグインを通じて)ベクトルサポートを備えており、より広範で横断的な機能を持っています。
言い換えれば、これらのアーキテクチャでは、ベクトルを特別に処理するための全く新しいデータベースは必要ない可能性があります。
重要なのは、ベクトル固有の便利な機能(例:組み込み埋め込みモデル)がミッションクリティカルであり、コストに見合う価値があるかどうかに集約されます。

### データ探索 {#data-exploration}

機械学習の問題、目標、成功基準を定義した後、一般的な最初のステップは、モデルのトレーニングと評価に使用される関連データを探索することです。

このステップでは、データの特性、分布、関係性を理解するために分析が行われます。
この評価と理解のプロセスは反復的なものであり、多くの場合、データセット全体で一連のアドホッククエリが実行されます。ここでは、クエリの応答性が重要です(コスト効率や精度などの他の要因とともに)。
企業が機械学習目的で活用するために保存するデータ量が増加するにつれて、保有するデータを調査する問題はより困難になります。

これは、従来のデータシステムでは、分析および評価クエリが大規模になると、しばしば退屈なほど遅くなるか、実行不可能なほど遅くなるためです。
大手プレイヤーの一部は、クエリ時間を短縮するために大幅にコストを増加させ、クエリごとまたはスキャンされたバイト数による課金によってアドホック評価を抑制しています。
エンジニアは、これらの制限への妥協策として、データのサブセットをローカルマシンにダウンロードすることに頼る場合があります。

一方、ClickHouseはリアルタイムデータウェアハウスであるため、ユーザーは分析計算において業界をリードするクエリ速度の恩恵を受けます。
さらに、ClickHouseは最初から高性能を提供し、重要なクエリ高速化機能を高価格帯の背後に隠すことはありません。
ClickHouseは、Iceberg、Delta Lake、Hudiなどの一般的な形式をサポートし、オブジェクトストレージやデータレイクから直接データをクエリすることもできます。
これは、データがどこにあっても、ClickHouseが機械学習ワークロードのための統一されたアクセスおよび計算レイヤーとして機能できることを意味します。

ClickHouseには、ペタバイト規模のデータに対応する広範な事前構築済み統計関数と集計関数のスイートもあり、複雑な計算を実行するシンプルなSQLを簡単に記述および保守できます。
最も細かい精度のデータ型とコーデックをサポートしているため、データの粒度を下げることを心配する必要はありません。


ユーザーはClickHouse内で直接データを変換したり、SQLクエリを使用して挿入前に変換したりできますが、[chDB](/chdb)を介してPythonなどのプログラミング環境でもClickHouseを使用できます。
これにより、組み込みClickHouseをPythonモジュールとして公開し、ノートブック内で大規模なデータフレームの変換や操作が可能になります。
データエンジニアはクライアント側で変換作業を実行でき、その結果を中央集約型のClickHouseインスタンスにフィーチャーテーブルとしてマテリアライズできます。

### データ準備とフィーチャー抽出 {#data-preparation-and-feature-extraction}

次にデータの準備が行われます。クリーニング、変換が行われ、モデルの訓練と評価に使用されるフィーチャーの抽出に使用されます。
このコンポーネントはフィーチャー生成または抽出パイプラインと呼ばれることがあり、新しいツールが頻繁に導入される機械学習データレイヤーの一部です。
NeptuneやHopsworksなどのMLOpsプレイヤーは、このようなパイプラインをオーケストレーションするために使用される多様なデータ変換製品の例を提供しています。
しかし、これらは操作対象のデータベースとは別のツールであるため、脆弱であり、手動で修正が必要な障害を引き起こす可能性があります。

対照的に、データ変換は[マテリアライズドビュー](/materialized-views)を通じてClickHouse内で直接簡単に実行できます。
これらは新しいデータがClickHouseのソーステーブルに挿入されると自動的にトリガーされ、データが到着する際の抽出、変換、修正を容易に行うために使用されます。これにより、独自のパイプラインを構築および監視する必要がなくなります。
これらの変換がメモリに収まらない可能性のある完全なデータセットに対する集計を必要とする場合、ClickHouseを活用することで、ローカルマシン上のデータフレームで動作するようにこのステップを改造する必要がなくなります。
ローカルで評価する方が便利なデータセットについては、[ClickHouse local](/operations/utilities/clickhouse-local)が[chDB](/chdb)とともに優れた代替手段となり、ユーザーはPandasなどの標準的なPythonデータライブラリとともにClickHouseを活用できます。

### 訓練と評価 {#training-and-evaluation}

この時点で、フィーチャーは訓練セット、検証セット、テストセットに分割されています。
これらのデータセットはバージョン管理され、それぞれのステージで利用されます。

パイプラインのこのフェーズでは、機械学習データレイヤーにさらに別の専門ツールであるフィーチャーストアを導入することが一般的です。
フィーチャーストアは、モデルの訓練、推論、評価のためのデータ管理に特化した便利な機能を提供する、データベースを中心とした抽象化レイヤーであることが最も一般的です。
これらの便利な機能の例には、バージョン管理、アクセス管理、フィーチャーの定義をSQL文に自動的に変換する機能などがあります。

フィーチャーストアにおいて、ClickHouseは以下の役割を果たすことができます。

**データソース** - IcebergやDelta Lakeなどのデータレイク形式を含む70種類以上のファイル形式でデータをクエリまたは取り込む能力を持つClickHouseは、データを保持またはクエリする理想的な長期ストアとなります。
オブジェクトストレージを使用してストレージとコンピュートを分離することで、ClickHouse Cloudはデータを無期限に保持でき、コストを最小限に抑えるためにコンピュートをスケールダウンまたは完全にアイドル状態にできます。
柔軟なコーデックと、カラム指向ストレージおよびディスク上のデータの順序付けを組み合わせることで、圧縮率が最大化され、必要なストレージが最小限に抑えられます。
ユーザーは、オブジェクトストレージ上のデータをその場でクエリする組み込み関数を使用して、ClickHouseをデータレイクと簡単に組み合わせることができます。

**変換エンジン** - SQLはデータ変換を宣言する自然な手段を提供します。
ClickHouseの分析関数と統計関数で拡張すると、これらの変換は簡潔で最適化されたものになります。
ClickHouseがデータストアとして使用される場合のClickHouseテーブルへの適用に加えて、テーブル関数により、Parquet形式でディスクまたはオブジェクトストレージに保存されたデータ、あるいはPostgreSQLやMySQLなどの他のデータストアに対してSQLクエリを記述できます。
完全に並列化されたクエリ実行エンジンとカラム指向ストレージ形式を組み合わせることで、ClickHouseは数秒でペタバイト規模のデータに対する集計を実行できます。メモリ内データフレームでの変換とは異なり、ユーザーはメモリに制約されません。
さらに、マテリアライズドビューにより、挿入時にデータを変換できるため、コンピュート負荷をクエリ時からデータロード時に移行できます。
これらのビューは、データ分析と要約に理想的な同じ範囲の分析関数と統計関数を活用できます。
ClickHouseの既存の分析関数が不十分な場合やカスタムライブラリを統合する必要がある場合、ユーザーはユーザー定義関数（UDF）も利用できます。

#### オフラインフィーチャーストア {#offline-feature-store}

オフラインフィーチャーストアはモデルの訓練に使用されます。
これは一般的に、フィーチャー自体がバッチ処理データ変換パイプライン（上記のセクションで説明）を通じて生成され、通常、これらのフィーチャーの可用性に厳格なレイテンシ要件がないことを意味します。


複数のソースからデータを読み取り、SQLクエリによる変換を適用する機能により、これらのクエリの結果は`INSERT INTO SELECT`ステートメントを使用してClickHouseに永続化することもできます。
変換は多くの場合エンティティIDでグループ化され、結果として複数のカラムを返すため、ClickHouseのスキーマ推論機能により、これらの結果から必要な型を自動的に検出し、それらを格納するための適切なテーブルスキーマを生成できます。
乱数生成と統計的サンプリングのための関数により、データを効率的に反復処理し、モデルトレーニングパイプラインに供給するために毎秒数百万行の規模でスケールすることができます。

多くの場合、特徴量はテーブルで表現され、特定の時点におけるエンティティと特徴量の値を示すタイムスタンプが付与されます。
前述のように、トレーニングパイプラインは特定の時点およびグループにおける特徴量の状態を必要とすることがよくあります。ClickHouseのスパースインデックスにより、ポイントインタイムクエリと特徴量選択フィルタを満たすためのデータの高速フィルタリングが可能になります。Spark、Redshift、BigQueryなどの他の技術が特定の時点における特徴量の状態を特定するために低速なステートフルウィンドウアプローチに依存しているのに対し、ClickHouseはASOF（as-of-this-time）LEFT JOINクエリとargMax関数をサポートしています。
構文を簡素化するだけでなく、このアプローチはソートとマージアルゴリズムの使用により、大規模データセットにおいて高いパフォーマンスを発揮します。
これにより特徴量グループを迅速に構築でき、トレーニング前のデータ準備時間を短縮できます。

#### オンライン特徴量ストア {#online-feature-store}

オンライン特徴量ストアは、推論に使用される特徴量の最新バージョンを格納するために使用され、リアルタイムで適用されます。
これは、これらの特徴量がリアルタイム機械学習サービスの一部として使用されるため、最小限のレイテンシで計算される必要があることを意味します。

<Image img={online_feature_store} size='sm' />

リアルタイム分析データベースとして、ClickHouseは低レイテンシで高度に並行したクエリワークロードを処理できます。
これには通常、データの非正規化が必要ですが、これはトレーニング時と推論時の両方で使用される特徴量グループの格納方法と一致しています。
重要なことに、ClickHouseはログ構造化マージツリーのおかげで、高い書き込みワークロード下でもこのクエリパフォーマンスを提供できます。
これらの特性は、特徴量を最新の状態に保つためにオンラインストアで必要とされます。
特徴量はすでにオフラインストア内で利用可能であるため、既存の機能（例：`remoteSecure`）を使用して、同じClickHouseクラスタ内または異なるインスタンス内の新しいテーブルに簡単にマテリアライズできます。
Kafkaとの統合は、exactly-once Kafka Connectの提供、またはClickHouse Cloudの[ClickPipes](/integrations/clickpipes/kafka)を介して、ストリーミングソースからのストリーミングデータの消費をシンプルかつ信頼性の高いものにします。

多くの最新システムはオフラインストアとオンラインストアの両方を必要とし、ここでは2つの専門的な特徴量ストアが必要であるという結論に飛びつきがちです。
しかし、これによりこれら両方のストアを同期させるという追加の複雑さが生じ、もちろんそれらの間でデータを複製するコストも含まれます。

ClickHouseのようなリアルタイムデータウェアハウスは、オフラインとオンラインの両方の特徴量管理を実現できる単一のシステムです。
ClickHouseはストリーミングデータと履歴データを効率的に処理し、リアルタイム推論とオフライントレーニングのための特徴量を提供する際に信頼できる、無制限のスケール、パフォーマンス、並行性を備えています。

この段階で特徴量ストア製品を使用することと、リアルタイムデータウェアハウスを直接活用することのトレードオフを考慮する際、バージョニングなどの便利な機能は、テーブルやスキーマ設計などの古くからのデータベースパラダイムを通じて実現できることを強調する価値があります。
特徴量定義をSQLステートメントに変換するなどの他の機能は、独自の抽象化レイヤーに存在するのではなく、アプリケーションまたはビジネスロジックの一部としてより大きな柔軟性を提供する可能性があります。

### 推論 {#inference}

モデル推論は、トレーニング済みモデルを実行して出力を受け取るプロセスです。
推論がデータベースアクション（例えば、新しいレコードの挿入やレコードのクエリ）によってトリガーされる場合、推論ステップはカスタムジョブまたはアプリケーションコードを介して管理できます。

一方で、データレイヤー自体で管理することもできます。ClickHouseの[ユーザー定義関数（UDF）](/sql-reference/functions/udf)は、挿入時またはクエリ時にClickHouseから直接モデルを呼び出す機能をユーザーに提供します。
これにより、受信データをモデルに渡し、出力を受け取り、これらの結果を取り込まれたデータとともに自動的に格納する機能が提供されます - すべて他のプロセスやジョブを起動する必要がありません。
これにより、このステップを管理するための単一のインターフェースであるSQLも提供されます。

### ベクトルストア {#vector-store}

ベクトルストアは、ベクトルの格納と取得に最適化された特定のタイプのデータベースであり、通常はデータの一部（テキストや画像など）の埋め込みで、その根底にある意味を数値的に捉えたものです。
ベクトルは今日の生成AI波の中核にあり、無数のアプリケーションで使用されています。


ベクトルデータベースにおける主要な操作は、数学的尺度に基づいて互いに「最も近い」ベクトルを見つける「類似性検索」です。
ベクトルデータベースが普及している理由は、ベクトル比較という処理を可能な限り高速化するための特定の手法を採用しているためです。
これらの手法では一般的に、入力ベクトルを保存されているすべてのベクトルと比較する代わりに、ベクトル比較を近似的に行います。

この新しいクラスのツールの課題は、ClickHouseを含む多くの汎用データベースが、ベクトルサポートを標準で提供しており、さらにこれらの近似手法の実装も組み込まれていることが多い点です。
特にClickHouseは、高性能な大規模分析向けに設計されており、近似を用いない正確なベクトル比較を非常に効果的に実行できます。
つまり、速度を犠牲にすることなく、近似に頼らずに正確な結果を得ることができます。

### オブザーバビリティ {#observability}

機械学習アプリケーションが本番稼働すると、ログやトレーシングデータを含むデータが生成され、モデルの動作、パフォーマンス、および改善可能な領域に関する貴重な洞察が得られます。

SQLベースのオブザーバビリティは、ClickHouseのもう一つの重要なユースケースであり、ClickHouseは代替手段と比較して10〜100倍のコスト効率を実現することが確認されています。
実際、多くのオブザーバビリティ製品は、内部でClickHouseを使用して構築されています。
クラス最高のインジェスト速度と圧縮率により、ClickHouseはあらゆる規模の機械学習オブザーバビリティに対して、コスト効率と圧倒的な速度を提供します。
