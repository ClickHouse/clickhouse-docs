---
'slug': '/cloud/get-started/cloud/use-cases/AI_ML'
'title': '機械学習'
'description': 'Learn how ClickHouse powers 機械学習 applications across the ML pipeline.'
'keywords':
- 'use cases'
- 'Machine Learning'
- 'Generative AI'
'sidebar_label': '機械学習'
'doc_type': 'guide'
---

import machine_learning_data_layer from '@site/static/images/cloud/onboard/discover/use_cases/ml_data_layer.png'
import online_feature_store from '@site/static/images/cloud/onboard/discover/use_cases/ml_data_layer.png'
import Image from '@theme/IdealImage';

## 機械学習データレイヤー {#machine-learning-data-layer}

おそらく、機械学習の実務家がデータのクリーンアップに80％の時間を費やしているという伝説を聞いたことがあるでしょう。
この神話が真実かどうかに関わらず、データは機械学習の問題の中心であり、始まりから終わりまで関与しています。
RAGパイプラインを構築する際や、ファインチューニングを行う際、自分のモデルをトレーニングする際、またはモデルパフォーマンスを評価する際、データは各問題の根本にあるものです。

データの管理は難しいことがあり、その副産物として、特定の機械学習データ問題を解決することで生産性を向上させるために設計されたツールの急増が見られます。
これはしばしば、特定のサブ問題に適用しやすくするために意見が分かれたインターフェースを持つ、より一般的なソリューションの周りの抽象化レイヤーとして形を取ります。
実際、これは、特定のタスクの使いやすさと単純さを優先するために、汎用ソリューションが持つ柔軟性を減少させます。

<Image img={machine_learning_data_layer} size="sm"/>

このアプローチにはいくつかの欠点があります。
特定のツール、製品、およびサービスの連鎖的なスイートは、サポートするアプリケーションコードと組み合わせた汎用ソリューションと対照的に、必要以上に大きなアーキテクチャの複雑さとデータコストのリスクをもたらします。
単一のステップに対してのみ使用されるツールやサービスの無限のリストを無意識に持つことは簡単です。

これらのリスクには、主に2つの共通の次元があります：

1. **学習、メンテナンス、切り替えコスト**

機械学習アーキテクチャは、さまざまなツールやコンポーネントで混雑することがあり、結果として分断され、学習や管理が困難で、失敗点やコストの増加が増します。

2. **データ重複と転送コスト**

機械学習パイプライン内でいくつかの離散的かつ重複したデータシステムを使用することは、データを一方からもう一方に送るための不要であり、しばしばコストのかかるオーバーヘッドを引き起こす可能性があります。

このトレードオフの素晴らしい例が、ベクトルデータベースです。
ベクトルデータベースは、ベクトルの格納と検索という超特定の機械学習タスクのために設計されています。
これは一部のアーキテクチャでは正しい選択かもしれませんが、他のアーキテクチャでは、統合し、管理し、データを送信するための新たなシステムが無駄に増える可能性があります。
ほとんどの現代の汎用データベースは、ベクトルサポートを標準装備（またはプラグインを介して）しており、より広範で横断的な機能を提供しています。
言い換えれば、これらのアーキテクチャで特にベクトルを処理するための新しいデータベースが必要ない場合もあります。
重要なのは、ベクトル特有の便利な機能（例：組み込みの埋め込みモデル）がミッションクリティカルであり、そのコストに見合う価値があるかどうかです。

### データ探索 {#data-exploration}

機械学習の問題、目標、成功基準を定義した後の一般的な最初のステップは、モデルのトレーニングと評価に使用される関連データを探索することです。

このステップでは、データの特性、分布、および関係を理解するために分析されます。
この評価と理解の過程は反復的であり、しばしばデータセット間で一連のアドホッククエリが実行される結果となり、クエリの応答性が重要である（コスト効率や正確性などの他の要因とともに）ことが求められます。
企業が機械学習目的で利用するデータの量を増やす中で、持っているデータを調べることがますます困難になっています。

これは、従来のデータシステムを用いた際に、分析および評価クエリがスケールで退屈になり、または高すぎることで遅くなることが多いためです。
主要なプレイヤーは、クエリ時間を短縮するために大幅にコストを引き上げ、クエリごとの料金やスキャンしたバイト数に基づいてアドホック評価を抑制します。
エンジニアは、これらの制限に妥協するために、データのサブセットをローカルマシンに引き下ろす場合があります。

一方で、ClickHouseはリアルタイムデータウェアハウスであり、ユーザーは分析計算において業界をリードするクエリ速度の恩恵を受けます。
さらに、ClickHouseは最初から高いパフォーマンスを発揮し、重要なクエリ加速機能をより高い価格帯の後ろに置かないため、コストの問題とは無縁です。
ClickHouseは、Iceberg、Delta Lake、Hudiなどの一般的なフォーマットをサポートし、オブジェクトストレージやデータレイクから直接データをクエリすることもできます。
これは、データがどこにあっても、ClickHouseが機械学習ワークロードのための統一されたアクセスおよび計算レイヤーとして機能できることを意味します。

ClickHouseには、ペタバイトのデータにスケールする事前構築された統計および集約関数の広範なスイートがあり、複雑な計算を実行するシンプルなSQLを書くのが容易です。
最も細かい精度を持つデータ型とコーデックをサポートしているため、データの粒度を減らす心配は不要です。

ユーザーは、ClickHouseで直接データを変換したり、SQLクエリを使用して挿入前にデータを変換したりできますが、ClickHouseはまた、[chDB](/chdb)を介してPythonなどのプログラミング環境で使用することもできます。
これにより、埋め込まれたClickHouseをPythonモジュールとして公開し、ノートブック内で大規模なデータフレームを変換および操作できます。
したがって、データエンジニアはクライアント側で変換作業を行うことができ、結果は中央集権的なClickHouseインスタンス内のフィーチャーテーブルとして具現化される可能性があります。

### データ準備と特徴抽出 {#data-preparation-and-feature-extraction}

次に、データが準備されます：クリーンアップ、変換、およびモデルがトレーニングおよび評価されるための特徴を抽出します。
このコンポーネントは時折特徴生成または抽出パイプラインと呼ばれ、新しいツールがしばしば導入される機械学習データレイヤーのもう一つのスライスです。
NeptuneやHopsworksのようなMLOpsプレイヤーは、このようなパイプラインを調整するために使用されるさまざまなデータ変換製品の例を提供します。
ただし、これらは彼らが操作しているデータベースとは別のツールであるため、壊れやすく、手動で修正する必要のある中断を引き起こす可能性があります。

対照的に、データ変換は[マテリアライズドビュー](/materialized-views)を介してClickHouse内で簡単に達成できます。
これらはClickHouseのソーステーブルに新しいデータが挿入されると自動的にトリガーされ、到着時にデータを簡単に抽出、変換、変更するために使用されます - 自分で特注のパイプラインを構築し、監視する必要がなくなります。
これらの変換がメモリに収まりきらない完全なデータセットにわたって集計を必要とする場合、ClickHouseを利用することで、ローカルマシン上のデータフレームでこのステップを調整する必要がなくなります。
ローカルで評価するのがより便利なデータセットには、[ClickHouse local](/operations/utilities/clickhouse-local)と[chDB](/chdb)が優れた代替手段として、ユーザーがPandasなどの標準的なPythonデータライブラリでClickHouseを活用することを可能にします。

### トレーニングと評価 {#training-and-evaluation}

この時点で、特徴はトレーニング、検証、およびテストセットに分割されています。
これらのデータセットはバージョン管理され、それぞれのステージで利用されます。

このパイプラインのこのフェーズでは、機械学習データレイヤーに追加の専門ツール - フィーチャーストアを導入することが一般的です。
フィーチャーストアは、モデルのトレーニング、推論、および評価のためにデータを管理するための便利な機能を提供するデータベースの周りの抽象化レイヤーです。
これらの便利な機能の例には、バージョン管理、アクセス管理、フィーチャーの定義をSQLステートメントに自動的に変換する機能などがあります。

フィーチャーストアとして、ClickHouseは次のように機能できます：

**データソース** - IcebergやDelta Lakeなどのデータレイクフォーマットを含む70以上の異なるファイル形式でデータをクエリまたは取り込む能力を持つClickHouseは、データを保持またはクエリするための理想的な長期ストレージです。
オブジェクトストレージを使用してストレージとコンピュートを分離することで、ClickHouse Cloudはデータを無期限に保持できるだけでなく、コストを最小限に抑えるためにコンピュートをダウンスケールまたは完全にアイドルにすることもできます。
柔軟なコーデックに加え、列指向ストレージおよびディスク上のデータの順序は、圧縮率を最大化し、結果として必要なストレージを最小限に抑えます。
ユーザーはClickHouseをデータレイクと簡単に組み合わせることができ、オブジェクトストレージ上でデータをそのままクエリするためのビルトイン関数を利用できます。

**変換エンジン** - SQLはデータ変換を宣言する自然な手段を提供します。
ClickHouseの分析および統計関数を追加すると、これらの変換は簡潔で最適化されます。
ClickHouseテーブルに適用できるだけでなく、ClickHouseがデータストアとして使用される場合には、テーブル関数を介して、Parquetなどのフォーマットで保存されたデータに対してSQLクエリを書くことができます。
完全な並列化されたクエリ実行エンジンと列指向ストレージフォーマットを組み合わせることで、ClickHouseは数秒でPB単位のデータに対する集計を行うことができます - メモリ内のデータフレームでの変換とは異なり、ユーザーはメモリに制約されません。
さらに、マテリアライズドビューは、挿入時にデータを変換できるため、クエリ時ではなくデータ読み込み時に計算を利用できます。
これらのビューは、データ分析および要約に最適な同様の範囲の分析および統計関数を利用できます。
ClickHouseの既存の分析関数が不十分な場合やカスタムライブラリを統合する必要がある場合、ユーザーはユーザー定義関数（UDF）を利用することもできます。

#### オフラインフィーチャーストア {#offline-feature-store}

オフラインフィーチャーストアはモデルのトレーニングに使用されます。
一般には、特徴自体はバッチプロセスのデータ変換パイプライン（上記のセクションで説明したように）を通じて生成され、これらの特徴の利用可能性に厳格な遅延要件は通常ありません。

複数のソースからデータを読み込み、SQLクエリを介して変換を適用する能力を持つため、これらのクエリの結果も`INSERT INTO SELECT`ステートメントを介してClickHouseに保持することができます。
変換はしばしばエンティティIDによってグループ化され、結果として複数のカラムを返すため、ClickHouseのスキーマ推測はこれらの結果から必要な型を自動的に検出し、それらを格納するのに適切なテーブルスキーマを生成します。
乱数生成や統計サンプリングのための関数を使用すると、データが効率的にイテレートされ、モデルのトレーニングパイプラインに供給するために1秒あたり数百万行のスケールでスケーリングされます。

特徴は、通常、特定の時点でのエンティティとフィーチャーの値を示すタイムスタンプを持つテーブルで表されます。
前述のように、トレーニングパイプラインは特定の時点およびグループでの特徴の状態を必要とします。ClickHouseのスパースインデックスは、時点でのクエリおよび特徴選択フィルタを満たすためにデータを迅速にフィルタリングすることを可能にします。他のテクノロジー（例えばSpark、Redshift、BigQuery）は、特定の時点での特徴の状態を識別するために遅い状態保持ウィンドウアプローチに依存していますが、ClickHouseはASOF（as-of-this-time）LEFT JOINクエリおよびargMax関数をサポートしています。
このアプローチは、構文を簡素化するだけでなく、ソートおよびマージアルゴリズムを使用することで大規模データセットに対して高いパフォーマンスを持ちます。
これにより、トレーニング前のデータ準備時間が短縮されるため、フィーチャーグループを迅速に構築できます。

#### オンラインフィーチャーストア {#online-feature-store}

オンラインフィーチャーストアは、推論に使用される最新のフィーチャーのバージョンを保存するために使用され、リアルタイムで適用されます。
これは、これらのフィーチャーを最小限の遅延で計算する必要があることを意味し、リアルタイムの機械学習サービスの一部として使用されます。

<Image img={online_feature_store} size="sm"/>

リアルタイム分析データベースとして、ClickHouseは低遅延で非常に同時クエリワークロードを処理できます。
これは通常、データを正規化されていない状態で必要としますが、これはトレーニングおよび推論の両方で使用される特徴グループの保存に適合します。
重要なのは、ClickHouseが高い書き込みワークロードに従事しながらもこのクエリパフォーマンスを提供できることです。これも、そのログ構造化マージツリーのおかげです。
これらの特性は、オンラインストアでフィーチャーを最新の状態に保つために必要です。
フィーチャーは既にオフラインストア内にあるため、既存の機能（例：`remoteSecure`）を介して、同じClickHouseクラスタ内または別のインスタンス内に新しいテーブルに簡単に具現化できます。
Kafkaとの統合は、確実に1回だけのKafka Connectの提供を介して、またはClickHouse Cloudの[ClickPipes](/integrations/clickpipes/kafka)を介して、ストリーミングソースからストリーミングデータを消費するのを簡単かつ信頼性の高いものにします。

多くの現代のシステムはオフラインストアとオンラインストアの両方を必要とし、ここで2つの特化したフィーチャーストアが必要という結論に飛びつくのも容易です。
しかし、これは、この2つのストアの同期を保つという追加の複雑さを導入し、もちろんそれにはデータを複製するためのコストも含まれます。

ClickHouseのようなリアルタイムデータウェアハウスは、オフラインおよびオンラインフィーチャー管理の両方を担う単一のシステムです。
ClickHouseはストリーミングおよび履歴データを効率的に処理し、リアルタイムの推論やオフラインのトレーニングにフィーチャーを提供する際に必要な無限のスケール、パフォーマンス、同時処理能力を持っています。

このステージでフィーチャーストア製品を使用することとリアルタイムデータウェアハウスを直接活用することのトレードオフを考える際、バージョン管理などの便利な機能は、テーブルやスキーマ設計といった古くからのデータベースパラダイムを通じて達成できることを強調する価値があります。
フィーチャー定義をSQLステートメントに変換するなどの他の機能は、既存の意見が分かれた抽象化レイヤーではなく、アプリケーションやビジネスロジックの一部としてより大きな柔軟性を提供するかもしれません。

### 推論 {#inference}

モデル推論は、トレーニングされたモデルを実行して出力を受け取るプロセスです。
推論がデータベースアクションによってトリガーされる場合 - 例えば新しいレコードを挿入したり、レコードをクエリしたりする場合 - 推論ステップは特注のジョブやアプリケーションコードを介して管理することができます。

一方で、データレイヤー自体で管理することもできます。ClickHouseの[ユーザー定義関数（UDF）](/sql-reference/functions/udf)は、ユーザーが挿入時またはクエリ時にClickHouseからモデルを直接呼び出す能力を提供します。
これにより、受信データをモデルに渡し、出力を受け取り、これらの結果を取り込んだデータとともに自動的に保存する能力が提供されます - 他のプロセスやジョブを立ち上げる必要はありません。
これにより、このステップを管理するための単一のインターフェースであるSQLが提供されます。

### ベクトルストア {#vector-store}

ベクトルストアは、通常、データの一部（テキストや画像など）の埋め込みを数値的にキャプチャし、その基礎となる意味を捉えるために最適化された特定のタイプのデータベースです。
ベクトルは、現在の生成AIの波の中心にあり、無数のアプリケーションで使用されています。

ベクトルデータベースにおける主な操作は、数学的な測定に基づいて「最も近い」ベクトルを見つけるための「類似性検索」です。
ベクトルデータベースは、この検査 - ベクトル比較 - をできるだけ迅速に行うための特定の戦術を採用しているため人気を博しています。
これらの技術は、一般に、入力ベクトルを保存されたすべてのベクトルと比較するのではなく、ベクトル比較を近似することを意味します。

この新しいクラスのツールの問題は、多くの汎用データベース（ClickHouseを含む）が、標準装備のベクトルサポートを提供し、また、しばしばそれらの近似アプローチの実装を内蔵していることです。
特にClickHouseは、高性能の大規模分析に設計されているため、非常に効果的に非近似ベクトル比較を実行できます。
これは、近似に頼る必要がなく、すべての速度を犠牲にすることなく正確な結果を得ることができることを意味します。

### 可視化性 {#observability}

機械学習アプリケーションが稼働し始めると、モデルの動作、パフォーマンス、改善の可能性のある分野に貴重な洞察を提供するデータ（ログやトレースデータを含む）が生成されます。

SQLベースの可視化性はClickHouseのもう一つの主要なユースケースであり、ClickHouseは代替手段の10-100倍のコスト効率を持つことがわかっています。
実際、多くの可視化製品はClickHouseを基盤として構築されています。
業界屈指の取り込み率と圧縮比を持つClickHouseは、あらゆる規模の機械学習可視化に必要なコスト効率と驚異的な速度を提供します。
