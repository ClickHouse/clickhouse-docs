---
slug: /cloud/data-resiliency
sidebar_label: 'データレジリエンス'
title: '災害復旧'
description: 'このガイドでは、災害復旧の概要を説明します。'
doc_type: 'reference'
keywords: ['ClickHouse Cloud', 'data resiliency', 'disaster recovery']
---

import Image from '@theme/IdealImage';
import restore_backup from '@site/static/images/cloud/guides/restore_backup.png';


# データレジリエンシー {#clickhouse-cloud-data-resiliency}

このページでは、ClickHouse Cloudのディザスタリカバリに関する推奨事項と、障害からの復旧に関するガイダンスを説明します。
ClickHouse Cloudは現在、自動フェイルオーバーや複数の地理的リージョン間での自動同期には対応していません。

:::tip
お客様は、ご利用のサービスのサイズと構成における具体的なRTOを把握するため、定期的にバックアップのリストアテストを実施してください。
:::


## 定義 {#definitions}

まず、いくつかの定義について説明します。

**RPO (Recovery Point Objective)**: 障害発生後に許容される最大データ損失量を時間で測定したもの。例:RPOが30分の場合、障害発生時にデータベースは30分以上前のデータまで復元可能である必要があります。これは当然、バックアップの取得頻度に依存します。

**RTO (Recovery Time Objective)**: 障害発生後、通常運用を再開するまでに許容される最大ダウンタイム。例:RTOが30分の場合、障害発生時にチームは30分以内にデータとアプリケーションを復元し、通常運用を再開できる必要があります。

**データベースバックアップとスナップショット**: バックアップは、データの別コピーを用いた耐久性のある長期ストレージを提供します。スナップショットはデータの追加コピーを作成せず、通常より高速で、より優れたRPOを実現します。


## データベースバックアップ {#database-backups}

プライマリサービスのバックアップを保持することは、プライマリサービスのダウンタイム発生時にバックアップから復元するための効果的な方法です。
ClickHouse Cloudは、バックアップに関して以下の機能をサポートしています。

1. **デフォルトバックアップ**

デフォルトでは、ClickHouse Cloudは24時間ごとにサービスの[バックアップ](/cloud/manage/backups)を取得します。
これらのバックアップはサービスと同じリージョンに保存され、ClickHouse CSP(クラウドサービスプロバイダー)のストレージバケットに格納されます。
プライマリサービスのデータが破損した場合、バックアップを使用して新しいサービスに復元できます。

2. **外部バックアップ(顧客独自のストレージバケット)**

Enterpriseティアのお客様は、自身のアカウント内のオブジェクトストレージに、同じリージョンまたは別のリージョンで[バックアップをエクスポート](/cloud/manage/backups/export-backups-to-own-cloud-account)できます。
クロスクラウドバックアップエクスポートのサポートは近日中に提供予定です。
リージョン間およびクラウド間のバックアップには、該当するデータ転送料金が適用されます。

:::note
この機能は現在、PCI/HIPAAサービスではご利用いただけません
:::

3. **設定可能なバックアップ**

お客様は、RPOを改善するために、最大6時間ごとの高頻度で実行されるよう[バックアップを設定](/cloud/manage/backups/configurable-backups)できます。
また、より長い保持期間を設定することも可能です。

サービスで現在利用可能なバックアップは、ClickHouse Cloudコンソールの「backups」ページに一覧表示されます。
このセクションでは、各バックアップの成功/失敗ステータスも提供されます。


## バックアップからの復元 {#restoring-from-a-backup}

1. ClickHouse Cloudバケット内のデフォルトバックアップは、同一リージョン内の新しいサービスに復元できます。
2. 外部バックアップ(お客様のオブジェクトストレージ内)は、同一リージョンまたは別リージョンの新しいサービスに復元できます。


## バックアップとリストアの所要時間ガイダンス {#backup-and-restore-duration-guidance}

バックアップとリストアの所要時間は、データベースのサイズ、スキーマ、テーブル数など、複数の要因に依存します。

当社のテストでは、約1TBの小規模なバックアップには10〜15分以上かかることが確認されています。
20TB未満のバックアップは通常1時間以内に完了し、約50TBのデータのバックアップには2〜3時間かかります。
バックアップはサイズが大きくなるほど規模の経済が働き、一部の内部サービスでは最大1PBのバックアップが10時間以内に完了することが確認されています。

実際の所要時間は上記のような複数の要因に依存するため、より正確な見積もりを得るには、お客様自身のデータベースまたはサンプルデータでテストすることを推奨します。

リストアの所要時間は、同程度のサイズのバックアップ所要時間と同様です。
前述のとおり、バックアップのリストアにかかる時間を把握するために、お客様自身のデータベースでテストすることを推奨します。

:::note
現在、同一リージョンまたは異なるリージョンにかかわらず、2つのClickHouse Cloudインスタンス間での自動フェイルオーバーはサポートされていません。
現在、同一リージョンまたは異なるリージョンの異なるClickHouse Cloudサービス間でのデータの自動同期(すなわち、アクティブ-アクティブレプリケーション)はサポートされていません。
:::


## 復旧プロセス {#recovery-process}

このセクションでは、各ケースで利用可能な様々な復旧オプションとそのプロセスについて説明します。

### プライマリサービスのデータ破損 {#primary-service-data-corruption}

この場合、データは同じリージョン内の別のサービスにバックアップから[復元できます](/cloud/manage/backups/overview#restore-a-backup)。
デフォルトのバックアップポリシーを使用している場合、バックアップは最大24時間前のものとなり、6時間間隔の設定可能なバックアップを使用している場合は最大6時間前のものとなります。

#### 復元手順 {#restoration-steps}

既存のバックアップから復元するには

<VerticalStepper headerLevel="list">

1. ClickHouse Cloudコンソールの「Backups」セクションに移動します。
2. 復元元とする特定のバックアップの「Actions」列にある三点リーダーをクリックします。
3. 新しいサービスに名前を付け、このバックアップから復元します

<Image img={restore_backup} size='md' alt='バックアップから復元' />

</VerticalStepper>

### プライマリリージョンのダウンタイム {#primary-region-downtime}

Enterprise Tierのお客様は、バックアップを自身のクラウドプロバイダーのバケットに[エクスポートできます](/cloud/manage/backups/export-backups-to-own-cloud-account)。
リージョン障害が懸念される場合は、バックアップを別のリージョンにエクスポートすることを推奨します。
リージョン間のデータ転送料金が発生することにご注意ください。

プライマリリージョンがダウンした場合、別のリージョンにあるバックアップを異なるリージョンの新しいサービスに復元できます。

バックアップが別のサービスに復元されたら、DNS、ロードバランサー、または接続文字列の設定が新しいサービスを参照するように更新されていることを確認する必要があります。
これには以下が含まれる場合があります:

- 環境変数またはシークレットの更新
- 新しい接続を確立するためのアプリケーションサービスの再起動

:::note
外部バケットへのバックアップ/復元は、現在[透過的データ暗号化(TDE)](/cloud/security/cmek#transparent-data-encryption-tde)を利用しているサービスではサポートされていません。
:::


## 追加オプション {#additional-options}

検討すべき追加オプションがいくつかあります。

1. **別々のクラスタへのデュアル書き込み**

このオプションでは、異なるリージョンに2つの独立したクラスタをセットアップし、両方にデュアル書き込みを行います。
このオプションは複数のサービスを実行する必要があるため、本質的にコストが高くなりますが、1つのリージョンが利用不可になった場合でも高可用性を提供します。

2. **CSPレプリケーションの活用**

このオプションでは、クラウドサービスプロバイダのネイティブなオブジェクトストレージレプリケーションを利用してデータをコピーします。
例えば、BYOBを使用する場合、プライマリリージョンで所有するバケットにバックアップをエクスポートし、[AWSクロスリージョンレプリケーション](https://docs.aws.amazon.com/AmazonS3/latest/userguide/replication.html)を使用して別のリージョンにレプリケートできます。
