---
sidebar_position: 1
sidebar_label: 'Make Before Break (MBB)'
slug: /cloud/features/mbb
description: 'ClickHouse Cloud における Make Before Break (MBB) オペレーションについて説明するページ'
keywords: ['Make Before Break', 'MBB', 'Scaling', 'ClickHouse Cloud']
title: 'ClickHouse Cloud における Make Before Break (MBB) オペレーション'
doc_type: 'guide'
---

import Image from '@theme/IdealImage';
import mbb_diagram from '@site/static/images/cloud/features/mbb/vertical_scaling.png';

ClickHouse Cloud は、クラスターのアップグレードおよびクラスターのスケーリングを行う際に、**Make Before Break** (MBB) 方式を採用しています。
この方式では、古いレプリカをクラスターから削除する前に、新しいレプリカをクラスターに追加します。
これは、先に古いレプリカを削除してから新しいレプリカを追加する break-first 方式とは対照的です。

MBB 方式には、いくつかの利点があります。

* 容量を削減する前にクラスターへ追加するため、break-first 方式とは異なり、**クラスター全体の容量が低下しません**。もちろん、クラウド環境ではノード障害やディスク障害などの予期しない事象は依然として発生し得ます。
* この方式は、クラスターに高い負荷がかかっている状況で特に有用です。break-first 方式で起こり得るような、**既存レプリカへの過負荷を防ぐ**ことができます。
* 先にレプリカ削除の完了を待つ必要がなく、レプリカを迅速に追加できるため、より**高速で応答性の高い**スケーリングを実現できます。

以下の画像は、3 つのレプリカを持つクラスターを垂直スケーリングした場合に、どのような動作になるかを示しています。

<Image img={mbb_diagram} size="lg" alt="3 つのレプリカを持つクラスターが垂直スケーリングされる例の図" />

全体として、MBB は、以前利用されていた break-first 方式と比べて、よりシームレスで影響の少ないスケーリングおよびアップグレードを可能にします。

MBB を利用する場合、ユーザーが理解しておくべき重要な挙動がいくつかあります。

1. MBB 操作では、現在のレプリカ上で実行中の既存ワークロードが終了するのを待ってから、そのレプリカを停止します。
   この待機時間は現在 1 時間に設定されており、スケーリングやアップグレードは、レプリカ上で実行中の長時間クエリが終了するのを、最大 1 時間まで待機する可能性があります。
   さらに、バックアップ処理がレプリカ上で実行中の場合、そのバックアップが完了するまでレプリカは停止されません。
2. レプリカを停止するまで待機時間があるため、クラスターに設定されている最大レプリカ数を一時的に超える場合があります。
   たとえば、合計 6 個のレプリカを持つサービスがあるとして、MBB 操作が進行中の場合、新たに 3 個のレプリカがクラスターに追加され、古いレプリカがクエリ処理を続けている間、一時的に合計 9 個のレプリカになることがあります。
   つまり、ある一定期間、クラスターは希望するレプリカ数を超える状態になります。
   さらに、複数の MBB 操作が互いに重なり合い、レプリカが蓄積される可能性もあります。これはたとえば、API 経由で複数の垂直スケーリング要求がクラスターに送信されるようなシナリオで発生し得ます。
   ClickHouse Cloud には、クラスターに蓄積し得るレプリカ数を制限するためのチェック機構が用意されています。
3. MBB 操作では、`system` テーブルのデータは 30 日間保持されます。これは、クラスター上で MBB 操作が発生するたびに、30 日分の `system` テーブルのデータが古いレプリカから新しいレプリカへ複製されることを意味します。

MBB 操作の仕組みについてさらに詳しく知りたい場合は、ClickHouse エンジニアリングチームによる[こちらのブログ記事](https://clickhouse.com/blog/make-before-break-faster-scaling-mechanics-for-clickhouse-cloud)を参照してください。
