---
sidebar_position: 1
sidebar_label: 'Make Before Break (MBB)'
slug: /cloud/features/mbb
description: 'ClickHouse Cloud における Make Before Break (MBB) 操作について説明するページ'
keywords: ['Make Before Break', 'MBB', 'スケーリング', 'ClickHouse Cloud']
title: 'ClickHouse Cloud における Make Before Break (MBB) 操作'
doc_type: 'guide'
---

import Image from '@theme/IdealImage';
import mbb_diagram from '@site/static/images/cloud/features/mbb/vertical_scaling.png';

ClickHouse Cloud は、クラスターのアップグレードおよびスケーリングを行う際に、**Make Before Break** (MBB) アプローチを採用しています。
このアプローチでは、既存のレプリカを削除する前に、新しいレプリカをクラスターに追加します。
これは、先に既存レプリカを削除してから新しいレプリカを追加する break-first アプローチとは対照的です。

MBB アプローチには、いくつかの利点があります。

* 容量を削減する前にクラスターへ追加するため、break-first アプローチとは異なり、**クラスター全体の容量が低下しません**。もちろん、クラウド環境ではノードやディスク障害などの予期しないイベントが発生する可能性は依然としてあります。
* このアプローチは、クラスターに高負荷がかかっている状況で特に有用です。break-first アプローチで起こりうるような、**既存レプリカへの過負荷を防止**できるためです。
* 先にレプリカの削除を待つ必要なくレプリカをすばやく追加できるため、**より高速で応答性の高い**スケーリングを実現できます。

以下の図は、3 つのレプリカを持つクラスターが垂直スケーリングされる場合に、どのように動作するかを示しています。

<Image img={mbb_diagram} size="lg" alt="3 つのレプリカを持つクラスターが垂直スケーリングされる場合の例示図" />

全体として、MBB は、従来利用されていた break-first アプローチと比べて、よりシームレスで影響の少ないスケーリングおよびアップグレード体験を提供します。

MBB では、ユーザーが把握しておく必要のある重要な挙動がいくつかあります。

1. MBB オペレーションでは、既存のワークロードが現在のレプリカ上で終了するのを待ってから、そのレプリカを停止します。
   この待機時間は現在 1 時間に設定されており、つまり、レプリカが削除される前に、そのレプリカ上で実行中の長時間クエリが最大 1 時間完了するのを待ってから、スケーリングやアップグレード処理が進行します。
   さらに、バックアップ処理がレプリカ上で実行中の場合、そのレプリカが停止される前にバックアップの完了を待ちます。
2. レプリカが停止される前に待機時間が存在するため、クラスター内のレプリカ数が、そのクラスターに設定された最大レプリカ数を一時的に上回る状況が発生する可能性があります。
   たとえば、合計 6 レプリカのサービスがあり、MBB オペレーションが進行中の場合、新たに 3 レプリカがクラスターに追加され、古いレプリカが引き続きクエリを処理している間、合計 9 レプリカとなることがあります。
   これは、一定期間、クラスターが意図したレプリカ数よりも多くのレプリカを持つことを意味します。
   さらに、複数の MBB オペレーションが互いに重なり合うことで、レプリカが累積する可能性があります。これは、たとえば API 経由で複数の垂直スケーリング要求がクラスターに送信されるシナリオなどで発生しえます。
   ClickHouse Cloud では、クラスターに累積しうるレプリカ数を制限するためのチェックが実装されています。
3. MBB オペレーションでは、`system` テーブルのデータは 30 日間保持されます。これは、クラスターで MBB オペレーションが行われるたびに、30 日分の `system` テーブルのデータが古いレプリカから新しいレプリカへレプリケートされることを意味します。

MBB オペレーションのメカニズムについてさらに詳しく知りたい場合は、ClickHouse エンジニアリングチームによるこちらの[ブログ記事](https://clickhouse.com/blog/make-before-break-faster-scaling-mechanics-for-clickhouse-cloud)をご覧ください。
