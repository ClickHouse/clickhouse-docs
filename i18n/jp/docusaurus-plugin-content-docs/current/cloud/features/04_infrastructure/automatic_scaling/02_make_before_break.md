---
sidebar_position: 1
sidebar_label: 'Make Before Break (MBB)'
slug: /cloud/features/mbb
description: 'ClickHouse Cloud における Make Before Break (MBB) オペレーションについて説明するページ'
keywords: ['Make Before Break', 'MBB', 'Scaling', 'ClickHouse Cloud']
title: 'ClickHouse Cloud における Make Before Break (MBB) オペレーション'
doc_type: 'guide'
---

import Image from '@theme/IdealImage';
import mbb_diagram from '@site/static/images/cloud/features/mbb/vertical_scaling.png';

ClickHouse Cloud は、クラスタのアップグレードおよびスケーリングを行う際に、**Make Before Break** (MBB) 方式を採用しています。
この方式では、既存のレプリカをクラスタから削除する前に、新しいレプリカをクラスタに追加します。
これは、先に既存レプリカを削除してから新しいレプリカを追加する break-first 方式とは対照的です。

MBB 方式には、いくつかの利点があります:

* 容量は削除前にクラスタへ追加されるため、break-first 方式とは異なり、**クラスタ全体の容量が低下しません**。もちろん、クラウド環境ではノードやディスク障害などの予期しない事象が発生する可能性は依然としてあります。
* この方式は、クラスタに高い負荷がかかっている状況で特に有効です。break-first 方式で発生し得るような、**既存レプリカへの過負荷を防止**できるためです。
* レプリカを先に削除するのを待たずにすばやく追加できるため、この方式により、**より高速で応答性の高い**スケーリングを行うことができます。

以下の図は、3 つのレプリカを持つクラスタが垂直スケーリングされる場合に、これがどのように行われるかを示しています:

<Image img={mbb_diagram} size="lg" alt="3 つのレプリカを持つクラスタが垂直スケーリングされる例の図" />

全体として、MBB は、以前利用されていた break-first 方式と比較して、よりシームレスで影響の少ないスケーリングおよびアップグレードを実現します。

MBB では、ユーザーが把握しておくべき重要な挙動がいくつかあります:

1. MBB オペレーションは、現在のレプリカ上で実行中の既存ワークロードが終了するまで、そのレプリカを終了しません。
   この待機時間は現在 1 時間に設定されており、つまり、スケーリングやアップグレードは、レプリカが削除される前に、そのレプリカ上で実行中の長時間クエリが完了するまで最長 1 時間待機する可能性があります。
   さらに、レプリカ上でバックアップ処理が実行されている場合、そのレプリカは処理が完了するまで残されてから終了されます。
2. レプリカが終了される前に待機時間があるため、クラスタが、そのクラスタに設定された最大レプリカ数を一時的に上回る状況が発生する可能性があります。
   たとえば、合計 6 個のレプリカを持つサービスがあり、MBB オペレーションが進行中の場合、新たに 3 個のレプリカがクラスタに追加され、古いレプリカが引き続きクエリを処理している間、合計 9 個のレプリカとなることがあります。
   これは、一定期間、クラスタが希望するレプリカ数を上回ることを意味します。
   さらに、複数の MBB オペレーション自体が重なり合い、レプリカが蓄積することがあります。これは、たとえば API 経由で複数の垂直スケーリング要求がクラスタに送信されるシナリオなどで発生し得ます。
   ClickHouse Cloud には、クラスタが蓄積し得るレプリカの数を制限するためのチェックが用意されています。
3. MBB オペレーションでは、system テーブルのデータは 30 日間保持されます。これは、クラスタで MBB オペレーションが発生するたびに、30 日分の system テーブルデータが古いレプリカから新しいレプリカへレプリケートされることを意味します。

MBB オペレーションの仕組みについてさらに詳しく知りたい場合は、ClickHouse エンジニアリングチームによるこの[ブログ記事](https://clickhouse.com/blog/make-before-break-faster-scaling-mechanics-for-clickhouse-cloud)をご覧ください。
