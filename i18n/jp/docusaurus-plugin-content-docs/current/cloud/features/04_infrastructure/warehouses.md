---
title: 'ウェアハウス'
slug: /cloud/reference/warehouses
keywords: ['compute separation', 'cloud', 'architecture', 'compute-compute', 'warehouse', 'warehouses', 'hydra']
description: 'ClickHouse Cloud におけるコンピュートの分離'
doc_type: 'reference'
---

import compute_1 from '@site/static/images/cloud/reference/compute-compute-1.png';
import compute_2 from '@site/static/images/cloud/reference/compute-compute-2.png';
import compute_3 from '@site/static/images/cloud/reference/compute-compute-3.png';
import compute_4 from '@site/static/images/cloud/reference/compute-compute-4.png';
import compute_5 from '@site/static/images/cloud/reference/compute-compute-5.png';
import compute_7 from '@site/static/images/cloud/reference/compute-compute-7.png';
import compute_8 from '@site/static/images/cloud/reference/compute-compute-8.png';
import Image from '@theme/IdealImage';


# ウェアハウス



## コンピュート-コンピュート分離とは？ {#what-is-compute-compute-separation}

コンピュート-コンピュート分離は、ScaleおよびEnterpriseティアで利用可能です。

各ClickHouse Cloudサービスには以下が含まれます：

- 2つ以上のClickHouseノード（またはレプリカ）のグループが必要ですが、子サービスは単一レプリカにすることができます。
- エンドポイント（またはClickHouse Cloud UIコンソールから作成された複数のエンドポイント）。これはサービスに接続するために使用するサービスURLです（例：`https://dv2fzne24g.us-east-1.aws.clickhouse.cloud:8443`）。
- サービスがすべてのデータと一部のメタデータを保存するオブジェクトストレージフォルダ：

:::note
子の単一サービスは、親の単一サービスとは異なり、垂直スケーリングが可能です。
:::

<Image img={compute_1} size='md' alt='ClickHouse Cloudの現在のサービス' />

<br />

_図1 - ClickHouse Cloudの現在のサービス_

コンピュート-コンピュート分離により、ユーザーは複数のコンピュートノードグループを作成できます。各グループは独自のエンドポイントを持ち、同じオブジェクトストレージフォルダを使用するため、同じテーブル、ビューなどを共有します。

各コンピュートノードグループは独自のエンドポイントを持つため、ワークロードに使用するレプリカのセットを選択できます。一部のワークロードは小規模な単一レプリカで十分な場合もあれば、完全な高可用性（HA）と数百ギガバイトのメモリを必要とする場合もあります。コンピュート-コンピュート分離により、読み取り操作と書き込み操作を分離して、互いに干渉しないようにすることもできます：

<Image img={compute_2} size='md' alt='ClickHouse Cloudのコンピュート分離' />

<br />

_図2 - ClickHouse Cloudのコンピュート分離_

既存のサービスと同じデータを共有する追加のサービスを作成することも、同じデータを共有する複数のサービスを持つ完全に新しいセットアップを作成することも可能です。


## ウェアハウスとは？ {#what-is-a-warehouse}

ClickHouse Cloudにおいて、_ウェアハウス_とは同じデータを共有する一連のサービスの集合です。
各ウェアハウスには、プライマリサービス（最初に作成されたサービス）とセカンダリサービスがあります。例えば、以下のスクリーンショットでは、2つのサービスを持つウェアハウス「DWH Prod」を確認できます：

- プライマリサービス `DWH Prod`
- セカンダリサービス `DWH Prod Subservice`

<Image
  img={compute_8}
  size='lg'
  alt='プライマリサービスとセカンダリサービスを持つウェアハウスの例'
  background='white'
/>

<br />

_図3 - ウェアハウスの例_

ウェアハウス内のすべてのサービスは、以下を共有します：

- リージョン（例：us-east1）
- クラウドサービスプロバイダー（AWS、GCP、またはAzure）
- ClickHouseデータベースバージョン

サービスは、所属するウェアハウスごとにソートできます。


## アクセス制御 {#access-controls}

### データベース認証情報 {#database-credentials}

ウェアハウス内のすべてのサービスは同じテーブルセットを共有するため、それらのサービスへのアクセス制御も共有されます。つまり、Service 1で作成されたすべてのデータベースユーザーは、同じ権限（テーブル、ビューなどへのGRANT権限）でService 2も使用でき、その逆も同様です。ユーザーは各サービスに対して異なるエンドポイントを使用しますが、同じユーザー名とパスワードを使用します。言い換えれば、_同じストレージを使用するサービス間でユーザーは共有されます：_

<Image
  img={compute_3}
  size='md'
  alt='同じデータを共有するサービス間でのユーザーアクセス'
/>

<br />

_図4 - ユーザーAliceはService 1で作成されましたが、同じ認証情報を使用して同じデータを共有するすべてのサービスにアクセスできます_

### ネットワークアクセス制御 {#network-access-control}

特定のサービスを他のアプリケーションやアドホックユーザーによる使用から制限することが有用な場合があります。これは、通常のサービスで現在設定されているのと同様に、ネットワーク制限を使用して実現できます（ClickHouse Cloudコンソールの特定のサービスのサービスタブで**Settings**に移動します）。

各サービスに個別にIPフィルタリング設定を適用できます。つまり、どのアプリケーションがどのサービスにアクセスできるかを制御できます。これにより、ユーザーによる特定のサービスの使用を制限できます：

<Image img={compute_4} size='md' alt='ネットワークアクセス制御設定' />

<br />

_図5 - Aliceはネットワーク設定によりService 2へのアクセスが制限されています_

### 読み取り専用と読み書き {#read-vs-read-write}

特定のサービスへの書き込みアクセスを制限し、ウェアハウス内の一部のサービスのみに書き込みを許可することが有用な場合があります。これは、2番目以降のサービスを作成する際に設定できます（最初のサービスは常に読み書き可能である必要があります）：

<Image
  img={compute_5}
  size='lg'
  alt='ウェアハウス内の読み書き可能サービスと読み取り専用サービス'
/>

<br />

_図6 - ウェアハウス内の読み書き可能サービスと読み取り専用サービス_

:::note

1. 読み取り専用サービスは現在、ユーザー管理操作（作成、削除など）を許可しています。この動作は将来変更される可能性があります。
2. 現在、更新可能なマテリアライズドビューは、読み取り専用サービスを含むウェアハウス内のすべてのサービスで実行されます。ただし、この動作は将来変更され、読み書き可能サービスでのみ実行されるようになります。
   :::


## スケーリング {#scaling}

ウェアハウス内の各サービスは、ワークロードに応じて以下の項目を調整できます：

- ノード数（レプリカ数）。プライマリサービス（ウェアハウスで最初に作成されたサービス）は2つ以上のノードが必要です。セカンダリサービスは1つ以上のノードを設定できます。
- ノードのサイズ（レプリカのサイズ）
- サービスの自動スケーリングの有効化
- 非アクティブ時のサービスのアイドル化（グループ内の最初のサービスには適用できません。詳細は**制限事項**セクションを参照してください）


## 動作の変更 {#changes-in-behavior}

サービスに対してコンピュート間接続が有効化されると（少なくとも1つのセカンダリサービスが作成された場合）、`default`クラスタ名を指定した`clusterAllReplicas()`関数の呼び出しは、その関数が呼び出されたサービスのレプリカのみを使用するようになります。つまり、同じデータセットに接続された2つのサービスが存在し、サービス1から`clusterAllReplicas(default, system, processes)`が呼び出された場合、サービス1で実行中のプロセスのみが表示されます。必要に応じて、すべてのレプリカにアクセスするには、例えば`clusterAllReplicas('all_groups.default', system, processes)`を呼び出すことができます。


## 制限事項 {#limitations}

1. **プライマリサービスは常に稼働している必要があり、アイドル状態にできません(この制限はGA後に解除される予定です)。** プライベートプレビュー期間中およびGA後しばらくの間、プライマリサービス(通常は他のサービスを追加して拡張する既存のサービス)は常に稼働状態となり、アイドル設定は無効化されます。セカンダリサービスが1つでも存在する場合、プライマリサービスを停止またはアイドル状態にすることはできません。すべてのセカンダリサービスを削除すると、元のサービスを再び停止またはアイドル状態にできるようになります。

2. **ワークロードを分離できない場合があります。** データベースワークロードを相互に分離するオプションを提供することが目標ですが、同じデータを共有する別のサービスに、あるサービスのワークロードが影響を与えるケースが存在する可能性があります。これらは主にOLTP型のワークロードに関連する非常にまれな状況です。

3. **すべての読み書きサービスはバックグラウンドマージ操作を実行します。** ClickHouseにデータを挿入する際、データベースはまずステージングパーティションにデータを挿入し、その後バックグラウンドでマージを実行します。これらのマージはメモリとCPUリソースを消費します。2つの読み書きサービスが同じストレージを共有している場合、両方がバックグラウンド操作を実行します。つまり、サービス1で`INSERT`クエリが実行されても、マージ操作はサービス2によって完了される場合があります。なお、読み取り専用サービスはバックグラウンドマージを実行しないため、この操作にリソースを消費しません。

4. **すべての読み書きサービスはS3Queueテーブルエンジンの挿入操作を実行します。** RWサービス上でS3Queueテーブルを作成すると、ウェアハウス内の他のすべてのRWサービスがS3からのデータ読み取りとデータベースへのデータ書き込みを実行する可能性があります。

5. **ある読み書きサービスでの挿入により、アイドル機能が有効な場合、別の読み書きサービスのアイドル状態への移行が妨げられる可能性があります。** その結果、2番目のサービスが1番目のサービスのバックグラウンドマージ操作を実行します。これらのバックグラウンド操作により、2番目のサービスがアイドル時にスリープ状態に移行できない場合があります。バックグラウンド操作が完了すると、サービスはアイドル状態になります。読み取り専用サービスは影響を受けず、遅延なくアイドル状態になります。

6. **CREATE/RENAME/DROP DATABASEクエリは、デフォルトでアイドル状態または停止中のサービスによってブロックされる可能性があります。** これらのクエリはハングする可能性があります。これを回避するには、セッションレベルまたはクエリごとに`settings distributed_ddl_task_timeout=0`を指定してデータベース管理クエリを実行します。例:

```sql
CREATE DATABASE db_test_ddl_single_query_setting
SETTINGS distributed_ddl_task_timeout=0
```

7. **現在、ウェアハウスあたり5サービスのソフトリミットがあります。** 単一のウェアハウスで5つ以上のサービスが必要な場合は、サポートチームにお問い合わせください。


## 料金 {#pricing}

ウェアハウス内のすべてのサービス(プライマリおよびセカンダリ)において、コンピュートの料金は同一です。ストレージは一度のみ課金され、最初(オリジナル)のサービスに含まれます。

ワークロードのサイズと選択したティアに基づいてコストを見積もるには、[料金](https://clickhouse.com/pricing)ページの料金計算ツールをご参照ください。


## バックアップ {#backups}

- 単一のウェアハウス内のすべてのサービスは同じストレージを共有するため、バックアップはプライマリ(初期)サービスでのみ作成されます。これにより、ウェアハウス内のすべてのサービスのデータがバックアップされます。
- ウェアハウスのプライマリサービスからバックアップを復元すると、既存のウェアハウスに接続されていない完全に新しいサービスとして復元されます。復元完了後、すぐに新しいサービスへ追加のサービスを追加できます。


## ウェアハウスの使用 {#using-warehouses}

### ウェアハウスの作成 {#creating-a-warehouse}

ウェアハウスを作成するには、既存のサービスとデータを共有する2つ目のサービスを作成する必要があります。既存のサービスのプラス記号をクリックすることで作成できます:

<Image
  img={compute_7}
  size='md'
  alt='ウェアハウス内に新しいサービスを作成'
  border
  background='white'
/>

<br />

_図7 - プラス記号をクリックしてウェアハウス内に新しいサービスを作成_

サービス作成画面では、元のサービスがドロップダウンで新しいサービスのデータソースとして選択されます。作成後、これら2つのサービスでウェアハウスが構成されます。

### ウェアハウスの名前変更 {#renaming-a-warehouse}

ウェアハウスの名前を変更する方法は2つあります:

- サービスページの右上にある「ウェアハウスで並べ替え」を選択し、ウェアハウス名の横にある鉛筆アイコンをクリックする
- いずれかのサービスでウェアハウス名をクリックし、そこで名前を変更する

### ウェアハウスの削除 {#deleting-a-warehouse}

ウェアハウスを削除すると、すべてのコンピュートサービスとデータ(テーブル、ビュー、ユーザーなど)が削除されます。この操作は取り消すことができません。
ウェアハウスを削除するには、最初に作成されたサービスを削除する必要があります。手順は以下の通りです:

1. 最初に作成されたサービス以外に作成されたすべてのサービスを削除する
2. 最初のサービスを削除する(警告: このステップですべてのウェアハウスのデータが削除されます)
