---
description: 'ClickHouse のテストおよびテストスイート実行のガイド'
sidebar_label: 'テスト'
sidebar_position: 40
slug: /development/tests
title: 'ClickHouse のテスト'
doc_type: 'guide'
---



# ClickHouse のテスト



## 機能テスト {#functional-tests}

機能テストは最もシンプルで使いやすいテスト手法です。
ClickHouseの機能の大部分は機能テストでテスト可能であり、この方法でテストできるClickHouseコードの変更には必ず使用する必要があります。

各機能テストは、実行中のClickHouseサーバーに1つまたは複数のクエリを送信し、その結果をリファレンスと比較します。

テストは`./tests/queries`ディレクトリに配置されています。

各テストは`.sql`と`.sh`の2つのタイプのいずれかになります。

- `.sql`テストは`clickhouse-client`にパイプされるシンプルなSQLスクリプトです。
- `.sh`テストは単独で実行されるスクリプトです。

一般的にSQLテストは`.sh`テストよりも推奨されます。
`.sh`テストは、`clickhouse-client`への入力データのパイプや`clickhouse-local`のテストなど、純粋なSQLでは実行できない機能をテストする必要がある場合にのみ使用してください。

:::note
データ型`DateTime`および`DateTime64`をテストする際によくある間違いは、サーバーが特定のタイムゾーン(例:「UTC」)を使用していると仮定することです。実際にはそうではなく、CIテスト実行におけるタイムゾーンは意図的にランダム化されています。最も簡単な回避策は、テスト値のタイムゾーンを明示的に指定することです。例:`toDateTime64(val, 3, 'Europe/Amsterdam')`
:::

### ローカルでのテスト実行 {#running-a-test-locally}

ClickHouseサーバーをローカルで起動し、デフォルトポート(9000)でリッスンさせます。
例えば、テスト`01428_hash_set_nan_key`を実行するには、リポジトリフォルダに移動して次のコマンドを実行します:

```sh
PATH=<path to clickhouse-client>:$PATH tests/clickhouse-test 01428_hash_set_nan_key
```

テスト結果(`stderr`および`stdout`)は、テスト自体の隣に配置される`01428_hash_set_nan_key.[stderr|stdout]`ファイルに書き込まれます(`queries/0_stateless/foo.sql`の場合、出力は`queries/0_stateless/foo.stdout`に格納されます)。

`clickhouse-test`のすべてのオプションについては`tests/clickhouse-test --help`を参照してください。
すべてのテストを実行するか、テスト名のフィルタを指定してテストのサブセットを実行できます:`./clickhouse-test substring`
テストを並列実行またはランダムな順序で実行するオプションもあります。

### 新しいテストの追加 {#adding-a-new-test}

新しいテストを追加するには、まず`queries/0_stateless`ディレクトリに`.sql`または`.sh`ファイルを作成します。
次に、`clickhouse-client < 12345_test.sql > 12345_test.reference`または`./12345_test.sh > ./12345_test.reference`を使用して対応する`.reference`ファイルを生成します。

テストは、事前に自動的に作成されるデータベース`test`内のテーブルに対してのみ作成、削除、選択などを行う必要があります。
一時テーブルの使用は問題ありません。

ローカルでCI環境と同じ環境を構築するには、テスト設定をインストールします(Zookeeperのモック実装を使用し、いくつかの設定を調整します)

```sh
cd <repository>/tests/config
sudo ./install.sh
```

:::note
テストは以下の条件を満たす必要があります:

- 最小限であること:必要最小限のテーブル、カラム、複雑さのみを作成する
- 高速であること:数秒以内(理想的にはサブ秒)で完了する
- 正確かつ決定的であること:テスト対象の機能が動作していない場合にのみ失敗する
- 独立/ステートレスであること:環境やタイミングに依存しない
- 網羅的であること:ゼロ、null、空のセット、例外などのコーナーケースをカバーする(ネガティブテストには`-- { serverError xyz }`および`-- { clientError xyz }`構文を使用)
- テスト終了時にテーブルをクリーンアップする(残存物がある場合)
- 他のテストが同じ内容をテストしていないことを確認する(つまり、最初にgrepで検索する)
  :::

### テスト実行の制限 {#restricting-test-runs}

テストには、CI内でテストが実行されるコンテキストの制限を指定する0個以上の_タグ_を設定できます。

`.sql`テストの場合、タグは最初の行にSQLコメントとして配置されます:

```sql
-- Tags: no-fasttest, no-replicated-database
-- no-fasttest: <ここにタグの理由を記載>
-- no-replicated-database: <ここに理由を記載>

SELECT 1
```

`.sh`テストの場合、タグは2行目にコメントとして記述されます:


```bash
#!/usr/bin/env bash
# Tags: no-fasttest, no-replicated-database
# - no-fasttest: <タグの理由をここに記載>
# - no-replicated-database: <理由をここに記載>
```

利用可能なタグ一覧:

| タグ名                          | 機能                                                            | 使用例                                                 |
| --------------------------------- | ----------------------------------------------------------------------- | ------------------------------------------------------------- |
| `disabled`                        | テストを実行しない                                                         |                                                               |
| `long`                            | テストの実行時間を1分から10分に延長                  |                                                               |
| `deadlock`                        | テストを長時間ループで実行                                   |                                                               |
| `race`                            | `deadlock`と同じ。`deadlock`を推奨                                   |                                                               |
| `shard`                           | サーバーが`127.0.0.*`をリッスンする必要がある                             |                                                               |
| `distributed`                     | `shard`と同じ。`shard`を推奨                                         |                                                               |
| `global`                          | `shard`と同じ。`shard`を推奨                                         |                                                               |
| `zookeeper`                       | テストの実行にZookeeperまたはClickHouse Keeperが必要                     | テストで`ReplicatedMergeTree`を使用                               |
| `replica`                         | `zookeeper`と同じ。`zookeeper`を推奨                                 |                                                               |
| `no-fasttest`                     | [Fast test](continuous-integration.md#fast-test)ではテストを実行しない  | テストでFast testで無効化されている`MySQL`テーブルエンジンを使用 |
| `fasttest-only`                   | [Fast test](continuous-integration.md#fast-test)でのみテストを実行 |                                                               |
| `no-[asan, tsan, msan, ubsan]`    | [sanitizers](#sanitizers)を使用したビルドでテストを無効化                  | テストはsanitizersと互換性のないQEMU上で実行     |
| `no-replicated-database`          |                                                                         |                                                               |
| `no-ordinary-database`            |                                                                         |                                                               |
| `no-parallel`                     | このテストと並行して他のテストを実行しない                  | テストが`system`テーブルから読み取りを行い、不変条件が破られる可能性がある  |
| `no-parallel-replicas`            |                                                                         |                                                               |
| `no-debug`                        |                                                                         |                                                               |
| `no-stress`                       |                                                                         |                                                               |
| `no-polymorphic-parts`            |                                                                         |                                                               |
| `no-random-settings`              |                                                                         |                                                               |
| `no-random-merge-tree-settings`   |                                                                         |                                                               |
| `no-backward-compatibility-check` |                                                                         |                                                               |
| `no-cpu-x86_64`                   |                                                                         |                                                               |
| `no-cpu-aarch64`                  |                                                                         |                                                               |
| `no-cpu-ppc64le`                  |                                                                         |                                                               |
| `no-s3-storage`                   |                                                                         |                                                               |

上記の設定に加えて、`system.build_options`の`USE_*`フラグを使用して、特定のClickHouse機能の使用を定義できます。
例えば、テストでMySQLテーブルを使用する場合は、`use-mysql`タグを追加してください。

### ランダム設定の制限の指定 {#specifying-limits-for-random-settings}

テストでは、テスト実行中にランダム化される可能性のある設定に対して、許容される最小値と最大値を指定できます。

`.sh`テストの場合、制限はタグの隣の行にコメントとして記述します。タグが指定されていない場合は2行目に記述します:


```bash
#!/usr/bin/env bash
# Tags: no-fasttest
# ランダム設定の制限: max_block_size=(1000, 10000); index_granularity=(100, None)
```

`.sql`テストの場合、タグはタグの次の行または最初の行にSQLコメントとして配置されます:

```sql
-- Tags: no-fasttest
-- ランダム設定の制限: max_block_size=(1000, 10000); index_granularity=(100, None)
SELECT 1
```

1つの制限のみを指定する必要がある場合は、もう一方に`None`を使用できます。

### テスト名の選択 {#choosing-the-test-name}

テスト名は5桁の接頭辞で始まり、その後に`00422_hash_function_constexpr.sql`のような説明的な名前が続きます。
接頭辞を選択するには、ディレクトリ内に既に存在する最大の接頭辞を見つけて、それを1つ増やします。

```sh
ls tests/queries/0_stateless/[0-9]*.reference | tail -n 1
```

その間に、同じ数値接頭辞を持つ他のテストが追加される可能性がありますが、これは問題なく、何の支障も生じません。後で変更する必要はありません。

### 発生すべきエラーの確認 {#checking-for-an-error-that-must-occur}

不正なクエリに対してサーバーエラーが発生することをテストしたい場合があります。SQLテストでは、次の形式で特別なアノテーションをサポートしています:

```sql
SELECT x; -- { serverError 49 }
```

このテストは、サーバーが未知の列`x`に関するコード49のエラーを返すことを保証します。
エラーがない場合、またはエラーが異なる場合、テストは失敗します。
クライアント側でエラーが発生することを保証したい場合は、代わりに`clientError`アノテーションを使用してください。

エラーメッセージの特定の文言を確認しないでください。将来変更される可能性があり、テストが不必要に失敗する原因となります。
エラーコードのみを確認してください。
既存のエラーコードがニーズに対して十分に正確でない場合は、新しいコードの追加を検討してください。

### 分散クエリのテスト {#testing-a-distributed-query}

機能テストで分散クエリを使用したい場合は、サーバーが自身にクエリを実行するために`127.0.0.{1..2}`アドレスを持つ`remote`テーブル関数を活用できます。または、`test_shard_localhost`のようなサーバー設定ファイル内の事前定義されたテストクラスターを使用できます。
テスト名に`shard`または`distributed`という単語を追加することを忘れないでください。そうすることで、サーバーが分散クエリをサポートするように設定されている正しい構成でCIで実行されます。

### 一時ファイルの操作 {#working-with-temporary-files}

シェルテストでは、作業するためにその場でファイルを作成する必要がある場合があります。
一部のCIチェックはテストを並列で実行するため、スクリプト内で一意の名前なしで一時ファイルを作成または削除すると、Flakyなどの一部のCIチェックが失敗する可能性があることに注意してください。
これを回避するには、環境変数`$CLICKHOUSE_TEST_UNIQUE_NAME`を使用して、実行中のテストに固有の名前を一時ファイルに付ける必要があります。
そうすることで、セットアップ中に作成またはクリーンアップ中に削除するファイルが、そのテストのみで使用されているファイルであり、並列で実行されている他のテストのファイルではないことを確認できます。


## 既知のバグ {#known-bugs}

機能テストで容易に再現できるバグが判明している場合、用意した機能テストを `tests/queries/bugs` ディレクトリに配置します。
これらのテストは、バグ修正後に `tests/queries/0_stateless` へ移動されます。


## 統合テスト {#integration-tests}

統合テストでは、クラスタ構成でのClickHouseのテスト、およびMySQL、Postgres、MongoDBなどの他のサーバーとのClickHouseの連携をテストできます。
これらは、ネットワーク分断やパケットドロップなどをエミュレートするのに有用です。
これらのテストはDocker上で実行され、さまざまなソフトウェアを含む複数のコンテナを作成します。

これらのテストの実行方法については、`tests/integration/README.md`を参照してください。

なお、サードパーティドライバーとのClickHouseの統合はテストされていません。
また、現在、JDBCおよびODBCドライバーとの統合テストは実施していません。


## ユニットテスト {#unit-tests}

ユニットテストは、ClickHouse全体ではなく、個別のライブラリやクラスをテストする際に有用です。
テストのビルドは、`ENABLE_TESTS` CMakeオプションで有効化または無効化できます。
ユニットテスト(およびその他のテストプログラム)は、コードベース全体の`tests`サブディレクトリに配置されています。
ユニットテストを実行するには、`ninja test`と入力してください。
一部のテストは`gtest`を使用していますが、テスト失敗時に非ゼロの終了コードを返すだけのプログラムもあります。

コードが既に機能テストでカバーされている場合、ユニットテストは必須ではありません(機能テストの方が通常、使用が簡単です)。

実行可能ファイルを直接呼び出すことで、個別のgtestチェックを実行できます。例:

```bash
$ ./src/unit_tests_dbms --gtest_filter=LocalAddress*
```


## パフォーマンステスト {#performance-tests}

パフォーマンステストは、合成クエリを使用してClickHouseの特定部分のパフォーマンスを測定・比較することができます。
パフォーマンステストは`tests/performance/`に配置されています。
各テストは、テストケースの説明を含む`.xml`ファイルで表されます。
テストは`docker/test/performance-comparison`ツールで実行されます。実行方法についてはreadmeファイルを参照してください。

各テストは、ループ内で1つまたは複数のクエリ(パラメータの組み合わせを含む場合があります)を実行します。

特定のシナリオでClickHouseのパフォーマンスを向上させたい場合で、かつ単純なクエリで改善が確認できる場合は、パフォーマンステストを作成することを強く推奨します。
また、比較的独立しており、それほど複雑でないSQL関数を追加または変更する際にも、パフォーマンステストを作成することを推奨します。
テスト中は`perf top`やその他の`perf`ツールを使用することが常に有効です。


## テストツールとスクリプト {#test-tools-and-scripts}

`tests`ディレクトリ内の一部のプログラムは、準備されたテストではなく、テストツールです。
例えば、`Lexer`には`src/Parsers/tests/lexer`というツールがあり、標準入力をトークン化して、色付けされた結果を標準出力に書き込みます。
これらのツールは、コード例として使用したり、探索や手動テストに利用したりできます。


## その他のテスト {#miscellaneous-tests}

機械学習モデルのテストは `tests/external_models` にあります。
これらのテストは更新されておらず、統合テストに移行する必要があります。

クォーラム挿入用の個別のテストがあります。
このテストは、個別のサーバー上でClickHouseクラスタを実行し、さまざまな障害ケースをエミュレートします。ネットワーク分断、パケットドロップ(ClickHouseノード間、ClickHouseとZooKeeper間、ClickHouseサーバーとクライアント間など)、`kill -9`、`kill -STOP`、`kill -CONT`など、[Jepsen](https://aphyr.com/tags/Jepsen)と同様の障害をシミュレートします。
その後、テストは、確認応答されたすべての挿入が書き込まれ、拒否されたすべての挿入が書き込まれていないことを検証します。

クォーラムテストは、ClickHouseがオープンソース化される前に別のチームによって作成されました。
このチームは現在ClickHouseに携わっていません。
テストは偶然Javaで書かれました。
これらの理由により、クォーラムテストは書き直され、統合テストに移行する必要があります。


## 手動テスト {#manual-testing}

新しい機能を開発する際は、手動でテストすることも推奨されます。
以下の手順で実行できます:

ClickHouseをビルドします。ターミナルからClickHouseを実行します: `programs/clickhouse-server`ディレクトリに移動し、`./clickhouse-server`で実行します。デフォルトでは、カレントディレクトリの設定ファイル(`config.xml`、`users.xml`、および`config.d`と`users.d`ディレクトリ内のファイル)を使用します。ClickHouseサーバーに接続するには、`programs/clickhouse-client/clickhouse-client`を実行します。

なお、すべてのClickHouseツール(server、clientなど)は、`clickhouse`という名前の単一バイナリへのシンボリックリンクです。
このバイナリは`programs/clickhouse`にあります。
すべてのツールは、`clickhouse-tool`の代わりに`clickhouse tool`として呼び出すこともできます。

または、ClickHouseパッケージをインストールすることもできます: ClickHouseリポジトリから安定版リリースをインストールするか、ClickHouseソースのルートディレクトリで`./release`を使用して自分でパッケージをビルドできます。
その後、`sudo clickhouse start`でサーバーを起動します(サーバーを停止するには`stop`を使用します)。
ログは`/etc/clickhouse-server/clickhouse-server.log`で確認できます。

ClickHouseがすでにシステムにインストールされている場合、新しい`clickhouse`バイナリをビルドして既存のバイナリを置き換えることができます:

```bash
$ sudo clickhouse stop
$ sudo cp ./clickhouse /usr/bin/
$ sudo clickhouse start
```

また、システムのclickhouse-serverを停止し、同じ設定でターミナルにログを出力しながら独自のサーバーを実行することもできます:

```bash
$ sudo clickhouse stop
$ sudo -u clickhouse /usr/bin/clickhouse server --config-file /etc/clickhouse-server/config.xml
```

gdbを使用した例:

```bash
$ sudo -u clickhouse gdb --args /usr/bin/clickhouse server --config-file /etc/clickhouse-server/config.xml
```

システムのclickhouse-serverがすでに実行中で停止したくない場合は、`config.xml`でポート番号を変更するか(`config.d`ディレクトリ内のファイルで上書きすることもできます)、適切なデータパスを指定して実行できます。

`clickhouse`バイナリはほとんど依存関係がなく、幅広いLinuxディストリビューションで動作します。
サーバー上で変更を簡易的にテストするには、新しくビルドした`clickhouse`バイナリを`scp`でサーバーに転送し、上記の例のように実行するだけです。


## ビルドテスト {#build-tests}

ビルドテストは、様々な代替構成や一部の外部システムにおいてビルドが正常に動作することを確認するために使用されます。
これらのテストも自動化されています。

例:

- Darwin x86_64(macOS)向けクロスコンパイル
- FreeBSD x86_64向けクロスコンパイル
- Linux AArch64向けクロスコンパイル
- システムパッケージのライブラリを使用したUbuntuでのビルド(非推奨)
- ライブラリの共有リンクを使用したビルド(非推奨)

例えば、システムパッケージを使用したビルドは、システムが持つパッケージの正確なバージョンを保証できないため、推奨されない方法です。
しかし、これはDebianメンテナにとって実際に必要とされています。
このため、少なくともこのビルド方式をサポートする必要があります。
別の例として、共有リンクは問題の一般的な原因ですが、一部の愛好家には必要とされています。

すべてのビルド方式ですべてのテストを実行することはできませんが、少なくとも様々なビルド方式が正常に動作することを確認したいと考えています。
この目的のためにビルドテストを使用しています。

また、コンパイルに時間がかかりすぎる、またはRAMを過度に必要とする翻訳単位が存在しないことも確認しています。

また、過度に大きなスタックフレームが存在しないことも確認しています。


## プロトコル互換性のテスト {#testing-for-protocol-compatibility}

ClickHouseネットワークプロトコルを拡張する際、旧バージョンのclickhouse-clientが新バージョンのclickhouse-serverで動作すること、および新バージョンのclickhouse-clientが旧バージョンのclickhouse-serverで動作することを手動でテストします(対応するパッケージのバイナリを実行するだけです)。

また、統合テストを使用して一部のケースを自動的にテストします:

- 旧バージョンのClickHouseで書き込まれたデータが新バージョンで正常に読み取れるかどうか
- 異なるClickHouseバージョンを持つクラスタで分散クエリが動作するかどうか


## コンパイラからの支援 {#help-from-the-compiler}

ClickHouseのメインコード(`src`ディレクトリに配置)は、`-Wall -Wextra -Werror`といくつかの追加の警告オプションを有効にしてビルドされます。
ただし、これらのオプションはサードパーティライブラリには適用されません。

Clangにはさらに有用な警告があります。`-Weverything`で確認し、デフォルトビルドに適用するものを選択できます。

ClickHouseのビルドには、開発環境と本番環境の両方で常にclangを使用しています。
デバッグモードで自身のマシン上でビルドすることもできます(ノートパソコンのバッテリーを節約するため)が、コンパイラは制御フローとプロシージャ間解析の向上により、`-O3`オプションを使用するとより多くの警告を生成できることに注意してください。
clangでデバッグモードでビルドする場合、デバッグバージョンの`libc++`が使用され、実行時により多くのエラーを検出できます。


## サニタイザー {#sanitizers}

:::note
ローカルで実行する際に、プロセス(ClickHouseサーバーまたはクライアント)が起動時にクラッシュする場合は、アドレス空間配置のランダム化を無効にする必要があります: `sudo sysctl kernel.randomize_va_space=0`
:::

### Address Sanitizer {#address-sanitizer}

コミットごとにASan環境下で機能テスト、統合テスト、ストレステスト、ユニットテストを実行しています。

### Thread Sanitizer {#thread-sanitizer}

コミットごとにTSan環境下で機能テスト、統合テスト、ストレステスト、ユニットテストを実行しています。

### Memory Sanitizer {#memory-sanitizer}

コミットごとにMSan環境下で機能テスト、統合テスト、ストレステスト、ユニットテストを実行しています。

### Undefined Behaviour Sanitizer {#undefined-behaviour-sanitizer}

コミットごとにUBSan環境下で機能テスト、統合テスト、ストレステスト、ユニットテストを実行しています。
一部のサードパーティライブラリのコードは未定義動作に対してサニタイズされていません。

### Valgrind (memcheck) {#valgrind-memcheck}

以前はValgrind環境下で機能テストを夜間に実行していましたが、現在は実施していません。
実行には数時間を要します。
現在、`re2`ライブラリに既知の誤検知が1件存在します。詳細は[この記事](https://research.swtch.com/sparse)を参照してください。


## ファジング {#fuzzing}

ClickHouseのファジングは、[libFuzzer](https://llvm.org/docs/LibFuzzer.html)とランダムなSQLクエリの両方を使用して実装されています。
すべてのファズテストは、サニタイザー(AddressおよびUndefined)を使用して実行する必要があります。

LibFuzzerは、ライブラリコードの独立したファズテストに使用されます。
ファザーはテストコードの一部として実装され、名前に"\_fuzzer"という接尾辞が付けられています。
ファザーの例は`src/Parsers/fuzzers/lexer_fuzzer.cpp`にあります。
LibFuzzer固有の設定、辞書、コーパスは`tests/fuzz`に保存されています。
ユーザー入力を処理するすべての機能に対してファズテストを作成することを推奨します。

ファザーはデフォルトではビルドされません。
ファザーをビルドするには、`-DENABLE_FUZZING=1`と`-DENABLE_TESTS=1`の両方のオプションを設定する必要があります。
ファザーをビルドする際は、Jemallocを無効にすることを推奨します。
ClickHouseのファジングをGoogle OSS-Fuzzに統合するために使用される設定は、`docker/fuzz`にあります。

また、ランダムなSQLクエリを生成し、サーバーがそれらを実行しても停止しないことを確認するために、シンプルなファズテストも使用しています。
これは`00746_sql_fuzzy.pl`にあります。
このテストは継続的に(一晩以上)実行する必要があります。

また、膨大な数のコーナーケースを発見できる高度なASTベースのクエリファザーも使用しています。
これは、クエリのASTに対してランダムな順列と置換を行います。
以前のテストからASTノードを記憶し、ランダムな順序で処理しながら、後続のテストのファジングに使用します。
このファザーの詳細については、[このブログ記事](https://clickhouse.com/blog/fuzzing-click-house)をご覧ください。


## ストレステスト {#stress-test}

ストレステストは、ファジングの一種です。
単一のサーバー上で、すべての機能テストをランダムな順序で並列実行します。
テストの結果自体は検証されません。

以下の点が検証されます:

- サーバーがクラッシュせず、デバッグやサニタイザーのトラップが発生しないこと;
- デッドロックが発生しないこと;
- データベース構造の一貫性が保たれていること;
- テスト後にサーバーが正常に停止し、例外なく再起動できること。

5つのバリアント(Debug、ASan、TSan、MSan、UBSan)があります。


## Thread Fuzzer {#thread-fuzzer}

Thread Fuzzer（Thread Sanitizerと混同しないでください）は、スレッドの実行順序をランダム化する別の種類のファジングです。
これにより、さらに多くのエッジケースを発見できます。


## セキュリティ監査 {#security-audit}

当社のセキュリティチームは、セキュリティの観点からClickHouseの機能について基本的なレビューを実施しました。


## 静的解析ツール {#static-analyzers}

コミットごとに `clang-tidy` を実行しています。
`clang-static-analyzer` のチェックも有効化されています。
`clang-tidy` は一部のスタイルチェックにも使用されています。

`clang-tidy`、`Coverity`、`cppcheck`、`PVS-Studio`、`tscancode`、`CodeQL` を評価済みです。
使用方法の手順は `tests/instructions/` ディレクトリで確認できます。

IDE として `CLion` を使用している場合、一部の `clang-tidy` チェックを標準で利用できます。

シェルスクリプトの静的解析には `shellcheck` も使用しています。


## 堅牢化 {#hardening}

デバッグビルドでは、ユーザーレベルのメモリ割り当てに対してASLRを実行するカスタムアロケータを使用しています。

また、割り当て後に読み取り専用となることが想定されるメモリ領域を手動で保護しています。

デバッグビルドでは、「有害な」関数(廃止された関数、安全でない関数、スレッドセーフでない関数)が呼び出されないことを保証するlibcのカスタマイズも組み込んでいます。

デバッグアサーションを広範囲に使用しています。

デバッグビルドでは、「論理エラー」コード(バグを示す)を持つ例外がスローされた場合、プログラムは早期に終了されます。
これにより、リリースビルドでは例外を使用し、デバッグビルドではアサーションとして扱うことが可能になります。

デバッグビルドではjemallocのデバッグバージョンを使用します。
デバッグビルドではlibc++のデバッグバージョンを使用します。


## ランタイム整合性チェック {#runtime-integrity-checks}

ディスクに保存されたデータにはチェックサムが付与されます。
MergeTreeテーブルのデータには、3つの方法で同時にチェックサムが付与されます\*（圧縮データブロック、非圧縮データブロック、ブロック全体の総合チェックサム）。
クライアントとサーバー間、またはサーバー間でネットワーク経由で転送されるデータにもチェックサムが付与されます。
レプリケーションにより、レプリカ上のデータがビット単位で同一であることが保証されます。

これは、障害のあるハードウェアから保護するために必要です（ストレージメディアのビット劣化、サーバーRAMのビット反転、ネットワークコントローラーRAMのビット反転、ネットワークスイッチRAMのビット反転、クライアントRAMのビット反転、通信線上のビット反転）。
ビット反転は一般的であり、ECC RAMやTCPチェックサムが存在する場合でも発生する可能性があることに注意してください（毎日ペタバイト単位のデータを処理する数千台のサーバーを運用している場合）。
[動画を参照（ロシア語）](https://www.youtube.com/watch?v=ooBAQIe0KlQ)。

ClickHouseは、運用エンジニアが障害のあるハードウェアを発見するのに役立つ診断機能を提供します。

\* そして、これは低速ではありません。


## コードスタイル {#code-style}

コードスタイルのルールは[こちら](style.md)に記載されています。

一般的なスタイル違反をチェックするには、`utils/check-style`スクリプトを使用できます。

コードに適切なスタイルを適用するには、`clang-format`を使用できます。
`.clang-format`ファイルはソースのルートディレクトリに配置されています。
これは実際のコードスタイルにほぼ対応しています。
ただし、既存のファイルに`clang-format`を適用することは推奨されません。フォーマットが悪化する可能性があるためです。
clangソースリポジトリにある`clang-format-diff`ツールを使用できます。

または、`uncrustify`ツールを使用してコードを再フォーマットすることもできます。
設定はソースのルートディレクトリにある`uncrustify.cfg`に記載されています。
これは`clang-format`ほどテストされていません。

`CLion`には独自のコードフォーマッターがあり、当プロジェクトのコードスタイルに合わせて調整する必要があります。

また、コード内のタイプミスを検出するために`codespell`を使用しています。
これも自動化されています。


## テストカバレッジ {#test-coverage}

テストカバレッジも追跡していますが、機能テストのみ、かつclickhouse-serverのみを対象としています。
これは毎日実行されます。


## テスト用のテスト {#tests-for-tests}

不安定なテストを検出するための自動チェックが実装されています。
このチェックでは、すべての新しいテストを100回（機能テストの場合）または10回（統合テストの場合）実行します。
1回でもテストが失敗した場合、そのテストは不安定であると判定されます。


## テスト自動化 {#test-automation}

[GitHub Actions](https://github.com/features/actions)を使用してテストを実行しています。

ビルドジョブとテストは、コミットごとにSandboxで実行されます。
生成されたパッケージとテスト結果はGitHubに公開され、直接リンクでダウンロードできます。
アーティファクトは数ヶ月間保存されます。
GitHubでプルリクエストを送信すると、「can be tested」タグが付けられ、CIシステムがClickHouseパッケージ(リリース版、デバッグ版、アドレスサニタイザー付きなど)を自動的にビルドします。
