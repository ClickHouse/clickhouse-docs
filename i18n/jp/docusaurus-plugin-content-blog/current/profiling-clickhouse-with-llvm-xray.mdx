---
title: "LLVM の XRay を用いた ClickHouse のプロファイリング"
date: 2024-11-13
description: "LLVM の XRay インストルメンテーションプロファイラを利用して ClickHouse をプロファイリングし、トレースを可視化してパフォーマンスを分析する方法を解説します。"
tags: ['パフォーマンスと最適化', 'ツールとユーティリティ']
---

import Image from "@theme/IdealImage";
import clickhouse from '@site/static/images/knowledgebase/profiling-clickhouse-with-llvm-xray/profile.png'
import time_order from '@site/static/images/knowledgebase/profiling-clickhouse-with-llvm-xray/time-order.png'
import left_heavy from '@site/static/images/knowledgebase/profiling-clickhouse-with-llvm-xray/left-heavy.png'
import sandwich from '@site/static/images/knowledgebase/profiling-clickhouse-with-llvm-xray/sandwich.png'

{frontMatter.description}

{/* 切り捨て */}

## プロファイラの種類 \{#types-of-profilers\}

LLVM にはすでに、コードに計測用の処理を挿入することで [インストゥルメンテーション
プロファイリング](https://en.wikipedia.org/wiki/Profiling_\(computer_programming\)#Instrumentation) を行うためのツールが含まれています。
[サンプリングまたは統計的プロファイリング](https://en.wikipedia.org/wiki/Profiling_\(computer_programming\)#Statistical_profilers)
とは対照的に、コードへインストゥルメンテーションを行う必要があり、より多くのリソースを消費する代わりに、呼び出しを一切取りこぼさない非常に高い精度が得られます。

簡単に言えば、インストゥルメンテーションプロファイラは、すべての関数呼び出しを追跡するための新しいコードを挿入します。
統計的プロファイラでは、コードに一切変更を加えることなく実行でき、アプリケーションの状態を確認するために定期的にスナップショットを取得します。
したがって、スナップショット取得時に実行中だった関数のみが対象となります。
[perf](https://en.wikipedia.org/wiki/Perf_%28Linux%29) は非常によく知られた統計的プロファイラです。

## XRay の統合機能を使って ClickHouse をプロファイリングする \{#profiling-clickhouse-using-xray-integration\}

ClickHouse 25.12 では、XRay が統合されており、関数に新しいインストルメンテーションポイントをシームレスに追加できます。
そのため、すべての公式リリースにはすでにこの機能が含まれており、必要に応じてオンデマンドでトリガーできます。有効化していないときには全体的なパフォーマンスに影響しません。最小限のインストルメンテーションポイントだけを有効にして、有用な情報を取得することとします。

新しいプロファイル用のインストルメンテーションポイントは、[SYSTEM INSTRUMENT ADD
PROFILE](https://clickhouse.com/docs/sql-reference/statements/system#instrument-add-profile)
文を使用して追加できます。インストルメント対象とする関数は
[system.symbols](https://clickhouse.com/docs/operations/system-tables/symbols) システムテーブルから取得できます。たとえば、実行にどれくらい時間がかかるかを確認するのに便利な `sleepForNanoseconds` 関数をプロファイリングしたいとします。

```sql
SYSTEM INSTRUMENT ADD 'sleepForNanoseconds' PROFILE
```

その後、プロファイリングしたい時間のあいだ動かしてから、停止します。

```sql
SYSTEM INSTRUMENT REMOVE ALL
```

system.trace&#95;log で収集されたデータを [Chrome 形式](https://clickhouse.com/docs/operations/system-tables/trace_log#chrome-event-trace-format) に変換し、[Perfetto](https://ui.perfetto.dev) で可視化します。各エントリの query&#95;id、cpu&#95;id、stacktrace に注目してください。

<Image img={clickhouse} size="md" alt="time-order" />

## XRay を使用したネイティブアプリケーションのプロファイリング \{#profiling-a-native-application-using-xray\}

以下のセクションは、XRay が内部でどのように動作するか、またネイティブアプリケーションのプロファイリングにどのようにそのまま利用できるかを理解するための参考として掲載しています。

### コードをインスツルメントする \{#instrument-the-code\}

次のソースコードを考えてみましょう：

```cpp
#include <chrono>
#include <cstdio>
#include <thread>

void one()
{
    std::this_thread::sleep_for(std::chrono::milliseconds(10));
}

void two()
{
    std::this_thread::sleep_for(std::chrono::milliseconds(5));
}

int main()
{
    printf("Start\n");

    for (int i = 0; i < 10; ++i)
    {
        one();
        two();
    }

    printf("Finish\n");
}
```

XRay で計装するには、次のようにフラグを追加する必要があります。

```bash
clang++ -o test test.cpp -fxray-instrument -fxray-instruction-threshold=1
```

* コードを計測用にインストルメントするには `-fxray-instrument` が必要です。
* `-fxray-instruction-threshold=1` は、例のように関数が非常に小さい場合でも、すべての関数を
  インストルメントするために使用します。デフォルトでは、[少なくとも 200 命令](https://llvm.org/docs/XRay.html#instrumenting-your-c-c-objective-c-application)
  を持つ関数だけがインストルメントされます。

バイナリに新しいセクションが追加されていることを確認することで、コードが正しくインストルメントされているかどうかを検証できます。

```bash
objdump -h -j xray_instr_map test

test:     file format elf64-x86-64

Sections:
Idx Name          Size      VMA               LMA               File off  Algn
 17 xray_instr_map 000005c0  000000000002f91c  000000000002f91c  0002f91c  2**0
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
```

### 適切な環境変数の値でプロセスを実行してトレースを収集する \{#run-the-process-with-proper-env-var-values-to-collect-the-trace\}

デフォルトでは、明示的に要求しない限りプロファイラによる収集は行われません。言い換えると、プロファイリングを行っていない場合、オーバーヘッドは無視できる程度です。`XRAY_OPTIONS` にさまざまな値を設定することで、プロファイラがいつ収集を開始するか、またどのように収集するかを設定できます。

```bash
XRAY_OPTIONS="patch_premain=true xray_mode=xray-basic verbosity=1" ./test
==74394==XRay: Log file in 'xray-log.test.14imlN'
Start
Finish
==74394==Cleaned up log for TID: 74394
```

### トレースを変換する \{#convert-the-trace\}

XRay のトレースは複数の形式に変換できます。`trace_event` 形式は解析しやすく、すでにそれに対応したツールも多数存在するため、ここではこの形式を使用します。

```bash
llvm-xray convert --symbolize --instr_map=./test --output-format=trace_event xray-log.test.14imlN | gzip > test-trace.txt.gz
```

### トレースを可視化する \{#visualize-the-trace\}

[speedscope.app](https://www.speedscope.app/) や
[Perfetto](https://ui.perfetto.dev) といった Web ベースの UI を利用できます。

Perfetto は複数スレッドの可視化やデータへのクエリ実行を容易にしてくれますが、speedscope の方が
フレームグラフやサンドイッチビューを生成する用途により適しています。

#### 時系列順 \{#time-order\}

<Image img={time_order} size="md" alt="時系列順" />

#### 左寄り \{#left-heavy\}

<Image img={left_heavy} size="md" alt="左寄り" />

#### サンドイッチ \{#sandwitch\}

<Image img={sandwich} size="md" alt="サンドイッチ" />

## 関連ドキュメントを参照する \{#check-out-the-docs\}

* [SYSTEM INSTRUMENT](https://clickhouse.com/docs/sql-reference/statements/system#instrument) — 計測ポイントを追加または削除します。
* [system.instrumentation](https://clickhouse.com/docs/operations/system-tables/instrumentation)
  — 計測対象ポイントを確認します。
* [system.symbols](https://clickhouse.com/docs/operations/system-tables/symbols) — 計測ポイントを追加するためのシンボルを確認します。
* [system.trace&#95;log](https://clickhouse.com/docs/operations/system-tables/trace_log) — 計測ポイントを使用して収集されたデータを確認します。
* [XRay Instrumentation](https://llvm.org/docs/XRay.html) ドキュメント
* さらに詳細を知るには、[Debugging with XRay](https://llvm.org/docs/XRayExample.html) ドキュメントを参照してください。