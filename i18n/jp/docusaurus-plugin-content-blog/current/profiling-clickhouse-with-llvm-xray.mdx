---
title: "LLVM の XRay を用いた ClickHouse のプロファイリング"
date: 2024-11-13
description: "LLVM の XRay インストルメンテーションプロファイラを利用して ClickHouse をプロファイリングし、トレースを可視化してパフォーマンスを分析する方法を解説します。"
tags: ['パフォーマンスと最適化', 'ツールとユーティリティ']
---

import Image from "@theme/IdealImage";
import time_order from '@site/static/images/knowledgebase/profiling-clickhouse-with-llvm-xray/time-order.png'
import left_heavy from '@site/static/images/knowledgebase/profiling-clickhouse-with-llvm-xray/left-heavy.png'
import sandwich from '@site/static/images/knowledgebase/profiling-clickhouse-with-llvm-xray/sandwich.png'
import clickhouse_time_order from '@site/static/images/knowledgebase/profiling-clickhouse-with-llvm-xray/clickhouse-time-order.png'

{frontMatter.description}

{/* 切り捨て */}


## プロファイラの種類 \{#types-of-profilers\}

LLVM にはすでに、コードに計測用の処理を挿入することで [インストゥルメンテーション
プロファイリング](https://en.wikipedia.org/wiki/Profiling_(computer_programming)#Instrumentation) を行うためのツールが含まれています。
[サンプリングまたは統計的プロファイリング](https://en.wikipedia.org/wiki/Profiling_(computer_programming)#Statistical_profilers)
とは対照的に、コードへインストゥルメンテーションを行う必要があり、より多くのリソースを消費する代わりに、呼び出しを一切取りこぼさない非常に高い精度が得られます。

簡単に言えば、インストゥルメンテーションプロファイラは、すべての関数呼び出しを追跡するための新しいコードを挿入します。
統計的プロファイラでは、コードに一切変更を加えることなく実行でき、アプリケーションの状態を確認するために定期的にスナップショットを取得します。
したがって、スナップショット取得時に実行中だった関数のみが対象となります。
[perf](https://en.wikipedia.org/wiki/Perf_%28Linux%29) は非常によく知られた統計的プロファイラです。

## XRay を使ったプロファイリング方法 \{#how-to-profile-with-xray\}

### コードをインスツルメントする

次のソースコードを考えてみましょう：

```cpp
#include <chrono>
#include <cstdio>
#include <thread>

void one()
{
    std::this_thread::sleep_for(std::chrono::milliseconds(10));
}

void two()
{
    std::this_thread::sleep_for(std::chrono::milliseconds(5));
}

int main()
{
    printf("Start\n");

    for (int i = 0; i < 10; ++i)
    {
        one();
        two();
    }

    printf("Finish\n");
}
```

XRay で計装するには、次のようにフラグを追加する必要があります。

```bash
clang++ -o test test.cpp -fxray-instrument -fxray-instruction-threshold=1
```

* コードを計測用にインストルメントするには `-fxray-instrument` が必要です。
* `-fxray-instruction-threshold=1` は、例のように関数が非常に小さい場合でも、すべての関数を
  インストルメントするために使用します。デフォルトでは、[少なくとも 200 命令](https://llvm.org/docs/XRay.html#instrumenting-your-c-c-objective-c-application)
  を持つ関数だけがインストルメントされます。

バイナリに新しいセクションが追加されていることを確認することで、コードが正しくインストルメントされているかどうかを検証できます。

```bash
objdump -h -j xray_instr_map test

test:     file format elf64-x86-64

Sections:
Idx Name          Size      VMA               LMA               File off  Algn
 17 xray_instr_map 000005c0  000000000002f91c  000000000002f91c  0002f91c  2**0
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
```


### 適切な環境変数の値でプロセスを実行してトレースを収集する

デフォルトでは、明示的に要求しない限りプロファイラによる収集は行われません。言い換えると、プロファイリングを行っていない場合、オーバーヘッドは無視できる程度です。`XRAY_OPTIONS` にさまざまな値を設定することで、プロファイラがいつ収集を開始するか、またどのように収集するかを設定できます。

```bash
XRAY_OPTIONS="patch_premain=true xray_mode=xray-basic verbosity=1" ./test
==74394==XRay: Log file in 'xray-log.test.14imlN'
Start
Finish
==74394==Cleaned up log for TID: 74394
```


### トレースを変換する

XRAy のトレースは複数の形式に変換できます。`trace_event` 形式は解析しやすく、すでにそれに対応したツールも多数存在するため、ここではこの形式を使用します。

```bash
llvm-xray convert --symbolize --instr_map=./test --output-format=trace_event xray-log.test.14imlN | gzip > test-trace.txt.gz
```


### トレースを可視化する \{#visualize-the-trace\}

[speedscope.app](https://www.speedscope.app/) や
[Perfetto](https://ui.perfetto.dev) といった Web ベースの UI を利用できます。

Perfetto は複数スレッドの可視化やデータへのクエリ実行を容易にしてくれますが、speedscope の方が
フレームグラフやサンドイッチビューを生成する用途により適しています。

#### 時系列順 \{#time-order\}

<Image img={time_order} size="md" alt="時系列順" />

#### 左寄り \{#left-heavy\}

<Image img={left_heavy} size="md" alt="左寄り" />

#### サンドイッチ \{#sandwitch\}

<Image img={sandwich} size="md" alt="サンドイッチ" />

## ClickHouse のプロファイリング \{#profiling-clickhouse\}

1. ClickHouse をビルドするときに、`cmake` に `-DENABLE_XRAY=1` を渡します。これにより[適切なコンパイラフラグが設定されます](https://github.com/ClickHouse/ClickHouse/blob/9caac43b2aa5e7c5474a87b7596dea95f5a2569a/cmake/xray_instrumentation.cmake)。
2. トレースを生成するため、ClickHouse を実行するときに環境変数 `XRAY_OPTIONS="patch_premain=true xray_mode=xray-basic verbosity=1"` を設定します。
3. トレースを trace event 形式などの有用な形式に変換します。`llvm-xray convert --symbolize
   --instr_map=./build/programs/clickhouse --output-format=trace_event xray-log.clickhouse.ZqKprE |
   gzip > clickhouse-trace.txt.gz`
4. [speedscope.app](https://www.speedscope.app/) または
   [Perfetto](https://ui.perfetto.dev) でトレースを可視化します。

<Image img={clickhouse_time_order} alt="ClickHouse time-order" size="md"/>

これは 1 つのスレッドのみを可視化したものです。上部のバーから他の `tid` を選択できます。

## ドキュメントを参照する \{#check-out-the-docs\}

詳しくは、[XRay Instrumentation](https://llvm.org/docs/XRay.html) および [Debugging with
XRay](https://llvm.org/docs/XRayExample.html) のドキュメントを参照してください。