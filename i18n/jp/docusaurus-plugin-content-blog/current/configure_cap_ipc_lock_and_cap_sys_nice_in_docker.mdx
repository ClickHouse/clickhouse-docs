---
title: Docker での CAP_IPC_LOCK および CAP_SYS_NICE ケーパビリティの設定
description: コンテナ内で ClickHouse を実行する際に表示される `CAP_IPC_LOCK` と `CAP_SYS_NICE` に関する Docker ケーパビリティ警告の対処方法を説明します。
date: 2023-06-07
tags: ['エラーと例外']
keywords: ['Docker', 'CAP_IPC_LOCK', 'CAP_SYS_NICE']
---

{frontMatter.description}

{/* 切り捨て */}

## 質問 \{#question\}

Docker で ClickHouse を実行していると、システムに `CAP_IPC_LOCK` と `CAP_SYS_NICE` のケーパビリティがないと Docker から警告されます。どのように対処すればよいですか？

`CAP_IPC_LOCK` または `CAP_SYS_NICE` ケーパビリティがない場合のログメッセージは次のようになります。

```bash
docker run -d --name clickhouse-server \
    --ulimit nofile=262144:262144 \
    --network clickhouse-net \
    -p 8123:8123 -p 9000:9000 -p 9009:9009 -p 9363:9363 \
    clickhouse/clickhouse-server:23.2
```

```response
2023.04.19 08:04:10.022720 [ 1 ] {} <Information> Application: プロセスにCAP_IPC_LOCK機能がないため、バイナリmlockが無効化されます。ClickHouseパッケージが正しくインストールされていないことが原因の可能性があります。'sudo setcap cap_ipc_lock=+ep /usr/bin/clickhouse'を手動で実行することで問題を解決できます。なお、'nosuid'でマウントされたファイルシステムでは動作しません。

2023.04.19 08:04:10.065860 [ 1 ] {} <Information> Application: プロセスにCAP_SYS_NICE機能がないため、'os_thread_priority'設定は効果がありません。ClickHouseパッケージが正しくインストールされていないことが原因の可能性があります。'sudo setcap cap_sys_nice=+ep /usr/bin/clickhouse'を手動で実行することで問題を解決できます。なお、'nosuid'でマウントされたファイルシステムでは動作しません。
```

## 回答 \{#answer\}

1. コンテナに `IPC_LOCK` および `SYS_NICE` のケーパビリティを付与するために、2つの `--cap-add` 引数を追加します。

```bash
docker run -d --name clickhouse-server \
   --cap-add=SYS_NICE \
   --cap-add=IPC_LOCK \
   --ulimit nofile=262144:262144 \
   --network clickhouse-net \
   -p 8123:8123 -p 9000:9000 -p 9009:9009 -p 9363:9363 \
   clickhouse/clickhouse-server:23.2
```

2. 次のコマンドを使用して、コンテナ内でケーパビリティが表示されることを確認します。

```bash
apt-get update > /dev/null && apt-get install -y libcap2-bin > /dev/null && capsh --print
```

レスポンスは以下のようになります：

```response
debconf: delaying package configuration, since apt-utils is not installed
WARNING: libcap needs an update (cap=40 should have a name).
Current: = cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_net_raw,cap_ipc_lock,cap_sys_chroot,cap_sys_nice,cap_mknod,cap_audit_write,cap_setfcap+ep
Bounding set =cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_net_raw,cap_ipc_lock,cap_sys_chroot,cap_sys_nice,cap_mknod,cap_audit_write,cap_setfcap
Ambient set =
Securebits: 00/0x0/1'b0
 secure-noroot: no (unlocked)
 secure-no-suid-fixup: no (unlocked)
 secure-keep-caps: no (unlocked)
 secure-no-ambient-raise: no (unlocked)
uid=0(root) euid=0(root)
gid=0(root)
groups=0(root)
Guessed mode: UNCERTAIN (0)
```

3. ClickHouse の 2 つのケーパビリティを手動で設定します

```bash
setcap "cap_ipc_lock=+ep cap_sys_nice=+ep" /usr/bin/clickhouse
```

4. ケーパビリティが適用されていることを確認します。

```bash
getcap -v /usr/bin/clickhouse
```

次のように表示されます。

```response
/usr/bin/clickhouse = cap_ipc_lock,cap_sys_nice+ep
```

5. ClickHouse サーバーを再起動すると、これらのログメッセージは表示されなくなるはずです。

<br />

詳細については、この [Linux capabilities に関する記事](https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities) を参照してください。
