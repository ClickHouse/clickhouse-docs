---
title: "PostgreSQL のデータを Parquet、CSV、JSON にエクスポートする方法"
date: 2023-03-22
description: "`clickhouse-local` を使用して、さまざまな例を通じて PostgreSQL のデータを Parquet、CSV、JSON 形式にエクスポートする方法を解説します。"
tags: ['データエクスポート', 'データ形式']
keywords: ['PostgreSQL', 'Parquet', 'CSV', 'JSON']
---

{frontMatter.description}

{/* 切り捨て */}

## PostgreSQL データを Parquet、CSV、JSON にエクスポートする方法 \{#how-to-export-postgresql-data-to-parquet-csv-or-json\}

これは `clickhouse-local` を使えば簡単にできます：

* データを読み取るために [`postgresql` テーブル関数](https://clickhouse.com/docs/sql-reference/table-functions/postgresql) を使用する
* `INTO OUTFILE _filename_ FORMAT` 句を使用して、目的の出力フォーマットを指定する

出力フォーマットには、ClickHouse がサポートしている任意の[出力フォーマット](https://clickhouse.com/docs/interfaces/formats)を指定できます。いくつか例を見てみましょう...

これらの例では、ClickHouse バイナリに含まれる `clickhouse-local` を使用します。次の手順でダウンロードしてください：

```bash
curl https://clickhouse.com/ | sh
```

## PostgreSQL を Parquet にエクスポートする \{#export-postgresql-to-parquet\}

`postgresql` テーブル関数を使用すると、リモートの PostgreSQL サーバー上に保存されているデータに対して `SELECT`（および `INSERT`）クエリを実行できます。たとえば、PostgreSQL のテーブルの全内容を参照するには次のようにします。

```bash
SELECT *
FROM
   postgresql(
    'localhost:5432',
    'postgres_database',
    'postgres_table',
    'user',
    'password'
);
```

このクエリの出力は、`INTO OUTFILE` を使ってファイルに書き出せます。`FORMAT` を使用して、作成するファイルのフォーマットを指定します。PostgreSQL テーブルの内容をすべて取得し、その内容を Parquet ファイルに出力しましょう。

```bash
./clickhouse local -q "SELECT * FROM
   postgresql(
    'localhost:5432',
    'postgres_database',
    'postgres_table',
    'user',
    'password'
)
INTO OUTFILE 'my_output_file.parquet'"
```

:::note
出力ファイル名の拡張子が `.parquet` であるため、ClickHouse は Parquet 形式を使用すると解釈します。そのため、ここでは `FORMAT Parquet` 句を省略しています。
:::

## PostgreSQL を CSV にエクスポートする \{#export-postgresql-to-csv\}

出力ファイル名をより適切なものに指定する点を除けば、Parquet の場合と同じです。

```bash
./clickhouse local -q "SELECT * FROM
   postgresql(
    'localhost:5432',
    'postgres_database',
    'postgres_table',
    'user',
    'password'
)
INTO OUTFILE 'my_output_file.csv'"
```

これで完了です。ClickHouse は出力ファイル名の `.csv` 拡張子を認識して、データをカンマ区切りで出力します。それ以外は、前述のコマンドとまったく同じです。

## PostgreSQL を JSON にエクスポートする \{#export-postgresql-to-json\}

PostgreSQL から JSON へエクスポートするには、ファイル名を変えるだけで、ClickHouse がフォーマットを自動判別します。

```bash
./clickhouse local -q "SELECT * FROM
   postgresql(
    'localhost:5432',
    'postgres_database',
    'postgres_table',
    'user',
    'password'
)
INTO OUTFILE 'my_output_file.ndjson'"
```

:::note
ここで終わる必要はありません。`clickhouse-local` を使って PostgreSQL からデータを取得し、[あらゆる種類の出力フォーマット](https://clickhouse.com/docs/sql-reference/formats/) に送信できます。

ClickHouse がファイル名の拡張子から出力タイプを判別できない場合、または明示的にフォーマットを指定したい場合は、`FOMRAT` 句を追加してください。

```bash
./clickhouse local -q "SELECT * FROM
   postgresql(
    'localhost:5432',
    'postgres_database',
    'postgres_table',
    'user',
    'password'
)
INTO OUTFILE 'my_output_file.ndjson'
FORMAT JSONEachRow"

:::

## PostgreSQL を別のプロセスにストリーミングする \{#stream-postgresql-to-another-process\}

`INTO OUTFILE` を使用する代わりに、テーブル関数の結果を別のプロセスへストリーミング出力できます。構文を示す簡単な例として、Linux の `wc -l` コマンドを使って行数をカウントします：

```bash
./clickhouse local -q "SELECT *
FROM s3('https://datasets-documentation.s3.eu-west-3.amazonaws.com/house_parquet/house_0.parquet'
FORMAT JSONEachRow
)" | wc -l
```

ただし、行をシェルスクリプトや Python スクリプト、あるいは任意のプロセスに対しても容易にストリーミングできます。
