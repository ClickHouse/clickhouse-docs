---
title: ClickHouse でマテリアライズドビューを使用しているクエリを特定する方法
description: 指定した時間範囲内でマテリアライズドビューが関与するすべてのクエリを特定するために、ClickHouse のログをクエリする方法を解説します。
date: 2023-03-24
tags: ['システムテーブル']
keywords: ['マテリアライズドビュー', 'create_table_query']
---

{frontMatter.description}

{/* トランケート */}

***


## 質問 \{#question\}

過去60分間にマテリアライズドビューを含むすべてのクエリを表示するにはどうすればよいですか？

## 回答

次のクエリでは、以下の点を踏まえて、マテリアライズドビューに向けられたすべてのクエリを表示できます。

* `system.tables` テーブル内の `create_table_query` フィールドを利用して、どのテーブルがマテリアライズドビューの明示的な（`TO`）宛先になっているかを特定できます。
* `uuid` と `.inner_id.<uuid>` という名前付け規則を用いることで、どのテーブルがマテリアライズドビューの暗黙的な宛先になっているかを追跡できます。

また、最初のクエリの CTE 内にある値（デフォルトでは `60` 分）を変更することで、どの程度過去まで遡って参照するかを設定できます。

```sql
WITH(60) -- デフォルト60分
AS timeRange,
(
    --NULL以外のuuidを持つ*すべての*テーブルについて、暗黙的なマテリアライズドビュー隠しターゲットテーブルの名前を準備
    SELECT groupArray(
            concat('default.`.inner_id.', toString(uuid), '`')
        )
    FROM clusterAllReplicas(default, system.tables)
    WHERE notEmpty(uuid)
) AS MV_implicit_possible_hidden_target_tables_names_array,
(
    --マテリアライズドビュー名とターゲットテーブルを取得（TOが指定されている場合）
    --TODO extractは最初のキャプチャグループのみを返すようです :( 利用可能になり次第regexpExtractに置き換える
    SELECT arrayFilter(
            x->x != '',
            --空のキャプチャを削除
            groupArray(
                extract(
                    create_table_query,
                    '^CREATE MATERIALIZED VIEW\s(\w+\.\w+)\s(?:TO\s(\S+))?'
                )
            )
        )
    FROM clusterAllReplicas(default, system.tables)
    WHERE engine = 'MaterializedView'
) AS MV_explicit_target_tables_names_array
SELECT event_time,
    query,
    tables as "マテリアライズドビューテーブル"
FROM clusterAllReplicas(default, system.query_log)
WHERE (
        -- 60分以内のSELECTのみ
        event_time > now() - toIntervalMinute(timeRange)
        AND startsWith(query, 'SELECT')
    ) -- クエリが暗黙的なマテリアライズドビューターゲットテーブル名を含むかどうかを確認
    AND (
        hasAny(
            tables,
            MV_implicit_possible_hidden_target_tables_names_array
        )
        OR -- クエリが明示的なマテリアライズドビューターゲットテーブルを含むかどうかを確認
        hasAny(tables, MV_explicit_target_tables_names_array)
    )
ORDER BY event_time DESC;
```

expected output:

```sql
| event_time          | query                                                                                          | MVs tables                                                            |
| ------------------- | ---------------------------------------------------------------------------------------------- | --------------------------------------------------------------------- |
| 2023-02-23 08:14:14 | SELECT     rand(),* FROM     default.sum_of_volumes,     default.big_changes,     system.users | ["default.big_changes_mv","default.sum_of_volumes_mv","system.users"] |
| 2023-02-23 08:04:47 | SELECT     price,* FROM     default.sum_of_volumes,     default.big_changes                    | ["default.big_changes_mv","default.sum_of_volumes_mv"]                |

```

この例の結果では、上記の `default.big_changes_mv` と `default.sum_of_volumes_mv` はどちらもマテリアライズドビューです。
