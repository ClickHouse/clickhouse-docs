---
title: リバースプロキシを使用してカスタム DNS エイリアスを設定する
description: リバースプロキシを使用してインスタンス用のカスタム DNS エイリアスを設定する方法を説明します
date: 2025-05-16
tags: ['サーバー管理', 'セキュリティと認証']
keywords: ['カスタム DNS エイリアス', 'DNS']
hide_title: true
---

{frontMatter.description}

{/* 省略 */}

<br />

<br />


# リバースプロキシを設定してカスタム DNS エイリアスを設定する \{#custom-dns-alias\}

> このナレッジベース記事では、Nginx などのリバースプロキシを使用して、ClickHouse ネイティブクライアント向けに ClickHouse Cloud インスタンスのカスタム DNS エイリアスを設定する方法を順を追って説明します。

## 自己署名証明書を作成する

:::note
署名付き証明書を使用している場合、この手順は不要です。
:::

任意のドメイン名を指定して自己署名証明書を作成します。
この例では、ドメイン名 `xyz-customdomain.com` を使用し、
`MyCertificate.crt` という名前の証明書を作成します。詳細については [&quot;SSL 証明書の作成&quot;](/guides/sre/configuring-ssl#2-create-ssl-certificates)
を参照してください。

証明書を `/etc/clickhouse-client/config.xml` に追加します:

```yaml
<clickhouse>
    <openSSL>
        <client>
            <loadDefaultCAFile>false</loadDefaultCAFile>
            # highlight-next-line
            <caConfig>/etc/ssl/certs/MyCertificate.crt</caConfig>
            <cacheSessions>true</cacheSessions>
            <disableProtocols>sslv2,sslv3</disableProtocols>
            <preferServerCiphers>true</preferServerCiphers>
            <invalidCertificateHandler>
                <name>RejectCertificateHandler</name>
            </invalidCertificateHandler>
        </client>
    </openSSL>
</clickhouse>
```


## Nginx 設定を更新する

`nginx.conf` ファイルに以下の内容を追加します：

```text
proxy_ssl_name xyz.us-west-2.aws.clickhouse.cloud;
proxy_ssl_server_name on;
```

```text
stream {
    upstream stream_backend {
         server xyz.us-west-2.aws.clickhouse.cloud:9440;
    }

    server {
        listen                9440 ssl;
        proxy_pass            stream_backend;

        ssl_certificate       /etc/ssl/certs/MyCertificate.crt;
        ssl_certificate_key   /etc/ssl/certs/MyKey.key;
        ssl_protocols         SSLv3 TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers           HIGH:!aNULL:!MD5;
        ssl_session_cache     shared:SSL:20m;
        ssl_session_timeout   4h;
        ssl_handshake_timeout 30s;
	proxy_ssl on;
	proxy_ssl_trusted_certificate /etc/ssl/certs/isrgrootx1.pem;
	proxy_ssl_session_reuse on;
        proxy_ssl_verify on;
    #highlight-next-line
	proxy_ssl_name xyz.us-west-2.aws.clickhouse.cloud;
    #highlight-next-line
	proxy_ssl_server_name on;
    }
}
```

ここで言う `isrgrootx1.pem` は ClickHouse Cloud のルート証明書で、
[こちら](https://letsencrypt.org/certs/isrgrootx1.pem) からダウンロードできます。


## hosts ファイルを更新する

:::note
独自のドメインコントローラーを使用している場合、次の手順は不要です
:::

Nginx サーバー上の `/etc/hosts` ファイルに以下を追加します:

```text title='/etc/hosts'
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost6 localhost6.localdomain6
10.X.Y.Z  xyz-customdomain.com
```

ここでの `10.X.Y.Z` は、あなたの環境における特定の Nginx サーバーの IP アドレスを指します。


## エイリアスを使用して Cloud に接続する

これで、カスタムエイリアスを使って接続する準備が整いました。

```bash
clickhouse-client --host xyz.customdomain.com --secure --password 'xxxxxxx'
ClickHouse client version 23.12.1.428 (official build).
Connecting to xyz.customdomain.com:9440 as user default.
Connected to ClickHouse server version 23.9.2.

clickhouse-cloud :)
```
