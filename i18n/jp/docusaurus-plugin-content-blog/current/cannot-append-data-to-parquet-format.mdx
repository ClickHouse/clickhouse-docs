---
title: ClickHouse での「Cannot Append Data in Parquet Format」エラーの解決方法
description: ClickHouse で「Cannot append data in format Parquet to file」というエラーが発生していますか？この記事では、その解決方法を解説します。
date: 2023-03-25
tags: ['エラーと例外', 'データ形式']
keywords: ['Parquet', 'Cannot Append Data']
---

{frontMatter.description}

{/* 切り捨て */}


## ClickHouse での「Cannot Append Data in Parquet Format」エラーの解消

ClickHouse で「Cannot append data in format Parquet to file」というエラーが発生していますか？

通常、このエラーは次のように表示されます。

`DB::Exception: Cannot append data in format Parquet to file, because this format doesn't support appends. (CANNOT_APPEND_TO_FILE)`

`File` テーブルエンジンで Parquet 形式を使用するテーブルを作成したとします。

```sql
CREATE TABLE parquet_test
(
    `x` UInt32,
    `y` String
)
ENGINE = File(Parquet)
```

テーブルには一度だけ書き込むことができます。

```sql
INSERT INTO parquet_test VALUES
   (1, 'Hello'),
   (2, 'Hi')
```

これにより、`data/default/parquet_test` ディレクトリ内に `data.Parquet` という名前のファイルが作成されます。別のバッチを挿入しようとすると、次のようになります。

```sql
INSERT INTO parquet_test VALUES
   (3, 'World'),
   (4, 'Bye')
```

…次のエラーが表示されます：

```response
コード: 641. DB::Exception: localhost:9000から受信。DB::Exception: Parquet形式ではファイルへのデータ追記ができません。この形式は追記をサポートしていないためです。engine_file_allow_create_multiple_files設定を有効化することで、挿入ごとに新しいファイルを作成できるようになります。(CANNOT_APPEND_TO_FILE)
```

ClickHouse では Parquet ファイルに追記することはできません。ただし、[`engine_file_allow_create_multiple_files` setting](https://clickhouse.com/docs/operations/settings/settings#engine_file_allow_create_multiple_files) を有効にすることで、ClickHouse に対して `INSERT` ごとに新しいファイルを作成するよう指示できます。有効化すると、挿入のたびに次のパターンに従った名前で新しいファイルが作成されます。

`data.Parquet` -&gt; `data.1.Parquet` -&gt; `data.2.Parquet` というようになります。

では実際に試してみましょう。2 つのコマンドを、`parquet.sql` という名前の 1 つのファイルにまとめて保存します。

```sql
SET engine_file_allow_create_multiple_files = 1;

INSERT INTO default.parquet_test VALUES  (3, 'World'), (4, 'Bye');
```

これを `clickhouse-client` を使って実行します：

```bash
./clickhouse client --queries-file parquet.sql
```

これで、`data/default/parquet_test` に 2 つのファイルが存在していることが確認できます（以降の各 INSERT ごとに新しいファイルが作成されます）。

:::note
`engine_file_allow_create_multiple_files` 設定は、JSON や ORC のような追記できないほかのデータ形式にも適用されます。
:::
