---
title: ClickHouse でメモリ使用量に基づいて負荷の高いクエリを特定する
description: クラスタ構成とスタンドアロン構成の両方の例を用いて、`system.query_log` テーブルを使って ClickHouse で最もメモリ使用量の大きいクエリを見つける方法を解説します。
date: 2023-06-07
tags: ['パフォーマンスと最適化']
keywords: ['負荷の高いクエリ', 'メモリ使用量']
---

{frontMatter.description}

{/* 切り詰め */}

## `system.query_log` テーブルの使用 \{#using-the-systemquery_log-table\}

次の便利なクエリを使用すると、実行されたクエリのうち、どれが最も多くのメモリを使用したかを確認できます。

このクエリについての補足事項は次のとおりです。

* 結果は過去 1 日間（`now() - toIntervalDay(1))`）のデータを基に計算されていますが、時間間隔は簡単に変更できます
* `default` という名前のクラスタが存在することを前提としています。これは [ClickHouse Cloud](https://console.clickhouse.cloud) におけるクラスタの名前です。`default` をご利用のクラスタ名に変更してください
* クラスタをお持ちでない場合は、本記事の末尾に記載されているクエリを参照してください

```sql
SELECT
    count() as nb_query,
    user,
    query,
    sum(memory_usage) AS memory,
    normalized_query_hash
FROM
    clusterAllReplicas(default, system.query_log)
WHERE
    (event_time >= (now() - toIntervalDay(1)))
    AND query_kind = 'Select'
    AND type = 'QueryFinish'
    and user != 'monitoring-internal'
GROUP BY
    normalized_query_hash,
    query,
    user
ORDER BY
    memory DESC;
```

レスポンスは次のようになります。

```response
┌─nb_query─┬─user────┬─query─────────────────────────────────────────────────────────┬───memory─┬─normalized_query_hash─┐
│       11 │ default │ select version()                                              │ 46178924 │   7202516440347714159 │
│        2 │ default │ SELECT * FROM "system"."table_functions" LIMIT 31 OFFSET 0    │  8391544 │  12830067173062987695 │
└──────────┴─────────┴───────────────────────────────────────────────────────────────┴──────────┴───────────────────────┘
```

:::note
もし `system.query_log` テーブルがない場合、クエリログが有効になっていない可能性があります。有効化方法については、[`query_log` 設定](https://clickhouse.com/docs/operations/server-configuration-parameters/settings#server_configuration_parameters-query-log) を参照してください。
:::

クラスタがない場合は、単一の `system.query_log` テーブルに対して直接クエリを実行できます。

```sql
SELECT
    count() as nb_query,
    user,
    query,
    sum(memory_usage) AS memory,
    normalized_query_hash
FROM
    system.query_log
WHERE
    (event_time >= (now() - toIntervalDay(1)))
    AND query_kind = 'Select'
    AND type = 'QueryFinish'
    and user != 'monitoring-internal'
GROUP BY
    normalized_query_hash,
    query,
    user
ORDER BY
    memory DESC;
```
