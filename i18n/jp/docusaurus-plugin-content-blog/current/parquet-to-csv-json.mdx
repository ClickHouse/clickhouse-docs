---
title: Parquet ファイルを CSV または JSON に変換するには？
description: "ClickHouse の `clickhouse-local` ツールを使用して、Parquet ファイルを CSV または JSON 形式に簡単に変換する方法について説明します。"
date: 2023-03-22
tags: ['データソース', 'データ形式']
keywords: ['変換', 'Parquet', 'CSV', 'JSON']
---

{frontMatter.description}

{/* 切り捨て */}

## Parquet から CSV または JSON へのファイル変換 \{#converting-files-from-parquet-to-csv-or-json\}

`clickhouse-local` を使用すると、ClickHouse がサポートするあらゆる [入力および出力フォーマット](https://clickhouse.com/docs/interfaces/formats) 間でファイルを変換できます（70 を超えるフォーマットに対応しています）。この記事では、S3 上の Parquet ファイルを CSV ファイルと JSON ファイルに変換する方法を説明します。

最初から順に確認していきます。ClickHouse には、ファイル、データベース、その他のリソースから読み込み、データをテーブルに変換するための [table function](https://clickhouse.com/docs/sql-reference/table-functions/)（テーブル関数）が用意されています。例として、S3 にある Parquet ファイルを想定します。これを読み込むために `s3` table function を使用します（ClickHouse はファイル名に基づいて、それが Parquet ファイルであることを認識します）。

その前に、まずは `clickhouse` バイナリをダウンロードしましょう。

```bash
curl https://clickhouse.com/ | sh
```

## テーブル関数を使ってデータにアクセスする \{#accessing-the-data-using-a-table-function\}

`s3` テーブル関数が生成する結果テーブルに対して `DESCRIBE` を実行し、ファイルを読み込めることを確認します。

```bash
./clickhouse local -q "DESCRIBE s3('https://datasets-documentation.s3.eu-west-3.amazonaws.com/house_parquet/house_0.parquet')"
```

このファイルには、英国で売却された物件の住宅価格データが含まれています。レスポンスは次のようになります。

```response
price	Nullable(Int64)
date	Nullable(UInt16)
postcode1	Nullable(String)
postcode2	Nullable(String)
type	Nullable(String)
is_new	Nullable(UInt8)
duration	Nullable(String)
addr1	Nullable(String)
addr2	Nullable(String)
street	Nullable(String)
locality	Nullable(String)
town	Nullable(String)
district	Nullable(String)
county	Nullable(String)
```

データに対して任意のクエリを実行できます。たとえば、どの町で住宅の平均価格が最も高いかを確認してみましょう。

```bash
./clickhouse local -q "SELECT
   town,
   avg(price) AS avg_price
FROM s3('https://datasets-documentation.s3.eu-west-3.amazonaws.com/house_parquet/house_0.parquet')
GROUP BY town
ORDER BY avg_price DESC
LIMIT 10"
```

レスポンスは次のようになります：

```bash
GATWICK	16818750
CHALFONT ST GILES	938090.0985915493
VIRGINIA WATER	789301.1320224719
COBHAM	699874.7111622555
BEACONSFIELD	677247.5483146068
ESHER	616004.6888297872
KESTON	607585.8597560975
GERRARDS CROSS	566330.2959086584
ASCOT	551491.2975753123
WEYBRIDGE	548974.828692494
```

## Parquet ファイルを CSV に変換する \{#convert-the-parquet-file-to-a-csv\}

任意の SQL クエリの結果をファイルに保存できます。S3 内の Parquet ファイルからすべての列を取得し、その出力を新しい CSV ファイルに書き出してみましょう。出力ファイル名が `.csv` で終わっているため、ClickHouse は `CSV` 出力フォーマットを使用することを自動的に認識します。

```bash
./clickhouse local -q "SELECT *
FROM s3('https://datasets-documentation.s3.eu-west-3.amazonaws.com/house_parquet/house_0.parquet')
INTO OUTFILE 'house_prices.csv'"
```

正しく動作しているか確認しましょう:

```response
$ tail house_prices.csv
70000,10508,"YO8","9XN","detached",0,"freehold","7","","POPPY CLOSE","SELBY","SELBY","SELBY","NORTH YORKSHIRE"
130000,14274,"YO8","9XP","detached",0,"freehold","10","","HEATHER CLOSE","","SELBY","SELBY","NORTH YORKSHIRE"
150000,18180,"YO8","9XP","detached",0,"freehold","11","","HEATHER CLOSE","","SELBY","SELBY","NORTH YORKSHIRE"
157000,18088,"YO8","9XP","detached",0,"freehold","12","","HEATHER CLOSE","","SELBY","SELBY","NORTH YORKSHIRE"
134000,17333,"YO8","9XP","semi-detached",0,"freehold","16","","HEATHER CLOSE","","SELBY","SELBY","NORTH YORKSHIRE"
250000,13405,"YO8","9YA","detached",0,"freehold","6","","YORKDALE COURT","HAMBLETON","SELBY","SELBY","NORTH YORKSHIRE"
59500,11166,"YO8","9YB","semi-detached",0,"freehold","4","","YORKDALE DRIVE","HAMBLETON","SELBY","SELBY","NORTH YORKSHIRE"
142500,17648,"YO8","9YB","semi-detached",0,"freehold","4A","","YORKDALE DRIVE","HAMBLETON","SELBY","SELBY","NORTH YORKSHIRE"
230000,15125,"YO8","9YD","detached",0,"freehold","1","","ONE ACRE GARTH","HAMBLETON","SELBY","SELBY","NORTH YORKSHIRE"
250000,15950,"YO8","9YD","detached",0,"freehold","3","","ONE ACRE GARTH","HAMBLETON","SELBY","SELBY","NORTH YORKSHIRE"
```

## Parquet ファイルを JSON に変換する \{#convert-the-parquet-file-to-a-json\}

Parquet ファイルを JSON に変換するには、出力ファイル名の拡張子を単に変更するだけです。

```bash
./clickhouse local -q "SELECT *
FROM s3('https://datasets-documentation.s3.eu-west-3.amazonaws.com/house_parquet/house_0.parquet')
INTO OUTFILE 'house_prices.ndjson'"
```

正しく動作していることを確認しましょう。

```response
 $ tail house_prices.ndjson
{"price":"70000","date":10508,"postcode1":"YO8","postcode2":"9XN","type":"detached","is_new":0,"duration":"freehold","addr1":"7","addr2":"","street":"POPPY CLOSE","locality":"SELBY","town":"SELBY","district":"SELBY","county":"NORTH YORKSHIRE"}
{"price":"130000","date":14274,"postcode1":"YO8","postcode2":"9XP","type":"detached","is_new":0,"duration":"freehold","addr1":"10","addr2":"","street":"HEATHER CLOSE","locality":"","town":"SELBY","district":"SELBY","county":"NORTH YORKSHIRE"}
{"price":"150000","date":18180,"postcode1":"YO8","postcode2":"9XP","type":"detached","is_new":0,"duration":"freehold","addr1":"11","addr2":"","street":"HEATHER CLOSE","locality":"","town":"SELBY","district":"SELBY","county":"NORTH YORKSHIRE"}
{"price":"157000","date":18088,"postcode1":"YO8","postcode2":"9XP","type":"detached","is_new":0,"duration":"freehold","addr1":"12","addr2":"","street":"HEATHER CLOSE","locality":"","town":"SELBY","district":"SELBY","county":"NORTH YORKSHIRE"}
{"price":"134000","date":17333,"postcode1":"YO8","postcode2":"9XP","type":"semi-detached","is_new":0,"duration":"freehold","addr1":"16","addr2":"","street":"HEATHER CLOSE","locality":"","town":"SELBY","district":"SELBY","county":"NORTH YORKSHIRE"}
{"price":"250000","date":13405,"postcode1":"YO8","postcode2":"9YA","type":"detached","is_new":0,"duration":"freehold","addr1":"6","addr2":"","street":"YORKDALE COURT","locality":"HAMBLETON","town":"SELBY","district":"SELBY","county":"NORTH YORKSHIRE"}
{"price":"59500","date":11166,"postcode1":"YO8","postcode2":"9YB","type":"semi-detached","is_new":0,"duration":"freehold","addr1":"4","addr2":"","street":"YORKDALE DRIVE","locality":"HAMBLETON","town":"SELBY","district":"SELBY","county":"NORTH YORKSHIRE"}
{"price":"142500","date":17648,"postcode1":"YO8","postcode2":"9YB","type":"semi-detached","is_new":0,"duration":"freehold","addr1":"4A","addr2":"","street":"YORKDALE DRIVE","locality":"HAMBLETON","town":"SELBY","district":"SELBY","county":"NORTH YORKSHIRE"}
{"price":"230000","date":15125,"postcode1":"YO8","postcode2":"9YD","type":"detached","is_new":0,"duration":"freehold","addr1":"1","addr2":"","street":"ONE ACRE GARTH","locality":"HAMBLETON","town":"SELBY","district":"SELBY","county":"NORTH YORKSHIRE"}
{"price":"250000","date":15950,"postcode1":"YO8","postcode2":"9YD","type":"detached","is_new":0,"duration":"freehold","addr1":"3","addr2":"","street":"ONE ACRE GARTH","locality":"HAMBLETON","town":"SELBY","district":"SELBY","county":"NORTH YORKSHIRE"}
```

## CSV を Parquet に変換する \{#convert-csv-to-parquet\}

この操作は逆方向にも行えます。新しい CSV ファイルを簡単に読み込み、Parquet ファイルとして出力できます。ローカルファイル `house_prices.csv` は、ClickHouse で `file` テーブル関数を使って読み込むことができ、ClickHouse は拡張子が `.parquet` のファイル名に基づいてファイルを Parquet 形式で出力します（あるいは `FORMAT Parquet` 句を追加して明示的に指定することもできます）。

```bash
./clickhouse local -q "SELECT *
FROM file('house_prices.csv')
INTO OUTFILE 'house_prices.parquet'"
```

前述のとおり、`clickhouse local` と組み合わせて ClickHouse の任意の [input フォーマットおよび output フォーマット](https://clickhouse.com/docs/interfaces/formats) を利用することで、ファイルをさまざまな形式に簡単に変換できます。
