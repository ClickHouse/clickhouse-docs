---
title: ClickHouse Cloud の辞書でデータが表示されないのはなぜですか？
description: 辞書内のデータが作成直後にすぐに表示されない場合があります。
date: 2024-04-12
tags: ['クラウドの管理', 'データモデリング']
keywords: ['辞書']
---

{frontMatter.description}

{/* トランケート */}


## ClickHouse におけるディクショナリ

ClickHouse Cloud で作成されたディクショナリは、作成直後の段階では一時的に不整合な状態になる場合があります。つまり、作成直後にはディクショナリ内にデータがまったく表示されないことがあります。ただし、数回リトライすると、作成クエリが別のレプリカで実行され、データが表示されるようになります。

この現象は、対象のパーツがサーバーに到達する前にディクショナリが作成されたことが原因で発生する場合があります。例として、次のようなケースが挙げられます。

```
2024-01-25 13:38:25.615837 - CREATE DICTIONARY を受信しました
2024-01-25 13:38:25.626468 - CREATE DICTIONARY が完了しました
2024-01-25 13:38:25.733008 - Part all_0_0_0 をダウンロードしました
```

ご覧のとおり、このデータは辞書が作成された後になって到着しました。`LIFETIME(MIN 0 MAX 0)` を使用している場合、これはより大きな問題になります。これは、その辞書が自動的に再読み込みされることは一切ないことを意味するからです。そのため、`RELOAD DICTIONARIES` コマンドを実行するまで、辞書は空のままになります。

この問題の解決策は、辞書を作成するときにソーステーブルを指定する代わりに `SELECT` クエリを使用し、設定 `select_sequential_consistency=1` を有効にすることです。

ソーステーブルを指定する代わりに、次のようにします。

```sql
SOURCE(CLICKHOUSE(
    table 'test.temp_title_table_1706189903924'
    user default password 'PASSWORD'))
```

`select_sequential_consistency=1` を指定した `SELECT` クエリを使用します。

```sql
SOURCE(CLICKHOUSE(QUERY
    'SELECT songTitle, mappedTitle
    FROM test.temp_title_table_1706189903924
    SETTINGS select_sequential_consistency=1' USER default PASSWORD ''))
```


## なぜこの問題が発生するのですか？ \{#why-does-this-issue-occur\}

データを挿入してから辞書を作成または再読み込みする際、DDL がデータ（または新しいデータ）よりも先にレプリカへ到達する場合があります。これにより、レプリカ間で辞書の内容に不整合が生じます。その結果、どのレプリカがクエリを受信するかによって、得られる結果が異なる可能性があります。

同じことは、データを挿入してすぐにテーブルから読み出す場合にも起こります。まだデータをレプリケートしていないレプリカから読み出すと、新しく挿入されたデータは見えません。逐次一貫性が必要な場合は、パフォーマンス低下を代償として（このため一般には利用が推奨されませんが）`select_sequential_consistency` を有効にできます。

辞書の場合は少し厄介で、辞書はクエリの設定ではなくサーバーの設定を使用します。その結果、辞書にデータをロードする際、たとえ `SET select_sequential_consistency=1` としても、レプリカ間でデータが一貫してロードされない可能性があります。辞書のソースクエリで `select_sequential_consistency=1` を指定すると、サーバー設定としてグローバルに有効化されていなくても、この設定に従って辞書を動作させることができます。