---
date: 2025-07-20
title: OPTIMIZE FINAL と FINAL の違いは何ですか？
tags: ['コアデータの基本概念']
keywords: ['OPTIMIZE FINAL', 'FINAL']
description: 'OPTIMIZE FINAL と FINAL の違いと、それぞれをいつ使用し、いつ避けるべきかを説明します。'
---

{frontMatter.description}

{/* 省略 */}

# `OPTIMIZE FINAL` と `FINAL` の違いは何ですか？ \{#what-is-the-difference-between-optimize-final-and-final\}

`OPTIMIZE FINAL` は、ディスク上のデータを物理的かつ恒久的に再編成・最適化する DDL コマンドです。`MergeTree` テーブル内のデータパーツを物理的にマージし、その過程でストレージから重複行を削除することでデータの重複排除を行います。

`FINAL` は **クエリ実行時** の修飾子であり、保存されているデータ構造を変更することなく、重複排除された結果を返します。読み取り時にマージロジックを実行することで動作します。これは一時的なものであり、現在実行中のクエリ結果にのみ影響します。

`OPTIMIZE FINAL` はパフォーマンスへのコストが大きいため、一般的には使用を避けることが推奨されますが、両者を混同すべきではありません。特に `ReplacingMergeTree` のようなテーブルエンジンを使用している場合、バックグラウンドでの最終的なマージ処理の段階でまだ置き換えられていない重複行を含むことがあるため、重複のない結果を取得するには `FINAL` を使用する必要があるケースがよくあります。

以下の表は主な違いをまとめたものです。

|Aspect	           |`OPTIMIZE FINAL`                            | `FINAL`                                            |
|------------------|--------------------------------------------|----------------------------------------------------|
|Type              | DDL コマンド                               | クエリ修飾子                                       |
|Effect            | 永続的なストレージ最適化	                  | 一時的なクエリ時の重複排除                         |
|Performance       | 影響: 一度の高コスト、その後のクエリは高速 | 影響: 個々のコストは低いが、クエリ毎に繰り返し発生 |
|Data Modification | あり - ストレージを物理的に変更            | なし - 読み取り専用の操作                          |
|Use Case          | 定期的なメンテナンス / 最適化              | リアルタイムな重複排除済みクエリ                   |

## それぞれを使う場面 \{#when-to-use-each\}

`OPTIMIZE FINAL` を使うのは次のような場合です:

* クエリ性能を恒久的に改善したい場合
* 一度きりの最適化コストを許容できる場合
* 定期的なテーブルのメンテナンスを行っている場合
* 重複データを物理的にクリーンアップしたい場合

`FINAL` を使うのは次のような場合です:

* すぐに重複排除された結果が必要な場合
* 永続的な最適化を待てない、または望まない場合
* ときどきだけ重複排除済みデータが必要な場合
* 頻繁に変更されるデータを扱っている場合

どちらも有用なツールですが、ClickHouse の重複排除戦略において異なる目的を果たします。