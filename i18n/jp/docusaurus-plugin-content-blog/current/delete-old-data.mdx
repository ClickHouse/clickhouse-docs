---
title: ClickHouse テーブルから古いレコードを削除することは可能ですか？
description: "短い答えは「はい」です。ClickHouse には、古いデータを削除してディスク領域を解放するための複数の仕組みが用意されています。各仕組みは、それぞれ異なるシナリオを想定しています。"
date: 2022-10-19
tags: ['データの削除']
keywords: ['古いレコードの削除']
---

{frontMatter.description}

{/* 省略 */}

## 結論は「はい」です \{#the-short-answer-is-yes\}

結論は「はい」です。ClickHouse には、古いデータを削除してディスク使用量を削減できる複数の仕組みがあります。それぞれ異なるシナリオを想定しています。

## TTL \{#ttl\}

ClickHouse では、特定の条件を満たしたときにデータを自動的に削除できます。この条件は任意の列に基づく式として設定でき、通常はタイムスタンプ列に対する固定オフセットとして指定します。

このアプローチの主な利点は、TTL を一度設定すれば外部システムによるトリガーを必要とせず、データの削除がバックグラウンドで自動的に実行される点です。

:::note
TTL はデータを [/dev/null](https://en.wikipedia.org/wiki/Null_device) に破棄するだけでなく、SSD から HDD など、異なるストレージシステム間でデータを移動するためにも使用できます。
:::

[TTL の設定](https://clickhouse.com/docs/engines/table-engines/mergetree-family/mergetree#table_engine-mergetree-ttl)についての詳細は、こちらを参照してください。

## DELETE FROM \{#delete-from\}

[DELETE FROM](https://clickhouse.com/docs/sql-reference/statements/delete) を使用すると、標準的な DELETE クエリを ClickHouse で実行できます。フィルター句で対象となった行には削除フラグが付き、以降の結果セットからは除外されます。削除済み行のクリーンアップ（物理削除）は非同期に行われます。

:::note
DELETE FROM はバージョン 23.3 以降で一般提供されています。より古いバージョンでは実験的機能であり、次の設定で有効化する必要があります:

```
SET allow_experimental_lightweight_delete = true;
```

:::

## ALTER DELETE \{#alter-delete\}

`ALTER DELETE` は、非同期バッチ処理を用いて行を削除します。`DELETE FROM` と異なり、`ALTER DELETE` の実行後からバッチ処理が完了するまでの間に実行されたクエリの結果には、削除対象となっている行も含まれます。詳細については [ALTER DELETE](https://clickhouse.com/docs/sql-reference/statements/alter/delete) ドキュメントを参照してください。

`ALTER DELETE` は、古いデータを柔軟に削除するために発行できます。これを定期的に行う必要がある場合の主なデメリットは、クエリを送信するための外部システムが必要になることです。また、削除する行が 1 行だけであっても、ミューテーションによってパーツ全体が書き換えられるため、パフォーマンス面での考慮も必要です。

これは、ClickHouse をベースにしたシステムを [GDPR](https://gdpr-info.eu) に準拠させるための、最も一般的なアプローチです。

[ミューテーション](https://clickhouse.com/docs/sql-reference/statements/alter/#alter-mutations) の詳細についてはこちらを参照してください。

## DROP PARTITION \{#drop-partition\}

`ALTER TABLE ... DROP PARTITION` は、パーティション全体を削除するためのコスト効率の高い方法です。柔軟性はそれほど高くなく、テーブル作成時に適切なパーティショニング方式を設定しておく必要がありますが、それでも一般的なユースケースの大部分はカバーできます。ミューテーションと同様に、通常利用する場合は外部システムから実行する必要があります。

[パーティションの操作](https://clickhouse.com/docs/sql-reference/statements/alter/partition/#alter_drop-partition)の詳細を参照してください。

## TRUNCATE \{#truncate\}

テーブルからすべてのデータを削除するのはかなり過激な操作ですが、状況によってはまさにそれが必要になる場合もあります。

詳しくは、[テーブルの TRUNCATE](https://clickhouse.com/docs/sql-reference/statements/truncate) を参照してください。