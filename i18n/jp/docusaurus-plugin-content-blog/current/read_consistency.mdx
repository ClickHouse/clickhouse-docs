---
date: 2024-02-14
title: "ClickHouse でデータ読み取りの一貫性を確保するには？"
description: "同じノードやランダムなノードに接続している場合でも、ClickHouse から読み取る際のデータの一貫性をどのように確保するかを学びます。"
tags: ['パフォーマンスと最適化']
keywords: ['読み取り整合性']
---

{frontMatter.description}

{/* 省略 */}


## 質問 \{#question\}

ClickHouse Cloud にデータを書き込んでいます。データを読み込む際に、常に最新かつ完全な情報を取得できることを保証する必要があります。

## 回答 \{#answer\}

### 同じノードと通信する \{#talking-to-the-same-node\}

ネイティブプロトコルまたはセッションを使用して読み書きを行う場合、常に同じレプリカに接続された状態になります。このシナリオでは、書き込んでいるノードから直接読み取ることになるため、読み取り結果の一貫性が常に保証されます。

### 任意のノードへのアクセス

同じノードと通信していることを保証できない場合（例えば、ロードバランサーによって振り分けられる HTTPS リクエスト経由でノードにアクセスしている場合）、次のいずれかの方法を取ることができます。

A)

1. データを書き込む
2. 新しいレプリカに接続する
3. `SYSTEM SYNC REPLICA db.table_name LIGHTWEIGHT` を実行する
4. 最新のデータを読み取る

`SYSTEM` コマンドの[リファレンス](https://clickhouse.com/docs/sql-reference/statements/system#sync-replica)を参照してください。

または

B) シーケンシャル一貫性を満たす読み取りをいつでも行う

```sql
SELECT 
...
SETTINGS select_sequential_consistency = 1
```

ClickHouse Cloud と、そのデフォルトの [SharedMergeTree](https://clickhouse.com/docs/cloud/reference/shared-merge-tree) テーブルエンジンを使用している場合、`insert_quorum_parallel` を使用する必要はありません。SharedMergeTree へのすべての挿入は、設計上すべてクォーラム挿入となります。

[`SYSTEM SYNC REPLICAS`](https://clickhouse.com/docs/sql-reference/statements/system#sync-replica) や [`select_sequential_consistency`](https://clickhouse.com/docs/operations/settings/settings#select_sequential_consistency) を使用すると、ClickHouse Keeper への負荷が増加し、サービス自体の負荷状況によってはパフォーマンスが低下する可能性があります。

推奨されるアプローチは、同じセッション、またはネイティブプロトコル（スティッキーコネクション）を用いて書き込み／読み取りを行うことです。
