---
title: SQL で円周率を計算してみよう
description: Pi Day です！ClickHouse SQL で円周率を計算してみましょう
date: 2023-03-14
tags: ['ユースケース']
keywords: ['円周率の計算', 'SQL']
---

{frontMatter.description}

{/* 切り捨て */}

## 円周率の日です！SQLを使用して円周率を計算する \{#its-pi-day-lets-calculate-pi-using-sql\}

円周率の日おめでとうございます!ClickHouseのSQLクエリを使って円周率を計算してみるのは面白いのではないかと考えました。これまでに考案した内容は以下の通りです...

1. このクエリでは、ClickHouse の `numbers_mt` テーブル関数を使って 10 億行を返しますが、計算の実行にはわずか 40ms しかかかりません。

```sql
SELECT 4 * sum(if(number % 2, -1, 1) / ((number * 2) + 1)) AS pi
FROM numbers_mt(1000000000.)

┌────────────────pi─┐
│ 3.141592652589797 │
└───────────────────┘

1行が設定されました。経過時間: 0.432秒。処理された行数: 10億行、8.00 GB (23.2億行/秒、18.53 GB/秒)
```

2. 次の例も 10 億個の数値を処理しますが、ただし前の例ほど高速ではありません。

```sql
SELECT 3 + (4 * sum(if((number % 2) = 0, if((number % 4) = 0, -1 / ((number * (number + 1)) * (number + 2)), 1 / ((number * (number + 1)) * (number + 2))), 0))) AS pi
FROM numbers_mt(2, 10000000000)

┌─────────────────pi─┐
│ 3.1415926525808087 │
└────────────────────┘

1 row in set. Elapsed: 9.825 sec. Processed 10.00 billion rows, 80.00 GB (1.02 billion rows/s., 8.14 GB/s.)
```

3. これは ClickHouse ではもちろん私たちのお気に入りであり（しかも最も正確です！）：

```sql
SELECT pi()

┌──────────────pi()─┐
│ 3.141592653589793 │
└───────────────────┘

1 row in set. Elapsed: 0.008 sec.
```

4. これは三角法に相当通じている人の仕事ですね：

```sql
SELECT 2 * asin(1) AS pi

┌────────────────pi─┐
│ 3.141592653589793 │
└───────────────────┘

1 row in set. Elapsed: 0.005 sec.
```

5. ここでは、必要な桁数を指定できる便利な API を紹介します：

```sql
SELECT *
FROM url('https://api.pi.delivery/v1/pi?start=0&numberOfDigits=100', 'JSONEachRow')

┌───────────────content─┐
│ 3.1415926535897933e99 │
└───────────────────────┘

1 row in set. Elapsed: 0.556 sec.
```

6. これはなかなか賢い方法で、ClickHouse の distance 関数を利用しています：

```sql
WITH random_points AS
    (
        SELECT (rand64(1) / pow(2, 64), rand64(2) / pow(2, 64)) AS point
        FROM numbers(1000000000)
    )
SELECT (4 * countIf(L2Norm(point) < 1)) / count() AS pi
FROM random_points


┌──────────pi─┐
│ 3.141627208 │
└─────────────┘

1 row in set. Elapsed: 4.742 sec. Processed 1.00 billion rows, 8.00 GB (210.88 million rows/s., 1.69 GB/s.)
```

7. 物理学者なら、これで満足できるはずです：

```sql
SELECT 22 / 7

┌─────divide(22, 7)─┐
│ 3.142857142857143 │
└───────────────────┘
```

8. 別の間接的な方法（Alexey Milovidov が考案したもので）、小数点以下 7 桁まで正確で、高速です。

```sql
WITH
    10 AS length,
    (number / 1000000000.) * length AS x
SELECT pow((2 * length) * avg(exp(-(x * x))), 2) AS pi
FROM numbers_mt(1000000000.)


┌─────────────────pi─┐
│ 3.1415926890388595 │
└────────────────────┘

1 row in set. Elapsed: 1.245 sec. Processed 1.00 billion rows, 8.00 GB (803.25 million rows/s., 6.43 GB/s.)
```

:::note
さらにお持ちの場合は、ぜひご貢献ください。ありがとうございます。
:::