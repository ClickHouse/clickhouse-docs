---
title: 'クエリのメモリ制限超過'
description: 'クエリで発生するメモリ制限超過エラーのトラブルシューティング'
date: 2025-07-25
tags: ['エラーと例外']
keywords: ['OOM', 'メモリ制限超過']
---

{frontMatter.description}

{/* truncate */}

import Image from '@theme/IdealImage';
import joins from '@site/static/images/knowledgebase/memory-limit-exceeded-for-query.png';

## クエリでメモリ制限を超過しました \{#troubleshooting-out-of-memory-issues\}

新しいユーザーにとって、ClickHouse はしばしば「魔法」のように感じられるかもしれません。どのクエリも非常に高速であり、
最大規模のデータセットやきわめて複雑なクエリであっても同様です。しかしながら、実運用では
ClickHouse の限界が試される場面も必ず出てきます。メモリ制限を超過するクエリは、さまざまな原因で発生し得ますが、
最も一般的なのは、大規模な `JOIN` や、高カーディナリティなフィールドに対する集約処理です。パフォーマンスが極めて重要で、
これらのクエリが不可欠な場合、よくユーザーに推奨するのは、単純にスケールアップすることです。
ClickHouse Cloud では、これを自動的かつシームレスに行い、クエリが常に応答性を保てるようにします。ただし、
セルフマネージドなシナリオでは、これが必ずしも容易ではなく、そもそも最適なパフォーマンスが必須でない場合もあることは理解しています。
このような場合、ユーザーにはいくつかの選択肢があります。

### 集約 \{#aggregations\}

メモリを大量に消費する集約処理やソート処理のシナリオでは、ユーザーはそれぞれ
[`max_bytes_before_external_group_by`](/operations/settings/settings#max_bytes_before_external_group_by)
および [`max_bytes_before_external_sort`](/operations/settings/settings#max_bytes_ratio_before_external_sort)
という設定を利用できます。前者については[こちら](/sql-reference/statements/select/group-by/#group-by-in-external-memory)で詳しく説明しています。

要約すると、これらの設定により、メモリのしきい値を超えた場合に集約処理をディスクへ「スピル」させることができます。これによりクエリ性能は必ず低下しますが、クエリが OOM で失敗しないようにするのに役立ちます。後者のソート設定も、メモリを多く消費するソートに伴う同様の問題に対処するのに役立ちます。これは、分散環境でコーディネーティングノードが子シャードからソート済みレスポンスを受け取るような場合に特に重要です。この場合、コーディネーティングサーバーは自身の利用可能メモリよりも大きなデータセットのソートを要求されることがあります。[`max_bytes_before_external_sort`](/operations/settings/settings#max_bytes_ratio_before_external_sort) を用いることで、ソート処理もディスクへスピルさせることができます。この設定は、特に分散クエリで、`GROUP BY` の後に `ORDER BY` と `LIMIT` があるようなケースでも有用です。

### Joins \{#joins\}

結合（join）では、ユーザーは複数の `JOIN` アルゴリズムを選択でき、これにより
必要なメモリ量を削減できます。デフォルトではハッシュ結合が使用され、機能面で
最も網羅的であり、多くの場合で最高のパフォーマンスを提供します。
このアルゴリズムでは、`JOIN` の右側のテーブルをインメモリのハッシュテーブルに
読み込み、そのハッシュテーブルに対して左側のテーブルを評価します。メモリ使用量を
最小化するには、小さい方のテーブルを右側に配置する必要があります。
ただし、このアプローチにも、メモリがボトルネックとなるケースでは依然として制約があります。
そのような場合には、[`join_algorithm`](/operations/settings/settings#join_algorithm)
設定で `partial_merge` 結合を有効にできます。これは
[sort-merge アルゴリズム](https://en.wikipedia.org/wiki/Sort-merge_join)の派生形であり、
まず右側のテーブルをブロック単位にソートし、それらに対して min-max インデックスを
作成します。次に、左側テーブルの一部を結合キーでソートし、それらを右側テーブルと
結合します。min-max インデックスは、不要な右側テーブルのブロックをスキップするために
使用されます。これはメモリ消費を抑えられる一方で、パフォーマンスが低下します。
このコンセプトをさらに発展させた `full_sorting_merge` アルゴリズムでは、右側が非常に
大きくメモリに収まらず、ルックアップが不可能な場合（複雑なサブクエリなど）でも
`JOIN` を実行できます。この場合、右側と左側の両方がメモリに収まらない場合には
ディスク上でソートされ、大きなテーブル同士の結合が可能になります。

<Image img={joins} size="md" alt="JOIN アルゴリズム" />

バージョン 20.3 以降、ClickHouse は `join_algorithm` 設定で auto 値をサポートしています。
これは ClickHouse にアダプティブな結合方式を適用するよう指示するものであり、
メモリ制限に違反するまではハッシュ結合アルゴリズムを優先し、その時点で
partial&#95;merge アルゴリズムが試行されます。最後に、結合に関しては、
分散結合の動作と、そのメモリ消費をいかに最小化するかを理解しておくことを推奨します。
詳細は[こちら](/sql-reference/operators/in#distributed-subqueries)を参照してください。