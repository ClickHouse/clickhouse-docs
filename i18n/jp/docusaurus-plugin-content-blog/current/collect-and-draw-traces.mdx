---
date: 2025-12-30
title: クエリトレースを収集して可視化する方法
tags: ['ツールとユーティリティ']
keywords: ['クエリトレース', 'OTel', 'Grafana']
description: "このガイドでは、セルフマネージド ClickHouse でクエリトレースを収集して可視化する方法を、ClickHouse の組み込み機能または Grafana を使用して行う手順として説明します。これは、複雑なクエリを扱っていて、EXPLAIN だけでは把握しきれない内部の実行メカニズムを理解する必要がある場合に特に有用です。"
---

import Image from '@theme/IdealImage';
import trace_visualizer from '@site/static/images/knowledgebase/trace-visualizer-example.png';
import trace_visualization_grafana from '@site/static/images/knowledgebase/trace-visualization-grafana.png';
import trace_visualization_diagram from '@site/static/images/knowledgebase/trace-visualization-diagram.png';

{frontMatter.description}

{/* 省略 */}

<br />

<br />

**前提条件**:

* ClickHouse の[設定ファイル](/operations/configuration-files)に関する理解
* 稼働中の [ClickHouse サーバー](/install) インスタンス
* （任意）ローカルで稼働している [Grafana インスタンス](https://grafana.com/docs/grafana/latest/fundamentals/getting-started/)

<VerticalStepper headerLevel="h2">
  ## `opentelemetry_span_log` システムテーブルが有効化されていることを確認する \{#enable-system-table\}

  `config.xml` の `opentelemetry_span_log` セクションを変更していない場合は、この手順をスキップできます。

  デフォルトの ClickHouse `config.xml` ファイルを開き、以下のセクションを見つけます:

  ```yaml
  <!--
      OpenTelemetry log contains OpenTelemetry trace spans.

      NOTE: this table does not use standard schema with event_date and event_time!
  -->
  <opentelemetry_span_log>
      <!--
          The default table creation code is insufficient, this <engine> spec
          is a workaround. There is no 'event_time' for this log, but two times,
          start and finish. It is sorted by finish time, to avoid inserting
          data too far away in the past (probably we can sometimes insert a span
          that is seconds earlier than the last span in the table, due to a race
          between several spans inserted in parallel). This gives the spans a
          global order that we can use to e.g. retry insertion into some external
          system.
      -->
      <engine>
          engine MergeTree
          partition by toYYYYMM(finish_date)
          order by (finish_date, finish_time_us, trace_id)
      </engine>
      <database>system</database>
      <table>opentelemetry_span_log</table>
      <flush_interval_milliseconds>7500</flush_interval_milliseconds>
      <max_size_rows>1048576</max_size_rows>
      <reserved_size_rows>8192</reserved_size_rows>
      <buffer_size_rows_flush_threshold>524288</buffer_size_rows_flush_threshold>
      <flush_on_crash>false</flush_on_crash>
  </opentelemetry_span_log>
  ```

  コメントアウトされていないことを確認してください。コメントアウトされている場合、以降の手順で `system.opentelemetry_span_log` が表示されません。
  ClickHouseサーバーがデフォルトの設定ファイルを使用していない場合も同様です。

  サーバーログで次のような内容を確認してください:

  ```text
  Processing configuration file 'config.xml'.
  There is no file 'config.xml', will use embedded config.
  ```

  :::tip
  標準的なインストールでは、このファイルは `/etc/clickhouse-server/config.xml` に配置されます
  :::

  ## OpenTelemetryトレースを有効にする \{#enable-otel-tracing\}

  ClickHouseサーバーが稼働している状態で、ClickHouseクライアントを開き、次のクエリを使用してトレース収集を有効化します:

  ```bash
  SET opentelemetry_trace_processors=1;
  ```

  次のコマンドを実行すると、`opentelemetry_span_log` システムテーブルが表示されるはずです:

  ```sql
  SHOW TABLES IN system
  ```

  次に以下を実行します:

  ```
  SET opentelemetry_start_trace_probability=1;
  ```

  これは、ClickHouseが実行されたクエリに対してトレースを開始する確率を設定します。
  `1`を指定すると、すべての実行されたクエリに対してトレースが有効になります。

  ## クエリIDを取得する \{#obtain-query-id\}

  以下のダミークエリ、またはトレース対象のクエリを実行してください:

  ```sql
  SELECT pow(number, 2) FROM numbers(10E4);
  ```

  クエリIDをコピーします:

  ```sql
  :) SELECT pow(number, 2) FROM numbers(10E4);

  SELECT pow(number, 2)
  FROM numbers(100000.)

  --highlight-next-line
  Query id: a9241258-a0c4-4776-a00b-e6a1d9bec4a1
  ```

  ## トレースファイルを生成する \{#generate-trace-file\}

  前のステップで取得したクエリIDに置き換えて、以下のクエリを実行してください:

  ```sql
  WITH 'a9241258-a0c4-4776-a00b-e6a1d9bec4a1' AS my_query_id
  SELECT
      concat(substring(hostName(), length(hostName()), 1), leftPad(greatest(attribute['clickhouse.thread_id'], attribute['thread_number']), 5, '0')) AS group,
      operation_name,
      start_time_us,
      finish_time_us,
      sipHash64(operation_name) AS color,
      attribute
  FROM system.opentelemetry_span_log
  WHERE (trace_id IN (
      SELECT trace_id
      FROM system.opentelemetry_span_log
      WHERE (attribute['clickhouse.query_id']) = my_query_id
  )) AND (operation_name != 'query') AND (operation_name NOT LIKE 'Query%')
  ORDER BY
      hostName() ASC,
      group ASC,
      parent_span_id ASC,
      start_time_us ASC
  INTO OUTFILE 'trace.json'
  FORMAT JSON
  SETTINGS output_format_json_named_tuples_as_objects = 1
  ```

  これにより、トレースが`trace.json`という名前のファイルに書き込まれます。
  デフォルトでは、このファイルはclickhouse-clientまたはclickhouse-localツールを実行している現在の作業ディレクトリに作成されます。

  ## 組み込みツールを使用してトレースを可視化する \{#visualize-trace-using-built-in-tooling\}

  [https://trace-visualizer.clickhouse.com/](https://trace-visualizer.clickhouse.com/) でホストされているトレースビジュアライザーを使用します。
  前のステップの `trace.json` ファイルを読み込んで、トレースを可視化します。

  <Image img={trace_visualizer} size="md" alt="ClickHouse トレース可視化の例" />

  ## Grafanaを使用してトレースを可視化する \{#using-grafana\}

  トレースデータの可視化と探索には、公式ClickHouseプラグインを使用したGrafanaを推奨します。
  このプラグインは、Trace Panelを使用したトレースの可視化が可能になるよう機能強化されています。
  これは、ビジュアライゼーションとしても、Explore内のコンポーネントとしてもサポートされています。

  [「オブザーバビリティのためのGrafanaとClickHouseの使用」](https://clickhouse.com/docs/observability/grafana)
  に記載されている手順に従って、ClickHouseプラグインでGrafanaをセットアップしてください。

  Exploreタブから以下のクエリを実行します。その際、`trace_id`を自分のものに置き換えてください:

  ```sql
  SELECT
      toString(trace_id) AS traceID,
      toString(span_id) AS spanID,
      if(toString(parent_span_id)='0', '', toString(parent_span_id)) AS parentSpanID,
      'ClickHouse' AS serviceName,
      operation_name AS operationName,
      start_time_us/1000000 AS startTime,
      (finish_time_us - start_time_us)/1000 AS duration,
      arrayMap(key -> map('key', key, 'value', attribute[key]), mapKeys(attribute)) AS serviceTags
  FROM system.opentelemetry_span_log
  WHERE trace_id = '68a14b27-a61f-596d-3746-2b03d2530e42' ORDER BY startTime ASC
  ```

  `Query type`を`Traces`に設定してください:

  <Image img={trace_visualization_grafana} size="md" alt="Grafana による ClickHouse トレースの可視化" />

  &quot;Run Query&quot;をクリックし、トレース図を確認します:

  <Image img={trace_visualization_diagram} size="md" alt="Grafana による ClickHouse トレースの可視化" />
</VerticalStepper>