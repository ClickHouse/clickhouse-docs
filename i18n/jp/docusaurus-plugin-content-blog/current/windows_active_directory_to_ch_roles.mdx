---
title: Windows Active Directory セキュリティグループを ClickHouse ロールにマッピングする
description: "Windows Active Directory セキュリティグループを ClickHouse ロールにマッピングする例"
date: 2024-05-20
tags: ['ツールとユーティリティ']
keywords: ['Windows']
---

import Image from "@theme/IdealImage";
import ad_env from "@site/static/images/knowledgebase/windows-ad-ch-roles/AD_Env_and_UO_structure.png";
import ad_group from "@site/static/images/knowledgebase/windows-ad-ch-roles/AD_Group_clickhouse_ad_db1_users.png";
import ad_user from "@site/static/images/knowledgebase/windows-ad-ch-roles/AD_user_clickhouse_db1_user.png";
import ad_user_group from "@site/static/images/knowledgebase/windows-ad-ch-roles/AD_user_to_group.png";

{frontMatter.description}

{/* 省略 */}


## 例

この例では、異なる AD セキュリティグループに属する AD ユーザーに、ClickHouse でロールによるアクセス権を付与する方法を示します。また、1 人のユーザーを複数の AD ユーザーグループに追加し、複数のロールによって付与されるアクセス権を持たせる方法も示します。

この環境には、次のものがあります。

* Windows Active Directory ドメイン: `marsnet2.local`
* ClickHouse クラスター: `cluster_1S_3R`（1 シャード 3 レプリカ構成・3 ノード）
* 3 人の AD ユーザー

| AD User                     | 説明                                        |
| --------------------------- | ----------------------------------------- |
| clickhouse&#95;ad&#95;admin | ClickHouse 管理者ユーザー                        |
| clickhouse&#95;db1&#95;user | db1.table1 へのアクセス権を持つユーザー                 |
| clickhouse&#95;db2&#95;user | db2.table1 へのアクセス権を持つユーザー                 |
| ch&#95;db1&#95;db2&#95;user | db1.table1 と db2.table1 の両方へのアクセス権を持つユーザー |

* 3 つの AD セキュリティグループ

| AD Group                            | 説明                            |
| ----------------------------------- | ----------------------------- |
| clickhouse&#95;ad&#95;admins        | ClickHouse 管理者グループ            |
| clickhouse&#95;ad&#95;db1&#95;users | db1.table1 へのアクセスにマッピングするグループ |
| clickhouse&#95;ad&#95;db2&#95;users | db2.table1 へのアクセスにマッピングするグループ |

* AD 環境と OU 構造の例:

<Image img={ad_env} size="md" alt="AD 環境と OU 構造の例" />

* AD セキュリティグループ構成の例:

<Image img={ad_group} size="md" alt="AD セキュリティグループ構成の例" />

* AD ユーザー構成の例:

<Image img={ad_user} size="md" alt="AD ユーザー構成の例" />

1. Windows AD Users and Groups で、各ユーザーを対応するグループに追加します。これらは ClickHouse のロールにマッピングされます（次のステップで例を示します）。

| AD Security Group           | ClickHouse ロール                                                              |
| --------------------------- | --------------------------------------------------------------------------- |
| clickhouse&#95;ad&#95;admin | clickhouse&#95;ad&#95;admins                                                |
| clickhouse&#95;db1&#95;user | clickhouse&#95;ad&#95;db1&#95;users                                         |
| clickhouse&#95;db2&#95;user | clickhouse&#95;ad&#95;db2&#95;users                                         |
| ch&#95;db1&#95;db2&#95;user | clickhouse&#95;ad&#95;db1&#95;users および clickhouse&#95;ad&#95;db2&#95;users |

* ユーザーグループ メンバーシップの例:

<Image img={ad_user_group} size="md" alt="ユーザーグループ メンバーシップの例" />

2. ClickHouse の `config.xml` で、各 ClickHouse ノードに `ldap_servers` 設定を追加します。

```
<ldap_servers>
	<marsnet2_ad>
		<host>marsdc1.marsnet2.local</host>
		<port>389</port>
		<bind_dn>{user_name}@marsnet2.local</bind_dn>
		<user_dn_detection>
			<base_dn>OU=Users,OU=ClickHouse,DC=marsnet2,DC=local</base_dn>
			<search_filter>(&amp;(objectClass=user)(sAMAccountName={user_name}))</search_filter>
		</user_dn_detection>
		<enable_tls>no</enable_tls>
	</marsnet2_ad>
</ldap_servers>
```

| xml tag                   | 説明                                                             | 値の例                                                 |
| ------------------------- | -------------------------------------------------------------- | --------------------------------------------------- |
| ldap&#95;servers          | ClickHouse が使用する ldap サーバーを定義するためのタグ                           | NA                                                  |
| marsnet&#95;ad            | このタグ名は任意で、`<user_directories>` セクション内でサーバーを識別するためのラベルとして使用されます | NA                                                  |
| host                      | Active Directory サーバーまたはドメインの FQDN または IP アドレス                 | marsdc1.marsnet2.local                              |
| port                      | Active Directory のポート。通常は非 SSL で 389、SSL で 636 を使用します          | 389                                                 |
| bind&#95;dn               | AD へのバインドを確立する際に使用するユーザー。一般ユーザーが使用できない場合は専用ユーザーを使用します          | `{user_name}@marsnet2.local`                        |
| user&#95;dn&#95;detection | ClickHouse が AD ユーザーをどのように検出するかを定義する設定                         | NA                                                  |
| base&#95;dn               | ユーザー検索を開始する AD の OU パス                                         | OU=Users,OU=ClickHouse,DC=marsnet2,DC=local         |
| search&#95;filter         | AD ユーザーを検索するための ldap 検索フィルター                                   | `(&(objectClass=user)(sAMAccountName={user_name}))` |

オプションの全一覧についてはドキュメントを参照してください:
[https://clickhouse.com/docs/operations/external-authenticators/ldap#ldap-server-definition](https://clickhouse.com/docs/operations/external-authenticators/ldap#ldap-server-definition)

3. ClickHouse の `config.xml` に、各 ClickHouse ノードごとに `<ldap>` エントリを含む `<user_directories>` 設定を追加します。


```
<user_directories>
	<users_xml>
		<path>users.xml</path>
	</users_xml>
	<local_directory>
		<path>/var/lib/clickhouse/access/</path>
	</local_directory>
	<ldap>
		<server>marsnet2_ad</server>
		<role_mapping>
			<base_dn>OU=Groups,OU=ClickHouse,DC=marsnet2,DC=local</base_dn>
			<search_filter>(&amp;(objectClass=group)(member={user_dn}))</search_filter>
			<attribute>CN</attribute>
			<scope>subtree</scope>
			<prefix>clickhouse_</prefix>
		</role_mapping>
	</ldap>
</user_directories>
```

| xml tag              | 説明                                                              | 値の例                                          |
| -------------------- | --------------------------------------------------------------- | -------------------------------------------- |
| user&#95;directories | 使用される認証器を定義します                                                  | NA                                           |
| ldap                 | 使用する AD 内の LDAP サーバーに関する設定を含みます                                 | NA                                           |
| server               | `<ldap_servers>` セクションで定義されたタグです                                | marsnet2&#95;ad                              |
| role&#95;mapping     | 認証されたユーザーを AD グループと ClickHouse のロールの間でどのように対応付けるかを定義します         | NA                                           |
| base&#95;dn          | システムが AD グループの検索を開始する際に使用する AD パスです                             | OU=Groups,OU=ClickHouse,DC=marsnet2,DC=local |
| search&#95;filter    | AD グループを検索するための LDAP 検索フィルタです                                   | `(&(objectClass=group)(member={user_dn}))`   |
| attribute            | ユーザーを識別するために使用する AD 属性フィールドです                                   | CN                                           |
| scope                | システムがグループを検索する際に、base DN に対してどの階層までを対象とするかを指定します                | subtree                                      |
| prefix               | AD 内のグループ名のプレフィックスであり、このプレフィックスは削除されて ClickHouse のロールの検索に利用されます | clickhouse&#95;                              |

すべてのオプションについてはドキュメントを参照してください:
[https://clickhouse.com/docs/operations/external-authenticators/ldap#ldap-external-user-directory](https://clickhouse.com/docs/operations/external-authenticators/ldap#ldap-external-user-directory)

**note:::**
この例では AD セキュリティ グループにプレフィックスが付けられています（例: `clickhouse_ad_db1_users`）。システムがこれらを取得する際、プレフィックスは削除され、`clickhouse_ad_db1_users` に対応付けるために、`ad_db1_users` という名前の ClickHouse ロールを探します。
**:::**

4. サンプルデータベースを作成します。

```
create database db1 on cluster 'cluster_1S_3R';
create database db2 on cluster 'cluster_1S_3R';
```

5. サンプルテーブルを作成します。

```
create table db1.table1 on cluster 'cluster_1S_3R'
(
  id Int32,
  column1 String
)
engine = MergeTree()
order by id;

create table db2.table1 on cluster 'cluster_1S_3R
(
  id Int32,
  column1 String
)
engine = MergeTree()
order by id;
```

6. サンプルデータを挿入します。

```
insert into db1.table1
values
(1, 'a');

insert into db2.table1
values
(2, 'b');
```

7. ClickHouse ロールを作成する

```
create role ad_admins on cluster 'cluster_1S_3R';
create role ad_db1_users on cluster 'cluster_1S_3R';
create role ad_db2_users on cluster 'cluster_1S_3R';
```

8. ロールに権限を付与します。

```
GRANT SHOW, SELECT, INSERT, ALTER, CREATE, DROP, UNDROP TABLE, TRUNCATE, OPTIMIZE, BACKUP, KILL QUERY, KILL TRANSACTION, MOVE PARTITION BETWEEN SHARDS, ACCESS MANAGEMENT, SYSTEM, dictGet, displaySecretsInShowAndSelect, INTROSPECTION, SOURCES, CLUSTER ON *.* on cluster 'cluster_1S_3R' TO ad_admins WITH GRANT OPTION;

GRANT SELECT ON db1.table1 on cluster 'cluster_1S_3R' TO ad_db1_users;

GRANT SELECT ON db2.table1 on cluster 'cluster_1S_3R' TO ad_db2_users;
```

9. 制限付き db1 ユーザーのアクセスをテストします。
   例えば、次のように実行します。


```
root@chnode1:/etc/clickhouse-server# clickhouse-client --user clickhouse_db1_user --password MyPassword123  --secure --port 9440 --host chnode1.marsnet.local
ClickHouseクライアントバージョン24.1.3.31(公式ビルド)。
ユーザーclickhouse_db1_userとしてchnode1.marsnet.local:9440に接続中。
ClickHouseサーバーバージョン24.1.3に接続しました。


clickhouse :) select * from db1.table1;

SELECT *
FROM db1.table1

Query id: b04b92d6-5b8b-40a2-a92a-f06f15774930

┌─id─┬─column1─┐
│  1 │ a       │
└────┴─────────┘

1行を取得。経過時間: 0.004秒。

clickhouse :) select * from db2.table1;

SELECT *
FROM db2.table1

Query id: 7f7eaa44-7b47-4184-807a-6968a56057ad


経過時間: 0.115秒。

サーバー(バージョン24.1.3)から例外を受信:
コード: 497. DB::Exception: chnode1.marsnet.local:9440から受信。DB::Exception: clickhouse_db1_user: 権限が不足しています。このクエリを実行するには、db2.table1に対するSELECT(id, column1)の権限付与が必要です。(ACCESS_DENIED)
```

10. db1 と db2 の両方のデータベースにアクセスできるユーザーでアクセスをテストします。
    例えば:

```
root@chnode1:/etc/clickhouse-server# clickhouse-client --user ch_db1_db2_user --password MyPassword123  --secure --port 9440 --host chnode1.marsnet.local
ClickHouse client version 24.1.3.31 (official build).
Connecting to chnode1.marsnet.local:9440 as user ch_db1_db2_user.
Connected to ClickHouse server version 24.1.3.

clickhouse :) select * from db1.table1;

SELECT *
FROM db1.table1

Query id: 23084744-08c2-48bd-8635-a23438812026

┌─id─┬─column1─┐
│  1 │ a       │
└────┴─────────┘

1 row in set. Elapsed: 0.005 sec.

clickhouse :) select * from db2.table1;

SELECT *
FROM db2.table1

Query id: f9954ec4-d8d9-4b5a-9f68-a7aa79a1bb4a

┌─id─┬─column1─┐
│  2 │ b       │
└────┴─────────┘

1 row in set. Elapsed: 0.004 sec.
```

11. Admin ユーザーとしてアクセスをテストします。
    例:


```
root@chnode1:/etc/clickhouse-server# clickhouse-client --user clickhouse_ad_admin --password MyPassword123  --secure --port 9440 --host chnode1.marsnet.local
ClickHouse client version 24.1.3.31 (official build).
Connecting to chnode1.marsnet.local:9440 as user clickhouse_ad_admin.
Connected to ClickHouse server version 24.1.3.

clickhouse :) create table db1.table2 on cluster 'cluster_1S_3R'
(
  id Int32,
  column1 String
)
engine = MergeTree()
order by id;

CREATE TABLE db1.table2 ON CLUSTER cluster_1S_3R
(
    `id` Int32,
    `column1` String
)
ENGINE = MergeTree
ORDER BY id

Query id: 6041fd32-4294-44bd-b442-3fdd41333e6f

┌─host──────────────────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐
│ chnode1.marsnet.local │ 9440 │      0 │       │                   2 │                2 │
└───────────────────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘
┌─host──────────────────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐
│ chnode2.marsnet.local │ 9440 │      0 │       │                   1 │                1 │
└───────────────────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘
┌─host──────────────────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐
│ chnode3.marsnet.local │ 9440 │      0 │       │                   0 │                0 │
└───────────────────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘
```
