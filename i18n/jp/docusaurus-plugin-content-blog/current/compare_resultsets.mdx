---
title: 2つのクエリが同一の結果セットを返すか検証する方法
description: ハッシュ関数と比較手法を用いて、2つの ClickHouse クエリが同一の結果セットを生成するかどうかを検証する方法を学びます。
date: 2023-05-04
tags: ['関数']
keywords: ['検証', '結果セット', 'ハッシュ関数']
---

{frontMatter.description}

{/* 省略 */}

## 質問 \{#question\}

2 つのクエリが同じ結果セットを返すことを検証するにはどうすればよいですか？

## 回答 \{#answer\}

以下の方法を利用できます。

```sql
WITH
    (
        SELECT sum(cityHash64(*))
        FROM
        (
            -- クエリ1をここに記述
            -- SELECT ...
        )
    ) AS q1_resultset_hash,
    (
        SELECT sum(cityHash64(*))
        FROM
        (
            -- クエリ2をここに記述
            -- SELECT ...
        )
    ) AS q2_resultset_hash
SELECT equals(q1_resultset_hash,q2_resultset_hash) as Q1_equals_Q2
```

この例では、[CTE](https://clickhouse.com/docs/sql-reference/statements/select/with) を使って、これら 2 つのクエリ内の各行の [cityHash](https://clickhouse.com/docs/sql-reference/functions/hash-functions#cityhash64) 値の合計を計算し、2 つの結果セットが同一であれば `1` を返します。

整数のシーケンスデータと、少し体裁を整えたフォーマットを使った例は次のとおりです:

```sql
WITH
    (
        SELECT sum(cityHash64(*))
        FROM
        (
            SELECT *
            FROM numbers(10)
            ORDER BY number DESC
        )
    ) AS q1_resultset_hash,
    (
        SELECT sum(cityHash64(*))
        FROM
        (
            SELECT *
            FROM numbers(10)
            ORDER BY number ASC
        )
    ) AS q2_resultset_hash
SELECT q1_resultset_hash = q2_resultset_hash AS Q1_equals_Q2
FORMAT Pretty
```

は以下を返します：

```
┏━━━━━━━━━━━━━━┓
┃ Q1_equals_Q2 ┃
┡━━━━━━━━━━━━━━┩
│            1 │
└──────────────┘
```

これは多くの場面で便利ですが、あらゆる型に対して結果セットの等価性を検証できる万能な「銀の弾丸」とみなすことはできず、使用には注意点があります。たとえば、いずれかの行に `NULL` 値が含まれている場合、上記の手法は失敗します。
