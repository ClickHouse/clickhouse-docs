---
title: 本番環境ではどの ClickHouse バージョンを使うべきか？
description: "まず、この質問がそもそもなぜ出てくるのかを説明します。主な理由は 2 つあります..."
date: 2021-09-01
tags: ['コンセプト', 'パフォーマンスと最適化']
keywords: ['本番環境向けバージョン']
---

{frontMatter.description}

{/* 省略 */}


## はじめに \{#introduction\}

まず最初に、そもそもなぜ人々がこの質問をするのかについて考えてみます。

主な理由は 2 つあります。

1.  ClickHouse はかなり高い頻度で開発が進められており、通常は年間に 10 以上の安定版リリースが行われます。つまり、選択肢となるリリースの幅が広く、どれを選ぶべきかの判断はそれほど単純ではありません。
2.  一部のユーザーは、自分のユースケースに最適なバージョンを調べるのに時間をかけたくないため、他の人の推奨に従いたいと考えます。

2 つ目の理由の方がより本質的なので、まずはこちらから説明し、その後でさまざまな ClickHouse リリースの選び方に話を戻します。

## 推奨される ClickHouse のバージョンはどれですか？ \{#which-clickhouse-version-do-you-recommend\}

本番環境の責任を回避するために、コンサルタントを雇ったり、よく知られた専門家を信頼したくなるかもしれません。誰かが推奨した特定の ClickHouse バージョンをインストールしておけば、もし何か問題が起きても「自分のせいではなく、他人のせいだ」と考えられます。しかし、この考え方は大きな落とし穴です。社外の人間が、あなたの会社の本番環境で何が起きているかを、あなた以上に理解していることはありません。

では、どの ClickHouse バージョンにアップグレードすべきか、あるいは最初の ClickHouse バージョンをどう選ぶべきでしょうか。まず最初に、**現実的なプレ本番環境**を構築することに投資する必要があります。理想的には、本番環境と完全に同一のシャドウコピーにできるとよいですが、通常は高コストです。

コストをあまりかけずに、プレ本番環境の再現性を十分に高めるための主なポイントは次のとおりです。

- プレ本番環境では、本番で実行する予定のクエリセットにできるだけ近いものを実行する必要があります。
    - 固定データだけを使った読み取り専用環境にしないでください。
    - 典型的なレポートを作成せずに、データをコピーするだけの書き込み専用環境にしないでください。
    - スキーママイグレーションを適用する代わりに、環境を毎回クリーンアップしてしまわないでください。
- 実際の本番データとクエリのサンプルを使用してください。`SELECT` クエリが妥当な結果を返すような、代表性のあるサンプルを選ぶようにします。データが機微情報を含み、社内ポリシー上本番環境外に出せない場合は、マスキングや難読化を利用してください。
- プレ本番環境も、本番環境と同様に監視・アラートソフトウェアの対象になっていることを確認してください。
- 本番環境が複数のデータセンターやリージョンにまたがっている場合は、プレ本番環境も同様にしてください。
- 本番環境でレプリケーションや分散テーブル、カスケードするマテリアライズドビューのような複雑な機能を使用している場合は、プレ本番環境でも同様に設定されていることを確認してください。
- プレ本番環境で、本番とほぼ同じ台数だが小さいサイズのサーバーまたは VM を使うか、台数はかなり減らして同じサイズのものを使うかはトレードオフです。前者はネットワーク関連の追加の問題を検出できる可能性がありますが、後者のほうが管理は容易です。

投資すべき 2 つ目の分野は、**自動テストインフラストラクチャ**です。ある種のクエリが一度成功して実行されたからといって、今後も永遠に成功し続けると想定してはいけません。ClickHouse をモック化したユニットテストを用意しても構いませんが、必ず、実際の ClickHouse に対して実行され、すべての重要なユースケースが期待どおりに動作していることを確認する、妥当なセットの自動テストを自社プロダクト側に用意してください。

さらに一歩進めるのであれば、そうした自動テストを、日々の開発で継続的に利用されている [ClickHouse のオープンソーステストインフラストラクチャ](https://github.com/ClickHouse/ClickHouse/tree/master/tests) にコントリビュートするという手もあります。[テストの実行方法](/development/tests) を学び、そのうえで自分のテストをこのフレームワークに適合させるには、当然ながら追加の時間と労力がかかります。しかし、そうすることで、ClickHouse のリリースが安定版としてアナウンスされる時点で、すでにそれらのテストに対して検証済みになり、問題を事後的に報告しては、バグ修正の実装・バックポート・リリースを待つ、という時間を繰り返し失うことを避けられます。企業によっては、こうしたテストのインフラストラクチャへのコントリビュートを、そのインフラを利用する際の社内ポリシーとして定めているところもあります（Google では [Beyonce's Rule](https://www.oreilly.com/library/view/software-engineering-at/9781492082781/ch01.html#policies_that_scale_well) と呼ばれています）。

プレ本番環境とテストインフラストラクチャが整っていれば、最適なバージョンの選定は明快です。

1.  新しい ClickHouse リリースに対して、定期的に自動テストを実行します。`testing` とマークされている ClickHouse リリースに対して実施しても構いませんが、その先のステップに進むことは推奨されません。
2.  テストに合格した ClickHouse リリースをプレ本番環境にデプロイし、すべてのプロセスが期待どおりに動作していることを確認します。
3.  発見した問題はすべて [ClickHouse GitHub Issues](https://github.com/ClickHouse/ClickHouse/issues) に報告します。
4.  重大な問題がなければ、その ClickHouse リリースを本番環境にデプロイし始めても安全と考えられます。[カナリアリリース](https://martinfowler.com/bliki/CanaryRelease.html) や [ブルーグリーンデプロイメント](https://martinfowler.com/bliki/BlueGreenDeployment.html) に類似したアプローチを実装する段階的なリリース自動化に投資することで、本番環境での問題発生リスクをさらに低減できます。

ここまで読んでお気付きかもしれませんが、上で説明したアプローチには ClickHouse 固有のものは何もありません。本番環境を真剣に扱っている人たちは、依存しているあらゆるインフラストラクチャに対して、同じことを行っています。

## ClickHouse のリリースの選び方 \{#how-to-choose-between-clickhouse-releases\}

ClickHouse のパッケージリポジトリの内容を確認すると、次の 2 種類のパッケージがあることが分かります。

1.  `stable`
2.  `lts` (long-term support)

それぞれをどのように選べばよいかについて、以下のガイドラインがあります。

- `stable` は、デフォルトで推奨されるパッケージです。おおよそ毎月リリースされるため（そのため、新機能も過度な遅延なく利用できます）、直近 3 つの stable リリースについては、診断およびバグ修正のバックポートがサポート対象となります。
- `lts` は年に 2 回リリースされ、最初のリリースから 1 年間サポートされます。次のような場合には `stable` よりも `lts` を選択したほうがよいかもしれません。
    - 社内ポリシーにより、頻繁なアップグレードや LTS ではないソフトウェアの利用が許可されていない場合。
    - ClickHouse を二次的なプロダクトで利用しており、複雑な ClickHouse の機能を必要としていない、またはアップデートを継続するだけのリソースがない場合。

当初は `lts` が最適だと考えていた多くのチームも、自分たちのプロダクトにとって重要な新機能が登場したことをきっかけに、最終的には `stable` に切り替えることがよくあります。

:::warning
ClickHouse をアップグレードする際に、もう 1 つ留意すべき点があります。私たちは常にリリース間の互換性を注視していますが、互換性を維持することが合理的でない場合もあり、その結果として細かな挙動が変わることがあります。アップグレードする前に、後方互換性のない変更に関する記述がないかどうかを確認するために、必ず [changelog](/whats-new/changelog) をチェックしてください。
:::