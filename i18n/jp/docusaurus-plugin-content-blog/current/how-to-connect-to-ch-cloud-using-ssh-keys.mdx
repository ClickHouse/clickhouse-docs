---
title: SSH鍵を使用してClickHouseに接続する方法
description: "SSH鍵を使用してClickHouseおよびClickHouse Cloudに接続する方法"
date: 2024-07-25
tags: ['クラウド管理', 'セキュリティと認証']
keywords: ['クラウド', 'SSH']
---

{frontMatter.description}

{/* 切り捨て */}


## 質問 \{#question\}

SSH 鍵認証を使用して ClickHouse に接続するにはどうすればよいですか？

:::note
ここでは例として ClickHouse Cloud を使用していますが、この手順は OSS 版 ClickHouse でも同様に利用できます。
:::

<iframe width="100%" height="315" src="https://www.youtube.com/embed/Rhe-kUyrFUE?si=JgcAusW1TcEyRqPr" title="YouTube 動画プレーヤー" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

## 回答

1. ssh-keygen を使用してキーペアを作成します。例：

```
➜  new ssh-keygen \
-t ed25519 \
> -f /Users/testuser/.ssh/ch_key
ed25519 公開鍵/秘密鍵ペアを生成しています。
パスフレーズを入力してください (パスフレーズなしの場合は空):
同じパスフレーズを再度入力してください:
秘密鍵は /Users/testuser/.ssh/ch_key に保存されました
公開鍵は /Users/testuser/.ssh/ch_key.pub に保存されました
.....
```

2. 公開鍵（上記の例では ch&#95;key.pub）を使用して USER を作成します。

```sql
clickhouse-cloud :) CREATE USER abcuser IDENTIFIED WITH ssh_key BY KEY 'AAAABBBcdE1lZDI1NTE5AAAAIISdl4CrGM8mckXBUXLjL3ef9XwnycDWEvBPu3toB40m' TYPE 'ssh-ed25519';

CREATE USER abcuser IDENTIFIED WITH ssh_key BY KEY AAAABBBcdE1lZDI1NTE5AAAAIISdl4CrGM8mckXBUXLjL3ef9XwnycDWEvBPu3toB40m TYPE `ssh-ed25519`

Query id: 34c6aad6-5f88-4c80-af7a-7d37c91ba7d5

Ok.
```

3. ユーザーが作成されたことを確認するために `SHOW users` を実行します。

4. ユーザーに default&#95;role ロールを付与します（任意）。

```sql
clickhouse-cloud :) grant default_role to abcuser;

GRANT default_role TO abcuser

Query id: 4a054003-220a-4dea-8e8d-eb1f08ee7b10

Ok.

0 rows in set. Elapsed: 0.137 sec.
```

5. ここでプライベートキーを使用して、サービスに対して認証を行います。

```sql
➜  new ./clickhouse client --host myhost.us-central1.gcp.clickhouse.cloud --secure --user abcuser --ssh-key-file '/Users/testuser/.ssh/ch_key'
ClickHouse client version 23.12.1.863 (official build).
秘密鍵のパスフレーズを入力してください（パスフレーズなしの場合は空欄のまま）:
myhost.us-central1.gcp.clickhouse.cloud:9440 にユーザー abcuser として接続しています。
ClickHouse server version 23.9.2 に接続しました。

clickhouse-cloud :) select currentUser();

SELECT currentUser()

Query id: d4b6bb60-ef45-47d3-8740-db9f2941dcd2

┌─currentUser()─┐
│ abcuser       │
└───────────────┘

1 行を取得しました。経過時間: 0.001 秒

clickhouse-cloud :)
```
