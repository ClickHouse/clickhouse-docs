---
title: "DB::Exception: Part XXXXX intersects previous part YYYYY. これはバグであるか、ZooKeeper のデータに対する手動操作の結果です。"
date: 2023-05-02
description: "この記事では、ClickHouse においてパーツ同士の交差に関連して発生する DB::Exception エラーの解決方法を説明します。このエラーは、レースコンディションや ZooKeeper のデータに対する手動操作が原因となることがよくあります。"
tags: ['エラーと例外', 'システムテーブル']
keywords: ['Part Intersects', 'system.replicas']
---

{frontMatter.description}

{/* 省略 */}


## なぜ発生するのか

このエラーが発生すると、テーブルは読み取り専用として表示され、エラーメッセージには互いに交差しているパーツが示されます。

このエラーは、ログで確認するか、次の方法で確認できます。

```sql
SELECT *
FROM system.replicas
WHERE is_readonly = 1
```

エラーメッセージは次のとおりです。

```
コード: 49. DB::Exception: パート XXXXX が前のパート YYYYY と重複しています。これはバグ、または ZooKeeper データへの手動介入による結果です。(LOGICAL_ERROR) (バージョン 21.12.4.1 (公式ビルド))
```


## エラーの原因 \{#cause-of-the-error\}

このエラーは、`mergeSelectingTask` とキューの再初期化との間で発生するレースコンディションによって発生する可能性があります。

## 解決方法

すべてのレプリカで次のクエリを実行します。

```sql
DETACH TABLE table_name;  -- DROP REPLICAの実行に必要

SYSTEM DROP REPLICA 'replica_name' FROM ZKPATH '/table_path_in_zk/'; -- /table_path_in_zk配下のすべてが削除されます

ATTACH TABLE table_name;  -- ZKにメタデータが存在しないため、テーブルは読み取り専用モードになります
```

次に、すべてのレプリカで以下を実行します。

```sql
SYSTEM RESTORE REPLICA table_name;  -- すべてのパーティションをデタッチし、ZooKeeper内のメタデータを再作成(新しい空のテーブルと同様)した後、すべてのパーティションを再アタッチします

SYSTEM SYNC REPLICA table_name; -- レプリカがパーツを同期するまで待機します。また、リカバリ完了後は全レプリカで `system.detached_parts` を確認することを推奨します。
```

:::tip
最新バージョンの ClickHouse へアップグレードしてください
:::


## 追加リソース \{#additional-resources\}

関連する PR および GitHub Issue:

- [ClickHouse/ClickHouse#34096](https://github.com/ClickHouse/ClickHouse/pull/34096)
- [ClickHouse/ClickHouse#30651](https://github.com/ClickHouse/ClickHouse/pull/30651)
- [ClickHouse/ClickHouse#31060](https://github.com/ClickHouse/ClickHouse/pull/31060)
- [ClickHouse/ClickHouse#35863](https://github.com/ClickHouse/ClickHouse/issues/35863)

## 影響を受けるバージョン: \{#versions-affected\}

ClickHouse v 22.12 以前