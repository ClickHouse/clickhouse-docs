---
slug: /changelogs/24.10
title: 'v24.10 Cloud 版本更新日志'
description: 'v24.10 快速发布版本的更新日志'
keywords: ['changelog', 'cloud']
sidebar_label: '24.10'
sidebar_position: 5
doc_type: 'changelog'
---

基于 v24.10 版本发布的 ClickHouse Cloud 服务相关变更。



## 向后不兼容的变更 {#backward-incompatible-change}

- 允许在使用 `UNION` 的查询链中,当子查询位于括号内时,在 `FORMAT` 之前编写 `SETTINGS`。这解决了 [#39712](https://github.com/ClickHouse/ClickHouse/issues/39712)。更改了当查询中连续指定两次 SETTINGS 子句时的行为。最近的 SETTINGS 子句将优先应用于相应的子查询。在以前的版本中,最外层的 SETTINGS 子句可能优先于内层的子句。[#60197](https://github.com/ClickHouse/ClickHouse/pull/60197)[#68614](https://github.com/ClickHouse/ClickHouse/pull/68614) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 重新实现了 Dynamic 类型。现在当达到动态数据类型的限制时,新类型不会被转换为 String,而是以二进制格式存储在特殊数据结构中,并使用二进制编码的数据类型。现在任何曾经插入到 Dynamic 列中的类型都可以作为子列从中读取。[#68132](https://github.com/ClickHouse/ClickHouse/pull/68132) ([Pavel Kruglov](https://github.com/Avogar))。
- 现在支持对命名元组使用类似 `a[b].c` 的表达式,以及从任意表达式中使用命名下标,例如 `expr().name`。这对于处理 JSON 很有用。这解决了 [#54965](https://github.com/ClickHouse/ClickHouse/issues/54965)。在以前的版本中,形如 `expr().name` 的表达式被解析为 `tupleElement(expr(), name)`,查询分析器会搜索名为 `name` 的列,而不是相应的元组元素;而在新版本中,它被更改为 `tupleElement(expr(), 'name')`。在大多数情况下,以前的版本无法正常工作,但可以想象一个非常不寻常的场景,这种变更可能导致不兼容:如果您将元组元素的名称存储在列或别名中,且该列或别名的名称与元组元素的名称不同:`SELECT 'b' AS a, CAST([tuple(123)] AS 'Array(Tuple(b UInt8))') AS t, t[1].a`。您不太可能使用过这样的查询,但我们仍然必须将此变更标记为可能向后不兼容。[#68435](https://github.com/ClickHouse/ClickHouse/pull/68435) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 当启用 `print_pretty_type_names` 设置时,它将在 `SHOW CREATE TABLE` 语句、`formatQuery` 函数以及 `clickhouse-client` 和 `clickhouse-local` 的交互模式中以美化形式打印 `Tuple` 数据类型。在以前的版本中,此设置仅应用于 `DESCRIBE` 查询和 `toTypeName`。这解决了 [#65753](https://github.com/ClickHouse/ClickHouse/issues/65753)。[#68492](https://github.com/ClickHouse/ClickHouse/pull/68492) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 现在默认允许对 `[PRE]WHERE` 子句中的过滤条件进行重新排序。可以通过将 `allow_reorder_prewhere_conditions` 设置为 `false` 来禁用此功能。[#70657](https://github.com/ClickHouse/ClickHouse/pull/70657) ([Nikita Taranov](https://github.com/nickitat))。
- 修复了 `optimize_functions_to_subcolumns` 优化(以前可能导致 `Invalid column type for ColumnUnique::insertRangeFrom. Expected String, got LowCardinality(String)` 错误),通过在 `mapKeys`/`mapValues` 中保留 `LowCardinality` 类型。[#70716](https://github.com/ClickHouse/ClickHouse/pull/70716) ([Azat Khuzhin](https://github.com/azat))。


## 新功能 {#new-feature}

- 可刷新物化视图已正式可用于生产环境。[#70550](https://github.com/ClickHouse/ClickHouse/pull/70550) ([Michael Kolupaev](https://github.com/al13n321))。可刷新物化视图现已支持在复制数据库中使用。[#60669](https://github.com/ClickHouse/ClickHouse/pull/60669) ([Michael Kolupaev](https://github.com/al13n321))。
- 函数 `toStartOfInterval()` 现在新增了一个重载版本,可以模拟 TimescaleDB 的 `time_bucket()` 函数以及 PostgreSQL 的 `date_bin()` 函数。([#55619](https://github.com/ClickHouse/ClickHouse/issues/55619))。它允许将日期或时间戳值对齐到从_任意_起点开始的给定间隔的倍数(而不是以 0000-01-01 00:00:00.000 作为_固定_起点)。例如,`SELECT toStartOfInterval(toDateTime('2023-01-01 14:45:00'), INTERVAL 1 MINUTE, toDateTime('2023-01-01 14:35:30'));` 返回 `2023-01-01 14:44:30`,这是从起点 `2023-01-01 14:35:30` 开始的 1 分钟间隔的倍数。[#56738](https://github.com/ClickHouse/ClickHouse/pull/56738) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- MongoDB 集成已重构:从已弃用的 Poco::MongoDB 迁移到新驱动程序 mongocxx,移除对已弃用旧协议的支持,支持通过 URI 连接,支持所有 MongoDB 类型,支持在 MongoDB 端执行 WHERE 和 ORDER BY 语句,限制 MongoDB 不支持的表达式。[#63279](https://github.com/ClickHouse/ClickHouse/pull/63279) ([Kirill Nikiforov](https://github.com/allmazz))。
- clickhouse-client 中新增的 `--progress-table` 选项可打印一个表格,显示查询执行期间变化的指标;新增的 `--enable-progress-table-toggle` 选项与 `--progress-table` 选项相关联,通过按下控制键(空格键)来切换进度表的渲染。[#63689](https://github.com/ClickHouse/ClickHouse/pull/63689) ([Maria Khristenko](https://github.com/mariaKhr))。
- 这允许授予对通配符前缀的访问权限。`GRANT SELECT ON db.table_pefix_* TO user`。[#65311](https://github.com/ClickHouse/ClickHouse/pull/65311) ([pufit](https://github.com/pufit))。
- 引入了 JSONCompactWithProgress 格式,其中 ClickHouse 将每一行输出为换行符分隔的 JSON 对象,包括元数据、数据、进度、总计和统计信息。[#66205](https://github.com/ClickHouse/ClickHouse/pull/66205) ([Alexey Korepanov](https://github.com/alexkorep))。
- 添加了 system.query_metric_log,其中包含来自 system.events 表的各个查询的内存和指标值历史记录,定期刷新到磁盘。[#66532](https://github.com/ClickHouse/ClickHouse/pull/66532) ([Pablo Marcos](https://github.com/pamarcos))。
- 添加了 `input_format_json_empty_as_default` 设置,启用后会将 JSON 输入中的空字段视为默认值。关闭 [#59339](https://github.com/ClickHouse/ClickHouse/issues/59339)。[#66782](https://github.com/ClickHouse/ClickHouse/pull/66782) ([Alexis Arnaud](https://github.com/a-a-f))。
- 添加了函数 `overlay` 和 `overlayUTF8`,用于将字符串的部分内容替换为另一个字符串。示例:`SELECT overlay('Hello New York', 'Jersey', 11)` 返回 `Hello New Jersey`。[#66933](https://github.com/ClickHouse/ClickHouse/pull/66933) ([李扬](https://github.com/taiyang-li))。
- 添加了新命令,分区内轻量级删除 `DELETE FROM [db.]table [ON CLUSTER cluster] [IN PARTITION partition_expr] WHERE expr;` ``` VM-114-29-tos :) select \* from ads_app_poster_ip_source_channel_di_replicated_local;. [#67805](https://github.com/ClickHouse/ClickHouse/pull/67805) ([sunny](https://github.com/sunny19930321))。
- 实现了 `Interval` 数据类型值的比较,现在它们会转换为最小公共超类型。[#68057](https://github.com/ClickHouse/ClickHouse/pull/68057) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- 添加了 create_if_not_exists 设置,在 CREATE 语句中默认使用 IF NOT EXISTS 行为。[#68164](https://github.com/ClickHouse/ClickHouse/pull/68164) ([Peter Nguyen](https://github.com/petern48))。
- 使得可以在 Azure 和本地读取 Iceberg 表。[#68210](https://github.com/ClickHouse/ClickHouse/pull/68210) ([Daniil Ivanik](https://github.com/divanik))。
- 添加了聚合函数 distinctDynamicTypes/distinctJSONPaths/distinctJSONPathsAndTypes,以更好地检查 JSON 列类型内容。[#68463](https://github.com/ClickHouse/ClickHouse/pull/68463) ([Pavel Kruglov](https://github.com/Avogar))。
- 现在可以按标签删除查询缓存条目。例如,由 `SELECT 1 SETTINGS use_query_cache = true, query_cache_tag = 'abc'` 创建的查询缓存条目现在可以通过 `SYSTEM DROP QUERY CACHE TAG 'abc'` 删除(或者当然也可以使用:`SYSTEM DROP QUERY CACHE`,这将清除整个查询缓存)。[#68477](https://github.com/ClickHouse/ClickHouse/pull/68477) ([Michał Tabaszewski](https://github.com/pinsvin00))。
- 简单的 SELECT 查询可以使用隐式 SELECT 编写,以启用计算器风格的表达式,例如 `ch "1 + 2"`。这由新设置 `implicit_select` 控制。[#68502](https://github.com/ClickHouse/ClickHouse/pull/68502) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 支持 clickhouse local 的 --copy 模式作为格式转换的快捷方式 [#68503](https://github.com/ClickHouse/ClickHouse/issues/68503)。[#68583](https://github.com/ClickHouse/ClickHouse/pull/68583) ([Denis Hananein](https://github.com/denis-hananein))。
- 添加了 `ripeMD160` 函数,用于计算字符串的 RIPEMD-160 加密哈希。示例:`SELECT hex(ripeMD160('The quick brown fox jumps over the lazy dog'))` 返回 `37F332F68DB77BD9D7EDD4969571AD671CF9DD3B`。[#68639](https://github.com/ClickHouse/ClickHouse/pull/68639) ([Dergousov Maxim](https://github.com/m7kss1))。
- 为 url 表引擎添加虚拟列 \_headers。关闭 [#65026](https://github.com/ClickHouse/ClickHouse/issues/65026)。[#68867](https://github.com/ClickHouse/ClickHouse/pull/68867) ([flynn](https://github.com/ucasfl))。
- 添加 `system.projections` 表以跟踪可用的投影。[#68901](https://github.com/ClickHouse/ClickHouse/pull/68901) ([Jordi Villar](https://github.com/jrdi))。
- 添加对 `arrayUnion` 函数的支持。[#68989](https://github.com/ClickHouse/ClickHouse/pull/68989) ([Peter Nguyen](https://github.com/petern48))。
- 添加新函数 `arrayZipUnaligned` 以实现 Spark 兼容性(arrays_zip),它允许基于原始 `arrayZip` 的非对齐数组。``` sql SELECT arrayZipUnaligned([1], [1, 2, 3]). [#69030](https://github.com/ClickHouse/ClickHouse/pull/69030) ([李扬](https://github.com/taiyang-li))。
- 支持聚合函数 `quantileExactWeightedInterpolated`,这是基于 quantileExactWeighted 的插值版本。有些人可能会疑惑,既然我们已经有了 `quantileExactInterpolatedWeighted`,为什么还需要新的 `quantileExactWeightedInterpolated`。原因是新版本比旧版本更准确。顺便说一句,这是为了在 Apache Gluten 中实现 Spark 兼容性。[#69619](https://github.com/ClickHouse/ClickHouse/pull/69619) ([李扬](https://github.com/taiyang-li))。
- 支持函数 arrayElementOrNull。如果数组索引超出范围或未找到映射键,则返回 null。[#69646](https://github.com/ClickHouse/ClickHouse/pull/69646) ([李扬](https://github.com/taiyang-li))。
- 通过在 Dynamic 内部类型上执行大多数函数来支持 Dynamic 类型。[#69691](https://github.com/ClickHouse/ClickHouse/pull/69691) ([Pavel Kruglov](https://github.com/Avogar))。
- 为函数 `arrayAUC` 添加参数 `scale`(默认值:`true`),允许跳过归一化步骤(问题 [#69609](https://github.com/ClickHouse/ClickHouse/issues/69609))。[#69717](https://github.com/ClickHouse/ClickHouse/pull/69717) ([gabrielmcg44](https://github.com/gabrielmcg44))。
- 重新添加了 `RIPEMD160` 函数,用于计算字符串的 RIPEMD-160 加密哈希。示例:`SELECT HEX(RIPEMD160('The quick brown fox jumps over the lazy dog'))` 返回 `37F332F68DB77BD9D7EDD4969571AD671CF9DD3B`。[#70087](https://github.com/ClickHouse/ClickHouse/pull/70087) ([Dergousov Maxim](https://github.com/m7kss1))。
- 允许使用 ETag + 文件路径的哈希作为缓存键,为对象存储表引擎和数据湖缓存读取的文件。[#70135](https://github.com/ClickHouse/ClickHouse/pull/70135) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 支持在 HDFS 上读取 Iceberg 表。[#70268](https://github.com/ClickHouse/ClickHouse/pull/70268) ([flynn](https://github.com/ucasfl))。
- 允许在设置 `input_format_binary_read_json_as_string/output_format_binary_write_json_as_string` 下,在 RowBinary 格式中将 JSON 类型作为二进制字符串读取/写入。[#70288](https://github.com/ClickHouse/ClickHouse/pull/70288) ([Pavel Kruglov](https://github.com/Avogar))。
- 允许在 Native 格式中将 JSON 列序列化/反序列化为单个 String 列。对于输出,使用设置 `output_format_native_write_json_as_string`。对于输入,在列数据之前使用序列化版本 `1`。[#70312](https://github.com/ClickHouse/ClickHouse/pull/70312) ([Pavel Kruglov](https://github.com/Avogar))。
- 支持标准 CTE,`with insert`,之前仅支持 `insert ... with ...`。[#70593](https://github.com/ClickHouse/ClickHouse/pull/70593) ([Shichao Jin](https://github.com/jsc0218))。
