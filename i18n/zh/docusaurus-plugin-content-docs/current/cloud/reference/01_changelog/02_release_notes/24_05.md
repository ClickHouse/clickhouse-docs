---
slug: /changelogs/24.5
title: 'v24.5 云版更新日志'
description: 'v24.5 快速发布更新日志'
keywords: ['更新日志', '云']
sidebar_label: '24.5'
sidebar_position: 8
doc_type: 'changelog'
---



# V24.5 Cloud 版本更新日志

基于 v24.5 版本的 ClickHouse Cloud 服务相关变更。



## 破坏性变更 {#breaking-changes}

- 将 system.zookeeper 表中的列名从 duration_ms 更改为 duration_microseconds,以反映持续时间实际为微秒精度。[#60774](https://github.com/ClickHouse/ClickHouse/pull/60774) (Duc Canh Le)。

- 不允许将 max_parallel_replicas 设置为 0,因为这没有意义。将其设置为 0 可能导致意外的逻辑错误。关闭 #60140。[#61201](https://github.com/ClickHouse/ClickHouse/pull/61201) (Kruglov Pavel)。

- 移除对 INSERT WATCH 查询的支持(实验性 LIVE VIEW 功能的一部分)。[#62382](https://github.com/ClickHouse/ClickHouse/pull/62382) (Alexey Milovidov)。

- 函数 neighbor、runningAccumulate、runningDifferenceStartingWithFirstValue、runningDifference 的使用已被弃用(因为它们容易出错)。应使用合适的窗口函数来代替。要重新启用它们,请设置 allow_deprecated_error_prone_window_functions=1。[#63132](https://github.com/ClickHouse/ClickHouse/pull/63132) (Nikita Taranov)。


## 向后不兼容的变更 {#backward-incompatible-changes}

- 在新版本的 ClickHouse 中,如果所有参数均为 Float64 类型,函数 geoDistance、greatCircleDistance 和 greatCircleAngle 将使用 64 位双精度浮点数据类型进行内部计算并返回该类型。此变更解决了 #58476 问题。在之前的版本中,这些函数始终使用 Float32。您可以通过将 geo_distance_returns_float64_on_float64_arguments 设置为 false 或将 compatibility 设置为 24.2 或更早版本来恢复旧行为。[#61848](https://github.com/ClickHouse/ClickHouse/pull/61848) (Alexey Milovidov)。

- 当存在大量列,但许多数据库或表未被授予 SHOW TABLES 权限时,对 system.columns 的查询将运行得更快。请注意,在之前的版本中,如果您对单个列授予 SHOW COLUMNS 权限而未对相应的表授予 SHOW TABLES 权限,system.columns 表将显示这些列,但在新版本中将完全跳过该表。移除了会降低查询速度的跟踪日志消息"Access granted"和"Access denied"。[#63439](https://github.com/ClickHouse/ClickHouse/pull/63439) (Alexey Milovidov)。

- 修复了 largestTriangleThreeBuckets 中的崩溃问题。此变更改变了该函数的行为,使其忽略所提供序列中的 NaN 值。因此,结果集可能与之前的版本不同。[#62646](https://github.com/ClickHouse/ClickHouse/pull/62646) (Raúl Marín)。


## 新功能 {#new-features}

- 新分析器在新服务上默认启用。

- 支持同时删除多个表,例如 drop table a,b,c;。[#58705](https://github.com/ClickHouse/ClickHouse/pull/58705) (zhongyuankai)。

- 用户现在可以使用设置 input_format_tsv_crlf_end_of_line 在 TSV 格式中解析 CRLF。关闭 #56257。[#59747](https://github.com/ClickHouse/ClickHouse/pull/59747) (Shaun Struwig)。

- 表引擎现在可授权,且不会影响现有用户的行为。[#60117](https://github.com/ClickHouse/ClickHouse/pull/60117) (jsc0218)。

- 添加 Form 格式以在 application/x-www-form-urlencoded 格式中读取/写入单条记录。[#60199](https://github.com/ClickHouse/ClickHouse/pull/60199) (Shaun Struwig)。

- 添加了在 CROSS JOIN 中进行压缩的功能。[#60459](https://github.com/ClickHouse/ClickHouse/pull/60459) (p1rattttt)。

- 新设置 input_format_force_null_for_omitted_fields 强制为省略的字段设置 NULL 值。[#60887](https://github.com/ClickHouse/ClickHouse/pull/60887) (Constantine Peresypkin)。

- 支持涉及左表和右表列的不等条件连接。例如 `t1.y < t2.y`。要启用,请设置 SET allow_experimental_join_condition = 1。[#60920](https://github.com/ClickHouse/ClickHouse/pull/60920) (lgbo)。

- 添加新函数 getClientHTTPHeader。关闭 #54665。与 @lingtaolf 共同完成。[#61820](https://github.com/ClickHouse/ClickHouse/pull/61820) (Alexey Milovidov)。

- 为方便起见,SELECT * FROM numbers() 将以与 SELECT * FROM system.numbers 相同的方式工作 - 无限制。[#61969](https://github.com/ClickHouse/ClickHouse/pull/61969) (YenchangChan)。

- 现在支持通过 ALTER MODIFY SETTING 修改内存表设置。ALTER TABLE memory MODIFY SETTING min_rows_to_keep = 100, max_rows_to_keep = 1000;。[#62039](https://github.com/ClickHouse/ClickHouse/pull/62039) (zhongyuankai)。

- 分析器支持递归 CTE。[#62074](https://github.com/ClickHouse/ClickHouse/pull/62074) (Maksim Kita)。

- 早期我们的 s3 存储和 s3 表函数不支持从归档文件中选择。我创建了一个解决方案,允许迭代 S3 中归档文件内的文件。[#62259](https://github.com/ClickHouse/ClickHouse/pull/62259) (Daniil Ivanik)。

- 支持条件函数 clamp。[#62377](https://github.com/ClickHouse/ClickHouse/pull/62377) (skyoct)。

- 添加 npy 输出格式。[#62430](https://github.com/ClickHouse/ClickHouse/pull/62430) (豪肥肥)。

- 分析器支持 QUALIFY 子句。关闭 #47819。[#62619](https://github.com/ClickHouse/ClickHouse/pull/62619) (Maksim Kita)。

- 在 HTTP 接口中添加了 role 查询参数。它的工作方式类似于 SET ROLE x,在执行语句之前应用角色。这允许克服 HTTP 接口的限制,因为不允许多个语句,并且无法同时发送 SET ROLE x 和语句本身。可以通过这种方式设置多个角色,例如 ?role=x&role=y,这相当于 SET ROLE x, y。[#62669](https://github.com/ClickHouse/ClickHouse/pull/62669) (Serge Klochkov)。

- 添加 SYSTEM UNLOAD PRIMARY KEY。[#62738](https://github.com/ClickHouse/ClickHouse/pull/62738) (Pablo Marcos)。


* 新增 SQL 函数 generateUUIDv7、generateUUIDv7ThreadMonotonic、generateUUIDv7NonMonotonic（在单调性和性能之间具有不同权衡），用于生成版本 7 UUID，即带随机组件的基于时间戳的 UUID。同时新增函数 UUIDToNum 用于从 UUID 中提取字节，以及函数 UUIDv7ToDateTime 用于从版本 7 UUID 中提取时间戳组件。[#62852](https://github.com/ClickHouse/ClickHouse/pull/62852) (Alexey Petrunyaka)。

* 新增将 Raw 作为 TSVRaw 的别名。[#63394](https://github.com/ClickHouse/ClickHouse/pull/63394) (Unalian)。

* 新增当大小超出限制时，可以在临时文件中执行 CROSS JOIN 的功能。[#63432](https://github.com/ClickHouse/ClickHouse/pull/63432) (p1rattttt)。



## 性能改进 {#performance-improvements}

- 在 INSERT 操作期间跳过新创建投影块的合并。[#59405](https://github.com/ClickHouse/ClickHouse/pull/59405) (Nikita Taranov)。

- 降低 SELECT 操作中 mutation 的开销(v2)。[#60856](https://github.com/ClickHouse/ClickHouse/pull/60856) (Azat Khuzhin)。

- 使用等价集改进 JOIN 过滤器下推。[#61216](https://github.com/ClickHouse/ClickHouse/pull/61216) (Maksim Kita)。

- 添加新的分析器遍历以优化单值场景。[#61564](https://github.com/ClickHouse/ClickHouse/pull/61564) (LiuNeng)。

- 当输入字符串全部为 ASCII 字符时,以 ASCII 方式处理字符串函数 XXXUTF8。灵感来自 apache/doris#29799。总体速度提升 1.07 倍至 1.62 倍。注意,在某些情况下峰值内存使用量有所降低。[#61632](https://github.com/ClickHouse/ClickHouse/pull/61632) (李扬)。

- 默认启用快速 Parquet 编码器(output_format_parquet_use_custom_encoder)。[#62088](https://github.com/ClickHouse/ClickHouse/pull/62088) (Michael Kolupaev)。

- 通过在读取所有必需字段后跳过所有剩余字段来改进 JSONEachRowRowInputFormat。[#62210](https://github.com/ClickHouse/ClickHouse/pull/62210) (lgbo)。

- 函数 splitByChar 和 splitByRegexp 的速度显著提升。[#62392](https://github.com/ClickHouse/ClickHouse/pull/62392) (李扬)。

- 改进从 file/s3/hdfs/url/... 表函数中的文件进行简单 insert select 的性能。添加独立的 max_parsing_threads 设置以控制并行解析使用的线程数。[#62404](https://github.com/ClickHouse/ClickHouse/pull/62404) (Kruglov Pavel)。

- 支持通过设置 azure_allow_parallel_part_upload 来管理 AzureBlobStorage 的并行写入缓冲区。[#62534](https://github.com/ClickHouse/ClickHouse/pull/62534) (SmitaRKulkarni)。

- 函数 to_utc_timestamp 和 from_utc_timestamp 现在速度提升约 2 倍。[#62583](https://github.com/ClickHouse/ClickHouse/pull/62583) (KevinyhZou)。

- 当输入主要包含不可解析值时,函数 parseDateTimeOrNull、parseDateTimeOrZero、parseDateTimeInJodaSyntaxOrNull 和 parseDateTimeInJodaSyntaxOrZero 现在运行速度显著加快(10 倍至 1000 倍)。[#62634](https://github.com/ClickHouse/ClickHouse/pull/62634) (LiuNeng)。

- 更改 HostResolver 在失败时的行为,每个 IP 仅保留一条记录 [#62652](https://github.com/ClickHouse/ClickHouse/pull/62652) (Anton Ivashkin)。

- 添加新配置 prefer_merge_sort_block_bytes 以控制内存使用,并在存在大量列时将合并排序速度提升 2 倍。[#62904](https://github.com/ClickHouse/ClickHouse/pull/62904) (LiuNeng)。

- 如果 JOIN 后的过滤器始终过滤默认值,QueryPlan 会将 OUTER JOIN 转换为 INNER JOIN 进行优化。该优化可通过设置 query_plan_convert_outer_join_to_inner_join 控制,默认启用。[#62907](https://github.com/ClickHouse/ClickHouse/pull/62907) (Maksim Kita)。

- 默认启用 optimize_rewrite_sum_if_to_count_if。[#62929](https://github.com/ClickHouse/ClickHouse/pull/62929) (Raúl Marín)。

- 对新分析器进行微优化。[#63429](https://github.com/ClickHouse/ClickHouse/pull/63429) (Raúl Marín)。

- 当 DateTime 与 DateTime64 进行比较时,索引分析将正常工作。这解决了 #63441。[#63443](https://github.com/ClickHouse/ClickHouse/pull/63443) (Alexey Milovidov)。

- 通过移除冗余数据,将 set 类型索引的速度略微提升(约 1.5 倍)。[#64098](https://github.com/ClickHouse/ClickHouse/pull/64098) (Alexey Milovidov)。


# 改进

* 移除 `optimize_monotonous_functions_in_order_by` 设置，该设置现在已不再产生任何效果（no-op）。[#63004](https://github.com/ClickHouse/ClickHouse/pull/63004) (Raúl Marín)。

* `Map` 现在可以使用 `Float32`、`Float64`、`Array(T)`、`Map(K,V)` 和 `Tuple(T1, T2, ...)` 作为键。关闭 issue #54537。[#59318](https://github.com/ClickHouse/ClickHouse/pull/59318) (李扬)。

* 为 `AzureBlobStorage` 添加类似于 S3 的异步 `WriteBuffer`。[#59929](https://github.com/ClickHouse/ClickHouse/pull/59929) (SmitaRKulkarni)。

* 支持在保留边框的同时调整列宽的多行字符串。[#59940](https://github.com/ClickHouse/ClickHouse/pull/59940) (Volodyachan)。

* 让 RabbitMQ 对损坏的消息执行 `nack`。关闭 issue #45350。[#60312](https://github.com/ClickHouse/ClickHouse/pull/60312) (Kseniia Sumarokova)。

* 添加设置 `first_day_of_week`，它会影响函数 `toStartOfInterval(..., INTERVAL ... WEEK)` 所认为的一周的第一天。这样可以与函数 `toStartOfWeek` 保持一致，后者默认将星期日视为一周的第一天。[#60598](https://github.com/ClickHouse/ClickHouse/pull/60598) (Jordi Villar)。

* 新增持久化虚拟列 `_block_offset`，用于保存写入时分配的块内原始行号。可以通过设置 `enable_block_offset_column` 启用 `_block_offset` 列的持久化。新增虚拟列 `_part_data_version`，其包含分片的最小块号或变更版本。持久化虚拟列 `_block_number` 不再被视为实验性功能。[#60676](https://github.com/ClickHouse/ClickHouse/pull/60676) (Anton Popov)。

* 函数 `date_diff` 和 `age` 现在以纳秒精度而不是微秒精度计算结果。它们现在还支持 `nanosecond`（或 `nanoseconds` 或 `ns`）作为 `unit` 参数的可选值。[#61409](https://github.com/ClickHouse/ClickHouse/pull/61409) (Austin Kothig)。

* 现在在合并过程中对宽部件不再加载标记（marks）。[#61551](https://github.com/ClickHouse/ClickHouse/pull/61551) (Anton Popov)。

* 默认启用 `output_format_pretty_row_numbers`。这可以提升可用性。[#61791](https://github.com/ClickHouse/ClickHouse/pull/61791) (Alexey Milovidov)。

* 进度条现在也适用于来自 `system.zeros`、`system.zeros_mt`（此前已支持 `system.numbers` 和 `system.numbers_mt`）以及 `generateRandom` 表函数的、带 `LIMIT` 的简单查询。额外改进：如果记录总数大于 `max_rows_to_read` 限制，将更早抛出异常。此项关闭 issue #58183。[#61823](https://github.com/ClickHouse/ClickHouse/pull/61823) (Alexey Milovidov)。

* 新增 `TRUNCATE ALL TABLES`。[#61862](https://github.com/ClickHouse/ClickHouse/pull/61862) (豪肥肥)。

* 添加设置 `input_format_json_throw_on_bad_escape_sequence`，禁用该设置允许在 JSON 输入格式中保留错误的转义序列。[#61889](https://github.com/ClickHouse/ClickHouse/pull/61889) (Kruglov Pavel)。

* 修正警告信息中的语法，将 "a" 改为 "the"。因为只有一个 Atomic 引擎，所以应为 "to the new Atomic engine" 而不是 "to a new Atomic engine"。[#61952](https://github.com/ClickHouse/ClickHouse/pull/61952) (shabroo)。

* 修复在撤销 quorum 插入事务时出现的逻辑错误。[#61953](https://github.com/ClickHouse/ClickHouse/pull/61953) (Han Fei)。

* 自动从 Apache Arrow schema 推断 `Nullable` 列类型。[#61984](https://github.com/ClickHouse/ClickHouse/pull/61984) (Maksim Kita)。

* 允许在聚合过程中取消聚合状态的并行合并。例如：`uniqExact`。[#61992](https://github.com/ClickHouse/ClickHouse/pull/61992) (Maksim Kita)。

* 启动时使用 `INVALIDATE_QUERY` 的字典源不会被重新加载两次。[#62050](https://github.com/ClickHouse/ClickHouse/pull/62050) (vdimir)。



* 现在，针对 ReplicatedMergeTree 的 OPTIMIZE FINAL 将会等待当前正在进行的合并结束，然后重新尝试调度最终合并。这会使其行为与普通 MergeTree 更加一致。[#62067](https://github.com/ClickHouse/ClickHouse/pull/62067) (Nikita Taranov)。

* 从 hive 文本文件读取数据时，会使用该文件的第一行来重新设定输入字段的数量，但有时第一行的字段数量与 hive 表定义的不匹配。比如 hive 表定义为 3 列：test_tbl(a Int32, b Int32, c Int32)，但文本文件的第一行只有 2 个字段，此时输入字段数会被调整为 2。如果文本文件的下一行有 3 个字段，那么第三个字段将无法被读取，而是被设置为默认值 0，这是不正确的。[#62086](https://github.com/ClickHouse/ClickHouse/pull/62086) (KevinyhZou)。

* 客户端在输入时的语法高亮现在将在语法层面工作（之前是在词法层面）。[#62123](https://github.com/ClickHouse/ClickHouse/pull/62123) (Alexey Milovidov)。

* 修复了一个问题：当在涉及主键的布尔表达式后添加多余的 = 1 或 = 0 时，主索引不会被使用。例如，`SELECT * FROM <table> WHERE <primary-key> IN (<value>) = 1` 和 `SELECT * FROM <table> WHERE <primary-key> NOT IN (<value>) = 0` 都会执行全表扫描，而本可以使用主索引。[#62142](https://github.com/ClickHouse/ClickHouse/pull/62142) (josh-hildred)。

* 新增设置 lightweight_deletes_sync（默认值：2 - 同步等待所有副本）。该设置与 mutations_sync 类似，但只影响轻量级删除（lightweight deletes）的行为。[#62195](https://github.com/ClickHouse/ClickHouse/pull/62195) (Anton Popov)。

* 在为自定义设置解析值时，区分布尔值和整数：SET custom_a = true; SET custom_b = 1;。[#62206](https://github.com/ClickHouse/ClickHouse/pull/62206) (Vitaly Baranov)。

* 支持通过 AWS PrivateLink Interface 端点访问 S3。关闭问题 #60021、#31074 和 #53761。[#62208](https://github.com/ClickHouse/ClickHouse/pull/62208) (Arthur Passos)。

* 客户端必须向服务器发送头部 `Keep-Alive: timeout=X`。如果客户端从服务器接收到带有该头部的响应，则客户端必须使用服务器提供的值。此外，为避免连接关闭竞争，客户端最好不要使用接近过期的连接。[#62249](https://github.com/ClickHouse/ClickHouse/pull/62249) (Sema Checherinda)。

* 为 date_trunc 新增纳秒、微秒和毫秒单位。[#62335](https://github.com/ClickHouse/ClickHouse/pull/62335) (Misz606)。

* 查询缓存现在不再缓存针对系统表（system.*、information_schema.*、INFORMATION_SCHEMA.*）的查询结果。[#62376](https://github.com/ClickHouse/ClickHouse/pull/62376) (Robert Schulze)。

* MOVE PARTITION TO TABLE 查询可以被延迟执行，或者抛出 TOO_MANY_PARTS 异常，以避免数据块数量超出限制。对其应用的设置和限制与 INSERT 查询相同（参见 max_parts_in_total、parts_to_delay_insert、parts_to_throw_insert、inactive_parts_to_throw_insert、inactive_parts_to_delay_insert、max_avg_part_size_for_too_many_parts、min_delay_to_insert_ms 和 max_delay_to_insert 设置）。[#62420](https://github.com/ClickHouse/ClickHouse/pull/62420) (Sergei Trifonov)。

* 使 transform 始终返回第一个匹配项。[#62518](https://github.com/ClickHouse/ClickHouse/pull/62518) (Raúl Marín)。

* 在执行 RESTORE 时避免对表的 DEFAULT 表达式求值。[#62601](https://github.com/ClickHouse/ClickHouse/pull/62601) (Vitaly Baranov)。

* 允许在 HTTP 请求中，在不同的认证方案下使用 quota key。[#62842](https://github.com/ClickHouse/ClickHouse/pull/62842) (Kseniia Sumarokova)。



* 当用户的 `valid_until` 到期时关闭会话。 [#63046](https://github.com/ClickHouse/ClickHouse/pull/63046) (Konstantin Bogdanov)。
