---
slug: /cloud/get-started/cloud/use-cases/AI_ML
title: '机器学习'
description: '了解 ClickHouse 如何为整个 ML 流程中的机器学习应用提供支持。'
keywords: ['用例', '机器学习', '生成式 AI']
sidebar_label: '机器学习'
doc_type: 'guide'
---

import machine_learning_data_layer from '@site/static/images/cloud/onboard/discover/use_cases/ml_data_layer.png'
import online_feature_store from '@site/static/images/cloud/onboard/discover/use_cases/ml_data_layer.png'
import Image from '@theme/IdealImage';


## 机器学习数据层 {#machine-learning-data-layer}

您可能听说过这样一个说法:机器学习从业者 80% 的时间都花在清理数据上。
无论这个说法是否属实,不变的事实是,从始至终,数据都是机器学习问题的核心。
无论您是在构建 RAG 管道、微调模型、训练自己的模型,还是评估模型性能,数据都是每个问题的根本。

数据管理可能很棘手,因此该领域涌现出大量工具,这些工具旨在通过解决机器学习数据问题的特定部分来提高生产力。
通常,这些工具表现为在更通用的解决方案之上添加一层抽象,并提供一个固定的接口,从表面上看,这使得将其应用于手头的特定子问题变得更容易。
实际上,这是以牺牲通用解决方案的灵活性为代价,来换取特定任务的易用性和简单性。

<Image img={machine_learning_data_layer} size='sm' />

这种方法存在几个缺点。
与通用解决方案加上支持性应用代码相比,一系列级联的专用工具、产品和服务会带来不必要的架构复杂性和数据成本增加的风险。
很容易在不知不觉中发现自己拥有一长串工具和服务,每个工具仅用于单个步骤。

这些风险通常体现在两个方面:

1. **学习、维护和切换成本**

机器学习架构可能会因各种工具和组件而变得杂乱无章,从而形成一个碎片化且难以学习和管理的环境,增加了故障点和成本蔓延。

2. **数据重复和传输成本**

在机器学习管道中使用多个离散但重叠的数据系统可能会引入不必要且通常代价高昂的数据传输开销。

向量数据库就是这种权衡的一个很好的例证。
向量数据库专为存储和搜索向量这一高度特定的机器学习任务而设计。
虽然这在某些架构中可能是正确的选择,但在其他架构中,向量数据库可能是技术栈中不必要的新增内容,因为它是又一个需要集成、管理以及进行数据传输的系统。
大多数现代通用数据库都开箱即用地支持向量(或通过插件),并具有更广泛和跨领域的能力。
换句话说,在这些架构中可能根本不需要专门用于处理向量的全新数据库。
关键在于向量特定的便利功能(例如内置嵌入模型)是否至关重要且值得付出成本。

### 数据探索 {#data-exploration}

在定义机器学习问题、目标和成功标准之后,常见的第一步是探索将用于模型训练和评估的相关数据。

在此步骤中,需要分析数据以了解其特征、分布和关系。
这个评估和理解的过程是迭代的,通常会导致跨数据集执行一系列临时查询,其中查询响应速度至关重要(以及成本效益和准确性等其他因素)。
随着公司存储越来越多的数据用于机器学习目的,检查现有数据的问题变得更加困难。

这是因为在传统数据系统中,分析和评估查询在大规模情况下往往会变得缓慢乏味或慢得令人无法接受。
一些大型供应商为了降低查询时间而大幅提高成本,并通过按查询收费或按扫描字节数收费的方式阻碍临时评估。
工程师可能不得不将数据子集拉取到本地机器上,作为对这些限制的妥协。

另一方面,ClickHouse 是一个实时数据仓库,因此用户可以从行业领先的分析计算查询速度中受益。
此外,ClickHouse 从一开始就提供高性能,不会将关键的查询加速功能限制在更高的定价层级之后。
ClickHouse 还可以直接从对象存储或数据湖查询数据,支持 Iceberg、Delta Lake 和 Hudi 等常见格式。
这意味着无论您的数据存储在何处,ClickHouse 都可以作为机器学习工作负载的统一访问和计算层。

ClickHouse 还拥有一套广泛的预构建统计和聚合函数,可扩展到 PB 级数据,使编写和维护执行复杂计算的简单 SQL 变得容易。
凭借对最精细精度数据类型和编解码器的支持,您无需担心降低数据的粒度。


用户既可以直接在 ClickHouse 中转换数据,也可以在插入前使用 SQL 查询进行转换,此外还可以通过 [chDB](/chdb) 在 Python 等编程环境中使用 ClickHouse。
这使得嵌入式 ClickHouse 能够以 Python 模块的形式提供,用于在 Notebook 中转换和处理大型数据帧。
因此,数据工程师可以在客户端执行转换工作,并将结果物化为集中式 ClickHouse 实例中的特征表。

### 数据准备和特征提取 {#data-preparation-and-feature-extraction}

接下来进行数据准备:清洗、转换,并提取用于模型训练和评估的特征。
该组件有时被称为特征生成或提取管道,是机器学习数据层的另一个环节,通常会引入新的工具。
Neptune 和 Hopsworks 等 MLOps 平台提供了用于编排此类管道的各种数据转换产品示例。
然而,由于这些工具与其操作的数据库相互独立,因此可能较为脆弱,并可能导致需要手动修复的中断。

相比之下,通过 [物化视图](/materialized-views) 可以直接在 ClickHouse 中轻松完成数据转换。
当新数据插入 ClickHouse 源表时,物化视图会自动触发,用于在数据到达时轻松提取、转换和修改数据,无需自行构建和监控定制化管道。
当这些转换需要对可能无法完全载入内存的数据集进行聚合时,利用 ClickHouse 可以确保您无需尝试改造此步骤以适配本地机器上的数据帧处理。
对于更适合在本地评估的数据集,[ClickHouse local](/operations/utilities/clickhouse-local) 和 [chDB](/chdb) 是很好的选择,允许用户将 ClickHouse 与 Pandas 等标准 Python 数据库结合使用。

### 训练和评估 {#training-and-evaluation}

此时,特征已被拆分为训练集、验证集和测试集。
这些数据集会进行版本管理,然后在各自的阶段中使用。

在管道的这个阶段,通常会向机器学习数据层引入另一个专用工具——特征存储。
特征存储通常是数据库之上的抽象层,提供专门用于管理模型训练、推理和评估数据的便捷功能。
这些便捷功能包括版本管理、访问控制以及自动将特征定义转换为 SQL 语句。

对于特征存储,ClickHouse 可以充当:

**数据源** - ClickHouse 能够查询或摄取超过 70 种不同文件格式的数据,包括 Iceberg 和 Delta Lake 等数据湖格式,是存储或查询数据的理想长期存储方案。
通过使用对象存储实现存储与计算分离,ClickHouse Cloud 还允许无限期保存数据,同时可以缩减计算规模或使其完全空闲以降低成本。
灵活的编解码器,结合列式存储和磁盘数据排序,可最大化压缩率,从而最小化所需的存储空间。
用户可以轻松地将 ClickHouse 与数据湖结合使用,通过内置函数直接查询对象存储中的数据。

**转换引擎** - SQL 提供了声明数据转换的自然方式。
当结合 ClickHouse 的分析和统计函数进行扩展时,这些转换变得简洁且高效。
除了应用于 ClickHouse 表(在 ClickHouse 用作数据存储的情况下),表函数还允许针对以 Parquet 等格式存储在磁盘或对象存储中的数据,甚至 Postgres 和 MySQL 等其他数据存储中的数据编写 SQL 查询。
完全并行化的查询执行引擎,结合列式存储格式,使 ClickHouse 能够在数秒内对 PB 级数据执行聚合,与内存数据帧上的转换不同,用户不受内存限制。
此外,物化视图允许在插入时转换数据,从而将计算负载从查询时转移到数据加载时。
这些视图可以利用同样丰富的分析和统计函数,非常适合数据分析和汇总。
如果 ClickHouse 的现有分析函数不能满足需求或需要集成自定义库,用户还可以使用用户定义函数 (UDF)。

#### 离线特征存储 {#offline-feature-store}

离线特征存储用于模型训练。
这通常意味着特征本身通过批处理数据转换管道生成(如上一节所述),并且通常对这些特征的可用性没有严格的延迟要求。


ClickHouse 能够从多个数据源读取数据并通过 SQL 查询进行转换,查询结果可以通过 `INSERT INTO SELECT` 语句持久化存储。
转换操作通常按实体 ID 分组并返回多列结果,ClickHouse 的模式推断功能可以自动检测结果中所需的数据类型,并生成相应的表结构来存储这些数据。
随机数生成和统计采样函数支持以每秒数百万行的速度高效迭代和扩展数据,为模型训练管道提供数据输入。

特征通常以表的形式表示,其中时间戳标识实体和特征在特定时间点的值。
如前所述,训练管道通常需要获取特定时间点和分组的特征状态。ClickHouse 的稀疏索引支持快速过滤数据,满足时间点查询和特征筛选的需求。 Spark、Redshift 和 BigQuery 等技术依赖较慢的有状态窗口方法来识别特定时间点的特征状态,而 ClickHouse 支持 ASOF(截至某时间点)LEFT JOIN 查询和 argMax 函数。
除了简化语法外,该方法通过排序和合并算法在大规模数据集上实现了高性能。
这使得特征组可以快速构建,缩短训练前的数据准备时间。

#### 在线特征存储 {#online-feature-store}

在线特征存储用于存储推理所需的最新版本特征,并实时应用。
这意味着这些特征需要以最低延迟进行计算,因为它们是实时机器学习服务的组成部分。

<Image img={online_feature_store} size='sm' />

作为实时分析数据库,ClickHouse 能够以低延迟处理高并发查询负载。
虽然这通常需要对数据进行反规范化处理,但这与训练和推理阶段使用的特征组存储方式相符。
重要的是,得益于日志结构合并树,ClickHouse 能够在承受高写入负载的同时保持优异的查询性能。
在线存储需要具备这些特性才能保持特征的实时更新。
由于特征已在离线存储中可用,因此可以通过现有功能(如 `remoteSecure`)轻松将其物化到同一 ClickHouse 集群或不同实例的新表中。
通过 exactly-once 语义的 Kafka Connect 或 ClickHouse Cloud 中的 [ClickPipes](/integrations/clickpipes/kafka) 与 Kafka 集成,可以简单可靠地从流式数据源消费流式数据。

许多现代系统同时需要离线和在线存储,因此很容易得出需要两个专用特征存储的结论。
然而,这会带来保持两个存储同步的额外复杂性,当然也包括在它们之间复制数据的成本。

像 ClickHouse 这样的实时数据仓库是一个统一系统,可以同时支持离线和在线特征管理。
ClickHouse 高效处理流式和历史数据,具备为实时推理和离线训练提供特征服务所需的无限扩展能力、性能和并发能力。

在权衡使用特征存储产品与直接利用实时数据仓库时,值得强调的是,版本控制等便利功能可以通过表设计或模式设计等传统数据库范式来实现。
其他功能,如将特征定义转换为 SQL 语句,作为应用程序或业务逻辑的一部分可能提供更大的灵活性,而不是存在于固化的抽象层中。

### 推理 {#inference}

模型推理是运行已训练模型以获取输出的过程。
当推理由数据库操作触发时(例如插入新记录或查询记录),推理步骤可以通过定制作业或应用程序代码来管理。

另一方面,也可以在数据层本身进行管理。ClickHouse [用户自定义函数 (UDF)](/sql-reference/functions/udf) 使用户能够在插入或查询时直接从 ClickHouse 调用模型。
这使得可以将传入数据传递给模型、接收输出并自动将结果与摄取的数据一起存储 - 所有这些都无需启动其他进程或作业。
这还提供了一个统一的 SQL 接口来管理此步骤。

### 向量存储 {#vector-store}

向量存储是一种专门用于存储和检索向量的数据库,通常是数据片段(如文本或图像)的嵌入表示,以数值形式捕获其底层语义。
向量是当今生成式 AI 浪潮的核心,在无数应用中得到使用。


向量数据库的主要操作是"相似性搜索",即根据数学度量找到彼此"最接近"的向量。
向量数据库之所以流行,是因为它们采用了特定的策略来使这种检查(即向量比较)尽可能快速。
这些技术通常采用近似计算的方式进行向量比较,而不是将输入向量与每个存储的向量逐一比较。

这类新工具面临的问题是,许多通用数据库(包括 ClickHouse)都提供开箱即用的向量支持,并且通常内置了这些近似方法的实现。
特别是 ClickHouse,它专为高性能大规模分析而设计,能够非常高效地执行非近似向量比较。
这意味着您可以获得精确的结果,而无需依赖近似计算,同时不会牺牲速度。

### 可观测性 {#observability}

一旦您的机器学习应用程序上线,它将生成包括日志和追踪数据在内的各类数据,这些数据可提供有关模型行为、性能和潜在改进方向的宝贵洞察。

基于 SQL 的可观测性是 ClickHouse 的另一个关键用例,ClickHouse 的成本效益比替代方案高出 10-100 倍。
事实上,许多可观测性产品本身就是基于 ClickHouse 构建的。
凭借业界领先的数据摄取速率和压缩比,ClickHouse 提供了卓越的成本效益和极快的速度,可在任何规模下为机器学习可观测性提供强大支持。
