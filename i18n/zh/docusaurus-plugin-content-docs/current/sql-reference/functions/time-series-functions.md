---
description: '时间序列处理函数文档'
sidebar_label: 'TimeSeries'
slug: /sql-reference/functions/time-series-functions
title: '时间序列处理函数'
doc_type: 'reference'
---

# 时间序列函数 {#time-series-functions}

以下函数被设计用于与 `timeSeries*()` 聚合函数一起使用，例如
[`timeSeriesInstantRateToGrid`](../aggregate-functions/reference/timeSeriesInstantRateToGrid.md)、[`timeSeriesLastToGrid`](../aggregate-functions/reference/timeSeriesResampleToGridWithStaleness.md) 等。

{/* 
  下面标签内的内容会在文档框架构建时替换为
  由 system.functions 自动生成的文档。请不要修改或删除这些标签。
  详见：https://github.com/ClickHouse/clickhouse-docs/blob/main/contribute/autogenerated-documentation-from-source.md
  */ }

{/*AUTOGENERATED_START*/ }

## seriesDecomposeSTL {#seriesDecomposeSTL}

在 v24.1 中引入

使用 STL [(Seasonal-Trend Decomposition Procedure Based on Loess)](https://www.wessa.net/download/stl.pdf) 将时间序列数据分解为季节成分、趋势成分和残差成分。

**语法**

```sql
seriesDecomposeSTL(series, period)
```

**参数**

* `series` — 数值数组 [`Array((U)Int8/16/32/64)`](/sql-reference/data-types/array) 或 [`Array(Float*)`](/sql-reference/data-types/array)
* `period` — 正整数 [`UInt8/16/32/64`](/sql-reference/data-types/int-uint)

**返回值**

返回一个由四个数组组成的数组，其中第一个数组为季节性成分，第二个数组为趋势成分，第三个数组为残差成分，第四个数组为基线（季节性 + 趋势）成分。[`Array(Array(Float32), Array(Float32), Array(Float32), Array(Float32))`](/sql-reference/data-types/array)

**示例**

**使用 STL 对序列数据进行分解**

```sql title=Query
SELECT seriesDecomposeSTL([10.1, 20.45, 40.34, 10.1, 20.45, 40.34, 10.1, 20.45, 40.34, 10.1, 20.45, 40.34, 10.1, 20.45, 40.34, 10.1, 20.45, 40.34, 10.1, 20.45, 40.34, 10.1, 20.45, 40.34], 3) AS print_0
```

```response title=Response
┌───────────print_0──────────────────────────────────────────────────────────────────────────────────────────────────────┐
│ [[
        -13.529999, -3.1799996, 16.71,      -13.53,     -3.1799996, 16.71,      -13.53,     -3.1799996,
        16.71,      -13.530001, -3.18,      16.710001,  -13.530001, -3.1800003, 16.710001,  -13.530001,
        -3.1800003, 16.710001,  -13.530001, -3.1799994, 16.71,      -13.529999, -3.1799994, 16.709997
    ],
    [
        23.63,     23.63,     23.630003, 23.630001, 23.630001, 23.630001, 23.630001, 23.630001,
        23.630001, 23.630001, 23.630001, 23.63,     23.630001, 23.630001, 23.63,     23.630001,
        23.630001, 23.63,     23.630001, 23.630001, 23.630001, 23.630001, 23.630001, 23.630003
    ],
    [
        0, 0.0000019073486, -0.0000019073486, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -0.0000019073486, 0,
        0
    ],
    [
        10.1, 20.449999, 40.340004, 10.100001, 20.45, 40.34, 10.100001, 20.45, 40.34, 10.1, 20.45, 40.34,
        10.1, 20.45, 40.34, 10.1, 20.45, 40.34, 10.1, 20.45, 40.34, 10.100002, 20.45, 40.34
    ]]                                                                                                                   │
└────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```



## seriesOutliersDetectTukey {#seriesOutliersDetectTukey}

Introduced in: v24.2


Detects outliers in series data using [Tukey Fences](https://en.wikipedia.org/wiki/Outlier#Tukey%27s_fences).
    

**Syntax**

```sql
seriesOutliersDetectTukey(series[, min_percentile, max_percentile, K])
```

**Arguments**

- `series` — An array of numeric values. [`Array((UInt8/16/32/64))`](/sql-reference/data-types/array) or [`Array(Float*)`](/sql-reference/data-types/array)
- `min_percentile` — Optional. The minimum percentile to be used to calculate inter-quantile range [(IQR)](https://en.wikipedia.org/wiki/Interquartile_range). The value must be in range [0.02,0.98]. The default is 0.25. [`Float*`](/sql-reference/data-types/float)
- `max_percentile` — Optional. The maximum percentile to be used to calculate inter-quantile range (IQR). The value must be in range [0.02,0.98]. The default is 0.75. [`Float*`](/sql-reference/data-types/float)
- `K` — Optional. Non-negative constant value to detect mild or stronger outliers. The default value is 1.5. [`Float*`](/sql-reference/data-types/float)


**Returned value**

Returns an array of the same length as the input array where each value represents score of possible anomaly of corresponding element in the series. A non-zero score indicates a possible anomaly. [`Array(Float32)`](/sql-reference/data-types/array)

**Examples**

**Basic outlier detection**

```sql title=Query
SELECT seriesOutliersDetectTukey([-3, 2, 15, 3, 5, 6, 4, 5, 12, 45, 12, 3, 3, 4, 5, 6]) AS print_0
```

```response title=Response
┌───────────print_0─────────────────┐
│[0,0,0,0,0,0,0,0,0,27,0,0,0,0,0,0] │
└───────────────────────────────────┘
```

**Custom parameters outlier detection**

```sql title=Query
SELECT seriesOutliersDetectTukey([-3, 2, 15, 3, 5, 6, 4.50, 5, 12, 45, 12, 3.40, 3, 4, 5, 6], 0.2, 0.8, 1.5) AS print_0
```

```response title=Response
┌─print_0──────────────────────────────┐
│ [0,0,0,0,0,0,0,0,0,19.5,0,0,0,0,0,0] │
└──────────────────────────────────────┘
```



## seriesPeriodDetectFFT {#seriesPeriodDetectFFT}

Introduced in: v23.12


Finds the period of the given series data using FFT - [Fast Fourier transform](https://en.wikipedia.org/wiki/Fast_Fourier_transform)
    

**Syntax**

```sql
seriesPeriodDetectFFT(series)
```

**Arguments**

- `series` — An array of numeric values. [`Array((U)Int8/16/32/64)`](/sql-reference/data-types/array) or [`Array(Float*)`](/sql-reference/data-types/array)


**Returned value**

Returns a real value equal to the period of series data. NaN when number of data points are less than four. [`Float64`](/sql-reference/data-types/float)

**Examples**

**Period detection with simple pattern**

```sql title=Query
SELECT seriesPeriodDetectFFT([1, 4, 6, 1, 4, 6, 1, 4, 6, 1, 4, 6, 1, 4, 6, 1, 4, 6, 1, 4, 6]) AS print_0
```

```response title=Response
┌───────────print_0──────┐
│                      3 │
└────────────────────────┘
```

**Period detection with complex pattern**

```sql title=Query
SELECT seriesPeriodDetectFFT(arrayMap(x -> abs((x % 6) - 3), range(1000))) AS print_0
```

```response title=Response
┌─print_0─┐
│       6 │
└─────────┘
```



## timeSeriesFromGrid {#timeSeriesFromGrid}

Introduced in: v25.8


Converts an array of values `[x1, x2, x3, ...]` to an array of tuples
`[(start_timestamp, x1), (start_timestamp + step, x2), (start_timestamp + 2 * step, x3), ...]`.

The current timestamp is increased by `step` until it becomes greater than `end_timestamp`
If the number of the values doesn't match the number of the timestamps, the function throws an exception.

NULL values in `[x1, x2, x3, ...]` are skipped but the current timestamp is still incremented.
For example, for `[value1, NULL, x2]` the function returns `[(start_timestamp, x1), (start_timestamp + 2 * step, x2)]`.
    

**Syntax**

```sql
timeSeriesFromGrid(start_timestamp, end_timestamp, step, values)
```

**Arguments**

- `start_timestamp` — Start of the grid. [`DateTime64`](/sql-reference/data-types/datetime64) or [`DateTime`](/sql-reference/data-types/datetime) or [`UInt32`](/sql-reference/data-types/int-uint)
- `end_timestamp` — End of the grid. [`DateTime64`](/sql-reference/data-types/datetime64) or [`DateTime`](/sql-reference/data-types/datetime) or [`UInt32`](/sql-reference/data-types/int-uint)
- `step` — Step of the grid in seconds [`Decimal64`](/sql-reference/data-types/decimal) or [`Decimal32`](/sql-reference/data-types/decimal) or [`UInt32/64`](/sql-reference/data-types/int-uint)
- `values` — Array of values [`Array(Float*)`](/sql-reference/data-types/array) or [`Array(Nullable(Float*))`](/sql-reference/data-types/array)


**Returned value**

Returns values from the source array of values combined with timestamps on a regular time grid described by `start_timestamp` and `step`. [`Array(Tuple(DateTime64, Float64))`](/sql-reference/data-types/array)

**Examples**

**Usage example**

```sql title=Query
SELECT timeSeriesFromGrid('2025-06-01 00:00:00'::DateTime64(3), '2025-06-01 00:01:30.000'::DateTime64(3), 30, [10, 20, NULL, 30]) AS result;
```

```response title=Response
┌─────────────────────────────────────────────result─────────────────────────────────────────────┐
│ [('2025-06-01 00:00:00.000',10),('2025-06-01 00:00:30.000',20),('2025-06-01 00:01:30.000',30)] │
└────────────────────────────────────────────────────────────────────────────────────────────────┘
```



## timeSeriesIdToTags {#timeSeriesIdToTags}

Introduced in: v25.8

Finds tags associated with the specified identifier of a time series.

**Syntax**

```sql
timeSeriesIdToTags(id)
```

**Arguments**

- `id` — Identifier of a time series. [`UInt64`](/sql-reference/data-types/int-uint) or [`UInt128`](/sql-reference/data-types/int-uint) or [`UUID`](/sql-reference/data-types/uuid) or [`FixedString(16)`](/sql-reference/data-types/fixedstring)


**Returned value**

Returns an array of pairs (tag_name, tag_value). [`Array(Tuple(String, String))`](/sql-reference/data-types/array)

**Examples**

**Example**

```sql title=Query
SELECT timeSeriesStoreTags(8374283493092, [('region', 'eu'), ('env', 'dev')], '__name__', 'http_requests_count') AS id, timeSeriesIdToTags(id)
```

```response title=Response
8374283493092    [('__name__', ''http_requests_count''), ('env', 'dev'), ('region', 'eu')]
```



## timeSeriesIdToTagsGroup {#timeSeriesIdToTagsGroup}

Introduced in: v25.8

Converts the specified identifier of a time series to its group index. Group indices are numbers 0, 1, 2, 3 associated with each unique set of tags in the context of the currently executed query.

**Syntax**

```sql
timeSeriesIdToTagsGroup(id)
```

**Arguments**

- `id` — Identifier of a time series. [`UInt64`](/sql-reference/data-types/int-uint) or [`UInt128`](/sql-reference/data-types/int-uint) or [`UUID`](/sql-reference/data-types/uuid) or [`FixedString(16)`](/sql-reference/data-types/fixedstring)


**Returned value**

Returns a group index associated with this set of tags. [`UInt64`](/sql-reference/data-types/int-uint)

**Examples**

**Example**

```sql title=Query
SELECT timeSeriesStoreTags(8374283493092, [('region', 'eu'), ('env', 'dev')], '__name__', 'http_requests_count') AS id, timeSeriesIdToTagsGroup(id)
```

```response title=Response
8374283493092    0
```



## timeSeriesRange {#timeSeriesRange}

Introduced in: v25.8


Generates a range of timestamps [start_timestamp, start_timestamp + step, start_timestamp + 2 * step, ..., end_timestamp].

If `start_timestamp` is equal to `end_timestamp`, the function returns a 1-element array containing `[start_timestamp]`.

Function `timeSeriesRange()` is similar to function [range](../functions/array-functions.md#range).


**Syntax**

```sql
timeSeriesRange(start_timestamp, end_timestamp, step)
```

**Arguments**

- `start_timestamp` — Start of the range. [`DateTime64`](/sql-reference/data-types/datetime64) or [`DateTime`](/sql-reference/data-types/datetime) or [`UInt32`](/sql-reference/data-types/int-uint)
- `end_timestamp` — End of the range. [`DateTime64`](/sql-reference/data-types/datetime64) or [`DateTime`](/sql-reference/data-types/datetime) or [`UInt32`](/sql-reference/data-types/int-uint)
- `step` — Step of the range in seconds [`UInt32/64`](/sql-reference/data-types/int-uint) or [`Decimal32/64`](/sql-reference/data-types/decimal)


**Returned value**

Returns a range of timestamps. [`Array(DateTime64)`](/sql-reference/data-types/array)

**Examples**

**Usage example**

```sql title=Query
SELECT timeSeriesRange('2025-06-01 00:00:00'::DateTime64(3), '2025-06-01 00:01:00'::DateTime64(3), 30)
```

```response title=Response
┌────────────────────────────────────result─────────────────────────────────────────┐
│ ['2025-06-01 00:00:00.000', '2025-06-01 00:00:30.000', '2025-06-01 00:01:00.000'] │
└───────────────────────────────────────────────────────────────────────────────────┘
```



## timeSeriesStoreTags {#timeSeriesStoreTags}

Introduced in: v25.8

Stores mapping between the identifier of a time series and its tags in the query context, so that function timeSeriesIdToTags() can extract these tags later.

**Syntax**

```sql
timeSeriesStoreTags(id, tags_array, separate_tag_name_1, separate_tag_value_1, ...)
```

**Arguments**

- `id` — Identifier of a time series. [`UInt64`](/sql-reference/data-types/int-uint) or [`UInt128`](/sql-reference/data-types/int-uint) or [`UUID`](/sql-reference/data-types/uuid) or [`FixedString(16)`](/sql-reference/data-types/fixedstring)
- `tags_array` — Array of pairs (tag_name, tag_value). [`Array(Tuple(String, String))`](/sql-reference/data-types/array) or [`NULL`](/sql-reference/syntax#null)
- `separate_tag_name_i` — The name of a tag. [`String`](/sql-reference/data-types/string) or [`FixedString`](/sql-reference/data-types/fixedstring)
- `separate_tag_value_i` — The value of a tag. [`String`](/sql-reference/data-types/string) or [`FixedString`](/sql-reference/data-types/fixedstring) or [`Nullable(String)`](/sql-reference/data-types/nullable)


**Returned value**

Returns the first argument, i.e. the identifier of a time series.

**Examples**

**Example**

```sql title=Query
SELECT timeSeriesStoreTags(8374283493092, [('region', 'eu'), ('env', 'dev')], '__name__', 'http_requests_count')
```

```response title=Response
8374283493092
```



## timeSeriesTagsGroupToTags {#timeSeriesTagsGroupToTags}

Introduced in: v25.8

Finds tags associated with a group index. Group indices are numbers 0, 1, 2, 3 associated with each unique set of tags in the context of the currently executed query.

**Syntax**

```sql
timeSeriesTagsGroupToTags(group)
```

**Arguments**

- `group` — Group index associated with a time series. [`UInt64`](/sql-reference/data-types/int-uint)


**Returned value**

Array of pairs (tag_name, tag_value). [`Array(Tuple(String, String))`](/sql-reference/data-types/array)

**Examples**

**Example**

```sql title=Query
SELECT timeSeriesStoreTags(8374283493092, [('region', 'eu'), ('env', 'dev')], '__name__', 'http_requests_count') AS id, timeSeriesIdToTagsGroup(id) AS group, timeSeriesTagsGroupToTags(group)
```

```response title=Response
8374283493092    0    [('__name__', ''http_requests_count''), ('env', 'dev'), ('region', 'eu')]
```

{/*AUTOGENERATED_END*/ }
