---
description: '以指定精度，根据序列中每个元素的权重计算数值数据序列的分位数。'
slug: /sql-reference/aggregate-functions/reference/quantilestimingweighted
title: 'quantilesTimingWeighted'
doc_type: 'reference'
---

{/*AUTOGENERATED_START*/ }

## quantilesTimingWeighted \{#quantilesTimingWeighted\}

自 v1.1 引入

在给定精度下，同时按不同水平计算数值数据序列的多个[分位数](https://en.wikipedia.org/wiki/Quantile)，并考虑序列中每个元素的权重。

此函数等价于 [`quantileTimingWeighted`](/sql-reference/aggregate-functions/reference/quantiletimingweighted)，但允许在一次遍历中计算多个分位水平，比多次调用单个分位函数更加高效。

结果是确定性的（不依赖于查询处理顺序）。该函数针对描述分布的序列进行了优化，例如网页加载时间或后端响应时间。

**精度**

在以下情况下，计算结果是精确的：

* 值的总数不超过 5670。
* 值的总数超过 5670，但页面加载时间小于 1024 ms。

否则，计算结果会被四舍五入到最接近的 16 ms 的倍数。

:::note
对于计算页面加载时间的分位数，此函数比 [`quantiles`](/sql-reference/aggregate-functions/reference/quantiles) 更高效且更准确。
:::

**语法**

```sql
quantilesTimingWeighted(level1, level2, ...)(expr, weight)
```

**参数**

* `level` — 分位数的 level。一个或多个取值在 0 到 1 之间的常量浮点数。我们建议将 `level` 值设置在 `[0.01, 0.99]` 区间内。[`Float*`](/sql-reference/data-types/float)

**参数说明**

* `expr` — 针对列值进行计算的表达式，返回 `Float*` 类型的数值。如果向函数传递负值，其行为未定义。如果值大于 30,000（页面加载时间超过 30 秒），则会被视为 30,000。[`Float*`](/sql-reference/data-types/float)
* `weight` — 序列元素权重所在的列。权重表示该数值出现的次数。[`UInt*`](/sql-reference/data-types/int-uint)

**返回值**

按指定 `level` 的顺序返回对应分位数构成的数组。[`Array(Float32)`](/sql-reference/data-types/array)

**示例**

**计算多个加权时延分位数**

```sql title=Query
SELECT quantilesTimingWeighted(0.5, 0.99)(response_time, weight) FROM t;
```

```response title=Response
┌─quantilesTimingWeighted(0.5, 0.99)(response_time, weight)─┐
│ [112, 162]                                                │
└───────────────────────────────────────────────────────────┘
```

{/*AUTOGENERATED_END*/ }

**另请参阅**

* [median](/sql-reference/aggregate-functions/reference/median)
* [quantiles](../../../sql-reference/aggregate-functions/reference/quantiles.md)
