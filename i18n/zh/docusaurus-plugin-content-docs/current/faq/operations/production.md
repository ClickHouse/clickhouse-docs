---
slug: /faq/operations/production
title: '在生产环境中应使用哪个 ClickHouse 版本？'
toc_hidden: true
toc_priority: 10
description: '本页面提供关于在生产环境中应使用哪个 ClickHouse 版本的指导'
doc_type: 'guide'
keywords: ['生产环境', '部署', '版本', '最佳实践', '升级策略']
---



# 生产环境中应该使用哪个 ClickHouse 版本? {#which-clickhouse-version-to-use-in-production}

首先,让我们讨论一下为什么会有人提出这个问题。主要有两个原因:

1.  ClickHouse 的开发速度非常快,通常每年会发布 10 个以上的稳定版本。这使得可供选择的版本范围很广,选择起来并不简单。
2.  一些用户希望避免花费时间去确定哪个版本最适合自己的使用场景,而是直接采纳他人的建议。

第二个原因更为根本,因此我们将从这个原因开始讨论,然后再回到如何在各个 ClickHouse 版本中进行选择的话题。


## 您推荐使用哪个 ClickHouse 版本? {#which-clickhouse-version-do-you-recommend}

雇佣咨询顾问或信任某些知名专家来规避生产环境责任的做法很有诱惑力。您安装了别人推荐的某个特定 ClickHouse 版本;如果出现问题——这不是您的错,而是别人的错。这种推理方式是一个巨大的陷阱。没有外部人员比您更了解公司生产环境中的实际情况。

那么如何正确选择要升级到哪个 ClickHouse 版本?或者如何选择您的第一个 ClickHouse 版本?首先,您需要投入资源建立一个**真实的预生产环境**。在理想情况下,它可以是一个完全相同的影子副本,但这通常成本高昂。

以下是在预生产环境中以较低成本获得合理保真度的一些关键要点:

- 预生产环境需要运行与您打算在生产环境中运行的查询集尽可能接近的查询:
  - 不要使用冻结的数据将其设置为只读。
  - 不要仅仅复制数据而不构建典型报表,将其设置为只写。
  - 不要清空数据,而应该应用 schema 迁移。
- 使用真实生产数据和查询的样本。尽量选择具有代表性并使 `SELECT` 查询返回合理结果的样本。如果您的数据敏感且内部政策不允许其离开生产环境,请使用混淆处理。
- 确保预生产环境与生产环境一样被您的监控和告警软件覆盖。
- 如果您的生产环境跨越多个数据中心或区域,请让您的预生产环境也这样做。
- 如果您的生产环境使用复制、分布式表和级联物化视图等复杂功能,请确保在预生产环境中进行类似配置。
- 在预生产环境中使用与生产环境大致相同数量但规模较小的服务器或虚拟机,或者使用数量少得多但规模相同的服务器或虚拟机,这之间存在权衡。第一种选择可能会发现额外的网络相关问题,而后者更易于管理。

第二个需要投入的领域是**自动化测试基础设施**。不要假设某种查询成功执行一次后就会永远如此。使用 mock 的 ClickHouse 进行一些单元测试是可以的,但要确保您的产品具有一套合理的自动化测试,这些测试针对真实的 ClickHouse 运行,并检查所有重要用例是否仍按预期工作。

更进一步的做法是将这些自动化测试贡献给 [ClickHouse 的开源测试基础设施](https://github.com/ClickHouse/ClickHouse/tree/master/tests),该基础设施在日常开发中持续使用。学习[如何运行它](../../development/tests.md)以及如何将您的测试适配到此框架肯定需要一些额外的时间和精力,但这将带来回报,确保 ClickHouse 版本在宣布稳定时就已经针对这些测试进行了验证,而不是反复浪费时间在事后报告问题,然后等待 bug 修复的实现、回溯和发布。一些公司甚至将此类测试贡献作为内部政策(在 Google 称为 [Beyonce's Rule](https://www.oreilly.com/library/view/software-engineering-at/9781492082781/ch01.html#policies_that_scale_well))。

当您的预生产环境和测试基础设施就位后,选择最佳版本就很简单了:

1.  定期针对新的 ClickHouse 版本运行自动化测试。即使对于标记为 `testing` 的 ClickHouse 版本也可以这样做,但不建议继续执行后续步骤。
2.  将通过测试的 ClickHouse 版本部署到预生产环境,并检查所有流程是否按预期运行。
3.  将您发现的任何问题报告到 [ClickHouse GitHub Issues](https://github.com/ClickHouse/ClickHouse/issues)。
4.  如果没有重大问题,开始将 ClickHouse 版本部署到生产环境应该是安全的。投资于实现类似于[金丝雀发布](https://martinfowler.com/bliki/CanaryRelease.html)或[蓝绿部署](https://martinfowler.com/bliki/BlueGreenDeployment.html)方法的渐进式发布自动化,可能会进一步降低生产环境中出现问题的风险。

您可能已经注意到,上述方法中没有任何特定于 ClickHouse 的内容——如果认真对待生产环境,人们会对所依赖的任何基础设施采取这种做法。


## 如何选择 ClickHouse 版本? {#how-to-choose-between-clickhouse-releases}

如果您查看 ClickHouse 软件包仓库的内容,会看到两种类型的软件包:

1.  `stable`(稳定版)
2.  `lts`(长期支持版)

以下是选择指南:

- `stable` 是我们默认推荐的软件包类型。它们大约每月发布一次(因此能够及时提供新功能),最新的三个稳定版本会获得诊断和错误修复回溯支持。
- `lts` 每年发布两次,并在初始发布后提供一年的支持。在以下情况下,您可能更倾向于选择 `lts` 而不是 `stable`:
  - 您的公司有内部政策,不允许频繁升级或使用非 LTS 软件。
  - 您在一些次要产品中使用 ClickHouse,这些产品不需要复杂的 ClickHouse 功能,或者没有足够的资源来保持更新。

许多最初认为应该选择 `lts` 的团队,最终还是会切换到 `stable`,因为某些对其产品至关重要的新功能。

:::tip  
升级 ClickHouse 时还需要注意一点:我们始终关注版本之间的兼容性,但有时保持完全兼容并不合理,一些细节可能会发生变化。因此,请务必在升级前查看[更新日志](/whats-new/changelog/index.md),了解是否有关于向后不兼容更改的说明。
:::
