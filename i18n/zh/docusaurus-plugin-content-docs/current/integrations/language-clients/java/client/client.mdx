---
sidebar_label: '客户端'
sidebar_position: 2
keywords: ['clickhouse', 'java', 'client', 'integrate']
description: 'Java ClickHouse 连接器'
slug: /integrations/language-clients/java/client
title: 'Java 客户端'
doc_type: 'reference'
integration:
  - support_level: 'core'
  - category: 'language_client'
---

import ClientVersionDropdown from '@theme/ClientVersionDropdown/ClientVersionDropdown';
import Version from '@theme/ClientVersionDropdown/Version';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import WideTableWrapper from '@site/src/components/WideTableWrapper/WideTableWrapper';

<ClientVersionDropdown
  versions={[
{
'version': 'v0.8+'
},
{
'version': 'v0.7.x'
}
]}
>
  <Version>
    用于通过协议与数据库服务器通信的 Java 客户端库。当前实现仅支持 [HTTP 接口](/interfaces/http)。
    该库提供了自己的 API 用于向服务器发送请求。该库还提供了用于处理不同二进制数据格式(RowBinary* &amp; Native*)的工具。

    ## 设置 \{#setup\}

    * Maven Central（项目页面）：https://mvnrepository.com/artifact/com.clickhouse/client-v2
    * 每夜构建版本（仓库链接）：https://central.sonatype.com/repository/maven-snapshots/
    * 旧版 Nightly 构建仓库（仓库链接）：https://s01.oss.sonatype.org/content/repositories/snapshots/

    <br />

    <Tabs groupId="client-setup">
      <TabItem value="maven" label="Maven">
        ```xml
        <dependency>
            <groupId>com.clickhouse</groupId>
            <artifactId>client-v2</artifactId>
            <version>0.9.4</version>
        </dependency>
        ```
      </TabItem>

      <TabItem value="gradle-kt" label="Gradle（Kotlin）">
        ```kotlin
        // https://mvnrepository.com/artifact/com.clickhouse/client-v2
        implementation("com.clickhouse:client-v2:0.9.4")
        ```
      </TabItem>

      <TabItem value="gradle" label="Gradle">
        ```groovy
        // https://mvnrepository.com/artifact/com.clickhouse/client-v2
        implementation 'com.clickhouse:client-v2:0.9.4'
        ```
      </TabItem>
    </Tabs>

    <br />

    ## 初始化 \{#initialization\}

    Client 对象通过 `com.clickhouse.client.api.Client.Builder#build()` 进行初始化。每个客户端都有自己的上下文,客户端之间不共享对象。
    Builder 提供了配置方法以便于进行设置。

    示例：

    ```java showLineNumbers
     Client client = new Client.Builder()
                    .addEndpoint("https://clickhouse-cloud-instance:8443/")
                    .setUsername(user)
                    .setPassword(password)
                    .build();
    ```

    `Client` 实现了 `AutoCloseable` 接口,不再需要时应将其关闭。

    ### 身份验证 \{#authentication\}

    身份验证在初始化阶段针对每个客户端进行配置。支持三种身份验证方式:密码、访问令牌、SSL 客户端证书。

    使用密码进行身份验证需要通过调用 `setUsername(String)` 和 `setPassword(String)` 方法来设置用户名和密码:

    ```java showLineNumbers
     Client client = new Client.Builder()
            .addEndpoint("https://clickhouse-cloud-instance:8443/")
            .setUsername(user)
            .setPassword(password)
            .build();
    ```

    使用访问令牌进行身份验证需要通过调用 `setAccessToken(String)` 设置访问令牌:

    ```java showLineNumbers
     Client client = new Client.Builder()
            .addEndpoint("https://clickhouse-cloud-instance:8443/")
            .setAccessToken(userAccessToken)
            .build();
    ```

    通过 SSL 客户端证书进行身份验证需要设置用户名、启用 SSL 身份验证、设置客户端证书和客户端密钥,方法是分别调用 `setUsername(String)`、`useSSLAuthentication(boolean)`、`setClientCertificate(String)` 和 `setClientKey(String)`:

    ```java showLineNumbers
    Client client = new Client.Builder()
            .useSSLAuthentication(true)
            .setUsername("some_user")
            .setClientCertificate("some_user.crt")
            .setClientKey("some_user.key")
    ```

    :::note
    SSL 身份验证在生产环境中可能难以排查,因为 SSL 库返回的许多错误信息不够详细。例如,如果客户端证书与密钥不匹配,服务器会立即终止连接(对于 HTTP 而言,这发生在连接初始化阶段,此时尚未发送任何 HTTP 请求,因此也不会返回任何响应)。

    请使用 [openssl](https://docs.openssl.org/master/man1/openssl/) 等工具验证证书和密钥:

    * 检查密钥完整性：`openssl rsa -in [key-file.key] -check -noout`
    * 检查客户端证书中的 CN 是否与某个 USER 匹配：
      * 从用户证书中获取 CN - `openssl x509 -noout -subject -in [user.cert]`
      * 确认数据库中已设置相同的值：`select name, auth_type, auth_params from system.users where auth_type = 'ssl_certificate'`（查询结果中的 `auth_params` 字段类似于 ` {"common_names":["some_user"]}`）

    :::

    ## 配置 \{#configuration\}

    所有设置均通过实例方法(即配置方法)定义,使每个值的作用域和上下文清晰明确。
    主要配置参数在单一作用域(客户端或操作)中定义,互不覆盖。

    配置在创建客户端时定义。请参阅 `com.clickhouse.client.api.Client.Builder`。

    ## 客户端配置 \{#client-configuration\}

    <Tabs groupId="client-config">
      <TabItem value="连接" label="连接与端点">
        | Method                                                                  | Arguments                                                        | Description                                         | Default   | Key                         |
        | ----------------------------------------------------------------------- | ---------------------------------------------------------------- | --------------------------------------------------- | --------- | --------------------------- |
        | `addEndpoint(String endpoint)`                                          | `endpoint` - URL 格式的服务器地址                                        | 将服务器端点添加到可用服务器列表。目前仅支持一个端点。                         | `none`    | `none`                      |
        | `addEndpoint(Protocol protocol, String host, int port, boolean secure)` | `protocol` - 连接协议<br />`host` - IP 或主机名<br />`secure` - 使用 HTTPS | 将服务器端点添加到可用服务器列表。目前仅支持一个端点。                         | `none`    | `none`                      |
        | `enableConnectionPool(boolean enable)`                                  | `enable` - 启用/禁用标志                                               | 设置是否启用连接池                                           | `true`    | `connection_pool_enabled`   |
        | `setMaxConnections(int maxConnections)`                                 | `maxConnections` - 连接数量                                          | 设置客户端对每个服务器端点最多可以打开的连接数。                            | `10`      | `max_open_connections`      |
        | `setConnectionTTL(long timeout, ChronoUnit unit)`                       | `timeout` - 超时值<br />`unit` - 时间单位                               | 设置连接的生存时间 (TTL)，超过该时间后连接将被视为不再活动                    | `-1`      | `connection_ttl`            |
        | `setKeepAliveTimeout(long timeout, ChronoUnit unit)`                    | `timeout` - 超时值<br />`unit` - 时间单位                               | 设置 HTTP 连接的 Keep-Alive 超时时间。设置为 `0` 以禁用 Keep-Alive。 | -         | `http_keep_alive_timeout`   |
        | `setConnectionReuseStrategy(ConnectionReuseStrategy strategy)`          | `strategy` - `LIFO` 或 `FIFO`                                     | 选择连接池应使用的连接复用策略                                     | `FIFO`    | `connection_reuse_strategy` |
        | `setDefaultDatabase(String database)`                                   | `database` - 数据库名称                                               | 设置默认数据库                                             | `default` | `database`                  |
      </TabItem>

      <TabItem value="身份验证" label="认证">
        | Method                                               | Arguments                             | Description                                   | Default   | Key                   |
        | ---------------------------------------------------- | ------------------------------------- | --------------------------------------------- | --------- | --------------------- |
        | `setUsername(String username)`                       | `username` - 用于认证的用户名                 | 为将通过后续配置选定的认证方式设置用户名                          | `default` | `user`                |
        | `setPassword(String password)`                       | `password` - 机密值                      | 为密码认证设置机密值，并将密码认证实际选为认证方式                     | -         | `password`            |
        | `setAccessToken(String accessToken)`                 | `accessToken` - 访问令牌字符串               | 设置访问令牌，以使用相应的认证方式进行认证                         | -         | `access_token`        |
        | `useSSLAuthentication(boolean useSSLAuthentication)` | `useSSLAuthentication` - 启用 SSL 认证的标志 | 将 SSL 客户端证书设置为一种认证方式。                         | -         | `ssl_authentication`  |
        | `useHTTPBasicAuth(boolean useBasicAuth)`             | `useBasicAuth` - 启用/禁用的标志             | 设置在用户密码认证中是否应使用基本 HTTP 认证。可解决包含特殊字符的密码所导致的问题。 | `true`    | `http_use_basic_auth` |
        | `useBearerTokenAuth(String bearerToken)`             | `bearerToken` - 编码后的 Bearer 令牌        | 指定是否使用 Bearer 认证以及要使用的令牌。令牌将按原样发送。            | -         | `bearer_token`        |
      </TabItem>

      <TabItem value="超时" label="超时与重试">
        | Method                                                       | Arguments                                | Description                           | Default                                                      | Key                          |
        | ------------------------------------------------------------ | ---------------------------------------- | ------------------------------------- | ------------------------------------------------------------ | ---------------------------- |
        | `setConnectTimeout(long timeout, ChronoUnit unit)`           | `timeout` - 超时时间值<br />`unit` - 时间单位     | 设置所有出站连接在建立连接时的超时时间。                  | -                                                            | `connection_timeout`         |
        | `setConnectionRequestTimeout(long timeout, ChronoUnit unit)` | `timeout` - 超时时间值<br />`unit` - 时间单位     | 设置连接请求超时时间。仅在从连接池获取连接时生效。             | `10000`                                                      | `connection_request_timeout` |
        | `setSocketTimeout(long timeout, ChronoUnit unit)`            | `timeout` - 超时时间值<br />`unit` - 时间单位     | 设置用于读写操作的 socket 超时时间。                | `0`                                                          | `socket_timeout`             |
        | `setExecutionTimeout(long timeout, ChronoUnit timeUnit)`     | `timeout` - 超时时间值<br />`timeUnit` - 时间单位 | 设置查询的最大执行超时时间。                        | `0`                                                          | `max_execution_time`         |
        | `retryOnFailures(ClientFaultCause ...causes)`                | `causes` - `ClientFaultCause` 的枚举常量      | 设置可恢复/可重试的故障类型。                       | `NoHttpResponse` `ConnectTimeout` `ConnectionRequestTimeout` | `client_retry_on_failures`   |
        | `setMaxRetries(int maxRetries)`                              | `maxRetries` - 重试次数                      | 设置针对由 `retryOnFailures` 定义的故障的最大重试次数。 | `3`                                                          | `retry`                      |
      </TabItem>

      <TabItem value="套接字" label="套接字选项">
        | Method                               | Arguments            | Description                                                         | Default | Key                  |
        | ------------------------------------ | -------------------- | ------------------------------------------------------------------- | ------- | -------------------- |
        | `setSocketRcvbuf(long size)`         | `size` - 以字节为单位的大小   | 设置 TCP socket 接收缓冲区。该缓冲区位于 JVM 内存之外（堆外内存）。                          | `8196`  | `socket_rcvbuf`      |
        | `setSocketSndbuf(long size)`         | `size` - 以字节为单位的大小   | 设置 TCP socket 发送缓冲区。该缓冲区位于 JVM 内存之外（堆外内存）。                          | `8196`  | `socket_sndbuf`      |
        | `setSocketKeepAlive(boolean value)`  | `value` - 启用/禁用的标志   | 为每个 TCP socket 设置 `SO_KEEPALIVE` 选项。TCP Keep Alive 启用用于检查连接是否存活的机制。 | -       | `socket_keepalive`   |
        | `setSocketTcpNodelay(boolean value)` | `value` - 启用/禁用的标志   | 为每个 TCP socket 设置 `SO_NODELAY` 选项。该 TCP 选项会使 socket 尽可能立即发送数据。      | -       | `socket_tcp_nodelay` |
        | `setSocketLinger(int secondsToWait)` | `secondsToWait` - 秒数 | 为客户端创建的每个 TCP socket 设置延迟关闭时间（linger time）。                         | -       | `socket_linger`      |
      </TabItem>

      <TabItem value="压缩" label="压缩">
        | Method                                    | Arguments           | Description                        | Default | Key                                        |
        | ----------------------------------------- | ------------------- | ---------------------------------- | ------- | ------------------------------------------ |
        | `compressServerResponse(boolean enabled)` | `enabled` - 启用/禁用标志 | 设置服务器是否应压缩响应。                      | `true`  | `compress`                                 |
        | `compressClientRequest(boolean enabled)`  | `enabled` - 启用/禁用标志 | 设置客户端是否应压缩请求。                      | `false` | `decompress`                               |
        | `useHttpCompression(boolean enabled)`     | `enabled` - 启用/禁用标志 | 设置在相应选项启用时，客户端与服务器通信是否应使用 HTTP 压缩。 | -       | -                                          |
        | `appCompressedData(boolean enabled)`      | `enabled` - 启用/禁用标志 | 告知客户端压缩由应用程序负责处理。                  | `false` | `app_compressed_data`                      |
        | `setLZ4UncompressedBufferSize(int size)`  | `size` - 以字节为单位的大小  | 设置用于接收数据流未压缩部分的缓冲区大小（字节数）。         | `65536` | `compression.lz4.uncompressed_buffer_size` |
        | `disableNativeCompression`                | `disable` - 禁用标志    | 禁用原生压缩。如果设为 true，则会禁用原生压缩。         | `false` | `disable_native_compression`               |
      </TabItem>

      <TabItem value="ssl" label="SSL/安全">
        | Method                                      | Arguments                | Description                                                  | Default | Key                  |
        | ------------------------------------------- | ------------------------ | ------------------------------------------------------------ | ------- | -------------------- |
        | `setSSLTrustStore(String path)`             | `path` - 本地系统上的文件路径      | 配置客户端是否使用 SSL truststore 来对服务器主机进行验证。                        | -       | `trust_store`        |
        | `setSSLTrustStorePassword(String password)` | `password` - 机密值         | 设置用于解锁由 `setSSLTrustStore` 指定的 SSL truststore 的密码。           | -       | `key_store_password` |
        | `setSSLTrustStoreType(String type)`         | `type` - truststore 类型名称 | 设置由 `setSSLTrustStore` 指定的 truststore 类型。                    | -       | `key_store_type`     |
        | `setRootCertificate(String path)`           | `path` - 本地系统上的文件路径      | 配置客户端是否使用指定的根 (CA) 证书来验证服务器主机。                               | -       | `sslrootcert`        |
        | `setClientCertificate(String path)`         | `path` - 本地系统上的文件路径      | 设置在发起 SSL 连接以及进行 SSL 认证时要使用的客户端证书路径。                         | -       | `sslcert`            |
        | `setClientKey(String path)`                 | `path` - 本地系统上的文件路径      | 设置用于与服务器进行 SSL 加密通信的客户端私钥。                                   | -       | `ssl_key`            |
        | `sslSocketSNI(String sni)`                  | `sni` - 服务器名称字符串         | 设置在 SSL/TLS 连接中用于 SNI（Server Name Indication，服务器名称指示）的服务器名称。 | -       | `ssl_socket_sni`     |
      </TabItem>

      <TabItem value="代理" label="代理">
        | 方法                                                | 参数                                                       | 描述             | 默认值 | 键                                        |
        | ------------------------------------------------- | -------------------------------------------------------- | -------------- | --- | ---------------------------------------- |
        | `addProxy(ProxyType type, String host, int port)` | `type` - 代理类型<br />`host` - 代理主机名或 IP<br />`port` - 代理端口 | 设置用于与服务器通信的代理。 | -   | `proxy_type`, `proxy_host`, `proxy_port` |
        | `setProxyCredentials(String user, String pass)`   | `user` - 代理用户名<br />`pass` - 密码                          | 设置用于代理认证的用户凭据。 | -   | `proxy_user`, `proxy_password`           |
      </TabItem>

      <TabItem value="http" label="HTTP 与头部">
        | Method                                      | Arguments                              | Description                    | Default | Key    |
        | ------------------------------------------- | -------------------------------------- | ------------------------------ | ------- | ------ |
        | `setHttpCookiesEnabled(boolean enabled)`    | `enabled` - 用于启用/禁用的标志位                | 设置是否应记住 HTTP cookie 并将其发送回服务器。 | -       | -      |
        | `httpHeader(String key, String value)`      | `key` - HTTP 头键<br />`value` - 字符串值    | 为单个 HTTP 头设置值。先前的值会被覆盖。        | `none`  | `none` |
        | `httpHeader(String key, Collection values)` | `key` - HTTP 头键<br />`values` - 字符串值列表 | 为单个 HTTP 头设置多个值。先前的值会被覆盖。      | `none`  | `none` |
        | `httpHeaders(Map headers)`                  | `headers` - 包含 HTTP 头的映射               | 一次性设置多个 HTTP 头的值。              | `none`  | `none` |
      </TabItem>

      <TabItem value="服务器设置" label="服务器配置">
        | Method                                          | Arguments                           | Description                                                                               | Default | Key    |
        | ----------------------------------------------- | ----------------------------------- | ----------------------------------------------------------------------------------------- | ------- | ------ |
        | `serverSetting(String name, String value)`      | `name` - 设置名称<br />`value` - 设置值    | 设置随每个查询一起发送到服务器的设置。单次操作的设置可以覆盖它。[设置列表](/operations/settings/query-level)                  | `none`  | `none` |
        | `serverSetting(String name, Collection values)` | `name` - 设置名称<br />`values` - 设置值集合 | 设置随每个查询一起发送到服务器的、包含多个值的设置，例如 [roles](/interfaces/http#setting-role-with-query-parameters) | `none`  | `none` |
      </TabItem>

      <TabItem value="时区" label="时区">
        | Method                                         | Arguments                     | Description                                      | Default | Key                    |
        | ---------------------------------------------- | ----------------------------- | ------------------------------------------------ | ------- | ---------------------- |
        | `useServerTimeZone(boolean useServerTimeZone)` | `useServerTimeZone` - 启用/禁用开关 | 设置在解码 `DateTime` 和 `Date` 列值时客户端是否应使用服务器时区。      | `true`  | `use_server_time_zone` |
        | `useTimeZone(String timeZone)`                 | `timeZone` - 有效的 Java 时区 ID   | 设置在解码 `DateTime` 和 `Date` 列值时是否使用指定的时区。将覆盖服务器时区。 | -       | `use_time_zone`        |
        | `setServerTimeZone(String timeZone)`           | `timeZone` - 有效的 Java 时区 ID   | 设置服务器端时区。默认将使用 UTC 时区。                           | `UTC`   | `server_time_zone`     |
      </TabItem>

      <TabItem value="高级" label="高级">
        | Method                                                                    | Arguments                                               | Description                                               | Default  | Key                          |
        | ------------------------------------------------------------------------- | ------------------------------------------------------- | --------------------------------------------------------- | -------- | ---------------------------- |
        | `setOption(String key, String value)`                                     | `key` - 配置选项键<br />`value` - 选项值                        | 设置客户端选项的原始值。适用于从属性配置文件读取配置的场景。                            | -        | -                            |
        | `useAsyncRequests(boolean async)`                                         | `async` - 启用/禁用标志                                       | 设置客户端是否应在单独线程中执行请求。默认禁用，因为应用程序更清楚如何组织多线程任务。               | `false`  | `async`                      |
        | `setSharedOperationExecutor(ExecutorService executorService)`             | `executorService` - ExecutorService 实例                  | 为操作任务设置 ExecutorService。                                  | `none`   | `none`                       |
        | `setClientNetworkBufferSize(int size)`                                    | `size` - 以字节为单位的大小                                      | 设置应用程序内存空间中缓冲区的大小，该缓冲区用于在 socket 与应用程序之间复制数据。             | `300000` | `client_network_buffer_size` |
        | `allowBinaryReaderToReuseBuffers(boolean reuse)`                          | `reuse` - 启用/禁用标志                                       | 如果启用，读取器将使用预分配的缓冲区执行数值转码。可降低数值数据的 GC 压力。                  | -        | -                            |
        | `columnToMethodMatchingStrategy(ColumnToMethodMatchingStrategy strategy)` | `strategy` - 匹配策略实现                                     | 设置在注册 DTO 时用于匹配 DTO 类字段和数据库列的自定义策略。                       | `none`   | `none`                       |
        | `setClientName(String clientName)`                                        | `clientName` - 应用程序名称字符串                                | 设置关于调用方应用程序的附加信息。该信息将作为 `User-Agent` 头传递。                 | -        | `client_name`                |
        | `registerClientMetrics(Object registry, String name)`                     | `registry` - Micrometer registry 实例<br />`name` - 指标组名称 | 向 Micrometer (https://micrometer.io/) registry 实例注册指标采集器。 | -        | -                            |
        | `setServerVersion(String version)`                                        | `version` - 服务器版本字符串                                    | 设置服务器版本以避免版本自动检测。                                         | -        | `server_version`             |
        | `typeHintMapping(Map typeHintMapping)`                                    | `typeHintMapping` - 类型提示映射                              | 为 ClickHouse 类型设置类型提示映射。例如，使多维数组可以以 Java 容器的形式呈现。         | -        | `type_hint_mapping`          |
      </TabItem>
    </Tabs>

    <br />

    ### 服务器设置 \{#server-settings\}

    服务器端设置可以在创建客户端时设置一次(参见 `Builder` 的 `serverSetting` 方法),也可以在操作级别设置(参见操作设置类的 `serverSetting`)。

    ```java showLineNumbers
     try (Client client = new Client.Builder().addEndpoint(Protocol.HTTP, "localhost", mockServer.port(), false)
            .setUsername("default")
            .setPassword(ClickHouseServerForTest.getPassword())
            .compressClientRequest(true)

            // Client level
            .serverSetting("max_threads", "10")
            .serverSetting("async_insert", "1")
            .serverSetting("roles", Arrays.asList("role1", "role2"))

            .build()) {

    	// Operation level
    	QuerySettings querySettings = new QuerySettings();
    	querySettings.serverSetting("session_timezone", "Europe/Zurich");

    	...
    }
    ```

    ⚠️ 当通过 `setOption` 方法设置选项时(无论是 `Client.Builder` 还是操作设置类),服务器设置名称都应添加 `clickhouse_setting_` 前缀。此时,`com.clickhouse.client.api.ClientConfigProperties#serverSetting()` 方法会很有用。

    ### 自定义 HTTP 请求头 \{#custom-http-header\}

    可以为所有操作(客户端级别)或单个操作(操作级别)设置自定义 HTTP 头。

    ```java showLineNumbers

    QuerySettings settings = new QuerySettings()
        .httpHeader(HttpHeaders.REFERER, clientReferer)
        .setQueryId(qId);

    ```

    当通过 `setOption` 方法设置选项时(无论是 `Client.Builder` 还是操作设置类),自定义请求头名称应以 `http_header_` 为前缀。此时,可以使用 `com.clickhouse.client.api.ClientConfigProperties#httpHeader()` 方法。

    ## 通用定义 \{#common-definitions\}

    ### ClickHouseFormat \{#clickhouseformat\}

    [支持的格式](/interfaces/formats)的枚举,包含 ClickHouse 支持的所有格式。

    * `raw` - 用户需要对原始数据进行转码
    * `full` - 客户端可以自行对数据进行转码，并能接收原始数据流
    * `-` - ClickHouse 不支持对该格式执行此操作

    此客户端版本支持:

    | 格式                                                                                                           |  输入  |  输出  |
    | ------------------------------------------------------------------------------------------------------------ | :--: | :--: |
    | [TabSeparated](/interfaces/formats/TabSeparated)                                                             |  原始  |  raw |
    | [TabSeparatedRaw](/interfaces/formats/TabSeparatedRaw)                                                       |  raw |  raw |
    | [TabSeparatedWithNames](/interfaces/formats/TabSeparatedWithNames)                                           |  原始  |  raw |
    | [TabSeparatedWithNamesAndTypes](/interfaces/formats/TabSeparatedWithNamesAndTypes)                           |  raw |  raw |
    | [TabSeparatedRawWithNames](/interfaces/formats/TabSeparatedRawWithNames)                                     |  raw |  raw |
    | [TabSeparatedRawWithNamesAndTypes](/interfaces/formats/TabSeparatedRawWithNamesAndTypes)                     |  raw |  raw |
    | [Template](/interfaces/formats/Template)                                                                     |  raw |  raw |
    | [TemplateIgnoreSpaces](/interfaces/formats/TemplateIgnoreSpaces)                                             |  原始  |   *  |
    | [CSV](/interfaces/formats/CSV)                                                                               |  原始  |  原始  |
    | [CSVWithNames](/interfaces/formats/CSVWithNames)                                                             |  raw |  raw |
    | [CSVWithNamesAndTypes](/interfaces/formats/CSVWithNamesAndTypes)                                             |  原始  |  raw |
    | [CustomSeparated](/interfaces/formats/CustomSeparated)                                                       |  raw |  原始  |
    | [CustomSeparatedWithNames](/interfaces/formats/CustomSeparatedWithNames)                                     |  原始  |  原始  |
    | [CustomSeparatedWithNamesAndTypes](/interfaces/formats/CustomSeparatedWithNamesAndTypes)                     |  raw |  raw |
    | [SQLInsert](/interfaces/formats/SQLInsert)                                                                   |   -  |  raw |
    | [Values](/interfaces/formats/Values)                                                                         |  raw |  原始  |
    | [Vertical](/interfaces/formats/Vertical)                                                                     |   *  |  原始  |
    | [JSON](/interfaces/formats/JSON)                                                                             |  raw |  原始  |
    | [JSONAsString](/interfaces/formats/JSONAsString)                                                             |  raw |   -  |
    | [JSONAsObject](/interfaces/formats/JSONAsObject)                                                             |  raw |   *  |
    | [JSONStrings](/interfaces/formats/JSONStrings)                                                               |  raw |  原始  |
    | [JSONColumns](/interfaces/formats/JSONColumns)                                                               |  raw |  原样  |
    | [JSONColumnsWithMetadata](/interfaces/formats/JSONColumnsWithMetadata)                                       |  原始  |  原始  |
    | [JSONCompact](/interfaces/formats/JSONCompact)                                                               |  raw |  原始  |
    | [JSONCompactStrings](/interfaces/formats/JSONCompactStrings)                                                 |   -  |  原始  |
    | [JSONCompactColumns](/interfaces/formats/JSONCompactColumns)                                                 |  raw |  原样  |
    | [JSONEachRow](/interfaces/formats/JSONEachRow)                                                               |  原始  |  原始  |
    | [PrettyJSONEachRow](/interfaces/formats/PrettyJSONEachRow)                                                   |   *  |  raw |
    | [JSONEachRowWithProgress](/interfaces/formats/JSONEachRowWithProgress)                                       |   -  |  原始  |
    | [JSONStringsEachRow](/interfaces/formats/JSONStringsEachRow)                                                 |  raw |  原始  |
    | [JSONStringsEachRowWithProgress](/interfaces/formats/JSONStringsEachRowWithProgress)                         |   *  |  原始  |
    | [JSONCompactEachRow](/interfaces/formats/JSONCompactEachRow)                                                 |  原始  |  raw |
    | [JSONCompactEachRowWithNames](/interfaces/formats/JSONCompactEachRowWithNames)                               |  原始  |  raw |
    | [JSONCompactEachRowWithNamesAndTypes](/interfaces/formats/JSONCompactEachRowWithNamesAndTypes)               |  原始  |  原始  |
    | [JSONCompactStringsEachRow](/interfaces/formats/JSONCompactStringsEachRow)                                   |  raw |  raw |
    | [JSONCompactStringsEachRowWithNames](/interfaces/formats/JSONCompactStringsEachRowWithNames)                 |  原始  |  原始  |
    | [JSONCompactStringsEachRowWithNamesAndTypes](/interfaces/formats/JSONCompactStringsEachRowWithNamesAndTypes) |  raw |  raw |
    | [JSONObjectEachRow](/interfaces/formats/JSONObjectEachRow)                                                   |  raw |  原始  |
    | [BSONEachRow](/interfaces/formats/BSONEachRow)                                                               |  原始  |  raw |
    | [TSKV](/interfaces/formats/TSKV)                                                                             |  raw |  原始  |
    | [Pretty](/interfaces/formats/Pretty)                                                                         |   -  |  原始  |
    | [PrettyNoEscapes](/interfaces/formats/PrettyNoEscapes)                                                       |   *  | 原始格式 |
    | [PrettyMonoBlock](/interfaces/formats/PrettyMonoBlock)                                                       |   -  |  raw |
    | [PrettyNoEscapesMonoBlock](/interfaces/formats/PrettyNoEscapesMonoBlock)                                     |   *  |  raw |
    | [PrettyCompact](/interfaces/formats/PrettyCompact)                                                           |   -  |  原始  |
    | [PrettyCompactNoEscapes](/interfaces/formats/PrettyCompactNoEscapes)                                         |   *  |  原始  |
    | [PrettyCompactMonoBlock](/interfaces/formats/PrettyCompactMonoBlock)                                         |   -  |  raw |
    | [PrettyCompactNoEscapesMonoBlock](/interfaces/formats/PrettyCompactNoEscapesMonoBlock)                       |   *  |  原始  |
    | [PrettySpace](/interfaces/formats/PrettySpace)                                                               |   -  |  原始  |
    | [PrettySpaceNoEscapes](/interfaces/formats/PrettySpaceNoEscapes)                                             |   *  |  原始  |
    | [PrettySpaceMonoBlock](/interfaces/formats/PrettySpaceMonoBlock)                                             |   -  |  原始  |
    | [PrettySpaceNoEscapesMonoBlock](/interfaces/formats/PrettySpaceNoEscapesMonoBlock)                           |   *  |  raw |
    | [Prometheus](/interfaces/formats/Prometheus)                                                                 |   -  |  raw |
    | [Protobuf](/interfaces/formats/Protobuf)                                                                     |  原始  |  原始  |
    | [ProtobufSingle](/interfaces/formats/ProtobufSingle)                                                         |  原始  |  原始  |
    | [ProtobufList](/interfaces/formats/ProtobufList)                                                             |  raw |  原始  |
    | [Avro](/interfaces/formats/Avro)                                                                             |  原始  |  原始  |
    | [AvroConfluent](/interfaces/formats/AvroConfluent)                                                           |  raw |   *  |
    | [Parquet](/interfaces/formats/Parquet)                                                                       | 原始数据 | 原始数据 |
    | [ParquetMetadata](/interfaces/formats/ParquetMetadata)                                                       |  原始  |   -  |
    | [Arrow](/interfaces/formats/Arrow)                                                                           |  原始  |  raw |
    | [ArrowStream](/interfaces/formats/ArrowStream)                                                               |  raw |  raw |
    | [ORC](/interfaces/formats/ORC)                                                                               |  原始  |  raw |
    | [One](/interfaces/formats/One)                                                                               |  原始  |   *  |
    | [Npy](/interfaces/formats/Npy)                                                                               |  原始  |  原始  |
    | [RowBinary](/interfaces/formats/RowBinary)                                                                   |  完整  | full |
    | [RowBinaryWithNames](/interfaces/formats/RowBinaryWithNamesAndTypes)                                         | full | 完全支持 |
    | [RowBinaryWithNamesAndTypes](/interfaces/formats/RowBinaryWithNamesAndTypes)                                 |  完全  | 完全支持 |
    | [RowBinaryWithDefaults](/interfaces/formats/RowBinaryWithDefaults)                                           |  完整  |   -  |
    | [Native](/interfaces/formats/Native)                                                                         |  完整  |  原始  |
    | [Null](/interfaces/formats/Null)                                                                             |   *  |  原始  |
    | [XML](/interfaces/formats/XML)                                                                               |   -  |  raw |
    | [CapnProto](/interfaces/formats/CapnProto)                                                                   |  raw |  原始  |
    | [LineAsString](/interfaces/formats/LineAsString)                                                             |  原始  |  原始  |
    | [Regexp](/interfaces/formats/Regexp)                                                                         | 原始数据 |   *  |
    | [RawBLOB](/interfaces/formats/RawBLOB)                                                                       |  raw |  raw |
    | [MsgPack](/interfaces/formats/MsgPack)                                                                       |  原始  |  原始  |
    | [MySQLDump](/interfaces/formats/MySQLDump)                                                                   |  原始  |   -  |
    | [DWARF](/interfaces/formats/DWARF)                                                                           |  原始  |   *  |
    | [Markdown](/interfaces/formats/Markdown)                                                                     |   -  |  raw |
    | [Form](/interfaces/formats/Form)                                                                             |  原始  |   *  |

    ## 插入 API \{#insert-api\}

    ### insert(String tableName, InputStream data, ClickHouseFormat format) \{#insertstring-tablename-inputstream-data-clickhouseformat-format\}

    接受指定格式的字节 `InputStream` 数据。要求 `data` 使用 `format` 编码。

    **签名**

    ```java
    CompletableFuture<InsertResponse> insert(String tableName, InputStream data, ClickHouseFormat format, InsertSettings settings)
    CompletableFuture<InsertResponse> insert(String tableName, InputStream data, ClickHouseFormat format)
    ```

    **参数**

    `tableName` - 目标表名。

    `data` - 已编码数据的输入流。

    `format` - 数据编码所使用的格式。

    `settings` - 请求设置。

    **返回值**

    `InsertResponse` 类型的 Future - 操作结果及服务器端指标等附加信息。

    **示例**

    ```java showLineNumbers
    try (InputStream dataStream = getDataStream()) {
        try (InsertResponse response = client.insert(TABLE_NAME, dataStream, ClickHouseFormat.JSONEachRow,
                insertSettings).get(3, TimeUnit.SECONDS)) {

            log.info("Insert finished: {} rows written", response.getMetrics().getMetric(ServerMetrics.NUM_ROWS_WRITTEN).getLong());
        } catch (Exception e) {
            log.error("Failed to write JSONEachRow data", e);
            throw new RuntimeException(e);
        }
    }

    ```

    ### insert(String tableName, List&lt;?&gt; data, InsertSettings settings) \{#insertstring-tablename-listlt-data-insertsettings-settings\}

    向数据库发送写入请求。对象列表将被转换为高效格式,然后发送到服务器。列表项的类应事先使用 `register(Class, TableSchema)` 方法进行注册。

    **签名**

    ```java
    client.insert(String tableName, List<?> data, InsertSettings settings)
    client.insert(String tableName, List<?> data)
    ```

    **参数**

    `tableName` - 目标表名称。

    `data` - DTO(数据传输对象)集合对象。

    `settings` - 请求设置。

    **返回值**

    `InsertResponse` 类型的 Future - 包含操作结果以及服务器端指标等附加信息。

    **示例**

    ```java showLineNumbers
    // Important step (done once) - register class to pre-compile object serializer according to the table schema.
    client.register(ArticleViewEvent.class, client.getTableSchema(TABLE_NAME));

    List<ArticleViewEvent> events = loadBatch();

    try (InsertResponse response = client.insert(TABLE_NAME, events).get()) {
        // handle response, then it will be closed and connection that served request will be released.
    }
    ```

    ### InsertSettings \{#insertsettings\}

    插入操作的配置选项。

    **配置方式**

    | 方法                                              | 说明                                                  |
    | ----------------------------------------------- | --------------------------------------------------- |
    | `setQueryId(String queryId)`                    | 设置要分配给该操作的查询 ID。默认值：`null`。                         |
    | `setDeduplicationToken(String token)`           | 设置去重令牌。该令牌将被发送到服务器，可用于标识该查询。默认值：`null`。             |
    | `setInputStreamCopyBufferSize(int size)`        | 复制缓冲区大小。该缓冲区在写入操作期间用于将数据从用户提供的输入流复制到输出流。默认值：`8196`。 |
    | `serverSetting(String name, String value)`      | 为一次操作设置单个服务器参数。                                     |
    | `serverSetting(String name, Collection values)` | 为某个操作设置一个可包含多个值的服务器配置项。集合中的元素必须是 `String` 类型的值。     |
    | `setDBRoles(Collection dbRoles)`                | 设置在执行操作前生效的 DB 角色。集合中的元素应为 `String` 类型的值。           |
    | `setOption(String option, Object value)`        | 以原始格式设置配置选项。这不是服务器级设置。                              |

    ### InsertResponse \{#insertresponse\}

    响应对象,保存插入操作的结果。仅在客户端收到服务器响应时可用。

    :::note
    应尽快关闭此对象以释放连接,因为只有在完全读取上一个响应的所有数据后,连接才能被重用。
    :::

    | 方法                              | 说明                                       |
    | ------------------------------- | ---------------------------------------- |
    | `OperationMetrics getMetrics()` | 返回一个包含操作指标的对象。                           |
    | `String getQueryId()`           | 返回为该操作分配的查询 ID，该 ID 由应用程序（通过操作设置）或服务器指定。 |

    ## 查询 API \{#query-api\}

    ### query(String sqlQuery) \{#querystring-sqlquery\}

    按原样发送 `sqlQuery`。响应格式由查询设置决定。`QueryResponse` 将持有对响应流的引用,该响应流应由支持相应格式的读取器消费。

    **签名**

    ```java
    CompletableFuture<QueryResponse> query(String sqlQuery, QuerySettings settings)
    CompletableFuture<QueryResponse> query(String sqlQuery)
    ```

    **参数**

    `sqlQuery` - 单个 SQL 语句。该查询将按原样发送到服务器。

    `settings` - 请求设置。

    **返回值**

    `QueryResponse` 类型的 Future - 包含结果数据集和附加信息(如服务器端指标)。使用完数据集后应关闭 Response 对象。

    **示例**

    ```java
    final String sql = "select * from " + TABLE_NAME + " where title <> '' limit 10";

    // Default format is RowBinaryWithNamesAndTypesFormatReader so reader have all information about columns
    try (QueryResponse response = client.query(sql).get(3, TimeUnit.SECONDS);) {

        // Create a reader to access the data in a convenient way
        ClickHouseBinaryFormatReader reader = client.newBinaryFormatReader(response);

        while (reader.hasNext()) {
            reader.next(); // Read the next record from stream and parse it

            // get values
            double id = reader.getDouble("id");
            String title = reader.getString("title");
            String url = reader.getString("url");

            // collecting data
        }
    } catch (Exception e) {
        log.error("Failed to read data", e);
    }

    // put business logic outside of the reading block to release http connection asap.
    ```

    ### query(String sqlQuery, Map&lt;String, Object&gt; queryParams, QuerySettings settings) \{#querystring-sqlquery-mapltstring-object-queryparams-querysettings-settings\}

    按原样发送 `sqlQuery`。此外还会发送查询参数,以便服务器编译 SQL 表达式。

    **签名**

    ```java
    CompletableFuture<QueryResponse> query(String sqlQuery, Map<String, Object> queryParams, QuerySettings settings)
    ```

    **参数**

    `sqlQuery` - 带有占位符 `{}` 的 SQL 表达式。

    `queryParams` - 用于在服务器上完成 SQL 表达式的变量映射表。

    `settings` - 请求设置。

    **返回值**

    `QueryResponse` 类型的 Future - 包含结果数据集和附加信息(如服务器端指标)。使用完数据集后应关闭 Response 对象。

    **示例**

    ```java showLineNumbers

    // define parameters. They will be sent to the server along with the request.
    Map<String, Object> queryParams = new HashMap<>();
    queryParams.put("param1", 2);

    try (QueryResponse response =
            client.query("SELECT * FROM " + table + " WHERE col1 >= {param1:UInt32}", queryParams, new QuerySettings()).get()) {

        // Create a reader to access the data in a convenient way
        ClickHouseBinaryFormatReader reader = client.newBinaryFormatReader(response);

        while (reader.hasNext()) {
            reader.next(); // Read the next record from stream and parse it

            // reading data
        }

    } catch (Exception e) {
        log.error("Failed to read data", e);
    }

    ```

    ### queryAll(String sqlQuery) \{#queryallstring-sqlquery\}

    以 `RowBinaryWithNamesAndTypes` 格式查询数据。将结果作为集合返回。读取性能与 reader 相同,但需要更多内存来保存整个数据集。

    **签名**

    ```java
    List<GenericRecord> queryAll(String sqlQuery)
    ```

    **参数**

    `sqlQuery` - 用于从服务器查询数据的 SQL 表达式。

    **返回值**

    完整数据集由 `GenericRecord` 对象列表表示,这些对象以行形式提供对结果数据的访问。

    **示例**

    ```java showLineNumbers
    try {
        log.info("Reading whole table and process record by record");
        final String sql = "select * from " + TABLE_NAME + " where title <> ''";

        // Read whole result set and process it record by record
        client.queryAll(sql).forEach(row -> {
            double id = row.getDouble("id");
            String title = row.getString("title");
            String url = row.getString("url");

            log.info("id: {}, title: {}, url: {}", id, title, url);
        });
    } catch (Exception e) {
        log.error("Failed to read data", e);
    }
    ```

    ### QuerySettings \{#querysettings\}

    查询操作的配置选项。

    **配置方式**

    | 方法                                                | 说明                                                                                                   |
    | ------------------------------------------------- | ---------------------------------------------------------------------------------------------------- |
    | `setQueryId(String queryId)`                      | 设置要分配给该操作的查询 ID。                                                                                     |
    | `setFormat(ClickHouseFormat format)`              | 设置响应格式。完整列表请参见 `RowBinaryWithNamesAndTypes`。                                                         |
    | `setMaxExecutionTime(Integer maxExecutionTime)`   | 在服务器端设置操作的最大执行时间。不会影响读取超时设置。                                                                         |
    | `waitEndOfQuery(Boolean waitEndOfQuery)`          | 请求服务器在发送响应前等待查询完成。                                                                                   |
    | `setUseServerTimeZone(Boolean useServerTimeZone)` | 服务器时区（参见客户端配置）将用于解析操作结果中的日期/时间类型。默认值为 `false`。                                                       |
    | `setUseTimeZone(String timeZone)`                 | 请求服务器使用 `timeZone` 进行时间转换。参见 [session&#95;timezone](/operations/settings/settings#session_timezone)。 |
    | `serverSetting(String name, String value)`        | 为一次操作设置单个服务器配置项。                                                                                     |
    | `serverSetting(String name, Collection values)`   | 为某个操作设置可包含多个值的单个服务器配置项。集合中的各项应为 `String` 值。                                                          |
    | `setDBRoles(Collection dbRoles)`                  | 设置在执行操作前要应用的数据库角色。集合中的元素应为 `String` 值。                                                               |
    | `setOption(String option, Object value)`          | 以原始格式设置配置选项。这不是服务器级别的设置。                                                                             |

    ### QueryResponse \{#queryresponse\}

    用于保存查询执行结果的响应对象。仅在客户端从服务器收到响应时可用。

    :::note
    应尽快关闭此对象以释放连接,因为只有在完全读取上一个响应的所有数据后,连接才能被重用。
    :::

    | 方法                              | 说明                                        |
    | ------------------------------- | ----------------------------------------- |
    | `ClickHouseFormat getFormat()`  | 返回用于对响应数据进行编码的格式。                         |
    | `InputStream getInputStream()`  | 返回采用指定格式的未压缩数据字节流。                        |
    | `OperationMetrics getMetrics()` | 返回一个包含该操作各项指标的对象。                         |
    | `String getQueryId()`           | 返回为该操作分配的查询 ID，该 ID 由应用程序（通过操作设置）或由服务器生成。 |
    | `TimeZone getTimeZone()`        | 返回用于处理响应中 Date/DateTime 类型的时区。            |

    ### 示例 \{#examples\}

    * 示例代码可在此[仓库](https://github.com/ClickHouse/clickhouse-java/tree/main/examples/client-v2)中找到。
    * 参考 Spring Service 的[实现示例](https://github.com/ClickHouse/clickhouse-java/tree/main/examples/demo-service)

    ## 通用 API \{#common-api\}

    ### getTableSchema(String table) \{#gettableschemastring-table\}

    获取 `table` 的表架构。

    **签名**

    ```java
    TableSchema getTableSchema(String table)
    TableSchema getTableSchema(String table, String database)
    ```

    **参数**

    `table` - 要获取模式数据的表名。

    `database` - 目标表所在的数据库。

    **返回值**

    返回包含表列列表的 `TableSchema` 对象。

    ### getTableSchemaFromQuery(String sql) \{#gettableschemafromquerystring-sql\}

    从 SQL 语句中获取模式（schema）。

    **签名**

    ```java
    TableSchema getTableSchemaFromQuery(String sql)
    ```

    **参数**

    `sql` - 需要返回其模式（schema）的 &quot;SELECT&quot; SQL 语句。

    **返回值**

    返回一个 `TableSchema` 对象,其列与 `sql` 表达式相匹配。

    ### TableSchema \{#tableschema\}

    ### register(Class&lt;?&gt; clazz, TableSchema schema) \{#registerclasslt-clazz-tableschema-schema\}

    为 Java 类编译序列化和反序列化层,以便使用 `schema` 进行数据的写入和读取。该方法将为 getter/setter 方法对及其对应的列创建序列化器和反序列化器。
    列匹配通过从方法名称中提取列名来实现。例如,`getFirstName` 方法将对应于列 `first_name` 或 `firstname`。

    **签名**

    ```java
    void register(Class<?> clazz, TableSchema schema)
    ```

    **参数**

    `clazz` - 表示用于读写数据的 POJO 类。

    `schema` - 用于与 POJO 属性进行匹配的数据架构。

    **示例**

    ```java showLineNumbers
    client.register(ArticleViewEvent.class, client.getTableSchema(TABLE_NAME));
    ```

    ## 使用示例 \{#usage-examples\}

    完整的示例代码存储在代码仓库的 `example` [文件夹](https://github.com/ClickHouse/clickhouse-java/tree/main/examples)中:

    * [client-v2](https://github.com/ClickHouse/clickhouse-java/tree/main/examples/client-v2) - 主要示例集合。
    * [demo-service](https://github.com/ClickHouse/clickhouse-java/tree/main/examples/demo-service) - 在 Spring Boot 应用程序中使用客户端的示例。
    * [demo-kotlin-service](https://github.com/ClickHouse/clickhouse-java/tree/main/examples/demo-kotlin-service) - 在 Ktor（Kotlin）应用中使用该客户端的示例。

    ## 迁移指南 \{#migration_guide\}

    旧版客户端(V1)使用 `com.clickhouse.client.ClickHouseClient#builder` 作为入口点。新版客户端(V2)采用类似的模式,使用 `com.clickhouse.client.api.Client.Builder`。主要差异如下:

    * 这里不会使用 service loader 来获取具体实现。`com.clickhouse.client.api.Client` 是一个外观类，作为未来各种实现的统一入口。
    * 配置来源更少：一个由构建器提供，另一个来自操作设置（`QuerySettings`、`InsertSettings`）。先前的版本在每个节点上都有配置，并且在某些情况下会从环境变量中加载。

    ### 配置参数匹配 \{#migration_from_v1_config\}

    V1 中有 3 个与配置相关的枚举类：

    * `com.clickhouse.client.config.ClickHouseDefaults` - 在大多数使用场景下通常需要设置的配置参数，例如 `USER` 和 `PASSWORD`。
    * `com.clickhouse.client.config.ClickHouseClientOption` - 客户端特定的配置参数，例如 `HEALTH_CHECK_INTERVAL`。
    * `com.clickhouse.client.http.config.ClickHouseHttpOption` - 特定于 HTTP 接口的配置参数，例如 `RECEIVE_QUERY_PROGRESS`。

    它们的设计目的是对参数进行分组并提供清晰的分离。但在某些情况下会导致混淆(例如 `com.clickhouse.client.config.ClickHouseDefaults#ASYNC` 和 `com.clickhouse.client.config.ClickHouseClientOption#ASYNC` 之间是否存在差异)。 新的 V2 客户端使用 `com.clickhouse.client.api.Client.Builder` 作为所有可能客户端配置选项的单一字典。所有配置参数名称列在 `com.clickhouse.client.api.ClientConfigProperties` 中。

    下表列出了新客户端支持的旧选项及其新含义。

    **图例：** ✔ = 支持，✗ = 已弃用

    <Tabs groupId="v1-migration">
      <TabItem value="连接认证" label="连接与认证">
        | V1 配置项                                                                           | V2 构建器方法                                    | 备注           |
        | -------------------------------------------------------------------------------- | ------------------------------------------- | ------------ |
        | `ClickHouseDefaults#HOST`                                                        | `Client.Builder#addEndpoint`                |              |
        | `ClickHouseDefaults#PROTOCOL`                                                    | ✗                                           | V2 中仅支持 HTTP |
        | `ClickHouseDefaults#DATABASE`<br />`ClickHouseClientOption#DATABASE`             | `Client.Builder#setDefaultDatabase`         |              |
        | `ClickHouseDefaults#USER`                                                        | `Client.Builder#setUsername`                |              |
        | `ClickHouseDefaults#PASSWORD`                                                    | `Client.Builder#setPassword`                |              |
        | `ClickHouseClientOption#CONNECTION_TIMEOUT`                                      | `Client.Builder#setConnectTimeout`          |              |
        | `ClickHouseClientOption#CONNECTION_TTL`                                          | `Client.Builder#setConnectionTTL`           |              |
        | `ClickHouseHttpOption#MAX_OPEN_CONNECTIONS`                                      | `Client.Builder#setMaxConnections`          |              |
        | `ClickHouseHttpOption#KEEP_ALIVE`<br />`ClickHouseHttpOption#KEEP_ALIVE_TIMEOUT` | `Client.Builder#setKeepAliveTimeout`        |              |
        | `ClickHouseHttpOption#CONNECTION_REUSE_STRATEGY`                                 | `Client.Builder#setConnectionReuseStrategy` |              |
        | `ClickHouseHttpOption#USE_BASIC_AUTHENTICATION`                                  | `Client.Builder#useHTTPBasicAuth`           |              |
      </TabItem>

      <TabItem value="SSL" label="SSL 与安全">
        | V1 配置                                                  | V2 Builder 方法                             | 注释                                        |
        | ------------------------------------------------------ | ----------------------------------------- | ----------------------------------------- |
        | `ClickHouseDefaults#SSL_CERTIFICATE_TYPE`              | ✗                                         |                                           |
        | `ClickHouseDefaults#SSL_KEY_ALGORITHM`                 | ✗                                         |                                           |
        | `ClickHouseDefaults#SSL_PROTOCOL`                      | ✗                                         |                                           |
        | `ClickHouseClientOption#SSL`                           | ✗                                         | 请参见 `Client.Builder#addEndpoint`          |
        | `ClickHouseClientOption#SSL_MODE`                      | ✗                                         |                                           |
        | `ClickHouseClientOption#SSL_ROOT_CERTIFICATE`          | `Client.Builder#setRootCertificate`       | 应通过 `useSSLAuthentication` 启用 SSL 身份验证    |
        | `ClickHouseClientOption#SSL_CERTIFICATE`               | `Client.Builder#setClientCertificate`     |                                           |
        | `ClickHouseClientOption#SSL_KEY`                       | `Client.Builder#setClientKey`             |                                           |
        | `ClickHouseClientOption#KEY_STORE_TYPE`                | `Client.Builder#setSSLTrustStoreType`     |                                           |
        | `ClickHouseClientOption#TRUST_STORE`                   | `Client.Builder#setSSLTrustStore`         |                                           |
        | `ClickHouseClientOption#KEY_STORE_PASSWORD`            | `Client.Builder#setSSLTrustStorePassword` |                                           |
        | `ClickHouseClientOption#SSL_SOCKET_SNI`                | `Client.Builder#sslSocketSNI`             |                                           |
        | `ClickHouseClientOption#CUSTOM_SOCKET_FACTORY`         | ✗                                         |                                           |
        | `ClickHouseClientOption#CUSTOM_SOCKET_FACTORY_OPTIONS` | ✗                                         | 请参见 `Client.Builder#sslSocketSNI` 以设置 SNI |
      </TabItem>

      <TabItem value="套接字" label="套接字选项">
        | V1 配置                                       | V2 构建器方法                               | 说明 |
        | ------------------------------------------- | -------------------------------------- | -- |
        | `ClickHouseClientOption#SOCKET_TIMEOUT`     | `Client.Builder#setSocketTimeout`      |    |
        | `ClickHouseClientOption#SOCKET_REUSEADDR`   | `Client.Builder#setSocketReuseAddress` |    |
        | `ClickHouseClientOption#SOCKET_KEEPALIVE`   | `Client.Builder#setSocketKeepAlive`    |    |
        | `ClickHouseClientOption#SOCKET_LINGER`      | `Client.Builder#setSocketLinger`       |    |
        | `ClickHouseClientOption#SOCKET_IP_TOS`      | ✗                                      |    |
        | `ClickHouseClientOption#SOCKET_TCP_NODELAY` | `Client.Builder#setSocketTcpNodelay`   |    |
        | `ClickHouseClientOption#SOCKET_RCVBUF`      | `Client.Builder#setSocketRcvbuf`       |    |
        | `ClickHouseClientOption#SOCKET_SNDBUF`      | `Client.Builder#setSocketSndbuf`       |    |
      </TabItem>

      <TabItem value="压缩" label="压缩">
        | V1 配置                                         | V2 Builder 方法                           | 说明                                         |
        | --------------------------------------------- | --------------------------------------- | ------------------------------------------ |
        | `ClickHouseClientOption#COMPRESS`             | `Client.Builder#compressServerResponse` | 另见 `useHttpCompression`                    |
        | `ClickHouseClientOption#DECOMPRESS`           | `Client.Builder#compressClientRequest`  | 另见 `useHttpCompression`                    |
        | `ClickHouseClientOption#COMPRESS_ALGORITHM`   | ✗                                       | 非 HTTP 使用 `LZ4`；HTTP 使用 `Accept-Encoding`  |
        | `ClickHouseClientOption#DECOMPRESS_ALGORITHM` | ✗                                       | 非 HTTP 使用 `LZ4`；HTTP 使用 `Content-Encoding` |
        | `ClickHouseClientOption#COMPRESS_LEVEL`       | ✗                                       |                                            |
        | `ClickHouseClientOption#DECOMPRESS_LEVEL`     | ✗                                       |                                            |
      </TabItem>

      <TabItem value="代理" label="代理">
        | V1 配置                                   | V2 构建器方法                             | 备注 |
        | --------------------------------------- | ------------------------------------ | -- |
        | `ClickHouseClientOption#PROXY_TYPE`     | `Client.Builder#addProxy`            |    |
        | `ClickHouseClientOption#PROXY_HOST`     | `Client.Builder#addProxy`            |    |
        | `ClickHouseClientOption#PROXY_PORT`     | `Client.Builder#addProxy`            |    |
        | `ClickHouseClientOption#PROXY_USERNAME` | `Client.Builder#setProxyCredentials` |    |
        | `ClickHouseClientOption#PROXY_PASSWORD` | `Client.Builder#setProxyCredentials` |    |
      </TabItem>

      <TabItem value="超时重试" label="超时和重试">
        | V1 配置                                           | V2 Builder 方法                        | 备注                     |
        | ----------------------------------------------- | ------------------------------------ | ---------------------- |
        | `ClickHouseClientOption#MAX_EXECUTION_TIME`     | `Client.Builder#setExecutionTimeout` |                        |
        | `ClickHouseClientOption#RETRY`                  | `Client.Builder#setMaxRetries`       | 另请参见 `retryOnFailures` |
        | `ClickHouseHttpOption#AHC_RETRY_ON_FAILURE`     | `Client.Builder#retryOnFailures`     |                        |
        | `ClickHouseClientOption#FAILOVER`               | ✗                                    |                        |
        | `ClickHouseClientOption#REPEAT_ON_SESSION_LOCK` | ✗                                    |                        |
        | `ClickHouseClientOption#SESSION_ID`             | ✗                                    |                        |
        | `ClickHouseClientOption#SESSION_CHECK`          | ✗                                    |                        |
        | `ClickHouseClientOption#SESSION_TIMEOUT`        | ✗                                    |                        |
      </TabItem>

      <TabItem value="时区" label="时区">
        | V1 配置                                                                                | V2 构建器方法                           | 说明 |
        | ------------------------------------------------------------------------------------ | ---------------------------------- | -- |
        | `ClickHouseDefaults#SERVER_TIME_ZONE`<br />`ClickHouseClientOption#SERVER_TIME_ZONE` | `Client.Builder#setServerTimeZone` |    |
        | `ClickHouseClientOption#USE_SERVER_TIME_ZONE`                                        | `Client.Builder#useServerTimeZone` |    |
        | `ClickHouseClientOption#USE_SERVER_TIME_ZONE_FOR_DATES`                              |                                    |    |
        | `ClickHouseClientOption#USE_TIME_ZONE`                                               | `Client.Builder#useTimeZone`       |    |
      </TabItem>

      <TabItem value="缓冲区" label="缓冲机制与性能">
        | V1 配置                                           | V2 构建器方法                                    | 备注 |
        | ----------------------------------------------- | ------------------------------------------- | -- |
        | `ClickHouseClientOption#BUFFER_SIZE`            | `Client.Builder#setClientNetworkBufferSize` |    |
        | `ClickHouseClientOption#BUFFER_QUEUE_VARIATION` | ✗                                           |    |
        | `ClickHouseClientOption#READ_BUFFER_SIZE`       | ✗                                           |    |
        | `ClickHouseClientOption#WRITE_BUFFER_SIZE`      | ✗                                           |    |
        | `ClickHouseClientOption#REQUEST_CHUNK_SIZE`     | ✗                                           |    |
        | `ClickHouseClientOption#REQUEST_BUFFERING`      | ✗                                           |    |
        | `ClickHouseClientOption#RESPONSE_BUFFERING`     | ✗                                           |    |
        | `ClickHouseClientOption#MAX_BUFFER_SIZE`        | ✗                                           |    |
        | `ClickHouseClientOption#MAX_QUEUED_BUFFERS`     | ✗                                           |    |
        | `ClickHouseClientOption#MAX_QUEUED_REQUESTS`    | ✗                                           |    |
        | `ClickHouseClientOption#REUSE_VALUE_WRAPPER`    | ✗                                           |    |
      </TabItem>

      <TabItem value="线程" label="线程与异步">
        | V1 配置                                                          | V2 Builder 方法                     | 备注                               |
        | -------------------------------------------------------------- | --------------------------------- | -------------------------------- |
        | `ClickHouseDefaults#ASYNC`<br />`ClickHouseClientOption#ASYNC` | `Client.Builder#useAsyncRequests` |                                  |
        | `ClickHouseDefaults#MAX_SCHEDULER_THREADS`                     | ✗                                 | 请参见 `setSharedOperationExecutor` |
        | `ClickHouseDefaults#MAX_THREADS`                               | ✗                                 | 请参见 `setSharedOperationExecutor` |
        | `ClickHouseDefaults#THREAD_KEEPALIVE_TIMEOUT`                  | 请参见 `setSharedOperationExecutor`  |                                  |
        | `ClickHouseClientOption#MAX_THREADS_PER_CLIENT`                | ✗                                 |                                  |
        | `ClickHouseClientOption#MAX_CORE_THREAD_TTL`                   | ✗                                 |                                  |
      </TabItem>

      <TabItem value="HTTP 头部" label="HTTP 与请求头">
        | V1 配置                                                | V2 构建器方法                       | 备注                                |
        | ---------------------------------------------------- | ------------------------------ | --------------------------------- |
        | `ClickHouseHttpOption#CUSTOM_HEADERS`                | `Client.Builder#httpHeaders`   |                                   |
        | `ClickHouseHttpOption#CUSTOM_PARAMS`                 | ✗                              | 参见 `Client.Builder#serverSetting` |
        | `ClickHouseClientOption#CLIENT_NAME`                 | `Client.Builder#setClientName` |                                   |
        | `ClickHouseHttpOption#CONNECTION_PROVIDER`           | ✗                              |                                   |
        | `ClickHouseHttpOption#DEFAULT_RESPONSE`              | ✗                              |                                   |
        | `ClickHouseHttpOption#SEND_HTTP_CLIENT_ID`           | ✗                              |                                   |
        | `ClickHouseHttpOption#AHC_VALIDATE_AFTER_INACTIVITY` | ✗                              | 使用 Apache Http Client 时始终启用       |
      </TabItem>

      <TabItem value="格式化查询" label="格式和查询">
        | V1 配置                                                            | V2 构建器方法            | 说明                                                                  |
        | ---------------------------------------------------------------- | ------------------- | ------------------------------------------------------------------- |
        | `ClickHouseDefaults#FORMAT`<br />`ClickHouseClientOption#FORMAT` | ✗                   | 已移动到操作级设置（`QuerySettings` 和 `InsertSettings`）                       |
        | `ClickHouseClientOption#QUERY_ID`                                | ✗                   | 参见 `QuerySettings` 和 `InsertSettings`                               |
        | `ClickHouseClientOption#LOG_LEADING_COMMENT`                     | ✗                   | 参见 `QuerySettings#logComment` 和 `InsertSettings#logComment`         |
        | `ClickHouseClientOption#MAX_RESULT_ROWS`                         | ✗                   | 是服务端设置                                                              |
        | `ClickHouseClientOption#RESULT_OVERFLOW_MODE`                    | ✗                   | 是服务端设置                                                              |
        | `ClickHouseHttpOption#RECEIVE_QUERY_PROGRESS`                    | ✗                   | 是服务端设置                                                              |
        | `ClickHouseHttpOption#WAIT_END_OF_QUERY`                         | ✗                   | 是服务端设置                                                              |
        | `ClickHouseHttpOption#REMEMBER_LAST_SET_ROLES`                   | `Client#setDBRoles` | 现为运行时配置。另见 `QuerySettings#setDBRoles` 和 `InsertSettings#setDBRoles` |
      </TabItem>

      <TabItem value="节点发现" label="节点发现与负载均衡">
        | V1 配置                                            | V2 构建器方法 | 说明 |
        | ------------------------------------------------ | -------- | -- |
        | `ClickHouseClientOption#AUTO_DISCOVERY`          | ✗        |    |
        | `ClickHouseClientOption#LOAD_BALANCING_POLICY`   | ✗        |    |
        | `ClickHouseClientOption#LOAD_BALANCING_TAGS`     | ✗        |    |
        | `ClickHouseClientOption#HEALTH_CHECK_INTERVAL`   | ✗        |    |
        | `ClickHouseClientOption#HEALTH_CHECK_METHOD`     | ✗        |    |
        | `ClickHouseClientOption#NODE_DISCOVERY_INTERVAL` | ✗        |    |
        | `ClickHouseClientOption#NODE_DISCOVERY_LIMIT`    | ✗        |    |
        | `ClickHouseClientOption#NODE_CHECK_INTERVAL`     | ✗        |    |
        | `ClickHouseClientOption#NODE_GROUP_SIZE`         | ✗        |    |
        | `ClickHouseClientOption#CHECK_ALL_NODES`         | ✗        |    |
      </TabItem>

      <TabItem value="其他" label="其他">
        | V1 配置                                                                            | V2 Builder 方法                     | 备注         |
        | -------------------------------------------------------------------------------- | --------------------------------- | ---------- |
        | `ClickHouseDefaults#AUTO_SESSION`                                                | ✗                                 | 会话支持将会重新评估 |
        | `ClickHouseDefaults#BUFFERING`                                                   | ✗                                 |            |
        | `ClickHouseDefaults#MAX_REQUESTS`                                                | ✗                                 |            |
        | `ClickHouseDefaults#ROUNDING_MODE`                                               |                                   |            |
        | `ClickHouseDefaults#SERVER_VERSION`<br />`ClickHouseClientOption#SERVER_VERSION` | `Client.Builder#setServerVersion` |            |
        | `ClickHouseDefaults#SRV_RESOLVE`                                                 | ✗                                 |            |
        | `ClickHouseClientOption#CUSTOM_SETTINGS`                                         |                                   |            |
        | `ClickHouseClientOption#PRODUCT_NAME`                                            | ✗                                 | 使用客户端名称    |
        | `ClickHouseClientOption#RENAME_RESPONSE_COLUMN`                                  | ✗                                 |            |
        | `ClickHouseClientOption#SERVER_REVISION`                                         | ✗                                 |            |
        | `ClickHouseClientOption#TRANSACTION_TIMEOUT`                                     | ✗                                 |            |
        | `ClickHouseClientOption#WIDEN_UNSIGNED_TYPES`                                    | ✗                                 |            |
        | `ClickHouseClientOption#USE_BINARY_STRING`                                       | ✗                                 |            |
        | `ClickHouseClientOption#USE_BLOCKING_QUEUE`                                      | ✗                                 |            |
        | `ClickHouseClientOption#USE_COMPILATION`                                         | ✗                                 |            |
        | `ClickHouseClientOption#USE_OBJECTS_IN_ARRAYS`                                   | ✗                                 |            |
        | `ClickHouseClientOption#MAX_MAPPER_CACHE`                                        | ✗                                 |            |
        | `ClickHouseClientOption#MEASURE_REQUEST_TIME`                                    | ✗                                 |            |
      </TabItem>
    </Tabs>

    ### 通用差异 \{#general-differences\}

    * Client V2 使用更少的自定义类以提高可移植性。例如，V2 可以与任何 `java.io.InputStream` 的实现配合使用，将数据写入服务器。
    * Client V2 的 `async` 配置默认为 `off`。这意味着不会额外创建线程，并让应用程序对客户端拥有更多控制权。对于大多数使用场景，此配置都应保持为 `off`。启用 `async` 会为请求创建一个单独的线程。仅在使用由应用程序控制的 executor 时才有意义（参见 `com.clickhouse.client.api.Client.Builder#setSharedOperationExecutor`）。

    ### 写入数据 \{#writing-data\}

    * 可以使用任何 `java.io.InputStream` 的实现。支持 V1 `com.clickhouse.data.ClickHouseInputStream`，但不推荐使用。
    * 一旦检测到输入流已结束，就会进行相应处理。在此之前，应先关闭该请求的输出流。

    **V1 插入 TSV 格式的数据。**

    ```java
    InputStream inData = getInData();
    ClickHouseRequest.Mutation request = client.read(server)
            .write()
            .table(tableName)
            .format(ClickHouseFormat.TSV);
    ClickHouseConfig config = request.getConfig();
    CompletableFuture<ClickHouseResponse> future;
    try (ClickHousePipedOutputStream requestBody = ClickHouseDataStreamFactory.getInstance()
            .createPipedOutputStream(config)) {
        // start the worker thread which transfer data from the input into ClickHouse
        future = request.data(requestBody.getInputStream()).execute();

        // Copy data from inData stream to requestBody stream

        // We need to close the stream before getting a response
        requestBody.close();

        try (ClickHouseResponse response = future.get()) {
            ClickHouseResponseSummary summary = response.getSummary();
            Assert.assertEquals(summary.getWrittenRows(), numRows, "Num of written rows");
        }
    }

    ```

    **V2 插入 TSV 格式的数据。**

    ```java
    InputStream inData = getInData();
    InsertSettings settings = new InsertSettings().setInputStreamCopyBufferSize(8198 * 2); // set copy buffer size
    try (InsertResponse response = client.insert(tableName, inData, ClickHouseFormat.TSV, settings).get(30, TimeUnit.SECONDS)) {

      // Insert is complete at this point

    } catch (Exception e) {
     // Handle exception
    }
    ```

    * 只需要调用一个方法，无需创建额外的请求对象。
    * 当所有数据复制完成后，请求体数据流会自动关闭。
    * 现已提供新的低级 API：`com.clickhouse.client.api.Client#insert(java.lang.String, java.util.List<java.lang.String>, com.clickhouse.client.api.DataStreamWriter, com.clickhouse.data.ClickHouseFormat, com.clickhouse.client.api.insert.InsertSettings)`。`com.clickhouse.client.api.DataStreamWriter` 专为实现自定义数据写入逻辑而设计，例如从队列中读取数据。

    ### 读取数据 \{#reading-data\}

    * 默认情况下，数据以 `RowBinaryWithNamesAndTypes` 格式读取。目前在需要进行数据绑定时，仅支持此格式。
    * 可以使用 `List<GenericRecord> com.clickhouse.client.api.Client#queryAll(java.lang.String)` 方法将数据读取为一组记录。该方法会将数据读取到内存中并释放连接，无需额外处理。`GenericRecord` 提供对数据的访问能力，并实现了一些类型转换。

    ```java
    Collection<GenericRecord> records = client.queryAll("SELECT * FROM table");
    for (GenericRecord record : records) {
        int rowId = record.getInteger("rowID");
        String name = record.getString("name");
        LocalDateTime ts = record.getLocalDateTime("ts");
    }

    ```
  </Version>

  <Version>
    Java 客户端库,用于通过数据库服务器协议进行通信。当前实现仅支持 [HTTP 接口](/interfaces/http)。该库提供了自有 API 用于向服务器发送请求。

    :::warning 弃用
    此库即将被弃用。新项目请使用最新的 [Java 客户端](/integrations/language-clients/java/client/client.mdx)
    :::

    ## 设置 \{#v1-setup\}

    <Tabs groupId="client-v1-setup">
      <TabItem value="maven" label="Maven">
        ```xml
        <!-- https://mvnrepository.com/artifact/com.clickhouse/clickhouse-http-client -->
        <dependency>
            <groupId>com.clickhouse</groupId>
            <artifactId>clickhouse-http-client</artifactId>
            <version>0.7.2</version>
        </dependency>
        ```
      </TabItem>

      <TabItem value="gradle-kt" label="Gradle（Kotlin）">
        ```kotlin
        // https://mvnrepository.com/artifact/com.clickhouse/clickhouse-http-client
        implementation("com.clickhouse:clickhouse-http-client:0.7.2")
        ```
      </TabItem>

      <TabItem value="gradle" label="Gradle">
        ```groovy
        // https://mvnrepository.com/artifact/com.clickhouse/clickhouse-http-client
        implementation 'com.clickhouse:clickhouse-http-client:0.7.2'
        ```
      </TabItem>
    </Tabs>

    从版本 `0.5.0` 开始,驱动程序使用新的客户端 HTTP 库,需要将其添加为依赖项。

    <Tabs groupId="client-v1-http-client">
      <TabItem value="maven" label="Maven">
        ```xml
        <!-- https://mvnrepository.com/artifact/org.apache.httpcomponents.client5/httpclient5 -->
        <dependency>
            <groupId>org.apache.httpcomponents.client5</groupId>
            <artifactId>httpclient5</artifactId>
            <version>5.3.1</version>
        </dependency>
        ```
      </TabItem>

      <TabItem value="gradle-kt" label="Gradle（Kotlin）">
        ```kotlin
        // https://mvnrepository.com/artifact/org.apache.httpcomponents.client5/httpclient5
        implementation("org.apache.httpcomponents.client5:httpclient5:5.3.1")
        ```
      </TabItem>

      <TabItem value="gradle" label="Gradle">
        ```groovy
        // https://mvnrepository.com/artifact/org.apache.httpcomponents.client5/httpclient5
        implementation 'org.apache.httpcomponents.client5:httpclient5:5.3.1'
        ```
      </TabItem>
    </Tabs>

    ## 初始化 \{#v1-initialization\}

    连接 URL 格式:`protocol://host[:port][/database][?param[=value][&param[=value]][#tag[,tag]]`,示例:

    * `http://localhost:8443?ssl=true&sslmode=NONE`
    * `https://(https://explorer@play.clickhouse.com:443`

    连接到单个节点:

    ```java showLineNumbers
    ClickHouseNode server = ClickHouseNode.of("http://localhost:8123/default?compress=0");
    ```

    连接到具有多个节点的集群:

    ```java showLineNumbers
    ClickHouseNodes servers = ClickHouseNodes.of(
        "jdbc:ch:http://server1.domain,server2.domain,server3.domain/my_db"
        + "?load_balancing_policy=random&health_check_interval=5000&failover=2");
    ```

    ## 查询 API \{#v1-query-api\}

    ```java showLineNumbers
    try (ClickHouseClient client = ClickHouseClient.newInstance(ClickHouseProtocol.HTTP);
         ClickHouseResponse response = client.read(servers)
            .format(ClickHouseFormat.RowBinaryWithNamesAndTypes)
            .query("select * from numbers limit :limit")
            .params(1000)
            .executeAndWait()) {
                ClickHouseResponseSummary summary = response.getSummary();
                long totalRows = summary.getTotalRowsToRead();
    }
    ```

    ## 流式查询 API \{#v1-streaming-query-api\}

    ```java showLineNumbers
    try (ClickHouseClient client = ClickHouseClient.newInstance(ClickHouseProtocol.HTTP);
         ClickHouseResponse response = client.read(servers)
            .format(ClickHouseFormat.RowBinaryWithNamesAndTypes)
            .query("select * from numbers limit :limit")
            .params(1000)
            .executeAndWait()) {
                for (ClickHouseRecord r : response.records()) {
                int num = r.getValue(0).asInteger();
                // type conversion
                String str = r.getValue(0).asString();
                LocalDate date = r.getValue(0).asDate();
            }
    }
    ```

    请参阅[代码仓库](https://github.com/ClickHouse/clickhouse-java/tree/main/examples/client)中的[完整代码示例](https://github.com/ClickHouse/clickhouse-java/blob/main/examples/client/src/main/java/com/clickhouse/examples/jdbc/Main.java#L73)。

    ## 插入 API \{#v1-insert-api\}

    ```java showLineNumbers

    try (ClickHouseClient client = ClickHouseClient.newInstance(ClickHouseProtocol.HTTP);
         ClickHouseResponse response = client.read(servers).write()
            .format(ClickHouseFormat.RowBinaryWithNamesAndTypes)
            .query("insert into my_table select c2, c3 from input('c1 UInt8, c2 String, c3 Int32')")
            .data(myInputStream) // `myInputStream` is source of data in RowBinary format
            .executeAndWait()) {
                ClickHouseResponseSummary summary = response.getSummary();
                summary.getWrittenRows();
    }
    ```

    请参阅[仓库](https://github.com/ClickHouse/clickhouse-java/tree/main/examples/client)中的[完整代码示例](https://github.com/ClickHouse/clickhouse-java/blob/main/examples/client/src/main/java/com/clickhouse/examples/jdbc/Main.java#L39)。

    **RowBinary 编码**

    RowBinary 格式在其[页面](/interfaces/formats/RowBinaryWithNamesAndTypes)中进行了说明。

    以下是一个 [代码示例](https://github.com/ClickHouse/clickhouse-kafka-connect/blob/main/src/main/java/com/clickhouse/kafka/connect/sink/db/ClickHouseWriter.java#L622).

    ## 功能 \{#v1-features\}

    ### 压缩 \{#v1-compression\}

    客户端默认使用 LZ4 压缩,需要以下依赖项:

    <Tabs groupId="client-v1-compression-deps">
      <TabItem value="maven" label="Maven">
        ```xml
        <!-- https://mvnrepository.com/artifact/org.lz4/lz4-java -->
        <dependency>
            <groupId>org.lz4</groupId>
            <artifactId>lz4-java</artifactId>
            <version>1.8.0</version>
        </dependency>
        ```
      </TabItem>

      <TabItem value="gradle-kt" label="Gradle (Kotlin)">
        ```kotlin
        // https://mvnrepository.com/artifact/org.lz4/lz4-java
        implementation("org.lz4:lz4-java:1.8.0")
        ```
      </TabItem>

      <TabItem value="gradle" label="Gradle">
        ```groovy
        // https://mvnrepository.com/artifact/org.lz4/lz4-java
        implementation 'org.lz4:lz4-java:1.8.0'
        ```
      </TabItem>
    </Tabs>

    您可以选择使用 gzip,只需在连接 URL 中设置 `compress_algorithm=gzip` 即可。

    或者,您可以通过以下几种方式禁用压缩。

    1. 通过在连接 URL 中将 `compress` 设置为 `0` 来禁用压缩：`http://localhost:8123/default?compress=0`
    2. 通过客户端配置禁用：

    ```java showLineNumbers
    ClickHouseClient client = ClickHouseClient.builder()
       .config(new ClickHouseConfig(Map.of(ClickHouseClientOption.COMPRESS, false)))
       .nodeSelector(ClickHouseNodeSelector.of(ClickHouseProtocol.HTTP))
       .build();
    ```

    请参阅[压缩文档](/data-compression/compression-modes)了解更多不同的压缩选项。

    ### 多查询 \{#v1-multiple-queries\}

    在同一会话内的工作线程中依次执行多个查询:

    ```java showLineNumbers
    CompletableFuture<List<ClickHouseResponseSummary>> future = ClickHouseClient.send(servers.apply(servers.getNodeSelector()),
        "create database if not exists my_base",
        "use my_base",
        "create table if not exists test_table(s String) engine=Memory",
        "insert into test_table values('1')('2')('3')",
        "select * from test_table limit 1",
        "truncate table test_table",
        "drop table if exists test_table");
    List<ClickHouseResponseSummary> results = future.get();
    ```

    ### 命名参数 \{#v1-named-parameters\}

    您可以按名称传递参数,而不必仅依赖参数在参数列表中的位置。使用 `params` 函数即可实现此功能。

    ```java showLineNumbers
    try (ClickHouseClient client = ClickHouseClient.newInstance(ClickHouseProtocol.HTTP);
         ClickHouseResponse response = client.read(servers)
            .format(ClickHouseFormat.RowBinaryWithNamesAndTypes)
            .query("select * from my_table where name=:name limit :limit")
            .params("Ben", 1000)
            .executeAndWait()) {
                //...
            }
    }
    ```

    :::note 参数
    所有涉及 `String` 类型的 `params` 签名(`String`、`String[]`、`Map<String, String>`)均假定传入的键为有效的 ClickHouse SQL 字符串。例如:

    ```java showLineNumbers
    try (ClickHouseClient client = ClickHouseClient.newInstance(ClickHouseProtocol.HTTP);
         ClickHouseResponse response = client.read(servers)
            .format(ClickHouseFormat.RowBinaryWithNamesAndTypes)
            .query("select * from my_table where name=:name")
            .params(Map.of("name","'Ben'"))
            .executeAndWait()) {
                //...
            }
    }
    ```

    如果您不想手动将 String 对象解析为 ClickHouse SQL,可以使用位于 `com.clickhouse.data` 的辅助函数 `ClickHouseValues.convertToSqlExpression`:

    ```java showLineNumbers
    try (ClickHouseClient client = ClickHouseClient.newInstance(ClickHouseProtocol.HTTP);
         ClickHouseResponse response = client.read(servers)
            .format(ClickHouseFormat.RowBinaryWithNamesAndTypes)
            .query("select * from my_table where name=:name")
            .params(Map.of("name", ClickHouseValues.convertToSqlExpression("Ben's")))
            .executeAndWait()) {
                //...
            }
    }
    ```

    在上述示例中,`ClickHouseValues.convertToSqlExpression` 会转义内部的单引号,并用有效的单引号将变量包围起来。

    其他类型,如 `Integer`、`UUID`、`Array` 和 `Enum`,将在 `params` 中自动转换。
    :::

    ## 节点发现 \{#v1-node-discovery\}

    Java 客户端提供自动发现 ClickHouse 节点的功能。自动发现默认为禁用状态。如需手动启用,请将 `auto_discovery` 设置为 `true`:

    ```java
    properties.setProperty("auto_discovery", "true");
    ```

    或在连接 URL 中:

    ```plaintext
    jdbc:ch://my-server/system?auto_discovery=true
    ```

    启用自动发现后,无需在连接 URL 中指定所有 ClickHouse 节点。URL 中指定的节点将作为种子节点,Java 客户端会自动从系统表和/或 clickhouse-keeper 或 zookeeper 中发现其他节点。

    以下选项用于配置自动发现功能:

    | 属性                              | 默认值     | 描述                                                       |
    | ------------------------------- | ------- | -------------------------------------------------------- |
    | auto&#95;discovery              | `false` | 客户端是否应从 system 表和/或 clickhouse-keeper/zookeeper 中发现更多节点。 |
    | node&#95;discovery&#95;interval | `0`     | 以毫秒为单位的节点发现间隔，值为零或负数表示仅进行一次发现。                           |
    | node&#95;discovery&#95;limit    | `100`   | 单次可发现的最大节点数；设置为零或负值表示不限制。                                |

    ### 负载均衡 \{#v1-load-balancing\}

    Java 客户端根据负载均衡策略选择 ClickHouse 节点来发送请求。通常,负载均衡策略负责以下事项:

    1. 从托管的节点列表中获取一个节点。
    2. 管理节点状态。
    3. （可选）调度一个用于节点发现的后台进程（如果启用了自动发现），并执行健康检查。

    以下是配置负载均衡的选项列表:

    | 属性                            | 默认值                                      | 说明                                                                                                                                                                                                                                                  |
    | ----------------------------- | ---------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
    | load&#95;balancing&#95;policy | `""`                                     | 负载均衡策略可以是以下之一：<li>`firstAlive` - 请求将被发送到受管节点列表中第一个健康节点</li><li>`random` - 请求将被发送到受管节点列表中随机选取的一个节点</li><li>`roundRobin` - 请求将按照轮询方式依次发送到受管节点列表中的每个节点</li><li>实现 `ClickHouseLoadBalancingPolicy` 的全限定类名 - 自定义负载均衡策略</li>如果未指定该策略，请求将被发送到受管节点列表中的第一个节点 |
    | load&#95;balancing&#95;tags   | `""`                                     | 用于筛选节点的负载均衡标签。只有具有指定标签的节点才会接收请求                                                                                                                                                                                                                     |
    | health&#95;check&#95;interval | `0`                                      | 健康检查间隔（毫秒）。值为 0 或负数表示仅执行一次。                                                                                                                                                                                                                         |
    | health&#95;check&#95;method   | `ClickHouseHealthCheckMethod.SELECT_ONE` | 健康检查方法。可以是以下之一： <li>`ClickHouseHealthCheckMethod.SELECT_ONE` - 通过 `select 1` 查询进行检查</li> <li>`ClickHouseHealthCheckMethod.PING` - 基于协议的检查，通常更快</li>                                                                                                 |
    | node&#95;check&#95;interval   | `0`                                      | 以毫秒为单位的节点检查间隔，负数将被视为 0。仅当自上次检查以来已过去指定的时间时，才会检查节点状态。<br />`health_check_interval` 和 `node_check_interval` 的区别在于，`health_check_interval` 选项会调度一个后台任务，对节点列表（全部节点或故障节点）执行状态检查，而 `node_check_interval` 指定的是针对某个特定节点，自上次检查以来需要经过的时间阈值。                    |
    | check&#95;all&#95;nodes       | `false`                                  | 是否对所有节点执行健康检查，或仅对故障节点执行检查。                                                                                                                                                                                                                          |

    ### 故障转移和重试 \{#v1-failover-and-retry\}

    Java 客户端提供配置选项,用于设置故障转移和失败查询的重试行为:

    | 参数                                 | 默认值    | 说明                                                                                                                    |
    | ---------------------------------- | ------ | --------------------------------------------------------------------------------------------------------------------- |
    | 故障切换                               | `0`    | 对单个请求允许执行故障转移的最大次数。值为 0 或负数表示不执行故障转移。发生故障转移时，会根据负载均衡策略将失败的请求发送到其他节点，以从故障中恢复。                                          |
    | retry                              | `0`    | 单个请求允许重试的最大次数。为零或负值时表示不进行重试。仅当 ClickHouse 服务器返回 `NETWORK_ERROR` 错误码时，才会对同一节点重新发送该请求                                   |
    | repeat&#95;on&#95;session&#95;lock | `true` | 当会话被锁定时，是否重复执行直到超时（由 `session_timeout` 或 `connect_timeout` 控制）。如果 ClickHouse 服务器返回 `SESSION_IS_LOCKED` 错误码，则会重试该失败请求。 |

    ### 添加自定义 HTTP 请求头 \{#v1-adding-custom-http-headers\}

    Java 客户端支持 HTTP/S 传输层,可在请求中添加自定义 HTTP 头。
    应使用 custom&#95;http&#95;headers 属性,多个头之间使用 `,` 分隔,键值对使用 `=` 分隔

    ## Java 客户端支持 \{#v1-java-client-support\}

    ```java
    options.put("custom_http_headers", "X-ClickHouse-Quota=test, X-ClickHouse-Test=test");
    ```

    ## JDBC 驱动 \{#v1-jdbc-driver\}

    ```java
    properties.setProperty("custom_http_headers", "X-ClickHouse-Quota=test, X-ClickHouse-Test=test");
    ```
  </Version>
</ClientVersionDropdown>