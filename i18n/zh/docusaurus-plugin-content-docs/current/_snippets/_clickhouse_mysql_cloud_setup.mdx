import mysql_1 from '@site/static/images/_snippets/mysql1.png';
import mysql_2 from '@site/static/images/_snippets/mysql2.png';
import mysql_3 from '@site/static/images/_snippets/mysql3.png';
import mysql_4 from '@site/static/images/_snippets/mysql4.png';
import mysql_5 from '@site/static/images/_snippets/mysql5.png';
import Image from '@theme/IdealImage';
import {VerticalStepper} from "@clickhouse/click-ui/bundled";

<VerticalStepper headerLevel="h4">
  #### 选择 `Connect your app` \{#select-connect-your-app\}

  创建 ClickHouse Cloud 服务之后，在 `Connect your app` 页面中，从下拉菜单选择 MySQL。

  <Image size="lg" img={mysql_1} alt="ClickHouse Cloud 凭证页面，显示 MySQL 接口选择下拉框" border />

  #### 启用 MySQL 接口 \{#enable-mysql-interface\}

  切换开关以为该特定服务启用 MySQL 接口。
  这将为该服务开放端口 `3306`，并显示一个 MySQL 连接页面，其中包含您专属的 MySQL 用户名。

  <Image size="lg" img={mysql_2} alt="ClickHouse Cloud 中启用 MySQL 接口的开关和连接详细信息" border />

  或者，如需为现有服务启用 MySQL 接口：

  #### 选择 `Connect` \{#select-connect\}

  确保您的服务处于 `Running` 状态，然后点击要为其启用 MySQL 接口的服务。
  从左侧菜单中选择 &quot;Connect&quot;：

  <Image size="lg" img={mysql_3} alt="ClickHouse Cloud 服务连接页面，其中 Connect 选项被高亮显示" border />

  #### 选择 `MySQL` \{#choose-mysql\}

  在 `Connect With` 下拉菜单中选择 `MySQL`。

  <Image size="md" img={mysql_4} alt="ClickHouse Cloud 连接页面，显示选择 MySQL 选项" border />

  #### 启用 MySQL 接口 \{#enable-mysql-interface\}

  切换开关以为该特定服务启用 MySQL 接口。
  这将为该服务开放端口 `3306`，并显示 MySQL 连接页面，其中包含您专属的 MySQL 用户名。
</VerticalStepper>

<Image size="md" img={mysql_5} alt="ClickHouse Cloud 连接页面中已启用 MySQL 接口并显示连接详细信息" border />

## 在 ClickHouse Cloud 中创建只读 MySQL 用户 \{#creating-multiple-mysql-users-in-clickhouse-cloud\}

ClickHouse Cloud 会自动创建一个 `mysql4<subdomain>` 用户，该用户与默认用户共享相同的密码。
`<subdomain>` 部分对应于你 ClickHouse Cloud 主机名的第一段。

这种用户名格式是为了兼容某些工具而必需的，这类工具会建立安全连接，但在其 TLS 握手中不包含 [SNI (Server Name Indication)](https://www.cloudflare.com/learning/ssl/what-is-sni) 数据。
在缺少 SNI 信息的情况下，系统无法执行正确的内部路由，因此嵌入在用户名中的子域名提示提供了所需的路由信息。
MySQL 控制台客户端就是此类工具的一个示例。

:::tip
推荐的最佳实践是创建一个新的只读 MySQL 用户。
:::

:::note
对于像 `foobar.us-east1.aws.clickhouse.cloud` 这样的 ClickHouse Cloud 主机名，`<subdomain>` 部分等于 `foobar`，自定义 MySQL 用户名可以类似于 `mysql4foobar_team1`。
:::

<VerticalStepper headerLevel="h4">
  #### 创建只读设置配置文件 \{#create-a-custom-settings-user\}

  创建一个要应用到只读用户的[设置配置文件](/sql-reference/statements/create/settings-profile)，
  将 `readonly` 设置为 `1`：

  ```sql
  CREATE SETTINGS PROFILE readonly_profile SETTINGS readonly = 1
  ```

  #### 创建新的只读 MySQL 用户 \{#create-a-readonly-mysql-user\}

  [创建一个用户](/sql-reference/statements/create/user)，并使用如下格式的名称：

  ```sql
  mysql4<subdomain>_<username>
  ```

  将 `readonly_profile` 应用到新用户上，并确保密码使用 double SHA1 格式。例如：

  ```sql
  CREATE USER mysql4foobar_readonly
  IDENTIFIED WITH double_sha1_password BY 'YourPassword42$'
  SETTINGS PROFILE 'readonly_profile';
  ```

  #### 授予新用户访问目标表的权限 \{#grant-the-new-user-the-necessary-permissions\}

  [授予](/sql-reference/statements/grant) 新用户与目标表或数据库交互所需的权限。
  例如，如果你只想授予对 `system.query_log` 的访问权限：

  ```sql
  GRANT SELECT ON system.query_log TO mysql4foobar_readonly;
  ```

  :::note
  对于只读用户，请确保只对你希望访问的表授予 `SELECT` 权限。
  :::

  新创建的用户可以通过 MySQL 接口连接到你的 ClickHouse Cloud 服务。
</VerticalStepper>

### 在 ClickHouse Cloud 中排查多个 MySQL 用户相关问题 \{#troubleshooting-multiple-mysql-users-in-clickhouse-cloud\}

如果您创建了一个新的 MySQL 用户，并且在通过 MySQL CLI 客户端进行连接时看到如下错误：

```
错误 2013 (HY000): 在"读取授权数据包"时与 MySQL 服务器失去连接,系统错误:54
```

在这种情况下，请确保用户名符合 `mysql4<subdomain>_<username>` 格式，具体说明见（[上文](#creating-multiple-mysql-users-in-clickhouse-cloud)）。
