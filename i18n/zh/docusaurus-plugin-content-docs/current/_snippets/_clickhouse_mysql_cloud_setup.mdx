import mysql_1 from '@site/static/images/_snippets/mysql1.png';
import mysql_2 from '@site/static/images/_snippets/mysql2.png';
import mysql_3 from '@site/static/images/_snippets/mysql3.png';
import mysql_4 from '@site/static/images/_snippets/mysql4.png';
import mysql_5 from '@site/static/images/_snippets/mysql5.png';
import Image from '@theme/IdealImage';
import {VerticalStepper} from "@clickhouse/click-ui/bundled";

<VerticalStepper headerLevel="h4">

#### 选择 `连接您的应用` {#select-connect-your-app}

在创建您的 ClickHouse Cloud 服务后，在 `连接您的应用` 屏幕上，从下拉菜单中选择 MySQL。

<Image size="lg" img={mysql_1} alt="ClickHouse Cloud 凭据屏幕显示 MySQL 接口选择下拉菜单" border />

#### 启用 MySQL 接口 {#enable-mysql-interface}

切换开关以启用此特定服务的 MySQL 接口。
这将为该服务暴露端口 `3306`，并提示您输入包含您唯一 MySQL 用户名的 MySQL 连接屏幕。

<Image size="lg" img={mysql_2} alt="ClickHouse Cloud MySQL 接口启用开关和连接详细信息" border />

另外，为了为现有服务启用 MySQL 接口：

#### 选择 `连接` {#select-connect}

确保您的服务处于 `运行` 状态，然后点击您想启用 MySQL 接口的服务。
从左侧菜单中选择 "连接"：

<Image size="lg" img={mysql_3} alt="ClickHouse Cloud 服务连接屏幕，突出显示连接选项" border />

#### 选择 `MySQL` {#choose-mysql}

从 `连接方式` 下拉菜单中选择 `MySQL`。

<Image size="md" img={mysql_4} alt="ClickHouse Cloud 连接屏幕显示 MySQL 选项选择" border />

#### 启用 MySQL 接口 {#enable-mysql-interface}

切换开关以启用此特定服务的 MySQL 接口。
这将为该服务暴露端口 `3306`，并提示您输入包含您唯一 MySQL 用户名的 MySQL 连接屏幕。

</VerticalStepper>

<Image size="md" img={mysql_5} alt="ClickHouse Cloud 连接屏幕，MySQL 接口启用，显示连接详细信息" border />

## 在 ClickHouse Cloud 中创建只读 MySQL 用户 {#creating-multiple-mysql-users-in-clickhouse-cloud}

ClickHouse Cloud 自动创建一个 `mysql4<subdomain>` 用户，该用户与默认用户共享相同的密码。
`<subdomain>` 部分对应于您 ClickHouse Cloud 主机名的第一部分。

这种用户名格式对于兼容那些建立安全连接但在 TLS 握手中未包含 [SNI (服务器名称指示)](https://www.cloudflare.com/learning/ssl/what-is-sni) 数据的工具是必需的。
没有 SNI 信息，系统无法执行正确的内部路由，因此嵌入在用户名中的子域提示提供了必要的路由信息。
MySQL 控制台客户端就是一个需要此信息的工具的例子。

:::tip
推荐的最佳实践是创建一个新的只读 MySQL 用户。
:::

:::note
对于像 `foobar.us-east1.aws.clickhouse.cloud` 的 ClickHouse Cloud 主机名，`<subdomain>` 部分等于 `foobar`，那么自定义 MySQL 用户名可以是 `mysql4foobar_team1`。
:::

<VerticalStepper headerLevel="h4">

#### 创建只读设置配置文件 {#create-a-custom-settings-user}

创建一个 [设置配置文件](/sql-reference/statements/create/settings-profile) 以应用于您的只读用户，将 `readonly` 设置为 `1`：

```sql
CREATE SETTINGS PROFILE readonly_profile SETTINGS readonly = 1
```

#### 创建一个新的只读 MySQL 用户 {#create-a-readonly-mysql-user}

[创建用户](/sql-reference/statements/create/user)，使用以下格式命名：

```sql
mysql4<subdomain>_<username>
```

将 `readonly_profile` 应用到新用户，并确保密码采用双重 SHA1 格式。例如：

```sql
CREATE USER mysql4foobar_readonly
IDENTIFIED WITH double_sha1_password BY 'YourPassword42$'
SETTINGS PROFILE 'readonly_profile';
```

#### 授予新用户访问所需表的权限 {#grant-the-new-user-the-necessary-permissions}

[授予](/sql-reference/statements/grant) 新用户与所需表或数据库进行交互的必要权限。
例如，如果您只想授予对 `system.query_log` 的访问权限：

```sql
GRANT SELECT ON system.query_log TO mysql4foobar_readonly;
```

:::note
对于只读用户，确保只授予所需访问表的 `SELECT` 权限。
:::

新创建的用户可以使用 MySQL 接口连接到您的 ClickHouse Cloud 服务。

</VerticalStepper>

### 在 ClickHouse Cloud 中故障排除多个 MySQL 用户 {#troubleshooting-multiple-mysql-users-in-clickhouse-cloud}

如果您创建了一个新的 MySQL 用户，并且在通过 MySQL CLI 客户端连接时看到以下错误：

```
ERROR 2013 (HY000): Lost connection to MySQL server at 'reading authorization packet', system error: 54
```

在这种情况下，请确保用户名遵循 `mysql4<subdomain>_<username>` 格式，如上所述 ([上文](#creating-multiple-mysql-users-in-clickhouse-cloud))。
