---
slug: /managing-data/materialized-views-versus-projections
sidebar_label: '物化视图 vs 投影'
title: '物化视图与投影'
hide_title: false
description: '本文比较 ClickHouse 中的物化视图与投影，包括它们的使用场景、性能以及局限性。'
doc_type: 'reference'
keywords: ['物化视图', '投影', '差异']
---

> 用户经常会问：在什么情况下应该使用物化视图，而不是投影？在本文中，我们将探讨二者之间的关键差异，以及在某些场景下为何更适合选择其中一种而非另一种。



## 关键差异总结 {#key-differences}

下表总结了在各个考量维度上，物化视图与投影之间的主要差异。

| 方面                                                                            | 物化视图                                                                                                                                                                                                                                                                                                                                                                  | 投影                                                                                                                                                                                                                                                                                                   |
|---------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 数据存储与位置                                                                  | 将结果存储在一个**单独、显式的目标表**中，在向源表插入数据时充当插入触发器。                                                                                                                                                                                                                                                                                                | 投影会创建经过优化的数据布局，这些数据在物理上**与主表数据一同存储**，并且对用户不可见。                                                                                                                                                                                                                |
| 更新机制                                                                        | 在对源表执行 `INSERT` 时（对于增量物化视图）**同步**运行。注意：也可以通过可刷新的物化视图将其设置为**按计划调度**。                                                                                                                                                                                                                  | 在对主表执行 `INSERT` 后，于后台**异步**更新。                                                                                                                                                                                                                                                          |
| 查询交互                                                                        | 使用物化视图时，需要**直接查询目标表**，这意味着用户在编写查询时需要了解物化视图的存在。                                                                                                                                                                                                                                            | 投影会由 ClickHouse 的查询优化器**自动选择**，对用户是透明的，用户无需为了使用投影而修改针对包含投影的表的查询。从 25.6 版本开始，也可以按照多个投影进行过滤。                                                                                                                                            |
| 处理 `UPDATE` / `DELETE`                                                        | 对源表上的 `UPDATE` 或 `DELETE` 操作**不会自动响应**，因为物化视图不了解源表，仅充当源表的插入触发器。这可能导致源表与目标表之间的数据陈旧，需要通过变通方案或定期全量刷新（通过可刷新物化视图）来解决。                                                                                                                          | 默认情况下，与被标记为 **`DELETED` 的行不兼容**（尤其是轻量级删除）。可以通过启用 `lightweight_mutation_projection_mode`（v24.7+）来实现兼容性。                                                                                                              |
| `JOIN` 支持                                                                     | 支持。可刷新物化视图可用于复杂的反规范化场景。增量物化视图仅在最左侧表插入时触发。                                                                                                                                                                                                                                                 | 不支持。投影定义中不支持 `JOIN` 操作来过滤物化后的数据。                                                                                                                                                                                                        |
| 定义中的 `WHERE` 子句                                                           | 支持。可以在定义中包含 `WHERE` 子句，以在物化前过滤数据。                                                                                                                                                                                                                                                                           | 不支持。投影定义中不支持使用 `WHERE` 子句来过滤物化数据。                                                                                                                                                                                                       |
| 串联能力                                                                        | 支持。一个物化视图的目标表可以作为另一个物化视图的源表，从而实现多阶段流水线。                                                                                                                                                                                                                                                     | 不支持。投影不能被串联使用。                                                                                                                                                                                                                                    |
| 适用的表引擎                                                                    | 可以与多种源表引擎配合使用，但目标表通常使用 `MergeTree` 系列表引擎。                                                                                                                                                                                                                                                               | **仅适用于** `MergeTree` 系列表引擎。                                                                                                                                                                                                                           |
| 失败处理                                                                        | 在插入数据期间发生失败时，目标表中的数据会丢失，从而可能导致不一致。                                                                                                                                                                                                                                                               | 失败会在后台被**静默**处理。查询可以无缝混合使用已物化和未物化的数据片段。                                                                                                                                                                                      |
| 运维开销                                                                        | 需要显式创建目标表，并且通常需要手动回填数据。使用 `UPDATE`/`DELETE` 维持一致性会增加复杂度。                                                                                                                                                                                                                                      | 投影会自动维护并保持同步，通常具有更低的运维负担。                                                                                                                                                                                                              |
| `FINAL` 查询兼容性                                                              | 一般兼容，但通常需要在目标表上使用 `GROUP BY`。                                                                                                                                                                                                                                                                                     | 与 `FINAL` 查询**不兼容**。                                                                                                                                                                                                                                     |
| 惰性物化                                                                        | 支持。                                                                                                                                                                                                                                                                                                                              | 使用惰性物化特性时，需要监控投影兼容性问题。你可能需要设置 `query_plan_optimize_lazy_materialization = false`。                                                                                                                                                 |
| 并行副本                                                                        | 支持。                                                                                                                                                                                                                                                                                                                              | 不支持。                                                                                                                                                                                                                                                                                               |
| [`optimize_read_in_order`](/operations/settings/settings#optimize_read_in_order) | 支持。                                                                                                                                                                                                                                                                                                                              | 支持。                                                                                                                                                                                                                                                                                                 |
| 轻量级更新与删除                                                                | 支持。                                                                                                                                                                                                                                                                                                                              | 不支持。                                                                                                                                                                                                                                                                                               |



## 比较物化视图和投影 {#choose-between}

### 何时选择物化视图 {#choosing-materialized-views}

在以下情况下，你应考虑使用物化视图：

- 处理 **实时 ETL 和多阶段数据管道**：你需要在数据到达时执行复杂转换、聚合或路由，并可能通过链式视图跨多个阶段处理数据。
- 需要 **复杂反规范化**：你需要将来自多个来源（表、子查询或字典）的数据预先关联到一个单一、针对查询优化的表中，尤其是在可以接受使用可刷新的物化视图进行周期性全量刷新的情况下。
- 希望 **显式控制模式（schema）**：你需要一个独立的目标表，用其自身的 schema 和引擎来存储预计算结果，为数据建模提供更大的灵活性。
- 希望在 **摄取阶段进行过滤**：你需要在数据被物化之前进行过滤，从而减少写入目标表的数据量。

### 何时避免使用物化视图 {#avoid-materialized-views}

在以下情况下，你应考虑避免使用物化视图：

- **源数据经常被更新或删除**：如果没有额外策略来处理源表和目标表之间的一致性，增量物化视图可能会变得陈旧且不一致。
- **更偏好简单性和自动优化**：例如你希望避免管理单独的目标表。

### 何时选择投影 {#choosing-projections}

在以下情况下，你应考虑使用投影：

- **优化单表查询**：你的主要目标是通过提供备用排序顺序、优化对非主键列的过滤，或为单个表预计算聚合结果，以加速对单个基础表的查询。
- 需要 **查询透明性**：你希望查询直接针对原始表而无需修改，并依赖 ClickHouse 为给定查询选择最优的数据布局。

### 何时避免使用投影 {#avoid-projections}

在以下情况下，你应考虑避免使用投影：

- **需要复杂数据转换或多阶段 ETL**：投影在其定义中不支持 `JOIN` 操作，无法调整为构建多步管道，并且无法处理某些 SQL 特性，如窗口函数或复杂的 `CASE` 表达式。因此，它们不适合复杂数据转换。
- **需要对物化数据进行显式过滤**：投影在其定义中不支持 `WHERE` 子句来过滤要物化到投影本身的数据。
- **使用非 MergeTree 表引擎**：投影仅适用于使用 `MergeTree` 系列表引擎的表。
- **必须依赖 `FINAL` 查询**：投影无法与 `FINAL` 查询配合使用，而后者有时用于去重。
- 你需要使用 [parallel replicas](/deployment-guides/parallel-replicas)，而这在投影中不受支持。



## 总结 {#summary}

物化视图和投影都是用于优化查询和转换数据的强大工具。总体来说，我们不建议将它们视为非此即彼的选择。相反，可以将它们以互补的方式一起使用，从而最大化查询性能。因此，在 ClickHouse 中选择物化视图还是投影，实际上取决于具体的使用场景和访问模式。

一般来说，当需要将一个或多个源表中的数据聚合到一个目标表中，或在大规模上执行复杂转换时，应考虑使用物化视图。物化视图非常适合将开销昂贵的聚合工作从查询时转移到写入时。它们非常适用于按日或按月的汇总、实时仪表盘或数据摘要。

另一方面，当需要优化那些在与表主键（主键决定了磁盘上数据的物理排序）不同的列上进行过滤的查询时，应使用投影。当无法再更改表的主键，或者访问模式比主键所能支持的更加多样化时，投影尤其有用。
