---
slug: /managing-data/materialized-views-versus-projections
sidebar_label: '物化视图与投影'
title: '物化视图与投影'
hide_title: false
description: '本文比较 ClickHouse 中的物化视图和投影，包括它们的使用场景、性能和局限性。'
doc_type: 'reference'
keywords: ['materialized views', 'projections', 'differences']
---

> 用户常问：什么时候应该使用物化视图，什么时候应该使用投影？在本文中，我们将探讨二者之间的关键差异，以及在某些场景下为什么可能更适合选择其中之一。



## 主要差异总结 {#key-differences}

下表总结了物化视图和投影在各个考量方面的主要差异。

| 方面                                                                           | 物化视图                                                                                                                                                                                                                                                                                                                                                                        | 投影                                                                                                                                                                                                                                                                                                            |
| -------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 数据存储和位置                                                        | 将结果存储在**独立的显式目标表**中,在向源表插入数据时充当插入触发器。                                                                                                                                                                                                                                                     | 投影创建优化的数据布局,这些布局在物理上**与主表数据一起存储**,对用户不可见。                                                                                                                                                                  |
| 更新机制                                                                 | 在向源表执行 `INSERT` 时**同步**操作(针对增量物化视图)。注意:也可以使用可刷新物化视图进行**调度**。                                                                                                                                                                                                | 在向主表执行 `INSERT` 时在后台进行**异步**更新。                                                                                                                                                                                                                            |
| 查询交互                                                                | 使用物化视图需要**直接查询目标表**,这意味着用户在编写查询时需要知道物化视图的存在。                                                                                                                                                                                         | 投影由 ClickHouse 的查询优化器**自动选择**,对用户透明,用户无需修改对带有投影的表的查询即可使用它。从 25.6 版本开始,还可以按多个投影进行过滤。 |
| 处理 `UPDATE` / `DELETE`                                                     | **不会自动响应**源表上的 `UPDATE` 或 `DELETE` 操作,因为物化视图不了解源表,仅充当_对_源表的插入触发器。这可能导致源表和目标表之间的数据陈旧,需要变通方法或定期完全刷新(通过可刷新物化视图)。 | 默认情况下,**与 `DELETED` 行不兼容**(尤其是轻量级删除)。`lightweight_mutation_projection_mode`(v24.7+)可以启用兼容性。                                                                                                                                       |
| `JOIN` 支持                                                                   | 支持。可刷新物化视图可用于复杂的反规范化。增量物化视图仅在最左侧表插入时触发。                                                                                                                                                                                                                      | 不支持。投影定义中不支持使用 `JOIN` 操作来过滤物化数据。                                                                                                                                                                                             |
| 定义中的 `WHERE` 子句                                                     | 支持。可以包含 `WHERE` 子句在物化之前过滤数据。                                                                                                                                                                                                                                                               | 不支持。投影定义中不支持使用 `WHERE` 子句来过滤物化数据。                                                                                                                                                                                               |
| 链式能力                                                            | 支持,一个物化视图的目标表可以作为另一个物化视图的源,从而实现多阶段管道。                                                                                                                                                                                                           | 不支持。投影不能链式连接。                                                                                                                                                                                                                                                                     |
| 适用的表引擎                                                         | 可以与各种源表引擎一起使用,但目标表通常属于 `MergeTree` 系列。                                                                                                                                                                                                   | **仅适用于** `MergeTree` 系列表引擎。                                                                                                                                                                                                                                               |
| 故障处理                                                                 | 数据插入期间的故障意味着目标表中的数据丢失,导致潜在的不一致性。                                                                                                                                                                                            | 故障在后台**静默**处理。查询可以无缝混合物化和未物化的部分。                                                                                                                                                                                 |
| 运维开销                                                             | 需要显式创建目标表,通常需要手动回填。管理与 `UPDATE`/`DELETE` 的一致性会增加复杂性。                                                                                                                                                                                                   | 投影自动维护并保持同步,通常具有较低的运维负担。                                                                                                                                                                                               |
| `FINAL` 查询兼容性                                                      | 通常兼容,但通常需要在目标表上使用 `GROUP BY`。                                                                                                                                                                                                                                   | **不支持** `FINAL` 查询。                                                                                                                                                                                                                                                                  |
| 延迟物化                                                             | 支持。                                                                                                                                                                                                                                                                                                      | 使用物化功能时需监控投影兼容性问题。您可能需要设置 `query_plan_optimize_lazy_materialization = false`                                                                                                                                                |
| 并行副本                                                                | 支持。                                                                                                                                                                                                                                                                                                      | 不支持。                                                                                                                                                                                                                                                                                                    |
| [`optimize_read_in_order`](/operations/settings/settings#optimize_read_in_order) | 支持。                                                                                                                                                                                                                                                                                                      | 支持。                                                                                                                                                                                                                                                                                                   |
| 轻量级更新和删除                                                  | 支持。                                                                                                                                                                                                                                                                                                      | 不支持。                                                                                                                                                                                                                                                                                                    |


## 物化视图与投影的比较 {#choose-between}

### 何时选择物化视图 {#choosing-materialized-views}

在以下情况下应考虑使用物化视图:

- 处理**实时 ETL 和多阶段数据管道:**需要在数据到达时执行复杂的转换、聚合或路由操作,可能通过链式视图跨越多个阶段。
- 需要**复杂的反规范化**:需要将来自多个源(表、子查询或字典)的数据预先连接到单个查询优化表中,特别是在可以接受使用可刷新物化视图进行定期完全刷新的情况下。
- 需要**显式模式控制**:需要为预计算结果创建一个独立的目标表,具有自己的模式和引擎,为数据建模提供更大的灵活性。
- 需要**在摄取时过滤**:需要在数据物化_之前_进行过滤,减少写入目标表的数据量。

### 何时避免使用物化视图 {#avoid-materialized-views}

在以下情况下应考虑避免使用物化视图:

- **源数据频繁更新或删除**:如果没有额外的策略来处理源表和目标表之间的一致性,增量物化视图可能会变得过时和不一致。
- **偏好简单性和自动优化**:如果希望避免管理独立的目标表。

### 何时选择投影 {#choosing-projections}

在以下情况下应考虑使用投影:

- **优化单表查询**:主要目标是通过提供替代排序顺序、优化非主键列的过滤器或预计算单表聚合来加速单个基表的查询。
- 需要**查询透明性**:希望查询无需修改即可针对原始表执行,依靠 ClickHouse 为给定查询选择最佳数据布局。

### 何时避免使用投影 {#avoid-projections}

在以下情况下应考虑避免使用投影:

- **需要复杂的数据转换或多阶段 ETL**:投影在其定义中不支持 `JOIN` 操作,无法更改以构建多步骤管道,也无法处理某些 SQL 功能,如窗口函数或复杂的 `CASE` 语句。因此它们不适合复杂的数据转换。
- **需要对物化数据进行显式过滤**:投影在其定义中不支持 `WHERE` 子句来过滤物化到投影本身的数据。
- **使用非 MergeTree 表引擎**:投影仅适用于使用 `MergeTree` 系列引擎的表。
- `FINAL` 查询至关重要:投影不支持 `FINAL` 查询,而后者有时用于去重。
- 需要[并行副本](/deployment-guides/parallel-replicas),因为投影不支持该功能。


## 总结 {#summary}

物化视图和投影都是您工具箱中用于优化查询和转换数据的强大工具。通常情况下,我们建议不要将使用它们视为非此即彼的选择。相反,它们可以互补使用,以充分发挥查询的最大效能。因此,在 ClickHouse 中选择物化视图还是投影,实际上取决于您的具体使用场景和访问模式。

一般来说,当您需要将一个或多个源表的数据聚合到目标表中,或需要大规模执行复杂转换时,应考虑使用物化视图。物化视图非常适合将高成本的聚合操作从查询时转移到插入时执行。对于日常或月度汇总、实时仪表板或数据摘要等场景,物化视图是理想的选择。

另一方面,当您需要优化基于不同列进行过滤的查询时,应使用投影——这些列不同于表主键所使用的列,而主键决定了数据在磁盘上的物理排序。当无法再更改表的主键,或者当您的访问模式比主键所能支持的更加多样化时,投影尤其有用。
