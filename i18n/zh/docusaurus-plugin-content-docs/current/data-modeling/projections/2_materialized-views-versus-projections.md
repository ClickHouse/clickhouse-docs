---
slug: /managing-data/materialized-views-versus-projections
sidebar_label: '物化视图 vs 投影'
title: '物化视图与投影'
hide_title: false
description: '本文比较 ClickHouse 中的物化视图和投影，包括它们的使用场景、性能和局限性。'
doc_type: 'reference'
keywords: ['materialized views', 'projections', 'differences']
---

> 用户经常会问，在什么情况下应该使用物化视图，什么时候又应该使用投影。本文将探讨二者之间的关键差异，以及在某些场景下为什么可能更适合选择其中一种方案。



## 关键差异概览 {#key-differences}

下表从多个角度对物化视图与投影之间的关键差异进行了总结。

| 方面                                                                           | 物化视图                                                                                                                                                                                                                                                                                                                                                     | 投影                                                                                                                                                                                                                                                                                                  |
| -------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 数据存储与位置                                                        | 将结果存储在一个**单独且显式的目标表**中，并在对源表执行插入操作时充当插入触发器。                                                                                                                                                                                                                                                       | 投影会创建经过优化的数据布局，这些数据在物理上**与主表数据一同存储**，对用户不可见。                                                                                                                                                                                                                  |
| 更新机制                                                                 | 在对源表执行 `INSERT` 时**同步**执行（针对增量物化视图）。注意：也可以通过可刷新的物化视图实现**定期调度刷新**。                                                                                                                                                                                                                             | 在对主表执行 `INSERT` 时，在后台进行**异步**更新。                                                                                                                                                                                                                                                     |
| 查询交互                                                                | 使用物化视图时需要**直接查询目标表**，也就是说，用户在编写查询时必须意识到物化视图的存在。                                                                                                                                                                                                                                                   | 投影会被 ClickHouse 查询优化器**自动选择**，在使用上是透明的：用户无需为利用投影而修改查询来显式访问包含投影的表。从 25.6 版本起，还可以基于多个投影进行筛选。                                                                                                                                |
| 处理 `UPDATE` / `DELETE`                                                     | 对源表上的 `UPDATE` 或 `DELETE` 操作**不会自动响应**，因为物化视图并不了解源表，只在向源表插入数据时充当插入触发器。这可能导致源表与目标表之间产生数据陈旧和不一致，需要通过变通方案或周期性全量刷新（通过可刷新的物化视图）来解决。                                                                                                                       | 默认情况下，与**被标记为 `DELETED` 的行**（尤其是轻量级删除）**不兼容**。可以通过启用 `lightweight_mutation_projection_mode`（v24.7+）来实现兼容。                                                                                                                                                |
| `JOIN` 支持                                                                   | 支持。可刷新的物化视图可用于复杂的反规范化。增量物化视图仅在最左侧表发生插入时触发。                                                                                                                                                                                                                                                       | 不支持。在投影定义中不支持使用 `JOIN` 操作来过滤物化后的数据。                                                                                                                                                                                                 |
| 定义中的 `WHERE` 子句                                                     | 支持。可以在定义中使用 `WHERE` 子句，在物化之前先对数据进行过滤。                                                                                                                                                                                                                                                                       | 不支持。在投影定义中不能使用 `WHERE` 子句来过滤物化后的数据。                                                                                                                                                                                                 |
| 链式能力                                                            | 支持，一个物化视图的目标表可以作为另一个物化视图的源表，从而实现多阶段处理流水线。                                                                                                                                                                                                                                                         | 不支持。投影不能进行链式串联。                                                                                                                                                                                                                                                                        |
| 适用的表引擎                                                         | 可以与多种源表引擎配合使用，但目标表通常使用 `MergeTree` 系列表引擎。                                                                                                                                                                                                                                                                 | **仅适用于** `MergeTree` 系列表引擎。                                                                                                                                                                                                                           |
| 故障处理                                                                 | 在数据插入过程中发生故障时，目标表中的数据会丢失，从而可能导致不一致。                                                                                                                                                                                                                                                                | 故障会在后台被**静默**处理。查询可以无缝地混合使用已物化和未物化的部分。                                                                                                                                                                                                 |
| 运维开销                                                             | 需要显式创建目标表，并且通常还需要手动回填历史数据。为了在 `UPDATE`/`DELETE` 操作下保持一致性，会增加额外的复杂度。                                                                                                                                                                                                                           | 投影由系统自动维护并保持同步，通常具有更低的运维负担。                                                                                                                                                                                                                                                |
| `FINAL` 查询兼容性                                                      | 通常是兼容的，但往往需要在目标表上使用 `GROUP BY`。                                                                                                                                                                                                                                                                                  | **不支持**与 `FINAL` 查询配合使用。                                                                                                                                                                                                                                                                    |
| 延迟物化                                                             | 支持。                                                                                                                                                                                                                                                                                                                                                                    | 在使用物化相关功能时，需要监控投影的兼容性问题。可能需要将 `query_plan_optimize_lazy_materialization` 设置为 `false`。                                                                                                                                                                              |
| 并行副本                                                                | 支持。                                                                                                                                                                                                                                                                                                                                                                    | 不支持。                                                                                                                                                                                                                                                                                               |
| [`optimize_read_in_order`](/operations/settings/settings#optimize_read_in_order) | 支持。                                                                                                                                                                                                                                                                                                                                                                    | 支持。                                                                                                                                                                                                                                                                                                 |
| 轻量级更新与删除                                                  | 支持。                                                                                                                                                                                                                                                                                                                                                                    | 不支持。                                                                                                                                                                                                                                                                                               |


## 物化视图与投影的比较 {#choose-between}

### 何时选择物化视图 {#choosing-materialized-views}

在以下情况下应考虑使用物化视图:

- 处理**实时 ETL 和多阶段数据管道:**需要在数据到达时执行复杂的转换、聚合或路由操作,可以通过链式视图跨越多个阶段。
- 需要**复杂的反规范化**:需要将来自多个数据源(表、子查询或字典)的数据预先连接到单个查询优化表中,特别是在可以接受使用可刷新物化视图进行定期完全刷新的情况下。
- 需要**显式模式控制**:需要为预计算结果创建一个独立的目标表,具有自己的模式和引擎,为数据建模提供更大的灵活性。
- 需要**在摄取时过滤**:需要在数据物化_之前_进行过滤,以减少写入目标表的数据量。

### 何时避免使用物化视图 {#avoid-materialized-views}

在以下情况下应考虑避免使用物化视图:

- **源数据频繁更新或删除**:如果没有额外的策略来处理源表和目标表之间的一致性,增量物化视图可能会变得过时且不一致。
- **偏好简单性和自动优化**:如果希望避免管理独立的目标表。

### 何时选择投影 {#choosing-projections}

在以下情况下应考虑使用投影:

- **优化单表查询**:主要目标是通过提供替代排序顺序、优化非主键列的过滤或预计算单表聚合来加速单个基表的查询。
- 需要**查询透明性**:希望查询无需修改即可针对原始表执行,依靠 ClickHouse 为给定查询选择最佳数据布局。

### 何时避免使用投影 {#avoid-projections}

在以下情况下应考虑避免使用投影:

- **需要复杂的数据转换或多阶段 ETL**:投影在其定义中不支持 `JOIN` 操作,无法更改以构建多步骤管道,也无法处理某些 SQL 功能,如窗口函数或复杂的 `CASE` 语句。因此它们不适合复杂的数据转换。
- **需要对物化数据进行显式过滤**:投影在其定义中不支持 `WHERE` 子句来过滤物化到投影本身的数据。
- **使用非 MergeTree 表引擎**:投影仅适用于使用 `MergeTree` 系列引擎的表。
- `FINAL` 查询至关重要:投影不支持 `FINAL` 查询,而 `FINAL` 查询有时用于去重。
- 需要[并行副本](/deployment-guides/parallel-replicas),因为投影不支持并行副本。


## 总结 {#summary}

物化视图和投影都是您工具箱中用于优化查询和转换数据的强大工具。通常情况下,我们建议不要将它们视为非此即彼的选择,而是以互补的方式配合使用,以充分发挥查询的最大效能。因此,在 ClickHouse 中选择物化视图还是投影,实际上取决于您的具体使用场景和访问模式。

一般来说,当您需要将一个或多个源表的数据聚合到目标表中,或需要大规模执行复杂转换时,应考虑使用物化视图。物化视图非常适合将高成本的聚合操作从查询时转移到插入时执行。对于日常或月度汇总、实时仪表板或数据摘要等场景,物化视图是理想的选择。

另一方面,当您需要优化基于不同列进行过滤的查询时,应使用投影——这些列不同于表主键所使用的列(主键决定了数据在磁盘上的物理排序)。当无法再更改表的主键,或者访问模式比主键所能支持的更加多样化时,投影尤其有用。
