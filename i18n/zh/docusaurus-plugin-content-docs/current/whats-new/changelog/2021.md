---
slug: /whats-new/changelog/2021
sidebar_position: 6
sidebar_label: "2021"
title: "2021 更新日志"
description: "2021 年更新日志"
doc_type: "changelog"
keywords:
  [
    "ClickHouse 2021",
    "changelog 2021",
    "发布说明",
    "版本历史",
    "新功能"
  ]
---

### ClickHouse 版本 v21.12, 2021-12-15 {#clickhouse-release-v2112-2021-12-15}

#### 向后不兼容变更 {#backward-incompatible-change}

- _修复了先前存在非预期行为的功能。_ 不再允许对 Kafka/RabbitMQ/FileLog 进行直接查询。可通过设置 `stream_like_engine_allow_direct_select` 启用。即使通过设置启用,如果存在已附加的物化视图,也不允许直接查询。对于 Kafka 和 RabbitMQ 的直接查询,如果允许,默认不会提交消息。要在直接查询时启用提交,用户必须使用存储级别设置 `kafka{rabbitmq}_commit_on_select=1`(默认为 `0`)。[#31053](https://github.com/ClickHouse/ClickHouse/pull/31053) ([Kseniia Sumarokova](https://github.com/kssenii))。
- _新函数行为的轻微变更。_ JSON_VALUE 返回不带引号的字符串。关闭 [#27965](https://github.com/ClickHouse/ClickHouse/issues/27965)。[#31008](https://github.com/ClickHouse/ClickHouse/pull/31008) ([Kseniia Sumarokova](https://github.com/kssenii))。
- _设置重命名。_ 为 TSV/CSV 输入格式添加自定义空值表示支持。修复 TSV/CSV/JSONCompactStringsEachRow/JSONStringsEachRow 输入格式中 Nullable(String) 的反序列化问题。将 `output_format_csv_null_representation` 和 `output_format_tsv_null_representation` 分别重命名为 `format_csv_null_representation` 和 `format_tsv_null_representation`。[#30497](https://github.com/ClickHouse/ClickHouse/pull/30497) ([Kruglov Pavel](https://github.com/Avogar))。
- _进一步弃用已不再使用的代码。_ 这仅与使用 20.6 之前 ClickHouse 版本的用户相关。从 `ReplicatedMergeTree` 中移除了"领导者选举"机制,因为自 20.6 版本起已支持多领导者。如果您从旧版本升级,且某个运行旧版本的副本是领导者,则升级后服务器将无法启动。需停止运行旧版本的副本以使新版本启动。之后将无法降级到 20.6 之前的版本。[#32140](https://github.com/ClickHouse/ClickHouse/pull/32140) ([tavplubix](https://github.com/tavplubix))。

#### 新功能 {#new-feature}


* 在 `clickhouse-keeper` 中实现了更多 ZooKeeper 四字母命令（Four Letter Words）：[https://zookeeper.apache.org/doc/r3.4.8/zookeeperAdmin.html#sc&#95;zkCommands](https://zookeeper.apache.org/doc/r3.4.8/zookeeperAdmin.html#sc_zkCommands)。[#28981](https://github.com/ClickHouse/ClickHouse/pull/28981)（[JackyWoo](https://github.com/JackyWoo)）。现在 `clickhouse-keeper` 已实现全部功能。
* 支持 `Bool` 数据类型。 [#31072](https://github.com/ClickHouse/ClickHouse/pull/31072)（[kevin wan](https://github.com/MaxWk)）。
* 在 File、URL、HDFS 存储以及 `INSERT INTO` 表函数中增加对 `PARTITION BY` 的支持。修复了 [#30273](https://github.com/ClickHouse/ClickHouse/issues/30273)。[#30690](https://github.com/ClickHouse/ClickHouse/pull/30690)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 新增 `CONSTRAINT ... ASSUME ...`（在执行 `INSERT` 时不进行检查）。新增将查询转换为 CNF（[https://github.com/ClickHouse/ClickHouse/issues/11749](https://github.com/ClickHouse/ClickHouse/issues/11749)），以便更方便地进行优化。新增基于约束的简单查询重写（目前仅支持简单匹配，后续将改进以支持 &lt;,=,&gt;...）。新增在可能的情况下用轻量列替换重型列的能力。[#18787](https://github.com/ClickHouse/ClickHouse/pull/18787)（[Nikita Vasilev](https://github.com/nikvas0)）。
* 为 `http`/`url` 函数添加基本访问身份验证。 [#31648](https://github.com/ClickHouse/ClickHouse/pull/31648) ([michael1589](https://github.com/michael1589)).
* 在 `WITH FILL` 修饰符的 `STEP` 子句中添加对 `INTERVAL` 类型的支持。 [#30927](https://github.com/ClickHouse/ClickHouse/pull/30927) ([Anton Popov](https://github.com/CurtizJ)).
* 在 `FROM INFILE` 子句中增加对从多个文件并行读取的支持，并支持使用通配符模式。 [#30135](https://github.com/ClickHouse/ClickHouse/pull/30135) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* 新增对 `Identifier` 表和数据库查询参数的支持。修复了 [#27226](https://github.com/ClickHouse/ClickHouse/issues/27226)。[#28668](https://github.com/ClickHouse/ClickHouse/pull/28668)（[Nikolay Degterinsky](https://github.com/evillique)）。
* *摘要：大幅提升了各文本格式的完备性与一致性。* 重构 `TSV`、`TSVRaw`、`CSV` 以及 `JSONCompactEachRow`、`JSONCompactStringsEachRow` 格式，去除代码重复，为带有 `-WithNames` 和 `-WithNamesAndTypes` 后缀的格式添加基础接口。新增 `CSVWithNamesAndTypes`、`TSVRawWithNames`、`TSVRawWithNamesAndTypes`、`JSONCompactEachRowWithNames`、`JSONCompactStringsEachRowWithNames`、`RowBinaryWithNames` 格式。为 `TSVWithNamesAndTypes`、`TSVRaw(WithNames/WithNamesAndTypes)`、`CSVWithNamesAndTypes`、`JSONCompactEachRow(WithNames/WithNamesAndTypes)`、`JSONCompactStringsEachRow(WithNames/WithNamesAndTypes)` 格式提供并行解析支持。为 `RowBinaryWithNamesAndTypes` 格式增加列映射和类型检查支持。新增设置 `input_format_with_types_use_header`，用于指定是否应检查 `<format_name>WithNamesAndTypes` 格式中写入的类型是否与表结构匹配。新增设置 `input_format_csv_empty_as_default`，并在 CSV 格式中用它替代 `input_format_defaults_for_omitted_fields`（因为该设置不应控制 `csv_empty_as_default`）。修复 `input_format_defaults_for_omitted_fields` 设置的使用方式（之前只作为 `csv_empty_as_default` 使用，但它应控制对被省略字段计算默认表达式）。修复 `TSVRaw` 格式中 Nullable 的输入/输出，使该格式与向 TSV 插入数据完全兼容。在启用 `input_format_null_as_default` 时，修复 `LowCardinality(Nullable)` 中插入 NULL 的问题（之前会插入默认值而非实际的 NULL）。修复 `JSONStringsEachRow`/`JSONCompactStringsEachRow` 格式中的字符串反序列化问题（字符串仅被解析到首个 `\n` 或 `\t` 为止）。为 Template 输入格式添加使用 `Raw` 转义规则的能力。为 `JSONCompactEachRow(WithNames/WithNamesAndTypes)` 输入格式增加诊断信息。修复当设置 `min_chunk_bytes_for_parallel_parsing` 小于单行字节数时，`-WithNames` 格式并行解析的错误。[#30178](https://github.com/ClickHouse/ClickHouse/pull/30178)（[Kruglov Pavel](https://github.com/Avogar)）。允许在 `CustomSeparated` 输入/输出格式中打印/解析列名和类型。新增 `CustomSeparatedWithNames/WithNamesAndTypes` 格式，其行为类似于 `TSVWithNames/WithNamesAndTypes`。[#31434](https://github.com/ClickHouse/ClickHouse/pull/31434)（[Kruglov Pavel](https://github.com/Avogar)）。
* 支持阿里云 OSS 存储。[#31286](https://github.com/ClickHouse/ClickHouse/pull/31286) ([cfcz48](https://github.com/cfcz48)).
* 在配置文件中暴露全局线程池的所有设置。[#31285](https://github.com/ClickHouse/ClickHouse/pull/31285) ([Tomáš Hromada](https://github.com/gyfis)).
* 引入了窗口函数 `exponentialTimeDecayedSum`、`exponentialTimeDecayedMax`、`exponentialTimeDecayedCount` 和 `exponentialTimeDecayedAvg`，在较大窗口下比 `exponentialMovingAverage` 更高效，并且覆盖了更多使用场景。 [#29799](https://github.com/ClickHouse/ClickHouse/pull/29799) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 新增选项，可在将日志写入文件前使用 LZ4 进行压缩。修复 [#23860](https://github.com/ClickHouse/ClickHouse/issues/23860)。[#29219](https://github.com/ClickHouse/ClickHouse/pull/29219) ([Nikolay Degterinsky](https://github.com/evillique))。
* 支持具有 CROSS JOIN 语义的 `JOIN ON 1 = 1`。修复了 [#25578](https://github.com/ClickHouse/ClickHouse/issues/25578)。[#25894](https://github.com/ClickHouse/ClickHouse/pull/25894)（[Vladimir C](https://github.com/vdimir)）。
* 为 `Map` 类型添加 Map 组合器。- 将用于映射数组的旧 `sum-, min-, max- Map` 重命名为 `sum-, min-, max- MappedArrays`。 [#24539](https://github.com/ClickHouse/ClickHouse/pull/24539) ([Ildus Kurbangaliev](https://github.com/ildus))。
* 使通过 HTTP 的读取操作支持重试。关闭 [#29696](https://github.com/ClickHouse/ClickHouse/issues/29696)。[#29894](https://github.com/ClickHouse/ClickHouse/pull/29894) ([Kseniia Sumarokova](https://github.com/kssenii))。

#### 实验性功能 {#experimental-feature}

- `WINDOW VIEW` 用于在 ClickHouse 中启用流处理。[#8331](https://github.com/ClickHouse/ClickHouse/pull/8331) ([vxider](https://github.com/Vxider))。
- 移除对 `MaterializedMySQL` 使用 Ordinary 数据库的支持。[#31292](https://github.com/ClickHouse/ClickHouse/pull/31292) ([Stig Bakken](https://github.com/stigsb))。
- 为 Log 引擎系列实现 BACKUP 和 RESTORE 命令。此功能正在开发中。[#30688](https://github.com/ClickHouse/ClickHouse/pull/30688) ([Vitaly Baranov](https://github.com/vitlibar))。

#### 性能改进 {#performance-improvement}


- 降低使用 `s3` / `url` / `hdfs` 格式读取 `Parquet`、`ORC`、`Arrow` 时的内存使用量(由设置 `input_format_allow_seeks` 控制,默认启用)。同时添加设置 `remote_read_min_bytes_for_seek` 以控制 seek 操作。关闭 [#10461](https://github.com/ClickHouse/ClickHouse/issues/10461)。关闭 [#16857](https://github.com/ClickHouse/ClickHouse/issues/16857)。[#30936](https://github.com/ClickHouse/ClickHouse/pull/30936) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 为 JOIN ON 中的常量条件添加优化,参考 [#26928](https://github.com/ClickHouse/ClickHouse/issues/26928)。[#27021](https://github.com/ClickHouse/ClickHouse/pull/27021) ([Vladimir C](https://github.com/vdimir))。
- 支持所有文本格式的并行格式化,`JSONEachRowWithProgress` 和 `PrettyCompactMonoBlock` 除外。[#31489](https://github.com/ClickHouse/ClickHouse/pull/31489) ([Kruglov Pavel](https://github.com/Avogar))。
- 加速可空列的计数操作。[#31806](https://github.com/ClickHouse/ClickHouse/pull/31806) ([Raúl Marín](https://github.com/Algunenano))。
- 加速 `avg` 和 `sumCount` 聚合函数。[#31694](https://github.com/ClickHouse/ClickHouse/pull/31694) ([Raúl Marín](https://github.com/Algunenano))。
- 提升 JSON 和 XML 输出格式的性能。[#31673](https://github.com/ClickHouse/ClickHouse/pull/31673) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 提升数据同步到块设备的性能。关闭 [#31181](https://github.com/ClickHouse/ClickHouse/issues/31181)。[#31229](https://github.com/ClickHouse/ClickHouse/pull/31229) ([zhanglistar](https://github.com/zhanglistar))。
- 修复 `LiveView` 表中的查询性能问题。修复 [#30831](https://github.com/ClickHouse/ClickHouse/issues/30831)。[#31006](https://github.com/ClickHouse/ClickHouse/pull/31006) ([vzakaznikov](https://github.com/vzakaznikov))。
- 加速查询解析。[#31949](https://github.com/ClickHouse/ClickHouse/pull/31949) ([Raúl Marín](https://github.com/Algunenano))。
- 允许为普通/标记指标拆分 `GraphiteMergeTree` 汇总规则(可选的 `rule_type` 字段)。[#25122](https://github.com/ClickHouse/ClickHouse/pull/25122) ([Michail Safronov](https://github.com/msaf1980))。
- 移除 `remote()` 的多余 `DESC TABLE` 请求(在 `remote('127.1', system.one)` 的情况下(即使用标识符作为 db.table 而非字符串)存在多余的 `DESC TABLE` 请求)。[#32019](https://github.com/ClickHouse/ClickHouse/pull/32019) ([Azat Khuzhin](https://github.com/azat))。
- 在启用设置 `optimize_functions_to_subcolumns` 时,优化函数 `tupleElement` 以读取子列。[#31261](https://github.com/ClickHouse/ClickHouse/pull/31261) ([Anton Popov](https://github.com/CurtizJ))。
- 在启用设置 `optimize_functions_to_subcolumns` 时,优化函数 `mapContains` 以读取子列 `key`。[#31218](https://github.com/ClickHouse/ClickHouse/pull/31218) ([Anton Popov](https://github.com/CurtizJ))。
- 添加设置 `merge_tree_min_rows_for_concurrent_read_for_remote_filesystem` 和 `merge_tree_min_bytes_for_concurrent_read_for_remote_filesystem`。[#30970](https://github.com/ClickHouse/ClickHouse/pull/30970) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 在 `StorageMergeTree` 中跳过不同分区的 mutation 操作。[#21326](https://github.com/ClickHouse/ClickHouse/pull/21326) ([Vladimir Chebotarev](https://github.com/excitoon))。

#### 改进 {#improvement}


* 当存在其他依赖于某个表或字典的表或字典时，不允许删除该表或字典。 [#30977](https://github.com/ClickHouse/ClickHouse/pull/30977) ([tavplubix](https://github.com/tavplubix)).
* 允许对聚合函数状态进行版本管理。现在我们可以在聚合函数状态的序列化格式中引入向后兼容的更改。修复 [#12552](https://github.com/ClickHouse/ClickHouse/issues/12552)。[#24820](https://github.com/ClickHouse/ClickHouse/pull/24820)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 支持 PostgreSQL 风格的 `ALTER MODIFY COLUMN` 语法。 [#32003](https://github.com/ClickHouse/ClickHouse/pull/32003) ([SuperDJY](https://github.com/cmsxbc))。
* 为 `RangeHashedDictionary` 和 `ComplexKeyRangeHashedDictionary` 增加了对 `update_field` 的支持。[#32185](https://github.com/ClickHouse/ClickHouse/pull/32185) ([Maksim Kita](https://github.com/kitaisreal))。
* `murmurHash3_128` 和 `sipHash128` 函数现在可以接受任意数量的参数。此更改关闭了 [#28774](https://github.com/ClickHouse/ClickHouse/issues/28774)。[#28965](https://github.com/ClickHouse/ClickHouse/pull/28965)（[小路](https://github.com/nicelulu)）。
* 为 `HDFS` 存储提供默认表达式支持，并在源为列式存储时优化读取。[#32256](https://github.com/ClickHouse/ClickHouse/pull/32256) ([李扬](https://github.com/taiyang-li)).
* 改进一个 OpenTelemetry span 的操作名。 [#32234](https://github.com/ClickHouse/ClickHouse/pull/32234) ([Frank Chen](https://github.com/FrankChen021)).
* 对于输出格式 `JSONEachRow`，请使用 `Content-Type: application/x-ndjson`（[http://ndjson.org/](http://ndjson.org/)）。[#32223](https://github.com/ClickHouse/ClickHouse/pull/32223)（[Dmitriy Dorofeev](https://github.com/deem0n)）。
* 改进了在 Template/CustomSeparated 格式中使用带引号转义规则跳过未知字段的机制。此前只能跳过带引号的字符串，现在可以跳过任意类型的值。[#32204](https://github.com/ClickHouse/ClickHouse/pull/32204)（[Kruglov Pavel](https://github.com/Avogar)）。
* 现在，当配置中包含重复的 ID 或 endpoint 时，`clickhouse-keeper` 将拒绝启动或应用配置更改。修复了 [#31339](https://github.com/ClickHouse/ClickHouse/issues/31339)。[#32121](https://github.com/ClickHouse/ClickHouse/pull/32121)（[alesapin](https://github.com/alesapin)）。
* 在 URL 引擎发出的 HTTP 数据包中设置 Content-Type。 [#32113](https://github.com/ClickHouse/ClickHouse/pull/32113) ([Frank Chen](https://github.com/FrankChen021))。
* 如果启用了 `output_format_json_array_of_rows`，则在 `JSONEachRow` 格式下将 Content-Type 返回为 `application/json`。[#32112](https://github.com/ClickHouse/ClickHouse/pull/32112) ([Frank Chen](https://github.com/FrankChen021))。
* 允许解析 `Float32`/`Float64` 值前面的 `+`。 [#32079](https://github.com/ClickHouse/ClickHouse/pull/32079) ([Kruglov Pavel](https://github.com/Avogar)).
* 允许用户为 `DiskHDFS` 和 `StorageHDFS` 配置 `hdfs_replication` 参数。修复了 [#32039](https://github.com/ClickHouse/ClickHouse/issues/32039)。[#32049](https://github.com/ClickHouse/ClickHouse/pull/32049)（[leosunli](https://github.com/leosunli)）。
* 在 OpenTelemetry span 日志中新增了 ClickHouse 的 `exception` 和 `exception_code` 字段。[#32040](https://github.com/ClickHouse/ClickHouse/pull/32040) ([Frank Chen](https://github.com/FrankChen021))。
* 改进 OpenTelemetry span 日志的持续时间计算——当查询出现异常时，查询级别的持续时间之前会被记录为 0。 [#32038](https://github.com/ClickHouse/ClickHouse/pull/32038) ([Frank Chen](https://github.com/FrankChen021)).
* 修复了无法创建 `Int256` 类型的 `LowCardinality` 的问题。[#31832](https://github.com/ClickHouse/ClickHouse/pull/31832)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在更改 `engine` 或 `partition_by` 时重新创建 `system.*_log` 表。[#31824](https://github.com/ClickHouse/ClickHouse/pull/31824)（[Azat Khuzhin](https://github.com/azat)）。
* `MaterializedMySQL`：修复名为 &#39;table&#39; 的表引发的问题。[#31781](https://github.com/ClickHouse/ClickHouse/pull/31781)（[Håvard Kvålen](https://github.com/havardk)）。
* ClickHouse 字典源：支持预定义连接。关闭 [#31705](https://github.com/ClickHouse/ClickHouse/issues/31705)。[#31749](https://github.com/ClickHouse/ClickHouse/pull/31749)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 允许在 Kafka 和 RabbitMQ 引擎中使用预定义的连接配置（与其他集成表引擎的用法相同）。 [#31691](https://github.com/ClickHouse/ClickHouse/pull/31691) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 在 clickhouse-client 中浏览历史记录时始终重新渲染提示符。这样可以提升在操作无法完整显示在屏幕上的超长查询时的易用性。[#31675](https://github.com/ClickHouse/ClickHouse/pull/31675) ([alexey-milovidov](https://github.com/alexey-milovidov))（作者：Amos Bird）。
* 添加用于在命令历史中导航的按键绑定（替代按行/按历史的导航方式）。 [#31641](https://github.com/ClickHouse/ClickHouse/pull/31641) ([Azat Khuzhin](https://github.com/azat)).
* 改进 `max_execution_time` 的检查。修复了在某些情况下未执行超时检查、导致查询可能运行过久的问题。 [#31636](https://github.com/ClickHouse/ClickHouse/pull/31636) ([Raúl Marín](https://github.com/Algunenano)).
* 当由于错误的密码哈希而导致无法加载 `users.xml` 时，改进异常消息。修复了 [#24126](https://github.com/ClickHouse/ClickHouse/issues/24126)。[#31557](https://github.com/ClickHouse/ClickHouse/pull/31557) ([Vitaly Baranov](https://github.com/vitlibar))。
* 当配置中未定义这些宏时，在展开 `ReplicatedMergeTree` 参数中的宏时，使用来自 `Replicated` 数据库参数的 shard 和 replica 名称。修复了 [#31471](https://github.com/ClickHouse/ClickHouse/issues/31471)。[#31488](https://github.com/ClickHouse/ClickHouse/pull/31488)（[tavplubix](https://github.com/tavplubix)）。
* 改进了对 `min/max/count` 投影的分析。现在，在启用 `allow_experimental_projection_optimization` 时，可以将虚拟 `min/max/count` 投影与分区键中的列配合使用。[#31474](https://github.com/ClickHouse/ClickHouse/pull/31474) ([Amos Bird](https://github.com/amosbird))。
* 为 `clickhouse-local` 添加对 `--pager` 的支持。[#31457](https://github.com/ClickHouse/ClickHouse/pull/31457) ([Azat Khuzhin](https://github.com/azat)).
* 修复交互式查询编辑期间编辑器阻塞等待的问题（当 `EDITOR` 与 `clickhouse-local`/`clickhouse-client` 并发运行时，`waitpid()` 在收到 `SIGWINCH` 时返回 -1）。[#31456](https://github.com/ClickHouse/ClickHouse/pull/31456) ([Azat Khuzhin](https://github.com/azat)).
* 如果在 `JSONCompactStrings(EachRow)` 格式中字段之后存在无效数据，则抛出异常。 [#31455](https://github.com/ClickHouse/ClickHouse/pull/31455) ([Kruglov Pavel](https://github.com/Avogar))。
* `http_send_timeout` 和 `http_receive_timeout` 设置的默认值从 1800（30 分钟）更改为 180（3 分钟）。[#31450](https://github.com/ClickHouse/ClickHouse/pull/31450)（[tavplubix](https://github.com/tavplubix)）。
* `MaterializedMySQL` 现在可以处理 `CREATE TABLE ... LIKE ...` DDL 查询。[#31410](https://github.com/ClickHouse/ClickHouse/pull/31410) ([Stig Bakken](https://github.com/stigsb))。
* 在对 system 表执行 `show create table` 时返回伪造的 CREATE 查询。 [#31391](https://github.com/ClickHouse/ClickHouse/pull/31391) ([SuperDJY](https://github.com/cmsxbc)).
* 之前仅对 `numbers` 表函数显示进度，现在 `numbers_mt` 也会显示进度。[#31318](https://github.com/ClickHouse/ClickHouse/pull/31318) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 现在会使用初始用户的角色来查找行级策略，参见 [#31080](https://github.com/ClickHouse/ClickHouse/issues/31080)。[#31262](https://github.com/ClickHouse/ClickHouse/pull/31262)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 如果修改了某个已废弃的设置，会在 `system.warnings` 中显示警告。[#31252](https://github.com/ClickHouse/ClickHouse/pull/31252) ([tavplubix](https://github.com/tavplubix))。
* 改进了 `MergeTree` 中后台清理任务的退避机制。设置项 `merge_tree_clear_old_temporary_directories_interval_seconds` 和 `merge_tree_clear_old_parts_interval_seconds` 已从用户设置中移动到 MergeTree 设置中。[#31180](https://github.com/ClickHouse/ClickHouse/pull/31180) ([tavplubix](https://github.com/tavplubix))。
* 现在，每个副本只会向客户端发送 profile events 计数器的增量信息。[#31155](https://github.com/ClickHouse/ClickHouse/pull/31155)（[Dmitry Novik](https://github.com/novikd)）。这使得 `clickhouse-client` 中的 `--hardware_utilization` 选项可以正常使用。
* 在 `clickhouse-client` 中默认启用多行编辑功能。此更改解决了 [#31121](https://github.com/ClickHouse/ClickHouse/issues/31121)。[#31123](https://github.com/ClickHouse/ClickHouse/pull/31123)（[Amos Bird](https://github.com/amosbird)）。
* 对 `ALTER` 查询中的函数名进行规范化。这有助于避免在使用索引/投影创建表与通过 ALTER 命令添加索引/投影之间出现元数据不匹配的情况。这是 [https://github.com/ClickHouse/ClickHouse/pull/20174](https://github.com/ClickHouse/ClickHouse/pull/20174) 的后续 PR。标记为改进项，因为尚无相关错误报告且该场景相对较少见。[#31095](https://github.com/ClickHouse/ClickHouse/pull/31095)（[Amos Bird](https://github.com/amosbird)）。
* 为 `RENAME DATABASE`/`TABLE`/`DICTIONARY` 查询增加对 `IF EXISTS` 修饰符的支持。如果使用该修饰符，当要重命名的 DATABASE/TABLE/DICTIONARY 不存在时，将不会报错。[#31081](https://github.com/ClickHouse/ClickHouse/pull/31081) ([victorgao](https://github.com/kafka1991))。
* 当分区被删除时，取消纵向合并。这是对 [https://github.com/ClickHouse/ClickHouse/pull/25684](https://github.com/ClickHouse/ClickHouse/pull/25684) 和 [https://github.com/ClickHouse/ClickHouse/pull/30996](https://github.com/ClickHouse/ClickHouse/pull/30996) 的后续改动。[#31057](https://github.com/ClickHouse/ClickHouse/pull/31057)（[Amos Bird](https://github.com/amosbird)）。
* ClickHouse 字典源中的本地会话将不再把其事件发送到会话日志。这修复了关闭时可能出现的死锁（tsan 警报）。此外，此 PR 还修复了不稳定的 `test_dictionaries_dependency_xml/`。 [#31013](https://github.com/ClickHouse/ClickHouse/pull/31013) ([Vitaly Baranov](https://github.com/vitlibar)).
* 在执行 `ALTER` 命令时减少加锁。[#31010](https://github.com/ClickHouse/ClickHouse/pull/31010)（[Amos Bird](https://github.com/amosbird)）。
* 修复 clickhouse-local 交互模式中的 `--verbose` 选项，并允许将日志记录到文件中。[#30881](https://github.com/ClickHouse/ClickHouse/pull/30881) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 在 `clickhouse-client` 中新增了 `\l`、`\d`、`\c` 命令，其行为与 MySQL 和 PostgreSQL 中的相应命令类似。 [#30876](https://github.com/ClickHouse/ClickHouse/pull/30876) ([Pavel Medvedev](https://github.com/pmed))。
* 对于 clickhouse-local 或 clickhouse-client：如果在使用 `--query` 或 `--queries-file` 时同时指定了 `--interactive` 选项，则会先像非交互模式那样执行这些查询，然后再进入交互模式。[#30851](https://github.com/ClickHouse/ClickHouse/pull/30851)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复可能出现的“X 的本地分片集合与 ZooKeeper 中的分片集合不一致”错误（当从 ZooKeeper 删除 znode 时 `DROP` 操作失败的情况）。[#30826](https://github.com/ClickHouse/ClickHouse/pull/30826) ([Azat Khuzhin](https://github.com/azat)).
* Avro 格式现在可与 Kafka 一起使用。新增设置 `output_format_avro_rows_in_file`。 [#30351](https://github.com/ClickHouse/ClickHouse/pull/30351) ([Ilya Golshtein](https://github.com/ilejn))。
* 允许为一个 `MaterializedPostgreSQL` 数据库指定一个或多个 PostgreSQL schema。修复了 [#28901](https://github.com/ClickHouse/ClickHouse/issues/28901) 与 [#29324](https://github.com/ClickHouse/ClickHouse/issues/29324) 问题。[#28933](https://github.com/ClickHouse/ClickHouse/pull/28933)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 将 clickhouse-keeper 内部通信的默认端口从 44444 替换为 9234。修复了 [#30879](https://github.com/ClickHouse/ClickHouse/issues/30879)。[#31799](https://github.com/ClickHouse/ClickHouse/pull/31799)（[alesapin](https://github.com/alesapin)）。
* 为函数 transform 实现对 Decimal 参数的支持。 [#31839](https://github.com/ClickHouse/ClickHouse/pull/31839) ([李帅](https://github.com/loneylee)).
* 通过增加对 hdfs url 结构的额外检查，在 hdfs url 不合法的情况下，修复了调试服务器中的异常终止问题以及发布服务器中的 `DB::Exception: std::out_of_range: basic_string` 错误。 [#31042](https://github.com/ClickHouse/ClickHouse/pull/31042) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复 `hdfs` 表函数/引擎中可能触发的断言，并添加测试。[#31036](https://github.com/ClickHouse/ClickHouse/pull/31036) ([Kruglov Pavel](https://github.com/Avogar)).

#### 错误修复 {#bug-fixes}


* 修复在启用位置参数时 `GROUP BY` / `ORDER BY` / `LIMIT BY` 中别名的处理。修复 [#31173](https://github.com/ClickHouse/ClickHouse/issues/31173)。[#31741](https://github.com/ClickHouse/ClickHouse/pull/31741)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在 `Buffer` 表引擎中使用 `Map` 类型时的行为。修复了 [#30546](https://github.com/ClickHouse/ClickHouse/issues/30546)。[#31742](https://github.com/ClickHouse/ClickHouse/pull/31742)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复在启用 `use_uncompressed_cache` 时从 `MergeTree` 表进行读取的行为。[#31826](https://github.com/ClickHouse/ClickHouse/pull/31826) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了在启用设置 `empty_result_for_aggregation_by_empty_set` 时，对数据无任何实际改动的 mutation 出现卡住的问题。[#32358](https://github.com/ClickHouse/ClickHouse/pull/32358) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 修复写入 protobuf 时跳过列的问题。此 PR 修复了 [#31160](https://github.com/ClickHouse/ClickHouse/issues/31160)，参见评论 [#31160](https://github.com/ClickHouse/ClickHouse/issues/31160)#issuecomment-980595318。[#31988](https://github.com/ClickHouse/ClickHouse/pull/31988)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复在子查询中移除不需要的列时的错误。如果查询中存在不带 `GROUP BY` 的聚合函数，即使该列是不需要的也不要移除。 [#32289](https://github.com/ClickHouse/ClickHouse/pull/32289) ([dongyifeng](https://github.com/dyf6372)).
* 配额下限尚未达到，但上限已被超出。此 PR 修复了 [#31174](https://github.com/ClickHouse/ClickHouse/issues/31174)。[#31337](https://github.com/ClickHouse/ClickHouse/pull/31337)（[sunny](https://github.com/sunny19930321)）。
* 在使用部分撤销时修复了 `SHOW GRANTS` 的行为。此 PR 修复了 [#31138](https://github.com/ClickHouse/ClickHouse/issues/31138)。[#31249](https://github.com/ClickHouse/ClickHouse/pull/31249)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 当 ClickHouse 在具有 cgroup 限制的容器中运行时，对可用内存的估算不正确。[#31157](https://github.com/ClickHouse/ClickHouse/pull/31157) ([Pavel Medvedev](https://github.com/pmed))。
* 修复在默认表达式的数据类型与列的数据类型不一致时，`ALTER ... MATERIALIZE COLUMN ...` 查询的行为。[#32348](https://github.com/ClickHouse/ClickHouse/pull/32348) ([Anton Popov](https://github.com/CurtizJ))。
* 修复了在聚合函数 `avgWeighted` 使用 `Decimal` 参数时出现的 SIGFPE 崩溃问题。修复了 [#32053](https://github.com/ClickHouse/ClickHouse/issues/32053)。[#32303](https://github.com/ClickHouse/ClickHouse/pull/32303)（[tavplubix](https://github.com/tavplubix)）。
* 如果 `Dictionary` 表引用了与其同名的 XML 字典，服务器可能会因 `Cannot attach 1 tables due to cyclic dependencies` 错误而无法启动，该问题已修复。修复了 [#31315](https://github.com/ClickHouse/ClickHouse/issues/31315)。[#32288](https://github.com/ClickHouse/ClickHouse/pull/32288)（[tavplubix](https://github.com/tavplubix)）。
* 修复在 `Quoted` 转义规则下，对 `Nullable(Float)` 进行 NaN 反序列化时出现的解析错误。[#32190](https://github.com/ClickHouse/ClickHouse/pull/32190) ([Kruglov Pavel](https://github.com/Avogar)).
* XML 字典：在 `CREATE TABLE` 查询中使用的标识符，在升级到新版本时可以自动补全为带 `default_database` 限定。修复 [#31963](https://github.com/ClickHouse/ClickHouse/issues/31963)。[#32187](https://github.com/ClickHouse/ClickHouse/pull/32187)（[Maksim Kita](https://github.com/kitaisreal)）。
* 在执行带 `quorum` 的插入时，如果某些副本上禁用了 `replicated_can_become_leader` 设置，活动副本数量可能会被错误计算。该问题已修复。 [#32157](https://github.com/ClickHouse/ClickHouse/pull/32157) ([tavplubix](https://github.com/tavplubix)).
* 字典：修复在自定义数据库查询中 `{condition}` 条件不起作用的情况。[#32117](https://github.com/ClickHouse/ClickHouse/pull/32117) ([Maksim Kita](https://github.com/kitaisreal))。
* 修复使用 `cast_keep_nullable` 对 `Nullable` 进行 `CAST` 时的问题（此前在例如 `toUInt32OrDefault(toNullable(toUInt32(1)))` 的情况下会触发 `PARAMETER_OUT_OF_BOUND` 错误）。 [#32080](https://github.com/ClickHouse/ClickHouse/pull/32080) ([Azat Khuzhin](https://github.com/azat)).
* 在某些较为冷门的场景下修复 Join 存储引擎的 `CREATE TABLE`。关闭 [#31680](https://github.com/ClickHouse/ClickHouse/issues/31680)。[#32066](https://github.com/ClickHouse/ClickHouse/pull/32066)（[SuperDJY](https://github.com/cmsxbc)）。
* 修复在分离数据分片时出现的 `Directory ... already exists and is not empty` 错误。[#32063](https://github.com/ClickHouse/ClickHouse/pull/32063) ([tavplubix](https://github.com/tavplubix)).
* `MaterializedMySQL`（实验特性）：修复从 MySQL 读取 `DECIMAL` 数据时的误解析问题。[#31990](https://github.com/ClickHouse/ClickHouse/pull/31990)（[Håvard Kvålen](https://github.com/havardk)）。
* `FileLog`（实验特性）引擎在建表失败时会不必要地创建元数据目录。修复 [#31962](https://github.com/ClickHouse/ClickHouse/issues/31962)。[#31967](https://github.com/ClickHouse/ClickHouse/pull/31967)（[flynn](https://github.com/ucasfl)）。
* 如果某个 `GET_PART` 条目对应的数据块在所有副本上都丢失，并且同一分区中没有其他数据块，它可能会在复制队列中卡住。当分区键仅包含整数类型或 `Date[Time]` 类型的列时，此问题已被修复。修复了 [#31485](https://github.com/ClickHouse/ClickHouse/issues/31485)。[#31887](https://github.com/ClickHouse/ClickHouse/pull/31887)（[tavplubix](https://github.com/tavplubix)）。
* 修复对 `UUID` 类型参数的 `empty` 和 `notEmpty` 函数的处理。修复了 [#31819](https://github.com/ClickHouse/ClickHouse/issues/31819)。[#31883](https://github.com/ClickHouse/ClickHouse/pull/31883)（[Anton Popov](https://github.com/CurtizJ)）。
* 在构造 `KeeperTCPHandler` 时，将配置路径从 `keeper_server.session_timeout_ms` 更改为 `keeper_server.coordination_settings.session_timeout_ms`。`operation_timeout` 同理。[#31859](https://github.com/ClickHouse/ClickHouse/pull/31859) ([JackyWoo](https://github.com/JackyWoo))。
* 修复在使用可空主键时对 `Nullable` 类型进行无效转换的问题。（不推荐使用可空主键——请勿使用）。此修复对应 [#31075](https://github.com/ClickHouse/ClickHouse/issues/31075)。[#31823](https://github.com/ClickHouse/ClickHouse/pull/31823)（[Amos Bird](https://github.com/amosbird)）。
* 修复 SQL 中递归 UDF 导致的崩溃。关闭 [#30856](https://github.com/ClickHouse/ClickHouse/issues/30856)。[#31820](https://github.com/ClickHouse/ClickHouse/pull/31820)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复了在字典属性类型为 `Nullable` 时使用带类型参数的函数 `dictGet` 会导致崩溃的问题。修复了 [#30980](https://github.com/ClickHouse/ClickHouse/issues/30980)。[#31800](https://github.com/ClickHouse/ClickHouse/pull/31800)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复在使用某些 ODBC 驱动时，当 ODBC 查询结果为空会导致的崩溃问题。关闭 [#31465](https://github.com/ClickHouse/ClickHouse/issues/31465)。[#31766](https://github.com/ClickHouse/ClickHouse/pull/31766)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复禁用查询分析器的问题（在 `query_profiler_real_time_period_ns>0` / `query_profiler_cpu_time_period_ns>0` 的情况下，即使查询已结束，查询分析器可能仍保持启用状态）。[#31740](https://github.com/ClickHouse/ClickHouse/pull/31740) ([Azat Khuzhin](https://github.com/azat))。
* 修复了在并发执行 `ATTACH PARTITION` 查询时偶发的段错误。 [#31738](https://github.com/ClickHouse/ClickHouse/pull/31738) ([tavplubix](https://github.com/tavplubix)).
* 修复 `JSONEachRowWithProgress` 输出格式中，当数据行与进度行混合输出时出现的竞态问题。 [#31736](https://github.com/ClickHouse/ClickHouse/pull/31736) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复了在执行 `ON CLUSTER` 查询时，如果指定的集群名称是某个 `Replicated` 数据库的名称，会错误地报出 `there are no such cluster here` 的问题。[#31723](https://github.com/ClickHouse/ClickHouse/pull/31723) ([tavplubix](https://github.com/tavplubix)).
* 修复在 `Nullable` 列上某些 `decrypt` 函数用法会抛出异常的问题。关闭了 [#31662](https://github.com/ClickHouse/ClickHouse/issues/31662)。关闭了 [#31426](https://github.com/ClickHouse/ClickHouse/issues/31426)。[#31707](https://github.com/ClickHouse/ClickHouse/pull/31707)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在字符串包含 UTF-8 字符时的 ngrams 固定函数。 [#31706](https://github.com/ClickHouse/ClickHouse/pull/31706) ([yandd](https://github.com/yandd)).
* 设置 `input_format_allow_errors_num` 和 `input_format_allow_errors_ratio` 之前对 `IPv4` 等域类型的解析无效，现已修复。修复了 [#31686](https://github.com/ClickHouse/ClickHouse/issues/31686)。[#31697](https://github.com/ClickHouse/ClickHouse/pull/31697) ([tavplubix](https://github.com/tavplubix)).
* 修复了在 `MATERIALIZE COLUMN` 中出现的空指针异常。[#31679](https://github.com/ClickHouse/ClickHouse/pull/31679) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 在 `Ordinary` 数据库中尝试重命名 DDL 字典时，`RENAME TABLE` 查询行为不正确，现已修复。 [#31638](https://github.com/ClickHouse/ClickHouse/pull/31638) ([tavplubix](https://github.com/tavplubix)).
* 按照最初的设想实现 `sparkbar` 聚合函数，参见：[#26175](https://github.com/ClickHouse/ClickHouse/issues/26175)#issuecomment-960353867、[评论](https://github.com/ClickHouse/ClickHouse/issues/26175#issuecomment-961155065)。[#31624](https://github.com/ClickHouse/ClickHouse/pull/31624)（[小路](https://github.com/nicelulu)）。
* 修复在仅有列名包含无效 UTF-8 序列时生成的无效 JSON。 [#31534](https://github.com/ClickHouse/ClickHouse/pull/31534) ([Kevin Michel](https://github.com/kmichel-aiven)).
* 在修复该优化中的 bug 之前，禁用 `partial_merge_join_left_table_buffer_bytes`。参见 [#31009](https://github.com/ClickHouse/ClickHouse/issues/31009)。移除冗余选项 `partial_merge_join_optimizations`。[#31528](https://github.com/ClickHouse/ClickHouse/pull/31528)（[Vladimir C](https://github.com/vdimir)）。
* 修复短 `INSERT SELECT` 查询的进度。[#31510](https://github.com/ClickHouse/ClickHouse/pull/31510) ([Azat Khuzhin](https://github.com/azat))。
* 修复 `GROUP BY` 与位置参数搭配使用时的异常行为。关闭 [#31280](https://github.com/ClickHouse/ClickHouse/issues/31280)#issuecomment-968696186。[#31420](https://github.com/ClickHouse/ClickHouse/pull/31420)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复 S3 中 STS 凭证提供程序的 `nullptr` 问题。[#31409](https://github.com/ClickHouse/ClickHouse/pull/31409)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* 从索引分析中移除 `notLike` 函数，因为其实现有误。[#31169](https://github.com/ClickHouse/ClickHouse/pull/31169) ([sundyli](https://github.com/sundy-li)).
* 修复 Keeper 中的一个错误：当部分协调日志丢失且快照比最新日志更新时，可能导致无法启动。 [#31150](https://github.com/ClickHouse/ClickHouse/pull/31150) ([alesapin](https://github.com/alesapin)).
* 在本地 `JOIN` 中对右侧分布式表进行重写。解决了 [#25809](https://github.com/ClickHouse/ClickHouse/issues/25809)。[#31105](https://github.com/ClickHouse/ClickHouse/pull/31105)（[abel-cheng](https://github.com/abel-cheng)）。
* 修复带有别名和 `where` 的 `Merge` 表（之前完全无法使用）。修复 [#28802](https://github.com/ClickHouse/ClickHouse/issues/28802)。[#31044](https://github.com/ClickHouse/ClickHouse/pull/31044)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复带引号标识符的 JSON&#95;VALUE/JSON&#95;QUERY，以便在 JSON 路径中允许包含空格。关闭 [#30971](https://github.com/ClickHouse/ClickHouse/issues/30971)。[#31003](https://github.com/ClickHouse/ClickHouse/pull/31003)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在对非行向格式使用 `formatRow` 函数时会导致段错误。不允许在此类格式中使用该函数（因为这样没有意义）。[#31001](https://github.com/ClickHouse/ClickHouse/pull/31001) ([Kruglov Pavel](https://github.com/Avogar))。
* 修复了一个 bug，该 bug 会导致在删除 `materialized view` 之后执行的 `select` 查询失败。见 [#30691](https://github.com/ClickHouse/ClickHouse/issues/30691)。[#30997](https://github.com/ClickHouse/ClickHouse/pull/30997)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在执行 ATTACH PARTITION ... FROM 和 MOVE PARTITION ... 时跳过 `max_partition_size_to_drop` 检查 [#30995](https://github.com/ClickHouse/ClickHouse/pull/30995)（[Amr Alaa](https://github.com/amralaa-MSFT)）。
* 修复 `INTERSECT` 和 `EXCEPT` 运算符的一些边缘情况。关闭 [#30803](https://github.com/ClickHouse/ClickHouse/issues/30803)。[#30965](https://github.com/ClickHouse/ClickHouse/pull/30965)（[Kseniia Sumarokova](https://github.com/kssenii)）。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement}

- 修复非 x86 架构构建中的错误过滤结果。此修复关闭了 [#31417](https://github.com/ClickHouse/ClickHouse/issues/31417)。此修复关闭了 [#31524](https://github.com/ClickHouse/ClickHouse/issues/31524)。[#31574](https://github.com/ClickHouse/ClickHouse/pull/31574) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 使 ClickHouse 构建完全可重现(在不同机器上字节完全相同)。此修复关闭了 [#22113](https://github.com/ClickHouse/ClickHouse/issues/22113)。[#31899](https://github.com/ClickHouse/ClickHouse/pull/31899) ([alexey-milovidov](https://github.com/alexey-milovidov))。从二进制文件中移除构建目录的文件系统路径以实现可重现构建。这是为了 [#22113](https://github.com/ClickHouse/ClickHouse/issues/22113)。[#31838](https://github.com/ClickHouse/ClickHouse/pull/31838) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 为 `zlib-ng`、`cassandra`、`mariadb-connector-c`、`xz`、`re2`、`sentry`、`gsasl`、`arrow`、`protobuf` 使用我们自己的 CMakeLists。这是为了 [#20151](https://github.com/ClickHouse/ClickHouse/issues/20151)。部分解决了 [#9226](https://github.com/ClickHouse/ClickHouse/issues/9226)。朝着从构建系统中移除冗余内容迈出的一小步。[#30599](https://github.com/ClickHouse/ClickHouse/pull/30599) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 密闭构建:使用固定版本的 libc 并确保在构建期间不使用来自宿主操作系统的源文件或二进制文件。此修复关闭了 [#27133](https://github.com/ClickHouse/ClickHouse/issues/27133)。此修复关闭了 [#21435](https://github.com/ClickHouse/ClickHouse/issues/21435)。此修复关闭了 [#30462](https://github.com/ClickHouse/ClickHouse/issues/30462)。[#30011](https://github.com/ClickHouse/ClickHouse/pull/30011) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 添加函数 `getFuzzerData()` 以便轻松对特定函数进行模糊测试。此修复关闭了 [#23227](https://github.com/ClickHouse/ClickHouse/issues/23227)。[#27526](https://github.com/ClickHouse/ClickHouse/pull/27526) ([Alexey Boykov](https://github.com/mathalex))。
- 更正确地在 Docker 内部设置 capabilities。[#31802](https://github.com/ClickHouse/ClickHouse/pull/31802) ([Constantine Peresypkin](https://github.com/pkit))。
- 启用 clang `-fstrict-vtable-pointers`、`-fwhole-program-vtables` 编译选项。[#20151](https://github.com/ClickHouse/ClickHouse/pull/20151) ([Maksim Kita](https://github.com/kitaisreal))。
- 避免为 FreeBSD 交叉编译下载工具链压缩包。[#31672](https://github.com/ClickHouse/ClickHouse/pull/31672) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 初步支持 risc-v。有关已测试的特殊问题和构建命令,请参阅 development/build-cross-riscv。[#31309](https://github.com/ClickHouse/ClickHouse/pull/31309) ([Vladimir Smirnov](https://github.com/Civil))。
- 支持在 arm 机器上使用参数 "-DENABLE_TESTS=OFF" 进行编译。[#31007](https://github.com/ClickHouse/ClickHouse/pull/31007) ([zhanghuajie](https://github.com/zhanghuajieHIT))。

### ClickHouse 版本 v21.11, 2021-11-09 {#clickhouse-release-v2111-2021-11-09}

#### 向后不兼容的变更 {#backward-incompatible-change-1}


- 更改 SQL/JSON 函数中 json_path 和 json 参数的顺序(以符合标准)。关闭 [#30449](https://github.com/ClickHouse/ClickHouse/issues/30449)。[#30474](https://github.com/ClickHouse/ClickHouse/pull/30474) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 移除 `MergeTree` 表设置 `write_final_mark`。该设置将始终为 `true`。[#30455](https://github.com/ClickHouse/ClickHouse/pull/30455) ([Kseniia Sumarokova](https://github.com/kssenii))。无需任何操作,所有表都与新版本兼容。
- 函数 `bayesAB` 已被移除。欢迎帮助以更新的形式恢复此函数。关闭 [#26233](https://github.com/ClickHouse/ClickHouse/issues/26233)。[#29934](https://github.com/ClickHouse/ClickHouse/pull/29934) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 仅当您已开始使用实验性的 `clickhouse-keeper` 支持时,此项才相关。现在 ClickHouse Keeper 快照默认使用 `ZSTD` 编解码器压缩,而不是自定义的 ClickHouse LZ4 块压缩。可以通过 `compress_snapshots_with_zstd_format` 协调设置关闭此行为(必须在所有仲裁副本上保持一致)。向后不兼容的情况非常罕见,仅在新节点向无法读取 ZSTD 格式快照的旧节点发送快照时(发生在恢复场景中)才可能出现。[#29417](https://github.com/ClickHouse/ClickHouse/pull/29417) ([alesapin](https://github.com/alesapin))。

#### 新功能 {#new-feature-1}


* 新的异步 `INSERT` 模式允许在后台累积插入的数据，并将其作为一个批次写入存储。在客户端，可以通过在 `INSERT` 查询中设置 `async_insert` 来启用该模式，适用于在查询中内联数据或使用单独缓冲区（例如通过 HTTP 协议执行的 `INSERT` 查询）。如果 `wait_for_async_insert` 为 true（默认值），客户端会等待数据刷新到表中。在服务端，该模式由 `async_insert_threads`、`async_insert_max_data_size` 和 `async_insert_busy_timeout_ms` 这些设置项进行控制。实现了 [#18282](https://github.com/ClickHouse/ClickHouse/issues/18282)。[#27537](https://github.com/ClickHouse/ClickHouse/pull/27537)（[Anton Popov](https://github.com/CurtizJ)）。[#20557](https://github.com/ClickHouse/ClickHouse/pull/20557)（[Ivan](https://github.com/abyss7)）。性能说明：使用异步插入时，每秒可以执行大约 10 000 个独立的 `INSERT` 查询，因此如果希望达到每秒插入数百万行的性能，仍然建议采用批量插入。
* 为 `clickhouse-local` 添加交互模式。这样，你可以直接运行 `clickhouse-local`，在无需连接服务器的情况下获得一个命令行 ClickHouse 界面，并处理来自文件和外部数据源的数据。同时合并 `clickhouse-client` 和 `clickhouse-local` 的代码。修复 [#7203](https://github.com/ClickHouse/ClickHouse/issues/7203)。修复 [#25516](https://github.com/ClickHouse/ClickHouse/issues/25516)。修复 [#22401](https://github.com/ClickHouse/ClickHouse/issues/22401)。[#26231](https://github.com/ClickHouse/ClickHouse/pull/26231)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 新增支持可执行（可脚本化）的用户自定义函数。这类 UDF 可以使用任意编程语言编写。 [#28803](https://github.com/ClickHouse/ClickHouse/pull/28803) ([Maksim Kita](https://github.com/kitaisreal)).
* 允许预定义到外部数据源的连接。这样在使用外部数据源时就无需再指定凭据或地址，而是可以通过名称来引用它们。关闭了 [#28367](https://github.com/ClickHouse/ClickHouse/issues/28367)。[#28577](https://github.com/ClickHouse/ClickHouse/pull/28577) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 在 `system` 数据库中对应的表之上新增了 `INFORMATION_SCHEMA` 数据库及其 `SCHEMATA`、`TABLES`、`VIEWS` 和 `COLUMNS` 视图。关闭了 [#9770](https://github.com/ClickHouse/ClickHouse/issues/9770)。[#28691](https://github.com/ClickHouse/ClickHouse/pull/28691)（[tavplubix](https://github.com/tavplubix)）。
* 支持 `EXISTS (subquery)`。已关闭 [#6852](https://github.com/ClickHouse/ClickHouse/issues/6852)。[#29731](https://github.com/ClickHouse/ClickHouse/pull/29731)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 用于审计的会话日志功能。将所有成功和失败的登录与登出事件记录到新的 `system.session_log` 表中。[#22415](https://github.com/ClickHouse/ClickHouse/pull/22415) ([Vasily Nemkov](https://github.com/Enmk)) ([Vitaly Baranov](https://github.com/vitlibar))。
* 支持多维余弦距离和欧几里得距离函数；支持 L1、L2、Lp、Linf 距离及其范数。支持在元组上进行标量积以及各种算术运算符。这一改动完全解决了 [#4509](https://github.com/ClickHouse/ClickHouse/issues/4509)，并且还带来了更多改进。[#27933](https://github.com/ClickHouse/ClickHouse/pull/27933)（[Alexey Boykov](https://github.com/mathalex)）。
* 为 `INTO OUTFILE` 和 `FROM INFILE` 添加压缩和解压缩功能（可自动检测或通过额外的可选参数指定）。 [#27135](https://github.com/ClickHouse/ClickHouse/pull/27135) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* 通过 HTTP `OPTIONS` 请求添加对 CORS（跨域资源共享）的支持。这意味着现在 Grafana 在无服务器请求场景下可以正常工作，而不再需要各种变通方案。修复 [#18693](https://github.com/ClickHouse/ClickHouse/issues/18693)。[#29155](https://github.com/ClickHouse/ClickHouse/pull/29155)（[Filatenkov Artur](https://github.com/FArthur-cmd)）。
* 带有 JOIN ON 的查询现在支持使用逻辑“或”（OR）。[#21320](https://github.com/ClickHouse/ClickHouse/pull/21320)（[Ilya Golshtein](https://github.com/ilejn)）。
* 新增函数 `tokens`，可使用非字母数字的 ASCII 字符作为分隔符，将字符串拆分为词元（tokens）。[#29981](https://github.com/ClickHouse/ClickHouse/pull/29981) ([Maksim Kita](https://github.com/kitaisreal))。新增函数 `ngrams`，用于从文本中提取 n-gram。修复 [#29699](https://github.com/ClickHouse/ClickHouse/issues/29699)。[#29738](https://github.com/ClickHouse/ClickHouse/pull/29738) ([Maksim Kita](https://github.com/kitaisreal))。
* 新增用于 Unicode 规范化的函数：`normalizeUTF8NFC`、`normalizeUTF8NFD`、`normalizeUTF8NFKC`、`normalizeUTF8NFKD`。[#28633](https://github.com/ClickHouse/ClickHouse/pull/28633)（[darkkeks](https://github.com/darkkeks)）。
* 在 ClickHouse 中使用 `FileLog` 表引擎对应用日志文件进行流式消费。它类似于 `Kafka` 或 `RabbitMQ` 引擎，但用于处理本地文件系统中仅追加且会轮转的日志。关闭了 [#6953](https://github.com/ClickHouse/ClickHouse/issues/6953)。[#25969](https://github.com/ClickHouse/ClickHouse/pull/25969)（[flynn](https://github.com/ucasfl)）（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 添加 `CapnProto` 输出格式，并重构 `CapnProto` 输入格式。 [#29291](https://github.com/ClickHouse/ClickHouse/pull/29291) ([Kruglov Pavel](https://github.com/Avogar)).
* 允许在查询中以二进制字面量形式书写数字。例如 `SELECT 0b001;`。[#29304](https://github.com/ClickHouse/ClickHouse/pull/29304) ([Maksim Kita](https://github.com/kitaisreal)).
* 添加了 `hashed_array` 字典类型，在使用包含多个属性的字典时可以节省内存。关闭了 [#30236](https://github.com/ClickHouse/ClickHouse/issues/30236)。[#30242](https://github.com/ClickHouse/ClickHouse/pull/30242)（[Maksim Kita](https://github.com/kitaisreal)）。
* 新增了 `JSONExtractKeys` 函数。[#30056](https://github.com/ClickHouse/ClickHouse/pull/30056) ([Vitaly](https://github.com/orloffv))。
* 添加函数 `getOSKernelVersion` —— 返回操作系统内核版本字符串。 [#29755](https://github.com/ClickHouse/ClickHouse/pull/29755) ([Memo](https://github.com/Joeywzr))。
* 新增了 `MD4` 和 `SHA384` 函数。`MD4` 是一种已过时且不安全的哈希函数，只应在极少数场景下使用，例如某些遗留系统中已经在使用 `MD4`，并且你需要得到完全相同的结果时。 [#29602](https://github.com/ClickHouse/ClickHouse/pull/29602) ([Nikita Tikhomirov](https://github.com/NSTikhomirov)).
* 可以通过在配置文件中将 `hsts_max_age` 设置为正数来为 ClickHouse HTTP 服务器启用 HSTS。 [#29516](https://github.com/ClickHouse/ClickHouse/pull/29516) ([凌涛](https://github.com/lingtaolf)).
* 支持华为 OBS 存储。关闭 [#24294](https://github.com/ClickHouse/ClickHouse/issues/24294)。[#29511](https://github.com/ClickHouse/ClickHouse/pull/29511)（[kevin wan](https://github.com/MaxWk)）。
* 新增函数 `mapContainsKeyLike`，用于获取键名匹配简单正则表达式的 `map`。[#29471](https://github.com/ClickHouse/ClickHouse/pull/29471) ([凌涛](https://github.com/lingtaolf))。新增函数 `mapExtractKeyLike`，用于仅保留键名匹配指定模式的元素的 `map`。[#30793](https://github.com/ClickHouse/ClickHouse/pull/30793) ([凌涛](https://github.com/lingtaolf))。
* 已实现 `ALTER TABLE x MODIFY COMMENT`。 [#29264](https://github.com/ClickHouse/ClickHouse/pull/29264) ([Vasily Nemkov](https://github.com/Enmk)).
* 添加了 ClickHouse 中尚缺失、但可通过 H3 API 使用的 H3 检查函数：[https://h3geo.org/docs/api/inspection](https://h3geo.org/docs/api/inspection)。[#29209](https://github.com/ClickHouse/ClickHouse/pull/29209)（[Bharat Nallan](https://github.com/bharatnc)）。
* 允许在 Replicated 数据库中执行非复制表的 `ALTER TABLE FETCH` 和 `ATTACH`。 [#29202](https://github.com/ClickHouse/ClickHouse/pull/29202) ([Kevin Michel](https://github.com/kmichel-aiven)).
* 新增设置 `output_format_csv_null_representation`：其作用与 `output_format_tsv_null_representation` 相同，但用于 CSV 输出。 [#29123](https://github.com/ClickHouse/ClickHouse/pull/29123) ([PHO](https://github.com/depressed-pho))。
* 新增函数 `zookeeperSessionUptime()`，用于返回当前 ZooKeeper 会话的存活时间（以秒为单位）。[#28983](https://github.com/ClickHouse/ClickHouse/pull/28983) ([tavplubix](https://github.com/tavplubix)).
* 实现了 `h3ToGeoBoundary` 函数。[#28952](https://github.com/ClickHouse/ClickHouse/pull/28952)（[Ivan Veselov](https://github.com/fuzzERot)）。
* 添加聚合函数 `exponentialMovingAverage`，可作为窗口函数使用。关闭了 [#27511](https://github.com/ClickHouse/ClickHouse/issues/27511)。[#28914](https://github.com/ClickHouse/ClickHouse/pull/28914)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 允许在 `DESCRIBE` 查询结果中包含表中列的子列（可通过设置 `describe_include_subcolumns` 启用）。 [#28905](https://github.com/ClickHouse/ClickHouse/pull/28905) ([Anton Popov](https://github.com/CurtizJ)).
* `Executable`、`ExecutablePool` 添加了选项 `send_chunk_header`。如果该选项为 true，则会在发送数据块之前，先向客户端发送包含换行符的数据块行数（`rows_count`）。 [#28833](https://github.com/ClickHouse/ClickHouse/pull/28833) ([Maksim Kita](https://github.com/kitaisreal)).
* `tokenbf_v1` 和 `ngram` 支持键类型为 String 或 FixedString 的 Map。它可以在使用 Map 键进行过滤查询时增强数据跳过能力。`sql CREATE TABLE map_tokenbf ( row_id UInt32, map Map(String, String), INDEX map_tokenbf map TYPE ngrambf_v1(4,256,2,0) GRANULARITY 1 ) Engine=MergeTree() Order by id ` 对于上述表，查询 `select * from map_tokebf where map['K']='V'` 将会跳过不包含键 `A` 的数据颗粒。当然，实际会跳过多少行取决于你设置的 `granularity` 和 `index_granularity`。 [#28511](https://github.com/ClickHouse/ClickHouse/pull/28511) ([凌涛](https://github.com/lingtaolf)).
* 支持将 profile 事件从服务器发送到客户端。引入了新的数据包类型 `ProfileEvents`。修复 [#26177](https://github.com/ClickHouse/ClickHouse/issues/26177)。[#28364](https://github.com/ClickHouse/ClickHouse/pull/28364)（[Dmitry Novik](https://github.com/novikd)）。
* 为 `FixedString` 和 `String` 数据类型添加位移运算。这关闭了 [#27763](https://github.com/ClickHouse/ClickHouse/issues/27763)。[#28325](https://github.com/ClickHouse/ClickHouse/pull/28325)（[小路](https://github.com/nicelulu)）。
* 在数据库引擎 `MaterializedPostgreSQL` 中支持在复制过程中动态添加/删除表。支持对数据库设置执行 `ALTER`。关闭 [#27573](https://github.com/ClickHouse/ClickHouse/issues/27573)。[#28301](https://github.com/ClickHouse/ClickHouse/pull/28301) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 新增函数 accurateCastOrDefault(x, T)。修复 [#21330](https://github.com/ClickHouse/ClickHouse/issues/21330)。作者 @taiyang-li。 [#23028](https://github.com/ClickHouse/ClickHouse/pull/23028) ([Maksim Kita](https://github.com/kitaisreal))。
* 新增函数 `toUUIDOrDefault`、`toUInt8/16/32/64/256OrDefault`、`toInt8/16/32/64/128/256OrDefault`，允许用户在字符串解析失败时指定默认值（非 NULL）。 [#21330](https://github.com/ClickHouse/ClickHouse/pull/21330) ([taiyang-li](https://github.com/taiyang-li))。

#### 性能改进 {#performance-improvement-1}


* 后台合并任务可以互相抢占，并按照合适的优先级进行调度。现在长时间运行的合并不会阻塞短合并的执行。这样可以更好地调度和控制合并的执行，降低出现 “too many parts” 错误的概率。[#22381](https://github.com/ClickHouse/ClickHouse/issues/22381)。[#25165](https://github.com/ClickHouse/ClickHouse/pull/25165)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。新增支持执行数量多于后台线程池线程数的合并和变更（mutations）。合并和变更将按照其大小分步执行（越小优先级越高）。要执行的任务数与线程数的比例由设置 `background_merges_mutations_concurrency_ratio` 控制，默认值为 2。[#29140](https://github.com/ClickHouse/ClickHouse/pull/29140)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 允许对远程文件系统使用异步读取，减少从远程文件系统读取时的寻道次数。这极大地提升了性能，并且在某些条件下，使实验性的 `web` 和 `s3` 磁盘比 EBS 跑得更快。 [#29205](https://github.com/ClickHouse/ClickHouse/pull/29205) ([Kseniia Sumarokova](https://github.com/kssenii))。同时，`web` 磁盘类型（托管在 Web 服务器上的静态数据集）已从实验阶段毕业，正式达到可用于生产环境的成熟度。
* 在 `clickhouse-client` 中使用 `INTO OUTFILE` 的查询现在将使用多线程执行。修复了使用 `INTO OUTFILE` 时进度条闪烁的问题。此更改解决了 [#30873](https://github.com/ClickHouse/ClickHouse/issues/30873)。此更改解决了 [#30872](https://github.com/ClickHouse/ClickHouse/issues/30872)。[#30886](https://github.com/ClickHouse/ClickHouse/pull/30886) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 减少某些类型 `SELECT` 查询从磁盘读取的冗余压缩数据量（仅适用于 `MergeTree` 系列引擎）。[#30111](https://github.com/ClickHouse/ClickHouse/pull/30111) ([alesapin](https://github.com/alesapin)).
* 在读取 MergeTree 系列表引擎中的压缩数据块时，移除了一些冗余的 `seek` 调用。[#29766](https://github.com/ClickHouse/ClickHouse/pull/29766) ([alesapin](https://github.com/alesapin)).
* 使 `url` 表函数能够并行处理多个 URL。此更改关闭了 [#29670](https://github.com/ClickHouse/ClickHouse/issues/29670) 和 [#29671](https://github.com/ClickHouse/ClickHouse/issues/29671)。[#29673](https://github.com/ClickHouse/ClickHouse/pull/29673)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在启用设置 `optimize_aggregation_in_order` 时，提升按主键顺序执行聚合的性能。 [#30266](https://github.com/ClickHouse/ClickHouse/pull/30266) ([Anton Popov](https://github.com/CurtizJ)).
* 现在，ClickHouse 在与外部 S3 通信时会使用 DNS 缓存。[#29999](https://github.com/ClickHouse/ClickHouse/pull/29999) ([alesapin](https://github.com/alesapin))。
* 为外部数据库（例如 MySQL）添加对 `IS NULL`/`IS NOT NULL` 条件下推的支持。 [#29463](https://github.com/ClickHouse/ClickHouse/pull/29463) ([Azat Khuzhin](https://github.com/azat))。将 `isNull`/`isNotNull` 转换为 `IS NULL`/`IS NOT NULL`（用于外部数据库，例如 MySQL）。 [#29446](https://github.com/ClickHouse/ClickHouse/pull/29446) ([Azat Khuzhin](https://github.com/azat))。
* 来自字典表的 SELECT 查询将使用多线程。[#30500](https://github.com/ClickHouse/ClickHouse/pull/30500) ([Maksim Kita](https://github.com/kitaisreal))。
* 提升对 `Decimal` 列进行筛选（`WHERE` 操作）时的性能。 [#30431](https://github.com/ClickHouse/ClickHouse/pull/30431) ([Jun Jin](https://github.com/vesslanjin))。
* 在 `filter` 操作中用基于 `popcnt`/`ctz` 的更优实现替换包含大量分支的代码，以提升性能。[#29881](https://github.com/ClickHouse/ClickHouse/pull/29881) ([Jun Jin](https://github.com/vesslanjin))。
* 改进用于 `WHERE` 运算符的过滤字节掩码（bytemask）生成器，将 SSE/AVX2/AVX512 指令统一为一个函数实现。注意，默认情况下 ClickHouse 只使用 SSE，因此这仅与自定义构建相关。[#30014](https://github.com/ClickHouse/ClickHouse/pull/30014) ([jasperzhu](https://github.com/jinjunzh))。[#30670](https://github.com/ClickHouse/ClickHouse/pull/30670) ([jasperzhu](https://github.com/jinjunzh))。
* 提升对 `Nullable` 浮点数执行 `SUM` 聚合函数时的性能。 [#28906](https://github.com/ClickHouse/ClickHouse/pull/28906) ([Raúl Marín](https://github.com/Algunenano))。
* 在使用多个磁盘时加速数据分片加载过程。思路类似于 [https://github.com/ClickHouse/ClickHouse/pull/16423](https://github.com/ClickHouse/ClickHouse/pull/16423)。生产环境中显示性能提升：24 分钟 → 16 分钟。[#28363](https://github.com/ClickHouse/ClickHouse/pull/28363)（[Amos Bird](https://github.com/amosbird)）。
* 降低 S3 分段上传的默认分片大小以减少内存占用。[#28679](https://github.com/ClickHouse/ClickHouse/pull/28679) ([ianton-ru](https://github.com/ianton-ru)).
* 加快 `bitmapAnd` 函数的执行速度。[#28332](https://github.com/ClickHouse/ClickHouse/pull/28332) ([dddounaiking](https://github.com/OodounaikingoO))。
* 在合并仍在进行时，移除了 `StorageMergeTree` 中次优的变更通知。 [#27552](https://github.com/ClickHouse/ClickHouse/pull/27552) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 尝试提升字符串比较的性能。 [#28767](https://github.com/ClickHouse/ClickHouse/pull/28767) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 主键索引和分区过滤器现在支持在 `tuple` 上工作。 [#29281](https://github.com/ClickHouse/ClickHouse/pull/29281) ([凌涛](https://github.com/lingtaolf)).
* 如果查询中包含多个 `quantile` 聚合函数，它们具有相同的参数但 level 参数不同，那么在启用 `optimize_syntax_fuse_functions` 设置时，这些函数会被合并并在一次遍历中执行。 [#26657](https://github.com/ClickHouse/ClickHouse/pull/26657) ([hexiaoting](https://github.com/hexiaoting)).
* 现在通过 projection 对主键首个表达式的 min-max 聚合进行了优化。此改进对应于 [#329](https://github.com/ClickHouse/ClickHouse/issues/329)。[#29918](https://github.com/ClickHouse/ClickHouse/pull/29918) ([Amos Bird](https://github.com/amosbird))。

#### 实验性功能 {#experimental-feature-1}

- 为 ClickHouse Keeper 添加了在 `.xml` 文件中修改节点配置的能力。[#30372](https://github.com/ClickHouse/ClickHouse/pull/30372) ([alesapin](https://github.com/alesapin))。
- 添加了 `sparkbar` 聚合函数。此更新关闭了 [#26175](https://github.com/ClickHouse/ClickHouse/issues/26175)。[#27481](https://github.com/ClickHouse/ClickHouse/pull/27481) ([小路](https://github.com/nicelulu))。注意:该函数存在一个缺陷,其行为将在未来版本中进行修改。

#### 改进 {#improvement-1}


* 允许用户在无需重启的情况下修改日志级别。 [#29586](https://github.com/ClickHouse/ClickHouse/pull/29586) ([Nikolay Degterinsky](https://github.com/evillique)).
* 针对 SQL UDF 的多项改进。用于操作 SQL 用户自定义函数的查询现在支持 `ON CLUSTER` 子句。例如：`CREATE FUNCTION test_function ON CLUSTER 'cluster' AS x -> x + 1;`。修复了 [#30666](https://github.com/ClickHouse/ClickHouse/issues/30666)。[#30734](https://github.com/ClickHouse/ClickHouse/pull/30734)（[Maksim Kita](https://github.com/kitaisreal)）。支持 `CREATE OR REPLACE`、`CREATE IF NOT EXISTS` 语法。[#30454](https://github.com/ClickHouse/ClickHouse/pull/30454)（[Maksim Kita](https://github.com/kitaisreal)）。新增对 `DROP IF EXISTS` 的支持。例如：`DROP FUNCTION IF EXISTS test_function`。[#30437](https://github.com/ClickHouse/ClickHouse/pull/30437)（[Maksim Kita](https://github.com/kitaisreal)）。支持 lambda 表达式。例如：`CREATE FUNCTION lambda_function AS x -> arrayMap(element -> element * 2, x);`。[#30435](https://github.com/ClickHouse/ClickHouse/pull/30435)（[Maksim Kita](https://github.com/kitaisreal)）。在 `clickhouse-local` 中支持 SQL 用户自定义函数。[#30179](https://github.com/ClickHouse/ClickHouse/pull/30179)（[Maksim Kita](https://github.com/kitaisreal)）。
* 在全局范围内启用按查询的内存分析器（将 `memory_profiler_step` 设置为 4MiB）。[#29455](https://github.com/ClickHouse/ClickHouse/pull/29455)（[Azat Khuzhin](https://github.com/azat)）。
* 在 `system.data_skipping_indices` 中新增列 `data_compressed_bytes`、`data_uncompressed_bytes`、`marks_bytes`。在 `system.parts` 中新增列 `secondary_indices_compressed_bytes`、`secondary_indices_uncompressed_bytes`、`secondary_indices_marks_bytes`。修复了 [#29697](https://github.com/ClickHouse/ClickHouse/issues/29697)。[#29896](https://github.com/ClickHouse/ClickHouse/pull/29896)（[Maksim Kita](https://github.com/kitaisreal)）。
* 为 `system.tables` 添加 `table` 别名，为 `system.databases` 添加 `database` 别名 [#29677](https://github.com/ClickHouse/ClickHouse/issues/29677)。 [#29882](https://github.com/ClickHouse/ClickHouse/pull/29882)（[kevin wan](https://github.com/MaxWk)）。
* 在服务器启动时正确解析表之间的相互依赖关系。修复了 [#8004](https://github.com/ClickHouse/ClickHouse/issues/8004) 和 [#15170](https://github.com/ClickHouse/ClickHouse/issues/15170)。[#28373](https://github.com/ClickHouse/ClickHouse/pull/28373)（[tavplubix](https://github.com/tavplubix)）。
* 当函数 `divide`、`intDiv` 和 `modulo` 的分母为 Nullable 时，避免出现 “Division by zero” 错误。关闭 [#22621](https://github.com/ClickHouse/ClickHouse/issues/22621)。 [#28352](https://github.com/ClickHouse/ClickHouse/pull/28352)（[Kruglov Pavel](https://github.com/Avogar)）。
* 允许在文本格式中将 `Date` 数据类型的值解析为 `YYYYMMDD` 格式，除了原有的 `YYYY-MM-DD` 之外。修复了 [#30870](https://github.com/ClickHouse/ClickHouse/issues/30870)。[#30871](https://github.com/ClickHouse/ClickHouse/pull/30871)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* Web UI：在表格单元格中渲染条形。 [#29792](https://github.com/ClickHouse/ClickHouse/pull/29792) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 用户现在可以在创建字典时添加注释：`CREATE DICTIONARY ... COMMENT 'vaue'` ... [#29899](https://github.com/ClickHouse/ClickHouse/pull/29899) ([Vasily Nemkov](https://github.com/Enmk))。用户现在也可以在 `CREATE DATABASE` 语句中为数据库添加注释 ... [#29429](https://github.com/ClickHouse/ClickHouse/pull/29429) ([Vasily Nemkov](https://github.com/Enmk))。
* 引入 `compiled_expression_cache_elements_size` 设置。如果你以后会想用这个设置，你自己就已经知道它是干什么的了。 [#30667](https://github.com/ClickHouse/ClickHouse/pull/30667) ([Maksim Kita](https://github.com/kitaisreal)).
* `clickhouse-format` 现在支持选项 `--query`。在之前的版本中，必须通过 stdin 传递查询。[#29325](https://github.com/ClickHouse/ClickHouse/pull/29325) ([凌涛](https://github.com/lingtaolf))。
* 为 `Memory` 数据库中的表提供 `ALTER TABLE` 支持。`Memory` 数据库用于 `clickhouse-local`。[#30866](https://github.com/ClickHouse/ClickHouse/pull/30866) ([tavplubix](https://github.com/tavplubix)).
* 现在，`arrayStringConcat` 已支持所有可序列化类型的数组。[#30840](https://github.com/ClickHouse/ClickHouse/pull/30840)（[Nickita Taranov](https://github.com/nickitat)）。
* ClickHouse 现在在获取系统内存总量时会考虑 docker/cgroups 的限制。参见 [#25662](https://github.com/ClickHouse/ClickHouse/issues/25662)。[#30574](https://github.com/ClickHouse/ClickHouse/pull/30574)（[Pavel Medvedev](https://github.com/pmed)）。
* 现在获取 PostgreSQL 数据库表结构的过程更加可靠。 [#30477](https://github.com/ClickHouse/ClickHouse/pull/30477) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 在 `GROUP BY` 和 `ORDER BY` 中对位置参数提供了完整支持。 [#30433](https://github.com/ClickHouse/ClickHouse/pull/30433) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 允许使用 JSONExtractString 将非字符串元素提取为字符串。参见 [pull/25452#issuecomment-927123287](https://github.com/ClickHouse/ClickHouse/pull/25452#issuecomment-927123287)。[#30426](https://github.com/ClickHouse/ClickHouse/pull/30426)（[Amos Bird](https://github.com/amosbird)）。
* 在对 `GraphiteMergeTree` 执行 `SELECT` 查询时，现在支持使用 `FINAL` 子句。 [#30360](https://github.com/ClickHouse/ClickHouse/pull/30360) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 在副本克隆以及为损坏的数据部分入队抓取任务方面做了一些小改进，从而避免极其罕见的 `GET_PART` 条目在复制队列中卡住的情况。[#30346](https://github.com/ClickHouse/ClickHouse/pull/30346) ([tavplubix](https://github.com/tavplubix))。
* 允许在 `user_files` 目录中的文件上使用符号链接用于 `file` 表函数。 [#30309](https://github.com/ClickHouse/ClickHouse/pull/30309) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 修复了 `Date32` 与 `Date`、`DateTime`、`DateTime64` 和 `String` 的比较问题。 [#30219](https://github.com/ClickHouse/ClickHouse/pull/30219) ([liang.huang](https://github.com/lhuang09287750))。
* 允许从 `MergeTree` 表中删除 `SAMPLE BY` 表达式（`ALTER TABLE &lt;table&gt; REMOVE SAMPLE BY`）。 [#30180](https://github.com/ClickHouse/ClickHouse/pull/30180) ([Anton Popov](https://github.com/CurtizJ)).
* 现在，如果 `Keeper`（作为 `clickhouse-server` 的一部分）可以连接到其他节点中的任意一个，它将以异步方式启动。[#30170](https://github.com/ClickHouse/ClickHouse/pull/30170) ([alesapin](https://github.com/alesapin))。
* 现在 `clickhouse-client` 支持原生的多行编辑。[#30143](https://github.com/ClickHouse/ClickHouse/pull/30143) ([Amos Bird](https://github.com/amosbird))。
* `polygon` 字典（反向地理编码）：在将 `store_polygon_key_column` 设置为 true 时，新增支持通过 SELECT 查询方式读取字典内容。修复了 [#30090](https://github.com/ClickHouse/ClickHouse/issues/30090)。[#30142](https://github.com/ClickHouse/ClickHouse/pull/30142)（[Maksim Kita](https://github.com/kitaisreal)）。
* 在 Play UI 中添加 ClickHouse 标志。[#29674](https://github.com/ClickHouse/ClickHouse/pull/29674) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 在从 `Arrow`、`ArrowStream`、`Parquet` 和 `ORC` 等 Arrow 支持的格式读取列时提供了更清晰的异常信息。此更改关闭了 [#29926](https://github.com/ClickHouse/ClickHouse/issues/29926)。[#29927](https://github.com/ClickHouse/ClickHouse/pull/29927)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `Buffer` 表中 `flush` 与启动之间的数据竞争问题。该问题可能会在测试中出现。[#29930](https://github.com/ClickHouse/ClickHouse/pull/29930)（[Azat Khuzhin](https://github.com/azat)）。
* 修复 `DatabaseMemory` 的 `DROP TABLE` 与 `LiveView` 之间的 `lock-order-inversion`。`Live View` 是一个实验性功能。`Memory` 数据库用于 `clickhouse-local` 中。 [#29929](https://github.com/ClickHouse/ClickHouse/pull/29929) ([Azat Khuzhin](https://github.com/azat)).
* 修复周期性字典重新加载与配置重新加载之间的锁顺序反转问题。 [#29928](https://github.com/ClickHouse/ClickHouse/pull/29928) ([Azat Khuzhin](https://github.com/azat)).
* 将 zoneinfo 文件更新到 2021c。[#29925](https://github.com/ClickHouse/ClickHouse/pull/29925)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 `clickhouse-copier` 增加可配置的重试次数及其间隔。 [#29921](https://github.com/ClickHouse/ClickHouse/pull/29921) ([Azat Khuzhin](https://github.com/azat)).
* 添加 `shutdown_wait_unfinished_queries` 服务器设置，以便在 `shutdown_wait_unfinished` 指定的时间内等待正在运行的查询。这是针对 [#24451](https://github.com/ClickHouse/ClickHouse/issues/24451) 的更改。[#29914](https://github.com/ClickHouse/ClickHouse/pull/29914)（[Amos Bird](https://github.com/amosbird)）。
* 新增峰值内存使用情况的跟踪功能（在 `system.trace_log` 中新增 `trace_type` - `MemoryPeak`）。[#29858](https://github.com/ClickHouse/ClickHouse/pull/29858) ([Azat Khuzhin](https://github.com/azat))。
* PostgreSQL 外部表：在用于获取副本标识索引的查询中添加了分区表前缀 &#39;p&#39;。 [#29828](https://github.com/ClickHouse/ClickHouse/pull/29828) ([Shoh Jahon](https://github.com/Shohjahon)).
* 在 mutate/merge 期间应用 `max_untracked_memory` / `memory_profiler_step` / `memory_profiler_sample_probability`，以在合并操作时分析内存使用情况。 [#29681](https://github.com/ClickHouse/ClickHouse/pull/29681) ([Azat Khuzhin](https://github.com/azat)).
* 查询混淆器：`clickhouse-format --obfuscate` 现在适用于更多类型的查询。[#29672](https://github.com/ClickHouse/ClickHouse/pull/29672) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复了 `clickhouse-format --obfuscate` 无法处理包含内置字典（`regionTo...` 系列函数）的查询的问题。 [#29667](https://github.com/ClickHouse/ClickHouse/pull/29667) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复 JSON 函数对 `Nullable` 的错误处理。该修复解决了 [#29615](https://github.com/ClickHouse/ClickHouse/issues/29615)。将其标记为改进项，因为 [https://github.com/ClickHouse/ClickHouse/pull/28012](https://github.com/ClickHouse/ClickHouse/pull/28012) 尚未发布。[#29659](https://github.com/ClickHouse/ClickHouse/pull/29659)（[Amos Bird](https://github.com/amosbird)）。
* 默认将 `listen_backlog` 调大（以匹配新版 Linux 内核的默认值）。 [#29643](https://github.com/ClickHouse/ClickHouse/pull/29643) ([Azat Khuzhin](https://github.com/azat)).
* 当服务器配置 `dictionaries_config`、`models_config`、`user_defined_executable_functions_config` 发生变化时，重新加载字典、模型和用户定义的可执行函数。修复 [#28142](https://github.com/ClickHouse/ClickHouse/issues/28142)。[#29529](https://github.com/ClickHouse/ClickHouse/pull/29529)（[Maksim Kita](https://github.com/kitaisreal)）。
* 取消了对 projection 名称的无意义限制。现在 projection 名称可以以 `tmp_` 开头。[#29520](https://github.com/ClickHouse/ClickHouse/pull/29520)（[Amos Bird](https://github.com/amosbird)）。
* 修复了在包含嵌套子查询的 mutation 中出现 `There is no query or query context has expired` 错误的问题。如果是副本表且禁用了 `allow_nondeterministic_mutations` 设置，则不允许在 mutation 中使用子查询。[#29495](https://github.com/ClickHouse/ClickHouse/pull/29495) ([tavplubix](https://github.com/tavplubix)).
* 在运行时应用对 `max_concurrent_queries` 的配置更改（无需重启）。[#29414](https://github.com/ClickHouse/ClickHouse/pull/29414) ([Raúl Marín](https://github.com/Algunenano))。
* 新增了设置项 `use_skip_indexes`。 [#29405](https://github.com/ClickHouse/ClickHouse/pull/29405) ([Maksim Kita](https://github.com/kitaisreal)).
* 为内存分片添加 `FREEZE` 支持（用于备份）。 [#29376](https://github.com/ClickHouse/ClickHouse/pull/29376) ([Mo Xuan](https://github.com/mo-avatar)).
* 为 `clickhouse-benchmark` 传递初始 query&#95;id（此前如果通过 `clickhouse-benchmark` 运行远程查询，各个分片上的查询不会通过 `initial_query_id` 关联到初始查询）。 [#29364](https://github.com/ClickHouse/ClickHouse/pull/29364) ([Azat Khuzhin](https://github.com/azat)).
* 跳过索引 `tokenbf_v1` 和 `ngrambf_v1`：新增对键为 `String` 或 `FixedString` 类型的 `Array` 数据类型的支持。[#29280](https://github.com/ClickHouse/ClickHouse/pull/29280) ([Maksim Kita](https://github.com/kitaisreal))。跳过索引 `tokenbf_v1` 和 `ngrambf_v1`：新增对键为 `String` 或 `FixedString` 类型的 `Map` 数据类型的支持。作者 @lingtaolf。[#29220](https://github.com/ClickHouse/ClickHouse/pull/29220) ([Maksim Kita](https://github.com/kitaisreal))。
* 函数 `has`：新增对 `Map` 数据类型的支持。[#29267](https://github.com/ClickHouse/ClickHouse/pull/29267)（[Maksim Kita](https://github.com/kitaisreal)）。
* 为 clickhouse-keeper 添加 `compress_logs` 设置，用于使用 `ZSTD` 压缩 clickhouse-keeper 的日志（用于 replicated state machine）。实现：[#26977](https://github.com/ClickHouse/ClickHouse/issues/26977)。[#29223](https://github.com/ClickHouse/ClickHouse/pull/29223) ([alesapin](https://github.com/alesapin))。
* 添加设置 `external_table_strict_query` —— 即使与外部数据库不兼容，也会在查询中强制将整个 WHERE 表达式传递给外部数据库。[#29206](https://github.com/ClickHouse/ClickHouse/pull/29206) ([Azat Khuzhin](https://github.com/azat))。
* 当使用 `ARRAY JOIN` 时禁用投影。在之前的版本中，投影分析可能会破坏 ARRAY JOIN 中的别名。[#29139](https://github.com/ClickHouse/ClickHouse/pull/29139) ([Amos Bird](https://github.com/amosbird))。
* 在 `MsgPack` 输入/输出格式中支持更多数据类型。[#29077](https://github.com/ClickHouse/ClickHouse/pull/29077) ([Kruglov Pavel](https://github.com/Avogar)).
* 允许在 `ORC` 输入/输出格式中读写 `LowCardinality` 列。[#29062](https://github.com/ClickHouse/ClickHouse/pull/29062) ([Kruglov Pavel](https://github.com/Avogar)).
* 从 `system.distributed_ddl_queue` 中执行 `SELECT` 查询可能会显示不正确的值，该问题已修复。[#29061](https://github.com/ClickHouse/ClickHouse/pull/29061) ([tavplubix](https://github.com/tavplubix)).
* 为 HTTP 连接在遇到未知方法时实现了正确的处理行为。解决了 [#29050](https://github.com/ClickHouse/ClickHouse/issues/29050)。[#29057](https://github.com/ClickHouse/ClickHouse/pull/29057)（[Filatenkov Artur](https://github.com/FArthur-cmd)）。
* `clickhouse-keeper`：修复 `clickhouse-keeper-converter` 中的一个 bug，该 bug 会在从 ZooKeeper 日志（非快照）恢复时导致部分数据丢失。[#29030](https://github.com/ClickHouse/ClickHouse/pull/29030)（[小路](https://github.com/nicelulu)）。修复 `clickhouse-keeper-converter` 中的一个 bug，该 bug 会导致 ZooKeeper 日志反序列化结果不正确。[#29071](https://github.com/ClickHouse/ClickHouse/pull/29071)（[小路](https://github.com/nicelulu)）。
* 从 `CREATE ... AS SELECT` 查询中应用设置（修复：[#28810](https://github.com/ClickHouse/ClickHouse/issues/28810)）。[#28962](https://github.com/ClickHouse/ClickHouse/pull/28962)（[Azat Khuzhin](https://github.com/azat)）。
* 在执行 `ALTER TABLE ... ON CLUSTER ... REPLACE/MOVE PARTITION FROM/TO ...` 时遵循默认数据库设置 [#28955](https://github.com/ClickHouse/ClickHouse/pull/28955) ([anneji-dev](https://github.com/anneji-dev))。
* gRPC 协议：允许客户端更改服务端的压缩方式。[#28953](https://github.com/ClickHouse/ClickHouse/pull/28953) ([Vitaly Baranov](https://github.com/vitlibar)).
* 在读取用于异步指标的温度传感器时跳过“no data”异常。此更改关闭了 [#28852](https://github.com/ClickHouse/ClickHouse/issues/28852)。[#28882](https://github.com/ClickHouse/ClickHouse/pull/28882)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了一个逻辑竞态问题，在极少数情况下可能会导致现有字典出现 `Dictionary not found` 错误。[#28853](https://github.com/ClickHouse/ClickHouse/pull/28853) ([tavplubix](https://github.com/tavplubix)).
* 放宽对 `If` 组合器进行检查时对嵌套函数的限制（但禁止嵌套相同的组合器）。[#28828](https://github.com/ClickHouse/ClickHouse/pull/28828) ([Azat Khuzhin](https://github.com/azat)).
* 修复服务器终止过程中的可能未捕获异常。[#28761](https://github.com/ClickHouse/ClickHouse/pull/28761) ([Azat Khuzhin](https://github.com/azat)).
* 在 mutation/merge 持续时间异常过长时，禁止清理可能被正在执行的 mutation/merge 使用的 tmp 目录。 [#28760](https://github.com/ClickHouse/ClickHouse/pull/28760) ([Azat Khuzhin](https://github.com/azat)).
* 当使用别名时，允许进行优化 `optimize_arithmetic_operations_in_aggregate_functions = 1`。 [#28746](https://github.com/ClickHouse/ClickHouse/pull/28746) ([Amos Bird](https://github.com/amosbird))。
* 为 `ReplicatedMergeTree` 实现 `detach_not_byte_identical_parts` 设置，使其在合并/变更后，对非字节级完全相同的部分执行分离而不是删除。[#28708](https://github.com/ClickHouse/ClickHouse/pull/28708) ([Azat Khuzhin](https://github.com/azat)).
* 为 `MergeTree` 实现 `max_suspicious_broken_parts_bytes` 设置（用于限制所有损坏分区的总大小，默认值为 `1GiB`）。 [#28707](https://github.com/ClickHouse/ClickHouse/pull/28707) ([Azat Khuzhin](https://github.com/azat))。
* 在 `RabbitMQ` 表设置中启用宏扩展。[#28683](https://github.com/ClickHouse/ClickHouse/pull/28683) ([Vitaly Baranov](https://github.com/vitlibar)).
* 恢复使用 `Log` 引擎以多线程读取表数据的功能。[#28125](https://github.com/ClickHouse/ClickHouse/pull/28125) ([Vitaly Baranov](https://github.com/vitlibar))。
* 修复了 JSON 函数中对 `NULL` 列处理不当的问题。该修复解决了 [#27930](https://github.com/ClickHouse/ClickHouse/issues/27930)。[#28012](https://github.com/ClickHouse/ClickHouse/pull/28012)（[Amos Bird](https://github.com/amosbird)）。
* 允许为跳过索引单独设置标记/未压缩缓存的大小，与列缓存分开配置。 [#27961](https://github.com/ClickHouse/ClickHouse/pull/27961) ([Amos Bird](https://github.com/amosbird)).
* 允许将带有 `USING` 的 JOIN 与其他类型的 JOIN 混合使用。 [#23881](https://github.com/ClickHouse/ClickHouse/pull/23881) ([darkkeks](https://github.com/darkkeks)).
* 为改进在 Yandex Cloud S3 中的限流处理，更新 `aws-sdk` 子模块。[#30646](https://github.com/ClickHouse/ClickHouse/pull/30646) ([ianton-ru](https://github.com/ianton-ru))。
* 修复在处理 gRPC 调用时于查询处理结束阶段释放 `query ID` 和 `session ID` 的逻辑。[#29954](https://github.com/ClickHouse/ClickHouse/pull/29954) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复 `AccessControlManager` 的关闭逻辑，解决不稳定的测试。[#29951](https://github.com/ClickHouse/ClickHouse/pull/29951) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复从 `HDFS` 读取时的断言失败。更新 libhdfs3 库，使其能够在调试模式下运行测试。修复 [#29251](https://github.com/ClickHouse/ClickHouse/issues/29251)。修复 [#27814](https://github.com/ClickHouse/ClickHouse/issues/27814)。[#29276](https://github.com/ClickHouse/ClickHouse/pull/29276)（[Kseniia Sumarokova](https://github.com/kssenii)）。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-1}

- 添加对 Aarch64 架构 FreeBSD 构建的支持。[#29952](https://github.com/ClickHouse/ClickHouse/pull/29952) ([MikaelUrankar](https://github.com/MikaelUrankar))。
- ClickHouse 不再需要递归子模块。[#30315](https://github.com/ClickHouse/ClickHouse/pull/30315) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- ClickHouse 现在可以使用 Musl 进行静态构建。此功能作为实验性特性添加,不支持构建 `odbc-bridge`、`library-bridge`、与 CatBoost 的集成以及部分库。[#30248](https://github.com/ClickHouse/ClickHouse/pull/30248) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 为 `AArch64` 和 `Darwin` (macOS) 构建启用 `Protobuf`、`Arrow`、`ORC`、`Parquet` 支持。此更改解决了 [#29248](https://github.com/ClickHouse/ClickHouse/issues/29248)。此更改解决了 [#28018](https://github.com/ClickHouse/ClickHouse/issues/28018)。[#30015](https://github.com/ClickHouse/ClickHouse/pull/30015) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 添加 PowerPC (powerpc64le) 的交叉编译支持。此更改解决了 [#9589](https://github.com/ClickHouse/ClickHouse/issues/9589)。为 AArch64 和 PowerPC 启用与 MySQL 交互的支持。此更改解决了 [#26301](https://github.com/ClickHouse/ClickHouse/issues/26301)。[#30010](https://github.com/ClickHouse/ClickHouse/pull/30010) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 在交叉编译工具链中仅保留必需的文件。将它们作为子模块包含(之前以 tarball 形式下载)。[#29974](https://github.com/ClickHouse/ClickHouse/pull/29974) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 在 ClickHouse 中为 select 语句解析器实现了结构感知的模糊测试方法。[#30012](https://github.com/ClickHouse/ClickHouse/pull/30012) ([Paul](https://github.com/PaulCher))。
- 为 clang 启用实验性 constexpr 表达式求值器以加速模板代码编译。[#29668](https://github.com/ClickHouse/ClickHouse/pull/29668) ([myrrc](https://github.com/myrrc))。
- 添加使用较新版本 glibc 进行编译而不使用新符号的功能。[#29594](https://github.com/ClickHouse/ClickHouse/pull/29594) ([Azat Khuzhin](https://github.com/azat))。
- 通过 clang 优化选项减小 Debug 构建的二进制文件大小。[#28736](https://github.com/ClickHouse/ClickHouse/pull/28736) ([flynn](https://github.com/ucasfl))。
- 现在所有 CI 镜像将放置在单独的 dockerhub 仓库中。[#28656](https://github.com/ClickHouse/ClickHouse/pull/28656) ([alesapin](https://github.com/alesapin))。
- 改进对使用 clang-13 构建的支持。[#28046](https://github.com/ClickHouse/ClickHouse/pull/28046) ([Sergei Semin](https://github.com/syominsergey))。
- 添加向 `clickhouse-client` 打印原始性能事件的功能(这对调试和测试很有用)。[#30064](https://github.com/ClickHouse/ClickHouse/pull/30064) ([Azat Khuzhin](https://github.com/azat))。
- 为 clickhouse-server 单元添加时间依赖(systemd 和 sysvinit init)。[#28891](https://github.com/ClickHouse/ClickHouse/pull/28891) ([Azat Khuzhin](https://github.com/azat))。
- 当符号重新加载时重新加载堆栈跟踪缓存。[#28137](https://github.com/ClickHouse/ClickHouse/pull/28137) ([Amos Bird](https://github.com/amosbird))。

#### 错误修复 {#bug-fix}


* 用于在 UTF-8 字符串中进行不区分大小写搜索的函数（如 `positionCaseInsensitiveUTF8` 和 `countSubstringsCaseInsensitiveUTF8`）在极少数情况下可能会找到实际上并不匹配的子字符串，该问题已修复。 [#30663](https://github.com/ClickHouse/ClickHouse/pull/30663) ([tavplubix](https://github.com/tavplubix))。
* 修复在加密磁盘上读取空文件时的问题。 [#30494](https://github.com/ClickHouse/ClickHouse/pull/30494) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复在设置 `legacy_column_name_of_tuple_literal = 0` 时的分布式查询中，将析取链优化为 `IN`（由设置 `optimize_min_equality_disjunction_chain_length` 控制）的问题。 [#28658](https://github.com/ClickHouse/ClickHouse/pull/28658) ([Anton Popov](https://github.com/CurtizJ)).
* 允许在分布式表中使用物化列作为分片键，即使 `insert_allow_materialized_columns=0`：[ #28637](https://github.com/ClickHouse/ClickHouse/pull/28637) ([Vitaly Baranov](https://github.com/vitlibar))。
* 修复在结果集为空且设置了 `TO` 和 `FROM` 时，使用 `ORDER BY ... WITH FILL` 的问题。[#30888](https://github.com/ClickHouse/ClickHouse/pull/30888) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在包含两个以上操作数的 AND/OR 表达式中未使用集合索引（set index）的问题。修复了 [#30416](https://github.com/ClickHouse/ClickHouse/issues/30416)。[#30887](https://github.com/ClickHouse/ClickHouse/pull/30887)（[Amos Bird](https://github.com/amosbird)）。
* 修复了在物化包含哈希函数的 projection 时发生的崩溃。这修复了 [#30861](https://github.com/ClickHouse/ClickHouse/issues/30861)。该问题与 [https://github.com/ClickHouse/ClickHouse/pull/28560](https://github.com/ClickHouse/ClickHouse/pull/28560) 类似，根本原因同样是对 header 为空这一不变量缺乏正确理解。[#30877](https://github.com/ClickHouse/ClickHouse/pull/30877)（[Amos Bird](https://github.com/amosbird)）。
* 修复了在 `ReplicatedMergeTree` 中从 ZooKeeper 路径提取辅助 ZooKeeper 名称时存在的歧义问题。此前，如果 ZooKeeper 路径中包含冒号，服务器在启动时可能会失败并报错 `Unknown auxiliary ZooKeeper name`。修复了 [#29052](https://github.com/ClickHouse/ClickHouse/issues/29052)。另外，此前允许指定不以斜杠开头的 ZooKeeper 路径，但该用法现在已被弃用，且不再允许使用此类路径创建新表。辅助 ZooKeeper 名称中同样不允许包含斜杠和冒号。[#30822](https://github.com/ClickHouse/ClickHouse/pull/30822) ([tavplubix](https://github.com/tavplubix))。
* 当 `localBackup` 因某些原因失败时，清理临时目录。[#30797](https://github.com/ClickHouse/ClickHouse/pull/30797) ([ianton-ru](https://github.com/ianton-ru))。
* 修复了在非复制的 `MergeTree` 中，`REPLACE/MOVE PARTITION` 与后台合并之间的竞争条件，该问题可能导致已移动/替换的数据部分仍然留在分区中。修复了 [#29327](https://github.com/ClickHouse/ClickHouse/issues/29327)。[#30717](https://github.com/ClickHouse/ClickHouse/pull/30717) ([tavplubix](https://github.com/tavplubix))。
* 在 `PREWHERE` 条件恒为真的情况下，将其替换为 `WHERE`。 [#30668](https://github.com/ClickHouse/ClickHouse/pull/30668) ([Azat Khuzhin](https://github.com/azat)).
* Limit 下推优化可能会导致 `Cannot find column` 错误。修复 [#30438](https://github.com/ClickHouse/ClickHouse/issues/30438)。[#30562](https://github.com/ClickHouse/ClickHouse/pull/30562)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 为将 `isNotNull`/`isNull` 重写为 `IS [NOT] NULL` 的逻辑补全缺失的括号（修复包含类似 `isNotNull(1)+isNotNull(2)` 表达式的查询）。[#30520](https://github.com/ClickHouse/ClickHouse/pull/30520) ([Azat Khuzhin](https://github.com/azat))。
* 修复在对同一张表执行包含标量子查询的 `ALTER` 时出现的死锁，关闭 [#30461](https://github.com/ClickHouse/ClickHouse/issues/30461)。[#30492](https://github.com/ClickHouse/ClickHouse/pull/30492)（[Vladimir C](https://github.com/vdimir)）。
* 修复了在执行 REPLACE PARTITION 期间会话过期时可能出现的段错误。 [#30432](https://github.com/ClickHouse/ClickHouse/pull/30432) ([tavplubix](https://github.com/tavplubix)).
* 在应用聚合投影（aggregate projection）时，带有 `IN (subquery)` 条件的查询可能会返回不正确的结果。已修复用于投影的集合创建问题。[#30310](https://github.com/ClickHouse/ClickHouse/pull/30310) ([Amos Bird](https://github.com/amosbird))。
* 在启用投影时修复 `JOIN` 查询的列别名解析问题。此修复解决了 [#30146](https://github.com/ClickHouse/ClickHouse/issues/30146)。[#30293](https://github.com/ClickHouse/ClickHouse/pull/30293)（[Amos Bird](https://github.com/amosbird)）。
* 修复 `replaceRegexpAll` 函数中的一些问题。 [#30292](https://github.com/ClickHouse/ClickHouse/pull/30292) ([Memo](https://github.com/Joeywzr)).
* 修复 ComplexKeyHashedDictionary、ComplexKeySparseHashedDictionary 从布局配置解析 `preallocate` 选项时的问题。 [#30246](https://github.com/ClickHouse/ClickHouse/pull/30246) ([Maksim Kita](https://github.com/kitaisreal)).
* 修复 `[I]LIKE` 函数。修复了 [#28661](https://github.com/ClickHouse/ClickHouse/issues/28661)。[#30244](https://github.com/ClickHouse/ClickHouse/pull/30244)（[Nikolay Degterinsky](https://github.com/evillique)）。
* 修复在 `multiIf` 中使用 `shortcircuit` 和 `lowcardinality` 时触发的崩溃。[#30243](https://github.com/ClickHouse/ClickHouse/pull/30243) ([Raúl Marín](https://github.com/Algunenano)).
* 修复 `FlatDictionary` 和 `HashedDictionary` 在可为空属性上的 `bytes_allocated` 计算错误。 [#30238](https://github.com/ClickHouse/ClickHouse/pull/30238) ([Maksim Kita](https://github.com/kitaisreal)).
* 在多表 JOIN 中允许使用以数字开头的标识符。[#30230](https://github.com/ClickHouse/ClickHouse/pull/30230) ([Vladimir C](https://github.com/vdimir)).
* 修复在从 `MergeTree` 读取且 `max_read_buffer_size = 0` 时的行为（当用户“搬起石头砸自己的脚”时）（可能会导致抛出 `Can't adjust last granule`、`LOGICAL_ERROR` 等异常，甚至造成数据丢失）。[#30192](https://github.com/ClickHouse/ClickHouse/pull/30192)（[Azat Khuzhin](https://github.com/azat)）。
* 修复在使用 `min_bytes_to_use_direct_io` 时的 `pread_fake_async` / `pread_threadpool`。 [#30191](https://github.com/ClickHouse/ClickHouse/pull/30191) ([Azat Khuzhin](https://github.com/azat)).
* 修复 `INSERT SELECT` 基于 `Nullable` 列错误填充 `MATERIALIZED` 列的问题。 [#30189](https://github.com/ClickHouse/ClickHouse/pull/30189) ([Azat Khuzhin](https://github.com/azat)).
* 在函数 `initializeAggregation` 中支持可为 `NULL` 的参数。 [#30177](https://github.com/ClickHouse/ClickHouse/pull/30177) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在包含 `GLOBAL IN` 和 `WITH TOTALS` 的查询中出现的 `Port is already connected` 错误。仅适用于 21.9 和 21.10。[#30086](https://github.com/ClickHouse/ClickHouse/pull/30086) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复 MergeTree 中 `MOVE PARTITION` 与合并/变更操作之间的竞态问题。[#30074](https://github.com/ClickHouse/ClickHouse/pull/30074)（[Azat Khuzhin](https://github.com/azat)）。
* 在服务器重启后，被删除的 `Memory` 数据库可能会重新出现，此问题已修复（[#29795](https://github.com/ClickHouse/ClickHouse/issues/29795)）。同时新增了 `force_remove_data_recursively_on_drop` 设置，作为在删除 `Ordinary` 数据库时遇到 `Directory not empty` 错误的解决方法（因为在云环境中无法手动清理残留数据）。[#30054](https://github.com/ClickHouse/ClickHouse/pull/30054)（[tavplubix](https://github.com/tavplubix)）。
* 修复由 `tuple()` 导致的示例崩溃，关闭 [#30004](https://github.com/ClickHouse/ClickHouse/issues/30004)。[#30016](https://github.com/ClickHouse/ClickHouse/pull/30016)（[flynn](https://github.com/ucasfl)）。
* 尝试关闭 issue：[ #29965 ](https://github.com/ClickHouse/ClickHouse/issues/29965)。[ #29976 ](https://github.com/ClickHouse/ClickHouse/pull/29976)（[hexiaoting](https://github.com/hexiaoting)）。
* 修复 `FileChecker` 与 `StorageLog`/`StorageStripeLog` 之间可能出现的数据竞争。 [#29959](https://github.com/ClickHouse/ClickHouse/pull/29959) ([Azat Khuzhin](https://github.com/azat)).
* 修复 `StorageLog` 中 `LogSink::writeMarks()` 与 `LogSource` 之间的数据竞态。 [#29946](https://github.com/ClickHouse/ClickHouse/pull/29946) ([Azat Khuzhin](https://github.com/azat)).
* 修复在 [https://github.com/ClickHouse/ClickHouse/pull/19544](https://github.com/ClickHouse/ClickHouse/pull/19544) 中引入的 MergeTree 表并发查询限制可能导致的资源泄漏问题。[#29879](https://github.com/ClickHouse/ClickHouse/pull/29879)（[Amos Bird](https://github.com/amosbird)）。
* 修复系统表重新创建检查（无法检测到 `Enum` 值的更改）。 [#29857](https://github.com/ClickHouse/ClickHouse/pull/29857) ([Azat Khuzhin](https://github.com/azat)).
* MaterializedMySQL：修复了一个问题：当与 MySQL 的连接丢失时，可能只会处理事务的一部分。 [#29837](https://github.com/ClickHouse/ClickHouse/pull/29837) ([Håvard Kvålen](https://github.com/havardk)).
* 避免在极少数情况下出现 `Timeout exceeded: elapsed 18446744073.709553 seconds` 错误（推测是由内核中的某些 bug 导致）。修复了 [#29154](https://github.com/ClickHouse/ClickHouse/issues/29154)。[#29811](https://github.com/ClickHouse/ClickHouse/pull/29811)（[tavplubix](https://github.com/tavplubix)）。
* 修复在 `ATTACH TABLE ... FROM 'path'` 查询中，当使用非字符串字面量作为路径时出现的不正确类型转换问题。该问题可能导致读取未初始化内存。[#29790](https://github.com/ClickHouse/ClickHouse/pull/29790) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复在 `GROUP BY` 期间对 `LowCardinality` 的并发访问（与 `Buffer` 表配合使用时可能会导致问题）。[#29782](https://github.com/ClickHouse/ClickHouse/pull/29782)（[Azat Khuzhin](https://github.com/azat)）。
* 在分布式查询场景下修复了 `GROUP BY` 结果错误（结果中出现多行具有相同键）的问题：当分片中同时存在版本 `<= 21.3` 和 `>= 21.4`，`GROUP BY` 键由多个全部为固定大小的列组成，并且启用了两级聚合时（参见 `group_by_two_level_threshold` 和 `group_by_two_level_threshold_bytes`），会触发该问题。修复了 [#29580](https://github.com/ClickHouse/ClickHouse/issues/29580)。[#29735](https://github.com/ClickHouse/ClickHouse/pull/29735)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在服务器重启时设置 `materialized_postgresql_tables_list` 的不正确行为。见 [#28529](https://github.com/ClickHouse/ClickHouse/issues/28529)。[#29686](https://github.com/ClickHouse/ClickHouse/pull/29686)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在下推优化后，过滤谓词中的条件可能会被丢弃。 [#29625](https://github.com/ClickHouse/ClickHouse/pull/29625) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复包含别名和短路求值的 JIT 表达式编译问题。关闭 [#29403](https://github.com/ClickHouse/ClickHouse/issues/29403)。[#29574](https://github.com/ClickHouse/ClickHouse/pull/29574) ([Maksim Kita](https://github.com/kitaisreal)).
* 修复在 `DEFAULT` 表达式中使用类似 `x.y.z...` 的错误表标识符时，`ALTER MODIFY` 查询中极少出现的段错误。修复了 [#29184](https://github.com/ClickHouse/ClickHouse/issues/29184)。[#29573](https://github.com/ClickHouse/ClickHouse/pull/29573)（[alesapin](https://github.com/alesapin)）。
* 修复 `GROUP BY WITH TOTALS HAVING` 中的 nullptr 解引用问题（当 `HAVING` 中使用的列未被选中时）。[#29553](https://github.com/ClickHouse/ClickHouse/pull/29553) ([Azat Khuzhin](https://github.com/azat))。
* 避免在同一时间对 Join 表引擎的表进行读写时发生死锁。[#29544](https://github.com/ClickHouse/ClickHouse/pull/29544) ([Raúl Marín](https://github.com/Algunenano)).
* 修复 `pathStartsWith` 检查中的错误，因为在使用 `std::mismatch` 时存在一个问题：`如果第二个范围比第一个范围短，则行为未定义。` [#29531](https://github.com/ClickHouse/ClickHouse/pull/29531) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 在 ODBC bridge 中为 `Invalid cursor state` 错误添加重试逻辑。该错误是可重试的。关闭 [#29473](https://github.com/ClickHouse/ClickHouse/issues/29473)。[#29518](https://github.com/ClickHouse/ClickHouse/pull/29518) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 修复在加载 `Lazy` 数据库时对表名的错误解析。修复了 [#29456](https://github.com/ClickHouse/ClickHouse/issues/29456)。[#29476](https://github.com/ClickHouse/ClickHouse/pull/29476)（[tavplubix](https://github.com/tavplubix)）。
* 修复在下推 `HAVING` 谓词的子查询中可能出现的 `Block structure mismatch` 问题。修复了 [#29010](https://github.com/ClickHouse/ClickHouse/issues/29010)。[#29475](https://github.com/ClickHouse/ClickHouse/pull/29475)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复 `greatest/least` 函数中的逻辑错误 `Cannot capture columns`。关闭 [#29334](https://github.com/ClickHouse/ClickHouse/issues/29334)。[#29454](https://github.com/ClickHouse/ClickHouse/pull/29454)（[Kruglov Pavel](https://github.com/Avogar)）。
* RocksDB 表引擎：修复在多次打开数据库时出现的竞争条件（并重新启用一些在 CI 中会触发该问题的测试）。 [#29393](https://github.com/ClickHouse/ClickHouse/pull/29393) ([Azat Khuzhin](https://github.com/azat)).
* 修复在配置错误时复制访问存储无法正常关闭的问题。 [#29388](https://github.com/ClickHouse/ClickHouse/pull/29388) ([Kevin Michel](https://github.com/kmichel-aiven)).
* 移除了窗口函数 `nth_value`，因为它不是内存安全的。由此关闭了 [#29347](https://github.com/ClickHouse/ClickHouse/issues/29347)。[#29348](https://github.com/ClickHouse/ClickHouse/pull/29348)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复投影部分的垂直合并。这修复了 [#29253](https://github.com/ClickHouse/ClickHouse/issues/29253)。此 PR 还修复了在 [https://github.com/ClickHouse/ClickHouse/pull/25165](https://github.com/ClickHouse/ClickHouse/pull/25165) 中引入的若干投影合并/变更问题。[#29337](https://github.com/ClickHouse/ClickHouse/pull/29337)（[Amos Bird](https://github.com/amosbird)）。
* 修复在向 Replicated 数据库添加新副本时会挂起的 DDL 查询。 [#29328](https://github.com/ClickHouse/ClickHouse/pull/29328) ([Kevin Michel](https://github.com/kmichel-aiven)).
* 修复连接超时问题（`send_timeout`/`receive_timeout`）。[#29282](https://github.com/ClickHouse/ClickHouse/pull/29282)（[Azat Khuzhin](https://github.com/azat)）。
* 修复在重新创建或新建 `ReplicatedMergeTree` 副本时，若某个表列的默认表达式中包含不区分大小写的函数，可能会出现的 `Table columns structure in ZooKeeper is different from local table structure` 异常。 [#29266](https://github.com/ClickHouse/ClickHouse/pull/29266) ([Anton Popov](https://github.com/CurtizJ)).
* 通过 TCP 向客户端发送常规的 `Database doesn't exist error`（`UNKNOWN_DATABASE`），而不是 `Attempt to read after eof`（`ATTEMPT_TO_READ_AFTER_EOF`）。[#29229](https://github.com/ClickHouse/ClickHouse/pull/29229)（[Azat Khuzhin](https://github.com/azat)）。
* 修复在 Avro 输入格式下向类型为 LowCardinality(Nullable) 的列插入数据时发生的段错误。 [#29132](https://github.com/ClickHouse/ClickHouse/pull/29132) ([Kruglov Pavel](https://github.com/Avogar)).
* 在使用服务器间密钥时，不允许重用之前的凭证（在通过 Buffer/Kafka 向为该集群配置了服务器间密钥的 Distributed 表执行 INSERT 之前，可能会复用此前为该连接设置的用户）。 [#29060](https://github.com/ClickHouse/ClickHouse/pull/29060) ([Azat Khuzhin](https://github.com/azat)).
* 在与字典进行 `JOIN` 时处理 `any_join_distinct_right_table_keys`，关闭 [#29007](https://github.com/ClickHouse/ClickHouse/issues/29007)。[#29014](https://github.com/ClickHouse/ClickHouse/pull/29014)（[Vladimir C](https://github.com/vdimir)）。
* 修复在对别名列进行 `JOIN` 时出现的 “Not found column ... in block” 错误，关闭 [#26980](https://github.com/ClickHouse/ClickHouse/issues/26980)。[#29008](https://github.com/ClickHouse/ClickHouse/pull/29008)（[Vladimir C](https://github.com/vdimir)）。
* 修复 `GLOBAL IN` 子查询中使用的线程数（自从 [#19414](https://github.com/ClickHouse/ClickHouse/issues/19414) 缺陷修复后，它一直只在单线程中执行）。[#28997](https://github.com/ClickHouse/ClickHouse/pull/28997)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在 `ORDER BY` 包含 `WITH FILL` 时产生的不正确优化。由此关闭 [#28908](https://github.com/ClickHouse/ClickHouse/issues/28908)。由此关闭 [#26049](https://github.com/ClickHouse/ClickHouse/issues/26049)。[#28910](https://github.com/ClickHouse/ClickHouse/pull/28910) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复在使用常量参数时，高阶数组函数（`arrayCompact` 出现 `SIGSEGV`，`arrayDifference` / `arrayCumSumNonNegative` 出现 `ILLEGAL_COLUMN`）的问题。 [#28904](https://github.com/ClickHouse/ClickHouse/pull/28904) ([Azat Khuzhin](https://github.com/azat)).
* 修复在 `mutations_sync=2` 时等待数据变更的问题。 [#28889](https://github.com/ClickHouse/ClickHouse/pull/28889) ([Azat Khuzhin](https://github.com/azat)).
* 修复针对外部数据库（例如 MySQL）的查询在 `IN` 子句中使用多列（例如 `(k,v) IN ((1, 2))`）时的问题。 [#28888](https://github.com/ClickHouse/ClickHouse/pull/28888) ([Azat Khuzhin](https://github.com/azat)).
* 修复在短路函数求值中与 `LowCardinality` 相关的错误。修复 [#28884](https://github.com/ClickHouse/ClickHouse/issues/28884)。[#28887](https://github.com/ClickHouse/ClickHouse/pull/28887)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复从紧凑数据部分读取子列的问题。 [#28873](https://github.com/ClickHouse/ClickHouse/pull/28873) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了 `DROP PART` 与 `REPLACE/MOVE PARTITION` 之间的竞态条件，该问题在极少数情况下可能导致副本之间出现差异。[#28864](https://github.com/ClickHouse/ClickHouse/pull/28864) ([tavplubix](https://github.com/tavplubix))。
* 修复使用短路求值的表达式的编译。 [#28821](https://github.com/ClickHouse/ClickHouse/pull/28821) ([Azat Khuzhin](https://github.com/azat)).
* 修复一种极其罕见的情况：在所有副本都进行硬重启后，`ReplicatedMergeTree` 副本之间可能出现数据不一致。错误信息类似于 `Part ... intersects (previous|next) part ...`。 [#28817](https://github.com/ClickHouse/ClickHouse/pull/28817) ([alesapin](https://github.com/alesapin))。
* 更完善地检查连接是否可用，并在 `RabbitMQ` 关闭时捕获任何异常以防万一。 [#28797](https://github.com/ClickHouse/ClickHouse/pull/28797) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 修复 `ReplicatedMergeTreeQueue` 中的无害竞态条件。按理说用户不应察觉，但可能会导致一些隐蔽的错误。[#28734](https://github.com/ClickHouse/ClickHouse/pull/28734) ([alesapin](https://github.com/alesapin))。
* 修复在出现异常时，使用只部分创建的聚合投影执行 `SELECT` 查询可能导致的崩溃问题。[#28700](https://github.com/ClickHouse/ClickHouse/pull/28700) ([Amos Bird](https://github.com/amosbird)).
* 修复了在创建 `Distributed` 表时，由于传入参数错误而导致的 `coredump` 问题。 [#28686](https://github.com/ClickHouse/ClickHouse/pull/28686) ([Zhiyong Wang](https://github.com/ljcui)).
* 为 `system.processes` 表新增 `Settings.Names` 和 `Settings.Values` 列别名。 [#28685](https://github.com/ClickHouse/ClickHouse/pull/28685) ([Vitaly](https://github.com/orloffv)).
* 对 S2 Geometry 库的支持：修正 `s2RectAdd` 和 `s2RectContains` 函数的参数个数要求。[#28663](https://github.com/ClickHouse/ClickHouse/pull/28663) ([Bharat Nallan](https://github.com/bharatnc))。
* 修复在使用 `Nullable` 或 `LowCardinality` 主键时出现的无效常量类型转换问题。[#28636](https://github.com/ClickHouse/ClickHouse/pull/28636)（[Amos Bird](https://github.com/amosbird)）。
* 使用 PREWHERE 修复 “Column is not under aggregate function and not in GROUP BY”（修复：[ #28461](https://github.com/ClickHouse/ClickHouse/issues/28461)）。[#28502](https://github.com/ClickHouse/ClickHouse/pull/28502)（[Azat Khuzhin](https://github.com/azat)）。

### ClickHouse 版本 v21.10, 2021-10-16 {#clickhouse-release-v2110-2021-10-16}

#### 不兼容变更 {#backward-incompatible-change-2}

- 现在以下 MergeTree 表级设置：`replicated_max_parallel_sends`、`replicated_max_parallel_sends_for_table`、`replicated_max_parallel_fetches`、`replicated_max_parallel_fetches_for_table` 已不再生效。这些设置从未正常工作过,已被 `max_replicated_fetches_network_bandwidth`、`max_replicated_sends_network_bandwidth` 和 `background_fetches_pool_size` 替代。[#28404](https://github.com/ClickHouse/ClickHouse/pull/28404) ([alesapin](https://github.com/alesapin))。

#### 新功能 {#new-feature-2}


- 新增以 lambda 表达式创建用户自定义函数 (UDF) 的功能。语法:`CREATE FUNCTION {function_name} as ({parameters}) -> {function core}`。示例:`CREATE FUNCTION plus_one as (a) -> a + 1`。作者 @Realist007。[#27796](https://github.com/ClickHouse/ClickHouse/pull/27796) ([Maksim Kita](https://github.com/kitaisreal)) [#23978](https://github.com/ClickHouse/ClickHouse/pull/23978) ([Realist007](https://github.com/Realist007))。
- 新增 `Executable` 存储引擎和 `executable` 表函数。支持以流式方式通过外部脚本处理数据。[#28102](https://github.com/ClickHouse/ClickHouse/pull/28102) ([Maksim Kita](https://github.com/kitaisreal)) ([ruct](https://github.com/ruct))。
- 新增 `ExecutablePool` 存储引擎。与 `Executable` 类似,但使用长期运行的进程池。[#28518](https://github.com/ClickHouse/ClickHouse/pull/28518) ([Maksim Kita](https://github.com/kitaisreal))。
- 新增 `ALTER TABLE ... MATERIALIZE COLUMN` 查询。[#27038](https://github.com/ClickHouse/ClickHouse/pull/27038) ([Vladimir Chebotarev](https://github.com/excitoon))。
- 支持向 `s3` 表函数进行分区写入。[#23051](https://github.com/ClickHouse/ClickHouse/pull/23051) ([Vladimir Chebotarev](https://github.com/excitoon))。
- 支持 `lz4` 压缩格式(除 `gz`、`bz2`、`xz`、`zstd` 外)用于数据导入/导出。[#25310](https://github.com/ClickHouse/ClickHouse/pull/25310) ([Bharat Nallan](https://github.com/bharatnc))。
- 在 `enable_positional_arguments` 设置下允许使用位置参数。关闭 [#2592](https://github.com/ClickHouse/ClickHouse/issues/2592)。[#27530](https://github.com/ClickHouse/ClickHouse/pull/27530) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 在 s3 表的 `CREATE` 查询中,允许在 `SETTINGS` 子句中接受与文件格式相关的用户设置。关闭 [#27580](https://github.com/ClickHouse/ClickHouse/issues/27580)。[#28037](https://github.com/ClickHouse/ClickHouse/pull/28037) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 允许 `RabbitMQ` 引擎使用 SSL 连接。[#28365](https://github.com/ClickHouse/ClickHouse/pull/28365) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 新增 `getServerPort` 函数用于获取服务器端口。当端口未被服务器使用时,抛出异常。[#27900](https://github.com/ClickHouse/ClickHouse/pull/27900) ([Amos Bird](https://github.com/amosbird))。
- 新增 "snowflake id" 与 `DateTime`、`DateTime64` 之间的转换函数。参见 [#27058](https://github.com/ClickHouse/ClickHouse/issues/27058)。[#27704](https://github.com/ClickHouse/ClickHouse/pull/27704) ([jasine](https://github.com/jasine))。
- 新增 `SHA512` 函数。[#27830](https://github.com/ClickHouse/ClickHouse/pull/27830) ([zhanglistar](https://github.com/zhanglistar))。
- 新增 `log_queries_probability` 设置,允许用户仅将查询样本写入 query_log。关闭 [#16609](https://github.com/ClickHouse/ClickHouse/issues/16609)。[#27527](https://github.com/ClickHouse/ClickHouse/pull/27527) ([Nikolay Degterinsky](https://github.com/evillique))。

#### 实验性功能 {#experimental-feature-2}


- `web` 类型磁盘,用于在 Web 服务器上以静态文件形式存储只读表。参见 [#23982](https://github.com/ClickHouse/ClickHouse/issues/23982)。[#25251](https://github.com/ClickHouse/ClickHouse/pull/25251) ([Kseniia Sumarokova](https://github.com/kssenii))。此功能主要用于便于在共享存储上进行操作测试以及轻松导入数据集。不建议在 21.11 版本之前使用。
- 新增 `BACKUP` 和 `RESTORE` 命令。[#21945](https://github.com/ClickHouse/ClickHouse/pull/21945) ([Vitaly Baranov](https://github.com/vitlibar))。此功能正在开发中,不建议在当前版本中使用。

#### 性能改进 {#performance-improvement-2}

- 加速 `sumIf` 和 `countIf` 聚合函数。[#28272](https://github.com/ClickHouse/ClickHouse/pull/28272) ([Raúl Marín](https://github.com/Algunenano))。
- 为 `minmax` 索引创建虚拟投影。现在,当启用 `allow_experimental_projection_optimization` 时,查询将在可能的情况下使用 minmax 索引而不是读取数据。[#26286](https://github.com/ClickHouse/ClickHouse/pull/26286) ([Amos Bird](https://github.com/amosbird))。
- 在 `sequenceMatch` 和 `sequenceCount` 中引入两项检查,当事件列表中缺少序列模式的某些确定性部分时允许提前退出。此更改使许多以前因达到操作上限而失败的查询得以执行,并总体上加速了处理流程。[#27729](https://github.com/ClickHouse/ClickHouse/pull/27729) ([Jakub Kuklis](https://github.com/jkuklis))。
- 利用二元函数的单调性信息增强主键分析,特别是非零常量除法。[#28302](https://github.com/ClickHouse/ClickHouse/pull/28302) ([Amos Bird](https://github.com/amosbird))。
- 使 `hasAll` 过滤条件利用布隆过滤器数据跳过索引。[#27984](https://github.com/ClickHouse/ClickHouse/pull/27984) ([Braulio Valdivielso Martínez](https://github.com/BraulioVM))。
- 通过延迟表启动过程加速数据部分加载。[#28313](https://github.com/ClickHouse/ClickHouse/pull/28313) ([Amos Bird](https://github.com/amosbird))。
- 修复了从 `WHERE` 移动到 `PREWHERE` 的条件数量可能过多的问题(该优化由设置 `optimize_move_to_prewhere` 控制)。[#28139](https://github.com/ClickHouse/ClickHouse/pull/28139) ([lthaooo](https://github.com/lthaooo))。
- 默认启用 `optimize_distributed_group_by_sharding_key`。[#28105](https://github.com/ClickHouse/ClickHouse/pull/28105) ([Azat Khuzhin](https://github.com/azat))。

#### 改进 {#improvement-2}


* 在创建 `Distributed` 表之前检查集群名称，禁止使用错误的集群名称创建表。修复了 [#27832](https://github.com/ClickHouse/ClickHouse/issues/27832)。[#27927](https://github.com/ClickHouse/ClickHouse/pull/27927)（[tavplubix](https://github.com/tavplubix)）。
* 添加聚合函数 `quantileBFloat16Weighted`，用法与其他 `quantile...Weighted` 函数类似。此更改关闭了 [#27745](https://github.com/ClickHouse/ClickHouse/issues/27745)。[#27758](https://github.com/ClickHouse/ClickHouse/pull/27758)（[Ivan Novitskiy](https://github.com/RedClusive)）。
* 允许创建属性列表为空的字典。 [#27905](https://github.com/ClickHouse/ClickHouse/pull/27905) ([Maksim Kita](https://github.com/kitaisreal)).
* 在 `clickhouse-client` 中添加了关于如何重置密码的交互式文档。这在用户安装 ClickHouse、设置密码后马上就忘记密码的场景中非常有用。参见 [#27750](https://github.com/ClickHouse/ClickHouse/issues/27750)。[#27903](https://github.com/ClickHouse/ClickHouse/pull/27903)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 `JSONAsString` 输入格式中，支持数据被包裹在数组中的情况。关闭了 [#25517](https://github.com/ClickHouse/ClickHouse/issues/25517)。[#25633](https://github.com/ClickHouse/ClickHouse/pull/25633)（[Kruglov Pavel](https://github.com/Avogar)）。
* 在 `system.replicas` 表中添加新列 `last_queue_update_exception`。 [#26843](https://github.com/ClickHouse/ClickHouse/pull/26843) ([nvartolomei](https://github.com/nvartolomei)).
* 为 `MaterializedPostgreSQL` 表在故障转移时提供重连支持。修复 [#28529](https://github.com/ClickHouse/ClickHouse/issues/28529)。[#28614](https://github.com/ClickHouse/ClickHouse/pull/28614)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在服务器首次启动时生成唯一的服务器 UUID。 [#20089](https://github.com/ClickHouse/ClickHouse/pull/20089) ([Bharat Nallan](https://github.com/bharatnc))。
* 为 `MySQL` 引擎新增 `connection_wait_timeout` 设置（默认 5 秒，0 表示不等待）。 [#28474](https://github.com/ClickHouse/ClickHouse/pull/28474) ([Azat Khuzhin](https://github.com/azat)).
* 禁止使用无效参数创建 `MaterializedPostgreSQL`。修复了 [#28423](https://github.com/ClickHouse/ClickHouse/issues/28423)。[#28430](https://github.com/ClickHouse/ClickHouse/pull/28430)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在垂直合并中，使用真实的 tmp 文件替代预定义的 &quot;rows&#95;sources&quot;。这可以避免在 tmp 磁盘上生成垃圾目录。 [#28299](https://github.com/ClickHouse/ClickHouse/pull/28299) ([Amos Bird](https://github.com/amosbird)).
* 在服务器配置中添加了 `libhdfs3_conf`，而不再在 clickhouse-server.service 中通过导出环境变量 `LIBHDFS3_CONF` 来进行配置。该设置用于与 HDFS 的交互配置。[#28268](https://github.com/ClickHouse/ClickHouse/pull/28268) ([Zhichang Yu](https://github.com/yuzhichang))。
* 修复对处于 Temporary 状态的数据部分的删除处理逻辑，该问题可能导致意外异常（`Part %name% doesn't exist`）。修复了 [#23661](https://github.com/ClickHouse/ClickHouse/issues/23661)。[#28221](https://github.com/ClickHouse/ClickHouse/pull/28221) [#28221](https://github.com/ClickHouse/ClickHouse/issues/28221))（[Azat Khuzhin](https://github.com/azat)）。
* 修复 `zookeeper_log.address`（在此 PR 的第一个补丁之前，该地址始终为 `::`），并减少对此列调用 `getpeername(2)` 的次数（由于每次向 `zookeeper_log` 添加条目都会调用 `getpeername()`，因此将该地址缓存在 zookeeper 客户端中以避免重复调用）。 [#28212](https://github.com/ClickHouse/ClickHouse/pull/28212) ([Azat Khuzhin](https://github.com/azat)).
* 支持在 `[]` 运算符的索引与 `Map` 类型键之间进行隐式转换（例如不同的 `Int` 类型、`String` 和 `FixedString`）。 [#28096](https://github.com/ClickHouse/ClickHouse/pull/28096) ([Anton Popov](https://github.com/CurtizJ))。
* 在向 PostgreSQL 表引擎或表函数中插入数据时支持使用 `ON CONFLICT` 子句。修复 [#27727](https://github.com/ClickHouse/ClickHouse/issues/27727)。[#28081](https://github.com/ClickHouse/ClickHouse/pull/28081)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 降低 `Enum` 数据类型的限制，以允许附加兼容数据。修复 [#26672](https://github.com/ClickHouse/ClickHouse/issues/26672)。[#28028](https://github.com/ClickHouse/ClickHouse/pull/28028)（[Dmitry Novik](https://github.com/novikd)）。
* 添加设置 `empty_result_for_aggregation_by_constant_keys_on_empty_set`，用于控制在空集合上按常量键分组时的行为。此设置用于恢复 [#6842](https://github.com/ClickHouse/ClickHouse/issues/6842) 中的原有行为。[#27932](https://github.com/ClickHouse/ClickHouse/pull/27932)（[Amos Bird](https://github.com/amosbird)）。
* 新增了 `replication_wait_for_inactive_replica_timeout` 设置。该设置用于指定在等待非活动副本执行 `ALTER`/`OPTIMZE`/`TRUNCATE` 查询时的最长时间（默认值为 120 秒）。如果 `replication_alter_partitions_sync` 为 2，且某些副本处于非活动状态的时间超过 `replication_wait_for_inactive_replica_timeout` 秒，则会抛出 `UNFINISHED`。 [#27931](https://github.com/ClickHouse/ClickHouse/pull/27931) ([tavplubix](https://github.com/tavplubix)).
* 为 `APPLY` 列转换器增加对 lambda 参数的支持，从而可以应用带有多个参数的函数。对应问题 [#27877](https://github.com/ClickHouse/ClickHouse/issues/27877)。[#27901](https://github.com/ClickHouse/ClickHouse/pull/27901)（[Amos Bird](https://github.com/amosbird)）。
* 默认启用 `tcp_keep_alive_timeout`。[#27882](https://github.com/ClickHouse/ClickHouse/pull/27882) ([Azat Khuzhin](https://github.com/azat))。
* 改进远程查询取消机制（应对远程服务器异常终止的情况）。 [#27881](https://github.com/ClickHouse/ClickHouse/pull/27881) ([Azat Khuzhin](https://github.com/azat)).
* 对大型 S3 对象使用 Multipart 分段复制上传。[#27858](https://github.com/ClickHouse/ClickHouse/pull/27858) ([ianton-ru](https://github.com/ianton-ru)).
* 允许在库字典路径中遍历符号链接。 [#27815](https://github.com/ClickHouse/ClickHouse/pull/27815) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 现在将 `ALTER MODIFY COLUM` `T` 修改为 `Nullable(T)` 不再需要执行 mutation。[#27787](https://github.com/ClickHouse/ClickHouse/pull/27787) ([victorgao](https://github.com/kafka1991))。
* 不要静默忽略错误，也不要在 `ReadBufferFromS3` 中统计延迟。 [#27484](https://github.com/ClickHouse/ClickHouse/pull/27484) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 通过仅重新计算元数据而不执行实际 TTL 操作来优化 `ALTER ... MATERIALIZE TTL`。 [#27019](https://github.com/ClickHouse/ClickHouse/pull/27019) ([lthaooo](https://github.com/lthaooo)).
* 允许在 EOF 处末尾没有换行符的情况下读取自定义顶级域名列表。 [#28213](https://github.com/ClickHouse/ClickHouse/pull/28213) ([Azat Khuzhin](https://github.com/azat)).

#### 错误修复 {#bug-fix-1}


* 修复从 `carbon-clickhouse` 读取压缩数据时出现“attempt to read after end of file”错误的问题。修复 [#26149](https://github.com/ClickHouse/ClickHouse/issues/26149)。[#28150](https://github.com/ClickHouse/ClickHouse/pull/28150)（[FArthur-cmd](https://github.com/FArthur-cmd)）。
* 修复在执行带有 `ON CLUSTER` 子句的 `GRANT WITH REPLACE` 语句时检查访问权限授予的问题。此 PR 在修复 [#27001](https://github.com/ClickHouse/ClickHouse/pull/27701) 的基础上作出改进。[#27983](https://github.com/ClickHouse/ClickHouse/pull/27983)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 允许在类型为 `LowCardinality(UUID)` 的列上使用 `extremes = 1` 进行查询。 [#27918](https://github.com/ClickHouse/ClickHouse/pull/27918) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复包含负数的 PostgreSQL 风格类型转换（`::` 运算符）。[#27876](https://github.com/ClickHouse/ClickHouse/pull/27876)（[Anton Popov](https://github.com/CurtizJ)）。
* 在 [#26864](https://github.com/ClickHouse/ClickHouse/pull/26864) 之后，修复了 `NamedSessionStorage` 的关闭逻辑：现在会在销毁全局上下文之前，先销毁存储在 `NamedSessionStorage` 中的会话上下文。[#27875](https://github.com/ClickHouse/ClickHouse/pull/27875)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复 `windowFunnel` 「strict」 模式的缺陷。此修复对应 [#27469](https://github.com/ClickHouse/ClickHouse/issues/27469)。[#27563](https://github.com/ClickHouse/ClickHouse/pull/27563)（[achimbab](https://github.com/achimbab)）。
* 修复读取被截断的 `bzip2` 压缩包时出现的无限循环问题。[#28543](https://github.com/ClickHouse/ClickHouse/pull/28543) ([Azat Khuzhin](https://github.com/azat)).
* 修复 `MaterializedMySQL` 内部 DDL 在执行 `DROP TABLE` 时的 UUID 重叠问题。MaterializedMySQL 是一个实验性特性。[#28533](https://github.com/ClickHouse/ClickHouse/pull/28533) ([Azat Khuzhin](https://github.com/azat)).
* 修复在查询包含 `Nested` 列，以及名称中带点且与 `Nested` 列具有相同前缀的标量列（例如 `n.id UInt32, n.arr1 Array(UInt64), n.arr2 Array(UInt64)`）的表时出现的 `There is no subcolumn` 错误。 [#28531](https://github.com/ClickHouse/ClickHouse/pull/28531) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了在对 `ReplicatedVersionedCollapsingMergeTree` 执行 ALTER 后，可能导致错误 `Existing table metadata in ZooKeeper differs in sorting key expression.` 的缺陷。修复了 [#28515](https://github.com/ClickHouse/ClickHouse/issues/28515)。[#28528](https://github.com/ClickHouse/ClickHouse/pull/28528)（[alesapin](https://github.com/alesapin)）。
* 修复了在分布式 DDL 队列后台处理过程中可能发生的 ZooKeeper watch 泄漏问题（次要问题）。修复了 [#26036](https://github.com/ClickHouse/ClickHouse/issues/26036)。[#28446](https://github.com/ClickHouse/ClickHouse/pull/28446)（[tavplubix](https://github.com/tavplubix)）。
* 修复 `MaterializedPostgreSQL` 引擎中缺少对表名加引号的问题。修复 [#28316](https://github.com/ClickHouse/ClickHouse/issues/28316)。[#28433](https://github.com/ClickHouse/ClickHouse/pull/28433)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复来自 `Nullable` 列的未匹配行的错误行为。关闭 [#27691](https://github.com/ClickHouse/ClickHouse/issues/27691)。[#28349](https://github.com/ClickHouse/ClickHouse/pull/28349)（[vdimir](https://github.com/vdimir)）。
* 修复在并未使用所有键列时的 `NOT IN` 索引优化问题。此修复解决了 [#28120](https://github.com/ClickHouse/ClickHouse/issues/28120)。[#28315](https://github.com/ClickHouse/ClickHouse/pull/28315)（[Amos Bird](https://github.com/amosbird)）。
* 修复由于新 part 被空 part 替换而导致的区间交叉问题。[#28310](https://github.com/ClickHouse/ClickHouse/pull/28310) ([Azat Khuzhin](https://github.com/azat)).
* 修复在启用 `optimize_read_in_order` 设置时，使用 `ORDER BY` 且基于 `Merge` 表的查询结果不一致的问题。 [#28266](https://github.com/ClickHouse/ClickHouse/pull/28266) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在使用 `Nullable(LowCardinality)` 类型且将 `extremes` 设置为 1 的查询中，可能出现的未初始化内存读取问题。修复了 [#28165](https://github.com/ClickHouse/ClickHouse/issues/28165)。[#28205](https://github.com/ClickHouse/ClickHouse/pull/28205)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 针对投影进行了多项小修复。详细说明请参阅 PR。[#28178](https://github.com/ClickHouse/ClickHouse/pull/28178) ([Amos Bird](https://github.com/amosbird)).
* 修复由于上下文/配置重载器关闭顺序不正确而在关闭时极其罕见发生的段错误。 [#28088](https://github.com/ClickHouse/ClickHouse/pull/28088) ([nvartolomei](https://github.com/nvartolomei)).
* 修复函数 `JSONExtract` 中对 `Nullable(String)` 类型空值的处理问题。此修复解决了 [#27929](https://github.com/ClickHouse/ClickHouse/issues/27929) 和 [#27930](https://github.com/ClickHouse/ClickHouse/issues/27930)。该问题最初是在 [https://github.com/ClickHouse/ClickHouse/pull/25452](https://github.com/ClickHouse/ClickHouse/pull/25452) 中引入的。[#27939](https://github.com/ClickHouse/ClickHouse/pull/27939)（[Amos Bird](https://github.com/amosbird)）。
* 对新的 `clickhouse-keeper` 工具进行了多项修复。修复了 `clickhouse-keeper` 中一个较为罕见的错误，该错误会导致客户端在收到请求响应之前先收到 watch 响应。 [#28197](https://github.com/ClickHouse/ClickHouse/pull/28197) ([alesapin](https://github.com/alesapin))。修复了 `clickhouse-keeper` 中的不正确行为，即在对子节点执行 `set` 请求时会触发列表 watch（`getChildren`）。 [#28190](https://github.com/ClickHouse/ClickHouse/pull/28190) ([alesapin](https://github.com/alesapin))。修复了在某些罕见情况下，修改 `clickhouse-keeper` 设置可能导致日志丢失和服务器挂起的问题。 [#28360](https://github.com/ClickHouse/ClickHouse/pull/28360) ([alesapin](https://github.com/alesapin))。修复了 `clickhouse-keeper` 中的一个错误，该错误在减小 `rotate_logs_interval` 时可能导致日志持续输出不止。 [#28152](https://github.com/ClickHouse/ClickHouse/pull/28152) ([alesapin](https://github.com/alesapin))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-2}

- 在压力测试中启用 Thread Fuzzer。Thread Fuzzer 是 ClickHouse 的一项功能,可以测试更多线程调度的排列组合,从而发现更多潜在问题。此更改关闭了 [#9813](https://github.com/ClickHouse/ClickHouse/issues/9813)、[#9814](https://github.com/ClickHouse/ClickHouse/issues/9814)、[#9515](https://github.com/ClickHouse/ClickHouse/issues/9515)、[#9516](https://github.com/ClickHouse/ClickHouse/issues/9516)。[#27538](https://github.com/ClickHouse/ClickHouse/pull/27538) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 为测试环境新增日志级别 `test`。该级别比默认的 `trace` 级别输出更详细的信息。[#28559](https://github.com/ClickHouse/ClickHouse/pull/28559) ([alesapin](https://github.com/alesapin))。
- 在 CMake 配置阶段输出 git 状态信息。[#28047](https://github.com/ClickHouse/ClickHouse/pull/28047) ([Braulio Valdivielso Martínez](https://github.com/BraulioVM))。
- 临时将 Ubuntu apt 仓库切换到镜像站 ru.archive.ubuntu.com,因为默认仓库 (archive.ubuntu.com) 在我们的 CI 环境中无法访问。[#28016](https://github.com/ClickHouse/ClickHouse/pull/28016) ([Ilya Yatsishin](https://github.com/qoega))。

### ClickHouse 版本 v21.9, 2021-09-09 {#clickhouse-release-v219-2021-09-09}

#### 向后不兼容的变更 {#backward-incompatible-change-3}


- `Decimal` 类型的文本表示不再输出尾随零。例如:对于精度为 6 的 decimal,将打印 `1.23` 而不是 `1.230000`。这解决了 [#15794](https://github.com/ClickHouse/ClickHouse/issues/15794)。如果您的应用程序依赖尾随零,这可能会引入轻微的不兼容性。输出格式中的序列化可以通过设置 `output_format_decimal_trailing_zeros` 来控制。`toString` 的实现和转换为 String 的行为无条件更改。[#27680](https://github.com/ClickHouse/ClickHouse/pull/27680) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 不允许将带有 `-Merge` 组合器的参数化聚合函数应用于由具有不同参数的聚合函数生成的聚合函数状态。例如,`fooState(42)(x)` 的状态不能用 `fooMerge(s)` 或 `fooMerge(123)(s)` 完成,必须像 `fooMerge(42)(s)` 这样显式指定参数,且参数必须相等。这不影响某些特殊的聚合函数,如 `quantile` 和 `sequence*`,它们仅在最终化时使用参数。[#26847](https://github.com/ClickHouse/ClickHouse/pull/26847) ([tavplubix](https://github.com/tavplubix))。
- 在 clickhouse-local 下,始终将带有端口的本地地址视为远程地址。[#26736](https://github.com/ClickHouse/ClickHouse/pull/26736) ([Raúl Marín](https://github.com/Algunenano))。
- 修复了在某些复杂查询中,当列别名与表达式名称相同时可能发生错误类型转换的问题。这修复了 [#25447](https://github.com/ClickHouse/ClickHouse/issues/25447)。这修复了 [#26914](https://github.com/ClickHouse/ClickHouse/issues/26914)。此修复可能会引入向后不兼容性:如果存在具有相同名称的不同表达式,将抛出异常。当设置 `enable_optimize_predicate_expression` 时,这可能会破坏某些罕见情况。[#26639](https://github.com/ClickHouse/ClickHouse/pull/26639) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 现在,如果标量子查询的类型可以是 `Nullable`,则始终返回 `Nullable` 结果。这是必需的,因为在空子查询的情况下,其结果应该是 `Null`。以前,可能会出现关于不兼容类型的错误(类型推导不执行标量子查询,可能使用非可空类型)。结果为空且无法转换为 `Nullable` 的标量子查询(如 `Array` 或 `Tuple`)现在会抛出错误。修复了 [#25411](https://github.com/ClickHouse/ClickHouse/issues/25411)。[#26423](https://github.com/ClickHouse/ClickHouse/pull/26423) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 引入 here document 语法。示例 `SELECT $doc$ VALUE $doc$`。[#26671](https://github.com/ClickHouse/ClickHouse/pull/26671) ([Maksim Kita](https://github.com/kitaisreal))。如果查询中存在包含 `$` 的标识符,此更改将向后不兼容 [#28768](https://github.com/ClickHouse/ClickHouse/issues/28768)。
- 现在索引可以处理 Nullable 类型,包括 `isNull` 和 `isNotNull`。[#12433](https://github.com/ClickHouse/ClickHouse/pull/12433) 和 [#12455](https://github.com/ClickHouse/ClickHouse/pull/12455) ([Amos Bird](https://github.com/amosbird)) 以及 [#27250](https://github.com/ClickHouse/ClickHouse/pull/27250) ([Azat Khuzhin](https://github.com/azat))。但这是通过磁盘格式更改完成的,尽管新服务器可以读取旧数据,但旧服务器不能。此外,如果您有 `MINMAX` 数据跳过索引,可能会收到 `Data after mutation/merge is not byte-identical` 错误,因为新索引将具有 `.idx2` 扩展名,而之前是 `.idx`。也就是说,在这种情况下,您不应延迟更新所有现有副本,否则,如果旧副本 (&lt;21.9) 从 21.9+ 的新副本下载数据,它将无法为下载的部分应用索引。

#### 新功能 {#new-feature-3}


* 实现短路函数求值，修复 [#12587](https://github.com/ClickHouse/ClickHouse/issues/12587)。添加设置项 `short_circuit_function_evaluation` 用于配置短路函数求值。[#23367](https://github.com/ClickHouse/ClickHouse/pull/23367)（[Kruglov Pavel](https://github.com/Avogar)）。
* 添加对 `INTERSECT`、`EXCEPT`、`ANY`、`ALL` 运算符的支持。[#24757](https://github.com/ClickHouse/ClickHouse/pull/24757) ([Kirill Ershov](https://github.com/zdikov)、[Kseniia Sumarokova](https://github.com/kssenii)).
* 在虚拟文件系统层面添加对加密的支持（静态数据加密），使用 AES-CTR 算法。[#24206](https://github.com/ClickHouse/ClickHouse/pull/24206) ([Latysheva Alexandra](https://github.com/alexelex)). ([Vitaly Baranov](https://github.com/vitlibar)) [#26733](https://github.com/ClickHouse/ClickHouse/pull/26733) [#26377](https://github.com/ClickHouse/ClickHouse/pull/26377) [#26465](https://github.com/ClickHouse/ClickHouse/pull/26465).
* 为同义词扩展添加了用于分词、词干还原、词形还原和搜索的自然语言处理（NLP）函数。[#24997](https://github.com/ClickHouse/ClickHouse/pull/24997)（[Nikolay Degterinsky](https://github.com/evillique)）。
* 新增了对 S2 几何库的集成。[#24980](https://github.com/ClickHouse/ClickHouse/pull/24980) ([Andr0901](https://github.com/Andr0901)). ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 添加 SQLite 表引擎、表函数和数据库引擎。 [#24194](https://github.com/ClickHouse/ClickHouse/pull/24194) ([Arslan Gumerov](https://github.com/g-arslan)). ([Kseniia Sumarokova](https://github.com/kssenii)).
* 为 `MySQL`、`PostgreSQL`、`ClickHouse`、`JDBC`、`Cassandra` 字典源新增了自定义查询支持。修复了 [#1270](https://github.com/ClickHouse/ClickHouse/issues/1270)。[#26995](https://github.com/ClickHouse/ClickHouse/pull/26995)（[Maksim Kita](https://github.com/kitaisreal)）。
* 通过 ZooKeeper 为用户、角色、行策略、配额和设置配置文件添加共享（复制）存储。[#27426](https://github.com/ClickHouse/ClickHouse/pull/27426) ([Kevin Michel](https://github.com/kmichel-aiven))。
* 为 `INTO OUTFILE` 添加自动选择压缩算法的压缩功能。修复 [#3473](https://github.com/ClickHouse/ClickHouse/issues/3473)。[#27134](https://github.com/ClickHouse/ClickHouse/pull/27134)（[Filatenkov Artur](https://github.com/FArthur-cmd)）。
* 类似于 `SELECT ... INTO OUTFILE`，新增 `INSERT ... FROM INFILE`。 [#27655](https://github.com/ClickHouse/ClickHouse/pull/27655) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* 新增了 `complex_key_range_hashed` 字典。关闭 [#22029](https://github.com/ClickHouse/ClickHouse/issues/22029)。[#27629](https://github.com/ClickHouse/ClickHouse/pull/27629)（[Maksim Kita](https://github.com/kitaisreal)）。
* 在 `JOIN ON` 部分中支持使用表达式。修复 [#21868](https://github.com/ClickHouse/ClickHouse/issues/21868)。[#24420](https://github.com/ClickHouse/ClickHouse/pull/24420)（[Vladimir C](https://github.com/vdimir)）。
* 当客户端连接到服务器时，它会收到服务器已收集的所有警告信息。（可通过选项 `--no-warnings` 禁用）。新增 `system.warnings` 表，用于收集有关服务器配置的警告。[#26246](https://github.com/ClickHouse/ClickHouse/pull/26246) ([Filatenkov Artur](https://github.com/FArthur-cmd)). [#26282](https://github.com/ClickHouse/ClickHouse/pull/26282) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* 允许在聚合函数参数中使用来自 `WITH` 和 `SELECT` 的常量表达式。修复 [#10945](https://github.com/ClickHouse/ClickHouse/issues/10945)。[#27531](https://github.com/ClickHouse/ClickHouse/pull/27531)（[abel-cheng](https://github.com/abel-cheng)）。
* 添加 `tupleToNameValuePairs` 函数，用于将具名元组转换为键值对数组。 [#27505](https://github.com/ClickHouse/ClickHouse/pull/27505) ([Braulio Valdivielso Martínez](https://github.com/BraulioVM))。
* 为导入/导出添加对 `bzip2` 压缩方法的支持。修复 [#22428](https://github.com/ClickHouse/ClickHouse/issues/22428)。[#27377](https://github.com/ClickHouse/ClickHouse/pull/27377)（[Nikolay Degterinsky](https://github.com/evillique)）。
* 新增了 `bitmapSubsetOffsetLimit(bitmap, offset, cardinality_limit)` 函数。它会基于 bitmap 创建一个子集，从 `offset` 位置开始，并将结果基数限制为 `cardinality_limit`。 [#27234](https://github.com/ClickHouse/ClickHouse/pull/27234) ([DHBin](https://github.com/DHBin)).
* 在 `system.users` 中添加 `default_database` 列。 [#27054](https://github.com/ClickHouse/ClickHouse/pull/27054) ([kevin wan](https://github.com/MaxWk))。
* 在表函数 `cluster` 和 `clusterAllReplicas` 中支持 `cluster` 宏。[#26913](https://github.com/ClickHouse/ClickHouse/pull/26913) ([polyprogrammist](https://github.com/PolyProgrammist))。
* 新增函数 `currentRoles()`, `enabledRoles()`, `defaultRoles()`. [#26780](https://github.com/ClickHouse/ClickHouse/pull/26780) ([Vitaly Baranov](https://github.com/vitlibar)).
* 新增函数：`currentProfiles()`, `enabledProfiles()`, `defaultProfiles()`. [#26714](https://github.com/ClickHouse/ClickHouse/pull/26714) ([Vitaly Baranov](https://github.com/vitlibar)).
* 新增可返回当前查询（initial&#95;)query&#95;id 的函数。此更改解决了 [#23682](https://github.com/ClickHouse/ClickHouse/issues/23682)。[#26410](https://github.com/ClickHouse/ClickHouse/pull/26410)（[Alexey Boykov](https://github.com/mathalex)）。
* 新增 `REPLACE GRANT` 功能。 [#26384](https://github.com/ClickHouse/ClickHouse/pull/26384) ([Caspian](https://github.com/Cas-pian)).
* `EXPLAIN` 查询现在新增了 `EXPLAIN ESTIMATE ...` 模式，用于显示 MergeTree 表中读取的行数、marks 和 parts 信息。修复了 [#23941](https://github.com/ClickHouse/ClickHouse/issues/23941)。[#26131](https://github.com/ClickHouse/ClickHouse/pull/26131) ([fastio](https://github.com/fastio))。
* 新增 `system.zookeeper_log` 表。ZooKeeper 客户端的所有操作都会记录到该表中。实现了 [#25449](https://github.com/ClickHouse/ClickHouse/issues/25449)。[#26129](https://github.com/ClickHouse/ClickHouse/pull/26129) ([tavplubix](https://github.com/tavplubix))。
* 为基于 `HDFS` 存储的 `ReplicatedMergeTree` 实现零拷贝复制。 [#25918](https://github.com/ClickHouse/ClickHouse/pull/25918) ([Zhichang Yu](https://github.com/yuzhichang)).
* 允许在 `Arrow`、`ORC` 和 `Parquet` 输入格式中，将 `Nested` 类型作为结构体数组进行插入。 [#25902](https://github.com/ClickHouse/ClickHouse/pull/25902) ([Kruglov Pavel](https://github.com/Avogar)).
* 新增数据类型 `Date32`（以 Int32 存储数据），支持与 `DateTime64` 相同的日期范围，支持将 Parquet 的 `date32` 加载到 ClickHouse 的 `Date32`，并新增类似 `toDate` 的函数 `toDate32`。 [#25774](https://github.com/ClickHouse/ClickHouse/pull/25774) ([LiuNeng](https://github.com/liuneng1994)).
* 允许为用户配置默认数据库。[#25268](https://github.com/ClickHouse/ClickHouse/issues/25268)。[#25687](https://github.com/ClickHouse/ClickHouse/pull/25687) ([kevin wan](https://github.com/MaxWk))。
* 为 `MongoDB` 引擎添加一个可选参数，用于接收连接字符串选项并支持 SSL 连接。修复 [#21189](https://github.com/ClickHouse/ClickHouse/issues/21189)。修复 [#21041](https://github.com/ClickHouse/ClickHouse/issues/21041)。[#22045](https://github.com/ClickHouse/ClickHouse/pull/22045)（[Omar Bazaraa](https://github.com/OmarBazaraa)）。

#### 实验性功能 {#experimental-feature-3}

- 新增压缩编解码器 `AES_128_GCM_SIV`,用于加密列而非压缩列。[#19896](https://github.com/ClickHouse/ClickHouse/pull/19896) ([PHO](https://github.com/depressed-pho))。该功能将被重写,请勿使用。
- 将 `MaterializeMySQL` 重命名为 `MaterializedMySQL`。[#26822](https://github.com/ClickHouse/ClickHouse/pull/26822) ([tavplubix](https://github.com/tavplubix))。

#### 性能改进 {#performance-improvement-3}

- 通过减少 `clock_gettime` 系统调用次数,提升 `max_execution_time = 0` 时快速查询的性能。[#27325](https://github.com/ClickHouse/ClickHouse/pull/27325) ([filimonov](https://github.com/filimonov))。
- 针对日期时间相关比较进行专门优化以提升性能。此修复解决了 [#27083](https://github.com/ClickHouse/ClickHouse/issues/27083)。[#27122](https://github.com/ClickHouse/ClickHouse/pull/27122) ([Amos Bird](https://github.com/amosbird))。
- 在并发读取相同文件时共享文件描述符。在 Linux 上性能差异不明显,但在典型服务器上打开的文件数量将显著减少(10 到 100 倍),从而简化操作。参见 [#26214](https://github.com/ClickHouse/ClickHouse/issues/26214)。[#26768](https://github.com/ClickHouse/ClickHouse/pull/26768) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 改善需要从具有大量列的表中读取数据的短查询的延迟。[#26371](https://github.com/ClickHouse/ClickHouse/pull/26371) ([Anton Popov](https://github.com/CurtizJ))。
- 在分析查询时不为索引构建集合。[#26365](https://github.com/ClickHouse/ClickHouse/pull/26365) ([Raúl Marín](https://github.com/Algunenano))。
- 对具有原生表示的可空整数类型的 SUM 进行向量化 ([David Manzanares](https://github.com/davidmanzanares)、[Raúl Marín](https://github.com/Algunenano))。[#26248](https://github.com/ClickHouse/ClickHouse/pull/26248) ([Raúl Marín](https://github.com/Algunenano))。
- 编译涉及 `Enum` 类型列的表达式。[#26237](https://github.com/ClickHouse/ClickHouse/pull/26237) ([Maksim Kita](https://github.com/kitaisreal))。
- 编译聚合函数 `groupBitOr`、`groupBitAnd`、`groupBitXor`。[#26161](https://github.com/ClickHouse/ClickHouse/pull/26161) ([Maksim Kita](https://github.com/kitaisreal))。
- 通过在读取空 DEFAULT 列时更好地预测块大小来改善内存使用。关闭 [#17317](https://github.com/ClickHouse/ClickHouse/issues/17317)。[#25917](https://github.com/ClickHouse/ClickHouse/pull/25917) ([Vladimir Chebotarev](https://github.com/excitoon))。
- 减少带有 `ORDER BY primary_key` 的查询中的内存使用和读取行数。[#25721](https://github.com/ClickHouse/ClickHouse/pull/25721) ([Anton Popov](https://github.com/CurtizJ))。
- 默认启用 `distributed_push_down_limit`。[#27104](https://github.com/ClickHouse/ClickHouse/pull/27104) ([Azat Khuzhin](https://github.com/azat))。
- 当 timeZone 为常量值时使 `toTimeZone` 具有单调性,以支持在使用类似 SQL 时进行分区裁剪。[#26261](https://github.com/ClickHouse/ClickHouse/pull/26261) ([huangzhaowei](https://github.com/SaintBacchus))。

#### 改进 {#improvement-3}


* 将窗口函数标记为可正式投入使用。移除 `allow_experimental_window_functions` 设置。[#27184](https://github.com/ClickHouse/ClickHouse/pull/27184) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* 改进对非整分钟时区偏移的兼容性。 [#27080](https://github.com/ClickHouse/ClickHouse/pull/27080) ([Raúl Marín](https://github.com/Algunenano)).
* 如果 `File` 表中的文件描述符指向的是常规文件，则允许对其进行多次读取。这样，当 stdin 是一个常规文件时，`clickhouse-local` 就可以从 stdin 多次读取（通过多个 SELECT 查询或子查询），例如：`clickhouse-local --query "SELECT * FROM table UNION ALL SELECT * FROM table" ... < file`。此更改解决了 [#11124](https://github.com/ClickHouse/ClickHouse/issues/11124)。由 ([alexey-milovidov](https://github.com/alexey-milovidov)) 合作完成。[#25960](https://github.com/ClickHouse/ClickHouse/pull/25960)（[BoloniniD](https://github.com/BoloniniD)）。
* 移除重复的索引分析，并在投影分析期间避免可能无效的 `LIMIT` 检查。[#27742](https://github.com/ClickHouse/ClickHouse/pull/27742) ([Amos Bird](https://github.com/amosbird))。
* 支持在 HTTP 请求正文中传递查询参数。 [#27706](https://github.com/ClickHouse/ClickHouse/pull/27706) ([Hermano Lustosa](https://github.com/hllustosa)).
* 在分区表达式中禁止使用 `arrayJoin`。[#27648](https://github.com/ClickHouse/ClickHouse/pull/27648)（[Raúl Marín](https://github.com/Algunenano)）。
* 如果身份验证失败，则记录客户端 IP 地址。[#27514](https://github.com/ClickHouse/ClickHouse/pull/27514) ([Misko Lee](https://github.com/imiskolee)).
* 在 GRPC 协议中，将二进制数据由字符串改为使用 bytes 类型。[#27431](https://github.com/ClickHouse/ClickHouse/pull/27431) ([Vitaly Baranov](https://github.com/vitlibar))。
* 如果未设置 HTTP 端口，而用户尝试向 TCP 端口发送 HTTP 请求，则返回包含错误消息的响应。 [#27385](https://github.com/ClickHouse/ClickHouse/pull/27385) ([Braulio Valdivielso Martínez](https://github.com/BraulioVM)).
* 为内部使用添加 `_CAST` 函数，该函数不会保留类型的可空性，而普通（非内部）的 cast 将根据设置 `cast_keep_nullable` 来保留可空性。关闭 [#12636](https://github.com/ClickHouse/ClickHouse/issues/12636)。 [#27382](https://github.com/ClickHouse/ClickHouse/pull/27382)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 新增 `log_formatted_queries` 设置，用于在 `system.query_log` 中记录额外的已格式化查询。对于规范化查询分析，这非常有用，因为 `normalizeQuery` 和 `normalizeQueryKeepNames` 等函数为了获得更好的性能，并不会对查询进行解析或格式化。[#27380](https://github.com/ClickHouse/ClickHouse/pull/27380) ([Amos Bird](https://github.com/amosbird))。
* 添加两个设置项 `max_hyperscan_regexp_length` 和 `max_hyperscan_regexp_total_length`，以防止在 hyperscan 相关函数（例如 `multiMatchAny`）中使用过大的正则表达式。 [#27378](https://github.com/ClickHouse/ClickHouse/pull/27378) ([Amos Bird](https://github.com/amosbird))。
* 现在，位图聚合函数消耗的内存也会被计入内存限制。这解决了 [#26555](https://github.com/ClickHouse/ClickHouse/issues/26555)。[#27252](https://github.com/ClickHouse/ClickHouse/pull/27252)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 S3 代理解析器添加 10 秒的缓存。[#27216](https://github.com/ClickHouse/ClickHouse/pull/27216) ([ianton-ru](https://github.com/ianton-ru))。
* 将全局互斥锁拆分为针对每个正则表达式构造的独立互斥锁。这样可以避免耗时的正则表达式构造阻塞其他相关线程。[#27211](https://github.com/ClickHouse/ClickHouse/pull/27211) ([Amos Bird](https://github.com/amosbird))。
* 为 PostgreSQL 数据库引擎提供 schema 支持。关闭 [#27166](https://github.com/ClickHouse/ClickHouse/issues/27166)。[#27198](https://github.com/ClickHouse/ClickHouse/pull/27198)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在 clickhouse-client 中追踪内存使用情况。 [#27191](https://github.com/ClickHouse/ClickHouse/pull/27191) ([Filatenkov Artur](https://github.com/FArthur-cmd))。
* 即使查询无法启动，也会尝试在 `system.query_log` 中记录 `query_kind`。 [#27182](https://github.com/ClickHouse/ClickHouse/pull/27182) ([Amos Bird](https://github.com/amosbird))。
* 在表 `system.replicas` 中新增列 `replica_is_active`，用于将副本名称映射到该副本是否处于活跃状态。修复了 [#27138](https://github.com/ClickHouse/ClickHouse/issues/27138)。[#27180](https://github.com/ClickHouse/ClickHouse/pull/27180)（[Maksim Kita](https://github.com/kitaisreal)）。
* 允许在 Web UI 中通过服务器 URI 传递查询设置。 [#27177](https://github.com/ClickHouse/ClickHouse/pull/27177) ([kolsys](https://github.com/kolsys))。
* 添加一个名为 `MaxPushedDDLEntryID` 的新指标，用于表示当前节点推送到 ZooKeeper 的最大 DDL entry ID。 [#27174](https://github.com/ClickHouse/ClickHouse/pull/27174) ([Fuwang Hu](https://github.com/fuwhu)).
* 在 `clickhouse-keeper` 创建 znode 时，改进了对存在条件和空字符串节点的判断。[#27125](https://github.com/ClickHouse/ClickHouse/pull/27125) ([小路](https://github.com/nicelulu)).
* Merge JOIN 现在可以正确处理右侧的空集合。[#27078](https://github.com/ClickHouse/ClickHouse/pull/27078)（[Vladimir C](https://github.com/vdimir)）。
* 现在，这些函数可以作为分片级常量使用，这意味着如果它们在某个分布式表的上下文中执行，就会生成一个普通列，否则则返回一个常量值。值得注意的函数包括：`hostName()`, `tcpPort()`, `version()`, `buildId()`, `uptime()` 等。[#27020](https://github.com/ClickHouse/ClickHouse/pull/27020)（[Amos Bird](https://github.com/amosbird)）。
* 更新了 `extractAllGroupsHorizontal` —— 可以通过可选的第三个参数设置每行匹配次数的上限。 [#26961](https://github.com/ClickHouse/ClickHouse/pull/26961) ([Vasily Nemkov](https://github.com/Enmk)).
* 通过 `system.rocksdb` 表公开 `RocksDB` 统计信息。从 ClickHouse 配置中读取 RocksDB 选项（`rocksdb...` 键）。注意：ClickHouse 不依赖 RocksDB，它只是众多可集成的附加存储引擎之一。 [#26821](https://github.com/ClickHouse/ClickHouse/pull/26821) ([Azat Khuzhin](https://github.com/azat)).
* 更精简的 RocksDB 内部日志。注意：ClickHouse 并不依赖 RocksDB，它只是额外集成的存储引擎之一。此更改关闭了 [#26252](https://github.com/ClickHouse/ClickHouse/issues/26252)。[#26789](https://github.com/ClickHouse/ClickHouse/pull/26789)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 更改默认角色仅会影响新的会话。[#26759](https://github.com/ClickHouse/ClickHouse/pull/26759)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 默认情况下，Docker 中会禁用 `watchdog`。修复了未处理 `Ctrl+C` 的问题。 [#26757](https://github.com/ClickHouse/ClickHouse/pull/26757) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* `SET PROFILE` 现在也会应用为传入的 profile 设置的约束条件。[#26730](https://github.com/ClickHouse/ClickHouse/pull/26730) ([Vitaly Baranov](https://github.com/vitlibar)).
* 改进对 `KILL QUERY` 请求的处理。[#26675](https://github.com/ClickHouse/ClickHouse/pull/26675)（[Raúl Marín](https://github.com/Algunenano)）。
* `mapPopulatesSeries` 函数现已支持 `Map` 类型。 [#26663](https://github.com/ClickHouse/ClickHouse/pull/26663) ([Ildus Kurbangaliev](https://github.com/ildus))。
* 修复在使用 `skip_unavailable_shards` 时成倍（x2）增加的连接尝试次数。 [#26658](https://github.com/ClickHouse/ClickHouse/pull/26658) ([Azat Khuzhin](https://github.com/azat)).
* 在连接失败时（例如出现 EMFILE 错误）避免 `clickhouse-benchmark` 发生挂起。 [#26656](https://github.com/ClickHouse/ClickHouse/pull/26656) ([Azat Khuzhin](https://github.com/azat)).
* 允许 Kafka 引擎使用更多线程。 [#26642](https://github.com/ClickHouse/ClickHouse/pull/26642) ([feihengye](https://github.com/feihengye))。
* 为 `clickhouse-benchmark` 添加轮询（round-robin）模式支持（除统计报告外，与常规的多主机/端口运行方式没有区别）。 [#26607](https://github.com/ClickHouse/ClickHouse/pull/26607) ([Azat Khuzhin](https://github.com/azat)).
* 可执行字典（`executable`、`executable_pool`）现在可以在 `clickhouse-local` 中通过 DDL 查询创建。修复 [#22355](https://github.com/ClickHouse/ClickHouse/issues/22355)。[#26510](https://github.com/ClickHouse/ClickHouse/pull/26510)（[Maksim Kita](https://github.com/kitaisreal)）。
* 为 `mysql` 和 `postgresql` 兼容协议处理程序设置客户端查询种类。 [#26498](https://github.com/ClickHouse/ClickHouse/pull/26498) ([anneji-dev](https://github.com/anneji-dev)).
* 对于类似 `SELECT * FROM dist ORDER BY key LIMIT 10` 的查询，在分片上下推并应用 `LIMIT`，方式是设置 `distributed_push_down_limit=1`。避免在类似 `SELECT DISTINCT shading_key FROM dist ORDER BY key` 的查询中执行 `Distinct`/`LIMIT BY` 步骤。现在 `distributed_push_down_limit` 已会被 `optimize_distributed_group_by_sharding_key` 优化所遵循。[#26466](https://github.com/ClickHouse/ClickHouse/pull/26466)（[Azat Khuzhin](https://github.com/azat)）。
* 将 protobuf 更新到 3.17.3。变更日志可在 [https://github.com/protocolbuffers/protobuf/releases](https://github.com/protocolbuffers/protobuf/releases) 查看。[#26424](https://github.com/ClickHouse/ClickHouse/pull/26424)（[Ilya Yatsishin](https://github.com/qoega)）。
* 启用 `use_hedged_requests` 设置，以降低大型集群中的尾延迟。[#26380](https://github.com/ClickHouse/ClickHouse/pull/26380) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 改进在用户允许的主机列表中找不到对应主机时的行为。 [#26368](https://github.com/ClickHouse/ClickHouse/pull/26368) ([ianton-ru](https://github.com/ianton-ru)).
* 新增可通过 CREATE TABLE 设置 `Distributed` 目录监控器配置的功能（例如：`CREATE TABLE dist (key Int) Engine=Distributed(cluster, db, table) SETTINGS monitor_batch_inserts=1` 等类似用法)。 [#26336](https://github.com/ClickHouse/ClickHouse/pull/26336) ([Azat Khuzhin](https://github.com/azat)).
* 如果服务器地址与 Web UI 的来源地址不同，则在 Web UI 的历史 URL 中保存该服务器地址。修复了 [#26044](https://github.com/ClickHouse/ClickHouse/issues/26044)。[#26322](https://github.com/ClickHouse/ClickHouse/pull/26322)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为对 `sleep` / `sleepEachRow` 的 profile 调用添加事件。 [#26320](https://github.com/ClickHouse/ClickHouse/pull/26320) ([Raúl Marín](https://github.com/Algunenano)).
* 允许在不同集群之间复用分片连接，同时在使用 `cluster` 表函数时避免创建新的连接。[#26318](https://github.com/ClickHouse/ClickHouse/pull/26318)（[Amos Bird](https://github.com/amosbird)）。
* 通过带有默认值的参数控制清理旧临时目录的执行周期。 [#26212](https://github.com/ClickHouse/ClickHouse/issues/26212). [#26313](https://github.com/ClickHouse/ClickHouse/pull/26313) ([fastio](https://github.com/fastio)).
* 添加设置 `function_range_max_elements_in_block`，用于调整函数 `range` 生成数据量的安全阈值。该更改关闭了 [#26303](https://github.com/ClickHouse/ClickHouse/issues/26303)。[#26305](https://github.com/ClickHouse/ClickHouse/pull/26305)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在创建表时检查哈希函数，而不是在采样时检查。为 MergeTree 添加相关设置；如果有人使用了不正确的采样列创建表，但从未使用采样，则可以禁用此设置，以便在启动服务器时不会抛出异常。 [#26256](https://github.com/ClickHouse/ClickHouse/pull/26256) ([zhaoyu](https://github.com/zxc111))。
* 添加了 `output_format_avro_string_column_pattern` 设置，用于将指定的 String 列在 Avro 中以 string 而非默认的 bytes 形式输出。实现了 [#22414](https://github.com/ClickHouse/ClickHouse/issues/22414)。[#26245](https://github.com/ClickHouse/ClickHouse/pull/26245)（[Ilya Golshtein](https://github.com/ilejn)）。
* 在 `system.columns` 表中为 `Log` 和 `TinyLog` 表添加列大小相关信息。这一更改修复了 [#9001](https://github.com/ClickHouse/ClickHouse/issues/9001)。[#26241](https://github.com/ClickHouse/ClickHouse/pull/26241)（[Nikolay Degterinsky](https://github.com/evillique)）。
* 在查询 `system.detached_parts` 表时，如果存在自定义磁盘配置且某些磁盘上不存在 `detached` 目录，不再抛出异常。修复了 [#26078](https://github.com/ClickHouse/ClickHouse/issues/26078)。[#26236](https://github.com/ClickHouse/ClickHouse/pull/26236)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 检查键中是否存在非确定性函数，包括诸如 `now()`、`today()` 等常量表达式。修复了 [#25875](https://github.com/ClickHouse/ClickHouse/issues/25875)。修复了 [#11333](https://github.com/ClickHouse/ClickHouse/issues/11333)。[#26235](https://github.com/ClickHouse/ClickHouse/pull/26235)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 PostgreSQL 表引擎中将 timestamp 和 timestamptz 数据类型转换为 `DateTime64`。[#26234](https://github.com/ClickHouse/ClickHouse/pull/26234) ([jasine](https://github.com/jasine))。
* 对投影应用更激进的 IN 索引分析，以便选择更优的投影候选项。 [#26218](https://github.com/ClickHouse/ClickHouse/pull/26218) ([Amos Bird](https://github.com/amosbird)).
* 当传入标量函数时，移除 `IN` 的 `GLOBAL` 关键字。在早期版本中，如果用户指定 `GLOBAL IN f(x)` 会抛出异常。[#26217](https://github.com/ClickHouse/ClickHouse/pull/26217) ([Amos Bird](https://github.com/amosbird)).
* 在异常消息中添加错误 ID（例如 `BAD_ARGUMENTS`）。此更改关闭了 [#25862](https://github.com/ClickHouse/ClickHouse/issues/25862)。[#26172](https://github.com/ClickHouse/ClickHouse/pull/26172)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在 `clickhouse-local` 中使用 `--progress` 选项时的错误输出。进度条在达到 100% 后会被清除——与 `clickhouse-client` 的行为相同。修复 [#17484](https://github.com/ClickHouse/ClickHouse/issues/17484)。[#26128](https://github.com/ClickHouse/ClickHouse/pull/26128)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 新增 `merge_selecting_sleep_ms` 设置。[#26120](https://github.com/ClickHouse/ClickHouse/pull/26120)（[lthaooo](https://github.com/lthaooo)）。
* 移除了使用 Linux AIO 搭配单块预读的复杂方案，改为使用带有 O&#95;DIRECT 的简单同步 IO。在先前的版本中，如果 `max_threads` 大于一，设置 `min_bytes_to_use_direct_io` 可能无法正确生效。使用 direct IO（对查询默认禁用、对大型合并默认启用）进行读取的效率会有所下降。此更改关闭了 [#25997](https://github.com/ClickHouse/ClickHouse/issues/25997)。[#26003](https://github.com/ClickHouse/ClickHouse/pull/26003)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在执行 `REPLACE TABLE` 查询时刷新 `Distributed` 表。解决 [#24566](https://github.com/ClickHouse/ClickHouse/issues/24566) —— 当向新表插入数据失败时，不在 `[CREATE OR] REPLACE TABLE ... AS SELECT` 查询中替换（或创建）表。解决 [#23175](https://github.com/ClickHouse/ClickHouse/issues/23175)。[#25895](https://github.com/ClickHouse/ClickHouse/pull/25895)（[tavplubix](https://github.com/tavplubix)）。
* 向 `system.query&#95;log` 添加 `views` 列，其中包含查询执行的（物化或实时）视图名称。新增一个日志表（`system.query_views_log`），其中包含关于查询期间每个被执行视图的信息。修改视图执行逻辑：在执行视图时抛出异常的情况下，任何已经开始执行的视图都会继续运行直到完成。此前这种行为仅在 `parallel&#95;view&#95;processing=true` 时生效，现在始终采用这种行为。- 依赖视图现在会向上下文报告读取进度。[#25714](https://github.com/ClickHouse/ClickHouse/pull/25714) ([Raúl Marín](https://github.com/Algunenano)).
* 在执行完分布式查询后异步进行连接回收。新增服务器设置 `max_threads_for_connection_collector`，用于指定在后台回收连接的工作线程数量。如果连接池已满，则会同步回收连接，但行为与之前略有不同：在向客户端发送 EOS 后再进行回收；查询在收到足够数据后会立即成功，任何异常会被记录到日志中，而不会抛给客户端。新增设置 `drain_timeout`（默认 3 秒）。连接回收在超时后会断开连接。[#25674](https://github.com/ClickHouse/ClickHouse/pull/25674)（[Amos Bird](https://github.com/amosbird)）。
* 在配置中支持多个 include。可以从多个来源引入 users 配置和 remote servers 配置。只需放置一个带有 `from_zk`、`from_env` 或 `incl` 属性的 `<include />` 元素，它就会被替换为相应的内容。[#24404](https://github.com/ClickHouse/ClickHouse/pull/24404) ([nvartolomei](https://github.com/nvartolomei))。
* 修复在 `insert_distributed_one_random_shard = 1` 时向分布式表插入多个数据块的问题。该功能较为边缘。标记为改进。 [#23140](https://github.com/ClickHouse/ClickHouse/pull/23140) ([Amos Bird](https://github.com/amosbird)).
* 为 `Map` 类型的键/值提供对 `LowCardinality` 和 `FixedString` 的支持。 [#21543](https://github.com/ClickHouse/ClickHouse/pull/21543) ([hexiaoting](https://github.com/hexiaoting)).
* 支持重新加载本地磁盘配置。[#19526](https://github.com/ClickHouse/ClickHouse/pull/19526) ([taiyang-li](https://github.com/taiyang-li))。

#### 错误修复 {#bug-fix-2}


* 修复了可能导致副本状态不一致的几个错误。 [#27808](https://github.com/ClickHouse/ClickHouse/pull/27808) ([tavplubix](https://github.com/tavplubix)).
* 修复了 `DROP PART` 中一个罕见的 bug，它可能会导致出现错误 `Unexpected merged part intersects drop range`。 [#27807](https://github.com/ClickHouse/ClickHouse/pull/27807) ([alesapin](https://github.com/alesapin)).
* 修复了当来自 Kafka 的 NULL（墓碑）消息到来时，某些格式会导致崩溃的问题。关闭了 [#19255](https://github.com/ClickHouse/ClickHouse/issues/19255)。[#27794](https://github.com/ClickHouse/ClickHouse/pull/27794)（[filimonov](https://github.com/filimonov)）。
* 修复在子查询中使用 `union distinct` 时的列过滤问题。解决 [#27578](https://github.com/ClickHouse/ClickHouse/issues/27578)。[#27689](https://github.com/ClickHouse/ClickHouse/pull/27689)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在对由不同非数值类型（例如 `DateTime` 和 `DateTime64`）的 Nullable 的 LowCardinality 组成的数组应用 `arrayHas` 等函数时出现的错误类型转换的问题。在之前的版本中会发生错误的类型转换，在新版本中则会改为抛出异常。这一更改关闭了 [#26330](https://github.com/ClickHouse/ClickHouse/issues/26330)。[#27682](https://github.com/ClickHouse/ClickHouse/pull/27682)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `postgresql` 表函数导致的连接未正常关闭的问题。修复 [#26088](https://github.com/ClickHouse/ClickHouse/issues/26088)。[#27662](https://github.com/ClickHouse/ClickHouse/pull/27662)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复了另一种会触发 `Unexpected merged part ... intersecting drop range ...` 错误的情况。[#27656](https://github.com/ClickHouse/ClickHouse/pull/27656) ([tavplubix](https://github.com/tavplubix))。
* 修复 `Distributed` 表中别名列相关的错误。[#27652](https://github.com/ClickHouse/ClickHouse/pull/27652) ([Vladimir C](https://github.com/vdimir)).
* 在将 `max_memory_usage*` 设置为非零值后，就无法再将其重置为 0（表示无限制）。该问题已修复。[#27638](https://github.com/ClickHouse/ClickHouse/pull/27638) ([tavplubix](https://github.com/tavplubix))。
* 修复了从各组成部分构造时间值时出现的下溢问题。修复了 [#27193](https://github.com/ClickHouse/ClickHouse/issues/27193)。[#27605](https://github.com/ClickHouse/ClickHouse/pull/27605)（[Vasily Nemkov](https://github.com/Enmk)）。
* 修复在某些 part 缺少列时进行 projection 物化时发生的崩溃问题。修复了 [#27512](https://github.com/ClickHouse/ClickHouse/issues/27512)。[#27528](https://github.com/ClickHouse/ClickHouse/pull/27528)（[Amos Bird](https://github.com/amosbird)）。
* 修复指标 `BackgroundMessageBrokerSchedulePoolTask`，之前可能有拼写错误。[#27452](https://github.com/ClickHouse/ClickHouse/pull/27452) ([Ben](https://github.com/benbiti))。
* 修复在零分片场景下包含聚合的分布式查询。 [#27427](https://github.com/ClickHouse/ClickHouse/pull/27427) ([Azat Khuzhin](https://github.com/azat)).
* 在 `/proc/meminfo` 不包含 KB 后缀时的兼容性。[#27361](https://github.com/ClickHouse/ClickHouse/pull/27361) ([Mike Kot](https://github.com/myrrc))。
* 修复在使用行级安全、`PREWHERE` 和 `LowCardinality` 过滤条件的查询中出现的错误结果。修复了 [#27179](https://github.com/ClickHouse/ClickHouse/issues/27179)。[#27329](https://github.com/ClickHouse/ClickHouse/pull/27329)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了使用旧语法创建的 MergeTree 表中分区 ID 的错误验证。[#27328](https://github.com/ClickHouse/ClickHouse/pull/27328) ([tavplubix](https://github.com/tavplubix)).
* 在使用并行格式（CSV / TSV）时修复了 MySQL 协议。 [#27326](https://github.com/ClickHouse/ClickHouse/pull/27326) ([Raúl Marín](https://github.com/Algunenano)).
* 修复带有 sampling 的查询出现 `Cannot find column` 错误的问题。该问题最初在 [#24574](https://github.com/ClickHouse/ClickHouse/issues/24574) 中被引入。本次修复解决了 [#26522](https://github.com/ClickHouse/ClickHouse/issues/26522)。[#27301](https://github.com/ClickHouse/ClickHouse/pull/27301)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复某些在 `PREWHERE` 中使用 `LowCardinality` 的查询中出现的错误，例如 `Expected ColumnLowCardinality, gotUInt8` 或 `Bad cast from type DB::ColumnVector<char8_t> to DB::ColumnLowCardinality`。更重要的是，修复错误消息中缺少空格的问题。修复了 [#23515](https://github.com/ClickHouse/ClickHouse/issues/23515)。[#27298](https://github.com/ClickHouse/ClickHouse/pull/27298)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复 `distributed_group_by_no_merge = 2` 与 `distributed_push_down_limit = 1` 或 `optimize_distributed_group_by_sharding_key = 1` 搭配 `LIMIT BY` 和 `LIMIT OFFSET` 时的问题。[#27249](https://github.com/ClickHouse/ClickHouse/pull/27249)（[Azat Khuzhin](https://github.com/azat)）。这些是几乎没有人会使用的冷门配置组合。
* 修复非复制 MergeTree 中因无效分区而卡住的 mutation。 [#27248](https://github.com/ClickHouse/ClickHouse/pull/27248) ([Azat Khuzhin](https://github.com/azat)).
* 在存在歧义的情况下，lambda 函数会优先将其参数解释为标识符，而不是使用其他别名或标识符。[#27235](https://github.com/ClickHouse/ClickHouse/pull/27235)（[Raúl Marín](https://github.com/Algunenano)）。
* 修复合并连接中的列结构，解决 [#27091](https://github.com/ClickHouse/ClickHouse/issues/27091)。[#27217](https://github.com/ClickHouse/ClickHouse/pull/27217)（[Vladimir C](https://github.com/vdimir)）。
* 在极少数情况下，`system.detached_parts` 表中可能会包含某些数据部分的不正确信息，此问题已修复。修复了 [#27114](https://github.com/ClickHouse/ClickHouse/issues/27114)。[#27183](https://github.com/ClickHouse/ClickHouse/pull/27183)（[tavplubix](https://github.com/tavplubix)）。
* 修复函数 `multiSearch*` 在使用空数组时的未初始化内存问题，关闭 [#27169](https://github.com/ClickHouse/ClickHouse/issues/27169)。[#27181](https://github.com/ClickHouse/ClickHouse/pull/27181)（[Vladimir C](https://github.com/vdimir)）。
* 修复 `GRPCServer` 中的同步问题。此 PR 解决了 [#27024](https://github.com/ClickHouse/ClickHouse/issues/27024)。[#27064](https://github.com/ClickHouse/ClickHouse/pull/27064)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复了 `cache`、`complex_key_cache`、`ssd_cache`、`complex_key_ssd_cache` 配置的解析问题。选项 `allow_read_expired_keys`、`max_update_queue_size`、`update_queue_push_timeout_milliseconds`、`query_wait_timeout_milliseconds` 之前不会被解析到非 `cache` 类型的字典中。 [#27032](https://github.com/ClickHouse/ClickHouse/pull/27032) ([Maksim Kita](https://github.com/kitaisreal))。
* 修复与 `DROP_RANGE` 竞争条件可能导致的变更堆栈问题。 [#27002](https://github.com/ClickHouse/ClickHouse/pull/27002) ([Azat Khuzhin](https://github.com/azat)).
* 现在在类似 `ALTER TABLE ... PARTITION ID xxx` 的查询中，会对分区 ID 进行正确性校验。修复了 [#25718](https://github.com/ClickHouse/ClickHouse/issues/25718)。[#26963](https://github.com/ClickHouse/ClickHouse/pull/26963)（[alesapin](https://github.com/alesapin)）。
* 在某些包含多个 `JOIN` 的情况中修复出现的“Unknown column name”错误，关闭 [#26899](https://github.com/ClickHouse/ClickHouse/issues/26899)。[#26957](https://github.com/ClickHouse/ClickHouse/pull/26957)（[Vladimir C](https://github.com/vdimir)）。
* 修复自定义 TLD 的读取问题（在缓冲区较小或文件较大时会停止处理）。 [#26948](https://github.com/ClickHouse/ClickHouse/pull/26948) ([Azat Khuzhin](https://github.com/azat))。
* 修复在带有 `DEFAULT` 的列引用其他没有 `DEFAULT` 表达式的非物化列时出现的错误 `Missing columns: 'xxx'`。修复了 [#26591](https://github.com/ClickHouse/ClickHouse/issues/26591)。[#26900](https://github.com/ClickHouse/ClickHouse/pull/26900)（[alesapin](https://github.com/alesapin)）。
* 修复在 `library` 字典源中通过 `library-bridge` 加载字典键的方式。[#26834](https://github.com/ClickHouse/ClickHouse/pull/26834)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在应用某些组合器时，聚合函数的参数可能会丢失，从而导致出现类似 `Conversion from AggregateFunction(topKArray, Array(String)) to AggregateFunction(topKArray(10), Array(String)) is not supported` 的异常。该问题已修复。修复了 [#26196](https://github.com/ClickHouse/ClickHouse/issues/26196) 和 [#26433](https://github.com/ClickHouse/ClickHouse/issues/26433)。[#26814](https://github.com/ClickHouse/ClickHouse/pull/26814)（[tavplubix](https://github.com/tavplubix)）。
* 为 `system.part_log` 中的 `REMOVE_PART` 添加 `event_time_microseconds` 值。此前版本中未设置该值。 [#26720](https://github.com/ClickHouse/ClickHouse/pull/26720) ([Azat Khuzhin](https://github.com/azat)).
* 在关闭 `ReplicatedMergeTree` 表时不要删除数据，以避免导致数据与元数据不一致。 [#26716](https://github.com/ClickHouse/ClickHouse/pull/26716) ([nvartolomei](https://github.com/nvartolomei)).
* 有时 `SET ROLE` 的行为可能不正确，本 PR 对其进行了修复。[#26707](https://github.com/ClickHouse/ClickHouse/pull/26707) ([Vitaly Baranov](https://github.com/vitlibar))。
* 针对并行格式的一些修复（[https://github.com/ClickHouse/ClickHouse/issues/26694](https://github.com/ClickHouse/ClickHouse/issues/26694)）。[#26703](https://github.com/ClickHouse/ClickHouse/pull/26703)（[Raúl Marín](https://github.com/Algunenano)）。
* 修复窗口函数中潜在的 `nullptr` 解引用问题。该修复对应 issue [#25276](https://github.com/ClickHouse/ClickHouse/issues/25276)。[#26668](https://github.com/ClickHouse/ClickHouse/pull/26668)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* 修复在从 3 年前版本的 `clickhouse-client` 历史记录文件格式升级时，当文件为空时的转换问题。[#26589](https://github.com/ClickHouse/ClickHouse/pull/26589) ([Azat Khuzhin](https://github.com/azat))。
* 修复 `groupBitmapAnd`/`groupBitmapOr`/`groupBitmapXor` 函数名称显示不正确的问题（在某些情况下可能会被显示）。[#26557](https://github.com/ClickHouse/ClickHouse/pull/26557)（[Amos Bird](https://github.com/amosbird)）。
* 更新 clickhouse-server Docker entrypoint 中对 `chown` 命令的检查，修复了在 Kubernetes 上集群 Pod 重启失败（或超时）的问题。[#26545](https://github.com/ClickHouse/ClickHouse/pull/26545) ([Ky Li](https://github.com/Kylinrix))。
* 修复在尚未启动 `RabbitMQ` 时关闭 `RabbitMQ` 会导致的崩溃问题。修复 [#26504](https://github.com/ClickHouse/ClickHouse/issues/26504)。[#26529](https://github.com/ClickHouse/ClickHouse/pull/26529)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在执行 `CREATE DICTIONARY` 查询时，当字典名或数据库名被加引号所导致的问题。修复关联的 issues [#26491](https://github.com/ClickHouse/ClickHouse/issues/26491)、[#26508](https://github.com/ClickHouse/ClickHouse/pull/26508)（[Maksim Kita](https://github.com/kitaisreal)）。
* 在重写列别名后修复了列名解析失效的问题。修复了 [#26432](https://github.com/ClickHouse/ClickHouse/issues/26432)。[#26475](https://github.com/ClickHouse/ClickHouse/pull/26475)（[Amos Bird](https://github.com/amosbird)）。
* 修复了一些由模糊测试触发的 msan 崩溃问题。修复了 [#22517](https://github.com/ClickHouse/ClickHouse/issues/22517)。[#26428](https://github.com/ClickHouse/ClickHouse/pull/26428)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复 `partial_merge_join` 关闭时出现无限非连接块流的问题 [#26325](https://github.com/ClickHouse/ClickHouse/issues/26325)。[#26374](https://github.com/ClickHouse/ClickHouse/pull/26374)（[Vladimir C](https://github.com/vdimir)）。
* 修复以已被删除的用户身份登录时可能发生的崩溃。此 PR 修复了 [#26073](https://github.com/ClickHouse/ClickHouse/issues/26073)。[#26363](https://github.com/ClickHouse/ClickHouse/pull/26363)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复 `optimize_distributed_group_by_sharding_key` 在多列场景下的行为（在 `optimize_skip_unused_shards=1`/`allow_nondeterministic_optimize_skip_unused_shards=1` 且分片键表达式包含多列时会导致结果不正确）。 [#26353](https://github.com/ClickHouse/ClickHouse/pull/26353) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在丢失副本恢复过程中极少出现的、可能导致副本产生分歧的一个错误。 [#26321](https://github.com/ClickHouse/ClickHouse/pull/26321) ([tavplubix](https://github.com/tavplubix)).
* 修复 zstd 解压缩（用于与表数据无关的 zstd 帧格式导入/导出）在内部缓冲区末尾存在转义序列时的行为问题。修复 [#26013](https://github.com/ClickHouse/ClickHouse/issues/26013)。[#26314](https://github.com/ClickHouse/ClickHouse/pull/26314)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复带 `totals` 的 `JOIN` 的逻辑错误，关闭 [#26017](https://github.com/ClickHouse/ClickHouse/issues/26017)。[#26250](https://github.com/ClickHouse/ClickHouse/pull/26250)（[Vladimir C](https://github.com/vdimir)）。
* 移除 `system.stack_trace` 表中 `thread_name` 列中多余的换行符。修复了 [#24124](https://github.com/ClickHouse/ClickHouse/issues/24124)。[#26210](https://github.com/ClickHouse/ClickHouse/pull/26210)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在使用多个 `untuple` 表达式时可能发生的崩溃。[#26179](https://github.com/ClickHouse/ClickHouse/pull/26179) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 如果 Enum 没有零值，则在 Nullable Enum 的 `toString` 中不要抛出异常，修复了 [#25806](https://github.com/ClickHouse/ClickHouse/issues/25806)。[#26123](https://github.com/ClickHouse/ClickHouse/pull/26123)（[Vladimir C](https://github.com/vdimir)）。
* 修复了 ClickHouse 在查询执行期间发生异常时通过 MySQL 协议发送的数据包中不正确的 `sequence_id`。该问题可能会导致 MySQL 客户端重置与 ClickHouse 服务器的连接。修复 [#21184](https://github.com/ClickHouse/ClickHouse/issues/21184)。[#26051](https://github.com/ClickHouse/ClickHouse/pull/26051)（[tavplubix](https://github.com/tavplubix)）。
* 修复了 `cutToFirstSignificantSubdomainCustom()` / `cutToFirstSignificantSubdomainCustomWithWWW()` / `firstSignificantSubdomainCustom()` 在处理常量时返回错误类型的问题，从而导致 `optimize_skip_unused_shards` 不起作用。[#26041](https://github.com/ClickHouse/ClickHouse/pull/26041) ([Azat Khuzhin](https://github.com/azat))。
* 修复在将普通 `projection` 与 `prewhere` 一起使用时可能出现的表头不匹配问题。解决了 [#26020](https://github.com/ClickHouse/ClickHouse/issues/26020)。[#26038](https://github.com/ClickHouse/ClickHouse/pull/26038)（[Amos Bird](https://github.com/amosbird)）。
* 修复了 remote() 在未对列使用函数时获取 sharding&#95;key 的问题（此前 `select * from remote('127.1', system.one, dummy)` 会导致 `Unknown column: dummy, there are only columns .` 错误）。[#25824](https://github.com/ClickHouse/ClickHouse/pull/25824) ([Azat Khuzhin](https://github.com/azat))。
* 修复从 `MaterializeMySQL` 查询时出现的 `Not found column ...` 和 `Missing column ...` 错误。修复了 [#23708](https://github.com/ClickHouse/ClickHouse/issues/23708)、[#24830](https://github.com/ClickHouse/ClickHouse/issues/24830)、[#25794](https://github.com/ClickHouse/ClickHouse/issues/25794)。[#25822](https://github.com/ClickHouse/ClickHouse/pull/25822)（[tavplubix](https://github.com/tavplubix)）。
* 修复了在处理非 UInt64 类型时的 `optimize_skip_unused_shards_rewrite_in` 问题（可能会最终选择错误的分片，或抛出 `Cannot infer type of an empty tuple` 或 `Function tuple requires at least one argument` 异常）。 [#25798](https://github.com/ClickHouse/ClickHouse/pull/25798) ([Azat Khuzhin](https://github.com/azat)).

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-3}

- 现在我们在随机时区中运行有状态和无状态测试。修复 [#12439](https://github.com/ClickHouse/ClickHouse/issues/12439)。在 Protobuf 格式中将 String 读取为 DateTime 以及将 DateTime 写入为 String 现在会遵循时区。在 Arrow 和 Parquet 格式中将 UInt16 读取为 DateTime 时,现在会将其视为 Date,然后根据 DateTime 的时区转换为 DateTime,因为 Date 在 Arrow 和 Parquet 中序列化为 UInt16。GraphiteMergeTree 现在在对时间进行舍入时会遵循时区。修复 [#5098](https://github.com/ClickHouse/ClickHouse/issues/5098)。作者:@alexey-milovidov。[#15408](https://github.com/ClickHouse/ClickHouse/pull/15408) ([alesapin](https://github.com/alesapin))。
- `clickhouse-test` 支持使用 [Jinja2](https://jinja.palletsprojects.com/en/3.0.x/templates/#synopsis) 模板的 SQL 测试。[#26579](https://github.com/ClickHouse/ClickHouse/pull/26579) ([Vladimir C](https://github.com/vdimir))。
- 添加对使用 `clang-13` 构建的支持。这解决了 [#27705](https://github.com/ClickHouse/ClickHouse/issues/27705)。[#27714](https://github.com/ClickHouse/ClickHouse/pull/27714) ([alexey-milovidov](https://github.com/alexey-milovidov))。[#27777](https://github.com/ClickHouse/ClickHouse/pull/27777) ([Sergei Semin](https://github.com/syominsergey))
- 添加 CMake 选项以选择是否使用特定 CPU 指令集进行构建。这是为了 [#17469](https://github.com/ClickHouse/ClickHouse/issues/17469) 和 [#27509](https://github.com/ClickHouse/ClickHouse/issues/27509)。[#27508](https://github.com/ClickHouse/ClickHouse/pull/27508) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 修复使用动态库时辅助程序的链接问题。[#26958](https://github.com/ClickHouse/ClickHouse/pull/26958) ([Raúl Marín](https://github.com/Algunenano))。
- 将 RocksDB 更新至 `2021-07-16` 主分支。[#26411](https://github.com/ClickHouse/ClickHouse/pull/26411) ([alexey-milovidov](https://github.com/alexey-milovidov))。

### ClickHouse 版本 v21.8,2021-08-12 {#clickhouse-release-v218-2021-08-12}

#### 升级说明 {#upgrade-notes}

- 新版本对系统日志表(`system.query_log`、`system.query_thread_log`、`system.processes`、`system.opentelemetry_span_log`)使用 `Map` 数据类型。这些表将使用新的数据类型自动创建。创建虚拟列以支持旧查询。解决 [#18698](https://github.com/ClickHouse/ClickHouse/issues/18698)。[#23934](https://github.com/ClickHouse/ClickHouse/pull/23934)、[#25773](https://github.com/ClickHouse/ClickHouse/pull/25773) ([hexiaoting](https://github.com/hexiaoting)、[sundy-li](https://github.com/sundy-li)、[Maksim Kita](https://github.com/kitaisreal))。如果您想从版本 21.8 _降级_ 到旧版本,您需要手动清理带有日志的系统表。请查看 `/var/lib/clickhouse/data/system/*_log`。

#### 新功能 {#new-features}


- 添加对部分 SQL/JSON 标准的支持。[#24148](https://github.com/ClickHouse/ClickHouse/pull/24148) ([l1tsolaiki](https://github.com/l1tsolaiki), [Kseniia Sumarokova](https://github.com/kssenii))。
- 收集常见系统指标(在 `system.asynchronous_metrics` 和 `system.asynchronous_metric_log` 中),包括 CPU 使用率、磁盘使用率、内存使用率、IO、网络、文件、平均负载、CPU 频率、温度传感器、EDAC 计数器、系统运行时间;还添加了调度抖动和指标收集耗时相关的指标。它的工作方式类似于 ClickHouse 中的 `atop`,即使没有安装额外的工具也能访问监控数据。关闭 [#9430](https://github.com/ClickHouse/ClickHouse/issues/9430)。[#24416](https://github.com/ClickHouse/ClickHouse/pull/24416) ([alexey-milovidov](https://github.com/alexey-milovidov), [Yegor Levankov](https://github.com/elevankoff))。
- 添加 MaterializedPostgreSQL 表引擎和数据库引擎。该数据库引擎允许复制整个数据库或数据库表的任意子集。[#20470](https://github.com/ClickHouse/ClickHouse/pull/20470) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 添加新函数 `leftPad()`、`rightPad()`、`leftPadUTF8()`、`rightPadUTF8()`。[#26075](https://github.com/ClickHouse/ClickHouse/pull/26075) ([Vitaly Baranov](https://github.com/vitlibar))。
- 为 `ADD INDEX` 命令添加 `FIRST` 关键字,以便能够在索引列表的开头添加索引。[#25904](https://github.com/ClickHouse/ClickHouse/pull/25904) ([xjewer](https://github.com/xjewer))。
- 引入 `system.data_skipping_indices` 表,包含现有数据跳过索引的信息。关闭 [#7659](https://github.com/ClickHouse/ClickHouse/issues/7659)。[#25693](https://github.com/ClickHouse/ClickHouse/pull/25693) ([Dmitry Novik](https://github.com/novikd))。
- 添加 `bin`/`unbin` 函数。[#25609](https://github.com/ClickHouse/ClickHouse/pull/25609) ([zhaoyu](https://github.com/zxc111))。
- 在 `mapAdd` 和 `mapSubtract` 函数中支持 `Map` 以及 `UInt128`、`Int128`、`UInt256`、`Int256` 类型。[#25596](https://github.com/ClickHouse/ClickHouse/pull/25596) ([Ildus Kurbangaliev](https://github.com/ildus))。
- 支持 `DISTINCT ON (columns)` 表达式,关闭 [#25404](https://github.com/ClickHouse/ClickHouse/issues/25404)。[#25589](https://github.com/ClickHouse/ClickHouse/pull/25589) ([Zijie Lu](https://github.com/TszKitLo40))。
- 添加将自定义设置重置为默认值并从表的元数据中删除的功能。这允许在不知道系统/配置默认值的情况下回滚更改。关闭 [#14449](https://github.com/ClickHouse/ClickHouse/issues/14449)。[#17769](https://github.com/ClickHouse/ClickHouse/pull/17769) ([xjewer](https://github.com/xjewer))。
- 如果提交 `EXPLAIN PIPELINE graph = 1` 查询,则在 Web UI 中将管道渲染为图形。[#26067](https://github.com/ClickHouse/ClickHouse/pull/26067) ([alexey-milovidov](https://github.com/alexey-milovidov))。

#### 性能改进 {#performance-improvements}

- 编译聚合函数。使用选项 `compile_aggregate_expressions` 来启用它。[#24789](https://github.com/ClickHouse/ClickHouse/pull/24789) ([Maksim Kita](https://github.com/kitaisreal))。
- 改进需要从具有多列的表中读取数据的短查询的延迟。[#26371](https://github.com/ClickHouse/ClickHouse/pull/26371) ([Anton Popov](https://github.com/CurtizJ))。

#### 改进 {#improvements}


* 对系统日志表（`system.query_log`、`system.query_thread_log`、`system.processes`、`system.opentelemetry_span_log`）使用 `Map` 数据类型。这些表会基于新的数据类型自动创建。会创建虚拟列以兼容旧查询。修复 [#18698](https://github.com/ClickHouse/ClickHouse/issues/18698)。[#23934](https://github.com/ClickHouse/ClickHouse/pull/23934)、[#25773](https://github.com/ClickHouse/ClickHouse/pull/25773)（[hexiaoting](https://github.com/hexiaoting)、[sundy-li](https://github.com/sundy-li)、[Maksim Kita](https://github.com/kitaisreal)）。
* 对于仅包含一个属性的复杂键字典，在使用 `dictGet`、`dictHas` 函数时，允许键表达式不再必须包裹在 tuple 中。 [#26130](https://github.com/ClickHouse/ClickHouse/pull/26130) ([Maksim Kita](https://github.com/kitaisreal)).
* 从 `AggregateFunction` 的状态实现 `bin`/`hex` 函数。 [#26094](https://github.com/ClickHouse/ClickHouse/pull/26094) ([zhaoyu](https://github.com/zxc111)).
* 为 `empty` 和 `notEmpty` 函数增加对 `UUID` 类型参数的支持。`UUID` 在全为零时视为空（nil UUID）。关闭 [#3446](https://github.com/ClickHouse/ClickHouse/issues/3446)。[#25974](https://github.com/ClickHouse/ClickHouse/pull/25974) ([zhaoyu](https://github.com/zxc111))。
* 在 MySQL 协议中新增对 `SET SQL_SELECT_LIMIT` 的支持。修复 [#17115](https://github.com/ClickHouse/ClickHouse/issues/17115)。[#25972](https://github.com/ClickHouse/ClickHouse/pull/25972)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 为网络交互添加更多监控：增加用于统计接收/发送字节数的计数器；增加用于监控接收/发送操作的仪表。补充缺失的文档。关闭 [#5897](https://github.com/ClickHouse/ClickHouse/issues/5897)。[#25962](https://github.com/ClickHouse/ClickHouse/pull/25962) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 添加设置 `optimize_move_to_prewhere_if_final`。如果查询包含 `FINAL`，则只有在同时启用 `optimize_move_to_prewhere` 和 `optimize_move_to_prewhere_if_final` 时，才会启用 `move_to_prewhere` 优化。修复 [#8684](https://github.com/ClickHouse/ClickHouse/issues/8684)。 [#25940](https://github.com/ClickHouse/ClickHouse/pull/25940)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 允许在 JOIN 的表上使用复杂的带引号标识符。关闭 [#17861](https://github.com/ClickHouse/ClickHouse/issues/17861)。[#25924](https://github.com/ClickHouse/ClickHouse/pull/25924)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 `Nested` 数据类型中的 Unicode 组件（例如中文、西里尔字母）添加支持。关闭 [#25594](https://github.com/ClickHouse/ClickHouse/issues/25594)。[#25923](https://github.com/ClickHouse/ClickHouse/pull/25923)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 允许 `quantiles*` 函数与 `aggregate_functions_null_for_empty` 一起配合使用。关闭 [#25892](https://github.com/ClickHouse/ClickHouse/issues/25892)。 [#25919](https://github.com/ClickHouse/ClickHouse/pull/25919) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 允许参数化聚合函数的参数为任意常量表达式（例如 `1 + 2`），而不仅仅是字面量。还允许在参数化聚合函数中使用查询参数（例如在 `{param:UInt8}` 这样的参数化查询中）。关闭了 [#11607](https://github.com/ClickHouse/ClickHouse/issues/11607)。[#25910](https://github.com/ClickHouse/ClickHouse/pull/25910)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在尝试解析无效的 `Date` 时正确抛出异常。修复 [#6481](https://github.com/ClickHouse/ClickHouse/issues/6481)。[#25909](https://github.com/ClickHouse/ClickHouse/pull/25909)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在配置中支持多个 include。现在可以从多个来源引入 users 配置和 remote server 配置。只需放置带有 `from_zk`、`from_env` 或 `incl` 属性的 `<include />` 元素，它就会被替换为相应的内容。[#24404](https://github.com/ClickHouse/ClickHouse/pull/24404) ([nvartolomei](https://github.com/nvartolomei))。
* 支持在查询中使用包含名为 `"null"`（必须用反引号或双引号引用）的列以及 `ON CLUSTER`。修复 [#24035](https://github.com/ClickHouse/ClickHouse/issues/24035)。[#25907](https://github.com/ClickHouse/ClickHouse/pull/25907)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 `JSONExtract` 增加对 `LowCardinality`、`Decimal` 和 `UUID` 的支持。修复 [#24606](https://github.com/ClickHouse/ClickHouse/issues/24606)。[#25900](https://github.com/ClickHouse/ClickHouse/pull/25900)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 将历史记录文件从 `readline` 格式转换为 `replxx` 格式。[#25888](https://github.com/ClickHouse/ClickHouse/pull/25888) ([Azat Khuzhin](https://github.com/azat))。
* 修复了一个问题，该问题可能会在执行 `DROP PART` 或后台删除空数据块后导致数据块相互交叉。[#25884](https://github.com/ClickHouse/ClickHouse/pull/25884) ([alesapin](https://github.com/alesapin)).
* 改进了对 `ReplicatedMergeTree` 表中丢失 part 的处理。修复了 `ReplicationQueue` 中极少见的不一致问题。修复了 [#10368](https://github.com/ClickHouse/ClickHouse/issues/10368)。[#25820](https://github.com/ClickHouse/ClickHouse/pull/25820)（[alesapin](https://github.com/alesapin)）。
* 允许在工作目录不可读的情况下启动 clickhouse-client。 [#25817](https://github.com/ClickHouse/ClickHouse/pull/25817) ([ianton-ru](https://github.com/ianton-ru)).
* 修复 `Merge` 存储引擎中出现的“No available columns”错误。[#25801](https://github.com/ClickHouse/ClickHouse/pull/25801) ([Azat Khuzhin](https://github.com/azat))。
* MySQL 引擎现在支持在 MySQL 和 ClickHouse 之间同步列注释。 [#25795](https://github.com/ClickHouse/ClickHouse/pull/25795) ([Storozhuk Kostiantyn](https://github.com/sand6255)).
* 修复在空结果集上对 `GROUP BY` 常量处理行为不一致的问题。关闭 [#6842](https://github.com/ClickHouse/ClickHouse/issues/6842)。[#25786](https://github.com/ClickHouse/ClickHouse/pull/25786)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在 `ReplicatedMergeTree` 中，针对 `DROP PARTITION` 和 `TRUNCATE` 操作，取消对应分区中已在运行的合并任务。修复了 [#17151](https://github.com/ClickHouse/ClickHouse/issues/17151)。[#25684](https://github.com/ClickHouse/ClickHouse/pull/25684)（[tavplubix](https://github.com/tavplubix)）。
* 为 MaterializeMySQL 提供对 `ENUM` 数据类型的支持。 [#25676](https://github.com/ClickHouse/ClickHouse/pull/25676) ([Storozhuk Kostiantyn](https://github.com/sand6255)).
* 在 `JOIN` 中支持物化列和别名列，关闭 [#13274](https://github.com/ClickHouse/ClickHouse/issues/13274)。 [#25634](https://github.com/ClickHouse/ClickHouse/pull/25634) ([Vladimir C](https://github.com/vdimir))。
* 修复 `ALTER TABLE ... DETACH` 与后台合并之间可能存在的逻辑竞态条件。[#25605](https://github.com/ClickHouse/ClickHouse/pull/25605) ([Azat Khuzhin](https://github.com/azat)).
* 使 `NetworkReceiveElapsedMicroseconds` 指标能够正确统计等待客户端为 `INSERT` 提供数据所花费的时间。关闭 [#9958](https://github.com/ClickHouse/ClickHouse/issues/9958)。[#25602](https://github.com/ClickHouse/ClickHouse/pull/25602)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 S3 和 HDFS 提供对 `TRUNCATE TABLE` 的支持。关闭 [#25530](https://github.com/ClickHouse/ClickHouse/issues/25530)。[#25550](https://github.com/ClickHouse/ClickHouse/pull/25550)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 支持通过动态重新加载配置来更改用于执行后台任务（合并、变更、拉取）的线程池线程数。[#25548](https://github.com/ClickHouse/ClickHouse/pull/25548) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 允许使用 `JSONExtract` 将非字符串元素提取为字符串。对应问题 [#25414](https://github.com/ClickHouse/ClickHouse/issues/25414)。[#25452](https://github.com/ClickHouse/ClickHouse/pull/25452)（[Amos Bird](https://github.com/amosbird)）。
* 在 `StorageMerge` 的 `Database` 参数中支持使用正则表达式。关闭 [#776](https://github.com/ClickHouse/ClickHouse/issues/776)。 [#25064](https://github.com/ClickHouse/ClickHouse/pull/25064) ([flynn](https://github.com/ucasfl))。
* Web UI：如果该值看起来像 URL，则自动生成链接。[#25965](https://github.com/ClickHouse/ClickHouse/pull/25965) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 使 `sudo service clickhouse-server start` 能在像 CentOS 8 这样使用 `systemd` 的系统上正常工作。修复 [#14298](https://github.com/ClickHouse/ClickHouse/issues/14298)。修复 [#17799](https://github.com/ClickHouse/ClickHouse/issues/17799)。[#25921](https://github.com/ClickHouse/ClickHouse/pull/25921)（[alexey-milovidov](https://github.com/alexey-milovidov)）。

#### 错误修复 {#bug-fixes-1}


* 在某些情况下修复了错误的 `SET ROLE`。 [#26707](https://github.com/ClickHouse/ClickHouse/pull/26707) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复窗口函数中可能出现的 `nullptr` 解引用问题。修复 [#25276](https://github.com/ClickHouse/ClickHouse/issues/25276)。[#26668](https://github.com/ClickHouse/ClickHouse/pull/26668)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* 修正 `groupBitmapAnd/Or/Xor` 的错误函数名。修复 [#26557](https://github.com/ClickHouse/ClickHouse/pull/26557)（[Amos Bird](https://github.com/amosbird)）。
* 修复在 RabbitMQ 关闭时，如果 RabbitMQ 未被启动配置就会发生的崩溃问题。修复 [#26504](https://github.com/ClickHouse/ClickHouse/issues/26504)。[#26529](https://github.com/ClickHouse/ClickHouse/pull/26529)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复当在 `CREATE DICTIONARY` 查询中为字典名或数据库名加上引号时出现的问题。修复问题 [#26491](https://github.com/ClickHouse/ClickHouse/issues/26491)。[#26508](https://github.com/ClickHouse/ClickHouse/pull/26508)（[Maksim Kita](https://github.com/kitaisreal)）。
* 在重写列别名后修复名称解析错误。修复 [#26432](https://github.com/ClickHouse/ClickHouse/issues/26432)。[#26475](https://github.com/ClickHouse/ClickHouse/pull/26475)（[Amos Bird](https://github.com/amosbird)）。
* 修复 `partial_merge_join` 在关闭时出现的无限未关联数据块流问题 [#26325](https://github.com/ClickHouse/ClickHouse/issues/26325)。[#26374](https://github.com/ClickHouse/ClickHouse/pull/26374) ([Vladimir C](https://github.com/vdimir))。
* 修复以已被删除的用户登录时可能导致的崩溃。修复 [#26073](https://github.com/ClickHouse/ClickHouse/issues/26073)。[#26363](https://github.com/ClickHouse/ClickHouse/pull/26363)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复 `optimize_distributed_group_by_sharding_key` 在多列表达式下的问题（在 `optimize_skip_unused_shards=1` / `allow_nondeterministic_optimize_skip_unused_shards=1` 且分片键表达式包含多列时，会导致结果不正确）。 [#26353](https://github.com/ClickHouse/ClickHouse/pull/26353) ([Azat Khuzhin](https://github.com/azat)).
* `CAST` 从 `Date` 到 `DateTime`（或 `DateTime64`）时未使用 `DateTime` 类型的时区。这也会影响 `Date` 和 `DateTime` 之间的比较。为 `Date` 和 `DateTime` 推断公共类型时同样未使用相应的时区，从而影响了函数 `if` 的结果以及数组构造。修复了 [#24128](https://github.com/ClickHouse/ClickHouse/issues/24128)。[#24129](https://github.com/ClickHouse/ClickHouse/pull/24129)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复了在丢失副本恢复过程中极少出现的 bug，该问题可能导致副本数据不一致。 [#26321](https://github.com/ClickHouse/ClickHouse/pull/26321) ([tavplubix](https://github.com/tavplubix)).
* 修复当内部缓冲区末尾存在转义序列时的 zstd 解压问题。修复 [#26013](https://github.com/ClickHouse/ClickHouse/issues/26013)。[#26314](https://github.com/ClickHouse/ClickHouse/pull/26314)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在使用 `totals` 的 `JOIN` 中的逻辑错误，关闭 [#26017](https://github.com/ClickHouse/ClickHouse/issues/26017)。[#26250](https://github.com/ClickHouse/ClickHouse/pull/26250)（[Vladimir C](https://github.com/vdimir)）。
* 移除 `system.stack_trace` 表中 `thread_name` 列里多余的换行符。修复 [#24124](https://github.com/ClickHouse/ClickHouse/issues/24124)。[#26210](https://github.com/ClickHouse/ClickHouse/pull/26210) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复带有 `LowCardinality` 列的 `joinGet`，关闭 [#25993](https://github.com/ClickHouse/ClickHouse/issues/25993)。[#26118](https://github.com/ClickHouse/ClickHouse/pull/26118)（[Vladimir C](https://github.com/vdimir)）。
* 在关闭 `validate_polygons` 设置时，修复 `pointInPolygon` 中可能出现的崩溃问题。 [#26113](https://github.com/ClickHouse/ClickHouse/pull/26113) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复在遍历不存在的远程目录时抛出异常的问题。[#26087](https://github.com/ClickHouse/ClickHouse/pull/26087) ([ianton-ru](https://github.com/ianton-ru))。
* 修复由于 ZooKeeper 客户端中的 `abort` 导致的罕见服务器崩溃问题。修复了 [#25813](https://github.com/ClickHouse/ClickHouse/issues/25813)。[#26079](https://github.com/ClickHouse/ClickHouse/pull/26079)（[alesapin](https://github.com/alesapin)）。
* 在某些情况下修复右侧子查询 `JOIN` 的线程数估计错误。关闭 [#24075](https://github.com/ClickHouse/ClickHouse/issues/24075)。[#26052](https://github.com/ClickHouse/ClickHouse/pull/26052)（[Vladimir C](https://github.com/vdimir)）。
* 修复了 ClickHouse 在查询执行期间抛出异常时，通过 MySQL 协议发送的数据包中错误的 `sequence_id`。该问题可能导致 MySQL 客户端重置与 ClickHouse 服务器的连接。修复了 [#21184](https://github.com/ClickHouse/ClickHouse/issues/21184)。[#26051](https://github.com/ClickHouse/ClickHouse/pull/26051)（[tavplubix](https://github.com/tavplubix)）。
* 修复在使用普通投影与 `PREWHERE` 时可能出现的 header 不匹配问题。修复 [#26020](https://github.com/ClickHouse/ClickHouse/issues/26020)。[#26038](https://github.com/ClickHouse/ClickHouse/pull/26038)（[Amos Bird](https://github.com/amosbird)）。
* 修复将键为整数的 `Map` 类型格式化为 `JSON` 时的格式问题。 [#25982](https://github.com/ClickHouse/ClickHouse/pull/25982) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在查询分析器栈回溯过程中可能出现的死锁。修复 [#25968](https://github.com/ClickHouse/ClickHouse/issues/25968)。[#25970](https://github.com/ClickHouse/ClickHouse/pull/25970)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复在使用无效参数调用 `dictGet()` 时发生的崩溃。[#25913](https://github.com/ClickHouse/ClickHouse/pull/25913) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复了 PostgreSQL 引擎的 `scram-sha-256` 身份验证问题。修复了 [#24516](https://github.com/ClickHouse/ClickHouse/issues/24516)。[#25906](https://github.com/ClickHouse/ClickHouse/pull/25906)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在后台线程池已满时后台任务退避时间过长的问题。修复了 [#25836](https://github.com/ClickHouse/ClickHouse/issues/25836)。[#25893](https://github.com/ClickHouse/ClickHouse/pull/25893)（[alesapin](https://github.com/alesapin)）。
* 修复在非默认页面大小情况下的 ARM 异常处理。修复了 [#25512](https://github.com/ClickHouse/ClickHouse/issues/25512)、[#25044](https://github.com/ClickHouse/ClickHouse/issues/25044)、[#24901](https://github.com/ClickHouse/ClickHouse/issues/24901)、[#23183](https://github.com/ClickHouse/ClickHouse/issues/23183)、[#20221](https://github.com/ClickHouse/ClickHouse/issues/20221)、[#19703](https://github.com/ClickHouse/ClickHouse/issues/19703)、[#19028](https://github.com/ClickHouse/ClickHouse/issues/19028)、[#18391](https://github.com/ClickHouse/ClickHouse/issues/18391)、[#18121](https://github.com/ClickHouse/ClickHouse/issues/18121)、[#17994](https://github.com/ClickHouse/ClickHouse/issues/17994)、[#12483](https://github.com/ClickHouse/ClickHouse/issues/12483)。[#25854](https://github.com/ClickHouse/ClickHouse/pull/25854)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复 `remote()` 在未使用函数的列上设置 `sharding_key` 时的问题（此前 `select * from remote('127.1', system.one, dummy)` 会导致 `Unknown column: dummy, there are only columns .` 错误）。[#25824](https://github.com/ClickHouse/ClickHouse/pull/25824) ([Azat Khuzhin](https://github.com/azat)).
* 修复了从 `MaterializeMySQL` 查询时出现的 `Not found column ...` 和 `Missing column ...` 错误。修复了 [#23708](https://github.com/ClickHouse/ClickHouse/issues/23708)、[#24830](https://github.com/ClickHouse/ClickHouse/issues/24830)、[#25794](https://github.com/ClickHouse/ClickHouse/issues/25794)。[#25822](https://github.com/ClickHouse/ClickHouse/pull/25822)（[tavplubix](https://github.com/tavplubix)）。
* 修复针对非 UInt64 类型的 `optimize_skip_unused_shards_rewrite_in`（否则最终可能会选择错误的分片，或抛出 `Cannot infer type of an empty tuple` 或 `Function tuple requires at least one argument` 异常）。 [#25798](https://github.com/ClickHouse/ClickHouse/pull/25798) ([Azat Khuzhin](https://github.com/azat)).
* 修复了 `ReplicatedMergeTree` 表中 `DROP PART` 查询的一个罕见错误，该错误可能导致报错 `Unexpected merged part intersecting drop range`。 [#25783](https://github.com/ClickHouse/ClickHouse/pull/25783) ([alesapin](https://github.com/alesapin)).
* 修复了在分区中首次执行后拒绝再次执行的、带有 `GROUP BY` 表达式的 `TTL` 的错误。 [#25743](https://github.com/ClickHouse/ClickHouse/pull/25743) ([alesapin](https://github.com/alesapin)).
* 允许 `StorageMerge` 访问带有别名的表。修复 [#6051](https://github.com/ClickHouse/ClickHouse/issues/6051)。[#25694](https://github.com/ClickHouse/ClickHouse/pull/25694)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在某些情况下修复了较慢的 `dict join`，关闭了 [#24209](https://github.com/ClickHouse/ClickHouse/issues/24209)。[#25618](https://github.com/ClickHouse/ClickHouse/pull/25618)（[Vladimir C](https://github.com/vdimir)）。
* 修复用于参与 TTL 表达式的列上的 `ALTER MODIFY COLUMN` 操作。 [#25554](https://github.com/ClickHouse/ClickHouse/pull/25554) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在 `PREWHERE` 中使用非 UInt8 类型时触发的断言，关闭 [#19589](https://github.com/ClickHouse/ClickHouse/issues/19589)。[#25484](https://github.com/ClickHouse/ClickHouse/pull/25484)（[Vladimir C](https://github.com/vdimir)）。
* 修复了一些由模糊测试引发的 msan 崩溃。修复了 [#22517](https://github.com/ClickHouse/ClickHouse/issues/22517)。[#26428](https://github.com/ClickHouse/ClickHouse/pull/26428)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 更新 `clickhouse-server` Docker 入口点中的 `chown` 命令检查，修复了在 Kubernetes 中出现的 “cluster pod restart failed (or timeout)” 错误。 [#26545](https://github.com/ClickHouse/ClickHouse/pull/26545) ([Ky Li](https://github.com/Kylinrix))。

### ClickHouse 版本 v21.7, 2021-07-09 {#clickhouse-release-v217-2021-07-09}

#### 向后不兼容变更 {#backward-incompatible-change-4}

- 改进了显式定义大型集合的查询性能。新增兼容性设置 `legacy_column_name_of_tuple_literal`。在将集群从 21.7 以下版本滚动升级到更高版本时,建议将其设置为 `true`。否则,在升级期间,`IN` 子句中显式定义集合的分布式查询可能会失败。[#25371](https://github.com/ClickHouse/ClickHouse/pull/25371) ([Anton Popov](https://github.com/CurtizJ))。
- clickhouse-keeper(ZooKeeper 的实验性替代方案)最大缓冲区大小的前向/后向不兼容变更。最好现在(在投入生产环境之前)进行此变更,而不是以后。[#25421](https://github.com/ClickHouse/ClickHouse/pull/25421) ([alesapin](https://github.com/alesapin))。

#### 新功能 {#new-feature-4}


- 支持使用 YAML 格式配置作为 XML 的替代方案。此更改关闭了 [#3607](https://github.com/ClickHouse/ClickHouse/issues/3607)。[#21858](https://github.com/ClickHouse/ClickHouse/pull/21858) ([BoloniniD](https://github.com/BoloniniD))。
- 提供了一种在数据（可能）存在但 ZooKeeper 元数据丢失时恢复复制表的方法。解决了 [#13458](https://github.com/ClickHouse/ClickHouse/issues/13458)。[#13652](https://github.com/ClickHouse/ClickHouse/pull/13652) ([Mike Kot](https://github.com/myrrc))。
- 在 Arrow/Parquet/ORC 中支持结构体和映射,在 Arrow 输入/输出格式中支持字典。引入新设置 `output_format_arrow_low_cardinality_as_dictionary`。[#24341](https://github.com/ClickHouse/ClickHouse/pull/24341) ([Kruglov Pavel](https://github.com/Avogar))。
- 在字典中添加了对 `Array` 类型的支持。[#25119](https://github.com/ClickHouse/ClickHouse/pull/25119) ([Maksim Kita](https://github.com/kitaisreal))。
- 添加了函数 `bitPositionsToArray`。关闭了 [#23792](https://github.com/ClickHouse/ClickHouse/issues/23792)。作者 [Kevin Wan] (@MaxWk)。[#25394](https://github.com/ClickHouse/ClickHouse/pull/25394) ([Maksim Kita](https://github.com/kitaisreal))。
- 添加了函数 `dateName` 以返回诸如 'Friday' 或 'April' 之类的名称。作者 [Daniil Kondratyev] (@dankondr)。[#25372](https://github.com/ClickHouse/ClickHouse/pull/25372) ([Maksim Kita](https://github.com/kitaisreal))。
- 添加了 `toJSONString` 函数以将列序列化为其 JSON 表示形式。[#25164](https://github.com/ClickHouse/ClickHouse/pull/25164) ([Amos Bird](https://github.com/amosbird))。
- 现在 `query_log` 有两个新列:`initial_query_start_time`、`initial_query_start_time_microsecond`,用于记录分布式查询的起始时间(如果有)。[#25022](https://github.com/ClickHouse/ClickHouse/pull/25022) ([Amos Bird](https://github.com/amosbird))。
- 添加了聚合函数 `segmentLengthSum`。[#24250](https://github.com/ClickHouse/ClickHouse/pull/24250) ([flynn](https://github.com/ucasfl))。
- 添加了新的布尔设置 `prefer_global_in_and_join`,将所有 IN/JOIN 默认设置为 GLOBAL IN/JOIN。[#23434](https://github.com/ClickHouse/ClickHouse/pull/23434) ([Amos Bird](https://github.com/amosbird))。
- 支持对 `Join` 表引擎执行 `ALTER DELETE` 查询。[#23260](https://github.com/ClickHouse/ClickHouse/pull/23260) ([foolchi](https://github.com/foolchi))。
- 添加了 `quantileBFloat16` 聚合函数以及相应的 `quantilesBFloat16` 和 `medianBFloat16`。这是一个非常简单且快速的分位数估算器,相对误差不超过 0.390625%。此更改关闭了 [#16641](https://github.com/ClickHouse/ClickHouse/issues/16641)。[#23204](https://github.com/ClickHouse/ClickHouse/pull/23204) ([Ivan Novitskiy](https://github.com/RedClusive))。
- 实现了 `sequenceNextNode()` 函数,对流程分析非常有用。[#19766](https://github.com/ClickHouse/ClickHouse/pull/19766) ([achimbab](https://github.com/achimbab))。

#### 实验性功能 {#experimental-feature-4}

- 添加了对基于 HDFS 的虚拟文件系统的支持。[#11058](https://github.com/ClickHouse/ClickHouse/pull/11058) ([overshov](https://github.com/overshov)) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 现在 clickhouse-keeper(ZooKeeper 的实验性替代方案)支持类似 ZooKeeper 的 `digest` ACL。[#24448](https://github.com/ClickHouse/ClickHouse/pull/24448) ([alesapin](https://github.com/alesapin))。

#### 性能改进 {#performance-improvement-4}


- 新增优化功能,将某些函数转换为读取子列以减少读取的数据量。例如,语句 `col IS NULL` 会被转换为读取子列 `col.null`。可以通过设置 `optimize_functions_to_subcolumns` 来启用此优化,该选项目前默认关闭。[#24406](https://github.com/ClickHouse/ClickHouse/pull/24406) ([Anton Popov](https://github.com/CurtizJ))。
- 将更多列重写为可能的别名表达式。这可能会启用更好的优化,例如投影。[#24405](https://github.com/ClickHouse/ClickHouse/pull/24405) ([Amos Bird](https://github.com/amosbird))。
- 类型为 `bloom_filter` 的索引现在可以用于带有常量数组的 `hasAny` 函数表达式。此更改解决了:[#24291](https://github.com/ClickHouse/ClickHouse/issues/24291)。[#24900](https://github.com/ClickHouse/ClickHouse/pull/24900) ([Vasily Nemkov](https://github.com/Enmk))。
- 在 RabbitMQ 队列为空的情况下,为重新调度读取尝试添加指数退避机制。(ClickHouse 支持从 RabbitMQ 导入数据)。解决了 [#24340](https://github.com/ClickHouse/ClickHouse/issues/24340)。[#24415](https://github.com/ClickHouse/ClickHouse/pull/24415) ([Kseniia Sumarokova](https://github.com/kssenii))。

#### 改进 {#improvement-4}


* 允许对复制操作使用的带宽进行限制。新增两个 `Replicated*MergeTree` 设置：`max_replicated_fetches_network_bandwidth` 和 `max_replicated_sends_network_bandwidth`，用于限制单个表复制拉取/发送的最大速度。新增两个服务器级设置（位于 `default` 用户配置中）：`max_replicated_fetches_network_bandwidth_for_server` 和 `max_replicated_sends_network_bandwidth_for_server`，用于限制所有表整体复制操作的最大速度。这些设置并不会被严格精确地遵守。默认关闭。修复 [#1821](https://github.com/ClickHouse/ClickHouse/issues/1821)。[#24573](https://github.com/ClickHouse/ClickHouse/pull/24573)（[alesapin](https://github.com/alesapin)）。
* 为 ODBC 和 Library bridge 提供资源约束和隔离。为 bridge 进程使用单独的 `clickhouse-bridge` 组和用户。设置 oom&#95;score&#95;adj，使这些 bridge 成为 OOM killer 的优先回收对象。将最大 RSS 限制设置为 1 GiB。修复 [#23861](https://github.com/ClickHouse/ClickHouse/issues/23861)。[#25280](https://github.com/ClickHouse/ClickHouse/pull/25280)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 为主 `clickhouse` 可执行文件添加了独立的 `clickhouse-keeper` 符号链接。现在可以在不启动主 ClickHouse 服务器的情况下单独运行协调服务。[#24059](https://github.com/ClickHouse/ClickHouse/pull/24059) ([alesapin](https://github.com/alesapin))。
* 对 `VIEW` 的查询使用全局设置。修复了当对 `VIEW` 的查询使用本地设置时的行为——如果在 `CREATE VIEW` 和 `SELECT` 中使用的设置不同，会导致错误。从现在开始，`VIEW` 不再使用这些被修改的设置，但你仍然可以在 `CREATE VIEW` 查询的 `SETTINGS` 部分传递额外的设置。关闭 [#20551](https://github.com/ClickHouse/ClickHouse/issues/20551)。[#24095](https://github.com/ClickHouse/ClickHouse/pull/24095)（[Vladimir](https://github.com/vdimir)）。
* 在服务器启动时，具有错误分区 ID 的数据片段不会被删除，而是始终被分离（detached）。[#25070](https://github.com/ClickHouse/ClickHouse/issues/25070)。[#25166](https://github.com/ClickHouse/ClickHouse/pull/25166) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 将后台调度池大小增加到 128（`background_schedule_pool_size` 设置）。这可以避免在 ZooKeeper 连接较慢时复制队列出现卡死。[#25072](https://github.com/ClickHouse/ClickHouse/pull/25072) ([alesapin](https://github.com/alesapin))。
* 添加 MergeTree 设置项 `max_parts_to_merge_at_once`，用于限制在后台一次可以合并的分片数量。不影响 `OPTIMIZE FINAL` 查询。修复 [#1820](https://github.com/ClickHouse/ClickHouse/issues/1820)。[#24496](https://github.com/ClickHouse/ClickHouse/pull/24496)（[alesapin](https://github.com/alesapin)）。
* 允许在分区剪枝中使用 `NOT IN` 运算符。[#24894](https://github.com/ClickHouse/ClickHouse/pull/24894) ([Amos Bird](https://github.com/amosbird))。
* 将类似 `127.0.1.1` 的 IPv4 地址识别为本地地址。此更改具有争议性，并解决了 [#23504](https://github.com/ClickHouse/ClickHouse/issues/23504)。Michael Filimonov 将对该功能进行测试。[#24316](https://github.com/ClickHouse/ClickHouse/pull/24316) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 使用 MaterializeMySQL（这是一个实验性特性）创建的 ClickHouse 数据库，现在包含来自被物化的 MySQL 数据库的所有列注释。 [#25199](https://github.com/ClickHouse/ClickHouse/pull/25199) ([Storozhuk Kostiantyn](https://github.com/sand6255)).
* 为 MySQL 存储引擎新增设置（`connection_auto_close`/`connection_max_tries`/`connection_pool_size`）。[#24146](https://github.com/ClickHouse/ClickHouse/pull/24146)（[Azat Khuzhin](https://github.com/azat)）。
* 缩短 `Distributed` 引擎的启动时间。[#25663](https://github.com/ClickHouse/ClickHouse/pull/25663) ([Azat Khuzhin](https://github.com/azat)).
* 对 Distributed 表进行了改进：对于 `internal_replication=true`，从 `dirname` 中去除了副本信息（这使得可以在包含任意数量副本的集群上向 Distributed 表执行 `INSERT`；此前最多只支持 15 个副本，超过该数量时，在为异步数据块创建目录时会因 ENAMETOOLONG 而失败）。 [#25513](https://github.com/ClickHouse/ClickHouse/pull/25513) ([Azat Khuzhin](https://github.com/azat)).
* 为 `LowCardinality` 新增对 `Interval` 类型的支持。此功能用于某些表达式的中间结果。修复了 [#21730](https://github.com/ClickHouse/ClickHouse/issues/21730)。[#25410](https://github.com/ClickHouse/ClickHouse/pull/25410)（[Vladimir](https://github.com/vdimir)）。
* 为 `sequenceMatch` 和 `sequenceCount` 函数的时间条件添加 `==` 运算符。例如：sequenceMatch(&#39;(?1)(?t==1)(?2)&#39;)(time, data = 1, data = 2)。[#25299](https://github.com/ClickHouse/ClickHouse/pull/25299) ([Christophe Kalenzaga](https://github.com/mga-chka))。
* 添加了设置项 `http_max_fields`、`http_max_field_name_size`、`http_max_field_value_size`。[#25296](https://github.com/ClickHouse/ClickHouse/pull/25296)（[Ivan](https://github.com/abyss7)）。
* 为 `if` 函数的分支添加对 `Decimal` 和 `Int` 类型的支持。修复了 [#20549](https://github.com/ClickHouse/ClickHouse/issues/20549)。修复了 [#10142](https://github.com/ClickHouse/ClickHouse/issues/10142)。[#25283](https://github.com/ClickHouse/ClickHouse/pull/25283)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 更新 `clickhouse-client` 的提示符，并在重新连接时显示一条消息。此更改解决了 [#10577](https://github.com/ClickHouse/ClickHouse/issues/10577)。[#25281](https://github.com/ClickHouse/ClickHouse/pull/25281)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在聚合函数 `topK` 中修正了内存跟踪。这解决了 [#25259](https://github.com/ClickHouse/ClickHouse/issues/25259)。[#25260](https://github.com/ClickHouse/ClickHouse/pull/25260)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 IDN 主机（例如 `example.рф`）的 `topLevelDomain`，此前对于此类主机会返回空字符串。 [#25103](https://github.com/ClickHouse/ClickHouse/pull/25103) ([Azat Khuzhin](https://github.com/azat)).
* 在运行时检测 Linux 内核版本（用于已修复的嵌套 epoll，这对于 `async_socket_for_remote`/`use_hedged_requests` 是必需的，否则远程查询可能会卡住）。[#25067](https://github.com/ClickHouse/ClickHouse/pull/25067) ([Azat Khuzhin](https://github.com/azat))。
* 对于分布式查询，当 `optimize_skip_unused_shards=1` 时，允许在类似 `(sharding key) IN (one-element-tuple)` 的条件下跳过分片。（此前已支持包含多个元素的 tuple。包含单个元素的 tuple 之前不起作用，因为它会被解析为字面量。）[#24930](https://github.com/ClickHouse/ClickHouse/pull/24930) ([Amos Bird](https://github.com/amosbird))。
* 改进了 S3 错误的日志消息，在 key 和 bucket 为空时不再出现双空格。 [#24897](https://github.com/ClickHouse/ClickHouse/pull/24897) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 某些查询需要进行多轮语义分析。在这种情况下，尝试复用为 `IN` 预先构建的集合。[#24874](https://github.com/ClickHouse/ClickHouse/pull/24874) ([Amos Bird](https://github.com/amosbird)).
* 在使用 `insert_distributed_sync` 时遵循 `max_distributed_connections`（否则在大型集群中进行同步写入时，可能会耗尽 `max_thread_pool_size`）。[#24754](https://github.com/ClickHouse/ClickHouse/pull/24754) ([Azat Khuzhin](https://github.com/azat))。
* 避免在标量子查询中隐藏 `Limit for rows or bytes to read exceeded` 之类的错误。[#24545](https://github.com/ClickHouse/ClickHouse/pull/24545) ([nvartolomei](https://github.com/nvartolomei))。
* 使 String-to-Int 解析器更加严格，使 `toInt64('+')` 会抛出异常。[#24475](https://github.com/ClickHouse/ClickHouse/pull/24475) ([Amos Bird](https://github.com/amosbird))。
* 如果通过 DDL 查询创建 `SSD_CACHE`，则它只能创建在 `user_files` 目录中。 [#24466](https://github.com/ClickHouse/ClickHouse/pull/24466) ([Maksim Kita](https://github.com/kitaisreal))。
* 支持在 PostgreSQL 方言中为 `INSERT` 查询指定非默认 `schema`。修复 [#24149](https://github.com/ClickHouse/ClickHouse/issues/24149)。[#24413](https://github.com/ClickHouse/ClickHouse/pull/24413) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 修复 IPv6 地址解析问题（例如修复了 `select * from remote('[::1]', system.one)`）。[#24319](https://github.com/ClickHouse/ClickHouse/pull/24319) ([Azat Khuzhin](https://github.com/azat))。
* 修复多行模式下 `FROM` 子句中包含子查询时的尾随空格问题，并且以更符合人类阅读习惯的方式对查询输出进行了轻微调整。[#24151](https://github.com/ClickHouse/ClickHouse/pull/24151) ([Azat Khuzhin](https://github.com/azat)).
* 对 Distributed 表的改进：新增在失败时（例如由于内存限制、数据损坏）拆分分布式批次的能力，由 `distributed_directory_monitor_split_batch_on_failure` 控制（默认关闭）。[#23864](https://github.com/ClickHouse/ClickHouse/pull/23864) ([Azat Khuzhin](https://github.com/azat))。
* 处理 `Join` 表引擎中的列名冲突。关闭 [#20309](https://github.com/ClickHouse/ClickHouse/issues/20309)。[#23769](https://github.com/ClickHouse/ClickHouse/pull/23769)（[Vladimir](https://github.com/vdimir)）。
* 当通过 stdin 传递数据时，在 `clickhouse-local` 中对 `File` 表引擎，以及在 `clickhouse-client` 中的 INSERT 查询显示进度。关闭 [#18209](https://github.com/ClickHouse/ClickHouse/issues/18209)。[#23656](https://github.com/ClickHouse/ClickHouse/pull/23656)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `clickhouse-copier` 的错误修复和改进。允许复制具有不同（但兼容）schema 的表。关闭 [#9159](https://github.com/ClickHouse/ClickHouse/issues/9159)。新增用于复制 ReplacingMergeTree 的测试。关闭 [#22711](https://github.com/ClickHouse/ClickHouse/issues/22711)。支持列上的 TTL 和 Data Skipping 索引。其做法是在创建内部 Distributed 表时简单地将其移除（底层表仍然保留 TTL 和 skipping 索引）。关闭 [#19384](https://github.com/ClickHouse/ClickHouse/issues/19384)。允许复制 MATERIALIZED 和 ALIAS 列。在某些情况下这会很有用（例如该列在 PRIMARY KEY 中）。现在可以通过在任务配置中将 `allow_to_copy_alias_and_materialized_columns` 属性设为 true 来启用。关闭 [#9177](https://github.com/ClickHouse/ClickHouse/issues/9177)。关闭 [#11007] ([https://github.com/ClickHouse/ClickHouse/issues/11007](https://github.com/ClickHouse/ClickHouse/issues/11007))。关闭 [#9514](https://github.com/ClickHouse/ClickHouse/issues/9514)。在任务配置中新增属性 `allow_to_drop_target_partitions`，用于在移动辅助表之前删除原始表中的分区。关闭 [#20957](https://github.com/ClickHouse/ClickHouse/issues/20957)。移除 `OPTIMIZE DEDUPLICATE` 查询。这个技巧之前是必需的，因为 `ALTER TABLE MOVE PARTITION` 会被重试多次，而普通的 MergeTree 表不支持去重。关闭 [#17966](https://github.com/ClickHouse/ClickHouse/issues/17966)。以 JSON 格式将进度写入 ZooKeeper 上路径为 `task_path + /status` 的节点。关闭 [#20955](https://github.com/ClickHouse/ClickHouse/issues/20955)。支持不带参数的 ReplicatedTables。关闭 [#24834](https://github.com/ClickHouse/ClickHouse/issues/24834)。[#23518](https://github.com/ClickHouse/ClickHouse/pull/23518) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 在从 S3 重试读取操作之间增加了带退避策略的休眠时间。[#23461](https://github.com/ClickHouse/ClickHouse/pull/23461) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 在向 `Distributed` 表执行 INSERT 时遵循 `insert_allow_materialized_columns`（允许物化列）。 [#23349](https://github.com/ClickHouse/ClickHouse/pull/23349) ([Azat Khuzhin](https://github.com/azat)).
* 为分布式查询添加下推 `LIMIT` 的能力。 [#23027](https://github.com/ClickHouse/ClickHouse/pull/23027) ([Azat Khuzhin](https://github.com/azat)).
* 修复在使用多个 S3 卷时的零拷贝复制问题（解决了 [#22679](https://github.com/ClickHouse/ClickHouse/issues/22679)）。[#22864](https://github.com/ClickHouse/ClickHouse/pull/22864)（[ianton-ru](https://github.com/ianton-ru)）。
* 当用户向操作系统请求任意可用端口时，解析实际绑定的端口号，并在日志消息中显示。 [#25569](https://github.com/ClickHouse/ClickHouse/pull/25569) ([bnaecker](https://github.com/bnaecker)).
* 修复了在某些情况下将 Postgres 数组转换时，结果变成 `String` 数据类型而不是 n 维数组的问题，原因是 `attndims` 在部分场景下工作不正确。修复了 [#24804](https://github.com/ClickHouse/ClickHouse/issues/24804)。[#25538](https://github.com/ClickHouse/ClickHouse/pull/25538)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复 MySQL、PostgreSQL、ODBC 的时区 `DateTime` 转换。关闭 [#5057](https://github.com/ClickHouse/ClickHouse/issues/5057)。[#25528](https://github.com/ClickHouse/ClickHouse/pull/25528)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 为不同的表区分处理 `KILL MUTATION`（修复意外出现的 `Cancelled mutating parts` 错误）。 [#25025](https://github.com/ClickHouse/ClickHouse/pull/25025) ([Azat Khuzhin](https://github.com/azat)).
* 允许在 bucket 根路径声明 S3 磁盘（S3 虚拟文件系统是一个正在开发中的实验性特性）。 [#24898](https://github.com/ClickHouse/ClickHouse/pull/24898) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 为分布式表启用子列读取（例如 `Tuple` 的各个组成部分）。[#24472](https://github.com/ClickHouse/ClickHouse/pull/24472)（[Anton Popov](https://github.com/CurtizJ)）。
* 为 MySQL 兼容协议新增特性：使 `user` 函数返回正确结果。关闭 [#25697](https://github.com/ClickHouse/ClickHouse/pull/25697)。[#25697](https://github.com/ClickHouse/ClickHouse/pull/25697)（[sundyli](https://github.com/sundy-li)）。

#### 错误修复 {#bug-fix-3}


* 改进向后兼容性：在用作分区键时，使用旧版本的 `modulo` 函数。修复 [#23508](https://github.com/ClickHouse/ClickHouse/issues/23508)。[#24157](https://github.com/ClickHouse/ClickHouse/pull/24157)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复了在低内存服务器上极其罕见的 bug，该 bug 可能会导致服务器在不重启的情况下无法执行合并操作。可能修复了 [#24603](https://github.com/ClickHouse/ClickHouse/issues/24603)。[#24872](https://github.com/ClickHouse/ClickHouse/pull/24872)（[alesapin](https://github.com/alesapin)）。
* 修复在并发执行 `alter move/replace partition` 时，复制队列中极其罕见出现的错误 `Tagging already tagged part`。可能修复了 [#22142](https://github.com/ClickHouse/ClickHouse/issues/22142)。[#24961](https://github.com/ClickHouse/ClickHouse/pull/24961)（[alesapin](https://github.com/alesapin)）。
* 修复在通过对其他聚合函数的聚合函数状态再进行聚合来计算聚合函数状态时可能发生的崩溃问题（并非实际使用场景）。参见 [#24523](https://github.com/ClickHouse/ClickHouse/issues/24523)。[#25015](https://github.com/ClickHouse/ClickHouse/pull/25015)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在执行 `SYSTEM RESTART REPLICA` 或 `SYSTEM SYNC REPLICA` 查询时操作无法结束的问题。该问题是在内存极其紧张的服务器上发现的。[#24457](https://github.com/ClickHouse/ClickHouse/pull/24457) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 修复可能导致 ZooKeeper 客户端在 clickhouse-server 中挂起的缺陷。 [#24721](https://github.com/ClickHouse/ClickHouse/pull/24721) ([alesapin](https://github.com/alesapin)).
* 如果 ZooKeeper 连接丢失，并且副本在恢复连接后被克隆，其复制队列中可能包含过期的记录。修复了在复制队列包含相交虚拟数据块时触发的断言失败。这种情况在某些数据块丢失时可能会极少发生。现在改为在日志中打印错误，而不是终止进程。 [#24777](https://github.com/ClickHouse/ClickHouse/pull/24777) ([tavplubix](https://github.com/tavplubix)).
* 修复查询计划中表达式下推优化导致丢失的 `WHERE` 条件（默认将 `query_plan_filter_push_down` 设置为 1）。修复了 [#25368](https://github.com/ClickHouse/ClickHouse/issues/25368)。[#25370](https://github.com/ClickHouse/ClickHouse/pull/25370)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复一个在带有 TTL 的合并后可能导致数据分片相互重叠的错误：`Part all_40_40_0 is covered by all_40_40_1 but should be merged into all_40_41_1. This shouldn't happen often.`。[#25549](https://github.com/ClickHouse/ClickHouse/pull/25549) ([alesapin](https://github.com/alesapin))。
* 在 ZooKeeper 连接丢失时，`ReplicatedMergeTree` 表可能会在尝试重新连接之前等待后台操作完成。该问题已修复，现在会强制停止后台操作。[#25306](https://github.com/ClickHouse/ClickHouse/pull/25306) ([tavplubix](https://github.com/tavplubix))。
* 修复在主键中使用数组且查询包含 `ARRAY JOIN` 时出现的错误 `Key expression contains comparison between inconvertible types`。修复了 [#8247](https://github.com/ClickHouse/ClickHouse/issues/8247)。[#25546](https://github.com/ClickHouse/ClickHouse/pull/25546)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复了在使用 `WITH TOTALS` 和 `WITH FILL` 的查询中总计结果错误的问题。修复了 [#20872](https://github.com/ClickHouse/ClickHouse/issues/20872)。[#25539](https://github.com/ClickHouse/ClickHouse/pull/25539)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复在重新加载集群配置的同时查询 `system.clusters` 时出现的数据竞争。 [#25737](https://github.com/ClickHouse/ClickHouse/pull/25737) ([Amos Bird](https://github.com/amosbird)).
* 修复了在数据库之间移动 `Distributed` 表时出现的 `No such file or directory` 错误。修复了 [#24971](https://github.com/ClickHouse/ClickHouse/issues/24971)。[#25667](https://github.com/ClickHouse/ClickHouse/pull/25667)（[tavplubix](https://github.com/tavplubix)）。
* 在极少数情况下，如果源分区为空，`REPLACE PARTITION` 可能会被忽略。此问题已修复，对应修复了 [#24869](https://github.com/ClickHouse/ClickHouse/issues/24869)。[#25665](https://github.com/ClickHouse/ClickHouse/pull/25665)（[tavplubix](https://github.com/tavplubix)）。
* 修复了 `Replicated` 数据库引擎中的一个错误，该错误在极少数情况下可能导致某些副本跳过已排队的 DDL 查询。[#24805](https://github.com/ClickHouse/ClickHouse/pull/24805) ([tavplubix](https://github.com/tavplubix))。
* 修复在没有查询时执行 `EXPLAIN AST` 出现的空指针解引用问题。 [#25631](https://github.com/ClickHouse/ClickHouse/pull/25631) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复在等待自动删除空数据分片时的行为。此前可能会导致后台线程池被完全占满，并使复制过程卡住。 [#23315](https://github.com/ClickHouse/ClickHouse/pull/23315) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在 S3 虚拟文件系统中存储的表的恢复功能（这是一项尚未可用于生产环境的实验性功能）。[#25601](https://github.com/ClickHouse/ClickHouse/pull/25601) ([ianton-ru](https://github.com/ianton-ru))。
* 修复在使用 `Decimal256` 时，`Arrow` 格式中的 `nullptr` 解引用问题。为 `Arrow` 格式添加 `Decimal256` 支持。[#25531](https://github.com/ClickHouse/ClickHouse/pull/25531) ([Kruglov Pavel](https://github.com/Avogar))。
* 修复预处理配置文件名称前多出的下划线。[#25431](https://github.com/ClickHouse/ClickHouse/pull/25431)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 针对 `clickhouse-copier` 工具的修复：修复在 copier 的任务配置中缺少 `sharding_key` 时出现的段错误。[#25419](https://github.com/ClickHouse/ClickHouse/pull/25419) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 通过在 DDL 中正确引用格式化后的查询，修复 `REPLACE` 列转换器。此更改修复了 [#23925](https://github.com/ClickHouse/ClickHouse/issues/23925)。[#25391](https://github.com/ClickHouse/ClickHouse/pull/25391)（[Amos Bird](https://github.com/amosbird)）。
* 修复 `quantileDeterministic` 函数及类似函数可能出现的非确定性行为。关闭 [#20480](https://github.com/ClickHouse/ClickHouse/issues/20480)。[#25313](https://github.com/ClickHouse/ClickHouse/pull/25313)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 `SummingMergeTree` 增加对 `SimpleAggregateFunction(LowCardinality)` 的支持。修复 [#25134](https://github.com/ClickHouse/ClickHouse/issues/25134)。[#25300](https://github.com/ClickHouse/ClickHouse/pull/25300)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复异常消息 &quot;Cannot sum Array/Tuple in min/maxMap&quot; 所对应的逻辑错误。[#25298](https://github.com/ClickHouse/ClickHouse/pull/25298) ([Kruglov Pavel](https://github.com/Avogar))。
* 修复在 `IN` 查询中使用 `LowCardinality` 参数时出现的错误 `Bad cast from type DB::ColumnLowCardinality to DB::ColumnVector<char8_t>`（该缺陷出现在 21.6 版本中）。修复 [#25187](https://github.com/ClickHouse/ClickHouse/issues/25187)。[#25290](https://github.com/ClickHouse/ClickHouse/pull/25290)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复 `joinGetOrNull` 在非可空列上的错误行为。此更改修复了 [#24261](https://github.com/ClickHouse/ClickHouse/issues/24261)。[#25288](https://github.com/ClickHouse/ClickHouse/pull/25288)（[Amos Bird](https://github.com/amosbird)）。
* 修复大整数中的不正确行为并解决 UBSan 报告问题。在此前版本中，`CAST(1e19 AS UInt128)` 会返回零。[#25279](https://github.com/ClickHouse/ClickHouse/pull/25279) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了使用 `CSVWithNames` 格式插入部分列时出现的错误。修复了 [#25129](https://github.com/ClickHouse/ClickHouse/issues/25129)。[#25169](https://github.com/ClickHouse/ClickHouse/pull/25169)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 不要在带有 `FINAL` 的 `SELECT` 中使用表的 `projection`。该用法暂不支持。[#25163](https://github.com/ClickHouse/ClickHouse/pull/25163) ([Amos Bird](https://github.com/amosbird))。
* 修复在升级到 21.5 后，如果表在分区键中使用了 `UUID`，可能导致的数据分片丢失问题。（不推荐在分区键中使用 `UUID`）。修复了 [#25070](https://github.com/ClickHouse/ClickHouse/issues/25070)。 [#25127](https://github.com/ClickHouse/ClickHouse/pull/25127)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在包含 cross join 且 `joined_subquery_requires_alias = 0` 的查询中出现的崩溃问题。修复了 [#24011](https://github.com/ClickHouse/ClickHouse/issues/24011)。[#25082](https://github.com/ClickHouse/ClickHouse/pull/25082)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了 `mapContains` 函数在处理常量映射时引发 `empty column was returned by function mapContains` 错误的缺陷。关闭 [#25077](https://github.com/ClickHouse/ClickHouse/issues/25077)。[#25080](https://github.com/ClickHouse/ClickHouse/pull/25080)（[Kruglov Pavel](https://github.com/Avogar)）。
* 不再允许创建包含自引用列（如 `a UInt32 ALIAS a + 1` 或 `b UInt32 MATERIALIZED b`）的表。修复了 [#24910](https://github.com/ClickHouse/ClickHouse/issues/24910)、[#24292](https://github.com/ClickHouse/ClickHouse/issues/24292)。[#25059](https://github.com/ClickHouse/ClickHouse/pull/25059)（[alesapin](https://github.com/alesapin)）。
* 修复在使用带有*非空* `GROUP BY` 键的聚合投影来执行按*空*键 `GROUP BY` 的查询时产生错误结果的问题。 [#25055](https://github.com/ClickHouse/ClickHouse/pull/25055) ([Amos Bird](https://github.com/amosbird))。
* 修复 Protobuf 格式中拆分的嵌套消息的序列化问题。此 PR 修复了 [#24647](https://github.com/ClickHouse/ClickHouse/issues/24647)。[#25000](https://github.com/ClickHouse/ClickHouse/pull/25000)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复分布式查询的 limit/offset 设置（在远程节点上忽略）。[#24940](https://github.com/ClickHouse/ClickHouse/pull/24940) ([Azat Khuzhin](https://github.com/azat))。
* 修复 `Arrow` 格式中可能出现的 heap-buffer-overflow。 [#24922](https://github.com/ClickHouse/ClickHouse/pull/24922) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复了从 DiskS3 读取文件时可能出现的错误 &#39;Cannot read from istream at offset 0&#39;（S3 虚拟文件系统是一个开发中的实验性功能，不应在生产环境中使用）。 [#24885](https://github.com/ClickHouse/ClickHouse/pull/24885) ([Pavel Kovalenko](https://github.com/Jokser)).
* 修复在对分布式物化视图执行 `JOIN` 时出现的 “Missing columns” 异常。[#24870](https://github.com/ClickHouse/ClickHouse/pull/24870) ([Azat Khuzhin](https://github.com/azat)).
* 在 postgresql 兼容协议中允许使用 `NULL` 值。修复了 [#22622](https://github.com/ClickHouse/ClickHouse/issues/22622)。[#24857](https://github.com/ClickHouse/ClickHouse/pull/24857)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复了一个问题：在等待 mutation 时，如果 mutation 尚未加载到内存中，可能会向客户端抛出 `Mutation was killed` 异常。 [#24809](https://github.com/ClickHouse/ClickHouse/pull/24809) ([alesapin](https://github.com/alesapin)).
* 修复了随机生成器状态反序列化中的一个错误，该错误可能会导致某些数据类型（例如 `AggregateFunction(groupArraySample(N), T)`）的行为变得不确定。[#24538](https://github.com/ClickHouse/ClickHouse/pull/24538)（[tavplubix](https://github.com/tavplubix)）。
* 禁止构建其他聚合状态的 `uniqXXXXStates`。[#24523](https://github.com/ClickHouse/ClickHouse/pull/24523)（[Raúl Marín](https://github.com/Algunenano)）。随后通过真正消除相关问题的根本原因，重新允许这样做。（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在 `CREATE .. AS SELECT` 查询中对 tuple 的使用。 [#24464](https://github.com/ClickHouse/ClickHouse/pull/24464) ([Anton Popov](https://github.com/CurtizJ)).
* 修复 `Buffer` 表中总字节数的计算。在当前 ClickHouse 版本中，`total_writes.bytes` 计数器在缓冲区刷新期间减少得过多。这会导致计数器溢出，并在刷新后的某个时间点使 `totalBytes` 返回约 17.44 EB 的值。[#24450](https://github.com/ClickHouse/ClickHouse/pull/24450) ([DimasKovas](https://github.com/DimasKovas))。
* 修复关于 `toWeek` 函数单调性的错误说明。此更改修复了 [#24422](https://github.com/ClickHouse/ClickHouse/issues/24422)。该缺陷最初在 [https://github.com/ClickHouse/ClickHouse/pull/5212](https://github.com/ClickHouse/ClickHouse/pull/5212) 中引入，之后被更智能的分区裁剪器暴露出来。[#24446](https://github.com/ClickHouse/ClickHouse/pull/24446)（[Amos Bird](https://github.com/amosbird)）。
* 当使用 LDAP 管理用户身份验证时，修复了在 LDAP 角色（重新）映射期间可能发生的死锁问题：当某个 LDAP 组被映射到一个不存在的本地角色时，可能会触发该问题。 [#24431](https://github.com/ClickHouse/ClickHouse/pull/24431) ([Denis Glazachev](https://github.com/traceon)).
* 在处理 &quot;multipart/form-data&quot; 消息时，将边界前的 CRLF 视为边界的一部分。修复了 [#23905](https://github.com/ClickHouse/ClickHouse/issues/23905)。[#24399](https://github.com/ClickHouse/ClickHouse/pull/24399) ([Ivan](https://github.com/abyss7))。
* 修复在存在相交的伪数据块时执行 drop partition 的问题。在极少数情况下，可能会出现 `mutation` 版本号大于当前块号的数据块。 [#24321](https://github.com/ClickHouse/ClickHouse/pull/24321) ([Amos Bird](https://github.com/amosbird)).
* 修复了使用 `RENAME TABLE` 查询将物化视图从 Ordinary 数据库迁移到 Atomic 数据库时的一个错误。现在内部表会与物化视图一起被迁移到新数据库。修复了 [#23926](https://github.com/ClickHouse/ClickHouse/issues/23926)。[#24309](https://github.com/ClickHouse/ClickHouse/pull/24309)（[tavplubix](https://github.com/tavplubix)）。
* 允许空的 HTTP 头。修复 [#23901](https://github.com/ClickHouse/ClickHouse/issues/23901)。[#24285](https://github.com/ClickHouse/ClickHouse/pull/24285)（[Ivan](https://github.com/abyss7)）。
* 在 `Memory` 表中正确处理变更操作（`ALTER UPDATE/DELETE`）。关闭 [#24274](https://github.com/ClickHouse/ClickHouse/issues/24274)。[#24275](https://github.com/ClickHouse/ClickHouse/pull/24275)（[flynn](https://github.com/ucasfl)）。
* 使 JOIN 输出列的 LowCardinality 属性与输入列保持一致，关闭 [#23351](https://github.com/ClickHouse/ClickHouse/issues/23351) 和 [#20315](https://github.com/ClickHouse/ClickHouse/issues/20315)。[#24061](https://github.com/ClickHouse/ClickHouse/pull/24061)（[Vladimir](https://github.com/vdimir)）。
* 修复了 Kafka 表的问题。修复了在 `Engine = Kafka` 的情况下，当同一消费者之前的分配为空时，无法开始消费的故障转移行为中的错误。关闭 [#21118](https://github.com/ClickHouse/ClickHouse/issues/21118)。[#21267](https://github.com/ClickHouse/ClickHouse/pull/21267)（[filimonov](https://github.com/filimonov)）。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-4}

- 在 CI 中添加 `darwin-aarch64`(Mac M1 / Apple Silicon)构建 [#25560](https://github.com/ClickHouse/ClickHouse/pull/25560) ([Ivan](https://github.com/abyss7)) 并将链接添加到文档和网站 ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 添加跨平台的二进制资源嵌入可执行文件功能。支持在 Illumos 上运行。[#25146](https://github.com/ClickHouse/ClickHouse/pull/25146) ([bnaecker](https://github.com/bnaecker))。
- 在压力测试中添加 join 相关选项以改进模糊测试。[#25200](https://github.com/ClickHouse/ClickHouse/pull/25200) ([Vladimir](https://github.com/vdimir))。
- 在 macOS 中启用 s3 模块构建 [#25217](https://github.com/ClickHouse/ClickHouse/issues/25217)。[#25218](https://github.com/ClickHouse/ClickHouse/pull/25218) ([kevin wan](https://github.com/MaxWk))。
- 添加集成测试用例以覆盖 JDBC 桥接。[#25047](https://github.com/ClickHouse/ClickHouse/pull/25047) ([Zhichun Wu](https://github.com/zhicwu))。
- 集成测试配置对字典进行了特殊处理。移除了剩余的字典手动配置。[#24728](https://github.com/ClickHouse/ClickHouse/pull/24728) ([Ilya Yatsishin](https://github.com/qoega))。
- 为 YAMLParser 类添加 libfuzzer 测试。[#24480](https://github.com/ClickHouse/ClickHouse/pull/24480) ([BoloniniD](https://github.com/BoloniniD))。
- 现在使用 Ubuntu 20.04 运行集成测试,用于运行集成测试的 docker-compose 版本已更新至 1.28.2。环境变量现在对 docker-compose 生效。重构 test_dictionaries_all_layouts_separate_sources 以支持并行运行。[#20393](https://github.com/ClickHouse/ClickHouse/pull/20393) ([Ilya Yatsishin](https://github.com/qoega))。
- 修复安装脚本中的 TOCTOU 错误。[#25277](https://github.com/ClickHouse/ClickHouse/pull/25277) ([alexey-milovidov](https://github.com/alexey-milovidov))。

### ClickHouse 版本 21.6,2021-06-05 {#clickhouse-release-216-2021-06-05}

#### 向后不兼容的变更 {#backward-incompatible-change-5}

- uniqState / uniqHLL12State / uniqCombinedState / uniqCombined64State 对 `UUID` 类型产生不兼容的状态。[#33607](https://github.com/ClickHouse/ClickHouse/issues/33607)。

#### 升级说明 {#upgrade-notes-1}

- `zstd` 压缩库已更新至 v1.5.0。您可能会在复制过程中收到"校验和不匹配"的消息。由于压缩算法的更新,这些消息是预期的,您可以忽略它们。这些消息仅供参考,不表示任何异常行为。
- 设置 `compile_expressions` 默认启用。尽管它已在各种场景下经过充分测试,但如果您在服务器上发现任何异常行为,可以尝试关闭此设置。
- `UUID` 类型的值不能与整数进行比较。例如,应使用 `uuid != '00000000-0000-0000-0000-000000000000'` 而不是 `uuid != 0`。

#### 新功能 {#new-feature-5}


* 添加类似 PostgreSQL 的类型转换运算符（`::`）。例如：`[1, 2]::Array(UInt8)`、`0.1::Decimal(4, 4)`、`number::UInt16`。[#23871](https://github.com/ClickHouse/ClickHouse/pull/23871)（[Anton Popov](https://github.com/CurtizJ)）。
* 让大整数达到生产可用状态。添加对 `UInt128` 数据类型的支持。修复 `Decimal256` 数据类型的已知问题。在字典中支持大整数。在 `gcd`/`lcm` 函数中支持大整数。在数组搜索和条件函数中支持大整数。支持 `LowCardinality(UUID)`。在 `generateRandom` 表函数和 `clickhouse-obfuscator` 中支持大整数。修复从标量子查询返回 `UUID` 时的错误。修复了 [#7834](https://github.com/ClickHouse/ClickHouse/issues/7834)。修复了 [#23936](https://github.com/ClickHouse/ClickHouse/issues/23936)。修复了 [#4176](https://github.com/ClickHouse/ClickHouse/issues/4176)。修复了 [#24018](https://github.com/ClickHouse/ClickHouse/issues/24018)。不向后兼容的变更：`UUID` 类型的值不能再与整数进行比较。例如，不要写 `uuid != 0`，而应写为 `uuid != '00000000-0000-0000-0000-000000000000'`。[#23631](https://github.com/ClickHouse/ClickHouse/pull/23631) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 在 `Arrow`、`Parquet` 和 `ORC` 格式中支持用于插入和查询数据的 `Array` 数据类型。 [#21770](https://github.com/ClickHouse/ClickHouse/pull/21770) ([taylor12805](https://github.com/taylor12805)).
* 实现表注释功能。修复 [#23225](https://github.com/ClickHouse/ClickHouse/issues/23225)。[#23548](https://github.com/ClickHouse/ClickHouse/pull/23548)（[flynn](https://github.com/ucasFL)）。
* 在 `clickhouse-local` 中支持使用 DDL 查询创建字典。修复了 [#22354](https://github.com/ClickHouse/ClickHouse/issues/22354) 中的问题。新增对 `DETACH DICTIONARY PERMANENTLY` 的支持。为 `Atomic` 数据库引擎新增对 `EXCHANGE DICTIONARIES` 的支持。新增通过 `RENAME DICTIONARY` 在数据库之间移动字典的支持。[#23436](https://github.com/ClickHouse/ClickHouse/pull/23436)（[Maksim Kita](https://github.com/kitaisreal)）。
* 在 ClickHouse 中添加聚合函数 `uniqTheta`，以支持 [Theta Sketch](https://datasketches.apache.org/docs/Theta/ThetaSketchFramework.html)。[#23894](https://github.com/ClickHouse/ClickHouse/pull/23894)。[#22609](https://github.com/ClickHouse/ClickHouse/pull/22609)（[Ping Yu](https://github.com/pingyu)）。
* 添加了函数 `splitByRegexp`。 [#24077](https://github.com/ClickHouse/ClickHouse/pull/24077) ([abel-cheng](https://github.com/abel-cheng))。
* 新增函数 `arrayProduct`，该函数接受一个数组作为参数，并返回数组中所有元素的乘积。修复问题 [#21613](https://github.com/ClickHouse/ClickHouse/issues/21613)。[#23782](https://github.com/ClickHouse/ClickHouse/pull/23782)（[Maksim Kita](https://github.com/kitaisreal)）。
* 在 `system.stack_trace` 中添加 `thread_name` 列。此更改解决了 [#23256](https://github.com/ClickHouse/ClickHouse/issues/23256)。[#24124](https://github.com/ClickHouse/ClickHouse/pull/24124)（[abel-cheng](https://github.com/abel-cheng)）。
* 如果将 `insert_null_as_default` 设为 1，则在 `INSERT ... SELECT` 和 `INSERT ... SELECT ... UNION ALL ...` 查询中会插入默认值而不是 NULL。修复了 [#22832](https://github.com/ClickHouse/ClickHouse/issues/22832)。[#23524](https://github.com/ClickHouse/ClickHouse/pull/23524)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在 `clickhouse-local` 中通过 `--progress` 选项增加进度显示支持。[#23196](https://github.com/ClickHouse/ClickHouse/pull/23196)（[Egor Savin](https://github.com/Amesaru)）。
* 在 `http` 字典源中添加对 HTTP 压缩（由 `Content-Encoding` HTTP 头确定）的支持。此更改修复了 [#8912](https://github.com/ClickHouse/ClickHouse/issues/8912)。[#23946](https://github.com/ClickHouse/ClickHouse/pull/23946)（[FArthur-cmd](https://github.com/FArthur-cmd)）。
* 新增 `SYSTEM QUERY RELOAD MODEL`、`SYSTEM QUERY RELOAD MODELS`。关闭 [#18722](https://github.com/ClickHouse/ClickHouse/issues/18722)。[#23182](https://github.com/ClickHouse/ClickHouse/pull/23182)（[Maksim Kita](https://github.com/kitaisreal)）。
* 为 `EXPLAIN PLAN` 查询新增 `json` 设置（布尔值，默认为 0）。启用后，查询输出将为单行 `JSON`。建议使用 `TSVRaw` 格式以避免不必要的转义。[#23082](https://github.com/ClickHouse/ClickHouse/pull/23082)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 为 `EXPLAIN PIPELINE` 查询新增 `indexes` 设置（布尔类型，默认禁用）。启用后，会显示所使用的索引，以及每个已应用索引对应被过滤的数据片段和粒度的数量。支持 `MergeTree*` 表。[#22352](https://github.com/ClickHouse/ClickHouse/pull/22352) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* LDAP：实现了用户 DN 侦测功能，用于在将 Active Directory 组映射到 ClickHouse 角色时使用。 [#22228](https://github.com/ClickHouse/ClickHouse/pull/22228) ([Denis Glazachev](https://github.com/traceon)).
* 新的聚合函数 `deltaSumTimestamp`，用于在合并时通过存储时间戳来保持顺序，并对连续行之间的差值求和。[#21888](https://github.com/ClickHouse/ClickHouse/pull/21888) ([Russ Frank](https://github.com/rf))。
* 为 S3 添加了一个安全性较低的 IMDS 凭据提供程序，使其能在 Docker 环境下正常工作。 [#21852](https://github.com/ClickHouse/ClickHouse/pull/21852) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 重新添加 `indexHint` 函数。用于 [#21238](https://github.com/ClickHouse/ClickHouse/issues/21238)。这回滚了 [#9542](https://github.com/ClickHouse/ClickHouse/pull/9542)，并修复了 [#9540](https://github.com/ClickHouse/ClickHouse/issues/9540)。[#21304](https://github.com/ClickHouse/ClickHouse/pull/21304)（[Amos Bird](https://github.com/amosbird)）。

#### 实验性功能 {#experimental-feature-5}

- 为 `MergeTree*` 表添加 `PROJECTION` 支持。[#20202](https://github.com/ClickHouse/ClickHouse/pull/20202) ([Amos Bird](https://github.com/amosbird))。

#### 性能改进 {#performance-improvement-5}

- 默认启用 `compile_expressions` 设置。启用此设置后,简单函数和运算符的组合将在运行时通过 LLVM 编译为原生代码。[#8482](https://github.com/ClickHouse/ClickHouse/pull/8482) ([Maksim Kita](https://github.com/kitaisreal), [alexey-milovidov](https://github.com/alexey-milovidov))。注意:如果遇到问题,请关闭此选项。
- 更新 `re2` 库。正则表达式匹配性能得到改进。此外,此 PR 添加了对 gcc-11 的兼容性。[#24196](https://github.com/ClickHouse/ClickHouse/pull/24196) ([Raúl Marín](https://github.com/Algunenano))。
- ORC 输入格式按条带读取,而不是一次性将整个表读入内存,避免了在文件较大时占用过多内存。[#23102](https://github.com/ClickHouse/ClickHouse/pull/23102) ([Chao Ma](https://github.com/godliness))。
- 将查询中的聚合函数 `sum`、`count` 和 `avg` 融合为单个聚合函数。此优化通过 `optimize_fuse_sum_count_avg` 设置控制。这是通过新的聚合函数 `sumCount` 实现的。该函数返回包含两个字段的元组:`sum` 和 `count`。[#21337](https://github.com/ClickHouse/ClickHouse/pull/21337) ([hexiaoting](https://github.com/hexiaoting))。
- 将 `zstd` 更新至 v1.5.0。压缩性能提升了个位数百分比。[#24135](https://github.com/ClickHouse/ClickHouse/pull/24135) ([Raúl Marín](https://github.com/Algunenano))。注意:在复制过程中可能会收到"校验和不匹配"的消息。由于压缩算法的更新,这些消息是预期的,可以忽略。
- 改进了 `Buffer` 表的性能:对于 `Buffer` 引擎,不再为 total_bytes/total_rows 获取锁。[#24066](https://github.com/ClickHouse/ClickHouse/pull/24066) ([Azat Khuzhin](https://github.com/azat))。
- 恢复了对 hashed/sparse_hashed 字典的预分配支持。[#23979](https://github.com/ClickHouse/ClickHouse/pull/23979) ([Azat Khuzhin](https://github.com/azat))。
- 默认启用 `async_socket_for_remote`(在查询具有大扇出的分布式表时减少线程数量)。[#23683](https://github.com/ClickHouse/ClickHouse/pull/23683) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。

#### 改进 {#improvement-5}


* 为 MergeTree 表族添加 `_partition_value` 虚拟列。它可用于以确定性方式剪枝分区，这是实现变更操作分区匹配器所必需的。[#23673](https://github.com/ClickHouse/ClickHouse/pull/23673) ([Amos Bird](https://github.com/amosbird))。
* 为 S3 存储和磁盘新增了 `region` 参数。[#23846](https://github.com/ClickHouse/ClickHouse/pull/23846)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* 允许为不同的日志通道配置不同的日志级别。修复 [#19569](https://github.com/ClickHouse/ClickHouse/issues/19569)。[#23857](https://github.com/ClickHouse/ClickHouse/pull/23857) ([filimonov](https://github.com/filimonov))。
* 在未显式指定时，在 `DateTime` 运算中保留默认时区。例如，如果对一个无时区的 `DateTime` 类型的值加一秒，它仍将是无时区的 `DateTime`。在之前的版本中，默认时区的值会被显式写入到返回的数据类型中，因此会变成 DateTime(&#39;something&#39;)。此变更修复了 [#4854](https://github.com/ClickHouse/ClickHouse/issues/4854)。[#23392](https://github.com/ClickHouse/ClickHouse/pull/23392)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 允许用户在 `MySQL` 存储中将数据库名指定为空字符串。查询将使用默认数据库。在之前的版本中，这仅对 SELECT 查询有效，现在也为 INSERT 增加了支持。此更改关闭了 [#19281](https://github.com/ClickHouse/ClickHouse/issues/19281)。这在使用 `Sphinx` 或其他兼容 MySQL 的外部数据库时非常有用。[#23319](https://github.com/ClickHouse/ClickHouse/pull/23319) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了 `quantile(s)TDigest`。根据 tdunning/t-digest 3.2+ 增加了对单元素质心的特殊处理，同时修复了早期版本算法实现中质心过度压缩的错误。[#23314](https://github.com/ClickHouse/ClickHouse/pull/23314)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* 函数 `now64` 现在支持可选的时区参数。[#24091](https://github.com/ClickHouse/ClickHouse/pull/24091) ([Vasily Nemkov](https://github.com/Enmk))。
* 修复在 `clickhouse-client` 交互模式下，进度条在数据输出中间出现时，可能会在终端中覆盖部分可见数据的问题。此更改关闭了 [#19283](https://github.com/ClickHouse/ClickHouse/issues/19283)。[#23050](https://github.com/ClickHouse/ClickHouse/pull/23050)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在 `simdjson` 中内存分配失败时导致的崩溃。 [https://github.com/simdjson/simdjson/pull/1567](https://github.com/simdjson/simdjson/pull/1567)。将其标记为改进项，因为这是一个极其罕见的错误。 [#24147](https://github.com/ClickHouse/ClickHouse/pull/24147) ([Amos Bird](https://github.com/amosbird))。
* 在存储关闭前保留字典（这样可以避免在服务器关闭期间 `Buffer` 引擎进行最终刷新时可能出现的 `external dictionary 'DICT' not found` 错误）。[#24068](https://github.com/ClickHouse/ClickHouse/pull/24068) ([Azat Khuzhin](https://github.com/azat)).
* 在关闭（同一数据库内的）表之前先刷新 `Buffer` 表，以避免由于底层表已经被分离而导致数据块被丢弃（以及日志中出现 `Destination table default.a_data_01870 doesn't exist. Block of data is discarded` 错误）。 [#24067](https://github.com/ClickHouse/ClickHouse/pull/24067) ([Azat Khuzhin](https://github.com/azat)).
* 现在 `prefer_column_name_to_alias = 1` 也会在 `group by`、`having` 和 `order by` 中优先使用列名。这修复了 [#23882](https://github.com/ClickHouse/ClickHouse/issues/23882)。[#24022](https://github.com/ClickHouse/ClickHouse/pull/24022)（[Amos Bird](https://github.com/amosbird)）。
* 为 `DateTime64` 添加 `ORDER BY WITH FILL` 支持。[#24016](https://github.com/ClickHouse/ClickHouse/pull/24016)（[kevin wan](https://github.com/MaxWk)）。
* 允许在 `ReplacingMergeTree` 中将 `DateTime64` 用作版本列。[#23992](https://github.com/ClickHouse/ClickHouse/pull/23992) ([kevin wan](https://github.com/MaxWk)).
* 在服务器启动时记录操作系统名称、内核版本和 CPU 架构等信息。 [#23988](https://github.com/ClickHouse/ClickHouse/pull/23988) ([Azat Khuzhin](https://github.com/azat)).
* 支持为 `postgresql` 字典源指定表结构。修复了 [#23958](https://github.com/ClickHouse/ClickHouse/issues/23958)。[#23980](https://github.com/ClickHouse/ClickHouse/pull/23980)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 为 `Enum` 元素名称添加提示功能（在出现拼写错误时给出名称建议）。修复 [#17112](https://github.com/ClickHouse/ClickHouse/issues/17112)。[#23919](https://github.com/ClickHouse/ClickHouse/pull/23919)（[flynn](https://github.com/ucasFL)）。
* 为字典统计命中率（找到值的百分比）（参见 `system.dictionaries` 中的 `found_rate`）。[#23916](https://github.com/ClickHouse/ClickHouse/pull/23916)（[Azat Khuzhin](https://github.com/azat)）。
* 允许通过表设置 `rabbitmq_queue_settings_list` 添加特定的队列配置。（关闭 [#23737](https://github.com/ClickHouse/ClickHouse/issues/23737) 和 [#23918](https://github.com/ClickHouse/ClickHouse/issues/23918)）。允许用户完全控制 RabbitMQ 的整体配置：如果将表设置 `rabbitmq_queue_consume` 设为 `1` —— RabbitMQ 表引擎将只连接到指定队列，不会执行任何 RabbitMQ 消费端的初始化操作，例如声明 exchange、队列和绑定。（关闭 [#21757](https://github.com/ClickHouse/ClickHouse/issues/21757)）。在删除 RabbitMQ 表时添加了正确的清理逻辑 —— 删除由该表声明的队列，以及所有与其绑定的 exchange（如果这些 exchange 是由该表创建的）。[#23887](https://github.com/ClickHouse/ClickHouse/pull/23887) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 在 `system.distribution_queue` 中添加字段 `broken_data_files` 和 `broken_data_compressed_bytes`。新增指标 `BrokenDistributedFilesToInsert`，用于统计异步插入到 Distributed 表时被标记为损坏的文件数量。[#23885](https://github.com/ClickHouse/ClickHouse/pull/23885) ([Azat Khuzhin](https://github.com/azat))。
* 查询 `system.tables` 时不再访问 ZooKeeper。[#23793](https://github.com/ClickHouse/ClickHouse/pull/23793) ([Fuwang Hu](https://github.com/fuwhu)).
* 在执行 `OPTIMIZE` 查询时遵循 `lock_acquire_timeout_for_background_operations` 设置。[#23623](https://github.com/ClickHouse/ClickHouse/pull/23623) ([Azat Khuzhin](https://github.com/azat)).
* 通过新的 `SYSTEM RESTART DISK` SQL 命令，可以在运行时修改 `S3` 磁盘设置。[#23429](https://github.com/ClickHouse/ClickHouse/pull/23429)（[Pavel Kovalenko](https://github.com/Jokser)）。
* 如果用户误将 `max_distributed_connections` 配置为零，对 `Distributed` 表的每个查询都会抛出一个异常，异常消息中包含 “logical error”。但这实际上是预期行为，而不是逻辑错误，因此该异常消息略有不准确。它还会触发我们 CI 环境中的检查，而该检查用于确保不会发生任何逻辑错误。因此，我们现在会将被错误配置为零的 `max_distributed_connections` 按最小允许值（1）处理。[#23348](https://github.com/ClickHouse/ClickHouse/pull/23348) ([Azat Khuzhin](https://github.com/azat))。
* 默认将 `min_bytes_to_use_mmap_io` 设为禁用。 [#23322](https://github.com/ClickHouse/ClickHouse/pull/23322) ([Azat Khuzhin](https://github.com/azat))。
* 在 `join_use_nulls` 中支持 `LowCardinality` 的可空性，关闭 [#15101](https://github.com/ClickHouse/ClickHouse/issues/15101)。[#23237](https://github.com/ClickHouse/ClickHouse/pull/23237)（[vdimir](https://github.com/vdimir)）。
* 为 `S3` 磁盘新增了将 `MergeTree` 数据部分恢复到 `detached` 目录的功能。 [#23112](https://github.com/ClickHouse/ClickHouse/pull/23112) ([Pavel Kovalenko](https://github.com/Jokser)).
* 在 S3 上支持针对 HTTP 连接中断的重试。[#22988](https://github.com/ClickHouse/ClickHouse/pull/22988)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* 为 MySQL 表引擎、字典源以及 MaterializeMySQL 的小批量数据抓取新增设置项 `external_storage_max_read_rows` 和 `external_storage_max_read_rows`。 [#22697](https://github.com/ClickHouse/ClickHouse/pull/22697) ([TCeason](https://github.com/TCeason))。
* `MaterializeMySQL`（实验特性）：此前由于 SQL 不兼容，不支持 MySQL 5.7.9。现在将 MySQL 参数验证交由 MaterializeMySQL 处理。[#23413](https://github.com/ClickHouse/ClickHouse/pull/23413) ([TCeason](https://github.com/TCeason))。
* 为分布式表启用子列读取功能。[#24472](https://github.com/ClickHouse/ClickHouse/pull/24472) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在 `CREATE .. AS SELECT` 查询中对元组的使用方式。 [#24464](https://github.com/ClickHouse/ClickHouse/pull/24464) ([Anton Popov](https://github.com/CurtizJ)).
* 在 `Kafka` 表中增加对 `Parquet` 格式的支持。[#23412](https://github.com/ClickHouse/ClickHouse/pull/23412)（[Chao Ma](https://github.com/godliness)）。

#### 错误修复 {#bug-fix-4}


* 在分区键和主键中使用时，采用旧版本的取模函数。修复了 [#23508](https://github.com/ClickHouse/ClickHouse/issues/23508)。[#24157](https://github.com/ClickHouse/ClickHouse/pull/24157)（[Kseniia Sumarokova](https://github.com/kssenii)）。这曾是之前版本中的一个向后不兼容问题来源。
* 修复了在执行 `SYSTEM RESTART REPLICA` 或 `SYSTEM SYNC REPLICA` 查询时会被无限处理的问题。该问题是在可用 RAM 极少的服务器上发现的。[#24457](https://github.com/ClickHouse/ClickHouse/pull/24457) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 修复 `toWeek` 函数不正确的单调性。此修复解决了 [#24422](https://github.com/ClickHouse/ClickHouse/issues/24422)。该缺陷最初在 [#5212](https://github.com/ClickHouse/ClickHouse/pull/5212) 中被引入，之后被更智能的分区裁剪器暴露出来。[#24446](https://github.com/ClickHouse/ClickHouse/pull/24446)（[Amos Bird](https://github.com/amosbird)）。
* 修复在存在相交伪部件时执行 drop partition 的问题。在极少数情况下，可能会出现 `mutation` 版本号大于当前块号的部件。 [#24321](https://github.com/ClickHouse/ClickHouse/pull/24321) ([Amos Bird](https://github.com/amosbird)).
* 修复了在使用 `RENAME TABLE` 查询将物化视图从 Ordinary 数据库迁移到 Atomic 数据库时的一个错误。现在内部表会和物化视图一起被移动到新的数据库中。修复了 [#23926](https://github.com/ClickHouse/ClickHouse/issues/23926)。[#24309](https://github.com/ClickHouse/ClickHouse/pull/24309)（[tavplubix](https://github.com/tavplubix)）。
* 允许客户端请求中包含空的 HTTP 头。修复了 [#23901](https://github.com/ClickHouse/ClickHouse/issues/23901)。[#24285](https://github.com/ClickHouse/ClickHouse/pull/24285)（[Ivan](https://github.com/abyss7)）。
* 将 `max_threads` 设置为 `1`，以修复 `Memory` 表 mutation 失败的问题。关闭 [#24274](https://github.com/ClickHouse/ClickHouse/issues/24274)。[#24275](https://github.com/ClickHouse/ClickHouse/pull/24275)（[flynn](https://github.com/ucasFL)）。
* 修复 `Memory` 表实现中的拼写错误，该问题是在 [#15127](https://github.com/ClickHouse/ClickHouse/issues/15127) 中引入的。修复了 [#24192](https://github.com/ClickHouse/ClickHouse/issues/24192)。[#24193](https://github.com/ClickHouse/ClickHouse/pull/24193)（[张中南](https://github.com/plugine)）。
* 修复在查询执行期间由于 `HDFS` 无法访问而导致的异常服务器终止问题。关闭 [#24117](https://github.com/ClickHouse/ClickHouse/issues/24117)。[#24191](https://github.com/ClickHouse/ClickHouse/pull/24191)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在使用常量条件更新 `Nested` 列时出现的崩溃。[#24183](https://github.com/ClickHouse/ClickHouse/pull/24183) ([hexiaoting](https://github.com/hexiaoting)).
* 修复在高负载下 RBAC 中可能出现的竞态条件。此 PR 修复了 [#24090](https://github.com/ClickHouse/ClickHouse/issues/24090)、[#24134](https://github.com/ClickHouse/ClickHouse/issues/24134)、[#24176](https://github.com/ClickHouse/ClickHouse/pull/24176)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复了一个罕见的错误，该错误可能导致表只被部分初始化却仍然可以处理写入请求（`insert`/`alter`/等）。现在，此类表将处于只读模式。[#24122](https://github.com/ClickHouse/ClickHouse/pull/24122) ([alesapin](https://github.com/alesapin)).
* 修复了一个问题：`EXPLAIN PIPELINE` 在处理 `SELECT xxx FINAL` 时展示的 pipeline 不正确。（[hexiaoting](https://github.com/hexiaoting)）。
* 修复了在 `WHERE` 子句中使用常量 `DateTime` 值与 `DateTime64` 列的问题。[#24100](https://github.com/ClickHouse/ClickHouse/pull/24100) ([Vasily Nemkov](https://github.com/Enmk))。
* 修复 `merge JOIN` 中的崩溃，关闭 [#24010](https://github.com/ClickHouse/ClickHouse/issues/24010)。[#24013](https://github.com/ClickHouse/ClickHouse/pull/24013)（[vdimir](https://github.com/vdimir)）。
* 某些 `ALTER PARTITION` 查询可能会在复制队列中导致 `Part A intersects previous part B` 和 `Unexpected merged part C intersecting drop range D` 错误。该问题已修复。修复了 [#23296](https://github.com/ClickHouse/ClickHouse/issues/23296)。[#23997](https://github.com/ClickHouse/ClickHouse/pull/23997)（[tavplubix](https://github.com/tavplubix)）。
* 修复在使用外部 GROUP BY 和溢出行时出现的 SIGSEGV（例如执行 `SELECT FROM GROUP BY WITH TOTALS SETTINGS max_bytes_before_external_group_by>0, max_rows_to_group_by>0, group_by_overflow_mode='any', totals_mode='before_having'` 这类查询时）。 [#23962](https://github.com/ClickHouse/ClickHouse/pull/23962) ([Azat Khuzhin](https://github.com/azat)).
* 修复 `CACHE` 字典在源数据存在重复项时的键指标统计问题（会导致 `DictCacheKeysRequestedMiss` 计数溢出）。[#23929](https://github.com/ClickHouse/ClickHouse/pull/23929) ([Azat Khuzhin](https://github.com/azat)).
* 修复 `PostgreSQL` 引擎的连接池实现。解决 [#23897](https://github.com/ClickHouse/ClickHouse/issues/23897)。[#23909](https://github.com/ClickHouse/ClickHouse/pull/23909)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在使用 `distributed_group_by_no_merge = 2` 时，`GROUP BY` 中的聚合函数被包裹在普通函数里所导致的问题（此前在 [#23546](https://github.com/ClickHouse/ClickHouse/issues/23546) 中被破坏）。当尝试将 `distributed_group_by_no_merge = 2` 与窗口函数一起使用时抛出异常。对包含窗口函数的查询禁用 `optimize_distributed_group_by_sharding_key`。[#23906](https://github.com/ClickHouse/ClickHouse/pull/23906)（[Azat Khuzhin](https://github.com/azat)）。
* 修复了 `s3` 表函数：改进了对 HTTP 错误的处理。之前会忽略 HTTP 错误的响应体。[#23844](https://github.com/ClickHouse/ClickHouse/pull/23844) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 对 `s3` 表函数的修复：改进了对 URI 的处理。修复了包含 `+` 符号的 URL 的兼容性问题，此前无法读取具有此类键的数据。[#23822](https://github.com/ClickHouse/ClickHouse/pull/23822)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* 修复在包含 `GLOBAL IN/JOIN` 且启用了 `use_hedged_requests` 的查询中出现的错误 `Can't initialize pipeline with empty pipe`。修复了 [#23431](https://github.com/ClickHouse/ClickHouse/issues/23431)。[#23805](https://github.com/ClickHouse/ClickHouse/pull/23805)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复 `CLEAR COLUMN` 在被物化视图引用时不起作用的问题。关闭 [#23764](https://github.com/ClickHouse/ClickHouse/issues/23764)。[#23781](https://github.com/ClickHouse/ClickHouse/pull/23781)（[flynn](https://github.com/ucasFL)）。
* 修复在使用 `Values` 格式从 HDFS 读取时出现的释放后堆使用问题。 [#23761](https://github.com/ClickHouse/ClickHouse/pull/23761) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 在向 Distributed 表执行 INSERT 时，避免在发生某些异常时可能出现的 “Cannot schedule a task” 错误。[#23744](https://github.com/ClickHouse/ClickHouse/pull/23744) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在恢复陈旧 `ReplicatedMergeTree` 副本时的一个错误。如果在副本停机期间执行了 `ALTER` 查询，那么该陈旧副本可能会忽略某些元数据更新。 [#23742](https://github.com/ClickHouse/ClickHouse/pull/23742) ([tavplubix](https://github.com/tavplubix)).
* 修复 `Join` 与 `WITH TOTALS` 的相关 bug，关闭 [#17718](https://github.com/ClickHouse/ClickHouse/issues/17718)。[#23549](https://github.com/ClickHouse/ClickHouse/pull/23549)（[vdimir](https://github.com/vdimir)）。
* 修复在使用 `UNION` 的查询中，因 filter-pushdown 优化可能导致的 `Block structure mismatch` 错误。修复 [#23029](https://github.com/ClickHouse/ClickHouse/issues/23029)。[#23359](https://github.com/ClickHouse/ClickHouse/pull/23359)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 在启用 `optimize_skip_unused_shards_rewrite_in` 设置时添加类型转换，以修复 MSan 报告的问题。[#23219](https://github.com/ClickHouse/ClickHouse/pull/23219) ([Azat Khuzhin](https://github.com/azat))。
* 在更新嵌套子列时补充遗漏的检查，关闭 issue：[#22353](https://github.com/ClickHouse/ClickHouse/issues/22353)。[#22503](https://github.com/ClickHouse/ClickHouse/pull/22503)（[hexiaoting](https://github.com/hexiaoting)）。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-5}

- 支持在 Illumos 上构建。[#24144](https://github.com/ClickHouse/ClickHouse/pull/24144)。增加了对 Solaris 衍生操作系统的构建支持。[#23746](https://github.com/ClickHouse/ClickHouse/pull/23746) ([bnaecker](https://github.com/bnaecker))。
- 为哈希表增加更多基准测试,包括 Google 的 Swiss Table(在我们的特定使用场景中,其性能似乎低于 ClickHouse 哈希映射)。[#24111](https://github.com/ClickHouse/ClickHouse/pull/24111) ([Maksim Kita](https://github.com/kitaisreal))。
- 将 librdkafka 从 1.6.0-RC3 更新至 1.6.1。[#23874](https://github.com/ClickHouse/ClickHouse/pull/23874) ([filimonov](https://github.com/filimonov))。
- 始终显式启用 `asynchronous-unwind-tables`。这可能会修复 AArch64 上的查询性能分析器问题。[#23602](https://github.com/ClickHouse/ClickHouse/pull/23602) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 避免构建对区域设置和文件系统顺序产生依赖。这使得可重现构建成为可能。[#23600](https://github.com/ClickHouse/ClickHouse/pull/23600) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 消除构建中的一个非确定性来源。现在在不同时间点进行的构建将产生字节级完全相同的二进制文件。部分解决了 [#22113](https://github.com/ClickHouse/ClickHouse/issues/22113)。[#23559](https://github.com/ClickHouse/ClickHouse/pull/23559) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 添加用于 (Zoo)Keeper 基准测试的简单工具。[#23038](https://github.com/ClickHouse/ClickHouse/pull/23038) ([alesapin](https://github.com/alesapin))。


## ClickHouse 版本 21.5, 2021-05-20 {#clickhouse-release-215-2021-05-20}

#### 向后不兼容的变更 {#backward-incompatible-change-6}

- 当整数无法在浮点数据类型中精确表示时,更改整数与浮点数的比较行为。在新版本中,由于会发生舍入误差,比较将返回 false。例如:`9223372036854775808.0 != 9223372036854775808`,因为数字 `9223372036854775808` 无法精确表示为浮点数(并且 `9223372036854775808.0` 会被舍入为 `9223372036854776000.0`)。但在之前的版本中,比较会返回这些数字相等,因为如果将浮点数 `9223372036854776000.0` 转换回 UInt64,它将产生 `9223372036854775808`。作为参考,Python 编程语言也将这些数字视为相等。但这种行为依赖于 CPU 型号(在 AMD64 和 AArch64 上对某些超出范围的数字会产生不同的结果),因此我们使比较更加精确。现在只有当整数能在浮点类型中精确表示时,才会将整数和浮点数视为相等。[#22595](https://github.com/ClickHouse/ClickHouse/pull/22595) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 移除对单个 `Tuple` 参数的 `argMin` 和 `argMax` 支持。该代码不是内存安全的。此功能是错误添加的,并且会让用户感到困惑。这些函数可能会在以后以不同的名称重新引入。此更改修复了 [#22384](https://github.com/ClickHouse/ClickHouse/issues/22384) 并回退了 [#17359](https://github.com/ClickHouse/ClickHouse/issues/17359)。[#23393](https://github.com/ClickHouse/ClickHouse/pull/23393) ([alexey-milovidov](https://github.com/alexey-milovidov))。

#### 新功能 {#new-feature-6}

- 添加了函数 `dictGetChildren(dictionary, key)` 和 `dictGetDescendants(dictionary, key, level)`。函数 `dictGetChildren` 以索引数组的形式返回所有子节点。它是 `dictGetHierarchy` 的逆向转换。函数 `dictGetDescendants` 返回所有后代节点,就像递归应用 `dictGetChildren` `level` 次一样。`level` 值为零等同于无限。改进了 `dictGetHierarchy` 和 `dictIsIn` 函数的性能。关闭了 [#14656](https://github.com/ClickHouse/ClickHouse/issues/14656)。[#22096](https://github.com/ClickHouse/ClickHouse/pull/22096) ([Maksim Kita](https://github.com/kitaisreal))。
- 添加了函数 `dictGetOrNull`。它的工作方式类似于 `dictGet`,但在字典中未找到键时返回 `Null`。关闭了 [#22375](https://github.com/ClickHouse/ClickHouse/issues/22375)。[#22413](https://github.com/ClickHouse/ClickHouse/pull/22413) ([Maksim Kita](https://github.com/kitaisreal))。
- 添加了表函数 `s3Cluster`,允许在指定集群的每个节点上并行处理来自 `s3` 的文件。[#22012](https://github.com/ClickHouse/ClickHouse/pull/22012) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 在 MySQL/PostgreSQL 表引擎/表函数中添加了对副本和分片的支持。您可以编写 `SELECT * FROM mysql('host{1,2}-{1|2}', ...)`。关闭了 [#20969](https://github.com/ClickHouse/ClickHouse/issues/20969)。[#22217](https://github.com/ClickHouse/ClickHouse/pull/22217) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 添加了 `ALTER TABLE ... FETCH PART ...` 查询。它类似于 `FETCH PARTITION`,但只获取一个数据部分。[#22706](https://github.com/ClickHouse/ClickHouse/pull/22706) ([turbo jason](https://github.com/songenjie))。
- 添加了设置 `max_distributed_depth`,用于限制对 `Distributed` 表的递归查询深度。关闭了 [#20229](https://github.com/ClickHouse/ClickHouse/issues/20229)。[#21942](https://github.com/ClickHouse/ClickHouse/pull/21942) ([flynn](https://github.com/ucasFL))。


#### 性能改进 {#performance-improvement-6}

- 通过为 AVX2 实现动态分发,提升了 `intDiv` 的性能。此更改解决了 [#22314](https://github.com/ClickHouse/ClickHouse/issues/22314)。[#23000](https://github.com/ClickHouse/ClickHouse/pull/23000) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 提升了从 `ArrowStream` 输入格式读取非本地文件源(例如 URL)的性能。[#22673](https://github.com/ClickHouse/ClickHouse/pull/22673) ([nvartolomei](https://github.com/nvartolomei))。
- 通过原生协议与 localhost 交互时(使用 clickhouse-client 或分布式查询中的服务器间通信),默认禁用压缩。这可能会提升某些导入/导出操作的性能。此更改解决了 [#22234](https://github.com/ClickHouse/ClickHouse/issues/22234)。[#22237](https://github.com/ClickHouse/ClickHouse/pull/22237) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 在分布式查询中,从 IN 子句的右侧部分排除不属于该分片的值(在 `optimize_skip_unused_shards_rewrite_in` 设置下,默认启用,但仍需要 `optimize_skip_unused_shards`)。[#21511](https://github.com/ClickHouse/ClickHouse/pull/21511) ([Azat Khuzhin](https://github.com/azat))。
- 提升了使用类文件表引擎和列式格式(如 Parquet、Arrow 或 ORC)读取列子集的性能。此更改解决了 [#issue:20129](https://github.com/ClickHouse/ClickHouse/issues/20129)。[#21302](https://github.com/ClickHouse/ClickHouse/pull/21302) ([keenwolf](https://github.com/keen-wolf))。
- 允许将更多条件移动到 `PREWHERE`,恢复到 21.1 版本之前的行为(调整了内部启发式算法)。移动的条件数量不足可能导致性能下降。[#23397](https://github.com/ClickHouse/ClickHouse/pull/23397) ([Anton Popov](https://github.com/CurtizJ))。
- 提升了 ODBC 连接的性能,并修复了积压的所有未解决问题。使用 `nanodbc` 库替代 `Poco::ODBC`。解决了 [#9678](https://github.com/ClickHouse/ClickHouse/issues/9678)。为 ODBC 表引擎添加了对 DateTime64 和 Decimal\* 的支持。解决了 [#21961](https://github.com/ClickHouse/ClickHouse/issues/21961)。修复了西里尔文本被截断的问题。解决了 [#16246](https://github.com/ClickHouse/ClickHouse/issues/16246)。为 ODBC 桥接添加了连接池。[#21972](https://github.com/ClickHouse/ClickHouse/pull/21972) ([Kseniia Sumarokova](https://github.com/kssenii))。

#### 改进 {#improvement-6}


* 将 HTTP 接口中 URL 最大长度参数 `max_uri_size` 的默认值提高到 1 MiB。此更改修复了 [#21197](https://github.com/ClickHouse/ClickHouse/issues/21197)。[#22997](https://github.com/ClickHouse/ClickHouse/pull/22997)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 将 `background_fetches_pool_size` 设置为 `8`，这更适用于在生产环境中存在频繁小批量写入或 ZooKeeper 集群较慢的情况。 [#22945](https://github.com/ClickHouse/ClickHouse/pull/22945) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* FlatDictionary 新增了 `initial_array_size` 和 `max_array_size` 选项。 [#22521](https://github.com/ClickHouse/ClickHouse/pull/22521) ([Maksim Kita](https://github.com/kitaisreal)).
* 为非复制 MergeTree 表的插入去重新增设置 `non_replicated_deduplication_window`。[#22514](https://github.com/ClickHouse/ClickHouse/pull/22514) ([alesapin](https://github.com/alesapin))。
* 在重新加载配置时更新 `CatBoost` 模型配置的路径。[#22434](https://github.com/ClickHouse/ClickHouse/pull/22434) ([Kruglov Pavel](https://github.com/Avogar))。
* 在字典中新增了对 `Decimal256` 类型的支持。`Decimal256` 是实验性特性。关闭了 [#20979](https://github.com/ClickHouse/ClickHouse/issues/20979)。[#22960](https://github.com/ClickHouse/ClickHouse/pull/22960)（[Maksim Kita](https://github.com/kitaisreal)）。
* 默认启用 `async_socket_for_remote`（分布式查询将使用更少的 OS 线程）。[#23683](https://github.com/ClickHouse/ClickHouse/pull/23683) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复了 `quantile(s)TDigest`。根据 tdunning/t-digest 3.2+ 对单个质心添加了特殊处理。同时修复了该算法早期版本实现中质心过度压缩的 Bug。[#23314](https://github.com/ClickHouse/ClickHouse/pull/23314)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* 将函数名 `unhex` 调整为大小写不敏感，以兼容 MySQL。 [#23229](https://github.com/ClickHouse/ClickHouse/pull/23229) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 在数组元素类型不同的通用场景下，实现对函数 `arrayHasAny`、`arrayHasAll`、`has`、`indexOf`、`countEqual` 的支持。此前版本中，函数 `arrayHasAny`、`arrayHasAll` 会返回 false，而 `has`、`indexOf`、`countEqual` 会抛出异常。同时在 `has` 及类似函数中新增对 `Decimal` 和大整数类型的支持。修复了 [#20272](https://github.com/ClickHouse/ClickHouse/issues/20272)。[#23044](https://github.com/ClickHouse/ClickHouse/pull/23044)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 提高了函数 `extractAllGroupsHorizontal` 结果中最大匹配次数的上限阈值。[#23036](https://github.com/ClickHouse/ClickHouse/pull/23036) ([Vasily Nemkov](https://github.com/Enmk))。
* 不要在只有一个节点的集群上执行 `optimize_skip_unused_shards`。 [#22999](https://github.com/ClickHouse/ClickHouse/pull/22999) ([Azat Khuzhin](https://github.com/azat)).
* 新增支持使用 SSL 运行 `clickhouse-keeper`（ZooKeeper 的实验性可直接替换方案）。配置项 `keeper_server.tcp_port_secure` 可用于在客户端与 keeper-server 之间进行安全交互。`keeper_server.raft_configuration.secure` 可用于启用节点间的内部安全通信。[#22992](https://github.com/ClickHouse/ClickHouse/pull/22992) ([alesapin](https://github.com/alesapin))。
* 为 `Buffer` 表新增仅在后台刷新缓冲区的功能。 [#22986](https://github.com/ClickHouse/ClickHouse/pull/22986) ([Azat Khuzhin](https://github.com/azat)).
* 在对 MergeTree 表执行包含 `NULL` 的 `WHERE` 条件查询时，极少数情况下会抛出异常。此改动关闭了 [#20019](https://github.com/ClickHouse/ClickHouse/issues/20019)。[#22978](https://github.com/ClickHouse/ClickHouse/pull/22978)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复用于 AWS 的 Poco HTTP 客户端中的错误处理。[#22973](https://github.com/ClickHouse/ClickHouse/pull/22973) ([kreuzerkrieg](https://github.com/kreuzerkrieg)).
* 在 `ReplicatedMergeTree` 中遵循 `max_part_removal_threads` 设置。 [#22971](https://github.com/ClickHouse/ClickHouse/pull/22971) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在 MergeTree 设置中，`inactive_parts_to_throw_insert = 0` 且 `inactive_parts_to_delay_insert &gt; 0` 时的一个晦涩边界情况。[#22947](https://github.com/ClickHouse/ClickHouse/pull/22947) ([Azat Khuzhin](https://github.com/azat))。
* `dateDiff` 现在支持使用 `DateTime64` 参数（即使参数值超出 `DateTime` 范围）[#22931](https://github.com/ClickHouse/ClickHouse/pull/22931)（[Vasily Nemkov](https://github.com/Enmk)）。
* MaterializeMySQL（实验性功能）：新增支持对包含视图的 MySQL 数据库进行复制而不会失败，其实现方式是忽略这些视图。 [#22760](https://github.com/ClickHouse/ClickHouse/pull/22760) ([Christian](https://github.com/cfroystad))。
* 通过 PostgreSQL 协议支持 RBAC 行级策略。修复 [#22658](https://github.com/ClickHouse/ClickHouse/issues/22658)。PostgreSQL 协议在配置中默认启用。[#22755](https://github.com/ClickHouse/ClickHouse/pull/22755)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 添加用于跟踪等待 Buffer 层锁所花时间的指标。 [#22725](https://github.com/ClickHouse/ClickHouse/pull/22725) ([Azat Khuzhin](https://github.com/azat))。
* 允许在 VIEW 定义中使用 CTE，修复了 [#22491](https://github.com/ClickHouse/ClickHouse/issues/22491)。[#22657](https://github.com/ClickHouse/ClickHouse/pull/22657)（[Amos Bird](https://github.com/amosbird)）。
* 如果上一个程序在终端中留下了杂乱内容，则在 `clickhouse-client` 中清空剩余屏幕并显示光标。此更改解决了 [#16518](https://github.com/ClickHouse/ClickHouse/issues/16518)。[#22634](https://github.com/ClickHouse/ClickHouse/pull/22634)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 使 `round` 函数在非 x86&#95;64 平台上的行为保持一致。采用“舍入到最接近的偶数”（Banker&#39;s rounding）规则进行取整。[#22582](https://github.com/ClickHouse/ClickHouse/pull/22582) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 正确校验由 Distributed 表发送的数据块结构。[#22325](https://github.com/ClickHouse/ClickHouse/pull/22325) ([Azat Khuzhin](https://github.com/azat)).
* 允许将 Kafka 错误写入 Kafka 引擎的虚拟列中，由 `kafka_handle_error_mode` 设置控制。[#21850](https://github.com/ClickHouse/ClickHouse/pull/21850) ([fastio](https://github.com/fastio))。
* 为 `visitParam/visitParamExtract{UInt, Int, Bool, Float, Raw, String}` 添加别名 `simpleJSONExtract/simpleJSONHas`。修复 [#21383](https://github.com/ClickHouse/ClickHouse/issues/21383)。[#21519](https://github.com/ClickHouse/ClickHouse/pull/21519)（[fastio](https://github.com/fastio)）。
* 为库字典来源添加 `clickhouse-library-bridge`。修复了 [#9502](https://github.com/ClickHouse/ClickHouse/issues/9502)。[#21509](https://github.com/ClickHouse/ClickHouse/pull/21509)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 如果某列被物化视图引用，则禁止执行 `DROP COLUMN` 操作。修复 [#21164](https://github.com/ClickHouse/ClickHouse/issues/21164)。[#21303](https://github.com/ClickHouse/ClickHouse/pull/21303) ([flynn](https://github.com/ucasFL))。
* 支持动态服务器间凭证（可在不停机的情况下轮换凭证）。 [#14113](https://github.com/ClickHouse/ClickHouse/pull/14113) ([johnskopis](https://github.com/johnskopis))。
* 为 Kafka 存储添加对 `Arrow` 和 `ArrowStream` 格式消息的支持。 [#23415](https://github.com/ClickHouse/ClickHouse/pull/23415) ([Chao Ma](https://github.com/godliness))。
* 修复了异常消息中缺失的分号。用户可能会觉得这条异常消息读起来不太顺畅。[#23208](https://github.com/ClickHouse/ClickHouse/pull/23208) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复了某些与 `LowCardinality` 类型相关的异常消息中缺失空格的问题。 [#23207](https://github.com/ClickHouse/ClickHouse/pull/23207) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 之前在 `Markdown` 格式的表格单元格中，有些值会被居中对齐显示。现在不再这样。[#23096](https://github.com/ClickHouse/ClickHouse/pull/23096) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 在 `clickhouse-client` 的建议中移除非关键细节。此更改关闭了 [#22158](https://github.com/ClickHouse/ClickHouse/issues/22158)。[#23040](https://github.com/ClickHouse/ClickHouse/pull/23040)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修正了 `system.dictionaries` 中稀疏哈希（`sparse_hashed`）字典的 `bytes_allocated` 字段的计算。[#22867](https://github.com/ClickHouse/ClickHouse/pull/22867) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在从 MergeTree 反向读取时对近似总行数的统计方式。 [#22726](https://github.com/ClickHouse/ClickHouse/pull/22726) ([Azat Khuzhin](https://github.com/azat)).
* 修复了这样一种情况：可以将字典配置为使用指向 ClickHouse 自身的 `clickhouse` 源，从而导致无限循环。修复了 [#14314](https://github.com/ClickHouse/ClickHouse/issues/14314)。[#22479](https://github.com/ClickHouse/ClickHouse/pull/22479)（[Maksim Kita](https://github.com/kitaisreal)）。

#### 错误修复 {#bug-fix-5}


* 针对对冲请求进行了多项修复。修复了在启用 `use_hedged_requests` 设置时，包含 `GLOBAL IN/JOIN` 的查询出现 `Can't initialize pipeline with empty pipe` 错误的问题。修复了 [#23431](https://github.com/ClickHouse/ClickHouse/issues/23431)。[#23805](https://github.com/ClickHouse/ClickHouse/pull/23805)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。修复了对冲连接中的竞态条件，该问题会导致崩溃。此修复对应 [#22161](https://github.com/ClickHouse/ClickHouse/issues/22161)。[#22443](https://github.com/ClickHouse/ClickHouse/pull/22443)（[Kruglov Pavel](https://github.com/Avogar)）。修复了在启用 `async_socket_for_remote` 时，从远程查询接收到 `unknown packet` 时可能发生的崩溃。修复了 [#21167](https://github.com/ClickHouse/ClickHouse/issues/21167)。[#23309](https://github.com/ClickHouse/ClickHouse/pull/23309)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在禁用 `input_format_with_names_use_header` 设置时导致丢弃所有 CSVWithNames 格式输入数据的行为。此更改修复了 [#22406](https://github.com/ClickHouse/ClickHouse/issues/22406)。[#23202](https://github.com/ClickHouse/ClickHouse/pull/23202)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 修复了远程 JDBC bridge 连接超时问题。修复了 [#9609](https://github.com/ClickHouse/ClickHouse/issues/9609)。[#23771](https://github.com/ClickHouse/ClickHouse/pull/23771)（[Maksim Kita](https://github.com/kitaisreal)、[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在指定 `update_field` 时修复 `complex_key_hashed` 的初始加载逻辑。关闭 [#23800](https://github.com/ClickHouse/ClickHouse/issues/23800)。[#23824](https://github.com/ClickHouse/ClickHouse/pull/23824)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复了在 `PREWHERE` 和行策略过滤器同时生效且结果为空时的崩溃问题。[#23763](https://github.com/ClickHouse/ClickHouse/pull/23763) ([Amos Bird](https://github.com/amosbird))。
* 在向 Distributed 表执行 INSERT 时，如果之前发生过某些异常，避免可能出现 “Cannot schedule a task” 错误。 [#23744](https://github.com/ClickHouse/ClickHouse/pull/23744) ([Azat Khuzhin](https://github.com/azat)).
* 在聚合函数 `mannWhitneyUTest` 中，当两个样本的值完全相同时，新增抛出异常。这修复了 [#23646](https://github.com/ClickHouse/ClickHouse/issues/23646)。[#23654](https://github.com/ClickHouse/ClickHouse/pull/23654)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 修复了通过 HTTP 插入数据时因异常导致的服务器崩溃问题。此修复解决了 [#23512](https://github.com/ClickHouse/ClickHouse/issues/23512)。[#23643](https://github.com/ClickHouse/ClickHouse/pull/23643)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 修复了对某些带有转义序列的 `LIKE` 表达式的错误理解。[#23610](https://github.com/ClickHouse/ClickHouse/pull/23610) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复了 `restart` / `stop` 命令会挂起的问题。修复关闭了 [#20214](https://github.com/ClickHouse/ClickHouse/issues/20214)。[#23552](https://github.com/ClickHouse/ClickHouse/pull/23552)（[filimonov](https://github.com/filimonov)）。
* 修复了在包含多个 `JOIN` 的 `SELECT` 查询中使用时的 `COLUMNS` 匹配器问题。关闭 [#22736](https://github.com/ClickHouse/ClickHouse/issues/22736)。[#23501](https://github.com/ClickHouse/ClickHouse/pull/23501)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复了在将某列本身用作 `ReplacingMergeTree` 参数时，修改该列默认值会导致崩溃的问题。[#23483](https://github.com/ClickHouse/ClickHouse/pull/23483) ([hexiaoting](https://github.com/hexiaoting))。
* 修复了在使用 `ReplacingMergeTree` 进行垂直合并时的一些边界情况。在少数场景下，这些问题可能导致合并失败，并抛出类似 `Incomplete granules are not allowed while blocks are granules size` 的异常。 [#23459](https://github.com/ClickHouse/ClickHouse/pull/23459) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了一个错误，该错误导致无法将空数组字面量转换为维度大于 1 的数组，例如 `CAST([] AS Array(Array(String)))`。修复 [#14476](https://github.com/ClickHouse/ClickHouse/issues/14476)。[#23456](https://github.com/ClickHouse/ClickHouse/pull/23456)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复了在重置计数器后 `deltaSum` 聚合函数产生错误结果的问题。 [#23437](https://github.com/ClickHouse/ClickHouse/pull/23437) ([Russ Frank](https://github.com/rf))。
* 修复了在使用多磁盘配置创建 `ReplicatedMergeTree` 表失败时出现的 `Cannot unlink file` 错误。修复了对应问题 [#21755](https://github.com/ClickHouse/ClickHouse/issues/21755)。[#23433](https://github.com/ClickHouse/ClickHouse/pull/23433)（[tavplubix](https://github.com/tavplubix)）。
* 修复了在基于虚拟列进行分区裁剪时生成不兼容常量表达式的问题。此更改修复了 [https://github.com/ClickHouse/ClickHouse/pull/21401#discussion&#95;r611888913](https://github.com/ClickHouse/ClickHouse/pull/21401#discussion_r611888913)。[#23366](https://github.com/ClickHouse/ClickHouse/pull/23366)（[Amos Bird](https://github.com/amosbird)）。
* 修复了在将 join&#95;algorithm 设置为 &#39;auto&#39; 并使用 Dictionary 执行 Join 时发生的崩溃问题。关闭 [#23002](https://github.com/ClickHouse/ClickHouse/issues/23002)。[#23312](https://github.com/ClickHouse/ClickHouse/pull/23312) ([Vladimir](https://github.com/vdimir))。
* 在分区剪枝期间不要放宽 `NOT` 条件。此更改修复了 [#23305](https://github.com/ClickHouse/ClickHouse/issues/23305) 和 [#21539](https://github.com/ClickHouse/ClickHouse/issues/21539)。[#23310](https://github.com/ClickHouse/ClickHouse/pull/23310)（[Amos Bird](https://github.com/amosbird)）。
* 修复了在后台清理旧数据块时极少发生的竞争条件。如果数据块恰好非常接近去重窗口的末尾，该问题可能会导致该数据块未被去重。 [#23301](https://github.com/ClickHouse/ClickHouse/pull/23301) ([tavplubix](https://github.com/tavplubix)).
* 修复了在创建和删除 `ReplicatedMergeTree` 表之间极其罕见的（分布式）竞争条件。该问题可能在尝试创建复制表时导致类似 `node doesn't exist` 的异常。修复了 [#21419](https://github.com/ClickHouse/ClickHouse/issues/21419)。[#23294](https://github.com/ClickHouse/ClickHouse/pull/23294)（[tavplubix](https://github.com/tavplubix)）。
* 修复了在通过 DDL 创建简单键字典时，当主键不是第一个属性时出现的问题。修复了 [#23236](https://github.com/ClickHouse/ClickHouse/issues/23236)。[#23262](https://github.com/ClickHouse/ClickHouse/pull/23262)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复了当表中存在大量长列名时通过 ODBC 读取数据的问题。修复 [#8853](https://github.com/ClickHouse/ClickHouse/issues/8853)。[#23215](https://github.com/ClickHouse/ClickHouse/pull/23215) ([Kseniia Sumarokova](https://github.com/kssenii)).
* MaterializeMySQL（实验性功能）：修复了在对键列加条件从 `MaterializeMySQL` 中查询时出现的 `Not found column` 错误。修复了 [#22432](https://github.com/ClickHouse/ClickHouse/issues/22432)。 [#23200](https://github.com/ClickHouse/ClickHouse/pull/23200)（[tavplubix](https://github.com/tavplubix)）。
* 修正子查询被优化为常量时的别名处理。修复 [#22924](https://github.com/ClickHouse/ClickHouse/issues/22924)。修复 [#10401](https://github.com/ClickHouse/ClickHouse/issues/10401)。[#23191](https://github.com/ClickHouse/ClickHouse/pull/23191)（[Maksim Kita](https://github.com/kitaisreal)）。
* 如果在默认 profile 中启用了 `data_type_default_nullable` 设置，服务器可能无法启动，此问题已修复。修复了 [#22573](https://github.com/ClickHouse/ClickHouse/issues/22573)。[#23185](https://github.com/ClickHouse/ClickHouse/pull/23185)（[tavplubix](https://github.com/tavplubix)）。
* 修复了由于当前连接计数错误导致的关闭时崩溃问题。[#23154](https://github.com/ClickHouse/ClickHouse/pull/23154) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复了将物化视图从 Atomic 数据库分离并重新附加后，在从该视图查询时出现的 `Table .inner_id... doesn't exist` 错误。[#23047](https://github.com/ClickHouse/ClickHouse/pull/23047) ([tavplubix](https://github.com/tavplubix))。
* 修复在子查询中使用 `untuple` 时可能出现的错误 `Cannot find column in ActionsDAG result`。修复了 [#22290](https://github.com/ClickHouse/ClickHouse/issues/22290)。[#22991](https://github.com/ClickHouse/ClickHouse/pull/22991)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复对含可空值的 `Map` 类型常量列的使用。[#22939](https://github.com/ClickHouse/ClickHouse/pull/22939) ([Anton Popov](https://github.com/CurtizJ))。
* 修复了 `DateTime64` 上 `formatDateTime()` 与 &quot;%C&quot; 格式说明符的问题，并修复了在大数值和非零小数位情况下的 `toDateTime64()`。 [#22937](https://github.com/ClickHouse/ClickHouse/pull/22937) ([Vasily Nemkov](https://github.com/Enmk))。
* 修复了在将 `mannWhitneyUTest` 和 `rankCorr` 与窗口函数一起使用时出现的崩溃问题。此更改修复了 [#22728](https://github.com/ClickHouse/ClickHouse/issues/22728)。[#22876](https://github.com/ClickHouse/ClickHouse/pull/22876)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* LIVE VIEW（实验性功能）：修复了在 `TemporaryLiveViewCleaner` 中并发执行 TEMPORARY LIVE VIEW 的 DROP/CREATE 操作时可能出现的卡死问题，[参见](https://gist.github.com/vzakaznikov/0c03195960fc86b56bfe2bc73a90019e)。[#22858](https://github.com/ClickHouse/ClickHouse/pull/22858)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复了在将包含过滤列的聚合下推到 `HAVING` 时的问题。 [#22763](https://github.com/ClickHouse/ClickHouse/pull/22763) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了在发生 OOM 异常时 Zookeeper 请求可能出现的卡死问题。修复了 [#22438](https://github.com/ClickHouse/ClickHouse/issues/22438)。[#22684](https://github.com/ClickHouse/ClickHouse/pull/22684)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了 `ReplicatedMergeTree` 表引擎在多个副本上等待变更的行为。之前，`mutation/alter` 查询可能会在变更实际在其他副本上执行之前就结束。[#22669](https://github.com/ClickHouse/ClickHouse/pull/22669) ([alesapin](https://github.com/alesapin))。
* 修复了在 `SELECT` 子句未包含列时，`Log` 表中嵌套类型引发异常的问题。[#22654](https://github.com/ClickHouse/ClickHouse/pull/22654) ([Azat Khuzhin](https://github.com/azat))。
* 修复辅助 AWS 请求无限期等待的问题。 [#22594](https://github.com/ClickHouse/ClickHouse/pull/22594) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 修复了客户端在连接建立初期就关闭时导致的崩溃 [#22579](https://github.com/ClickHouse/ClickHouse/issues/22579)。[#22591](https://github.com/ClickHouse/ClickHouse/pull/22591)（[nvartolomei](https://github.com/nvartolomei)）。
* `Map` 数据类型（实验性功能）：修复了分布式查询中 `map` 函数的错误格式化问题。[#22588](https://github.com/ClickHouse/ClickHouse/pull/22588) ([foolchi](https://github.com/foolchi)).
* 修复了在 `TSV` 格式末尾没有换行符时，对空字符串的反序列化问题。这解决了 [#20244](https://github.com/ClickHouse/ClickHouse/issues/20244)。在不升级版本的情况下，可以采用的变通办法是：将 `input_format_null_as_default` 设置为 0。在旧版本中该设置默认为 0。[#22527](https://github.com/ClickHouse/ClickHouse/pull/22527) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了 Merge Join 算法中对 `LowCardinality` 类型列的不正确类型转换。关闭 [#22386](https://github.com/ClickHouse/ClickHouse/issues/22386)，关闭 [#22388](https://github.com/ClickHouse/ClickHouse/issues/22388)。[#22510](https://github.com/ClickHouse/ClickHouse/pull/22510)（[Vladimir](https://github.com/vdimir)）。
* 在 `tokenbf_v1` 全文索引中，读取时可能发生缓冲区溢出。多余的字节不会被使用，但读取操作在极少数情况下可能导致崩溃。此更改关闭了 [#19233](https://github.com/ClickHouse/ClickHouse/issues/19233)。[#22421](https://github.com/ClickHouse/ClickHouse/pull/22421)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 取消对 HTTP 分块大小的限制。修复了 [#21907](https://github.com/ClickHouse/ClickHouse/issues/21907)。[#22322](https://github.com/ClickHouse/ClickHouse/pull/22322)（[Ivan](https://github.com/abyss7)）。
* 修复了一个在启用 `optimize_aggregation_in_order` 且表中存在大量数据分片时会导致聚合结果不完整的错误。略微提升了在启用 `optimize_aggregation_in_order` 时聚合的性能。[#21889](https://github.com/ClickHouse/ClickHouse/pull/21889) ([Anton Popov](https://github.com/CurtizJ)).
* 检查是否将表函数 `view` 作为列使用。补充了 #20350。[#21465](https://github.com/ClickHouse/ClickHouse/pull/21465) ([Amos Bird](https://github.com/amosbird))。
* 修复在包含 `JOIN` 和聚合的查询中，使用 `Merge` 引擎的表出现的 “unknown column” 错误。关闭 [#18368](https://github.com/ClickHouse/ClickHouse/issues/18368)，关闭 [#22226](https://github.com/ClickHouse/ClickHouse/issues/22226)。[#21370](https://github.com/ClickHouse/ClickHouse/pull/21370)（[Vladimir](https://github.com/vdimir)）。
* 修复了下推优化中的名称冲突问题，该问题会在执行 `FULL JOIN` 后导致错误的 `WHERE` 过滤。关闭 [#20497](https://github.com/ClickHouse/ClickHouse/issues/20497)。[#20622](https://github.com/ClickHouse/ClickHouse/pull/20622)（[Vladimir](https://github.com/vdimir)）。
* 修复了一个极为罕见的错误：在启用 `quorum_parallel=1` 时，由于去重机制导致 quorum 写入实际上并不是真正意义上的“quorum”。[#18215](https://github.com/ClickHouse/ClickHouse/pull/18215)（[filimonov](https://github.com/filimonov) - 报告，[alesapin](https://github.com/alesapin) - 修复）。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-6}

- 在 CI 中并行运行无状态测试。[#22300](https://github.com/ClickHouse/ClickHouse/pull/22300) ([alesapin](https://github.com/alesapin))。
- 简化 Debian 软件包。此更改修复了 [#21698](https://github.com/ClickHouse/ClickHouse/issues/21698)。[#22976](https://github.com/ClickHouse/ClickHouse/pull/22976) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 新增对 Apple M1 上构建 ClickHouse 的支持。[#21639](https://github.com/ClickHouse/ClickHouse/pull/21639) ([changvvb](https://github.com/changvvb))。
- 修复了 macOS 上 ClickHouse Keeper 的构建问题。[#22860](https://github.com/ClickHouse/ClickHouse/pull/22860) ([alesapin](https://github.com/alesapin))。
- 修复了 AArch64 平台上的部分测试。[#22596](https://github.com/ClickHouse/ClickHouse/pull/22596) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 新增函数对齐以提升性能。[#21431](https://github.com/ClickHouse/ClickHouse/pull/21431) ([Danila Kutenin](https://github.com/danlark1))。
- 调整部分测试以在 amd64 和 aarch64 (qemu) 上输出一致的结果。之前的结果依赖于特定实现的 CPU 行为。[#22590](https://github.com/ClickHouse/ClickHouse/pull/22590) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 仅允许在 x86_64 上进行查询性能分析。参见 [#15174](https://github.com/ClickHouse/ClickHouse/issues/15174#issuecomment-812954965) 和 [#15638](https://github.com/ClickHouse/ClickHouse/issues/15638#issuecomment-703805337)。此更改关闭了 [#15638](https://github.com/ClickHouse/ClickHouse/issues/15638)。[#22580](https://github.com/ClickHouse/ClickHouse/pull/22580) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 允许使用 `USE_INTERNAL_XZ_LIBRARY=OFF` CMake 选项以非捆绑的 xz (lzma) 进行构建。[#22571](https://github.com/ClickHouse/ClickHouse/pull/22571) ([Kfir Itzhak](https://github.com/mastertheknife))。
- 在 `ppc64le` 上启用捆绑的 `openldap` [#22487](https://github.com/ClickHouse/ClickHouse/pull/22487) ([Kfir Itzhak](https://github.com/mastertheknife))。
- 在 `ppc64le` 上禁用不兼容的库(通常为平台特定库) [#22475](https://github.com/ClickHouse/ClickHouse/pull/22475) ([Kfir Itzhak](https://github.com/mastertheknife))。
- 在 CI 中为 ClickHouse Keeper 新增 Jepsen 测试。[#22373](https://github.com/ClickHouse/ClickHouse/pull/22373) ([alesapin](https://github.com/alesapin))。
- 构建支持[堆性能分析](https://github.com/jemalloc/jemalloc/wiki/Use-Case%3A-Heap-Profiling)的 `jemalloc`。[#22834](https://github.com/ClickHouse/ClickHouse/pull/22834) ([nvartolomei](https://github.com/nvartolomei))。
- 避免 `*Log` 引擎中因从其他线程解锁 rwlock 而导致的未定义行为。[#22583](https://github.com/ClickHouse/ClickHouse/pull/22583) ([Azat Khuzhin](https://github.com/azat))。
- 通过从同一线程解锁 TinyLog 的 rwlock 修复了未定义行为。[#22560](https://github.com/ClickHouse/ClickHouse/pull/22560) ([Azat Khuzhin](https://github.com/azat))。


## ClickHouse 版本 21.4 {#clickhouse-release-214}

### ClickHouse 版本 21.4.1 2021-04-12 {#clickhouse-release-2141-2021-04-12}

#### 向后不兼容变更 {#backward-incompatible-change-7}

- `toStartOfIntervalFunction` 函数现在会将小时间隔对齐到午夜(在之前的版本中对齐到 Unix 纪元的起始时间)。例如,`toStartOfInterval(x, INTERVAL 11 HOUR)` 会将每天分为三个间隔:`00:00:00..10:59:59`、`11:00:00..21:59:59` 和 `22:00:00..23:59:59`。这种行为更符合实际需求。此变更解决了 [#9510](https://github.com/ClickHouse/ClickHouse/issues/9510)。[#22060](https://github.com/ClickHouse/ClickHouse/pull/22060) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- graphite rollup 配置中的 `Age` 和 `Precision` 应该在各个保留期之间递增。现在会对此进行检查,错误的配置会抛出异常。[#21496](https://github.com/ClickHouse/ClickHouse/pull/21496) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- 修复了 `cutToFirstSignificantSubdomainCustom()`/`firstSignificantSubdomainCustom()` 对自定义顶级域名列表中存在的 3 级及以上域名返回错误结果的问题。对于匹配这些自定义顶级域名的输入域名,三级域名被错误地认为是第一个有效域名。此问题现已修复。如果该函数用于分片键等场景,此变更可能会引入不兼容性。[#21946](https://github.com/ClickHouse/ClickHouse/pull/21946) ([Azat Khuzhin](https://github.com/azat))。
- `system.dictionaries` 表中的 `keys` 列已替换为 `key.names` 和 `key.types` 列。`system.dictionaries` 表中的 `key.names`、`key.types`、`attribute.names`、`attribute.types` 列不再要求字典必须已加载。[#21884](https://github.com/ClickHouse/ClickHouse/pull/21884) ([Maksim Kita](https://github.com/kitaisreal))。
- 现在处理 `ALTER TABLE ATTACH PART[ITION]` 命令的副本会先在其 `detached/` 文件夹中搜索,然后再从其他副本获取数据。作为实现细节,在复制日志中引入了新命令 `ATTACH_PART`。数据分片通过其校验和进行搜索和比较。[#18978](https://github.com/ClickHouse/ClickHouse/pull/18978) ([Mike Kot](https://github.com/myrrc))。**注意**:
  - 在集群升级期间,`ATTACH PART[ITION]` 查询可能无法正常工作。
  - 在新版本中执行 `ALTER ... ATTACH` 查询后,无法回滚到旧版本的 ClickHouse,因为旧服务器无法处理复制日志中的 `ATTACH_PART` 条目。
- 在此版本中,空的 `<remote_url_allow_hosts></remote_url_allow_hosts>` 将阻止所有对远程主机的访问,而在之前的版本中它不起作用。如果您想保持旧的行为,并且配置文件中有空的 `remote_url_allow_hosts` 元素,请将其删除。[#20058](https://github.com/ClickHouse/ClickHouse/pull/20058) ([Vladimir Chebotarev](https://github.com/excitoon))。

#### 新功能 {#new-feature-7}


* 将 `DateTime64` 的范围扩展为支持从 1925 年到 2283 年的日期。改进了在零日期（`1970-01-01`）附近对 `DateTime` 的支持。[#9404](https://github.com/ClickHouse/ClickHouse/pull/9404)（[alexey-milovidov](https://github.com/alexey-milovidov)，[Vasily Nemkov](https://github.com/Enmk)）。并非所有日期和时间函数都适用于扩展后的日期范围。
* 为预配置用户和 HTTP 请求（GSS-SPNEGO）增加了 Kerberos 身份验证支持。 [#14995](https://github.com/ClickHouse/ClickHouse/pull/14995) ([Denis Glazachev](https://github.com/traceon)).
* 添加 `prefer_column_name_to_alias` 设置，以使用原始列名而非别名，以便与常见数据库的别名规则更加兼容。对应 [#9715](https://github.com/ClickHouse/ClickHouse/issues/9715) 和 [#9887](https://github.com/ClickHouse/ClickHouse/issues/9887)。[#22044](https://github.com/ClickHouse/ClickHouse/pull/22044)（[Amos Bird](https://github.com/amosbird)）。
* 新增函数 `dictGetChildren(dictionary, key)` 和 `dictGetDescendants(dictionary, key, level)`。函数 `dictGetChildren` 返回所有子节点的索引数组，是 `dictGetHierarchy` 的逆变换。函数 `dictGetDescendants` 返回在递归应用 `dictGetChildren` `level` 次后得到的所有后代节点。`level` 值为 0 等价于无限。修复 [#14656](https://github.com/ClickHouse/ClickHouse/issues/14656)。[#22096](https://github.com/ClickHouse/ClickHouse/pull/22096)（[Maksim Kita](https://github.com/kitaisreal)）。
* 新增 `executable_pool` 字典源。关闭 [#14528](https://github.com/ClickHouse/ClickHouse/issues/14528)。[#21321](https://github.com/ClickHouse/ClickHouse/pull/21321)（[Maksim Kita](https://github.com/kitaisreal)）。
* 新增了表函数 `dictionary`，其工作方式与 `Dictionary` 引擎相同。修复了 [#21560](https://github.com/ClickHouse/ClickHouse/issues/21560)。[#21910](https://github.com/ClickHouse/ClickHouse/pull/21910)（[Maksim Kita](https://github.com/kitaisreal)）。
* 为 `PolygonDictionary` 属性添加对 `Nullable` 类型的支持。 [#21890](https://github.com/ClickHouse/ClickHouse/pull/21890) ([Maksim Kita](https://github.com/kitaisreal)).
* 函数 `dictGet`、`dictHas` 对于通过 DDL 创建的字典，如果未显式指定数据库名，将使用当前数据库名。修复了 [#21632](https://github.com/ClickHouse/ClickHouse/issues/21632)。[#21859](https://github.com/ClickHouse/ClickHouse/pull/21859)（[Maksim Kita](https://github.com/kitaisreal)）。
* 新增函数 `dictGetOrNull`。其工作方式与 `dictGet` 相同，但在字典中找不到键时会返回 `Null`。关闭 [#22375](https://github.com/ClickHouse/ClickHouse/issues/22375)。[#22413](https://github.com/ClickHouse/ClickHouse/pull/22413)（[Maksim Kita](https://github.com/kitaisreal)）。
* 在 `ComplexKeyCache`、`SSDCache`、`SSDComplexKeyCache` 字典中新增了异步更新功能。在 `Cache`、`ComplexKeyCache`、`SSDCache`、`SSDComplexKeyCache` 字典中新增了对 `Nullable` 类型的支持。为 `dictGet`、`dictGetOrDefault` 函数新增了多属性获取功能。修复了 [#21517](https://github.com/ClickHouse/ClickHouse/issues/21517)。[#20595](https://github.com/ClickHouse/ClickHouse/pull/20595)（[Maksim Kita](https://github.com/kitaisreal)）。
* 为 `RangeHashedDictionary` 添加对 `dictHas` 函数的支持。修复 [#6680](https://github.com/ClickHouse/ClickHouse/issues/6680)。[#19816](https://github.com/ClickHouse/ClickHouse/pull/19816)（[Maksim Kita](https://github.com/kitaisreal)）。
* 添加函数 `timezoneOf`，用于返回 `DateTime` 或 `DateTime64` 数据类型的时区名称。此更改并未解决 [#9959](https://github.com/ClickHouse/ClickHouse/issues/9959)。修复函数命名中的不一致问题：添加别名 `timezone` 和 `timeZone`，`toTimezone` 和 `toTimeZone`，以及 `timezoneOf` 和 `timeZoneOf`。 [#22001](https://github.com/ClickHouse/ClickHouse/pull/22001) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 为 `CREATE/ALTER USER` 命令新增可选子句 `GRANTEES`。它用于指定哪些用户或角色被允许从该用户处接收授权，前提是该用户本身也已通过带有 GRANT 选项的方式获得所有所需的访问权限。默认情况下使用 `GRANTEES ANY`，这意味着拥有 GRANT 选项的用户可以向任意对象授予权限。语法：`CREATE USER ... GRANTEES {user | role | ANY | NONE} [,...] [EXCEPT {user | role} [,...]]`。[#21641](https://github.com/ClickHouse/ClickHouse/pull/21641)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 向 `system.clusters` 添加新列 `slowdowns_count`。在使用对冲请求时，它表示由于某个副本响应过慢而切换到其他副本的次数。同时在 `system.clusters` 中显示 `errors_count` 的实际值。[#21480](https://github.com/ClickHouse/ClickHouse/pull/21480) ([Kruglov Pavel](https://github.com/Avogar))。
* 为 `MergeTree*` 引擎添加 `_partition_id` 虚拟列，支持通过 `_partition_id` 剔除分区。添加用于计算分区 ID 字符串的 `partitionID()` 函数。 [#21401](https://github.com/ClickHouse/ClickHouse/pull/21401) ([Amos Bird](https://github.com/amosbird)).
* 添加函数 `isIPAddressInRange`，用于测试某个 IPv4 或 IPv6 地址是否位于给定的 CIDR 网络前缀范围内。[#21329](https://github.com/ClickHouse/ClickHouse/pull/21329) ([PHO](https://github.com/depressed-pho))。
* 添加了新的 SQL 命令 `ALTER TABLE 'table_name' UNFREEZE [PARTITION 'part_expr'] WITH NAME 'backup_name'`。该命令用于从所有磁盘中正确删除已「冻结」的分区。 [#21142](https://github.com/ClickHouse/ClickHouse/pull/21142) ([Pavel Kovalenko](https://github.com/Jokser))。
* 为 `JOIN` 提供对键类型的隐式转换支持。 [#19885](https://github.com/ClickHouse/ClickHouse/pull/19885) ([Vladimir](https://github.com/vdimir)).

#### 实验性功能 {#experimental-feature-6}

- 支持浮点类型的 `RANGE OFFSET` 帧(用于窗口函数)。实现了 `lagInFrame`/`leadInFrame` 窗口函数,它们类似于 `lag`/`lead`,但会遵循窗口帧的定义。当帧为 `between unbounded preceding and unbounded following` 时,两者行为相同。此更改解决了 [#5485](https://github.com/ClickHouse/ClickHouse/issues/5485)。[#21895](https://github.com/ClickHouse/ClickHouse/pull/21895) ([Alexander Kuzmenkov](https://github.com/akuzm))。
- 为基于 S3 存储的 `ReplicatedMergeTree` 提供零拷贝复制功能。[#16240](https://github.com/ClickHouse/ClickHouse/pull/16240) ([ianton-ru](https://github.com/ianton-ru))。
- 新增将现有 S3 磁盘迁移到支持备份恢复功能的模式的能力。[#22070](https://github.com/ClickHouse/ClickHouse/pull/22070) ([Pavel Kovalenko](https://github.com/Jokser))。

#### 性能改进 {#performance-improvement-7}

- 在 `clickhouse-local` 及其他所有场景中支持并行格式化。[#21630](https://github.com/ClickHouse/ClickHouse/pull/21630) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 支持 `CSVWithNames` 和 `TSVWithNames` 格式的并行解析。此更改解决了 [#21085](https://github.com/ClickHouse/ClickHouse/issues/21085)。[#21149](https://github.com/ClickHouse/ClickHouse/pull/21149) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 为 64 MiB 及以上的文件范围启用 mmap IO 读取(通过设置 `min_bytes_to_use_mmap_io`)。这可能带来适度的性能提升。[#22326](https://github.com/ClickHouse/ClickHouse/pull/22326) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 为使用 `min_bytes_to_use_mmap_io` 设置读取的文件添加缓存。当设置值较小时,通过避免频繁的 mmap/munmap 调用及其导致的页面错误,可实现显著的性能提升(2 倍或更高)。需要注意的是,mmap IO 存在重大缺陷,使其在生产环境中可靠性较低(例如,在故障磁盘上可能挂起或触发 SIGBUS;内存使用难以控制)。尽管如此,它在基准测试中表现良好。[#22206](https://github.com/ClickHouse/ClickHouse/pull/22206) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 使用 `NONE` 编解码器时避免不必要的数据复制。请注意,`NONE` 编解码器在大多数情况下并无实际用途 - 建议始终使用压缩(默认为 `LZ4`)。与普遍认知相反,禁用压缩可能不会提升性能(甚至可能产生相反效果)。`NONE` 编解码器在以下情况下有用:- 数据不可压缩时;- 用于合成基准测试。[#22145](https://github.com/ClickHouse/ClickHouse/pull/22145) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 在 `max_rows_to_group_by` 较小且 `group_by_overflow_mode='any'` 时,`GROUP BY` 性能更快。[#21856](https://github.com/ClickHouse/ClickHouse/pull/21856) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 优化类似 `SELECT ... FINAL ... WHERE` 的查询性能。现在在使用 `FINAL` 的查询中,允许将排序键中的列移至 `PREWHERE`。[#21830](https://github.com/ClickHouse/ClickHouse/pull/21830) ([foolchi](https://github.com/foolchi))。
- 通过替换 `memcpy` 实现来提升性能。此更改解决了 [#18583](https://github.com/ClickHouse/ClickHouse/issues/18583)。[#21520](https://github.com/ClickHouse/ClickHouse/pull/21520) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 改进按排序键顺序进行聚合的性能(启用 `optimize_aggregation_in_order` 设置时)。[#19401](https://github.com/ClickHouse/ClickHouse/pull/19401) ([Anton Popov](https://github.com/CurtizJ))。

#### 改进 {#improvement-7}


* 为 PostgreSQL 表/数据库引擎和字典源添加连接池。修复 [#21444](https://github.com/ClickHouse/ClickHouse/issues/21444)。[#21839](https://github.com/ClickHouse/ClickHouse/pull/21839)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 为 `postgres` 存储/表函数提供对非默认表模式的支持。关闭 [#21701](https://github.com/ClickHouse/ClickHouse/issues/21701)。[#21711](https://github.com/ClickHouse/ClickHouse/pull/21711)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 为 `postgres` 字典源添加对副本优先级的支持。[#21710](https://github.com/ClickHouse/ClickHouse/pull/21710) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 引入了一个新的 MergeTree 设置 `min_bytes_to_rebalance_partition_over_jbod`，用于在 JBOD 卷的不同磁盘之间以均衡的方式分配新的数据片段（part）。 [#16481](https://github.com/ClickHouse/ClickHouse/pull/16481) ([Amos Bird](https://github.com/amosbird))。
* 为 `system.query_log` 中相应的查询在 `query_kind` 列中添加了 `Grant`、`Revoke` 和 `System` 值。[#21102](https://github.com/ClickHouse/ClickHouse/pull/21102) ([Vasily Nemkov](https://github.com/Enmk))。
* 允许将用于复制的 HTTP 连接超时时间与其他 HTTP 超时时间分开单独配置。 [#20088](https://github.com/ClickHouse/ClickHouse/pull/20088) ([nvartolomei](https://github.com/nvartolomei)).
* 在服务器写入数据块时发生异常的情况下，为客户端提供更清晰的异常信息。在之前的版本中，客户端可能会收到具有误导性的信息，例如 `Data compressed with different methods`。[#22427](https://github.com/ClickHouse/ClickHouse/pull/22427) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复在拉取分片失败后可能出现的错误 `Directory tmp_fetch_XXX already exists`：如果临时拉取目录已存在，则将其删除。修复了 [#14197](https://github.com/ClickHouse/ClickHouse/issues/14197)。[#22411](https://github.com/ClickHouse/ClickHouse/pull/22411)（[nvartolomei](https://github.com/nvartolomei)）。
* 修复了针对带有 `UInt256` 参数的 `range` 函数的 MSan 报告（对大整数的支持仍为实验性功能）。此更改关闭了 [#22157](https://github.com/ClickHouse/ClickHouse/issues/22157)。[#22387](https://github.com/ClickHouse/ClickHouse/pull/22387)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 向 `system.processes` 表中添加 `current_database` 列。该列包含查询当前使用的数据库。[#22365](https://github.com/ClickHouse/ClickHouse/pull/22365) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* 为 `clickhouse-client` 添加不区分大小写的历史记录搜索/导航和子单词移动功能。 [#22105](https://github.com/ClickHouse/ClickHouse/pull/22105) ([Amos Bird](https://github.com/amosbird)).
* 如果由 `NULL` 组成的 `tuple`，例如 `(NULL, NULL)`，位于 `IN` 运算符左侧，而右侧是由非 `NULL` 值组成的 `tuple`，例如 `SELECT (NULL, NULL) IN ((0, 0), (3, 1))`，现在会返回 0，而不是抛出类型不兼容的异常。该表达式也可能由于对类似如下语句进行优化而出现：`SELECT (NULL, NULL) = (8, 0) OR (NULL, NULL) = (3, 2) OR (NULL, NULL) = (0, 0) OR (NULL, NULL) = (3, 1)`。此更改关闭了 [#22017](https://github.com/ClickHouse/ClickHouse/issues/22017)。[#22063](https://github.com/ClickHouse/ClickHouse/pull/22063)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 将使用的 simdjson 版本更新为 0.9.1，修复了 [#21984](https://github.com/ClickHouse/ClickHouse/issues/21984)。[#22057](https://github.com/ClickHouse/ClickHouse/pull/22057)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 为 `CONNECTION_ID()` 和 `VERSION()` 函数添加了不区分大小写的别名。修复了 [#22028](https://github.com/ClickHouse/ClickHouse/issues/22028)。[#22042](https://github.com/ClickHouse/ClickHouse/pull/22042)（[Eugene Klimov](https://github.com/Slach)）。
* 为 `windowFunnel` 函数添加 `strict_increase` 选项，以确保每个事件只被计算一次（解决 [#21835](https://github.com/ClickHouse/ClickHouse/issues/21835)）。[#22025](https://github.com/ClickHouse/ClickHouse/pull/22025)（[Vladimir](https://github.com/vdimir)）。
* 如果 `MergeTree` 表的分区键不包含 `Date` 或 `DateTime` 列，但恰好包含一列 `DateTime64` 列，则在 `system.parts` 和 `system.parts_columns` 表的 `min_time` 与 `max_time` 列中展示其值。向 `system.parts_columns` 表添加 `min_time` 和 `max_time` 列（之前与 `system.parts` 表不一致）。修复了 [#18244](https://github.com/ClickHouse/ClickHouse/issues/18244)。[#22011](https://github.com/ClickHouse/ClickHouse/pull/22011)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 `clickhouse-copier` 中支持设置 `replication_alter_partitions_sync=1`，用于将分区从辅助表移动到目标表。缩短了默认超时时间。修复了 [#21911](https://github.com/ClickHouse/ClickHouse/issues/21911)。[#21912](https://github.com/ClickHouse/ClickHouse/pull/21912)（[turbo jason](https://github.com/songenjie)）。
* 在 system 表中显示 `EmbeddedRocksDB` 表的数据目录路径。 [#21903](https://github.com/ClickHouse/ClickHouse/pull/21903) ([tavplubix](https://github.com/tavplubix))。
* 添加 profile 事件 `HedgedRequestsChangeReplica`，将读取数据的超时时间从秒调整为毫秒。 [#21886](https://github.com/ClickHouse/ClickHouse/pull/21886) ([Kruglov Pavel](https://github.com/Avogar)).
* DiskS3（开发中的实验性功能）。修复了在目标目录非空且使用缓存磁盘时无法移动目录的错误。[#21837](https://github.com/ClickHouse/ClickHouse/pull/21837) ([Pavel Kovalenko](https://github.com/Jokser)).
* 在 Web UI 中改进了对 `Array` 和 `Map` 数据类型的格式化。 [#21798](https://github.com/ClickHouse/ClickHouse/pull/21798) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 仅在配置发生更改时才更新集群。[#21685](https://github.com/ClickHouse/ClickHouse/pull/21685) ([Kruglov Pavel](https://github.com/Avogar)).
* 为分布式 DDL 查询传递查询和会话设置。将 `distributed_ddl_entry_format_version` 设置为 2 以启用该功能。新增 `distributed_ddl_output_mode` 设置。支持的模式：`none`、`throw`（默认）、`null_status_on_timeout` 和 `never_throw`。对 `Replicated` 数据库引擎进行了若干修复和改进。[#21535](https://github.com/ClickHouse/ClickHouse/pull/21535) ([tavplubix](https://github.com/tavplubix))。
* 如果使用的元素大小既不是 16 的倍数也不是 16 的因数来实例化 `PODArray`，则可能发生缓冲区溢出。目前发布的版本中不存在相关 bug。 [#21533](https://github.com/ClickHouse/ClickHouse/pull/21533) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 为 `system.errors` 表添加 `last_error_time` / `last_error_message` / `last_error_stacktrace` / `remote` 列。[#21529](https://github.com/ClickHouse/ClickHouse/pull/21529) ([Azat Khuzhin](https://github.com/azat))。
* 为 `visitParam/visitParamExtract{UInt, Int, Bool, Float, Raw, String}` 添加别名 `simpleJSONExtract/simpleJSONHas`。修复 #21383。[#21519](https://github.com/ClickHouse/ClickHouse/pull/21519) ([fastio](https://github.com/fastio))。
* 添加 `optimize_skip_unused_shards_limit` 设置，用于限制 `optimize_skip_unused_shards` 可使用的分片键值数量。 [#21512](https://github.com/ClickHouse/ClickHouse/pull/21512) ([Azat Khuzhin](https://github.com/azat)).
* 改进 `clickhouse-format`，使其在最后一个查询后存在多余空格或注释时不抛出异常，并在对包含数据的 `ASTInsertQuery` 进行格式化时尽早抛出带有清晰错误信息的异常。 [#21311](https://github.com/ClickHouse/ClickHouse/pull/21311) ([flynn](https://github.com/ucasFL)).
* 改进对数据类型 `Map` 中整数键的支持。[#21157](https://github.com/ClickHouse/ClickHouse/pull/21157) ([Anton Popov](https://github.com/CurtizJ))。
* MaterializeMySQL：在连接丢失时尝试重新连接到 MySQL。 [#20961](https://github.com/ClickHouse/ClickHouse/pull/20961) ([Håvard Kvålen](https://github.com/havardk)).
* 在更多场景下支持将 `CROSS JOIN` 重写为 `INNER JOIN`。[#20392](https://github.com/ClickHouse/ClickHouse/pull/20392) ([Vladimir](https://github.com/vdimir)).
* 启用 `optimize_on_insert` 设置时，避免在执行 INSERT 时创建空 part。修复 [#20304](https://github.com/ClickHouse/ClickHouse/issues/20304)。[#20387](https://github.com/ClickHouse/ClickHouse/pull/20387)（[Kruglov Pavel](https://github.com/Avogar)）。
* `MaterializeMySQL`：为 `_version` 列添加 minmax 跳跃索引。[#20382](https://github.com/ClickHouse/ClickHouse/pull/20382)（[Stig Bakken](https://github.com/stigsb)）。
* 为 `clickhouse-format` 新增 `--backslash` 选项，可在格式化后的查询中为每一行行尾添加反斜杠。 [#21494](https://github.com/ClickHouse/ClickHouse/pull/21494) ([flynn](https://github.com/ucasFL)).
* 现在，在尝试对已包含的部分进行变更（mutation）时，ClickHouse 将不再抛出 `LOGICAL_ERROR` 异常。修复了 [#22013](https://github.com/ClickHouse/ClickHouse/issues/22013)。[#22291](https://github.com/ClickHouse/ClickHouse/pull/22291)（[alesapin](https://github.com/alesapin)）。

#### 错误修复 {#bug-fix-6}


* 在 `HedgedConnections` 中，在取消数据包接收器之前先将 socket 从 epoll 中移除，以防止可能的竞争条件。修复了 [#22161](https://github.com/ClickHouse/ClickHouse/issues/22161)。[#22443](https://github.com/ClickHouse/ClickHouse/pull/22443)（[Kruglov Pavel](https://github.com/Avogar)）。
* 在并行解析流程中补充缺失的内存计量。在先前版本中，当结果集包含非常大的数据块时，可能会发生 OOM。此更改关闭了 [#22008](https://github.com/ClickHouse/ClickHouse/issues/22008)。[#22425](https://github.com/ClickHouse/ClickHouse/pull/22425)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在 `SELECT` 语句的 `WHERE` 条件为常量且源表包含列名为数字时可能出现的异常。[#22270](https://github.com/ClickHouse/ClickHouse/pull/22270) ([LiuNeng](https://github.com/liuneng1994)).
* 修复在 `use_hedged_requests=0` 且 `async_socket_for_remote=1` 时的查询取消问题。[#22183](https://github.com/ClickHouse/ClickHouse/pull/22183) ([Azat Khuzhin](https://github.com/azat)).
* 修复 `InterserverIOHTTPHandler` 中未捕获的异常。[#22146](https://github.com/ClickHouse/ClickHouse/pull/22146) ([Azat Khuzhin](https://github.com/azat))。
* 在配置中未指定 `http_port` 时修复 Docker 入口点（entrypoint）。[#22132](https://github.com/ClickHouse/ClickHouse/pull/22132) ([Ewout](https://github.com/devwout))。
* 修复在包含 `TOTALS` 和 `arrayJoin` 的 `JOIN` 中出现的错误 `Invalid number of rows in Chunk`。关闭 [#19303](https://github.com/ClickHouse/ClickHouse/issues/19303)。[#22129](https://github.com/ClickHouse/ClickHouse/pull/22129)（[Vladimir](https://github.com/vdimir)）。
* 修复用于从 Kafka 轮询消息的后台线程池名称。使用该损坏线程池的 Kafka 引擎将不会从消息队列中消费消息。[#22122](https://github.com/ClickHouse/ClickHouse/pull/22122) ([fastio](https://github.com/fastio))。
* 修复了在 `ReplicatedMergeTree` 表引擎上等待 `OPTIMIZE` 和 `ALTER` 查询时的问题。现在当表被分离或重启时，查询不会再卡住。[#22118](https://github.com/ClickHouse/ClickHouse/pull/22118) ([alesapin](https://github.com/alesapin))。
* 在存在缺陷的 Linux 内核上禁用 `async_socket_for_remote`/`use_hedged_requests`。[#22109](https://github.com/ClickHouse/ClickHouse/pull/22109) ([Azat Khuzhin](https://github.com/azat))。
* Docker entrypoint：在 `LOG_PATH` 为空时避免对 `.` 执行 chown。修复 [#22100](https://github.com/ClickHouse/ClickHouse/issues/22100)。[#22102](https://github.com/ClickHouse/ClickHouse/pull/22102)（[filimonov](https://github.com/filimonov)）。
* 函数 `decrypt` 此前缺少对 `AEAD` 模式下加密数据最小大小的检查。此更改修复了 [#21897](https://github.com/ClickHouse/ClickHouse/issues/21897)。[#22064](https://github.com/ClickHouse/ClickHouse/pull/22064)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在极少数情况下，`CollapsingMergeTree` 的合并可能会生成包含 `index_granularity + 1` 行的 granule。由于这一点，在 [#18928](https://github.com/ClickHouse/ClickHouse/issues/18928) 中添加的内部检查（影响 21.2 和 21.3 版本）可能会因报错 `Incomplete granules are not allowed while blocks are granules size` 而失败。该错误会阻止数据分片进行合并。[#21976](https://github.com/ClickHouse/ClickHouse/pull/21976)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 回滚了 [#15454](https://github.com/ClickHouse/ClickHouse/issues/15454)，该更改可能会在加载哈希类型外部字典时显著增加内存使用量。这也关闭了 [#21935](https://github.com/ClickHouse/ClickHouse/issues/21935)。 [#21948](https://github.com/ClickHouse/ClickHouse/pull/21948)（[Maksim Kita](https://github.com/kitaisreal)）。
* 防止对冲连接发生重叠（`Unknown packet 9 from server` 错误）。[#21941](https://github.com/ClickHouse/ClickHouse/pull/21941) ([Azat Khuzhin](https://github.com/azat))。
* 在某些情况下修复了读取 content type 为 &quot;multipart/form-data&quot; 的 HTTP POST 请求的行为。 [#21936](https://github.com/ClickHouse/ClickHouse/pull/21936) ([Ivan](https://github.com/abyss7)).
* 修复在查询包含窗口函数且应用了按主键顺序读取优化时出现的错误 `ORDER BY` 结果。修复 [#21828](https://github.com/ClickHouse/ClickHouse/issues/21828)。[#21915](https://github.com/ClickHouse/ClickHouse/pull/21915)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* 修复首次执行 catboost 模型时出现的死锁问题。关闭 [#13832](https://github.com/ClickHouse/ClickHouse/issues/13832)。[#21844](https://github.com/ClickHouse/ClickHouse/pull/21844)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复在将 `WHERE` 或 `HAVING` 条件下推至 `GROUP BY` 之前时，可能出现的查询结果不正确（以及可能崩溃）的问题。修复了 [#21773](https://github.com/ClickHouse/ClickHouse/issues/21773)。[#21841](https://github.com/ClickHouse/ClickHouse/pull/21841)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 在 `WriteBufferFromS3` 中改进错误处理和日志。[#21836](https://github.com/ClickHouse/ClickHouse/pull/21836)（[Pavel Kovalenko](https://github.com/Jokser)）。
* 修复在使用两级聚合时，带有组合子 `Distinct` 的聚合函数中可能发生的崩溃。这是对 [#18365](https://github.com/ClickHouse/ClickHouse/pull/18365) 的后续修复。该问题只能在生产环境中复现。[#21818](https://github.com/ClickHouse/ClickHouse/pull/21818) ([Amos Bird](https://github.com/amosbird))。
* 修复标量子查询的索引分析。该修复解决了在 [#18896](https://github.com/ClickHouse/ClickHouse/pull/18896) 中引入的 [#21717](https://github.com/ClickHouse/ClickHouse/issues/21717)。[#21766](https://github.com/ClickHouse/ClickHouse/pull/21766)（[Amos Bird](https://github.com/amosbird)）。
* 修复 `ReplicatedMerge` 表引擎中的一个错误：当 `Decimal` 列的大小（32 位或 64 位）未改变时，`ALTER MODIFY COLUMN` 查询不会修改其类型的问题。[#21728](https://github.com/ClickHouse/ClickHouse/pull/21728) ([alesapin](https://github.com/alesapin))。
* 修复在 `ReplicatedMergeTree` 上并发执行 `OPTIMIZE` 和 `DROP` 时可能出现的无限等待问题。[#21716](https://github.com/ClickHouse/ClickHouse/pull/21716) ([Azat Khuzhin](https://github.com/azat)).
* 修复在参数为常量整数时对 `Map` 类型使用 `arrayElement` 函数的问题。 [#21699](https://github.com/ClickHouse/ClickHouse/pull/21699) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在 `ip_trie` 中访问不存在的属性并使用 `access_to_key_from_attributes` 时发生的 SIGSEGV。 [#21692](https://github.com/ClickHouse/ClickHouse/pull/21692) ([Azat Khuzhin](https://github.com/azat)).
* 服务器现在仅在完成 `DDLWorker` 和字典初始化之后才开始接受连接。[#21676](https://github.com/ClickHouse/ClickHouse/pull/21676)（[Azat Khuzhin](https://github.com/azat)）。
* 为 `Join` 类型表的键添加类型转换（此前会导致 SIGSEGV）。 [#21646](https://github.com/ClickHouse/ClickHouse/pull/21646) ([Azat Khuzhin](https://github.com/azat)).
* 修复在 `async_socket_for_remote=1` 时分布式请求的取消问题（例如对多个分片执行带 `limit` 的简单查询：`select * from remote('127.{2,3}', system.numbers) limit 100`）。[#21643](https://github.com/ClickHouse/ClickHouse/pull/21643)（[Azat Khuzhin](https://github.com/azat)）。
* 修复在水平合并中使用的 `fsync_part_directory`。 [#21642](https://github.com/ClickHouse/ClickHouse/pull/21642) ([Azat Khuzhin](https://github.com/azat)).
* 在针对外部数据库引擎（MySQL、PostgreSQL）的查询中，从 `WHERE` 子句中移除关联表中的未知列。修复 [#14614](https://github.com/ClickHouse/ClickHouse/issues/14614)、[#19288](https://github.com/ClickHouse/ClickHouse/issues/19288)（重复）、[#19645](https://github.com/ClickHouse/ClickHouse/issues/19645)（重复）。[#21640](https://github.com/ClickHouse/ClickHouse/pull/21640)（[Vladimir](https://github.com/vdimir)）。
* 如果在向 S3 写入数据时发生错误，则会调用 `std::terminate`。[#21624](https://github.com/ClickHouse/ClickHouse/pull/21624) ([Vladimir](https://github.com/vdimir))。
* 修复在启用 `optimize_skip_unused_shards` 且没有可用分片时可能出现的 `Cannot find column` 错误。[#21579](https://github.com/ClickHouse/ClickHouse/pull/21579) ([Azat Khuzhin](https://github.com/azat)).
* 如果查询包含常量 `WHERE` 条件，并且启用了 `optimize_skip_unused_shards` 设置，则所有分片都可能被跳过，导致查询返回错误的空结果。 [#21550](https://github.com/ClickHouse/ClickHouse/pull/21550) ([Amos Bird](https://github.com/amosbird)).
* 修复表函数 `clusterAllReplicas` 返回错误 `_shard_num` 的问题。关闭 [#21481](https://github.com/ClickHouse/ClickHouse/issues/21481)。[#21498](https://github.com/ClickHouse/ClickHouse/pull/21498)（[flynn](https://github.com/ucasFL)）。
* 修复在更新配置后，S3 表仍然使用旧凭据的问题。[#21457](https://github.com/ClickHouse/ClickHouse/pull/21457) ([Grigory Pervakov](https://github.com/GrigoryPervakov)).
* 修复了 Poco 中 `SecureSocket` 内部 SSL 对象的竞态问题。 [#21456](https://github.com/ClickHouse/ClickHouse/pull/21456) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 修复 `Kafka` 的 `Avro` 格式解析问题。修复了 [#21437](https://github.com/ClickHouse/ClickHouse/issues/21437)。[#21438](https://github.com/ClickHouse/ClickHouse/pull/21438)（[Ilya Golshtein](https://github.com/ilejn)）。
* 修复安全套接字中的接收与发送超时问题以及非阻塞读取。[#21429](https://github.com/ClickHouse/ClickHouse/pull/21429) ([Kruglov Pavel](https://github.com/Avogar))。
* `force_drop_table` 标志在 `MATERIALIZED VIEW` 中不起作用的问题已修复。修复了 [#18943](https://github.com/ClickHouse/ClickHouse/issues/18943)。[#20626](https://github.com/ClickHouse/ClickHouse/pull/20626)（[tavplubix](https://github.com/tavplubix)）。
* 修复 `PredicateRewriteVisitor` 中的名称冲突问题。该问题会在执行 full join 后导致错误的 `WHERE` 过滤。关闭 [#20497](https://github.com/ClickHouse/ClickHouse/issues/20497)。[#20622](https://github.com/ClickHouse/ClickHouse/pull/20622)（[Vladimir](https://github.com/vdimir)）。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-7}


* 为 ClickHouse Keeper 添加 [Jepsen](https://github.com/jepsen-io/jepsen) 测试。[#21677](https://github.com/ClickHouse/ClickHouse/pull/21677) ([alesapin](https://github.com/alesapin))。
* 在 CI 中并行运行无状态测试。依赖 [#22181](https://github.com/ClickHouse/ClickHouse/issues/22181)。[#22300](https://github.com/ClickHouse/ClickHouse/pull/22300)（[alesapin](https://github.com/alesapin)）。
* 为 [SQLancer](https://github.com/sqlancer/sqlancer) 的 CI 运行启用状态检查。[#22015](https://github.com/ClickHouse/ClickHouse/pull/22015)（[Ilya Yatsishin](https://github.com/qoega)）。
* 针对 PowerPC 构建进行了多项准备：在 `ppc64le` 上启用自带的 openldap。[#22487](https://github.com/ClickHouse/ClickHouse/pull/22487)（[Kfir Itzhak](https://github.com/mastertheknife)）。在 `ppc64le` 上启用使用 Clang 进行编译。[#22476](https://github.com/ClickHouse/ClickHouse/pull/22476)（[Kfir Itzhak](https://github.com/mastertheknife)）。修复在 `ppc64le` 上编译 boost 的问题。[#22474](https://github.com/ClickHouse/ClickHouse/pull/22474)（[Kfir Itzhak](https://github.com/mastertheknife)）。修复在 `ppc64le` 上内部 CMake 变量 `CMAKE_ASM_COMPILE_OBJECT` 未设置导致的 CMake 错误。[#22469](https://github.com/ClickHouse/ClickHouse/pull/22469)（[Kfir Itzhak](https://github.com/mastertheknife)）。修复 Fedora/RHEL/CentOS 在 `ppc64le` 上找不到 `libclang_rt.builtins` 的问题。[#22458](https://github.com/ClickHouse/ClickHouse/pull/22458)（[Kfir Itzhak](https://github.com/mastertheknife)）。在 `ppc64le` 上启用使用 `jemalloc` 进行构建。[#22447](https://github.com/ClickHouse/ClickHouse/pull/22447)（[Kfir Itzhak](https://github.com/mastertheknife)）。修复 ClickHouse 的配置嵌入以及 cctz 的时区嵌入在 `ppc64le` 上的问题。[#22445](https://github.com/ClickHouse/ClickHouse/pull/22445)（[Kfir Itzhak](https://github.com/mastertheknife)）。修复在 `ppc64le` 上的编译问题，并在 `ppc64le` 上使用正确的指令指针寄存器。[#22430](https://github.com/ClickHouse/ClickHouse/pull/22430)（[Kfir Itzhak](https://github.com/mastertheknife)）。
* 在 `aarch64` 上重新启用 S3（AWS）库。[#22484](https://github.com/ClickHouse/ClickHouse/pull/22484)（[Kfir Itzhak](https://github.com/mastertheknife)）。
* 在 Docker 容器中添加 `tzdata`，因为读取 `ORC` 格式时需要它。修复了 [#14156](https://github.com/ClickHouse/ClickHouse/issues/14156)。[#22000](https://github.com/ClickHouse/ClickHouse/pull/22000)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 `clickhouse-server` 镜像的 Dockerfile 新增 2 个参数：`deb_location` 和 `single_binary_location`。 [#21977](https://github.com/ClickHouse/ClickHouse/pull/21977) ([filimonov](https://github.com/filimonov))。
* 通过在使用 `clang-tidy` 时启用断言，使其也可用于 release 构建。 [#21914](https://github.com/ClickHouse/ClickHouse/pull/21914) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 在 CMake 脚本中将 `llvm-12` 可执行文件名称加入到搜索范围。调整隐式常量转换以消除 clang 警告。更新子模块以支持使用 CMake 3.19 构建。在 `readpassphrase` 库中屏蔽宏展开时的递归警告。在 clang 中将已弃用的 `-fuse-ld` 替换为 `--ld-path`。[#21597](https://github.com/ClickHouse/ClickHouse/pull/21597)（[Ilya Yatsishin](https://github.com/qoega)）。
* 将 `docker/test/testflows/runner/dockerd-entrypoint.sh` 更新为使用 Yandex 的 dockerhub-proxy，因为 Docker Hub 启用了非常严格的速率限制 [#21551](https://github.com/ClickHouse/ClickHouse/pull/21551) ([vzakaznikov](https://github.com/vzakaznikov))。
* 修复 macOS 共享库编译。[#20184](https://github.com/ClickHouse/ClickHouse/pull/20184) ([nvartolomei](https://github.com/nvartolomei)).
* 为 `zookeeper-dump-tree` 添加 `ctime` 选项，用于导出节点创建时间。 [#21842](https://github.com/ClickHouse/ClickHouse/pull/21842) ([Ilya](https://github.com/HumanUser)).





## ClickHouse 21.3 版本 (LTS) {#clickhouse-release-213-lts}

### ClickHouse v21.3 版本,2021-03-12 {#clickhouse-release-v213-2021-03-12}

#### 不兼容变更 {#backward-incompatible-change-8}

- 现在不允许使用旧语法创建带有表级 TTL 的 MergeTree 表,因为该设置会被忽略。仍然可以附加旧表。[#20282](https://github.com/ClickHouse/ClickHouse/pull/20282) ([alesapin](https://github.com/alesapin))。
- 现在所有不区分大小写的函数名称都将被重写为其规范形式。这是投影查询路由(即将推出的功能)所必需的。[#20174](https://github.com/ClickHouse/ClickHouse/pull/20174) ([Amos Bird](https://github.com/amosbird))。
- 修复了当 `TTL` 表达式是函数且与 `ORDER BY` 键相同时创建 `TTL` 的问题。现在允许在带有 `GROUP BY` 的 `TTL` 中为主键列设置自定义聚合。不兼容变更:对于不在 `GROUP BY` 中且未显式设置的主键列,当 TTL 过期时,现在应用的是 `any` 函数而不是 `max` 函数。此外,如果在 TTL 中使用 `WHERE` 或 `GROUP BY`,在执行滚动更新时可能会在合并过程中遇到异常。[#15450](https://github.com/ClickHouse/ClickHouse/pull/15450) ([Anton Popov](https://github.com/CurtizJ))。

#### 新功能 {#new-feature-8}


- 新增文件引擎设置：`engine_file_empty_if_not_exists` 和 `engine_file_truncate_on_insert`。[#20620](https://github.com/ClickHouse/ClickHouse/pull/20620) ([M0r64n](https://github.com/M0r64n))。
- 新增聚合函数 `deltaSum`，用于计算连续行之间的差值总和。[#20057](https://github.com/ClickHouse/ClickHouse/pull/20057) ([Russ Frank](https://github.com/rf))。
- `system.part_log` 表新增 `event_time_microseconds` 列。[#20027](https://github.com/ClickHouse/ClickHouse/pull/20027) ([Bharat Nallan](https://github.com/bharatnc))。
- 新增 `timezoneOffset(datetime)` 函数，返回相对于 UTC 的时区偏移量(以秒为单位)。此功能解决了 [#issue:19850](https://github.com/ClickHouse/ClickHouse/issues/19850)。[#19962](https://github.com/ClickHouse/ClickHouse/pull/19962) ([keenwolf](https://github.com/keen-wolf))。
- 新增设置 `insert_shard_id`，支持从分布式表向指定分片插入数据。[#19961](https://github.com/ClickHouse/ClickHouse/pull/19961) ([flynn](https://github.com/ucasFL))。
- 函数 `reinterpretAs` 更新以支持大整数类型。修复了 [#19691](https://github.com/ClickHouse/ClickHouse/issues/19691)。[#19858](https://github.com/ClickHouse/ClickHouse/pull/19858) ([Maksim Kita](https://github.com/kitaisreal))。
- S3 客户端新增服务器端加密客户密钥支持(即 `x-amz-server-side-encryption-customer-(key/md5)` 请求头)。详见[此链接](https://docs.aws.amazon.com/AmazonS3/latest/dev/ServerSideEncryptionCustomerKeys.html)。解决了 [#19428](https://github.com/ClickHouse/ClickHouse/issues/19428)。[#19748](https://github.com/ClickHouse/ClickHouse/pull/19748) ([Vladimir Chebotarev](https://github.com/excitoon))。
- 为 `executable` 字典源新增 `implicit_key` 选项。当记录顺序与输入键顺序一致时,该选项允许省略为每条记录打印键。实现了 [#14527](https://github.com/ClickHouse/ClickHouse/issues/14527)。[#19677](https://github.com/ClickHouse/ClickHouse/pull/19677) ([Maksim Kita](https://github.com/kitaisreal))。
- 新增配额类型 `query_selects` 和 `query_inserts`。[#19603](https://github.com/ClickHouse/ClickHouse/pull/19603) ([JackyWoo](https://github.com/JackyWoo))。
- 新增函数 `extractTextFromHTML` [#19600](https://github.com/ClickHouse/ClickHouse/pull/19600) ([zlx19950903](https://github.com/zlx19950903)), ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 使用 `MergeTree*` 引擎的表新增两个表级设置用于查询并发控制。设置 `max_concurrent_queries` 限制与该表相关的并发执行查询数量。设置 `min_marks_to_honor_max_concurrent_queries` 指定仅当查询读取至少指定数量的标记时才应用前述设置。[#19544](https://github.com/ClickHouse/ClickHouse/pull/19544) ([Amos Bird](https://github.com/amosbird))。
- 新增 `file` 函数,用于从 user_files 目录读取文件并以字符串形式返回。该函数与 `file` 表函数不同。实现了 [#issue:18851](https://github.com/ClickHouse/ClickHouse/issues/18851)。[#19204](https://github.com/ClickHouse/ClickHouse/pull/19204) ([keenwolf](https://github.com/keen-wolf))。

#### 实验性功能 {#experimental-feature-7}


- 新增实验性 `Replicated` 数据库引擎。该引擎可在多个主机间复制 DDL 查询。[#16193](https://github.com/ClickHouse/ClickHouse/pull/16193) ([tavplubix](https://github.com/tavplubix)).
- 引入窗口函数的实验性支持,通过设置 `allow_experimental_window_functions = 1` 启用。这是一个初步的 alpha 质量实现,不适用于生产环境,且在未来版本中将以不向后兼容的方式进行更改。支持的功能列表请参阅[文档](https://github.com/ClickHouse/ClickHouse/blob/master/docs/sql-reference/window-functions/index.md#experimental-window-functions)。[#20337](https://github.com/ClickHouse/ClickHouse/pull/20337) ([Alexander Kuzmenkov](https://github.com/akuzm)).
- 新增 DiskS3 元数据文件的备份/恢复功能。[#18377](https://github.com/ClickHouse/ClickHouse/pull/18377) ([Pavel Kovalenko](https://github.com/Jokser)).

#### 性能改进 {#performance-improvement-8}


* 针对远程查询的对冲请求。启用 `use_hedged_requests`（默认关闭）后，允许为一次查询同时与多个不同副本建立连接。如果在 `hedged_connection_timeout` 内未能与副本成功建立现有连接，或在 `receive_data_timeout` 内未收到数据，则会启动新的连接。查询会使用第一个发送非空进度包的连接（或者在启用 `allow_changing_replica_until_first_data_packet` 时，第一个发送数据包的连接），其他连接将被取消。支持 `max_parallel_replicas > 1` 的查询。[#19291](https://github.com/ClickHouse/ClickHouse/pull/19291)（[Kruglov Pavel](https://github.com/Avogar)）。这可以在超大集群中显著降低尾部延迟。
* 当表中指定了行级安全表达式时，新增对 `PREWHERE` 的支持（并启用相应的优化）。[#19576](https://github.com/ClickHouse/ClickHouse/pull/19576) ([Denis Glazachev](https://github.com/traceon))。
* 设置 `distributed_aggregation_memory_efficient` 默认是启用状态。它可以降低内存占用并提升分布式查询的性能。 [#20599](https://github.com/ClickHouse/ClickHouse/pull/20599) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 提升多固定大小键 GROUP BY 的性能。 [#20472](https://github.com/ClickHouse/ClickHouse/pull/20472) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 通过更严格的别名优化提升聚合函数的性能。 [#19946](https://github.com/ClickHouse/ClickHouse/pull/19946) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 在极端情况下（读取速度在 50 GB/秒量级时），通过简化 `pipeline` 并从而减少 `pipeline` 调度中的锁争用，加速从 `Memory` 表中读取数据。[#20468](https://github.com/ClickHouse/ClickHouse/pull/20468)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 部分重写 HTTP 服务器，以减少对传入和传出数据的拷贝次数。这样在通过 HTTP 插入长记录时，性能最高可提升约 1.5 倍。 [#19516](https://github.com/ClickHouse/ClickHouse/pull/19516) ([Ivan](https://github.com/abyss7))。
* 为 `Memory` 表添加 `compress` 设置。如果启用，该表将占用更少的 RAM。在某些机器和数据集上，它在执行 SELECT 时也可能更快，但并非总是如此。此更改解决了 [#20093](https://github.com/ClickHouse/ClickHouse/issues/20093)。注意：`Memory` 表可能比 `MergeTree` 更慢的原因包括：(1) 不进行压缩 (2) 数据块大小固定 (3) 缺少索引和 `prewhere`…… [#20168](https://github.com/ClickHouse/ClickHouse/pull/20168) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 聚合相关代码略有改进。[#20978](https://github.com/ClickHouse/ClickHouse/pull/20978) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 为获得更好的性能，重新添加 `intDiv`/`modulo` 特化实现。修复了 [#21293](https://github.com/ClickHouse/ClickHouse/issues/21293)。该回归问题是在 [https://github.com/ClickHouse/ClickHouse/pull/18145](https://github.com/ClickHouse/ClickHouse/pull/18145) 中引入的。[#21307](https://github.com/ClickHouse/ClickHouse/pull/21307)（[Amos Bird](https://github.com/amosbird)）。
* 在向 Memory 表执行 INSERT SELECT 时不要过度合并数据块。在之前的版本中，执行 INSERT SELECT 后会在 Memory 表中生成低效的数据表示。本次变更修复了 [#13052](https://github.com/ClickHouse/ClickHouse/issues/13052)。[#20169](https://github.com/ClickHouse/ClickHouse/pull/20169)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了至少一个 `DataType` 解析器在某些情况下可能呈指数级复杂度的问题（由模糊测试发现），由此关闭了 [#20096](https://github.com/ClickHouse/ClickHouse/issues/20096)。[#20132](https://github.com/ClickHouse/ClickHouse/pull/20132)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 当 `do_not_merge_across_partitions_select_final` 设置为 1，且单个 part 的 level &gt; 0 时，对带有 FINAL 的 SELECT 查询进行并行化。[#19375](https://github.com/ClickHouse/ClickHouse/pull/19375) ([Kruglov Pavel](https://github.com/Avogar)).
* 在查询 `system.parts` 和 `system.parts_columns` 时只填充被请求的列。修复 [#19570](https://github.com/ClickHouse/ClickHouse/issues/19570)。[#21035](https://github.com/ClickHouse/ClickHouse/pull/21035)（[Anmol Arora](https://github.com/anmolarora)）。
* 对 `avg` 聚合函数内部的算术表达式进行代数优化。修复 [#20092](https://github.com/ClickHouse/ClickHouse/issues/20092)。[#20183](https://github.com/ClickHouse/ClickHouse/pull/20183)（[flynn](https://github.com/ucasFL)）。

#### 改进 {#improvement-8}


* 为表函数提供了不区分大小写的压缩方法。同时修复了此前仅以大写形式进行检查的 LZMA 压缩方法。[#21416](https://github.com/ClickHouse/ClickHouse/pull/21416) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 添加两个设置，用于在非活动数据片过多时延迟插入或抛出错误。当服务器无法足够快地清理数据片时，这非常有用。 [#20178](https://github.com/ClickHouse/ClickHouse/pull/20178) ([Amos Bird](https://github.com/amosbird)).
* 为 `mysql` 客户端提供更好的兼容性：1. `mysql JDBC` 2. `mycli`。[#21367](https://github.com/ClickHouse/ClickHouse/pull/21367)（[Amos Bird](https://github.com/amosbird)）。
* 如果某列被物化视图引用，则禁止删除该列。修复 [#21164](https://github.com/ClickHouse/ClickHouse/issues/21164)。[#21303](https://github.com/ClickHouse/ClickHouse/pull/21303)（[flynn](https://github.com/ucasFL)）。
* MySQL 字典源现在会在发生意外连接失败（在查询期间与 MySQL 服务器的连接丢失）时进行重试，这种情况有时会在使用 SSL/TLS 的连接中出现。 [#21237](https://github.com/ClickHouse/ClickHouse/pull/21237) ([Alexander Kazakov](https://github.com/Akazz)).
* 可用性改进：使 `DateTime64` 的解析行为更加一致：能够识别以缩放整数形式指定、带有子秒精度的 Unix 时间戳（例如使用 `1111111111222` 而不是 `1111111111.222`）。修复了 [#13194](https://github.com/ClickHouse/ClickHouse/issues/13194)。[#21053](https://github.com/ClickHouse/ClickHouse/pull/21053)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在使用 `distributed_group_by_no_merge` 时，仅在发起端执行已排序数据块的合并。 [#20882](https://github.com/ClickHouse/ClickHouse/pull/20882) ([Azat Khuzhin](https://github.com/azat)).
* 在加载 `mysql` 源的配置时，ClickHouse 现在会对具有相同优先级的副本列表进行随机打乱，以保证以轮询方式选择 `mysql` 端点。此更改修复了 [#20629](https://github.com/ClickHouse/ClickHouse/issues/20629)。[#20632](https://github.com/ClickHouse/ClickHouse/pull/20632)（[Alexander Kazakov](https://github.com/Akazz)）。
* 函数 &#39;reinterpretAs(x, Type)&#39; 已重命名为 &#39;reinterpret(x, Type)&#39;。[#20611](https://github.com/ClickHouse/ClickHouse/pull/20611) ([Maksim Kita](https://github.com/kitaisreal)).
* 为 RabbitMQ 引擎添加对 vhost 的支持 [#20576](https://github.com/ClickHouse/ClickHouse/issues/20576)。[#20596](https://github.com/ClickHouse/ClickHouse/pull/20596)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 改进了由 `Array` 和 `Tuple` 组合的数据类型的序列化。改进了枚举数据类型与 protobuf 枚举类型的匹配。修复了 `Map` 数据类型的序列化。现在会默认设置被省略的值。[#20506](https://github.com/ClickHouse/ClickHouse/pull/20506)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复了分布式 DDL 任务执行与 DDL 队列清理之间的竞态问题。现在在存在活动 worker 时，DDL 任务不会从 ZooKeeper 中被移除。修复了 [#20016](https://github.com/ClickHouse/ClickHouse/issues/20016)。[#20448](https://github.com/ClickHouse/ClickHouse/pull/20448)（[tavplubix](https://github.com/tavplubix)）。
* 在 alpine 镜像中使 FQDN 和其他与 DNS 相关的函数正常工作。 [#20336](https://github.com/ClickHouse/ClickHouse/pull/20336) ([filimonov](https://github.com/filimonov)).
* 禁止对被显式禁止的函数执行提前常量折叠。 [#20303](https://github.com/ClickHouse/ClickHouse/pull/20303) ([Azat Khuzhin](https://github.com/azat)).
* 当整数到 `Decimal` 类型的隐式转换在整数值无法容纳进 `Decimal` 类型时仍然被错误地判定为成功时，现在会抛出 `ARGUMENT_OUT_OF_BOUND`。 [#20232](https://github.com/ClickHouse/ClickHouse/pull/20232) ([tavplubix](https://github.com/tavplubix))。
* 无锁 `SYSTEM FLUSH DISTRIBUTED`。 [#20215](https://github.com/ClickHouse/ClickHouse/pull/20215) ([Azat Khuzhin](https://github.com/azat)).
* 将 `count(constant)`、`sum(1)` 规范化为 `count()`。这是投影查询路由所必需的。[#20175](https://github.com/ClickHouse/ClickHouse/pull/20175) ([Amos Bird](https://github.com/amosbird))。
* 在 bitmap 函数中支持所有原生整数类型。[#20171](https://github.com/ClickHouse/ClickHouse/pull/20171)（[Amos Bird](https://github.com/amosbird)）。
* 将 `CacheDictionary`、`ComplexCacheDictionary`、`SSDCacheDictionary` 和 `SSDComplexKeyDictionary` 的底层索引更新为使用 `LRUHashMap`。[#20164](https://github.com/ClickHouse/ClickHouse/pull/20164)（[Maksim Kita](https://github.com/kitaisreal)）。
* 现在可以在启动时通过设置 `CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT` 来配置 `access_management`，其默认值仍为禁用（`0`），与之前相同。[#20139](https://github.com/ClickHouse/ClickHouse/pull/20139) ([Marquitos](https://github.com/sonirico))。
* 修复 `DateTime64` 中 `toDateTime64(toDate()/toDateTime())` 的行为——为 `DateTime64` 实现与 `DateTime` 相同的范围钳制逻辑。[#20131](https://github.com/ClickHouse/ClickHouse/pull/20131)（[Azat Khuzhin](https://github.com/azat)）。
* 配额改进：在配额计算中，`SHOW TABLES` 现在被视为一次查询，而不是两次查询。`SYSTEM` 查询现在会消耗配额。修复了配额消耗中时间区间结束点的计算。[#20106](https://github.com/ClickHouse/ClickHouse/pull/20106) ([Vitaly Baranov](https://github.com/vitlibar))。
* 为 `system.zookeeper` 表添加对 `path IN (set)` 表达式的支持。 [#20105](https://github.com/ClickHouse/ClickHouse/pull/20105) ([小路](https://github.com/nicelulu)).
* 在 `system.tables` 中显示 `MaterializeMySQL` 表的完整详情。[#20051](https://github.com/ClickHouse/ClickHouse/pull/20051) ([Stig Bakken](https://github.com/stigsb))。
* 修复了 `executable dictionary` 中的一个数据竞争问题，该问题仅在误用时才会出现（例如脚本在忽略其输入的情况下返回数据时）。 [#20045](https://github.com/ClickHouse/ClickHouse/pull/20045) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 现在可以通过 mysql replica 配置部分中的“opt&#95;reconnect”参数来控制 MYSQL&#95;OPT&#95;RECONNECT 选项的值。[#19998](https://github.com/ClickHouse/ClickHouse/pull/19998) ([Alexander Kazakov](https://github.com/Akazz))。
* 如果用户调用 `JSONExtract` 函数并请求 `Float32` 类型，则允许将值不精确地转换为目标类型。例如，JSON 中的数字 `0.1` 是双精度的，在 Float32 中无法精确表示，但用户仍然希望得到这个值。之前的版本为了表明转换不精确，对于非 `Nullable` 类型返回 0，对于 `Nullable` 类型返回 NULL。这个逻辑在语义上是完全正确的，但会让用户感到意外并引发疑问。此更改关闭了 [#13962](https://github.com/ClickHouse/ClickHouse/issues/13962)。[#19960](https://github.com/ClickHouse/ClickHouse/pull/19960)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 如果向 `Distributed` 表执行 `INSERT` 时块结构不匹配，则添加块结构转换。 [#19947](https://github.com/ClickHouse/ClickHouse/pull/19947) ([Azat Khuzhin](https://github.com/azat)).
* 改进了 `system.distributed_ddl_queue` 表。重启后将 MaxDDLEntryID 初始化为最新值。在此 PR 之前，MaxDDLEntryID 会一直保持为零，直到有新的 DDLTask 被处理。[#19924](https://github.com/ClickHouse/ClickHouse/pull/19924) ([Amos Bird](https://github.com/amosbird))。
* 在 `system.parts` 中展示 `MaterializeMySQL` 表。 [#19770](https://github.com/ClickHouse/ClickHouse/pull/19770) ([Stig Bakken](https://github.com/stigsb))。
* 为 `Buffer` 配置文件新增单独的配置指令。 [#19721](https://github.com/ClickHouse/ClickHouse/pull/19721) ([Azat Khuzhin](https://github.com/azat)).
* 将与 `JOIN` 无关的条件移到 `WHERE` 子句中。[#18720](https://github.com/ClickHouse/ClickHouse/issues/18720)。[#19685](https://github.com/ClickHouse/ClickHouse/pull/19685) ([hexiaoting](https://github.com/hexiaoting))。
* 为 `Distributed` 引擎新增了基于异步发送待处理字节数来限制 `INSERT` 的功能（新增了 `bytes_to_delay_insert`、`max_delay_to_insert` 和 `bytes_to_throw_insert` 设置）。 [#19673](https://github.com/ClickHouse/ClickHouse/pull/19673) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在某些极少见情况下，析构函数中写入错误可能被忽略的问题。 [#19451](https://github.com/ClickHouse/ClickHouse/pull/19451) ([Azat Khuzhin](https://github.com/azat)).
* 在致命错误的堆栈跟踪中输出内联帧。 [#19317](https://github.com/ClickHouse/ClickHouse/pull/19317) ([Ivan](https://github.com/abyss7)).

#### 错误修复 {#bug-fix-7}


* 修复对 ZooKeeper 的多余重连，以及同一 ClickHouse 服务器可能同时存在两个活动会话的问题。这两个问题均在 #14678 中被引入。[#21264](https://github.com/ClickHouse/ClickHouse/pull/21264) ([alesapin](https://github.com/alesapin))。
* 修复在将 `Values` 格式的数据插入包含 `LowCardinality` 列的表时出现的错误 `Bad cast from type ... to DB::ColumnLowCardinality`。已修复 #21140 [#21357](https://github.com/ClickHouse/ClickHouse/pull/21357)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在非复制 MergeTree 表引擎中，当 `ALTER DELETE` 变更的谓词中引用了该表本身时可能出现的死锁问题。修复了 [#20558](https://github.com/ClickHouse/ClickHouse/issues/20558)。[#21477](https://github.com/ClickHouse/ClickHouse/pull/21477)（[alesapin](https://github.com/alesapin)）。
* 修复分布式查询失败时触发的 SIGSEGV。 [#21434](https://github.com/ClickHouse/ClickHouse/pull/21434) ([Azat Khuzhin](https://github.com/azat)).
* 现在，`ALTER MODIFY COLUMN` 查询将会正确地将更改应用到分区键、跳过索引、TTL 等。修复了 [#13675](https://github.com/ClickHouse/ClickHouse/issues/13675)。[#21334](https://github.com/ClickHouse/ClickHouse/pull/21334)（[alesapin](https://github.com/alesapin)）。
* 修复了在使用 `join_use_nulls` 并从子查询中关联 `TOTALS` 时的错误。此修复关闭了 [#19362](https://github.com/ClickHouse/ClickHouse/issues/19362) 和 [#21137](https://github.com/ClickHouse/ClickHouse/issues/21137)。[#21248](https://github.com/ClickHouse/ClickHouse/pull/21248)（[vdimir](https://github.com/vdimir)）。
* 修复在包含 `UNION` 的查询上执行 `EXPLAIN` 时发生的崩溃问题。修复了 [#20876](https://github.com/ClickHouse/ClickHouse/issues/20876)、[#21170](https://github.com/ClickHouse/ClickHouse/issues/21170)。[#21246](https://github.com/ClickHouse/ClickHouse/pull/21246)（[flynn](https://github.com/ucasFL)）。
* 现在只有对支持 `mutation` 的表引擎（MergeTree 系列、Memory、MaterializedView）才允许执行 `mutation`。其他引擎将报告更清晰的错误信息。修复了 [#21168](https://github.com/ClickHouse/ClickHouse/issues/21168)。[#21183](https://github.com/ClickHouse/ClickHouse/pull/21183)（[alesapin](https://github.com/alesapin)）。
* 修复了 [#21112](https://github.com/ClickHouse/ClickHouse/issues/21112)。修复了一个可能在 `insert` 查询中导致数据重复的错误（当某个回调稍有延迟时可能发生）。[#21138](https://github.com/ClickHouse/ClickHouse/pull/21138)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复了在类型为 Nullable 时 `input_format_null_as_default` 未生效的问题，解决了 [#21116](https://github.com/ClickHouse/ClickHouse/issues/21116)。[#21121](https://github.com/ClickHouse/ClickHouse/pull/21121)（[Amos Bird](https://github.com/amosbird)）。
* 修复与将 Tuple 转为 Map 相关的 bug。关闭 [#21029](https://github.com/ClickHouse/ClickHouse/issues/21029)。[#21120](https://github.com/ClickHouse/ClickHouse/pull/21120)（[hexiaoting](https://github.com/hexiaoting)）。
* 修复在删除使用自定义（非默认）ZooKeeper 集群的 `Replicated*MergeTree` 表时产生的元数据泄漏问题。[#21119](https://github.com/ClickHouse/ClickHouse/pull/21119)（[fastio](https://github.com/fastio)）。
* 修复在 `joinGet` 中使用 `LowCardinality` 键时的类型不匹配问题，解决了 [#21114](https://github.com/ClickHouse/ClickHouse/issues/21114)。[#21117](https://github.com/ClickHouse/ClickHouse/pull/21117)（[Amos Bird](https://github.com/amosbird)）。
* 修复了在引擎需要指定其他参数时，`default_replica_path` 和 `default_replica_name` 参数在 `Replicated(*)MergeTree` 引擎中形同无效的问题。[#21060](https://github.com/ClickHouse/ClickHouse/pull/21060) ([mxzlxy](https://github.com/mxzlxy)).
* 在对特意构造的超出范围的 `DateTime64` 类型值进行格式化时，可能发生越界内存访问。此更改关闭了 [#20494](https://github.com/ClickHouse/ClickHouse/issues/20494)。此更改关闭了 [#20543](https://github.com/ClickHouse/ClickHouse/issues/20543)。[#21023](https://github.com/ClickHouse/ClickHouse/pull/21023)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 阻止对 `StorageJoin` 的并行插入。 [#21009](https://github.com/ClickHouse/ClickHouse/pull/21009) ([vdimir](https://github.com/vdimir)).
* 修复了 `ALTER MODIFY COLUMN` 在明知必然失败的情况下仍然创建 mutation 的行为。[#21007](https://github.com/ClickHouse/ClickHouse/pull/21007) ([Anton Popov](https://github.com/CurtizJ)).
* 关闭了 [#9969](https://github.com/ClickHouse/ClickHouse/issues/9969)。修复了 Brotli `http` 压缩错误，该错误会在数据量较大、结构略微复杂且使用 `json` 输出格式时复现。将 Brotli 更新到最新版本，以包含“修复环形缓冲区中对未初始化数据的罕见访问”的补丁。[#20991](https://github.com/ClickHouse/ClickHouse/pull/20991)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在取消查询时出现的 “Empty task was returned from async task queue” 问题。 [#20881](https://github.com/ClickHouse/ClickHouse/pull/20881) ([Azat Khuzhin](https://github.com/azat)).
* 使用 MySQL 5.7 客户端连接 ClickHouse 服务器时，`USE database;` 查询无法正常工作，现已修复。修复了 [#18926](https://github.com/ClickHouse/ClickHouse/issues/18926)。[#20878](https://github.com/ClickHouse/ClickHouse/pull/20878)（[tavplubix](https://github.com/tavplubix)）。
* 修正聚合函数中同时使用 `-Distinct` 组合器与 `-State` 组合器时的用法。[#20866](https://github.com/ClickHouse/ClickHouse/pull/20866)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复包含 `UNION DISTINCT` 和 `LIMIT` 子句的子查询。关闭 [#20597](https://github.com/ClickHouse/ClickHouse/issues/20597)。[#20610](https://github.com/ClickHouse/ClickHouse/pull/20610)（[flynn](https://github.com/ucasFL)）。
* 修复了在查询中查找字典中不存在的键时字典行为不一致的问题。 [#20578](https://github.com/ClickHouse/ClickHouse/pull/20578) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 修复标量子查询和用于索引的子查询的线程数设置（在 [#19007](https://github.com/ClickHouse/ClickHouse/issues/19007) 之后始终只使用单线程）。修复了 [#20457](https://github.com/ClickHouse/ClickHouse/issues/20457)、[#20512](https://github.com/ClickHouse/ClickHouse/issues/20512)。[#20550](https://github.com/ClickHouse/ClickHouse/pull/20550)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在接收到来自远程查询的未知数据包时可能发生的崩溃问题（在 [#17868](https://github.com/ClickHouse/ClickHouse/issues/17868) 中引入）。[#20547](https://github.com/ClickHouse/ClickHouse/pull/20547)（[Azat Khuzhin](https://github.com/azat)）。
* 在解析用于异步 `INSERT` 的目录名称时添加适当的检查（修复 `SIGSEGV`）。 [#20498](https://github.com/ClickHouse/ClickHouse/pull/20498) ([Azat Khuzhin](https://github.com/azat))。
* 修复函数 `transform` 在浮点型键上无法正常工作的问题。修复 [#20460](https://github.com/ClickHouse/ClickHouse/issues/20460)。[#20479](https://github.com/ClickHouse/ClickHouse/pull/20479)（[flynn](https://github.com/ucasFL)）。
* 修复在将 `WITH` 别名传播到子查询时出现的无限循环问题。解决了 [#20388](https://github.com/ClickHouse/ClickHouse/issues/20388)。[#20476](https://github.com/ClickHouse/ClickHouse/pull/20476)（[Amos Bird](https://github.com/amosbird)）。
* 修复在 HTTP 客户端断开连接时导致的服务器异常终止问题。 [#20464](https://github.com/ClickHouse/ClickHouse/pull/20464) ([Azat Khuzhin](https://github.com/azat)).
* 修复在 `JOIN` 中包含来自 `SELECT` 的常量时，`join_use_nulls=1` 出现的 `LOGICAL_ERROR`。 [#20461](https://github.com/ClickHouse/ClickHouse/pull/20461) ([Azat Khuzhin](https://github.com/azat)).
* 检查表达式列表中是否使用了表函数 `view`，如使用则抛出错误。此更改修复了 [#20342](https://github.com/ClickHouse/ClickHouse/issues/20342)。[#20350](https://github.com/ClickHouse/ClickHouse/pull/20350)（[Amos Bird](https://github.com/amosbird)）。
* 避免在 RANGE&#95;HASHED() 字典中发生无效解引用。 [#20345](https://github.com/ClickHouse/ClickHouse/pull/20345) ([Azat Khuzhin](https://github.com/azat)).
* 修复在 `join_use_nulls=1` 时出现的空值解引用问题。 [#20344](https://github.com/ClickHouse/ClickHouse/pull/20344) ([Azat Khuzhin](https://github.com/azat)).
* 修复两个具有不同 scale 的常量 `Decimal` 之间进行二元运算时产生的错误结果。修复 [#20283](https://github.com/ClickHouse/ClickHouse/issues/20283)。[#20339](https://github.com/ClickHouse/ClickHouse/pull/20339)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复 `ReplicatedMergeTree` 表引擎族中失败后台任务重试过于频繁的问题。该问题可能导致日志过于冗长以及 CPU 负载增加。修复了 [#20203](https://github.com/ClickHouse/ClickHouse/issues/20203)。[#20335](https://github.com/ClickHouse/ClickHouse/pull/20335)（[alesapin](https://github.com/alesapin)）。
* 将 `*CollapsingMergeTree` 和 `ReplacingMergeTree` 表引擎中的版本列操作限制为仅支持 `DROP` 或 `RENAME`。 [#20300](https://github.com/ClickHouse/ClickHouse/pull/20300) ([alesapin](https://github.com/alesapin)).
* 修复了在遇到损坏的 JSON 时尝试将整个文件读入内存、从而导致分配器抛出异常的问题。修复了 [#19719](https://github.com/ClickHouse/ClickHouse/issues/19719)。[#20286](https://github.com/ClickHouse/ClickHouse/pull/20286)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 修复在对不支持垂直合并的 `MergeTree` 表引擎家族执行垂直合并时抛出的异常。修复了 [#20259](https://github.com/ClickHouse/ClickHouse/issues/20259)。[#20279](https://github.com/ClickHouse/ClickHouse/pull/20279)（[alesapin](https://github.com/alesapin)）。
* 修复在关闭过程中重新加载配置时可能出现的罕见服务器崩溃问题。修复了 [#19689](https://github.com/ClickHouse/ClickHouse/issues/19689)。[#20224](https://github.com/ClickHouse/ClickHouse/pull/20224)（[alesapin](https://github.com/alesapin)）。
* 修复在 `INSERT SELECT` 中使用 CTE 时的错误。修复了 [#20187](https://github.com/ClickHouse/ClickHouse/issues/20187) 和 [#20195](https://github.com/ClickHouse/ClickHouse/issues/20195)。[#20211](https://github.com/ClickHouse/ClickHouse/pull/20211)（[Amos Bird](https://github.com/amosbird)）。
* 修复了 [#19314](https://github.com/ClickHouse/ClickHouse/issues/19314)。[#20156](https://github.com/ClickHouse/ClickHouse/pull/20156)（[Ivan](https://github.com/abyss7)）。
* 修复 `toMinute` 函数，以正确处理特殊时区。[#20149](https://github.com/ClickHouse/ClickHouse/pull/20149) ([keenwolf](https://github.com/keen-wolf))。
* 修复了在执行带有 `if` 函数、且 then/else 分支结果为 `Tuple` 类型的查询时导致的服务器崩溃问题。`Tuple` 类型中必须包含 `Array` 或其他复杂类型。修复了 [#18356](https://github.com/ClickHouse/ClickHouse/issues/18356)。[#20133](https://github.com/ClickHouse/ClickHouse/pull/20133)（[alesapin](https://github.com/alesapin)）。
* `MongoDB` 表引擎现在只有在要读取数据时才会建立连接。`ATTACH TABLE` 不再尝试建立连接。[#20110](https://github.com/ClickHouse/ClickHouse/pull/20110)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复 `StorageJoin` 中的缺陷。[#20079](https://github.com/ClickHouse/ClickHouse/pull/20079)（[vdimir](https://github.com/vdimir)）。
* 修复了在对负数按较小除数进行取模计算时，结果数据类型不足以容纳负结果的问题。此修复关闭了 [#20052](https://github.com/ClickHouse/ClickHouse/issues/20052)。[#20067](https://github.com/ClickHouse/ClickHouse/pull/20067)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* MaterializeMySQL：修复对更新多个表的语句的复制问题。 [#20066](https://github.com/ClickHouse/ClickHouse/pull/20066) ([Håvard Kvålen](https://github.com/havardk)).
* 防止在执行初始化脚本期间在 Docker 中出现“Connection refused”错误。[#20012](https://github.com/ClickHouse/ClickHouse/pull/20012) ([filimonov](https://github.com/filimonov))。
* `EmbeddedRocksDB` 是一种实验性存储。修复了缺少正确类型检查的问题，并简化了代码。此更改关闭了 [#19967](https://github.com/ClickHouse/ClickHouse/issues/19967)。[#19972](https://github.com/ClickHouse/ClickHouse/pull/19972)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在参数类型为 `Nullable(T)` 且为除 Int32 以外的任意整数类型时，函数 `fromModifiedJulianDay` 会发生段错误的问题。[#19959](https://github.com/ClickHouse/ClickHouse/pull/19959) ([PHO](https://github.com/depressed-pho))。
* 修复 BloomFilter 索引导致的崩溃问题。修复了 [#19757](https://github.com/ClickHouse/ClickHouse/issues/19757)。[#19884](https://github.com/ClickHouse/ClickHouse/pull/19884)（[Maksim Kita](https://github.com/kitaisreal)）。
* 如果启用了 system.text&#95;log，可能会发生死锁。此更改修复了 [#19874](https://github.com/ClickHouse/ClickHouse/issues/19874)。[#19875](https://github.com/ClickHouse/ClickHouse/pull/19875)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在存在包含 `dictGet()` 默认表达式的表时启动服务器的问题。允许在不加载字典的情况下获取 `dictGet()` 的返回类型。[#19805](https://github.com/ClickHouse/ClickHouse/pull/19805) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复在仅执行 `select` 时导致 clickhouse-client 异常中止的问题。[#19790](https://github.com/ClickHouse/ClickHouse/pull/19790) ([taiyang-li](https://github.com/taiyang-li)).
* 修复了在启动多个 clickhouse-copier 时，将数据片段移动到目标表可能失败的错误。 [#19743](https://github.com/ClickHouse/ClickHouse/pull/19743) ([madianjun](https://github.com/mdianjun)).
* 执行 `ON CLUSTER` 查询的后台线程可能会在等待已被删除的复制表执行某些操作时进入挂起状态。此问题已修复。 [#19684](https://github.com/ClickHouse/ClickHouse/pull/19684) ([yiguolei](https://github.com/yiguolei)).

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-8}

- 允许在全局启用 AVX-2 来构建 ClickHouse。在现代 CPU 上可以带来轻微的性能提升。目前不建议用于生产环境,暂不作为官方构建版本提供支持。[#20180](https://github.com/ClickHouse/ClickHouse/pull/20180) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 修复了 Coverity 发现的部分问题。参见 [#19964](https://github.com/ClickHouse/ClickHouse/issues/19964)。[#20010](https://github.com/ClickHouse/ClickHouse/pull/20010) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 允许在 gdb 下使用修改过的二进制文件启动。在之前的版本中,如果在启动前在 gdb 中设置断点,服务器会因完整性检查失败而拒绝启动。[#21258](https://github.com/ClickHouse/ClickHouse/pull/21258) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 为 Kafka 的不同压缩方法添加了测试。[#21111](https://github.com/ClickHouse/ClickHouse/pull/21111) ([filimonov](https://github.com/filimonov))。
- 修复了 test_storage_kerberized_hdfs 测试中的端口冲突问题。[#19974](https://github.com/ClickHouse/ClickHouse/pull/19974) ([Ilya Yatsishin](https://github.com/qoega))。
- 在集成测试中 docker 启动失败时,将 `stdout` 和 `stderr` 输出到日志。在此 PR 之前,这种情况下只有一条非常简短的错误消息,不利于问题排查。[#20631](https://github.com/ClickHouse/ClickHouse/pull/20631) ([Vitaly Baranov](https://github.com/vitlibar))。


## ClickHouse 版本 21.2 {#clickhouse-release-212}

### ClickHouse 版本 v21.2.2.8-stable, 2021-02-07 {#clickhouse-release-v21228-stable-2021-02-07}

#### 不兼容变更 {#backward-incompatible-change-9}

- 位运算函数（`bitAnd`、`bitOr` 等）禁止用于浮点数参数。现在必须显式转换为整数类型。[#19853](https://github.com/ClickHouse/ClickHouse/pull/19853) ([Azat Khuzhin](https://github.com/azat))。
- 禁止对浮点数使用 `lcm`/`gcd` 函数。[#19532](https://github.com/ClickHouse/ClickHouse/pull/19532) ([Azat Khuzhin](https://github.com/azat))。
- 修复 `OPTIMIZE TABLE`/合并操作的内存跟踪；为 `OPTIMIZE TABLE`/合并操作应用查询内存限制和采样。[#18772](https://github.com/ClickHouse/ClickHouse/pull/18772) ([Azat Khuzhin](https://github.com/azat))。
- 禁止使用浮点数列作为分区键,详见 [#18421](https://github.com/ClickHouse/ClickHouse/issues/18421#event-4147046255)。[#18464](https://github.com/ClickHouse/ClickHouse/pull/18464) ([hexiaoting](https://github.com/hexiaoting))。
- 不再支持类型定义中的多余括号,例如：`Array((UInt8))`。

#### 新功能 {#new-feature-9}


* 新增 `PostgreSQL` 表引擎（支持 select/insert，并支持多维数组），也可作为表函数使用。新增 `PostgreSQL` 字典源。新增 `PostgreSQL` 数据库引擎。[#18554](https://github.com/ClickHouse/ClickHouse/pull/18554) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 数据类型 `Nested` 现在支持任意层级的嵌套。引入了复杂类型的子列，例如 `Array` 中的 `size0`、`Nullable` 中的 `null`、以及 `Tuple` 元素的名称，这些子列可以在不读取整个列的情况下单独读取。[#17310](https://github.com/ClickHouse/ClickHouse/pull/17310)（[Anton Popov](https://github.com/CurtizJ)）。
* 为 `FlatDictionary`、`HashedDictionary`、`ComplexKeyHashedDictionary`、`DirectDictionary`、`ComplexKeyDirectDictionary` 和 `RangeHashedDictionary` 增加了对 `Nullable` 的支持。[#18236](https://github.com/ClickHouse/ClickHouse/pull/18236) ([Maksim Kita](https://github.com/kitaisreal))。
* 添加了一个名为 `system.distributed_ddl_queue` 的新表，用于显示 DDL 工作线程队列中的查询。 [#17656](https://github.com/ClickHouse/ClickHouse/pull/17656) ([Bharat Nallan](https://github.com/bharatnc))。
* 为来自 `ldap` 用户目录的用户新增对将 `LDAP` 组名（以及通用属性值）映射到本地角色的支持。[#17211](https://github.com/ClickHouse/ClickHouse/pull/17211) ([Denis Glazachev](https://github.com/traceon)).
* 支持对表函数 `cluster` 执行 `INSERT INTO` 操作，并且对于表函数 `remote` 和 `cluster`，支持通过指定分片键在各节点间分发数据。关闭 [#16752](https://github.com/ClickHouse/ClickHouse/issues/16752)。[#18264](https://github.com/ClickHouse/ClickHouse/pull/18264)（[flynn](https://github.com/ucasFL)）。
* 添加函数 `decodeXMLComponent` 用于解码 XML 字符。例如：`SELECT decodeXMLComponent('Hello,&quot;world&quot;!')` [#17659](https://github.com/ClickHouse/ClickHouse/issues/17659)。 [#18542](https://github.com/ClickHouse/ClickHouse/pull/18542) ([nauta](https://github.com/nautaa))。
* 新增了函数 `parseDateTimeBestEffortUSOrZero`、`parseDateTimeBestEffortUSOrNull`。[#19712](https://github.com/ClickHouse/ClickHouse/pull/19712) ([Maksim Kita](https://github.com/kitaisreal)).
* 新增 `sign` 数学函数。 [#19527](https://github.com/ClickHouse/ClickHouse/pull/19527) ([flynn](https://github.com/ucasFL)).
* 在 system.query&#95;log 中添加已使用特性（函数、表引擎等）的相关信息。 [#18495](https://github.com/ClickHouse/ClickHouse/issues/18495)。 [#19371](https://github.com/ClickHouse/ClickHouse/pull/19371) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 函数 `formatDateTime` 支持使用 `%Q` 修饰符将日期格式化为季度。[#19224](https://github.com/ClickHouse/ClickHouse/pull/19224)（[Jianmei Zhang](https://github.com/zhangjmruc)）。
* 在 play UI 中支持 MetaKey+Enter 快捷键绑定。[#19012](https://github.com/ClickHouse/ClickHouse/pull/19012) ([sundyli](https://github.com/sundy-li)).
* 为 `map` 数据类型新增三个函数：1. `mapContains(map, key)` 用于检查 `map` 中的键是否包含第二个参数 `key`。2. `mapKeys(map)` 以 `Array` 格式返回所有键。3. `mapValues(map)` 以 `Array` 格式返回所有值。[#18788](https://github.com/ClickHouse/ClickHouse/pull/18788) ([hexiaoting](https://github.com/hexiaoting))。
* 添加与 [#18494](https://github.com/ClickHouse/ClickHouse/issues/18494) 相关的 `log_comment` 设置。[#18549](https://github.com/ClickHouse/ClickHouse/pull/18549)（[Zijie Lu](https://github.com/TszKitLo40)）。
* 为 `argMin` 和 `argMax` 函数添加对元组（tuple）参数的支持。[#17359](https://github.com/ClickHouse/ClickHouse/pull/17359) ([Ildus Kurbangaliev](https://github.com/ildus))。
* 支持 `EXISTS VIEW` 语法。 [#18552](https://github.com/ClickHouse/ClickHouse/pull/18552) ([杜川](https://github.com/spongedu))。
* 添加 `SELECT ALL` 语法。修复 [#18706](https://github.com/ClickHouse/ClickHouse/issues/18706)。[#18723](https://github.com/ClickHouse/ClickHouse/pull/18723)（[flynn](https://github.com/ucasFL)）。

#### 性能改进 {#performance-improvement-9}

- 通过减少 `stat` 系统调用次数加快数据分片删除速度。此更改恢复了之前存在的优化,并提供了更安全的 `IDisk` 接口。此更改关闭了 [#19065](https://github.com/ClickHouse/ClickHouse/issues/19065)。[#19086](https://github.com/ClickHouse/ClickHouse/pull/19086) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 在 `WITH` 语句中声明的别名现在可以正确用于索引分析。类似 `WITH column AS alias SELECT ... WHERE alias = ...` 的查询现在可以使用索引。[#18896](https://github.com/ClickHouse/ClickHouse/pull/18896) ([Amos Bird](https://github.com/amosbird))。
- 添加 `optimize_alias_column_prediction` 设置(默认开启),该设置将:- 在分区裁剪和使用二级索引跳过数据时,在 WHERE 子句中识别别名列;- 在 optimize_trivial_count 的简单计数查询中,在 WHERE 子句中识别别名列;- 在 optimize_aggregation_in_order/optimize_read_in_order 中,在 GROUP BY/ORDER BY 子句中识别别名列。[#16995](https://github.com/ClickHouse/ClickHouse/pull/16995) ([sundyli](https://github.com/sundy-li))。
- 加速聚合函数 `sum`。改进仅在合成基准测试中可见,实际应用价值不大。[#19216](https://github.com/ClickHouse/ClickHouse/pull/19216) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 更新 libc++ 并使用另一个 ABI 以提供更好的性能。[#18914](https://github.com/ClickHouse/ClickHouse/pull/18914) ([Danila Kutenin](https://github.com/danlark1))。
- 在逻辑等价时,将 `sumIf()` 和 `sum(if())` 函数重写为 `countIf()` 函数。[#17041](https://github.com/ClickHouse/ClickHouse/pull/17041) ([flynn](https://github.com/ucasFL))。
- 为 S3 连接使用连接池,由 `s3_max_connections` 设置控制。[#13405](https://github.com/ClickHouse/ClickHouse/pull/13405) ([Vladimir Chebotarev](https://github.com/excitoon))。
- 添加对 zstd long 选项的支持,以更好地压缩字符串列从而节省空间。[#17184](https://github.com/ClickHouse/ClickHouse/pull/17184) ([ygrek](https://github.com/ygrek))。
- 通过移除每次连接时对配置的访问,略微改善服务器延迟。[#19863](https://github.com/ClickHouse/ClickHouse/pull/19863) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 减少 `Buffer` 引擎多层的锁竞争。[#19379](https://github.com/ClickHouse/ClickHouse/pull/19379) ([Azat Khuzhin](https://github.com/azat))。
- 支持将查询计划的 `Filter` 步骤拆分为 `Expression + Filter` 对。结合 `Expression + Expression` 合并优化([#17458](https://github.com/ClickHouse/ClickHouse/issues/17458)),可以延迟 `Filter` 步骤之后某些表达式的执行。[#19253](https://github.com/ClickHouse/ClickHouse/pull/19253) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。

#### 改进 {#improvement-9}


* `SELECT count() FROM table` 现在即使在该 `table` 中只有一列可供选择时也可以执行。此 PR 修复了 [#10639](https://github.com/ClickHouse/ClickHouse/issues/10639)。[#18233](https://github.com/ClickHouse/ClickHouse/pull/18233)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 与远程 MySQL 服务器交互时，将字符集设置为 `utf8mb4`。修复了 [#19795](https://github.com/ClickHouse/ClickHouse/issues/19795)。 [#19800](https://github.com/ClickHouse/ClickHouse/pull/19800) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `S3` 表函数现已支持 `auto` 压缩模式（自动检测）。这解决了 [#18754](https://github.com/ClickHouse/ClickHouse/issues/18754)。[#19793](https://github.com/ClickHouse/ClickHouse/pull/19793)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* 为 `formatReadableTimeDelta` 函数正确输出表示无穷大的参数。在之前的版本中，这些参数会被隐式转换为与具体实现相关的整数值。[#19791](https://github.com/ClickHouse/ClickHouse/pull/19791) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 如果无法精确确定区域，表函数 `S3` 将使用全局区域。修复了 [#10998](https://github.com/ClickHouse/ClickHouse/issues/10998)。[#19750](https://github.com/ClickHouse/ClickHouse/pull/19750)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* 在分布式查询中，如果启用了 `async_socket_for_remote` 设置，在表中使用嵌套层级非常深的数据类型（例如 `Array(Array(Array(...more...)))`）时，至少在调试构建配置下有可能导致栈溢出。此更改修复了 [#19108](https://github.com/ClickHouse/ClickHouse/issues/19108)。该更改引入了轻微的向后不兼容性：类型定义中的多余括号将不再受支持，例如：`Array((UInt8))`。[#19736](https://github.com/ClickHouse/ClickHouse/pull/19736)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为消息代理（RabbitMQ 和 Kafka）新增独立的连接池。 [#19722](https://github.com/ClickHouse/ClickHouse/pull/19722) ([Azat Khuzhin](https://github.com/azat)).
* 修复非复制 MergeTree 中罕见出现的 `max_number_of_merges_with_ttl_in_pool` 限制被超出的情况（可以分配更多带有 TTL 的合并）。[#19708](https://github.com/ClickHouse/ClickHouse/pull/19708) ([alesapin](https://github.com/alesapin)).
* Dictionary：在解析属性时提供了更清晰的错误消息。[#19678](https://github.com/ClickHouse/ClickHouse/pull/19678) ([Maksim Kita](https://github.com/kitaisreal))。
* 增加了一个选项，可在读取时禁用校验和验证。绝不应在生产环境中使用。请不要指望禁用它会带来任何好处。它仅可用于实验和基准测试。该设置仅适用于 MergeTree 系列表。对于其他表引擎以及通过网络接收数据时，校验和始终会被验证。根据我的观察，性能没有差异，或者差异小于 0.5%。 [#19588](https://github.com/ClickHouse/ClickHouse/pull/19588) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 在函数 `multiIf` 中支持返回常量结果。 [#19533](https://github.com/ClickHouse/ClickHouse/pull/19533) ([Maksim Kita](https://github.com/kitaisreal)).
* 为 Map 数据类型启用 length/empty/notEmpty 函数，用于返回 Map 中键的数量。 [#19530](https://github.com/ClickHouse/ClickHouse/pull/19530) ([taiyang-li](https://github.com/taiyang-li)).
* 为 `clickhouse-benchmark` 添加 `--reconnect` 选项。指定该选项时，将在每次请求前重新建立连接。这在测试时是必要的。[#19872](https://github.com/ClickHouse/ClickHouse/pull/19872) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 支持 `.debug` 文件的新位置。这修复了 [#19348](https://github.com/ClickHouse/ClickHouse/issues/19348)。[#19520](https://github.com/ClickHouse/ClickHouse/pull/19520)（[Amos Bird](https://github.com/amosbird)）。
* `toIPv6` 函数支持解析 `IPv4` 地址。 [#19518](https://github.com/ClickHouse/ClickHouse/pull/19518) ([Bharat Nallan](https://github.com/bharatnc))。
* 为 `system.query_log`、`system.processes` 等添加 `http_referer` 字段。此更改修复了 [#19389](https://github.com/ClickHouse/ClickHouse/issues/19389)。[#19390](https://github.com/ClickHouse/ClickHouse/pull/19390)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 通过让更多函数对大小写不敏感并添加别名来提升 MySQL 兼容性。 [#19387](https://github.com/ClickHouse/ClickHouse/pull/19387) ([Daniil Kondratyev](https://github.com/dankondr)).
* 为 MergeTree 数据片（Wide/Compact/InMemory）类型添加指标。 [#19381](https://github.com/ClickHouse/ClickHouse/pull/19381) ([Azat Khuzhin](https://github.com/azat)).
* 允许使用任意 UID 运行 Docker。 [#19374](https://github.com/ClickHouse/ClickHouse/pull/19374) ([filimonov](https://github.com/filimonov)).
* 修复 Pretty 格式中 `IPv4` 数据类型值的错误对齐问题。之前它们是右对齐，而不是左对齐。修复了 [#19184](https://github.com/ClickHouse/ClickHouse/issues/19184)。[#19339](https://github.com/ClickHouse/ClickHouse/pull/19339)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 允许在无需重启的情况下修改 `max_server_memory_usage`。修复了 [#18154](https://github.com/ClickHouse/ClickHouse/issues/18154)。[#19186](https://github.com/ClickHouse/ClickHouse/pull/19186)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在较早的版本中，当以某些 NaN 参数调用函数 `bar` 时抛出的异常信息可能略具误导性。此更改修复了 [#19088](https://github.com/ClickHouse/ClickHouse/issues/19088)。[#19107](https://github.com/ClickHouse/ClickHouse/pull/19107)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 clickhouse-server 镜像中，将 clickhouse 用户和用户组的 uid/gid 显式设置为固定值 101。 [#19096](https://github.com/ClickHouse/ClickHouse/pull/19096) ([filimonov](https://github.com/filimonov)).
* 修复了在插入包含超大字符串的数据时出现的 `PeekableReadBuffer: Memory limit exceed` 错误。修复了 [#18690](https://github.com/ClickHouse/ClickHouse/issues/18690)。[#18979](https://github.com/ClickHouse/ClickHouse/pull/18979)（[tavplubix](https://github.com/tavplubix)）。
* Docker 镜像：对 clickhouse-server 入口脚本进行了多项改进。 [#18954](https://github.com/ClickHouse/ClickHouse/pull/18954) ([filimonov](https://github.com/filimonov)).
* 添加 `normalizeQueryKeepNames` 和 `normalizedQueryHashKeepNames`，以在不使用 `?` 掩盖长名称的情况下规范化查询。这有助于更好地分析复杂查询日志。 [#18910](https://github.com/ClickHouse/ClickHouse/pull/18910) ([Amos Bird](https://github.com/amosbird)).
* 在发送端发送之前，对分布式批次的每个数据块计算并校验校验和（在读取时完成校验，而无需对文件进行二次读取），从而避免在接收端出现 `INSERT` 被卡住的情况（例如发送端的 `.bin` 文件被截断）。同时避免在批量 `INSERT` 时对 `.bin` 文件进行二次读取（之前需要这样做来计算行数/字节数以考虑 squashing，现在这些信息已包含在头部中，并且保持了向后兼容性）。 [#18853](https://github.com/ClickHouse/ClickHouse/pull/18853) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在对包含聚合函数状态的表执行 RIGHT 和 FULL JOIN 时出现的问题。在早期版本中，会抛出与 `cloneResized` 方法相关的异常。[#18818](https://github.com/ClickHouse/ClickHouse/pull/18818)（[templarzq](https://github.com/templarzq)）。
* 新增基于前缀的 S3 端点设置。[#18812](https://github.com/ClickHouse/ClickHouse/pull/18812)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* 为 `bitmapTransform`、`bitmapSubsetInRange`、`bitmapSubsetLimit`、`bitmapContains` 函数新增对 [UInt8, UInt16, UInt32, UInt64] 参数类型的支持。修复了 [#18713](https://github.com/ClickHouse/ClickHouse/issues/18713)。[#18791](https://github.com/ClickHouse/ClickHouse/pull/18791)（[sundyli](https://github.com/sundy-li)）。
* 允许对 CTE（Common Table Expressions，公用表表达式）进行进一步的别名化处理。当 `enable_global_with_statement = 1` 时，将 CSE（Common Subexpressions Elimination，公共子表达式消除）传播到同一层级的子查询中。修复了 [#17378](https://github.com/ClickHouse/ClickHouse/issues/17378)。修复了 [https://github.com/ClickHouse/ClickHouse/pull/16575#issuecomment-753416235](https://github.com/ClickHouse/ClickHouse/pull/16575#issuecomment-753416235)。[#18684](https://github.com/ClickHouse/ClickHouse/pull/18684)（[Amos Bird](https://github.com/amosbird)）。
* 将 `librdkafka` 更新到 v1.6.0-RC2，修复了 [#18668](https://github.com/ClickHouse/ClickHouse/issues/18668)。[#18671](https://github.com/ClickHouse/ClickHouse/pull/18671)（[filimonov](https://github.com/filimonov)）。
* 在出现意外异常时，自动重启负责执行分布式 DDL 查询的后台线程。修复 [#17991](https://github.com/ClickHouse/ClickHouse/issues/17991)。[#18285](https://github.com/ClickHouse/ClickHouse/pull/18285) ([徐炘](https://github.com/weeds085490))。
* 更新了 AWS C++ SDK，以便在 S3 中使用全局区域。 [#17870](https://github.com/ClickHouse/ClickHouse/pull/17870) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 在创建 `LIVE VIEW` 表时，新增支持使用 `WITH ... [AND] [PERIODIC] REFRESH [interval_in_sec]` 子句。[#14822](https://github.com/ClickHouse/ClickHouse/pull/14822) ([vzakaznikov](https://github.com/vzakaznikov)).
* 限制对使用旧语法创建的 `MergeTree` 表执行 `MODIFY TTL` 查询。之前这些查询会成功执行，但实际上不会产生任何效果。[#19064](https://github.com/ClickHouse/ClickHouse/pull/19064) ([Anton Popov](https://github.com/CurtizJ)).

#### 错误修复 {#bug-fix-8}


* 修复对带有常量参数的二元函数的索引分析问题，该问题会导致查询结果错误。此修复对应 [#18364](https://github.com/ClickHouse/ClickHouse/issues/18364)。[#18373](https://github.com/ClickHouse/ClickHouse/pull/18373)（[Amos Bird](https://github.com/amosbird)）。
* 修复了在存在包含 `dictGet()` 默认表达式的表时启动服务器的问题。允许在不加载字典的情况下获取 `dictGet()` 的返回类型。[#19805](https://github.com/ClickHouse/ClickHouse/pull/19805) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复了在执行使用 `if` 函数且 then/else 分支结果为 `Tuple` 类型的查询后导致的服务器崩溃问题。`Tuple` 类型必须包含 `Array` 或其他复杂类型。修复了 [#18356](https://github.com/ClickHouse/ClickHouse/issues/18356)。[#20133](https://github.com/ClickHouse/ClickHouse/pull/20133)（[alesapin](https://github.com/alesapin)）。
* `MaterializeMySQL`（实验特性）：修复对包含多个表更新操作的语句的复制。[#20066](https://github.com/ClickHouse/ClickHouse/pull/20066)（[Håvard Kvålen](https://github.com/havardk)）。
* 在执行初始化脚本期间，避免在 Docker 中出现 “Connection refused” 错误。 [#20012](https://github.com/ClickHouse/ClickHouse/pull/20012) ([filimonov](https://github.com/filimonov)).
* `EmbeddedRocksDB` 是一种实验性存储。修复了缺乏正确类型检查的问题，并简化了代码。由 [#19972](https://github.com/ClickHouse/ClickHouse/pull/19972)（[alexey-milovidov](https://github.com/alexey-milovidov)）关闭 [#19967](https://github.com/ClickHouse/ClickHouse/issues/19967)。
* 修复函数 `fromModifiedJulianDay` 在参数类型为 `Nullable(T)` 且底层为除 Int32 之外的任意整数类型时发生段错误的问题。 [#19959](https://github.com/ClickHouse/ClickHouse/pull/19959) ([PHO](https://github.com/depressed-pho)).
* 函数 `greatCircleAngle` 在之前的版本中返回的结果不够准确。此更改修复了问题 [#19769](https://github.com/ClickHouse/ClickHouse/issues/19769)。[#19789](https://github.com/ClickHouse/ClickHouse/pull/19789)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了一个罕见的错误：在数据损坏后，某些复制操作（如 `mutation`）无法处理某些分片。修复了 [#19593](https://github.com/ClickHouse/ClickHouse/issues/19593)。[#19702](https://github.com/ClickHouse/ClickHouse/pull/19702)（[alesapin](https://github.com/alesapin)）。
* 执行 `ON CLUSTER` 查询的后台线程可能会在等待已删除的复制表执行某些操作时被挂起。该问题已修复。 [#19684](https://github.com/ClickHouse/ClickHouse/pull/19684) ([yiguolei](https://github.com/yiguolei)).
* 修复列描述反序列化错误的问题。该问题会导致无法向包含名为 `\` 的列的表执行 INSERT 操作。[#19479](https://github.com/ClickHouse/ClickHouse/pull/19479) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 如果某个文件中的数据块为空，则将分布式批处理标记为损坏。 [#19449](https://github.com/ClickHouse/ClickHouse/pull/19449) ([Azat Khuzhin](https://github.com/azat)).
* 修复了一个极其罕见的 bug，该 bug 可能会在执行 `DROP/DETACH/REPLACE/MOVE PARTITION` 后导致 mutation 卡住。此前已由 [#15537](https://github.com/ClickHouse/ClickHouse/issues/15537) 在大多数情况下进行了部分修复。[#19443](https://github.com/ClickHouse/ClickHouse/pull/19443)（[tavplubix](https://github.com/tavplubix)）。
* 修复可能出现的错误 `Extremes transform was already added to pipeline`。修复 [#14100](https://github.com/ClickHouse/ClickHouse/issues/14100)。[#19430](https://github.com/ClickHouse/ClickHouse/pull/19430)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在具有非零默认值（例如某些 `Enum`）的 `JOIN` 类型中使用默认值的行为。关闭 [#18197](https://github.com/ClickHouse/ClickHouse/issues/18197)。[#19360](https://github.com/ClickHouse/ClickHouse/pull/19360)（[vdimir](https://github.com/vdimir)）。
* 不要在 EOF 时将用于分布式发送的文件标记为损坏。 [#19290](https://github.com/ClickHouse/ClickHouse/pull/19290) ([Azat Khuzhin](https://github.com/azat)).
* 修复 `async_socket_for_remote` 的管道文件描述符（fd）泄漏问题。[#19153](https://github.com/ClickHouse/ClickHouse/pull/19153) ([Azat Khuzhin](https://github.com/azat)).
* 修复 `ORC` 格式文件的无限读取问题（在 [#10580](https://github.com/ClickHouse/ClickHouse/issues/10580) 中引入）。修复 [#19095](https://github.com/ClickHouse/ClickHouse/issues/19095)。[#19134](https://github.com/ClickHouse/ClickHouse/pull/19134)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了 `MergeTree` 数据写入器中的一个问题，该问题可能导致标记大小超过固定粒度大小。修复了 [#18913](https://github.com/ClickHouse/ClickHouse/issues/18913)。[#19123](https://github.com/ClickHouse/ClickHouse/pull/19123)（[alesapin](https://github.com/alesapin)）。
* 修复启动阶段的一个错误：当 ClickHouse 无法从 `LowCardinality(Nullable(...))` 读取压缩编解码器并抛出异常 `Attempt to read after EOF` 时会导致启动失败。修复了 [#18340](https://github.com/ClickHouse/ClickHouse/issues/18340)。[#19101](https://github.com/ClickHouse/ClickHouse/pull/19101)（[alesapin](https://github.com/alesapin)）。
* 简化了 `tupleHammingDistance` 的实现。支持任意长度相同的元组。修复了 [#19029](https://github.com/ClickHouse/ClickHouse/issues/19029)。[#19084](https://github.com/ClickHouse/ClickHouse/pull/19084)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 确保 `groupUniqArray` 对 Enum 类型的参数返回正确的类型。此更改修复了 [#17875](https://github.com/ClickHouse/ClickHouse/issues/17875)。[#19019](https://github.com/ClickHouse/ClickHouse/pull/19019)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在将 `LowCardinality` 参数与函数 `ignore` 一起使用时可能出现的 `Expected single dictionary argument for function` 错误。修复 [#14275](https://github.com/ClickHouse/ClickHouse/issues/14275)。[#19016](https://github.com/ClickHouse/ClickHouse/pull/19016)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了向使用 `TinyLog` 引擎的表中插入 `LowCardinality` 列的问题。修复了 [#18629](https://github.com/ClickHouse/ClickHouse/issues/18629)。[#19010](https://github.com/ClickHouse/ClickHouse/pull/19010)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复 JOIN 中的一个小问题：`Join` 会尝试实体化常量列，但我们的代码会在其他地方等待这些列。[#18982](https://github.com/ClickHouse/ClickHouse/pull/18982)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 禁用 `optimize_move_functions_out_of_any`，因为该优化并不总是正确的。关闭了 [#18051](https://github.com/ClickHouse/ClickHouse/issues/18051)。关闭了 [#18973](https://github.com/ClickHouse/ClickHouse/issues/18973)。[#18981](https://github.com/ClickHouse/ClickHouse/pull/18981)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在合并查询计划中的 `Expression` 步骤时可能引发的异常 `QueryPipeline stream: different number of columns`。修复了 [#18190](https://github.com/ClickHouse/ClickHouse/issues/18190)。[#18980](https://github.com/ClickHouse/ClickHouse/pull/18980)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在关闭时极其罕见出现的死锁问题。[#18977](https://github.com/ClickHouse/ClickHouse/pull/18977) ([tavplubix](https://github.com/tavplubix)).
* 修复了服务器内存耗尽时偶发的崩溃问题。 [#18976](https://github.com/ClickHouse/ClickHouse/pull/18976) ([tavplubix](https://github.com/tavplubix)).
* 修复 `ALTER TABLE ... DROP PART 'part_name'` 查询会删除整个分区所有去重块这一错误行为。修复了 [#18874](https://github.com/ClickHouse/ClickHouse/issues/18874)。[#18969](https://github.com/ClickHouse/ClickHouse/pull/18969)（[alesapin](https://github.com/alesapin)）。
* 修复了问题 [#18894](https://github.com/ClickHouse/ClickHouse/issues/18894)，添加了检查，以避免在长列别名（`table.column` 样式，通常由 Looker 等 BI 工具自动生成）与长表名相同时抛出异常。[#18968](https://github.com/ClickHouse/ClickHouse/pull/18968)（[Daniel Qin](https://github.com/mathfool)）。
* 修复错误 `Task was not found in task queue`（仅可能在远程查询且 `async_socket_for_remote = 1` 时出现）。 [#18964](https://github.com/ClickHouse/ClickHouse/pull/18964) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复在包含某些转义文本的 `mutation`（例如 `ALTER ... UPDATE e = CAST('foo', 'Enum8(\'foo\' = 1')`）时出现的序列化错误。修复了 [#18878](https://github.com/ClickHouse/ClickHouse/issues/18878)。[#18944](https://github.com/ClickHouse/ClickHouse/pull/18944)（[alesapin](https://github.com/alesapin)）。
* ATTACH PARTITION 将会重置变更（mutations）。[#18804](https://github.com/ClickHouse/ClickHouse/issues/18804). [#18935](https://github.com/ClickHouse/ClickHouse/pull/18935) ([fastio](https://github.com/fastio)).
* 修复 `bitmapOrCardinality` 中可能导致空指针解引用的问题。关闭了 [#18911](https://github.com/ClickHouse/ClickHouse/issues/18911)。[#18912](https://github.com/ClickHouse/ClickHouse/pull/18912)（[sundyli](https://github.com/sundy-li)）。
* 修复了在尝试将 `NULL` 从 `Nullable(String)` `CAST` 为 `Nullable(Decimal(P, S))` 时出现的 `Attempt to read after eof` 错误。现在当 `CAST` 函数无法从可空字符串解析出 decimal 时会返回 `NULL`。修复了 [#7690](https://github.com/ClickHouse/ClickHouse/issues/7690)。[#18718](https://github.com/ClickHouse/ClickHouse/pull/18718)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复 MySQL 引擎中的数据类型转换问题。 [#18124](https://github.com/ClickHouse/ClickHouse/pull/18124) ([bo zeng](https://github.com/mis98zb)).
* 修复在仅执行 `select` 时导致 clickhouse-client 终止异常的问题。 [#19790](https://github.com/ClickHouse/ClickHouse/pull/19790) ([taiyang-li](https://github.com/taiyang-li)).

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-9}

- 在 CI 中运行 [SQLancer](https://twitter.com/RiggerManuel/status/1352345625480884228)(逻辑 SQL 模糊测试器)。[#19006](https://github.com/ClickHouse/ClickHouse/pull/19006) ([Ilya Yatsishin](https://github.com/qoega))。
- Query Fuzzer 将更全面地对新添加的测试进行模糊测试。此更改关闭了 [#18916](https://github.com/ClickHouse/ClickHouse/issues/18916)。[#19185](https://github.com/ClickHouse/ClickHouse/pull/19185) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 集成 [Big List of Naughty Strings](https://github.com/minimaxir/big-list-of-naughty-strings/) 以改进模糊测试。[#19480](https://github.com/ClickHouse/ClickHouse/pull/19480) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 添加使用 MSan 运行的集成测试。[#18974](https://github.com/ClickHouse/ClickHouse/pull/18974) ([alesapin](https://github.com/alesapin))。
- 修复了 cyrus-sasl 和 musl 中的 MemorySanitizer 错误。[#19821](https://github.com/ClickHouse/ClickHouse/pull/19821) ([Ilya Yatsishin](https://github.com/qoega))。
- `positionCaseInsensitiveUTF8` 函数中的参数检查不足触发了地址清理器。[#19720](https://github.com/ClickHouse/ClickHouse/pull/19720) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 在集成测试中移除 docker-compose 的 --project-directory 参数。修复来自 docker 容器的日志格式。[#19706](https://github.com/ClickHouse/ClickHouse/pull/19706) ([Ilya Yatsishin](https://github.com/qoega))。
- 简化了集成测试中 macros.xml 的生成。不再有来自 dicttoxml 的过多日志记录。dicttoxml 项目已经超过 5 年没有活跃维护了。[#19697](https://github.com/ClickHouse/ClickHouse/pull/19697) ([Ilya Yatsishin](https://github.com/qoega))。
- 允许通过环境变量 `CLICKHOUSE_WATCHDOG_ENABLE` 显式启用或禁用看门狗。默认情况下,如果服务器未连接到终端,则启用看门狗。[#19522](https://github.com/ClickHouse/ClickHouse/pull/19522) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 允许在 arm64 上构建支持 Kafka 的 ClickHouse。[#19369](https://github.com/ClickHouse/ClickHouse/pull/19369) ([filimonov](https://github.com/filimonov))。
- 允许在不使用 SSL 的情况下构建 librdkafka。[#19337](https://github.com/ClickHouse/ClickHouse/pull/19337) ([filimonov](https://github.com/filimonov))。
- 在 FreeBSD 构建中恢复 Kafka 输入。[#18924](https://github.com/ClickHouse/ClickHouse/pull/18924) ([Alexandre Snarskii](https://github.com/snar))。
- 修复表函数 `VALUES` 中潜在的空指针解引用问题。[#19357](https://github.com/ClickHouse/ClickHouse/pull/19357) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 避免 `arrayElement` 函数、`substring` 和 `arraySum` 中的 UBSan 报告。修复了 [#19305](https://github.com/ClickHouse/ClickHouse/issues/19305)。修复了 [#19287](https://github.com/ClickHouse/ClickHouse/issues/19287)。此更改关闭了 [#19336](https://github.com/ClickHouse/ClickHouse/issues/19336)。[#19347](https://github.com/ClickHouse/ClickHouse/pull/19347) ([alexey-milovidov](https://github.com/alexey-milovidov))。


## ClickHouse 21.1 版本 {#clickhouse-release-211}

### ClickHouse v21.1.3.32-stable 版本,2021-02-03 {#clickhouse-release-v211332-stable-2021-02-03}

#### Bug 修复 {#bug-fix-9}


* 修复 BloomFilter 索引导致的崩溃问题。修复了 [#19757](https://github.com/ClickHouse/ClickHouse/issues/19757)。[#19884](https://github.com/ClickHouse/ClickHouse/pull/19884)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复在将谓词下推到 `UNION DISTINCT` 子查询时发生的崩溃问题。修复了 [#19855](https://github.com/ClickHouse/ClickHouse/issues/19855)。[#19861](https://github.com/ClickHouse/ClickHouse/pull/19861)（[Amos Bird](https://github.com/amosbird)）。
* 修复对 `UInt8` 大于 127 的值进行过滤的问题。 [#19799](https://github.com/ClickHouse/ClickHouse/pull/19799) ([Anton Popov](https://github.com/CurtizJ))。
* 在此前的版本中，函数 `arrayEnumerateUniq` 的异常参数可能会导致崩溃或无限循环。此更改修复了 [#19787](https://github.com/ClickHouse/ClickHouse/issues/19787)。[#19788](https://github.com/ClickHouse/ClickHouse/pull/19788)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在对算术类型与字符串类型进行精确比较时出现的栈溢出问题。 [#19773](https://github.com/ClickHouse/ClickHouse/pull/19773) ([tavplubix](https://github.com/tavplubix)).
* 修复在 `WHERE` 或 `PREWHERE` 中使用嵌套列名时导致的崩溃。修复了 [#19755](https://github.com/ClickHouse/ClickHouse/issues/19755)。[#19763](https://github.com/ClickHouse/ClickHouse/pull/19763)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复 `bitmapAndnot` 函数中的段错误。修复了 [#19668](https://github.com/ClickHouse/ClickHouse/issues/19668)。[#19713](https://github.com/ClickHouse/ClickHouse/pull/19713)（[Maksim Kita](https://github.com/kitaisreal)）。
* 某些使用大整数的函数可能会导致段错误。大整数目前是实验性特性。本次修改关闭了 [#19667](https://github.com/ClickHouse/ClickHouse/issues/19667)。[#19672](https://github.com/ClickHouse/ClickHouse/pull/19672)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在 `LowCardinality` 参数情况下函数 `neighbor` 返回错误结果的问题。修复了 [#10333](https://github.com/ClickHouse/ClickHouse/issues/10333)。[#19617](https://github.com/ClickHouse/ClickHouse/pull/19617)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在断开连接后 `Connection` 中 `CompressedWriteBuffer` 的 use-after-free 错误。[#19599](https://github.com/ClickHouse/ClickHouse/pull/19599) ([Azat Khuzhin](https://github.com/azat))。
* `DROP/DETACH TABLE table ON CLUSTER cluster SYNC` 查询可能会挂起，现已修复。修复了 [#19568](https://github.com/ClickHouse/ClickHouse/issues/19568)。[#19572](https://github.com/ClickHouse/ClickHouse/pull/19572)（[tavplubix](https://github.com/tavplubix)）。
* 修复 `CREATE DICTIONARY` 查询中的 `id` 表达式。 [#19571](https://github.com/ClickHouse/ClickHouse/pull/19571) ([Maksim Kita](https://github.com/kitaisreal)).
* 修复在 `merge_tree_min_rows_for_concurrent_read`/`merge_tree_min_bytes_for_concurrent_read` 设置为 0 或 UINT64&#95;MAX 时出现的 SIGSEGV。 [#19528](https://github.com/ClickHouse/ClickHouse/pull/19528) ([Azat Khuzhin](https://github.com/azat)).
* 如果以特制参数调用 `addMonth` 函数，则在读取内存时可能发生缓冲区溢出。本次修改修复了 [#19441](https://github.com/ClickHouse/ClickHouse/issues/19441)。本次修改修复了 [#19413](https://github.com/ClickHouse/ClickHouse/issues/19413)。[#19472](https://github.com/ClickHouse/ClickHouse/pull/19472)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 如果将空字符串作为 IV 传入，`encrypt`/`decrypt` 函数中可能发生未初始化内存读取。此变更修复了 [#19391](https://github.com/ClickHouse/ClickHouse/issues/19391)。[#19397](https://github.com/ClickHouse/ClickHouse/pull/19397)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 Uber H3 库中可能出现的缓冲区溢出问题。参见 [https://github.com/uber/h3/issues/392](https://github.com/uber/h3/issues/392)。由此关闭 [#19219](https://github.com/ClickHouse/ClickHouse/issues/19219)。[#19383](https://github.com/ClickHouse/ClickHouse/pull/19383)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `system.parts` 的 `state` 列（由于顺序不正确，在查询该列时会触发 `LOGICAL_ERROR`）。[#19346](https://github.com/ClickHouse/ClickHouse/pull/19346) ([Azat Khuzhin](https://github.com/azat))。
* 修复了在 `materialized view` 与其目标表结构不同时进行聚合时，可能出现的结果错误或段错误。修复了 [#18063](https://github.com/ClickHouse/ClickHouse/issues/18063)。[#19322](https://github.com/ClickHouse/ClickHouse/pull/19322)（[tavplubix](https://github.com/tavplubix)）。
* 修复错误 `Cannot convert column now64() because it is constant but values of constants are different in source and result`。是对 [#7156](https://github.com/ClickHouse/ClickHouse/issues/7156) 的延续。[#19316](https://github.com/ClickHouse/ClickHouse/pull/19316)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在并发执行 `ALTER` 和 `DROP` 查询处理 ReplicatedMergeTree 表时可能发生的挂起问题。 [#19237](https://github.com/ClickHouse/ClickHouse/pull/19237) ([alesapin](https://github.com/alesapin)).
* 修复了通过 HTTP 接口使用 `Template` 或 `CustomSeparated` 格式插入数据时出现的 `There is no checkpoint` 错误。修复了 [#19021](https://github.com/ClickHouse/ClickHouse/issues/19021)。[#19072](https://github.com/ClickHouse/ClickHouse/pull/19072)（[tavplubix](https://github.com/tavplubix)）。
* 在分析阶段，当结果无法被计算时，禁用对子查询的常量折叠。 [#18446](https://github.com/ClickHouse/ClickHouse/pull/18446) ([Azat Khuzhin](https://github.com/azat)).
* 在执行 `MOVE` 或 `REPLACE PARTITION` 之后，或者在极少数情况下执行 `DETACH` 或 `DROP PARTITION` 之后，Mutation 可能会因为等待某个不存在的 part 而一直挂起。该问题已修复。[#15537](https://github.com/ClickHouse/ClickHouse/pull/15537) ([tavplubix](https://github.com/tavplubix))。

### ClickHouse 版本 v21.1.2.15-stable 2021-01-18 {#clickhouse-release-v211215-stable-2021-01-18}

#### 向后不兼容的变更 {#backward-incompatible-change-10}

- 设置 `input_format_null_as_default` 现已默认启用。[#17525](https://github.com/ClickHouse/ClickHouse/pull/17525) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 检查配置文件中 profile 设置的约束条件。如果 users.xml 包含不满足相应约束的设置,服务器将无法启动。[#18486](https://github.com/ClickHouse/ClickHouse/pull/18486) ([tavplubix](https://github.com/tavplubix))。
- 限制 `ALTER MODIFY SETTING` 修改影响数据部分的存储设置(`write_final_mark` 和 `enable_mixed_granularity_parts`)。[#18306](https://github.com/ClickHouse/ClickHouse/pull/18306) ([Amos Bird](https://github.com/amosbird))。
- 将 `insert_quorum_parallel` 默认设置为 1。这比"顺序"仲裁插入使用起来方便得多。但如果您依赖顺序一致性,应将该设置改回零。[#17567](https://github.com/ClickHouse/ClickHouse/pull/17567) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 移除 `sumburConsistentHash` 函数。这解决了 [#18120](https://github.com/ClickHouse/ClickHouse/issues/18120)。[#18656](https://github.com/ClickHouse/ClickHouse/pull/18656) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 移除聚合函数 `timeSeriesGroupSum`、`timeSeriesGroupRateSum`,因为有人反馈它们从未正常工作过。这修复了 [#16869](https://github.com/ClickHouse/ClickHouse/issues/16869)。如果您曾成功使用过这些函数,请发送电子邮件至 feedback@clickhouse.com。[#17423](https://github.com/ClickHouse/ClickHouse/pull/17423) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 禁止使用 toUnixTimestamp(Date())(之前它只是返回 Date 的 UInt16 表示)。[#17376](https://github.com/ClickHouse/ClickHouse/pull/17376) ([Azat Khuzhin](https://github.com/azat))。
- 允许在 `avg` 和 `avgWeighted` 函数中使用扩展整数类型(`Int128`、`Int256`、`UInt256`)。同时允许在 `avgWeighted` 函数中对值和权重使用不同类型(整数、十进制、浮点数)。这是一个向后不兼容的变更:现在 `avg` 和 `avgWeighted` 函数始终返回 `Float64`(如文档所述)。在此变更之前,`Decimal` 参数的返回类型也是 `Decimal`。[#15419](https://github.com/ClickHouse/ClickHouse/pull/15419) ([Mike](https://github.com/myrrc))。
- 表达式 `toUUID(N)` 不再有效。请替换为 `toUUID('00000000-0000-0000-0000-000000000000')`。此变更是由于当 N 非零时 `toUUID(N)` 的结果不明确。
- 具有不正确"密钥用途"的 SSL 证书将被拒绝。在以前的版本中它们可以正常工作。参见 [#19262](https://github.com/ClickHouse/ClickHouse/issues/19262)。
- 默认配置中移除了对替换文件(`/etc/metrika.xml`)的 `incl` 引用(`<remote_servers>`、`<zookeeper>`、`<macros>`、`<compression>`、`<networks>`)。如果您使用了替换文件并依赖这些隐式引用,应在更新前通过添加带有 `incl="..."` 属性的相应配置段手动显式地将它们添加回来。参见 [#18740](https://github.com/ClickHouse/ClickHouse/pull/18740) ([alexey-milovidov](https://github.com/alexey-milovidov))。

#### 新功能 {#new-feature-10}


* 在 ClickHouse 中实现 gRPC 协议。 [#15111](https://github.com/ClickHouse/ClickHouse/pull/15111) ([Vitaly Baranov](https://github.com/vitlibar))。
* 允许使用多个 ZooKeeper 集群。 [#17070](https://github.com/ClickHouse/ClickHouse/pull/17070) ([fastio](https://github.com/fastio)).
* 实现了 `REPLACE TABLE` 和 `CREATE OR REPLACE TABLE` 查询。[#18521](https://github.com/ClickHouse/ClickHouse/pull/18521) ([tavplubix](https://github.com/tavplubix))。
* 实现 `UNION DISTINCT`，并默认将普通的 `UNION` 子句视为 `UNION DISTINCT`。新增设置 `union_default_mode`，可将其改为按 `UNION ALL` 处理，或要求显式指定模式。 [#16338](https://github.com/ClickHouse/ClickHouse/pull/16338) ([flynn](https://github.com/ucasFL))。
* 新增函数 `accurateCastOrNull`。修复了 [#10290](https://github.com/ClickHouse/ClickHouse/issues/10290)。在 `x IN (subquery)` 表达式中添加类型转换。修复了 [#10266](https://github.com/ClickHouse/ClickHouse/issues/10266)。[#16724](https://github.com/ClickHouse/ClickHouse/pull/16724)（[Maksim Kita](https://github.com/kitaisreal)）。
* IP Dictionary 现已直接支持 `IPv4` / `IPv6` 类型。 [#17571](https://github.com/ClickHouse/ClickHouse/pull/17571) ([vdimir](https://github.com/vdimir)).
* IP Dictionary 支持按键获取。修复了 [#18241](https://github.com/ClickHouse/ClickHouse/issues/18241)。[#18480](https://github.com/ClickHouse/ClickHouse/pull/18480)（[vdimir](https://github.com/vdimir)）。
* 为数据导入和导出添加对 `*.zst` 压缩/解压缩的支持。这样可以在 `file()` 函数中使用 `*.zst`，并在 HTTP 客户端中使用 `Content-encoding: zstd`。修复了 [#16791 ](https://github.com/ClickHouse/ClickHouse/issues/16791)。[#17144](https://github.com/ClickHouse/ClickHouse/pull/17144)（[Abi Palagashvili](https://github.com/fibersel)）。
* 新增了 `mannWitneyUTest`、`studentTTest` 和 `welchTTest` 聚合函数，并对 `rankCorr` 做了一些重构。[#16883](https://github.com/ClickHouse/ClickHouse/pull/16883) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 新增函数 `countMatches`/`countMatchesCaseInsensitive`。 [#17459](https://github.com/ClickHouse/ClickHouse/pull/17459) ([Azat Khuzhin](https://github.com/azat))。
* 实现 `countSubstrings()`/`countSubstringsCaseInsensitive()`/`countSubstringsCaseInsensitiveUTF8()`（统计子串出现的次数）。 [#17347](https://github.com/ClickHouse/ClickHouse/pull/17347) ([Azat Khuzhin](https://github.com/azat)).
* 在 `system.query_log` 中添加所使用的数据库、表和列的信息，并新增 `query_kind` 和 `normalized_query_hash` 字段。[#17726](https://github.com/ClickHouse/ClickHouse/pull/17726) ([Amos Bird](https://github.com/amosbird))。
* 添加设置 `optimize_on_insert`。启用后，会对 `INSERT` 的数据块执行与对该数据块进行合并时相同的转换（例如 Replacing、Collapsing、Aggregating 等）。此设置默认启用。这可能会影响物化视图和 MaterializeMySQL 的行为（详见说明）。关闭了 [#10683](https://github.com/ClickHouse/ClickHouse/issues/10683)。[#16954](https://github.com/ClickHouse/ClickHouse/pull/16954)（[Kruglov Pavel](https://github.com/Avogar)）。
* HDFS 的 Kerberos 认证。[#16621](https://github.com/ClickHouse/ClickHouse/pull/16621) ([Ilya Golshtein](https://github.com/ilejn))。
* 支持使用 `SHOW SETTINGS` 语句查看 `system.settings` 中的参数。同时也支持 `SHOW CHANGED SETTINGS` 和 `LIKE/ILIKE` 子句。[#18056](https://github.com/ClickHouse/ClickHouse/pull/18056) ([Jianmei Zhang](https://github.com/zhangjmruc)).
* 函数 `position` 现在支持 `POSITION(needle IN haystack)` 语法，以提升 SQL 兼容性。相关问题 [#18701](https://github.com/ClickHouse/ClickHouse/issues/18701) 已关闭。... [#18779](https://github.com/ClickHouse/ClickHouse/pull/18779)（[Jianmei Zhang](https://github.com/zhangjmruc)）。
* 现在，我们为 MergeTree 系列表新增了一个存储设置 `max_partitions_to_read`，用于限制单个查询中最多可访问的分区数量。同时还增加了用户设置 `force_max_partition_limit`，用于强制执行这一限制。[#18712](https://github.com/ClickHouse/ClickHouse/pull/18712) ([Amos Bird](https://github.com/amosbird))。
* 为已插入的分区在 `system.part_log` 中添加 `query_id` 列。关闭 [#10097](https://github.com/ClickHouse/ClickHouse/issues/10097)。[#18644](https://github.com/ClickHouse/ClickHouse/pull/18644)（[flynn](https://github.com/ucasFL)）。
* 允许在指定列定义的情况下使用 `CREATE TABLE AS SELECT`。示例：`CREATE TABLE t1 (x String) ENGINE = Memory AS SELECT 1;`。[#18060](https://github.com/ClickHouse/ClickHouse/pull/18060)（[Maksim Kita](https://github.com/kitaisreal)）。
* 新增了 `arrayMin`、`arrayMax`、`arrayAvg` 聚合函数。[#18032](https://github.com/ClickHouse/ClickHouse/pull/18032)（[Maksim Kita](https://github.com/kitaisreal)）。
* 实现了 `ATTACH TABLE name FROM 'path/to/data/' (col1 Type1, ...` 查询。它会根据提供的表结构创建一个新表，并从 `user_files` 中指定的目录中加载并附加表数据。 [#17903](https://github.com/ClickHouse/ClickHouse/pull/17903) ([tavplubix](https://github.com/tavplubix))。
* 为 `StorageMemory` 增加变更（mutation）支持。解决了 [#9117](https://github.com/ClickHouse/ClickHouse/issues/9117)。[#15127](https://github.com/ClickHouse/ClickHouse/pull/15127)（[flynn](https://github.com/ucasFL)）。
* 支持 `EXISTS DATABASE name` 语法。 [#18458](https://github.com/ClickHouse/ClickHouse/pull/18458) ([Du Chuan](https://github.com/spongedu)).
* 支持与 [MySQL](https://github.com/ClickHouse/ClickHouse/compare/master...spongedu:support_is_ipv4?expand=1) 类似的内置函数 `isIPv4String` 和 `isIPv6String`。[#18349](https://github.com/ClickHouse/ClickHouse/pull/18349)（[Du Chuan](https://github.com/spongedu)）。
* 添加新设置 `insert_distributed_one_random_shard = 1`，以允许在没有任何分布式键的情况下向多分片的分布式表中插入数据。[#18294](https://github.com/ClickHouse/ClickHouse/pull/18294)（[Amos Bird](https://github.com/amosbird)）。
* 将 `min_compress_block_size` 和 `max_compress_block_size` 设置添加到 MergeTreeSettings 中，这些设置的优先级高于全局设置，且在显式配置后生效。关闭 [13890](https://github.com/ClickHouse/ClickHouse/issues/13890)。[#17867](https://github.com/ClickHouse/ClickHouse/pull/17867) ([flynn](https://github.com/ucasFL))。
* 添加对 64 位 Roaring 位图的支持。 [#17858](https://github.com/ClickHouse/ClickHouse/pull/17858) ([Andy Yang](https://github.com/andyyzh)).
* 扩展了 `OPTIMIZE ... DEDUPLICATE` 语法，允许显式指定（或通过星号/列转换器隐式指定）用于检查重复项的列列表。... [#17846](https://github.com/ClickHouse/ClickHouse/pull/17846) ([Vasily Nemkov](https://github.com/Enmk)).
* 新增了函数 `toModifiedJulianDay`、`fromModifiedJulianDay`、`toModifiedJulianDayOrNull` 和 `fromModifiedJulianDayOrNull`。这些函数在推前格里高利历日期与修正儒略日数之间进行转换。[#17750](https://github.com/ClickHouse/ClickHouse/pull/17750) ([PHO](https://github.com/depressed-pho))。
* 新增对自定义 TLD 列表的支持：增加函数 `firstSignificantSubdomainCustom`、`cutToFirstSignificantSubdomainCustom`。 [#17748](https://github.com/ClickHouse/ClickHouse/pull/17748) ([Azat Khuzhin](https://github.com/azat)).
* 为原生 TCP 接口新增对 `PROXYv1` 协议的支持。允许按代理转发的 IP 地址来设置配额键（适用于 `PROXYv1` 中的地址以及来自 HTTP 接口的 `X-Forwarded-For`）。当你仅通过可信代理（例如 CloudFlare）对外提供 ClickHouse 访问，但又希望按用户的原始 IP 地址统计其资源使用时，这将非常有用。修复了 [#17268](https://github.com/ClickHouse/ClickHouse/issues/17268)。[#17707](https://github.com/ClickHouse/ClickHouse/pull/17707)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 现在，clickhouse-client 支持通过 `Alt-Shift-E` 打开 `EDITOR` 来编辑命令。[#17665](https://github.com/ClickHouse/ClickHouse/pull/17665)（[Amos Bird](https://github.com/amosbird)）。
* 新增函数 `encodeXMLComponent`，用于转义字符，以便将字符串放入 XML 文本节点或属性中。[#17659](https://github.com/ClickHouse/ClickHouse/pull/17659) ([nauta](https://github.com/nautaa))。
* 引入 `DETACH TABLE/VIEW ... PERMANENTLY` 语法，这样在重启后表不会自动重新出现（只能通过显式请求恢复）。仍然可以使用简写语法 `ATTACH TABLE` 将该表重新附加回来。实现了 [#5555](https://github.com/ClickHouse/ClickHouse/issues/5555)，修复了 [#13850](https://github.com/ClickHouse/ClickHouse/issues/13850)。[#17642](https://github.com/ClickHouse/ClickHouse/pull/17642)（[filimonov](https://github.com/filimonov)）。
* 在 MergeTree 表中新增行数、字节数和分片总量的异步指标。此更改修复了 [#11714](https://github.com/ClickHouse/ClickHouse/issues/11714)。[#17639](https://github.com/ClickHouse/ClickHouse/pull/17639) ([flynn](https://github.com/ucasFL))。
* 为 SQL 外部分页新增 `limit` 和 `offset` 设置：[#16176](https://github.com/ClickHouse/ClickHouse/issues/16176) 它们在构建 API 时非常有用。这两个设置会影响 SELECT 查询，相当于在原始查询外再包一层：`select * from (your_original_select_query) t limit xxx offset xxx;`。[#17633](https://github.com/ClickHouse/ClickHouse/pull/17633) ([hexiaoting](https://github.com/hexiaoting))。
* 提供一个新的聚合器组合子：`-SimpleState`，用于在查询中构建 `SimpleAggregateFunction` 类型。它对于定义 `AggregatingMergeTree` 引擎的 `MaterializedView` 很有用，也将使投影（projections）受益。[#16853](https://github.com/ClickHouse/ClickHouse/pull/16853) ([Amos Bird](https://github.com/amosbird))。
* 为 `clickhouse-client` 和 `clickhouse-local` 新增 `queries-file` 参数。[#15930](https://github.com/ClickHouse/ClickHouse/pull/15930) ([Maksim Kita](https://github.com/kitaisreal)).
* 为 `clickhouse-benchmark` 增加了 `query` 参数。 [#17832](https://github.com/ClickHouse/ClickHouse/pull/17832) ([Maksim Kita](https://github.com/kitaisreal)).
* `EXPLAIN AST` 现在支持 `SELECT` 以外的其他查询。[#18136](https://github.com/ClickHouse/ClickHouse/pull/18136) ([taiyang-li](https://github.com/taiyang-li)).

#### 实验性功能 {#experimental-feature-8}

- 新增用于计算文本 n-gram 和 shingle 的 minHash 和 simHash 函数。这些函数用于半重复检测。同时还新增了 `bitHammingDistance` 和 `tupleHammingDistance` 函数。[#7649](https://github.com/ClickHouse/ClickHouse/pull/7649) ([flynn](https://github.com/ucasFL))。
- 新增 `Map` 数据类型。参见 [#1841](https://github.com/ClickHouse/ClickHouse/issues/1841)。Map 的首个版本仅支持 `String` 类型的键和值。[#15806](https://github.com/ClickHouse/ClickHouse/pull/15806) ([hexiaoting](https://github.com/hexiaoting))。
- 实现基于 ANTLR4 运行时的替代 SQL 解析器,该解析器由 EBNF 语法生成。[#11298](https://github.com/ClickHouse/ClickHouse/pull/11298) ([Ivan](https://github.com/abyss7))。

#### 性能改进 {#performance-improvement-10}


* 新的 IP Dictionary 实现，具有更低的内存占用、在某些场景下更高的性能，并修复了一些错误。[#16804](https://github.com/ClickHouse/ClickHouse/pull/16804) ([vdimir](https://github.com/vdimir))。
* 支持数据导出的并行格式化。 [#11617](https://github.com/ClickHouse/ClickHouse/pull/11617) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* LDAP 集成：在 LDAP 服务器连接配置中新增 `verification_cooldown` 参数，用于在可配置的时间段内缓存成功的 “bind” 尝试。[#15988](https://github.com/ClickHouse/ClickHouse/pull/15988) ([Denis Glazachev](https://github.com/traceon)).
* 为 `clickhouse-local` 添加 `--no-system-table` 选项，以在不加载 system 表的情况下运行。这样可以避免在启动时初始化 `DateLUT`，从而节省可能较为明显的时间开销（几十毫秒）。 [#18899](https://github.com/ClickHouse/ClickHouse/pull/18899) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 在 `AggregateFunctionWindowFunnelData` 中将 `PODArray` 替换为 `PODArrayWithStackMemory`，以提升 `windowFunnel` 函数的性能。 [#18817](https://github.com/ClickHouse/ClickHouse/pull/18817) ([flynn](https://github.com/ucasFL)).
* 在对 `Distributed` 表执行同步 `INSERT` 时，不再向分片发送空数据块。修复了 [#14571](https://github.com/ClickHouse/ClickHouse/issues/14571)。[#18775](https://github.com/ClickHouse/ClickHouse/pull/18775)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 `StorageMemory` 优化了读取。 [#18052](https://github.com/ClickHouse/ClickHouse/pull/18052) ([Maksim Kita](https://github.com/kitaisreal)).
* 使用 Dragonbox 算法替代 ryu 进行浮点数到字符串的转换，大幅提升了这一转换操作的性能。[#17831](https://github.com/ClickHouse/ClickHouse/pull/17831) ([Maksim Kita](https://github.com/kitaisreal))。
* 加快 `IPv6CIDRToRange` 的实现。 [#17569](https://github.com/ClickHouse/ClickHouse/pull/17569) ([vdimir](https://github.com/vdimir)).
* 添加 `remerge_sort_lowered_memory_bytes_ratio` 设置（如果重新合并后的内存使用量未按该比例降低，将禁用重新合并）。 [#17539](https://github.com/ClickHouse/ClickHouse/pull/17539) ([Azat Khuzhin](https://github.com/azat)).
* 改进在主键中使用 SimpleAggregateFunction(String) 时 AggregatingMergeTree 的性能。[#17109](https://github.com/ClickHouse/ClickHouse/pull/17109) ([Azat Khuzhin](https://github.com/azat)).
* 现在 `-If` 组合器已去虚拟化，`count` 也已正确向量化。此更改对应于 [这个 PR](https://github.com/ClickHouse/ClickHouse/pull/17041)。[#17043](https://github.com/ClickHouse/ClickHouse/pull/17043)（[Amos Bird](https://github.com/amosbird)）。
* 修复在存在大量 `MergeTree` 表时从 `Merge` 表读取时的性能问题。修复了 [#7748](https://github.com/ClickHouse/ClickHouse/issues/7748)。[#16988](https://github.com/ClickHouse/ClickHouse/pull/16988)（[Anton Popov](https://github.com/CurtizJ)）。
* 提升了 `repeat` 函数的性能。[#16937](https://github.com/ClickHouse/ClickHouse/pull/16937) ([satanson](https://github.com/satanson)).
* 略微提升了 `float` 解析性能。 [#16809](https://github.com/ClickHouse/ClickHouse/pull/16809) ([Maksim Kita](https://github.com/kitaisreal))。
* 为 `OPTIMIZE TABLE ... FINAL` 新增可跳过已合并分区的功能。[#15939](https://github.com/ClickHouse/ClickHouse/pull/15939) ([Kruglov Pavel](https://github.com/Avogar))。
* 集成 [Daniel Lemire 的 fast&#95;float](https://github.com/lemire/fast_float) 以解析浮点数。[#16787](https://github.com/ClickHouse/ClickHouse/pull/16787)（[Maksim Kita](https://github.com/kitaisreal)）。目前未启用，因为它的性能仍然低于 ClickHouse 中现有的快速浮点解析器。
* 修复 `max_distributed_connections`（影响 `prefer_localhost_replica = 1` 且 `max_threads != max_distributed_connections` 的情况）。[#17848](https://github.com/ClickHouse/ClickHouse/pull/17848)（[Azat Khuzhin](https://github.com/azat)）。
* 向 S3 发送数据时自适应选择单段/多段上传方式。单段上传由新增设置 `max_single_part_upload_size` 控制。[#17934](https://github.com/ClickHouse/ClickHouse/pull/17934) ([Pavel Kovalenko](https://github.com/Jokser))。
* 在 `PipelineExecutor` 中增加对异步任务的支持。为远程查询提供初始的异步套接字支持。[#17868](https://github.com/ClickHouse/ClickHouse/pull/17868)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 允许在列大小未知时，对紧凑部件使用 `optimize_move_to_prewhere` 优化。[#17330](https://github.com/ClickHouse/ClickHouse/pull/17330) ([Anton Popov](https://github.com/CurtizJ)).

#### 改进 {#improvement-10}


* 在对使用 `TinyLog` 或 `Log` 表引擎的表执行 `INSERT SELECT` 并将结果插入同一张表时，避免发生死锁。此更改关闭 [#6802](https://github.com/ClickHouse/ClickHouse/issues/6802)。此更改关闭 [#18691](https://github.com/ClickHouse/ClickHouse/issues/18691)。此更改关闭 [#16812](https://github.com/ClickHouse/ClickHouse/issues/16812)。此更改关闭 [#14570](https://github.com/ClickHouse/ClickHouse/issues/14570)。[#15260](https://github.com/ClickHouse/ClickHouse/pull/15260) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 支持与 [MySQL](https://dev.mysql.com/doc/refman/5.7/en/show-create-view.html) 类似的 `SHOW CREATE VIEW name` 语法。 [#18095](https://github.com/ClickHouse/ClickHouse/pull/18095) ([Du Chuan](https://github.com/spongedu)).
* 允许所有 `Decimal * Float`（或反过来）的查询类型，包括聚合查询（例如 `SELECT sum(decimal_field * 1.1)` 或 `SELECT dec_col * float_col`），其结果类型为 Float32 或 Float64。 [#18145](https://github.com/ClickHouse/ClickHouse/pull/18145) ([Mike](https://github.com/myrrc))。
* 改进精简版 Web UI：添加历史记录；添加分享功能；避免并发请求产生竞态条件；添加请求进行中和已就绪指示器；添加 favicon；在 `textarea` 不在焦点时也能检测 Ctrl+Enter。 [#17293](https://github.com/ClickHouse/ClickHouse/pull/17293) [#17770](https://github.com/ClickHouse/ClickHouse/pull/17770) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* clickhouse-server 未向 ZooKeeper 服务器发送 `close` 请求。[#16837](https://github.com/ClickHouse/ClickHouse/pull/16837) ([alesapin](https://github.com/alesapin))。
* 在内存限制过低（`max_memory_usage = 1` / `max_untracked_memory = 1`）的情况下，避免服务器异常退出。 [#17453](https://github.com/ClickHouse/ClickHouse/pull/17453) ([Azat Khuzhin](https://github.com/azat)).
* 修复在不同事件具有相同时间戳时 `windowFunnel` 函数产生非确定性结果的问题。[#18884](https://github.com/ClickHouse/ClickHouse/pull/18884)（[Fuwang Hu](https://github.com/fuwhu)）。
* Docker：在 clickhouse-server Docker 镜像中，将 clickhouse 用户和用户组的 uid/gid 显式设置为固定值 101。 [#19096](https://github.com/ClickHouse/ClickHouse/pull/19096) ([filimonov](https://github.com/filimonov)).
* 对 `Distributed` 表进行异步 `INSERT`：新增了两个设置（类似于 MergeTree 系列表）：- `fsync_after_insert` —— 对每次插入执行 fsync，这会降低插入性能。- `fsync_directories` —— 在完成所有操作（写入、重命名等）后，对临时目录（仅用于异步 INSERT）执行 fsync。[#18864](https://github.com/ClickHouse/ClickHouse/pull/18864) ([Azat Khuzhin](https://github.com/azat))。
* `SYSTEM KILL` 命令在 Docker 中开始工作。已关闭 [#18847](https://github.com/ClickHouse/ClickHouse/issues/18847)。[#18848](https://github.com/ClickHouse/ClickHouse/pull/18848)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在执行 `FETCH PARTITION` 时展开 ZooKeeper 路径中的宏。[#18839](https://github.com/ClickHouse/ClickHouse/pull/18839) ([fastio](https://github.com/fastio)).
* 对所有副本执行 `ALTER TABLE <replicated_table> ON CLUSTER MODIFY SETTING ...`，因为此类 ALTER 命令不会在副本之间复制。[#18789](https://github.com/ClickHouse/ClickHouse/pull/18789) ([Amos Bird](https://github.com/amosbird))。
* 允许列转换器 `EXCEPT` 接受字符串作为正则表达式匹配器。这解决了 [#18685](https://github.com/ClickHouse/ClickHouse/issues/18685)。[#18699](https://github.com/ClickHouse/ClickHouse/pull/18699)（[Amos Bird](https://github.com/amosbird)）。
* 修复 `SummingMergeTree` 中的 `SimpleAggregateFunction`，现在它的行为与 `AggregateFunction` 一致。在之前的版本中，值会被直接相加，而不考虑聚合函数本身。此修改修复了 [#18564](https://github.com/ClickHouse/ClickHouse/issues/18564)、[#8052](https://github.com/ClickHouse/ClickHouse/issues/8052)、[#18637](https://github.com/ClickHouse/ClickHouse/pull/18637)（[Amos Bird](https://github.com/amosbird)）。另外还修复了在 `SummingMergeTree` 中使用 `SimpleAggregateFunction` 的另一处问题，修复了 [#18676](https://github.com/ClickHouse/ClickHouse/issues/18676)、[#18677](https://github.com/ClickHouse/ClickHouse/pull/18677)（[Amos Bird](https://github.com/amosbird)）。
* 修复了当函数 `bar` 的最后一个参数为 NaN 时，分配器内部出现的断言错误。现在会抛出普通的 ClickHouse 异常。此更改修复了 [#17876](https://github.com/ClickHouse/ClickHouse/issues/17876)。[#18520](https://github.com/ClickHouse/ClickHouse/pull/18520)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 修复易用性问题：在某些工具中异常消息后没有换行符。 [#18444](https://github.com/ClickHouse/ClickHouse/pull/18444) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 新增支持在 `LowCardinality(Type)` 与 `Type` 之间互相修改主键和分区键列类型。同时新增支持将主键列类型从 `EnumX` 修改为 `IntX` 类型。修复了 [#5604](https://github.com/ClickHouse/ClickHouse/issues/5604)。[#18362](https://github.com/ClickHouse/ClickHouse/pull/18362)（[alesapin](https://github.com/alesapin)）。
* 实现对 `untuple` 的字段访问。[#18133](https://github.com/ClickHouse/ClickHouse/issues/18133)。[#18309](https://github.com/ClickHouse/ClickHouse/pull/18309)（[hexiaoting](https://github.com/hexiaoting)）。
* 允许从 CSV 中解析 `Array` 字段，如果该字段以字符串形式表示，且字符串中包含按嵌套 CSV 格式序列化的数组。例如：`"[""Hello"", ""world"", ""42"""" TV""]"` 将会被解析为 `['Hello', 'world', '42" TV']`。允许从 CSV 中解析以字符串形式给出的数组，即使字符串中不包含外层方括号。例如：`"'Hello', 'world', '42"" TV'"` 将会被解析为 `['Hello', 'world', '42" TV']`。[#18271](https://github.com/ClickHouse/ClickHouse/pull/18271) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 改进 MergeTree 宽部件的自适应粒度计算。[#18223](https://github.com/ClickHouse/ClickHouse/pull/18223) ([alesapin](https://github.com/alesapin))。
* 现在 `clickhouse install` 已可在 Mac 上使用。之前的问题是该平台上没有 procfs。[#18201](https://github.com/ClickHouse/ClickHouse/pull/18201)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 改进了对 `SHOW ...` 查询语法的提示。 [#18183](https://github.com/ClickHouse/ClickHouse/pull/18183) ([Du Chuan](https://github.com/spongedu)).
* 数组聚合函数 `arrayMin`、`arrayMax`、`arraySum`、`arrayAvg` 现已支持 `Int128`、`Int256`、`UInt256`。 [#18147](https://github.com/ClickHouse/ClickHouse/pull/18147) ([Maksim Kita](https://github.com/kitaisreal)).
* 在 Set 和 Join 存储设置中新增 `disk`。 [#18112](https://github.com/ClickHouse/ClickHouse/pull/18112) ([Grigory Pervakov](https://github.com/GrigoryPervakov))。
* 访问控制：现在表函数 `merge()` 要求当前用户对其获取数据的每个表都具有 `SELECT` 权限。此 PR 修复了 [#16964](https://github.com/ClickHouse/ClickHouse/issues/16964)。[#18104](https://github.com/ClickHouse/ClickHouse/pull/18104) [#17983](https://github.com/ClickHouse/ClickHouse/pull/17983)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 临时表现在只在其创建所在的会话中，于系统表 `system.tables` 和 `system.columns` 中可见。内部数据库 `_temporary_and_external_tables` 现在在这些系统表中被隐藏；临时表会显示为 `database` 为空且 `is_temporary` 标志已设置的表。[#18014](https://github.com/ClickHouse/ClickHouse/pull/18014)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复在终端窗口大小变化时 `clickhouse-client` 的渲染问题。 [#18009](https://github.com/ClickHouse/ClickHouse/pull/18009) ([Amos Bird](https://github.com/amosbird)).
* 当客户端断开连接时，将相关事件的日志级别从 Warning 降低为 Information。 [#18005](https://github.com/ClickHouse/ClickHouse/pull/18005) ([filimonov](https://github.com/filimonov)).
* 从文件系统中强制删除 DiskS3 的空或损坏元数据文件。S3 目前是实验性特性。[#17935](https://github.com/ClickHouse/ClickHouse/pull/17935)（[Pavel Kovalenko](https://github.com/Jokser)）。
* 访问控制：`allow_introspection_functions=0` 会禁止使用自省函数，但不再禁止为这些函数授予权限（被授权人需要自行将 `allow_introspection_functions` 设置为 1 才能使用该授权）。类似地，`allow_ddl=0` 会禁止使用 DDL 命令，但不再禁止为这些命令授予权限。[#17908](https://github.com/ClickHouse/ClickHouse/pull/17908) ([Vitaly Baranov](https://github.com/vitlibar))。
* 易用性改进：列名提示。 [#17112](https://github.com/ClickHouse/ClickHouse/issues/17112)。 [#17857](https://github.com/ClickHouse/ClickHouse/pull/17857) ([fastio](https://github.com/fastio))。
* 当两个 `Merge` 表尝试相互读取对方数据时，添加诊断信息。 [#17854](https://github.com/ClickHouse/ClickHouse/pull/17854) ([徐炘](https://github.com/weeds085490)).
* 允许在使用 ClickHouse Docker 镜像运行脚本时重写 `timeout` 值。[#17818](https://github.com/ClickHouse/ClickHouse/pull/17818) ([Guillaume Tassery](https://github.com/YiuRULE)).
* 检查系统日志表的 `ENGINE` 定义语法，以防止某些配置错误。需要注意的是，此语法检查不涉及语义层面，这意味着诸如不存在的列 / 表达式函数之类的错误，只有在实际创建表时才会被发现。 [#17739](https://github.com/ClickHouse/ClickHouse/pull/17739) ([Du Chuan](https://github.com/spongedu))。
* 移除了在初始化 `RabbitMQ` 表且没有连接时抛出异常的行为（现在会在后台自动重连）。 [#17709](https://github.com/ClickHouse/ClickHouse/pull/17709) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 在 Buffer 刷新期间不再忽略服务器内存限制。[#17646](https://github.com/ClickHouse/ClickHouse/pull/17646) ([Azat Khuzhin](https://github.com/azat))。
* 切换到修补后的 RocksDB 版本（来自 ClickHouse-Extras），以修复 use-after-free 错误。 [#17643](https://github.com/ClickHouse/ClickHouse/pull/17643) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 为并行解析的异常消息添加了偏移量。修复了 [#17457](https://github.com/ClickHouse/ClickHouse/issues/17457)。[#17641](https://github.com/ClickHouse/ClickHouse/pull/17641)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 在执行 INSERT 查询过程中不再在中途抛出 “Too many parts” 错误。[#17566](https://github.com/ClickHouse/ClickHouse/pull/17566) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 在 `ALTER` 查询的 `UPDATE` 语句中允许使用查询参数。修复了 [#10976](https://github.com/ClickHouse/ClickHouse/issues/10976)。[#17563](https://github.com/ClickHouse/ClickHouse/pull/17563)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 查询混淆器：避免将某些 SQL 关键字用作标识符名称。 [#17526](https://github.com/ClickHouse/ClickHouse/pull/17526) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 通过服务器指标导出由 DDLWorker 执行的当前最大 DDL 条目。可用于检查 DDLWorker 是否在某处发生卡顿。[#17464](https://github.com/ClickHouse/ClickHouse/pull/17464) ([Amos Bird](https://github.com/amosbird))。
* 导出所有服务器当前线程的异步指标。这有助于排查[此类问题](https://github.com/ClickHouse-Extras/poco/pull/28)。[#17463](https://github.com/ClickHouse/ClickHouse/pull/17463)（[Amos Bird](https://github.com/amosbird)）。
* 在将 `asterisk_include_materialized_columns` 和 `asterisk_include_alias_columns` 设置为开启时，在通配符查询中包含 MATERIALIZED / ALIAS 等动态列。 [#17462](https://github.com/ClickHouse/ClickHouse/pull/17462) ([Ken Chen](https://github.com/chenziliang)).
* 允许在 `config.xml` 中使用 `<ttl>` 属性为[系统日志表](/operations/system-tables/)指定 [TTL](/engines/table-engines/mergetree-family/mergetree/#mergetree-table-ttl)，以删除旧记录。[#17438](https://github.com/ClickHouse/ClickHouse/pull/17438)（[Du Chuan](https://github.com/spongedu)）。
* 现在，通过 MySQL 和 PostgreSQL 协议发送到服务器的查询具有各自不同的接口类型（可在表 `system.query_log` 的 `interface` 列中查看）：MySQL 为 `4`，PostgreSQL 为 `5`，而此前使用的 `1` 现仅用于原生协议。[#17437](https://github.com/ClickHouse/ClickHouse/pull/17437)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复 `INSERT ... SELECT ... SETTINGS` 查询中 `SETTINGS` 子句的解析。 [#17414](https://github.com/ClickHouse/ClickHouse/pull/17414) ([Azat Khuzhin](https://github.com/azat)).
* 在 RadixSort 中正确计算内存使用情况。[#17412](https://github.com/ClickHouse/ClickHouse/pull/17412) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 在服务器的 `receiveHello` 中增加 EOF 检查，以防止出现 `Attempt to read after eof` 异常。[#17365](https://github.com/ClickHouse/ClickHouse/pull/17365)（[Kruglov Pavel](https://github.com/Avogar)）。
* 在 bigint 转换中避免可能的栈溢出。大整数功能为实验性特性。[#17269](https://github.com/ClickHouse/ClickHouse/pull/17269) ([flynn](https://github.com/ucasFL))。
* 现在 `set` 索引可以与 `GLOBAL IN` 一起配合使用了。此更改修复了 [#17232](https://github.com/ClickHouse/ClickHouse/issues/17232)、[#5576](https://github.com/ClickHouse/ClickHouse/issues/5576)。[#17253](https://github.com/ClickHouse/ClickHouse/pull/17253)（[Amos Bird](https://github.com/amosbird)）。
* 在向 S3 存储发送请求时，为 HTTP 重定向次数添加上限（`s3_max_redirects`）。[#17220](https://github.com/ClickHouse/ClickHouse/pull/17220)（[ianton-ru](https://github.com/ianton-ru)）。
* 当 `-OrNull` 组合器与 `-If`、`-Merge`、`-MergeState`、`-State` 等组合器一起使用时，应将 `-OrNull` 放在最前面。 [#16935](https://github.com/ClickHouse/ClickHouse/pull/16935) ([flynn](https://github.com/ucasFL)).
* 支持配置 HTTP 代理和 HTTPS S3 终端节点。 [#16861](https://github.com/ClickHouse/ClickHouse/pull/16861) ([Pavel Kovalenko](https://github.com/Jokser)).
* 为 S3 客户端新增了基于环境变量、`~/.aws` 和 `AssumeRole` 的正确身份验证支持。[#16856](https://github.com/ClickHouse/ClickHouse/pull/16856) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 添加更多 OpenTelemetry span。添加一个将 span 数据导出到 Zipkin 的示例。[#16535](https://github.com/ClickHouse/ClickHouse/pull/16535) ([Alexander Kuzmenkov](https://github.com/akuzm))。
* 缓存字典：在获取缓存字典时彻底取消回调和加锁。键不再区分“未找到”和“已过期”，而是在查询期间统一存储在同一个映射中。[#14958](https://github.com/ClickHouse/ClickHouse/pull/14958) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 修复从未起作用的 `fsync_part_directory`/`fsync_after_insert`/`in_memory_parts_insert_sync`（实验性功能）。 [#18845](https://github.com/ClickHouse/ClickHouse/pull/18845) ([Azat Khuzhin](https://github.com/azat)).
* 允许在 `MaterializeMySQL` 引擎的内部数据库中使用 `Atomic` 引擎。 [#14849](https://github.com/ClickHouse/ClickHouse/pull/14849) ([tavplubix](https://github.com/tavplubix)).

#### 错误修复 {#bug-fix-10}


* 修复一个在极少数情况下服务器可能会停止接受连接的问题。[#17542](https://github.com/ClickHouse/ClickHouse/pull/17542) (Amos Bird, [alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复对含有常量参数的二元函数的索引分析问题，该问题会导致错误的查询结果。此修复解决了 [#18364](https://github.com/ClickHouse/ClickHouse/issues/18364)。[#18373](https://github.com/ClickHouse/ClickHouse/pull/18373)（[Amos Bird](https://github.com/amosbird)）。
* 修复在索引比较两侧类型不同时可能出现的错误索引分析。此更改修复了 [#17122](https://github.com/ClickHouse/ClickHouse/issues/17122)。[#17145](https://github.com/ClickHouse/ClickHouse/pull/17145)（[Amos Bird](https://github.com/amosbird)）。
* 在合并过程中禁用使用 AIO 的写入，因为这在极其罕见的情况下可能会导致主键列数据损坏。 [#18481](https://github.com/ClickHouse/ClickHouse/pull/18481) ([alesapin](https://github.com/alesapin))。
* 限制从宽格式部分到紧凑部分的合并。在垂直合并的情况下，这会导致生成的部分损坏。[#18381](https://github.com/ClickHouse/ClickHouse/pull/18381) ([Anton Popov](https://github.com/CurtizJ))。
* 修复在发生读退避（日志中出现消息 `<Debug> MergeTreeReadPool: Will lower number of threads`）时，从 `MergeTree*` 读取可能导致查询结果不完整的问题。该问题是在 [#16423](https://github.com/ClickHouse/ClickHouse/issues/16423) 中引入的。本次修复解决了 [#18137](https://github.com/ClickHouse/ClickHouse/issues/18137)。[#18216](https://github.com/ClickHouse/ClickHouse/pull/18216)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复 `rocksdb` 库中的 use-after-free 错误。[#18862](https://github.com/ClickHouse/ClickHouse/pull/18862) ([sundyli](https://github.com/sundy-li))。
* 修复以 `ORC` 格式从文件进行无限读取的问题（该问题是在 [#10580](https://github.com/ClickHouse/ClickHouse/issues/10580) 中引入的）。修复了 [#19095](https://github.com/ClickHouse/ClickHouse/issues/19095)。[#19134](https://github.com/ClickHouse/ClickHouse/pull/19134)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复 `MergeTree` 数据写入器中的一个错误，该错误可能导致生成的 `mark` 大小超过固定粒度大小。修复了 [#18913](https://github.com/ClickHouse/ClickHouse/issues/18913)。[#19123](https://github.com/ClickHouse/ClickHouse/pull/19123)（[alesapin](https://github.com/alesapin)）。
* 修复了启动时的错误：ClickHouse 无法从 `LowCardinality(Nullable(...))` 中读取压缩编解码器并抛出异常 `Attempt to read after EOF`。修复了 [#18340](https://github.com/ClickHouse/ClickHouse/issues/18340)。[#19101](https://github.com/ClickHouse/ClickHouse/pull/19101)（[alesapin](https://github.com/alesapin)）。
* 限制对使用旧语法创建的 `MergeTree` 表执行 `MODIFY TTL` 查询。此前这些查询虽然会成功执行，但实际上并不会产生任何效果。[#19064](https://github.com/ClickHouse/ClickHouse/pull/19064) ([Anton Popov](https://github.com/CurtizJ)).
* 确保 `groupUniqArray` 对 Enum 类型参数返回正确的类型。此更改修复了 [#17875](https://github.com/ClickHouse/ClickHouse/issues/17875)。[#19019](https://github.com/ClickHouse/ClickHouse/pull/19019)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在将函数 `ignore` 与 `LowCardinality` 类型参数一起使用时，可能出现的 `Expected single dictionary argument for function` 错误。修复了 [#14275](https://github.com/ClickHouse/ClickHouse/issues/14275)。[#19016](https://github.com/ClickHouse/ClickHouse/pull/19016)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了向使用 `TinyLog` 引擎的表中插入 `LowCardinality` 列的问题。修复了 [#18629](https://github.com/ClickHouse/ClickHouse/issues/18629)。[#19010](https://github.com/ClickHouse/ClickHouse/pull/19010)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `JOIN` 会尝试物化 `const` 列，但我们的代码期望它们出现在其他位置。[#18982](https://github.com/ClickHouse/ClickHouse/pull/18982) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 禁用 `optimize_move_functions_out_of_any`，因为该优化并不总是正确的。修复了 [#18051](https://github.com/ClickHouse/ClickHouse/issues/18051)。修复了 [#18973](https://github.com/ClickHouse/ClickHouse/issues/18973)。[#18981](https://github.com/ClickHouse/ClickHouse/pull/18981)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在合并查询计划中的 `Expression` 步骤时可能出现的异常 `QueryPipeline stream: different number of columns`。修复 [#18190](https://github.com/ClickHouse/ClickHouse/issues/18190)。[#18980](https://github.com/ClickHouse/ClickHouse/pull/18980)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了关闭时极少出现的死锁问题。[#18977](https://github.com/ClickHouse/ClickHouse/pull/18977) ([tavplubix](https://github.com/tavplubix)).
* 修复了在执行 `ALTER TABLE ... DROP PART 'part_name'` 查询时会错误地删除整个分区所有去重块的问题。修复了 [#18874](https://github.com/ClickHouse/ClickHouse/issues/18874)。[#18969](https://github.com/ClickHouse/ClickHouse/pull/18969)（[alesapin](https://github.com/alesapin)）。
* 附加分区时应重置变更。 [#18804](https://github.com/ClickHouse/ClickHouse/issues/18804)。 [#18935](https://github.com/ClickHouse/ClickHouse/pull/18935) ([fastio](https://github.com/fastio))。
* 修复 `bitmapOrCardinality` 中可能导致空指针解引用的问题。修复对应的 issue [#18911](https://github.com/ClickHouse/ClickHouse/issues/18911)。[#18912](https://github.com/ClickHouse/ClickHouse/pull/18912)（[sundyli](https://github.com/sundy-li)）。
* 修复 `clickhouse-local` 在关闭时可能出现的卡死问题。修复了 [#18891](https://github.com/ClickHouse/ClickHouse/issues/18891)。[#18893](https://github.com/ClickHouse/ClickHouse/pull/18893)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 针对外部数据库（MySQL、ODBC、JDBC）的查询，如果包含形如 `x IN table` 的表达式，会被错误地重写。此更改修复了 [#9756](https://github.com/ClickHouse/ClickHouse/issues/9756)。[#18876](https://github.com/ClickHouse/ClickHouse/pull/18876)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复用于一元函数和 `Nullable` 类型的 `If` 组合器。[#18806](https://github.com/ClickHouse/ClickHouse/pull/18806) ([Azat Khuzhin](https://github.com/azat))。
* 修复了当全局将 `network_compression_method` 设置为非默认值时，异步分布式 INSERT 可能会被服务器拒绝的问题。此修复解决了 [#18741](https://github.com/ClickHouse/ClickHouse/issues/18741)。[#18776](https://github.com/ClickHouse/ClickHouse/pull/18776)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在尝试将 `NULL` 从 `Nullable(String)` `CAST` 为 `Nullable(Decimal(P, S))` 时出现的 `Attempt to read after eof` 错误。现在当 `CAST` 函数无法从可空字符串解析出小数时，会返回 `NULL`。修复了 [#7690](https://github.com/ClickHouse/ClickHouse/issues/7690)。[#18718](https://github.com/ClickHouse/ClickHouse/pull/18718)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复日志记录中的小问题。[#18717](https://github.com/ClickHouse/ClickHouse/pull/18717) ([sundyli](https://github.com/sundy-li)).
* 修复了使用旧语法创建的 `ReplicatedMergeTree` 表中删除空数据分片的行为。修复了 [#18582](https://github.com/ClickHouse/ClickHouse/issues/18582)。[#18614](https://github.com/ClickHouse/ClickHouse/pull/18614)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复此前在日期溢出且取值不同情况下的错误。将 `Date` 的取值上限严格限制为 &quot;2106-02-07&quot;，并将大于 &quot;2106-02-07&quot; 的日期转换为值 0。[#18565](https://github.com/ClickHouse/ClickHouse/pull/18565) ([hexiaoting](https://github.com/hexiaoting)).
* 为从 MySQL 复制添加对 `FixedString` 数据类型的支持。从 MySQL 复制是一个实验性功能。此补丁修复了 [#18450](https://github.com/ClickHouse/ClickHouse/issues/18450)，并同时修复了 [#6556](https://github.com/ClickHouse/ClickHouse/issues/6556)。[#18553](https://github.com/ClickHouse/ClickHouse/pull/18553)（[awesomeleo](https://github.com/awesomeleo)）。
* 修复在包含 `RIGHT` 或 `FULL` join 的子查询之后使用 `ORDER BY` 时可能出现的 `Pipeline stuck` 错误。[#18550](https://github.com/ClickHouse/ClickHouse/pull/18550) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复了一个错误，该错误可能会导致在终止相应变更后 `ALTER` 查询挂起。由线程模糊测试器发现。[#18518](https://github.com/ClickHouse/ClickHouse/pull/18518) ([alesapin](https://github.com/alesapin)).
* 在 `parseDateTimeBestEffort` 函数中正确支持 12AM。修复了 [#18402](https://github.com/ClickHouse/ClickHouse/issues/18402)。[#18449](https://github.com/ClickHouse/ClickHouse/pull/18449)（[vladimir-golovchenko](https://github.com/vladimir-golovchenko)）。
* 修复了在对参数类型为 `Nullable(String)` 的值执行 `toType(...)` 函数（如 `toDate`、`toUInt32` 等）时出现的 `value is too short` 错误。现在，此类函数在解析出错时会返回 `NULL`，而不是抛出异常。修复了 [#7673](https://github.com/ClickHouse/ClickHouse/issues/7673)。[#18445](https://github.com/ClickHouse/ClickHouse/pull/18445)（[tavplubix](https://github.com/tavplubix)）。
* 修复 `SHOW TABLES` 的意外行为。[#18431](https://github.com/ClickHouse/ClickHouse/pull/18431)（[fastio](https://github.com/fastio)）。
* 修复 `-SimpleState` 组合器生成不兼容的参数类型和返回类型的问题。[#18404](https://github.com/ClickHouse/ClickHouse/pull/18404)（[Amos Bird](https://github.com/amosbird)）。
* 修复在并发使用 `Set` 或 `Join` 表并同时从 `system.tables` 查询时可能出现的竞态条件。[#18385](https://github.com/ClickHouse/ClickHouse/pull/18385) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复填充表 `system.settings_profile_elements` 的逻辑。此 PR 修复了 [#18231](https://github.com/ClickHouse/ClickHouse/issues/18231)。[#18379](https://github.com/ClickHouse/ClickHouse/pull/18379)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复在使用双层聚合时，带有 `Distinct` 组合器的聚合函数中可能发生的崩溃。修复 [#17682](https://github.com/ClickHouse/ClickHouse/issues/17682)。[#18365](https://github.com/ClickHouse/ClickHouse/pull/18365)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复了在具有 IPv4/IPv6 双栈的机器上，服务器无法访问 `clickhouse-odbc-bridge` 进程的问题；修复了因使用格式错误的查询执行 ODBC 字典更新而导致 odbc-bridge 进程崩溃的问题；可能关闭 [#14489](https://github.com/ClickHouse/ClickHouse/issues/14489)。[#18278](https://github.com/ClickHouse/ClickHouse/pull/18278)（[Denis Glazachev](https://github.com/traceon)）。
* 访问控制：现在只要用户对表中至少一列具有访问权限，就可以执行 `SELECT count() FROM table`。该 PR 修复了 [#10639](https://github.com/ClickHouse/ClickHouse/issues/10639)。[#18233](https://github.com/ClickHouse/ClickHouse/pull/18233)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 访问控制：现在执行 `SELECT JOIN` 需要对每个参与关联的表都拥有 `SELECT` 权限。此 PR 修复了 [#17654](https://github.com/ClickHouse/ClickHouse/issues/17654)。[#18232](https://github.com/ClickHouse/ClickHouse/pull/18232)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复 `Enum` 与 `Int` 类型之间的键比较问题。修复了 [#17989](https://github.com/ClickHouse/ClickHouse/issues/17989)。[#18214](https://github.com/ClickHouse/ClickHouse/pull/18214)（[Amos Bird](https://github.com/amosbird)）。
* 从 MySQL 进行复制（实验性功能）。修复 [#18186](https://github.com/ClickHouse/ClickHouse/issues/18186)，修复 [#16372](https://github.com/ClickHouse/ClickHouse/issues/16372)，修复 MaterializeMySQL 数据库引擎中唯一键转换问题。[#18211](https://github.com/ClickHouse/ClickHouse/pull/18211)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复在同时使用 `WITH FILL` 和 `WITH TIES` 时查询结果不一致的问题 [#17466](https://github.com/ClickHouse/ClickHouse/issues/17466)。[#18188](https://github.com/ClickHouse/ClickHouse/pull/18188) ([hexiaoting](https://github.com/hexiaoting))。
* 修复在最后一列解析出错时插入默认值行的行为。修复了 [#17712](https://github.com/ClickHouse/ClickHouse/issues/17712)。[#18182](https://github.com/ClickHouse/ClickHouse/pull/18182)（[Jianmei Zhang](https://github.com/zhangjmruc)）。
* 修复在尝试设置设置配置集时出现的 `Unknown setting profile` 错误。[#18167](https://github.com/ClickHouse/ClickHouse/pull/18167) ([tavplubix](https://github.com/tavplubix)).
* 修复了查询 `MODIFY COLUMN ... REMOVE TTL` 未实际移除列 TTL 的错误。 [#18130](https://github.com/ClickHouse/ClickHouse/pull/18130) ([alesapin](https://github.com/alesapin)).
* 修复了解析 S3 URL 时出现的 `std::out_of_range: basic_string` 错误。[#18059](https://github.com/ClickHouse/ClickHouse/pull/18059) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 修复 `DateTime64` 与 `Date` 的比较行为。修复了 [#13804](https://github.com/ClickHouse/ClickHouse/issues/13804) 和 [#11222](https://github.com/ClickHouse/ClickHouse/issues/11222)。... [#18050](https://github.com/ClickHouse/ClickHouse/pull/18050)（[Vasily Nemkov](https://github.com/Enmk)）。
* 从 MySQL 复制（实验性特性）：修复 [#15187](https://github.com/ClickHouse/ClickHouse/issues/15187)、[#17912](https://github.com/ClickHouse/ClickHouse/issues/17912)，并为 `MaterializeMySQL` 提供对 MySQL 前缀索引转换的支持。[#17944](https://github.com/ClickHouse/ClickHouse/pull/17944) ([Winter Zhang](https://github.com/zhang2014))。
* 当使用 `logger.size` 参数并将其设置为大于 2^32 的数值来配置服务器日志轮转时，日志不会正确轮转。此问题已修复。 [#17905](https://github.com/ClickHouse/ClickHouse/pull/17905) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* 如果查询包含 `ARRAY JOIN`（因此查询实际上并非简单查询），则琐碎查询优化会产生错误结果。 [#17887](https://github.com/ClickHouse/ClickHouse/pull/17887) ([sundyli](https://github.com/sundy-li))。
* 修复 `topK` 聚合函数中可能出现的段错误。修复内容见 [#17404](https://github.com/ClickHouse/ClickHouse/issues/17404)。[#17845](https://github.com/ClickHouse/ClickHouse/pull/17845)（[Maksim Kita](https://github.com/kitaisreal)）。
* WAL（实验特性）：如果禁用了 `in_memory_parts_enable_wal`，则不要从 WAL 恢复数据分片（parts）。[#17802](https://github.com/ClickHouse/ClickHouse/pull/17802) ([detailyang](https://github.com/detailyang))。
* 关于可删除的最大表大小的异常消息显示不正确。[#17764](https://github.com/ClickHouse/ClickHouse/pull/17764) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复了在向 `Distributed` 表插入数据时，由于空间不足而可能发生的段错误。[#17737](https://github.com/ClickHouse/ClickHouse/pull/17737) ([tavplubix](https://github.com/tavplubix))。
* 修复了 ClickHouse 无法重新建立与 MySQL 服务器连接的问题。 [#17681](https://github.com/ClickHouse/ClickHouse/pull/17681) ([Alexander Kazakov](https://github.com/Akazz)).
* Windows：修复了在 Windows Subsystem for Linux 上运行 ClickHouse 时，在 `Atomic` 数据库中执行 `RENAME` 查询会出现的 `Function not implemented` 错误。修复了 [#17661](https://github.com/ClickHouse/ClickHouse/issues/17661)。[#17664](https://github.com/ClickHouse/ClickHouse/pull/17664)（[tavplubix](https://github.com/tavplubix)）。
* 在执行 `ON CLUSTER` 查询时，如果 `pool_size` &gt; 1，由于竞争条件，可能会错误地判断集群是否为环形（交叉）复制集群。该问题已修复。[#17640](https://github.com/ClickHouse/ClickHouse/pull/17640) ([tavplubix](https://github.com/tavplubix))。
* 修复服务器以守护进程模式运行时 `system.stack_trace` 表为空的问题。[#17630](https://github.com/ClickHouse/ClickHouse/pull/17630) ([Amos Bird](https://github.com/amosbird))。
* 异常 `fmt::v7::format_error` 可能会在 MergeTree 表的后台任务中被记录到日志。此更改修复了 [#17613](https://github.com/ClickHouse/ClickHouse/issues/17613)。[#17615](https://github.com/ClickHouse/ClickHouse/pull/17615)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在交互模式下使用 `clickhouse-client` 执行多行查询时，单行注释会被错误地延伸至整个查询的末尾。此更改修复了 [#13654](https://github.com/ClickHouse/ClickHouse/issues/13654)。[#17565](https://github.com/ClickHouse/ClickHouse/pull/17565)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了当对应的 `mutation` 在其他副本上被终止时导致 `ALTER` 查询挂起的问题。修复了 [#16953](https://github.com/ClickHouse/ClickHouse/issues/16953)。[#17499](https://github.com/ClickHouse/ClickHouse/pull/17499)（[alesapin](https://github.com/alesapin)）。
* 修复了在 ClickHouse 低估 `mark cache` 大小时出现的内存计量问题。当存在大量带有 `marks` 的小文件时可能会出现这种情况。[#17496](https://github.com/ClickHouse/ClickHouse/pull/17496) ([alesapin](https://github.com/alesapin))。
* 修复在启用设置 `optimize_redundant_functions_in_order_by` 时的 `ORDER BY`。 [#17471](https://github.com/ClickHouse/ClickHouse/pull/17471) ([Anton Popov](https://github.com/CurtizJ)).
* 修复由于错误优化导致在执行 `DISTINCT` 后仍可能出现的重复数据。修复 [#17294](https://github.com/ClickHouse/ClickHouse/issues/17294)。[#17296](https://github.com/ClickHouse/ClickHouse/pull/17296)（[li chengxiang](https://github.com/chengxianglibra)）。[#17439](https://github.com/ClickHouse/ClickHouse/pull/17439)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了 *MergeTree 表后台任务中 CPU 占用率过高的问题。[#17416](https://github.com/ClickHouse/ClickHouse/pull/17416) ([tavplubix](https://github.com/tavplubix)).
* 修复从包含 `LowCardinality` 类型的 `JOIN` 表读取数据时可能发生的崩溃。修复 [#17228](https://github.com/ClickHouse/ClickHouse/issues/17228)。[#17397](https://github.com/ClickHouse/ClickHouse/pull/17397)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 从 MySQL 进行复制（实验性功能）：修复 [#16835](https://github.com/ClickHouse/ClickHouse/issues/16835)，尝试修复与 MySQL `SHOW` 语句的表头不匹配问题。[#17366](https://github.com/ClickHouse/ClickHouse/pull/17366)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复谓词优化器中非确定性函数的问题。此更改修复了 [#17244](https://github.com/ClickHouse/ClickHouse/issues/17244)。[#17273](https://github.com/ClickHouse/ClickHouse/pull/17273)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复在带有 `LIMIT` 的 Distributed 查询中可能出现的 `Unexpected packet Data received from client` 错误。[#17254](https://github.com/ClickHouse/ClickHouse/pull/17254) ([Azat Khuzhin](https://github.com/azat))。
* 修复了当子查询中存在 `const` 列时 `set` 索引失效的问题。此修复解决了 [#17246](https://github.com/ClickHouse/ClickHouse/issues/17246)。[#17249](https://github.com/ClickHouse/ClickHouse/pull/17249)（[Amos Bird](https://github.com/amosbird)）。
* clickhouse-copier：修复对非分区表的处理 [#15235](https://github.com/ClickHouse/ClickHouse/issues/15235)。[#17248](https://github.com/ClickHouse/ClickHouse/pull/17248)（[Qi Chen](https://github.com/kaka11chen)）。
* 修复了存储在 S3 磁盘上的数据片段上可能无法生效的 `MUTATION` 操作（实验特性）。 [#17227](https://github.com/ClickHouse/ClickHouse/pull/17227) ([Pavel Kovalenko](https://github.com/Jokser)).
* 修复函数 `fuzzBits` 的 Bug，相关 issue：[#16980](https://github.com/ClickHouse/ClickHouse/issues/16980)。[#17051](https://github.com/ClickHouse/ClickHouse/pull/17051)（[hexiaoting](https://github.com/hexiaoting)）。
* 修复仅包含 OFFSET 的查询中 `optimize_distributed_group_by_sharding_key` 的问题。 [#16996](https://github.com/ClickHouse/ClickHouse/pull/16996) ([Azat Khuzhin](https://github.com/azat)).
* 修复在 `Distributed` 表（带有 JOIN）之上执行的 `Merge` 表查询。 [#16993](https://github.com/ClickHouse/ClickHouse/pull/16993) ([Azat Khuzhin](https://github.com/azat))。
* 修复涉及单调函数的 `ORDER BY` 优化。修复了 [#16107](https://github.com/ClickHouse/ClickHouse/issues/16107)。[#16956](https://github.com/ClickHouse/ClickHouse/pull/16956)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复了具有不同 scale 的 `DateTime64` 类型之间比较不正确的问题。修复了 [#16655](https://github.com/ClickHouse/ClickHouse/issues/16655) ... [#16952](https://github.com/ClickHouse/ClickHouse/pull/16952)（[Vasily Nemkov](https://github.com/Enmk)）。
* 修复在启用设置 `optimize_aggregators_of_group_by_keys` 且存在 `JOIN` 时对 `GROUP BY` 的优化问题。修复了 [#12604](https://github.com/ClickHouse/ClickHouse/issues/12604)。 [#16951](https://github.com/ClickHouse/ClickHouse/pull/16951)（[Anton Popov](https://github.com/CurtizJ)）。
* 对 `SHOW ACCESS` 查询进行了小幅改进。 [#16866](https://github.com/ClickHouse/ClickHouse/pull/16866) ([tavplubix](https://github.com/tavplubix)).
* 修复在启用 `optimize_trivial_count_query` 设置且包含分区谓词时的行为。[#16767](https://github.com/ClickHouse/ClickHouse/pull/16767)（[Azat Khuzhin](https://github.com/azat)）。
* 通过 MySQL 线协议为 `INSERT` 查询返回受影响的行数。此前 ClickHouse 始终返回 0，现已修复。修复了 [#16605](https://github.com/ClickHouse/ClickHouse/issues/16605)。[#16715](https://github.com/ClickHouse/ClickHouse/pull/16715)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复了由于 `select_sequential_consistency` 导致的、在优化后的简单计数查询和 system 表中出现的不一致行为。[#16309](https://github.com/ClickHouse/ClickHouse/pull/16309) ([Hao Chen](https://github.com/haoch))。
* 当 `REPLACE` 列转换器作用于不存在的列时抛出错误。 [#16183](https://github.com/ClickHouse/ClickHouse/pull/16183) ([hexiaoting](https://github.com/hexiaoting)).
* 在 `RIGHT|FULL JOIN` 中，如果 `ON` 表达式不是等值连接，则抛出异常。 [#15162](https://github.com/ClickHouse/ClickHouse/pull/15162) ([Artem Zuikov](https://github.com/4ertus2)).

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-10}


* 为 ClickHouse 二进制文件添加了简单的完整性检查。它可以用于检测由硬件故障导致的损坏（存储介质上的位腐烂或内存中的位翻转）。 [#18811](https://github.com/ClickHouse/ClickHouse/pull/18811) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 将 `OpenSSL` 更改为 `BoringSSL`。这可以避免与 sanitizer 相关的问题。修复了 [#12490](https://github.com/ClickHouse/ClickHouse/issues/12490)。修复了 [#17502](https://github.com/ClickHouse/ClickHouse/issues/17502)。修复了 [#12952](https://github.com/ClickHouse/ClickHouse/issues/12952)。[#18129](https://github.com/ClickHouse/ClickHouse/pull/18129)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 简化 `Sys/V` init 脚本。该脚本在 Ubuntu 12.04 及更早版本上无法正常工作。[#17428](https://github.com/ClickHouse/ClickHouse/pull/17428) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 对 `./clickhouse install` 脚本进行了多项改进。[#17421](https://github.com/ClickHouse/ClickHouse/pull/17421) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 现在 ClickHouse 可以充当一个“伪”ZooKeeper。目前，存储实现只是使用内存中的哈希表，且服务器对 ZooKeeper 协议提供了部分支持。[#16877](https://github.com/ClickHouse/ClickHouse/pull/16877) ([alesapin](https://github.com/alesapin))。
* 修复 `TestKeeperStorage`（`ZooKeeper` 的一个 mock）中失效列表 watch 删除的问题。 [#18065](https://github.com/ClickHouse/ClickHouse/pull/18065) ([alesapin](https://github.com/alesapin)).
* 为故障注入添加 `SYSTEM SUSPEND` 命令，可用于方便地进行故障转移测试。修复了 [#15979](https://github.com/ClickHouse/ClickHouse/issues/15979)。[#18850](https://github.com/ClickHouse/ClickHouse/pull/18850) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 当 ClickHouse 使用 `lld` 进行链接时生成 build id。发现 `lld` 在我的机器上默认不会生成它。build id 用于崩溃报告和内部诊断。[#18808](https://github.com/ClickHouse/ClickHouse/pull/18808) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复样式检查中的 shellcheck 错误。 [#18566](https://github.com/ClickHouse/ClickHouse/pull/18566) ([Ilya Yatsishin](https://github.com/qoega)).
* 将时区信息更新至 2020e。[#18531](https://github.com/ClickHouse/ClickHouse/pull/18531) ([alesapin](https://github.com/alesapin)).
* 修复 codespell 警告。将样式检查拆分为多个部分。更新样式检查的 Docker 镜像。[#18463](https://github.com/ClickHouse/ClickHouse/pull/18463)（[Ilya Yatsishin](https://github.com/qoega)）。
* 在文档中自动检查是否遗留冲突标记。[#18332](https://github.com/ClickHouse/ClickHouse/pull/18332)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为无状态测试的波动性检查启用 Thread Fuzzer。 [#18299](https://github.com/ClickHouse/ClickHouse/pull/18299) ([alesapin](https://github.com/alesapin)).
* 不要使用非线程安全的函数 `strerror`。[#18204](https://github.com/ClickHouse/ClickHouse/pull/18204) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 更新 `anchore/scan-action@main` 工作流操作（已从 `master` 迁移到 `main`）。[#18192](https://github.com/ClickHouse/ClickHouse/pull/18192) ([Stig Bakken](https://github.com/stigsb))。
* 现在，`clickhouse-test` 在执行 DROP/CREATE 数据库操作时会使用超时控制。[#18098](https://github.com/ClickHouse/ClickHouse/pull/18098) ([alesapin](https://github.com/alesapin)).
* 为无状态测试启用对 Pytest 框架的实验性支持。[#17902](https://github.com/ClickHouse/ClickHouse/pull/17902)（[Ivan](https://github.com/abyss7)）。
* 现在我们在集成测试中使用最新的 Docker 守护进程版本。[#17671](https://github.com/ClickHouse/ClickHouse/pull/17671)（[alesapin](https://github.com/alesapin)）。
* 如果启用了 Sentry，则向其发送有关官方构建、内存、CPU 和可用磁盘空间的信息。Sentry 是一项需用户主动选择开启的功能，用于帮助 ClickHouse 开发者。此更改解决了 [#17279](https://github.com/ClickHouse/ClickHouse/issues/17279)。[#17543](https://github.com/ClickHouse/ClickHouse/pull/17543) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 在 `clickhouse-copier` 代码中存在一个未初始化的变量。[#17363](https://github.com/ClickHouse/ClickHouse/pull/17363)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 修复来自 [#17309](https://github.com/ClickHouse/ClickHouse/issues/17309) 的 [一份 MSan 报告](https://clickhouse-test-reports.s3.yandex.net/17309/065cd002578f2e8228f12a2744bd40c970065e0c/stress_test_\(memory\)/stderr.log)。[#17344](https://github.com/ClickHouse/ClickHouse/pull/17344)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 修复 Arrow Flight 库中 IPv6 相关的问题。详情参见[评论](https://github.com/ClickHouse/ClickHouse/pull/16243#issuecomment-720830294)。[#16664](https://github.com/ClickHouse/ClickHouse/pull/16664)（[Zhanna](https://github.com/FawnD2)）。
* 添加一个库，将部分 `libc` 函数替换为会终止进程的 trap。 [#16366](https://github.com/ClickHouse/ClickHouse/pull/16366) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 在发生栈溢出时，在服务器日志中提供诊断信息，并向 `clickhouse-client` 发送错误消息。关闭了 [#14840](https://github.com/ClickHouse/ClickHouse/issues/14840)。[#16346](https://github.com/ClickHouse/ClickHouse/pull/16346)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 现在我们可以并行运行几乎所有无状态的函数式测试。[#15236](https://github.com/ClickHouse/ClickHouse/pull/15236) ([alesapin](https://github.com/alesapin))。
* 修复 `librdkafka` 中 snappy 解压缩的数据损坏问题（仅在使用 gcc10 构建时会出现，但官方构建已改用 clang，因此至少最近的官方发行版不受影响）。[#18053](https://github.com/ClickHouse/ClickHouse/pull/18053) ([Azat Khuzhin](https://github.com/azat)).
* 如果服务器被 OOM killer 终止，则在日志中输出一条消息。 [#13516](https://github.com/ClickHouse/ClickHouse/pull/13516) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* PODArray：避免调用参数为 (nullptr, 0) 的 `memcpy`（修复 UBSan 报告）。修复了 [#18525](https://github.com/ClickHouse/ClickHouse/issues/18525)。[#18526](https://github.com/ClickHouse/ClickHouse/pull/18526)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 对 DDLWorker 中 zookeeper 路径的拼接方式进行了小幅改进。 [#17767](https://github.com/ClickHouse/ClickHouse/pull/17767) ([Bharat Nallan](https://github.com/bharatnc)).
* 允许从调试文件重新加载符号。此 PR 还修复了一个 build-id 问题。[#17637](https://github.com/ClickHouse/ClickHouse/pull/17637) ([Amos Bird](https://github.com/amosbird))。





## [2020 年变更日志](./2020.md) {#changelog-for-2020}
