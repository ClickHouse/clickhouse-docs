---
slug: /whats-new/changelog/2021
sidebar_position: 6
sidebar_label: "2021年"
title: "2021 年更新日志"
description: "2021 年更新日志"
doc_type: "changelog"
keywords:
  [
    "ClickHouse 2021",
    "changelog 2021",
    "发行说明",
    "版本历史",
    "新特性"
  ]
---

### ClickHouse 版本 v21.12 发布，2021-12-15 {#clickhouse-release-v2112-2021-12-15}

#### 向后不兼容的变更 {#backward-incompatible-change}

- _修复此前具有非预期行为的特性。_ 不再允许对 Kafka/RabbitMQ/FileLog 进行直接查询（direct select）。可以通过设置 `stream_like_engine_allow_direct_select` 来启用。即使通过该设置启用了直接查询，只要存在附加的物化视图，仍然不允许直接查询。对于 Kafka 和 RabbitMQ，即使允许直接查询，默认情况下也不会提交消息。若要在直接查询时启用提交，用户必须使用存储级别设置 `kafka{rabbitmq}_commit_on_select=1`（默认值为 `0`）。[#31053](https://github.com/ClickHouse/ClickHouse/pull/31053) ([Kseniia Sumarokova](https://github.com/kssenii))。
- _对一个新函数的行为进行轻微调整。_ 在 JSON_VALUE 中返回未加引号的字符串。修复了 [#27965](https://github.com/ClickHouse/ClickHouse/issues/27965)。[#31008](https://github.com/ClickHouse/ClickHouse/pull/31008) ([Kseniia Sumarokova](https://github.com/kssenii))。
- _设置重命名。_ 为 TSV/CSV 输入格式增加自定义 null 表示支持。修复在 TSV/CSV/JSONCompactStringsEachRow/JSONStringsEachRow 输入格式中反序列化 Nullable(String) 的问题。将 `output_format_csv_null_representation` 和 `output_format_tsv_null_representation` 分别重命名为 `format_csv_null_representation` 和 `format_tsv_null_representation`。[#30497](https://github.com/ClickHouse/ClickHouse/pull/30497) ([Kruglov Pavel](https://github.com/Avogar))。
- _进一步废弃已不再使用的代码。_ 这仅与 ClickHouse 20.6 之前版本的用户相关。`ReplicatedMergeTree` 中移除了“leader 选举”机制，因为自 20.6 起已经支持多个 leader。如果你是从较早版本升级，并且某个旧版本副本当前是 leader，那么在升级后服务器将无法启动。请先停止旧版本副本，以便新版本能够启动。完成后，将无法再降级到 20.6 之前的版本。[#32140](https://github.com/ClickHouse/ClickHouse/pull/32140) ([tavplubix](https://github.com/tavplubix))。

#### 新特性 {#new-feature}


* 在 clickhouse-keeper 中实现了更多 ZooKeeper Four Letter Words 命令：[https://zookeeper.apache.org/doc/r3.4.8/zookeeperAdmin.html#sc&#95;zkCommands](https://zookeeper.apache.org/doc/r3.4.8/zookeeperAdmin.html#sc_zkCommands)。[#28981](https://github.com/ClickHouse/ClickHouse/pull/28981)（[JackyWoo](https://github.com/JackyWoo)）。现在 `clickhouse-keeper` 已经实现了全部功能。
* 支持 `Bool` 数据类型。[#31072](https://github.com/ClickHouse/ClickHouse/pull/31072)（[Kevin Wan](https://github.com/MaxWk)）。
* 在 File、URL、HDFS 存储引擎以及 `INSERT INTO` 表函数中支持 `PARTITION BY`。关闭 [#30273](https://github.com/ClickHouse/ClickHouse/issues/30273)。[#30690](https://github.com/ClickHouse/ClickHouse/pull/30690) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 添加了 `CONSTRAINT ... ASSUME ...`（在执行 `INSERT` 时不进行检查）。添加了将查询转换为 CNF（[https://github.com/ClickHouse/ClickHouse/issues/11749](https://github.com/ClickHouse/ClickHouse/issues/11749)），以便更方便地进行优化。添加了基于约束的简单查询重写（目前仅支持简单匹配，之后将改进以支持 &lt;,=,&gt; 等）。在可行的情况下，添加了将重型列替换为轻量列的能力。[#18787](https://github.com/ClickHouse/ClickHouse/pull/18787)（[Nikita Vasilev](https://github.com/nikvas0)）。
* 为 `http`/`url` 函数添加基本访问身份验证。 [#31648](https://github.com/ClickHouse/ClickHouse/pull/31648) ([michael1589](https://github.com/michael1589)).
* 在 `WITH FILL` 修饰符的 `STEP` 子句中支持使用 `INTERVAL` 类型。 [#30927](https://github.com/ClickHouse/ClickHouse/pull/30927) ([Anton Popov](https://github.com/CurtizJ)).
* 为 `FROM INFILE` 子句新增从多个文件并行读取以及支持通配符（glob）的功能。[#30135](https://github.com/ClickHouse/ClickHouse/pull/30135) ([Filatenkov Artur](https://github.com/FArthur-cmd))。
* 为 `Identifier` 表和数据库查询参数添加支持。修复 [#27226](https://github.com/ClickHouse/ClickHouse/issues/27226)。[#28668](https://github.com/ClickHouse/ClickHouse/pull/28668)（[Nikolay Degterinsky](https://github.com/evillique)）。
* *TLDR：大幅提升文本格式的完整性和一致性。* 重构 `TSV`、`TSVRaw`、`CSV` 以及 `JSONCompactEachRow`、`JSONCompactStringsEachRow` 格式，移除重复代码，为带有 `-WithNames` 和 `-WithNamesAndTypes` 后缀的格式增加基础接口。新增 `CSVWithNamesAndTypes`、`TSVRawWithNames`、`TSVRawWithNamesAndTypes`、`JSONCompactEachRowWithNames`、`JSONCompactStringsEachRowWithNames`、`RowBinaryWithNames` 等格式。为 `TSVWithNamesAndTypes`、`TSVRaw(WithNames/WithNamesAndTypes)`、`CSVWithNamesAndTypes`、`JSONCompactEachRow(WithNames/WithNamesAndTypes)`、`JSONCompactStringsEachRow(WithNames/WithNamesAndTypes)` 等格式提供并行解析支持。为 `RowBinaryWithNamesAndTypes` 格式增加列映射与类型检查支持。新增设置 `input_format_with_types_use_header`，用于指定是否需要检查 `<format_name>WithNamesAndTypes` 格式中写入的类型是否与表结构匹配。新增设置 `input_format_csv_empty_as_default`，并在 CSV 格式中使用该设置以替代 `input_format_defaults_for_omitted_fields`（因为后者不应控制 `csv_empty_as_default`）。修正 `input_format_defaults_for_omitted_fields` 的用法（此前仅作为 `csv_empty_as_default` 使用，但它应控制对被省略字段的默认表达式计算）。修复 `TSVRaw` 格式中 Nullable 的输入/输出，使该格式与向 TSV 插入数据完全兼容。修复在启用 `input_format_null_as_default` 时向 `LowCardinality(Nullable)` 插入 NULL 的行为（此前会插入默认值而非实际的 NULL）。修复 `JSONStringsEachRow`/`JSONCompactStringsEachRow` 格式中的字符串反序列化问题（此前字符串只会被解析到遇到第一个 &#39;\n&#39; 或 &#39;\t&#39; 为止）。在 Template 输入格式中增加使用 `Raw` 转义规则的能力。为 `JSONCompactEachRow(WithNames/WithNamesAndTypes)` 输入格式增加诊断信息。修复在 `min_chunk_bytes_for_parallel_parsing` 设置小于单行字节数时，对 `-WithNames` 格式进行并行解析的错误。[#30178](https://github.com/ClickHouse/ClickHouse/pull/30178)（[Kruglov Pavel](https://github.com/Avogar)）。允许在 `CustomSeparated` 输入/输出格式中输出/解析列名和类型。新增与 `TSVWithNames/WithNamesAndTypes` 类似的格式 `CustomSeparatedWithNames/WithNamesAndTypes`。[#31434](https://github.com/ClickHouse/ClickHouse/pull/31434)（[Kruglov Pavel](https://github.com/Avogar)）。
* 支持阿里云 OSS 存储。 [#31286](https://github.com/ClickHouse/ClickHouse/pull/31286) ([cfcz48](https://github.com/cfcz48)).
* 在配置文件中暴露全局线程池的所有设置。[#31285](https://github.com/ClickHouse/ClickHouse/pull/31285)（[Tomáš Hromada](https://github.com/gyfis)）。
* 引入了窗口函数 `exponentialTimeDecayedSum`、`exponentialTimeDecayedMax`、`exponentialTimeDecayedCount` 和 `exponentialTimeDecayedAvg`，在较大的窗口上比 `exponentialMovingAverage` 更高效，同时还覆盖了更多使用场景。 [#29799](https://github.com/ClickHouse/ClickHouse/pull/29799) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 添加了一个选项，可在将日志写入文件之前使用 LZ4 对其进行压缩。修复了 [#23860](https://github.com/ClickHouse/ClickHouse/issues/23860)。[#29219](https://github.com/ClickHouse/ClickHouse/pull/29219)（[Nikolay Degterinsky](https://github.com/evillique)）。
* 支持具有 CROSS JOIN 语义的 `JOIN ON 1 = 1`。此更改解决了 [#25578](https://github.com/ClickHouse/ClickHouse/issues/25578)。[#25894](https://github.com/ClickHouse/ClickHouse/pull/25894)（[Vladimir C](https://github.com/vdimir)）。
* 为 `Map` 类型添加 Map 组合器。- 将用于映射数组的旧 `sum-, min-, max- Map` 重命名为 `sum-, min-, max- MappedArrays`。 [#24539](https://github.com/ClickHouse/ClickHouse/pull/24539) ([Ildus Kurbangaliev](https://github.com/ildus))。
* 使通过 HTTP 进行读取的操作可重试。关闭 [#29696](https://github.com/ClickHouse/ClickHouse/issues/29696)。[#29894](https://github.com/ClickHouse/ClickHouse/pull/29894)（[Kseniia Sumarokova](https://github.com/kssenii)）。

#### 实验性功能 {#experimental-feature}

- `WINDOW VIEW` 用于在 ClickHouse 中启用流处理。[#8331](https://github.com/ClickHouse/ClickHouse/pull/8331) ([vxider](https://github.com/Vxider))。
- 移除对 `MaterializedMySQL` 使用 Ordinary 数据库的支持。[#31292](https://github.com/ClickHouse/ClickHouse/pull/31292) ([Stig Bakken](https://github.com/stigsb))。
- 为 Log 系列实现 BACKUP 和 RESTORE 命令。此功能正在开发中。[#30688](https://github.com/ClickHouse/ClickHouse/pull/30688) ([Vitaly Baranov](https://github.com/vitlibar))。

#### 性能改进 {#performance-improvement}


- 降低使用 `s3` / `url` / `hdfs` 格式读取 `Parquet`、`ORC`、`Arrow` 时的内存使用量(由设置 `input_format_allow_seeks` 控制,默认启用)。同时添加设置 `remote_read_min_bytes_for_seek` 以控制 seek 操作。关闭 [#10461](https://github.com/ClickHouse/ClickHouse/issues/10461)。关闭 [#16857](https://github.com/ClickHouse/ClickHouse/issues/16857)。[#30936](https://github.com/ClickHouse/ClickHouse/pull/30936) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 为 JOIN ON 中的常量条件添加优化,参考 [#26928](https://github.com/ClickHouse/ClickHouse/issues/26928)。[#27021](https://github.com/ClickHouse/ClickHouse/pull/27021) ([Vladimir C](https://github.com/vdimir))。
- 支持所有文本格式的并行格式化,`JSONEachRowWithProgress` 和 `PrettyCompactMonoBlock` 除外。[#31489](https://github.com/ClickHouse/ClickHouse/pull/31489) ([Kruglov Pavel](https://github.com/Avogar))。
- 加速可空列的计数操作。[#31806](https://github.com/ClickHouse/ClickHouse/pull/31806) ([Raúl Marín](https://github.com/Algunenano))。
- 加速 `avg` 和 `sumCount` 聚合函数。[#31694](https://github.com/ClickHouse/ClickHouse/pull/31694) ([Raúl Marín](https://github.com/Algunenano))。
- 提升 JSON 和 XML 输出格式的性能。[#31673](https://github.com/ClickHouse/ClickHouse/pull/31673) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 提升数据同步到块设备的性能。关闭 [#31181](https://github.com/ClickHouse/ClickHouse/issues/31181)。[#31229](https://github.com/ClickHouse/ClickHouse/pull/31229) ([zhanglistar](https://github.com/zhanglistar))。
- 修复 `LiveView` 表中的查询性能问题。修复 [#30831](https://github.com/ClickHouse/ClickHouse/issues/30831)。[#31006](https://github.com/ClickHouse/ClickHouse/pull/31006) ([vzakaznikov](https://github.com/vzakaznikov))。
- 加速查询解析。[#31949](https://github.com/ClickHouse/ClickHouse/pull/31949) ([Raúl Marín](https://github.com/Algunenano))。
- 允许为普通/标记指标拆分 `GraphiteMergeTree` 汇总规则(可选的 `rule_type` 字段)。[#25122](https://github.com/ClickHouse/ClickHouse/pull/25122) ([Michail Safronov](https://github.com/msaf1980))。
- 移除 `remote()` 的多余 `DESC TABLE` 请求(在 `remote('127.1', system.one)` 的情况下(即使用标识符作为 db.table 而非字符串)存在多余的 `DESC TABLE` 请求)。[#32019](https://github.com/ClickHouse/ClickHouse/pull/32019) ([Azat Khuzhin](https://github.com/azat))。
- 在启用设置 `optimize_functions_to_subcolumns` 时,优化函数 `tupleElement` 以读取子列。[#31261](https://github.com/ClickHouse/ClickHouse/pull/31261) ([Anton Popov](https://github.com/CurtizJ))。
- 在启用设置 `optimize_functions_to_subcolumns` 时,优化函数 `mapContains` 以读取子列 `key`。[#31218](https://github.com/ClickHouse/ClickHouse/pull/31218) ([Anton Popov](https://github.com/CurtizJ))。
- 添加设置 `merge_tree_min_rows_for_concurrent_read_for_remote_filesystem` 和 `merge_tree_min_bytes_for_concurrent_read_for_remote_filesystem`。[#30970](https://github.com/ClickHouse/ClickHouse/pull/30970) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 在 `StorageMergeTree` 中跳过不同分区的 mutation 操作。[#21326](https://github.com/ClickHouse/ClickHouse/pull/21326) ([Vladimir Chebotarev](https://github.com/excitoon))。

#### 改进 {#improvement}


* 如果有其他表或字典依赖于某个表或字典，则不允许删除该表或字典。 [#30977](https://github.com/ClickHouse/ClickHouse/pull/30977) ([tavplubix](https://github.com/tavplubix))。
* 允许对聚合函数状态进行版本管理。现在我们可以在保持向后兼容的前提下，更改聚合函数状态的序列化格式。关闭 [#12552](https://github.com/ClickHouse/ClickHouse/issues/12552)。[#24820](https://github.com/ClickHouse/ClickHouse/pull/24820)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 支持 PostgreSQL 风格的 `ALTER MODIFY COLUMN` 语法。[#32003](https://github.com/ClickHouse/ClickHouse/pull/32003) ([SuperDJY](https://github.com/cmsxbc))。
* 为 `RangeHashedDictionary` 和 `ComplexKeyRangeHashedDictionary` 添加了对 `update_field` 的支持。 [#32185](https://github.com/ClickHouse/ClickHouse/pull/32185) ([Maksim Kita](https://github.com/kitaisreal)).
* `murmurHash3_128` 和 `sipHash128` 函数现在可以接受任意数量的参数。由此关闭了 [#28774](https://github.com/ClickHouse/ClickHouse/issues/28774)。[#28965](https://github.com/ClickHouse/ClickHouse/pull/28965)（[小路](https://github.com/nicelulu)）。
* 为 `HDFS` 存储增加对默认表达式的支持，并在源为列式存储时优化读取。 [#32256](https://github.com/ClickHouse/ClickHouse/pull/32256) ([李扬](https://github.com/taiyang-li)).
* 改进一个 OpenTelemetry span 的操作名。 [#32234](https://github.com/ClickHouse/ClickHouse/pull/32234) ([Frank Chen](https://github.com/FrankChen021))。
* 对于输出格式 `JSONEachRow`，使用 `Content-Type: application/x-ndjson`（[http://ndjson.org/](http://ndjson.org/)）。[#32223](https://github.com/ClickHouse/ClickHouse/pull/32223)（[Dmitriy Dorofeev](https://github.com/deem0n)）。
* 在 Template/CustomSeparated 格式中改进基于带引号转义规则的未知字段跳过机制。此前只能跳过带引号的字符串，现在可以跳过任意类型的值。[#32204](https://github.com/ClickHouse/ClickHouse/pull/32204)（[Kruglov Pavel](https://github.com/Avogar)）。
* 现在，当配置中包含重复的 ID 或 endpoint 时，`clickhouse-keeper` 将拒绝启动或应用配置更改。修复了 [#31339](https://github.com/ClickHouse/ClickHouse/issues/31339)。[#32121](https://github.com/ClickHouse/ClickHouse/pull/32121) ([alesapin](https://github.com/alesapin))。
* 在由 URL 引擎发出的 HTTP 包中设置 Content-Type。[#32113](https://github.com/ClickHouse/ClickHouse/pull/32113)（[Frank Chen](https://github.com/FrankChen021)）。
* 如果启用了 `output_format_json_array_of_rows`，则对于 `JSONEachRow` 格式，将 Content-Type 返回为 &#39;application/json&#39;。[#32112](https://github.com/ClickHouse/ClickHouse/pull/32112) ([Frank Chen](https://github.com/FrankChen021)).
* 允许在 `Float32`/`Float64` 值前解析 `+` 符号。[#32079](https://github.com/ClickHouse/ClickHouse/pull/32079) ([Kruglov Pavel](https://github.com/Avogar)).
* 允许为 `DiskHDFS` 和 `StorageHDFS` 配置用户自定义的 `hdfs_replication` 参数。修复 [#32039](https://github.com/ClickHouse/ClickHouse/issues/32039)。[#32049](https://github.com/ClickHouse/ClickHouse/pull/32049)（[leosunli](https://github.com/leosunli)）。
* 在 OpenTelemetry span 日志中新增了 ClickHouse 的 `exception` 和 `exception_code` 字段。[#32040](https://github.com/ClickHouse/ClickHouse/pull/32040) ([Frank Chen](https://github.com/FrankChen021))。
* 改进 OpenTelemetry span 日志的持续时间 —— 之前在查询级别如果出现查询异常，其持续时间会被记录为 0。[#32038](https://github.com/ClickHouse/ClickHouse/pull/32038) ([Frank Chen](https://github.com/FrankChen021)).
* 修复无法创建 `Int256` 类型的 `LowCardinality` 列的问题。[#31832](https://github.com/ClickHouse/ClickHouse/pull/31832) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 在 `engine` 或 `partition_by` 不同时重新创建 `system.*_log` 表。[#31824](https://github.com/ClickHouse/ClickHouse/pull/31824) ([Azat Khuzhin](https://github.com/azat))。
* `MaterializedMySQL`：修复名为 &#39;table&#39; 的表的相关问题。 [#31781](https://github.com/ClickHouse/ClickHouse/pull/31781) ([Håvard Kvålen](https://github.com/havardk))。
* ClickHouse 字典源：支持预定义连接。修复 [#31705](https://github.com/ClickHouse/ClickHouse/issues/31705)。[#31749](https://github.com/ClickHouse/ClickHouse/pull/31749)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 允许为 Kafka 和 RabbitMQ 引擎使用预定义的连接配置（方式与其他集成表引擎相同）。 [#31691](https://github.com/ClickHouse/ClickHouse/pull/31691) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 在 clickhouse-client 中浏览历史记录时始终重新渲染提示符。这将提升操作无法完全显示在屏幕上的超长查询时的易用性。[#31675](https://github.com/ClickHouse/ClickHouse/pull/31675) ([alexey-milovidov](https://github.com/alexey-milovidov))（作者：Amos Bird）。
* 添加用于在历史记录中导航的按键绑定（而不是在行/历史之间切换）。 [#31641](https://github.com/ClickHouse/ClickHouse/pull/31641) ([Azat Khuzhin](https://github.com/azat))。
* 改进了 `max_execution_time` 检查。修复了在某些情况下未进行超时检查、导致查询可能运行过长的问题。[#31636](https://github.com/ClickHouse/ClickHouse/pull/31636) ([Raúl Marín](https://github.com/Algunenano))。
* 当由于错误的密码哈希而无法加载 `users.xml` 时，改进异常消息。这解决了 [#24126](https://github.com/ClickHouse/ClickHouse/issues/24126)。[#31557](https://github.com/ClickHouse/ClickHouse/pull/31557)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 当在 `ReplicatedMergeTree` 参数中展开宏且这些宏未在配置中定义时，使用 `Replicated` 数据库参数中的分片名和副本名。关闭 [#31471](https://github.com/ClickHouse/ClickHouse/issues/31471)。[#31488](https://github.com/ClickHouse/ClickHouse/pull/31488)（[tavplubix](https://github.com/tavplubix)）。
* 改进了对 `min/max/count` 投影的分析。现在，在启用 `allow_experimental_projection_optimization` 时，可以将虚拟 `min/max/count` 投影与分区键中的列联合使用。[#31474](https://github.com/ClickHouse/ClickHouse/pull/31474) ([Amos Bird](https://github.com/amosbird))。
* 为 `clickhouse-local` 添加对 `--pager` 的支持。 [#31457](https://github.com/ClickHouse/ClickHouse/pull/31457) ([Azat Khuzhin](https://github.com/azat)).
* 修复在交互式查询编辑期间编辑器等待的问题（当 `EDITOR` 与 `clickhouse-local`/`clickhouse-client` 并发工作时，`waitpid()` 在接收到 `SIGWINCH` 时返回 -1）。 [#31456](https://github.com/ClickHouse/ClickHouse/pull/31456) ([Azat Khuzhin](https://github.com/azat)).
* 如果在 `JSONCompactStrings(EachRow)` 格式中字段之后存在无效数据，则抛出异常。 [#31455](https://github.com/ClickHouse/ClickHouse/pull/31455) ([Kruglov Pavel](https://github.com/Avogar)).
* `http_send_timeout` 和 `http_receive_timeout` 设置的默认值从 1800（30 分钟）修改为 180（3 分钟）。 [#31450](https://github.com/ClickHouse/ClickHouse/pull/31450) ([tavplubix](https://github.com/tavplubix))。
* `MaterializedMySQL` 现在支持处理 `CREATE TABLE ... LIKE ...` DDL 查询。[#31410](https://github.com/ClickHouse/ClickHouse/pull/31410)（[Stig Bakken](https://github.com/stigsb)）。
* 在对 system 表执行 `show create table` 时返回伪造的 CREATE 查询。[#31391](https://github.com/ClickHouse/ClickHouse/pull/31391) ([SuperDJY](https://github.com/cmsxbc))。
* 之前仅为 `numbers` 表函数显示进度。现在 `numbers_mt` 也会显示进度。[#31318](https://github.com/ClickHouse/ClickHouse/pull/31318) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 现在会使用初始用户的角色来查找行级策略，参见 [#31080](https://github.com/ClickHouse/ClickHouse/issues/31080)。[#31262](https://github.com/ClickHouse/ClickHouse/pull/31262)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 如果某个已废弃的设置被更改，则在 `system.warnings` 中显示警告。[#31252](https://github.com/ClickHouse/ClickHouse/pull/31252) ([tavplubix](https://github.com/tavplubix))。
* 改进了 `MergeTree` 中后台清理任务的退避机制。设置项 `merge_tree_clear_old_temporary_directories_interval_seconds` 和 `merge_tree_clear_old_parts_interval_seconds` 已从用户设置迁移到 MergeTree 设置中。[#31180](https://github.com/ClickHouse/ClickHouse/pull/31180) ([tavplubix](https://github.com/tavplubix)).
* 现在，每个副本只会向客户端发送 profile events 计数器的增量信息。[#31155](https://github.com/ClickHouse/ClickHouse/pull/31155) ([Dmitry Novik](https://github.com/novikd))。这使得 `clickhouse-client` 中的 `--hardware_utilization` 选项真正可用。
* 在 `clickhouse-client` 中默认启用多行编辑。修复了 [#31121](https://github.com/ClickHouse/ClickHouse/issues/31121)。[#31123](https://github.com/ClickHouse/ClickHouse/pull/31123)（[Amos Bird](https://github.com/amosbird)）。
* 对 `ALTER` 查询中的函数名进行规范化。这有助于避免在通过索引/投影创建表与通过 `ALTER` 命令添加索引/投影之间出现元数据不匹配。这是 [https://github.com/ClickHouse/ClickHouse/pull/20174](https://github.com/ClickHouse/ClickHouse/pull/20174) 的后续 PR。将其标记为改进项，因为目前没有相关的错误报告且该场景相对较少见。[#31095](https://github.com/ClickHouse/ClickHouse/pull/31095) ([Amos Bird](https://github.com/amosbird))。
* 为 `RENAME DATABASE`/`TABLE`/`DICTIONARY` 查询提供 `IF EXISTS` 修饰符支持。使用该指令时，如果要重命名的 DATABASE/TABLE/DICTIONARY 不存在，将不会报错。[#31081](https://github.com/ClickHouse/ClickHouse/pull/31081) ([victorgao](https://github.com/kafka1991))。
* 在分区被删除时取消纵向合并。这是对 [https://github.com/ClickHouse/ClickHouse/pull/25684](https://github.com/ClickHouse/ClickHouse/pull/25684) 和 [https://github.com/ClickHouse/ClickHouse/pull/30996](https://github.com/ClickHouse/ClickHouse/pull/30996) 的后续更新。[#31057](https://github.com/ClickHouse/ClickHouse/pull/31057)（[Amos Bird](https://github.com/amosbird)）。
* ClickHouse 字典源内部的本地会话将不再把其事件发送到 session log。这修复了关闭时可能出现的死锁问题（tsan 警告）。此外，此 PR 还修复了不稳定的 `test_dictionaries_dependency_xml/`。 [#31013](https://github.com/ClickHouse/ClickHouse/pull/31013) ([Vitaly Baranov](https://github.com/vitlibar)).
* 在执行 `ALTER` 命令时减少锁的使用。[#31010](https://github.com/ClickHouse/ClickHouse/pull/31010)（[Amos Bird](https://github.com/amosbird)）。
* 修复 clickhouse-local 交互模式中的 `--verbose` 选项，并支持将日志写入文件。[#30881](https://github.com/ClickHouse/ClickHouse/pull/30881) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 在 `clickhouse-client` 中新增了 `\l`、`\d`、`\c` 命令，其用法与 MySQL 和 PostgreSQL 中的对应命令类似。[#30876](https://github.com/ClickHouse/ClickHouse/pull/30876) ([Pavel Medvedev](https://github.com/pmed)).
* 对于 clickhouse-local 或 clickhouse-client：如果在使用 `--query` 或 `--queries-file` 时指定了 `--interactive` 选项，则会先像在非交互模式下一样执行这些查询，然后再进入交互模式。[#30851](https://github.com/ClickHouse/ClickHouse/pull/30851)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复可能出现的 “The local set of parts of X doesn&#39;t look like the set of parts in ZooKeeper” 错误（当从 ZooKeeper 删除 znode 时 `DROP` 失败的情况）。[#30826](https://github.com/ClickHouse/ClickHouse/pull/30826) ([Azat Khuzhin](https://github.com/azat)).
* Avro 格式可用于 Kafka。已添加 `output_format_avro_rows_in_file` 设置。[#30351](https://github.com/ClickHouse/ClickHouse/pull/30351)（[Ilya Golshtein](https://github.com/ilejn)）。
* 允许为一个 `MaterializedPostgreSQL` 数据库指定一个或任意数量的 PostgreSQL schema。关闭 [#28901](https://github.com/ClickHouse/ClickHouse/issues/28901)。关闭 [#29324](https://github.com/ClickHouse/ClickHouse/issues/29324)。[#28933](https://github.com/ClickHouse/ClickHouse/pull/28933) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 将 clickhouse-keeper 内部通信的默认端口由 44444 更改为 9234。修复了 [#30879](https://github.com/ClickHouse/ClickHouse/issues/30879)。[#31799](https://github.com/ClickHouse/ClickHouse/pull/31799)（[alesapin](https://github.com/alesapin)）。
* 实现支持 `Decimal` 参数的 `transform` 函数。 [#31839](https://github.com/ClickHouse/ClickHouse/pull/31839) ([李帅](https://github.com/loneylee))。
* 通过增加对 hdfs url 结构的额外检查，在 hdfs url 不合法的情况下，修复了调试服务器中的 abort 以及发布服务器中的 `DB::Exception: std::out_of_range: basic_string` 错误。 [#31042](https://github.com/ClickHouse/ClickHouse/pull/31042) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复 `hdfs` 表函数/引擎中可能出现的断言问题，并添加测试。[#31036](https://github.com/ClickHouse/ClickHouse/pull/31036) ([Kruglov Pavel](https://github.com/Avogar)).

#### 错误修复 {#bug-fixes}


* 修复在启用位置参数时，`GROUP BY` / `ORDER BY` / `LIMIT BY` 中使用别名的行为。解决 [#31173](https://github.com/ClickHouse/ClickHouse/issues/31173)。[#31741](https://github.com/ClickHouse/ClickHouse/pull/31741)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在 `Buffer` 表引擎中使用 `Map` 类型时的问题。修复了 [#30546](https://github.com/ClickHouse/ClickHouse/issues/30546)。[#31742](https://github.com/ClickHouse/ClickHouse/pull/31742)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复在启用 `use_uncompressed_cache` 时从 `MergeTree` 表读取数据的行为。[#31826](https://github.com/ClickHouse/ClickHouse/pull/31826) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了在启用设置 `empty_result_for_aggregation_by_empty_set` 时，对无事可做的变更操作会卡住的问题。[#32358](https://github.com/ClickHouse/ClickHouse/pull/32358) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 修复使用 Protobuf 写入时跳过列的问题。此 PR 修复了 [#31160](https://github.com/ClickHouse/ClickHouse/issues/31160)，参见评论 [#31160](https://github.com/ClickHouse/ClickHouse/issues/31160)#issuecomment-980595318。[#31988](https://github.com/ClickHouse/ClickHouse/pull/31988)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复在子查询中移除不需要列时的错误。如果在没有 `GROUP BY` 的查询中存在聚合函数，即使该列被认为是不需要的，也不要将其移除。 [#32289](https://github.com/ClickHouse/ClickHouse/pull/32289) ([dongyifeng](https://github.com/dyf6372)).
* 尚未达到配额限制，但已出现超限。本 PR 修复了 [#31174](https://github.com/ClickHouse/ClickHouse/issues/31174)。[#31337](https://github.com/ClickHouse/ClickHouse/pull/31337)（[sunny](https://github.com/sunny19930321)）。
* 在使用部分权限撤销时修复 `SHOW GRANTS` 的行为。此 PR 修复了 [#31138](https://github.com/ClickHouse/ClickHouse/issues/31138)。[#31249](https://github.com/ClickHouse/ClickHouse/pull/31249)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 在带有 cgroup 限制的容器中运行 ClickHouse 时，内存大小被错误估算。[#31157](https://github.com/ClickHouse/ClickHouse/pull/31157) ([Pavel Medvedev](https://github.com/pmed)).
* 修复了当默认表达式的数据类型与列数据类型不一致时 `ALTER ... MATERIALIZE COLUMN ...` 查询的问题。[#32348](https://github.com/ClickHouse/ClickHouse/pull/32348) ([Anton Popov](https://github.com/CurtizJ))。
* 修复了在 `Decimal` 参数下聚合函数 `avgWeighted` 发生 SIGFPE 崩溃的问题。修复了 [#32053](https://github.com/ClickHouse/ClickHouse/issues/32053)。[#32303](https://github.com/ClickHouse/ClickHouse/pull/32303)（[tavplubix](https://github.com/tavplubix)）。
* 如果 `Dictionary` 表引用了同名的 XML 字典，服务器在启动时可能会因报错 `Cannot attach 1 tables due to cyclic dependencies` 而无法启动，现已修复此问题。修复了 [#31315](https://github.com/ClickHouse/ClickHouse/issues/31315)。[#32288](https://github.com/ClickHouse/ClickHouse/pull/32288)（[tavplubix](https://github.com/tavplubix)）。
* 修复在应用 `Quoted` 转义规则时，对 `Nullable(Float)` 进行 `NaN` 反序列化时的解析错误。 [#32190](https://github.com/ClickHouse/ClickHouse/pull/32190) ([Kruglov Pavel](https://github.com/Avogar)).
* XML 字典：在创建表查询中使用的标识符，在升级到新版本时可以自动补全为 `default_database`。修复了 [#31963](https://github.com/ClickHouse/ClickHouse/issues/31963)。[#32187](https://github.com/ClickHouse/ClickHouse/pull/32187)（[Maksim Kita](https://github.com/kitaisreal)）。
* 如果在某些副本上禁用了 `replicated_can_become_leader` 设置，则在以仲裁方式插入数据时，活动副本的数量可能会被错误计算。该问题已修复。[#32157](https://github.com/ClickHouse/ClickHouse/pull/32157) ([tavplubix](https://github.com/tavplubix))。
* 字典：修复自定义数据库查询中 `{condition}` 不生效的问题。[#32117](https://github.com/ClickHouse/ClickHouse/pull/32117) ([Maksim Kita](https://github.com/kitaisreal))。
* 修复在使用 `cast_keep_nullable` 时对 `Nullable` 值进行 `CAST` 的问题（之前会出现 `PARAMETER_OUT_OF_BOUND` 错误，例如 `toUInt32OrDefault(toNullable(toUInt32(1)))`）。 [#32080](https://github.com/ClickHouse/ClickHouse/pull/32080) ([Azat Khuzhin](https://github.com/azat)).
* 在某些罕见情况下修复 `Join` 表引擎的 `CREATE TABLE` 语句。关闭 [#31680](https://github.com/ClickHouse/ClickHouse/issues/31680)。[#32066](https://github.com/ClickHouse/ClickHouse/pull/32066)（[SuperDJY](https://github.com/cmsxbc)）。
* 修复了分离数据分片时出现的 `Directory ... already exists and is not empty` 错误。[#32063](https://github.com/ClickHouse/ClickHouse/pull/32063) ([tavplubix](https://github.com/tavplubix))。
* `MaterializedMySQL`（实验特性）：修复来自 MySQL 的 `DECIMAL` 数据被误解的问题。[#31990](https://github.com/ClickHouse/ClickHouse/pull/31990)（[Håvard Kvålen](https://github.com/havardk)）。
* `FileLog`(实验性功能)引擎在创建表失败时不必要地创建了元数据目录。修复 [#31962](https://github.com/ClickHouse/ClickHouse/issues/31962)。[#31967](https://github.com/ClickHouse/ClickHouse/pull/31967) ([flynn](https://github.com/ucasfl))。
* 某些 `GET_PART` 记录在所有副本上都丢失该 part 且同一分区中不存在其他 part 时，可能会在复制队列中挂起。在分区键仅包含整数类型或 `Date[Time]` 列的情况下已修复此问题。修复 [#31485](https://github.com/ClickHouse/ClickHouse/issues/31485)。[#31887](https://github.com/ClickHouse/ClickHouse/pull/31887)（[tavplubix](https://github.com/tavplubix)）。
* 修复了 `empty` 和 `notEmpty` 函数处理 `UUID` 类型参数时的问题。修复 [#31819](https://github.com/ClickHouse/ClickHouse/issues/31819)。[#31883](https://github.com/ClickHouse/ClickHouse/pull/31883) ([Anton Popov](https://github.com/CurtizJ))。
* 在构造 `KeeperTCPHandler` 时，将配置路径从 `keeper_server.session_timeout_ms` 更改为 `keeper_server.coordination_settings.session_timeout_ms`。`operation_timeout` 的配置路径同样进行相同更改。[#31859](https://github.com/ClickHouse/ClickHouse/pull/31859) ([JackyWoo](https://github.com/JackyWoo)).
* 修复在使用 `Nullable` 主键时，对 `Nullable` 类型执行无效 `cast` 的问题。（`Nullable` 主键是一个不推荐使用的特性——请不要使用）。此修复对应 [#31075](https://github.com/ClickHouse/ClickHouse/issues/31075)。[#31823](https://github.com/ClickHouse/ClickHouse/pull/31823)（[Amos Bird](https://github.com/amosbird)）。
* 修复 SQL 中递归 UDF 导致的崩溃。关闭 [#30856](https://github.com/ClickHouse/ClickHouse/issues/30856)。[#31820](https://github.com/ClickHouse/ClickHouse/pull/31820)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复在字典属性类型为 `Nullable` 时使用带类型的 `dictGet` 函数会导致的崩溃。修复了 [#30980](https://github.com/ClickHouse/ClickHouse/issues/30980)。[#31800](https://github.com/ClickHouse/ClickHouse/pull/31800)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复在某些 ODBC 驱动程序下，当 ODBC 查询结果为空时发生的崩溃问题。关闭 [#31465](https://github.com/ClickHouse/ClickHouse/issues/31465)。[#31766](https://github.com/ClickHouse/ClickHouse/pull/31766)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复禁用查询分析器的问题（在 `query_profiler_real_time_period_ns>0`/`query_profiler_cpu_time_period_ns>0` 的情况下，查询结束后查询分析器可能仍然保持启用状态）。 [#31740](https://github.com/ClickHouse/ClickHouse/pull/31740) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在并发执行 `ATTACH PARTITION` 查询时偶发的段错误。[#31738](https://github.com/ClickHouse/ClickHouse/pull/31738) ([tavplubix](https://github.com/tavplubix))。
* 修复 `JSONEachRowWithProgress` 输出格式在数据行与进度行混合输出时出现的竞态问题。 [#31736](https://github.com/ClickHouse/ClickHouse/pull/31736) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复了在执行 `ON CLUSTER` 查询时，如果指定的集群名称是某个 `Replicated` 数据库的名称，会出现 `there are no such cluster here` 错误的问题。 [#31723](https://github.com/ClickHouse/ClickHouse/pull/31723) ([tavplubix](https://github.com/tavplubix)).
* 修复 `decrypt` 函数在某些 Nullable 列上的应用会抛出异常的问题。此更改关闭了 [#31662](https://github.com/ClickHouse/ClickHouse/issues/31662)。此更改关闭了 [#31426](https://github.com/ClickHouse/ClickHouse/issues/31426)。[#31707](https://github.com/ClickHouse/ClickHouse/pull/31707)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在字符串包含 UTF-8 字符时 `ngrams` 固定函数的问题。 [#31706](https://github.com/ClickHouse/ClickHouse/pull/31706) ([yandd](https://github.com/yandd)).
* `input_format_allow_errors_num` 和 `input_format_allow_errors_ratio` 这两个设置在解析 `IPv4` 等域类型时不起作用，现已修复。修复了 [#31686](https://github.com/ClickHouse/ClickHouse/issues/31686)。[#31697](https://github.com/ClickHouse/ClickHouse/pull/31697)（[tavplubix](https://github.com/tavplubix)）。
* 修复了 `MATERIALIZE COLUMN` 中的空指针异常。[#31679](https://github.com/ClickHouse/ClickHouse/pull/31679) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `RENAME TABLE` 查询在尝试重命名 `Ordinary` 数据库中的 DDL 字典时无法正常工作,此问题已修复。[#31638](https://github.com/ClickHouse/ClickHouse/pull/31638) ([tavplubix](https://github.com/tavplubix))。
* 按照原始设计实现 `sparkbar` 聚合函数,详见:[#26175](https://github.com/ClickHouse/ClickHouse/issues/26175)#issuecomment-960353867,[评论](https://github.com/ClickHouse/ClickHouse/issues/26175#issuecomment-961155065)。[#31624](https://github.com/ClickHouse/ClickHouse/pull/31624) ([小路](https://github.com/nicelulu))。
* 修复在仅有列名包含无效 UTF-8 序列时生成的无效 JSON。 [#31534](https://github.com/ClickHouse/ClickHouse/pull/31534) ([Kevin Michel](https://github.com/kmichel-aiven)).
* 在修复该优化中的 bug 之前，禁用 `partial_merge_join_left_table_buffer_bytes`。参见 [#31009](https://github.com/ClickHouse/ClickHouse/issues/31009)。移除冗余选项 `partial_merge_join_optimizations`。[#31528](https://github.com/ClickHouse/ClickHouse/pull/31528) ([Vladimir C](https://github.com/vdimir))。
* 修复短 `INSERT SELECT` 查询的进度。[#31510](https://github.com/ClickHouse/ClickHouse/pull/31510) ([Azat Khuzhin](https://github.com/azat)).
* 修复 `GROUP BY` 与位置参数相关的错误行为。关闭 [#31280](https://github.com/ClickHouse/ClickHouse/issues/31280)#issuecomment-968696186。 [#31420](https://github.com/ClickHouse/ClickHouse/pull/31420)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在 S3 的 STS 凭证提供程序中处理 `nullptr` 问题。[#31409](https://github.com/ClickHouse/ClickHouse/pull/31409) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 从索引分析中移除 `notLike` 函数，因为其实现存在错误。[#31169](https://github.com/ClickHouse/ClickHouse/pull/31169) ([sundyli](https://github.com/sundy-li))。
* 修复 Keeper 中的一个错误：当部分协调日志丢失且存在比最新日志更新的快照时，可能会导致无法启动。[#31150](https://github.com/ClickHouse/ClickHouse/pull/31150) ([alesapin](https://github.com/alesapin))。
* 在本地 `JOIN` 中重写右侧的分布式表。修复了 [#25809](https://github.com/ClickHouse/ClickHouse/issues/25809)。[#31105](https://github.com/ClickHouse/ClickHouse/pull/31105)（[abel-cheng](https://github.com/abel-cheng)）。
* 修复在使用别名和 WHERE 子句时的 `Merge` 表（之前完全无法工作）。关闭 [#28802](https://github.com/ClickHouse/ClickHouse/issues/28802)。[#31044](https://github.com/ClickHouse/ClickHouse/pull/31044)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复带引号标识符的 JSON&#95;VALUE/JSON&#95;QUERY，这样就可以在 JSON 路径中包含空格。关闭 [#30971](https://github.com/ClickHouse/ClickHouse/issues/30971)。[#31003](https://github.com/ClickHouse/ClickHouse/pull/31003) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 在非行向格式中使用 `formatRow` 函数会导致段错误。不允许在此类格式中使用该函数（因为这没有意义）。[#31001](https://github.com/ClickHouse/ClickHouse/pull/31001) ([Kruglov Pavel](https://github.com/Avogar))。
* 修复了一个在删除物化视图后执行 `SELECT` 查询会失败的错误。见 [#30691](https://github.com/ClickHouse/ClickHouse/issues/30691)。[#30997](https://github.com/ClickHouse/ClickHouse/pull/30997) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 在执行 `ATTACH PARTITION ... FROM` 和 `MOVE PARTITION ...` 时跳过 `max_partition_size_to_drop` 检查 [#30995](https://github.com/ClickHouse/ClickHouse/pull/30995) ([Amr Alaa](https://github.com/amralaa-MSFT))。
* 修复 `INTERSECT` 和 `EXCEPT` 运算符的一些边界情况。解决 [#30803](https://github.com/ClickHouse/ClickHouse/issues/30803)。[#30965](https://github.com/ClickHouse/ClickHouse/pull/30965)（[Kseniia Sumarokova](https://github.com/kssenii)）。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement}

- 修复非 x86 构建上的错误过滤结果。此修复关闭了 [#31417](https://github.com/ClickHouse/ClickHouse/issues/31417)。此修复关闭了 [#31524](https://github.com/ClickHouse/ClickHouse/issues/31524)。[#31574](https://github.com/ClickHouse/ClickHouse/pull/31574) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 使 ClickHouse 构建完全可重现(在不同机器上字节完全相同)。此修复关闭了 [#22113](https://github.com/ClickHouse/ClickHouse/issues/22113)。[#31899](https://github.com/ClickHouse/ClickHouse/pull/31899) ([alexey-milovidov](https://github.com/alexey-milovidov))。从二进制文件中移除构建目录的文件系统路径以实现可重现构建。这是为了 [#22113](https://github.com/ClickHouse/ClickHouse/issues/22113)。[#31838](https://github.com/ClickHouse/ClickHouse/pull/31838) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 为 `zlib-ng`、`cassandra`、`mariadb-connector-c`、`xz`、`re2`、`sentry`、`gsasl`、`arrow`、`protobuf` 使用我们自己的 CMakeLists。这是为了 [#20151](https://github.com/ClickHouse/ClickHouse/issues/20151)。部分解决了 [#9226](https://github.com/ClickHouse/ClickHouse/issues/9226)。朝着从构建系统中移除冗余内容迈出的一小步。[#30599](https://github.com/ClickHouse/ClickHouse/pull/30599) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 密闭构建:使用固定版本的 libc 并确保构建期间不使用来自宿主操作系统的源文件或二进制文件。此修复关闭了 [#27133](https://github.com/ClickHouse/ClickHouse/issues/27133)。此修复关闭了 [#21435](https://github.com/ClickHouse/ClickHouse/issues/21435)。此修复关闭了 [#30462](https://github.com/ClickHouse/ClickHouse/issues/30462)。[#30011](https://github.com/ClickHouse/ClickHouse/pull/30011) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 添加函数 `getFuzzerData()` 以便轻松对特定函数进行模糊测试。此修复关闭了 [#23227](https://github.com/ClickHouse/ClickHouse/issues/23227)。[#27526](https://github.com/ClickHouse/ClickHouse/pull/27526) ([Alexey Boykov](https://github.com/mathalex))。
- 更正确地在 Docker 内设置权限能力。[#31802](https://github.com/ClickHouse/ClickHouse/pull/31802) ([Constantine Peresypkin](https://github.com/pkit))。
- 启用 clang `-fstrict-vtable-pointers`、`-fwhole-program-vtables` 编译选项。[#20151](https://github.com/ClickHouse/ClickHouse/pull/20151) ([Maksim Kita](https://github.com/kitaisreal))。
- 避免为 FreeBSD 交叉编译下载工具链压缩包。[#31672](https://github.com/ClickHouse/ClickHouse/pull/31672) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 初步支持 risc-v。有关已测试的特殊问题和构建命令,请参阅 development/build-cross-riscv。[#31309](https://github.com/ClickHouse/ClickHouse/pull/31309) ([Vladimir Smirnov](https://github.com/Civil))。
- 支持在 arm 机器上使用参数 "-DENABLE_TESTS=OFF" 进行编译。[#31007](https://github.com/ClickHouse/ClickHouse/pull/31007) ([zhanghuajie](https://github.com/zhanghuajieHIT))。

### ClickHouse 版本 v21.11, 2021-11-09 {#clickhouse-release-v2111-2021-11-09}

#### 向后不兼容的变更 {#backward-incompatible-change-1}


- 更改 SQL/JSON 函数中 json_path 和 json 参数的顺序(以符合标准)。关闭 [#30449](https://github.com/ClickHouse/ClickHouse/issues/30449)。[#30474](https://github.com/ClickHouse/ClickHouse/pull/30474) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 移除 `MergeTree` 表设置 `write_final_mark`。该设置将始终为 `true`。[#30455](https://github.com/ClickHouse/ClickHouse/pull/30455) ([Kseniia Sumarokova](https://github.com/kssenii))。无需任何操作,所有表均与新版本兼容。
- 函数 `bayesAB` 已被移除。欢迎帮助以更新的形式恢复此函数。关闭 [#26233](https://github.com/ClickHouse/ClickHouse/issues/26233)。[#29934](https://github.com/ClickHouse/ClickHouse/pull/29934) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 仅当您已开始使用实验性的 `clickhouse-keeper` 支持时,此项才相关。现在 ClickHouse Keeper 快照默认使用 `ZSTD` 编解码器压缩,而不是自定义的 ClickHouse LZ4 块压缩。可以通过 `compress_snapshots_with_zstd_format` 协调设置关闭此行为(必须在所有仲裁副本上保持一致)。向后不兼容的情况非常罕见,仅在新节点向无法读取 ZSTD 格式快照的旧节点发送快照时(发生在恢复场景中)才可能出现。[#29417](https://github.com/ClickHouse/ClickHouse/pull/29417) ([alesapin](https://github.com/alesapin))。

#### 新功能 {#new-feature-1}


* 新的异步 INSERT 模式允许在后台累积插入的数据，并以单个批次进行存储。在客户端，可以通过为带有内联数据或在单独缓冲区中携带数据的 `INSERT` 查询（例如通过 HTTP 协议发送的 `INSERT` 查询）设置 `async_insert` 来启用此模式。如果 `wait_for_async_insert` 为 true（默认值），客户端将会等待直到数据被刷写到表中。在服务端，则通过 `async_insert_threads`、`async_insert_max_data_size` 和 `async_insert_busy_timeout_ms` 这些设置进行控制。实现了 [#18282](https://github.com/ClickHouse/ClickHouse/issues/18282)。[#27537](https://github.com/ClickHouse/ClickHouse/pull/27537)（[Anton Popov](https://github.com/CurtizJ)）。[#20557](https://github.com/ClickHouse/ClickHouse/pull/20557)（[Ivan](https://github.com/abyss7)）。关于性能的说明：使用异步插入时，你每秒最多可以执行大约 10 000 个独立的 INSERT 查询，因此如果你希望达到每秒插入数百万行的性能，仍然建议采用批量插入的方式。
* 为 `clickhouse-local` 添加交互模式。这样，你可以直接运行 `clickhouse-local`，在无需连接服务器的情况下使用命令行 ClickHouse 接口，并处理来自文件和外部数据源的数据。同时合并 `clickhouse-client` 和 `clickhouse-local` 的代码。关闭 [#7203](https://github.com/ClickHouse/ClickHouse/issues/7203)。关闭 [#25516](https://github.com/ClickHouse/ClickHouse/issues/25516)。关闭 [#22401](https://github.com/ClickHouse/ClickHouse/issues/22401)。[#26231](https://github.com/ClickHouse/ClickHouse/pull/26231)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 新增对可执行（可脚本化）用户自定义函数的支持。这类 UDF 可以使用任意编程语言编写。[#28803](https://github.com/ClickHouse/ClickHouse/pull/28803) ([Maksim Kita](https://github.com/kitaisreal))。
* 允许预定义到外部数据源的连接。这样在使用外部数据源时就无需指定凭据或地址，可以改为通过名称引用。关闭了 [#28367](https://github.com/ClickHouse/ClickHouse/issues/28367)。[#28577](https://github.com/ClickHouse/ClickHouse/pull/28577)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在 `system` 数据库的相应表中新增了 `INFORMATION_SCHEMA` 数据库及其 `SCHEMATA`、`TABLES`、`VIEWS` 和 `COLUMNS` 视图。修复了 [#9770](https://github.com/ClickHouse/ClickHouse/issues/9770)。[#28691](https://github.com/ClickHouse/ClickHouse/pull/28691)（[tavplubix](https://github.com/tavplubix)）。
* 支持 `EXISTS (subquery)`。修复 [#6852](https://github.com/ClickHouse/ClickHouse/issues/6852)。[#29731](https://github.com/ClickHouse/ClickHouse/pull/29731)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 用于审计的会话日志。将所有成功和失败的登录与登出事件记录到新的 `system.session_log` 表中。[#22415](https://github.com/ClickHouse/ClickHouse/pull/22415) ([Vasily Nemkov](https://github.com/Enmk)) ([Vitaly Baranov](https://github.com/vitlibar))。
* 支持多维余弦距离和欧几里得距离函数；L1、L2、Lp、Linf 距离和范数。支持元组的标量积以及多种元组算术运算符。此更改完整解决了 [#4509](https://github.com/ClickHouse/ClickHouse/issues/4509) 并带来更多改进。[#27933](https://github.com/ClickHouse/ClickHouse/pull/27933)（[Alexey Boykov](https://github.com/mathalex)）。
* 为 `INTO OUTFILE` 和 `FROM INFILE` 增加压缩和解压缩功能（支持自动检测或通过额外可选参数指定）。 [#27135](https://github.com/ClickHouse/ClickHouse/pull/27135) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* 通过 HTTP `OPTIONS` 请求添加 CORS（跨源资源共享）支持。这意味着，现在 Grafana 可以在无需各种权宜之计的情况下与无服务器请求正常协作。修复 [#18693](https://github.com/ClickHouse/ClickHouse/issues/18693)。[#29155](https://github.com/ClickHouse/ClickHouse/pull/29155)（[Filatenkov Artur](https://github.com/FArthur-cmd)）。
* 带有 `JOIN ON` 的查询现在支持使用逻辑或（`OR`）。 [#21320](https://github.com/ClickHouse/ClickHouse/pull/21320) ([Ilya Golshtein](https://github.com/ilejn)).
* 新增函数 `tokens`，允许使用非字母数字的 ASCII 字符作为分隔符，将字符串拆分为多个 token。 [#29981](https://github.com/ClickHouse/ClickHouse/pull/29981) ([Maksim Kita](https://github.com/kitaisreal))。新增函数 `ngrams`，用于从文本中提取 n-gram。修复了问题 [#29699](https://github.com/ClickHouse/ClickHouse/issues/29699)。 [#29738](https://github.com/ClickHouse/ClickHouse/pull/29738) ([Maksim Kita](https://github.com/kitaisreal))。
* 新增 Unicode 规范化函数：`normalizeUTF8NFC`、`normalizeUTF8NFD`、`normalizeUTF8NFKC`、`normalizeUTF8NFKD`。 [#28633](https://github.com/ClickHouse/ClickHouse/pull/28633) ([darkkeks](https://github.com/darkkeks)).
* 在 ClickHouse 中使用 `FileLog` 表引擎对应用日志文件进行流式消费。它类似于 `Kafka` 或 `RabbitMQ` 引擎，但面向本地文件系统中仅追加且会轮转的日志。关闭了 [#6953](https://github.com/ClickHouse/ClickHouse/issues/6953)。[#25969](https://github.com/ClickHouse/ClickHouse/pull/25969)（[flynn](https://github.com/ucasfl)）（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 添加 `CapnProto` 输出格式，并重构 `CapnProto` 输入格式。 [#29291](https://github.com/ClickHouse/ClickHouse/pull/29291) ([Kruglov Pavel](https://github.com/Avogar)).
* 允许在查询中以二进制字面量形式书写数字。例如 `SELECT 0b001;`。 [#29304](https://github.com/ClickHouse/ClickHouse/pull/29304) ([Maksim Kita](https://github.com/kitaisreal)).
* 新增 `hashed_array` 字典类型。在使用包含多个属性的字典时可以节省内存。关闭 [#30236](https://github.com/ClickHouse/ClickHouse/issues/30236)。[#30242](https://github.com/ClickHouse/ClickHouse/pull/30242) ([Maksim Kita](https://github.com/kitaisreal)).
* 新增了 `JSONExtractKeys` 函数。 [#30056](https://github.com/ClickHouse/ClickHouse/pull/30056) ([Vitaly](https://github.com/orloffv)).
* 新增函数 `getOSKernelVersion` —— 返回操作系统内核版本的字符串。 [#29755](https://github.com/ClickHouse/ClickHouse/pull/29755) ([Memo](https://github.com/Joeywzr)).
* 新增了 `MD4` 和 `SHA384` 函数。`MD4` 是一种已过时且不安全的哈希函数，只应在极少数情况下使用，例如某些遗留系统已经在使用 `MD4`，而你需要获得完全相同的结果。[#29602](https://github.com/ClickHouse/ClickHouse/pull/29602) ([Nikita Tikhomirov](https://github.com/NSTikhomirov))。
* 可以通过在配置文件中将 `hsts_max_age` 设置为正值，为 ClickHouse HTTP 服务器启用 HSTS。 [#29516](https://github.com/ClickHouse/ClickHouse/pull/29516) ([凌涛](https://github.com/lingtaolf))。
* 支持华为 OBS 存储。修复 [#24294](https://github.com/ClickHouse/ClickHouse/issues/24294)。[#29511](https://github.com/ClickHouse/ClickHouse/pull/29511)（[kevin wan](https://github.com/MaxWk)）。
* 新增函数 `mapContainsKeyLike`，用于获取键名匹配简单正则表达式的 `map`。 [#29471](https://github.com/ClickHouse/ClickHouse/pull/29471) ([凌涛](https://github.com/lingtaolf))。新增函数 `mapExtractKeyLike`，用于获取仅保留与指定模式匹配元素的 `map`。 [#30793](https://github.com/ClickHouse/ClickHouse/pull/30793) ([凌涛](https://github.com/lingtaolf))。
* 已实现 `ALTER TABLE x MODIFY COMMENT`。 [#29264](https://github.com/ClickHouse/ClickHouse/pull/29264) ([Vasily Nemkov](https://github.com/Enmk))。
* 添加了 ClickHouse 中原本缺失、但可通过 H3 API 使用的 H3 检查函数： [https://h3geo.org/docs/api/inspection](https://h3geo.org/docs/api/inspection)。 [#29209](https://github.com/ClickHouse/ClickHouse/pull/29209) ([Bharat Nallan](https://github.com/bharatnc))。
* 允许在 Replicated 数据库中对非复制表执行 `ALTER TABLE FETCH` 和 `ATTACH` 操作。 [#29202](https://github.com/ClickHouse/ClickHouse/pull/29202) ([Kevin Michel](https://github.com/kmichel-aiven)).
* 新增了设置 `output_format_csv_null_representation`：其作用与 `output_format_tsv_null_representation` 相同，但用于 CSV 输出。[#29123](https://github.com/ClickHouse/ClickHouse/pull/29123) ([PHO](https://github.com/depressed-pho))。
* 新增函数 `zookeeperSessionUptime()`，用于返回当前 ZooKeeper 会话的已运行时间（以秒为单位）。[#28983](https://github.com/ClickHouse/ClickHouse/pull/28983) ([tavplubix](https://github.com/tavplubix))。
* 实现了 `h3ToGeoBoundary` 函数。[#28952](https://github.com/ClickHouse/ClickHouse/pull/28952)（[Ivan Veselov](https://github.com/fuzzERot)）。
* 新增聚合函数 `exponentialMovingAverage`,可用作窗口函数。此更新解决了 [#27511](https://github.com/ClickHouse/ClickHouse/issues/27511)。[#28914](https://github.com/ClickHouse/ClickHouse/pull/28914) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 允许在 `DESCRIBE` 查询结果中包含表中列的子列（可通过设置 `describe_include_subcolumns` 启用）。 [#28905](https://github.com/ClickHouse/ClickHouse/pull/28905) ([Anton Popov](https://github.com/CurtizJ))。
* `Executable`、`ExecutablePool` 新增了选项 `send_chunk_header`。如果该选项为 true，则会在发送分块之前，先将带有换行符的分块行数（rows&#95;count）发送给客户端。[#28833](https://github.com/ClickHouse/ClickHouse/pull/28833) ([Maksim Kita](https://github.com/kitaisreal))。
* `tokenbf_v1` 和 `ngram` 现在支持键类型为 String 或 FixedSring 的 Map。这提升了在带有 map 键过滤条件的查询中的数据跳过效果。`sql CREATE TABLE map_tokenbf ( row_id UInt32, map Map(String, String), INDEX map_tokenbf map TYPE ngrambf_v1(4,256,2,0) GRANULARITY 1 ) Engine=MergeTree() Order by id ` 使用上述表时，查询 `select * from map_tokebf where map['K']='V'` 将跳过不包含键 `A` 的数据块。当然，实际能跳过多少行取决于你设置的 `granularity` 和 `index_granularity`。[#28511](https://github.com/ClickHouse/ClickHouse/pull/28511) ([凌涛](https://github.com/lingtaolf))。
* 将 profile 事件从服务器发送到客户端。引入了新的数据包类型 `ProfileEvents`。修复 [#26177](https://github.com/ClickHouse/ClickHouse/issues/26177)。[#28364](https://github.com/ClickHouse/ClickHouse/pull/28364)（[Dmitry Novik](https://github.com/novikd)）。
* 为 `FixedString` 和 `String` 数据类型添加位移操作。这一更改关闭了 [#27763](https://github.com/ClickHouse/ClickHouse/issues/27763)。[#28325](https://github.com/ClickHouse/ClickHouse/pull/28325)（[小路](https://github.com/nicelulu)）。
* 支持在数据库引擎 `MaterializedPostgreSQL` 中动态添加/删除从 PostgreSQL 进行复制的表。支持通过 `ALTER` 修改数据库设置。修复 [#27573](https://github.com/ClickHouse/ClickHouse/issues/27573)。[#28301](https://github.com/ClickHouse/ClickHouse/pull/28301) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 新增函数 accurateCastOrDefault(x, T)。解决 [#21330](https://github.com/ClickHouse/ClickHouse/issues/21330)。作者 @taiyang-li。 [#23028](https://github.com/ClickHouse/ClickHouse/pull/23028)（[Maksim Kita](https://github.com/kitaisreal)）。
* 新增函数 `toUUIDOrDefault`、`toUInt8/16/32/64/256OrDefault`、`toInt8/16/32/64/128/256OrDefault`，允许用户在字符串解析失败时自定义默认值（非 NULL）。 [#21330](https://github.com/ClickHouse/ClickHouse/pull/21330) ([taiyang-li](https://github.com/taiyang-li)).

#### 性能改进 {#performance-improvement-1}


* 后台合并操作可以相互抢占，并按照适当的优先级进行调度。现在，长时间运行的合并不会阻止短时间合并的执行。这对于更好地调度和控制合并执行至关重要，可以降低出现&quot;分区过多&quot;错误的几率。[#22381](https://github.com/ClickHouse/ClickHouse/issues/22381)。[#25165](https://github.com/ClickHouse/ClickHouse/pull/25165) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。新增了执行数量超过后台池线程数的合并和变更操作的能力。合并和变更将根据其大小按步骤执行（较小的具有更高优先级）。任务数与执行线程数的比率由设置 `background_merges_mutations_concurrency_ratio` 控制，默认值为 2。[#29140](https://github.com/ClickHouse/ClickHouse/pull/29140) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 允许对远程文件系统使用异步读取，从而在从远程文件系统读取时减少寻道次数。这极大地提升了性能，并使实验性的 `web` 和 `s3` 磁盘在某些条件下运行速度甚至快于 EBS。 [#29205](https://github.com/ClickHouse/ClickHouse/pull/29205) ([Kseniia Sumarokova](https://github.com/kssenii))。与此同时，`web` 磁盘类型（托管在 Web 服务器上的静态数据集）已从实验特性毕业，成为可用于生产环境的功能。
* 在 `clickhouse-client` 中，带有 `INTO OUTFILE` 的查询现在将使用多线程。修复了在使用 `INTO OUTFILE` 时进度条闪烁的问题。此更改关闭了 [#30873](https://github.com/ClickHouse/ClickHouse/issues/30873)。此更改关闭了 [#30872](https://github.com/ClickHouse/ClickHouse/issues/30872)。[#30886](https://github.com/ClickHouse/ClickHouse/pull/30886) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 减少某些类型的 `SELECT` 查询从磁盘读取的冗余压缩数据量（仅适用于 `MergeTree` 引擎家族）。[#30111](https://github.com/ClickHouse/ClickHouse/pull/30111) ([alesapin](https://github.com/alesapin))。
* 在读取 MergeTree 系列表引擎中的压缩数据块时，移除了一些多余的 `seek` 调用。[#29766](https://github.com/ClickHouse/ClickHouse/pull/29766) ([alesapin](https://github.com/alesapin))。
* 使 `url` 表函数能够并行处理多个 URL。此更改解决了 [#29670](https://github.com/ClickHouse/ClickHouse/issues/29670) 和 [#29671](https://github.com/ClickHouse/ClickHouse/issues/29671)。[#29673](https://github.com/ClickHouse/ClickHouse/pull/29673)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在启用 `optimize_aggregation_in_order` 设置时，提升按主键顺序执行聚合的性能。 [#30266](https://github.com/ClickHouse/ClickHouse/pull/30266) ([Anton Popov](https://github.com/CurtizJ)).
* 现在 ClickHouse 在与外部 S3 通信时会使用 DNS 缓存。[#29999](https://github.com/ClickHouse/ClickHouse/pull/29999) ([alesapin](https://github.com/alesapin))。
* 为外部数据库（如 MySQL）添加对下推 `IS NULL`/`IS NOT NULL` 的支持。[#29463](https://github.com/ClickHouse/ClickHouse/pull/29463) ([Azat Khuzhin](https://github.com/azat))。将 `isNull`/`isNotNull` 转换为 `IS NULL`/`IS NOT NULL`（用于外部数据库，如 MySQL）。[#29446](https://github.com/ClickHouse/ClickHouse/pull/29446) ([Azat Khuzhin](https://github.com/azat))。
* 对 Dictionary 表的 SELECT 查询将使用多线程。[#30500](https://github.com/ClickHouse/ClickHouse/pull/30500) ([Maksim Kita](https://github.com/kitaisreal))。
* 提升对 `Decimal` 列进行过滤（WHERE 操作）时的性能。[#30431](https://github.com/ClickHouse/ClickHouse/pull/30431)（[Jun Jin](https://github.com/vesslanjin)）。
* 在过滤操作中使用基于 `popcnt`/`ctz` 的更优实现来移除分支较多的代码，从而提升性能。 [#29881](https://github.com/ClickHouse/ClickHouse/pull/29881) ([Jun Jin](https://github.com/vesslanjin)).
* 改进用于 WHERE 运算符的过滤 bytemask 生成器函数，将 SSE/AVX2/AVX512 指令的实现整合为一体。注意，默认情况下 ClickHouse 只使用 SSE，因此此改进仅与自定义构建相关。[#30014](https://github.com/ClickHouse/ClickHouse/pull/30014) ([jasperzhu](https://github.com/jinjunzh))。[#30670](https://github.com/ClickHouse/ClickHouse/pull/30670) ([jasperzhu](https://github.com/jinjunzh))。
* 提升对 `Nullable` 浮点数执行 `SUM` 聚合函数时的性能。 [#28906](https://github.com/ClickHouse/ClickHouse/pull/28906) ([Raúl Marín](https://github.com/Algunenano)).
* 在使用多个磁盘时加速数据分片加载过程。其思路类似于 [https://github.com/ClickHouse/ClickHouse/pull/16423](https://github.com/ClickHouse/ClickHouse/pull/16423)。生产环境中表现出性能提升：24 分钟 → 16 分钟。[#28363](https://github.com/ClickHouse/ClickHouse/pull/28363)（[Amos Bird](https://github.com/amosbird)）。
* 将 S3 分段上传的默认分片大小调小，以降低内存占用。[#28679](https://github.com/ClickHouse/ClickHouse/pull/28679) ([ianton-ru](https://github.com/ianton-ru))。
* 优化 `bitmapAnd` 函数性能。 [#28332](https://github.com/ClickHouse/ClickHouse/pull/28332) ([dddounaiking](https://github.com/OodounaikingoO)).
* 在合并仍在进行时，移除了 `StorageMergeTree` 中次优的变更通知。[#27552](https://github.com/ClickHouse/ClickHouse/pull/27552) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 尝试优化字符串比较的性能。 [#28767](https://github.com/ClickHouse/ClickHouse/pull/28767) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 主键索引和分区过滤现在可以作用于 `tuple`。[#29281](https://github.com/ClickHouse/ClickHouse/pull/29281) ([凌涛](https://github.com/lingtaolf))。
* 如果查询中包含多个具有相同参数但 `level` 参数不同的 `quantile` 聚合函数，并且启用了 `optimize_syntax_fuse_functions` 设置，这些函数会被合并，并在一次遍历中完成执行。[#26657](https://github.com/ClickHouse/ClickHouse/pull/26657) ([hexiaoting](https://github.com/hexiaoting))。
* 现在，针对主键第一个表达式的 `min`/`max` 聚合已通过 projection 得到优化。这是为了解决 [#329](https://github.com/ClickHouse/ClickHouse/issues/329)。[#29918](https://github.com/ClickHouse/ClickHouse/pull/29918)（[Amos Bird](https://github.com/amosbird)）。

#### 实验性功能 {#experimental-feature-1}

- 为 ClickHouse Keeper 添加了在 `.xml` 文件中更改节点配置的能力。[#30372](https://github.com/ClickHouse/ClickHouse/pull/30372) ([alesapin](https://github.com/alesapin))。
- 添加了 `sparkbar` 聚合函数。此更改关闭了 [#26175](https://github.com/ClickHouse/ClickHouse/issues/26175)。[#27481](https://github.com/ClickHouse/ClickHouse/pull/27481) ([小路](https://github.com/nicelulu))。注意:该函数存在一个缺陷,其行为将在未来版本中更改。

#### 改进 {#improvement-1}


* 允许用户在无需重启的情况下修改日志级别。[#29586](https://github.com/ClickHouse/ClickHouse/pull/29586) ([Nikolay Degterinsky](https://github.com/evillique))。
* SQL UDF 的多项改进。用于操作 SQL 用户定义函数的查询现已支持 ON CLUSTER 子句。示例:`CREATE FUNCTION test_function ON CLUSTER 'cluster' AS x -> x + 1;`。关闭 [#30666](https://github.com/ClickHouse/ClickHouse/issues/30666)。[#30734](https://github.com/ClickHouse/ClickHouse/pull/30734) ([Maksim Kita](https://github.com/kitaisreal))。支持 `CREATE OR REPLACE`、`CREATE IF NOT EXISTS` 语法。[#30454](https://github.com/ClickHouse/ClickHouse/pull/30454) ([Maksim Kita](https://github.com/kitaisreal))。新增 DROP IF EXISTS 支持。示例:`DROP FUNCTION IF EXISTS test_function`。[#30437](https://github.com/ClickHouse/ClickHouse/pull/30437) ([Maksim Kita](https://github.com/kitaisreal))。支持 Lambda 表达式。示例:`CREATE FUNCTION lambda_function AS x -> arrayMap(element -> element * 2, x);`。[#30435](https://github.com/ClickHouse/ClickHouse/pull/30435) ([Maksim Kita](https://github.com/kitaisreal))。`clickhouse-local` 现已支持 SQL 用户定义函数。[#30179](https://github.com/ClickHouse/ClickHouse/pull/30179) ([Maksim Kita](https://github.com/kitaisreal))。
* 在全局范围内启用按查询的内存分析器（将 `memory_profiler_step` 设置为 4MiB）。[#29455](https://github.com/ClickHouse/ClickHouse/pull/29455)（[Azat Khuzhin](https://github.com/azat)）。
* 在 `system.data_skipping_indices` 中新增列 `data_compressed_bytes`、`data_uncompressed_bytes`、`marks_bytes`。在 `system.parts` 中新增列 `secondary_indices_compressed_bytes`、`secondary_indices_uncompressed_bytes`、`secondary_indices_marks_bytes`。修复 [#29697](https://github.com/ClickHouse/ClickHouse/issues/29697)。[#29896](https://github.com/ClickHouse/ClickHouse/pull/29896)（[Maksim Kita](https://github.com/kitaisreal)）。
* 在 `system.tables` 中添加 `table` 别名，在 `system.databases` 中添加 `database` 别名 [#29677](https://github.com/ClickHouse/ClickHouse/issues/29677)。 [#29882](https://github.com/ClickHouse/ClickHouse/pull/29882) ([kevin wan](https://github.com/MaxWk))。
* 在服务器启动时正确处理表之间的相互依赖关系。修复 [#8004](https://github.com/ClickHouse/ClickHouse/issues/8004)、[#15170](https://github.com/ClickHouse/ClickHouse/issues/15170)。[#28373](https://github.com/ClickHouse/ClickHouse/pull/28373)（[tavplubix](https://github.com/tavplubix)）。
* 在函数 `divide`、`intDiv` 和 `modulo` 中，当分母为 Nullable 时，避免出现 “Division by zero” 错误。修复了 [#22621](https://github.com/ClickHouse/ClickHouse/issues/22621)。[#28352](https://github.com/ClickHouse/ClickHouse/pull/28352)（[Kruglov Pavel](https://github.com/Avogar)）。
* 允许在文本格式中将 `Date` 数据类型的值除 `YYYY-MM-DD` 外，也解析为 `YYYYMMDD`。关闭了 [#30870](https://github.com/ClickHouse/ClickHouse/issues/30870)。[#30871](https://github.com/ClickHouse/ClickHouse/pull/30871)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* Web UI：在表格单元格中渲染柱状条。[#29792](https://github.com/ClickHouse/ClickHouse/pull/29792) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 用户现在可以在创建字典时添加注释：`CREATE DICTIONARY ... COMMENT 'vaue'` ... [#29899](https://github.com/ClickHouse/ClickHouse/pull/29899) ([Vasily Nemkov](https://github.com/Enmk))。用户现在也可以在 `CREATE DATABASE` 语句中为数据库添加注释 ... [#29429](https://github.com/ClickHouse/ClickHouse/pull/29429) ([Vasily Nemkov](https://github.com/Enmk))。
* 引入 `compiled_expression_cache_elements_size` 设置。如果你打算使用此设置，你自然已经知道它的作用。[#30667](https://github.com/ClickHouse/ClickHouse/pull/30667) ([Maksim Kita](https://github.com/kitaisreal)).
* `clickhouse-format` 现在支持 `--query` 选项。在之前的版本中，必须通过 stdin 传递查询。[#29325](https://github.com/ClickHouse/ClickHouse/pull/29325) ([凌涛](https://github.com/lingtaolf)).
* 为 `Memory` 数据库中的表增加对 `ALTER TABLE` 的支持。`Memory` 数据库用于 `clickhouse-local` 中。[#30866](https://github.com/ClickHouse/ClickHouse/pull/30866) ([tavplubix](https://github.com/tavplubix))。
* 现在，`arrayStringConcat` 已支持由所有可序列化类型组成的数组。[#30840](https://github.com/ClickHouse/ClickHouse/pull/30840)（[Nickita Taranov](https://github.com/nickitat)）。
* ClickHouse 现在在获取系统内存总量时会考虑 docker/cgroups 的限制。参见 [#25662](https://github.com/ClickHouse/ClickHouse/issues/25662)。[#30574](https://github.com/ClickHouse/ClickHouse/pull/30574)（[Pavel Medvedev](https://github.com/pmed)）。
* 现在为 PostgreSQL 数据库获取的表结构信息更加可靠。[#30477](https://github.com/ClickHouse/ClickHouse/pull/30477) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 在 `GROUP BY` 和 `ORDER BY` 中完全支持位置参数。 [#30433](https://github.com/ClickHouse/ClickHouse/pull/30433) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 允许使用 JSONExtractString 将非字符串元素提取为字符串。此更改用于解决 [pull/25452#issuecomment-927123287](https://github.com/ClickHouse/ClickHouse/pull/25452#issuecomment-927123287)。[#30426](https://github.com/ClickHouse/ClickHouse/pull/30426)（[Amos Bird](https://github.com/amosbird)）。
* 新增了在 `GraphiteMergeTree` 表的 SELECT 查询中使用 FINAL 子句的能力。[#30360](https://github.com/ClickHouse/ClickHouse/pull/30360) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 在副本克隆以及为损坏的分片入队获取任务方面进行了小幅改进，应当可以避免在极少数情况下复制队列中的 `GET_PART` 条目出现长时间挂起。 [#30346](https://github.com/ClickHouse/ClickHouse/pull/30346) ([tavplubix](https://github.com/tavplubix))。
* 允许在 `user_files` 目录中对文件表函数使用符号链接。 [#30309](https://github.com/ClickHouse/ClickHouse/pull/30309) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 修正了 `Date32` 与 `Date`、`DateTime`、`DateTime64` 和 `String` 类型之间的比较。[#30219](https://github.com/ClickHouse/ClickHouse/pull/30219)（[liang.huang](https://github.com/lhuang09287750)）。
* 允许从 `MergeTree` 表中删除 `SAMPLE BY` 表达式（`ALTER TABLE <table> REMOVE SAMPLE BY`）。[#30180](https://github.com/ClickHouse/ClickHouse/pull/30180)（[Anton Popov](https://github.com/CurtizJ)）。
* 现在，如果 `Keeper`（作为 `clickhouse-server` 的一部分）能够连接到其他节点，它将以异步方式启动。[#30170](https://github.com/ClickHouse/ClickHouse/pull/30170) ([alesapin](https://github.com/alesapin))。
* 现在 `clickhouse-client` 原生支持多行编辑。[#30143](https://github.com/ClickHouse/ClickHouse/pull/30143) ([Amos Bird](https://github.com/amosbird))。
* `polygon` 字典（反向地理编码）：当设置 `store_polygon_key_column` = true 时，新增支持通过 SELECT 查询方式读取字典内容。关闭 [#30090](https://github.com/ClickHouse/ClickHouse/issues/30090)。[#30142](https://github.com/ClickHouse/ClickHouse/pull/30142)（[Maksim Kita](https://github.com/kitaisreal)）。
* 在 Play UI 中添加 ClickHouse 徽标。 [#29674](https://github.com/ClickHouse/ClickHouse/pull/29674) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 在从 `Arrow`、`ArrowStream`、`Parquet` 和 `ORC` 等 Arrow 支持的格式读取列时，提供了更清晰的异常信息。由此关闭了 [#29926](https://github.com/ClickHouse/ClickHouse/issues/29926)。[#29927](https://github.com/ClickHouse/ClickHouse/pull/29927)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `Buffer` 表中 `flush` 与启动过程之间的数据竞争问题。该问题可能在测试中出现。 [#29930](https://github.com/ClickHouse/ClickHouse/pull/29930) ([Azat Khuzhin](https://github.com/azat)).
* 修复 `DatabaseMemory` 的 `DROP TABLE` 与 `LiveView` 之间的 `lock-order-inversion` 问题。Live View 是一个实验性功能。Memory 数据库用于 clickhouse-local。[#29929](https://github.com/ClickHouse/ClickHouse/pull/29929) ([Azat Khuzhin](https://github.com/azat)).
* 修复周期性字典重载与配置重载之间的锁顺序反转问题。 [#29928](https://github.com/ClickHouse/ClickHouse/pull/29928) ([Azat Khuzhin](https://github.com/azat)).
* 将 zoneinfo 文件更新到 2021c。 [#29925](https://github.com/ClickHouse/ClickHouse/pull/29925) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 为 `clickhouse-copier` 增加可配置重试次数及重试间隔的功能。[#29921](https://github.com/ClickHouse/ClickHouse/pull/29921)（[Azat Khuzhin](https://github.com/azat)）。
* 添加 `shutdown_wait_unfinished_queries` 服务器设置，以允许在最多 `shutdown_wait_unfinished` 时间内等待正在运行的查询。这针对 [#24451](https://github.com/ClickHouse/ClickHouse/issues/24451)。[#29914](https://github.com/ClickHouse/ClickHouse/pull/29914)（[Amos Bird](https://github.com/amosbird)）。
* 新增对峰值内存使用情况进行追踪的功能（在 `system.trace_log` 中新增 `trace_type`：`MemoryPeak`）。[#29858](https://github.com/ClickHouse/ClickHouse/pull/29858) ([Azat Khuzhin](https://github.com/azat))。
* PostgreSQL 外部表：在用于获取副本标识索引的查询中，为分区表名称新增了前缀 &#39;p&#39;。 [#29828](https://github.com/ClickHouse/ClickHouse/pull/29828) ([Shoh Jahon](https://github.com/Shohjahon)).
* 在 mutate/merge 期间应用 `max_untracked_memory`/`memory_profiler_step`/`memory_profiler_sample_probability`，以在合并时对内存使用情况进行分析。 [#29681](https://github.com/ClickHouse/ClickHouse/pull/29681) ([Azat Khuzhin](https://github.com/azat)).
* 查询混淆器：`clickhouse-format --obfuscate` 现在可以处理更多类型的查询。[#29672](https://github.com/ClickHouse/ClickHouse/pull/29672) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了一个问题：`clickhouse-format --obfuscate` 无法处理包含嵌入式字典（`regionTo...` 等函数）的查询。 [#29667](https://github.com/ClickHouse/ClickHouse/pull/29667) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复 JSON 函数对 `Nullable` 的错误处理。此修复对应 [#29615](https://github.com/ClickHouse/ClickHouse/issues/29615)。由于 [https://github.com/ClickHouse/ClickHouse/pull/28012](https://github.com/ClickHouse/ClickHouse/pull/28012) 尚未发布，因此将其标记为改进项。[#29659](https://github.com/ClickHouse/ClickHouse/pull/29659)（[Amos Bird](https://github.com/amosbird)）。
* 默认将 `listen_backlog` 的值提高（与较新 Linux 内核中的默认值保持一致）。[#29643](https://github.com/ClickHouse/ClickHouse/pull/29643) ([Azat Khuzhin](https://github.com/azat)).
* 当服务器配置项 `dictionaries_config`、`models_config`、`user_defined_executable_functions_config` 发生变化时，重新加载字典、模型以及用户定义的可执行函数。修复 [#28142](https://github.com/ClickHouse/ClickHouse/issues/28142)。[#29529](https://github.com/ClickHouse/ClickHouse/pull/29529) ([Maksim Kita](https://github.com/kitaisreal)).
* 移除了对投影名称的无谓限制。现在投影名称可以以 `tmp_` 开头。[#29520](https://github.com/ClickHouse/ClickHouse/pull/29520) ([Amos Bird](https://github.com/amosbird))。
* 修复了在包含嵌套子查询的 mutation 中出现的 `There is no query or query context has expired` 错误。如果表是复制表并且禁用了 `allow_nondeterministic_mutations` 设置，则不允许在 mutation 中使用子查询。 [#29495](https://github.com/ClickHouse/ClickHouse/pull/29495) ([tavplubix](https://github.com/tavplubix)).
* 在运行时应用对 `max_concurrent_queries` 的配置更改（无需重启）。[#29414](https://github.com/ClickHouse/ClickHouse/pull/29414) ([Raúl Marín](https://github.com/Algunenano))。
* 新增设置 `use_skip_indexes`。[#29405](https://github.com/ClickHouse/ClickHouse/pull/29405)（[Maksim Kita](https://github.com/kitaisreal)）。
* 为内存分片添加对 `FREEZE`（用于备份）的支持。 [#29376](https://github.com/ClickHouse/ClickHouse/pull/29376) ([Mo Xuan](https://github.com/mo-avatar)).
* 为 `clickhouse-benchmark` 传递初始 `query_id`（此前如果通过 `clickhouse-benchmark` 运行远程查询，分片上的查询不会通过 `initial_query_id` 关联到初始查询）。[#29364](https://github.com/ClickHouse/ClickHouse/pull/29364) ([Azat Khuzhin](https://github.com/azat)).
* 跳过索引 `tokenbf_v1` 和 `ngrambf_v1`：新增对键为 `String` 或 `FixedString` 类型的 `Array` 数据类型的支持。 [#29280](https://github.com/ClickHouse/ClickHouse/pull/29280) ([Maksim Kita](https://github.com/kitaisreal))。跳过索引 `tokenbf_v1` 和 `ngrambf_v1` 新增对键为 `String` 或 `FixedString` 类型的 `Map` 数据类型的支持。作者 @lingtaolf。 [#29220](https://github.com/ClickHouse/ClickHouse/pull/29220) ([Maksim Kita](https://github.com/kitaisreal))。
* 函数 `has`：新增对 `Map` 数据类型的支持。 [#29267](https://github.com/ClickHouse/ClickHouse/pull/29267) ([Maksim Kita](https://github.com/kitaisreal)).
* 为 clickhouse-keeper 新增 `compress_logs` 设置，用于使用 `ZSTD` 压缩 clickhouse-keeper 日志（用于 replicated state machine）。实现：[#26977](https://github.com/ClickHouse/ClickHouse/issues/26977)。[#29223](https://github.com/ClickHouse/ClickHouse/pull/29223) ([alesapin](https://github.com/alesapin))。
* 新增设置 `external_table_strict_query` - 该设置将强制向外部数据库传递完整的 WHERE 表达式,即使表达式不兼容也会传递。[#29206](https://github.com/ClickHouse/ClickHouse/pull/29206) ([Azat Khuzhin](https://github.com/azat))。
* 在使用 `ARRAY JOIN` 时禁用投影。在早期版本中，投影分析可能会破坏 ARRAY JOIN 中的别名。[#29139](https://github.com/ClickHouse/ClickHouse/pull/29139)（[Amos Bird](https://github.com/amosbird)）。
* 在 `MsgPack` 输入/输出格式中支持更多数据类型。[#29077](https://github.com/ClickHouse/ClickHouse/pull/29077) ([Kruglov Pavel](https://github.com/Avogar))。
* 允许在 `ORC` 输入/输出格式中读写 `LowCardinality` 列。[#29062](https://github.com/ClickHouse/ClickHouse/pull/29062) ([Kruglov Pavel](https://github.com/Avogar)).
* 从 `system.distributed_ddl_queue` 中执行 SELECT 查询可能会显示不正确的值，该问题已修复。[#29061](https://github.com/ClickHouse/ClickHouse/pull/29061) ([tavplubix](https://github.com/tavplubix)).
* 修正了 HTTP 连接中处理未知方法时的行为。解决了 [#29050](https://github.com/ClickHouse/ClickHouse/issues/29050)。[#29057](https://github.com/ClickHouse/ClickHouse/pull/29057)（[Filatenkov Artur](https://github.com/FArthur-cmd)）。
* `clickhouse-keeper`：修复 `clickhouse-keeper-converter` 中的一个 bug，该 bug 在从 ZooKeeper 日志（非快照）恢复时可能导致部分数据丢失。[#29030](https://github.com/ClickHouse/ClickHouse/pull/29030) ([小路](https://github.com/nicelulu))。修复 `clickhouse-keeper-converter` 中的一个 bug，该 bug 可能导致 ZooKeeper 日志反序列化不正确。[#29071](https://github.com/ClickHouse/ClickHouse/pull/29071) ([小路](https://github.com/nicelulu))。
* 从 `CREATE ... AS SELECT` 查询中应用设置（修复：[ #28810 ](https://github.com/ClickHouse/ClickHouse/issues/28810)）。[ #28962 ](https://github.com/ClickHouse/ClickHouse/pull/28962)（[Azat Khuzhin](https://github.com/azat)）。
* 在 ALTER TABLE ... ON CLUSTER ... REPLACE/MOVE PARTITION FROM/TO ... 中遵守默认数据库设置 [#28955](https://github.com/ClickHouse/ClickHouse/pull/28955) ([anneji-dev](https://github.com/anneji-dev))。
* gRPC 协议：允许客户端更改服务端压缩方式。[#28953](https://github.com/ClickHouse/ClickHouse/pull/28953) ([Vitaly Baranov](https://github.com/vitlibar))。
* 在读取用于异步指标的热传感器时跳过 “no data” 异常。此更改关闭了 [#28852](https://github.com/ClickHouse/ClickHouse/issues/28852)。[#28882](https://github.com/ClickHouse/ClickHouse/pull/28882)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了一个逻辑竞态问题，在极少数情况下它可能会对已存在的字典导致 `Dictionary not found` 错误。 [#28853](https://github.com/ClickHouse/ClickHouse/pull/28853) ([tavplubix](https://github.com/tavplubix)).
* 放宽对 `If` 组合器嵌套使用的检查（但禁止嵌套相同的组合器）。 [#28828](https://github.com/ClickHouse/ClickHouse/pull/28828) ([Azat Khuzhin](https://github.com/azat)).
* 修复服务器终止时可能出现的未捕获异常。[#28761](https://github.com/ClickHouse/ClickHouse/pull/28761) ([Azat Khuzhin](https://github.com/azat)).
* 禁止清理可能正在被 mutation/merge 使用的 tmp 目录，即使该 mutation/merge 持续时间异常地长。 [#28760](https://github.com/ClickHouse/ClickHouse/pull/28760) ([Azat Khuzhin](https://github.com/azat)).
* 在使用别名时，允许进行优化 `optimize_arithmetic_operations_in_aggregate_functions = 1`。[#28746](https://github.com/ClickHouse/ClickHouse/pull/28746)（[Amos Bird](https://github.com/amosbird)）。
* 为 `ReplicatedMergeTree` 实现 `detach_not_byte_identical_parts` 设置，使其在合并/变更之后，将非字节级完全相同的分片从表中分离而不是删除。 [#28708](https://github.com/ClickHouse/ClickHouse/pull/28708) ([Azat Khuzhin](https://github.com/azat)).
* 为 `MergeTree` 实现 `max_suspicious_broken_parts_bytes` 设置（用于限制所有可疑损坏数据分片的总大小，默认值为 `1GiB`）。 [#28707](https://github.com/ClickHouse/ClickHouse/pull/28707) ([Azat Khuzhin](https://github.com/azat)).
* 在 `RabbitMQ` 表设置中启用宏展开。[#28683](https://github.com/ClickHouse/ClickHouse/pull/28683)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 恢复了使用 `Log` 引擎多线程读取表数据的能力。[#28125](https://github.com/ClickHouse/ClickHouse/pull/28125) ([Vitaly Baranov](https://github.com/vitlibar))。
* 修复 JSON 函数中 `NULL` 列处理的不当行为。此修复对应 [#27930](https://github.com/ClickHouse/ClickHouse/issues/27930)。[#28012](https://github.com/ClickHouse/ClickHouse/pull/28012)（[Amos Bird](https://github.com/amosbird)）。
* 允许为跳过索引单独设置 Mark/未压缩缓存的大小，将其与列的缓存大小配置分离。 [#27961](https://github.com/ClickHouse/ClickHouse/pull/27961) ([Amos Bird](https://github.com/amosbird)).
* 允许将带有 `USING` 的 JOIN 与其他类型的 JOIN 混用。[#23881](https://github.com/ClickHouse/ClickHouse/pull/23881) ([darkkeks](https://github.com/darkkeks))。
* 为应对 Yandex Cloud S3 中的限流情况，更新 `aws-sdk` 子模块。 [#30646](https://github.com/ClickHouse/ClickHouse/pull/30646) ([ianton-ru](https://github.com/ianton-ru)).
* 修复在处理 gRPC 调用时查询处理结束后释放查询 ID 和会话 ID 的问题。[#29954](https://github.com/ClickHouse/ClickHouse/pull/29954) ([Vitaly Baranov](https://github.com/vitlibar))。
* 修复 `AccessControlManager` 的关闭流程，以解决不稳定的测试。[#29951](https://github.com/ClickHouse/ClickHouse/pull/29951) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复从 `HDFS` 读取时触发的断言失败。更新 libhdfs3 库，以便能够在 debug 模式下运行测试。关闭 [#29251](https://github.com/ClickHouse/ClickHouse/issues/29251)。关闭 [#27814](https://github.com/ClickHouse/ClickHouse/issues/27814)。[#29276](https://github.com/ClickHouse/ClickHouse/pull/29276)（[Kseniia Sumarokova](https://github.com/kssenii)）。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-1}

- 添加对 Aarch64 架构 FreeBSD 构建的支持。[#29952](https://github.com/ClickHouse/ClickHouse/pull/29952) ([MikaelUrankar](https://github.com/MikaelUrankar))。
- ClickHouse 不再需要递归子模块。[#30315](https://github.com/ClickHouse/ClickHouse/pull/30315) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- ClickHouse 现在可以使用 Musl 进行静态构建。此功能作为实验性添加,不支持构建 `odbc-bridge`、`library-bridge`、与 CatBoost 的集成以及部分库。[#30248](https://github.com/ClickHouse/ClickHouse/pull/30248) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 为 `AArch64` 和 `Darwin` (macOS) 构建启用 `Protobuf`、`Arrow`、`ORC`、`Parquet` 支持。此更改解决了 [#29248](https://github.com/ClickHouse/ClickHouse/issues/29248)。此更改解决了 [#28018](https://github.com/ClickHouse/ClickHouse/issues/28018)。[#30015](https://github.com/ClickHouse/ClickHouse/pull/30015) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 添加 PowerPC (powerpc64le) 的交叉编译支持。此更改解决了 [#9589](https://github.com/ClickHouse/ClickHouse/issues/9589)。为 AArch64 和 PowerPC 启用与 MySQL 交互的支持。此更改解决了 [#26301](https://github.com/ClickHouse/ClickHouse/issues/26301)。[#30010](https://github.com/ClickHouse/ClickHouse/pull/30010) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 在交叉编译工具链中仅保留必需的文件。将它们作为子模块包含(之前以 tarball 形式下载)。[#29974](https://github.com/ClickHouse/ClickHouse/pull/29974) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 在 ClickHouse 中为 select 语句解析器实现了结构感知的模糊测试方法。[#30012](https://github.com/ClickHouse/ClickHouse/pull/30012) ([Paul](https://github.com/PaulCher))。
- 为 clang 启用实验性 constexpr 表达式求值器以加速模板代码编译。[#29668](https://github.com/ClickHouse/ClickHouse/pull/29668) ([myrrc](https://github.com/myrrc))。
- 添加使用较新版本 glibc 进行编译而不使用新符号的能力。[#29594](https://github.com/ClickHouse/ClickHouse/pull/29594) ([Azat Khuzhin](https://github.com/azat))。
- 通过 clang 优化选项减小 Debug 构建的二进制文件大小。[#28736](https://github.com/ClickHouse/ClickHouse/pull/28736) ([flynn](https://github.com/ucasfl))。
- 现在所有 CI 镜像将放置在独立的 dockerhub 仓库中。[#28656](https://github.com/ClickHouse/ClickHouse/pull/28656) ([alesapin](https://github.com/alesapin))。
- 改进对 clang-13 构建的支持。[#28046](https://github.com/ClickHouse/ClickHouse/pull/28046) ([Sergei Semin](https://github.com/syominsergey))。
- 添加向 `clickhouse-client` 打印原始性能事件的能力(这对调试和测试很有用)。[#30064](https://github.com/ClickHouse/ClickHouse/pull/30064) ([Azat Khuzhin](https://github.com/azat))。
- 为 clickhouse-server 单元添加时间依赖(systemd 和 sysvinit init)。[#28891](https://github.com/ClickHouse/ClickHouse/pull/28891) ([Azat Khuzhin](https://github.com/azat))。
- 当符号重新加载时重新加载堆栈跟踪缓存。[#28137](https://github.com/ClickHouse/ClickHouse/pull/28137) ([Amos Bird](https://github.com/amosbird))。

#### 错误修复 {#bug-fix}


* 用于在 UTF-8 字符串中进行不区分大小写搜索的函数，如 `positionCaseInsensitiveUTF8` 和 `countSubstringsCaseInsensitiveUTF8`，在极少数情况下可能会找到实际上并不匹配的子字符串，该问题已修复。 [#30663](https://github.com/ClickHouse/ClickHouse/pull/30663) ([tavplubix](https://github.com/tavplubix)).
* 修复从加密磁盘读取空文件时的问题。 [#30494](https://github.com/ClickHouse/ClickHouse/pull/30494) ([Vitaly Baranov](https://github.com/vitlibar)).
* 在分布式查询中，当设置 `legacy_column_name_of_tuple_literal = 0` 时，修复将析取条件链转换为 `IN` 的行为（由设置 `optimize_min_equality_disjunction_chain_length` 控制）。[#28658](https://github.com/ClickHouse/ClickHouse/pull/28658) ([Anton Popov](https://github.com/CurtizJ))。
* 允许在分布式表中将物化列用作分片键，即使 `insert_allow_materialized_columns=0`：[ #28637](https://github.com/ClickHouse/ClickHouse/pull/28637)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复在结果集为空时，使用设置了 `TO` 和 `FROM` 的 `ORDER BY ... WITH FILL` 的问题。 [#30888](https://github.com/ClickHouse/ClickHouse/pull/30888) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在 `AND`/`OR` 表达式中，当操作数多于两个时未使用集合索引的问题。修复了 [#30416](https://github.com/ClickHouse/ClickHouse/issues/30416)。[#30887](https://github.com/ClickHouse/ClickHouse/pull/30887)（[Amos Bird](https://github.com/amosbird)）。
* 修复在包含哈希函数的 projection 物化时发生的崩溃。该修复解决了 [#30861](https://github.com/ClickHouse/ClickHouse/issues/30861)。此问题与 [https://github.com/ClickHouse/ClickHouse/pull/28560](https://github.com/ClickHouse/ClickHouse/pull/28560) 类似，其根本原因都是对 header 为空这一不变式缺乏正确理解。[#30877](https://github.com/ClickHouse/ClickHouse/pull/30877)（[Amos Bird](https://github.com/amosbird)）。
* 修复了在 `ReplicatedMergeTree` 中从 ZooKeeper 路径提取辅助 ZooKeeper 名称时的歧义问题。此前，如果 ZooKeeper 路径中包含冒号，服务器可能会在启动时失败并报错 `Unknown auxiliary ZooKeeper name`。此更改修复了 [#29052](https://github.com/ClickHouse/ClickHouse/issues/29052)。另外，之前允许指定不以斜杠开头的 ZooKeeper 路径，但该用法现在已被弃用，且不再允许使用此类路径创建新表。辅助 ZooKeeper 名称中也不允许出现斜杠和冒号。[#30822](https://github.com/ClickHouse/ClickHouse/pull/30822)（[tavplubix](https://github.com/tavplubix)）。
* 当 `localBackup` 因某些原因失败时，清理临时目录。[#30797](https://github.com/ClickHouse/ClickHouse/pull/30797) ([ianton-ru](https://github.com/ianton-ru)).
* 修复了在非复制 `MergeTree` 中，`REPLACE/MOVE PARTITION` 与后台合并之间的竞争条件，该问题可能导致部分已移动/已替换的数据仍保留在分区中。修复了 [#29327](https://github.com/ClickHouse/ClickHouse/issues/29327)。[#30717](https://github.com/ClickHouse/ClickHouse/pull/30717)（[tavplubix](https://github.com/tavplubix)）。
* 在 `PREWHERE` 条件恒为 `true` 时，将 `PREWHERE` 替换为 `WHERE`。 [#30668](https://github.com/ClickHouse/ClickHouse/pull/30668) ([Azat Khuzhin](https://github.com/azat)).
* Limit 下推优化可能会导致 `Cannot find column` 错误。已修复 [#30438](https://github.com/ClickHouse/ClickHouse/issues/30438)。[#30562](https://github.com/ClickHouse/ClickHouse/pull/30562)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 为 `isNotNull`/`isNull` 重写为 `IS [NOT] NULL` 时添加缺失的括号(修复了包含类似 `isNotNull(1)+isNotNull(2)` 表达式的查询)。[#30520](https://github.com/ClickHouse/ClickHouse/pull/30520) ([Azat Khuzhin](https://github.com/azat))。
* 修复对同一张表执行包含标量子查询的 `ALTER` 时出现的死锁，关闭 [#30461](https://github.com/ClickHouse/ClickHouse/issues/30461)。[#30492](https://github.com/ClickHouse/ClickHouse/pull/30492)（[Vladimir C](https://github.com/vdimir)）。
* 修复了在执行 `REPLACE PARTITION` 期间会话过期时可能发生的段错误。 [#30432](https://github.com/ClickHouse/ClickHouse/pull/30432) ([tavplubix](https://github.com/tavplubix))。
* 在应用聚合投影的情况下，带有 `IN (subquery)` 条件的查询可能会返回不正确的结果。已修复为投影创建集合的流程。[#30310](https://github.com/ClickHouse/ClickHouse/pull/30310) ([Amos Bird](https://github.com/amosbird))。
* 在启用投影时修复 JOIN 查询的列别名解析。此更改修复了 [#30146](https://github.com/ClickHouse/ClickHouse/issues/30146)。[#30293](https://github.com/ClickHouse/ClickHouse/pull/30293)（[Amos Bird](https://github.com/amosbird)）。
* 修复 `replaceRegexpAll` 函数中的若干缺陷。[#30292](https://github.com/ClickHouse/ClickHouse/pull/30292) ([Memo](https://github.com/Joeywzr))。
* 修复 ComplexKeyHashedDictionary 和 ComplexKeySparseHashedDictionary 从布局配置中解析 `preallocate` 选项的问题。[#30246](https://github.com/ClickHouse/ClickHouse/pull/30246) ([Maksim Kita](https://github.com/kitaisreal)).
* 修复 `[I]LIKE` 函数。修复 [#28661](https://github.com/ClickHouse/ClickHouse/issues/28661)。[#30244](https://github.com/ClickHouse/ClickHouse/pull/30244)（[Nikolay Degterinsky](https://github.com/evillique)）。
* 修复在 `multiIf` 中结合使用 `shortcircuit` 与 `lowcardinality` 时出现的崩溃。[#30243](https://github.com/ClickHouse/ClickHouse/pull/30243) ([Raúl Marín](https://github.com/Algunenano)).
* 修复了 FlatDictionary 和 HashedDictionary 中可为空属性的 bytes&#95;allocated 计算。 [#30238](https://github.com/ClickHouse/ClickHouse/pull/30238) ([Maksim Kita](https://github.com/kitaisreal)).
* 在多表 `JOIN` 中允许使用以数字开头的标识符。[#30230](https://github.com/ClickHouse/ClickHouse/pull/30230) ([Vladimir C](https://github.com/vdimir)).
* 修复在从 `MergeTree` 读取且 `max_read_buffer_size = 0` 时的行为（当用户想“作死”时）（可能会导致 `Can't adjust last granule`、`LOGICAL_ERROR` 等异常，甚至数据丢失）。[#30192](https://github.com/ClickHouse/ClickHouse/pull/30192)（[Azat Khuzhin](https://github.com/azat)）。
* 修复与 `min_bytes_to_use_direct_io` 相关的 `pread_fake_async`/`pread_threadpool` 问题。[#30191](https://github.com/ClickHouse/ClickHouse/pull/30191) ([Azat Khuzhin](https://github.com/azat))。
* 修复了 `INSERT SELECT` 在基于 `Nullable` 列填充 `MATERIALIZED` 列时出现的错误。 [#30189](https://github.com/ClickHouse/ClickHouse/pull/30189) ([Azat Khuzhin](https://github.com/azat)).
* 在函数 `initializeAggregation` 中支持可空参数。 [#30177](https://github.com/ClickHouse/ClickHouse/pull/30177) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在使用 `GLOBAL IN` 和 `WITH TOTALS` 的查询中出现的 `Port is already connected` 错误。仅适用于 21.9 和 21.10。[#30086](https://github.com/ClickHouse/ClickHouse/pull/30086)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复 MergeTree 中 `MOVE PARTITION` 与合并/变更操作之间的竞争条件。[#30074](https://github.com/ClickHouse/ClickHouse/pull/30074) ([Azat Khuzhin](https://github.com/azat)).
* 被删除的 `Memory` 数据库在服务器重启后可能会重新出现，此问题已修复（[#29795](https://github.com/ClickHouse/ClickHouse/issues/29795)）。同时新增了 `force_remove_data_recursively_on_drop` 设置，作为在删除 `Ordinary` 数据库时出现 `Directory not empty` 错误的临时解决方案（因为在云环境中无法手动删除残留数据）。[#30054](https://github.com/ClickHouse/ClickHouse/pull/30054)（[tavplubix](https://github.com/tavplubix)）。
* 修复由 `tuple()` 引起的 `SAMPLE` 崩溃，关闭 [#30004](https://github.com/ClickHouse/ClickHouse/issues/30004)。[#30016](https://github.com/ClickHouse/ClickHouse/pull/30016)（[flynn](https://github.com/ucasfl)）。
* 尝试关闭 issue：[ #29965 ](https://github.com/ClickHouse/ClickHouse/issues/29965)。[#29976](https://github.com/ClickHouse/ClickHouse/pull/29976)（[hexiaoting](https://github.com/hexiaoting)）。
* 修复 `FileChecker` 与 `StorageLog`/`StorageStripeLog` 之间可能出现的数据竞态。 [#29959](https://github.com/ClickHouse/ClickHouse/pull/29959) ([Azat Khuzhin](https://github.com/azat)).
* 修复 `StorageLog` 中 `LogSink::writeMarks()` 与 `LogSource` 之间的数据竞争问题。 [#29946](https://github.com/ClickHouse/ClickHouse/pull/29946) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在合并树表并发查询限制中引入的潜在资源泄漏问题，相关变更见 [https://github.com/ClickHouse/ClickHouse/pull/19544](https://github.com/ClickHouse/ClickHouse/pull/19544)。[#29879](https://github.com/ClickHouse/ClickHouse/pull/29879)（[Amos Bird](https://github.com/amosbird)）。
* 修复系统表重新创建检查逻辑（之前无法检测到 `enum` 值的更改）。 [#29857](https://github.com/ClickHouse/ClickHouse/pull/29857) ([Azat Khuzhin](https://github.com/azat)).
* MaterializedMySQL：修复了一个问题，即当与 MySQL 的连接丢失时，可能只会处理事务的一部分。 [#29837](https://github.com/ClickHouse/ClickHouse/pull/29837) ([Håvard Kvålen](https://github.com/havardk)).
* 避免在极其罕见的情况下出现 `Timeout exceeded: elapsed 18446744073.709553 seconds` 错误，推测是由内核中的某个 bug 导致的。修复了 [#29154](https://github.com/ClickHouse/ClickHouse/issues/29154)。[#29811](https://github.com/ClickHouse/ClickHouse/pull/29811)（[tavplubix](https://github.com/tavplubix)）。
* 修复在 `ATTACH TABLE ... FROM 'path'` 查询中，当用非字符串字面量代替路径时出现的不正确类型转换问题。该问题可能导致读取未初始化内存。[#29790](https://github.com/ClickHouse/ClickHouse/pull/29790) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复在 `GROUP BY` 期间对 `LowCardinality` 的并发访问（与 `Buffer` 表组合使用时可能会导致问题）。[#29782](https://github.com/ClickHouse/ClickHouse/pull/29782) ([Azat Khuzhin](https://github.com/azat)).
* 修复了分布式查询中 `GROUP BY` 结果不正确的问题(结果中出现具有相同键的多行)。该问题出现在以下情况:分片混合使用 `<= 21.3` 和 `>= 21.4` 版本,`GROUP BY` 键包含多个固定大小的列,且启用了两级聚合(参见 `group_by_two_level_threshold` 和 `group_by_two_level_threshold_bytes`)。修复 [#29580](https://github.com/ClickHouse/ClickHouse/issues/29580)。[#29735](https://github.com/ClickHouse/ClickHouse/pull/29735) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了在服务器重启时设置 `materialized_postgresql_tables_list` 时行为不正确的问题。见 [#28529](https://github.com/ClickHouse/ClickHouse/issues/28529)。[#29686](https://github.com/ClickHouse/ClickHouse/pull/29686)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在下推优化后，过滤谓词中的条件可能会丢失。[#29625](https://github.com/ClickHouse/ClickHouse/pull/29625) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了 JIT 表达式编译中别名和短路表达式求值的问题。关闭 [#29403](https://github.com/ClickHouse/ClickHouse/issues/29403)。[#29574](https://github.com/ClickHouse/ClickHouse/pull/29574) ([Maksim Kita](https://github.com/kitaisreal))。
* 修复了在 `DEFAULT` 表达式中使用类似 `x.y.z...` 的错误表标识符时，`ALTER MODIFY` 查询中出现的罕见段错误。修复了 [#29184](https://github.com/ClickHouse/ClickHouse/issues/29184)。[#29573](https://github.com/ClickHouse/ClickHouse/pull/29573)（[alesapin](https://github.com/alesapin)）。
* 修复在 `HAVING` 中使用的列未被选中时，`GROUP BY WITH TOTALS HAVING` 出现的 `nullptr` 解引用问题。[#29553](https://github.com/ClickHouse/ClickHouse/pull/29553) ([Azat Khuzhin](https://github.com/azat)).
* 在对 Join 表引擎的表进行并发读写时避免发生死锁。[#29544](https://github.com/ClickHouse/ClickHouse/pull/29544)（[Raúl Marín](https://github.com/Algunenano)）。
* 修复 `pathStartsWith` 检查中的错误，因为在使用 `std::mismatch` 时存在一个问题：`如果第二个范围比第一个范围短，则其行为是未定义的。`。[#29531](https://github.com/ClickHouse/ClickHouse/pull/29531) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 在 ODBC bridge 中为错误 `Invalid cursor state` 添加重试机制。该错误是可重试的。关闭 [#29473](https://github.com/ClickHouse/ClickHouse/issues/29473)。[#29518](https://github.com/ClickHouse/ClickHouse/pull/29518)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复了加载 `Lazy` 数据库时表名解析不正确的问题。修复 [#29456](https://github.com/ClickHouse/ClickHouse/issues/29456)。[#29476](https://github.com/ClickHouse/ClickHouse/pull/29476) ([tavplubix](https://github.com/tavplubix))。
* 修复在向下推送 `HAVING` 谓词的子查询中可能出现的 `Block structure mismatch` 问题。修复 [#29010](https://github.com/ClickHouse/ClickHouse/issues/29010)。[#29475](https://github.com/ClickHouse/ClickHouse/pull/29475)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复 `greatest`/`least` 函数中的逻辑错误 `Cannot capture columns`。修复问题 [#29334](https://github.com/ClickHouse/ClickHouse/issues/29334)。[#29454](https://github.com/ClickHouse/ClickHouse/pull/29454)（[Kruglov Pavel](https://github.com/Avogar)）。
* RocksDB 表引擎：修复在多次打开 DB 时的竞争条件（并重新启用在 CI 上能够触发该问题的一些测试）。 [#29393](https://github.com/ClickHouse/ClickHouse/pull/29393) ([Azat Khuzhin](https://github.com/azat)).
* 修复在配置错误时复制访问存储无法正常关闭的问题。 [#29388](https://github.com/ClickHouse/ClickHouse/pull/29388) ([Kevin Michel](https://github.com/kmichel-aiven))。
* 移除窗口函数 `nth_value`，因为它不具备内存安全性。此更改修复了 [#29347](https://github.com/ClickHouse/ClickHouse/issues/29347)。[#29348](https://github.com/ClickHouse/ClickHouse/pull/29348)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复投影 part 的垂直合并，解决了 [#29253](https://github.com/ClickHouse/ClickHouse/issues/29253)。该 PR 还修复了在 [https://github.com/ClickHouse/ClickHouse/pull/25165](https://github.com/ClickHouse/ClickHouse/pull/25165) 中引入的若干投影合并 / 变更问题。[#29337](https://github.com/ClickHouse/ClickHouse/pull/29337)（[Amos Bird](https://github.com/amosbird)）。
* 修复在为 Replicated 数据库添加新副本时会挂起的 DDL 查询。[#29328](https://github.com/ClickHouse/ClickHouse/pull/29328) ([Kevin Michel](https://github.com/kmichel-aiven)).
* 修复连接超时问题（`send_timeout`/`receive_timeout`）。[#29282](https://github.com/ClickHouse/ClickHouse/pull/29282)（[Azat Khuzhin](https://github.com/azat)）。
* 修复在重新创建或创建新的 `ReplicatedMergeTree` 副本时，可能出现的 `Table columns structure in ZooKeeper is different from local table structure` 异常，该异常会在某个表列包含使用不区分大小写函数的默认表达式时触发。 [#29266](https://github.com/ClickHouse/ClickHouse/pull/29266) ([Anton Popov](https://github.com/CurtizJ)).
* 通过 TCP 向客户端发送常规的 `Database doesn't exist error`（`UNKNOWN_DATABASE`），而不是 `Attempt to read after eof`（`ATTEMPT_TO_READ_AFTER_EOF`）。[#29229](https://github.com/ClickHouse/ClickHouse/pull/29229) ([Azat Khuzhin](https://github.com/azat))。
* 修复在 `Avro` 输入格式中向类型为 `LowCardinality(Nullable)` 的列插入数据时产生的段错误。 [#29132](https://github.com/ClickHouse/ClickHouse/pull/29132) ([Kruglov Pavel](https://github.com/Avogar))。
* 在配置了服务器间密钥的情况下,不允许重用先前的凭据(在通过 Buffer/Kafka 向配置了服务器间密钥的分布式表执行 INSERT 之前,可能会为该连接重用先前设置的用户)。[#29060](https://github.com/ClickHouse/ClickHouse/pull/29060) ([Azat Khuzhin](https://github.com/azat))。
* 在与字典进行 join 时处理 `any_join_distinct_right_table_keys`，修复 [#29007](https://github.com/ClickHouse/ClickHouse/issues/29007)。[#29014](https://github.com/ClickHouse/ClickHouse/pull/29014)（[Vladimir C](https://github.com/vdimir)）。
* 修复在对别名列执行 `JOIN` 时出现的 “Not found column ... in block” 错误，关闭 [#26980](https://github.com/ClickHouse/ClickHouse/issues/26980)。 [#29008](https://github.com/ClickHouse/ClickHouse/pull/29008) ([Vladimir C](https://github.com/vdimir)).
* 修复 `GLOBAL IN` 子查询使用的线程数问题（自从 [#19414](https://github.com/ClickHouse/ClickHouse/issues/19414) 缺陷修复后，它一直只在单线程中执行）。[#28997](https://github.com/ClickHouse/ClickHouse/pull/28997)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在 `ORDER BY` 包含 `WITH FILL` 时的错误优化。这修复了 [#28908](https://github.com/ClickHouse/ClickHouse/issues/28908)。这修复了 [#26049](https://github.com/ClickHouse/ClickHouse/issues/26049)。[#28910](https://github.com/ClickHouse/ClickHouse/pull/28910)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复高阶数组函数在使用常量时的问题（`arrayCompact` 的 `SIGSEGV` 错误/`arrayDifference` 的 `ILLEGAL_COLUMN` 错误/`arrayCumSumNonNegative`）。[#28904](https://github.com/ClickHouse/ClickHouse/pull/28904) ([Azat Khuzhin](https://github.com/azat))。
* 修复在使用 `mutations_sync=2` 时等待 mutation 的问题。[#28889](https://github.com/ClickHouse/ClickHouse/pull/28889) ([Azat Khuzhin](https://github.com/azat)).
* 修复对外部数据库（如 MySQL）的查询在 `IN` 中使用多列条件时的问题（例如 `(k,v) IN ((1, 2))`）。[#28888](https://github.com/ClickHouse/ClickHouse/pull/28888)（[Azat Khuzhin](https://github.com/azat)）。
* 修复在短路函数求值中使用 `LowCardinality` 时的错误。关闭 [#28884](https://github.com/ClickHouse/ClickHouse/issues/28884)。[#28887](https://github.com/ClickHouse/ClickHouse/pull/28887)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复从紧凑部件中读取子列的问题。[#28873](https://github.com/ClickHouse/ClickHouse/pull/28873) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了 `DROP PART` 与 `REPLACE/MOVE PARTITION` 之间的竞争条件，该问题在极少数情况下可能导致副本状态出现不一致。[#28864](https://github.com/ClickHouse/ClickHouse/pull/28864) ([tavplubix](https://github.com/tavplubix))。
* 修复使用短路求值的表达式编译问题。[#28821](https://github.com/ClickHouse/ClickHouse/pull/28821)（[Azat Khuzhin](https://github.com/azat)）。
* 修复了一种极其罕见的情况：在所有副本强制重启后，`ReplicatedMergeTree` 副本之间可能产生分歧。错误表现为 `Part ... intersects (previous|next) part ...`。 [#28817](https://github.com/ClickHouse/ClickHouse/pull/28817) ([alesapin](https://github.com/alesapin)).
* 最好还是检查一下连接是否可用，并在 `RabbitMQ` 关闭时捕获所有异常以防万一。[#28797](https://github.com/ClickHouse/ClickHouse/pull/28797) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 修复 `ReplicatedMergeTreeQueue` 中的非致命竞态条件。对用户来说本不应可见，但可能导致一些隐蔽的错误。[#28734](https://github.com/ClickHouse/ClickHouse/pull/28734) ([alesapin](https://github.com/alesapin))。
* 修复在出现异常时，带有部分创建完成的聚合投影的 `SELECT` 查询可能发生的崩溃问题。 [#28700](https://github.com/ClickHouse/ClickHouse/pull/28700) ([Amos Bird](https://github.com/amosbird))。
* 修复在创建分布式表时，由于传入参数错误导致的核心转储问题。 [#28686](https://github.com/ClickHouse/ClickHouse/pull/28686) ([Zhiyong Wang](https://github.com/ljcui)).
* 为 `system.processes` 表添加 `Settings.Names` 和 `Settings.Values` 列别名。 [#28685](https://github.com/ClickHouse/ClickHouse/pull/28685) ([Vitaly](https://github.com/orloffv))。
* 支持 S2 Geometry 库：修正 `s2RectAdd` 和 `s2RectContains` 函数所需的参数数量。[#28663](https://github.com/ClickHouse/ClickHouse/pull/28663) ([Bharat Nallan](https://github.com/bharatnc))。
* 修复在使用 `Nullable` 或 `LowCardinality` 主键时出现的无效常量类型转换。[#28636](https://github.com/ClickHouse/ClickHouse/pull/28636) ([Amos Bird](https://github.com/amosbird))。
* 使用 `PREWHERE` 修复 “Column is not under aggregate function and not in GROUP BY” 错误（问题：[#28461](https://github.com/ClickHouse/ClickHouse/issues/28461)）。[#28502](https://github.com/ClickHouse/ClickHouse/pull/28502)（[Azat Khuzhin](https://github.com/azat)）。

### ClickHouse 版本 v21.10, 2021-10-16 {#clickhouse-release-v2110-2021-10-16}

#### 不兼容变更 {#backward-incompatible-change-2}

- 现在以下 MergeTree 表级设置：`replicated_max_parallel_sends`、`replicated_max_parallel_sends_for_table`、`replicated_max_parallel_fetches`、`replicated_max_parallel_fetches_for_table` 已不再生效。这些设置从未正常工作,现已被 `max_replicated_fetches_network_bandwidth`、`max_replicated_sends_network_bandwidth` 和 `background_fetches_pool_size` 替代。[#28404](https://github.com/ClickHouse/ClickHouse/pull/28404) ([alesapin](https://github.com/alesapin))。

#### 新功能 {#new-feature-2}


- 新增以 lambda 表达式创建用户自定义函数 (UDF) 的功能。语法:`CREATE FUNCTION {function_name} as ({parameters}) -> {function core}`。示例:`CREATE FUNCTION plus_one as (a) -> a + 1`。作者 @Realist007。[#27796](https://github.com/ClickHouse/ClickHouse/pull/27796) ([Maksim Kita](https://github.com/kitaisreal)) [#23978](https://github.com/ClickHouse/ClickHouse/pull/23978) ([Realist007](https://github.com/Realist007))。
- 新增 `Executable` 存储引擎和 `executable` 表函数。支持以流式方式通过外部脚本处理数据。[#28102](https://github.com/ClickHouse/ClickHouse/pull/28102) ([Maksim Kita](https://github.com/kitaisreal)) ([ruct](https://github.com/ruct))。
- 新增 `ExecutablePool` 存储引擎。与 `Executable` 类似,但使用长期运行的进程池。[#28518](https://github.com/ClickHouse/ClickHouse/pull/28518) ([Maksim Kita](https://github.com/kitaisreal))。
- 新增 `ALTER TABLE ... MATERIALIZE COLUMN` 查询。[#27038](https://github.com/ClickHouse/ClickHouse/pull/27038) ([Vladimir Chebotarev](https://github.com/excitoon))。
- 支持向 `s3` 表函数进行分区写入。[#23051](https://github.com/ClickHouse/ClickHouse/pull/23051) ([Vladimir Chebotarev](https://github.com/excitoon))。
- 支持 `lz4` 压缩格式(除 `gz`、`bz2`、`xz`、`zstd` 外)用于数据导入/导出。[#25310](https://github.com/ClickHouse/ClickHouse/pull/25310) ([Bharat Nallan](https://github.com/bharatnc))。
- 在 `enable_positional_arguments` 设置下允许使用位置参数。关闭 [#2592](https://github.com/ClickHouse/ClickHouse/issues/2592)。[#27530](https://github.com/ClickHouse/ClickHouse/pull/27530) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 在 s3 表的 `CREATE` 查询中,允许在 `SETTINGS` 子句中接受与文件格式相关的用户设置。关闭 [#27580](https://github.com/ClickHouse/ClickHouse/issues/27580)。[#28037](https://github.com/ClickHouse/ClickHouse/pull/28037) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 允许 `RabbitMQ` 引擎使用 SSL 连接。[#28365](https://github.com/ClickHouse/ClickHouse/pull/28365) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 新增 `getServerPort` 函数用于获取服务器端口。当端口未被服务器使用时,抛出异常。[#27900](https://github.com/ClickHouse/ClickHouse/pull/27900) ([Amos Bird](https://github.com/amosbird))。
- 新增 "snowflake id" 与 `DateTime`、`DateTime64` 之间的转换函数。参见 [#27058](https://github.com/ClickHouse/ClickHouse/issues/27058)。[#27704](https://github.com/ClickHouse/ClickHouse/pull/27704) ([jasine](https://github.com/jasine))。
- 新增 `SHA512` 函数。[#27830](https://github.com/ClickHouse/ClickHouse/pull/27830) ([zhanglistar](https://github.com/zhanglistar))。
- 新增 `log_queries_probability` 设置,允许用户仅将查询样本写入 query_log。关闭 [#16609](https://github.com/ClickHouse/ClickHouse/issues/16609)。[#27527](https://github.com/ClickHouse/ClickHouse/pull/27527) ([Nikolay Degterinsky](https://github.com/evillique))。

#### 实验性功能 {#experimental-feature-2}


- `web` 类型磁盘,用于在 Web 服务器上以静态文件形式存储只读表。参见 [#23982](https://github.com/ClickHouse/ClickHouse/issues/23982)。[#25251](https://github.com/ClickHouse/ClickHouse/pull/25251) ([Kseniia Sumarokova](https://github.com/kssenii))。此功能主要用于便于在共享存储上进行操作测试以及轻松导入数据集。不建议在 21.11 版本之前使用。
- 新增 `BACKUP` 和 `RESTORE` 命令。[#21945](https://github.com/ClickHouse/ClickHouse/pull/21945) ([Vitaly Baranov](https://github.com/vitlibar))。此功能正在开发中,不建议在当前版本中使用。

#### 性能改进 {#performance-improvement-2}

- 加速 `sumIf` 和 `countIf` 聚合函数。[#28272](https://github.com/ClickHouse/ClickHouse/pull/28272) ([Raúl Marín](https://github.com/Algunenano))。
- 为 `minmax` 索引创建虚拟投影。现在,当启用 `allow_experimental_projection_optimization` 时,查询将在可能的情况下使用 minmax 索引而非读取数据。[#26286](https://github.com/ClickHouse/ClickHouse/pull/26286) ([Amos Bird](https://github.com/amosbird))。
- 在 `sequenceMatch` 和 `sequenceCount` 中引入两项检查,当事件列表中缺少序列模式的某些确定性部分时允许提前退出。此更改使许多以前因达到操作上限而失败的查询得以执行,并且通常会加速处理流程。[#27729](https://github.com/ClickHouse/ClickHouse/pull/27729) ([Jakub Kuklis](https://github.com/jkuklis))。
- 利用二元函数的单调性信息增强主键分析,特别是非零常量除法。[#28302](https://github.com/ClickHouse/ClickHouse/pull/28302) ([Amos Bird](https://github.com/amosbird))。
- 使 `hasAll` 过滤条件能够利用布隆过滤器数据跳过索引。[#27984](https://github.com/ClickHouse/ClickHouse/pull/27984) ([Braulio Valdivielso Martínez](https://github.com/BraulioVM))。
- 通过延迟表启动过程加速数据部分加载。[#28313](https://github.com/ClickHouse/ClickHouse/pull/28313) ([Amos Bird](https://github.com/amosbird))。
- 修复了从 `WHERE` 移动到 `PREWHERE` 的条件数量可能过多的问题(该优化由 `optimize_move_to_prewhere` 设置控制)。[#28139](https://github.com/ClickHouse/ClickHouse/pull/28139) ([lthaooo](https://github.com/lthaooo))。
- 默认启用 `optimize_distributed_group_by_sharding_key`。[#28105](https://github.com/ClickHouse/ClickHouse/pull/28105) ([Azat Khuzhin](https://github.com/azat))。

#### 改进 {#improvement-2}


* 在创建 `Distributed` 表之前检查集群名称，不允许使用错误的集群名称创建表。修复了 [#27832](https://github.com/ClickHouse/ClickHouse/issues/27832)。[#27927](https://github.com/ClickHouse/ClickHouse/pull/27927)（[tavplubix](https://github.com/tavplubix)）。
* 新增聚合函数 `quantileBFloat16Weighted`，实现方式与其他 quantile...Weighted 函数类似。此更改关闭了 [#27745](https://github.com/ClickHouse/ClickHouse/issues/27745)。[#27758](https://github.com/ClickHouse/ClickHouse/pull/27758)（[Ivan Novitskiy](https://github.com/RedClusive)）。
* 允许创建不含属性的字典。[#27905](https://github.com/ClickHouse/ClickHouse/pull/27905) ([Maksim Kita](https://github.com/kitaisreal))。
* 在 `clickhouse-client` 中添加了关于如何重置密码的交互式文档。这在用户安装 ClickHouse、设置密码后立刻忘记密码的场景下非常有用。参见 [#27750](https://github.com/ClickHouse/ClickHouse/issues/27750)。[#27903](https://github.com/ClickHouse/ClickHouse/pull/27903)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 `JSONAsString` 输入格式中支持数据被包裹在数组中的情况。修复 [#25517](https://github.com/ClickHouse/ClickHouse/issues/25517)。[#25633](https://github.com/ClickHouse/ClickHouse/pull/25633)（[Kruglov Pavel](https://github.com/Avogar)）。
* 在 `system.replicas` 表中新增 `last_queue_update_exception` 列。 [#26843](https://github.com/ClickHouse/ClickHouse/pull/26843) ([nvartolomei](https://github.com/nvartolomei)).
* 为 `MaterializedPostgreSQL` 表在故障转移时提供重新连接支持。修复了 [#28529](https://github.com/ClickHouse/ClickHouse/issues/28529)。[#28614](https://github.com/ClickHouse/ClickHouse/pull/28614)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 首次启动服务器时生成唯一的服务器 UUID。 [#20089](https://github.com/ClickHouse/ClickHouse/pull/20089) ([Bharat Nallan](https://github.com/bharatnc))。
* 为 `MySQL` 引擎新增 `connection_wait_timeout` 设置（默认 5 秒，设置为 0 表示不等待）。[#28474](https://github.com/ClickHouse/ClickHouse/pull/28474) ([Azat Khuzhin](https://github.com/azat)).
* 禁止使用错误参数创建 `MaterializedPostgreSQL`。修复 [#28423](https://github.com/ClickHouse/ClickHouse/issues/28423)。[#28430](https://github.com/ClickHouse/ClickHouse/pull/28430) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 在垂直合并时使用实际的 tmp 文件来替代预定义的 &quot;rows&#95;sources&quot;，从而避免在 tmp 磁盘上生成无用目录。 [#28299](https://github.com/ClickHouse/ClickHouse/pull/28299) ([Amos Bird](https://github.com/amosbird)).
* 在服务器配置中添加了 `libhdfs3_conf`，而不再在 clickhouse-server.service 中通过导出环境变量 `LIBHDFS3_CONF` 进行配置。此更改用于配置与 HDFS 的交互。[#28268](https://github.com/ClickHouse/ClickHouse/pull/28268) ([Zhichang Yu](https://github.com/yuzhichang)).
* 修复在 `Temporary` 状态下移除数据部分时可能导致的意外异常（`Part %name% doesn't exist`）的问题。修复了 [#23661](https://github.com/ClickHouse/ClickHouse/issues/23661)。[#28221](https://github.com/ClickHouse/ClickHouse/pull/28221) [#28221](https://github.com/ClickHouse/ClickHouse/issues/28221)) ([Azat Khuzhin](https://github.com/azat)).
* 修复 `zookeeper_log.address`（在本 PR 的第一个补丁之前，该地址始终为 `::`），并减少对此列调用 `getpeername(2)` 的次数（由于每次向 `zookeeper_log` 添加记录时都会调用 `getpeername()`，因此将该地址缓存在 zookeeper 客户端中以避免重复调用）。[#28212](https://github.com/ClickHouse/ClickHouse/pull/28212) ([Azat Khuzhin](https://github.com/azat))。
* 支持在 `[]` 运算符的索引与 `Map` 类型的键之间进行隐式转换（例如不同的 `Int` 类型、`String` 和 `FixedString`）。 [#28096](https://github.com/ClickHouse/ClickHouse/pull/28096) ([Anton Popov](https://github.com/CurtizJ)).
* 支持在向 PostgreSQL 表引擎或表函数插入数据时使用 `ON CONFLICT` 子句。关闭 [#27727](https://github.com/ClickHouse/ClickHouse/issues/27727)。[#28081](https://github.com/ClickHouse/ClickHouse/pull/28081) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 放宽 `Enum` 数据类型的限制,以允许附加兼容数据。关闭 [#26672](https://github.com/ClickHouse/ClickHouse/issues/26672)。[#28028](https://github.com/ClickHouse/ClickHouse/pull/28028) ([Dmitry Novik](https://github.com/novikd))。
* 添加设置 `empty_result_for_aggregation_by_constant_keys_on_empty_set`，用于控制在空结果集上按常量键分组时的行为。这样可以恢复 [#6842](https://github.com/ClickHouse/ClickHouse/issues/6842) 中的旧行为。[#27932](https://github.com/ClickHouse/ClickHouse/pull/27932)（[Amos Bird](https://github.com/amosbird)）。
* 新增了 `replication_wait_for_inactive_replica_timeout` 设置。它用于指定在等待非活动副本执行 `ALTER`/`OPTIMZE`/`TRUNCATE` 查询时的最长时间（默认为 120 秒）。如果 `replication_alter_partitions_sync` 为 2，且某些副本处于非活动状态的时间超过 `replication_wait_for_inactive_replica_timeout` 秒，则会抛出 `UNFINISHED`。 [#27931](https://github.com/ClickHouse/ClickHouse/pull/27931) ([tavplubix](https://github.com/tavplubix)).
* 为 `APPLY` 列转换器增加对 lambda 参数的支持，从而可以应用带有多个参数的函数。对应 [#27877](https://github.com/ClickHouse/ClickHouse/issues/27877)。[#27901](https://github.com/ClickHouse/ClickHouse/pull/27901)（[Amos Bird](https://github.com/amosbird)）。
* 默认启用 `tcp_keep_alive_timeout`。[#27882](https://github.com/ClickHouse/ClickHouse/pull/27882)（[Azat Khuzhin](https://github.com/azat)）。
* 改进远程查询取消机制（在远程服务器异常终止的情况下）。[#27881](https://github.com/ClickHouse/ClickHouse/pull/27881) ([Azat Khuzhin](https://github.com/azat)).
* 对大型 S3 对象使用分段复制上传（Multipart copy upload）。 [#27858](https://github.com/ClickHouse/ClickHouse/pull/27858) ([ianton-ru](https://github.com/ianton-ru)).
* 允许在库字典路径中遍历符号链接。 [#27815](https://github.com/ClickHouse/ClickHouse/pull/27815) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 现在将 `ALTER MODIFY COLUM` 中的类型 `T` 修改为 `Nullable(T)` 不再需要执行 mutation。[#27787](https://github.com/ClickHouse/ClickHouse/pull/27787) ([victorgao](https://github.com/kafka1991))。
* 不要默默忽略错误，也不要在 `ReadBufferFromS3` 中统计延迟。[#27484](https://github.com/ClickHouse/ClickHouse/pull/27484)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* 通过仅重新计算元数据而不执行实际 TTL 操作来改进 `ALTER ... MATERIALIZE TTL`。 [#27019](https://github.com/ClickHouse/ClickHouse/pull/27019) ([lthaooo](https://github.com/lthaooo)).
* 允许在 EOF 处没有换行符的情况下读取自定义顶级域名列表。 [#28213](https://github.com/ClickHouse/ClickHouse/pull/28213) ([Azat Khuzhin](https://github.com/azat)).

#### 错误修复 {#bug-fix-1}


* 修复从 `carbon-clickhouse` 读取压缩数据时出现 “attempt to read after end of file” 错误的问题。修复关闭了 [#26149](https://github.com/ClickHouse/ClickHouse/issues/26149)。[#28150](https://github.com/ClickHouse/ClickHouse/pull/28150)（[FArthur-cmd](https://github.com/FArthur-cmd)）。
* 修复在执行带有 `ON CLUSTER` 子句的 `GRANT WITH REPLACE` 语句时检查访问权限的问题。此 PR 对修复 [#27001](https://github.com/ClickHouse/ClickHouse/pull/27701) 进行了改进。[#27983](https://github.com/ClickHouse/ClickHouse/pull/27983)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 允许在类型为 `LowCardinality(UUID)` 的列上使用 `extremes = 1` 进行查询。 [#27918](https://github.com/ClickHouse/ClickHouse/pull/27918) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复对负数使用 PostgreSQL 风格类型转换（`::` 运算符）时的行为。[#27876](https://github.com/ClickHouse/ClickHouse/pull/27876) ([Anton Popov](https://github.com/CurtizJ))。
* 基于 [#26864](https://github.com/ClickHouse/ClickHouse/pull/26864)。修复 `NamedSessionStorage` 的关闭逻辑：现在会在销毁全局上下文之前，先销毁存储在 `NamedSessionStorage` 中的会话上下文。[#27875](https://github.com/ClickHouse/ClickHouse/pull/27875)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复了 `windowFunnel` 的 &quot;strict&quot; 模式中的缺陷。对应修复 [#27469](https://github.com/ClickHouse/ClickHouse/issues/27469)。[#27563](https://github.com/ClickHouse/ClickHouse/pull/27563)（[achimbab](https://github.com/achimbab)）。
* 修复读取被截断的 `bzip2` 归档时出现的无限循环问题。 [#28543](https://github.com/ClickHouse/ClickHouse/pull/28543) ([Azat Khuzhin](https://github.com/azat)).
* 修复 `MaterializedMySQL` 内部 DDL 中 `DROP TABLE` 的 UUID 重叠问题。MaterializedMySQL 是一项实验性功能。[#28533](https://github.com/ClickHouse/ClickHouse/pull/28533) ([Azat Khuzhin](https://github.com/azat)).
* 修复在从包含 `Nested` 列以及名称中带点、且与该 `Nested` 列具有相同前缀的标量列的表中进行查询时出现的 `There is no subcolumn` 错误（例如 `n.id UInt32, n.arr1 Array(UInt64), n.arr2 Array(UInt64)`）。 [#28531](https://github.com/ClickHouse/ClickHouse/pull/28531) ([Anton Popov](https://github.com/CurtizJ)).
* 修复一个错误，该错误会在对 `ReplicatedVersionedCollapsingMergeTree` 执行 ALTER 后导致报错 `Existing table metadata in ZooKeeper differs in sorting key expression.`。修复了 [#28515](https://github.com/ClickHouse/ClickHouse/issues/28515)。[#28528](https://github.com/ClickHouse/ClickHouse/pull/28528)（[alesapin](https://github.com/alesapin)）。
* 修复了在分布式 DDL 队列的后台处理过程中可能出现的 ZooKeeper watch 泄漏问题（次要问题）。关闭 [#26036](https://github.com/ClickHouse/ClickHouse/issues/26036)。[#28446](https://github.com/ClickHouse/ClickHouse/pull/28446)（[tavplubix](https://github.com/tavplubix)）。
* 修复 `MaterializedPostgreSQL` 引擎中缺失的表名引用符。关闭 [#28316](https://github.com/ClickHouse/ClickHouse/issues/28316)。[#28433](https://github.com/ClickHouse/ClickHouse/pull/28433)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复来自 `Nullable` 列的未连接行的错误行为。关闭 [#27691](https://github.com/ClickHouse/ClickHouse/issues/27691)。[#28349](https://github.com/ClickHouse/ClickHouse/pull/28349)（[vdimir](https://github.com/vdimir)）。
* 修复在未使用所有键列时的 `NOT IN` 索引优化问题。修复了 [#28120](https://github.com/ClickHouse/ClickHouse/issues/28120)。[#28315](https://github.com/ClickHouse/ClickHouse/pull/28315)（[Amos Bird](https://github.com/amosbird)）。
* 修复由于新数据部分被空数据部分替换而导致的数据部分交叉问题。[#28310](https://github.com/ClickHouse/ClickHouse/pull/28310) ([Azat Khuzhin](https://github.com/azat)).
* 修复在启用 `optimize_read_in_order` 设置时，对包含 `ORDER BY` 的查询和 `Merge` 表产生的不一致结果。[#28266](https://github.com/ClickHouse/ClickHouse/pull/28266) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在查询中使用 `Nullable(LowCardinality)` 类型且将 `extremes` 设置为 1 时，可能出现的未初始化内存读取问题。修复了 [#28165](https://github.com/ClickHouse/ClickHouse/issues/28165)。[#28205](https://github.com/ClickHouse/ClickHouse/pull/28205)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 针对投影的多项小修复。详见 PR 中的详细说明。[#28178](https://github.com/ClickHouse/ClickHouse/pull/28178) ([Amos Bird](https://github.com/amosbird))。
* 修复由于 context/config 重新加载器关闭顺序不正确而在关闭时极少发生的段错误。 [#28088](https://github.com/ClickHouse/ClickHouse/pull/28088) ([nvartolomei](https://github.com/nvartolomei)).
* 修复函数 `JSONExtract` 在处理类型为 `Nullable(String)` 的 null 值时的行为。此修复解决了 [#27929](https://github.com/ClickHouse/ClickHouse/issues/27929) 和 [#27930](https://github.com/ClickHouse/ClickHouse/issues/27930)。该问题最初是在 [https://github.com/ClickHouse/ClickHouse/pull/25452](https://github.com/ClickHouse/ClickHouse/pull/25452) 中引入的。[#27939](https://github.com/ClickHouse/ClickHouse/pull/27939)（[Amos Bird](https://github.com/amosbird)）。
* 针对新的 `clickhouse-keeper` 工具进行了多项修复。修复了 `clickhouse-keeper` 中的一个罕见错误，在该错误下客户端可能在收到请求的响应之前就收到 watch 响应。 [#28197](https://github.com/ClickHouse/ClickHouse/pull/28197) ([alesapin](https://github.com/alesapin))。修复了 `clickhouse-keeper` 中的不正确行为：当对子节点发起 `set` 请求时会触发列表 watch（`getChildren`）。 [#28190](https://github.com/ClickHouse/ClickHouse/pull/28190) ([alesapin](https://github.com/alesapin))。修复了一个罕见问题，即修改 `clickhouse-keeper` 设置可能导致日志丢失和服务器挂起。 [#28360](https://github.com/ClickHouse/ClickHouse/pull/28360) ([alesapin](https://github.com/alesapin))。修复了 `clickhouse-keeper` 中的一个错误，该错误在减小 `rotate_logs_interval` 时可能导致日志持续输出。 [#28152](https://github.com/ClickHouse/ClickHouse/pull/28152) ([alesapin](https://github.com/alesapin))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-2}

- 在压力测试中启用线程模糊器。线程模糊器是 ClickHouse 的一项功能,可以测试更多线程调度的排列组合,从而发现更多潜在问题。此更改关闭了 [#9813](https://github.com/ClickHouse/ClickHouse/issues/9813)、[#9814](https://github.com/ClickHouse/ClickHouse/issues/9814)、[#9515](https://github.com/ClickHouse/ClickHouse/issues/9515)、[#9516](https://github.com/ClickHouse/ClickHouse/issues/9516)。[#27538](https://github.com/ClickHouse/ClickHouse/pull/27538) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 为测试环境新增日志级别 `test`。该级别比默认的 `trace` 级别输出更详细的信息。[#28559](https://github.com/ClickHouse/ClickHouse/pull/28559) ([alesapin](https://github.com/alesapin))。
- 在 CMake 配置阶段输出 git 状态信息。[#28047](https://github.com/ClickHouse/ClickHouse/pull/28047) ([Braulio Valdivielso Martínez](https://github.com/BraulioVM))。
- 临时将 ubuntu apt 仓库切换至镜像 ru.archive.ubuntu.com,因为默认仓库 (archive.ubuntu.com) 在我们的 CI 环境中无法访问。[#28016](https://github.com/ClickHouse/ClickHouse/pull/28016) ([Ilya Yatsishin](https://github.com/qoega))。

### ClickHouse 版本 v21.9,2021-09-09 {#clickhouse-release-v219-2021-09-09}

#### 向后不兼容变更 {#backward-incompatible-change-3}


- 在 `Decimal` 类型的文本表示中不再输出尾随零。例如:对于精度为 6 的 decimal,将打印 `1.23` 而不是 `1.230000`。这解决了 [#15794](https://github.com/ClickHouse/ClickHouse/issues/15794)。如果您的应用程序依赖于尾随零,这可能会引入轻微的不兼容性。输出格式中的序列化可以通过设置 `output_format_decimal_trailing_zeros` 来控制。`toString` 的实现和转换为 String 的行为已无条件更改。[#27680](https://github.com/ClickHouse/ClickHouse/pull/27680) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 不允许将带有 `-Merge` 组合器的参数化聚合函数应用于由具有不同参数的聚合函数生成的聚合函数状态。例如,`fooState(42)(x)` 的状态不能用 `fooMerge(s)` 或 `fooMerge(123)(s)` 来完成,必须像 `fooMerge(42)(s)` 这样显式指定参数,并且参数必须相等。这不影响某些特殊的聚合函数,如 `quantile` 和 `sequence*`,它们仅在最终化阶段使用参数。[#26847](https://github.com/ClickHouse/ClickHouse/pull/26847) ([tavplubix](https://github.com/tavplubix))。
- 在 clickhouse-local 下,始终将带有端口的本地地址视为远程地址。[#26736](https://github.com/ClickHouse/ClickHouse/pull/26736) ([Raúl Marín](https://github.com/Algunenano))。
- 修复了在某些复杂查询中,当列别名与表达式名称相同时可能发生错误类型转换的问题。这修复了 [#25447](https://github.com/ClickHouse/ClickHouse/issues/25447)。这修复了 [#26914](https://github.com/ClickHouse/ClickHouse/issues/26914)。此修复可能会引入向后不兼容性:如果存在具有相同名称的不同表达式,将抛出异常。当设置 `enable_optimize_predicate_expression` 时,这可能会破坏某些罕见情况。[#26639](https://github.com/ClickHouse/ClickHouse/pull/26639) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 现在,如果标量子查询的类型可以是 `Nullable`,则始终返回 `Nullable` 结果。这是必需的,因为在空子查询的情况下,其结果应该是 `Null`。以前,可能会出现关于不兼容类型的错误(类型推导不执行标量子查询,可能会使用非可空类型)。结果为空且无法转换为 `Nullable` 的标量子查询(如 `Array` 或 `Tuple`)现在会抛出错误。修复了 [#25411](https://github.com/ClickHouse/ClickHouse/issues/25411)。[#26423](https://github.com/ClickHouse/ClickHouse/pull/26423) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 引入了 here document 语法。示例 `SELECT $doc$ VALUE $doc$`。[#26671](https://github.com/ClickHouse/ClickHouse/pull/26671) ([Maksim Kita](https://github.com/kitaisreal))。如果查询中存在包含 `$` 的标识符,此更改将向后不兼容 [#28768](https://github.com/ClickHouse/ClickHouse/issues/28768)。
- 现在索引可以处理 Nullable 类型,包括 `isNull` 和 `isNotNull`。[#12433](https://github.com/ClickHouse/ClickHouse/pull/12433) 和 [#12455](https://github.com/ClickHouse/ClickHouse/pull/12455) ([Amos Bird](https://github.com/amosbird)) 以及 [#27250](https://github.com/ClickHouse/ClickHouse/pull/27250) ([Azat Khuzhin](https://github.com/azat))。但这是通过磁盘格式更改完成的,尽管新服务器可以读取旧数据,但旧服务器无法读取新数据。此外,如果您有 `MINMAX` 数据跳过索引,可能会收到 `Data after mutation/merge is not byte-identical` 错误,因为新索引将具有 `.idx2` 扩展名,而之前是 `.idx`。也就是说,在这种情况下,您不应延迟更新所有现有副本,否则,如果旧副本(<21.9)从 21.9+ 的新副本下载数据,它将无法为下载的部分应用索引。

#### 新功能 {#new-feature-3}


* 实现短路函数求值，解决 [#12587](https://github.com/ClickHouse/ClickHouse/issues/12587)。新增设置项 `short_circuit_function_evaluation` 用于配置短路函数求值。[#23367](https://github.com/ClickHouse/ClickHouse/pull/23367) ([Kruglov Pavel](https://github.com/Avogar))。
* 添加对 `INTERSECT`、`EXCEPT`、`ANY`、`ALL` 运算符的支持。[#24757](https://github.com/ClickHouse/ClickHouse/pull/24757) ([Kirill Ershov](https://github.com/zdikov))（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在虚拟文件系统级别新增对加密（静态数据加密）的支持，使用 AES-CTR 算法实现。 [#24206](https://github.com/ClickHouse/ClickHouse/pull/24206) ([Latysheva Alexandra](https://github.com/alexelex)). ([Vitaly Baranov](https://github.com/vitlibar)) [#26733](https://github.com/ClickHouse/ClickHouse/pull/26733) [#26377](https://github.com/ClickHouse/ClickHouse/pull/26377) [#26465](https://github.com/ClickHouse/ClickHouse/pull/26465).
* 在同义词扩展中新增了用于分词、词干提取、词形还原和搜索的自然语言处理（NLP）函数。[#24997](https://github.com/ClickHouse/ClickHouse/pull/24997) ([Nikolay Degterinsky](https://github.com/evillique))。
* 增加了与 S2 几何库的集成。[#24980](https://github.com/ClickHouse/ClickHouse/pull/24980) ([Andr0901](https://github.com/Andr0901))（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 新增 SQLite 表引擎、表函数、数据库引擎。[#24194](https://github.com/ClickHouse/ClickHouse/pull/24194) ([Arslan Gumerov](https://github.com/g-arslan))。([Kseniia Sumarokova](https://github.com/kssenii))。
* 为 `MySQL`、`PostgreSQL`、`ClickHouse`、`JDBC`、`Cassandra` 字典源新增了自定义查询支持。关闭了 [#1270](https://github.com/ClickHouse/ClickHouse/issues/1270)。[#26995](https://github.com/ClickHouse/ClickHouse/pull/26995)（[Maksim Kita](https://github.com/kitaisreal)）。
* 通过 ZooKeeper 添加用户、角色、行级策略、配额和设置配置文件的共享（复制）存储。[#27426](https://github.com/ClickHouse/ClickHouse/pull/27426) ([Kevin Michel](https://github.com/kmichel-aiven)).
* 为 `INTO OUTFILE` 添加压缩功能，可自动选择压缩算法。修复 [#3473](https://github.com/ClickHouse/ClickHouse/issues/3473)。[#27134](https://github.com/ClickHouse/ClickHouse/pull/27134)（[Filatenkov Artur](https://github.com/FArthur-cmd)）。
* 类似于 `SELECT ... INTO OUTFILE`，新增 `INSERT ... FROM INFILE`。 [#27655](https://github.com/ClickHouse/ClickHouse/pull/27655) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* 新增 `complex_key_range_hashed` 字典。修复 [#22029](https://github.com/ClickHouse/ClickHouse/issues/22029)。[#27629](https://github.com/ClickHouse/ClickHouse/pull/27629)（[Maksim Kita](https://github.com/kitaisreal)）。
* 在 JOIN ON 子句中支持使用表达式。关闭 [#21868](https://github.com/ClickHouse/ClickHouse/issues/21868)。[#24420](https://github.com/ClickHouse/ClickHouse/pull/24420)（[Vladimir C](https://github.com/vdimir)）。
* 当客户端连接到服务器时，会接收所有已由服务器收集的告警信息。（可以通过选项 `--no-warnings` 禁用）。新增 `system.warnings` 表，用于收集关于服务器配置的告警。[#26246](https://github.com/ClickHouse/ClickHouse/pull/26246) ([Filatenkov Artur](https://github.com/FArthur-cmd)). [#26282](https://github.com/ClickHouse/ClickHouse/pull/26282) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* 允许在聚合函数参数中使用来自 WITH 和 SELECT 子句的常量表达式。关闭 [#10945](https://github.com/ClickHouse/ClickHouse/issues/10945)。[#27531](https://github.com/ClickHouse/ClickHouse/pull/27531) ([abel-cheng](https://github.com/abel-cheng))。
* 添加 `tupleToNameValuePairs` 函数，用于将命名元组转换为键值对数组。[#27505](https://github.com/ClickHouse/ClickHouse/pull/27505) ([Braulio Valdivielso Martínez](https://github.com/BraulioVM))。
* 为导入/导出添加对 `bzip2` 压缩方法的支持。修复了 [#22428](https://github.com/ClickHouse/ClickHouse/issues/22428)。[#27377](https://github.com/ClickHouse/ClickHouse/pull/27377)（[Nikolay Degterinsky](https://github.com/evillique)）。
* 新增 `bitmapSubsetOffsetLimit(bitmap, offset, cardinality_limit)` 函数。该函数在偏移量为 `offset` 的基础上，从 bitmap 中创建一个子集，并将结果基数限制为 `cardinality_limit`。 [#27234](https://github.com/ClickHouse/ClickHouse/pull/27234) ([DHBin](https://github.com/DHBin)).
* 为 `system.users` 表添加 `default_database` 列。[#27054](https://github.com/ClickHouse/ClickHouse/pull/27054) ([kevin wan](https://github.com/MaxWk))。
* 在表函数 &#39;cluster&#39; 和 &#39;clusterAllReplicas&#39; 中增加对 `cluster` 宏的支持。[#26913](https://github.com/ClickHouse/ClickHouse/pull/26913) ([polyprogrammist](https://github.com/PolyProgrammist)).
* 添加了新函数 `currentRoles()`, `enabledRoles()`, `defaultRoles()`. [#26780](https://github.com/ClickHouse/ClickHouse/pull/26780) ([Vitaly Baranov](https://github.com/vitlibar)).
* 新增函数 `currentProfiles()`, `enabledProfiles()`, `defaultProfiles()`. [#26714](https://github.com/ClickHouse/ClickHouse/pull/26714) ([Vitaly Baranov](https://github.com/vitlibar)).
* 添加用于返回当前查询 (initial&#95;)query&#95;id 的函数。修复了 [#23682](https://github.com/ClickHouse/ClickHouse/issues/23682)。[#26410](https://github.com/ClickHouse/ClickHouse/pull/26410) ([Alexey Boykov](https://github.com/mathalex)).
* 添加 `REPLACE GRANT` 功能。[#26384](https://github.com/ClickHouse/ClickHouse/pull/26384)（[Caspian](https://github.com/Cas-pian)）。
* `EXPLAIN` 查询现在新增了 `EXPLAIN ESTIMATE ...` 模式，用于显示从 MergeTree 表中读取的行数、marks 和 parts 等信息。修复了 [#23941](https://github.com/ClickHouse/ClickHouse/issues/23941)。 [#26131](https://github.com/ClickHouse/ClickHouse/pull/26131) ([fastio](https://github.com/fastio))。
* 新增 `system.zookeeper_log` 表。ZooKeeper 客户端的所有操作都会记录到该表中。实现了 [#25449](https://github.com/ClickHouse/ClickHouse/issues/25449)。[#26129](https://github.com/ClickHouse/ClickHouse/pull/26129)（[tavplubix](https://github.com/tavplubix)）。
* 为 `ReplicatedMergeTree` 在 `HDFS` 存储上实现零拷贝复制。[#25918](https://github.com/ClickHouse/ClickHouse/pull/25918) ([Zhichang Yu](https://github.com/yuzhichang))。
* 允许在 `Arrow`、`ORC` 和 `Parquet` 输入格式中以结构体数组的形式插入 `Nested` 类型。[#25902](https://github.com/ClickHouse/ClickHouse/pull/25902) ([Kruglov Pavel](https://github.com/Avogar)).
* 新增数据类型 `Date32`（以 Int32 存储数据），支持与 `DateTime64` 相同的日期范围，支持将 Parquet 中的 date32 加载为 ClickHouse 的 `Date32`，并新增类似 `toDate` 的函数 `toDate32`。[#25774](https://github.com/ClickHouse/ClickHouse/pull/25774) ([LiuNeng](https://github.com/liuneng1994))。
* 允许为用户设置默认数据库。 [#25268](https://github.com/ClickHouse/ClickHouse/issues/25268)。 [#25687](https://github.com/ClickHouse/ClickHouse/pull/25687) ([kevin wan](https://github.com/MaxWk))。
* 为 `MongoDB` 引擎添加可选参数以接受连接字符串选项并支持 SSL 连接。关闭 [#21189](https://github.com/ClickHouse/ClickHouse/issues/21189)。关闭 [#21041](https://github.com/ClickHouse/ClickHouse/issues/21041)。[#22045](https://github.com/ClickHouse/ClickHouse/pull/22045) ([Omar Bazaraa](https://github.com/OmarBazaraa))。

#### 实验性功能 {#experimental-feature-3}

- 新增压缩编解码器 `AES_128_GCM_SIV`,用于加密列而非压缩列。[#19896](https://github.com/ClickHouse/ClickHouse/pull/19896) ([PHO](https://github.com/depressed-pho))。该功能将被重写,请勿使用。
- 将 `MaterializeMySQL` 重命名为 `MaterializedMySQL`。[#26822](https://github.com/ClickHouse/ClickHouse/pull/26822) ([tavplubix](https://github.com/tavplubix))。

#### 性能改进 {#performance-improvement-3}

- 通过减少 `clock_gettime` 系统调用次数,提升 `max_execution_time = 0` 时快速查询的性能。[#27325](https://github.com/ClickHouse/ClickHouse/pull/27325) ([filimonov](https://github.com/filimonov))。
- 针对日期时间相关比较进行专门优化以提升性能。此改进修复了 [#27083](https://github.com/ClickHouse/ClickHouse/issues/27083)。[#27122](https://github.com/ClickHouse/ClickHouse/pull/27122) ([Amos Bird](https://github.com/amosbird))。
- 在并发读取相同文件时共享文件描述符。在 Linux 上性能差异不明显,但在典型服务器上打开的文件数量将显著减少(10 到 100 倍),从而简化运维操作。参见 [#26214](https://github.com/ClickHouse/ClickHouse/issues/26214)。[#26768](https://github.com/ClickHouse/ClickHouse/pull/26768) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 改进需要从大量列的表中读取数据的短查询的延迟。[#26371](https://github.com/ClickHouse/ClickHouse/pull/26371) ([Anton Popov](https://github.com/CurtizJ))。
- 在分析查询时不再为索引构建集合。[#26365](https://github.com/ClickHouse/ClickHouse/pull/26365) ([Raúl Marín](https://github.com/Algunenano))。
- 对具有原生表示的可空整数类型的 SUM 进行向量化 ([David Manzanares](https://github.com/davidmanzanares), [Raúl Marín](https://github.com/Algunenano))。[#26248](https://github.com/ClickHouse/ClickHouse/pull/26248) ([Raúl Marín](https://github.com/Algunenano))。
- 编译涉及 `Enum` 类型列的表达式。[#26237](https://github.com/ClickHouse/ClickHouse/pull/26237) ([Maksim Kita](https://github.com/kitaisreal))。
- 编译聚合函数 `groupBitOr`、`groupBitAnd`、`groupBitXor`。[#26161](https://github.com/ClickHouse/ClickHouse/pull/26161) ([Maksim Kita](https://github.com/kitaisreal))。
- 通过在读取空 DEFAULT 列时更好地预测块大小来改进内存使用。关闭 [#17317](https://github.com/ClickHouse/ClickHouse/issues/17317)。[#25917](https://github.com/ClickHouse/ClickHouse/pull/25917) ([Vladimir Chebotarev](https://github.com/excitoon))。
- 减少带有 `ORDER BY primary_key` 的查询中的内存使用和读取行数。[#25721](https://github.com/ClickHouse/ClickHouse/pull/25721) ([Anton Popov](https://github.com/CurtizJ))。
- 默认启用 `distributed_push_down_limit`。[#27104](https://github.com/ClickHouse/ClickHouse/pull/27104) ([Azat Khuzhin](https://github.com/azat))。
- 当 timeZone 为常量值时使 `toTimeZone` 具有单调性,以支持在使用类似 SQL 时进行分区裁剪。[#26261](https://github.com/ClickHouse/ClickHouse/pull/26261) ([huangzhaowei](https://github.com/SaintBacchus))。

#### 改进 {#improvement-3}


* 将窗口函数标记为可在生产环境中通用使用。移除 `allow_experimental_window_functions` 设置。[#27184](https://github.com/ClickHouse/ClickHouse/pull/27184)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* 提高对非整分钟时区偏移量的兼容性。[#27080](https://github.com/ClickHouse/ClickHouse/pull/27080)（[Raúl Marín](https://github.com/Algunenano)）。
* 如果 `File` 表中的文件描述符指向常规文件,则允许多次读取。这使得 `clickhouse-local` 可以从标准输入多次读取数据(使用多个 SELECT 查询或子查询),前提是标准输入为常规文件,例如 `clickhouse-local --query "SELECT * FROM table UNION ALL SELECT * FROM table" ... < file`。此功能修复了 [#11124](https://github.com/ClickHouse/ClickHouse/issues/11124)。与 ([alexey-milovidov](https://github.com/alexey-milovidov)) 合作完成。[#25960](https://github.com/ClickHouse/ClickHouse/pull/25960) ([BoloniniD](https://github.com/BoloniniD))。
* 移除重复的索引分析，并在投影分析期间避免可能发生的无效 `LIMIT` 检查。 [#27742](https://github.com/ClickHouse/ClickHouse/pull/27742) ([Amos Bird](https://github.com/amosbird)).
* 支持在 HTTP 请求的 body 中传递查询参数。 [#27706](https://github.com/ClickHouse/ClickHouse/pull/27706) ([Hermano Lustosa](https://github.com/hllustosa))。
* 禁止在分区表达式上使用 `arrayJoin`。[#27648](https://github.com/ClickHouse/ClickHouse/pull/27648) ([Raúl Marín](https://github.com/Algunenano))。
* 在身份验证失败时记录客户端 IP 地址。 [#27514](https://github.com/ClickHouse/ClickHouse/pull/27514) ([Misko Lee](https://github.com/imiskolee)).
* 在 GRPC 协议中，对二进制数据使用 bytes 类型而不是字符串类型。[#27431](https://github.com/ClickHouse/ClickHouse/pull/27431) ([Vitaly Baranov](https://github.com/vitlibar)).
* 如果未设置 HTTP 端口，而用户尝试向 TCP 端口发送 HTTP 请求，则返回包含错误消息的响应。 [#27385](https://github.com/ClickHouse/ClickHouse/pull/27385) ([Braulio Valdivielso Martínez](https://github.com/BraulioVM)).
* 为内部使用新增 `_CAST` 函数，该函数不会保留类型的可为空性，而普通的 `CAST` 将根据设置 `cast_keep_nullable` 保留可为空性。修复 [#12636](https://github.com/ClickHouse/ClickHouse/issues/12636)。[#27382](https://github.com/ClickHouse/ClickHouse/pull/27382)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 添加设置 `log_formatted_queries`，以在 `system.query_log` 中记录额外的格式化查询。由于 `normalizeQuery` 和 `normalizeQueryKeepNames` 等函数为了获得更高性能，不会对查询进行解析或格式化，因此这对于规范化查询分析非常有用。 [#27380](https://github.com/ClickHouse/ClickHouse/pull/27380) ([Amos Bird](https://github.com/amosbird))。
* 添加两个设置 `max_hyperscan_regexp_length` 和 `max_hyperscan_regexp_total_length`，用于防止在与 Hyperscan 相关的函数（例如 `multiMatchAny`）中使用过大的正则表达式。 [#27378](https://github.com/ClickHouse/ClickHouse/pull/27378) ([Amos Bird](https://github.com/amosbird))。
* 现在，位图聚合函数所使用的内存也会计入内存限制。这修复了 [#26555](https://github.com/ClickHouse/ClickHouse/issues/26555)。[#27252](https://github.com/ClickHouse/ClickHouse/pull/27252) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 为 S3 代理解析器增加 10 秒缓存。 [#27216](https://github.com/ClickHouse/ClickHouse/pull/27216) ([ianton-ru](https://github.com/ianton-ru)).
* 将全局互斥锁拆分为针对单个 `regexp` 构造的互斥锁。这样可以避免单个大规模的 `regexp` 构造阻塞其他相关线程。[#27211](https://github.com/ClickHouse/ClickHouse/pull/27211)（[Amos Bird](https://github.com/amosbird)）。
* 为 PostgreSQL 数据库引擎添加对 schema 的支持。修复 [#27166](https://github.com/ClickHouse/ClickHouse/issues/27166)。[#27198](https://github.com/ClickHouse/ClickHouse/pull/27198)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在 clickhouse-client 中跟踪内存使用。 [#27191](https://github.com/ClickHouse/ClickHouse/pull/27191) ([Filatenkov Artur](https://github.com/FArthur-cmd))。
* 尝试在查询启动失败时也向 `system.query_log` 中记录 `query_kind`。[#27182](https://github.com/ClickHouse/ClickHouse/pull/27182) ([Amos Bird](https://github.com/amosbird))。
* 在表 `system.replicas` 中新增列 `replica_is_active`，用于将副本名称映射到该副本是否处于活跃状态。修复了 [#27138](https://github.com/ClickHouse/ClickHouse/issues/27138)。 [#27180](https://github.com/ClickHouse/ClickHouse/pull/27180)（[Maksim Kita](https://github.com/kitaisreal)）。
* 允许在 Web UI 中通过服务器 URI 传递查询设置。 [#27177](https://github.com/ClickHouse/ClickHouse/pull/27177) ([kolsys](https://github.com/kolsys))。
* 新增名为 `MaxPushedDDLEntryID` 的指标，表示当前节点推送到 ZooKeeper 的最大 DDL 条目 ID。[#27174](https://github.com/ClickHouse/ClickHouse/pull/27174) ([Fuwang Hu](https://github.com/fuwhu))。
* 改进了 `clickhouse-keeper` 在创建 znode 时对存在条件和空字符串节点的判断。[#27125](https://github.com/ClickHouse/ClickHouse/pull/27125) ([小路](https://github.com/nicelulu)).
* `Merge JOIN` 现在能够正确处理右侧为空集的情况。[#27078](https://github.com/ClickHouse/ClickHouse/pull/27078) ([Vladimir C](https://github.com/vdimir))。
* 现在，函数可以是分片级常量，这意味着如果在某个分布式表的上下文中执行，它会生成一个普通列，否则会返回一个常量值。值得注意的函数包括：`hostName()`, `tcpPort()`, `version()`, `buildId()`, `uptime()` 等。[#27020](https://github.com/ClickHouse/ClickHouse/pull/27020)（[Amos Bird](https://github.com/amosbird)）。
* 更新了 `extractAllGroupsHorizontal` —— 现在可以通过可选的第三个参数为每行设置匹配数量的上限。[#26961](https://github.com/ClickHouse/ClickHouse/pull/26961) ([Vasily Nemkov](https://github.com/Enmk))。
* 通过 `system.rocksdb` 表对外提供 `RocksDB` 统计信息。从 ClickHouse 配置中读取 rocksdb 选项（`rocksdb...` 键）。注意：ClickHouse 并不依赖 RocksDB，它只是众多可集成的附加存储引擎之一。 [#26821](https://github.com/ClickHouse/ClickHouse/pull/26821) ([Azat Khuzhin](https://github.com/azat)).
* 更精简的 RocksDB 内部日志。注意：ClickHouse 并不依赖 RocksDB，它只是众多可集成的附加存储引擎之一。此更改关闭了 [#26252](https://github.com/ClickHouse/ClickHouse/issues/26252)。[#26789](https://github.com/ClickHouse/ClickHouse/pull/26789)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 更改默认角色只会影响新的会话。 [#26759](https://github.com/ClickHouse/ClickHouse/pull/26759) ([Vitaly Baranov](https://github.com/vitlibar)).
* 在 Docker 中默认禁用 Watchdog。修复未处理 Ctrl+C 的问题。[#26757](https://github.com/ClickHouse/ClickHouse/pull/26757) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* 如果为传入的 profile 设置了约束，`SET PROFILE` 现在也会生效这些约束。[#26730](https://github.com/ClickHouse/ClickHouse/pull/26730) ([Vitaly Baranov](https://github.com/vitlibar)).
* 改进对 `KILL QUERY` 请求的处理。[#26675](https://github.com/ClickHouse/ClickHouse/pull/26675) ([Raúl Marín](https://github.com/Algunenano))。
* `mapPopulatesSeries` 函数现在支持 `Map` 类型。[#26663](https://github.com/ClickHouse/ClickHouse/pull/26663) ([Ildus Kurbangaliev](https://github.com/ildus)).
* 修复在使用 `skip_unavailable_shards` 时出现的过多（x2）连接尝试。[#26658](https://github.com/ClickHouse/ClickHouse/pull/26658) ([Azat Khuzhin](https://github.com/azat))。
* 在连接失败时避免 `clickhouse-benchmark` 挂起（例如在 EMFILE 情况下）。[#26656](https://github.com/ClickHouse/ClickHouse/pull/26656)（[Azat Khuzhin](https://github.com/azat)）。
* 允许 Kafka 引擎使用更多线程。 [#26642](https://github.com/ClickHouse/ClickHouse/pull/26642) ([feihengye](https://github.com/feihengye))。
* 为 `clickhouse-benchmark` 增加轮循（round-robin）支持（除统计报告外，与常规的多主机/端口运行没有区别）。[#26607](https://github.com/ClickHouse/ClickHouse/pull/26607) ([Azat Khuzhin](https://github.com/azat))。
* 可执行字典（`executable`、`executable_pool`）现在支持使用 `clickhouse-local` 通过 DDL 查询进行创建。修复了 [#22355](https://github.com/ClickHouse/ClickHouse/issues/22355)。[#26510](https://github.com/ClickHouse/ClickHouse/pull/26510)（[Maksim Kita](https://github.com/kitaisreal)）。
* 为 `mysql` 和 `postgresql` 兼容协议处理程序设置客户端查询种类。 [#26498](https://github.com/ClickHouse/ClickHouse/pull/26498) ([anneji-dev](https://github.com/anneji-dev)).
* 对于类似 `SELECT * FROM dist ORDER BY key LIMIT 10` 的查询，在分片上应用 `LIMIT`，并设置 `distributed_push_down_limit=1`。避免对类似 `SELECT DISTINCT shading_key FROM dist ORDER BY key` 的查询执行 `Distinct`/`LIMIT BY` 步骤。现在，`distributed_push_down_limit` 会被 `optimize_distributed_group_by_sharding_key` 优化所考虑。[#26466](https://github.com/ClickHouse/ClickHouse/pull/26466)（[Azat Khuzhin](https://github.com/azat)）。
* 将 protobuf 更新到 3.17.3。变更日志可在 [https://github.com/protocolbuffers/protobuf/releases](https://github.com/protocolbuffers/protobuf/releases) 查看。[#26424](https://github.com/ClickHouse/ClickHouse/pull/26424)（[Ilya Yatsishin](https://github.com/qoega)）。
* 启用 `use_hedged_requests` 设置，以降低大型集群中的尾延迟。[#26380](https://github.com/ClickHouse/ClickHouse/pull/26380)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 改进在用户允许主机列表中包含不存在的主机时的行为。[#26368](https://github.com/ClickHouse/ClickHouse/pull/26368) ([ianton-ru](https://github.com/ianton-ru)).
* 通过 `CREATE TABLE` 语句新增对 `Distributed` 目录监控参数的设置支持（例如 `CREATE TABLE dist (key Int) Engine=Distributed(cluster, db, table) SETTINGS monitor_batch_inserts=1` 以及类似语句）。[#26336](https://github.com/ClickHouse/ClickHouse/pull/26336) ([Azat Khuzhin](https://github.com/azat))。
* 如果服务器地址与 Web UI 的来源不同，则在 Web UI 的历史记录 URL 中保存该服务器地址。此更改修复了 [#26044](https://github.com/ClickHouse/ClickHouse/issues/26044)。[#26322](https://github.com/ClickHouse/ClickHouse/pull/26322)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为对 `sleep` / `sleepEachRow` 的 profile 调用添加事件。[#26320](https://github.com/ClickHouse/ClickHouse/pull/26320) ([Raúl Marín](https://github.com/Algunenano)).
* 允许在不同集群之间复用分片连接，同时在使用 `cluster` 表函数时避免创建新的连接。[#26318](https://github.com/ClickHouse/ClickHouse/pull/26318) ([Amos Bird](https://github.com/amosbird))。
* 通过具有默认值的参数来控制清理旧临时目录的执行周期。 [#26212](https://github.com/ClickHouse/ClickHouse/issues/26212). [#26313](https://github.com/ClickHouse/ClickHouse/pull/26313) ([fastio](https://github.com/fastio)).
* 添加设置 `function_range_max_elements_in_block`，用于调整函数 `range` 生成数据量的安全阈值。该更改修复了 [#26303](https://github.com/ClickHouse/ClickHouse/issues/26303)。[#26305](https://github.com/ClickHouse/ClickHouse/pull/26305)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在创建表时检查哈希函数，而不是在采样时检查。为 MergeTree 添加相关设置：如果有人创建了采样列不正确的表但从未使用采样功能，可以禁用此设置，从而在不抛出异常的情况下启动服务器。 [#26256](https://github.com/ClickHouse/ClickHouse/pull/26256) ([zhaoyu](https://github.com/zxc111)).
* 新增 `output_format_avro_string_column_pattern` 设置，用于将指定的 `String` 列在 Avro 中以字符串而非默认的字节形式输出。实现了 [#22414](https://github.com/ClickHouse/ClickHouse/issues/22414)。[#26245](https://github.com/ClickHouse/ClickHouse/pull/26245)（[Ilya Golshtein](https://github.com/ilejn)）。
* 在 `system.columns` 表中为 `Log` 和 `TinyLog` 表添加列大小信息。此更改解决了 [#9001](https://github.com/ClickHouse/ClickHouse/issues/9001)。[#26241](https://github.com/ClickHouse/ClickHouse/pull/26241)（[Nikolay Degterinsky](https://github.com/evillique)）。
* 在存在自定义磁盘配置且某些磁盘上不存在 `detached` 目录时，查询 `system.detached_parts` 表时不要抛出异常。修复了 [#26078](https://github.com/ClickHouse/ClickHouse/issues/26078)。[#26236](https://github.com/ClickHouse/ClickHouse/pull/26236)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 检查键中是否存在非确定性函数，包括 `now()`, `today()` 等常量表达式。修复了 [#25875](https://github.com/ClickHouse/ClickHouse/issues/25875)。修复了 [#11333](https://github.com/ClickHouse/ClickHouse/issues/11333)。[#26235](https://github.com/ClickHouse/ClickHouse/pull/26235)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 PostgreSQL 表引擎中支持将 timestamp 和 timestamptz 数据类型转换为 `DateTime64`。 [#26234](https://github.com/ClickHouse/ClickHouse/pull/26234) ([jasine](https://github.com/jasine)).
* 对 projection 应用更激进的 `IN` 索引分析，以便可以选择更优的 projection 备选项。 [#26218](https://github.com/ClickHouse/ClickHouse/pull/26218) ([Amos Bird](https://github.com/amosbird)).
* 当传入标量函数时，移除了 `IN` 的 `GLOBAL` 关键字。在早期版本中，如果用户指定 `GLOBAL IN f(x)` 会抛出异常。[#26217](https://github.com/ClickHouse/ClickHouse/pull/26217) ([Amos Bird](https://github.com/amosbird))。
* 在异常消息中添加错误 ID（例如 `BAD_ARGUMENTS`）。此更改关闭了 [#25862](https://github.com/ClickHouse/ClickHouse/issues/25862)。[#26172](https://github.com/ClickHouse/ClickHouse/pull/26172)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在 `clickhouse-local` 中使用 `--progress` 选项时的错误输出。进度条在达到 100% 后会被清除——与 `clickhouse-client` 的行为一致。修复 [#17484](https://github.com/ClickHouse/ClickHouse/issues/17484)。[#26128](https://github.com/ClickHouse/ClickHouse/pull/26128)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 添加 `merge_selecting_sleep_ms` 设置。[#26120](https://github.com/ClickHouse/ClickHouse/pull/26120) ([lthaooo](https://github.com/lthaooo))。
* 移除了复杂的 Linux AIO 单块预读使用方式,改用简单的同步 IO 配合 O&#95;DIRECT。在之前的版本中,当 `max_threads` 大于 1 时,`min_bytes_to_use_direct_io` 设置可能无法正常工作。使用直接 IO 读取(查询默认禁用,大型合并默认启用)的工作效率会降低。此更改解决了 [#25997](https://github.com/ClickHouse/ClickHouse/issues/25997)。[#26003](https://github.com/ClickHouse/ClickHouse/pull/26003) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 在执行 `REPLACE TABLE` 查询时刷新 `Distributed` 表。修复了 [#24566](https://github.com/ClickHouse/ClickHouse/issues/24566) —— 如果向新表插入数据失败，则在 `[CREATE OR] REPLACE TABLE ... AS SELECT` 查询中不要替换（或创建）表。修复了 [#23175](https://github.com/ClickHouse/ClickHouse/issues/23175)。[#25895](https://github.com/ClickHouse/ClickHouse/pull/25895) ([tavplubix](https://github.com/tavplubix))。
* 向 `system.query_log` 添加 `views` 列，其中包含查询执行的（物化或实时）视图名称。新增一个日志表（`system.query_views_log`），用于记录查询期间每个已执行视图的信息。修改视图执行方式：当在执行视图时抛出异常时，任何已经开始执行的视图将继续运行直至完成。此前这仅在 `parallel_view_processing=true` 时生效，现在始终采用这种行为。- 依赖视图现在会向上下文报告读取进度。[#25714](https://github.com/ClickHouse/ClickHouse/pull/25714) ([Raúl Marín](https://github.com/Algunenano))。
* 在执行完分布式查询后异步进行连接回收。新增服务器设置 `max_threads_for_connection_collector`，用于指定在后台回收连接的工作线程数。如果连接池已满，则会同步回收连接，但行为与之前略有不同：回收发生在向客户端发送 EOS 之后；在接收足够数据后查询会立即成功；任何异常都会被记录到日志中，而不会再抛给客户端。新增设置 `drain_timeout`（默认 3 秒）。连接回收在超时后会断开连接。[#25674](https://github.com/ClickHouse/ClickHouse/pull/25674)（[Amos Bird](https://github.com/amosbird)）。
* 在配置中支持多个 include。现在可以从多个来源引入 users 配置和 remote servers 配置。只需放置带有 `from_zk`、`from_env` 或 `incl` 属性的 `<include />` 元素，它就会被相应替换为实际内容。[#24404](https://github.com/ClickHouse/ClickHouse/pull/24404) ([nvartolomei](https://github.com/nvartolomei))。
* 修复在 `insert_distributed_one_random_shard = 1` 时向分布式表进行多批次插入的问题。这是一个边缘特性。标记为改进。 [#23140](https://github.com/ClickHouse/ClickHouse/pull/23140) ([Amos Bird](https://github.com/amosbird)).
* 为 `Map` 类型的键/值提供对 `LowCardinality` 和 `FixedString` 的支持。 [#21543](https://github.com/ClickHouse/ClickHouse/pull/21543) ([hexiaoting](https://github.com/hexiaoting)).
* 启用本地磁盘配置热加载。[#19526](https://github.com/ClickHouse/ClickHouse/pull/19526) ([taiyang-li](https://github.com/taiyang-li))。

#### 错误修复 {#bug-fix-2}


* 修复了可能导致副本数据不一致的几个错误。 [#27808](https://github.com/ClickHouse/ClickHouse/pull/27808) ([tavplubix](https://github.com/tavplubix)).
* 修复了 `DROP PART` 中的一个罕见错误，该错误可能会导致出现 `Unexpected merged part intersects drop range` 错误。 [#27807](https://github.com/ClickHouse/ClickHouse/pull/27807) ([alesapin](https://github.com/alesapin)).
* 修复了当来自 Kafka 的 `NULL`（墓碑）消息出现时某些格式可能导致崩溃的问题。关闭 [#19255](https://github.com/ClickHouse/ClickHouse/issues/19255)。[#27794](https://github.com/ClickHouse/ClickHouse/pull/27794)（[filimonov](https://github.com/filimonov)）。
* 修复在子查询中使用 `UNION DISTINCT` 时的列过滤问题。修复了 [#27578](https://github.com/ClickHouse/ClickHouse/issues/27578)。[#27689](https://github.com/ClickHouse/ClickHouse/pull/27689)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在将 `arrayHas` 等函数应用于由不同非数值类型（例如 `DateTime` 和 `DateTime64`）组成的 `LowCardinality` 的 `Nullable` 数组时发生的不正确类型转换问题。在之前的版本中会发生错误的类型转换，在新版本中，这种情况将会抛出异常。修复关联：[ #26330](https://github.com/ClickHouse/ClickHouse/issues/26330)。[#27682](https://github.com/ClickHouse/ClickHouse/pull/27682)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `postgresql` 表函数导致连接未关闭的问题。修复 [#26088](https://github.com/ClickHouse/ClickHouse/issues/26088)。[#27662](https://github.com/ClickHouse/ClickHouse/pull/27662)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复了另一个出现 `Unexpected merged part ... intersecting drop range ...` 错误的场景。[#27656](https://github.com/ClickHouse/ClickHouse/pull/27656)（[tavplubix](https://github.com/tavplubix)）。
* 修复 `Distributed` 表中带别名的列的错误。 [#27652](https://github.com/ClickHouse/ClickHouse/pull/27652) ([Vladimir C](https://github.com/vdimir)).
* 在将 `max_memory_usage*` 设置为非零值之后，就无法再将其重置为 0（表示无限制）。该问题已修复。[#27638](https://github.com/ClickHouse/ClickHouse/pull/27638) ([tavplubix](https://github.com/tavplubix))。
* 修复了从各个组成部分构造时间值时可能发生的下溢问题。修复了 [#27193](https://github.com/ClickHouse/ClickHouse/issues/27193)。[#27605](https://github.com/ClickHouse/ClickHouse/pull/27605)（[Vasily Nemkov](https://github.com/Enmk)）。
* 修复在投影物化过程中，当某些数据分片缺少列时导致的崩溃问题。修复了 [#27512](https://github.com/ClickHouse/ClickHouse/issues/27512)。[#27528](https://github.com/ClickHouse/ClickHouse/pull/27528)（[Amos Bird](https://github.com/amosbird)）。
* 修复指标 `BackgroundMessageBrokerSchedulePoolTask`，之前可能存在拼写错误。[#27452](https://github.com/ClickHouse/ClickHouse/pull/27452) ([Ben](https://github.com/benbiti))。
* 修复当分片数为零且包含聚合时的分布式查询。 [#27427](https://github.com/ClickHouse/ClickHouse/pull/27427) ([Azat Khuzhin](https://github.com/azat)).
* 当 `/proc/meminfo` 不包含 KB 后缀时的兼容性支持。[#27361](https://github.com/ClickHouse/ClickHouse/pull/27361) ([Mike Kot](https://github.com/myrrc))。
* 修复了在包含行级安全、`PREWHERE` 和 `LowCardinality` 过滤条件的查询中导致结果不正确的问题。修复了 [#27179](https://github.com/ClickHouse/ClickHouse/issues/27179)。[#27329](https://github.com/ClickHouse/ClickHouse/pull/27329)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了使用旧语法创建的 MergeTree 表中分区 ID 验证不正确的问题。[#27328](https://github.com/ClickHouse/ClickHouse/pull/27328) ([tavplubix](https://github.com/tavplubix)).
* 修复在使用并行格式（CSV / TSV）时的 MySQL 协议。[#27326](https://github.com/ClickHouse/ClickHouse/pull/27326)（[Raúl Marín](https://github.com/Algunenano)）。
* 修复带有采样的查询中出现的 `Cannot find column` 错误。该问题最初在 [#24574](https://github.com/ClickHouse/ClickHouse/issues/24574) 中引入。本次修复解决了 [#26522](https://github.com/ClickHouse/ClickHouse/issues/26522)。[#27301](https://github.com/ClickHouse/ClickHouse/pull/27301)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在 `PREWHERE` 中使用 `LowCardinality` 的某些查询会出现的错误，例如 `Expected ColumnLowCardinality, gotUInt8` 或 `Bad cast from type DB::ColumnVector<char8_t> to DB::ColumnLowCardinality`。更重要的是，修复错误消息中缺少空格的问题。修复了 [#23515](https://github.com/ClickHouse/ClickHouse/issues/23515)。[#27298](https://github.com/ClickHouse/ClickHouse/pull/27298)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在 `distributed_push_down_limit = 1` 或 `optimize_distributed_group_by_sharding_key = 1` 并配合 `LIMIT BY` 和 `LIMIT OFFSET` 使用时，`distributed_group_by_no_merge = 2` 的问题。[#27249](https://github.com/ClickHouse/ClickHouse/pull/27249) ([Azat Khuzhin](https://github.com/azat))。这些是几乎没有人使用的冷门配置组合。
* 修复在非复制 MergeTree 中由于无效分区而卡住的 mutation。[#27248](https://github.com/ClickHouse/ClickHouse/pull/27248) ([Azat Khuzhin](https://github.com/azat))。
* 在存在歧义的情况下，`lambda` 函数会优先将其参数视为解析对象，而不是其他别名或标识符。[#27235](https://github.com/ClickHouse/ClickHouse/pull/27235)（[Raúl Marín](https://github.com/Algunenano)）。
* 修复合并连接中的列结构，关闭 [#27091](https://github.com/ClickHouse/ClickHouse/issues/27091)。[#27217](https://github.com/ClickHouse/ClickHouse/pull/27217)（[Vladimir C](https://github.com/vdimir)）。
* 在极少数情况下,`system.detached_parts` 表可能包含某些数据分片的错误信息,该问题已修复。修复 [#27114](https://github.com/ClickHouse/ClickHouse/issues/27114)。[#27183](https://github.com/ClickHouse/ClickHouse/pull/27183) ([tavplubix](https://github.com/tavplubix))。
* 修复函数 `multiSearch*` 在使用空数组时的未初始化内存问题，关闭 [#27169](https://github.com/ClickHouse/ClickHouse/issues/27169)。[#27181](https://github.com/ClickHouse/ClickHouse/pull/27181)（[Vladimir C](https://github.com/vdimir)）。
* 修复 GRPCServer 中的同步。此 PR 解决了 [#27024](https://github.com/ClickHouse/ClickHouse/issues/27024)。[#27064](https://github.com/ClickHouse/ClickHouse/pull/27064)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复了 `cache`、`complex_key_cache`、`ssd_cache`、`complex_key_ssd_cache` 的配置解析问题。对于非 `cache` 类型的字典，选项 `allow_read_expired_keys`、`max_update_queue_size`、`update_queue_push_timeout_milliseconds`、`query_wait_timeout_milliseconds` 之前不会被解析。[#27032](https://github.com/ClickHouse/ClickHouse/pull/27032)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复由于与 `DROP_RANGE` 的竞争条件导致的潜在 mutation 栈问题。 [#27002](https://github.com/ClickHouse/ClickHouse/pull/27002) ([Azat Khuzhin](https://github.com/azat)).
* 现在，会对诸如 `ALTER TABLE ... PARTITION ID xxx` 之类查询中的分区 ID 进行正确性校验。修复了 [#25718](https://github.com/ClickHouse/ClickHouse/issues/25718)。[#26963](https://github.com/ClickHouse/ClickHouse/pull/26963)（[alesapin](https://github.com/alesapin)）。
* 在某些情况下，修复在包含多个 `JOIN` 时出现的“Unknown column name”错误，关闭 [#26899](https://github.com/ClickHouse/ClickHouse/issues/26899)。[#26957](https://github.com/ClickHouse/ClickHouse/pull/26957)（[Vladimir C](https://github.com/vdimir)）。
* 修复自定义 TLD 的读取问题（在缓冲区较小或文件较大时会停止处理）。[#26948](https://github.com/ClickHouse/ClickHouse/pull/26948)（[Azat Khuzhin](https://github.com/azat)）。
* 修复在 `DEFAULT` 列引用其他没有 `DEFAULT` 表达式的非物化列时出现的错误 `Missing columns: 'xxx'`。修复了 [#26591](https://github.com/ClickHouse/ClickHouse/issues/26591)。[#26900](https://github.com/ClickHouse/ClickHouse/pull/26900)（[alesapin](https://github.com/alesapin)）。
* 修复在 `library` 字典源中通过 `library-bridge` 加载字典键的方式。[#26834](https://github.com/ClickHouse/ClickHouse/pull/26834) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 在应用某些组合器时，聚合函数的参数可能会丢失，从而导致类似 `Conversion from AggregateFunction(topKArray, Array(String)) to AggregateFunction(topKArray(10), Array(String)) is not supported` 的异常。该问题已修复。修复了 [#26196](https://github.com/ClickHouse/ClickHouse/issues/26196) 和 [#26433](https://github.com/ClickHouse/ClickHouse/issues/26433)。[#26814](https://github.com/ClickHouse/ClickHouse/pull/26814)（[tavplubix](https://github.com/tavplubix)）。
* 在 `system.part_log` 中为 `REMOVE_PART` 添加 `event_time_microseconds` 值。在之前的版本中，该值未设置。 [#26720](https://github.com/ClickHouse/ClickHouse/pull/26720) ([Azat Khuzhin](https://github.com/azat)).
* 在关闭 `ReplicatedMergeTree` 表时不要删除数据，以避免造成数据与元数据不一致。[#26716](https://github.com/ClickHouse/ClickHouse/pull/26716) ([nvartolomei](https://github.com/nvartolomei)).
* 有时 `SET ROLE` 的行为可能不正确，此 PR 进行了修复。[#26707](https://github.com/ClickHouse/ClickHouse/pull/26707) ([Vitaly Baranov](https://github.com/vitlibar)).
* 对并行格式的一些修复（[https://github.com/ClickHouse/ClickHouse/issues/26694](https://github.com/ClickHouse/ClickHouse/issues/26694)）。[#26703](https://github.com/ClickHouse/ClickHouse/pull/26703)（[Raúl Marín](https://github.com/Algunenano)）。
* 修复窗口函数中潜在的 `nullptr` 解引用问题。此修复解决了 [#25276](https://github.com/ClickHouse/ClickHouse/issues/25276)。[#26668](https://github.com/ClickHouse/ClickHouse/pull/26668)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* 修复了当从 3 年前版本的 clickhouse-client 升级时,历史文件为空导致的转换问题。[#26589](https://github.com/ClickHouse/ClickHouse/pull/26589) ([Azat Khuzhin](https://github.com/azat))。
* 修复 groupBitmapAnd/Or/Xor 函数名称显示不正确的问题(在某些情况下可能出现)。修复详见 [#26557](https://github.com/ClickHouse/ClickHouse/pull/26557) ([Amos Bird](https://github.com/amosbird))。
* 更新 clickhouse-server Docker entrypoint 中 `chown` 命令的检查。此修复解决了在 Kubernetes 上集群 Pod 重启失败（或超时）的问题。[#26545](https://github.com/ClickHouse/ClickHouse/pull/26545) ([Ky Li](https://github.com/Kylinrix))。
* 修复在未启动 `RabbitMQ` 的情况下关闭 `RabbitMQ` 时发生的崩溃。修复了 [#26504](https://github.com/ClickHouse/ClickHouse/issues/26504)。[#26529](https://github.com/ClickHouse/ClickHouse/pull/26529)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在 `CREATE DICTIONARY` 查询中，当字典名或数据库名被加引号时出现的问题。关闭 [#26491](https://github.com/ClickHouse/ClickHouse/issues/26491)。[#26508](https://github.com/ClickHouse/ClickHouse/pull/26508)（[Maksim Kita](https://github.com/kitaisreal)）。
* 在重写列别名后修复列名解析错误。修复了 [#26432](https://github.com/ClickHouse/ClickHouse/issues/26432)。[#26475](https://github.com/ClickHouse/ClickHouse/pull/26475)（[Amos Bird](https://github.com/amosbird)）。
* 修复了模糊测试中的 msan 崩溃问题。修复 [#22517](https://github.com/ClickHouse/ClickHouse/issues/22517)。[#26428](https://github.com/ClickHouse/ClickHouse/pull/26428) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复在 `partial_merge_join` 关闭时出现的无限未关联块流问题 [#26325](https://github.com/ClickHouse/ClickHouse/issues/26325)。[#26374](https://github.com/ClickHouse/ClickHouse/pull/26374)（[Vladimir C](https://github.com/vdimir)）。
* 修复以已被删除的用户身份登录时可能发生的崩溃。此 PR 修复了 [#26073](https://github.com/ClickHouse/ClickHouse/issues/26073)。[#26363](https://github.com/ClickHouse/ClickHouse/pull/26363)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复 `optimize_distributed_group_by_sharding_key` 在多列场景下的问题（当 `optimize_skip_unused_shards=1` / `allow_nondeterministic_optimize_skip_unused_shards=1` 且分片键表达式包含多列时会导致结果不正确）。 [#26353](https://github.com/ClickHouse/ClickHouse/pull/26353) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在恢复丢失副本时出现的一个罕见错误，该错误可能导致副本数据不一致。 [#26321](https://github.com/ClickHouse/ClickHouse/pull/26321) ([tavplubix](https://github.com/tavplubix)).
* 修复 zstd 解压缩在内部缓冲区末尾存在转义序列时的处理问题（针对与表数据无关、采用 zstd 帧格式的导入/导出）。修复了 [#26013](https://github.com/ClickHouse/ClickHouse/issues/26013)。[#26314](https://github.com/ClickHouse/ClickHouse/pull/26314)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复带有 `totals` 的 `JOIN` 中的逻辑错误，关闭 [#26017](https://github.com/ClickHouse/ClickHouse/issues/26017)。[#26250](https://github.com/ClickHouse/ClickHouse/pull/26250)（[Vladimir C](https://github.com/vdimir)）。
* 移除 `system.stack_trace` 表中 `thread_name` 列中多余的换行符。修复了 [#24124](https://github.com/ClickHouse/ClickHouse/issues/24124)。[#26210](https://github.com/ClickHouse/ClickHouse/pull/26210)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复使用多个 `untuple` 表达式时可能导致的崩溃问题。[#26179](https://github.com/ClickHouse/ClickHouse/pull/26179) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 当 Enum 没有零值时，在对 Nullable Enum 调用 `toString` 时不要抛出异常，关闭 [#25806](https://github.com/ClickHouse/ClickHouse/issues/25806)。[#26123](https://github.com/ClickHouse/ClickHouse/pull/26123)（[Vladimir C](https://github.com/vdimir)）。
* 修复了 ClickHouse 在查询执行期间抛出异常时，通过 MySQL 协议发送的数据包中错误的 `sequence_id`。该问题可能导致 MySQL 客户端重置与 ClickHouse 服务器的连接。解决了 [#21184](https://github.com/ClickHouse/ClickHouse/issues/21184)。[#26051](https://github.com/ClickHouse/ClickHouse/pull/26051)（[tavplubix](https://github.com/tavplubix)）。
* 修复了 `cutToFirstSignificantSubdomainCustom()` / `cutToFirstSignificantSubdomainCustomWithWWW()` / `firstSignificantSubdomainCustom()` 在常量场景下返回类型不正确、从而导致 `optimize_skip_unused_shards` 不生效的问题：[#26041](https://github.com/ClickHouse/ClickHouse/pull/26041) ([Azat Khuzhin](https://github.com/azat))。
* 修复在将普通投影与 `prewhere` 一同使用时可能出现的表头不匹配问题。修复了 [#26020](https://github.com/ClickHouse/ClickHouse/issues/26020)。[#26038](https://github.com/ClickHouse/ClickHouse/pull/26038)（[Amos Bird](https://github.com/amosbird)）。
* 修复了 `remote()` 在未对列应用函数时从列获取 `sharding_key` 的问题（此前执行 `select * from remote('127.1', system.one, dummy)` 会导致 `Unknown column: dummy, there are only columns .` 错误）。[#25824](https://github.com/ClickHouse/ClickHouse/pull/25824) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在从 `MaterializeMySQL` 进行查询时出现的 `Not found column ...` 和 `Missing column ...` 错误。修复了 [#23708](https://github.com/ClickHouse/ClickHouse/issues/23708)、[#24830](https://github.com/ClickHouse/ClickHouse/issues/24830)、[#25794](https://github.com/ClickHouse/ClickHouse/issues/25794)。[#25822](https://github.com/ClickHouse/ClickHouse/pull/25822)（[tavplubix](https://github.com/tavplubix)）。
* 修复在非 UInt64 类型上使用 `optimize_skip_unused_shards_rewrite_in` 时的问题（可能会最终选择错误的分片，或抛出 `Cannot infer type of an empty tuple` 或 `Function tuple requires at least one argument` 错误）。 [#25798](https://github.com/ClickHouse/ClickHouse/pull/25798) ([Azat Khuzhin](https://github.com/azat)).

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-3}

- 现在我们在随机时区中运行有状态和无状态测试。修复 [#12439](https://github.com/ClickHouse/ClickHouse/issues/12439)。在 Protobuf 格式中将 String 读取为 DateTime 以及将 DateTime 写入为 String 现在会遵循时区。在 Arrow 和 Parquet 格式中将 UInt16 读取为 DateTime 时,现在会将其视为 Date,然后根据 DateTime 的时区转换为 DateTime,因为 Date 在 Arrow 和 Parquet 中序列化为 UInt16。GraphiteMergeTree 现在在对时间进行舍入时会遵循时区。修复 [#5098](https://github.com/ClickHouse/ClickHouse/issues/5098)。作者:@alexey-milovidov。[#15408](https://github.com/ClickHouse/ClickHouse/pull/15408) ([alesapin](https://github.com/alesapin))。
- `clickhouse-test` 支持使用 [Jinja2](https://jinja.palletsprojects.com/en/3.0.x/templates/#synopsis) 模板的 SQL 测试。[#26579](https://github.com/ClickHouse/ClickHouse/pull/26579) ([Vladimir C](https://github.com/vdimir))。
- 添加对使用 `clang-13` 构建的支持。这解决了 [#27705](https://github.com/ClickHouse/ClickHouse/issues/27705)。[#27714](https://github.com/ClickHouse/ClickHouse/pull/27714) ([alexey-milovidov](https://github.com/alexey-milovidov))。[#27777](https://github.com/ClickHouse/ClickHouse/pull/27777) ([Sergei Semin](https://github.com/syominsergey))
- 添加 CMake 选项以选择是否使用特定 CPU 指令集进行构建。这是为了 [#17469](https://github.com/ClickHouse/ClickHouse/issues/17469) 和 [#27509](https://github.com/ClickHouse/ClickHouse/issues/27509)。[#27508](https://github.com/ClickHouse/ClickHouse/pull/27508) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 修复使用动态库时辅助程序的链接问题。[#26958](https://github.com/ClickHouse/ClickHouse/pull/26958) ([Raúl Marín](https://github.com/Algunenano))。
- 将 RocksDB 更新到 `2021-07-16` 主分支。[#26411](https://github.com/ClickHouse/ClickHouse/pull/26411) ([alexey-milovidov](https://github.com/alexey-milovidov))。

### ClickHouse 版本 v21.8,2021-08-12 {#clickhouse-release-v218-2021-08-12}

#### 升级说明 {#upgrade-notes}

- 新版本对系统日志表(`system.query_log`、`system.query_thread_log`、`system.processes`、`system.opentelemetry_span_log`)使用 `Map` 数据类型。这些表将使用新的数据类型自动创建。创建了虚拟列以支持旧查询。解决了 [#18698](https://github.com/ClickHouse/ClickHouse/issues/18698)。[#23934](https://github.com/ClickHouse/ClickHouse/pull/23934),[#25773](https://github.com/ClickHouse/ClickHouse/pull/25773) ([hexiaoting](https://github.com/hexiaoting),[sundy-li](https://github.com/sundy-li),[Maksim Kita](https://github.com/kitaisreal))。如果您想从版本 21.8 _降级_ 到旧版本,您需要手动清理包含日志的系统表。请查看 `/var/lib/clickhouse/data/system/*_log`。

#### 新功能 {#new-features}


- 添加对部分 SQL/JSON 标准的支持。[#24148](https://github.com/ClickHouse/ClickHouse/pull/24148) ([l1tsolaiki](https://github.com/l1tsolaiki), [Kseniia Sumarokova](https://github.com/kssenii))。
- 收集常见系统指标(在 `system.asynchronous_metrics` 和 `system.asynchronous_metric_log` 中),包括 CPU 使用率、磁盘使用率、内存使用率、IO、网络、文件、负载平均值、CPU 频率、温度传感器、EDAC 计数器、系统运行时间;还添加了关于调度抖动和收集指标所花费时间的指标。它的工作方式类似于 ClickHouse 中的 `atop`,即使没有安装其他工具也能访问监控数据。关闭 [#9430](https://github.com/ClickHouse/ClickHouse/issues/9430)。[#24416](https://github.com/ClickHouse/ClickHouse/pull/24416) ([alexey-milovidov](https://github.com/alexey-milovidov), [Yegor Levankov](https://github.com/elevankoff))。
- 添加 MaterializedPostgreSQL 表引擎和数据库引擎。该数据库引擎允许复制整个数据库或数据库表的任意子集。[#20470](https://github.com/ClickHouse/ClickHouse/pull/20470) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 添加新函数 `leftPad()`、`rightPad()`、`leftPadUTF8()`、`rightPadUTF8()`。[#26075](https://github.com/ClickHouse/ClickHouse/pull/26075) ([Vitaly Baranov](https://github.com/vitlibar))。
- 为 `ADD INDEX` 命令添加 `FIRST` 关键字,以便能够在索引列表的开头添加索引。[#25904](https://github.com/ClickHouse/ClickHouse/pull/25904) ([xjewer](https://github.com/xjewer))。
- 引入 `system.data_skipping_indices` 表,包含有关现有数据跳过索引的信息。关闭 [#7659](https://github.com/ClickHouse/ClickHouse/issues/7659)。[#25693](https://github.com/ClickHouse/ClickHouse/pull/25693) ([Dmitry Novik](https://github.com/novikd))。
- 添加 `bin`/`unbin` 函数。[#25609](https://github.com/ClickHouse/ClickHouse/pull/25609) ([zhaoyu](https://github.com/zxc111))。
- 在 `mapAdd` 和 `mapSubtract` 函数中支持 `Map` 以及 `UInt128`、`Int128`、`UInt256`、`Int256` 类型。[#25596](https://github.com/ClickHouse/ClickHouse/pull/25596) ([Ildus Kurbangaliev](https://github.com/ildus))。
- 支持 `DISTINCT ON (columns)` 表达式,关闭 [#25404](https://github.com/ClickHouse/ClickHouse/issues/25404)。[#25589](https://github.com/ClickHouse/ClickHouse/pull/25589) ([Zijie Lu](https://github.com/TszKitLo40))。
- 添加将自定义设置重置为默认值并从表的元数据中删除的功能。这允许在不知道系统/配置默认值的情况下回滚更改。关闭 [#14449](https://github.com/ClickHouse/ClickHouse/issues/14449)。[#17769](https://github.com/ClickHouse/ClickHouse/pull/17769) ([xjewer](https://github.com/xjewer))。
- 如果提交 `EXPLAIN PIPELINE graph = 1` 查询,则在 Web UI 中将管道渲染为图形。[#26067](https://github.com/ClickHouse/ClickHouse/pull/26067) ([alexey-milovidov](https://github.com/alexey-milovidov))。

#### 性能改进 {#performance-improvements}

- 编译聚合函数。使用选项 `compile_aggregate_expressions` 来启用它。[#24789](https://github.com/ClickHouse/ClickHouse/pull/24789) ([Maksim Kita](https://github.com/kitaisreal))。
- 改进需要从具有多列的表中读取数据的短查询的延迟。[#26371](https://github.com/ClickHouse/ClickHouse/pull/26371) ([Anton Popov](https://github.com/CurtizJ))。

#### 改进 {#improvements}


* 对系统日志表（`system.query_log`、`system.query_thread_log`、`system.processes`、`system.opentelemetry_span_log`）使用 `Map` 数据类型。这些表将使用新的数据类型自动创建。会创建虚拟列以兼容旧查询。修复了 [#18698](https://github.com/ClickHouse/ClickHouse/issues/18698)。[#23934](https://github.com/ClickHouse/ClickHouse/pull/23934)、[#25773](https://github.com/ClickHouse/ClickHouse/pull/25773)（[hexiaoting](https://github.com/hexiaoting)、[sundy-li](https://github.com/sundy-li)、[Maksim Kita](https://github.com/kitaisreal)）。
* 对于仅包含单个属性的复杂键字典，在使用 `dictGet`、`dictHas` 函数时，允许不再将键表达式包裹在 tuple 中。 [#26130](https://github.com/ClickHouse/ClickHouse/pull/26130) ([Maksim Kita](https://github.com/kitaisreal)).
* 从 `AggregateFunction` 的状态中实现 `bin`/`hex` 函数。 [#26094](https://github.com/ClickHouse/ClickHouse/pull/26094) ([zhaoyu](https://github.com/zxc111))。
* 为 `empty` 和 `notEmpty` 函数添加对 `UUID` 类型参数的支持。若 `UUID` 全为零（nil UUID），则视为空。关闭 [#3446](https://github.com/ClickHouse/ClickHouse/issues/3446)。 [#25974](https://github.com/ClickHouse/ClickHouse/pull/25974) ([zhaoyu](https://github.com/zxc111))。
* 在 MySQL 协议中添加对 `SET SQL_SELECT_LIMIT` 的支持。修复 [#17115](https://github.com/ClickHouse/ClickHouse/issues/17115)。[#25972](https://github.com/ClickHouse/ClickHouse/pull/25972)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 为网络交互增加更多监控：新增用于统计接收/发送字节数的计数器；新增用于监控接收/发送次数的指标。补充缺失的文档。关闭 [#5897](https://github.com/ClickHouse/ClickHouse/issues/5897)。[#25962](https://github.com/ClickHouse/ClickHouse/pull/25962) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 添加设置 `optimize_move_to_prewhere_if_final`。如果查询包含 `FINAL`，则仅在 `optimize_move_to_prewhere` 和 `optimize_move_to_prewhere_if_final` 都启用的情况下才会启用 `move_to_prewhere` 优化。修复了 [#8684](https://github.com/ClickHouse/ClickHouse/issues/8684)。[#25940](https://github.com/ClickHouse/ClickHouse/pull/25940)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 允许在 JOIN 的表上使用复杂的带引号标识符。修复 [#17861](https://github.com/ClickHouse/ClickHouse/issues/17861)。[#25924](https://github.com/ClickHouse/ClickHouse/pull/25924)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 `Nested` 数据类型中的 Unicode 组件（例如中文、西里尔文）添加支持。关闭 [#25594](https://github.com/ClickHouse/ClickHouse/issues/25594)。[#25923](https://github.com/ClickHouse/ClickHouse/pull/25923)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 允许 `quantiles*` 函数与 `aggregate_functions_null_for_empty` 一起配合使用。关闭 [#25892](https://github.com/ClickHouse/ClickHouse/issues/25892)。[#25919](https://github.com/ClickHouse/ClickHouse/pull/25919)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 允许参数化聚合函数的参数为任意常量表达式（例如 `1 + 2`），而不仅仅是字面量。还允许在参数化聚合函数中使用查询参数（如在 `{param:UInt8}` 这样的参数化查询中）。修复了 [#11607](https://github.com/ClickHouse/ClickHouse/issues/11607)。[#25910](https://github.com/ClickHouse/ClickHouse/pull/25910)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在尝试解析无效的 `Date` 时正确抛出异常。修复 [#6481](https://github.com/ClickHouse/ClickHouse/issues/6481)。[#25909](https://github.com/ClickHouse/ClickHouse/pull/25909)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在配置中支持多个 include。可以从多个来源引入 users 配置和远程服务器配置。只需放置带有 `from_zk`、`from_env` 或 `incl` 属性的 `<include />` 元素，它会被替换为相应的配置内容。[#24404](https://github.com/ClickHouse/ClickHouse/pull/24404)（[nvartolomei](https://github.com/nvartolomei)）。
* 支持在包含名为 `"null"` 的列（必须使用反引号或双引号引用）以及 `ON CLUSTER` 的查询中使用。修复了 [#24035](https://github.com/ClickHouse/ClickHouse/issues/24035)。[#25907](https://github.com/ClickHouse/ClickHouse/pull/25907)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 `JSONExtract` 增加对 `LowCardinality`、`Decimal` 和 `UUID` 的支持。修复 [#24606](https://github.com/ClickHouse/ClickHouse/issues/24606)。[#25900](https://github.com/ClickHouse/ClickHouse/pull/25900)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 将历史记录文件从 `readline` 格式转换为 `replxx` 格式。[#25888](https://github.com/ClickHouse/ClickHouse/pull/25888) ([Azat Khuzhin](https://github.com/azat))。
* 修复了一个问题，该问题可能在执行 `DROP PART` 或后台删除空 part 后导致 part 之间相互交叉。[#25884](https://github.com/ClickHouse/ClickHouse/pull/25884) ([alesapin](https://github.com/alesapin))。
* 改进了对 `ReplicatedMergeTree` 表中丢失 part 的处理。修复了 `ReplicationQueue` 中一些罕见的不一致问题。修复了 [#10368](https://github.com/ClickHouse/ClickHouse/issues/10368)。[#25820](https://github.com/ClickHouse/ClickHouse/pull/25820)（[alesapin](https://github.com/alesapin)）。
* 允许在工作目录不可读的情况下启动 clickhouse-client。 [#25817](https://github.com/ClickHouse/ClickHouse/pull/25817) ([ianton-ru](https://github.com/ianton-ru)).
* 修复 `Merge` 存储引擎中出现的 “No available columns” 错误。 [#25801](https://github.com/ClickHouse/ClickHouse/pull/25801) ([Azat Khuzhin](https://github.com/azat)).
* MySQL 引擎现在支持在 MySQL 和 ClickHouse 之间同步列注释。 [#25795](https://github.com/ClickHouse/ClickHouse/pull/25795) ([Storozhuk Kostiantyn](https://github.com/sand6255)).
* 修复在空结果集上 `GROUP BY` 常量的不一致行为。修复 [#6842](https://github.com/ClickHouse/ClickHouse/issues/6842)。[#25786](https://github.com/ClickHouse/ClickHouse/pull/25786)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在 `ReplicatedMergeTree` 上执行 `DROP PARTITION` 和 `TRUNCATE` 时，取消该分区中已在运行的合并操作。修复了 [#17151](https://github.com/ClickHouse/ClickHouse/issues/17151)。[#25684](https://github.com/ClickHouse/ClickHouse/pull/25684)（[tavplubix](https://github.com/tavplubix)）。
* 为 MaterializeMySQL 增加对 `ENUM` 数据类型的支持。[#25676](https://github.com/ClickHouse/ClickHouse/pull/25676)（[Storozhuk Kostiantyn](https://github.com/sand6255)）。
* 在 `JOIN` 中支持物化列和别名列，关闭 [#13274](https://github.com/ClickHouse/ClickHouse/issues/13274)。[#25634](https://github.com/ClickHouse/ClickHouse/pull/25634)（[Vladimir C](https://github.com/vdimir)）。
* 修复 `ALTER TABLE ... DETACH` 与后台合并之间可能出现的逻辑竞争条件。 [#25605](https://github.com/ClickHouse/ClickHouse/pull/25605) ([Azat Khuzhin](https://github.com/azat)).
* 使 `NetworkReceiveElapsedMicroseconds` 指标能够正确包含等待客户端向 `INSERT` 提交数据所花费的时间。关闭 [#9958](https://github.com/ClickHouse/ClickHouse/issues/9958)。[#25602](https://github.com/ClickHouse/ClickHouse/pull/25602)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 S3 和 HDFS 增加对 `TRUNCATE TABLE` 的支持。修复 [#25530](https://github.com/ClickHouse/ClickHouse/issues/25530)。 [#25550](https://github.com/ClickHouse/ClickHouse/pull/25550) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 支持通过动态重新加载配置来更改用于执行后台作业（合并、变更、获取）的线程池线程数。[#25548](https://github.com/ClickHouse/ClickHouse/pull/25548)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 允许使用 `JSONExtract` 将非字符串元素提取为字符串。相关问题见 [#25414](https://github.com/ClickHouse/ClickHouse/issues/25414)。[#25452](https://github.com/ClickHouse/ClickHouse/pull/25452) ([Amos Bird](https://github.com/amosbird))。
* 在 `StorageMerge` 的 `Database` 参数中支持使用正则表达式。关闭 [#776](https://github.com/ClickHouse/ClickHouse/issues/776)。[#25064](https://github.com/ClickHouse/ClickHouse/pull/25064) ([flynn](https://github.com/ucasfl))。
* Web UI：如果某个值看起来像 URL，则自动生成链接。[#25965](https://github.com/ClickHouse/ClickHouse/pull/25965) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 使 `sudo service clickhouse-server start` 能够在使用 `systemd` 的系统（如 Centos 8）上正常工作。关闭 [#14298](https://github.com/ClickHouse/ClickHouse/issues/14298)。关闭 [#17799](https://github.com/ClickHouse/ClickHouse/issues/17799)。[#25921](https://github.com/ClickHouse/ClickHouse/pull/25921) ([alexey-milovidov](https://github.com/alexey-milovidov))。

#### 错误修复 {#bug-fixes-1}


* 修复某些情况下不正确的 `SET ROLE`。 [#26707](https://github.com/ClickHouse/ClickHouse/pull/26707) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复窗口函数中可能出现的 `nullptr` 解引用问题。修复 [#25276](https://github.com/ClickHouse/ClickHouse/issues/25276)。[#26668](https://github.com/ClickHouse/ClickHouse/pull/26668)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* 修正 `groupBitmapAnd/Or/Xor` 的错误函数名。修复 [#26557](https://github.com/ClickHouse/ClickHouse/pull/26557)（[Amos Bird](https://github.com/amosbird)）。
* 修复在 RabbitMQ 未启动时关闭 RabbitMQ 会崩溃的问题。修复 [#26504](https://github.com/ClickHouse/ClickHouse/issues/26504)。[#26529](https://github.com/ClickHouse/ClickHouse/pull/26529)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在字典名称或数据库名称被加上引号时，`CREATE DICTIONARY` 查询存在的问题。修复于 [#26491](https://github.com/ClickHouse/ClickHouse/issues/26491)。[#26508](https://github.com/ClickHouse/ClickHouse/pull/26508)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复在重写列别名后导致的名称解析问题。修复 [#26432](https://github.com/ClickHouse/ClickHouse/issues/26432)。[#26475](https://github.com/ClickHouse/ClickHouse/pull/26475)（[Amos Bird](https://github.com/amosbird)）。
* 修复 `partial_merge_join` 关闭时出现的无限未连接数据块流问题 [#26325](https://github.com/ClickHouse/ClickHouse/issues/26325)。[#26374](https://github.com/ClickHouse/ClickHouse/pull/26374)（[Vladimir C](https://github.com/vdimir)）。
* 修复以已被删除的用户登录时可能发生的崩溃问题。修复 [#26073](https://github.com/ClickHouse/ClickHouse/issues/26073)。[#26363](https://github.com/ClickHouse/ClickHouse/pull/26363)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复在多列表达式场景下的 `optimize_distributed_group_by_sharding_key`（在 `optimize_skip_unused_shards=1`/`allow_nondeterministic_optimize_skip_unused_shards=1` 且分片键表达式包含多列时会导致结果不正确）。[#26353](https://github.com/ClickHouse/ClickHouse/pull/26353)（[Azat Khuzhin](https://github.com/azat)）。
* 从 `Date` 到 `DateTime`（或 `DateTime64`）的 `CAST` 没有使用 `DateTime` 类型的时区。这也会影响 `Date` 和 `DateTime` 之间的比较。为 `Date` 和 `DateTime` 推断公共类型时同样没有使用相应的时区，从而影响了函数 `if` 的结果以及数组构造。修复了 [#24128](https://github.com/ClickHouse/ClickHouse/issues/24128)。[#24129](https://github.com/ClickHouse/ClickHouse/pull/24129)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复了在丢失副本恢复过程中出现的一个罕见错误，该错误可能导致副本状态不一致。 [#26321](https://github.com/ClickHouse/ClickHouse/pull/26321) ([tavplubix](https://github.com/tavplubix)).
* 修复在内部缓冲区末尾存在转义序列时的 zstd 解压问题。修复 [#26013](https://github.com/ClickHouse/ClickHouse/issues/26013)。[#26314](https://github.com/ClickHouse/ClickHouse/pull/26314)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复带有 `totals` 的 `JOIN` 中的逻辑错误，关闭 [#26017](https://github.com/ClickHouse/ClickHouse/issues/26017)。[#26250](https://github.com/ClickHouse/ClickHouse/pull/26250)（[Vladimir C](https://github.com/vdimir)）。
* 移除 `system.stack_trace` 表中 `thread_name` 列的多余换行。修复 [#24124](https://github.com/ClickHouse/ClickHouse/issues/24124)。[#26210](https://github.com/ClickHouse/ClickHouse/pull/26210) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复包含 `LowCarinality` 列的 `joinGet`，关闭 [#25993](https://github.com/ClickHouse/ClickHouse/issues/25993)。[#26118](https://github.com/ClickHouse/ClickHouse/pull/26118)（[Vladimir C](https://github.com/vdimir)）。
* 修复在关闭 `validate_polygons` 设置时，`pointInPolygon` 可能发生的崩溃问题。[#26113](https://github.com/ClickHouse/ClickHouse/pull/26113) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复在遍历不存在的远程目录时抛出异常的问题。 [#26087](https://github.com/ClickHouse/ClickHouse/pull/26087) ([ianton-ru](https://github.com/ianton-ru)).
* 修复了由于 ZooKeeper 客户端中的 `abort` 导致的罕见服务器崩溃问题。修复了 [#25813](https://github.com/ClickHouse/ClickHouse/issues/25813)。[#26079](https://github.com/ClickHouse/ClickHouse/pull/26079)（[alesapin](https://github.com/alesapin)）。
* 在某些情况下修复右侧子查询 `JOIN` 的线程数估算错误。关闭 [#24075](https://github.com/ClickHouse/ClickHouse/issues/24075)。[#26052](https://github.com/ClickHouse/ClickHouse/pull/26052)（[Vladimir C](https://github.com/vdimir)）。
* 修复了 ClickHouse 在查询执行期间出现异常时，通过 MySQL 协议发送的数据包中错误的 `sequence_id`。该错误可能导致 MySQL 客户端重置与 ClickHouse 服务器的连接。修复了 [#21184](https://github.com/ClickHouse/ClickHouse/issues/21184)。[#26051](https://github.com/ClickHouse/ClickHouse/pull/26051)（[tavplubix](https://github.com/tavplubix)）。
* 修复在使用普通投影和 `PREWHERE` 时可能出现的表头不匹配问题。修复 [#26020](https://github.com/ClickHouse/ClickHouse/issues/26020)。[#26038](https://github.com/ClickHouse/ClickHouse/pull/26038)（[Amos Bird](https://github.com/amosbird)）。
* 修复具有整数键的 `Map` 类型到 `JSON` 的格式化方式。 [#25982](https://github.com/ClickHouse/ClickHouse/pull/25982) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在查询分析器栈展开过程中可能发生的死锁问题。修复 [#25968](https://github.com/ClickHouse/ClickHouse/issues/25968)。[#25970](https://github.com/ClickHouse/ClickHouse/pull/25970)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复在使用错误参数调用 `dictGet()` 时发生的崩溃。[#25913](https://github.com/ClickHouse/ClickHouse/pull/25913)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复了 PostgreSQL 引擎的 `scram-sha-256` 认证。关联问题 [#24516](https://github.com/ClickHouse/ClickHouse/issues/24516)。[#25906](https://github.com/ClickHouse/ClickHouse/pull/25906)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在后台线程池已满时后台任务出现的极长退避时间问题。修复了 [#25836](https://github.com/ClickHouse/ClickHouse/issues/25836)。[#25893](https://github.com/ClickHouse/ClickHouse/pull/25893)（[alesapin](https://github.com/alesapin)）。
* 修复在非默认页大小情况下的 ARM 异常处理。修复了 [#25512](https://github.com/ClickHouse/ClickHouse/issues/25512)、[#25044](https://github.com/ClickHouse/ClickHouse/issues/25044)、[#24901](https://github.com/ClickHouse/ClickHouse/issues/24901)、[#23183](https://github.com/ClickHouse/ClickHouse/issues/23183)、[#20221](https://github.com/ClickHouse/ClickHouse/issues/20221)、[#19703](https://github.com/ClickHouse/ClickHouse/issues/19703)、[#19028](https://github.com/ClickHouse/ClickHouse/issues/19028)、[#18391](https://github.com/ClickHouse/ClickHouse/issues/18391)、[#18121](https://github.com/ClickHouse/ClickHouse/issues/18121)、[#17994](https://github.com/ClickHouse/ClickHouse/issues/17994)、[#12483](https://github.com/ClickHouse/ClickHouse/issues/12483)。[#25854](https://github.com/ClickHouse/ClickHouse/pull/25854)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复 `remote()` 在从未使用函数处理的列中获取 `sharding_key` 时的问题（此前 `select * from remote('127.1', system.one, dummy)` 会导致 `Unknown column: dummy, there are only columns .` 错误）。[#25824](https://github.com/ClickHouse/ClickHouse/pull/25824) ([Azat Khuzhin](https://github.com/azat)).
* 修复了从 `MaterializeMySQL` 中查询时出现的 `Not found column ...` 和 `Missing column ...` 错误。修复了 [#23708](https://github.com/ClickHouse/ClickHouse/issues/23708)、[#24830](https://github.com/ClickHouse/ClickHouse/issues/24830)、[#25794](https://github.com/ClickHouse/ClickHouse/issues/25794)。[#25822](https://github.com/ClickHouse/ClickHouse/pull/25822)（[tavplubix](https://github.com/tavplubix)）。
* 修复了在处理非 UInt64 类型时的 `optimize_skip_unused_shards_rewrite_in`（可能最终选择错误的分片，或抛出 `Cannot infer type of an empty tuple` 或 `Function tuple requires at least one argument`）。 [#25798](https://github.com/ClickHouse/ClickHouse/pull/25798) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在 `ReplicatedMergeTree` 表上执行 `DROP PART` 查询时出现的罕见错误，该错误可能导致报错信息 `Unexpected merged part intersecting drop range`。 [#25783](https://github.com/ClickHouse/ClickHouse/pull/25783) ([alesapin](https://github.com/alesapin)).
* 修复了在分区中首次执行后拒绝再次执行的、带有 `GROUP BY` 表达式的 `TTL` 的错误。[#25743](https://github.com/ClickHouse/ClickHouse/pull/25743) ([alesapin](https://github.com/alesapin)).
* 允许 `StorageMerge` 访问带有别名的表。关闭了 [#6051](https://github.com/ClickHouse/ClickHouse/issues/6051)。[#25694](https://github.com/ClickHouse/ClickHouse/pull/25694)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在某些情况下修复了字典 JOIN 性能较慢的问题，关闭 [#24209](https://github.com/ClickHouse/ClickHouse/issues/24209)。[#25618](https://github.com/ClickHouse/ClickHouse/pull/25618)（[Vladimir C](https://github.com/vdimir)）。
* 修复对参与 `TTL` 表达式的列执行 `ALTER MODIFY COLUMN` 时的行为。[#25554](https://github.com/ClickHouse/ClickHouse/pull/25554) ([Anton Popov](https://github.com/CurtizJ))。
* 修复在 `PREWHERE` 中使用非 UInt8 类型时的断言错误，关闭 [#19589](https://github.com/ClickHouse/ClickHouse/issues/19589)。[#25484](https://github.com/ClickHouse/ClickHouse/pull/25484)（[Vladimir C](https://github.com/vdimir)）。
* 修复了一些由 fuzz 测试触发的 msan 崩溃。修复了 [#22517](https://github.com/ClickHouse/ClickHouse/issues/22517)。[#26428](https://github.com/ClickHouse/ClickHouse/pull/26428)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 更新 `clickhouse-server` Docker entrypoint 中对 `chown` 命令的检查。这一更新修复了在 Kubernetes 上出现的 “cluster pod restart failed (or timeout)” 错误。[#26545](https://github.com/ClickHouse/ClickHouse/pull/26545) ([Ky Li](https://github.com/Kylinrix)).

### ClickHouse 版本 v21.7，2021-07-09 {#clickhouse-release-v217-2021-07-09}

#### 向后不兼容变更 {#backward-incompatible-change-4}

- 改进了显式定义大型集合的查询性能。新增兼容性设置 `legacy_column_name_of_tuple_literal`。在将集群从 21.7 以下版本滚动升级到更高版本时，建议将其设置为 `true`。否则，在升级期间，`IN` 子句中显式定义集合的分布式查询可能会失败。[#25371](https://github.com/ClickHouse/ClickHouse/pull/25371) ([Anton Popov](https://github.com/CurtizJ))。
- clickhouse-keeper（ZooKeeper 的实验性替代方案）最大缓冲区大小的前向/后向不兼容变更。最好现在（在投入生产环境之前）进行此变更，而不是以后。[#25421](https://github.com/ClickHouse/ClickHouse/pull/25421) ([alesapin](https://github.com/alesapin))。

#### 新功能 {#new-feature-4}


- 支持使用 YAML 格式配置作为 XML 的替代方案。此更改关闭了 [#3607](https://github.com/ClickHouse/ClickHouse/issues/3607)。[#21858](https://github.com/ClickHouse/ClickHouse/pull/21858) ([BoloniniD](https://github.com/BoloniniD))。
- 提供了一种在数据(可能)存在但 ZooKeeper 元数据丢失时恢复复制表的方法。解决了 [#13458](https://github.com/ClickHouse/ClickHouse/issues/13458)。[#13652](https://github.com/ClickHouse/ClickHouse/pull/13652) ([Mike Kot](https://github.com/myrrc))。
- 在 Arrow/Parquet/ORC 中支持结构体和映射,在 Arrow 输入/输出格式中支持字典。引入了新设置 `output_format_arrow_low_cardinality_as_dictionary`。[#24341](https://github.com/ClickHouse/ClickHouse/pull/24341) ([Kruglov Pavel](https://github.com/Avogar))。
- 在字典中添加了对 `Array` 类型的支持。[#25119](https://github.com/ClickHouse/ClickHouse/pull/25119) ([Maksim Kita](https://github.com/kitaisreal))。
- 添加了函数 `bitPositionsToArray`。关闭了 [#23792](https://github.com/ClickHouse/ClickHouse/issues/23792)。作者 [Kevin Wan] (@MaxWk)。[#25394](https://github.com/ClickHouse/ClickHouse/pull/25394) ([Maksim Kita](https://github.com/kitaisreal))。
- 添加了函数 `dateName` 以返回诸如 'Friday' 或 'April' 之类的名称。作者 [Daniil Kondratyev] (@dankondr)。[#25372](https://github.com/ClickHouse/ClickHouse/pull/25372) ([Maksim Kita](https://github.com/kitaisreal))。
- 添加了 `toJSONString` 函数以将列序列化为其 JSON 表示形式。[#25164](https://github.com/ClickHouse/ClickHouse/pull/25164) ([Amos Bird](https://github.com/amosbird))。
- 现在 `query_log` 有两个新列:`initial_query_start_time`、`initial_query_start_time_microsecond`,用于记录分布式查询的起始时间(如果有)。[#25022](https://github.com/ClickHouse/ClickHouse/pull/25022) ([Amos Bird](https://github.com/amosbird))。
- 添加了聚合函数 `segmentLengthSum`。[#24250](https://github.com/ClickHouse/ClickHouse/pull/24250) ([flynn](https://github.com/ucasfl))。
- 添加了新的布尔设置 `prefer_global_in_and_join`,将所有 IN/JOIN 默认设置为 GLOBAL IN/JOIN。[#23434](https://github.com/ClickHouse/ClickHouse/pull/23434) ([Amos Bird](https://github.com/amosbird))。
- 支持对 `Join` 表引擎执行 `ALTER DELETE` 查询。[#23260](https://github.com/ClickHouse/ClickHouse/pull/23260) ([foolchi](https://github.com/foolchi))。
- 添加了 `quantileBFloat16` 聚合函数以及相应的 `quantilesBFloat16` 和 `medianBFloat16`。这是一个非常简单且快速的分位数估算器,相对误差不超过 0.390625%。此更改关闭了 [#16641](https://github.com/ClickHouse/ClickHouse/issues/16641)。[#23204](https://github.com/ClickHouse/ClickHouse/pull/23204) ([Ivan Novitskiy](https://github.com/RedClusive))。
- 实现了 `sequenceNextNode()` 函数,对`流程分析`很有用。[#19766](https://github.com/ClickHouse/ClickHouse/pull/19766) ([achimbab](https://github.com/achimbab))。

#### 实验性功能 {#experimental-feature-4}

- 添加了对基于 HDFS 的虚拟文件系统的支持。[#11058](https://github.com/ClickHouse/ClickHouse/pull/11058) ([overshov](https://github.com/overshov)) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 现在 clickhouse-keeper(ZooKeeper 的实验性替代方案)支持类似 ZooKeeper 的 `digest` ACL。[#24448](https://github.com/ClickHouse/ClickHouse/pull/24448) ([alesapin](https://github.com/alesapin))。

#### 性能改进 {#performance-improvement-4}


- 新增优化功能,将某些函数转换为读取子列以减少读取的数据量。例如,语句 `col IS NULL` 会被转换为读取子列 `col.null`。可以通过设置 `optimize_functions_to_subcolumns` 来启用此优化,该选项目前默认关闭。[#24406](https://github.com/ClickHouse/ClickHouse/pull/24406) ([Anton Popov](https://github.com/CurtizJ))。
- 将更多列重写为可能的别名表达式。这可能会启用更好的优化,例如投影。[#24405](https://github.com/ClickHouse/ClickHouse/pull/24405) ([Amos Bird](https://github.com/amosbird))。
- 类型为 `bloom_filter` 的索引现在可以用于带有常量数组的 `hasAny` 函数表达式。此更改解决了:[#24291](https://github.com/ClickHouse/ClickHouse/issues/24291)。[#24900](https://github.com/ClickHouse/ClickHouse/pull/24900) ([Vasily Nemkov](https://github.com/Enmk))。
- 在 RabbitMQ 队列为空时,为重新调度读取尝试添加指数退避机制。(ClickHouse 支持从 RabbitMQ 导入数据)。解决了 [#24340](https://github.com/ClickHouse/ClickHouse/issues/24340)。[#24415](https://github.com/ClickHouse/ClickHouse/pull/24415) ([Kseniia Sumarokova](https://github.com/kssenii))。

#### 改进 {#improvement-4}


* 允许限制复制所使用的带宽。添加两个 Replicated*MergeTree 设置：`max_replicated_fetches_network_bandwidth` 和 `max_replicated_sends_network_bandwidth`，用于限制单个表的复制拉取/发送的最大速度。添加两个适用于整个服务器的设置（位于 `default` 用户配置中）：`max_replicated_fetches_network_bandwidth_for_server` 和 `max_replicated_sends_network_bandwidth_for_server`，用于限制所有表的复制最大速度。对这些设置的执行并非完全精确。默认关闭。修复 [#1821](https://github.com/ClickHouse/ClickHouse/issues/1821)。[#24573](https://github.com/ClickHouse/ClickHouse/pull/24573)（[alesapin](https://github.com/alesapin)）。
* ODBC 和 Library 桥接的资源约束与隔离。为桥接进程使用独立的 `clickhouse-bridge` 组和用户。设置 oom&#95;score&#95;adj 使桥接进程成为 OOM killer 的优先终止对象。将最大 RSS 限制设置为 1 GiB。关闭 [#23861](https://github.com/ClickHouse/ClickHouse/issues/23861)。[#25280](https://github.com/ClickHouse/ClickHouse/pull/25280) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 为主 `clickhouse` 可执行文件添加独立的 `clickhouse-keeper` 符号链接。现在可以在不依赖主 ClickHouse 服务器的情况下单独运行协调服务。[#24059](https://github.com/ClickHouse/ClickHouse/pull/24059) ([alesapin](https://github.com/alesapin))。
* 对发往 `VIEW` 的查询使用全局设置。修复了此前对 `VIEW` 的查询使用局部设置时的行为问题：如果在 `CREATE VIEW` 和 `SELECT` 中的设置不同，就会导致错误。现在，`VIEW` 不会使用这些被修改的设置，但你仍然可以在 `CREATE VIEW` 查询的 `SETTINGS` 部分传递额外设置。关闭 [#20551](https://github.com/ClickHouse/ClickHouse/issues/20551)。 [#24095](https://github.com/ClickHouse/ClickHouse/pull/24095) ([Vladimir](https://github.com/vdimir))。
* 在服务器启动时，具有错误分区 ID 的数据部分不会被删除，而是始终被分离。 [#25070](https://github.com/ClickHouse/ClickHouse/issues/25070)。 [#25166](https://github.com/ClickHouse/ClickHouse/pull/25166) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 将后台调度线程池大小增加到 128（`background_schedule_pool_size` 设置）。这可以避免在 ZooKeeper 连接较慢时复制队列出现卡死。[#25072](https://github.com/ClickHouse/ClickHouse/pull/25072) ([alesapin](https://github.com/alesapin)).
* 添加 MergeTree 设置 `max_parts_to_merge_at_once`，用于限制后台一次合并的分片数量。不影响 `OPTIMIZE FINAL` 查询。修复了 [#1820](https://github.com/ClickHouse/ClickHouse/issues/1820)。[#24496](https://github.com/ClickHouse/ClickHouse/pull/24496) ([alesapin](https://github.com/alesapin))。
* 允许在分区剪枝中使用 `NOT IN` 运算符。[#24894](https://github.com/ClickHouse/ClickHouse/pull/24894) ([Amos Bird](https://github.com/amosbird))。
* 将类似 `127.0.1.1` 的 IPv4 地址识别为本地地址。此改动存在争议,解决了 [#23504](https://github.com/ClickHouse/ClickHouse/issues/23504) 中的问题。Michael Filimonov 将对此功能进行测试。[#24316](https://github.com/ClickHouse/ClickHouse/pull/24316) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 通过 MaterializeMySQL 创建的 ClickHouse 数据库（实验性特性）现在包含了来自对应 MySQL 数据库的所有列注释。 [#25199](https://github.com/ClickHouse/ClickHouse/pull/25199) ([Storozhuk Kostiantyn](https://github.com/sand6255)).
* 为 MySQL 存储引擎添加设置（`connection_auto_close` / `connection_max_tries` / `connection_pool_size`）。[#24146](https://github.com/ClickHouse/ClickHouse/pull/24146)（[Azat Khuzhin](https://github.com/azat)）。
* 改进了 Distributed 引擎的启动时间。[#25663](https://github.com/ClickHouse/ClickHouse/pull/25663) ([Azat Khuzhin](https://github.com/azat))。
* 对 Distributed 表的改进：在 internal&#95;replication=true 时，从 dirname 中移除副本信息（允许在带有 cluster 的 Distributed 表上从任意数量的副本执行 INSERT，此前仅支持最多 15 个副本，更多副本在为异步块创建目录时会因 ENAMETOOLONG 而失败）。 [#25513](https://github.com/ClickHouse/ClickHouse/pull/25513) ([Azat Khuzhin](https://github.com/azat)).
* 为 `LowCardinality` 增加了对 `Interval` 类型的支持。该功能用于某些表达式的中间值。修复了 [#21730](https://github.com/ClickHouse/ClickHouse/issues/21730)。[#25410](https://github.com/ClickHouse/ClickHouse/pull/25410)（[Vladimir](https://github.com/vdimir)）。
* 为 `sequenceMatch` 和 `sequenceCount` 函数的时间条件添加 `==` 运算符。例如：sequenceMatch(&#39;(?1)(?t==1)(?2)&#39;)(time, data = 1, data = 2)。 [#25299](https://github.com/ClickHouse/ClickHouse/pull/25299) ([Christophe Kalenzaga](https://github.com/mga-chka)).
* 添加了设置 `http_max_fields`、`http_max_field_name_size`、`http_max_field_value_size`。[#25296](https://github.com/ClickHouse/ClickHouse/pull/25296)（[Ivan](https://github.com/abyss7)）。
* 为函数 `if` 的分支添加对 `Decimal` 和 `Int` 类型的支持。关闭了 [#20549](https://github.com/ClickHouse/ClickHouse/issues/20549)。关闭了 [#10142](https://github.com/ClickHouse/ClickHouse/issues/10142)。[#25283](https://github.com/ClickHouse/ClickHouse/pull/25283)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 更新 `clickhouse-client` 中的提示符，并在重新连接时显示一条消息。修复了 [#10577](https://github.com/ClickHouse/ClickHouse/issues/10577)。[#25281](https://github.com/ClickHouse/ClickHouse/pull/25281)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修正聚合函数 `topK` 中的内存跟踪。这修复了 [#25259](https://github.com/ClickHouse/ClickHouse/issues/25259)。[#25260](https://github.com/ClickHouse/ClickHouse/pull/25260)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了 `topLevelDomain` 函数对 IDN 主机(如 `example.рф`)的处理,此前该函数对此类主机返回空字符串。[#25103](https://github.com/ClickHouse/ClickHouse/pull/25103) ([Azat Khuzhin](https://github.com/azat))。
* 在运行时检测 Linux 内核版本（用于启用可正常工作的嵌套 epoll，这是 `async_socket_for_remote`/`use_hedged_requests` 所必需的，否则远程查询可能会卡住）。 [#25067](https://github.com/ClickHouse/ClickHouse/pull/25067) ([Azat Khuzhin](https://github.com/azat)).
* 对于分布式查询，当 `optimize_skip_unused_shards=1` 时，允许在条件为 `(sharding key) IN (单元素 tuple)` 的情况下跳过分片。（此前已支持多元素 tuple。单元素 tuple 之前不起作用，因为它会被解析为字面量）。[#24930](https://github.com/ClickHouse/ClickHouse/pull/24930) ([Amos Bird](https://github.com/amosbird))。
* 改进了 S3 错误的日志消息，在键和存储桶为空时不再出现双空格。 [#24897](https://github.com/ClickHouse/ClickHouse/pull/24897) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 某些查询需要多轮语义分析。在这种情况下，尝试复用为 `IN` 预先构建的集合。[#24874](https://github.com/ClickHouse/ClickHouse/pull/24874)（[Amos Bird](https://github.com/amosbird)）。
* 对 `insert_distributed_sync` 遵守 `max_distributed_connections` 限制（否则在大型集群上执行同步写入时，可能会耗尽 `max_thread_pool_size`）。 [#24754](https://github.com/ClickHouse/ClickHouse/pull/24754) ([Azat Khuzhin](https://github.com/azat)).
* 避免在标量子查询中隐藏诸如 `Limit for rows or bytes to read exceeded` 之类的错误。[#24545](https://github.com/ClickHouse/ClickHouse/pull/24545) ([nvartolomei](https://github.com/nvartolomei)).
* 使 String-to-Int 解析器更加严格，使 `toInt64('+')` 会抛出异常。 [#24475](https://github.com/ClickHouse/ClickHouse/pull/24475) ([Amos Bird](https://github.com/amosbird)).
* 如果通过 DDL 查询创建 `SSD_CACHE`，则它只能在 `user_files` 目录中创建。[#24466](https://github.com/ClickHouse/ClickHouse/pull/24466)（[Maksim Kita](https://github.com/kitaisreal)）。
* 为 PostgreSQL 插入查询增加了指定非默认 `schema` 的支持。关闭 [#24149](https://github.com/ClickHouse/ClickHouse/issues/24149)。[#24413](https://github.com/ClickHouse/ClickHouse/pull/24413)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复 IPv6 地址解析问题(例如修复 `select * from remote('[::1]', system.one)`)。[#24319](https://github.com/ClickHouse/ClickHouse/pull/24319) ([Azat Khuzhin](https://github.com/azat))。
* 在多行模式下修复 `FROM` 子句中带子查询时出现的行尾空格，并对查询输出进行了小幅调整，使其更便于阅读。[#24151](https://github.com/ClickHouse/ClickHouse/pull/24151) ([Azat Khuzhin](https://github.com/azat)).
* 对 Distributed 表进行了改进：在发生失败时（例如由于内存限制或数据损坏），支持将分布式批次拆分处理，可通过 `distributed_directory_monitor_split_batch_on_failure` 参数控制（默认关闭）。[#23864](https://github.com/ClickHouse/ClickHouse/pull/23864) ([Azat Khuzhin](https://github.com/azat)).
* 处理 `Join` 表引擎的列名冲突问题。关闭 [#20309](https://github.com/ClickHouse/ClickHouse/issues/20309)。[#23769](https://github.com/ClickHouse/ClickHouse/pull/23769) ([Vladimir](https://github.com/vdimir))。
* 当数据通过 stdin 传入时，在 `clickhouse-local` 的 `File` 表引擎以及 `clickhouse-client` 中的 INSERT 查询中显示进度。修复 [#18209](https://github.com/ClickHouse/ClickHouse/issues/18209)。[#23656](https://github.com/ClickHouse/ClickHouse/pull/23656) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 对 `clickhouse-copier` 进行了错误修复和改进。允许复制具有不同（但兼容）schema 的表。修复 [#9159](https://github.com/ClickHouse/ClickHouse/issues/9159)。添加了复制 ReplacingMergeTree 的测试。修复 [#22711](https://github.com/ClickHouse/ClickHouse/issues/22711)。在列和 Data Skipping 索引上支持 TTL。为创建内部 Distributed 表，会简单地移除 TTL（底层表仍然保留 TTL 和 skipping 索引）。修复 [#19384](https://github.com/ClickHouse/ClickHouse/issues/19384)。允许复制 MATERIALIZED 和 ALIAS 列。在某些情况下这可能会有帮助（例如该列位于 PRIMARY KEY 中）。现在可以通过在任务配置中将 `allow_to_copy_alias_and_materialized_columns` 属性设置为 true 来启用此行为。修复 [#9177](https://github.com/ClickHouse/ClickHouse/issues/9177)。修复 [#11007] ([https://github.com/ClickHouse/ClickHouse/issues/11007](https://github.com/ClickHouse/ClickHouse/issues/11007))。修复 [#9514](https://github.com/ClickHouse/ClickHouse/issues/9514)。在任务配置中添加了 `allow_to_drop_target_partitions` 属性，用于在移动辅助表之前删除原始表中的分区。修复 [#20957](https://github.com/ClickHouse/ClickHouse/issues/20957)。移除了 `OPTIMIZE DEDUPLICATE` 查询。此前需要这个 hack，是因为 `ALTER TABLE MOVE PARTITION` 会被重试多次，而普通 MergeTree 表没有去重功能。修复 [#17966](https://github.com/ClickHouse/ClickHouse/issues/17966)。将执行进度以 JSON 格式写入路径为 `task_path + /status` 的 ZooKeeper 节点。修复 [#20955](https://github.com/ClickHouse/ClickHouse/issues/20955)。支持无参数的 ReplicatedTables。修复 [#24834](https://github.com/ClickHouse/ClickHouse/issues/24834)。[#23518](https://github.com/ClickHouse/ClickHouse/pull/23518) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 在从 S3 进行读重试之间增加了带退避的休眠。 [#23461](https://github.com/ClickHouse/ClickHouse/pull/23461) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 对于向 `Distributed` 表执行的 INSERT 操作，遵从 `insert_allow_materialized_columns`（允许使用物化列）设置。[#23349](https://github.com/ClickHouse/ClickHouse/pull/23349) ([Azat Khuzhin](https://github.com/azat))。
* 为分布式查询新增对 `LIMIT` 下推的支持。 [#23027](https://github.com/ClickHouse/ClickHouse/pull/23027) ([Azat Khuzhin](https://github.com/azat)).
* 修复在多个 S3 卷场景下的零拷贝复制问题（修复 [#22679](https://github.com/ClickHouse/ClickHouse/issues/22679)）。[#22864](https://github.com/ClickHouse/ClickHouse/pull/22864)（[ianton-ru](https://github.com/ianton-ru)）。
* 当用户向操作系统请求任意可用端口时，解析实际绑定的端口号，并在日志消息中显示。 [#25569](https://github.com/ClickHouse/ClickHouse/pull/25569) ([bnaecker](https://github.com/bnaecker)).
* 修复了在某些情况下将 Postgres 数组转换时，结果变成 `String` 数据类型而不是 n 维数组的问题，这是由于 `attndims` 在部分场景下工作不正确所致。修复了 [#24804](https://github.com/ClickHouse/ClickHouse/issues/24804)。[#25538](https://github.com/ClickHouse/ClickHouse/pull/25538)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复了 MySQL、PostgreSQL、ODBC 中带时区 `DateTime` 的转换问题。修复关联的 [#5057](https://github.com/ClickHouse/ClickHouse/issues/5057)。[#25528](https://github.com/ClickHouse/ClickHouse/pull/25528)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 为不同的表区分处理 `KILL MUTATION`（修复了意外出现的 `Cancelled mutating parts` 错误）。[#25025](https://github.com/ClickHouse/ClickHouse/pull/25025) ([Azat Khuzhin](https://github.com/azat)).
* 允许在 bucket 根目录声明 S3 磁盘（S3 虚拟文件系统是一个开发中的实验性特性）。 [#24898](https://github.com/ClickHouse/ClickHouse/pull/24898) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 允许在分布式表中读取子列（例如 `Tuple` 的各个组成部分）。[#24472](https://github.com/ClickHouse/ClickHouse/pull/24472)（[Anton Popov](https://github.com/CurtizJ)）。
* MySQL 兼容协议相关特性：使 `user` 函数返回正确的输出。关闭 [#25697](https://github.com/ClickHouse/ClickHouse/pull/25697)。[#25697](https://github.com/ClickHouse/ClickHouse/pull/25697)（[sundyli](https://github.com/sundy-li)）。

#### 错误修复 {#bug-fix-3}


* 改进向后兼容性：在用作分区键时，沿用旧版本的取模函数。修复 [#23508](https://github.com/ClickHouse/ClickHouse/issues/23508)。[#24157](https://github.com/ClickHouse/ClickHouse/pull/24157)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复了在低内存服务器上出现的一个极其罕见的错误，该错误可能会导致无法在不重启的情况下执行合并。可能同时修复了 [#24603](https://github.com/ClickHouse/ClickHouse/issues/24603)。[#24872](https://github.com/ClickHouse/ClickHouse/pull/24872)（[alesapin](https://github.com/alesapin)）。
* 修复在并发执行 `alter move/replace partition` 时，复制队列中极其罕见的错误 `Tagging already tagged part`。可能也一并修复了 [#22142](https://github.com/ClickHouse/ClickHouse/issues/22142)。[#24961](https://github.com/ClickHouse/ClickHouse/pull/24961)（[alesapin](https://github.com/alesapin)）。
* 修复了在通过对其他聚合函数的聚合函数状态进行聚合来计算聚合函数状态时可能发生的崩溃问题（这并不是一个实际的使用场景）。参见 [#24523](https://github.com/ClickHouse/ClickHouse/issues/24523)。[#25015](https://github.com/ClickHouse/ClickHouse/pull/25015)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在执行 `SYSTEM RESTART REPLICA` 或 `SYSTEM SYNC REPLICA` 查询时可能无法结束的问题。该问题是在内存极其不足的服务器上发现的。[#24457](https://github.com/ClickHouse/ClickHouse/pull/24457) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 修复了可能导致 ZooKeeper 客户端在 clickhouse-server 内部挂起的错误。 [#24721](https://github.com/ClickHouse/ClickHouse/pull/24721) ([alesapin](https://github.com/alesapin)).
* 如果 ZooKeeper 连接丢失，并且在恢复连接后克隆了副本，那么其复制队列中可能包含过期的记录。修复了当复制队列包含相交的虚拟数据部分时触发的断言失败问题。这种情况在某些数据部分丢失时极少会发生。现在改为在日志中输出错误而不是终止进程。[#24777](https://github.com/ClickHouse/ClickHouse/pull/24777) ([tavplubix](https://github.com/tavplubix))。
* 修复在查询计划的表达式下推优化中丢失的 `WHERE` 条件（默认将 `query_plan_filter_push_down` 设置为 1）。修复了 [#25368](https://github.com/ClickHouse/ClickHouse/issues/25368)。[#25370](https://github.com/ClickHouse/ClickHouse/pull/25370) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复了一个在带有 TTL 的合并后可能导致分块相互交叠的错误：`Part all_40_40_0 is covered by all_40_40_1 but should be merged into all_40_41_1. This shouldn't happen often.`。 [#25549](https://github.com/ClickHouse/ClickHouse/pull/25549) ([alesapin](https://github.com/alesapin))。
* 在 ZooKeeper 连接丢失时，`ReplicatedMergeTree` 表可能会在尝试重新连接之前一直等待后台操作完成。该问题已修复，现在会强制停止后台操作。[#25306](https://github.com/ClickHouse/ClickHouse/pull/25306) ([tavplubix](https://github.com/tavplubix))。
* 修复在主键中使用数组时，对带有 `ARRAY JOIN` 的查询出现的错误 `Key expression contains comparison between inconvertible types`。修复了 [#8247](https://github.com/ClickHouse/ClickHouse/issues/8247)。[#25546](https://github.com/ClickHouse/ClickHouse/pull/25546)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复了使用 `WITH TOTALS` 和 `WITH FILL` 的查询中错误的总计结果。修复 [#20872](https://github.com/ClickHouse/ClickHouse/issues/20872)。[#25539](https://github.com/ClickHouse/ClickHouse/pull/25539) ([Anton Popov](https://github.com/CurtizJ))。
* 修复在重新加载集群配置的同时查询 `system.clusters` 时出现的数据竞争问题。[#25737](https://github.com/ClickHouse/ClickHouse/pull/25737)（[Amos Bird](https://github.com/amosbird)）。
* 修复在数据库之间移动 `Distributed` 表时出现的 `No such file or directory` 错误。修复了 [#24971](https://github.com/ClickHouse/ClickHouse/issues/24971)。[#25667](https://github.com/ClickHouse/ClickHouse/pull/25667)（[tavplubix](https://github.com/tavplubix)）。
* 在极少数情况下，如果源分区为空，`REPLACE PARTITION` 可能会被忽略。该问题已修复。修复了 [#24869](https://github.com/ClickHouse/ClickHouse/issues/24869)。[#25665](https://github.com/ClickHouse/ClickHouse/pull/25665)（[tavplubix](https://github.com/tavplubix)）。
* 修复了 `Replicated` 数据库引擎中的一个错误，该错误在极少数情况下可能导致某个副本跳过已排队的 DDL 查询。[#24805](https://github.com/ClickHouse/ClickHouse/pull/24805) ([tavplubix](https://github.com/tavplubix))。
* 修复在未提供查询时 `EXPLAIN AST` 中的空指针解引用问题。[#25631](https://github.com/ClickHouse/ClickHouse/pull/25631) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复对空数据分片自动删除操作的等待逻辑。该问题可能导致后台线程池被完全占满，并使复制过程卡住。 [#23315](https://github.com/ClickHouse/ClickHouse/pull/23315) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了存储在 S3 虚拟文件系统中的表的恢复功能（这是一项尚未准备好在生产环境中使用的实验性特性）。[#25601](https://github.com/ClickHouse/ClickHouse/pull/25601) ([ianton-ru](https://github.com/ianton-ru))。
* 修复在 `Arrow` 格式中使用 `Decimal256` 时的 `nullptr` 解引用问题。为 `Arrow` 格式添加 `Decimal256` 支持。[#25531](https://github.com/ClickHouse/ClickHouse/pull/25531) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复预处理配置文件名称中多余的下划线。 [#25431](https://github.com/ClickHouse/ClickHouse/pull/25431) ([Vitaly Baranov](https://github.com/vitlibar)).
* 对 `clickhouse-copier` 工具的修复：修复在 copier 的任务配置中缺少 `sharding_key` 时出现的段错误。[#25419](https://github.com/ClickHouse/ClickHouse/pull/25419) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 修复在 DDL 中使用 `REPLACE` 列转换器时对格式化查询的引用方式，确保正确加引号。这修复了 [#23925](https://github.com/ClickHouse/ClickHouse/issues/23925)。[#25391](https://github.com/ClickHouse/ClickHouse/pull/25391)（[Amos Bird](https://github.com/amosbird)）。
* 修复了 `quantileDeterministic` 函数及类似函数可能出现的非确定性行为。此更改解决了 [#20480](https://github.com/ClickHouse/ClickHouse/issues/20480)。[#25313](https://github.com/ClickHouse/ClickHouse/pull/25313)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 `SummingMergeTree` 添加对 `SimpleAggregateFunction(LowCardinality)` 的支持。修复 [#25134](https://github.com/ClickHouse/ClickHouse/issues/25134)。[#25300](https://github.com/ClickHouse/ClickHouse/pull/25300)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了异常消息&quot;Cannot sum Array/Tuple in min/maxMap&quot;相关的逻辑错误。[#25298](https://github.com/ClickHouse/ClickHouse/pull/25298) ([Kruglov Pavel](https://github.com/Avogar))。
* 修复在 IN 查询中使用 `LowCardinality` 参数时出现的错误 `Bad cast from type DB::ColumnLowCardinality to DB::ColumnVector<char8_t>`（该缺陷出现在 21.6 版本中）。修复了 [#25187](https://github.com/ClickHouse/ClickHouse/issues/25187)。[#25290](https://github.com/ClickHouse/ClickHouse/pull/25290)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复 `joinGetOrNull` 在非 Nullable 列上的错误行为。此修复解决了 [#24261](https://github.com/ClickHouse/ClickHouse/issues/24261)。[#25288](https://github.com/ClickHouse/ClickHouse/pull/25288)（[Amos Bird](https://github.com/amosbird)）。
* 修复大整数中的不正确行为和 UBSan 报告。在先前的版本中，`CAST(1e19 AS UInt128)` 会返回零。[#25279](https://github.com/ClickHouse/ClickHouse/pull/25279) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复了在使用 `CSVWithNames` 格式插入部分列时出现的错误。修复了 [#25129](https://github.com/ClickHouse/ClickHouse/issues/25129)。[#25169](https://github.com/ClickHouse/ClickHouse/pull/25169)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 不要在带有 `FINAL` 的 `SELECT` 中使用表的投影（projection）。该用法目前尚不支持。[#25163](https://github.com/ClickHouse/ClickHouse/pull/25163) ([Amos Bird](https://github.com/amosbird))。
* 修复升级到 21.5 版本后,当表的分区键中使用了 `UUID` 时可能导致的数据分区丢失问题。(不建议在分区键中使用 `UUID`)。修复 [#25070](https://github.com/ClickHouse/ClickHouse/issues/25070)。[#25127](https://github.com/ClickHouse/ClickHouse/pull/25127) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复在包含 cross join 且 `joined_subquery_requires_alias = 0` 的查询中发生的崩溃问题。修复 [#24011](https://github.com/ClickHouse/ClickHouse/issues/24011)。[#25082](https://github.com/ClickHouse/ClickHouse/pull/25082)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了 `mapContains` 函数中使用常量映射时导致错误 `empty column was returned by function mapContains` 的问题。关闭 [#25077](https://github.com/ClickHouse/ClickHouse/issues/25077)。[#25080](https://github.com/ClickHouse/ClickHouse/pull/25080)（[Kruglov Pavel](https://github.com/Avogar)）。
* 禁止创建包含自引用列（例如 `a UInt32 ALIAS a + 1` 或 `b UInt32 MATERIALIZED b`）的表。修复了 [#24910](https://github.com/ClickHouse/ClickHouse/issues/24910)、[#24292](https://github.com/ClickHouse/ClickHouse/issues/24292)。[#25059](https://github.com/ClickHouse/ClickHouse/pull/25059)（[alesapin](https://github.com/alesapin)）。
* 修复在使用具有*非空* `GROUP BY` 键的聚合投影来执行按*空*键进行 `GROUP BY` 的查询时产生错误结果的问题。 [#25055](https://github.com/ClickHouse/ClickHouse/pull/25055) ([Amos Bird](https://github.com/amosbird)).
* 修复 Protobuf 格式中被拆分的嵌套消息的序列化。此 PR 修复了 [#24647](https://github.com/ClickHouse/ClickHouse/issues/24647)。[#25000](https://github.com/ClickHouse/ClickHouse/pull/25000)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复分布式查询的 limit/offset 设置（在远程节点上忽略该设置）。[#24940](https://github.com/ClickHouse/ClickHouse/pull/24940)（[Azat Khuzhin](https://github.com/azat)）。
* 修复 `Arrow` 格式中可能的堆缓冲区溢出问题。[#24922](https://github.com/ClickHouse/ClickHouse/pull/24922) ([Kruglov Pavel](https://github.com/Avogar))。
* 修复了从 DiskS3 读取文件时可能出现的错误 &#39;Cannot read from istream at offset 0&#39;（S3 虚拟文件系统是一项仍在开发中的实验性功能，不应在生产环境中使用）。 [#24885](https://github.com/ClickHouse/ClickHouse/pull/24885) ([Pavel Kovalenko](https://github.com/Jokser)).
* 修复在 JOIN 分布式物化视图时出现的 &quot;Missing columns&quot; 异常。[#24870](https://github.com/ClickHouse/ClickHouse/pull/24870) ([Azat Khuzhin](https://github.com/azat)).
* 在 postgresql 兼容协议中允许使用 `NULL` 值。修复了 [#22622](https://github.com/ClickHouse/ClickHouse/issues/22622)。[#24857](https://github.com/ClickHouse/ClickHouse/pull/24857)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复了一个错误：在等待变更操作时，如果该变更操作尚未加载到内存中，客户端可能会抛出 `Mutation was killed` 异常。 [#24809](https://github.com/ClickHouse/ClickHouse/pull/24809) ([alesapin](https://github.com/alesapin))。
* 修复了随机生成器状态反序列化中的错误，该错误可能导致某些数据类型（例如 `AggregateFunction(groupArraySample(N), T))`）出现非确定性行为。 [#24538](https://github.com/ClickHouse/ClickHouse/pull/24538) ([tavplubix](https://github.com/tavplubix)).
* 禁止构建其他聚合状态的 `uniqXXXXStates`。 [#24523](https://github.com/ClickHouse/ClickHouse/pull/24523)（[Raúl Marín](https://github.com/Algunenano)）。随后通过真正消除相关问题的根本原因，又重新允许这样做。（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在 `CREATE .. AS SELECT` 查询中对元组（tuple）的使用。[#24464](https://github.com/ClickHouse/ClickHouse/pull/24464) ([Anton Popov](https://github.com/CurtizJ)).
* 修复 `Buffer` 表中总字节数的计算。在当前 ClickHouse 版本中，`total_writes.bytes` 计数器在缓冲区刷新期间被递减得过多。这会导致计数器溢出，并且在刷新一段时间后，`totalBytes` 返回约 17.44 EB 的值。[#24450](https://github.com/ClickHouse/ClickHouse/pull/24450) ([DimasKovas](https://github.com/DimasKovas))。
* 修正关于 `toWeek` 函数单调性的错误说明，修复了 [#24422](https://github.com/ClickHouse/ClickHouse/issues/24422)。该缺陷是在 [https://github.com/ClickHouse/ClickHouse/pull/5212](https://github.com/ClickHouse/ClickHouse/pull/5212) 中引入的，并在更智能的分区剪枝器出现后才被暴露出来。[#24446](https://github.com/ClickHouse/ClickHouse/pull/24446)（[Amos Bird](https://github.com/amosbird)）。
* 当用户身份验证由 LDAP 管理时，修复了在 LDAP 角色（重新）映射过程中可能发生的潜在死锁问题：当 LDAP 组被映射到一个不存在的本地角色时会触发该问题。 [#24431](https://github.com/ClickHouse/ClickHouse/pull/24431) ([Denis Glazachev](https://github.com/traceon)).
* 在 &quot;multipart/form-data&quot; 消息中,将边界前的 CRLF 视为边界的一部分。修复 [#23905](https://github.com/ClickHouse/ClickHouse/issues/23905)。[#24399](https://github.com/ClickHouse/ClickHouse/pull/24399) ([Ivan](https://github.com/abyss7))。
* 修复在存在相交伪分片时执行 drop partition 的问题。在极少数情况下，可能会出现 `mutation` 版本号大于当前块号的数据分片。[#24321](https://github.com/ClickHouse/ClickHouse/pull/24321) ([Amos Bird](https://github.com/amosbird))。
* 修复了在将物化视图从 Ordinary 数据库迁移到 Atomic 数据库时（通过 `RENAME TABLE` 查询）出现的错误。现在内部表会随同物化视图一起迁移到新的数据库中。修复了 [#23926](https://github.com/ClickHouse/ClickHouse/issues/23926)。[#24309](https://github.com/ClickHouse/ClickHouse/pull/24309)（[tavplubix](https://github.com/tavplubix)）。
* 允许空 HTTP 头。修复 [#23901](https://github.com/ClickHouse/ClickHouse/issues/23901)。[#24285](https://github.com/ClickHouse/ClickHouse/pull/24285)（[Ivan](https://github.com/abyss7)）。
* 修正了 Memory 表中变更操作(ALTER UPDATE/DELETE)的处理。关闭 [#24274](https://github.com/ClickHouse/ClickHouse/issues/24274)。[#24275](https://github.com/ClickHouse/ClickHouse/pull/24275) ([flynn](https://github.com/ucasfl))。
* 使 `JOIN` 输出中列的 `LowCardinality` 属性与输入保持一致，修复 [#23351](https://github.com/ClickHouse/ClickHouse/issues/23351)、[#20315](https://github.com/ClickHouse/ClickHouse/issues/20315)。[#24061](https://github.com/ClickHouse/ClickHouse/pull/24061)（[Vladimir](https://github.com/vdimir)）。
* 针对 Kafka 表的修复。修复了故障转移行为中的一个 bug：当 `Engine = Kafka` 使用的同一 consumer 之前曾获得空的 assignment 时，无法重新开始消费的问题。关闭 [#21118](https://github.com/ClickHouse/ClickHouse/issues/21118)。 [#21267](https://github.com/ClickHouse/ClickHouse/pull/21267) ([filimonov](https://github.com/filimonov))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-4}

- 在 CI 中添加 `darwin-aarch64`(Mac M1 / Apple Silicon)构建 [#25560](https://github.com/ClickHouse/ClickHouse/pull/25560) ([Ivan](https://github.com/abyss7)) 并将链接添加到文档和网站 ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 添加跨平台的二进制资源嵌入可执行文件功能。支持在 Illumos 上运行。[#25146](https://github.com/ClickHouse/ClickHouse/pull/25146) ([bnaecker](https://github.com/bnaecker))。
- 在压力测试中添加 join 相关选项以改进模糊测试。[#25200](https://github.com/ClickHouse/ClickHouse/pull/25200) ([Vladimir](https://github.com/vdimir))。
- 在 macOS 中启用 s3 模块构建 [#25217](https://github.com/ClickHouse/ClickHouse/issues/25217)。[#25218](https://github.com/ClickHouse/ClickHouse/pull/25218) ([kevin wan](https://github.com/MaxWk))。
- 添加集成测试用例以覆盖 JDBC 桥接。[#25047](https://github.com/ClickHouse/ClickHouse/pull/25047) ([Zhichun Wu](https://github.com/zhicwu))。
- 集成测试配置对字典进行了特殊处理。移除了剩余的字典手动配置。[#24728](https://github.com/ClickHouse/ClickHouse/pull/24728) ([Ilya Yatsishin](https://github.com/qoega))。
- 为 YAMLParser 类添加 libfuzzer 测试。[#24480](https://github.com/ClickHouse/ClickHouse/pull/24480) ([BoloniniD](https://github.com/BoloniniD))。
- 现在使用 Ubuntu 20.04 运行集成测试,用于运行集成测试的 docker-compose 版本已更新至 1.28.2。环境变量现在可在 docker-compose 中生效。重构 test_dictionaries_all_layouts_separate_sources 以支持并行运行。[#20393](https://github.com/ClickHouse/ClickHouse/pull/20393) ([Ilya Yatsishin](https://github.com/qoega))。
- 修复安装脚本中的 TOCTOU 错误。[#25277](https://github.com/ClickHouse/ClickHouse/pull/25277) ([alexey-milovidov](https://github.com/alexey-milovidov))。

### ClickHouse 版本 21.6,2021-06-05 {#clickhouse-release-216-2021-06-05}

#### 向后不兼容的变更 {#backward-incompatible-change-5}

- uniqState / uniqHLL12State / uniqCombinedState / uniqCombined64State 对 `UUID` 类型产生不兼容的状态。[#33607](https://github.com/ClickHouse/ClickHouse/issues/33607)。

#### 升级说明 {#upgrade-notes-1}

- `zstd` 压缩库已更新至 v1.5.0。您可能会在复制过程中收到"校验和不匹配"的消息。由于压缩算法的更新,这些消息是预期的,您可以忽略它们。这些消息仅供参考,不表示任何异常行为。
- 设置 `compile_expressions` 默认启用。尽管它已在各种场景下经过充分测试,但如果您在服务器上发现任何异常行为,可以尝试关闭此设置。
- `UUID` 类型的值不能与整数进行比较。例如,应使用 `uuid != '00000000-0000-0000-0000-000000000000'` 而不是 `uuid != 0`。

#### 新功能 {#new-feature-5}


* 添加类似 Postgres 的类型转换运算符（`::`）。例如：`[1, 2]::Array(UInt8)`、`0.1::Decimal(4, 4)`、`number::UInt16`。[#23871](https://github.com/ClickHouse/ClickHouse/pull/23871)（[Anton Popov](https://github.com/CurtizJ)）。
* 使大整数功能达到可用于生产环境的水平。添加对 `UInt128` 数据类型的支持。修复已知的 `Decimal256` 数据类型问题。在字典中支持大整数。在 `gcd`/`lcm` 函数中支持大整数。在数组查找和条件函数中支持大整数。支持 `LowCardinality(UUID)`。在 `generateRandom` 表函数和 `clickhouse-obfuscator` 中支持大整数。修复从标量子查询返回 `UUID` 时的错误。修复了 [#7834](https://github.com/ClickHouse/ClickHouse/issues/7834)。修复了 [#23936](https://github.com/ClickHouse/ClickHouse/issues/23936)。修复了 [#4176](https://github.com/ClickHouse/ClickHouse/issues/4176)。修复了 [#24018](https://github.com/ClickHouse/ClickHouse/issues/24018)。向后不兼容变更：`UUID` 类型的值不能再与整数进行比较。例如，不要写 `uuid != 0`，而应写 `uuid != '00000000-0000-0000-0000-000000000000'`。[#23631](https://github.com/ClickHouse/ClickHouse/pull/23631)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 `Arrow`、`Parquet` 和 `ORC` 格式中支持用于插入和查询数据的 `Array` 数据类型。 [#21770](https://github.com/ClickHouse/ClickHouse/pull/21770) ([taylor12805](https://github.com/taylor12805))。
* 实现表级注释功能。关闭 [#23225](https://github.com/ClickHouse/ClickHouse/issues/23225)。[#23548](https://github.com/ClickHouse/ClickHouse/pull/23548)（[flynn](https://github.com/ucasFL)）。
* 在 `clickhouse-local` 中支持使用 DDL 查询创建字典。修复了 [#22354](https://github.com/ClickHouse/ClickHouse/issues/22354)。新增对 `DETACH DICTIONARY PERMANENTLY` 的支持。为 `Atomic` 数据库引擎新增对 `EXCHANGE DICTIONARIES` 的支持。新增对通过 `RENAME DICTIONARY` 在数据库之间移动字典的支持。[#23436](https://github.com/ClickHouse/ClickHouse/pull/23436)（[Maksim Kita](https://github.com/kitaisreal)）。
* 在 ClickHouse 中新增聚合函数 `uniqTheta`，以支持 [Theta Sketch](https://datasketches.apache.org/docs/Theta/ThetaSketchFramework.html)。[#23894](https://github.com/ClickHouse/ClickHouse/pull/23894)。[#22609](https://github.com/ClickHouse/ClickHouse/pull/22609)（[Ping Yu](https://github.com/pingyu)）。
* 添加了函数 `splitByRegexp`。[#24077](https://github.com/ClickHouse/ClickHouse/pull/24077) ([abel-cheng](https://github.com/abel-cheng))。
* 添加函数 `arrayProduct`，该函数接受一个数组作为参数，并返回该数组中所有元素的乘积。修复 [#21613](https://github.com/ClickHouse/ClickHouse/issues/21613)。[#23782](https://github.com/ClickHouse/ClickHouse/pull/23782)（[Maksim Kita](https://github.com/kitaisreal)）。
* 在 `system.stack_trace` 中添加 `thread_name` 列。此更改解决了 [#23256](https://github.com/ClickHouse/ClickHouse/issues/23256)。[#24124](https://github.com/ClickHouse/ClickHouse/pull/24124)（[abel-cheng](https://github.com/abel-cheng)）。
* 如果将 `insert_null_as_default` 设为 1，则在 `INSERT ... SELECT` 和 `INSERT ... SELECT ... UNION ALL ...` 查询中会插入默认值来替代 NULL。修复了 [#22832](https://github.com/ClickHouse/ClickHouse/issues/22832)。[#23524](https://github.com/ClickHouse/ClickHouse/pull/23524)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 为 `clickhouse-local` 添加使用 `--progress` 选项显示进度的支持。[#23196](https://github.com/ClickHouse/ClickHouse/pull/23196) ([Egor Savin](https://github.com/Amesaru))。
* 在 `http` 字典源中增加对 HTTP 压缩（由 `Content-Encoding` HTTP 头确定）的支持。修复了 [#8912](https://github.com/ClickHouse/ClickHouse/issues/8912)。[#23946](https://github.com/ClickHouse/ClickHouse/pull/23946)（[FArthur-cmd](https://github.com/FArthur-cmd)）。
* 添加了 `SYSTEM QUERY RELOAD MODEL` 和 `SYSTEM QUERY RELOAD MODELS`。修复了 [#18722](https://github.com/ClickHouse/ClickHouse/issues/18722)。[#23182](https://github.com/ClickHouse/ClickHouse/pull/23182)（[Maksim Kita](https://github.com/kitaisreal)）。
* 为 `EXPLAIN PLAN` 查询新增 `json` 设置（布尔型，默认值为 0）。启用后，查询输出将为单行 `JSON`。建议使用 `TSVRaw` 格式以避免不必要的转义。[#23082](https://github.com/ClickHouse/ClickHouse/pull/23082)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 为 `EXPLAIN PIPELINE` 查询新增 `indexes` 设置（布尔类型，默认禁用）。启用后，将显示所使用的索引，以及每个已应用索引所过滤的分片（parts）和粒度（granules）数量。支持 `MergeTree*` 表。[#22352](https://github.com/ClickHouse/ClickHouse/pull/22352) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* LDAP：实现了用户 DN 自动检测功能，可用于将 Active Directory 组映射到 ClickHouse 角色时。 [#22228](https://github.com/ClickHouse/ClickHouse/pull/22228) ([Denis Glazachev](https://github.com/traceon)).
* 新的聚合函数 `deltaSumTimestamp`，通过存储时间戳，在合并时保持顺序的同时，对连续行之间的差值进行求和。[#21888](https://github.com/ClickHouse/ClickHouse/pull/21888)（[Russ Frank](https://github.com/rf)）。
* 为 S3 新增了安全性较低但可在 Docker 中正确工作的 IMDS 凭证提供程序。 [#21852](https://github.com/ClickHouse/ClickHouse/pull/21852) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 重新添加 `indexHint` 函数。用于处理 [#21238](https://github.com/ClickHouse/ClickHouse/issues/21238)。回滚了 [#9542](https://github.com/ClickHouse/ClickHouse/pull/9542)，并修复了 [#9540](https://github.com/ClickHouse/ClickHouse/issues/9540)。[#21304](https://github.com/ClickHouse/ClickHouse/pull/21304)（[Amos Bird](https://github.com/amosbird)）。

#### 实验性功能 {#experimental-feature-5}

- 为 `MergeTree*` 表添加 `PROJECTION` 支持。[#20202](https://github.com/ClickHouse/ClickHouse/pull/20202) ([Amos Bird](https://github.com/amosbird))。

#### 性能改进 {#performance-improvement-5}

- 默认启用 `compile_expressions` 设置。启用此设置后,简单函数和运算符的组合将在运行时通过 LLVM 编译为原生代码。[#8482](https://github.com/ClickHouse/ClickHouse/pull/8482) ([Maksim Kita](https://github.com/kitaisreal), [alexey-milovidov](https://github.com/alexey-milovidov))。注意:如果遇到问题,请关闭此选项。
- 更新 `re2` 库。正则表达式匹配性能得到改进。此外,此 PR 添加了对 gcc-11 的兼容性。[#24196](https://github.com/ClickHouse/ClickHouse/pull/24196) ([Raúl Marín](https://github.com/Algunenano))。
- ORC 输入格式按条带读取,而不是一次性将整个表读入内存,避免了在文件较大时占用过多内存。[#23102](https://github.com/ClickHouse/ClickHouse/pull/23102) ([Chao Ma](https://github.com/godliness))。
- 将查询中的聚合函数 `sum`、`count` 和 `avg` 融合为单个聚合函数。此优化通过 `optimize_fuse_sum_count_avg` 设置控制。这是通过新的聚合函数 `sumCount` 实现的。该函数返回包含两个字段的元组:`sum` 和 `count`。[#21337](https://github.com/ClickHouse/ClickHouse/pull/21337) ([hexiaoting](https://github.com/hexiaoting))。
- 将 `zstd` 更新至 v1.5.0。压缩性能提升了个位数百分比。[#24135](https://github.com/ClickHouse/ClickHouse/pull/24135) ([Raúl Marín](https://github.com/Algunenano))。注意:在复制过程中可能会收到"校验和不匹配"的消息。由于压缩算法的更新,这些消息是预期的,可以忽略。
- 改进了 `Buffer` 表的性能:对于 `Buffer` 引擎,不再为 total_bytes/total_rows 获取锁。[#24066](https://github.com/ClickHouse/ClickHouse/pull/24066) ([Azat Khuzhin](https://github.com/azat))。
- 恢复了对 hashed/sparse_hashed 字典的预分配支持。[#23979](https://github.com/ClickHouse/ClickHouse/pull/23979) ([Azat Khuzhin](https://github.com/azat))。
- 默认启用 `async_socket_for_remote`(在查询具有大扇出的分布式表时减少线程数量)。[#23683](https://github.com/ClickHouse/ClickHouse/pull/23683) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。

#### 改进 {#improvement-5}


* 为 MergeTree 表族添加 `_partition_value` 虚拟列。它可用于以确定性的方式剪枝分区，这是实现用于变更（mutations）的分区匹配器所必需的。[#23673](https://github.com/ClickHouse/ClickHouse/pull/23673) ([Amos Bird](https://github.com/amosbird))。
* 为 S3 存储和磁盘新增了 `region` 参数。[#23846](https://github.com/ClickHouse/ClickHouse/pull/23846) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 允许为不同的日志通道配置不同的日志级别。修复 [#19569](https://github.com/ClickHouse/ClickHouse/issues/19569)。[#23857](https://github.com/ClickHouse/ClickHouse/pull/23857)（[filimonov](https://github.com/filimonov)）。
* 在未显式指定时，在 `DateTime` 运算中保留默认时区。例如，如果对一个不带时区的 `DateTime` 类型的值加上一秒，它仍将是一个不带时区的 `DateTime`。在之前的版本中，默认时区的值会被显式写入返回的数据类型中，因此会变成 DateTime(&#39;something&#39;)。此变更关闭了 [#4854](https://github.com/ClickHouse/ClickHouse/issues/4854)。[#23392](https://github.com/ClickHouse/ClickHouse/pull/23392)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 允许用户在 `MySQL` 存储中将数据库名指定为空字符串。查询将会使用默认数据库。在之前的版本中，这只对 SELECT 查询生效，现在也为 INSERT 查询增加了支持。此更改关闭了 [#19281](https://github.com/ClickHouse/ClickHouse/issues/19281)。这在与 `Sphinx` 或其他兼容 MySQL 的外部数据库配合使用时会很有用。[#23319](https://github.com/ClickHouse/ClickHouse/pull/23319) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了 `quantile(s)TDigest`。根据 tdunning/t-digest 3.2+ 添加了对单个质心的特殊处理。同时修复了早期版本算法实现中质心过度压缩的一个错误。[#23314](https://github.com/ClickHouse/ClickHouse/pull/23314)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* 函数 `now64` 现在支持可选的时区参数。[#24091](https://github.com/ClickHouse/ClickHouse/pull/24091)（[Vasily Nemkov](https://github.com/Enmk)）。
* 修复在 `clickhouse-client` 交互模式下，进度条出现在数据中间时，可能会覆盖终端中部分可见数据的情况。此更改关闭了 [#19283](https://github.com/ClickHouse/ClickHouse/issues/19283)。[#23050](https://github.com/ClickHouse/ClickHouse/pull/23050)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复当 `simdjson` 中内存分配失败时发生的崩溃。[https://github.com/simdjson/simdjson/pull/1567](https://github.com/simdjson/simdjson/pull/1567)。由于这是一个极其罕见的 bug，将其标记为改进。[#24147](https://github.com/ClickHouse/ClickHouse/pull/24147) ([Amos Bird](https://github.com/amosbird))。
* 在存储关闭前保留字典(这将避免在服务器关闭时 `Buffer` 引擎执行最终刷新期间可能出现的 `external dictionary 'DICT' not found` 错误)。[#24068](https://github.com/ClickHouse/ClickHouse/pull/24068) ([Azat Khuzhin](https://github.com/azat))。
* 在关闭同一数据库内的表之前先刷新 `Buffer` 表，避免因底层表已被分离而导致数据块被丢弃（以及日志中出现 `Destination table default.a_data_01870 doesn't exist. Block of data is discarded` 错误）。 [#24067](https://github.com/ClickHouse/ClickHouse/pull/24067) ([Azat Khuzhin](https://github.com/azat)).
* 现在当设置 `prefer_column_name_to_alias = 1` 时，`group by`、`having` 和 `order by` 也会优先使用列名。这修复了 [#23882](https://github.com/ClickHouse/ClickHouse/issues/23882)。[#24022](https://github.com/ClickHouse/ClickHouse/pull/24022)（[Amos Bird](https://github.com/amosbird)）。
* 为 `DateTime64` 添加对 `ORDER BY WITH FILL` 的支持。 [#24016](https://github.com/ClickHouse/ClickHouse/pull/24016) ([kevin wan](https://github.com/MaxWk))。
* 支持在 `ReplacingMergeTree` 中将 `DateTime64` 用作版本列。 [#23992](https://github.com/ClickHouse/ClickHouse/pull/23992) ([kevin wan](https://github.com/MaxWk)).
* 在服务器启动时记录操作系统名称、内核版本和 CPU 架构等信息。[#23988](https://github.com/ClickHouse/ClickHouse/pull/23988)（[Azat Khuzhin](https://github.com/azat)）。
* 支持为 `postgresql` 字典源指定表模式。修复 [#23958](https://github.com/ClickHouse/ClickHouse/issues/23958)。[#23980](https://github.com/ClickHouse/ClickHouse/pull/23980)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 为 `Enum` 元素名称添加提示功能（在出现拼写错误时给出名称建议）。修复问题 [#17112](https://github.com/ClickHouse/ClickHouse/issues/17112)。[#23919](https://github.com/ClickHouse/ClickHouse/pull/23919)（[flynn](https://github.com/ucasFL)）。
* 为字典统计命中率（找到值的百分比）（参见 `system.dictionaries` 中的 `found_rate`）。[#23916](https://github.com/ClickHouse/ClickHouse/pull/23916) ([Azat Khuzhin](https://github.com/azat))。
* 允许通过表设置 `rabbitmq_queue_settings_list` 添加特定队列设置。（修复 [#23737](https://github.com/ClickHouse/ClickHouse/issues/23737) 和 [#23918](https://github.com/ClickHouse/ClickHouse/issues/23918)）。允许用户完全控制 RabbitMQ 的全部配置：如果将表设置 `rabbitmq_queue_consume` 设为 `1`，RabbitMQ 表引擎将只连接到指定队列，并且不会执行任何 RabbitMQ 消费端的初始化操作，例如声明 exchange、队列和绑定。（修复 [#21757](https://github.com/ClickHouse/ClickHouse/issues/21757)）。在删除 RabbitMQ 表时添加了正确的清理逻辑——删除由该表声明的队列，以及所有由该表创建并已绑定的 exchange。[#23887](https://github.com/ClickHouse/ClickHouse/pull/23887) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 将 `broken_data_files`/`broken_data_compressed_bytes` 添加到 `system.distribution_queue` 中。为用于向 Distributed 表进行异步插入且已被标记为损坏的文件数量添加指标（`BrokenDistributedFilesToInsert`）。[#23885](https://github.com/ClickHouse/ClickHouse/pull/23885) ([Azat Khuzhin](https://github.com/azat)).
* 查询 `system.tables` 不再访问 ZooKeeper。[#23793](https://github.com/ClickHouse/ClickHouse/pull/23793)（[Fuwang Hu](https://github.com/fuwhu)）。
* 对 `OPTIMIZE` 查询遵守 `lock_acquire_timeout_for_background_operations` 设置。[#23623](https://github.com/ClickHouse/ClickHouse/pull/23623) ([Azat Khuzhin](https://github.com/azat)).
* 可以通过新的 `SYSTEM RESTART DISK` SQL 命令在运行时修改 `S3` 磁盘设置。[#23429](https://github.com/ClickHouse/ClickHouse/pull/23429)（[Pavel Kovalenko](https://github.com/Jokser)）。
* 如果用户误将 `max_distributed_connections` 设置为零导致配置错误,那么对 `Distributed` 表的每个查询都会抛出包含&quot;logical error&quot;消息的异常。但这实际上是预期行为,而非逻辑错误,因此异常消息并不准确。这还会触发我们 CI 环境中的检查机制,该机制用于确保不会发生逻辑错误。现在我们将把 `max_distributed_connections` 错误配置为零的情况视为最小可能值(一)。[#23348](https://github.com/ClickHouse/ClickHouse/pull/23348) ([Azat Khuzhin](https://github.com/azat))。
* 默认关闭 `min_bytes_to_use_mmap_io`。[#23322](https://github.com/ClickHouse/ClickHouse/pull/23322)（[Azat Khuzhin](https://github.com/azat)）。
* 通过 `join_use_nulls` 支持 `LowCardinality` 的可空性，修复 [#15101](https://github.com/ClickHouse/ClickHouse/issues/15101)。[#23237](https://github.com/ClickHouse/ClickHouse/pull/23237)（[vdimir](https://github.com/vdimir)）。
* 为 `S3` 磁盘新增了将 `MergeTree` 分区恢复到 `detached` 目录的功能。[#23112](https://github.com/ClickHouse/ClickHouse/pull/23112) ([Pavel Kovalenko](https://github.com/Jokser)).
* 在 S3 上支持在 HTTP 连接中断时进行重试。[#22988](https://github.com/ClickHouse/ClickHouse/pull/22988)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* 为 MySQL 表引擎、字典源以及 MaterializeMySQL 的小批量数据抓取新增 `external_storage_max_read_rows` 和 `external_storage_max_read_rows` 设置。[#22697](https://github.com/ClickHouse/ClickHouse/pull/22697) ([TCeason](https://github.com/TCeason))。
* `MaterializeMySQL`（实验特性）：此前由于 SQL 不兼容，不支持 MySQL 5.7.9。现在将 MySQL 参数验证交由 MaterializeMySQL 处理。[#23413](https://github.com/ClickHouse/ClickHouse/pull/23413) ([TCeason](https://github.com/TCeason))。
* 支持在分布式表中读取子列。[#24472](https://github.com/ClickHouse/ClickHouse/pull/24472) ([Anton Popov](https://github.com/CurtizJ))。
* 修复 `CREATE .. AS SELECT` 查询中对元组（tuple）的使用方式。[#24464](https://github.com/ClickHouse/ClickHouse/pull/24464) ([Anton Popov](https://github.com/CurtizJ))。
* 在 `Kafka` 表中添加对 `Parquet` 格式的支持。[#23412](https://github.com/ClickHouse/ClickHouse/pull/23412)（[Chao Ma](https://github.com/godliness)）。

#### 错误修复 {#bug-fix-4}


* 在分区键和主键中使用时，使用旧版本的取模函数。修复了 [#23508](https://github.com/ClickHouse/ClickHouse/issues/23508)。[#24157](https://github.com/ClickHouse/ClickHouse/pull/24157)（[Kseniia Sumarokova](https://github.com/kssenii)）。这是此前版本中导致向后不兼容的原因。
* 修复了在处理 `SYSTEM RESTART REPLICA` 或 `SYSTEM SYNC REPLICA` 查询时可能出现的无限执行问题。该问题是在可用 RAM 极少的服务器上被发现的。[#24457](https://github.com/ClickHouse/ClickHouse/pull/24457) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 修复 `toWeek` 函数不正确的单调性。这修复了 [#24422](https://github.com/ClickHouse/ClickHouse/issues/24422)。该缺陷是在 [#5212](https://github.com/ClickHouse/ClickHouse/pull/5212) 中引入的，并在更智能的分区裁剪器出现后被暴露。[#24446](https://github.com/ClickHouse/ClickHouse/pull/24446)（[Amos Bird](https://github.com/amosbird)）。
* 修复在存在交叉伪数据片段时执行 `drop partition` 的问题。在极少数情况下，可能会出现变更版本号大于当前块编号的数据片段。[#24321](https://github.com/ClickHouse/ClickHouse/pull/24321) ([Amos Bird](https://github.com/amosbird))。
* 修复了在使用 `RENAME TABLE` 查询将物化视图从 Ordinary 数据库迁移到 Atomic 数据库时的一个错误。现在内部表会与物化视图一起被移动到新数据库。修复了 [#23926](https://github.com/ClickHouse/ClickHouse/issues/23926)。[#24309](https://github.com/ClickHouse/ClickHouse/pull/24309)（[tavplubix](https://github.com/tavplubix)）。
* 允许客户端请求中包含空的 HTTP 头。修复 [#23901](https://github.com/ClickHouse/ClickHouse/issues/23901)。[#24285](https://github.com/ClickHouse/ClickHouse/pull/24285)（[Ivan](https://github.com/abyss7)）。
* 将 `max_threads` 设置为 `1` 以修复 `Memory` 表变更失败的问题。关闭 [#24274](https://github.com/ClickHouse/ClickHouse/issues/24274)。[#24275](https://github.com/ClickHouse/ClickHouse/pull/24275)（[flynn](https://github.com/ucasFL)）。
* 修复 `Memory` 表实现中的拼写错误，该错误最初在 [#15127](https://github.com/ClickHouse/ClickHouse/issues/15127) 中引入。修复了 [#24192](https://github.com/ClickHouse/ClickHouse/issues/24192)。[#24193](https://github.com/ClickHouse/ClickHouse/pull/24193)（[张中南](https://github.com/plugine)）。
* 修复在查询执行期间 `HDFS` 变得不可访问时导致服务器异常终止的问题。关闭 [#24117](https://github.com/ClickHouse/ClickHouse/issues/24117)。[#24191](https://github.com/ClickHouse/ClickHouse/pull/24191)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在使用常量条件更新 `Nested` 列时出现的崩溃问题。[#24183](https://github.com/ClickHouse/ClickHouse/pull/24183) ([hexiaoting](https://github.com/hexiaoting)).
* 修复在高负载下 RBAC 中可能出现的竞争条件。此 PR 修复了 [#24090](https://github.com/ClickHouse/ClickHouse/issues/24090)、[#24134](https://github.com/ClickHouse/ClickHouse/issues/24134)、[#24176](https://github.com/ClickHouse/ClickHouse/pull/24176)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复了一个罕见的错误，该错误可能导致表只被部分初始化但仍可处理写入请求（`insert`/`alter`/等）。现在此类表将会处于只读模式。[#24122](https://github.com/ClickHouse/ClickHouse/pull/24122) ([alesapin](https://github.com/alesapin))。
* 修复了一个问题：在使用 `SELECT xxx FINAL` 时，`EXPLAIN PIPELINE` 显示了错误的执行管线。（[hexiaoting](https://github.com/hexiaoting)）。
* 修复了在 `WHERE` 子句中将常量 `DateTime` 值与 `DateTime64` 列一起使用的问题。[#24100](https://github.com/ClickHouse/ClickHouse/pull/24100) ([Vasily Nemkov](https://github.com/Enmk)).
* 修复 merge JOIN 中的崩溃，解决 [#24010](https://github.com/ClickHouse/ClickHouse/issues/24010)。[#24013](https://github.com/ClickHouse/ClickHouse/pull/24013) ([vdimir](https://github.com/vdimir))。
* 某些 `ALTER PARTITION` 查询可能会在复制队列中导致 `Part A intersects previous part B` 和 `Unexpected merged part C intersecting drop range D` 错误。此问题已修复。修复了 [#23296](https://github.com/ClickHouse/ClickHouse/issues/23296)。[#23997](https://github.com/ClickHouse/ClickHouse/pull/23997)（[tavplubix](https://github.com/tavplubix)）。
* 修复外部 GROUP BY 和溢出行触发的 SIGSEGV（即类似 `SELECT FROM GROUP BY WITH TOTALS SETTINGS max_bytes_before_external_group_by>0, max_rows_to_group_by>0, group_by_overflow_mode='any', totals_mode='before_having'` 这样的查询）。 [#23962](https://github.com/ClickHouse/ClickHouse/pull/23962) ([Azat Khuzhin](https://github.com/azat)).
* 修复在源数据包含重复项时 `CACHE` 字典键相关指标的统计方式问题（会导致 `DictCacheKeysRequestedMiss` 溢出）。[#23929](https://github.com/ClickHouse/ClickHouse/pull/23929) ([Azat Khuzhin](https://github.com/azat))。
* 修复 `PostgreSQL` 引擎的连接池实现。修复 [#23897](https://github.com/ClickHouse/ClickHouse/issues/23897)。[#23909](https://github.com/ClickHouse/ClickHouse/pull/23909)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在将聚合函数包裹在普通函数中并与 `GROUP BY` 一起使用时 `distributed_group_by_no_merge = 2` 的问题（此前在 [#23546](https://github.com/ClickHouse/ClickHouse/issues/23546) 中被引入了缺陷）。当有人尝试将 `distributed_group_by_no_merge = 2` 与窗口函数一起使用时抛出异常。对包含窗口函数的查询禁用 `optimize_distributed_group_by_sharding_key`。[#23906](https://github.com/ClickHouse/ClickHouse/pull/23906) ([Azat Khuzhin](https://github.com/azat))。
* 修复了 `s3` 表函数：改进了对 HTTP 错误的处理。此前会忽略 HTTP 错误的响应体。[#23844](https://github.com/ClickHouse/ClickHouse/pull/23844)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* 对 `s3` 表函数的修复：改进了对 URI 的处理。修复了包含 `+` 符号的 URL 的兼容性问题，此前使用此类键的数据无法被读取。[#23822](https://github.com/ClickHouse/ClickHouse/pull/23822) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 修复在包含 `GLOBAL IN/JOIN` 且启用了 `use_hedged_requests` 的查询中出现的错误 `Can't initialize pipeline with empty pipe`。修复 [#23431](https://github.com/ClickHouse/ClickHouse/issues/23431)。[#23805](https://github.com/ClickHouse/ClickHouse/pull/23805)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在被物化视图引用时 `CLEAR COLUMN` 不生效的问题。关闭 [#23764](https://github.com/ClickHouse/ClickHouse/issues/23764)。[#23781](https://github.com/ClickHouse/ClickHouse/pull/23781)（[flynn](https://github.com/ucasFL)）。
* 修复在使用 `Values` 格式从 HDFS 读取时发生的“释放后使用堆内存”问题。 [#23761](https://github.com/ClickHouse/ClickHouse/pull/23761) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 在向 Distributed 执行 INSERT 时，如果发生某些异常，避免可能出现 “Cannot schedule a task” 错误。 [#23744](https://github.com/ClickHouse/ClickHouse/pull/23744) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在恢复过时 `ReplicatedMergeTree` 副本时的一个错误。如果在副本停机期间执行了 `ALTER` 查询，则该过时副本可能会忽略某些元数据更新。[#23742](https://github.com/ClickHouse/ClickHouse/pull/23742) ([tavplubix](https://github.com/tavplubix)).
* 修复 `Join` 与 `WITH TOTALS` 的一个 bug，关闭 [#17718](https://github.com/ClickHouse/ClickHouse/issues/17718)。[#23549](https://github.com/ClickHouse/ClickHouse/pull/23549)（[vdimir](https://github.com/vdimir)）。
* 修复在包含 `UNION` 的查询中可能出现的 `Block structure mismatch` 错误，该错误可能在进行过滤下推（filter-pushdown）优化后发生。修复 [#23029](https://github.com/ClickHouse/ClickHouse/issues/23029)。[#23359](https://github.com/ClickHouse/ClickHouse/pull/23359)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 在启用 `optimize_skip_unused_shards_rewrite_in` 设置时添加类型转换。此更改修复了 MSan 的报错。[#23219](https://github.com/ClickHouse/ClickHouse/pull/23219) ([Azat Khuzhin](https://github.com/azat))。
* 在更新嵌套子列时补充缺失的检查，关闭问题：[#22353](https://github.com/ClickHouse/ClickHouse/issues/22353)。[#22503](https://github.com/ClickHouse/ClickHouse/pull/22503)（[hexiaoting](https://github.com/hexiaoting)）。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-5}

- 支持在 Illumos 上构建。[#24144](https://github.com/ClickHouse/ClickHouse/pull/24144)。添加了对 Solaris 衍生操作系统的构建支持。[#23746](https://github.com/ClickHouse/ClickHouse/pull/23746) ([bnaecker](https://github.com/bnaecker))。
- 为哈希表添加更多基准测试,包括 Google 的 Swiss Table(在我们的特定使用场景中,其性能似乎低于 ClickHouse 哈希映射)。[#24111](https://github.com/ClickHouse/ClickHouse/pull/24111) ([Maksim Kita](https://github.com/kitaisreal))。
- 将 librdkafka 从 1.6.0-RC3 更新至 1.6.1。[#23874](https://github.com/ClickHouse/ClickHouse/pull/23874) ([filimonov](https://github.com/filimonov))。
- 始终显式启用 `asynchronous-unwind-tables`。这可能会修复 AArch64 上的查询性能分析器问题。[#23602](https://github.com/ClickHouse/ClickHouse/pull/23602) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 避免构建对区域设置和文件系统顺序的依赖。这使得可重现构建成为可能。[#23600](https://github.com/ClickHouse/ClickHouse/pull/23600) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 消除构建中的一个非确定性来源。现在在不同时间点进行的构建将产生字节完全相同的二进制文件。部分解决了 [#22113](https://github.com/ClickHouse/ClickHouse/issues/22113)。[#23559](https://github.com/ClickHouse/ClickHouse/pull/23559) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 添加用于 (Zoo)Keeper 基准测试的简单工具。[#23038](https://github.com/ClickHouse/ClickHouse/pull/23038) ([alesapin](https://github.com/alesapin))。


## ClickHouse 21.5 版本,2021-05-20 {#clickhouse-release-215-2021-05-20}

#### 向后不兼容变更 {#backward-incompatible-change-6}

- 当整数无法在浮点数据类型中精确表示时,更改整数与浮点数的比较行为。在新版本中,由于会发生舍入误差,比较将返回 false。例如:`9223372036854775808.0 != 9223372036854775808`,因为数字 `9223372036854775808` 无法精确表示为浮点数(且 `9223372036854775808.0` 会被舍入为 `9223372036854776000.0`)。但在旧版本中,比较会返回这些数字相等,因为如果将浮点数 `9223372036854776000.0` 转换回 UInt64,它将产生 `9223372036854775808`。作为参考,Python 编程语言也将这些数字视为相等。但这种行为依赖于 CPU 型号(在 AMD64 和 AArch64 上对某些超出范围的数字会产生不同的结果),因此我们使比较更加精确。现在只有当整数能在浮点类型中精确表示时,才会将整数和浮点数视为相等。[#22595](https://github.com/ClickHouse/ClickHouse/pull/22595) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 移除对单个 `Tuple` 参数的 `argMin` 和 `argMax` 支持。该代码不是内存安全的。此功能是错误添加的,会让用户感到困惑。这些函数可能会在以后以不同的名称重新引入。此更改修复了 [#22384](https://github.com/ClickHouse/ClickHouse/issues/22384) 并回退了 [#17359](https://github.com/ClickHouse/ClickHouse/issues/17359)。[#23393](https://github.com/ClickHouse/ClickHouse/pull/23393) ([alexey-milovidov](https://github.com/alexey-milovidov))。

#### 新功能 {#new-feature-6}

- 添加了函数 `dictGetChildren(dictionary, key)` 和 `dictGetDescendants(dictionary, key, level)`。函数 `dictGetChildren` 以索引数组的形式返回所有子节点。它是 `dictGetHierarchy` 的逆向转换。函数 `dictGetDescendants` 返回所有后代节点,就像递归应用 `dictGetChildren` `level` 次一样。`level` 值为零等同于无限。改进了 `dictGetHierarchy` 和 `dictIsIn` 函数的性能。关闭 [#14656](https://github.com/ClickHouse/ClickHouse/issues/14656)。[#22096](https://github.com/ClickHouse/ClickHouse/pull/22096) ([Maksim Kita](https://github.com/kitaisreal))。
- 添加了函数 `dictGetOrNull`。它的工作方式类似于 `dictGet`,但在字典中未找到键时返回 `Null`。关闭 [#22375](https://github.com/ClickHouse/ClickHouse/issues/22375)。[#22413](https://github.com/ClickHouse/ClickHouse/pull/22413) ([Maksim Kita](https://github.com/kitaisreal))。
- 添加了表函数 `s3Cluster`,允许在指定集群的每个节点上并行处理来自 `s3` 的文件。[#22012](https://github.com/ClickHouse/ClickHouse/pull/22012) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 在 MySQL/PostgreSQL 表引擎/表函数中添加了对副本和分片的支持。您可以编写 `SELECT * FROM mysql('host{1,2}-{1|2}', ...)`。关闭 [#20969](https://github.com/ClickHouse/ClickHouse/issues/20969)。[#22217](https://github.com/ClickHouse/ClickHouse/pull/22217) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 添加了 `ALTER TABLE ... FETCH PART ...` 查询。它类似于 `FETCH PARTITION`,但只获取单个数据部分。[#22706](https://github.com/ClickHouse/ClickHouse/pull/22706) ([turbo jason](https://github.com/songenjie))。
- 添加了设置 `max_distributed_depth`,用于限制对 `Distributed` 表的递归查询深度。关闭 [#20229](https://github.com/ClickHouse/ClickHouse/issues/20229)。[#21942](https://github.com/ClickHouse/ClickHouse/pull/21942) ([flynn](https://github.com/ucasFL))。


#### 性能改进 {#performance-improvement-6}

- 通过为 AVX2 实现动态分发,提升了 `intDiv` 的性能。此更改解决了 [#22314](https://github.com/ClickHouse/ClickHouse/issues/22314)。[#23000](https://github.com/ClickHouse/ClickHouse/pull/23000) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 提升了从 `ArrowStream` 输入格式读取非本地文件源(例如 URL)的性能。[#22673](https://github.com/ClickHouse/ClickHouse/pull/22673) ([nvartolomei](https://github.com/nvartolomei))。
- 通过原生协议与 localhost 交互时(使用 clickhouse-client 或分布式查询中的服务器间通信),默认禁用压缩。这可能会提升某些导入/导出操作的性能。此更改解决了 [#22234](https://github.com/ClickHouse/ClickHouse/issues/22234)。[#22237](https://github.com/ClickHouse/ClickHouse/pull/22237) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 在分布式查询中,从 IN 子句的右侧部分排除不属于该分片的值(在 `optimize_skip_unused_shards_rewrite_in` 设置下,默认启用,但仍需要 `optimize_skip_unused_shards`)。[#21511](https://github.com/ClickHouse/ClickHouse/pull/21511) ([Azat Khuzhin](https://github.com/azat))。
- 提升了使用类文件表引擎和列式格式(如 Parquet、Arrow 或 ORC)读取列子集的性能。此更改解决了 [#issue:20129](https://github.com/ClickHouse/ClickHouse/issues/20129)。[#21302](https://github.com/ClickHouse/ClickHouse/pull/21302) ([keenwolf](https://github.com/keen-wolf))。
- 允许将更多条件移动到 `PREWHERE`,恢复到 21.1 版本之前的行为(调整了内部启发式算法)。移动的条件数量不足可能导致性能下降。[#23397](https://github.com/ClickHouse/ClickHouse/pull/23397) ([Anton Popov](https://github.com/CurtizJ))。
- 提升了 ODBC 连接的性能,并修复了积压的所有未解决问题。使用 `nanodbc` 库替代 `Poco::ODBC`。解决了 [#9678](https://github.com/ClickHouse/ClickHouse/issues/9678)。为 ODBC 表引擎添加了对 DateTime64 和 Decimal\* 的支持。解决了 [#21961](https://github.com/ClickHouse/ClickHouse/issues/21961)。修复了西里尔文本被截断的问题。解决了 [#16246](https://github.com/ClickHouse/ClickHouse/issues/16246)。为 ODBC bridge 添加了连接池。[#21972](https://github.com/ClickHouse/ClickHouse/pull/21972) ([Kseniia Sumarokova](https://github.com/kssenii))。

#### 改进 {#improvement-6}


* 将 `max_uri_size`（HTTP 接口中 URL 的最大长度）的默认值提升到 1 MiB。由此关闭了 [#21197](https://github.com/ClickHouse/ClickHouse/issues/21197)。[#22997](https://github.com/ClickHouse/ClickHouse/pull/22997)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 将 `background_fetches_pool_size` 设置为 `8`，在存在频繁小批量插入或 ZooKeeper 集群较慢的生产环境中效果更佳。 [#22945](https://github.com/ClickHouse/ClickHouse/pull/22945) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* FlatDictionary 新增了 `initial_array_size` 和 `max_array_size` 选项。[#22521](https://github.com/ClickHouse/ClickHouse/pull/22521)（[Maksim Kita](https://github.com/kitaisreal)）。
* 为非复制 MergeTree 表的插入去重新增设置 `non_replicated_deduplication_window`。 [#22514](https://github.com/ClickHouse/ClickHouse/pull/22514) ([alesapin](https://github.com/alesapin)).
* 在配置重新加载时更新 `CatBoost` 模型配置的路径。[#22434](https://github.com/ClickHouse/ClickHouse/pull/22434) ([Kruglov Pavel](https://github.com/Avogar))。
* 在字典中新增了对 `Decimal256` 类型的支持。`Decimal256` 是一个实验性特性。关闭 [#20979](https://github.com/ClickHouse/ClickHouse/issues/20979)。[#22960](https://github.com/ClickHouse/ClickHouse/pull/22960)（[Maksim Kita](https://github.com/kitaisreal)）。
* 默认启用 `async_socket_for_remote`（分布式查询将使用更少的 OS 线程）。 [#23683](https://github.com/ClickHouse/ClickHouse/pull/23683) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复了 `quantile(s)TDigest`。根据 tdunning/t-digest 3.2+ 增加了对单个质心的特殊处理。同时修复了该算法早期版本实现中质心过度压缩的缺陷。[#23314](https://github.com/ClickHouse/ClickHouse/pull/23314)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* 使函数名 `unhex` 不区分大小写，以兼容 MySQL。[#23229](https://github.com/ClickHouse/ClickHouse/pull/23229) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 为 `arrayHasAny`、`arrayHasAll`、`has`、`indexOf`、`countEqual` 等函数实现了对数组元素类型不同的通用场景的支持。在之前的版本中,`arrayHasAny`、`arrayHasAll` 函数会返回 false,而 `has`、`indexOf`、`countEqual` 函数会抛出异常。同时为 `has` 及类似函数添加了对 `Decimal` 和大整数类型的支持。此更改解决了 [#20272](https://github.com/ClickHouse/ClickHouse/issues/20272)。[#23044](https://github.com/ClickHouse/ClickHouse/pull/23044) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 提高了函数 `extractAllGroupsHorizontal` 结果中最大匹配数量的阈值。[#23036](https://github.com/ClickHouse/ClickHouse/pull/23036) ([Vasily Nemkov](https://github.com/Enmk))。
* 不要在只有一个节点的集群上执行 `optimize_skip_unused_shards`。 [#22999](https://github.com/ClickHouse/ClickHouse/pull/22999) ([Azat Khuzhin](https://github.com/azat)).
* 新增支持使用 SSL 运行 clickhouse-keeper（ZooKeeper 的实验性可直接替换方案）。可以使用配置项 `keeper_server.tcp_port_secure` 实现客户端与 keeper-server 之间的安全交互。`keeper_server.raft_configuration.secure` 可用于启用节点之间的内部安全通信。[#22992](https://github.com/ClickHouse/ClickHouse/pull/22992) ([alesapin](https://github.com/alesapin))。
* 为 `Buffer` 表新增了仅在后台刷新缓冲区的功能。 [#22986](https://github.com/ClickHouse/ClickHouse/pull/22986) ([Azat Khuzhin](https://github.com/azat)).
* 当从 MergeTree 表中查询且 WHERE 条件包含 NULL 时,在极少数情况下会抛出异常。此问题已修复,关闭了 [#20019](https://github.com/ClickHouse/ClickHouse/issues/20019)。[#22978](https://github.com/ClickHouse/ClickHouse/pull/22978) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复用于 AWS 的 Poco HTTP 客户端中的错误处理。[#22973](https://github.com/ClickHouse/ClickHouse/pull/22973) ([kreuzerkrieg](https://github.com/kreuzerkrieg))。
* 对 `ReplicatedMergeTree` 生效 `max_part_removal_threads` 设置。[#22971](https://github.com/ClickHouse/ClickHouse/pull/22971) ([Azat Khuzhin](https://github.com/azat))。
* 修复 MergeTree 设置中，当 `inactive_parts_to_throw_insert = 0` 且 `inactive_parts_to_delay_insert &gt; 0` 时出现的一个较为隐蔽的边缘情况。 [#22947](https://github.com/ClickHouse/ClickHouse/pull/22947) ([Azat Khuzhin](https://github.com/azat)).
* `dateDiff` 现在支持 `DateTime64` 参数（即使值超出 `DateTime` 的范围）[#22931](https://github.com/ClickHouse/ClickHouse/pull/22931)（[Vasily Nemkov](https://github.com/Enmk)）。
* MaterializeMySQL（实验特性）：新增了对包含视图的 MySQL 数据库进行复制且不会失败的能力。其实现方式是忽略这些视图。 [#22760](https://github.com/ClickHouse/ClickHouse/pull/22760) ([Christian](https://github.com/cfroystad)).
* 允许通过 PostgreSQL 协议使用 RBAC 行级策略。修复了 [#22658](https://github.com/ClickHouse/ClickHouse/issues/22658)。PostgreSQL 协议在配置中默认启用。[#22755](https://github.com/ClickHouse/ClickHouse/pull/22755)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 添加指标以跟踪等待 Buffer 层锁所花费的时间。[#22725](https://github.com/ClickHouse/ClickHouse/pull/22725) ([Azat Khuzhin](https://github.com/azat)).
* 允许在 VIEW 定义中使用 CTE。已关闭 [#22491](https://github.com/ClickHouse/ClickHouse/issues/22491)。[#22657](https://github.com/ClickHouse/ClickHouse/pull/22657)（[Amos Bird](https://github.com/amosbird)）。
* 如果之前的程序在终端中留下了杂乱输出，则在 `clickhouse-client` 中清理屏幕剩余部分并重新显示光标。此更改关闭了 [#16518](https://github.com/ClickHouse/ClickHouse/issues/16518)。[#22634](https://github.com/ClickHouse/ClickHouse/pull/22634)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 让 `round` 函数在非 x86&#95;64 平台上的行为保持一致。采用“四舍六入，五取偶”（银行家舍入法）。[#22582](https://github.com/ClickHouse/ClickHouse/pull/22582)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 正确检查由 Distributed 表发送的数据块的结构。[#22325](https://github.com/ClickHouse/ClickHouse/pull/22325)（[Azat Khuzhin](https://github.com/azat)）。
* 允许在 Kafka 引擎的虚拟列中记录 Kafka 错误，由 `kafka_handle_error_mode` 设置控制。 [#21850](https://github.com/ClickHouse/ClickHouse/pull/21850) ([fastio](https://github.com/fastio)).
* 为 `visitParam/visitParamExtract{UInt, Int, Bool, Float, Raw, String}` 添加别名 `simpleJSONExtract/simpleJSONHas`。修复 [#21383](https://github.com/ClickHouse/ClickHouse/issues/21383)。[#21519](https://github.com/ClickHouse/ClickHouse/pull/21519)（[fastio](https://github.com/fastio)）。
* 为库字典源添加了 `clickhouse-library-bridge`。解决了 [#9502](https://github.com/ClickHouse/ClickHouse/issues/9502)。[#21509](https://github.com/ClickHouse/ClickHouse/pull/21509)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 禁止删除被物化视图引用的列。解决 [#21164](https://github.com/ClickHouse/ClickHouse/issues/21164)。 [#21303](https://github.com/ClickHouse/ClickHouse/pull/21303) ([flynn](https://github.com/ucasFL))。
* 支持动态的服务器间凭证（在不停机的情况下轮换凭证）。 [#14113](https://github.com/ClickHouse/ClickHouse/pull/14113) ([johnskopis](https://github.com/johnskopis)).
* 为 Kafka 存储添加对 `Arrow` 和 `ArrowStream` 格式消息的支持。 [#23415](https://github.com/ClickHouse/ClickHouse/pull/23415) ([Chao Ma](https://github.com/godliness))。
* 修复了异常消息中缺失的分号。用户可能会发现此异常消息的可读性不佳。[#23208](https://github.com/ClickHouse/ClickHouse/pull/23208) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了某些与 `LowCardinality` 类型相关的异常消息中缺失空格的问题。[#23207](https://github.com/ClickHouse/ClickHouse/pull/23207) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 在 `Markdown` 格式的表格单元格中，部分值曾被设置为居中对齐，现在已不再如此。[#23096](https://github.com/ClickHouse/ClickHouse/pull/23096) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 移除 `clickhouse-client` 中补全建议的非关键细节。修复了 [#22158](https://github.com/ClickHouse/ClickHouse/issues/22158)。[#23040](https://github.com/ClickHouse/ClickHouse/pull/23040)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 `system.dictionaries` 中为 `sparse_hashed` 字典正确计算 `bytes_allocated` 字段。[#22867](https://github.com/ClickHouse/ClickHouse/pull/22867) ([Azat Khuzhin](https://github.com/azat)).
* 修复了 `MergeTree` 在反向读取时对近似总行数的统计。 [#22726](https://github.com/ClickHouse/ClickHouse/pull/22726) ([Azat Khuzhin](https://github.com/azat)).
* 修复了这样一种情况：可以配置一个使用 `clickhouse` 源、并将自身作为数据源的字典，从而导致无限循环。关闭了 [#14314](https://github.com/ClickHouse/ClickHouse/issues/14314)。[#22479](https://github.com/ClickHouse/ClickHouse/pull/22479)（[Maksim Kita](https://github.com/kitaisreal)）。

#### 错误修复 {#bug-fix-5}


* 对 hedged 请求进行了多项修复。修复了在启用 `use_hedged_requests` 设置时，带有 `GLOBAL IN/JOIN` 的查询出现错误 `Can't initialize pipeline with empty pipe` 的问题。修复了 [#23431](https://github.com/ClickHouse/ClickHouse/issues/23431)。[#23805](https://github.com/ClickHouse/ClickHouse/pull/23805)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。修复了 hedged 连接中的竞争条件，该问题会导致崩溃。修复了 [#22161](https://github.com/ClickHouse/ClickHouse/issues/22161)。[#22443](https://github.com/ClickHouse/ClickHouse/pull/22443)（[Kruglov Pavel](https://github.com/Avogar)）。修复了在启用 `async_socket_for_remote` 的情况下，从远程查询接收到 `unknown packet` 时可能发生的崩溃。修复了 [#21167](https://github.com/ClickHouse/ClickHouse/issues/21167)。[#23309](https://github.com/ClickHouse/ClickHouse/pull/23309)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在禁用 `input_format_with_names_use_header` 设置时会丢弃所有 CSVWithNames 格式输入数据的行为。此更改修复了 [#22406](https://github.com/ClickHouse/ClickHouse/issues/22406)。 [#23202](https://github.com/ClickHouse/ClickHouse/pull/23202) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 修复了远程 JDBC bridge 连接超时问题。修复了 [#9609](https://github.com/ClickHouse/ClickHouse/issues/9609)。[#23771](https://github.com/ClickHouse/ClickHouse/pull/23771)（[Maksim Kita](https://github.com/kitaisreal)、[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在指定 `update_field` 时 `complex_key_hashed` 的初始加载逻辑。解决 [#23800](https://github.com/ClickHouse/ClickHouse/issues/23800)。[#23824](https://github.com/ClickHouse/ClickHouse/pull/23824)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复了在 `PREWHERE` 和行策略过滤器同时生效且结果为空时出现的崩溃。[#23763](https://github.com/ClickHouse/ClickHouse/pull/23763)（[Amos Bird](https://github.com/amosbird)）。
* 避免在向 Distributed 表执行 INSERT 操作时可能出现的&quot;Cannot schedule a task&quot;错误(当发生某些异常时)。[#23744](https://github.com/ClickHouse/ClickHouse/pull/23744) ([Azat Khuzhin](https://github.com/azat))。
* 在聚合函数 `mannWhitneyUTest` 中，当两个样本的值完全相同时新增了一个异常。这修复了 [#23646](https://github.com/ClickHouse/ClickHouse/issues/23646)。[#23654](https://github.com/ClickHouse/ClickHouse/pull/23654)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 修复了通过 HTTP 插入数据时因异常导致的服务器故障。此问题修复自 [#23512](https://github.com/ClickHouse/ClickHouse/issues/23512)。[#23643](https://github.com/ClickHouse/ClickHouse/pull/23643)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 修复了某些包含转义序列的 `LIKE` 表达式被错误解析的问题。 [#23610](https://github.com/ClickHouse/ClickHouse/pull/23610) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复了 `restart` / `stop` 命令卡住的问题。关闭 [#20214](https://github.com/ClickHouse/ClickHouse/issues/20214)。[#23552](https://github.com/ClickHouse/ClickHouse/pull/23552) ([filimonov](https://github.com/filimonov))。
* 修复了在 `SELECT` 查询中包含多个 `JOIN` 时的 `COLUMNS` 匹配器。关闭了 [#22736](https://github.com/ClickHouse/ClickHouse/issues/22736)。[#23501](https://github.com/ClickHouse/ClickHouse/pull/23501)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复了在列本身被用作 `ReplacingMergeTree` 参数时，修改该列默认值会导致崩溃的问题。 [#23483](https://github.com/ClickHouse/ClickHouse/pull/23483) ([hexiaoting](https://github.com/hexiaoting)).
* 修复了在使用 `ReplacingMergeTree` 进行垂直合并时的一些边界情况。在极少数情况下，这些问题可能导致合并失败，并抛出类似 `Incomplete granules are not allowed while blocks are granules size` 的异常。 [#23459](https://github.com/ClickHouse/ClickHouse/pull/23459) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了一个错误，该错误导致无法将空数组字面量转换为维度大于 1 的数组，例如 `CAST([] AS Array(Array(String)))`。修复了 [#14476](https://github.com/ClickHouse/ClickHouse/issues/14476)。[#23456](https://github.com/ClickHouse/ClickHouse/pull/23456)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复了在重置计数器后，`deltaSum` 聚合函数产生错误结果的问题。[#23437](https://github.com/ClickHouse/ClickHouse/pull/23437) ([Russ Frank](https://github.com/rf))。
* 修复了在使用多磁盘配置创建 `ReplicatedMergeTree` 表失败时出现的 `Cannot unlink file` 错误。此更改解决了 [#21755](https://github.com/ClickHouse/ClickHouse/issues/21755)。[#23433](https://github.com/ClickHouse/ClickHouse/pull/23433)（[tavplubix](https://github.com/tavplubix)）。
* 修复了基于虚拟列在分区裁剪过程中生成不兼容常量表达式的问题。此修复对应 [https://github.com/ClickHouse/ClickHouse/pull/21401#discussion&#95;r611888913](https://github.com/ClickHouse/ClickHouse/pull/21401#discussion_r611888913)。 [#23366](https://github.com/ClickHouse/ClickHouse/pull/23366) ([Amos Bird](https://github.com/amosbird)).
* 修复了在将 join&#95;algorithm 设置为 &#39;auto&#39; 并使用 Dictionary 执行 Join 时发生的崩溃问题。已关闭 [#23002](https://github.com/ClickHouse/ClickHouse/issues/23002)。[#23312](https://github.com/ClickHouse/ClickHouse/pull/23312)（[Vladimir](https://github.com/vdimir)）。
* 在分区裁剪期间不要放宽 `NOT` 条件。修复了 [#23305](https://github.com/ClickHouse/ClickHouse/issues/23305) 和 [#21539](https://github.com/ClickHouse/ClickHouse/issues/21539)。[#23310](https://github.com/ClickHouse/ClickHouse/pull/23310)（[Amos Bird](https://github.com/amosbird)）。
* 修复了在后台清理旧数据块时极少出现的竞态条件。如果数据块距离去重窗口的结束位置过近，该问题可能会导致该数据块未被去重。[#23301](https://github.com/ClickHouse/ClickHouse/pull/23301) ([tavplubix](https://github.com/tavplubix)).
* 修复了在创建和删除 `ReplicatedMergeTree` 表之间出现的极少见（分布式）竞态条件。该问题可能在尝试创建复制表时导致 `node doesn't exist` 等异常。修复了 [#21419](https://github.com/ClickHouse/ClickHouse/issues/21419)。[#23294](https://github.com/ClickHouse/ClickHouse/pull/23294)（[tavplubix](https://github.com/tavplubix)）。
* 修复了通过 DDL 创建简单键字典时，如果主键不是第一个属性所导致的问题。修复了 [#23236](https://github.com/ClickHouse/ClickHouse/issues/23236)。[#23262](https://github.com/ClickHouse/ClickHouse/pull/23262)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复了在表中包含许多长列名时通过 ODBC 读取数据的问题。关闭了 [#8853](https://github.com/ClickHouse/ClickHouse/issues/8853)。[#23215](https://github.com/ClickHouse/ClickHouse/pull/23215)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* MaterializeMySQL（实验特性）：修复了在对键列添加条件、从 `MaterializeMySQL` 查询时出现的 `Not found column` 错误。修复了 [#22432](https://github.com/ClickHouse/ClickHouse/issues/22432)。[#23200](https://github.com/ClickHouse/ClickHouse/pull/23200)（[tavplubix](https://github.com/tavplubix)）。
* 在子查询被优化为常量时，正确处理别名。修复 [#22924](https://github.com/ClickHouse/ClickHouse/issues/22924)。修复 [#10401](https://github.com/ClickHouse/ClickHouse/issues/10401)。[#23191](https://github.com/ClickHouse/ClickHouse/pull/23191)（[Maksim Kita](https://github.com/kitaisreal)）。
* 如果在默认配置文件中启用了 `data_type_default_nullable` 设置，服务器可能无法启动，该问题已修复。修复了 [#22573](https://github.com/ClickHouse/ClickHouse/issues/22573)。[#23185](https://github.com/ClickHouse/ClickHouse/pull/23185)（[tavplubix](https://github.com/tavplubix)）。
* 修复了由于当前连接数统计错误导致的关闭时崩溃问题。[#23154](https://github.com/ClickHouse/ClickHouse/pull/23154) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复了在将物化视图从 Atomic 数据库分离并重新附加后，对该物化视图执行 `SELECT` 时出现的 `Table .inner_id... doesn't exist` 错误。[#23047](https://github.com/ClickHouse/ClickHouse/pull/23047) ([tavplubix](https://github.com/tavplubix))。
* 修复在子查询中使用 `untuple` 时可能出现的错误 `Cannot find column in ActionsDAG result`。修复了 [#22290](https://github.com/ClickHouse/ClickHouse/issues/22290)。[#22991](https://github.com/ClickHouse/ClickHouse/pull/22991)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复带可为空值的 `Map` 类型常量列的使用问题。[#22939](https://github.com/ClickHouse/ClickHouse/pull/22939)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复了 `DateTime64` 上 `formatDateTime()` 与 &quot;%C&quot; 格式说明符的问题，并修复了在处理大数值和非零 scale 时的 `toDateTime64()`。 [#22937](https://github.com/ClickHouse/ClickHouse/pull/22937) ([Vasily Nemkov](https://github.com/Enmk)).
* 修复了将 `mannWhitneyUTest` 和 `rankCorr` 与窗口函数一起使用时发生的崩溃问题。此修复解决了 [#22728](https://github.com/ClickHouse/ClickHouse/issues/22728)。[#22876](https://github.com/ClickHouse/ClickHouse/pull/22876)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* LIVE VIEW（实验特性）：修复了在 `TemporaryLiveViewCleaner` 中对 TEMPORARY LIVE VIEW 并发执行 DROP/CREATE 时可能出现的卡死问题，[参见](https://gist.github.com/vzakaznikov/0c03195960fc86b56bfe2bc73a90019e)。[#22858](https://github.com/ClickHouse/ClickHouse/pull/22858)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 在使用过滤列进行聚合时，修复了 `HAVING` 子句下推的问题。[#22763](https://github.com/ClickHouse/ClickHouse/pull/22763) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了在出现 OOM 异常时 Zookeeper 请求可能发生挂起的问题。修复 [#22438](https://github.com/ClickHouse/ClickHouse/issues/22438)。[#22684](https://github.com/ClickHouse/ClickHouse/pull/22684)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了 `ReplicatedMergeTree` 表引擎在多个副本上等待变更操作的机制。此前，`mutation`/`alter` 查询可能会在变更实际在其他副本上执行完毕之前就结束。[#22669](https://github.com/ClickHouse/ClickHouse/pull/22669)（[alesapin](https://github.com/alesapin)）。
* 修复了在 `SELECT` 子句中未选择任何列时，`Log` 中包含嵌套类型所导致的异常。[#22654](https://github.com/ClickHouse/ClickHouse/pull/22654) ([Azat Khuzhin](https://github.com/azat)).
* 修复辅助 AWS 请求无限等待的问题。[#22594](https://github.com/ClickHouse/ClickHouse/pull/22594)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* 修复了在客户端过早关闭连接时发生的崩溃问题 [#22579](https://github.com/ClickHouse/ClickHouse/issues/22579)。[#22591](https://github.com/ClickHouse/ClickHouse/pull/22591)（[nvartolomei](https://github.com/nvartolomei)）。
* `Map` 数据类型(实验性功能):修复了分布式查询中 `map` 函数格式化错误的问题。[#22588](https://github.com/ClickHouse/ClickHouse/pull/22588) ([foolchi](https://github.com/foolchi))。
* 修复了在 TSV 格式中对末尾没有换行符的空字符串的反序列化问题。该修复关闭了 [#20244](https://github.com/ClickHouse/ClickHouse/issues/20244)。在不升级版本的情况下，可采用如下变通方案：将 `input_format_null_as_default` 设置为 0。在旧版本中它的默认值为 0。[#22527](https://github.com/ClickHouse/ClickHouse/pull/22527) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了在 Merge Join 算法中对 `LowCardinality` 类型列的错误类型转换。关闭 [#22386](https://github.com/ClickHouse/ClickHouse/issues/22386)，关闭 [#22388](https://github.com/ClickHouse/ClickHouse/issues/22388)。[#22510](https://github.com/ClickHouse/ClickHouse/pull/22510)（[Vladimir](https://github.com/vdimir)）。
* 在 `tokenbf_v1` 全文索引中，读取时可能发生缓冲区溢出。多余的字节不会被使用，但读取操作在极少数情况下可能导致崩溃。此更改关闭了 [#19233](https://github.com/ClickHouse/ClickHouse/issues/19233)。[#22421](https://github.com/ClickHouse/ClickHouse/pull/22421)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 不再限制 HTTP 分块大小。修复 [#21907](https://github.com/ClickHouse/ClickHouse/issues/21907)。[#22322](https://github.com/ClickHouse/ClickHouse/pull/22322)（[Ivan](https://github.com/abyss7)）。
* 修复了一个错误：当启用 `optimize_aggregation_in_order` 且表中存在大量数据分片时，会导致数据聚合不完整。同时略微提升了启用 `optimize_aggregation_in_order` 时的聚合性能。[#21889](https://github.com/ClickHouse/ClickHouse/pull/21889) ([Anton Popov](https://github.com/CurtizJ))。
* 检查是否将表函数 view 用作列。这是对 #20350 的补充。[#21465](https://github.com/ClickHouse/ClickHouse/pull/21465) ([Amos Bird](https://github.com/amosbird))。
* 修复在包含 `JOIN` 和聚合的查询中，使用 `Merge` 引擎的表出现的“unknown column”错误。修复 [#18368](https://github.com/ClickHouse/ClickHouse/issues/18368)、[#22226](https://github.com/ClickHouse/ClickHouse/issues/22226)。[#21370](https://github.com/ClickHouse/ClickHouse/pull/21370)（[Vladimir](https://github.com/vdimir)）。
* 修复了下推优化中的名称冲突问题。该问题会在执行 FULL JOIN 后导致错误的 `WHERE` 过滤。关闭 [#20497](https://github.com/ClickHouse/ClickHouse/issues/20497)。[#20622](https://github.com/ClickHouse/ClickHouse/pull/20622) ([Vladimir](https://github.com/vdimir))。
* 修复了一个极其罕见的错误：在设置 `quorum_parallel=1` 时，由于去重导致 quorum 插入实际上并不是真正的“quorum”。[#18215](https://github.com/ClickHouse/ClickHouse/pull/18215)（[filimonov](https://github.com/filimonov) - 报告，[alesapin](https://github.com/alesapin) - 修复）。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-6}

- 在 CI 中并行运行无状态测试。[#22300](https://github.com/ClickHouse/ClickHouse/pull/22300) ([alesapin](https://github.com/alesapin))。
- 简化 Debian 软件包。此更改修复了 [#21698](https://github.com/ClickHouse/ClickHouse/issues/21698)。[#22976](https://github.com/ClickHouse/ClickHouse/pull/22976) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 新增对 Apple M1 上构建 ClickHouse 的支持。[#21639](https://github.com/ClickHouse/ClickHouse/pull/21639) ([changvvb](https://github.com/changvvb))。
- 修复了 macOS 上 ClickHouse Keeper 的构建问题。[#22860](https://github.com/ClickHouse/ClickHouse/pull/22860) ([alesapin](https://github.com/alesapin))。
- 修复了 AArch64 平台上的部分测试。[#22596](https://github.com/ClickHouse/ClickHouse/pull/22596) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 新增函数对齐以提升性能。[#21431](https://github.com/ClickHouse/ClickHouse/pull/21431) ([Danila Kutenin](https://github.com/danlark1))。
- 调整部分测试以在 amd64 和 aarch64 (qemu) 上输出一致的结果。之前的结果依赖于特定实现的 CPU 行为。[#22590](https://github.com/ClickHouse/ClickHouse/pull/22590) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 仅允许在 x86_64 上进行查询性能分析。参见 [#15174](https://github.com/ClickHouse/ClickHouse/issues/15174#issuecomment-812954965) 和 [#15638](https://github.com/ClickHouse/ClickHouse/issues/15638#issuecomment-703805337)。此更改关闭了 [#15638](https://github.com/ClickHouse/ClickHouse/issues/15638)。[#22580](https://github.com/ClickHouse/ClickHouse/pull/22580) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 允许使用 `USE_INTERNAL_XZ_LIBRARY=OFF` CMake 选项以非捆绑的 xz (lzma) 进行构建。[#22571](https://github.com/ClickHouse/ClickHouse/pull/22571) ([Kfir Itzhak](https://github.com/mastertheknife))。
- 在 `ppc64le` 上启用捆绑的 `openldap` [#22487](https://github.com/ClickHouse/ClickHouse/pull/22487) ([Kfir Itzhak](https://github.com/mastertheknife))。
- 在 `ppc64le` 上禁用不兼容的库(通常是平台特定的) [#22475](https://github.com/ClickHouse/ClickHouse/pull/22475) ([Kfir Itzhak](https://github.com/mastertheknife))。
- 在 CI 中为 ClickHouse Keeper 新增 Jepsen 测试。[#22373](https://github.com/ClickHouse/ClickHouse/pull/22373) ([alesapin](https://github.com/alesapin))。
- 构建支持[堆性能分析](https://github.com/jemalloc/jemalloc/wiki/Use-Case%3A-Heap-Profiling)的 `jemalloc`。[#22834](https://github.com/ClickHouse/ClickHouse/pull/22834) ([nvartolomei](https://github.com/nvartolomei))。
- 避免 `*Log` 引擎中因从其他线程解锁读写锁而导致的未定义行为。[#22583](https://github.com/ClickHouse/ClickHouse/pull/22583) ([Azat Khuzhin](https://github.com/azat))。
- 通过从同一线程解锁 TinyLog 的读写锁修复了未定义行为。[#22560](https://github.com/ClickHouse/ClickHouse/pull/22560) ([Azat Khuzhin](https://github.com/azat))。


## ClickHouse 版本 21.4 {#clickhouse-release-214}

### ClickHouse 版本 21.4.1 2021-04-12 {#clickhouse-release-2141-2021-04-12}

#### 向后不兼容的变更 {#backward-incompatible-change-7}

- `toStartOfIntervalFunction` 函数现在会将小时间隔对齐到午夜(在之前的版本中它们对齐到 Unix 纪元的起始时间)。例如,`toStartOfInterval(x, INTERVAL 11 HOUR)` 会将每天分割为三个间隔:`00:00:00..10:59:59`、`11:00:00..21:59:59` 和 `22:00:00..23:59:59`。这种行为更符合实际需求。此变更关闭了 [#9510](https://github.com/ClickHouse/ClickHouse/issues/9510)。[#22060](https://github.com/ClickHouse/ClickHouse/pull/22060) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- Graphite 汇总配置中的 `Age` 和 `Precision` 应该从一个保留期到下一个保留期递增。现在会进行检查,错误的配置会引发异常。[#21496](https://github.com/ClickHouse/ClickHouse/pull/21496) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- 修复了 `cutToFirstSignificantSubdomainCustom()`/`firstSignificantSubdomainCustom()` 对于自定义顶级域名列表中存在的 3 级及以上域名返回错误结果的问题。对于匹配这些自定义顶级域名的输入域名,三级域名被认为是第一个有效域名。此问题现已修复。如果该函数用于分片键等场景,此变更可能会引入不兼容性。[#21946](https://github.com/ClickHouse/ClickHouse/pull/21946) ([Azat Khuzhin](https://github.com/azat))。
- `system.dictionaries` 表中的 `keys` 列已被替换为 `key.names` 和 `key.types` 列。`system.dictionaries` 表中的 `key.names`、`key.types`、`attribute.names`、`attribute.types` 列不再要求字典必须被加载。[#21884](https://github.com/ClickHouse/ClickHouse/pull/21884) ([Maksim Kita](https://github.com/kitaisreal))。
- 现在处理 `ALTER TABLE ATTACH PART[ITION]` 命令的副本会在从其他副本获取数据之前先在其 `detached/` 文件夹中搜索。作为实现细节,在复制日志中引入了一个新命令 `ATTACH_PART`。数据分片通过其校验和进行搜索和比较。[#18978](https://github.com/ClickHouse/ClickHouse/pull/18978) ([Mike Kot](https://github.com/myrrc))。**注意**:
  - `ATTACH PART[ITION]` 查询在集群升级期间可能无法正常工作。
  - 在新版本中执行 `ALTER ... ATTACH` 查询后,无法回滚到旧版本的 ClickHouse,因为旧服务器无法处理复制日志中的 `ATTACH_PART` 条目。
- 在此版本中,空的 `<remote_url_allow_hosts></remote_url_allow_hosts>` 将阻止所有对远程主机的访问,而在之前的版本中它不起作用。如果您想保持旧的行为,并且配置文件中有空的 `remote_url_allow_hosts` 元素,请将其删除。[#20058](https://github.com/ClickHouse/ClickHouse/pull/20058) ([Vladimir Chebotarev](https://github.com/excitoon))。

#### 新功能 {#new-feature-7}


* 将 `DateTime64` 的取值范围扩展为支持 1925 年到 2283 年之间的日期。改进了接近零日期（`1970-01-01`）时的 `DateTime` 支持。[#9404](https://github.com/ClickHouse/ClickHouse/pull/9404) ([alexey-milovidov](https://github.com/alexey-milovidov), [Vasily Nemkov](https://github.com/Enmk))。并非所有时间和日期函数都能在扩展后的日期范围内正常工作。
* 为预配置用户和 HTTP 请求（GSS-SPNEGO）增加了对 Kerberos 认证的支持。 [#14995](https://github.com/ClickHouse/ClickHouse/pull/14995) ([Denis Glazachev](https://github.com/traceon)).
* 添加 `prefer_column_name_to_alias` 设置，以使用原始列名而不是别名，以便与常见数据库的别名规则更加兼容。此更改对应 [#9715](https://github.com/ClickHouse/ClickHouse/issues/9715) 和 [#9887](https://github.com/ClickHouse/ClickHouse/issues/9887)。[#22044](https://github.com/ClickHouse/ClickHouse/pull/22044)（[Amos Bird](https://github.com/amosbird)）。
* 新增函数 `dictGetChildren(dictionary, key)`、`dictGetDescendants(dictionary, key, level)`。函数 `dictGetChildren` 以数组形式返回所有子节点的索引，是 `dictGetHierarchy` 的逆变换。函数 `dictGetDescendants` 返回在递归调用 `dictGetChildren` `level` 次后得到的所有后代节点。`level` 为零等价于无穷大。修复 [#14656](https://github.com/ClickHouse/ClickHouse/issues/14656)。[#22096](https://github.com/ClickHouse/ClickHouse/pull/22096)（[Maksim Kita](https://github.com/kitaisreal)）。
* 新增了 `executable_pool` 字典来源。关闭 [#14528](https://github.com/ClickHouse/ClickHouse/issues/14528)。[#21321](https://github.com/ClickHouse/ClickHouse/pull/21321)（[Maksim Kita](https://github.com/kitaisreal)）。
* 新增了表函数 `dictionary`，其工作方式与 `Dictionary` 引擎相同。修复了 [#21560](https://github.com/ClickHouse/ClickHouse/issues/21560)。[#21910](https://github.com/ClickHouse/ClickHouse/pull/21910)（[Maksim Kita](https://github.com/kitaisreal)）。
* 为 `PolygonDictionary` 属性添加对 `Nullable` 类型的支持。 [#21890](https://github.com/ClickHouse/ClickHouse/pull/21890) ([Maksim Kita](https://github.com/kitaisreal)).
* 函数 `dictGet` 和 `dictHas` 对于通过 DDL 创建、且未指定数据库名的字典，会使用当前数据库名。修复了 [#21632](https://github.com/ClickHouse/ClickHouse/issues/21632)。[#21859](https://github.com/ClickHouse/ClickHouse/pull/21859)（[Maksim Kita](https://github.com/kitaisreal)）。
* 新增了函数 `dictGetOrNull`。其行为与 `dictGet` 类似，但在字典中未找到键时返回 `Null`。修复 [#22375](https://github.com/ClickHouse/ClickHouse/issues/22375)。[#22413](https://github.com/ClickHouse/ClickHouse/pull/22413)（[Maksim Kita](https://github.com/kitaisreal)）。
* 在 `ComplexKeyCache`、`SSDCache`、`SSDComplexKeyCache` 字典中新增了异步更新功能。在 `Cache`、`ComplexKeyCache`、`SSDCache`、`SSDComplexKeyCache` 字典中新增了对 `Nullable` 类型的支持。为 `dictGet`、`dictGetOrDefault` 函数新增了多属性获取支持。修复了 [#21517](https://github.com/ClickHouse/ClickHouse/issues/21517)。[#20595](https://github.com/ClickHouse/ClickHouse/pull/20595)（[Maksim Kita](https://github.com/kitaisreal)）。
* 为 `RangeHashedDictionary` 添加对 `dictHas` 函数的支持。修复 [#6680](https://github.com/ClickHouse/ClickHouse/issues/6680)。[#19816](https://github.com/ClickHouse/ClickHouse/pull/19816) ([Maksim Kita](https://github.com/kitaisreal))。
* 新增函数 `timezoneOf`，用于返回 `DateTime` 或 `DateTime64` 数据类型的时区名称。此更改并未关闭 [#9959](https://github.com/ClickHouse/ClickHouse/issues/9959)。修复函数命名中的不一致之处：新增别名 `timezone` 和 `timeZone`，以及 `toTimezone` 和 `toTimeZone`、`timezoneOf` 和 `timeZoneOf`。[#22001](https://github.com/ClickHouse/ClickHouse/pull/22001)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 `CREATE/ALTER USER` 命令新增可选子句 `GRANTEES`。它用于指定哪些用户或角色被允许从该用户处获得授权，前提是该用户自身也拥有所有所需的访问权限，并带有 `grant option`。默认使用 `GRANTEES ANY`，表示拥有 `grant option` 的用户可以向任意主体授予权限。语法：`CREATE USER ... GRANTEES {user | role | ANY | NONE} [,...] [EXCEPT {user | role} [,...]]`。 [#21641](https://github.com/ClickHouse/ClickHouse/pull/21641) ([Vitaly Baranov](https://github.com/vitlibar)).
* 在 `system.clusters` 中新增列 `slowdowns_count`。在使用对冲请求（hedged requests）时，该列显示由于某个副本响应缓慢而切换到其他副本的次数。同时在 `system.clusters` 中显示 `errors_count` 的实际值。 [#21480](https://github.com/ClickHouse/ClickHouse/pull/21480) ([Kruglov Pavel](https://github.com/Avogar)).
* 为 `MergeTree*` 引擎添加 `_partition_id` 虚拟列。允许通过 `_partition_id` 剪枝分区。添加 `partitionID()` 函数用于计算分区 ID 字符串。[#21401](https://github.com/ClickHouse/ClickHouse/pull/21401) ([Amos Bird](https://github.com/amosbird))。
* 添加函数 `isIPAddressInRange`，用于测试某个 IPv4 或 IPv6 地址是否位于给定的 CIDR 网络前缀范围内。 [#21329](https://github.com/ClickHouse/ClickHouse/pull/21329) ([PHO](https://github.com/depressed-pho))。
* 新增了 SQL 命令 `ALTER TABLE 'table_name' UNFREEZE [PARTITION 'part_expr'] WITH NAME 'backup_name'`。此命令用于从所有磁盘中正确移除“冻结”的分区。[#21142](https://github.com/ClickHouse/ClickHouse/pull/21142) ([Pavel Kovalenko](https://github.com/Jokser)).
* 支持在 JOIN 中进行键类型的隐式转换。[#19885](https://github.com/ClickHouse/ClickHouse/pull/19885) ([Vladimir](https://github.com/vdimir))。

#### 实验性功能 {#experimental-feature-6}

- 支持浮点类型的 `RANGE OFFSET` 帧(用于窗口函数)。实现了 `lagInFrame`/`leadInFrame` 窗口函数,它们类似于 `lag`/`lead`,但会遵循窗口帧的定义。当帧为 `between unbounded preceding and unbounded following` 时,两者行为相同。此功能解决了 [#5485](https://github.com/ClickHouse/ClickHouse/issues/5485)。[#21895](https://github.com/ClickHouse/ClickHouse/pull/21895) ([Alexander Kuzmenkov](https://github.com/akuzm))。
- 为基于 S3 存储的 `ReplicatedMergeTree` 提供零拷贝复制功能。[#16240](https://github.com/ClickHouse/ClickHouse/pull/16240) ([ianton-ru](https://github.com/ianton-ru))。
- 新增将现有 S3 磁盘迁移到支持备份恢复功能的架构的能力。[#22070](https://github.com/ClickHouse/ClickHouse/pull/22070) ([Pavel Kovalenko](https://github.com/Jokser))。

#### 性能改进 {#performance-improvement-7}

- 在 `clickhouse-local` 及其他所有场景中支持并行格式化。[#21630](https://github.com/ClickHouse/ClickHouse/pull/21630) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 支持 `CSVWithNames` 和 `TSVWithNames` 格式的并行解析。此功能解决了 [#21085](https://github.com/ClickHouse/ClickHouse/issues/21085)。[#21149](https://github.com/ClickHouse/ClickHouse/pull/21149) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 为 64 MiB 及以上的文件范围启用 mmap IO 读取(通过设置 `min_bytes_to_use_mmap_io`)。这可能带来适度的性能提升。[#22326](https://github.com/ClickHouse/ClickHouse/pull/22326) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 为使用 `min_bytes_to_use_mmap_io` 设置读取的文件添加缓存。当该设置值较小时,通过避免频繁的 mmap/munmap 调用及其导致的页面错误,可实现显著的性能提升(2倍或更高)。需要注意的是,mmap IO 存在重大缺陷,使其在生产环境中可靠性较低(例如,在故障磁盘上可能挂起或触发 SIGBUS;内存使用难以控制)。尽管如此,它在基准测试中表现良好。[#22206](https://github.com/ClickHouse/ClickHouse/pull/22206) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 使用 `NONE` 编解码器时避免不必要的数据复制。请注意,`NONE` 编解码器在大多数情况下并无实际用途 - 建议始终使用压缩(默认为 `LZ4`)。与普遍认知相反,禁用压缩可能不会提升性能(甚至可能产生相反效果)。`NONE` 编解码器在以下情况下有用:- 数据不可压缩时;- 用于合成基准测试。[#22145](https://github.com/ClickHouse/ClickHouse/pull/22145) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 在 `max_rows_to_group_by` 较小且 `group_by_overflow_mode='any'` 时,`GROUP BY` 性能更快。[#21856](https://github.com/ClickHouse/ClickHouse/pull/21856) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 优化类似 `SELECT ... FINAL ... WHERE` 的查询性能。现在在使用 `FINAL` 的查询中,允许将排序键中的列移至 `PREWHERE`。[#21830](https://github.com/ClickHouse/ClickHouse/pull/21830) ([foolchi](https://github.com/foolchi))。
- 通过替换 `memcpy` 实现来提升性能。此功能解决了 [#18583](https://github.com/ClickHouse/ClickHouse/issues/18583)。[#21520](https://github.com/ClickHouse/ClickHouse/pull/21520) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 提升按排序键顺序进行聚合的性能(启用 `optimize_aggregation_in_order` 设置时)。[#19401](https://github.com/ClickHouse/ClickHouse/pull/19401) ([Anton Popov](https://github.com/CurtizJ))。

#### 改进 {#improvement-7}


* 为 PostgreSQL 表 / 数据库引擎和字典源添加连接池。应能修复 [#21444](https://github.com/ClickHouse/ClickHouse/issues/21444)。[#21839](https://github.com/ClickHouse/ClickHouse/pull/21839)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 为 Postgres 存储/table-function 提供对非默认表 schema 的支持。修复 [#21701](https://github.com/ClickHouse/ClickHouse/issues/21701)。[#21711](https://github.com/ClickHouse/ClickHouse/pull/21711)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 为 `postgres` 字典源提供副本优先级支持。[#21710](https://github.com/ClickHouse/ClickHouse/pull/21710) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 引入一个新的 MergeTree 设置 `min_bytes_to_rebalance_partition_over_jbod`，用于在 JBOD 卷的不同磁盘之间以均衡的方式分配新数据部件。 [#16481](https://github.com/ClickHouse/ClickHouse/pull/16481) ([Amos Bird](https://github.com/amosbird)).
* 在 `system.query_log` 中，为相应查询的 `query_kind` 列新增了 `Grant`、`Revoke` 和 `System` 取值。 [#21102](https://github.com/ClickHouse/ClickHouse/pull/21102) ([Vasily Nemkov](https://github.com/Enmk))。
* 允许将用于复制的 HTTP 连接的超时时间与其他 HTTP 超时分开独立配置。 [#20088](https://github.com/ClickHouse/ClickHouse/pull/20088) ([nvartolomei](https://github.com/nvartolomei)).
* 在服务器写入数据块时发生异常的情况下，改进了客户端的异常消息。在之前的版本中，客户端可能会收到具有误导性的消息，例如 `Data compressed with different methods`。 [#22427](https://github.com/ClickHouse/ClickHouse/pull/22427) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复在获取分片失败后可能出现的错误 `Directory tmp_fetch_XXX already exists`。如果临时获取目录已存在则将其删除。修复了 [#14197](https://github.com/ClickHouse/ClickHouse/issues/14197)。[#22411](https://github.com/ClickHouse/ClickHouse/pull/22411)（[nvartolomei](https://github.com/nvartolomei)）。
* 修复在使用 `UInt256` 参数的 `range` 函数时触发的 MSan 报告（对大整数的支持仍为实验性特性）。此更改关闭了 [#22157](https://github.com/ClickHouse/ClickHouse/issues/22157)。[#22387](https://github.com/ClickHouse/ClickHouse/pull/22387)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 `system.processes` 表新增 `current_database` 列。该列包含查询所在的当前数据库。[#22365](https://github.com/ClickHouse/ClickHouse/pull/22365) ([Alexander Kuzmenkov](https://github.com/akuzm))。
* 为 `clickhouse-client` 添加不区分大小写的历史记录搜索/导航和子单词移动功能。 [#22105](https://github.com/ClickHouse/ClickHouse/pull/22105) ([Amos Bird](https://github.com/amosbird)).
* 如果在 `IN` 运算符左侧是一个由 `NULL` 组成的元组，例如 `(NULL, NULL)`，而右侧是由非 `NULL` 元组组成的列表，例如在 `SELECT (NULL, NULL) IN ((0, 0), (3, 1))` 中，则返回 0，而不是抛出关于类型不兼容的异常。该表达式也可能由于对如下语句的优化而出现：`SELECT (NULL, NULL) = (8, 0) OR (NULL, NULL) = (3, 2) OR (NULL, NULL) = (0, 0) OR (NULL, NULL) = (3, 1)`。此变更关闭了 [#22017](https://github.com/ClickHouse/ClickHouse/issues/22017)。[#22063](https://github.com/ClickHouse/ClickHouse/pull/22063)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 将使用的 simdjson 版本更新为 0.9.1。这修复了 [#21984](https://github.com/ClickHouse/ClickHouse/issues/21984)。[#22057](https://github.com/ClickHouse/ClickHouse/pull/22057)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 为 `CONNECTION_ID()` 和 `VERSION()` 函数添加了不区分大小写的别名。修复了 [#22028](https://github.com/ClickHouse/ClickHouse/issues/22028)。[#22042](https://github.com/ClickHouse/ClickHouse/pull/22042)（[Eugene Klimov](https://github.com/Slach)）。
* 为 `windowFunnel` 函数新增选项 `strict_increase`，以便每个事件只被计算一次（修复 [#21835](https://github.com/ClickHouse/ClickHouse/issues/21835)）。[#22025](https://github.com/ClickHouse/ClickHouse/pull/22025)（[Vladimir](https://github.com/vdimir)）。
* 如果 `MergeTree` 表的分区键不包含 `Date` 或 `DateTime` 列，但包含且只包含一列 `DateTime64`，则在 `system.parts` 和 `system.parts_columns` 表中的 `min_time` 和 `max_time` 列中公开其值。向 `system.parts_columns` 表添加 `min_time` 和 `max_time` 列（此前与 `system.parts` 表存在不一致）。此更改修复了 [#18244](https://github.com/ClickHouse/ClickHouse/issues/18244)。[#22011](https://github.com/ClickHouse/ClickHouse/pull/22011)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 `clickhouse-copier` 中支持使用 `replication_alter_partitions_sync=1` 设置，用于将分区从辅助表移动到目标表。缩短了默认超时时间。修复 [#21911](https://github.com/ClickHouse/ClickHouse/issues/21911)。[#21912](https://github.com/ClickHouse/ClickHouse/pull/21912)（[turbo jason](https://github.com/songenjie)）。
* 在 system 表中显示 `EmbeddedRocksDB` 表的数据目录路径。[#21903](https://github.com/ClickHouse/ClickHouse/pull/21903) ([tavplubix](https://github.com/tavplubix))。
* 新增 profile 事件 `HedgedRequestsChangeReplica`，将读取数据的超时时间单位从秒改为毫秒。 [#21886](https://github.com/ClickHouse/ClickHouse/pull/21886) ([Kruglov Pavel](https://github.com/Avogar)).
* DiskS3（开发中的实验性功能）。修复了在目标非空且使用 cache 磁盘时无法移动目录的错误。 [#21837](https://github.com/ClickHouse/ClickHouse/pull/21837) ([Pavel Kovalenko](https://github.com/Jokser)).
* 改进了 Web UI 中 `Array` 和 `Map` 数据类型的格式化。[#21798](https://github.com/ClickHouse/ClickHouse/pull/21798) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 仅在配置发生更改时才更新集群。 [#21685](https://github.com/ClickHouse/ClickHouse/pull/21685) ([Kruglov Pavel](https://github.com/Avogar)).
* 为分布式 DDL 查询传递查询和会话设置。将 `distributed_ddl_entry_format_version` 设为 2 以启用此功能。新增 `distributed_ddl_output_mode` 设置。支持的模式包括：`none`、`throw`（默认）、`null_status_on_timeout` 和 `never_throw`。对 `Replicated` 数据库引擎进行了若干修复和改进。[#21535](https://github.com/ClickHouse/ClickHouse/pull/21535) ([tavplubix](https://github.com/tavplubix))。
* 如果在实例化 `PODArray` 时使用的元素大小既不是 16 的倍数也不是 16 的因数，则可能发生缓冲区溢出。目前的发布版本中不存在相关缺陷。[#21533](https://github.com/ClickHouse/ClickHouse/pull/21533) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 为 `system.errors` 表添加 `last_error_time`/`last_error_message`/`last_error_stacktrace`/`remote` 列。[#21529](https://github.com/ClickHouse/ClickHouse/pull/21529) ([Azat Khuzhin](https://github.com/azat))。
* 为 `visitParam/visitParamExtract{UInt, Int, Bool, Float, Raw, String}` 添加别名 `simpleJSONExtract/simpleJSONHas`。已修复 #21383。 [#21519](https://github.com/ClickHouse/ClickHouse/pull/21519) ([fastio](https://github.com/fastio))。
* 添加 `optimize_skip_unused_shards_limit` 设置，用于限制 `optimize_skip_unused_shards` 的分片键值数量。 [#21512](https://github.com/ClickHouse/ClickHouse/pull/21512) ([Azat Khuzhin](https://github.com/azat)).
* 改进 `clickhouse-format`，在最后一个查询后存在多余空格或注释时不再抛出异常，并在对包含数据的 `ASTInsertQuery` 进行格式化时尽早抛出带有可读信息的异常。 [#21311](https://github.com/ClickHouse/ClickHouse/pull/21311) ([flynn](https://github.com/ucasFL)).
* 改进对数据类型 `Map` 中整数键的支持。[#21157](https://github.com/ClickHouse/ClickHouse/pull/21157) ([Anton Popov](https://github.com/CurtizJ))。
* MaterializeMySQL：在连接丢失时尝试重新连接到 MySQL。[#20961](https://github.com/ClickHouse/ClickHouse/pull/20961) ([Håvard Kvålen](https://github.com/havardk))。
* 支持更多将 `CROSS JOIN` 重写为 `INNER JOIN` 的场景。[#20392](https://github.com/ClickHouse/ClickHouse/pull/20392) ([Vladimir](https://github.com/vdimir)).
* 在启用 `optimize_on_insert` 设置时，INSERT 不再创建空的 part。修复了 [#20304](https://github.com/ClickHouse/ClickHouse/issues/20304)。[#20387](https://github.com/ClickHouse/ClickHouse/pull/20387)（[Kruglov Pavel](https://github.com/Avogar)）。
* `MaterializeMySQL`：为 `_version` 列添加 minmax 跳跃索引。 [#20382](https://github.com/ClickHouse/ClickHouse/pull/20382) ([Stig Bakken](https://github.com/stigsb)).
* 为 `clickhouse-format` 添加 `--backslash` 选项,可在格式化查询的每行末尾添加反斜杠。[#21494](https://github.com/ClickHouse/ClickHouse/pull/21494) ([flynn](https://github.com/ucasFL))。
* 现在，当我们尝试对已覆盖的部分执行变更时，ClickHouse 将不再抛出 `LOGICAL_ERROR` 异常。修复了 [#22013](https://github.com/ClickHouse/ClickHouse/issues/22013)。[#22291](https://github.com/ClickHouse/ClickHouse/pull/22291)（[alesapin](https://github.com/alesapin)）。

#### 错误修复 {#bug-fix-6}


* 在 `HedgedConnections` 中，在取消数据包接收器之前先将 socket 从 epoll 中移除，以防止可能出现的竞争条件。修复了 [#22161](https://github.com/ClickHouse/ClickHouse/issues/22161)。[#22443](https://github.com/ClickHouse/ClickHouse/pull/22443)（[Kruglov Pavel](https://github.com/Avogar)）。
* 在并行解析流程中补充缺失的内存统计。在之前的版本中，当结果集包含非常大的数据块时，可能会发生 OOM。此更改修复了 [#22008](https://github.com/ClickHouse/ClickHouse/issues/22008)。[#22425](https://github.com/ClickHouse/ClickHouse/pull/22425)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在 `SELECT` 语句中使用常量 `WHERE` 条件且源表包含列名为数字时可能出现的异常。 [#22270](https://github.com/ClickHouse/ClickHouse/pull/22270) ([LiuNeng](https://github.com/liuneng1994)).
* 修复在 `use_hedged_requests=0` 且 `async_socket_for_remote=1` 时的查询取消问题。[#22183](https://github.com/ClickHouse/ClickHouse/pull/22183) ([Azat Khuzhin](https://github.com/azat)).
* 修复 `InterserverIOHTTPHandler` 中未处理的异常。 [#22146](https://github.com/ClickHouse/ClickHouse/pull/22146) ([Azat Khuzhin](https://github.com/azat)).
* 在配置中未设置 `http_port` 时修复 Docker 入口点。 [#22132](https://github.com/ClickHouse/ClickHouse/pull/22132) ([Ewout](https://github.com/devwout)).
* 修复在使用 `JOIN`、`TOTALS` 和 `arrayJoin` 时出现的错误 `Invalid number of rows in Chunk`。关闭 [#19303](https://github.com/ClickHouse/ClickHouse/issues/19303)。[#22129](https://github.com/ClickHouse/ClickHouse/pull/22129)（[Vladimir](https://github.com/vdimir)）。
* 修复用于轮询 Kafka 消息的后台线程池名称。使用损坏线程池的 Kafka 引擎将无法从消息队列中消费消息。[#22122](https://github.com/ClickHouse/ClickHouse/pull/22122) ([fastio](https://github.com/fastio))。
* 修复在 `ReplicatedMergeTree` 表引擎中等待 `OPTIMIZE` 和 `ALTER` 查询时的问题。现在当表被分离或重启时，查询将不再挂起。[#22118](https://github.com/ClickHouse/ClickHouse/pull/22118) ([alesapin](https://github.com/alesapin)).
* 为存在缺陷的 Linux 内核禁用 `async_socket_for_remote`/`use_hedged_requests`。[#22109](https://github.com/ClickHouse/ClickHouse/pull/22109) ([Azat Khuzhin](https://github.com/azat))。
* Docker 入口点：在 `LOG_PATH` 为空时避免对 `.` 执行 chown。修复 [#22100](https://github.com/ClickHouse/ClickHouse/issues/22100)。[#22102](https://github.com/ClickHouse/ClickHouse/pull/22102)（[filimonov](https://github.com/filimonov)）。
* 函数 `decrypt` 之前未检查以 `AEAD` 模式加密数据的最小长度。此更改修复了 [#21897](https://github.com/ClickHouse/ClickHouse/issues/21897)。[#22064](https://github.com/ClickHouse/ClickHouse/pull/22064)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在极少数情况下，`CollapsingMergeTree` 的合并可能会创建包含 `index_granularity + 1` 行的 granule。由于这一点，在 [#18928](https://github.com/ClickHouse/ClickHouse/issues/18928) 中添加的内部检查（影响 21.2 和 21.3）可能会因报错 `Incomplete granules are not allowed while blocks are granules size` 而失败。该错误会阻止数据分片进行合并。[#21976](https://github.com/ClickHouse/ClickHouse/pull/21976)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 回滚了可能在加载哈希类型外部字典时显著增加内存占用的更改 [#15454](https://github.com/ClickHouse/ClickHouse/issues/15454)。由此关闭 [#21935](https://github.com/ClickHouse/ClickHouse/issues/21935)。[#21948](https://github.com/ClickHouse/ClickHouse/pull/21948)（[Maksim Kita](https://github.com/kitaisreal)）。
* 防止对冲连接发生重叠（`Unknown packet 9 from server` 错误）。[#21941](https://github.com/ClickHouse/ClickHouse/pull/21941)（[Azat Khuzhin](https://github.com/azat)）。
* 在某些情况下修复了对内容类型为 `multipart/form-data` 的 HTTP POST 请求的读取问题。[#21936](https://github.com/ClickHouse/ClickHouse/pull/21936) ([Ivan](https://github.com/abyss7)).
* 修复在查询包含窗口函数且应用按主键顺序读取优化时，导致 `ORDER BY` 结果错误的问题。修复 [#21828](https://github.com/ClickHouse/ClickHouse/issues/21828)。[#21915](https://github.com/ClickHouse/ClickHouse/pull/21915)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* 修复首次执行 `catboost` 模型时出现的死锁问题。关闭 [#13832](https://github.com/ClickHouse/ClickHouse/issues/13832)。[#21844](https://github.com/ClickHouse/ClickHouse/pull/21844)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复了当 `WHERE` 或 `HAVING` 条件被下推到 `GROUP BY` 之前时可能导致的查询结果错误(以及可能的崩溃)问题。修复 [#21773](https://github.com/ClickHouse/ClickHouse/issues/21773)。[#21841](https://github.com/ClickHouse/ClickHouse/pull/21841) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 在 `WriteBufferFromS3` 中优化错误处理和日志记录。[#21836](https://github.com/ClickHouse/ClickHouse/pull/21836) ([Pavel Kovalenko](https://github.com/Jokser)).
* 修复了在使用两级聚合时,带有 `Distinct` 组合器的聚合函数可能发生的崩溃问题。这是 [#18365](https://github.com/ClickHouse/ClickHouse/pull/18365) 的后续修复。此问题仅在生产环境中可复现。[#21818](https://github.com/ClickHouse/ClickHouse/pull/21818) ([Amos Bird](https://github.com/amosbird))。
* 修复标量子查询的索引分析。此更改修复了在 [#18896](https://github.com/ClickHouse/ClickHouse/pull/18896) 中引入的 [#21717](https://github.com/ClickHouse/ClickHouse/issues/21717) 问题。[#21766](https://github.com/ClickHouse/ClickHouse/pull/21766)（[Amos Bird](https://github.com/amosbird)）。
* 修复了 `ReplicatedMerge` 表引擎中的一个错误：当 `Decimal` 列的位宽（32 位或 64 位）未改变时，`ALTER MODIFY COLUMN` 查询不会修改其类型的问题。 [#21728](https://github.com/ClickHouse/ClickHouse/pull/21728) ([alesapin](https://github.com/alesapin)).
* 修复在 `ReplicatedMergeTree` 中并发执行 `OPTIMIZE` 和 `DROP` 时可能出现的无限等待问题。[#21716](https://github.com/ClickHouse/ClickHouse/pull/21716) ([Azat Khuzhin](https://github.com/azat)).
* 修复在参数为常量整数且类型为 `Map` 时的 `arrayElement` 函数。 [#21699](https://github.com/ClickHouse/ClickHouse/pull/21699) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在使用 `access_to_key_from_attributes` 访问 `ip_trie` 中不存在的属性时出现的 SIGSEGV。[#21692](https://github.com/ClickHouse/ClickHouse/pull/21692) ([Azat Khuzhin](https://github.com/azat)).
* 服务器现在仅在完成 `DDLWorker` 和字典初始化后才开始接受连接。 [#21676](https://github.com/ClickHouse/ClickHouse/pull/21676) ([Azat Khuzhin](https://github.com/azat)).
* 为 `Join` 类型表的键添加类型转换（此前会导致 SIGSEGV）。[#21646](https://github.com/ClickHouse/ClickHouse/pull/21646)（[Azat Khuzhin](https://github.com/azat)）。
* 修复在使用 `async_socket_for_remote=1` 时分布式请求无法正确取消的问题（例如对多个分片执行带 `LIMIT` 的简单查询，即 `select * from remote('127.{2,3}', system.numbers) limit 100`）。[#21643](https://github.com/ClickHouse/ClickHouse/pull/21643)（[Azat Khuzhin](https://github.com/azat)）。
* 修复 `fsync_part_directory` 在水平合并中的行为。 [#21642](https://github.com/ClickHouse/ClickHouse/pull/21642) ([Azat Khuzhin](https://github.com/azat)).
* 对外部数据库引擎（MySQL、PostgreSQL）的查询，在 `WHERE` 子句中移除来自关联表的未知列。关闭 [#14614](https://github.com/ClickHouse/ClickHouse/issues/14614)、[#19288](https://github.com/ClickHouse/ClickHouse/issues/19288)（重复）、[#19645](https://github.com/ClickHouse/ClickHouse/issues/19645)（重复）。[#21640](https://github.com/ClickHouse/ClickHouse/pull/21640)（[Vladimir](https://github.com/vdimir)）。
* 如果在向 S3 写入数据时出现错误，会调用 `std::terminate`。 [#21624](https://github.com/ClickHouse/ClickHouse/pull/21624) ([Vladimir](https://github.com/vdimir)).
* 修复在启用 `optimize_skip_unused_shards` 且未使用任何分片时可能出现的 `Cannot find column` 错误。[#21579](https://github.com/ClickHouse/ClickHouse/pull/21579) ([Azat Khuzhin](https://github.com/azat))。
* 如果查询包含常量 `WHERE` 条件，并且启用了 `optimize_skip_unused_shards` 设置，则所有分片都有可能被跳过，从而导致查询错误地返回空结果。[#21550](https://github.com/ClickHouse/ClickHouse/pull/21550)（[Amos Bird](https://github.com/amosbird)）。
* 修复表函数 `clusterAllReplicas` 返回错误 `_shard_num` 的问题。关闭 [#21481](https://github.com/ClickHouse/ClickHouse/issues/21481)。[#21498](https://github.com/ClickHouse/ClickHouse/pull/21498) ([flynn](https://github.com/ucasFL))。
* 修复在更新配置后，S3 表仍然保留旧凭据的问题。[#21457](https://github.com/ClickHouse/ClickHouse/pull/21457) ([Grigory Pervakov](https://github.com/GrigoryPervakov)).
* 修复了 Poco 中 `SecureSocket` 内部 SSL 对象的竞态问题。 [#21456](https://github.com/ClickHouse/ClickHouse/pull/21456) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 修复 `Kafka` 的 `Avro` 格式解析。修复了 [#21437](https://github.com/ClickHouse/ClickHouse/issues/21437)。[#21438](https://github.com/ClickHouse/ClickHouse/pull/21438)（[Ilya Golshtein](https://github.com/ilejn)）。
* 修复安全套接字中的接收和发送超时问题以及非阻塞读取。[#21429](https://github.com/ClickHouse/ClickHouse/pull/21429) ([Kruglov Pavel](https://github.com/Avogar)).
* `force_drop_table` 标志对 `MATERIALIZED VIEW` 无效的问题已修复。修复了 [#18943](https://github.com/ClickHouse/ClickHouse/issues/18943)。[#20626](https://github.com/ClickHouse/ClickHouse/pull/20626)（[tavplubix](https://github.com/tavplubix)）。
* 修复 `PredicateRewriteVisitor` 中的名称冲突问题。该问题会在全连接后导致 `WHERE` 过滤结果不正确。关闭 [#20497](https://github.com/ClickHouse/ClickHouse/issues/20497)。[#20622](https://github.com/ClickHouse/ClickHouse/pull/20622)（[Vladimir](https://github.com/vdimir)）。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-7}


* 为 ClickHouse Keeper 添加 [Jepsen](https://github.com/jepsen-io/jepsen) 测试。[#21677](https://github.com/ClickHouse/ClickHouse/pull/21677) ([alesapin](https://github.com/alesapin))。
* 在 CI 中并行运行无状态测试。依赖于 [#22181](https://github.com/ClickHouse/ClickHouse/issues/22181)。[#22300](https://github.com/ClickHouse/ClickHouse/pull/22300)（[alesapin](https://github.com/alesapin)）。
* 为 [SQLancer](https://github.com/sqlancer/sqlancer) CI 运行启用状态检查。[#22015](https://github.com/ClickHouse/ClickHouse/pull/22015) ([Ilya Yatsishin](https://github.com/qoega))。
* 为 PowerPC 构建做了多项准备：在 `ppc64le` 上启用自带的 openldap。[#22487](https://github.com/ClickHouse/ClickHouse/pull/22487) ([Kfir Itzhak](https://github.com/mastertheknife))。在 `ppc64le` 上启用使用 Clang 进行编译。[#22476](https://github.com/ClickHouse/ClickHouse/pull/22476) ([Kfir Itzhak](https://github.com/mastertheknife))。修复在 `ppc64le` 上编译 boost 的问题。[#22474](https://github.com/ClickHouse/ClickHouse/pull/22474) ([Kfir Itzhak](https://github.com/mastertheknife))。修复在 `ppc64le` 上未设置内部 CMake 变量 `CMAKE_ASM_COMPILE_OBJECT` 导致的 CMake 错误。[#22469](https://github.com/ClickHouse/ClickHouse/pull/22469) ([Kfir Itzhak](https://github.com/mastertheknife))。修复 Fedora/RHEL/CentOS 在 `ppc64le` 上找不到 `libclang_rt.builtins` 的问题。[#22458](https://github.com/ClickHouse/ClickHouse/pull/22458) ([Kfir Itzhak](https://github.com/mastertheknife))。在 `ppc64le` 上启用使用 `jemalloc` 进行构建。[#22447](https://github.com/ClickHouse/ClickHouse/pull/22447) ([Kfir Itzhak](https://github.com/mastertheknife))。修复 ClickHouse 的配置嵌入以及 cctz 的时区嵌入在 `ppc64le` 上的问题。[#22445](https://github.com/ClickHouse/ClickHouse/pull/22445) ([Kfir Itzhak](https://github.com/mastertheknife))。修复在 `ppc64le` 上的编译，并在 `ppc64le` 上使用正确的指令指针寄存器。[#22430](https://github.com/ClickHouse/ClickHouse/pull/22430) ([Kfir Itzhak](https://github.com/mastertheknife))。
* 在 `aarch64` 上重新启用 S3（AWS）库。[#22484](https://github.com/ClickHouse/ClickHouse/pull/22484) ([Kfir Itzhak](https://github.com/mastertheknife))。
* 在 Docker 容器中添加 `tzdata`，因为读取 `ORC` 格式时需要它。此更改关闭了 [#14156](https://github.com/ClickHouse/ClickHouse/issues/14156)。[#22000](https://github.com/ClickHouse/ClickHouse/pull/22000)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 `clickhouse-server` 镜像的 Dockerfile 新增两个参数：`deb_location` 和 `single_binary_location`。[#21977](https://github.com/ClickHouse/ClickHouse/pull/21977)（[filimonov](https://github.com/filimonov)）。
* 通过在使用时启用断言，允许在发布版本构建中使用 clang-tidy。[#21914](https://github.com/ClickHouse/ClickHouse/pull/21914) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 在 CMake 脚本中新增对 llvm-12 可执行文件名称的搜索。调整隐式常量转换以消除 clang 警告。更新子模块以兼容使用 CMake 3.19 进行构建。在 `readpassphrase` 库中抑制宏展开时的递归。将已弃用的 `-fuse-ld` 选项替换为 clang 的 `--ld-path`。[#21597](https://github.com/ClickHouse/ClickHouse/pull/21597) ([Ilya Yatsishin](https://github.com/qoega))。
* 将 `docker/test/testflows/runner/dockerd-entrypoint.sh` 更新为使用 Yandex dockerhub-proxy，因为 Docker Hub 已启用非常严格的请求速率限制 [#21551](https://github.com/ClickHouse/ClickHouse/pull/21551) ([vzakaznikov](https://github.com/vzakaznikov))。
* 修复 macOS 共享库的构建。 [#20184](https://github.com/ClickHouse/ClickHouse/pull/20184) ([nvartolomei](https://github.com/nvartolomei)).
* 为 `zookeeper-dump-tree` 添加 `ctime` 选项，用于导出节点创建时间。[#21842](https://github.com/ClickHouse/ClickHouse/pull/21842) ([Ilya](https://github.com/HumanUser)).





## ClickHouse 21.3 版本 (LTS) {#clickhouse-release-213-lts}

### ClickHouse v21.3 版本,2021-03-12 {#clickhouse-release-v213-2021-03-12}

#### 不向后兼容的变更 {#backward-incompatible-change-8}

- 现在不允许使用旧语法创建带有表 TTL 的 MergeTree 表,因为 TTL 设置会被忽略。仍然可以附加旧表。[#20282](https://github.com/ClickHouse/ClickHouse/pull/20282) ([alesapin](https://github.com/alesapin)).
- 现在所有不区分大小写的函数名称都将被重写为其规范形式。这是投影查询路由(即将推出的功能)所必需的。[#20174](https://github.com/ClickHouse/ClickHouse/pull/20174) ([Amos Bird](https://github.com/amosbird)).
- 修复了当 `TTL` 表达式是函数且与 `ORDER BY` 键相同时创建 `TTL` 的问题。现在允许在带有 `GROUP BY` 的 `TTL` 中为主键列设置自定义聚合。不向后兼容:对于不在 `GROUP BY` 中且未显式设置的主键列,当 TTL 过期时,现在应用 `any` 函数而不是 `max` 函数。此外,如果在 TTL 中使用 `WHERE` 或 `GROUP BY`,在执行滚动更新时可能会在合并过程中遇到异常。[#15450](https://github.com/ClickHouse/ClickHouse/pull/15450) ([Anton Popov](https://github.com/CurtizJ)).

#### 新功能 {#new-feature-8}


- 添加文件引擎设置：`engine_file_empty_if_not_exists` 和 `engine_file_truncate_on_insert`。[#20620](https://github.com/ClickHouse/ClickHouse/pull/20620) ([M0r64n](https://github.com/M0r64n))。
- 添加聚合函数 `deltaSum`，用于对连续行之间的差值求和。[#20057](https://github.com/ClickHouse/ClickHouse/pull/20057) ([Russ Frank](https://github.com/rf))。
- 在 `system.part_log` 表中新增 `event_time_microseconds` 列。[#20027](https://github.com/ClickHouse/ClickHouse/pull/20027) ([Bharat Nallan](https://github.com/bharatnc))。
- 添加 `timezoneOffset(datetime)` 函数，返回与 UTC 的时间偏移量(以秒为单位)。此功能关闭 [#issue:19850](https://github.com/ClickHouse/ClickHouse/issues/19850)。[#19962](https://github.com/ClickHouse/ClickHouse/pull/19962) ([keenwolf](https://github.com/keen-wolf))。
- 添加设置 `insert_shard_id`，支持从分布式表向指定分片插入数据。[#19961](https://github.com/ClickHouse/ClickHouse/pull/19961) ([flynn](https://github.com/ucasFL))。
- 更新函数 `reinterpretAs` 以支持大整数。修复 [#19691](https://github.com/ClickHouse/ClickHouse/issues/19691)。[#19858](https://github.com/ClickHouse/ClickHouse/pull/19858) ([Maksim Kita](https://github.com/kitaisreal))。
- 在 S3 客户端中添加服务器端加密客户密钥(即 `x-amz-server-side-encryption-customer-(key/md5)` 标头)支持。参见[此链接](https://docs.aws.amazon.com/AmazonS3/latest/dev/ServerSideEncryptionCustomerKeys.html)。关闭 [#19428](https://github.com/ClickHouse/ClickHouse/issues/19428)。[#19748](https://github.com/ClickHouse/ClickHouse/pull/19748) ([Vladimir Chebotarev](https://github.com/excitoon))。
- 为 `executable` 字典源添加 `implicit_key` 选项。如果记录的顺序与输入键的顺序相同，该选项允许避免为每条记录打印键。实现 [#14527](https://github.com/ClickHouse/ClickHouse/issues/14527)。[#19677](https://github.com/ClickHouse/ClickHouse/pull/19677) ([Maksim Kita](https://github.com/kitaisreal))。
- 添加配额类型 `query_selects` 和 `query_inserts`。[#19603](https://github.com/ClickHouse/ClickHouse/pull/19603) ([JackyWoo](https://github.com/JackyWoo))。
- 添加函数 `extractTextFromHTML` [#19600](https://github.com/ClickHouse/ClickHouse/pull/19600) ([zlx19950903](https://github.com/zlx19950903))，([alexey-milovidov](https://github.com/alexey-milovidov))。
- 使用 `MergeTree*` 引擎的表现在具有两个新的表级设置用于查询并发控制。设置 `max_concurrent_queries` 限制与该表相关的并发执行查询数量。设置 `min_marks_to_honor_max_concurrent_queries` 指定仅当查询读取至少此数量的标记时才应用前一个设置。[#19544](https://github.com/ClickHouse/ClickHouse/pull/19544) ([Amos Bird](https://github.com/amosbird))。
- 添加 `file` 函数，用于从 user_files 目录读取文件并作为字符串返回。这与 `file` 表函数不同。此功能实现 [#issue:18851](https://github.com/ClickHouse/ClickHouse/issues/18851)。[#19204](https://github.com/ClickHouse/ClickHouse/pull/19204) ([keenwolf](https://github.com/keen-wolf))。

#### 实验性功能 {#experimental-feature-7}


- 新增实验性 `Replicated` 数据库引擎。该引擎可在多个主机间复制 DDL 查询。 [#16193](https://github.com/ClickHouse/ClickHouse/pull/16193) ([tavplubix](https://github.com/tavplubix)).
- 引入窗口函数的实验性支持,通过设置 `allow_experimental_window_functions = 1` 启用。这是一个初步的 alpha 质量实现,不适用于生产环境,且在未来版本中将以不向后兼容的方式进行更改。请参阅[文档](https://github.com/ClickHouse/ClickHouse/blob/master/docs/sql-reference/window-functions/index.md#experimental-window-functions)了解支持的功能列表。 [#20337](https://github.com/ClickHouse/ClickHouse/pull/20337) ([Alexander Kuzmenkov](https://github.com/akuzm)).
- 新增 DiskS3 元数据文件的备份/恢复功能。 [#18377](https://github.com/ClickHouse/ClickHouse/pull/18377) ([Pavel Kovalenko](https://github.com/Jokser)).

#### 性能改进 {#performance-improvement-8}


* 远程查询的对冲请求。当启用 `use_hedged_requests` 设置时(默认关闭),允许与不同副本建立多个连接来执行查询。在以下情况下会建立新连接:现有副本连接在 `hedged_connection_timeout` 时间内未能建立,或在 `receive_data_timeout` 时间内未接收到数据。查询会使用第一个发送非空进度包(或数据包,如果启用了 `allow_changing_replica_until_first_data_packet`)的连接;其他连接将被取消。支持 `max_parallel_replicas > 1` 的查询。[#19291](https://github.com/ClickHouse/ClickHouse/pull/19291) ([Kruglov Pavel](https://github.com/Avogar))。这可以显著降低超大规模集群的尾部延迟。
* 新增对 `PREWHERE` 的支持(并启用相应优化),适用于指定了行级安全表达式的表。[#19576](https://github.com/ClickHouse/ClickHouse/pull/19576) ([Denis Glazachev](https://github.com/traceon))。
* `distributed_aggregation_memory_efficient` 设置现已默认启用。该设置可降低内存使用量并提升分布式查询性能。[#20599](https://github.com/ClickHouse/ClickHouse/pull/20599) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 提升了使用多个固定大小键进行 GROUP BY 操作的性能。[#20472](https://github.com/ClickHouse/ClickHouse/pull/20472) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 通过更严格的别名优化提升聚合函数性能。[#19946](https://github.com/ClickHouse/ClickHouse/pull/19946) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 在极端情况下(当读取速度达到 50 GB/秒量级时),通过简化管道从而减少管道调度中的锁竞争,提升从 `Memory` 表读取数据的速度。[#20468](https://github.com/ClickHouse/ClickHouse/pull/20468) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 部分重新实现 HTTP 服务器,以减少传入和传出数据的复制次数。在通过 HTTP 插入长记录时,性能提升最高可达 1.5 倍。[#19516](https://github.com/ClickHouse/ClickHouse/pull/19516) ([Ivan](https://github.com/abyss7))。
* 为 `Memory` 表新增 `compress` 配置项。启用后,表将占用更少的内存。在某些机器和数据集上,SELECT 查询也可能运行得更快,但并非总是如此。此更改解决了 [#20093](https://github.com/ClickHouse/ClickHouse/issues/20093)。注意:Memory 表相比 MergeTree 可能运行较慢的原因包括:(1) 缺少压缩 (2) 固定的块大小 (3) 缺少索引和 prewhere 优化... [#20168](https://github.com/ClickHouse/ClickHouse/pull/20168) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 聚合功能代码优化。[#20978](https://github.com/ClickHouse/ClickHouse/pull/20978) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 重新添加 `intDiv`/`modulo` 特化以提升性能。此修复解决了 [#21293](https://github.com/ClickHouse/ClickHouse/issues/21293)。该性能回退问题是在 [https://github.com/ClickHouse/ClickHouse/pull/18145](https://github.com/ClickHouse/ClickHouse/pull/18145) 中引入的。[#21307](https://github.com/ClickHouse/ClickHouse/pull/21307) ([Amos Bird](https://github.com/amosbird))。
* 在向 Memory 表执行 INSERT SELECT 时,不再过度压缩块。在之前的版本中,INSERT SELECT 操作会在 Memory 表中产生低效的数据表示形式。此修复解决了 [#13052](https://github.com/ClickHouse/ClickHouse/issues/13052)。[#20169](https://github.com/ClickHouse/ClickHouse/pull/20169) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了 DataType 解析器可能出现指数级复杂度的问题(由模糊测试发现)。此修复关闭了 [#20096](https://github.com/ClickHouse/ClickHouse/issues/20096)。[#20132](https://github.com/ClickHouse/ClickHouse/pull/20132) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 当 `do_not_merge_across_partitions_select_final` 设置为 1 时,对 level &gt; 0 的单个数据部分并行执行带 FINAL 的 SELECT 查询。[#19375](https://github.com/ClickHouse/ClickHouse/pull/19375) ([Kruglov Pavel](https://github.com/Avogar))。
* 查询 `system.parts` 和 `system.parts_columns` 时仅填充所请求的列。关闭 [#19570](https://github.com/ClickHouse/ClickHouse/issues/19570)。[#21035](https://github.com/ClickHouse/ClickHouse/pull/21035) ([Anmol Arora](https://github.com/anmolarora))。
* 对 `avg` 聚合函数内的算术表达式进行代数优化。关闭 [#20092](https://github.com/ClickHouse/ClickHouse/issues/20092)。[#20183](https://github.com/ClickHouse/ClickHouse/pull/20183) ([flynn](https://github.com/ucasFL))。

#### 改进 {#improvement-8}


* 表函数的压缩方法现已支持不区分大小写。同时修复了 LZMA 压缩方法以大写形式检查的问题。[#21416](https://github.com/ClickHouse/ClickHouse/pull/21416) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 新增两个设置,用于在非活跃数据分片过多时延迟插入或抛出错误。当服务器清理数据分片的速度不够快时,此功能非常有用。[#20178](https://github.com/ClickHouse/ClickHouse/pull/20178) ([Amos Bird](https://github.com/amosbird))。
* 提升与 MySQL 客户端的兼容性。1. MySQL JDBC 2. mycli。[#21367](https://github.com/ClickHouse/ClickHouse/pull/21367) ([Amos Bird](https://github.com/amosbird))。
* 禁止删除被物化视图引用的列。修复 [#21164](https://github.com/ClickHouse/ClickHouse/issues/21164)。[#21303](https://github.com/ClickHouse/ClickHouse/pull/21303) ([flynn](https://github.com/ucasFL))。
* MySQL 字典源现在会重试意外的连接失败(查询期间与 MySQL 服务器失去连接),这种情况有时会在 SSL/TLS 连接中发生。[#21237](https://github.com/ClickHouse/ClickHouse/pull/21237) ([Alexander Kazakov](https://github.com/Akazz))。
* 可用性改进:更一致的 `DateTime64` 解析:识别以缩放整数形式指定的亚秒级精度 Unix 时间戳(如 `1111111111222` 而非 `1111111111.222`)。此更改解决了 [#13194](https://github.com/ClickHouse/ClickHouse/issues/13194)。[#21053](https://github.com/ClickHouse/ClickHouse/pull/21053) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 在启动器上仅合并已排序的块,配合 distributed&#95;group&#95;by&#95;no&#95;merge 设置。[#20882](https://github.com/ClickHouse/ClickHouse/pull/20882) ([Azat Khuzhin](https://github.com/azat))。
* 在为 MySQL 数据源加载配置时,ClickHouse 现在会对具有相同优先级的副本列表进行随机化处理,以确保轮询选择 MySQL 端点的逻辑正常工作。此更改解决了 [#20629](https://github.com/ClickHouse/ClickHouse/issues/20629)。[#20632](https://github.com/ClickHouse/ClickHouse/pull/20632) ([Alexander Kazakov](https://github.com/Akazz))。
* 函数 &#39;reinterpretAs(x, Type)&#39; 重命名为 &#39;reinterpret(x, Type)&#39;。[#20611](https://github.com/ClickHouse/ClickHouse/pull/20611) ([Maksim Kita](https://github.com/kitaisreal))。
* RabbitMQ 引擎现已支持 vhost [#20576](https://github.com/ClickHouse/ClickHouse/issues/20576)。[#20596](https://github.com/ClickHouse/ClickHouse/pull/20596) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 改进了由 Array 和 Tuple 组合的数据类型的序列化。改进了枚举数据类型与 protobuf 枚举类型的匹配。修复了 `Map` 数据类型的序列化。省略的值现在会被设置为默认值。[#20506](https://github.com/ClickHouse/ClickHouse/pull/20506) ([Vitaly Baranov](https://github.com/vitlibar))。
* 修复了分布式 DDL 任务执行与 DDL 队列清理之间的竞态条件。现在,当存在活跃的工作节点时,DDL 任务不会从 ZooKeeper 中被删除。修复 [#20016](https://github.com/ClickHouse/ClickHouse/issues/20016)。[#20448](https://github.com/ClickHouse/ClickHouse/pull/20448) ([tavplubix](https://github.com/tavplubix))。
* 修复 FQDN 和其他 DNS 相关函数在 Alpine 镜像中的工作问题。[#20336](https://github.com/ClickHouse/ClickHouse/pull/20336) ([filimonov](https://github.com/filimonov))。
* 禁止对明确禁止的函数进行早期常量折叠。[#20303](https://github.com/ClickHouse/ClickHouse/pull/20303) ([Azat Khuzhin](https://github.com/azat))。
* 从整数到 Decimal 类型的隐式转换在整数值超出 Decimal 类型范围时可能会成功。现在会抛出 `ARGUMENT_OUT_OF_BOUND` 异常。[#20232](https://github.com/ClickHouse/ClickHouse/pull/20232) ([tavplubix](https://github.com/tavplubix))。
* 无锁 `SYSTEM FLUSH DISTRIBUTED`。[#20215](https://github.com/ClickHouse/ClickHouse/pull/20215) ([Azat Khuzhin](https://github.com/azat))。
* 将 count(constant)、sum(1) 规范化为 count()。投影查询路由需要此优化。[#20175](https://github.com/ClickHouse/ClickHouse/pull/20175) ([Amos Bird](https://github.com/amosbird))。
* 位图函数现已支持所有原生整数类型。[#20171](https://github.com/ClickHouse/ClickHouse/pull/20171) ([Amos Bird](https://github.com/amosbird))。
* 更新了 `CacheDictionary`、`ComplexCacheDictionary`、`SSDCacheDictionary`、`SSDComplexKeyDictionary`，使用 LRUHashMap 作为底层索引。[#20164](https://github.com/ClickHouse/ClickHouse/pull/20164) ([Maksim Kita](https://github.com/kitaisreal))。
* 现在可以通过设置 `CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT` 环境变量在启动时配置 `access_management` 参数,默认值为禁用 (`0`),与之前保持一致。[#20139](https://github.com/ClickHouse/ClickHouse/pull/20139) ([Marquitos](https://github.com/sonirico))。
* 修复 DateTime64 的 toDateTime64(toDate()/toDateTime()) - 实现 DateTime64 的范围限制以匹配 DateTime 行为。[#20131](https://github.com/ClickHouse/ClickHouse/pull/20131) ([Azat Khuzhin](https://github.com/azat))。
* 配额改进：SHOW TABLES 现在在配额计算中被视为一个查询，而不是两个查询。SYSTEM 查询现在会消耗配额。修复了配额消耗中时间间隔结束点的计算。[#20106](https://github.com/ClickHouse/ClickHouse/pull/20106) ([Vitaly Baranov](https://github.com/vitlibar))。
* 支持在 `system.zookeeper` 表中使用 `path IN (set)` 表达式。[#20105](https://github.com/ClickHouse/ClickHouse/pull/20105) ([小路](https://github.com/nicelulu))。
* 在 `system.tables` 中显示 `MaterializeMySQL` 表的完整详细信息。[#20051](https://github.com/ClickHouse/ClickHouse/pull/20051) ([Stig Bakken](https://github.com/stigsb))。
* 修复了可执行字典中的数据竞争问题,该问题仅在误用时可能发生(即脚本返回数据时忽略了其输入)。[#20045](https://github.com/ClickHouse/ClickHouse/pull/20045) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 现在可以通过 MySQL 副本配置部分中的 &quot;opt&#95;reconnect&quot; 参数来控制 MYSQL&#95;OPT&#95;RECONNECT 选项的值。[#19998](https://github.com/ClickHouse/ClickHouse/pull/19998) ([Alexander Kazakov](https://github.com/Akazz))。
* 当用户调用 `JSONExtract` 函数并请求 `Float32` 类型时,允许对结果类型进行不精确转换。例如,JSON 中的数字 `0.1` 是双精度浮点数,无法用 Float32 精确表示,但用户仍希望获取该值。旧版本对非 Nullable 类型返回 0,对 Nullable 类型返回 NULL 来表示转换不精确。该逻辑完全正确,但会让用户感到困惑并产生疑问。此更改解决了 [#13962](https://github.com/ClickHouse/ClickHouse/issues/13962)。[#19960](https://github.com/ClickHouse/ClickHouse/pull/19960) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 当向分布式表执行 INSERT 操作时,如果块结构不匹配,现已添加自动转换功能。[#19947](https://github.com/ClickHouse/ClickHouse/pull/19947) ([Azat Khuzhin](https://github.com/azat))。
* 改进了 `system.distributed_ddl_queue` 表。重启后将 MaxDDLEntryID 初始化为最后一个值。在此 PR 之前,MaxDDLEntryID 会保持为零,直到处理新的 DDL 任务。[#19924](https://github.com/ClickHouse/ClickHouse/pull/19924) ([Amos Bird](https://github.com/amosbird))。
* 在 `system.parts` 中显示 `MaterializeMySQL` 表。[#19770](https://github.com/ClickHouse/ClickHouse/pull/19770) ([Stig Bakken](https://github.com/stigsb))。
* 为 `Buffer` 引擎添加独立的配置指令。[#19721](https://github.com/ClickHouse/ClickHouse/pull/19721) ([Azat Khuzhin](https://github.com/azat))。
* 将与 JOIN 无关的条件移至 WHERE 子句。[#18720](https://github.com/ClickHouse/ClickHouse/issues/18720). [#19685](https://github.com/ClickHouse/ClickHouse/pull/19685) ([hexiaoting](https://github.com/hexiaoting)).
* 新增根据异步发送的待处理字节数对 Distributed 表的 INSERT 操作进行限流的功能(为 `Distributed` 引擎添加了 `bytes_to_delay_insert`/`max_delay_to_insert` 和 `bytes_to_throw_insert` 配置项)。[#19673](https://github.com/ClickHouse/ClickHouse/pull/19673) ([Azat Khuzhin](https://github.com/azat))。
* 修复了析构函数中写入错误在某些罕见情况下可能被忽略的问题。[#19451](https://github.com/ClickHouse/ClickHouse/pull/19451) ([Azat Khuzhin](https://github.com/azat))。
* 在致命错误的堆栈跟踪中打印内联帧。[#19317](https://github.com/ClickHouse/ClickHouse/pull/19317) ([Ivan](https://github.com/abyss7))。

#### 错误修复 {#bug-fix-7}


* 修复了与 ZooKeeper 的冗余重连以及单个 ClickHouse 服务器可能同时存在两个活动会话的问题。这两个问题均在 #14678 中引入。[#21264](https://github.com/ClickHouse/ClickHouse/pull/21264) ([alesapin](https://github.com/alesapin))。
* 修复了使用 `Values` 格式向包含 `LowCardinality` 列的表插入数据时出现的 `Bad cast from type ... to DB::ColumnLowCardinality` 错误。修复 #21140 [#21357](https://github.com/ClickHouse/ClickHouse/pull/21357) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了非复制 MergeTree 表引擎中 `ALTER DELETE` 变更操作的死锁问题,该问题发生在谓词包含表自身时。修复 [#20558](https://github.com/ClickHouse/ClickHouse/issues/20558)。[#21477](https://github.com/ClickHouse/ClickHouse/pull/21477) ([alesapin](https://github.com/alesapin))。
* 修复分布式查询失败时的 SIGSEGV 错误。[#21434](https://github.com/ClickHouse/ClickHouse/pull/21434) ([Azat Khuzhin](https://github.com/azat))。
* 现在 `ALTER MODIFY COLUMN` 查询将正确应用于分区键、跳数索引、TTL 等的变更。修复 [#13675](https://github.com/ClickHouse/ClickHouse/issues/13675)。[#21334](https://github.com/ClickHouse/ClickHouse/pull/21334) ([alesapin](https://github.com/alesapin))。
* 修复了 `join_use_nulls` 与子查询中 `TOTALS` 连接时的错误。此修复关闭了 [#19362](https://github.com/ClickHouse/ClickHouse/issues/19362) 和 [#21137](https://github.com/ClickHouse/ClickHouse/issues/21137)。[#21248](https://github.com/ClickHouse/ClickHouse/pull/21248) ([vdimir](https://github.com/vdimir))。
* 修复了在对包含 `UNION` 的查询执行 `EXPLAIN` 时发生的崩溃问题。修复 [#20876](https://github.com/ClickHouse/ClickHouse/issues/20876)、[#21170](https://github.com/ClickHouse/ClickHouse/issues/21170)。[#21246](https://github.com/ClickHouse/ClickHouse/pull/21246) ([flynn](https://github.com/ucasFL))。
* 现在 mutation 操作仅允许用于支持该功能的表引擎(MergeTree 系列、Memory、MaterializedView)。其他引擎将报告更明确的错误信息。修复 [#21168](https://github.com/ClickHouse/ClickHouse/issues/21168)。[#21183](https://github.com/ClickHouse/ClickHouse/pull/21183) ([alesapin](https://github.com/alesapin))。
* 修复 [#21112](https://github.com/ClickHouse/ClickHouse/issues/21112)。修复了可能导致插入查询产生重复数据的错误(当某个回调响应延迟时)。[#21138](https://github.com/ClickHouse/ClickHouse/pull/21138) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 修复了当类型为可空类型时 `input_format_null_as_default` 无法生效的问题。此修复解决了 [#21116](https://github.com/ClickHouse/ClickHouse/issues/21116)。[#21121](https://github.com/ClickHouse/ClickHouse/pull/21121) ([Amos Bird](https://github.com/amosbird))。
* 修复了 Tuple 转换为 Map 时的相关错误。关闭 [#21029](https://github.com/ClickHouse/ClickHouse/issues/21029)。[#21120](https://github.com/ClickHouse/ClickHouse/pull/21120) ([hexiaoting](https://github.com/hexiaoting))。
* 修复了删除使用自定义(非默认)ZooKeeper 集群的 Replicated*MergeTree 表时的元数据泄漏问题。[#21119](https://github.com/ClickHouse/ClickHouse/pull/21119) ([fastio](https://github.com/fastio))。
* 修复在 joinGet 中使用 LowCardinality 键时的类型不匹配问题。修复了 [#21114](https://github.com/ClickHouse/ClickHouse/issues/21114)。[#21117](https://github.com/ClickHouse/ClickHouse/pull/21117) ([Amos Bird](https://github.com/amosbird))。
* 修复了当 Replicated(*)MergeTree 引擎需要指定其他参数时,default&#95;replica&#95;path 和 default&#95;replica&#95;name 值无法生效的问题。[#21060](https://github.com/ClickHouse/ClickHouse/pull/21060) ([mxzlxy](https://github.com/mxzlxy))。
* 在格式化特定构造的超出范围的 `DateTime64` 类型值时,可能发生越界内存访问。此问题修复了 [#20494](https://github.com/ClickHouse/ClickHouse/issues/20494)。此问题修复了 [#20543](https://github.com/ClickHouse/ClickHouse/issues/20543)。[#21023](https://github.com/ClickHouse/ClickHouse/pull/21023) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 阻止并行插入到存储引擎 Join。[#21009](https://github.com/ClickHouse/ClickHouse/pull/21009) ([vdimir](https://github.com/vdimir))。
* 修复了 `ALTER MODIFY COLUMN` 会创建注定失败的 mutation 的问题。[#21007](https://github.com/ClickHouse/ClickHouse/pull/21007) ([Anton Popov](https://github.com/CurtizJ))。
* 关闭 [#9969](https://github.com/ClickHouse/ClickHouse/issues/9969)。修复了 Brotli HTTP 压缩错误,该错误在处理大数据量、结构较复杂且使用 JSON 输出格式时会出现。将 Brotli 更新至最新版本,包含了&quot;修复环形缓冲区中罕见的未初始化数据访问问题&quot;的修复。[#20991](https://github.com/ClickHouse/ClickHouse/pull/20991) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 修复查询取消时出现的 &#39;Empty task was returned from async task queue&#39; 错误。[#20881](https://github.com/ClickHouse/ClickHouse/pull/20881) ([Azat Khuzhin](https://github.com/azat))。
* 修复了使用 MySQL 5.7 客户端连接 ClickHouse 服务器时 `USE database;` 查询无法工作的问题。修复 [#18926](https://github.com/ClickHouse/ClickHouse/issues/18926)。[#20878](https://github.com/ClickHouse/ClickHouse/pull/20878) ([tavplubix](https://github.com/tavplubix))。
* 修复聚合函数中 `-Distinct` 组合器与 `-State` 组合器配合使用的问题。[#20866](https://github.com/ClickHouse/ClickHouse/pull/20866) ([Anton Popov](https://github.com/CurtizJ))。
* 修复了包含 UNION DISTINCT 和 LIMIT 子句的子查询问题。关闭 [#20597](https://github.com/ClickHouse/ClickHouse/issues/20597)。[#20610](https://github.com/ClickHouse/ClickHouse/pull/20610) ([flynn](https://github.com/ucasFL))。
* 修复了查询字典中不存在的键时行为不一致的问题。[#20578](https://github.com/ClickHouse/ClickHouse/pull/20578) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 修复标量子查询和索引子查询的线程数问题(在 [#19007](https://github.com/ClickHouse/ClickHouse/issues/19007) 之后总是使用单线程)。修复了 [#20457](https://github.com/ClickHouse/ClickHouse/issues/20457)、[#20512](https://github.com/ClickHouse/ClickHouse/issues/20512)。[#20550](https://github.com/ClickHouse/ClickHouse/pull/20550) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了从远程查询接收到未知数据包时可能发生的崩溃(在 [#17868](https://github.com/ClickHouse/ClickHouse/issues/17868) 中引入)。[#20547](https://github.com/ClickHouse/ClickHouse/pull/20547) ([Azat Khuzhin](https://github.com/azat))。
* 在解析异步 INSERT 的目录名称时添加适当的检查（修复 SIGSEGV）。[#20498](https://github.com/ClickHouse/ClickHouse/pull/20498) ([Azat Khuzhin](https://github.com/azat))。
* 修复 `transform` 函数在使用浮点数键时无法正常工作的问题。关闭 [#20460](https://github.com/ClickHouse/ClickHouse/issues/20460)。[#20479](https://github.com/ClickHouse/ClickHouse/pull/20479) ([flynn](https://github.com/ucasFL))。
* 修复将 WITH 别名传播到子查询时的无限循环。此修复解决了 [#20388](https://github.com/ClickHouse/ClickHouse/issues/20388)。[#20476](https://github.com/ClickHouse/ClickHouse/pull/20476) ([Amos Bird](https://github.com/amosbird))。
* 修复 HTTP 客户端断开连接时导致服务器异常终止的问题。[#20464](https://github.com/ClickHouse/ClickHouse/pull/20464) ([Azat Khuzhin](https://github.com/azat))。
* 修复了当 JOIN 包含来自 SELECT 的常量时,`join_use_nulls=1` 会导致 `LOGICAL_ERROR` 的问题。[#20461](https://github.com/ClickHouse/ClickHouse/pull/20461) ([Azat Khuzhin](https://github.com/azat))。
* 检查表达式列表中是否使用了表函数 `view`,如果使用则抛出错误。此修复解决了 [#20342](https://github.com/ClickHouse/ClickHouse/issues/20342)。[#20350](https://github.com/ClickHouse/ClickHouse/pull/20350) ([Amos Bird](https://github.com/amosbird))。
* 避免 RANGE&#95;HASHED() 字典中的无效解引用。[#20345](https://github.com/ClickHouse/ClickHouse/pull/20345) ([Azat Khuzhin](https://github.com/azat))。
* 修复了 `join_use_nulls=1` 时的空指针解引用问题。[#20344](https://github.com/ClickHouse/ClickHouse/pull/20344) ([Azat Khuzhin](https://github.com/azat))。
* 修复了不同精度的常量 Decimal 类型之间进行二进制运算时结果不正确的问题。修复 [#20283](https://github.com/ClickHouse/ClickHouse/issues/20283)。[#20339](https://github.com/ClickHouse/ClickHouse/pull/20339) ([Maksim Kita](https://github.com/kitaisreal))。
* 修复了 `ReplicatedMergeTree` 表引擎系列中失败后台任务过于频繁重试的问题。这可能导致日志过于冗长和 CPU 负载增加。修复 [#20203](https://github.com/ClickHouse/ClickHouse/issues/20203)。[#20335](https://github.com/ClickHouse/ClickHouse/pull/20335) ([alesapin](https://github.com/alesapin))。
* 限制对 `*CollapsingMergeTree` 和 `ReplacingMergeTree` 表引擎的版本列进行 `DROP` 或 `RENAME` 操作。[#20300](https://github.com/ClickHouse/ClickHouse/pull/20300) ([alesapin](https://github.com/alesapin))。
* 修复了在 JSON 文件损坏时尝试将整个文件读入内存而导致内存分配器抛出异常的问题。修复 [#19719](https://github.com/ClickHouse/ClickHouse/issues/19719)。[#20286](https://github.com/ClickHouse/ClickHouse/pull/20286) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 修复了 `MergeTree` 表引擎系列中不支持垂直合并时发生的异常。修复 [#20259](https://github.com/ClickHouse/ClickHouse/issues/20259)。[#20279](https://github.com/ClickHouse/ClickHouse/pull/20279) ([alesapin](https://github.com/alesapin))。
* 修复了服务器关闭期间重新加载配置时偶发的崩溃问题。修复 [#19689](https://github.com/ClickHouse/ClickHouse/issues/19689)。[#20224](https://github.com/ClickHouse/ClickHouse/pull/20224) ([alesapin](https://github.com/alesapin))。
* 修复了在 INSERT SELECT 中使用 CTE 时的问题。此修复解决了 [#20187](https://github.com/ClickHouse/ClickHouse/issues/20187) 和 [#20195](https://github.com/ClickHouse/ClickHouse/issues/20195)。[#20211](https://github.com/ClickHouse/ClickHouse/pull/20211) ([Amos Bird](https://github.com/amosbird))。
* 修复了 [#19314](https://github.com/ClickHouse/ClickHouse/issues/19314)。[#20156](https://github.com/ClickHouse/ClickHouse/pull/20156) ([Ivan](https://github.com/abyss7))。
* 修复 toMinute 函数以正确处理特殊时区。[#20149](https://github.com/ClickHouse/ClickHouse/pull/20149) ([keenwolf](https://github.com/keen-wolf))。
* 修复了当 `if` 函数的 then/else 分支结果为 `Tuple` 类型时导致服务器崩溃的问题。该 `Tuple` 类型必须包含 `Array` 或其他复杂类型。修复 [#18356](https://github.com/ClickHouse/ClickHouse/issues/18356)。[#20133](https://github.com/ClickHouse/ClickHouse/pull/20133) ([alesapin](https://github.com/alesapin))。
* `MongoDB` 表引擎现在仅在需要读取数据时才建立连接。`ATTACH TABLE` 不再尝试连接。[#20110](https://github.com/ClickHouse/ClickHouse/pull/20110) ([Vitaly Baranov](https://github.com/vitlibar))。
* 修复 StorageJoin 中的错误。[#20079](https://github.com/ClickHouse/ClickHouse/pull/20079) ([vdimir](https://github.com/vdimir))。
* 修复了负数除以较小除数进行取模运算时,结果数据类型无法容纳负数结果的问题。此修复关闭了 [#20052](https://github.com/ClickHouse/ClickHouse/issues/20052)。[#20067](https://github.com/ClickHouse/ClickHouse/pull/20067) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* MaterializeMySQL:修复了涉及更新多个表的语句的复制问题。[#20066](https://github.com/ClickHouse/ClickHouse/pull/20066) ([Håvard Kvålen](https://github.com/havardk))。
* 防止在 Docker 初始化脚本执行期间出现 &quot;Connection refused&quot; 错误。[#20012](https://github.com/ClickHouse/ClickHouse/pull/20012) ([filimonov](https://github.com/filimonov))。
* `EmbeddedRocksDB` 是一个实验性存储引擎。修复了类型检查不完善的问题，并简化了代码。此更改关闭了 [#19967](https://github.com/ClickHouse/ClickHouse/issues/19967)。[#19972](https://github.com/ClickHouse/ClickHouse/pull/19972) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了函数 `fromModifiedJulianDay` 在参数类型为 `Nullable(T)`(其中 T 为 Int32 以外的任意整数类型)时的段错误问题。[#19959](https://github.com/ClickHouse/ClickHouse/pull/19959) ([PHO](https://github.com/depressed-pho))。
* 修复 BloomFilter 索引崩溃问题。修复 [#19757](https://github.com/ClickHouse/ClickHouse/issues/19757)。[#19884](https://github.com/ClickHouse/ClickHouse/pull/19884) ([Maksim Kita](https://github.com/kitaisreal))。
* 启用 system.text&#95;log 时可能发生死锁。此问题已修复 [#19874](https://github.com/ClickHouse/ClickHouse/issues/19874)。[#19875](https://github.com/ClickHouse/ClickHouse/pull/19875) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了服务器启动时包含 dictGet() 默认表达式的表无法正常启动的问题。允许在不加载字典的情况下获取 dictGet() 的返回类型。[#19805](https://github.com/ClickHouse/ClickHouse/pull/19805) ([Vitaly Baranov](https://github.com/vitlibar))。
* 修复 clickhouse-client 在仅执行 `select` 语句时异常中止的问题。[#19790](https://github.com/ClickHouse/ClickHouse/pull/19790) ([taiyang-li](https://github.com/taiyang-li))。
* 修复了启动多个 clickhouse-copier 实例时，数据片段移动到目标表可能失败的问题。[#19743](https://github.com/ClickHouse/ClickHouse/pull/19743) ([madianjun](https://github.com/mdianjun))。
* 执行 `ON CLUSTER` 查询的后台线程可能会挂起,等待已删除的复制表执行某些操作。该问题已修复。[#19684](https://github.com/ClickHouse/ClickHouse/pull/19684) ([yiguolei](https://github.com/yiguolei))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-8}

- 允许在全局启用 AVX-2 来构建 ClickHouse。在现代 CPU 上可以带来轻微的性能提升。目前不建议用于生产环境,暂不作为官方构建版本提供支持。[#20180](https://github.com/ClickHouse/ClickHouse/pull/20180) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 修复了 Coverity 发现的部分问题。参见 [#19964](https://github.com/ClickHouse/ClickHouse/issues/19964)。[#20010](https://github.com/ClickHouse/ClickHouse/pull/20010) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 允许在 gdb 下使用修改过的二进制文件启动。在之前的版本中,如果在启动前在 gdb 中设置断点,服务器会因完整性检查失败而拒绝启动。[#21258](https://github.com/ClickHouse/ClickHouse/pull/21258) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 为 Kafka 的不同压缩方法添加了测试。[#21111](https://github.com/ClickHouse/ClickHouse/pull/21111) ([filimonov](https://github.com/filimonov))。
- 修复了 test_storage_kerberized_hdfs 测试中的端口冲突问题。[#19974](https://github.com/ClickHouse/ClickHouse/pull/19974) ([Ilya Yatsishin](https://github.com/qoega))。
- 在集成测试中 docker 启动失败时,将 `stdout` 和 `stderr` 输出到日志。在此 PR 之前,这种情况下只有一条非常简短的错误消息,不利于问题排查。[#20631](https://github.com/ClickHouse/ClickHouse/pull/20631) ([Vitaly Baranov](https://github.com/vitlibar))。


## ClickHouse 21.2 版本 {#clickhouse-release-212}

### ClickHouse v21.2.2.8-stable 版本,2021-02-07 {#clickhouse-release-v21228-stable-2021-02-07}

#### 不向后兼容的变更 {#backward-incompatible-change-9}

- 位运算函数(`bitAnd`、`bitOr` 等)不再允许用于浮点数参数。现在必须显式转换为整数类型。[#19853](https://github.com/ClickHouse/ClickHouse/pull/19853) ([Azat Khuzhin](https://github.com/azat)).
- 禁止对浮点数使用 `lcm`/`gcd` 函数。[#19532](https://github.com/ClickHouse/ClickHouse/pull/19532) ([Azat Khuzhin](https://github.com/azat)).
- 修复 `OPTIMIZE TABLE`/合并操作的内存跟踪;为 `OPTIMIZE TABLE`/合并操作计入查询内存限制和采样。[#18772](https://github.com/ClickHouse/ClickHouse/pull/18772) ([Azat Khuzhin](https://github.com/azat)).
- 不再允许使用浮点数列作为分区键,参见 [#18421](https://github.com/ClickHouse/ClickHouse/issues/18421#event-4147046255)。[#18464](https://github.com/ClickHouse/ClickHouse/pull/18464) ([hexiaoting](https://github.com/hexiaoting)).
- 类型定义中不再支持多余的括号,例如:`Array((UInt8))`。

#### 新功能 {#new-feature-9}


* 新增 `PostgreSQL` 表引擎(支持 SELECT/INSERT 操作,并支持多维数组),同时也可作为表函数使用。新增 `PostgreSQL` 字典源。新增 `PostgreSQL` 数据库引擎。[#18554](https://github.com/ClickHouse/ClickHouse/pull/18554) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 数据类型 `Nested` 现在支持任意层级的嵌套。引入了复杂类型的子列，例如 `Array` 中的 `size0`、`Nullable` 中的 `null`、`Tuple` 元素的名称，这些子列可以在不读取整列的情况下单独读取。[#17310](https://github.com/ClickHouse/ClickHouse/pull/17310) ([Anton Popov](https://github.com/CurtizJ))。
* 为 `FlatDictionary`、`HashedDictionary`、`ComplexKeyHashedDictionary`、`DirectDictionary`、`ComplexKeyDirectDictionary`、`RangeHashedDictionary` 添加了 `Nullable` 支持。[#18236](https://github.com/ClickHouse/ClickHouse/pull/18236) ([Maksim Kita](https://github.com/kitaisreal))。
* 新增了一个名为 `system.distributed_ddl_queue` 的系统表,用于显示 DDL 工作队列中的查询。[#17656](https://github.com/ClickHouse/ClickHouse/pull/17656) ([Bharat Nallan](https://github.com/bharatnc))。
* 新增支持将 LDAP 组名称和属性值映射到 LDAP 用户目录中用户的本地角色。[#17211](https://github.com/ClickHouse/ClickHouse/pull/17211) ([Denis Glazachev](https://github.com/traceon))。
* 支持向表函数 `cluster` 插入数据,并且对于表函数 `remote` 和 `cluster`,支持通过指定分片键将数据分布到各个节点。关闭 [#16752](https://github.com/ClickHouse/ClickHouse/issues/16752)。[#18264](https://github.com/ClickHouse/ClickHouse/pull/18264) ([flynn](https://github.com/ucasFL))。
* 新增函数 `decodeXMLComponent`,用于解码 XML 字符。示例:`SELECT decodeXMLComponent('Hello,&quot;world&quot;!')` [#17659](https://github.com/ClickHouse/ClickHouse/issues/17659). [#18542](https://github.com/ClickHouse/ClickHouse/pull/18542) ([nauta](https://github.com/nautaa)).
* 新增函数 `parseDateTimeBestEffortUSOrZero` 和 `parseDateTimeBestEffortUSOrNull`。[#19712](https://github.com/ClickHouse/ClickHouse/pull/19712) ([Maksim Kita](https://github.com/kitaisreal))。
* 新增 `sign` 数学函数。[#19527](https://github.com/ClickHouse/ClickHouse/pull/19527) ([flynn](https://github.com/ucasFL))。
* 将已使用的功能（函数、表引擎等）信息添加到 system.query&#95;log 中。[#18495](https://github.com/ClickHouse/ClickHouse/issues/18495)。[#19371](https://github.com/ClickHouse/ClickHouse/pull/19371) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 函数 `formatDateTime` 支持使用 `%Q` 修饰符将日期格式化为季度。[#19224](https://github.com/ClickHouse/ClickHouse/pull/19224) ([Jianmei Zhang](https://github.com/zhangjmruc))。
* 在 Play UI 中支持 MetaKey+Enter 快捷键绑定。[#19012](https://github.com/ClickHouse/ClickHouse/pull/19012) ([sundyli](https://github.com/sundy-li))。
* 为 map 数据类型新增三个函数：1. `mapContains(map, key)` 用于检查 map.keys 是否包含第二个参数 key；2. `mapKeys(map)` 以数组格式返回所有键；3. `mapValues(map)` 以数组格式返回所有值。[#18788](https://github.com/ClickHouse/ClickHouse/pull/18788) ([hexiaoting](https://github.com/hexiaoting))。
* 新增 `log_comment` 设置，相关 issue 见 [#18494](https://github.com/ClickHouse/ClickHouse/issues/18494)。[#18549](https://github.com/ClickHouse/ClickHouse/pull/18549) ([Zijie Lu](https://github.com/TszKitLo40))。
* 为 `argMin` 和 `argMax` 函数添加元组参数支持。[#17359](https://github.com/ClickHouse/ClickHouse/pull/17359) ([Ildus Kurbangaliev](https://github.com/ildus))。
* 支持 `EXISTS VIEW` 语法。[#18552](https://github.com/ClickHouse/ClickHouse/pull/18552) ([Du Chuan](https://github.com/spongedu))。
* 新增 `SELECT ALL` 语法。关闭 [#18706](https://github.com/ClickHouse/ClickHouse/issues/18706)。[#18723](https://github.com/ClickHouse/ClickHouse/pull/18723) ([flynn](https://github.com/ucasFL))。

#### 性能改进 {#performance-improvement-9}

- 通过减少 `stat` 系统调用次数加快数据分片删除速度。此更改恢复了之前存在的优化,并提供了更安全的 `IDisk` 接口。此更改关闭了 [#19065](https://github.com/ClickHouse/ClickHouse/issues/19065)。[#19086](https://github.com/ClickHouse/ClickHouse/pull/19086) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 在 `WITH` 语句中声明的别名现在可以正确用于索引分析。类似 `WITH column AS alias SELECT ... WHERE alias = ...` 的查询现在可以使用索引。[#18896](https://github.com/ClickHouse/ClickHouse/pull/18896) ([Amos Bird](https://github.com/amosbird))。
- 添加 `optimize_alias_column_prediction` 设置(默认开启),该设置将:- 在分区裁剪和使用二级索引跳过数据时,在 WHERE 子句中识别别名列;- 在 optimize_trivial_count 的简单计数查询中,在 WHERE 子句中识别别名列;- 在 optimize_aggregation_in_order/optimize_read_in_order 中,在 GROUP BY/ORDER BY 子句中识别别名列。[#16995](https://github.com/ClickHouse/ClickHouse/pull/16995) ([sundyli](https://github.com/sundy-li))。
- 加速聚合函数 `sum`。改进仅在合成基准测试中可见,实际应用价值不大。[#19216](https://github.com/ClickHouse/ClickHouse/pull/19216) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 更新 libc++ 并使用另一个 ABI 以提供更好的性能。[#18914](https://github.com/ClickHouse/ClickHouse/pull/18914) ([Danila Kutenin](https://github.com/danlark1))。
- 在逻辑等价时将 `sumIf()` 和 `sum(if())` 函数重写为 `countIf()` 函数。[#17041](https://github.com/ClickHouse/ClickHouse/pull/17041) ([flynn](https://github.com/ucasFL))。
- 为 S3 连接使用连接池,由 `s3_max_connections` 设置控制。[#13405](https://github.com/ClickHouse/ClickHouse/pull/13405) ([Vladimir Chebotarev](https://github.com/excitoon))。
- 添加对 zstd long 选项的支持,以更好地压缩字符串列从而节省空间。[#17184](https://github.com/ClickHouse/ClickHouse/pull/17184) ([ygrek](https://github.com/ygrek))。
- 通过移除每次连接时对配置的访问,略微改善服务器延迟。[#19863](https://github.com/ClickHouse/ClickHouse/pull/19863) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 减少 `Buffer` 引擎多层的锁竞争。[#19379](https://github.com/ClickHouse/ClickHouse/pull/19379) ([Azat Khuzhin](https://github.com/azat))。
- 支持将查询计划的 `Filter` 步骤拆分为 `Expression + Filter` 对。结合 `Expression + Expression` 合并优化([#17458](https://github.com/ClickHouse/ClickHouse/issues/17458)),可以延迟 `Filter` 步骤之后某些表达式的执行。[#19253](https://github.com/ClickHouse/ClickHouse/pull/19253) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。

#### 改进 {#improvement-9}


* 现在即使只能从 `table` 中选择任意一列,也可以执行 `SELECT count() FROM table`。此 PR 修复了 [#10639](https://github.com/ClickHouse/ClickHouse/issues/10639)。[#18233](https://github.com/ClickHouse/ClickHouse/pull/18233) ([Vitaly Baranov](https://github.com/vitlibar))。
* 与远程 MySQL 服务器交互时将字符集设置为 `utf8mb4`。修复 [#19795](https://github.com/ClickHouse/ClickHouse/issues/19795)。[#19800](https://github.com/ClickHouse/ClickHouse/pull/19800) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `S3` 表函数现在支持 `auto` 压缩模式(自动检测)。此更新解决了 [#18754](https://github.com/ClickHouse/ClickHouse/issues/18754)。[#19793](https://github.com/ClickHouse/ClickHouse/pull/19793) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 修复了 `formatReadableTimeDelta` 函数对无限值参数的输出问题。在之前的版本中,无限值会被隐式转换为实现相关的整数值。[#19791](https://github.com/ClickHouse/ClickHouse/pull/19791) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 表函数 `S3` 在无法准确确定区域时将使用全局区域。此更改关闭了 [#10998](https://github.com/ClickHouse/ClickHouse/issues/10998)。[#19750](https://github.com/ClickHouse/ClickHouse/pull/19750) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 在分布式查询中,如果启用了 `async_socket_for_remote` 设置,当表使用非常深层嵌套的数据类型(例如 `Array(Array(Array(...更多...)))`)时,至少在调试构建配置下可能会发生栈溢出。此修复解决了 [#19108](https://github.com/ClickHouse/ClickHouse/issues/19108)。此更改引入了轻微的向后不兼容性:类型定义中的多余括号不再支持,例如:`Array((UInt8))`。[#19736](https://github.com/ClickHouse/ClickHouse/pull/19736) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 为消息代理(RabbitMQ 和 Kafka)添加独立的连接池。[#19722](https://github.com/ClickHouse/ClickHouse/pull/19722) ([Azat Khuzhin](https://github.com/azat))。
* 修复非复制 MergeTree 中罕见的 `max_number_of_merges_with_ttl_in_pool` 限制超限问题(可能分配超过限制数量的 TTL 合并)。[#19708](https://github.com/ClickHouse/ClickHouse/pull/19708) ([alesapin](https://github.com/alesapin))。
* Dictionary:改进属性解析时的错误消息。[#19678](https://github.com/ClickHouse/ClickHouse/pull/19678) ([Maksim Kita](https://github.com/kitaisreal))。
* 新增选项,可在读取时禁用校验和验证。此选项绝不应在生产环境中使用。请勿期望禁用后会带来任何性能提升。该选项仅用于实验和基准测试。此设置仅适用于 MergeTree 系列表。其他表引擎以及通过网络接收数据时,始终会进行校验和验证。根据我的观察,禁用校验和验证不会带来性能差异,即使有差异也小于 0.5%。[#19588](https://github.com/ClickHouse/ClickHouse/pull/19588) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 支持 `multiIf` 函数返回常量结果。[#19533](https://github.com/ClickHouse/ClickHouse/pull/19533) ([Maksim Kita](https://github.com/kitaisreal))。
* 为 Map 数据类型启用 length/empty/notEmpty 函数,这些函数返回 Map 中的键数量。[#19530](https://github.com/ClickHouse/ClickHouse/pull/19530) ([taiyang-li](https://github.com/taiyang-li))。
* 为 `clickhouse-benchmark` 添加 `--reconnect` 选项。指定此选项后,将在每次请求前重新建立连接。此功能用于测试场景。[#19872](https://github.com/ClickHouse/ClickHouse/pull/19872) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 支持使用 `.debug` 文件的新位置。修复了 [#19348](https://github.com/ClickHouse/ClickHouse/issues/19348)。[#19520](https://github.com/ClickHouse/ClickHouse/pull/19520) ([Amos Bird](https://github.com/amosbird))。
* `toIPv6` 函数现可解析 `IPv4` 地址。[#19518](https://github.com/ClickHouse/ClickHouse/pull/19518) ([Bharat Nallan](https://github.com/bharatnc))。
* 为 `system.query_log`、`system.processes` 等添加 `http_referer` 字段。此更改解决了 [#19389](https://github.com/ClickHouse/ClickHouse/issues/19389)。[#19390](https://github.com/ClickHouse/ClickHouse/pull/19390) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 通过使更多函数不区分大小写并添加别名来提升 MySQL 兼容性。[#19387](https://github.com/ClickHouse/ClickHouse/pull/19387) ([Daniil Kondratyev](https://github.com/dankondr))。
* 为 MergeTree 数据部分（Wide/Compact/InMemory）类型添加指标。[#19381](https://github.com/ClickHouse/ClickHouse/pull/19381) ([Azat Khuzhin](https://github.com/azat))。
* 允许 Docker 以任意 UID 执行。[#19374](https://github.com/ClickHouse/ClickHouse/pull/19374) ([filimonov](https://github.com/filimonov))。
* 修复了 Pretty 格式中 `IPv4` 数据类型值的错误对齐。之前为右对齐,现已修正为左对齐。此问题已在 [#19184](https://github.com/ClickHouse/ClickHouse/issues/19184) 中关闭。[#19339](https://github.com/ClickHouse/ClickHouse/pull/19339) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 允许在不重启的情况下修改 `max_server_memory_usage`。此更改解决了 [#18154](https://github.com/ClickHouse/ClickHouse/issues/18154)。[#19186](https://github.com/ClickHouse/ClickHouse/pull/19186) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 在之前的版本中,当使用某些 NaN 参数调用函数 `bar` 时抛出的异常信息可能会产生误导。此问题已修复,详见 [#19088](https://github.com/ClickHouse/ClickHouse/issues/19088)。[#19107](https://github.com/ClickHouse/ClickHouse/pull/19107) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 在 clickhouse-server 镜像中将 clickhouse 用户和组的 uid / gid 显式设置为固定值 (101)。[#19096](https://github.com/ClickHouse/ClickHouse/pull/19096) ([filimonov](https://github.com/filimonov))。
* 修复了插入包含超大字符串的数据时出现的 `PeekableReadBuffer: Memory limit exceed` 错误。修复 [#18690](https://github.com/ClickHouse/ClickHouse/issues/18690)。[#18979](https://github.com/ClickHouse/ClickHouse/pull/18979) ([tavplubix](https://github.com/tavplubix))。
* Docker 镜像：对 clickhouse-server 入口点进行了多项改进。[#18954](https://github.com/ClickHouse/ClickHouse/pull/18954) ([filimonov](https://github.com/filimonov))。
* 新增 `normalizeQueryKeepNames` 和 `normalizedQueryHashKeepNames` 函数,用于在规范化查询时保留长名称而不使用 `?` 进行掩码处理。这有助于更好地分析复杂的查询日志。[#18910](https://github.com/ClickHouse/ClickHouse/pull/18910) ([Amos Bird](https://github.com/amosbird))。
* 在发送前检查发送端分布式批次的每块校验和(无需读取文件两次,校验和将在读取时进行验证),这将避免 INSERT 在接收端卡住(当发送端的 .bin 文件被截断时)。避免为批量 INSERT 读取 .bin 文件两次(之前需要计算行数/字节数以便进行压缩合并,现在此信息已包含在头部中,并保持了向后兼容性)。[#18853](https://github.com/ClickHouse/ClickHouse/pull/18853) ([Azat Khuzhin](https://github.com/azat))。
* 修复了对包含聚合函数状态的表执行 RIGHT 和 FULL JOIN 时的问题。在之前的版本中会抛出关于 `cloneResized` 方法的异常。[#18818](https://github.com/ClickHouse/ClickHouse/pull/18818) ([templarzq](https://github.com/templarzq))。
* 新增基于前缀的 S3 端点配置。[#18812](https://github.com/ClickHouse/ClickHouse/pull/18812) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 为 bitmapTransform、bitmapSubsetInRange、bitmapSubsetLimit、bitmapContains 函数添加 [UInt8, UInt16, UInt32, UInt64] 参数类型支持。此更改关闭了 [#18713](https://github.com/ClickHouse/ClickHouse/issues/18713)。[#18791](https://github.com/ClickHouse/ClickHouse/pull/18791) ([sundyli](https://github.com/sundy-li))。
* 允许对 CTE(公用表表达式)进行进一步的别名设置。当 `enable_global_with_statement = 1` 时,将 CSE(公共子表达式消除)传播到同级子查询。此更改修复了 [#17378](https://github.com/ClickHouse/ClickHouse/issues/17378)。此更改修复了 [https://github.com/ClickHouse/ClickHouse/pull/16575#issuecomment-753416235](https://github.com/ClickHouse/ClickHouse/pull/16575#issuecomment-753416235)。[#18684](https://github.com/ClickHouse/ClickHouse/pull/18684) ([Amos Bird](https://github.com/amosbird))。
* 将 librdkafka 更新到 v1.6.0-RC2。修复了 [#18668](https://github.com/ClickHouse/ClickHouse/issues/18668)。[#18671](https://github.com/ClickHouse/ClickHouse/pull/18671) ([filimonov](https://github.com/filimonov))。
* 当发生意外异常时,自动重启负责执行分布式 DDL 查询的后台线程。修复了 [#17991](https://github.com/ClickHouse/ClickHouse/issues/17991)。[#18285](https://github.com/ClickHouse/ClickHouse/pull/18285) ([徐炘](https://github.com/weeds085490))。
* 更新了 AWS C++ SDK 以支持 S3 全球区域。[#17870](https://github.com/ClickHouse/ClickHouse/pull/17870) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 新增在创建 `LIVE VIEW` 表时对 `WITH ... [AND] [PERIODIC] REFRESH [interval_in_sec]` 子句的支持。[#14822](https://github.com/ClickHouse/ClickHouse/pull/14822) ([vzakaznikov](https://github.com/vzakaznikov))。
* 限制对使用旧语法创建的 `MergeTree` 表执行 `MODIFY TTL` 查询。之前该查询虽然执行成功,但实际上不会生效。[#19064](https://github.com/ClickHouse/ClickHouse/pull/19064) ([Anton Popov](https://github.com/CurtizJ))。

#### 错误修复 {#bug-fix-8}


* 修复了带有常量参数的二元函数索引分析问题,该问题导致查询结果错误。此修复解决了 [#18364](https://github.com/ClickHouse/ClickHouse/issues/18364)。[#18373](https://github.com/ClickHouse/ClickHouse/pull/18373) ([Amos Bird](https://github.com/amosbird))。
* 修复了服务器启动时包含 dictGet() 默认表达式的表无法正常启动的问题。允许在不加载字典的情况下获取 dictGet() 的返回类型。[#19805](https://github.com/ClickHouse/ClickHouse/pull/19805) ([Vitaly Baranov](https://github.com/vitlibar))。
* 修复了当 `if` 函数的 then/else 分支结果为 `Tuple` 类型时导致服务器崩溃的问题。该 `Tuple` 类型必须包含 `Array` 或其他复杂类型。修复 [#18356](https://github.com/ClickHouse/ClickHouse/issues/18356)。[#20133](https://github.com/ClickHouse/ClickHouse/pull/20133) ([alesapin](https://github.com/alesapin))。
* `MaterializeMySQL`(实验性功能):修复了涉及更新多个表的语句的复制问题。[#20066](https://github.com/ClickHouse/ClickHouse/pull/20066) ([Håvard Kvålen](https://github.com/havardk))。
* 防止在 Docker 初始化脚本执行期间出现 &quot;Connection refused&quot; 错误。[#20012](https://github.com/ClickHouse/ClickHouse/pull/20012) ([filimonov](https://github.com/filimonov))。
* `EmbeddedRocksDB` 是一个实验性存储引擎。修复了类型检查不完善的问题，并简化了代码。此更改关闭了 [#19967](https://github.com/ClickHouse/ClickHouse/issues/19967)。[#19972](https://github.com/ClickHouse/ClickHouse/pull/19972) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了函数 `fromModifiedJulianDay` 在参数类型为 `Nullable(T)`(其中 T 为 Int32 以外的任意整数类型)时的段错误问题。[#19959](https://github.com/ClickHouse/ClickHouse/pull/19959) ([PHO](https://github.com/depressed-pho))。
* 函数 `greatCircleAngle` 在之前的版本中返回不准确的结果。此问题已在 [#19769](https://github.com/ClickHouse/ClickHouse/issues/19769) 中关闭。[#19789](https://github.com/ClickHouse/ClickHouse/pull/19789) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了一个罕见的 bug,即在数据损坏后某些复制操作(如 mutation)无法处理部分数据分片。修复 [#19593](https://github.com/ClickHouse/ClickHouse/issues/19593)。[#19702](https://github.com/ClickHouse/ClickHouse/pull/19702) ([alesapin](https://github.com/alesapin))。
* 执行 `ON CLUSTER` 查询的后台线程可能会在等待已删除的复制表执行某些操作时挂起。该问题已修复。[#19684](https://github.com/ClickHouse/ClickHouse/pull/19684) ([yiguolei](https://github.com/yiguolei))。
* 修复列描述反序列化错误。此问题会导致无法向包含名为 `\` 的列的表中执行 INSERT 操作。[#19479](https://github.com/ClickHouse/ClickHouse/pull/19479) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 当某个文件中出现空数据块时,将分布式批次标记为已损坏。[#19449](https://github.com/ClickHouse/ClickHouse/pull/19449) ([Azat Khuzhin](https://github.com/azat))。
* 修复了一个极其罕见的 bug,该 bug 可能导致在执行 `DROP/DETACH/REPLACE/MOVE PARTITION` 后 mutation 挂起。此问题在大多数情况下已通过 [#15537](https://github.com/ClickHouse/ClickHouse/issues/15537) 部分修复。[#19443](https://github.com/ClickHouse/ClickHouse/pull/19443) ([tavplubix](https://github.com/tavplubix))。
* 修复可能出现的错误 `Extremes transform was already added to pipeline`。修复了 [#14100](https://github.com/ClickHouse/ClickHouse/issues/14100)。[#19430](https://github.com/ClickHouse/ClickHouse/pull/19430) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了在具有非零默认值的连接类型(例如某些枚举类型)中的默认值问题。关闭 [#18197](https://github.com/ClickHouse/ClickHouse/issues/18197)。[#19360](https://github.com/ClickHouse/ClickHouse/pull/19360) ([vdimir](https://github.com/vdimir))。
* 遇到 EOF 时不再将分布式发送文件标记为损坏。[#19290](https://github.com/ClickHouse/ClickHouse/pull/19290) ([Azat Khuzhin](https://github.com/azat))。
* 修复 `async_socket_for_remote` 的管道文件描述符泄漏。[#19153](https://github.com/ClickHouse/ClickHouse/pull/19153) ([Azat Khuzhin](https://github.com/azat))。
* 修复 `ORC` 格式文件的无限读取问题(此问题在 [#10580](https://github.com/ClickHouse/ClickHouse/issues/10580) 中引入)。修复 [#19095](https://github.com/ClickHouse/ClickHouse/issues/19095)。[#19134](https://github.com/ClickHouse/ClickHouse/pull/19134) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了 MergeTree 数据写入器中可能导致标记大小超过固定粒度大小的问题。修复 [#18913](https://github.com/ClickHouse/ClickHouse/issues/18913)。[#19123](https://github.com/ClickHouse/ClickHouse/pull/19123) ([alesapin](https://github.com/alesapin))。
* 修复了启动时 ClickHouse 无法从 `LowCardinality(Nullable(...))` 读取压缩编解码器而抛出 `Attempt to read after EOF` 异常的问题。修复 [#18340](https://github.com/ClickHouse/ClickHouse/issues/18340)。[#19101](https://github.com/ClickHouse/ClickHouse/pull/19101) ([alesapin](https://github.com/alesapin))。
* 简化了 `tupleHammingDistance` 的实现。支持任意长度相等的元组。修复 [#19029](https://github.com/ClickHouse/ClickHouse/issues/19029)。[#19084](https://github.com/ClickHouse/ClickHouse/pull/19084) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 确保 `groupUniqArray` 函数在处理 Enum 类型参数时返回正确的类型。此问题已在 [#17875](https://github.com/ClickHouse/ClickHouse/issues/17875) 中关闭。[#19019](https://github.com/ClickHouse/ClickHouse/pull/19019) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了在 `ignore` 函数中使用 `LowCardinality` 参数时可能出现的 `Expected single dictionary argument for function` 错误。修复了 [#14275](https://github.com/ClickHouse/ClickHouse/issues/14275)。[#19016](https://github.com/ClickHouse/ClickHouse/pull/19016) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了将 `LowCardinality` 列插入到使用 `TinyLog` 引擎的表时的问题。修复 [#18629](https://github.com/ClickHouse/ClickHouse/issues/18629)。[#19010](https://github.com/ClickHouse/ClickHouse/pull/19010) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复 JOIN 中的小问题:Join 尝试物化常量列,但代码在其他位置等待这些列。[#18982](https://github.com/ClickHouse/ClickHouse/pull/18982) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 禁用 `optimize_move_functions_out_of_any`,因为该优化并非总是正确。此更改关闭了 [#18051](https://github.com/ClickHouse/ClickHouse/issues/18051)。此更改关闭了 [#18973](https://github.com/ClickHouse/ClickHouse/issues/18973)。[#18981](https://github.com/ClickHouse/ClickHouse/pull/18981) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了由查询计划的 `Expression` 步骤合并引起的异常 `QueryPipeline stream: different number of columns`。修复了 [#18190](https://github.com/ClickHouse/ClickHouse/issues/18190)。[#18980](https://github.com/ClickHouse/ClickHouse/pull/18980) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了关闭时极其罕见的死锁。[#18977](https://github.com/ClickHouse/ClickHouse/pull/18977) ([tavplubix](https://github.com/tavplubix))。
* 修复了服务器内存不足时偶发的崩溃问题。[#18976](https://github.com/ClickHouse/ClickHouse/pull/18976) ([tavplubix](https://github.com/tavplubix))。
* 修复了 `ALTER TABLE ... DROP PART 'part_name'` 查询错误地删除整个分区所有去重块的问题。修复 [#18874](https://github.com/ClickHouse/ClickHouse/issues/18874)。[#18969](https://github.com/ClickHouse/ClickHouse/pull/18969) ([alesapin](https://github.com/alesapin))。
* 修复了问题 [#18894](https://github.com/ClickHouse/ClickHouse/issues/18894)，增加了检查以避免当长列别名（&#39;table.column&#39; 样式，通常由 Looker 等 BI 工具自动生成）与长表名相同时出现异常。[#18968](https://github.com/ClickHouse/ClickHouse/pull/18968) ([Daniel Qin](https://github.com/mathfool))。
* 修复错误 `Task was not found in task queue`(仅在远程查询且 `async_socket_for_remote = 1` 时可能出现)。[#18964](https://github.com/ClickHouse/ClickHouse/pull/18964) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了包含转义文本的变更操作(如 `ALTER ... UPDATE e = CAST('foo', 'Enum8(\'foo\' = 1')`)序列化错误的问题。修复 [#18878](https://github.com/ClickHouse/ClickHouse/issues/18878)。[#18944](https://github.com/ClickHouse/ClickHouse/pull/18944) ([alesapin](https://github.com/alesapin))。
* ATTACH PARTITION 将重置 mutation。[#18804](https://github.com/ClickHouse/ClickHouse/issues/18804). [#18935](https://github.com/ClickHouse/ClickHouse/pull/18935) ([fastio](https://github.com/fastio)).
* 修复 `bitmapOrCardinality` 可能导致空指针解引用的问题。此问题已在 [#18911](https://github.com/ClickHouse/ClickHouse/issues/18911) 中关闭。[#18912](https://github.com/ClickHouse/ClickHouse/pull/18912) ([sundyli](https://github.com/sundy-li))。
* 修复了在尝试将 `Nullable(String)` 中的 `NULL` 值 `CAST` 为 `Nullable(Decimal(P, S))` 时出现的 `Attempt to read after eof` 错误。现在当 `CAST` 函数无法从可空字符串中解析十进制数时,会返回 `NULL`。修复 [#7690](https://github.com/ClickHouse/ClickHouse/issues/7690)。[#18718](https://github.com/ClickHouse/ClickHouse/pull/18718) ([Winter Zhang](https://github.com/zhang2014))。
* 修复 MySQL 引擎的数据类型转换问题。[#18124](https://github.com/ClickHouse/ClickHouse/pull/18124) ([bo zeng](https://github.com/mis98zb))。
* 修复 clickhouse-client 在仅执行 `select` 语句时异常中止的问题。[#19790](https://github.com/ClickHouse/ClickHouse/pull/19790) ([taiyang-li](https://github.com/taiyang-li))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-9}

- 在 CI 中运行 [SQLancer](https://twitter.com/RiggerManuel/status/1352345625480884228)(逻辑 SQL 模糊测试器)。[#19006](https://github.com/ClickHouse/ClickHouse/pull/19006) ([Ilya Yatsishin](https://github.com/qoega))。
- Query Fuzzer 将更全面地对新添加的测试进行模糊测试。此更改关闭了 [#18916](https://github.com/ClickHouse/ClickHouse/issues/18916)。[#19185](https://github.com/ClickHouse/ClickHouse/pull/19185) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 集成 [Big List of Naughty Strings](https://github.com/minimaxir/big-list-of-naughty-strings/) 以改进模糊测试。[#19480](https://github.com/ClickHouse/ClickHouse/pull/19480) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 添加使用 MSan 运行的集成测试。[#18974](https://github.com/ClickHouse/ClickHouse/pull/18974) ([alesapin](https://github.com/alesapin))。
- 修复了 cyrus-sasl 和 musl 中的 MemorySanitizer 错误。[#19821](https://github.com/ClickHouse/ClickHouse/pull/19821) ([Ilya Yatsishin](https://github.com/qoega))。
- `positionCaseInsensitiveUTF8` 函数中的参数检查不足触发了地址清理器。[#19720](https://github.com/ClickHouse/ClickHouse/pull/19720) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 在集成测试中移除 docker-compose 的 --project-directory 参数。修复来自 docker 容器的日志格式。[#19706](https://github.com/ClickHouse/ClickHouse/pull/19706) ([Ilya Yatsishin](https://github.com/qoega))。
- 简化了集成测试中 macros.xml 的生成。不再有来自 dicttoxml 的过多日志记录。dicttoxml 项目已经超过 5 年没有活跃维护了。[#19697](https://github.com/ClickHouse/ClickHouse/pull/19697) ([Ilya Yatsishin](https://github.com/qoega))。
- 允许通过环境变量 `CLICKHOUSE_WATCHDOG_ENABLE` 显式启用或禁用看门狗。默认情况下,如果服务器未连接到终端,则启用看门狗。[#19522](https://github.com/ClickHouse/ClickHouse/pull/19522) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 允许在 arm64 上构建支持 Kafka 的 ClickHouse。[#19369](https://github.com/ClickHouse/ClickHouse/pull/19369) ([filimonov](https://github.com/filimonov))。
- 允许在不使用 SSL 的情况下构建 librdkafka。[#19337](https://github.com/ClickHouse/ClickHouse/pull/19337) ([filimonov](https://github.com/filimonov))。
- 在 FreeBSD 构建中恢复 Kafka 输入。[#18924](https://github.com/ClickHouse/ClickHouse/pull/18924) ([Alexandre Snarskii](https://github.com/snar))。
- 修复表函数 `VALUES` 中潜在的空指针解引用问题。[#19357](https://github.com/ClickHouse/ClickHouse/pull/19357) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 避免 `arrayElement` 函数、`substring` 和 `arraySum` 中的 UBSan 报告。修复 [#19305](https://github.com/ClickHouse/ClickHouse/issues/19305)。修复 [#19287](https://github.com/ClickHouse/ClickHouse/issues/19287)。此更改关闭了 [#19336](https://github.com/ClickHouse/ClickHouse/issues/19336)。[#19347](https://github.com/ClickHouse/ClickHouse/pull/19347) ([alexey-milovidov](https://github.com/alexey-milovidov))。


## ClickHouse 21.1 版本 {#clickhouse-release-211}

### ClickHouse v21.1.3.32-stable 版本,2021-02-03 {#clickhouse-release-v211332-stable-2021-02-03}

#### 错误修复 {#bug-fix-9}


* 修复了 BloomFilter 索引崩溃问题。修复 [#19757](https://github.com/ClickHouse/ClickHouse/issues/19757)。[#19884](https://github.com/ClickHouse/ClickHouse/pull/19884) ([Maksim Kita](https://github.com/kitaisreal))。
* 修复将谓词下推到 union distinct 子查询时导致的崩溃问题。此修复解决了 [#19855](https://github.com/ClickHouse/ClickHouse/issues/19855)。[#19861](https://github.com/ClickHouse/ClickHouse/pull/19861) ([Amos Bird](https://github.com/amosbird))。
* 修复 UInt8 类型值大于 127 时的过滤问题。[#19799](https://github.com/ClickHouse/ClickHouse/pull/19799) ([Anton Popov](https://github.com/CurtizJ))。
* 在之前的版本中,为函数 arrayEnumerateUniq 传入异常参数可能导致崩溃或无限循环。此问题已在 [#19787](https://github.com/ClickHouse/ClickHouse/issues/19787) 中关闭。[#19788](https://github.com/ClickHouse/ClickHouse/pull/19788) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了算术类型与字符串类型进行精确比较时的栈溢出问题。[#19773](https://github.com/ClickHouse/ClickHouse/pull/19773) ([tavplubix](https://github.com/tavplubix))。
* 修复了在 `WHERE` 或 `PREWHERE` 中使用嵌套列名时导致崩溃的问题。修复 [#19755](https://github.com/ClickHouse/ClickHouse/issues/19755)。[#19763](https://github.com/ClickHouse/ClickHouse/pull/19763) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了 `bitmapAndnot` 函数中的段错误问题。修复 [#19668](https://github.com/ClickHouse/ClickHouse/issues/19668)。[#19713](https://github.com/ClickHouse/ClickHouse/pull/19713) ([Maksim Kita](https://github.com/kitaisreal))。
* 某些处理大整数的函数可能导致段错误。大整数为实验性功能。此问题已在 [#19667](https://github.com/ClickHouse/ClickHouse/issues/19667) 中关闭。[#19672](https://github.com/ClickHouse/ClickHouse/pull/19672) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了 `neighbor` 函数对 `LowCardinality` 参数返回错误结果的问题。修复 [#10333](https://github.com/ClickHouse/ClickHouse/issues/10333)。[#19617](https://github.com/ClickHouse/ClickHouse/pull/19617) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复断开连接后 Connection 中 CompressedWriteBuffer 的 use-after-free 问题。[#19599](https://github.com/ClickHouse/ClickHouse/pull/19599) ([Azat Khuzhin](https://github.com/azat))。
* `DROP/DETACH TABLE table ON CLUSTER cluster SYNC` 查询可能会挂起，该问题已修复。修复 [#19568](https://github.com/ClickHouse/ClickHouse/issues/19568)。[#19572](https://github.com/ClickHouse/ClickHouse/pull/19572) ([tavplubix](https://github.com/tavplubix))。
* 修复了 CREATE DICTIONARY 查询中 id 表达式的问题。[#19571](https://github.com/ClickHouse/ClickHouse/pull/19571) ([Maksim Kita](https://github.com/kitaisreal))。
* 修复当 merge&#95;tree&#95;min&#95;rows&#95;for&#95;concurrent&#95;read/merge&#95;tree&#95;min&#95;bytes&#95;for&#95;concurrent&#95;read 设置为 0/UINT64&#95;MAX 时导致的 SIGSEGV 错误。[#19528](https://github.com/ClickHouse/ClickHouse/pull/19528) ([Azat Khuzhin](https://github.com/azat))。
* 当使用特定构造的参数调用 `addMonth` 函数时,可能会发生缓冲区溢出(内存读取)。此修复解决了 [#19441](https://github.com/ClickHouse/ClickHouse/issues/19441) 和 [#19413](https://github.com/ClickHouse/ClickHouse/issues/19413)。[#19472](https://github.com/ClickHouse/ClickHouse/pull/19472) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了当加密/解密函数传入空字符串作为 IV 时可能发生的未初始化内存读取问题。此修复关闭了 [#19391](https://github.com/ClickHouse/ClickHouse/issues/19391)。[#19397](https://github.com/ClickHouse/ClickHouse/pull/19397) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复 Uber H3 库中可能存在的缓冲区溢出问题。详见 [https://github.com/uber/h3/issues/392](https://github.com/uber/h3/issues/392)。此修复关闭了 [#19219](https://github.com/ClickHouse/ClickHouse/issues/19219)。[#19383](https://github.com/ClickHouse/ClickHouse/pull/19383) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复 system.parts &#95;state 列(由于顺序不正确,查询此列时会出现 LOGICAL&#95;ERROR)。[#19346](https://github.com/ClickHouse/ClickHouse/pull/19346) ([Azat Khuzhin](https://github.com/azat))。
* 修复了当物化视图与其目标表结构不同时,聚合操作可能导致错误结果或段错误的问题。修复 [#18063](https://github.com/ClickHouse/ClickHouse/issues/18063)。[#19322](https://github.com/ClickHouse/ClickHouse/pull/19322) ([tavplubix](https://github.com/tavplubix))。
* 修复错误 `Cannot convert column now64() because it is constant but values of constants are different in source and result`。延续 [#7156](https://github.com/ClickHouse/ClickHouse/issues/7156)。[#19316](https://github.com/ClickHouse/ClickHouse/pull/19316) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了在处理 ReplicatedMergeTree 表时，并发的 `ALTER` 和 `DROP` 查询可能挂起的错误。[#19237](https://github.com/ClickHouse/ClickHouse/pull/19237) ([alesapin](https://github.com/alesapin))。
* 修复了通过 HTTP 接口使用 `Template` 或 `CustomSeparated` 格式插入数据时出现的 `There is no checkpoint` 错误。修复 [#19021](https://github.com/ClickHouse/ClickHouse/issues/19021)。[#19072](https://github.com/ClickHouse/ClickHouse/pull/19072) ([tavplubix](https://github.com/tavplubix))。
* 在分析阶段,当结果无法计算时,禁用子查询的常量折叠。[#18446](https://github.com/ClickHouse/ClickHouse/pull/18446) ([Azat Khuzhin](https://github.com/azat))。
* 在执行 `MOVE` 或 `REPLACE PARTITION` 之后,或在极少数情况下执行 `DETACH` 或 `DROP PARTITION` 之后,Mutation 可能会因等待某个不存在的数据分片而挂起。该问题已修复。[#15537](https://github.com/ClickHouse/ClickHouse/pull/15537) ([tavplubix](https://github.com/tavplubix))。

### ClickHouse 版本 v21.1.2.15-stable 2021-01-18 {#clickhouse-release-v211215-stable-2021-01-18}

#### 向后不兼容的变更 {#backward-incompatible-change-10}

- 设置 `input_format_null_as_default` 现已默认启用。[#17525](https://github.com/ClickHouse/ClickHouse/pull/17525) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 检查配置文件中 profile 设置的约束条件。如果 users.xml 包含不满足相应约束的设置,服务器将无法启动。[#18486](https://github.com/ClickHouse/ClickHouse/pull/18486) ([tavplubix](https://github.com/tavplubix))。
- 限制 `ALTER MODIFY SETTING` 修改影响数据部分的存储设置(`write_final_mark` 和 `enable_mixed_granularity_parts`)。[#18306](https://github.com/ClickHouse/ClickHouse/pull/18306) ([Amos Bird](https://github.com/amosbird))。
- 将 `insert_quorum_parallel` 默认设置为 1。这比"顺序"仲裁插入使用起来方便得多。但如果您依赖顺序一致性,应将该设置改回零。[#17567](https://github.com/ClickHouse/ClickHouse/pull/17567) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 移除 `sumburConsistentHash` 函数。这解决了 [#18120](https://github.com/ClickHouse/ClickHouse/issues/18120)。[#18656](https://github.com/ClickHouse/ClickHouse/pull/18656) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 移除聚合函数 `timeSeriesGroupSum`、`timeSeriesGroupRateSum`,因为有人反映它们从未正常工作过。这修复了 [#16869](https://github.com/ClickHouse/ClickHouse/issues/16869)。如果您曾成功使用过这些函数,请发送电子邮件至 feedback@clickhouse.com。[#17423](https://github.com/ClickHouse/ClickHouse/pull/17423) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 禁止使用 toUnixTimestamp(Date())(之前它只是返回 Date 的 UInt16 表示)。[#17376](https://github.com/ClickHouse/ClickHouse/pull/17376) ([Azat Khuzhin](https://github.com/azat))。
- 允许在 `avg` 和 `avgWeighted` 函数中使用扩展整数类型(`Int128`、`Int256`、`UInt256`)。同时允许在 `avgWeighted` 函数中对值和权重使用不同类型(整数、十进制、浮点数)。这是一个向后不兼容的变更:现在 `avg` 和 `avgWeighted` 函数始终返回 `Float64`(如文档所述)。在此变更之前,`Decimal` 参数的返回类型也是 `Decimal`。[#15419](https://github.com/ClickHouse/ClickHouse/pull/15419) ([Mike](https://github.com/myrrc))。
- 表达式 `toUUID(N)` 不再有效。请替换为 `toUUID('00000000-0000-0000-0000-000000000000')`。此变更的原因是当 N 非零时 `toUUID(N)` 的结果不够直观。
- 具有不正确"密钥用途"的 SSL 证书将被拒绝。在以前的版本中它们可以正常使用。参见 [#19262](https://github.com/ClickHouse/ClickHouse/issues/19262)。
- 默认配置中对替换文件(`/etc/metrika.xml`)的 `incl` 引用已被移除(`<remote_servers>`、`<zookeeper>`、`<macros>`、`<compression>`、`<networks>`)。如果您正在使用替换文件并依赖这些隐式引用,则应在更新前手动显式地添加带有 `incl="..."` 属性的相应部分。参见 [#18740](https://github.com/ClickHouse/ClickHouse/pull/18740) ([alexey-milovidov](https://github.com/alexey-milovidov))。

#### 新功能 {#new-feature-10}


* 在 ClickHouse 中实现 gRPC 协议。[#15111](https://github.com/ClickHouse/ClickHouse/pull/15111) ([Vitaly Baranov](https://github.com/vitlibar))。
* 支持使用多个 ZooKeeper 集群。[#17070](https://github.com/ClickHouse/ClickHouse/pull/17070) ([fastio](https://github.com/fastio))。
* 实现了 `REPLACE TABLE` 和 `CREATE OR REPLACE TABLE` 查询。[#18521](https://github.com/ClickHouse/ClickHouse/pull/18521) ([tavplubix](https://github.com/tavplubix))。
* 实现 `UNION DISTINCT` 并默认将普通 `UNION` 子句视为 `UNION DISTINCT`。新增设置 `union_default_mode`,允许将其视为 `UNION ALL` 或要求显式指定模式。[#16338](https://github.com/ClickHouse/ClickHouse/pull/16338) ([flynn](https://github.com/ucasFL))。
* 新增函数 `accurateCastOrNull`。该功能解决了 [#10290](https://github.com/ClickHouse/ClickHouse/issues/10290)。在 `x IN (subquery)` 表达式中添加了类型转换功能。该功能解决了 [#10266](https://github.com/ClickHouse/ClickHouse/issues/10266)。[#16724](https://github.com/ClickHouse/ClickHouse/pull/16724) ([Maksim Kita](https://github.com/kitaisreal))。
* IP 字典现已直接支持 `IPv4` / `IPv6` 类型。[#17571](https://github.com/ClickHouse/ClickHouse/pull/17571) ([vdimir](https://github.com/vdimir))。
* IP 字典支持键查询功能。解决了 [#18241](https://github.com/ClickHouse/ClickHouse/issues/18241)。[#18480](https://github.com/ClickHouse/ClickHouse/pull/18480) ([vdimir](https://github.com/vdimir))。
* 为数据导入和导出添加 `*.zst` 压缩/解压缩支持。支持在 `file()` 函数中使用 `*.zst` 格式,以及在 HTTP 客户端中使用 `Content-encoding: zstd`。此更改解决了 [#16791 ](https://github.com/ClickHouse/ClickHouse/issues/16791)。[#17144](https://github.com/ClickHouse/ClickHouse/pull/17144) ([Abi Palagashvili](https://github.com/fibersel))。
* 新增了 `mannWitneyUTest`、`studentTTest` 和 `welchTTest` 聚合函数。对 `rankCorr` 进行了少量重构。[#16883](https://github.com/ClickHouse/ClickHouse/pull/16883) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 新增函数 `countMatches`/`countMatchesCaseInsensitive`。[#17459](https://github.com/ClickHouse/ClickHouse/pull/17459) ([Azat Khuzhin](https://github.com/azat))。
* 实现 `countSubstrings()`/`countSubstringsCaseInsensitive()`/`countSubstringsCaseInsensitiveUTF8()`(统计子字符串出现次数)。[#17347](https://github.com/ClickHouse/ClickHouse/pull/17347) ([Azat Khuzhin](https://github.com/azat))。
* 在 system.query&#95;log 中添加已使用的数据库、表和列的相关信息。新增 `query_kind` 和 `normalized_query_hash` 字段。[#17726](https://github.com/ClickHouse/ClickHouse/pull/17726) ([Amos Bird](https://github.com/amosbird))。
* 新增设置 `optimize_on_insert`。启用后,会对插入的数据块执行与合并操作相同的转换(如 Replacing、Collapsing、Aggregating 等)。该设置默认启用。这可能会影响物化视图和 MaterializeMySQL 的行为(详见说明)。此更改解决了 [#10683](https://github.com/ClickHouse/ClickHouse/issues/10683)。[#16954](https://github.com/ClickHouse/ClickHouse/pull/16954) ([Kruglov Pavel](https://github.com/Avogar))。
* HDFS 的 Kerberos 身份验证。[#16621](https://github.com/ClickHouse/ClickHouse/pull/16621) ([Ilya Golshtein](https://github.com/ilejn))。
* 支持 `SHOW SETTINGS` 语句来显示 system.settings 中的参数。同时还支持 `SHOW CHANGED SETTINGS` 以及 `LIKE/ILIKE` 子句。[#18056](https://github.com/ClickHouse/ClickHouse/pull/18056) ([Jianmei Zhang](https://github.com/zhangjmruc))。
* 函数 `position` 现在支持 `POSITION(needle IN haystack)` 语法以兼容 SQL 标准。此更改解决了 [#18701](https://github.com/ClickHouse/ClickHouse/issues/18701)。... [#18779](https://github.com/ClickHouse/ClickHouse/pull/18779) ([Jianmei Zhang](https://github.com/zhangjmruc))。
* 现在为 MergeTree 系列表新增了存储设置 `max_partitions_to_read`，用于限制单个查询可访问的最大分区数。同时新增了用户设置 `force_max_partition_limit` 以强制执行此限制。[#18712](https://github.com/ClickHouse/ClickHouse/pull/18712) ([Amos Bird](https://github.com/amosbird))。
* 为 `system.part_log` 中插入的数据部分添加 `query_id` 列。关闭 [#10097](https://github.com/ClickHouse/ClickHouse/issues/10097)。[#18644](https://github.com/ClickHouse/ClickHouse/pull/18644) ([flynn](https://github.com/ucasFL))。
* 允许在 CREATE TABLE AS SELECT 语句中指定列定义。示例：`CREATE TABLE t1 (x String) ENGINE = Memory AS SELECT 1;`。[#18060](https://github.com/ClickHouse/ClickHouse/pull/18060) ([Maksim Kita](https://github.com/kitaisreal))。
* 新增 `arrayMin`、`arrayMax`、`arrayAvg` 聚合函数。[#18032](https://github.com/ClickHouse/ClickHouse/pull/18032) ([Maksim Kita](https://github.com/kitaisreal))。
* 实现了 `ATTACH TABLE name FROM 'path/to/data/' (col1 Type1, ...` 查询。该查询会创建一个具有指定结构的新表,并从 `user_files` 目录下的指定路径附加表数据。[#17903](https://github.com/ClickHouse/ClickHouse/pull/17903) ([tavplubix](https://github.com/tavplubix))。
* 为 StorageMemory 添加 mutation 支持。此更改关闭了 [#9117](https://github.com/ClickHouse/ClickHouse/issues/9117)。[#15127](https://github.com/ClickHouse/ClickHouse/pull/15127) ([flynn](https://github.com/ucasFL))。
* 支持 `EXISTS DATABASE name` 语法。[#18458](https://github.com/ClickHouse/ClickHouse/pull/18458) ([Du Chuan](https://github.com/spongedu))。
* 支持内置函数 `isIPv4String` &amp;&amp; `isIPv6String`,类似于 [MySQL](https://github.com/ClickHouse/ClickHouse/compare/master...spongedu:support_is_ipv4?expand=1)。[#18349](https://github.com/ClickHouse/ClickHouse/pull/18349) ([Du Chuan](https://github.com/spongedu))。
* 新增设置 `insert_distributed_one_random_shard = 1`,允许在没有分布式键的情况下向多分片分布式表插入数据。[#18294](https://github.com/ClickHouse/ClickHouse/pull/18294) ([Amos Bird](https://github.com/amosbird))。
* 在 MergeTreeSettings 中新增 `min_compress_block_size` 和 `max_compress_block_size` 设置,这些设置的优先级高于全局设置,设置后即可生效。关闭 [13890](https://github.com/ClickHouse/ClickHouse/issues/13890)。[#17867](https://github.com/ClickHouse/ClickHouse/pull/17867) ([flynn](https://github.com/ucasFL))。
* 添加对 64 位 Roaring 位图的支持。[#17858](https://github.com/ClickHouse/ClickHouse/pull/17858) ([Andy Yang](https://github.com/andyyzh))。
* 扩展了 `OPTIMIZE ... DEDUPLICATE` 语法,允许显式指定(或通过星号/列转换器隐式指定)用于检查重复项的列列表。... [#17846](https://github.com/ClickHouse/ClickHouse/pull/17846) ([Vasily Nemkov](https://github.com/Enmk))。
* 新增函数 `toModifiedJulianDay`、`fromModifiedJulianDay`、`toModifiedJulianDayOrNull` 和 `fromModifiedJulianDayOrNull`。这些函数用于在预推格里高利历日期与修正儒略日数之间进行转换。[#17750](https://github.com/ClickHouse/ClickHouse/pull/17750) ([PHO](https://github.com/depressed-pho))。
* 新增使用自定义 TLD 列表的功能:添加了 `firstSignificantSubdomainCustom` 和 `cutToFirstSignificantSubdomainCustom` 函数。[#17748](https://github.com/ClickHouse/ClickHouse/pull/17748) ([Azat Khuzhin](https://github.com/azat))。
* 新增对 `PROXYv1` 协议的支持,用于封装原生 TCP 接口。允许配额按代理转发的 IP 地址作为键值(适用于 `PROXYv1` 地址和 HTTP 接口的 `X-Forwarded-For` 头)。当您仅通过受信任的代理(如 CloudFlare)提供 ClickHouse 访问,但希望按用户的原始 IP 地址统计资源使用情况时,此功能非常有用。修复了 [#17268](https://github.com/ClickHouse/ClickHouse/issues/17268)。[#17707](https://github.com/ClickHouse/ClickHouse/pull/17707) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 现在 clickhouse-client 支持通过 `EDITOR` 编辑命令,快捷键为 `Alt-Shift-E`。[#17665](https://github.com/ClickHouse/ClickHouse/pull/17665) ([Amos Bird](https://github.com/amosbird))。
* 新增函数 `encodeXMLComponent`,用于转义字符以便将字符串放入 XML 文本节点或属性中。[#17659](https://github.com/ClickHouse/ClickHouse/pull/17659) ([nauta](https://github.com/nautaa))。
* 引入 `DETACH TABLE/VIEW ... PERMANENTLY` 语法,使表在重启后不会自动重新出现(仅通过显式请求)。该表仍可使用简短语法 ATTACH TABLE 重新附加。实现 [#5555](https://github.com/ClickHouse/ClickHouse/issues/5555)。修复 [#13850](https://github.com/ClickHouse/ClickHouse/issues/13850)。[#17642](https://github.com/ClickHouse/ClickHouse/pull/17642) ([filimonov](https://github.com/filimonov))。
* 为 MergeTree 表添加了关于总行数、字节数和数据分片数的异步指标。此修复解决了 [#11714](https://github.com/ClickHouse/ClickHouse/issues/11714)。[#17639](https://github.com/ClickHouse/ClickHouse/pull/17639) ([flynn](https://github.com/ucasFL))。
* 新增 `limit` 和 `offset` 设置用于 SQL 外分页:[#16176](https://github.com/ClickHouse/ClickHouse/issues/16176) 这两个设置对于构建 API 非常有用。它们会影响 SELECT 查询,效果相当于在原查询外层添加 `select * from (your_original_select_query) t limit xxx offset xxx;`。[#17633](https://github.com/ClickHouse/ClickHouse/pull/17633) ([hexiaoting](https://github.com/hexiaoting))。
* 提供了一个新的聚合器组合子:`-SimpleState`,用于通过查询构建 `SimpleAggregateFunction` 类型。这对于定义 AggregatingMergeTree 引擎的物化视图非常有用,同时也有利于投影功能。[#16853](https://github.com/ClickHouse/ClickHouse/pull/16853) ([Amos Bird](https://github.com/amosbird))。
* 为 `clickhouse-client` 和 `clickhouse-local` 新增了 `queries-file` 参数。[#15930](https://github.com/ClickHouse/ClickHouse/pull/15930) ([Maksim Kita](https://github.com/kitaisreal))。
* 为 `clickhouse-benchmark` 添加了 `query` 参数。[#17832](https://github.com/ClickHouse/ClickHouse/pull/17832) ([Maksim Kita](https://github.com/kitaisreal))。
* `EXPLAIN AST` 现在支持除 `SELECT` 之外的查询。[#18136](https://github.com/ClickHouse/ClickHouse/pull/18136) ([taiyang-li](https://github.com/taiyang-li))。

#### 实验性功能 {#experimental-feature-8}

- 新增用于计算文本 n-gram 和 shingle 的 minHash 和 simHash 函数。这些函数用于半重复检测。同时还新增了 `bitHammingDistance` 和 `tupleHammingDistance` 函数。[#7649](https://github.com/ClickHouse/ClickHouse/pull/7649) ([flynn](https://github.com/ucasFL))。
- 新增 `Map` 数据类型。参见 [#1841](https://github.com/ClickHouse/ClickHouse/issues/1841)。Map 的首个版本仅支持 `String` 类型的键和值。[#15806](https://github.com/ClickHouse/ClickHouse/pull/15806) ([hexiaoting](https://github.com/hexiaoting))。
- 实现基于 ANTLR4 运行时的替代 SQL 解析器,该解析器由 EBNF 语法生成。[#11298](https://github.com/ClickHouse/ClickHouse/pull/11298) ([Ivan](https://github.com/abyss7))。

#### 性能改进 {#performance-improvement-10}


* 新的 IP 字典实现，降低了内存消耗，在某些情况下提升了性能，并修复了 bug。[#16804](https://github.com/ClickHouse/ClickHouse/pull/16804) ([vdimir](https://github.com/vdimir))。
* 数据导出的并行格式化。[#11617](https://github.com/ClickHouse/ClickHouse/pull/11617) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* LDAP 集成:在 LDAP 服务器连接配置中新增了 `verification_cooldown` 参数,允许在可配置的时间段内缓存成功的&quot;bind&quot;尝试。[#15988](https://github.com/ClickHouse/ClickHouse/pull/15988) ([Denis Glazachev](https://github.com/traceon))。
* 为 `clickhouse-local` 添加 `--no-system-table` 选项,可在不使用系统表的情况下运行。这避免了 `DateLUT` 的初始化,从而节省启动时可能消耗的可观时间(数十毫秒)。[#18899](https://github.com/ClickHouse/ClickHouse/pull/18899) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 在 `AggregateFunctionWindowFunnelData` 中将 `PODArray` 替换为 `PODArrayWithStackMemory`,以提升 `windowFunnel` 函数的性能。[#18817](https://github.com/ClickHouse/ClickHouse/pull/18817) ([flynn](https://github.com/ucasFL))。
* 在同步 INSERT 到分布式表时,不再向分片发送空块。此更改解决了 [#14571](https://github.com/ClickHouse/ClickHouse/issues/14571)。[#18775](https://github.com/ClickHouse/ClickHouse/pull/18775) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 优化了 StorageMemory 的读取。[#18052](https://github.com/ClickHouse/ClickHouse/pull/18052) ([Maksim Kita](https://github.com/kitaisreal))。
* 使用 Dragonbox 算法替代 ryu 算法进行浮点数到字符串的转换。这显著提升了浮点数到字符串转换的性能。[#17831](https://github.com/ClickHouse/ClickHouse/pull/17831) ([Maksim Kita](https://github.com/kitaisreal))。
* 优化 `IPv6CIDRToRange` 实现性能。[#17569](https://github.com/ClickHouse/ClickHouse/pull/17569) ([vdimir](https://github.com/vdimir))。
* 新增 `remerge_sort_lowered_memory_bytes_ratio` 设置(如果重新合并后内存使用量的降低幅度未达到此比率,则禁用重新合并)。[#17539](https://github.com/ClickHouse/ClickHouse/pull/17539) ([Azat Khuzhin](https://github.com/azat))。
* 改进了在主键中使用 SimpleAggregateFunction(String) 的 AggregatingMergeTree 性能。[#17109](https://github.com/ClickHouse/ClickHouse/pull/17109) ([Azat Khuzhin](https://github.com/azat))。
* 现在 `-If` 组合器已去虚拟化,`count` 也已正确向量化。相关 PR 为 [此 PR](https://github.com/ClickHouse/ClickHouse/pull/17041)。[#17043](https://github.com/ClickHouse/ClickHouse/pull/17043) ([Amos Bird](https://github.com/amosbird))。
* 修复了从 `Merge` 表读取大量 `MergeTree` 表时的性能问题。修复 [#7748](https://github.com/ClickHouse/ClickHouse/issues/7748)。[#16988](https://github.com/ClickHouse/ClickHouse/pull/16988) ([Anton Popov](https://github.com/CurtizJ))。
* 提升了 `repeat` 函数的性能。[#16937](https://github.com/ClickHouse/ClickHouse/pull/16937) ([satanson](https://github.com/satanson))。
* 略微提升了浮点数解析性能。[#16809](https://github.com/ClickHouse/ClickHouse/pull/16809) ([Maksim Kita](https://github.com/kitaisreal))。
* 为 `OPTIMIZE TABLE ... FINAL` 添加跳过已合并分区的功能。[#15939](https://github.com/ClickHouse/ClickHouse/pull/15939) ([Kruglov Pavel](https://github.com/Avogar))。
* 集成 [Daniel Lemire 的 fast&#95;float](https://github.com/lemire/fast_float) 用于解析浮点数。[#16787](https://github.com/ClickHouse/ClickHouse/pull/16787) ([Maksim Kita](https://github.com/kitaisreal))。此功能未启用,因为其性能仍低于 ClickHouse 内置的快速浮点解析器。
* 修复 max&#95;distributed&#95;connections(当 `prefer_localhost_replica = 1` 且 `max_threads != max_distributed_connections` 时会受影响)。[#17848](https://github.com/ClickHouse/ClickHouse/pull/17848) ([Azat Khuzhin](https://github.com/azat))。
* 向 S3 发送数据时自适应选择单部分上传或多部分上传。单部分上传通过新增配置项 `max_single_part_upload_size` 控制。[#17934](https://github.com/ClickHouse/ClickHouse/pull/17934) ([Pavel Kovalenko](https://github.com/Jokser))。
* `PipelineExecutor` 中的异步任务支持。远程查询的异步套接字初步支持。[#17868](https://github.com/ClickHouse/ClickHouse/pull/17868) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 允许在列大小未知的情况下,对紧凑部分使用 `optimize_move_to_prewhere` 优化。[#17330](https://github.com/ClickHouse/ClickHouse/pull/17330) ([Anton Popov](https://github.com/CurtizJ))。

#### 改进 {#improvement-10}


* 避免在使用 `TinyLog` 或 `Log` 表引擎的表上执行 INSERT SELECT 查询自身时发生死锁。此修复关闭了 [#6802](https://github.com/ClickHouse/ClickHouse/issues/6802)。此修复关闭了 [#18691](https://github.com/ClickHouse/ClickHouse/issues/18691)。此修复关闭了 [#16812](https://github.com/ClickHouse/ClickHouse/issues/16812)。此修复关闭了 [#14570](https://github.com/ClickHouse/ClickHouse/issues/14570)。[#15260](https://github.com/ClickHouse/ClickHouse/pull/15260) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 支持 `SHOW CREATE VIEW name` 语法，与 [MySQL](https://dev.mysql.com/doc/refman/5.7/en/show-create-view.html) 类似。[#18095](https://github.com/ClickHouse/ClickHouse/pull/18095) ([Du Chuan](https://github.com/spongedu))。
* 现在允许所有 `Decimal * Float` 类型的查询(反之亦然),包括聚合查询(例如 `SELECT sum(decimal_field * 1.1)` 或 `SELECT dec_col * float_col`),结果类型为 Float32 或 Float64。[#18145](https://github.com/ClickHouse/ClickHouse/pull/18145) ([Mike](https://github.com/myrrc))。
* 改进了精简版 Web UI：添加历史记录；添加分享支持；避免不同请求的竞态条件；添加请求执行中和就绪状态指示器；添加网站图标；支持在文本框未获得焦点时检测 Ctrl+Enter 快捷键。[#17293](https://github.com/ClickHouse/ClickHouse/pull/17293) [#17770](https://github.com/ClickHouse/ClickHouse/pull/17770) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* clickhouse-server 未向 ZooKeeper 服务器发送 `close` 请求。[#16837](https://github.com/ClickHouse/ClickHouse/pull/16837) ([alesapin](https://github.com/alesapin))。
* 避免在内存限制过低（`max_memory_usage = 1` / `max_untracked_memory = 1`）时导致服务器异常终止。[#17453](https://github.com/ClickHouse/ClickHouse/pull/17453) ([Azat Khuzhin](https://github.com/azat))。
* 修复了当不同事件具有相同时间戳时 `windowFunnel` 函数产生非确定性结果的问题。[#18884](https://github.com/ClickHouse/ClickHouse/pull/18884) ([Fuwang Hu](https://github.com/fuwhu))。
* Docker:在 clickhouse-server Docker 镜像中显式将 clickhouse 用户和组的 uid/gid 设置为固定值 (101)。[#19096](https://github.com/ClickHouse/ClickHouse/pull/19096) ([filimonov](https://github.com/filimonov))。
* `Distributed` 表的异步 INSERT：新增了两个设置（类比 MergeTree 系列）：- `fsync_after_insert` - 每次插入后执行 fsync。会降低插入性能。- `fsync_directories` - 在所有操作（写入、重命名等）完成后对临时目录（仅用于异步 INSERT）执行 fsync。[#18864](https://github.com/ClickHouse/ClickHouse/pull/18864) ([Azat Khuzhin](https://github.com/azat))。
* `SYSTEM KILL` 命令现已在 Docker 中正常工作。此更改修复了 [#18847](https://github.com/ClickHouse/ClickHouse/issues/18847)。[#18848](https://github.com/ClickHouse/ClickHouse/pull/18848) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 执行 `FETCH PARTITION` 时展开 ZooKeeper 路径中的宏。[#18839](https://github.com/ClickHouse/ClickHouse/pull/18839) ([fastio](https://github.com/fastio))。
* 将 `ALTER TABLE <replicated_table> ON CLUSTER MODIFY SETTING ...` 应用于所有副本。因为此类 alter 命令不会被复制。[#18789](https://github.com/ClickHouse/ClickHouse/pull/18789) ([Amos Bird](https://github.com/amosbird))。
* 允许列转换器 `EXCEPT` 接受字符串作为正则表达式匹配器。此更改解决了 [#18685](https://github.com/ClickHouse/ClickHouse/issues/18685)。[#18699](https://github.com/ClickHouse/ClickHouse/pull/18699) ([Amos Bird](https://github.com/amosbird))。
* 修复了 SummingMergeTree 中 SimpleAggregateFunction 的问题。现在它的行为与 AggregateFunction 一致。在之前的版本中,无论指定何种聚合函数,值都会被直接求和。此修复解决了 [#18564](https://github.com/ClickHouse/ClickHouse/issues/18564)、[#8052](https://github.com/ClickHouse/ClickHouse/issues/8052)。[#18637](https://github.com/ClickHouse/ClickHouse/pull/18637) ([Amos Bird](https://github.com/amosbird))。另一个 `SummingMergeTree` 中使用 `SimpleAggregateFunction` 的修复。此修复解决了 [#18676](https://github.com/ClickHouse/ClickHouse/issues/18676)。[#18677](https://github.com/ClickHouse/ClickHouse/pull/18677) ([Amos Bird](https://github.com/amosbird))。
* 修复了当函数 bar 的最后一个参数为 NaN 时分配器内部的断言错误。现在会抛出 ClickHouse 标准异常。此修复解决了 [#17876](https://github.com/ClickHouse/ClickHouse/issues/17876)。[#18520](https://github.com/ClickHouse/ClickHouse/pull/18520) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 修复可用性问题:某些工具中异常消息后缺少换行符。[#18444](https://github.com/ClickHouse/ClickHouse/pull/18444) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 新增支持将主键和分区键列类型在 `LowCardinality(Type)` 和 `Type` 之间相互转换的功能。同时新增支持将主键列类型从 `EnumX` 转换为 `IntX` 类型的功能。修复 [#5604](https://github.com/ClickHouse/ClickHouse/issues/5604)。[#18362](https://github.com/ClickHouse/ClickHouse/pull/18362) ([alesapin](https://github.com/alesapin))。
* 实现 `untuple` 字段访问功能。[#18133](https://github.com/ClickHouse/ClickHouse/issues/18133). [#18309](https://github.com/ClickHouse/ClickHouse/pull/18309) ([hexiaoting](https://github.com/hexiaoting)).
* 允许从 CSV 中解析 Array 字段,当其表示为包含嵌套 CSV 序列化数组的字符串时。示例:`"[""Hello"", ""world"", ""42"""" TV""]"` 将被解析为 `['Hello', 'world', '42" TV']`。允许解析 CSV 中不带外层方括号的字符串形式数组。示例:`"'Hello', 'world', '42"" TV'"` 将被解析为 `['Hello', 'world', '42" TV']`。[#18271](https://github.com/ClickHouse/ClickHouse/pull/18271) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 改进 MergeTree 宽格式数据分区的自适应粒度计算。[#18223](https://github.com/ClickHouse/ClickHouse/pull/18223) ([alesapin](https://github.com/alesapin))。
* 现在 `clickhouse install` 可以在 Mac 上正常工作了。此前的问题是该平台上没有 procfs。[#18201](https://github.com/ClickHouse/ClickHouse/pull/18201) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 改进了 `SHOW ...` 查询语法的提示。[#18183](https://github.com/ClickHouse/ClickHouse/pull/18183) ([Du Chuan](https://github.com/spongedu))。
* 数组聚合函数 `arrayMin`、`arrayMax`、`arraySum`、`arrayAvg` 现已支持 `Int128`、`Int256`、`UInt256` 数据类型。[#18147](https://github.com/ClickHouse/ClickHouse/pull/18147) ([Maksim Kita](https://github.com/kitaisreal))。
* 为 Set 和 Join 存储引擎添加 `disk` 配置项。[#18112](https://github.com/ClickHouse/ClickHouse/pull/18112) ([Grigory Pervakov](https://github.com/GrigoryPervakov))。
* 访问控制:现在表函数 `merge()` 要求当前用户对其读取数据的每个表都具有 `SELECT` 权限。此 PR 修复了 [#16964](https://github.com/ClickHouse/ClickHouse/issues/16964)。[#18104](https://github.com/ClickHouse/ClickHouse/pull/18104) [#17983](https://github.com/ClickHouse/ClickHouse/pull/17983) ([Vitaly Baranov](https://github.com/vitlibar))。
* 临时表现在仅在创建它们的会话中可见于系统表 `system.tables` 和 `system.columns`。内部数据库 `_temporary_and_external_tables` 现在在这些系统表中已被隐藏;临时表会显示为数据库名为空的表,并设置 `is_temporary` 标志。[#18014](https://github.com/ClickHouse/ClickHouse/pull/18014) ([Vitaly Baranov](https://github.com/vitlibar))。
* 修复了终端窗口大小改变时 clickhouse-client 的渲染问题。[#18009](https://github.com/ClickHouse/ClickHouse/pull/18009) ([Amos Bird](https://github.com/amosbird))。
* 降低客户端断开连接时事件日志的详细级别,从 Warning 改为 Information。[#18005](https://github.com/ClickHouse/ClickHouse/pull/18005) ([filimonov](https://github.com/filimonov))。
* 强制从文件系统中移除 DiskS3 的空元数据文件或损坏的元数据文件。S3 是实验性功能。[#17935](https://github.com/ClickHouse/ClickHouse/pull/17935) ([Pavel Kovalenko](https://github.com/Jokser))。
* 访问控制：`allow_introspection_functions=0` 禁止使用内省函数，但不再禁止为其授予权限（被授权者需要自行设置 `allow_introspection_functions=1` 才能使用该授权）。同样，`allow_ddl=0` 禁止使用 DDL 命令，但不再禁止为其授予权限。[#17908](https://github.com/ClickHouse/ClickHouse/pull/17908) ([Vitaly Baranov](https://github.com/vitlibar))。
* 可用性改进:列名提示。[#17112](https://github.com/ClickHouse/ClickHouse/issues/17112). [#17857](https://github.com/ClickHouse/ClickHouse/pull/17857) ([fastio](https://github.com/fastio)).
* 当两个 Merge 表尝试相互读取数据时添加诊断信息。[#17854](https://github.com/ClickHouse/ClickHouse/pull/17854) ([徐炘](https://github.com/weeds085490))。
* 允许在使用 ClickHouse Docker 镜像运行脚本时覆盖超时值。[#17818](https://github.com/ClickHouse/ClickHouse/pull/17818) ([Guillaume Tassery](https://github.com/YiuRULE))。
* 检查系统日志表的引擎定义语法以防止某些配置错误。注意,此语法检查不是语义检查,这意味着不存在的列/表达式函数等错误只有在创建表时才会被发现。[#17739](https://github.com/ClickHouse/ClickHouse/pull/17739) ([Du Chuan](https://github.com/spongedu))。
* 移除了 `RabbitMQ` 表初始化时无连接抛出异常的行为(现在会在后台自动重连)。[#17709](https://github.com/ClickHouse/ClickHouse/pull/17709) ([Kseniia Sumarokova](https://github.com/kssenii))。
* Buffer 刷新时不再忽略服务器内存限制。[#17646](https://github.com/ClickHouse/ClickHouse/pull/17646) ([Azat Khuzhin](https://github.com/azat))。
* 切换到 RocksDB 的补丁版本(来自 ClickHouse-Extras)以修复 use-after-free 错误。[#17643](https://github.com/ClickHouse/ClickHouse/pull/17643) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 为并行解析的异常消息添加了偏移量。修复了 [#17457](https://github.com/ClickHouse/ClickHouse/issues/17457)。[#17641](https://github.com/ClickHouse/ClickHouse/pull/17641) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 在 INSERT 查询执行过程中不再抛出 &quot;Too many parts&quot; 错误。[#17566](https://github.com/ClickHouse/ClickHouse/pull/17566) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 允许在 ALTER 查询的 UPDATE 语句中使用查询参数。修复了 [#10976](https://github.com/ClickHouse/ClickHouse/issues/10976)。[#17563](https://github.com/ClickHouse/ClickHouse/pull/17563) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 查询混淆器:避免使用某些 SQL 关键字作为标识符名称。[#17526](https://github.com/ClickHouse/ClickHouse/pull/17526) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 通过服务器指标导出 DDLWorker 已执行的当前最大 DDL 条目。这有助于检查 DDLWorker 是否卡住。[#17464](https://github.com/ClickHouse/ClickHouse/pull/17464) ([Amos Bird](https://github.com/amosbird))。
* 导出所有服务器当前线程的异步指标。这有助于排查类似[此处](https://github.com/ClickHouse-Extras/poco/pull/28)的问题。[#17463](https://github.com/ClickHouse/ClickHouse/pull/17463) ([Amos Bird](https://github.com/amosbird))。
* 当设置 `asterisk_include_materialized_columns` 和 `asterisk_include_alias_columns` 启用时,通配符查询将包含 MATERIALIZED / ALIAS 等动态列。[#17462](https://github.com/ClickHouse/ClickHouse/pull/17462) ([Ken Chen](https://github.com/chenziliang))。
* 允许在 `config.xml` 中使用 `<ttl>` 属性为[系统日志表](/operations/system-tables/)指定 [TTL](/engines/table-engines/mergetree-family/mergetree/#mergetree-table-ttl)，以删除旧条目。[#17438](https://github.com/ClickHouse/ClickHouse/pull/17438) ([Du Chuan](https://github.com/spongedu))。
* 现在通过 MySQL 和 PostgreSQL 协议发送到服务器的查询具有不同的接口类型(可在 `system.query_log` 表的 `interface` 列中查看):MySQL 为 `4`,PostgreSQL 为 `5`,不再使用以前的 `1`,`1` 现在仅用于原生协议。[#17437](https://github.com/ClickHouse/ClickHouse/pull/17437) ([Vitaly Baranov](https://github.com/vitlibar))。
* 修复 `INSERT ... SELECT ... SETTINGS` 查询的 SETTINGS 子句解析问题。[#17414](https://github.com/ClickHouse/ClickHouse/pull/17414) ([Azat Khuzhin](https://github.com/azat))。
* 正确统计 RadixSort 中的内存使用。[#17412](https://github.com/ClickHouse/ClickHouse/pull/17412) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 在服务器的 `receiveHello` 中添加 EOF 检查,以防止出现 `Attempt to read after eof` 异常。[#17365](https://github.com/ClickHouse/ClickHouse/pull/17365) ([Kruglov Pavel](https://github.com/Avogar))。
* 避免 bigint 转换时可能发生的栈溢出。大整数为实验性功能。[#17269](https://github.com/ClickHouse/ClickHouse/pull/17269) ([flynn](https://github.com/ucasFL))。
* 现在 `set` 索引可以与 `GLOBAL IN` 配合使用。此更改修复了 [#17232](https://github.com/ClickHouse/ClickHouse/issues/17232)、[#5576](https://github.com/ClickHouse/ClickHouse/issues/5576)。[#17253](https://github.com/ClickHouse/ClickHouse/pull/17253) ([Amos Bird](https://github.com/amosbird))。
* 为 S3 存储请求添加 HTTP 重定向次数限制(`s3_max_redirects`)。[#17220](https://github.com/ClickHouse/ClickHouse/pull/17220) ([ianton-ru](https://github.com/ianton-ru))。
* 当 `-OrNull` 组合器与 `-If`、`-Merge`、`-MergeState`、`-State` 组合器组合使用时,应将 `-OrNull` 放在前面。[#16935](https://github.com/ClickHouse/ClickHouse/pull/16935) ([flynn](https://github.com/ucasFL))。
* 支持 HTTP 代理和 HTTPS S3 端点配置。[#16861](https://github.com/ClickHouse/ClickHouse/pull/16861) ([Pavel Kovalenko](https://github.com/Jokser))。
* 为 S3 客户端添加了完善的身份验证支持,支持通过环境变量、`~/.aws` 配置文件和 `AssumeRole` 进行认证。[#16856](https://github.com/ClickHouse/ClickHouse/pull/16856) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 新增更多 OpenTelemetry span。新增将 span 数据导出到 Zipkin 的示例。[#16535](https://github.com/ClickHouse/ClickHouse/pull/16535) ([Alexander Kuzmenkov](https://github.com/akuzm))。
* 缓存字典：完全消除了获取字典时的回调和锁。键不再区分&quot;未找到&quot;和&quot;已过期&quot;两种状态，而是在查询期间统一存储在同一个映射表中。[#14958](https://github.com/ClickHouse/ClickHouse/pull/14958) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 修复了一直未能正常工作的 `fsync_part_directory`/`fsync_after_insert`/`in_memory_parts_insert_sync`(实验性功能)。[#18845](https://github.com/ClickHouse/ClickHouse/pull/18845) ([Azat Khuzhin](https://github.com/azat))。
* 允许为 `MaterializeMySQL` 引擎的嵌套数据库使用 `Atomic` 引擎。[#14849](https://github.com/ClickHouse/ClickHouse/pull/14849) ([tavplubix](https://github.com/tavplubix))。

#### 错误修复 {#bug-fix-10}


* 修复了极少数情况下服务器停止接受连接的问题。[#17542](https://github.com/ClickHouse/ClickHouse/pull/17542) (Amos Bird, [alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了带有常量参数的二元函数索引分析问题,该问题导致查询结果错误。此修复解决了 [#18364](https://github.com/ClickHouse/ClickHouse/issues/18364)。[#18373](https://github.com/ClickHouse/ClickHouse/pull/18373) ([Amos Bird](https://github.com/amosbird))。
* 修复了索引比较类型不一致时可能导致的索引分析错误。此修复解决了 [#17122](https://github.com/ClickHouse/ClickHouse/issues/17122)。[#17145](https://github.com/ClickHouse/ClickHouse/pull/17145) ([Amos Bird](https://github.com/amosbird))。
* 禁用合并期间使用 AIO 写入,因为这可能导致合并过程中主键列出现极其罕见的数据损坏。[#18481](https://github.com/ClickHouse/ClickHouse/pull/18481) ([alesapin](https://github.com/alesapin))。
* 限制从宽格式数据分区到紧凑格式数据分区的合并。在垂直合并的情况下,这会导致结果分区损坏。[#18381](https://github.com/ClickHouse/ClickHouse/pull/18381) ([Anton Popov](https://github.com/CurtizJ))。
* 修复了在读取回退情况下从 `MergeTree*` 读取时可能导致查询结果不完整的问题(日志中会出现 `<Debug> MergeTreeReadPool: Will lower number of threads` 消息)。此问题由 [#16423](https://github.com/ClickHouse/ClickHouse/issues/16423) 引入。修复了 [#18137](https://github.com/ClickHouse/ClickHouse/issues/18137)。[#18216](https://github.com/ClickHouse/ClickHouse/pull/18216) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复 `rocksdb` 库中的释放后使用错误。[#18862](https://github.com/ClickHouse/ClickHouse/pull/18862) ([sundyli](https://github.com/sundy-li))。
* 修复 `ORC` 格式文件的无限读取问题(此问题在 [#10580](https://github.com/ClickHouse/ClickHouse/issues/10580) 中引入)。修复 [#19095](https://github.com/ClickHouse/ClickHouse/issues/19095)。[#19134](https://github.com/ClickHouse/ClickHouse/pull/19134) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了 MergeTree 数据写入器中的一个错误,该错误可能导致标记大小超过固定的 granularity 大小。修复 [#18913](https://github.com/ClickHouse/ClickHouse/issues/18913)。[#19123](https://github.com/ClickHouse/ClickHouse/pull/19123) ([alesapin](https://github.com/alesapin))。
* 修复了启动时 ClickHouse 无法从 `LowCardinality(Nullable(...))` 读取压缩编解码器而抛出 `Attempt to read after EOF` 异常的问题。修复 [#18340](https://github.com/ClickHouse/ClickHouse/issues/18340)。[#19101](https://github.com/ClickHouse/ClickHouse/pull/19101) ([alesapin](https://github.com/alesapin))。
* 限制对使用旧语法创建的 `MergeTree` 表执行 `MODIFY TTL` 查询。之前该查询虽然执行成功,但实际上不会生效。[#19064](https://github.com/ClickHouse/ClickHouse/pull/19064) ([Anton Popov](https://github.com/CurtizJ))。
* 确保 `groupUniqArray` 函数在处理 Enum 类型参数时返回正确的类型。此问题已在 [#17875](https://github.com/ClickHouse/ClickHouse/issues/17875) 中关闭。[#19019](https://github.com/ClickHouse/ClickHouse/pull/19019) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了在 `ignore` 函数中使用 `LowCardinality` 参数时可能出现的 `Expected single dictionary argument for function` 错误。修复了 [#14275](https://github.com/ClickHouse/ClickHouse/issues/14275)。[#19016](https://github.com/ClickHouse/ClickHouse/pull/19016) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了向使用 `TinyLog` 引擎的表插入 `LowCardinality` 列的问题。修复 [#18629](https://github.com/ClickHouse/ClickHouse/issues/18629)。[#19010](https://github.com/ClickHouse/ClickHouse/pull/19010) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* Join 尝试物化常量列,但我们的代码希望将它们放在其他位置。[#18982](https://github.com/ClickHouse/ClickHouse/pull/18982) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 禁用 `optimize_move_functions_out_of_any`,因为该优化并非总是正确。此更改关闭了 [#18051](https://github.com/ClickHouse/ClickHouse/issues/18051)。此更改关闭了 [#18973](https://github.com/ClickHouse/ClickHouse/issues/18973)。[#18981](https://github.com/ClickHouse/ClickHouse/pull/18981) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了由查询计划的 `Expression` 步骤合并引起的异常 `QueryPipeline stream: different number of columns`。修复了 [#18190](https://github.com/ClickHouse/ClickHouse/issues/18190)。[#18980](https://github.com/ClickHouse/ClickHouse/pull/18980) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了关闭时极其罕见的死锁。[#18977](https://github.com/ClickHouse/ClickHouse/pull/18977) ([tavplubix](https://github.com/tavplubix))。
* 修复了 `ALTER TABLE ... DROP PART 'part_name'` 查询错误地删除整个分区所有去重块的问题。修复 [#18874](https://github.com/ClickHouse/ClickHouse/issues/18874)。[#18969](https://github.com/ClickHouse/ClickHouse/pull/18969) ([alesapin](https://github.com/alesapin))。
* 附加分区操作应重置 mutation。[#18804](https://github.com/ClickHouse/ClickHouse/issues/18804)。[#18935](https://github.com/ClickHouse/ClickHouse/pull/18935) ([fastio](https://github.com/fastio))。
* 修复 `bitmapOrCardinality` 可能导致空指针解引用的问题。此问题已在 [#18911](https://github.com/ClickHouse/ClickHouse/issues/18911) 中关闭。[#18912](https://github.com/ClickHouse/ClickHouse/pull/18912) ([sundyli](https://github.com/sundy-li))。
* 修复 `clickhouse-local` 关闭时可能挂起的问题。此修复解决了 [#18891](https://github.com/ClickHouse/ClickHouse/issues/18891)。[#18893](https://github.com/ClickHouse/ClickHouse/pull/18893) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 当查询包含 `x IN table` 形式的表达式时,针对外部数据库(MySQL、ODBC、JDBC)的查询会被错误地重写。此问题已修复 [#9756](https://github.com/ClickHouse/ClickHouse/issues/9756)。[#18876](https://github.com/ClickHouse/ClickHouse/pull/18876) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复 *If 组合器与一元函数和 Nullable 类型配合使用时的问题。[#18806](https://github.com/ClickHouse/ClickHouse/pull/18806) ([Azat Khuzhin](https://github.com/azat))。
* 修复了当 `network_compression_method` 设置全局配置为非默认值时,服务器可能拒绝异步分布式 INSERT 操作的问题。此修复解决了 [#18741](https://github.com/ClickHouse/ClickHouse/issues/18741)。[#18776](https://github.com/ClickHouse/ClickHouse/pull/18776) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了在尝试将 `Nullable(String)` 中的 `NULL` 值 `CAST` 为 `Nullable(Decimal(P, S))` 时出现的 `Attempt to read after eof` 错误。现在当 `CAST` 函数无法从可空字符串中解析十进制数时,会返回 `NULL`。修复 [#7690](https://github.com/ClickHouse/ClickHouse/issues/7690)。[#18718](https://github.com/ClickHouse/ClickHouse/pull/18718) ([Winter Zhang](https://github.com/zhang2014))。
* 修复日志记录中的小问题。[#18717](https://github.com/ClickHouse/ClickHouse/pull/18717) ([sundyli](https://github.com/sundy-li))。
* 修复了使用旧语法创建的 `ReplicatedMergeTree` 表中空数据部分的删除问题。修复 [#18582](https://github.com/ClickHouse/ClickHouse/issues/18582)。[#18614](https://github.com/ClickHouse/ClickHouse/pull/18614) ([Anton Popov](https://github.com/CurtizJ))。
* 修复了之前日期溢出导致值异常的错误。严格限制 Date 值上限为 &quot;2106-02-07&quot;,将超过 &quot;2106-02-07&quot; 的日期值转换为 0。[#18565](https://github.com/ClickHouse/ClickHouse/pull/18565) ([hexiaoting](https://github.com/hexiaoting))。
* 为 MySQL 复制功能添加 FixedString 数据类型支持。MySQL 复制是一个实验性功能。此补丁修复了 [#18450](https://github.com/ClickHouse/ClickHouse/issues/18450),同时也修复了 [#6556](https://github.com/ClickHouse/ClickHouse/issues/6556)。[#18553](https://github.com/ClickHouse/ClickHouse/pull/18553) ([awesomeleo](https://github.com/awesomeleo))。
* 修复在带有 `RIGHT` 或 `FULL` 连接的子查询之后使用 `ORDER BY` 时可能出现的 `Pipeline stuck` 错误。[#18550](https://github.com/ClickHouse/ClickHouse/pull/18550) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了一个可能导致 `ALTER` 查询在相应 mutation 被终止后挂起的错误。通过线程模糊测试发现。[#18518](https://github.com/ClickHouse/ClickHouse/pull/18518) ([alesapin](https://github.com/alesapin))。
* `parseDateTimeBestEffort` 函数现已正确支持 12AM。此修复解决了 [#18402](https://github.com/ClickHouse/ClickHouse/issues/18402)。[#18449](https://github.com/ClickHouse/ClickHouse/pull/18449) ([vladimir-golovchenko](https://github.com/vladimir-golovchenko))。
* 修复了执行 `toType(...)` 函数(如 `toDate`、`toUInt32` 等)时,参数类型为 `Nullable(String)` 导致的 `value is too short` 错误。现在这些函数在解析错误时会返回 `NULL` 而不是抛出异常。修复 [#7673](https://github.com/ClickHouse/ClickHouse/issues/7673)。[#18445](https://github.com/ClickHouse/ClickHouse/pull/18445) ([tavplubix](https://github.com/tavplubix))。
* 修复 `SHOW TABLES` 的异常行为。[#18431](https://github.com/ClickHouse/ClickHouse/pull/18431) ([fastio](https://github.com/fastio))。
* 修复 -SimpleState 组合器生成不兼容的参数类型和返回类型的问题。[#18404](https://github.com/ClickHouse/ClickHouse/pull/18404) ([Amos Bird](https://github.com/amosbird))。
* 修复了并发使用 `Set` 或 `Join` 表以及从 `system.tables` 进行查询时可能出现的竞态条件。[#18385](https://github.com/ClickHouse/ClickHouse/pull/18385) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复 `system.settings_profile_elements` 表的填充问题。此 PR 修复了 [#18231](https://github.com/ClickHouse/ClickHouse/issues/18231)。[#18379](https://github.com/ClickHouse/ClickHouse/pull/18379) ([Vitaly Baranov](https://github.com/vitlibar))。
* 修复了使用两级聚合时，带有 `Distinct` 组合器的聚合函数可能崩溃的问题。修复 [#17682](https://github.com/ClickHouse/ClickHouse/issues/17682)。[#18365](https://github.com/ClickHouse/ClickHouse/pull/18365) ([Anton Popov](https://github.com/CurtizJ))。
* 修复了在 IPv4/IPv6 双栈机器上服务器无法访问 `clickhouse-odbc-bridge` 进程的问题;修复了 ODBC 字典更新时使用格式错误的查询和/或导致 odbc-bridge 进程崩溃的问题;可能解决了 [#14489](https://github.com/ClickHouse/ClickHouse/issues/14489)。[#18278](https://github.com/ClickHouse/ClickHouse/pull/18278) ([Denis Glazachev](https://github.com/traceon))。
* 访问控制:现在只要用户拥有表中任意一列的访问权限,即可执行 `SELECT count() FROM table`。此 PR 修复了 [#10639](https://github.com/ClickHouse/ClickHouse/issues/10639)。[#18233](https://github.com/ClickHouse/ClickHouse/pull/18233) ([Vitaly Baranov](https://github.com/vitlibar))。
* 访问控制：`SELECT JOIN` 现在要求对每个参与连接的表都具有 `SELECT` 权限。此 PR 修复了 [#17654](https://github.com/ClickHouse/ClickHouse/issues/17654)。[#18232](https://github.com/ClickHouse/ClickHouse/pull/18232) ([Vitaly Baranov](https://github.com/vitlibar))。
* 修复 Enum 和 Int 类型之间的键比较。此修复解决了 [#17989](https://github.com/ClickHouse/ClickHouse/issues/17989)。[#18214](https://github.com/ClickHouse/ClickHouse/pull/18214) ([Amos Bird](https://github.com/amosbird))。
* 从 MySQL 复制(实验性功能)。修复 [#18186](https://github.com/ClickHouse/ClickHouse/issues/18186) 修复 [#16372](https://github.com/ClickHouse/ClickHouse/issues/16372) 修复了 MaterializeMySQL 数据库引擎中的唯一键转换问题。[#18211](https://github.com/ClickHouse/ClickHouse/pull/18211) ([Winter Zhang](https://github.com/zhang2014))。
* 修复同时使用 `WITH FILL` 和 `WITH TIES` 的查询不一致问题 [#17466](https://github.com/ClickHouse/ClickHouse/issues/17466)。[#18188](https://github.com/ClickHouse/ClickHouse/pull/18188) ([hexiaoting](https://github.com/hexiaoting))。
* 修复了最后一列解析错误时无法插入默认值行的问题。修复 [#17712](https://github.com/ClickHouse/ClickHouse/issues/17712)。[#18182](https://github.com/ClickHouse/ClickHouse/pull/18182) ([Jianmei Zhang](https://github.com/zhangjmruc))。
* 修复尝试设置设置配置文件时出现的 `Unknown setting profile` 错误。[#18167](https://github.com/ClickHouse/ClickHouse/pull/18167) ([tavplubix](https://github.com/tavplubix))。
* 修复了 `MODIFY COLUMN ... REMOVE TTL` 查询未能实际删除列 TTL 的错误。[#18130](https://github.com/ClickHouse/ClickHouse/pull/18130) ([alesapin](https://github.com/alesapin))。
* 修复了 S3 URL 解析中的 `std::out_of_range: basic_string` 异常。[#18059](https://github.com/ClickHouse/ClickHouse/pull/18059) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 修复了 `DateTime64` 和 `Date` 的比较问题。修复了 [#13804](https://github.com/ClickHouse/ClickHouse/issues/13804) 和 [#11222](https://github.com/ClickHouse/ClickHouse/issues/11222)。... [#18050](https://github.com/ClickHouse/ClickHouse/pull/18050) ([Vasily Nemkov](https://github.com/Enmk))。
* 从 MySQL 复制(实验性功能):修复 [#15187](https://github.com/ClickHouse/ClickHouse/issues/15187) 修复 [#17912](https://github.com/ClickHouse/ClickHouse/issues/17912) 支持将 MySQL 前缀索引转换为 MaterializeMySQL。[#17944](https://github.com/ClickHouse/ClickHouse/pull/17944) ([Winter Zhang](https://github.com/zhang2014))。
* 当使用 `logger.size` 参数配置服务器日志轮转且数值大于 2^32 时,日志无法正确轮转。该问题已修复。[#17905](https://github.com/ClickHouse/ClickHouse/pull/17905) ([Alexander Kuzmenkov](https://github.com/akuzm))。
* 当查询包含 ARRAY JOIN 时(此时查询实际上并非简单查询),简单查询优化会产生错误结果。[#17887](https://github.com/ClickHouse/ClickHouse/pull/17887) ([sundyli](https://github.com/sundy-li))。
* 修复 `topK` 聚合函数中可能发生的段错误。该问题已在 [#17404](https://github.com/ClickHouse/ClickHouse/issues/17404) 中关闭。[#17845](https://github.com/ClickHouse/ClickHouse/pull/17845) ([Maksim Kita](https://github.com/kitaisreal))。
* WAL(实验性功能):当 `in_memory_parts_enable_wal` 被禁用时,不再从 WAL 恢复数据部分。[#17802](https://github.com/ClickHouse/ClickHouse/pull/17802) ([detailyang](https://github.com/detailyang))。
* 关于可删除表的最大大小限制的异常消息显示不正确。[#17764](https://github.com/ClickHouse/ClickHouse/pull/17764) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了向 `Distributed` 表插入数据时因空间不足可能导致的段错误。[#17737](https://github.com/ClickHouse/ClickHouse/pull/17737) ([tavplubix](https://github.com/tavplubix))。
* 修复了 ClickHouse 无法恢复与 MySQL 服务器的连接的问题。[#17681](https://github.com/ClickHouse/ClickHouse/pull/17681) ([Alexander Kazakov](https://github.com/Akazz))。
* Windows:修复了在 Windows Subsystem for Linux 上运行 ClickHouse 时,在 `Atomic` 数据库中执行 `RENAME` 查询出现 `Function not implemented` 错误的问题。修复 [#17661](https://github.com/ClickHouse/ClickHouse/issues/17661)。[#17664](https://github.com/ClickHouse/ClickHouse/pull/17664) ([tavplubix](https://github.com/tavplubix))。
* 当执行 `ON CLUSTER` 查询时,如果 `pool_size` &gt; 1,由于竞态条件可能导致集群是否为循环(交叉)复制的判断出现错误。该问题已修复。[#17640](https://github.com/ClickHouse/ClickHouse/pull/17640) ([tavplubix](https://github.com/tavplubix))。
* 修复了服务器以守护进程模式运行时 `system.stack_trace` 表为空的问题。[#17630](https://github.com/ClickHouse/ClickHouse/pull/17630) ([Amos Bird](https://github.com/amosbird))。
* 对于 MergeTree 表，异常 `fmt::v7::format_error` 可能会在后台记录。此修复解决了 [#17613](https://github.com/ClickHouse/ClickHouse/issues/17613)。[#17615](https://github.com/ClickHouse/ClickHouse/pull/17615) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 当 clickhouse-client 在交互模式下使用多行查询时,单行注释会被错误地延伸至查询结尾。此问题已修复 [#13654](https://github.com/ClickHouse/ClickHouse/issues/13654)。[#17565](https://github.com/ClickHouse/ClickHouse/pull/17565) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了当相应的变更操作在不同副本上被终止时导致 ALTER 查询挂起的问题。修复 [#16953](https://github.com/ClickHouse/ClickHouse/issues/16953)。[#17499](https://github.com/ClickHouse/ClickHouse/pull/17499) ([alesapin](https://github.com/alesapin))。
* 修复了当 ClickHouse 低估标记缓存大小时内存统计不准确的问题。当存在大量带有标记的小文件时可能会发生此情况。[#17496](https://github.com/ClickHouse/ClickHouse/pull/17496) ([alesapin](https://github.com/alesapin))。
* 修复了启用 `optimize_redundant_functions_in_order_by` 设置时 `ORDER BY` 的问题。[#17471](https://github.com/ClickHouse/ClickHouse/pull/17471) ([Anton Popov](https://github.com/CurtizJ))。
* 修复了因错误优化导致 `DISTINCT` 后可能出现重复项的问题。修复 [#17294](https://github.com/ClickHouse/ClickHouse/issues/17294)。[#17296](https://github.com/ClickHouse/ClickHouse/pull/17296) ([li chengxiang](https://github.com/chengxianglibra))。[#17439](https://github.com/ClickHouse/ClickHouse/pull/17439) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了 *MergeTree 表后台任务中 CPU 占用过高的问题。[#17416](https://github.com/ClickHouse/ClickHouse/pull/17416) ([tavplubix](https://github.com/tavplubix))。
* 修复了从包含 `LowCardinality` 类型的 `JOIN` 表读取数据时可能发生的崩溃问题。修复 [#17228](https://github.com/ClickHouse/ClickHouse/issues/17228)。[#17397](https://github.com/ClickHouse/ClickHouse/pull/17397) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 从 MySQL 复制(实验性功能):修复 [#16835](https://github.com/ClickHouse/ClickHouse/issues/16835) 尝试修复 MySQL SHOW 语句的头部不匹配问题。[#17366](https://github.com/ClickHouse/ClickHouse/pull/17366) ([Winter Zhang](https://github.com/zhang2014))。
* 修复谓词优化器处理非确定性函数的问题。此修复解决了 [#17244](https://github.com/ClickHouse/ClickHouse/issues/17244)。[#17273](https://github.com/ClickHouse/ClickHouse/pull/17273) ([Winter Zhang](https://github.com/zhang2014))。
* 修复了带有 `LIMIT` 的分布式查询可能出现 `Unexpected packet Data received from client` 错误的问题。[#17254](https://github.com/ClickHouse/ClickHouse/pull/17254) ([Azat Khuzhin](https://github.com/azat))。
* 修复了子查询中存在常量列时集合索引失效的问题。此修复解决了 [#17246](https://github.com/ClickHouse/ClickHouse/issues/17246)。[#17249](https://github.com/ClickHouse/ClickHouse/pull/17249) ([Amos Bird](https://github.com/amosbird))。
* clickhouse-copier:修复非分区表问题 [#15235](https://github.com/ClickHouse/ClickHouse/issues/15235)。[#17248](https://github.com/ClickHouse/ClickHouse/pull/17248) ([Qi Chen](https://github.com/kaka11chen))。
* 修复了存储在 S3 磁盘上的数据分区可能无法正常执行 mutation 的问题(实验性功能)。[#17227](https://github.com/ClickHouse/ClickHouse/pull/17227) ([Pavel Kovalenko](https://github.com/Jokser))。
* 修复了函数 `fuzzBits` 的 bug,相关 issue:[#16980](https://github.com/ClickHouse/ClickHouse/issues/16980)。[#17051](https://github.com/ClickHouse/ClickHouse/pull/17051) ([hexiaoting](https://github.com/hexiaoting))。
* 修复了仅使用 OFFSET 的查询中 `optimize_distributed_group_by_sharding_key` 的问题。[#16996](https://github.com/ClickHouse/ClickHouse/pull/16996) ([Azat Khuzhin](https://github.com/azat))。
* 修复了对包含 JOIN 的 `Distributed` 表执行 `Merge` 表查询时的问题。[#16993](https://github.com/ClickHouse/ClickHouse/pull/16993) ([Azat Khuzhin](https://github.com/azat))。
* 修复了单调函数在 ORDER BY 优化中的问题。修复 [#16107](https://github.com/ClickHouse/ClickHouse/issues/16107)。[#16956](https://github.com/ClickHouse/ClickHouse/pull/16956) ([Anton Popov](https://github.com/CurtizJ))。
* 修复了不同精度的 `DateTime64` 类型比较错误的问题。修复 [#16655](https://github.com/ClickHouse/ClickHouse/issues/16655) ... [#16952](https://github.com/ClickHouse/ClickHouse/pull/16952) ([Vasily Nemkov](https://github.com/Enmk))。
* 修复了启用 `optimize_aggregators_of_group_by_keys` 设置时 GROUP BY 与 JOIN 结合使用的优化问题。修复 [#12604](https://github.com/ClickHouse/ClickHouse/issues/12604)。[#16951](https://github.com/ClickHouse/ClickHouse/pull/16951) ([Anton Popov](https://github.com/CurtizJ))。
* 修复 SHOW ACCESS 查询中的小问题。[#16866](https://github.com/ClickHouse/ClickHouse/pull/16866) ([tavplubix](https://github.com/tavplubix))。
* 修复了启用 `optimize_trivial_count_query` 设置且存在分区谓词时的行为问题。[#16767](https://github.com/ClickHouse/ClickHouse/pull/16767) ([Azat Khuzhin](https://github.com/azat))。
* 通过 MySQL 线路协议返回 INSERT 查询的受影响行数。此前 ClickHouse 始终返回 0,现已修复。修复 [#16605](https://github.com/ClickHouse/ClickHouse/issues/16605)。[#16715](https://github.com/ClickHouse/ClickHouse/pull/16715) ([Winter Zhang](https://github.com/zhang2014))。
* 修复了 `select_sequential_consistency` 在优化的简单计数查询和系统表中导致的不一致行为。[#16309](https://github.com/ClickHouse/ClickHouse/pull/16309) ([Hao Chen](https://github.com/haoch))。
* 当 `REPLACE` 列转换器操作不存在的列时抛出错误。[#16183](https://github.com/ClickHouse/ClickHouse/pull/16183) ([hexiaoting](https://github.com/hexiaoting))。
* 在 RIGHT|FULL JOIN 的 ON 表达式中遇到非等值连接时抛出异常。[#15162](https://github.com/ClickHouse/ClickHouse/pull/15162) ([Artem Zuikov](https://github.com/4ertus2))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-10}


* 为 ClickHouse 二进制文件添加简单的完整性检查。可用于检测因硬件故障(存储介质位衰减或内存位翻转)导致的数据损坏。[#18811](https://github.com/ClickHouse/ClickHouse/pull/18811) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 将 `OpenSSL` 替换为 `BoringSSL`。这可以避免与 sanitizer 相关的问题。此更改修复了 [#12490](https://github.com/ClickHouse/ClickHouse/issues/12490)、[#17502](https://github.com/ClickHouse/ClickHouse/issues/17502) 和 [#12952](https://github.com/ClickHouse/ClickHouse/issues/12952)。[#18129](https://github.com/ClickHouse/ClickHouse/pull/18129) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 简化 `Sys/V` 初始化脚本。此前该脚本在 Ubuntu 12.04 及更早版本上无法正常工作。[#17428](https://github.com/ClickHouse/ClickHouse/pull/17428) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 对 `./clickhouse install` 脚本进行了多项改进。[#17421](https://github.com/ClickHouse/ClickHouse/pull/17421) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 现在 ClickHouse 可以模拟 ZooKeeper。目前,存储实现仅为内存中的哈希表,服务器部分支持 ZooKeeper 协议。[#16877](https://github.com/ClickHouse/ClickHouse/pull/16877) ([alesapin](https://github.com/alesapin))。
* 修复 TestKeeperStorage(ZooKeeper 的模拟实现)中死列表监视器的移除问题。[#18065](https://github.com/ClickHouse/ClickHouse/pull/18065) ([alesapin](https://github.com/alesapin))。
* 新增 `SYSTEM SUSPEND` 命令用于故障注入，可用于辅助故障转移测试。此更改关闭了 [#15979](https://github.com/ClickHouse/ClickHouse/issues/15979)。[#18850](https://github.com/ClickHouse/ClickHouse/pull/18850) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 当 ClickHouse 使用 `lld` 链接时生成构建 ID。经发现,`lld` 在某些机器上默认不生成构建 ID。构建 ID 用于崩溃报告和程序自省。[#18808](https://github.com/ClickHouse/ClickHouse/pull/18808) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复代码风格检查中的 shellcheck 错误。[#18566](https://github.com/ClickHouse/ClickHouse/pull/18566) ([Ilya Yatsishin](https://github.com/qoega))。
* 更新时区信息至 2020e 版本。[#18531](https://github.com/ClickHouse/ClickHouse/pull/18531) ([alesapin](https://github.com/alesapin))。
* 修复 codespell 警告。将代码风格检查拆分为多个独立部分。更新代码风格检查 Docker 镜像。[#18463](https://github.com/ClickHouse/ClickHouse/pull/18463) ([Ilya Yatsishin](https://github.com/qoega))。
* 自动检查文档中残留的冲突标记。[#18332](https://github.com/ClickHouse/ClickHouse/pull/18332) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 为无状态测试的不稳定检查启用线程模糊器。[#18299](https://github.com/ClickHouse/ClickHouse/pull/18299) ([alesapin](https://github.com/alesapin))。
* 不再使用非线程安全函数 `strerror`。[#18204](https://github.com/ClickHouse/ClickHouse/pull/18204) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 更新 `anchore/scan-action@main` 工作流操作（已从 `master` 分支迁移至 `main` 分支）。[#18192](https://github.com/ClickHouse/ClickHouse/pull/18192) ([Stig Bakken](https://github.com/stigsb))。
* 现在 `clickhouse-test` 在执行 DROP/CREATE 数据库操作时会设置超时。[#18098](https://github.com/ClickHouse/ClickHouse/pull/18098) ([alesapin](https://github.com/alesapin))。
* 为无状态测试启用 Pytest 框架的实验性支持。[#17902](https://github.com/ClickHouse/ClickHouse/pull/17902) ([Ivan](https://github.com/abyss7))。
* 现在我们在集成测试中使用最新版本的 Docker daemon。[#17671](https://github.com/ClickHouse/ClickHouse/pull/17671) ([alesapin](https://github.com/alesapin))。
* 如果启用了 Sentry,则向其发送有关官方构建版本、内存、CPU 和可用磁盘空间的信息。Sentry 是一个可选功能,用于帮助 ClickHouse 开发人员。此更改关闭了 [#17279](https://github.com/ClickHouse/ClickHouse/issues/17279)。[#17543](https://github.com/ClickHouse/ClickHouse/pull/17543) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* clickhouse-copier 代码中存在未初始化变量。[#17363](https://github.com/ClickHouse/ClickHouse/pull/17363) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 修复了来自 [#17309](https://github.com/ClickHouse/ClickHouse/issues/17309) 的[一个 MSan 报告](https://clickhouse-test-reports.s3.yandex.net/17309/065cd002578f2e8228f12a2744bd40c970065e0c/stress_test_\(memory\)/stderr.log)。[#17344](https://github.com/ClickHouse/ClickHouse/pull/17344) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 修复了 Arrow Flight 库中的 IPv6 问题。详见[评论](https://github.com/ClickHouse/ClickHouse/pull/16243#issuecomment-720830294)。[#16664](https://github.com/ClickHouse/ClickHouse/pull/16664) ([Zhanna](https://github.com/FawnD2))。
* 添加了一个库,用于将某些 `libc` 函数替换为会终止进程的陷阱。[#16366](https://github.com/ClickHouse/ClickHouse/pull/16366) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 在发生栈溢出时在服务器日志中提供诊断信息,并向 clickhouse-client 发送错误消息。此更改关闭了 [#14840](https://github.com/ClickHouse/ClickHouse/issues/14840)。[#16346](https://github.com/ClickHouse/ClickHouse/pull/16346) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 现在我们可以并行运行几乎所有无状态功能测试。[#15236](https://github.com/ClickHouse/ClickHouse/pull/15236) ([alesapin](https://github.com/alesapin))。
* 修复 `librdkafka` snappy 解压缩中的损坏问题(此问题仅影响 gcc10 构建版本,但官方构建已使用 clang,因此至少近期的官方发布版本不受影响)。[#18053](https://github.com/ClickHouse/ClickHouse/pull/18053) ([Azat Khuzhin](https://github.com/azat))。
* 如果服务器被 OOM killer 终止，会在日志中打印消息。[#13516](https://github.com/ClickHouse/ClickHouse/pull/13516) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* PODArray:避免使用 (nullptr, 0) 参数调用 memcpy(修复 UBSan 报告)。此修复解决了 [#18525](https://github.com/ClickHouse/ClickHouse/issues/18525) 问题。[#18526](https://github.com/ClickHouse/ClickHouse/pull/18526) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 改进了 DDLWorker 中 ZooKeeper 路径拼接的实现。[#17767](https://github.com/ClickHouse/ClickHouse/pull/17767) ([Bharat Nallan](https://github.com/bharatnc))。
* 允许从调试文件重新加载符号。此 PR 还修复了 build-id 相关问题。[#17637](https://github.com/ClickHouse/ClickHouse/pull/17637) ([Amos Bird](https://github.com/amosbird))。





## [2020 年更新日志](./2020.md) {#changelog-for-2020}
