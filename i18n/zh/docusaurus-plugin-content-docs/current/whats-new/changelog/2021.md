---
slug: /whats-new/changelog/2021
sidebar_position: 6
sidebar_label: "2021"
title: "2021 更新日志"
description: "2021 年更新日志"
doc_type: "changelog"
keywords:
  [
    "ClickHouse 2021",
    "changelog 2021",
    "发布说明",
    "版本历史",
    "新功能"
  ]
---

### ClickHouse 版本 v21.12, 2021-12-15 {#clickhouse-release-v2112-2021-12-15}

#### 向后不兼容的变更 {#backward-incompatible-change}

- _修复了先前存在不当行为的功能。_ 不再允许对 Kafka/RabbitMQ/FileLog 进行直接查询。可以通过设置 `stream_like_engine_allow_direct_select` 来启用。如果存在已附加的物化视图,即使通过设置启用,也不允许直接查询。对于 Kafka 和 RabbitMQ 的直接查询,如果允许,默认情况下不会提交消息。要在直接查询时启用提交,用户必须使用存储级别设置 `kafka{rabbitmq}_commit_on_select=1`(默认为 `0`)。[#31053](https://github.com/ClickHouse/ClickHouse/pull/31053) ([Kseniia Sumarokova](https://github.com/kssenii))。
- _新函数行为的轻微变更。_ 在 JSON_VALUE 中返回不带引号的字符串。关闭 [#27965](https://github.com/ClickHouse/ClickHouse/issues/27965)。[#31008](https://github.com/ClickHouse/ClickHouse/pull/31008) ([Kseniia Sumarokova](https://github.com/kssenii))。
- _设置重命名。_ 为 TSV/CSV 输入格式添加自定义空值表示支持。修复 TSV/CSV/JSONCompactStringsEachRow/JSONStringsEachRow 输入格式中 Nullable(String) 的反序列化。将 `output_format_csv_null_representation` 和 `output_format_tsv_null_representation` 分别重命名为 `format_csv_null_representation` 和 `format_tsv_null_representation`。[#30497](https://github.com/ClickHouse/ClickHouse/pull/30497) ([Kruglov Pavel](https://github.com/Avogar))。
- _进一步弃用已不使用的代码。_ 这仅与使用 20.6 之前版本 ClickHouse 的用户相关。从 `ReplicatedMergeTree` 中移除了"领导者选举"机制,因为自 20.6 版本起已支持多个领导者。如果您从旧版本升级,并且某个使用旧版本的副本是领导者,则服务器在升级后将无法启动。停止使用旧版本的副本以使新版本启动。之后将无法降级到 20.6 之前的版本。[#32140](https://github.com/ClickHouse/ClickHouse/pull/32140) ([tavplubix](https://github.com/tavplubix))。

#### 新功能 {#new-feature}


* 在 clickhouse-keeper 中实现了更多 ZooKeeper 四字命令（Four Letter Words）：[https://zookeeper.apache.org/doc/r3.4.8/zookeeperAdmin.html#sc&#95;zkCommands](https://zookeeper.apache.org/doc/r3.4.8/zookeeperAdmin.html#sc_zkCommands)。[#28981](https://github.com/ClickHouse/ClickHouse/pull/28981)（[JackyWoo](https://github.com/JackyWoo)）。现在 `clickhouse-keeper` 的功能已全部实现。
* 新增对 `Bool` 数据类型的支持。 [#31072](https://github.com/ClickHouse/ClickHouse/pull/31072) ([kevin wan](https://github.com/MaxWk)).
* 在 File、URL、HDFS 存储以及 `INSERT INTO` 表函数中增加对 `PARTITION BY` 的支持。修复了 [#30273](https://github.com/ClickHouse/ClickHouse/issues/30273)。[#30690](https://github.com/ClickHouse/ClickHouse/pull/30690)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 添加了 `CONSTRAINT ... ASSUME ...`（在执行 `INSERT` 时不进行检查）。添加了将查询转换为 CNF 形式（[https://github.com/ClickHouse/ClickHouse/issues/11749](https://github.com/ClickHouse/ClickHouse/issues/11749)），以便更方便地进行优化。添加了基于约束的简单查询改写（目前仅支持简单匹配，后续将改进以支持 &lt;,=,&gt; 等）。在可能的情况下，添加了将重型列替换为轻量列的功能。[#18787](https://github.com/ClickHouse/ClickHouse/pull/18787)（[Nikita Vasilev](https://github.com/nikvas0)）。
* 用于 HTTP/URL 函数的基本身份验证。[#31648](https://github.com/ClickHouse/ClickHouse/pull/31648) ([michael1589](https://github.com/michael1589)).
* 支持在 `WITH FILL` 修饰符的 `STEP` 子句中使用 `INTERVAL` 类型。[#30927](https://github.com/ClickHouse/ClickHouse/pull/30927) ([Anton Popov](https://github.com/CurtizJ))。
* 在 `FROM INFILE` 子句中新增对从多个文件并行读取以及对通配符（glob）匹配的支持。 [#30135](https://github.com/ClickHouse/ClickHouse/pull/30135) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* 为 `Identifier` 表和数据库查询参数提供支持。关闭 [#27226](https://github.com/ClickHouse/ClickHouse/issues/27226)。[#28668](https://github.com/ClickHouse/ClickHouse/pull/28668)（[Nikolay Degterinsky](https://github.com/evillique)）。
* *摘要：显著提升各文本格式的完备性与一致性。* 重构 `TSV`、`TSVRaw`、`CSV` 以及 `JSONCompactEachRow`、`JSONCompactStringsEachRow` 格式，消除代码重复，为带有 `-WithNames` 和 `-WithNamesAndTypes` 后缀的格式添加基础接口。新增 `CSVWithNamesAndTypes`、`TSVRawWithNames`、`TSVRawWithNamesAndTypes`、`JSONCompactEachRowWIthNames`、`JSONCompactStringsEachRowWIthNames`、`RowBinaryWithNames` 格式。为 `TSVWithNamesAndTypes`、`TSVRaw(WithNames/WIthNamesAndTypes)`、`CSVWithNamesAndTypes`、`JSONCompactEachRow(WithNames/WIthNamesAndTypes)`、`JSONCompactStringsEachRow(WithNames/WIthNamesAndTypes)` 等格式增加并行解析支持。为 `RowBinaryWithNamesAndTypes` 格式增加列映射和类型检查支持。新增设置 `input_format_with_types_use_header`，用于指定是否应检查 `<format_name>WIthNamesAndTypes` 格式中写入的类型是否与表结构匹配。新增设置 `input_format_csv_empty_as_default`，并在 CSV 格式中使用它来替代 `input_format_defaults_for_omitted_fields`（因为该设置不应控制 `csv_empty_as_default`）。修复 `input_format_defaults_for_omitted_fields` 的用法（此前仅被用作 `csv_empty_as_default`，但它应控制对被省略字段的默认表达式计算）。修复 `TSVRaw` 格式中 Nullable 的输入/输出，使该格式与向 TSV 插入数据完全兼容。在启用 `input_format_null_as_default` 时，修复向 `LowCardinality(Nullable)` 插入 NULL 的问题（此前会插入默认值而非实际的 NULL）。修复 `JSONStringsEachRow`/`JSONCompactStringsEachRow` 格式中的字符串反序列化问题（字符串仅解析到第一个 &#39;\n&#39; 或 &#39;\t&#39; 为止）。在 Template 输入格式中增加对 `Raw` 转义规则的支持。为 JSONCompactEachRow(WithNames/WIthNamesAndTypes) 输入格式增加诊断信息。修复在设置 `min_chunk_bytes_for_parallel_parsing` 小于单行字节数时，对 `-WithNames` 格式进行并行解析的错误。[#30178](https://github.com/ClickHouse/ClickHouse/pull/30178)（[Kruglov Pavel](https://github.com/Avogar)）。允许在 `CustomSeparated` 输入/输出格式中输出/解析列名和列类型。新增 `CustomSeparatedWithNames/WithNamesAndTypes` 格式，其行为类似于 `TSVWithNames/WithNamesAndTypes`。[#31434](https://github.com/ClickHouse/ClickHouse/pull/31434)（[Kruglov Pavel](https://github.com/Avogar)）。
* 新增对 Aliyun OSS 存储的支持。[#31286](https://github.com/ClickHouse/ClickHouse/pull/31286) ([cfcz48](https://github.com/cfcz48))。
* 在配置文件中公开全局线程池的所有设置。[#31285](https://github.com/ClickHouse/ClickHouse/pull/31285) ([Tomáš Hromada](https://github.com/gyfis))。
* 引入了窗口函数 `exponentialTimeDecayedSum`、`exponentialTimeDecayedMax`、`exponentialTimeDecayedCount` 和 `exponentialTimeDecayedAvg`，对于较大的窗口比 `exponentialMovingAverage` 更高效，同时覆盖了更多用例。[#29799](https://github.com/ClickHouse/ClickHouse/pull/29799)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* 添加选项，可在将日志写入文件之前使用 LZ4 对其进行压缩。修复 [#23860](https://github.com/ClickHouse/ClickHouse/issues/23860)。[#29219](https://github.com/ClickHouse/ClickHouse/pull/29219) ([Nikolay Degterinsky](https://github.com/evillique))。
* 支持具有 CROSS JOIN 语义的 `JOIN ON 1 = 1` 写法。这解决了 [#25578](https://github.com/ClickHouse/ClickHouse/issues/25578)。[#25894](https://github.com/ClickHouse/ClickHouse/pull/25894)（[Vladimir C](https://github.com/vdimir)）。
* 为 `Map` 类型添加 Map 组合器，将原先用于映射数组的 `sum-, min-, max- Map` 重命名为 `sum-, min-, max- MappedArrays`。[#24539](https://github.com/ClickHouse/ClickHouse/pull/24539) ([Ildus Kurbangaliev](https://github.com/ildus))。
* 支持对 HTTP 读取进行重试。修复 [#29696](https://github.com/ClickHouse/ClickHouse/issues/29696)。[#29894](https://github.com/ClickHouse/ClickHouse/pull/29894)（[Kseniia Sumarokova](https://github.com/kssenii)）。

#### 实验性功能 {#experimental-feature}

- `WINDOW VIEW` 用于在 ClickHouse 中启用流处理。[#8331](https://github.com/ClickHouse/ClickHouse/pull/8331) ([vxider](https://github.com/Vxider))。
- 移除对 `MaterializedMySQL` 使用 Ordinary 数据库的支持。[#31292](https://github.com/ClickHouse/ClickHouse/pull/31292) ([Stig Bakken](https://github.com/stigsb))。
- 为 Log 系列实现 BACKUP 和 RESTORE 命令。此功能正在开发中。[#30688](https://github.com/ClickHouse/ClickHouse/pull/30688) ([Vitaly Baranov](https://github.com/vitlibar))。

#### 性能改进 {#performance-improvement}


- 降低使用 `s3` / `url` / `hdfs` 格式读取 `Parquet`、`ORC`、`Arrow` 时的内存使用量(由设置 `input_format_allow_seeks` 控制,默认启用)。同时添加设置 `remote_read_min_bytes_for_seek` 以控制查找操作。关闭 [#10461](https://github.com/ClickHouse/ClickHouse/issues/10461)。关闭 [#16857](https://github.com/ClickHouse/ClickHouse/issues/16857)。[#30936](https://github.com/ClickHouse/ClickHouse/pull/30936) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 为 JOIN ON 中的常量条件添加优化,参考 [#26928](https://github.com/ClickHouse/ClickHouse/issues/26928)。[#27021](https://github.com/ClickHouse/ClickHouse/pull/27021) ([Vladimir C](https://github.com/vdimir))。
- 支持所有文本格式的并行格式化,`JSONEachRowWithProgress` 和 `PrettyCompactMonoBlock` 除外。[#31489](https://github.com/ClickHouse/ClickHouse/pull/31489) ([Kruglov Pavel](https://github.com/Avogar))。
- 加速可空列的计数操作。[#31806](https://github.com/ClickHouse/ClickHouse/pull/31806) ([Raúl Marín](https://github.com/Algunenano))。
- 加速 `avg` 和 `sumCount` 聚合函数。[#31694](https://github.com/ClickHouse/ClickHouse/pull/31694) ([Raúl Marín](https://github.com/Algunenano))。
- 提升 JSON 和 XML 输出格式的性能。[#31673](https://github.com/ClickHouse/ClickHouse/pull/31673) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 提升数据同步到块设备的性能。此更改关闭 [#31181](https://github.com/ClickHouse/ClickHouse/issues/31181)。[#31229](https://github.com/ClickHouse/ClickHouse/pull/31229) ([zhanglistar](https://github.com/zhanglistar))。
- 修复 `LiveView` 表中的查询性能问题。修复 [#30831](https://github.com/ClickHouse/ClickHouse/issues/30831)。[#31006](https://github.com/ClickHouse/ClickHouse/pull/31006) ([vzakaznikov](https://github.com/vzakaznikov))。
- 加速查询解析。[#31949](https://github.com/ClickHouse/ClickHouse/pull/31949) ([Raúl Marín](https://github.com/Algunenano))。
- 允许为普通/标记指标拆分 `GraphiteMergeTree` 汇总规则(可选的 `rule_type` 字段)。[#25122](https://github.com/ClickHouse/ClickHouse/pull/25122) ([Michail Safronov](https://github.com/msaf1980))。
- 移除 `remote()` 的多余 `DESC TABLE` 请求(在 `remote('127.1', system.one)` 的情况下(即使用标识符作为 db.table 而不是字符串)存在多余的 `DESC TABLE` 请求)。[#32019](https://github.com/ClickHouse/ClickHouse/pull/32019) ([Azat Khuzhin](https://github.com/azat))。
- 在启用设置 `optimize_functions_to_subcolumns` 时,优化函数 `tupleElement` 以读取子列。[#31261](https://github.com/ClickHouse/ClickHouse/pull/31261) ([Anton Popov](https://github.com/CurtizJ))。
- 在启用设置 `optimize_functions_to_subcolumns` 时,优化函数 `mapContains` 以读取子列 `key`。[#31218](https://github.com/ClickHouse/ClickHouse/pull/31218) ([Anton Popov](https://github.com/CurtizJ))。
- 添加设置 `merge_tree_min_rows_for_concurrent_read_for_remote_filesystem` 和 `merge_tree_min_bytes_for_concurrent_read_for_remote_filesystem`。[#30970](https://github.com/ClickHouse/ClickHouse/pull/30970) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 在 `StorageMergeTree` 中跳过不同分区的变更操作。[#21326](https://github.com/ClickHouse/ClickHouse/pull/21326) ([Vladimir Chebotarev](https://github.com/excitoon))。

#### 改进 {#improvement}


* 当某个表或字典被其他表或字典依赖时，禁止将其删除。 [#30977](https://github.com/ClickHouse/ClickHouse/pull/30977) ([tavplubix](https://github.com/tavplubix)).
* 允许对聚合函数状态进行版本化。现在我们可以在聚合函数状态的序列化格式中引入向后兼容的更改。解决了 [#12552](https://github.com/ClickHouse/ClickHouse/issues/12552)。[#24820](https://github.com/ClickHouse/ClickHouse/pull/24820)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 支持 PostgreSQL 风格的 `ALTER MODIFY COLUMN` 语法。[#32003](https://github.com/ClickHouse/ClickHouse/pull/32003) ([SuperDJY](https://github.com/cmsxbc))。
* 为 `RangeHashedDictionary`、`ComplexKeyRangeHashedDictionary` 添加了对 `update_field` 的支持。[#32185](https://github.com/ClickHouse/ClickHouse/pull/32185) ([Maksim Kita](https://github.com/kitaisreal))。
* `murmurHash3_128` 和 `sipHash128` 函数现在可以接受任意数量的参数，从而解决了 [#28774](https://github.com/ClickHouse/ClickHouse/issues/28774)。[#28965](https://github.com/ClickHouse/ClickHouse/pull/28965)（[小路](https://github.com/nicelulu)）。
* 为 `HDFS` 存储提供默认表达式支持，并在源为列式时优化数据获取。[#32256](https://github.com/ClickHouse/ClickHouse/pull/32256) ([李扬](https://github.com/taiyang-li))。
* 优化 OpenTelemetry span 的操作名称。[#32234](https://github.com/ClickHouse/ClickHouse/pull/32234) ([Frank Chen](https://github.com/FrankChen021)).
* 在使用 `JSONEachRow` 输出格式时，请使用 `Content-Type: application/x-ndjson`（[http://ndjson.org/](http://ndjson.org/)）。[#32223](https://github.com/ClickHouse/ClickHouse/pull/32223)（[Dmitriy Dorofeev](https://github.com/deem0n)）。
* 改进在 Template/CustomSeparated 格式中使用引号转义规则跳过未知字段的行为。之前只能跳过带引号的字符串，现在可以跳过任意类型的值。[#32204](https://github.com/ClickHouse/ClickHouse/pull/32204) ([Kruglov Pavel](https://github.com/Avogar)).
* 现在，当配置包含重复 ID 或端点时，`clickhouse-keeper` 会拒绝启动或应用配置更改。修复了问题 [#31339](https://github.com/ClickHouse/ClickHouse/issues/31339)。[#32121](https://github.com/ClickHouse/ClickHouse/pull/32121)（[alesapin](https://github.com/alesapin)）。
* 为 URL 引擎发出的 HTTP 数据包设置 Content-Type。 [#32113](https://github.com/ClickHouse/ClickHouse/pull/32113) ([Frank Chen](https://github.com/FrankChen021))。
* 当启用 `output_format_json_array_of_rows` 时，对 `JSONEachRow` 格式返回的 Content-Type 为 &#39;application/json&#39;。 [#32112](https://github.com/ClickHouse/ClickHouse/pull/32112) ([Frank Chen](https://github.com/FrankChen021)).
* 支持在 `Float32`/`Float64` 值前解析 `+` 符号。[#32079](https://github.com/ClickHouse/ClickHouse/pull/32079) ([Kruglov Pavel](https://github.com/Avogar))。
* 允许为 `DiskHDFS` 和 `StorageHDFS` 设置用户自定义的 `hdfs_replication` 参数。关闭 [#32039](https://github.com/ClickHouse/ClickHouse/issues/32039)。[#32049](https://github.com/ClickHouse/ClickHouse/pull/32049)（[leosunli](https://github.com/leosunli)）。
* 在 OpenTelemetry span 日志中新增了 ClickHouse 的 `exception` 和 `exception_code` 字段。[#32040](https://github.com/ClickHouse/ClickHouse/pull/32040)（[Frank Chen](https://github.com/FrankChen021)）。
* 改进 OpenTelemetry span 日志的持续时间——当查询发生异常时，其在查询级别的持续时间会被记录为 0。 [#32038](https://github.com/ClickHouse/ClickHouse/pull/32038) ([Frank Chen](https://github.com/FrankChen021)).
* 修复无法创建 `Int256` 类型的 `LowCardinality` 的问题。[#31832](https://github.com/ClickHouse/ClickHouse/pull/31832)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在引擎或 partition&#95;by 设置不同时重新创建 `system.*_log` 表。 [#31824](https://github.com/ClickHouse/ClickHouse/pull/31824) ([Azat Khuzhin](https://github.com/azat)).
* `MaterializedMySQL`：修复当表名为 &#39;table&#39; 时出现的问题。[#31781](https://github.com/ClickHouse/ClickHouse/pull/31781) ([Håvard Kvålen](https://github.com/havardk))。
* ClickHouse 字典源：支持预定义连接。解决 [#31705](https://github.com/ClickHouse/ClickHouse/issues/31705)。[#31749](https://github.com/ClickHouse/ClickHouse/pull/31749)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 支持为 Kafka 和 RabbitMQ 引擎使用预定义的连接配置（方式与其他集成表引擎相同）。 [#31691](https://github.com/ClickHouse/ClickHouse/pull/31691) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 在 clickhouse-client 中浏览历史记录时始终重新渲染提示符。这将提高在处理无法完全显示在屏幕上的超长查询时的易用性。 [#31675](https://github.com/ClickHouse/ClickHouse/pull/31675) ([alexey-milovidov](https://github.com/alexey-milovidov))（作者：Amos Bird）。
* 新增用于在历史记录中导航的按键绑定（替代按行/历史记录导航）。 [#31641](https://github.com/ClickHouse/ClickHouse/pull/31641) ([Azat Khuzhin](https://github.com/azat)).
* 改进了 `max_execution_time` 检查。修复了某些情况下未进行超时检查、导致查询可能运行时间过长的问题。[#31636](https://github.com/ClickHouse/ClickHouse/pull/31636) ([Raúl Marín](https://github.com/Algunenano))。
* 当因密码哈希值错误而无法加载 `users.xml` 时，提供更清晰的异常消息。此更改关闭了 [#24126](https://github.com/ClickHouse/ClickHouse/issues/24126)。[#31557](https://github.com/ClickHouse/ClickHouse/pull/31557)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 在 `ReplicatedMergeTree` 参数中展开宏时，如果这些宏未在配置中定义，则使用来自 `Replicated` 数据库参数的分片名和副本名。修复 [#31471](https://github.com/ClickHouse/ClickHouse/issues/31471)。[#31488](https://github.com/ClickHouse/ClickHouse/pull/31488)（[tavplubix](https://github.com/tavplubix)）。
* 改进了对 `min/max/count` 投影的分析能力。现在，在启用 `allow_experimental_projection_optimization` 时，虚拟的 `min/max/count` 投影可以与分区键中的列组合使用。[#31474](https://github.com/ClickHouse/ClickHouse/pull/31474) ([Amos Bird](https://github.com/amosbird))。
* 为 `clickhouse-local` 添加 `--pager` 支持。[#31457](https://github.com/ClickHouse/ClickHouse/pull/31457) ([Azat Khuzhin](https://github.com/azat))。
* 修复了在交互式编辑查询时编辑器的等待行为（在收到 `SIGWINCH` 信号时 `waitpid()` 返回 -1，并且 `EDITOR` 与 `clickhouse-local`/`clickhouse-client` 同时运行）。[#31456](https://github.com/ClickHouse/ClickHouse/pull/31456) ([Azat Khuzhin](https://github.com/azat)).
* 如果在 `JSONCompactStrings(EachRow)` 格式中，字段之后存在多余数据，则抛出异常。 [#31455](https://github.com/ClickHouse/ClickHouse/pull/31455) ([Kruglov Pavel](https://github.com/Avogar)).
* `http_send_timeout` 和 `http_receive_timeout` 配置项的默认值从 1800（30 分钟）更改为 180（3 分钟）。[#31450](https://github.com/ClickHouse/ClickHouse/pull/31450) ([tavplubix](https://github.com/tavplubix))。
* `MaterializedMySQL` 现已支持处理 `CREATE TABLE ... LIKE ...` DDL 查询。[#31410](https://github.com/ClickHouse/ClickHouse/pull/31410) ([Stig Bakken](https://github.com/stigsb)).
* 在对系统表执行 `SHOW CREATE TABLE` 时返回伪造的 CREATE 查询语句。 [#31391](https://github.com/ClickHouse/ClickHouse/pull/31391) ([SuperDJY](https://github.com/cmsxbc))。
* 之前仅为 `numbers` 表函数显示进度。现在，`numbers_mt` 也会显示进度。[#31318](https://github.com/ClickHouse/ClickHouse/pull/31318) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 用户的初始角色现在用于查找行级策略，参见 [#31080](https://github.com/ClickHouse/ClickHouse/issues/31080)。[#31262](https://github.com/ClickHouse/ClickHouse/pull/31262)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 当更改某个已弃用的设置时，在 `system.warnings` 中显示警告。[#31252](https://github.com/ClickHouse/ClickHouse/pull/31252) ([tavplubix](https://github.com/tavplubix))。
* 改进了 `MergeTree` 中后台清理任务的退避机制。将 `merge_tree_clear_old_temporary_directories_interval_seconds` 和 `merge_tree_clear_old_parts_interval_seconds` 从用户设置移动到了 MergeTree 设置中。[#31180](https://github.com/ClickHouse/ClickHouse/pull/31180) ([tavplubix](https://github.com/tavplubix))。
* 现在每个副本只向客户端发送 profile events 计数器的增量信息。 [#31155](https://github.com/ClickHouse/ClickHouse/pull/31155) ([Dmitry Novik](https://github.com/novikd))。这使得 `clickhouse-client` 中的 `--hardware_utilization` 选项可以正常使用。
* 在 clickhouse-client 中默认启用多行编辑，以解决 [#31121](https://github.com/ClickHouse/ClickHouse/issues/31121)。[#31123](https://github.com/ClickHouse/ClickHouse/pull/31123)（[Amos Bird](https://github.com/amosbird)）。
* 对 `ALTER` 查询中的函数名进行规范化。这有助于避免在使用索引/投影创建表与通过 ALTER 命令添加索引/投影之间出现元数据不匹配。这是对 [https://github.com/ClickHouse/ClickHouse/pull/20174](https://github.com/ClickHouse/ClickHouse/pull/20174) 的后续 PR。标记为改进项，因为目前没有相关的 bug 报告，而且该场景相对较为少见。[#31095](https://github.com/ClickHouse/ClickHouse/pull/31095)（[Amos Bird](https://github.com/amosbird)）。
* 为 `RENAME DATABASE`/`TABLE`/`DICTIONARY` 查询增加对 `IF EXISTS` 修饰符的支持。如果使用该修饰符，当要重命名的 DATABASE/TABLE/DICTIONARY 不存在时，将不会报错。[#31081](https://github.com/ClickHouse/ClickHouse/pull/31081) ([victorgao](https://github.com/kafka1991)).
* 在删除分区时取消纵向合并。这是对 [https://github.com/ClickHouse/ClickHouse/pull/25684](https://github.com/ClickHouse/ClickHouse/pull/25684) 和 [https://github.com/ClickHouse/ClickHouse/pull/30996](https://github.com/ClickHouse/ClickHouse/pull/30996) 的后续补充。[#31057](https://github.com/ClickHouse/ClickHouse/pull/31057)（[Amos Bird](https://github.com/amosbird)）。
* ClickHouse 字典源中的本地会话不再将其事件发送到会话日志。这修复了关闭时可能出现的潜在死锁问题（tsan 报警）。此外，此 PR 还修复了不稳定的 `test_dictionaries_dependency_xml/` 测试。 [#31013](https://github.com/ClickHouse/ClickHouse/pull/31013) ([Vitaly Baranov](https://github.com/vitlibar))。
* 降低 `ALTER` 命令中的加锁开销。 [#31010](https://github.com/ClickHouse/ClickHouse/pull/31010) ([Amos Bird](https://github.com/amosbird)).
* 修复 clickhouse-local 交互模式中的 `--verbose` 选项，并允许将日志记录到文件。[#30881](https://github.com/ClickHouse/ClickHouse/pull/30881)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在 `clickhouse-client` 中新增了 `\l`、`\d`、`\c` 命令，与 MySQL 和 PostgreSQL 中的命令类似。 [#30876](https://github.com/ClickHouse/ClickHouse/pull/30876) ([Pavel Medvedev](https://github.com/pmed)).
* 对于 clickhouse-local 或 clickhouse-client：如果在使用 `--query` 或 `--queries-file` 时带有 `--interactive` 选项，则先按非交互模式执行这些查询，然后再进入交互模式。[#30851](https://github.com/ClickHouse/ClickHouse/pull/30851) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 修复可能出现的 &quot;The local set of parts of X doesn&#39;t look like the set of parts in ZooKeeper&quot; 错误（当在从 ZooKeeper 中删除 znode 时 DROP 操作失败）。[#30826](https://github.com/ClickHouse/ClickHouse/pull/30826) ([Azat Khuzhin](https://github.com/azat))。
* Avro 格式现在可以与 Kafka 配合使用。新增了 `output_format_avro_rows_in_file` 设置项。[#30351](https://github.com/ClickHouse/ClickHouse/pull/30351) ([Ilya Golshtein](https://github.com/ilejn)).
* 允许为单个 `MaterializedPostgreSQL` 数据库指定一个或多个 PostgreSQL 模式（schema）。关闭 [#28901](https://github.com/ClickHouse/ClickHouse/issues/28901)。关闭 [#29324](https://github.com/ClickHouse/ClickHouse/issues/29324)。[#28933](https://github.com/ClickHouse/ClickHouse/pull/28933)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 已将 clickhouse-keeper 内部通信的默认端口从 44444 替换为 9234。修复了 [#30879](https://github.com/ClickHouse/ClickHouse/issues/30879)。[#31799](https://github.com/ClickHouse/ClickHouse/pull/31799)（[alesapin](https://github.com/alesapin)）。
* 为函数 transform 实现对 Decimal 参数的支持。 [#31839](https://github.com/ClickHouse/ClickHouse/pull/31839) ([李帅](https://github.com/loneylee)).
* 通过对 hdfs URL 结构添加额外检查，在 hdfs URL 非法时修复了调试服务器中的异常终止（abort）以及发布版本服务器中的 `DB::Exception: std::out_of_range: basic_string` 错误。 [#31042](https://github.com/ClickHouse/ClickHouse/pull/31042) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复 `hdfs` 表函数/引擎中可能出现的断言错误，并添加测试。[#31036](https://github.com/ClickHouse/ClickHouse/pull/31036)（[Kruglov Pavel](https://github.com/Avogar)）。

#### 错误修复 {#bug-fixes}


* 修复在启用位置参数时对 `GROUP BY` / `ORDER BY` / `LIMIT BY` 中别名的处理。关闭 [#31173](https://github.com/ClickHouse/ClickHouse/issues/31173)。[#31741](https://github.com/ClickHouse/ClickHouse/pull/31741)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复 `Buffer` 表引擎与 `Map` 类型配合使用时的问题。修复了 [#30546](https://github.com/ClickHouse/ClickHouse/issues/30546)。[#31742](https://github.com/ClickHouse/ClickHouse/pull/31742)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复在启用 `use_uncompressed_cache` 时从 `MergeTree` 表读取数据的问题。[#31826](https://github.com/ClickHouse/ClickHouse/pull/31826)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复了在启用设置 `empty_result_for_aggregation_by_empty_set` 时，没有任何操作可执行的 mutation 会卡住的问题。 [#32358](https://github.com/ClickHouse/ClickHouse/pull/32358) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 修复在写入 Protobuf 数据时跳过列的问题。此 PR 修复了 [#31160](https://github.com/ClickHouse/ClickHouse/issues/31160)，详见评论 [#31160](https://github.com/ClickHouse/ClickHouse/issues/31160)#issuecomment-980595318。[#31988](https://github.com/ClickHouse/ClickHouse/pull/31988)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复在子查询中删除不需要列时的错误。如果查询中存在未带 `GROUP BY` 的聚合函数，即使该列被认为不需要，也不要删除。 [#32289](https://github.com/ClickHouse/ClickHouse/pull/32289) ([dongyifeng](https://github.com/dyf6372)).
* 尚未达到配额上限，却被认为已超出限制。本 PR 修复了 [#31174](https://github.com/ClickHouse/ClickHouse/issues/31174)。[#31337](https://github.com/ClickHouse/ClickHouse/pull/31337)（[sunny](https://github.com/sunny19930321)）。
* 修复在使用部分撤销时 `SHOW GRANTS` 的行为。此 PR 修复了 [#31138](https://github.com/ClickHouse/ClickHouse/issues/31138)。[#31249](https://github.com/ClickHouse/ClickHouse/pull/31249)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 在具有 cgroup 限制的容器中运行 ClickHouse 时，内存容量会被错误估算。[#31157](https://github.com/ClickHouse/ClickHouse/pull/31157) ([Pavel Medvedev](https://github.com/pmed))。
* 修复在默认表达式的数据类型与列的数据类型不一致时执行的 `ALTER ... MATERIALIZE COLUMN ...` 查询。 [#32348](https://github.com/ClickHouse/ClickHouse/pull/32348) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了在聚合函数 `avgWeighted` 使用 `Decimal` 参数时出现的 SIGFPE 崩溃问题。修复了 [#32053](https://github.com/ClickHouse/ClickHouse/issues/32053)。[#32303](https://github.com/ClickHouse/ClickHouse/pull/32303)（[tavplubix](https://github.com/tavplubix)）。
* 如果 `Dictionary` 表引用了同名的 XML 字典，服务器可能无法启动，并报错 `Cannot attach 1 tables due to cyclic dependencies`，该问题已修复。修复了 [#31315](https://github.com/ClickHouse/ClickHouse/issues/31315)。[#32288](https://github.com/ClickHouse/ClickHouse/pull/32288)（[tavplubix](https://github.com/tavplubix)）。
* 修复在根据 `Quoted` 转义规则反序列化 `Nullable(Float)` 类型的 NaN 值时出现的解析错误。 [#32190](https://github.com/ClickHouse/ClickHouse/pull/32190) ([Kruglov Pavel](https://github.com/Avogar)).
* XML 字典：在 CREATE TABLE 查询中使用的标识符，在升级到更高版本时可以归属到 `default_database`。修复了 [#31963](https://github.com/ClickHouse/ClickHouse/issues/31963)。[#32187](https://github.com/ClickHouse/ClickHouse/pull/32187)（[Maksim Kita](https://github.com/kitaisreal)）。
* 当在部分副本上禁用 `replicated_can_become_leader` 设置时，使用 quorum 插入数据可能会导致活动副本数量被错误计算。该问题已修复。[#32157](https://github.com/ClickHouse/ClickHouse/pull/32157) ([tavplubix](https://github.com/tavplubix)).
* 字典：修复 `{condition}` 在自定义数据库查询中不起作用的问题。 [#32117](https://github.com/ClickHouse/ClickHouse/pull/32117) ([Maksim Kita](https://github.com/kitaisreal)).
* 修复了在从 `Nullable` 类型进行 `CAST` 时使用 `cast_keep_nullable` 的问题（此前对于诸如 `toUInt32OrDefault(toNullable(toUInt32(1)))` 的情况会触发 `PARAMETER_OUT_OF_BOUND` 错误）。 [#32080](https://github.com/ClickHouse/ClickHouse/pull/32080) ([Azat Khuzhin](https://github.com/azat)).
* 在某些较为少见的场景下修复 Join 存储引擎的 CREATE TABLE。关闭 [#31680](https://github.com/ClickHouse/ClickHouse/issues/31680)。[#32066](https://github.com/ClickHouse/ClickHouse/pull/32066)（[SuperDJY](https://github.com/cmsxbc)）。
* 修复在分离 part 时出现的 `Directory ... already exists and is not empty` 错误。[#32063](https://github.com/ClickHouse/ClickHouse/pull/32063) ([tavplubix](https://github.com/tavplubix)).
* `MaterializedMySQL`（实验性功能）：修复了来自 MySQL 的 `DECIMAL` 数据被错误解析的问题。[#31990](https://github.com/ClickHouse/ClickHouse/pull/31990) ([Håvard Kvålen](https://github.com/havardk))。
* `FileLog`（实验特性）引擎在建表失败时不必要地创建了元数据目录。修复 [#31962](https://github.com/ClickHouse/ClickHouse/issues/31962)。[#31967](https://github.com/ClickHouse/ClickHouse/pull/31967) ([flynn](https://github.com/ucasfl))。
* 如果某个 `GET_PART` 条目对应的分片在所有副本上都丢失，并且同一分区中没有其他分片，那么该条目可能会在复制队列中卡住。对于分区键仅包含整型列或 `Date[Time]` 的情况，此问题已修复。修复 [#31485](https://github.com/ClickHouse/ClickHouse/issues/31485)。[#31887](https://github.com/ClickHouse/ClickHouse/pull/31887)（[tavplubix](https://github.com/tavplubix)）。
* 修复 `empty` 和 `notEmpty` 函数在处理 `UUID` 类型参数时的问题。修复了 [#31819](https://github.com/ClickHouse/ClickHouse/issues/31819)。[#31883](https://github.com/ClickHouse/ClickHouse/pull/31883)（[Anton Popov](https://github.com/CurtizJ)）。
* 在构造 `KeeperTCPHandler` 时，将配置路径从 `keeper_server.session_timeout_ms` 更改为 `keeper_server.coordination_settings.session_timeout_ms`。`operation_timeout` 同样如此。 [#31859](https://github.com/ClickHouse/ClickHouse/pull/31859) ([JackyWoo](https://github.com/JackyWoo)).
* 修复在使用可为空主键时对 Nullable 类型进行的无效类型转换问题。（不建议使用可为空主键——请不要使用。）此修复解决了 [#31075](https://github.com/ClickHouse/ClickHouse/issues/31075)。[#31823](https://github.com/ClickHouse/ClickHouse/pull/31823)（[Amos Bird](https://github.com/amosbird)）。
* 修复 SQL 中递归 UDF 导致的崩溃问题。关闭 [#30856](https://github.com/ClickHouse/ClickHouse/issues/30856)。[#31820](https://github.com/ClickHouse/ClickHouse/pull/31820)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复在将带类型的函数 `dictGet` 用于类型为 `Nullable` 的字典属性时会导致崩溃的问题。修复 [#30980](https://github.com/ClickHouse/ClickHouse/issues/30980)。[#31800](https://github.com/ClickHouse/ClickHouse/pull/31800)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复在（某些 ODBC 驱动下）ODBC 查询结果为空时发生的崩溃。关闭 [#31465](https://github.com/ClickHouse/ClickHouse/issues/31465)。[#31766](https://github.com/ClickHouse/ClickHouse/pull/31766)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复禁用查询分析器的问题（在 `query_profiler_real_time_period_ns>0` / `query_profiler_cpu_time_period_ns>0` 的情况下，即使查询结束后，查询分析器仍可能保持启用）。 [#31740](https://github.com/ClickHouse/ClickHouse/pull/31740) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在并发执行 `ATTACH PARTITION` 查询时偶发的段错误问题。 [#31738](https://github.com/ClickHouse/ClickHouse/pull/31738) ([tavplubix](https://github.com/tavplubix)).
* 修复 `JSONEachRowWithProgress` 输出格式在数据行与进度行混合输出时的竞态问题。[#31736](https://github.com/ClickHouse/ClickHouse/pull/31736) ([Kruglov Pavel](https://github.com/Avogar))。
* 修复了在执行 `ON CLUSTER` 查询时，如果指定的集群名称与某个 `Replicated` 数据库同名，会出现 `there are no such cluster here` 错误的问题。 [#31723](https://github.com/ClickHouse/ClickHouse/pull/31723) ([tavplubix](https://github.com/tavplubix)).
* 修复在对 Nullable 列使用 `decrypt` 函数时在某些情况下抛出的异常。此更改关闭了 [#31662](https://github.com/ClickHouse/ClickHouse/issues/31662)。此更改关闭了 [#31426](https://github.com/ClickHouse/ClickHouse/issues/31426)。[#31707](https://github.com/ClickHouse/ClickHouse/pull/31707)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在字符串包含 UTF-8 字符时 ngrams 固定函数的问题。[#31706](https://github.com/ClickHouse/ClickHouse/pull/31706) ([yandd](https://github.com/yandd)).
* 修复了设置 `input_format_allow_errors_num` 和 `input_format_allow_errors_ratio` 在解析 `IPv4` 等域类型时不起作用的问题。修复了 [#31686](https://github.com/ClickHouse/ClickHouse/issues/31686)。[#31697](https://github.com/ClickHouse/ClickHouse/pull/31697)（[tavplubix](https://github.com/tavplubix)）。
* 修复 `MATERIALIZE COLUMN` 中的空指针异常。[#31679](https://github.com/ClickHouse/ClickHouse/pull/31679) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 在 `Ordinary` 数据库中对 DDL 字典执行重命名操作时，`RENAME TABLE` 查询运行不正确，现已修复。[#31638](https://github.com/ClickHouse/ClickHouse/pull/31638) ([tavplubix](https://github.com/tavplubix)).
* 按预期方式实现 `sparkbar` 聚合函数，参见：[ #26175 ](https://github.com/ClickHouse/ClickHouse/issues/26175)#issuecomment-960353867、[评论](https://github.com/ClickHouse/ClickHouse/issues/26175#issuecomment-961155065)。[ #31624 ](https://github.com/ClickHouse/ClickHouse/pull/31624)（[小路](https://github.com/nicelulu)）。
* 修复在仅列名包含无效 UTF-8 序列时生成无效 JSON 的问题。 [#31534](https://github.com/ClickHouse/ClickHouse/pull/31534) ([Kevin Michel](https://github.com/kmichel-aiven)).
* 在修复该优化中的缺陷之前，禁用 `partial_merge_join_left_table_buffer_bytes`。参见 [#31009](https://github.com/ClickHouse/ClickHouse/issues/31009))。移除冗余选项 `partial_merge_join_optimizations`。[#31528](https://github.com/ClickHouse/ClickHouse/pull/31528)（[Vladimir C](https://github.com/vdimir)）。
* 修复短 `INSERT SELECT` 查询的进度显示。[#31510](https://github.com/ClickHouse/ClickHouse/pull/31510)（[Azat Khuzhin](https://github.com/azat)）。
* 修复在 `GROUP BY` 与位置参数组合使用时的错误行为。关闭 [#31280](https://github.com/ClickHouse/ClickHouse/issues/31280)#issuecomment-968696186。 [#31420](https://github.com/ClickHouse/ClickHouse/pull/31420)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复 S3 STS 凭证提供程序中的 `nullptr` 问题。[#31409](https://github.com/ClickHouse/ClickHouse/pull/31409) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 从索引分析中移除 `notLike` 函数，因为其行为不正确。[#31169](https://github.com/ClickHouse/ClickHouse/pull/31169) ([sundyli](https://github.com/sundy-li))。
* 修复 Keeper 中的一个缺陷：当部分协调日志丢失且最新快照比最新日志更新时，可能导致无法启动。 [#31150](https://github.com/ClickHouse/ClickHouse/pull/31150) ([alesapin](https://github.com/alesapin)).
* 在本地 JOIN 中重写右侧分布式表。解决 [#25809](https://github.com/ClickHouse/ClickHouse/issues/25809)。[#31105](https://github.com/ClickHouse/ClickHouse/pull/31105)（[abel-cheng](https://github.com/abel-cheng)）。
* 修复带有别名和 `WHERE` 子句的 `Merge` 表（之前完全无法使用）。关闭 [#28802](https://github.com/ClickHouse/ClickHouse/issues/28802)。[#31044](https://github.com/ClickHouse/ClickHouse/pull/31044)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复了带引号标识符情况下的 JSON&#95;VALUE/JSON&#95;QUERY，使得在 JSON 路径中可以包含空格。关闭 [#30971](https://github.com/ClickHouse/ClickHouse/issues/30971)。[#31003](https://github.com/ClickHouse/ClickHouse/pull/31003)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在非行向格式中使用 `formatRow` 函数会导致段错误。不允许在此类格式中使用该函数（因为这没有意义）。[#31001](https://github.com/ClickHouse/ClickHouse/pull/31001) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复了一个问题：在删除物化视图之后执行的 `SELECT` 查询会出错。见 [#30691](https://github.com/ClickHouse/ClickHouse/issues/30691)。[#30997](https://github.com/ClickHouse/ClickHouse/pull/30997)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在执行 ATTACH PARTITION ... FROM 和 MOVE PARTITION ... 时跳过 `max_partition_size_to_drop` 检查 [#30995](https://github.com/ClickHouse/ClickHouse/pull/30995) ([Amr Alaa](https://github.com/amralaa-MSFT)).
* 修复 `INTERSECT` 和 `EXCEPT` 运算符的一些边界情况。关闭 [#30803](https://github.com/ClickHouse/ClickHouse/issues/30803)。[#30965](https://github.com/ClickHouse/ClickHouse/pull/30965)（[Kseniia Sumarokova](https://github.com/kssenii)）。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement}

- 修复非 x86 架构构建中的错误过滤结果。此修复关闭了 [#31417](https://github.com/ClickHouse/ClickHouse/issues/31417)。此修复关闭了 [#31524](https://github.com/ClickHouse/ClickHouse/issues/31524)。[#31574](https://github.com/ClickHouse/ClickHouse/pull/31574) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 使 ClickHouse 构建完全可重现(在不同机器上字节完全相同)。此修复关闭了 [#22113](https://github.com/ClickHouse/ClickHouse/issues/22113)。[#31899](https://github.com/ClickHouse/ClickHouse/pull/31899) ([alexey-milovidov](https://github.com/alexey-milovidov))。从二进制文件中移除构建目录的文件系统路径以实现可重现构建。此修改是为了 [#22113](https://github.com/ClickHouse/ClickHouse/issues/22113)。[#31838](https://github.com/ClickHouse/ClickHouse/pull/31838) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 为 `zlib-ng`、`cassandra`、`mariadb-connector-c`、`xz`、`re2`、`sentry`、`gsasl`、`arrow`、`protobuf` 使用我们自己的 CMakeLists。此修改是为了 [#20151](https://github.com/ClickHouse/ClickHouse/issues/20151)。属于 [#9226](https://github.com/ClickHouse/ClickHouse/issues/9226)。朝着从构建系统中移除冗余内容迈出的一小步。[#30599](https://github.com/ClickHouse/ClickHouse/pull/30599) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 密闭构建:使用固定版本的 libc 并确保在构建过程中不使用来自宿主操作系统的源文件或二进制文件。此修复关闭了 [#27133](https://github.com/ClickHouse/ClickHouse/issues/27133)。此修复关闭了 [#21435](https://github.com/ClickHouse/ClickHouse/issues/21435)。此修复关闭了 [#30462](https://github.com/ClickHouse/ClickHouse/issues/30462)。[#30011](https://github.com/ClickHouse/ClickHouse/pull/30011) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 添加函数 `getFuzzerData()` 以便轻松对特定函数进行模糊测试。此修复关闭了 [#23227](https://github.com/ClickHouse/ClickHouse/issues/23227)。[#27526](https://github.com/ClickHouse/ClickHouse/pull/27526) ([Alexey Boykov](https://github.com/mathalex))。
- 在 Docker 内更正确地设置 capabilities。[#31802](https://github.com/ClickHouse/ClickHouse/pull/31802) ([Constantine Peresypkin](https://github.com/pkit))。
- 启用 clang `-fstrict-vtable-pointers`、`-fwhole-program-vtables` 编译选项。[#20151](https://github.com/ClickHouse/ClickHouse/pull/20151) ([Maksim Kita](https://github.com/kitaisreal))。
- 避免为 FreeBSD 交叉编译下载工具链压缩包。[#31672](https://github.com/ClickHouse/ClickHouse/pull/31672) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 初步支持 risc-v。有关已测试的特殊问题和构建命令,请参阅 development/build-cross-riscv。[#31309](https://github.com/ClickHouse/ClickHouse/pull/31309) ([Vladimir Smirnov](https://github.com/Civil))。
- 支持在 ARM 机器上使用参数 "-DENABLE_TESTS=OFF" 进行编译。[#31007](https://github.com/ClickHouse/ClickHouse/pull/31007) ([zhanghuajie](https://github.com/zhanghuajieHIT))。

### ClickHouse 版本 v21.11, 2021-11-09 {#clickhouse-release-v2111-2021-11-09}

#### 向后不兼容的变更 {#backward-incompatible-change-1}


- 更改 SQL/JSON 函数中 json_path 和 json 参数的顺序(以符合标准)。关闭 [#30449](https://github.com/ClickHouse/ClickHouse/issues/30449)。[#30474](https://github.com/ClickHouse/ClickHouse/pull/30474) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 移除 `MergeTree` 表设置 `write_final_mark`。该设置将始终为 `true`。[#30455](https://github.com/ClickHouse/ClickHouse/pull/30455) ([Kseniia Sumarokova](https://github.com/kssenii))。无需任何操作,所有表都与新版本兼容。
- 函数 `bayesAB` 已被移除。欢迎帮助以更新的形式恢复此函数。关闭 [#26233](https://github.com/ClickHouse/ClickHouse/issues/26233)。[#29934](https://github.com/ClickHouse/ClickHouse/pull/29934) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 仅当您已开始使用实验性的 `clickhouse-keeper` 支持时,此项才相关。现在 ClickHouse Keeper 快照默认使用 `ZSTD` 编解码器进行压缩,而不是自定义的 ClickHouse LZ4 块压缩。可以通过 `compress_snapshots_with_zstd_format` 协调设置来关闭此行为(必须在所有仲裁副本上保持一致)。向后不兼容的情况非常罕见,仅在新节点向无法读取 ZSTD 格式快照的旧节点发送快照时(在恢复情况下发生)才可能发生。[#29417](https://github.com/ClickHouse/ClickHouse/pull/29417) ([alesapin](https://github.com/alesapin))。

#### 新功能 {#new-feature-1}


* 新的异步 INSERT 模式允许在后台累积插入的数据，并以单个批次进行存储。在客户端，可以通过为在查询中内联数据或使用单独缓冲区的 `INSERT` 查询（例如通过 HTTP 协议的 `INSERT` 查询）设置 `async_insert` 来启用该模式。如果 `wait_for_async_insert` 为 true（默认值），客户端会一直等待，直到数据被刷写到表中。在服务端，该模式由设置 `async_insert_threads`、`async_insert_max_data_size` 和 `async_insert_busy_timeout_ms` 进行控制。实现了 [#18282](https://github.com/ClickHouse/ClickHouse/issues/18282)。[#27537](https://github.com/ClickHouse/ClickHouse/pull/27537)（[Anton Popov](https://github.com/CurtizJ)）。[#20557](https://github.com/ClickHouse/ClickHouse/pull/20557)（[Ivan](https://github.com/abyss7)）。性能说明：使用异步插入时，每秒最多可以执行约 10 000 个单独的 INSERT 查询，因此如果希望达到每秒插入数百万行的性能，仍然建议以批量方式插入数据。
* 为 `clickhouse-local` 添加交互模式。现在，你可以直接运行 `clickhouse-local` 来获得一个无需连接服务器的 ClickHouse 命令行界面，并处理来自文件和外部数据源的数据。同时合并了 `clickhouse-client` 和 `clickhouse-local` 的代码。关闭 [#7203](https://github.com/ClickHouse/ClickHouse/issues/7203)。关闭 [#25516](https://github.com/ClickHouse/ClickHouse/issues/25516)。关闭 [#22401](https://github.com/ClickHouse/ClickHouse/issues/22401)。[#26231](https://github.com/ClickHouse/ClickHouse/pull/26231) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 新增支持可执行（脚本式）用户自定义函数。这类 UDF 可以使用任意编程语言编写。 [#28803](https://github.com/ClickHouse/ClickHouse/pull/28803) ([Maksim Kita](https://github.com/kitaisreal)).
* 允许预先定义外部数据源连接。这样在使用外部数据源时就无需再次指定凭证或地址，而是可以通过名称进行引用。解决了 [#28367](https://github.com/ClickHouse/ClickHouse/issues/28367)。[#28577](https://github.com/ClickHouse/ClickHouse/pull/28577)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 新增了 `INFORMATION_SCHEMA` 数据库，其中包含映射到 `system` 数据库中相应表的 `SCHEMATA`、`TABLES`、`VIEWS` 和 `COLUMNS` 视图。修复 [#9770](https://github.com/ClickHouse/ClickHouse/issues/9770)。[#28691](https://github.com/ClickHouse/ClickHouse/pull/28691) ([tavplubix](https://github.com/tavplubix))。
* 支持 `EXISTS (subquery)`，并关闭了 [#6852](https://github.com/ClickHouse/ClickHouse/issues/6852)。[#29731](https://github.com/ClickHouse/ClickHouse/pull/29731)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 会话审计日志。将所有成功和失败的登录和登出事件记录到新的 `system.session_log` 表中。[#22415](https://github.com/ClickHouse/ClickHouse/pull/22415) ([Vasily Nemkov](https://github.com/Enmk)) ([Vitaly Baranov](https://github.com/vitlibar))。
* 支持多维余弦距离和欧几里得距离函数；L1、L2、Lp、Linf 距离和范数。在元组上支持标量积以及多种算术运算符。这不仅完全解决了 [#4509](https://github.com/ClickHouse/ClickHouse/issues/4509)，还覆盖了更多场景。[#27933](https://github.com/ClickHouse/ClickHouse/pull/27933)（[Alexey Boykov](https://github.com/mathalex)）。
* 为 `INTO OUTFILE` 和 `FROM INFILE` 添加压缩与解压缩支持（可自动检测或通过额外的可选参数进行指定）。 [#27135](https://github.com/ClickHouse/ClickHouse/pull/27135) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* 通过 HTTP `OPTIONS` 请求添加 CORS（跨域资源共享）支持。也就是说，现在 Grafana 在无服务器请求场景下可以正常工作，无需任何权宜之计。关闭 [#18693](https://github.com/ClickHouse/ClickHouse/issues/18693)。[#29155](https://github.com/ClickHouse/ClickHouse/pull/29155)（[Filatenkov Artur](https://github.com/FArthur-cmd)）。
* 带有 JOIN ON 的查询现在支持析取（OR）。 [#21320](https://github.com/ClickHouse/ClickHouse/pull/21320) ([Ilya Golshtein](https://github.com/ilejn))。
* 新增函数 `tokens`，该函数使用非字母数字的 ASCII 字符作为分隔符，将字符串拆分为多个 token。[#29981](https://github.com/ClickHouse/ClickHouse/pull/29981) ([Maksim Kita](https://github.com/kitaisreal))。新增函数 `ngrams`，用于从文本中提取 n-gram。修复并关闭 [#29699](https://github.com/ClickHouse/ClickHouse/issues/29699)。[#29738](https://github.com/ClickHouse/ClickHouse/pull/29738) ([Maksim Kita](https://github.com/kitaisreal))。
* 添加 Unicode 规范化函数：`normalizeUTF8NFC`、`normalizeUTF8NFD`、`normalizeUTF8NFKC`、`normalizeUTF8NFKD`。[#28633](https://github.com/ClickHouse/ClickHouse/pull/28633)（[darkkeks](https://github.com/darkkeks)）。
* 在 ClickHouse 中使用 `FileLog` 表引擎对应用日志文件进行流式消费。它类似于 `Kafka` 或 `RabbitMQ` 引擎，但面向本地文件系统中的仅追加、轮转日志。修复 [#6953](https://github.com/ClickHouse/ClickHouse/issues/6953)。[#25969](https://github.com/ClickHouse/ClickHouse/pull/25969)（[flynn](https://github.com/ucasfl)）（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 新增 `CapnProto` 输出格式，并重构 `CapnProto` 输入格式。[#29291](https://github.com/ClickHouse/ClickHouse/pull/29291) ([Kruglov Pavel](https://github.com/Avogar)).
* 允许在查询中以二进制字面量的形式书写数字。例如 `SELECT 0b001;`。 [#29304](https://github.com/ClickHouse/ClickHouse/pull/29304) ([Maksim Kita](https://github.com/kitaisreal))。
* 新增 `hashed_array` 字典类型。在使用包含多个属性的字典时可以节省内存。修复了 [#30236](https://github.com/ClickHouse/ClickHouse/issues/30236)。[#30242](https://github.com/ClickHouse/ClickHouse/pull/30242)（[Maksim Kita](https://github.com/kitaisreal)）。
* 新增了 `JSONExtractKeys` 函数。 [#30056](https://github.com/ClickHouse/ClickHouse/pull/30056) ([Vitaly](https://github.com/orloffv))。
* 添加了函数 `getOSKernelVersion`——返回操作系统内核版本号的字符串。[#29755](https://github.com/ClickHouse/ClickHouse/pull/29755) ([Memo](https://github.com/Joeywzr))。
* 添加了 `MD4` 和 `SHA384` 函数。MD4 是一种过时且不安全的哈希函数，只能在极少数场景下使用，例如某些遗留系统中已经在使用 MD4，而你需要获得完全相同的结果时。[#29602](https://github.com/ClickHouse/ClickHouse/pull/29602) ([Nikita Tikhomirov](https://github.com/NSTikhomirov))。
* 可以通过在配置文件中将 `hsts_max_age` 设置为正整数，为 ClickHouse HTTP 服务器启用 HSTS。 [#29516](https://github.com/ClickHouse/ClickHouse/pull/29516) ([凌涛](https://github.com/lingtaolf))。
* 新增对华为 OBS 存储的支持。关闭 Issue [#24294](https://github.com/ClickHouse/ClickHouse/issues/24294)。[#29511](https://github.com/ClickHouse/ClickHouse/pull/29511) ([kevin wan](https://github.com/MaxWk))。
* 新增函数 `mapContainsKeyLike`，用于判断 map 中是否存在键名匹配简单正则表达式的元素。[#29471](https://github.com/ClickHouse/ClickHouse/pull/29471) ([凌涛](https://github.com/lingtaolf))。新增函数 `mapExtractKeyLike`，用于从 map 中提取仅保留键名匹配指定模式的元素。[#30793](https://github.com/ClickHouse/ClickHouse/pull/30793) ([凌涛](https://github.com/lingtaolf))。
* 已实现 `ALTER TABLE x MODIFY COMMENT`。 [#29264](https://github.com/ClickHouse/ClickHouse/pull/29264) ([Vasily Nemkov](https://github.com/Enmk)).
* 添加了 ClickHouse 中缺失但可通过 H3 API 使用的 H3 检查函数： [https://h3geo.org/docs/api/inspection](https://h3geo.org/docs/api/inspection)。 [#29209](https://github.com/ClickHouse/ClickHouse/pull/29209)（[Bharat Nallan](https://github.com/bharatnc)）。
* 允许在 Replicated 数据库中执行非复制表的 `ALTER TABLE FETCH` 和 `ATTACH` 操作。[#29202](https://github.com/ClickHouse/ClickHouse/pull/29202) ([Kevin Michel](https://github.com/kmichel-aiven)).
* 新增了设置 `output_format_csv_null_representation`：其作用与 `output_format_tsv_null_representation` 相同，但用于 CSV 输出。[#29123](https://github.com/ClickHouse/ClickHouse/pull/29123) ([PHO](https://github.com/depressed-pho))。
* 新增函数 `zookeeperSessionUptime()`，用于返回当前 ZooKeeper 会话已运行的时间（以秒为单位）。 [#28983](https://github.com/ClickHouse/ClickHouse/pull/28983) ([tavplubix](https://github.com/tavplubix)).
* 实现 `h3ToGeoBoundary` 函数。 [#28952](https://github.com/ClickHouse/ClickHouse/pull/28952) ([Ivan Veselov](https://github.com/fuzzERot))。
* 添加聚合函数 `exponentialMovingAverage`，可作为窗口函数使用。由此关闭了 [#27511](https://github.com/ClickHouse/ClickHouse/issues/27511)。[#28914](https://github.com/ClickHouse/ClickHouse/pull/28914)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 允许在 `DESCRIBE` 查询结果中包含表中列的子列（可通过设置 `describe_include_subcolumns` 启用）。 [#28905](https://github.com/ClickHouse/ClickHouse/pull/28905) ([Anton Popov](https://github.com/CurtizJ)).
* 为 `Executable` 和 `ExecutablePool` 添加了选项 `send_chunk_header`。如果该选项为 true，则会在发送数据块之前，先将包含块行数 `rows_count` 和换行符的头信息发送给客户端。 [#28833](https://github.com/ClickHouse/ClickHouse/pull/28833) ([Maksim Kita](https://github.com/kitaisreal)).
* `tokenbf_v1` 和 `ngram` 支持 key 类型为 String 或 FixedString 的 Map。它增强了在带有 map key 过滤条件的查询中的数据跳过能力。`sql CREATE TABLE map_tokenbf ( row_id UInt32, map Map(String, String), INDEX map_tokenbf map TYPE ngrambf_v1(4,256,2,0) GRANULARITY 1 ) Engine=MergeTree() Order by id ` 使用上面的表，查询 `select * from map_tokebf where map['K']='V'` 将会跳过不包含 key `A` 的数据块。当然，实际会跳过多少行取决于你设置的 `granularity` 和 `index_granularity`。 [#28511](https://github.com/ClickHouse/ClickHouse/pull/28511) ([凌涛](https://github.com/lingtaolf))。
* 支持将 profile 事件从服务器发送到客户端。引入了新的数据包类型 `ProfileEvents`。关闭 [#26177](https://github.com/ClickHouse/ClickHouse/issues/26177)。[#28364](https://github.com/ClickHouse/ClickHouse/pull/28364) ([Dmitry Novik](https://github.com/novikd))。
* 为 `FixedString` 和 `String` 数据类型添加位移运算。修复了 [#27763](https://github.com/ClickHouse/ClickHouse/issues/27763)。[#28325](https://github.com/ClickHouse/ClickHouse/pull/28325)（[小路](https://github.com/nicelulu)）。
* 在数据库引擎 MaterializedPostgreSQL 中支持对来自 PostgreSQL 的复制动态添加 / 删除表。支持通过 ALTER 修改数据库设置。解决 [#27573](https://github.com/ClickHouse/ClickHouse/issues/27573)。[#28301](https://github.com/ClickHouse/ClickHouse/pull/28301) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 添加了函数 accurateCastOrDefault(x, T)。修复了 [#21330](https://github.com/ClickHouse/ClickHouse/issues/21330)。作者 @taiyang-li。[#23028](https://github.com/ClickHouse/ClickHouse/pull/23028)（[Maksim Kita](https://github.com/kitaisreal)）。
* 新增函数 `toUUIDOrDefault`、`toUInt8/16/32/64/256OrDefault`、`toInt8/16/32/64/128/256OrDefault`，当字符串解析失败时，允许用户指定默认值（非 `null`）。 [#21330](https://github.com/ClickHouse/ClickHouse/pull/21330) ([taiyang-li](https://github.com/taiyang-li)).

#### 性能改进 {#performance-improvement-1}


* 后台合并操作可以相互抢占执行，并会按合适的优先级进行调度。现在，长时间运行的合并不会阻塞短时合并任务的执行。这有助于更好地调度和控制合并的执行，降低触发 “too many parts” 错误的概率。[#22381](https://github.com/ClickHouse/ClickHouse/issues/22381)。[#25165](https://github.com/ClickHouse/ClickHouse/pull/25165)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。新增功能：允许后台同时执行的合并与变更（mutations）数量多于后台线程池中的线程数。合并和变更会根据其大小按步骤依次执行（越小优先级越高）。要执行的任务数量与线程数量的比例由设置 `background_merges_mutations_concurrency_ratio` 控制，默认值为 2。[#29140](https://github.com/ClickHouse/ClickHouse/pull/29140)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 允许在远程文件系统上使用异步读取，并在从远程文件系统读取时减少寻道次数。这极大地提升了性能，并在某些条件下使实验性的 `web` 和 `s3` 磁盘的性能甚至优于 EBS。[#29205](https://github.com/ClickHouse/ClickHouse/pull/29205)（[Kseniia Sumarokova](https://github.com/kssenii)）。与此同时，`web` 磁盘类型（托管在 Web 服务器上的静态数据集）已从实验特性升级为可用于生产环境。
* 在 `clickhouse-client` 中使用 `INTO OUTFILE` 的查询现在将使用多线程执行。修复了在使用 `INTO OUTFILE` 时进度条闪烁的问题。已关闭 [#30873](https://github.com/ClickHouse/ClickHouse/issues/30873)。已关闭 [#30872](https://github.com/ClickHouse/ClickHouse/issues/30872)。[#30886](https://github.com/ClickHouse/ClickHouse/pull/30886)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 减少某些类型的 `SELECT` 查询从磁盘读取的冗余压缩数据量（仅适用于 `MergeTree` 引擎系列）。[#30111](https://github.com/ClickHouse/ClickHouse/pull/30111) ([alesapin](https://github.com/alesapin))。
* 在 MergeTree 表引擎系列中读取压缩块时，移除了部分冗余的 `seek` 调用。 [#29766](https://github.com/ClickHouse/ClickHouse/pull/29766) ([alesapin](https://github.com/alesapin))。
* 使 `url` 表函数支持并行处理多个 URL。此更改解决了 [#29670](https://github.com/ClickHouse/ClickHouse/issues/29670) 和 [#29671](https://github.com/ClickHouse/ClickHouse/issues/29671)。[#29673](https://github.com/ClickHouse/ClickHouse/pull/29673)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在启用设置 `optimize_aggregation_in_order` 时，提升按主键顺序聚合的性能。 [#30266](https://github.com/ClickHouse/ClickHouse/pull/30266) ([Anton Popov](https://github.com/CurtizJ)).
* 现在 ClickHouse 在与外部 S3 通信时会使用 DNS 缓存。[#29999](https://github.com/ClickHouse/ClickHouse/pull/29999) ([alesapin](https://github.com/alesapin))。
* 为外部数据库（例如 MySQL）添加对 `IS NULL`/`IS NOT NULL` 谓词下推的支持。[#29463](https://github.com/ClickHouse/ClickHouse/pull/29463) ([Azat Khuzhin](https://github.com/azat))。将 `isNull`/`isNotNull` 转换为 `IS NULL`/`IS NOT NULL`（针对外部数据库，例如 MySQL）。[#29446](https://github.com/ClickHouse/ClickHouse/pull/29446) ([Azat Khuzhin](https://github.com/azat))。
* 来自 Dictionary 表中的 SELECT 查询将使用多线程。 [#30500](https://github.com/ClickHouse/ClickHouse/pull/30500) ([Maksim Kita](https://github.com/kitaisreal)).
* 提升 `Decimal` 列在筛选（WHERE 操作）时的性能。[#30431](https://github.com/ClickHouse/ClickHouse/pull/30431) ([Jun Jin](https://github.com/vesslanjin))。
* 在过滤操作中移除分支代码，使用基于 `popcnt`/`ctz` 的更优实现，以获得更好的性能。[#29881](https://github.com/ClickHouse/ClickHouse/pull/29881) ([Jun Jin](https://github.com/vesslanjin))。
* 改进用于 WHERE 运算符的过滤 bytemask 生成器函数，在单个函数中统一利用 SSE/AVX2/AVX512 指令。请注意，默认情况下 ClickHouse 只使用 SSE，因此这仅与自定义构建相关。 [#30014](https://github.com/ClickHouse/ClickHouse/pull/30014) ([jasperzhu](https://github.com/jinjunzh)). [#30670](https://github.com/ClickHouse/ClickHouse/pull/30670) ([jasperzhu](https://github.com/jinjunzh)).
* 提升 `Nullable` 浮点数 `SUM` 聚合函数的性能。 [#28906](https://github.com/ClickHouse/ClickHouse/pull/28906) ([Raúl Marín](https://github.com/Algunenano)).
* 在使用多个磁盘时加速数据分片加载过程。其思路与 [https://github.com/ClickHouse/ClickHouse/pull/16423](https://github.com/ClickHouse/ClickHouse/pull/16423) 类似。生产环境中表现为：耗时由 24 分钟缩短至 16 分钟。[#28363](https://github.com/ClickHouse/ClickHouse/pull/28363)（[Amos Bird](https://github.com/amosbird)）。
* 减小 S3 分段上传的默认分片大小，以降低内存占用。[#28679](https://github.com/ClickHouse/ClickHouse/pull/28679) ([ianton-ru](https://github.com/ianton-ru)).
* 加速 `bitmapAnd` 函数。 [#28332](https://github.com/ClickHouse/ClickHouse/pull/28332) ([dddounaiking](https://github.com/OodounaikingoO)).
* 在合并仍在进行时，移除了 `StorageMergeTree` 中不理想的变更通知。[#27552](https://github.com/ClickHouse/ClickHouse/pull/27552) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 尝试优化字符串比较性能。 [#28767](https://github.com/ClickHouse/ClickHouse/pull/28767) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 主键索引和分区过滤条件可用于 `tuple`。 [#29281](https://github.com/ClickHouse/ClickHouse/pull/29281) ([凌涛](https://github.com/lingtaolf)).
* 如果查询中包含多个具有相同参数但 `level` 参数不同的 quantile 聚合函数，在启用 `optimize_syntax_fuse_functions` 设置时，它们会被合并起来，并在一次遍历中执行。[#26657](https://github.com/ClickHouse/ClickHouse/pull/26657)（[hexiaoting](https://github.com/hexiaoting)）。
* 现在，针对首个主键表达式的 min-max 聚合已利用 projection 进行了优化。这对应于 [#329](https://github.com/ClickHouse/ClickHouse/issues/329)。[#29918](https://github.com/ClickHouse/ClickHouse/pull/29918)（[Amos Bird](https://github.com/amosbird)）。

#### 实验性功能 {#experimental-feature-1}

- 为 ClickHouse Keeper 添加了在 `.xml` 文件中更改节点配置的能力。[#30372](https://github.com/ClickHouse/ClickHouse/pull/30372) ([alesapin](https://github.com/alesapin))。
- 添加了 `sparkbar` 聚合函数。此更改关闭了 [#26175](https://github.com/ClickHouse/ClickHouse/issues/26175)。[#27481](https://github.com/ClickHouse/ClickHouse/pull/27481) ([小路](https://github.com/nicelulu))。注意:该函数存在一个缺陷,其行为将在未来版本中更改。

#### 改进 {#improvement-1}


* 允许用户无需重启即可修改日志级别。 [#29586](https://github.com/ClickHouse/ClickHouse/pull/29586) ([Nikolay Degterinsky](https://github.com/evillique))。
* 对 SQL UDF 进行了多项改进。现在用于管理 SQL 用户自定义函数的查询支持 ON CLUSTER 子句。例如：`CREATE FUNCTION test_function ON CLUSTER 'cluster' AS x -> x + 1;`。修复了 [#30666](https://github.com/ClickHouse/ClickHouse/issues/30666)。[#30734](https://github.com/ClickHouse/ClickHouse/pull/30734)（[Maksim Kita](https://github.com/kitaisreal)）。支持 `CREATE OR REPLACE`、`CREATE IF NOT EXISTS` 语法。[#30454](https://github.com/ClickHouse/ClickHouse/pull/30454)（[Maksim Kita](https://github.com/kitaisreal)）。新增对 DROP IF EXISTS 的支持，例如 `DROP FUNCTION IF EXISTS test_function`。[#30437](https://github.com/ClickHouse/ClickHouse/pull/30437)（[Maksim Kita](https://github.com/kitaisreal)）。支持 lambda 表达式，例如 `CREATE FUNCTION lambda_function AS x -> arrayMap(element -> element * 2, x);`。[#30435](https://github.com/ClickHouse/ClickHouse/pull/30435)（[Maksim Kita](https://github.com/kitaisreal)）。为 `clickhouse-local` 添加了对 SQL 用户自定义函数的支持。[#30179](https://github.com/ClickHouse/ClickHouse/pull/30179)（[Maksim Kita](https://github.com/kitaisreal)）。
* 在全局范围内启用逐查询内存分析器（将 `memory_profiler_step` 设为 4MiB）。[#29455](https://github.com/ClickHouse/ClickHouse/pull/29455) ([Azat Khuzhin](https://github.com/azat)).
* 在 `system.data_skipping_indices` 中新增了列 `data_compressed_bytes`、`data_uncompressed_bytes`、`marks_bytes`。在 `system.parts` 中新增了列 `secondary_indices_compressed_bytes`、`secondary_indices_uncompressed_bytes`、`secondary_indices_marks_bytes`。关闭了 [#29697](https://github.com/ClickHouse/ClickHouse/issues/29697)。[#29896](https://github.com/ClickHouse/ClickHouse/pull/29896)（[Maksim Kita](https://github.com/kitaisreal)）。
* 为 system.tables 添加了 `table` 别名，为 system.databases 添加了 `database` 别名 [#29677](https://github.com/ClickHouse/ClickHouse/issues/29677)。[#29882](https://github.com/ClickHouse/ClickHouse/pull/29882) ([kevin wan](https://github.com/MaxWk))。
* 在服务器启动时正确解析表之间的相互依赖关系。解决 [#8004](https://github.com/ClickHouse/ClickHouse/issues/8004) 和 [#15170](https://github.com/ClickHouse/ClickHouse/issues/15170)。[#28373](https://github.com/ClickHouse/ClickHouse/pull/28373)（[tavplubix](https://github.com/tavplubix)）。
* 避免在 `divide`、`intDiv` 和 `modulo` 函数中，当分母为 Nullable 时出现 “Division by zero” 错误。关闭 [#22621](https://github.com/ClickHouse/ClickHouse/issues/22621)。[#28352](https://github.com/ClickHouse/ClickHouse/pull/28352) ([Kruglov Pavel](https://github.com/Avogar))。
* 允许在文本格式中将 `Date` 数据类型的值在原有 `YYYY-MM-DD` 格式之外，也解析为 `YYYYMMDD`。修复了 [#30870](https://github.com/ClickHouse/ClickHouse/issues/30870)。[#30871](https://github.com/ClickHouse/ClickHouse/pull/30871)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* Web UI：在表格单元格中渲染条形图。 [#29792](https://github.com/ClickHouse/ClickHouse/pull/29792) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 用户现在可以在创建字典时添加注释：`CREATE DICTIONARY ... COMMENT 'vaue'` ... [#29899](https://github.com/ClickHouse/ClickHouse/pull/29899) ([Vasily Nemkov](https://github.com/Enmk))。用户现在也可以在 `CREATE DATABASE` 语句中为数据库设置注释 ... [#29429](https://github.com/ClickHouse/ClickHouse/pull/29429) ([Vasily Nemkov](https://github.com/Enmk))。
* 引入 `compiled_expression_cache_elements_size` 设置。如果你需要用到这个设置，你自然会知道它的作用。[#30667](https://github.com/ClickHouse/ClickHouse/pull/30667)（[Maksim Kita](https://github.com/kitaisreal)）。
* clickhouse-format 现在支持选项 `--query`。在早期版本中，必须通过 stdin 传递查询。[#29325](https://github.com/ClickHouse/ClickHouse/pull/29325) ([凌涛](https://github.com/lingtaolf))。
* 为 `Memory` 数据库中的表提供 `ALTER TABLE` 支持。`Memory` 数据库用于 `clickhouse-local`。 [#30866](https://github.com/ClickHouse/ClickHouse/pull/30866) ([tavplubix](https://github.com/tavplubix)).
* 现在，`arrayStringConcat` 已支持所有可序列化类型的数组。 [#30840](https://github.com/ClickHouse/ClickHouse/pull/30840) ([Nickita Taranov](https://github.com/nickitat))。
* ClickHouse 现在会考虑 Docker/cgroups 的限制来确定系统内存总量。参见 [#25662](https://github.com/ClickHouse/ClickHouse/issues/25662)。[#30574](https://github.com/ClickHouse/ClickHouse/pull/30574)（[Pavel Medvedev](https://github.com/pmed)）。
* 从 PostgreSQL 数据库获取的表结构现在更加可靠。[#30477](https://github.com/ClickHouse/ClickHouse/pull/30477)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在 GROUP BY 和 ORDER BY 中对位置参数提供全面支持。 [#30433](https://github.com/ClickHouse/ClickHouse/pull/30433) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 允许使用 JSONExtractString 将非字符串类型元素提取为字符串。相关讨论见 [pull/25452#issuecomment-927123287](https://github.com/ClickHouse/ClickHouse/pull/25452#issuecomment-927123287)。[#30426](https://github.com/ClickHouse/ClickHouse/pull/30426)（[Amos Bird](https://github.com/amosbird)）。
* 新增支持在针对 `GraphiteMergeTree` 的 SELECT 查询中使用 FINAL 子句。[#30360](https://github.com/ClickHouse/ClickHouse/pull/30360) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 对副本克隆以及为损坏的数据部分入队拉取的逻辑进行了小幅改进，应能避免在极少数情况下复制队列中的 `GET_PART` 条目出现长时间挂起的情况。 [#30346](https://github.com/ClickHouse/ClickHouse/pull/30346) ([tavplubix](https://github.com/tavplubix)).
* 允许通过符号链接访问 `user_files` 目录中的文件，以供 file 表函数使用。 [#30309](https://github.com/ClickHouse/ClickHouse/pull/30309) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 修复了 `Date32` 与 `Date`、`DateTime`、`DateTime64` 和 `String` 的比较行为。[#30219](https://github.com/ClickHouse/ClickHouse/pull/30219) ([liang.huang](https://github.com/lhuang09287750))。
* 支持通过 `ALTER TABLE <table> REMOVE SAMPLE BY` 从 `MergeTree` 表中移除 `SAMPLE BY` 表达式。 [#30180](https://github.com/ClickHouse/ClickHouse/pull/30180) ([Anton Popov](https://github.com/CurtizJ)).
* 现在，如果 `Keeper`（作为 `clickhouse-server` 的一部分）可以连接到其他节点，它将以异步方式启动。[#30170](https://github.com/ClickHouse/ClickHouse/pull/30170)（[alesapin](https://github.com/alesapin)）。
* 现在 `clickhouse-client` 支持原生多行编辑。[#30143](https://github.com/ClickHouse/ClickHouse/pull/30143)（[Amos Bird](https://github.com/amosbird)）。
* `polygon` 字典（反向地理编码）：当 `store_polygon_key_column` 设置为 true 时，新增通过 SELECT 查询方式来读取字典内容的支持。修复了 [#30090](https://github.com/ClickHouse/ClickHouse/issues/30090)。[#30142](https://github.com/ClickHouse/ClickHouse/pull/30142)（[Maksim Kita](https://github.com/kitaisreal)）。
* 将 ClickHouse 标志添加到 Play UI。[#29674](https://github.com/ClickHouse/ClickHouse/pull/29674)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在从 `Arrow`、`ArrowStream`、`Parquet` 和 `ORC` 等 Arrow 支持的格式读取列时，改进了异常消息。这修复了 [#29926](https://github.com/ClickHouse/ClickHouse/issues/29926)。[#29927](https://github.com/ClickHouse/ClickHouse/pull/29927)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `Buffer` 表中刷新与启动之间的数据竞争问题。这可能会在测试中暴露。[#29930](https://github.com/ClickHouse/ClickHouse/pull/29930) ([Azat Khuzhin](https://github.com/azat)).
* 修复了 `DatabaseMemory` 的 `DROP TABLE` 与 `LiveView` 之间的 `lock-order-inversion` 问题。Live View 是一项实验性功能。Memory 数据库用于 clickhouse-local。 [#29929](https://github.com/ClickHouse/ClickHouse/pull/29929) ([Azat Khuzhin](https://github.com/azat)).
* 修复周期性字典重新加载与配置重新加载之间的锁顺序倒置问题。[#29928](https://github.com/ClickHouse/ClickHouse/pull/29928) ([Azat Khuzhin](https://github.com/azat)).
* 将 zoneinfo 文件更新至 2021c 版本。 [#29925](https://github.com/ClickHouse/ClickHouse/pull/29925) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 为 `clickhouse-copier` 新增可配置重试及其间隔的功能。[#29921](https://github.com/ClickHouse/ClickHouse/pull/29921) ([Azat Khuzhin](https://github.com/azat)).
* 添加 `shutdown_wait_unfinished_queries` 服务器设置项，以允许在 `shutdown_wait_unfinished` 指定的时间内等待正在运行的查询完成。用于解决 [#24451](https://github.com/ClickHouse/ClickHouse/issues/24451)。[#29914](https://github.com/ClickHouse/ClickHouse/pull/29914)（[Amos Bird](https://github.com/amosbird)）。
* 新增峰值内存使用情况跟踪功能（在 `system.trace_log` 中新增 `trace_type` —— `MemoryPeak`）。 [#29858](https://github.com/ClickHouse/ClickHouse/pull/29858) ([Azat Khuzhin](https://github.com/azat)).
* PostgreSQL 外部表：为用于获取副本标识索引的查询添加了分区表前缀 &#39;p&#39;。 [#29828](https://github.com/ClickHouse/ClickHouse/pull/29828) ([Shoh Jahon](https://github.com/Shohjahon))。
* 在 mutate/merge 期间应用 `max_untracked_memory`/`memory_profiler_step`/`memory_profiler_sample_probability`，以对合并过程中的内存使用情况进行分析。 [#29681](https://github.com/ClickHouse/ClickHouse/pull/29681) ([Azat Khuzhin](https://github.com/azat)).
* 查询混淆器：`clickhouse-format --obfuscate` 现在支持更多类型的查询。[#29672](https://github.com/ClickHouse/ClickHouse/pull/29672) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了 `clickhouse-format --obfuscate` 无法处理包含嵌入式字典（`regionTo...` 函数）的查询的问题。[#29667](https://github.com/ClickHouse/ClickHouse/pull/29667) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复 JSON 函数对 Nullable 的错误处理。这修复了 [#29615](https://github.com/ClickHouse/ClickHouse/issues/29615)。将其标记为改进，因为 [https://github.com/ClickHouse/ClickHouse/pull/28012](https://github.com/ClickHouse/ClickHouse/pull/28012) 尚未发布。[#29659](https://github.com/ClickHouse/ClickHouse/pull/29659)（[Amos Bird](https://github.com/amosbird)）。
* 默认将 `listen_backlog` 值提高（与较新 Linux 内核的默认值保持一致）。[#29643](https://github.com/ClickHouse/ClickHouse/pull/29643)（[Azat Khuzhin](https://github.com/azat)）。
* 当服务器配置项 `dictionaries_config`、`models_config`、`user_defined_executable_functions_config` 发生变更时，重新加载字典、模型以及用户自定义可执行函数。修复 [#28142](https://github.com/ClickHouse/ClickHouse/issues/28142)。[#29529](https://github.com/ClickHouse/ClickHouse/pull/29529)（[Maksim Kita](https://github.com/kitaisreal)）。
* 取消对 projection 名称的多余限制。现在 projection 名称可以以 `tmp_` 开头。[#29520](https://github.com/ClickHouse/ClickHouse/pull/29520)（[Amos Bird](https://github.com/amosbird)）。
* 修复了在包含嵌套子查询的 mutation 操作中出现的 `There is no query or query context has expired` 错误。如果表为复制表且已禁用 `allow_nondeterministic_mutations` 设置，则不允许在 mutation 中使用子查询。[#29495](https://github.com/ClickHouse/ClickHouse/pull/29495) ([tavplubix](https://github.com/tavplubix))。
* 在运行时即可应用对 `max_concurrent_queries` 的配置更改（无需重启）。[#29414](https://github.com/ClickHouse/ClickHouse/pull/29414)（[Raúl Marín](https://github.com/Algunenano)）。
* 新增设置 `use_skip_indexes`。 [#29405](https://github.com/ClickHouse/ClickHouse/pull/29405) ([Maksim Kita](https://github.com/kitaisreal)).
* 为内存 part 添加对 `FREEZE` 操作的支持（用于备份）。 [#29376](https://github.com/ClickHouse/ClickHouse/pull/29376) ([Mo Xuan](https://github.com/mo-avatar)).
* 为 `clickhouse-benchmark` 传递初始 query&#95;id（此前，通过 `clickhouse-benchmark` 运行远程查询时，分片上的查询不会通过 `initial_query_id` 关联到初始查询）。[#29364](https://github.com/ClickHouse/ClickHouse/pull/29364) ([Azat Khuzhin](https://github.com/azat)).
* 跳过索引 `tokenbf_v1` 和 `ngrambf_v1`：新增对元素类型为 `String` 或 `FixedString` 的 `Array` 数据类型的支持。[#29280](https://github.com/ClickHouse/ClickHouse/pull/29280)（[Maksim Kita](https://github.com/kitaisreal)）。跳过索引 `tokenbf_v1` 和 `ngrambf_v1`：新增对键类型为 `String` 或 `FixedString` 的 `Map` 数据类型的支持。作者 @lingtaolf。[#29220](https://github.com/ClickHouse/ClickHouse/pull/29220)（[Maksim Kita](https://github.com/kitaisreal)）。
* 函数 `has`：已添加对 `Map` 数据类型的支持。[#29267](https://github.com/ClickHouse/ClickHouse/pull/29267) ([Maksim Kita](https://github.com/kitaisreal))。
* 为 clickhouse-keeper 添加 `compress_logs` 设置，用于使用 `ZSTD` 压缩 clickhouse-keeper 日志（用于复制状态机）。实现：[#26977](https://github.com/ClickHouse/ClickHouse/issues/26977)。[#29223](https://github.com/ClickHouse/ClickHouse/pull/29223)（[alesapin](https://github.com/alesapin)）。
* 新增设置 `external_table_strict_query` —— 即使与外部数据库不兼容，该设置也会强制将查询中的整个 WHERE 表达式传递给外部数据库。[#29206](https://github.com/ClickHouse/ClickHouse/pull/29206) ([Azat Khuzhin](https://github.com/azat))。
* 在使用 `ARRAY JOIN` 时禁用投影。在此前版本中，投影分析可能会破坏 `ARRAY JOIN` 中的别名。[#29139](https://github.com/ClickHouse/ClickHouse/pull/29139) ([Amos Bird](https://github.com/amosbird))。
* 在 `MsgPack` 输入/输出格式中支持更多数据类型。 [#29077](https://github.com/ClickHouse/ClickHouse/pull/29077) ([Kruglov Pavel](https://github.com/Avogar)).
* 允许在 `ORC` 输入/输出格式中读写 `LowCardinality` 列。 [#29062](https://github.com/ClickHouse/ClickHouse/pull/29062) ([Kruglov Pavel](https://github.com/Avogar)).
* 查询 `system.distributed_ddl_queue` 时可能会显示不正确的值，现已修复。[#29061](https://github.com/ClickHouse/ClickHouse/pull/29061) ([tavplubix](https://github.com/tavplubix)).
* 修正了 HTTP 连接中对未知方法的处理行为。解决了 [#29050](https://github.com/ClickHouse/ClickHouse/issues/29050)。[#29057](https://github.com/ClickHouse/ClickHouse/pull/29057)（[Filatenkov Artur](https://github.com/FArthur-cmd)）。
* `clickhouse-keeper`：修复 `clickhouse-keeper-converter` 中的一个 bug，该问题在从 ZooKeeper 日志（非快照）恢复时可能导致部分数据丢失。[#29030](https://github.com/ClickHouse/ClickHouse/pull/29030) ([小路](https://github.com/nicelulu))。修复 `clickhouse-keeper-converter` 中的一个 bug，该问题可能导致 ZooKeeper 日志反序列化错误。[#29071](https://github.com/ClickHouse/ClickHouse/pull/29071) ([小路](https://github.com/nicelulu))。
* 应用 `CREATE ... AS SELECT` 查询中的设置（修复：[#28810](https://github.com/ClickHouse/ClickHouse/issues/28810)）。 [#28962](https://github.com/ClickHouse/ClickHouse/pull/28962) ([Azat Khuzhin](https://github.com/azat)).
* 在执行 ALTER TABLE ... ON CLUSTER ... REPLACE/MOVE PARTITION FROM/TO ... 时遵循默认数据库设置 [#28955](https://github.com/ClickHouse/ClickHouse/pull/28955) ([anneji-dev](https://github.com/anneji-dev)).
* gRPC 协议：允许客户端更改服务端压缩设置。 [#28953](https://github.com/ClickHouse/ClickHouse/pull/28953) ([Vitaly Baranov](https://github.com/vitlibar)).
* 在为异步指标读取温度传感器时跳过 “no data” 异常。此更改解决了 [#28852](https://github.com/ClickHouse/ClickHouse/issues/28852)。[#28882](https://github.com/ClickHouse/ClickHouse/pull/28882)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了一种在极少数情况下可能导致已存在的字典报出 `Dictionary not found` 错误的逻辑竞态问题。[#28853](https://github.com/ClickHouse/ClickHouse/pull/28853) ([tavplubix](https://github.com/tavplubix)).
* 放宽针对 If 组合器的嵌套函数检查（但禁止嵌套相同的组合器）。 [#28828](https://github.com/ClickHouse/ClickHouse/pull/28828) ([Azat Khuzhin](https://github.com/azat)).
* 修复在服务器终止过程中可能发生的未捕获异常。[#28761](https://github.com/ClickHouse/ClickHouse/pull/28761) ([Azat Khuzhin](https://github.com/azat)).
* 禁止清理可能被正在执行且耗时异常的 mutation/merge 使用的 tmp 目录，以避免其被误清理。[#28760](https://github.com/ClickHouse/ClickHouse/pull/28760) ([Azat Khuzhin](https://github.com/azat)).
* 当使用别名时允许启用优化 `optimize_arithmetic_operations_in_aggregate_functions = 1`。 [#28746](https://github.com/ClickHouse/ClickHouse/pull/28746) ([Amos Bird](https://github.com/amosbird))。
* 为 `ReplicatedMergeTree` 实现 `detach_not_byte_identical_parts` 设置，使其在合并/变更后对非字节级完全相同的部件不再删除而是执行分离操作。 [#28708](https://github.com/ClickHouse/ClickHouse/pull/28708) ([Azat Khuzhin](https://github.com/azat)).
* 为 `MergeTree` 实现 `max_suspicious_broken_parts_bytes` 设置（用于限制所有疑似损坏数据分片的总大小，默认值为 `1GiB`）。 [#28707](https://github.com/ClickHouse/ClickHouse/pull/28707) ([Azat Khuzhin](https://github.com/azat)).
* 在 `RabbitMQ` 表设置中启用宏展开。 [#28683](https://github.com/ClickHouse/ClickHouse/pull/28683) ([Vitaly Baranov](https://github.com/vitlibar))。
* 恢复了使用多线程读取 `Log` 引擎表中数据的能力。[#28125](https://github.com/ClickHouse/ClickHouse/pull/28125) ([Vitaly Baranov](https://github.com/vitlibar))。
* 修复 JSON 函数中对 NULL 列处理的不当行为。此修复解决了 [#27930](https://github.com/ClickHouse/ClickHouse/issues/27930)。[#28012](https://github.com/ClickHouse/ClickHouse/pull/28012)（[Amos Bird](https://github.com/amosbird)）。
* 允许单独为跳过索引设置 Mark/未压缩缓存的大小，而不是与列共用。 [#27961](https://github.com/ClickHouse/ClickHouse/pull/27961) ([Amos Bird](https://github.com/amosbird)).
* 允许将带有 `USING` 的 JOIN 与其他 JOIN 类型混合使用。[#23881](https://github.com/ClickHouse/ClickHouse/pull/23881) ([darkkeks](https://github.com/darkkeks))。
* 为支持 Yandex Cloud S3 的限流，更新 aws-sdk 子模块。[#30646](https://github.com/ClickHouse/ClickHouse/pull/30646) ([ianton-ru](https://github.com/ianton-ru))。
* 修复在处理 gRPC 调用时于查询处理结束后释放 query ID 和 session ID 的问题。[#29954](https://github.com/ClickHouse/ClickHouse/pull/29954) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复 `AccessControlManager` 的关闭逻辑，以解决测试不稳定的问题。 [#29951](https://github.com/ClickHouse/ClickHouse/pull/29951) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复从 `HDFS` 读取时出现的断言失败。更新 libhdfs3 库，使其能够在调试模式下运行测试。修复 [#29251](https://github.com/ClickHouse/ClickHouse/issues/29251)。修复 [#27814](https://github.com/ClickHouse/ClickHouse/issues/27814)。[#29276](https://github.com/ClickHouse/ClickHouse/pull/29276)（[Kseniia Sumarokova](https://github.com/kssenii)）。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-1}

- 添加对 Aarch64 架构 FreeBSD 构建的支持。[#29952](https://github.com/ClickHouse/ClickHouse/pull/29952) ([MikaelUrankar](https://github.com/MikaelUrankar))。
- ClickHouse 不再需要递归子模块。[#30315](https://github.com/ClickHouse/ClickHouse/pull/30315) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- ClickHouse 可以使用 Musl 进行静态构建。此功能作为实验性添加,不支持构建 `odbc-bridge`、`library-bridge`、与 CatBoost 的集成以及部分库。[#30248](https://github.com/ClickHouse/ClickHouse/pull/30248) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 为 `AArch64` 和 `Darwin` (macOS) 构建启用 `Protobuf`、`Arrow`、`ORC`、`Parquet`。此更改解决了 [#29248](https://github.com/ClickHouse/ClickHouse/issues/29248)。此更改解决了 [#28018](https://github.com/ClickHouse/ClickHouse/issues/28018)。[#30015](https://github.com/ClickHouse/ClickHouse/pull/30015) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 添加 PowerPC (powerpc64le) 的交叉编译支持。此更改解决了 [#9589](https://github.com/ClickHouse/ClickHouse/issues/9589)。为 AArch64 和 PowerPC 启用与 MySQL 交互的支持。此更改解决了 [#26301](https://github.com/ClickHouse/ClickHouse/issues/26301)。[#30010](https://github.com/ClickHouse/ClickHouse/pull/30010) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 在交叉编译工具链中仅保留必需的文件。将它们作为子模块包含(之前以 tarball 形式下载)。[#29974](https://github.com/ClickHouse/ClickHouse/pull/29974) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 在 ClickHouse 中为 select 语句解析器实现了结构感知的模糊测试方法。[#30012](https://github.com/ClickHouse/ClickHouse/pull/30012) ([Paul](https://github.com/PaulCher))。
- 为 clang 启用实验性 constexpr 表达式求值器以加速模板代码编译。[#29668](https://github.com/ClickHouse/ClickHouse/pull/29668) ([myrrc](https://github.com/myrrc))。
- 添加使用较新版本 glibc 进行编译而不使用新符号的功能。[#29594](https://github.com/ClickHouse/ClickHouse/pull/29594) ([Azat Khuzhin](https://github.com/azat))。
- 通过 clang 优化选项减小 Debug 构建的二进制文件大小。[#28736](https://github.com/ClickHouse/ClickHouse/pull/28736) ([flynn](https://github.com/ucasfl))。
- 现在所有 CI 镜像将放置在单独的 dockerhub 仓库中。[#28656](https://github.com/ClickHouse/ClickHouse/pull/28656) ([alesapin](https://github.com/alesapin))。
- 改进对使用 clang-13 构建的支持。[#28046](https://github.com/ClickHouse/ClickHouse/pull/28046) ([Sergei Semin](https://github.com/syominsergey))。
- 添加向 `clickhouse-client` 打印原始性能事件的功能(这对调试和测试很有用)。[#30064](https://github.com/ClickHouse/ClickHouse/pull/30064) ([Azat Khuzhin](https://github.com/azat))。
- 为 clickhouse-server 单元添加时间依赖(systemd 和 sysvinit init)。[#28891](https://github.com/ClickHouse/ClickHouse/pull/28891) ([Azat Khuzhin](https://github.com/azat))。
- 当符号重新加载时重新加载堆栈跟踪缓存。[#28137](https://github.com/ClickHouse/ClickHouse/pull/28137) ([Amos Bird](https://github.com/amosbird))。

#### 错误修复 {#bug-fix}


* 用于在 UTF-8 字符串中进行不区分大小写搜索的函数（如 `positionCaseInsensitiveUTF8` 和 `countSubstringsCaseInsensitiveUTF8`）在极少数情况下可能会错误地匹配实际上并不相符的子字符串，此问题已修复。 [#30663](https://github.com/ClickHouse/ClickHouse/pull/30663) ([tavplubix](https://github.com/tavplubix)).
* 修复在加密磁盘上读取空文件的问题。 [#30494](https://github.com/ClickHouse/ClickHouse/pull/30494) ([Vitaly Baranov](https://github.com/vitlibar)).
* 在分布式查询中，当设置 `legacy_column_name_of_tuple_literal = 0` 时，修复将析取链转换为 `IN` 的优化行为（由设置 `optimize_min_equality_disjunction_chain_length` 控制）。 [#28658](https://github.com/ClickHouse/ClickHouse/pull/28658) ([Anton Popov](https://github.com/CurtizJ)).
* 即使 `insert_allow_materialized_columns=0`，也允许在分布式表中使用物化列作为分片键。 [#28637](https://github.com/ClickHouse/ClickHouse/pull/28637) ([Vitaly Baranov](https://github.com/vitlibar))。
* 修复在结果集为空且同时设置 `FROM` 和 `TO` 时的 `ORDER BY ... WITH FILL`。 [#30888](https://github.com/ClickHouse/ClickHouse/pull/30888) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在具有两个以上操作数的 AND/OR 表达式中未使用 set 索引的问题。此修复解决了 [#30416](https://github.com/ClickHouse/ClickHouse/issues/30416)。[#30887](https://github.com/ClickHouse/ClickHouse/pull/30887)（[Amos Bird](https://github.com/amosbird)）。
* 修复在带有哈希函数的 projection 物化时发生的崩溃问题。此修复解决了 [#30861](https://github.com/ClickHouse/ClickHouse/issues/30861)。该问题类似于 [https://github.com/ClickHouse/ClickHouse/pull/28560](https://github.com/ClickHouse/ClickHouse/pull/28560)，根本原因同样是对 header 为空这一不变量缺乏正确理解。[#30877](https://github.com/ClickHouse/ClickHouse/pull/30877)（[Amos Bird](https://github.com/amosbird)）。
* 修复了在 `ReplicatedMergeTree` 中从 ZooKeeper 路径提取辅助 ZooKeeper 名称时存在的歧义问题。之前，如果 ZooKeeper 路径中包含冒号，服务器在启动时可能会失败并报错 `Unknown auxiliary ZooKeeper name`。修复了 [#29052](https://github.com/ClickHouse/ClickHouse/issues/29052)。此外，此前允许指定不以斜杠开头的 ZooKeeper 路径，但该用法现已被弃用，并且不再允许使用此类路径创建新表。辅助 ZooKeeper 名称中同样不允许包含斜杠和冒号。[#30822](https://github.com/ClickHouse/ClickHouse/pull/30822) ([tavplubix](https://github.com/tavplubix))。
* 当 localBackup 因某种原因失败时，清理临时目录。[#30797](https://github.com/ClickHouse/ClickHouse/pull/30797) ([ianton-ru](https://github.com/ianton-ru)).
* 修复了在非复制 `MergeTree` 中 `REPLACE/MOVE PARTITION` 与后台合并之间的竞态条件，该问题可能导致已移动/已替换的数据部分仍然遗留在分区中。修复了 [#29327](https://github.com/ClickHouse/ClickHouse/issues/29327)。[#30717](https://github.com/ClickHouse/ClickHouse/pull/30717)（[tavplubix](https://github.com/tavplubix)）。
* 在 `PREWHERE` 条件恒为真时，改为使用 `WHERE`。 [#30668](https://github.com/ClickHouse/ClickHouse/pull/30668) ([Azat Khuzhin](https://github.com/azat)).
* Limit 下推优化可能会导致 `Cannot find column` 错误。修复了 [#30438](https://github.com/ClickHouse/ClickHouse/issues/30438)。[#30562](https://github.com/ClickHouse/ClickHouse/pull/30562)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 在将 `isNotNull`/`isNull` 重写为 `IS [NOT] NULL` 时添加缺失的括号（修复包含 `isNotNull(1)+isNotNull(2)` 之类表达式的查询）。 [#30520](https://github.com/ClickHouse/ClickHouse/pull/30520) ([Azat Khuzhin](https://github.com/azat)).
* 修复在执行针对同一张表且带标量子查询的 ALTER 时出现的死锁问题，关闭 [#30461](https://github.com/ClickHouse/ClickHouse/issues/30461)。[#30492](https://github.com/ClickHouse/ClickHouse/pull/30492)（[Vladimir C](https://github.com/vdimir)）。
* 修复了在执行 REPLACE PARTITION 期间，由于会话过期可能出现的段错误。 [#30432](https://github.com/ClickHouse/ClickHouse/pull/30432) ([tavplubix](https://github.com/tavplubix)).
* 在应用聚合投影时，带有 `IN (subquery)` 条件的查询可能会返回不正确的结果。已修复用于投影的集合创建逻辑。 [#30310](https://github.com/ClickHouse/ClickHouse/pull/30310) ([Amos Bird](https://github.com/amosbird))。
* 在启用 projection 时修复 `JOIN` 查询的列别名解析。修复了 [#30146](https://github.com/ClickHouse/ClickHouse/issues/30146)。[#30293](https://github.com/ClickHouse/ClickHouse/pull/30293)（[Amos Bird](https://github.com/amosbird)）。
* 修复 `replaceRegexpAll` 函数中的一些问题。[#30292](https://github.com/ClickHouse/ClickHouse/pull/30292) ([Memo](https://github.com/Joeywzr))。
* 修复 ComplexKeyHashedDictionary 和 ComplexKeySparseHashedDictionary 在从布局配置解析 `preallocate` 选项时的问题。[#30246](https://github.com/ClickHouse/ClickHouse/pull/30246) ([Maksim Kita](https://github.com/kitaisreal)).
* 修复 `[I]LIKE` 函数。解决 [#28661](https://github.com/ClickHouse/ClickHouse/issues/28661) 中的问题。[#30244](https://github.com/ClickHouse/ClickHouse/pull/30244)（[Nikolay Degterinsky](https://github.com/evillique)）。
* 修复在 `multiIf` 中同时使用 `shortcircuit` 和 `LowCardinality` 时引发的崩溃问题。[#30243](https://github.com/ClickHouse/ClickHouse/pull/30243) ([Raúl Marín](https://github.com/Algunenano)).
* 修复 `FlatDictionary` 和 `HashedDictionary` 针对可空属性的 `bytes_allocated` 计算。[#30238](https://github.com/ClickHouse/ClickHouse/pull/30238) ([Maksim Kita](https://github.com/kitaisreal))。
* 在多个 `JOIN` 中允许使用以数字开头的标识符。[#30230](https://github.com/ClickHouse/ClickHouse/pull/30230) ([Vladimir C](https://github.com/vdimir))。
* 修复在 `MergeTree` 中使用 `max_read_buffer_size = 0` 进行读取的问题（当用户将其设置为 0、等于“自找麻烦”时），该问题可能导致抛出 `Can't adjust last granule`、`LOGICAL_ERROR` 等异常，甚至造成数据丢失。[#30192](https://github.com/ClickHouse/ClickHouse/pull/30192) ([Azat Khuzhin](https://github.com/azat)).
* 修复在使用 `min_bytes_to_use_direct_io` 时的 `pread_fake_async`/`pread_threadpool` 问题。[#30191](https://github.com/ClickHouse/ClickHouse/pull/30191) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在通过 `INSERT SELECT` 语句从 `Nullable` 列填充 `MATERIALIZED` 列时填充不正确的问题。 [#30189](https://github.com/ClickHouse/ClickHouse/pull/30189) ([Azat Khuzhin](https://github.com/azat)).
* 在函数 `initializeAggregation` 中支持可为 NULL 的参数。 [#30177](https://github.com/ClickHouse/ClickHouse/pull/30177) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在包含 `GLOBAL IN` 和 `WITH TOTALS` 的查询中出现的 `Port is already connected` 错误。仅限 21.9 和 21.10 版本。[#30086](https://github.com/ClickHouse/ClickHouse/pull/30086) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复 MergeTree 中 MOVE PARTITION 与合并/变更操作之间的竞态条件。[#30074](https://github.com/ClickHouse/ClickHouse/pull/30074) ([Azat Khuzhin](https://github.com/azat)).
* 已修复在服务器重启后已删除的 `Memory` 数据库可能再次出现的问题（[#29795](https://github.com/ClickHouse/ClickHouse/issues/29795)）。同时新增了 `force_remove_data_recursively_on_drop` 设置，作为在删除 `Ordinary` 数据库时出现 `Directory not empty` 错误的变通方案（因为在云环境中无法手动删除残留数据）。[#30054](https://github.com/ClickHouse/ClickHouse/pull/30054)（[tavplubix](https://github.com/tavplubix)）。
* 修复由 `tuple()` 引起的示例代码崩溃，关闭 [#30004](https://github.com/ClickHouse/ClickHouse/issues/30004)。[#30016](https://github.com/ClickHouse/ClickHouse/pull/30016)（[flynn](https://github.com/ucasfl)）。
* 尝试关闭 Issue：[#29965](https://github.com/ClickHouse/ClickHouse/issues/29965)。[#29976](https://github.com/ClickHouse/ClickHouse/pull/29976)（[hexiaoting](https://github.com/hexiaoting)）。
* 修复 `FileChecker` 与 `StorageLog`/`StorageStripeLog` 之间潜在的数据竞争问题。 [#29959](https://github.com/ClickHouse/ClickHouse/pull/29959) ([Azat Khuzhin](https://github.com/azat)).
* 修复 `StorageLog` 中 `LogSink::writeMarks()` 与 `LogSource` 之间的数据竞争问题。[#29946](https://github.com/ClickHouse/ClickHouse/pull/29946) ([Azat Khuzhin](https://github.com/azat)).
* 修复在 [https://github.com/ClickHouse/ClickHouse/pull/19544](https://github.com/ClickHouse/ClickHouse/pull/19544) 中引入的 MergeTree 表并发查询限制可能导致的资源泄漏问题。[#29879](https://github.com/ClickHouse/ClickHouse/pull/29879) ([Amos Bird](https://github.com/amosbird))。
* 修复系统表重建检查逻辑（之前无法检测到枚举值的变更）。 [#29857](https://github.com/ClickHouse/ClickHouse/pull/29857) ([Azat Khuzhin](https://github.com/azat)).
* MaterializedMySQL：修复了一个问题，即当与 MySQL 的连接丢失时，只能处理事务的一部分。[#29837](https://github.com/ClickHouse/ClickHouse/pull/29837) ([Håvard Kvålen](https://github.com/havardk))。
* 避免在极其罕见的情况下出现 `Timeout exceeded: elapsed 18446744073.709553 seconds` 错误，推测是由于内核 bug 所致。修复 [#29154](https://github.com/ClickHouse/ClickHouse/issues/29154)。[#29811](https://github.com/ClickHouse/ClickHouse/pull/29811) ([tavplubix](https://github.com/tavplubix))。
* 修复在 `ATTACH TABLE ... FROM 'path'` 查询中，当使用非字符串字面量作为路径时出现的错误类型转换。该问题可能导致读取未初始化的内存。[#29790](https://github.com/ClickHouse/ClickHouse/pull/29790) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复在 `GROUP BY` 过程中对 `LowCardinality` 的并发访问问题（与 `Buffer` 表结合使用时可能会导致问题）。 [#29782](https://github.com/ClickHouse/ClickHouse/pull/29782) ([Azat Khuzhin](https://github.com/azat)).
* 在分布式查询的场景下，如果各分片混合使用 `&lt;= 21.3` 和 `&gt;= 21.4` 版本，且 `GROUP BY` 键由多个固定大小的列组成，并启用了两级聚合（参见 `group_by_two_level_threshold` 和 `group_by_two_level_threshold_bytes`），修复了结果中出现具有相同键的多行这一错误的 `GROUP BY` 行为。修复了 [#29580](https://github.com/ClickHouse/ClickHouse/issues/29580)。[#29735](https://github.com/ClickHouse/ClickHouse/pull/29735)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在服务器重启时设置 `materialized_postgresql_tables_list` 时的错误行为。见 [#28529](https://github.com/ClickHouse/ClickHouse/issues/28529)。[#29686](https://github.com/ClickHouse/ClickHouse/pull/29686)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在进行下推优化后，过滤谓词中的条件可能会丢失。[#29625](https://github.com/ClickHouse/ClickHouse/pull/29625)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在包含别名和短路求值表达式时的 JIT 表达式编译问题。修复 [#29403](https://github.com/ClickHouse/ClickHouse/issues/29403)。[#29574](https://github.com/ClickHouse/ClickHouse/pull/29574)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复在 `DEFAULT` 表达式中使用类似 `x.y.z...` 这种错误表标识符时，`ALTER MODIFY` 查询中极少发生的段错误问题。修复了 [#29184](https://github.com/ClickHouse/ClickHouse/issues/29184)。[#29573](https://github.com/ClickHouse/ClickHouse/pull/29573)（[alesapin](https://github.com/alesapin)）。
* 修复 `GROUP BY WITH TOTALS HAVING` 的空指针解引用错误（当 `HAVING` 中引用的列未被选择时）。[#29553](https://github.com/ClickHouse/ClickHouse/pull/29553)（[Azat Khuzhin](https://github.com/azat)）。
* 避免在对 Join 表引擎的表进行并发读写时发生死锁。 [#29544](https://github.com/ClickHouse/ClickHouse/pull/29544) ([Raúl Marín](https://github.com/Algunenano)).
* 修复 `pathStartsWith` 检查中的 bug，因为在使用 `std::mismatch` 时存在问题：`如果第二个范围比第一个范围短，则其行为是未定义的。`。 [#29531](https://github.com/ClickHouse/ClickHouse/pull/29531) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 在 ODBC bridge 中为 Invalid cursor state 错误添加重试机制。这是一个可重试的错误。关闭了 [#29473](https://github.com/ClickHouse/ClickHouse/issues/29473)。[#29518](https://github.com/ClickHouse/ClickHouse/pull/29518)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在加载 `Lazy` 数据库时出现的表名解析错误。修复了 [#29456](https://github.com/ClickHouse/ClickHouse/issues/29456)。[#29476](https://github.com/ClickHouse/ClickHouse/pull/29476)（[tavplubix](https://github.com/tavplubix)）。
* 修复在下推 `HAVING` 谓词的子查询中可能出现的 `Block structure mismatch` 问题。修复了 [#29010](https://github.com/ClickHouse/ClickHouse/issues/29010)。[#29475](https://github.com/ClickHouse/ClickHouse/pull/29475)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了 `greatest`/`least` 函数中的逻辑错误 `Cannot capture columns`。关闭 [#29334](https://github.com/ClickHouse/ClickHouse/issues/29334)。[#29454](https://github.com/ClickHouse/ClickHouse/pull/29454)（[Kruglov Pavel](https://github.com/Avogar)）。
* RocksDB 表引擎：修复在多次打开数据库时出现的竞争条件（并重新启用了一些在 CI 上能触发该问题的测试）。 [#29393](https://github.com/ClickHouse/ClickHouse/pull/29393) ([Azat Khuzhin](https://github.com/azat))。
* 修复因配置不当导致复制访问存储无法正常关闭的问题。 [#29388](https://github.com/ClickHouse/ClickHouse/pull/29388) ([Kevin Michel](https://github.com/kmichel-aiven)).
* 移除了窗口函数 `nth_value`，因为它不具备内存安全性。修复了 [#29347](https://github.com/ClickHouse/ClickHouse/issues/29347)。[#29348](https://github.com/ClickHouse/ClickHouse/pull/29348)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复投影部分的垂直合并问题，解决了 [#29253](https://github.com/ClickHouse/ClickHouse/issues/29253)。此 PR 还修复了在 [https://github.com/ClickHouse/ClickHouse/pull/25165](https://github.com/ClickHouse/ClickHouse/pull/25165) 中引入的若干投影合并/变更相关问题。[#29337](https://github.com/ClickHouse/ClickHouse/pull/29337)（[Amos Bird](https://github.com/amosbird)）。
* 修复在向 Replicated 数据库添加新副本时 DDL 查询发生挂起的问题。[#29328](https://github.com/ClickHouse/ClickHouse/pull/29328) ([Kevin Michel](https://github.com/kmichel-aiven)).
* 修复连接超时（`send_timeout`/`receive_timeout`）。[#29282](https://github.com/ClickHouse/ClickHouse/pull/29282)（[Azat Khuzhin](https://github.com/azat)）。
* 修复在为 `ReplicatedMergeTree` 重新创建或创建新副本时，当某个表列的默认表达式中使用了不区分大小写的函数时，可能出现的 `Table columns structure in ZooKeeper is different from local table structure` 异常。 [#29266](https://github.com/ClickHouse/ClickHouse/pull/29266) ([Anton Popov](https://github.com/CurtizJ)).
* 向客户端（通过 TCP）发送常规的 `Database doesn't exist error`（`UNKNOWN_DATABASE`），而不是 `Attempt to read after eof`（`ATTEMPT_TO_READ_AFTER_EOF`）。[#29229](https://github.com/ClickHouse/ClickHouse/pull/29229) ([Azat Khuzhin](https://github.com/azat)).
* 修复在使用 Avro 输入格式时向类型为 LowCardinality(Nullable) 的列插入数据会导致的段错误。 [#29132](https://github.com/ClickHouse/ClickHouse/pull/29132) ([Kruglov Pavel](https://github.com/Avogar)).
* 在使用服务器间密钥的情况下，不允许复用之前的凭据（在通过 Buffer/Kafka 向为该集群配置了服务器间密钥的 Distributed 表执行 INSERT 之前，可能会复用此前为该连接设置的用户）。 [#29060](https://github.com/ClickHouse/ClickHouse/pull/29060) ([Azat Khuzhin](https://github.com/azat)).
* 在与字典进行 JOIN 时对 `any_join_distinct_right_table_keys` 进行处理，关闭 [#29007](https://github.com/ClickHouse/ClickHouse/issues/29007)。[#29014](https://github.com/ClickHouse/ClickHouse/pull/29014)（[Vladimir C](https://github.com/vdimir)）。
* 修复在对别名列进行 JOIN 时出现的 &quot;Not found column ... in block&quot; 错误，关闭 [#26980](https://github.com/ClickHouse/ClickHouse/issues/26980)。[#29008](https://github.com/ClickHouse/ClickHouse/pull/29008) ([Vladimir C](https://github.com/vdimir)).
* 修复 `GLOBAL IN` 子查询中使用的线程数量（自从 [#19414](https://github.com/ClickHouse/ClickHouse/issues/19414) 缺陷修复后，该子查询一直仅使用单线程执行）。[#28997](https://github.com/ClickHouse/ClickHouse/pull/28997)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复当 `ORDER BY` 子句包含 `WITH FILL` 时的不当优化。本次修复关闭了 [#28908](https://github.com/ClickHouse/ClickHouse/issues/28908)。本次修复关闭了 [#26049](https://github.com/ClickHouse/ClickHouse/issues/26049)。[#28910](https://github.com/ClickHouse/ClickHouse/pull/28910)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在与常量参数一起使用时，高阶数组函数（`arrayCompact` 出现 `SIGSEGV`，`arrayDifference` / `arrayCumSumNonNegative` 出现 `ILLEGAL_COLUMN`）的问题。 [#28904](https://github.com/ClickHouse/ClickHouse/pull/28904) ([Azat Khuzhin](https://github.com/azat)).
* 修复在 `mutations_sync=2` 时的变更等待问题。[#28889](https://github.com/ClickHouse/ClickHouse/pull/28889) ([Azat Khuzhin](https://github.com/azat)).
* 修复针对外部数据库（例如 MySQL）的查询在 `IN` 中包含多列时的问题（例如 `(k,v) IN ((1, 2))`）。[#28888](https://github.com/ClickHouse/ClickHouse/pull/28888)（[Azat Khuzhin](https://github.com/azat)）。
* 修复在函数短路求值中与 `LowCardinality` 相关的 bug。关闭 [#28884](https://github.com/ClickHouse/ClickHouse/issues/28884)。[#28887](https://github.com/ClickHouse/ClickHouse/pull/28887)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复从紧凑部分读取子列的问题。 [#28873](https://github.com/ClickHouse/ClickHouse/pull/28873) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了 `DROP PART` 与 `REPLACE/MOVE PARTITION` 之间的竞争条件，该问题在极少数情况下可能导致副本状态不一致。 [#28864](https://github.com/ClickHouse/ClickHouse/pull/28864) ([tavplubix](https://github.com/tavplubix)).
* 修复带短路求值的表达式编译问题。 [#28821](https://github.com/ClickHouse/ClickHouse/pull/28821) ([Azat Khuzhin](https://github.com/azat)).
* 修复一个极其罕见的情况：在所有副本发生硬重启后，`ReplicatedMergeTree` 副本可能发生分歧。错误表现为 `Part ... intersects (previous|next) part ...`。 [#28817](https://github.com/ClickHouse/ClickHouse/pull/28817) ([alesapin](https://github.com/alesapin))。
* 最好检查连接的可用性，并在 `RabbitMQ` 关闭时同时捕获所有异常，以防万一。[#28797](https://github.com/ClickHouse/ClickHouse/pull/28797) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 修复 `ReplicatedMergeTreeQueue` 中一个表面上无害的竞态条件。对用户本不应可见，但可能导致一些隐蔽的错误。 [#28734](https://github.com/ClickHouse/ClickHouse/pull/28734) ([alesapin](https://github.com/alesapin)).
* 在存在仅部分创建的聚合投影且出现异常的情况下，修复执行 `SELECT` 时可能发生的崩溃问题。[#28700](https://github.com/ClickHouse/ClickHouse/pull/28700) ([Amos Bird](https://github.com/amosbird))。
* 修复在创建分布式表时由于传入参数错误导致的核心转储问题。 [#28686](https://github.com/ClickHouse/ClickHouse/pull/28686) ([Zhiyong Wang](https://github.com/ljcui))。
* 为 system.processes 表添加 Settings.Names 和 Settings.Values 列别名。 [#28685](https://github.com/ClickHouse/ClickHouse/pull/28685) ([Vitaly](https://github.com/orloffv))。
* 对 S2 Geometry 库的支持：修正 `s2RectAdd` 和 `s2RectContains` 函数的参数个数要求。[#28663](https://github.com/ClickHouse/ClickHouse/pull/28663)（[Bharat Nallan](https://github.com/bharatnc)）。
* 修复在使用 Nullable 或 LowCardinality 主键时发生的无效常量类型转换。 [#28636](https://github.com/ClickHouse/ClickHouse/pull/28636) ([Amos Bird](https://github.com/amosbird)).
* 通过使用 PREWHERE 修复 &quot;Column is not under aggregate function and not in GROUP BY&quot;（修复：[#28461](https://github.com/ClickHouse/ClickHouse/issues/28461)）。 [#28502](https://github.com/ClickHouse/ClickHouse/pull/28502)（[Azat Khuzhin](https://github.com/azat)）。

### ClickHouse 版本 v21.10, 2021-10-16 {#clickhouse-release-v2110-2021-10-16}

#### 不兼容变更 {#backward-incompatible-change-2}

- 现在以下 MergeTree 表级设置:`replicated_max_parallel_sends`、`replicated_max_parallel_sends_for_table`、`replicated_max_parallel_fetches`、`replicated_max_parallel_fetches_for_table` 已不再生效。这些设置从未正常工作,现已被 `max_replicated_fetches_network_bandwidth`、`max_replicated_sends_network_bandwidth` 和 `background_fetches_pool_size` 替代。[#28404](https://github.com/ClickHouse/ClickHouse/pull/28404) ([alesapin](https://github.com/alesapin))。

#### 新功能 {#new-feature-2}


- 新增将用户自定义函数 (UDF) 创建为 lambda 表达式的功能。语法为 `CREATE FUNCTION {function_name} as ({parameters}) -> {function core}`。示例:`CREATE FUNCTION plus_one as (a) -> a + 1`。作者 @Realist007。[#27796](https://github.com/ClickHouse/ClickHouse/pull/27796) ([Maksim Kita](https://github.com/kitaisreal)) [#23978](https://github.com/ClickHouse/ClickHouse/pull/23978) ([Realist007](https://github.com/Realist007))。
- 新增 `Executable` 存储引擎和 `executable` 表函数。支持以流式方式使用外部脚本处理数据。[#28102](https://github.com/ClickHouse/ClickHouse/pull/28102) ([Maksim Kita](https://github.com/kitaisreal)) ([ruct](https://github.com/ruct))。
- 新增 `ExecutablePool` 存储引擎。与 `Executable` 类似,但使用长期运行的进程池。[#28518](https://github.com/ClickHouse/ClickHouse/pull/28518) ([Maksim Kita](https://github.com/kitaisreal))。
- 新增 `ALTER TABLE ... MATERIALIZE COLUMN` 查询。[#27038](https://github.com/ClickHouse/ClickHouse/pull/27038) ([Vladimir Chebotarev](https://github.com/excitoon))。
- 支持对 `s3` 表函数进行分区写入。[#23051](https://github.com/ClickHouse/ClickHouse/pull/23051) ([Vladimir Chebotarev](https://github.com/excitoon))。
- 支持 `lz4` 压缩格式(除 `gz`、`bz2`、`xz`、`zstd` 外)用于数据导入/导出。[#25310](https://github.com/ClickHouse/ClickHouse/pull/25310) ([Bharat Nallan](https://github.com/bharatnc))。
- 在 `enable_positional_arguments` 设置下允许使用位置参数。关闭 [#2592](https://github.com/ClickHouse/ClickHouse/issues/2592)。[#27530](https://github.com/ClickHouse/ClickHouse/pull/27530) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 在 s3 表的 `CREATE` 查询中,支持在 `SETTINGS` 子句中接受与文件格式相关的用户设置。关闭 [#27580](https://github.com/ClickHouse/ClickHouse/issues/27580)。[#28037](https://github.com/ClickHouse/ClickHouse/pull/28037) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 允许 `RabbitMQ` 引擎使用 SSL 连接。[#28365](https://github.com/ClickHouse/ClickHouse/pull/28365) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 新增 `getServerPort` 函数用于获取服务器端口。当服务器未使用该端口时,抛出异常。[#27900](https://github.com/ClickHouse/ClickHouse/pull/27900) ([Amos Bird](https://github.com/amosbird))。
- 新增 "snowflake id" 与 `DateTime`、`DateTime64` 之间的转换函数。参见 [#27058](https://github.com/ClickHouse/ClickHouse/issues/27058)。[#27704](https://github.com/ClickHouse/ClickHouse/pull/27704) ([jasine](https://github.com/jasine))。
- 新增函数 `SHA512`。[#27830](https://github.com/ClickHouse/ClickHouse/pull/27830) ([zhanglistar](https://github.com/zhanglistar))。
- 新增 `log_queries_probability` 设置,允许用户仅将查询样本写入 query_log。关闭 [#16609](https://github.com/ClickHouse/ClickHouse/issues/16609)。[#27527](https://github.com/ClickHouse/ClickHouse/pull/27527) ([Nikolay Degterinsky](https://github.com/evillique))。

#### 实验性功能 {#experimental-feature-2}


- `web` 类型磁盘,用于在 Web 服务器上以静态文件形式存储只读表。参见 [#23982](https://github.com/ClickHouse/ClickHouse/issues/23982)。[#25251](https://github.com/ClickHouse/ClickHouse/pull/25251) ([Kseniia Sumarokova](https://github.com/kssenii))。此功能主要用于便于在共享存储上进行操作测试以及轻松导入数据集。不建议在 21.11 版本之前使用。
- 新增 `BACKUP` 和 `RESTORE` 命令。[#21945](https://github.com/ClickHouse/ClickHouse/pull/21945) ([Vitaly Baranov](https://github.com/vitlibar))。此功能正在开发中,不建议在当前版本中使用。

#### 性能改进 {#performance-improvement-2}

- 加速 `sumIf` 和 `countIf` 聚合函数。[#28272](https://github.com/ClickHouse/ClickHouse/pull/28272) ([Raúl Marín](https://github.com/Algunenano))。
- 为 `minmax` 索引创建虚拟投影。现在,当启用 `allow_experimental_projection_optimization` 时,查询将在可能的情况下使用 minmax 索引而非读取数据。[#26286](https://github.com/ClickHouse/ClickHouse/pull/26286) ([Amos Bird](https://github.com/amosbird))。
- 在 `sequenceMatch` 和 `sequenceCount` 中引入两项检查,当事件列表中缺少序列模式的某些确定性部分时允许提前退出。此更改使许多以前因达到操作上限而失败的查询得以执行,并且通常会加速处理流程。[#27729](https://github.com/ClickHouse/ClickHouse/pull/27729) ([Jakub Kuklis](https://github.com/jkuklis))。
- 利用二元函数的单调性信息增强主键分析,特别是非零常量除法。[#28302](https://github.com/ClickHouse/ClickHouse/pull/28302) ([Amos Bird](https://github.com/amosbird))。
- 使 `hasAll` 过滤条件能够利用布隆过滤器数据跳过索引。[#27984](https://github.com/ClickHouse/ClickHouse/pull/27984) ([Braulio Valdivielso Martínez](https://github.com/BraulioVM))。
- 通过延迟表启动过程加速数据部分加载。[#28313](https://github.com/ClickHouse/ClickHouse/pull/28313) ([Amos Bird](https://github.com/amosbird))。
- 修复了从 `WHERE` 移动到 `PREWHERE` 的条件数量可能过多的问题(该优化由 `optimize_move_to_prewhere` 设置控制)。[#28139](https://github.com/ClickHouse/ClickHouse/pull/28139) ([lthaooo](https://github.com/lthaooo))。
- 默认启用 `optimize_distributed_group_by_sharding_key`。[#28105](https://github.com/ClickHouse/ClickHouse/pull/28105) ([Azat Khuzhin](https://github.com/azat))。

#### 改进 {#improvement-2}


* 在创建 `Distributed` 表之前检查集群名称，不允许使用错误的集群名称创建表。修复了 [#27832](https://github.com/ClickHouse/ClickHouse/issues/27832)。[#27927](https://github.com/ClickHouse/ClickHouse/pull/27927)（[tavplubix](https://github.com/tavplubix)）。
* 添加聚合函数 `quantileBFloat16Weighted`，其方式与其他 quantile...Weighted 函数类似，从而关闭了 issue [#27745](https://github.com/ClickHouse/ClickHouse/issues/27745)。[#27758](https://github.com/ClickHouse/ClickHouse/pull/27758)（[Ivan Novitskiy](https://github.com/RedClusive)）。
* 支持创建属性列表为空的字典。 [#27905](https://github.com/ClickHouse/ClickHouse/pull/27905) ([Maksim Kita](https://github.com/kitaisreal)).
* 在 `clickhouse-client` 中添加了关于如何重置密码的交互式文档。在用户安装 ClickHouse、设置密码后立刻就忘记密码的情况下，这非常有用。参见 [#27750](https://github.com/ClickHouse/ClickHouse/issues/27750)。[#27903](https://github.com/ClickHouse/ClickHouse/pull/27903)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 `JSONAsString` 输入格式中支持数据被包含在数组中的情况。修复 [#25517](https://github.com/ClickHouse/ClickHouse/issues/25517)。[#25633](https://github.com/ClickHouse/ClickHouse/pull/25633)（[Kruglov Pavel](https://github.com/Avogar)）。
* 向 `system.replicas` 表新增列 `last_queue_update_exception`。 [#26843](https://github.com/ClickHouse/ClickHouse/pull/26843) ([nvartolomei](https://github.com/nvartolomei))。
* 在故障转移时支持 `MaterializedPostgreSQL` 表重新连接。关闭 [#28529](https://github.com/ClickHouse/ClickHouse/issues/28529)。[#28614](https://github.com/ClickHouse/ClickHouse/pull/28614)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在服务器首次启动时生成唯一的服务器 UUID。 [#20089](https://github.com/ClickHouse/ClickHouse/pull/20089) ([Bharat Nallan](https://github.com/bharatnc)).
* 为 `MySQL` 引擎引入 `connection_wait_timeout` 设置（默认 5 秒，0 表示不等待）。 [#28474](https://github.com/ClickHouse/ClickHouse/pull/28474) ([Azat Khuzhin](https://github.com/azat)).
* 不允许使用不正确的参数创建 `MaterializedPostgreSQL`。关闭 [#28423](https://github.com/ClickHouse/ClickHouse/issues/28423)。[#28430](https://github.com/ClickHouse/ClickHouse/pull/28430)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 对纵向合并使用实际的 tmp 文件，而不是预定义的名为 &quot;rows&#95;sources&quot; 的文件。这样可以避免在 tmp 磁盘上生成垃圾目录。 [#28299](https://github.com/ClickHouse/ClickHouse/pull/28299) ([Amos Bird](https://github.com/amosbird)).
* 在服务器配置中添加了 `libhdfs3_conf`，而不是在 clickhouse-server.service 中导出环境变量 `LIBHDFS3_CONF`。用于配置与 HDFS 的交互。[#28268](https://github.com/ClickHouse/ClickHouse/pull/28268) ([Zhichang Yu](https://github.com/yuzhichang)).
* 修复删除处于 Temporary 状态的 part 时可能导致的意外异常（`Part %name% doesn't exist`）。修复 [#23661](https://github.com/ClickHouse/ClickHouse/issues/23661)。[#28221](https://github.com/ClickHouse/ClickHouse/pull/28221) [#28221](https://github.com/ClickHouse/ClickHouse/issues/28221))（[Azat Khuzhin](https://github.com/azat)）。
* 修复 `zookeeper_log.address`（在此 PR 的第一个补丁之前，该地址始终为 `::`），并减少该列对 `getpeername(2)` 的调用次数（由于每次为 `zookeeper_log` 添加条目时都会调用 `getpeername()`，因此在 ZooKeeper 客户端中缓存此地址以避免重复调用）。 [#28212](https://github.com/ClickHouse/ClickHouse/pull/28212) ([Azat Khuzhin](https://github.com/azat)).
* 支持在 `[]` 运算符的索引与 `Map` 类型键之间进行隐式转换（例如不同的 `Int` 类型、`String` 和 `FixedString`）。 [#28096](https://github.com/ClickHouse/ClickHouse/pull/28096) ([Anton Popov](https://github.com/CurtizJ)).
* 在向 PostgreSQL 表引擎或表函数插入数据时支持 `ON CONFLICT` 子句。解决了 [#27727](https://github.com/ClickHouse/ClickHouse/issues/27727) 中的问题。[#28081](https://github.com/ClickHouse/ClickHouse/pull/28081)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 降低对 `Enum` 数据类型的限制，以便能够附加兼容的数据。修复 [#26672](https://github.com/ClickHouse/ClickHouse/issues/26672)。[#28028](https://github.com/ClickHouse/ClickHouse/pull/28028)（[Dmitry Novik](https://github.com/novikd)）。
* 添加一个设置项 `empty_result_for_aggregation_by_constant_keys_on_empty_set`，用于控制在空集合上按常量键进行分组时的行为。此设置用于恢复 [#6842](https://github.com/ClickHouse/ClickHouse/issues/6842) 中的旧行为。[#27932](https://github.com/ClickHouse/ClickHouse/pull/27932)（[Amos Bird](https://github.com/amosbird)）。
* 新增了 `replication_wait_for_inactive_replica_timeout` 设置。它用于指定在等待不活跃副本执行 `ALTER`/`OPTIMZE`/`TRUNCATE` 查询时的最长时间（默认值为 120 秒）。如果 `replication_alter_partitions_sync` 为 2，且某些副本处于不活跃状态的时间超过 `replication_wait_for_inactive_replica_timeout` 秒，则会抛出 `UNFINISHED` 异常。 [#27931](https://github.com/ClickHouse/ClickHouse/pull/27931) ([tavplubix](https://github.com/tavplubix)).
* 为 `APPLY` 列转换器增加对 Lambda 参数的支持，从而可以应用多参数函数。对应问题 [#27877](https://github.com/ClickHouse/ClickHouse/issues/27877)。[#27901](https://github.com/ClickHouse/ClickHouse/pull/27901)（[Amos Bird](https://github.com/amosbird)）。
* 默认启用 `tcp_keep_alive_timeout`。 [#27882](https://github.com/ClickHouse/ClickHouse/pull/27882) ([Azat Khuzhin](https://github.com/azat)).
* 改进远程查询取消功能（在远程服务器异常终止的情况下）。[#27881](https://github.com/ClickHouse/ClickHouse/pull/27881) ([Azat Khuzhin](https://github.com/azat)).
* 对大型 S3 对象使用多部分复制上传（Multipart copy upload）。 [#27858](https://github.com/ClickHouse/ClickHouse/pull/27858) ([ianton-ru](https://github.com/ianton-ru)).
* 允许在库字典路径中跟随符号链接。 [#27815](https://github.com/ClickHouse/ClickHouse/pull/27815) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 现在将 `ALTER MODIFY COLUM` `T` 修改为 `Nullable(T)` 不再需要执行 mutation 变更。 [#27787](https://github.com/ClickHouse/ClickHouse/pull/27787) ([victorgao](https://github.com/kafka1991))。
* 不要在 `ReadBufferFromS3` 中静默地忽略错误，也不要统计延迟。[#27484](https://github.com/ClickHouse/ClickHouse/pull/27484) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 通过仅重新计算元数据，而不执行实际的 TTL 操作来改进 `ALTER ... MATERIALIZE TTL`。[#27019](https://github.com/ClickHouse/ClickHouse/pull/27019) ([lthaooo](https://github.com/lthaooo)).
* 即使在文件末尾（EOF）没有换行符，也允许读取自定义顶级域名列表。 [#28213](https://github.com/ClickHouse/ClickHouse/pull/28213) ([Azat Khuzhin](https://github.com/azat)).

#### 错误修复 {#bug-fix-1}


* 修复了从 `carbon-clickhouse` 读取压缩数据时出现“attempt to read after end of file”（尝试在文件末尾之后读取）错误的问题。关闭了 [#26149](https://github.com/ClickHouse/ClickHouse/issues/26149)。[#28150](https://github.com/ClickHouse/ClickHouse/pull/28150)（[FArthur-cmd](https://github.com/FArthur-cmd)）。
* 修复在执行带有 `ON CLUSTER` 子句的 `GRANT WITH REPLACE` 语句时访问权限检查的逻辑。在修复 [#27001](https://github.com/ClickHouse/ClickHouse/pull/27701) 的基础上进行了改进。[#27983](https://github.com/ClickHouse/ClickHouse/pull/27983)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 允许在查询中对类型为 `LowCardinality(UUID)` 的列使用 `extremes = 1`。 [#27918](https://github.com/ClickHouse/ClickHouse/pull/27918) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复在处理负数时的 PostgreSQL 风格类型转换（`::` 运算符）。[#27876](https://github.com/ClickHouse/ClickHouse/pull/27876)（[Anton Popov](https://github.com/CurtizJ)）。
* 在 [#26864](https://github.com/ClickHouse/ClickHouse/pull/26864) 之后，修复了 `NamedSessionStorage` 的关闭过程：现在会在销毁全局上下文之前，先销毁存储在 `NamedSessionStorage` 中的会话上下文。[#27875](https://github.com/ClickHouse/ClickHouse/pull/27875)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复了 `windowFunnel`「strict」模式中的错误。该修复解决了 [#27469](https://github.com/ClickHouse/ClickHouse/issues/27469)。[#27563](https://github.com/ClickHouse/ClickHouse/pull/27563)（[achimbab](https://github.com/achimbab)）。
* 修复读取被截断的 `bzip2` 压缩包时出现的无限循环问题。[#28543](https://github.com/ClickHouse/ClickHouse/pull/28543) ([Azat Khuzhin](https://github.com/azat))。
* 修复来自 `MaterializedMySQL` 的内部 DDL 在执行 `DROP TABLE` 时出现的 UUID 冲突问题。MaterializedMySQL 是一个实验性特性。[#28533](https://github.com/ClickHouse/ClickHouse/pull/28533) ([Azat Khuzhin](https://github.com/azat))。
* 修复在查询包含 `Nested` 列以及名称中带点且与该 `Nested` 列前缀相同的标量列的表时出现的 `There is no subcolumn` 错误（例如 `n.id UInt32, n.arr1 Array(UInt64), n.arr2 Array(UInt64)`）。 [#28531](https://github.com/ClickHouse/ClickHouse/pull/28531) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了一个在对 `ReplicatedVersionedCollapsingMergeTree` 执行 ALTER 后可能导致报错 `Existing table metadata in ZooKeeper differs in sorting key expression.` 的缺陷。修复了 [#28515](https://github.com/ClickHouse/ClickHouse/issues/28515)。[#28528](https://github.com/ClickHouse/ClickHouse/pull/28528)（[alesapin](https://github.com/alesapin)）。
* 修复了在分布式 DDL 队列后台处理过程中可能出现的 ZooKeeper watch 监听泄漏问题（次要问题）。关闭 [#26036](https://github.com/ClickHouse/ClickHouse/issues/26036)。[#28446](https://github.com/ClickHouse/ClickHouse/pull/28446)（[tavplubix](https://github.com/tavplubix)）。
* 修复 `MaterializedPostgreSQL` 引擎中表名未加引号的问题。关闭 [#28316](https://github.com/ClickHouse/ClickHouse/issues/28316)。[#28433](https://github.com/ClickHouse/ClickHouse/pull/28433)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复 Nullable 列中未被联接的行的错误行为。关闭 [#27691](https://github.com/ClickHouse/ClickHouse/issues/27691)。[#28349](https://github.com/ClickHouse/ClickHouse/pull/28349)（[vdimir](https://github.com/vdimir)）。
* 修复在未使用所有键列时的 NOT IN 索引优化问题。此更改修复了 [#28120](https://github.com/ClickHouse/ClickHouse/issues/28120)。[#28315](https://github.com/ClickHouse/ClickHouse/pull/28315)（[Amos Bird](https://github.com/amosbird)）。
* 修复由于新数据块被替换为空数据块而导致的数据块相交问题。[#28310](https://github.com/ClickHouse/ClickHouse/pull/28310) ([Azat Khuzhin](https://github.com/azat)).
* 修复在启用 `optimize_read_in_order` 设置时，对带有 `ORDER BY` 的查询和 `Merge` 表产生的不一致结果。 [#28266](https://github.com/ClickHouse/ClickHouse/pull/28266) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在包含 `Nullable(LowCardinality)` 类型且将 `extremes` 设置为 1 的查询中可能发生的未初始化内存读取问题。修复 [#28165](https://github.com/ClickHouse/ClickHouse/issues/28165)。[#28205](https://github.com/ClickHouse/ClickHouse/pull/28205)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 针对投影（projections）进行了多项小修复。详细说明请参见该 PR。 [#28178](https://github.com/ClickHouse/ClickHouse/pull/28178) ([Amos Bird](https://github.com/amosbird)).
* 修复由于 context/config 重新加载器关闭顺序不正确而导致在关闭阶段极少数情况下出现的段错误。 [#28088](https://github.com/ClickHouse/ClickHouse/pull/28088) ([nvartolomei](https://github.com/nvartolomei)).
* 修复函数 `JSONExtract` 中处理类型为 `Nullable(String)` 的 NULL 值的问题。此修复解决了 [#27929](https://github.com/ClickHouse/ClickHouse/issues/27929) 和 [#27930](https://github.com/ClickHouse/ClickHouse/issues/27930)。该问题是在 [https://github.com/ClickHouse/ClickHouse/pull/25452](https://github.com/ClickHouse/ClickHouse/pull/25452) 中引入的。[#27939](https://github.com/ClickHouse/ClickHouse/pull/27939)（[Amos Bird](https://github.com/amosbird)）。
* 对新的 `clickhouse-keeper` 工具进行了多项修复。修复了 `clickhouse-keeper` 中一个罕见的错误，该错误会导致客户端在收到请求的响应之前先收到 watch 响应。[#28197](https://github.com/ClickHouse/ClickHouse/pull/28197) ([alesapin](https://github.com/alesapin))。修复了 `clickhouse-keeper` 中在对子节点的 `set` 请求触发子节点列表 watch（`getChildren`）时的不正确行为。[#28190](https://github.com/ClickHouse/ClickHouse/pull/28190) ([alesapin](https://github.com/alesapin))。修复了一个罕见问题，即修改 `clickhouse-keeper` 设置时可能导致日志丢失和服务器挂起。[#28360](https://github.com/ClickHouse/ClickHouse/pull/28360) ([alesapin](https://github.com/alesapin))。修复了 `clickhouse-keeper` 中的一个错误，该错误在减小 `rotate_logs_interval` 时可能导致产生无休止的日志输出。[#28152](https://github.com/ClickHouse/ClickHouse/pull/28152) ([alesapin](https://github.com/alesapin))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-2}

- 在压力测试中启用线程模糊器。线程模糊器是 ClickHouse 的一项功能,可以测试更多线程调度的排列组合,从而发现更多潜在问题。此更改关闭了 [#9813](https://github.com/ClickHouse/ClickHouse/issues/9813)、[#9814](https://github.com/ClickHouse/ClickHouse/issues/9814)、[#9515](https://github.com/ClickHouse/ClickHouse/issues/9515)、[#9516](https://github.com/ClickHouse/ClickHouse/issues/9516)。[#27538](https://github.com/ClickHouse/ClickHouse/pull/27538) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 为测试环境新增日志级别 `test`。该级别比默认的 `trace` 级别输出更详细的信息。[#28559](https://github.com/ClickHouse/ClickHouse/pull/28559) ([alesapin](https://github.com/alesapin))。
- 在 CMake 配置阶段输出 git 状态信息。[#28047](https://github.com/ClickHouse/ClickHouse/pull/28047) ([Braulio Valdivielso Martínez](https://github.com/BraulioVM))。
- 临时将 ubuntu apt 仓库切换至镜像 ru.archive.ubuntu.com,因为默认仓库 (archive.ubuntu.com) 在我们的 CI 环境中无响应。[#28016](https://github.com/ClickHouse/ClickHouse/pull/28016) ([Ilya Yatsishin](https://github.com/qoega))。

### ClickHouse 版本 v21.9, 2021-09-09 {#clickhouse-release-v219-2021-09-09}

#### 向后不兼容变更 {#backward-incompatible-change-3}


- 在 `Decimal` 类型的文本表示中不再输出尾随零。例如:对于精度为 6 的 decimal,将打印 `1.23` 而不是 `1.230000`。这解决了 [#15794](https://github.com/ClickHouse/ClickHouse/issues/15794)。如果您的应用程序依赖于尾随零,这可能会引入轻微的不兼容性。输出格式中的序列化可以通过设置 `output_format_decimal_trailing_zeros` 来控制。`toString` 的实现和转换为 String 的行为已无条件更改。[#27680](https://github.com/ClickHouse/ClickHouse/pull/27680) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 不允许将带有 `-Merge` 组合器的参数化聚合函数应用于由具有不同参数的聚合函数生成的聚合函数状态。例如,`fooState(42)(x)` 的状态不能用 `fooMerge(s)` 或 `fooMerge(123)(s)` 来完成,参数必须像 `fooMerge(42)(s)` 这样显式指定且必须相等。这不影响某些特殊的聚合函数,如 `quantile` 和 `sequence*`,它们仅在最终化阶段使用参数。[#26847](https://github.com/ClickHouse/ClickHouse/pull/26847) ([tavplubix](https://github.com/tavplubix))。
- 在 clickhouse-local 下,始终将带有端口的本地地址视为远程地址。[#26736](https://github.com/ClickHouse/ClickHouse/pull/26736) ([Raúl Marín](https://github.com/Algunenano))。
- 修复了在某些复杂查询中,当列别名与表达式名称相同时可能发生错误类型转换的问题。这修复了 [#25447](https://github.com/ClickHouse/ClickHouse/issues/25447)。这修复了 [#26914](https://github.com/ClickHouse/ClickHouse/issues/26914)。此修复可能会引入向后不兼容性:如果存在具有相同名称的不同表达式,将抛出异常。当设置了 `enable_optimize_predicate_expression` 时,这可能会破坏某些罕见情况。[#26639](https://github.com/ClickHouse/ClickHouse/pull/26639) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 现在,如果标量子查询的类型可以是 `Nullable`,则始终返回 `Nullable` 结果。这是必需的,因为在空子查询的情况下,其结果应该是 `Null`。以前,可能会出现关于不兼容类型的错误(类型推导不执行标量子查询,可能会使用非可空类型)。结果为空且无法转换为 `Nullable` 的标量子查询(如 `Array` 或 `Tuple`)现在会抛出错误。修复了 [#25411](https://github.com/ClickHouse/ClickHouse/issues/25411)。[#26423](https://github.com/ClickHouse/ClickHouse/pull/26423) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 引入了 here document 语法。示例 `SELECT $doc$ VALUE $doc$`。[#26671](https://github.com/ClickHouse/ClickHouse/pull/26671) ([Maksim Kita](https://github.com/kitaisreal))。如果查询中存在包含 `$` 的标识符,此更改将向后不兼容 [#28768](https://github.com/ClickHouse/ClickHouse/issues/28768)。
- 现在索引可以处理 Nullable 类型,包括 `isNull` 和 `isNotNull`。[#12433](https://github.com/ClickHouse/ClickHouse/pull/12433) 和 [#12455](https://github.com/ClickHouse/ClickHouse/pull/12455) ([Amos Bird](https://github.com/amosbird)) 以及 [#27250](https://github.com/ClickHouse/ClickHouse/pull/27250) ([Azat Khuzhin](https://github.com/azat))。但这是通过磁盘格式更改完成的,尽管新服务器可以读取旧数据,但旧服务器无法读取新数据。此外,如果您有 `MINMAX` 数据跳过索引,可能会收到 `Data after mutation/merge is not byte-identical` 错误,因为新索引将具有 `.idx2` 扩展名,而之前是 `.idx`。也就是说,在这种情况下,您不应延迟更新所有现有副本,否则,如果旧副本 (<21.9) 从 21.9+ 的新副本下载数据,它将无法为下载的部分应用索引。

#### 新功能 {#new-feature-3}


* 实现函数短路求值功能，关闭 [#12587](https://github.com/ClickHouse/ClickHouse/issues/12587)。添加设置项 `short_circuit_function_evaluation` 用于配置函数短路求值。 [#23367](https://github.com/ClickHouse/ClickHouse/pull/23367) ([Kruglov Pavel](https://github.com/Avogar))。
* 增加对 INTERSECT、EXCEPT、ANY、ALL 运算符的支持。 [#24757](https://github.com/ClickHouse/ClickHouse/pull/24757) ([Kirill Ershov](https://github.com/zdikov)). ([Kseniia Sumarokova](https://github.com/kssenii)).
* 在虚拟文件系统层面添加对静态数据加密的支持，使用 AES-CTR 算法。[#24206](https://github.com/ClickHouse/ClickHouse/pull/24206) ([Latysheva Alexandra](https://github.com/alexelex))。([Vitaly Baranov](https://github.com/vitlibar)) [#26733](https://github.com/ClickHouse/ClickHouse/pull/26733) [#26377](https://github.com/ClickHouse/ClickHouse/pull/26377) [#26465](https://github.com/ClickHouse/ClickHouse/pull/26465)。
* 在同义词扩展中新增了用于分词、词干提取、词形还原和搜索的自然语言处理（NLP）函数。[#24997](https://github.com/ClickHouse/ClickHouse/pull/24997) ([Nikolay Degterinsky](https://github.com/evillique))。
* 已新增对 S2 Geometry 库的集成。 [#24980](https://github.com/ClickHouse/ClickHouse/pull/24980) ([Andr0901](https://github.com/Andr0901)). ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 新增 SQLite 表引擎、表函数和数据库引擎。 [#24194](https://github.com/ClickHouse/ClickHouse/pull/24194) ([Arslan Gumerov](https://github.com/g-arslan)). ([Kseniia Sumarokova](https://github.com/kssenii)).
* 为 `MySQL`、`PostgreSQL`、`ClickHouse`、`JDBC`、`Cassandra` 字典源新增自定义查询支持。解决了 [#1270](https://github.com/ClickHouse/ClickHouse/issues/1270)。[#26995](https://github.com/ClickHouse/ClickHouse/pull/26995)（[Maksim Kita](https://github.com/kitaisreal)）。
* 通过 ZooKeeper 添加了用户、角色、行策略、配额和设置配置文件的共享（复制）存储。[#27426](https://github.com/ClickHouse/ClickHouse/pull/27426) ([Kevin Michel](https://github.com/kmichel-aiven))。
* 为 `INTO OUTFILE` 添加支持自动选择压缩算法的压缩功能。关闭 [#3473](https://github.com/ClickHouse/ClickHouse/issues/3473)。[#27134](https://github.com/ClickHouse/ClickHouse/pull/27134)（[Filatenkov Artur](https://github.com/FArthur-cmd)）。
* 新增 `INSERT ... FROM INFILE`，用法类似于 `SELECT ... INTO OUTFILE`。 [#27655](https://github.com/ClickHouse/ClickHouse/pull/27655) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* 新增了 `complex_key_range_hashed` 字典。修复了 [#22029](https://github.com/ClickHouse/ClickHouse/issues/22029)。[#27629](https://github.com/ClickHouse/ClickHouse/pull/27629)（[Maksim Kita](https://github.com/kitaisreal)）。
* 在 JOIN 的 ON 子句中支持表达式。关闭 [#21868](https://github.com/ClickHouse/ClickHouse/issues/21868)。[#24420](https://github.com/ClickHouse/ClickHouse/pull/24420)（[Vladimir C](https://github.com/vdimir)）。
* 当客户端连接到服务器时，会收到服务器端已收集的所有警告信息。（可以通过选项 `--no-warnings` 禁用。）新增 `system.warnings` 表，用于收集与服务器配置相关的警告。[#26246](https://github.com/ClickHouse/ClickHouse/pull/26246) ([Filatenkov Artur](https://github.com/FArthur-cmd)). [#26282](https://github.com/ClickHouse/ClickHouse/pull/26282) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* 允许在聚合函数参数中使用来自 `WITH` 和 `SELECT` 子句的常量表达式。关闭 [#10945](https://github.com/ClickHouse/ClickHouse/issues/10945)。[#27531](https://github.com/ClickHouse/ClickHouse/pull/27531)（[abel-cheng](https://github.com/abel-cheng)）。
* 添加 `tupleToNameValuePairs` 函数，用于将具名元组转换为键值对数组。 [#27505](https://github.com/ClickHouse/ClickHouse/pull/27505) ([Braulio Valdivielso Martínez](https://github.com/BraulioVM)).
* 为导入/导出添加对 `bzip2` 压缩格式的支持。修复 [#22428](https://github.com/ClickHouse/ClickHouse/issues/22428)。[#27377](https://github.com/ClickHouse/ClickHouse/pull/27377)（[Nikolay Degterinsky](https://github.com/evillique)）。
* 新增 `bitmapSubsetOffsetLimit(bitmap, offset, cardinality_limit)` 函数。该函数从 bitmap 中创建一个子集，将结果数量限制为 `cardinality_limit`，并使用 `offset` 作为偏移量。[#27234](https://github.com/ClickHouse/ClickHouse/pull/27234) ([DHBin](https://github.com/DHBin))。
* 在 `system.users` 中添加 `default_database` 列。 [#27054](https://github.com/ClickHouse/ClickHouse/pull/27054) ([kevin wan](https://github.com/MaxWk)).
* 支持在表函数 &#39;cluster&#39; 和 &#39;clusterAllReplicas&#39; 中使用 `cluster` 宏。[#26913](https://github.com/ClickHouse/ClickHouse/pull/26913) ([polyprogrammist](https://github.com/PolyProgrammist))。
* 新增了函数 `currentRoles()`, `enabledRoles()`, `defaultRoles()`。[#26780](https://github.com/ClickHouse/ClickHouse/pull/26780) ([Vitaly Baranov](https://github.com/vitlibar))。
* 新增了函数 `currentProfiles()`, `enabledProfiles()`, `defaultProfiles()`. [#26714](https://github.com/ClickHouse/ClickHouse/pull/26714) ([Vitaly Baranov](https://github.com/vitlibar)).
* 添加用于返回当前查询 (initial&#95;)query&#95;id 的函数。此更改修复了 [#23682](https://github.com/ClickHouse/ClickHouse/issues/23682)。[#26410](https://github.com/ClickHouse/ClickHouse/pull/26410)（[Alexey Boykov](https://github.com/mathalex)）。
* 添加对 `REPLACE GRANT` 的支持。 [#26384](https://github.com/ClickHouse/ClickHouse/pull/26384) ([Caspian](https://github.com/Cas-pian)).
* `EXPLAIN` 查询现在新增 `EXPLAIN ESTIMATE ...` 模式，可显示从 MergeTree 表读取的行数、marks 和 parts 等信息。修复了 [#23941](https://github.com/ClickHouse/ClickHouse/issues/23941)。[#26131](https://github.com/ClickHouse/ClickHouse/pull/26131)（[fastio](https://github.com/fastio)）。
* 新增 `system.zookeeper_log` 表。ZooKeeper 客户端的所有操作都会记录到该表中。实现了 [#25449](https://github.com/ClickHouse/ClickHouse/issues/25449)。[#26129](https://github.com/ClickHouse/ClickHouse/pull/26129) ([tavplubix](https://github.com/tavplubix))。
* 在 `HDFS` 存储上为 `ReplicatedMergeTree` 实现零拷贝复制功能。[#25918](https://github.com/ClickHouse/ClickHouse/pull/25918)（[Zhichang Yu](https://github.com/yuzhichang)）。
* 允许在 `Arrow`、`ORC` 和 `Parquet` 输入格式中插入 Nested 类型的结构体数组。 [#25902](https://github.com/ClickHouse/ClickHouse/pull/25902) ([Kruglov Pavel](https://github.com/Avogar)).
* 新增数据类型 `Date32`（以 Int32 存储数据），支持的日期范围与 `DateTime64` 相同，并支持将 Parquet 中的 date32 加载为 ClickHouse 的 `Date32`。新增与 `toDate` 类似的函数 `toDate32`。 [#25774](https://github.com/ClickHouse/ClickHouse/pull/25774) ([LiuNeng](https://github.com/liuneng1994)).
* 支持为用户设置默认数据库。 [#25268](https://github.com/ClickHouse/ClickHouse/issues/25268)。 [#25687](https://github.com/ClickHouse/ClickHouse/pull/25687) ([kevin wan](https://github.com/MaxWk))。
* 为 `MongoDB` 引擎添加一个可选参数，用于接受连接字符串选项并支持 SSL 连接。修复 [#21189](https://github.com/ClickHouse/ClickHouse/issues/21189)。修复 [#21041](https://github.com/ClickHouse/ClickHouse/issues/21041)。[#22045](https://github.com/ClickHouse/ClickHouse/pull/22045)（[Omar Bazaraa](https://github.com/OmarBazaraa)）。

#### 实验性功能 {#experimental-feature-3}

- 新增压缩编解码器 `AES_128_GCM_SIV`,用于加密列而非压缩列。[#19896](https://github.com/ClickHouse/ClickHouse/pull/19896) ([PHO](https://github.com/depressed-pho))。该功能将被重写,请勿使用。
- 将 `MaterializeMySQL` 重命名为 `MaterializedMySQL`。[#26822](https://github.com/ClickHouse/ClickHouse/pull/26822) ([tavplubix](https://github.com/tavplubix))。

#### 性能改进 {#performance-improvement-3}

- 通过减少 `clock_gettime` 系统调用次数,提升 `max_execution_time = 0` 时快速查询的性能。[#27325](https://github.com/ClickHouse/ClickHouse/pull/27325) ([filimonov](https://github.com/filimonov))。
- 针对日期时间相关比较进行专门优化以提升性能。此修复解决了 [#27083](https://github.com/ClickHouse/ClickHouse/issues/27083)。[#27122](https://github.com/ClickHouse/ClickHouse/pull/27122) ([Amos Bird](https://github.com/amosbird))。
- 在并发读取相同文件时共享文件描述符。在 Linux 上性能差异不明显,但在典型服务器上打开的文件数量将显著减少(10 到 100 倍),从而简化运维操作。参见 [#26214](https://github.com/ClickHouse/ClickHouse/issues/26214)。[#26768](https://github.com/ClickHouse/ClickHouse/pull/26768) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 改善需要从大量列的表中读取数据的短查询的延迟。[#26371](https://github.com/ClickHouse/ClickHouse/pull/26371) ([Anton Popov](https://github.com/CurtizJ))。
- 在分析查询时不再为索引构建集合。[#26365](https://github.com/ClickHouse/ClickHouse/pull/26365) ([Raúl Marín](https://github.com/Algunenano))。
- 对具有原生表示的可空整数类型的 SUM 进行向量化 ([David Manzanares](https://github.com/davidmanzanares), [Raúl Marín](https://github.com/Algunenano))。[#26248](https://github.com/ClickHouse/ClickHouse/pull/26248) ([Raúl Marín](https://github.com/Algunenano))。
- 编译涉及 `Enum` 类型列的表达式。[#26237](https://github.com/ClickHouse/ClickHouse/pull/26237) ([Maksim Kita](https://github.com/kitaisreal))。
- 编译聚合函数 `groupBitOr`、`groupBitAnd`、`groupBitXor`。[#26161](https://github.com/ClickHouse/ClickHouse/pull/26161) ([Maksim Kita](https://github.com/kitaisreal))。
- 通过在读取空 DEFAULT 列时更好地预测块大小来改善内存使用。关闭 [#17317](https://github.com/ClickHouse/ClickHouse/issues/17317)。[#25917](https://github.com/ClickHouse/ClickHouse/pull/25917) ([Vladimir Chebotarev](https://github.com/excitoon))。
- 减少带有 `ORDER BY primary_key` 的查询中的内存使用和读取行数。[#25721](https://github.com/ClickHouse/ClickHouse/pull/25721) ([Anton Popov](https://github.com/CurtizJ))。
- 默认启用 `distributed_push_down_limit`。[#27104](https://github.com/ClickHouse/ClickHouse/pull/27104) ([Azat Khuzhin](https://github.com/azat))。
- 当 timeZone 为常量值时使 `toTimeZone` 具有单调性,以支持在使用类似 SQL 时进行分区裁剪。[#26261](https://github.com/ClickHouse/ClickHouse/pull/26261) ([huangzhaowei](https://github.com/SaintBacchus))。

#### 改进 {#improvement-3}


* 将窗口函数标记为已准备好正式使用。移除 `allow_experimental_window_functions` 设置。[#27184](https://github.com/ClickHouse/ClickHouse/pull/27184) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* 改进对非整分时区偏移量的兼容性。 [#27080](https://github.com/ClickHouse/ClickHouse/pull/27080) ([Raúl Marín](https://github.com/Algunenano)).
* 如果 `File` 表中的文件描述符对应的是常规文件，则允许对其进行多次读取。这样，如果 stdin 是一个常规文件，例如 `clickhouse-local --query "SELECT * FROM table UNION ALL SELECT * FROM table" ... < file`，则 `clickhouse-local` 可以多次从标准输入读取（通过多个 SELECT 查询或子查询）。这修复了 [#11124](https://github.com/ClickHouse/ClickHouse/issues/11124)。与 ([alexey-milovidov](https://github.com/alexey-milovidov)) 共同完成。[#25960](https://github.com/ClickHouse/ClickHouse/pull/25960) ([BoloniniD](https://github.com/BoloniniD))。
* 移除重复的索引分析，并在投影分析期间避免可能出现的无效 limit 检查。[#27742](https://github.com/ClickHouse/ClickHouse/pull/27742) ([Amos Bird](https://github.com/amosbird))。
* 允许在 HTTP 请求体中传递查询参数。 [#27706](https://github.com/ClickHouse/ClickHouse/pull/27706) ([Hermano Lustosa](https://github.com/hllustosa)).
* 不允许在分区表达式中使用 `arrayJoin`。 [#27648](https://github.com/ClickHouse/ClickHouse/pull/27648) ([Raúl Marín](https://github.com/Algunenano))。
* 在身份验证失败时记录客户端 IP 地址。 [#27514](https://github.com/ClickHouse/ClickHouse/pull/27514) ([Misko Lee](https://github.com/imiskolee)).
* 在 GRPC 协议中，对二进制数据使用 bytes 类型而非字符串。[#27431](https://github.com/ClickHouse/ClickHouse/pull/27431) ([Vitaly Baranov](https://github.com/vitlibar))。
* 当未设置 HTTP 端口且用户尝试向 TCP 端口发送 HTTP 请求时，返回包含错误消息的响应。 [#27385](https://github.com/ClickHouse/ClickHouse/pull/27385) ([Braulio Valdivielso Martínez](https://github.com/BraulioVM)).
* 为内部使用添加 `_CAST` 函数，该函数不会保留类型的可空性，而非内部的 `CAST` 转换将根据设置 `cast_keep_nullable` 来保留可空性。关闭 [#12636](https://github.com/ClickHouse/ClickHouse/issues/12636)。[#27382](https://github.com/ClickHouse/ClickHouse/pull/27382)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 添加 `log_formatted_queries` 设置，用于将额外的格式化查询记录到 `system.query_log` 中。由于诸如 `normalizeQuery` 和 `normalizeQueryKeepNames` 之类的函数不会对查询进行解析/格式化，以获得更高性能，因此这对于规范化查询分析非常有用。[#27380](https://github.com/ClickHouse/ClickHouse/pull/27380) ([Amos Bird](https://github.com/amosbird))。
* 新增两个设置项 `max_hyperscan_regexp_length` 和 `max_hyperscan_regexp_total_length`，以防止在 Hyperscan 相关函数（如 `multiMatchAny`）中使用过大的正则表达式。[#27378](https://github.com/ClickHouse/ClickHouse/pull/27378) ([Amos Bird](https://github.com/amosbird)).
* 现在，位图聚合函数所消耗的内存也会计入内存限制中。此更改修复了问题 [#26555](https://github.com/ClickHouse/ClickHouse/issues/26555)。[#27252](https://github.com/ClickHouse/ClickHouse/pull/27252)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 S3 代理解析器添加 10 秒的缓存。[#27216](https://github.com/ClickHouse/ClickHouse/pull/27216) ([ianton-ru](https://github.com/ianton-ru)).
* 将用于正则表达式构造的全局互斥锁拆分为多个独立的互斥锁。这有助于避免在构造大型正则表达式时阻塞其他相关线程。 [#27211](https://github.com/ClickHouse/ClickHouse/pull/27211) ([Amos Bird](https://github.com/amosbird)).
* 为 PostgreSQL 数据库引擎添加 schema 支持。关闭 [#27166](https://github.com/ClickHouse/ClickHouse/issues/27166)。[#27198](https://github.com/ClickHouse/ClickHouse/pull/27198)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在 clickhouse-client 中跟踪内存使用。 [#27191](https://github.com/ClickHouse/ClickHouse/pull/27191) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* 即使查询无法启动，也在 `system.query_log` 中记录 `query_kind`。 [#27182](https://github.com/ClickHouse/ClickHouse/pull/27182) ([Amos Bird](https://github.com/amosbird)).
* 在 `system.replicas` 表中新增列 `replica_is_active`，用于将副本名称映射到该副本是否处于活动状态。修复 [#27138](https://github.com/ClickHouse/ClickHouse/issues/27138)。[#27180](https://github.com/ClickHouse/ClickHouse/pull/27180)（[Maksim Kita](https://github.com/kitaisreal)）。
* 允许在 Web UI 中通过服务器 URI 传递查询设置。[#27177](https://github.com/ClickHouse/ClickHouse/pull/27177) ([kolsys](https://github.com/kolsys)).
* 添加了一个名为 `MaxPushedDDLEntryID` 的新指标，表示当前节点推送到 ZooKeeper 的最大 DDL 条目 ID。 [#27174](https://github.com/ClickHouse/ClickHouse/pull/27174) ([Fuwang Hu](https://github.com/fuwhu))。
* 改进了 `clickhouse-keeper` 在创建 znode 时对节点是否存在的判断，以及对空字符串节点的判断。[#27125](https://github.com/ClickHouse/ClickHouse/pull/27125) ([小路](https://github.com/nicelulu))。
* Merge JOIN 现在在右侧为空集合时也能正确处理。[#27078](https://github.com/ClickHouse/ClickHouse/pull/27078) ([Vladimir C](https://github.com/vdimir))。
* 现在，函数可以作为分片级常量使用，这意味着如果在某个分布式表的上下文中执行，它会生成一列普通数据列，否则会返回一个常量值。值得注意的函数包括：`hostName()`, `tcpPort()`, `version()`, `buildId()`, `uptime()` 等。[#27020](https://github.com/ClickHouse/ClickHouse/pull/27020)（[Amos Bird](https://github.com/amosbird)）。
* 更新了 `extractAllGroupsHorizontal`——现在可以通过可选的第三个参数设置每行匹配次数的上限。[#26961](https://github.com/ClickHouse/ClickHouse/pull/26961)（[Vasily Nemkov](https://github.com/Enmk)）。
* 在 `system.rocksdb` 表中公开 `RocksDB` 统计信息。从 ClickHouse 配置中读取 RocksDB 选项（`rocksdb...` 键）。注意：ClickHouse 并不依赖 RocksDB，它只是额外集成的一种存储引擎。[#26821](https://github.com/ClickHouse/ClickHouse/pull/26821) ([Azat Khuzhin](https://github.com/azat))。
* 更简洁的内部 RocksDB 日志。注意：ClickHouse 并不依赖 RocksDB，它只是众多可集成的附加存储引擎之一。关闭了 [#26252](https://github.com/ClickHouse/ClickHouse/issues/26252)。[#26789](https://github.com/ClickHouse/ClickHouse/pull/26789)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 更改默认角色只会影响新的会话。[#26759](https://github.com/ClickHouse/ClickHouse/pull/26759) ([Vitaly Baranov](https://github.com/vitlibar))。
* 在 Docker 中默认禁用 Watchdog。修复了未处理 Ctrl+C 信号的问题。[#26757](https://github.com/ClickHouse/ClickHouse/pull/26757)（[Mikhail f. Shiryaev](https://github.com/Felixoid)）。
* `SET PROFILE` 现在也会应用为传入的 profile 设置的约束。[#26730](https://github.com/ClickHouse/ClickHouse/pull/26730) ([Vitaly Baranov](https://github.com/vitlibar))。
* 改进 `KILL QUERY` 请求的处理方式。[#26675](https://github.com/ClickHouse/ClickHouse/pull/26675) ([Raúl Marín](https://github.com/Algunenano)).
* `mapPopulatesSeries` 函数现已支持 `Map` 类型。[#26663](https://github.com/ClickHouse/ClickHouse/pull/26663)（[Ildus Kurbangaliev](https://github.com/ildus)）。
* 修复在使用 `skip_unavailable_shards` 时连接尝试次数翻倍（x2）的问题。[#26658](https://github.com/ClickHouse/ClickHouse/pull/26658) ([Azat Khuzhin](https://github.com/azat))。
* 在连接失败时（例如出现 EMFILE 错误时），避免 `clickhouse-benchmark` 发生挂起。[#26656](https://github.com/ClickHouse/ClickHouse/pull/26656) ([Azat Khuzhin](https://github.com/azat)).
* 使 Kafka 引擎能够使用更多线程。 [#26642](https://github.com/ClickHouse/ClickHouse/pull/26642) ([feihengye](https://github.com/feihengye)).
* 为 `clickhouse-benchmark` 添加轮询（round-robin）模式支持（除统计报告外，与常规的多主机/端口运行没有区别）。[#26607](https://github.com/ClickHouse/ClickHouse/pull/26607) ([Azat Khuzhin](https://github.com/azat))。
* 可执行字典（`executable`、`executable_pool`）现支持使用 `clickhouse-local` 通过 DDL 查询创建。解决了 [#22355](https://github.com/ClickHouse/ClickHouse/issues/22355) 中的问题。[#26510](https://github.com/ClickHouse/ClickHouse/pull/26510)（[Maksim Kita](https://github.com/kitaisreal)）。
* 设置 `mysql` 和 `postgresql` 兼容协议处理程序的客户端查询类型。[#26498](https://github.com/ClickHouse/ClickHouse/pull/26498) ([anneji-dev](https://github.com/anneji-dev)).
* 在分片上对类似 `SELECT * FROM dist ORDER BY key LIMIT 10` 的查询下推并应用 `LIMIT`，需设置 `distributed_push_down_limit=1`。避免对类似 `SELECT DISTINCT shading_key FROM dist ORDER BY key` 的查询执行 `Distinct`/`LIMIT BY` 阶段。现在，`distributed_push_down_limit` 会被 `optimize_distributed_group_by_sharding_key` 优化所尊重。[#26466](https://github.com/ClickHouse/ClickHouse/pull/26466) ([Azat Khuzhin](https://github.com/azat))。
* 已将 protobuf 更新到 3.17.3。变更日志可在 [https://github.com/protocolbuffers/protobuf/releases](https://github.com/protocolbuffers/protobuf/releases) 中查看。[#26424](https://github.com/ClickHouse/ClickHouse/pull/26424)（[Ilya Yatsishin](https://github.com/qoega)）。
* 启用 `use_hedged_requests` 设置，以缓解大规模集群上的长尾延迟。 [#26380](https://github.com/ClickHouse/ClickHouse/pull/26380) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 改进当用户允许的主机列表中包含不存在的主机时的处理行为。[#26368](https://github.com/ClickHouse/ClickHouse/pull/26368) ([ianton-ru](https://github.com/ianton-ru)).
* 新增支持通过 CREATE TABLE 设置 `Distributed` 目录监控设置（例如 `CREATE TABLE dist (key Int) Engine=Distributed(cluster, db, table) SETTINGS monitor_batch_inserts=1` 等类似语句）。 [#26336](https://github.com/ClickHouse/ClickHouse/pull/26336) ([Azat Khuzhin](https://github.com/azat)).
* 如果服务器地址与 Web UI 所在地址不同，则在 Web UI 的历史 URL 中保存该服务器地址。修复了 [#26044](https://github.com/ClickHouse/ClickHouse/issues/26044)。[#26322](https://github.com/ClickHouse/ClickHouse/pull/26322) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 为 `sleep` / `sleepEachRow` 的性能分析（profiling）调用添加事件。 [#26320](https://github.com/ClickHouse/ClickHouse/pull/26320) ([Raúl Marín](https://github.com/Algunenano)).
* 允许在不同集群之间复用分片连接，从而在使用 `cluster` 表函数时避免创建新连接。[#26318](https://github.com/ClickHouse/ClickHouse/pull/26318) ([Amos Bird](https://github.com/amosbird))。
* 通过带默认值的参数控制清理旧临时目录的执行周期。 [#26212](https://github.com/ClickHouse/ClickHouse/issues/26212). [#26313](https://github.com/ClickHouse/ClickHouse/pull/26313) ([fastio](https://github.com/fastio)).
* 新增设置项 `function_range_max_elements_in_block`，用于调整函数 `range` 所生成数据量的安全阈值。修复了 [#26303](https://github.com/ClickHouse/ClickHouse/issues/26303)。[#26305](https://github.com/ClickHouse/ClickHouse/pull/26305) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 在建表时检查哈希函数，而不是在采样时检查。为 MergeTree 新增相关设置：如果有人使用不正确的采样列创建了表但从未使用采样，可禁用此设置，以便在不抛出异常的情况下启动服务器。[#26256](https://github.com/ClickHouse/ClickHouse/pull/26256) ([zhaoyu](https://github.com/zxc111))。
* 添加了 `output_format_avro_string_column_pattern` 设置，用于将指定的 String 列在 Avro 中以 string 而非默认的 bytes 形式写入。实现了 [#22414](https://github.com/ClickHouse/ClickHouse/issues/22414)。[#26245](https://github.com/ClickHouse/ClickHouse/pull/26245)（[Ilya Golshtein](https://github.com/ilejn)）。
* 在 `system.columns` 表中为 `Log` 和 `TinyLog` 表添加列大小信息。此更改解决了 [#9001](https://github.com/ClickHouse/ClickHouse/issues/9001)。[#26241](https://github.com/ClickHouse/ClickHouse/pull/26241)（[Nikolay Degterinsky](https://github.com/evillique)）。
* 当配置了自定义磁盘且某些磁盘上不存在 `detached` 目录时，查询 `system.detached_parts` 表时不再抛出异常。修复了 [#26078](https://github.com/ClickHouse/ClickHouse/issues/26078)。[#26236](https://github.com/ClickHouse/ClickHouse/pull/26236)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 检查键中是否存在非确定性函数，包括诸如 `now()`, `today()` 之类的常量表达式。此更改修复了 [#25875](https://github.com/ClickHouse/ClickHouse/issues/25875)。此更改修复了 [#11333](https://github.com/ClickHouse/ClickHouse/issues/11333)。[#26235](https://github.com/ClickHouse/ClickHouse/pull/26235) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 在 PostgreSQL 表引擎中将 `timestamp` 和 `timestamptz` 数据类型转换为 `DateTime64`。 [#26234](https://github.com/ClickHouse/ClickHouse/pull/26234) ([jasine](https://github.com/jasine)).
* 对投影应用更激进的 IN 索引分析，以便选择更优的投影候选项。 [#26218](https://github.com/ClickHouse/ClickHouse/pull/26218) ([Amos Bird](https://github.com/amosbird)).
* 当 `IN` 子句中传入标量函数时，移除 `GLOBAL` 关键字。在早期版本中，如果用户指定 `GLOBAL IN f(x)`，则会抛出异常。[#26217](https://github.com/ClickHouse/ClickHouse/pull/26217) ([Amos Bird](https://github.com/amosbird))。
* 在异常信息中添加错误 ID（如 `BAD_ARGUMENTS`）。此更改解决了 [#25862](https://github.com/ClickHouse/ClickHouse/issues/25862)。[#26172](https://github.com/ClickHouse/ClickHouse/pull/26172)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `clickhouse-local` 使用 `--progress` 选项时的错误输出。进度条在达到 100% 后会被清除——与 `clickhouse-client` 的行为保持一致。关闭 [#17484](https://github.com/ClickHouse/ClickHouse/issues/17484)。[#26128](https://github.com/ClickHouse/ClickHouse/pull/26128)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 新增 `merge_selecting_sleep_ms` 设置。 [#26120](https://github.com/ClickHouse/ClickHouse/pull/26120) ([lthaooo](https://github.com/lthaooo)).
* 移除使用单块预读的复杂 Linux AIO，并将其替换为带有 O&#95;DIRECT 的简单同步 IO。在之前的版本中，如果 `max_threads` 大于 1，设置 `min_bytes_to_use_direct_io` 可能无法正常工作。使用 direct IO 进行读取（对查询默认禁用，对大型合并默认启用）将以较低的效率运行。此修改关闭了 [#25997](https://github.com/ClickHouse/ClickHouse/issues/25997)。[#26003](https://github.com/ClickHouse/ClickHouse/pull/26003)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在执行 `REPLACE TABLE` 查询时刷新 `Distributed` 表。修复 [#24566](https://github.com/ClickHouse/ClickHouse/issues/24566) —— 在 `[CREATE OR] REPLACE TABLE ... AS SELECT` 查询中，如果向新表插入数据失败，则不要替换（或创建）该表。修复 [#23175](https://github.com/ClickHouse/ClickHouse/issues/23175)。[#25895](https://github.com/ClickHouse/ClickHouse/pull/25895)（[tavplubix](https://github.com/tavplubix)）。
* 在 `system.query&#95;log` 中添加 `views` 列，用于记录查询执行的（物化或实时）视图名称。新增一个日志表（`system.query_views_log`），其中包含关于查询期间执行的每个视图的信息。修改视图执行行为：当在执行视图时抛出异常时，任何已经开始执行的视图将继续运行直至完成。此前仅在 parallel&#95;view&#95;processing=true 时才是这种行为，现在则始终如此。依赖视图现在会向执行上下文报告读取进度。 [#25714](https://github.com/ClickHouse/ClickHouse/pull/25714) ([Raúl Marín](https://github.com/Algunenano))。
* 在执行完分布式查询后异步进行连接回收。新增了一个服务器设置 `max_threads_for_connection_collector`，用于指定在后台回收连接的工作线程数。如果连接池已满，则连接将以同步方式回收，但行为与之前略有不同：会在向客户端发送 EOS 之后再回收连接；查询在收到足够数据后会立即成功，任何异常都会被记录到日志中，而不是抛给客户端。新增设置 `drain_timeout`（默认 3 秒）。连接回收在超时后将断开连接。 [#25674](https://github.com/ClickHouse/ClickHouse/pull/25674) ([Amos Bird](https://github.com/amosbird))。
* 在配置中支持多个 include。可以从多个来源引入用户配置和远程服务器配置。只需使用带有 `from_zk`、`from_env` 或 `incl` 属性的 `<include />` 元素，即会被替换为相应的内容。[#24404](https://github.com/ClickHouse/ClickHouse/pull/24404) ([nvartolomei](https://github.com/nvartolomei))。
* 修复在 `insert_distributed_one_random_shard = 1` 时向分布式表插入多个数据块的问题。这是一个边缘功能。标记为改进。 [#23140](https://github.com/ClickHouse/ClickHouse/pull/23140) ([Amos Bird](https://github.com/amosbird)).
* 为 `Map` 类型的键/值添加对 `LowCardinality` 和 `FixedString` 的支持。 [#21543](https://github.com/ClickHouse/ClickHouse/pull/21543) ([hexiaoting](https://github.com/hexiaoting)).
* 支持重新加载本地磁盘配置。[#19526](https://github.com/ClickHouse/ClickHouse/pull/19526) ([taiyang-li](https://github.com/taiyang-li))。

#### 错误修复 {#bug-fix-2}


* 修复了几个可能导致副本出现不一致的问题。[#27808](https://github.com/ClickHouse/ClickHouse/pull/27808) ([tavplubix](https://github.com/tavplubix)).
* 修复了 `DROP PART` 中的一个罕见 bug，可能会导致报错 `Unexpected merged part intersects drop range`。[#27807](https://github.com/ClickHouse/ClickHouse/pull/27807) ([alesapin](https://github.com/alesapin)).
* 防止在接收到来自 Kafka 的 NULL（墓碑）消息时某些格式发生崩溃。修复 [#19255](https://github.com/ClickHouse/ClickHouse/issues/19255)。[#27794](https://github.com/ClickHouse/ClickHouse/pull/27794)（[filimonov](https://github.com/filimonov)）。
* 修复了在子查询中使用 `UNION DISTINCT` 时的列过滤问题。关闭 [#27578](https://github.com/ClickHouse/ClickHouse/issues/27578)。[#27689](https://github.com/ClickHouse/ClickHouse/pull/27689)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在将 `arrayHas` 等函数应用于由不同非数值类型（如 `DateTime` 和 `DateTime64`）组成的 LowCardinality(Nullable(...)) 数组时出现的不正确类型转换问题。在之前的版本中会发生错误的类型转换，在新版本中，这种情况将导致抛出异常。此更改关闭了 [#26330](https://github.com/ClickHouse/ClickHouse/issues/26330)。[#27682](https://github.com/ClickHouse/ClickHouse/pull/27682) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复 postgresql 表函数导致连接未被关闭的问题。解决了 [#26088](https://github.com/ClickHouse/ClickHouse/issues/26088)。[#27662](https://github.com/ClickHouse/ClickHouse/pull/27662)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复了另一种会触发 `Unexpected merged part ... intersecting drop range ...` 错误的情况。 [#27656](https://github.com/ClickHouse/ClickHouse/pull/27656) ([tavplubix](https://github.com/tavplubix)).
* 修复 `Distributed` 表中包含别名列时的错误。[#27652](https://github.com/ClickHouse/ClickHouse/pull/27652)（[Vladimir C](https://github.com/vdimir)）。
* 将 `max_memory_usage*` 设置为非零值后，无法将其重置为 0（表示无限制）。此问题已修复。 [#27638](https://github.com/ClickHouse/ClickHouse/pull/27638) ([tavplubix](https://github.com/tavplubix))。
* 修复了在从各个分量构造时间值时可能发生的下溢问题。关闭了 [#27193](https://github.com/ClickHouse/ClickHouse/issues/27193)。[#27605](https://github.com/ClickHouse/ClickHouse/pull/27605)（[Vasily Nemkov](https://github.com/Enmk)）。
* 修复在对投影进行物化时，当某些数据分片缺少列会导致的崩溃。修复了 [#27512](https://github.com/ClickHouse/ClickHouse/issues/27512)。[#27528](https://github.com/ClickHouse/ClickHouse/pull/27528)（[Amos Bird](https://github.com/amosbird)）。
* 修复指标 `BackgroundMessageBrokerSchedulePoolTask`，之前可能存在拼写错误。[#27452](https://github.com/ClickHouse/ClickHouse/pull/27452) ([Ben](https://github.com/benbiti)).
* 修复分片数为零且包含聚合时的分布式查询问题。[#27427](https://github.com/ClickHouse/ClickHouse/pull/27427)（[Azat Khuzhin](https://github.com/azat)）。
* 在 `/proc/meminfo` 不包含 KB 后缀时提供兼容性支持。[#27361](https://github.com/ClickHouse/ClickHouse/pull/27361)（[Mike Kot](https://github.com/myrrc)）。
* 修复使用行级安全、PREWHERE 和 LowCardinality 过滤条件的查询时出现结果错误的问题。修复了 [#27179](https://github.com/ClickHouse/ClickHouse/issues/27179)。[#27329](https://github.com/ClickHouse/ClickHouse/pull/27329)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了使用旧语法创建的 MergeTree 表的分区 ID 校验不正确的问题。[#27328](https://github.com/ClickHouse/ClickHouse/pull/27328) ([tavplubix](https://github.com/tavplubix))。
* 修复在使用并行格式（CSV / TSV）时的 MySQL 协议。 [#27326](https://github.com/ClickHouse/ClickHouse/pull/27326) ([Raúl Marín](https://github.com/Algunenano)).
* 修复在使用采样的查询中出现的 `Cannot find column` 错误。该问题在 [#24574](https://github.com/ClickHouse/ClickHouse/issues/24574) 中引入。本修复解决了 [#26522](https://github.com/ClickHouse/ClickHouse/issues/26522)。[#27301](https://github.com/ClickHouse/ClickHouse/pull/27301)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了某些在 `PREWHERE` 中使用 `LowCardinality` 的查询中出现的错误，例如 `Expected ColumnLowCardinality, gotUInt8` 或 `Bad cast from type DB::ColumnVector<char8_t> to DB::ColumnLowCardinality`。更重要的是，修正了错误消息中缺少空格的问题。修复了 [#23515](https://github.com/ClickHouse/ClickHouse/issues/23515)。[#27298](https://github.com/ClickHouse/ClickHouse/pull/27298)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在 `distributed_group_by_no_merge = 2` 且 `distributed_push_down_limit = 1`，或 `optimize_distributed_group_by_sharding_key = 1` 且同时使用 `LIMIT BY` 和 `LIMIT OFFSET` 时的问题。[#27249](https://github.com/ClickHouse/ClickHouse/pull/27249)（[Azat Khuzhin](https://github.com/azat)）。这些是一些晦涩的配置组合，几乎没有人会这么使用。
* 修复在非复制 MergeTree 中因无效分区而卡住的变更操作。 [#27248](https://github.com/ClickHouse/ClickHouse/pull/27248) ([Azat Khuzhin](https://github.com/azat)).
* 在存在歧义的情况下，lambda 函数会优先将其参数解释为参数，而不是其他别名或标识符。[#27235](https://github.com/ClickHouse/ClickHouse/pull/27235)（[Raúl Marín](https://github.com/Algunenano)）。
* 修复 merge join 的列结构问题，关闭 [#27091](https://github.com/ClickHouse/ClickHouse/issues/27091)。[#27217](https://github.com/ClickHouse/ClickHouse/pull/27217)（[Vladimir C](https://github.com/vdimir)）。
* 在极少数情况下，`system.detached_parts` 表中某些分片可能包含不正确的信息，此问题已修复。修复了 [#27114](https://github.com/ClickHouse/ClickHouse/issues/27114)。[#27183](https://github.com/ClickHouse/ClickHouse/pull/27183)（[tavplubix](https://github.com/tavplubix)）。
* 修复函数 `multiSearch*` 在处理空数组时的未初始化内存错误，关闭 [#27169](https://github.com/ClickHouse/ClickHouse/issues/27169)。[#27181](https://github.com/ClickHouse/ClickHouse/pull/27181)（[Vladimir C](https://github.com/vdimir)）。
* 修复 GRPCServer 中的同步问题。该 PR 修复了 [#27024](https://github.com/ClickHouse/ClickHouse/issues/27024)。[#27064](https://github.com/ClickHouse/ClickHouse/pull/27064)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复了 `cache`、`complex_key_cache`、`ssd_cache`、`complex_key_ssd_cache` 配置解析问题。选项 `allow_read_expired_keys`、`max_update_queue_size`、`update_queue_push_timeout_milliseconds`、`query_wait_timeout_milliseconds` 之前不会为非 `cache` 类型的字典被解析。 [#27032](https://github.com/ClickHouse/ClickHouse/pull/27032) ([Maksim Kita](https://github.com/kitaisreal)).
* 修复由于与 DROP&#95;RANGE 发生竞态而可能出现的 mutation 栈问题。[#27002](https://github.com/ClickHouse/ClickHouse/pull/27002) ([Azat Khuzhin](https://github.com/azat))。
* 现在在类似 `ALTER TABLE ... PARTITION ID xxx` 的查询中，分区 ID 会进行正确性校验。修复了 [#25718](https://github.com/ClickHouse/ClickHouse/issues/25718)。[#26963](https://github.com/ClickHouse/ClickHouse/pull/26963)（[alesapin](https://github.com/alesapin)）。
* 在某些包含多个 JOIN 的情况下修复 “Unknown column name” 错误，关闭 [#26899](https://github.com/ClickHouse/ClickHouse/issues/26899)。 [#26957](https://github.com/ClickHouse/ClickHouse/pull/26957)（[Vladimir C](https://github.com/vdimir)）。
* 修复自定义 TLD 的读取问题（在缓冲区较小或文件较大时会中止处理）。 [#26948](https://github.com/ClickHouse/ClickHouse/pull/26948) ([Azat Khuzhin](https://github.com/azat)).
* 修复在 `DEFAULT` 列引用其他未物化且未定义 `DEFAULT` 表达式的列时出现的错误 `Missing columns: 'xxx'`。修复 [#26591](https://github.com/ClickHouse/ClickHouse/issues/26591)。[#26900](https://github.com/ClickHouse/ClickHouse/pull/26900)（[alesapin](https://github.com/alesapin)）。
* 修复在 `library` 字典源中使用 `library-bridge` 加载字典键的问题。[#26834](https://github.com/ClickHouse/ClickHouse/pull/26834) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 在应用某些组合器时，聚合函数的参数可能会丢失，从而导致类似 `Conversion from AggregateFunction(topKArray, Array(String)) to AggregateFunction(topKArray(10), Array(String)) is not supported` 的异常。该问题已修复，修复了 [#26196](https://github.com/ClickHouse/ClickHouse/issues/26196) 和 [#26433](https://github.com/ClickHouse/ClickHouse/issues/26433)。[#26814](https://github.com/ClickHouse/ClickHouse/pull/26814)（[tavplubix](https://github.com/tavplubix)）。
* 在 `system.part_log` 中为 `REMOVE_PART` 添加 `event_time_microseconds` 值。此前的版本中未设置该值。[#26720](https://github.com/ClickHouse/ClickHouse/pull/26720) ([Azat Khuzhin](https://github.com/azat)).
* 在关闭 ReplicatedMergeTree 表时请勿删除数据，以避免导致数据与元数据不一致的情况。[#26716](https://github.com/ClickHouse/ClickHouse/pull/26716) ([nvartolomei](https://github.com/nvartolomei))。
* 有时 `SET ROLE` 的行为可能不正确，本 PR 修复了该问题。[#26707](https://github.com/ClickHouse/ClickHouse/pull/26707) ([Vitaly Baranov](https://github.com/vitlibar)).
* 针对并行格式的一些修复（[https://github.com/ClickHouse/ClickHouse/issues/26694](https://github.com/ClickHouse/ClickHouse/issues/26694)）。[#26703](https://github.com/ClickHouse/ClickHouse/pull/26703)（[Raúl Marín](https://github.com/Algunenano)）。
* 修复窗口函数中潜在的 `nullptr` 解引用问题。此更改修复了 [#25276](https://github.com/ClickHouse/ClickHouse/issues/25276)。 [#26668](https://github.com/ClickHouse/ClickHouse/pull/26668)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* 修复在从 3 年前版本的 clickhouse-client 历史文件格式升级时，当历史文件为空导致转换失败的问题。 [#26589](https://github.com/ClickHouse/ClickHouse/pull/26589) ([Azat Khuzhin](https://github.com/azat)).
* 修复在某些情况下可能显示错误的 groupBitmapAnd/Or/Xor 函数名称。已修复该问题。 [#26557](https://github.com/ClickHouse/ClickHouse/pull/26557) ([Amos Bird](https://github.com/amosbird)).
* 更新 clickhouse-server Docker entrypoint 中对 `chown` 命令的检查，修复了在 Kubernetes 中集群 Pod 重启失败（或超时）的问题。[#26545](https://github.com/ClickHouse/ClickHouse/pull/26545) ([Ky Li](https://github.com/Kylinrix))。
* 修复在尚未启动 `RabbitMQ` 设置时关闭 `RabbitMQ` 时发生的崩溃。修复了 [#26504](https://github.com/ClickHouse/ClickHouse/issues/26504)。[#26529](https://github.com/ClickHouse/ClickHouse/pull/26529)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在字典名称或数据库名称被引号括起来时，`CREATE DICTIONARY` 查询出现的问题。关闭 [#26491](https://github.com/ClickHouse/ClickHouse/issues/26491)。[#26508](https://github.com/ClickHouse/ClickHouse/pull/26508)（[Maksim Kita](https://github.com/kitaisreal)）。
* 在重写列别名后修复列名解析出错的问题。修复了 [#26432](https://github.com/ClickHouse/ClickHouse/issues/26432)。[#26475](https://github.com/ClickHouse/ClickHouse/pull/26475)（[Amos Bird](https://github.com/amosbird)）。
* 修复了一些在模糊测试中暴露的 msan 崩溃。修复了 [#22517](https://github.com/ClickHouse/ClickHouse/issues/22517)。[#26428](https://github.com/ClickHouse/ClickHouse/pull/26428) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复在关闭 `partial_merge_join` 时出现的无限未参与连接的块流问题 [#26325](https://github.com/ClickHouse/ClickHouse/issues/26325)。 [#26374](https://github.com/ClickHouse/ClickHouse/pull/26374) ([Vladimir C](https://github.com/vdimir))。
* 修复以已被删除的用户身份登录时可能发生的崩溃。此 PR 修复了 [#26073](https://github.com/ClickHouse/ClickHouse/issues/26073)。[#26363](https://github.com/ClickHouse/ClickHouse/pull/26363)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复 `optimize_distributed_group_by_sharding_key` 在多列场景下的问题（当 `optimize_skip_unused_shards=1` / `allow_nondeterministic_optimize_skip_unused_shards=1` 且分片键表达式包含多列时会导致结果不正确）。[#26353](https://github.com/ClickHouse/ClickHouse/pull/26353) ([Azat Khuzhin](https://github.com/azat))。
* 修复了一个在丢失副本恢复过程中可能导致副本出现分歧的罕见错误。 [#26321](https://github.com/ClickHouse/ClickHouse/pull/26321) ([tavplubix](https://github.com/tavplubix)).
* 修复 zstd 解压缩：当内部缓冲区末尾存在转义序列时，会影响用于与表数据无关的 zstd 帧格式导入/导出。关闭 [#26013](https://github.com/ClickHouse/ClickHouse/issues/26013)。[#26314](https://github.com/ClickHouse/ClickHouse/pull/26314)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复带 `totals` 的 `JOIN` 的逻辑错误，关闭 [#26017](https://github.com/ClickHouse/ClickHouse/issues/26017)。[#26250](https://github.com/ClickHouse/ClickHouse/pull/26250)（[Vladimir C](https://github.com/vdimir)）。
* 去除 `system.stack_trace` 表中 `thread_name` 列里的多余换行符。已修复 [#24124](https://github.com/ClickHouse/ClickHouse/issues/24124)。[#26210](https://github.com/ClickHouse/ClickHouse/pull/26210)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在使用多个 `untuple` 表达式时可能发生的崩溃问题。[#26179](https://github.com/ClickHouse/ClickHouse/pull/26179) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 如果 Enum 没有零值，则对于 Nullable Enum 的 `toString` 不要抛出异常，修复并关闭 [#25806](https://github.com/ClickHouse/ClickHouse/issues/25806)。[#26123](https://github.com/ClickHouse/ClickHouse/pull/26123)（[Vladimir C](https://github.com/vdimir)）。
* 修复了 ClickHouse 在查询执行期间抛出异常时，通过 MySQL 协议发送的数据包中错误设置的 `sequence_id`。该问题可能导致 MySQL 客户端重置与 ClickHouse 服务器的连接。修复了 [#21184](https://github.com/ClickHouse/ClickHouse/issues/21184)。[#26051](https://github.com/ClickHouse/ClickHouse/pull/26051)（[tavplubix](https://github.com/tavplubix)）。
* 修复了 `cutToFirstSignificantSubdomainCustom()`/`cutToFirstSignificantSubdomainCustomWithWWW()`/`firstSignificantSubdomainCustom()` 对常量返回的类型不正确，从而导致 `optimize_skip_unused_shards` 不生效的问题：[ #26041](https://github.com/ClickHouse/ClickHouse/pull/26041)（[Azat Khuzhin](https://github.com/azat)）。
* 修复在使用普通 projection 搭配 prewhere 时可能出现的头部不匹配问题。本次修改修复了 [#26020](https://github.com/ClickHouse/ClickHouse/issues/26020)。[#26038](https://github.com/ClickHouse/ClickHouse/pull/26038)（[Amos Bird](https://github.com/amosbird)）。
* 修复 remote() 在使用未带函数的列作为 sharding&#95;key 时的问题（此前 `select * from remote('127.1', system.one, dummy)` 会导致 `Unknown column: dummy, there are only columns .` 错误）。[#25824](https://github.com/ClickHouse/ClickHouse/pull/25824) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在从 `MaterializeMySQL` 执行查询时出现的 `Not found column ...` 和 `Missing column ...` 错误。相关问题：[#23708](https://github.com/ClickHouse/ClickHouse/issues/23708)、[#24830](https://github.com/ClickHouse/ClickHouse/issues/24830)、[#25794](https://github.com/ClickHouse/ClickHouse/issues/25794)。[#25822](https://github.com/ClickHouse/ClickHouse/pull/25822)（[tavplubix](https://github.com/tavplubix)）。
* 修复在处理非 UInt64 类型时的 `optimize_skip_unused_shards_rewrite_in`（可能最终会选择错误的分片，或抛出 `Cannot infer type of an empty tuple` 或 `Function tuple requires at least one argument`）。 [#25798](https://github.com/ClickHouse/ClickHouse/pull/25798) ([Azat Khuzhin](https://github.com/azat)).

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-3}

- 现在我们在随机时区中运行有状态和无状态测试。修复 [#12439](https://github.com/ClickHouse/ClickHouse/issues/12439)。在 Protobuf 格式中将 String 读取为 DateTime 以及将 DateTime 写入为 String 现在会遵循时区。在 Arrow 和 Parquet 格式中将 UInt16 读取为 DateTime 现在会将其视为 Date,然后根据 DateTime 的时区转换为 DateTime,因为 Date 在 Arrow 和 Parquet 中被序列化为 UInt16。GraphiteMergeTree 现在在对时间进行舍入时会遵循时区。修复 [#5098](https://github.com/ClickHouse/ClickHouse/issues/5098)。作者:@alexey-milovidov。[#15408](https://github.com/ClickHouse/ClickHouse/pull/15408) ([alesapin](https://github.com/alesapin))。
- `clickhouse-test` 支持使用 [Jinja2](https://jinja.palletsprojects.com/en/3.0.x/templates/#synopsis) 模板的 SQL 测试。[#26579](https://github.com/ClickHouse/ClickHouse/pull/26579) ([Vladimir C](https://github.com/vdimir))。
- 添加对使用 `clang-13` 构建的支持。这解决了 [#27705](https://github.com/ClickHouse/ClickHouse/issues/27705)。[#27714](https://github.com/ClickHouse/ClickHouse/pull/27714) ([alexey-milovidov](https://github.com/alexey-milovidov))。[#27777](https://github.com/ClickHouse/ClickHouse/pull/27777) ([Sergei Semin](https://github.com/syominsergey))
- 添加 CMake 选项以选择是否使用特定的 CPU 指令集进行构建。这是为了 [#17469](https://github.com/ClickHouse/ClickHouse/issues/17469) 和 [#27509](https://github.com/ClickHouse/ClickHouse/issues/27509)。[#27508](https://github.com/ClickHouse/ClickHouse/pull/27508) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 修复使用动态库时辅助程序的链接问题。[#26958](https://github.com/ClickHouse/ClickHouse/pull/26958) ([Raúl Marín](https://github.com/Algunenano))。
- 将 RocksDB 更新至 `2021-07-16` 主分支。[#26411](https://github.com/ClickHouse/ClickHouse/pull/26411) ([alexey-milovidov](https://github.com/alexey-milovidov))。

### ClickHouse 版本 v21.8,2021-08-12 {#clickhouse-release-v218-2021-08-12}

#### 升级说明 {#upgrade-notes}

- 新版本对系统日志表(`system.query_log`、`system.query_thread_log`、`system.processes`、`system.opentelemetry_span_log`)使用 `Map` 数据类型。这些表将使用新的数据类型自动创建。创建虚拟列以支持旧查询。解决了 [#18698](https://github.com/ClickHouse/ClickHouse/issues/18698)。[#23934](https://github.com/ClickHouse/ClickHouse/pull/23934)、[#25773](https://github.com/ClickHouse/ClickHouse/pull/25773) ([hexiaoting](https://github.com/hexiaoting)、[sundy-li](https://github.com/sundy-li)、[Maksim Kita](https://github.com/kitaisreal))。如果您想从版本 21.8 _降级_ 到旧版本,您需要手动清理包含日志的系统表。请查看 `/var/lib/clickhouse/data/system/*_log`。

#### 新功能 {#new-features}


- 添加对部分 SQL/JSON 标准的支持。[#24148](https://github.com/ClickHouse/ClickHouse/pull/24148) ([l1tsolaiki](https://github.com/l1tsolaiki), [Kseniia Sumarokova](https://github.com/kssenii))。
- 收集常见系统指标(在 `system.asynchronous_metrics` 和 `system.asynchronous_metric_log` 中),包括 CPU 使用率、磁盘使用率、内存使用率、IO、网络、文件、平均负载、CPU 频率、温度传感器、EDAC 计数器、系统运行时间;还添加了调度抖动和指标收集耗时的相关指标。它在 ClickHouse 中的工作方式类似于 `atop`,即使未安装其他工具也能访问监控数据。关闭 [#9430](https://github.com/ClickHouse/ClickHouse/issues/9430)。[#24416](https://github.com/ClickHouse/ClickHouse/pull/24416) ([alexey-milovidov](https://github.com/alexey-milovidov), [Yegor Levankov](https://github.com/elevankoff))。
- 添加 MaterializedPostgreSQL 表引擎和数据库引擎。该数据库引擎允许复制整个数据库或数据库表的任意子集。[#20470](https://github.com/ClickHouse/ClickHouse/pull/20470) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 添加新函数 `leftPad()`、`rightPad()`、`leftPadUTF8()`、`rightPadUTF8()`。[#26075](https://github.com/ClickHouse/ClickHouse/pull/26075) ([Vitaly Baranov](https://github.com/vitlibar))。
- 在 `ADD INDEX` 命令中添加 `FIRST` 关键字,以便能够在索引列表的开头添加索引。[#25904](https://github.com/ClickHouse/ClickHouse/pull/25904) ([xjewer](https://github.com/xjewer))。
- 引入 `system.data_skipping_indices` 表,包含有关现有数据跳过索引的信息。关闭 [#7659](https://github.com/ClickHouse/ClickHouse/issues/7659)。[#25693](https://github.com/ClickHouse/ClickHouse/pull/25693) ([Dmitry Novik](https://github.com/novikd))。
- 添加 `bin`/`unbin` 函数。[#25609](https://github.com/ClickHouse/ClickHouse/pull/25609) ([zhaoyu](https://github.com/zxc111))。
- 在 `mapAdd` 和 `mapSubtract` 函数中支持 `Map` 以及 `UInt128`、`Int128`、`UInt256`、`Int256` 类型。[#25596](https://github.com/ClickHouse/ClickHouse/pull/25596) ([Ildus Kurbangaliev](https://github.com/ildus))。
- 支持 `DISTINCT ON (columns)` 表达式,关闭 [#25404](https://github.com/ClickHouse/ClickHouse/issues/25404)。[#25589](https://github.com/ClickHouse/ClickHouse/pull/25589) ([Zijie Lu](https://github.com/TszKitLo40))。
- 添加将自定义设置重置为默认值并从表的元数据中删除的功能。这允许在不知道系统/配置默认值的情况下回滚更改。关闭 [#14449](https://github.com/ClickHouse/ClickHouse/issues/14449)。[#17769](https://github.com/ClickHouse/ClickHouse/pull/17769) ([xjewer](https://github.com/xjewer))。
- 如果提交 `EXPLAIN PIPELINE graph = 1` 查询,则在 Web UI 中将管道渲染为图形。[#26067](https://github.com/ClickHouse/ClickHouse/pull/26067) ([alexey-milovidov](https://github.com/alexey-milovidov))。

#### 性能改进 {#performance-improvements}

- 编译聚合函数。使用选项 `compile_aggregate_expressions` 启用此功能。[#24789](https://github.com/ClickHouse/ClickHouse/pull/24789) ([Maksim Kita](https://github.com/kitaisreal))。
- 改进需要从具有多列的表中读取数据的短查询的延迟。[#26371](https://github.com/ClickHouse/ClickHouse/pull/26371) ([Anton Popov](https://github.com/CurtizJ))。

#### 改进 {#improvements}


* 对系统日志表（`system.query_log`、`system.query_thread_log`、`system.processes`、`system.opentelemetry_span_log`）使用 `Map` 数据类型。这些表将自动以新的数据类型创建。为了兼容旧查询，会创建虚拟列。修复 [#18698](https://github.com/ClickHouse/ClickHouse/issues/18698)。[#23934](https://github.com/ClickHouse/ClickHouse/pull/23934)、[#25773](https://github.com/ClickHouse/ClickHouse/pull/25773)（[hexiaoting](https://github.com/hexiaoting)、[sundy-li](https://github.com/sundy-li)、[Maksim Kita](https://github.com/kitaisreal)）。
* 对于键为复杂类型且仅包含一个属性的字典，在使用 `dictGet`、`dictHas` 函数时，允许不将键表达式包裹在 tuple 中。[#26130](https://github.com/ClickHouse/ClickHouse/pull/26130) ([Maksim Kita](https://github.com/kitaisreal))。
* 为 `AggregateFunction` 状态实现 `bin`/`hex` 函数。[#26094](https://github.com/ClickHouse/ClickHouse/pull/26094)（[zhaoyu](https://github.com/zxc111)）。
* 为 `empty` 和 `notEmpty` 函数增加对 `UUID` 类型参数的支持。当 `UUID` 全为零（nil UUID）时，视为空。关闭 [#3446](https://github.com/ClickHouse/ClickHouse/issues/3446)。[#25974](https://github.com/ClickHouse/ClickHouse/pull/25974)（[zhaoyu](https://github.com/zxc111)）。
* 在 MySQL 协议中添加对 `SET SQL_SELECT_LIMIT` 的支持。修复 [#17115](https://github.com/ClickHouse/ClickHouse/issues/17115)。[#25972](https://github.com/ClickHouse/ClickHouse/pull/25972)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 为网络通信增加更多监控指标：添加接收/发送字节数的计数器；添加接收/发送次数的仪表型指标。补充缺失的文档。关闭 [#5897](https://github.com/ClickHouse/ClickHouse/issues/5897)。[#25962](https://github.com/ClickHouse/ClickHouse/pull/25962)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 新增设置项 `optimize_move_to_prewhere_if_final`。如果查询包含 `FINAL`，则只有在同时启用 `optimize_move_to_prewhere` 和 `optimize_move_to_prewhere_if_final` 时，才会启用 `move_to_prewhere` 优化。修复 [#8684](https://github.com/ClickHouse/ClickHouse/issues/8684)。[#25940](https://github.com/ClickHouse/ClickHouse/pull/25940)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 支持在 JOIN 中的表使用复杂的带引号标识符。关闭 [#17861](https://github.com/ClickHouse/ClickHouse/issues/17861)。[#25924](https://github.com/ClickHouse/ClickHouse/pull/25924)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 `Nested` 数据类型中的 Unicode 组件（例如中文、西里尔字母）新增支持。关闭 [#25594](https://github.com/ClickHouse/ClickHouse/issues/25594)。[#25923](https://github.com/ClickHouse/ClickHouse/pull/25923)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 允许 `quantiles*` 函数与 `aggregate_functions_null_for_empty` 一起工作。修复 [#25892](https://github.com/ClickHouse/ClickHouse/issues/25892)。[#25919](https://github.com/ClickHouse/ClickHouse/pull/25919)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 允许参数化聚合函数的参数为任意常量表达式（例如 `1 + 2`），而不仅限于字面量。还允许在参数化聚合函数中使用查询参数（如在 `{param:UInt8}` 这类参数化查询中）。修复 [#11607](https://github.com/ClickHouse/ClickHouse/issues/11607)。[#25910](https://github.com/ClickHouse/ClickHouse/pull/25910)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在尝试解析无效的 `Date` 时正确抛出异常。修复 [#6481](https://github.com/ClickHouse/ClickHouse/issues/6481)。[#25909](https://github.com/ClickHouse/ClickHouse/pull/25909)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在配置中支持多个 include。现在可以从多个来源包含 users 配置和 remote server 配置。只需添加一个带有 `from_zk`、`from_env` 或 `incl` 属性的 `<include />` 元素，它就会被相应的替换内容所替换。[#24404](https://github.com/ClickHouse/ClickHouse/pull/24404) ([nvartolomei](https://github.com/nvartolomei))。
* 支持包含名为 `"null"` 的列（必须使用反引号或双引号引用）以及 `ON CLUSTER` 的查询。关闭 [#24035](https://github.com/ClickHouse/ClickHouse/issues/24035)。[#25907](https://github.com/ClickHouse/ClickHouse/pull/25907)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 `JSONExtract` 提供对 `LowCardinality`、`Decimal` 和 `UUID` 的支持，关闭 [#24606](https://github.com/ClickHouse/ClickHouse/issues/24606)。[#25900](https://github.com/ClickHouse/ClickHouse/pull/25900)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 将历史文件从 `readline` 格式转换为 `replxx` 格式。[#25888](https://github.com/ClickHouse/ClickHouse/pull/25888) ([Azat Khuzhin](https://github.com/azat))。
* 修复一个问题，该问题可能在执行 `DROP PART` 或后台删除空 part 后导致 part 之间出现交叉。 [#25884](https://github.com/ClickHouse/ClickHouse/pull/25884) ([alesapin](https://github.com/alesapin))。
* 改进了对 `ReplicatedMergeTree` 表中丢失 part 的处理。修复了 `ReplicationQueue` 中罕见的不一致情况。修复了 [#10368](https://github.com/ClickHouse/ClickHouse/issues/10368)。[#25820](https://github.com/ClickHouse/ClickHouse/pull/25820)（[alesapin](https://github.com/alesapin)）。
* 允许在无法读取工作目录的情况下启动 clickhouse-client。 [#25817](https://github.com/ClickHouse/ClickHouse/pull/25817) ([ianton-ru](https://github.com/ianton-ru)).
* 修复 `Merge` 存储引擎中的 &quot;No available columns&quot; 错误。[#25801](https://github.com/ClickHouse/ClickHouse/pull/25801) ([Azat Khuzhin](https://github.com/azat)).
* MySQL Engine 现在支持在 MySQL 和 ClickHouse 之间同步列注释。 [#25795](https://github.com/ClickHouse/ClickHouse/pull/25795) ([Storozhuk Kostiantyn](https://github.com/sand6255)).
* 修复在空结果集上对常量执行 `GROUP BY` 时出现的不一致行为。关闭 [#6842](https://github.com/ClickHouse/ClickHouse/issues/6842)。[#25786](https://github.com/ClickHouse/ClickHouse/pull/25786)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在 `ReplicatedMergeTree` 中，在执行 `DROP PARTITION` 和 `TRUNCATE` 时取消该分区中已在运行的合并。修复了 [#17151](https://github.com/ClickHouse/ClickHouse/issues/17151)。[#25684](https://github.com/ClickHouse/ClickHouse/pull/25684)（[tavplubix](https://github.com/tavplubix)）。
* 为 MaterializeMySQL 增加对 ENUM 数据类型的支持。[#25676](https://github.com/ClickHouse/ClickHouse/pull/25676)（[Storozhuk Kostiantyn](https://github.com/sand6255)）。
* 在 JOIN 中支持物化列和别名列，解决 [#13274](https://github.com/ClickHouse/ClickHouse/issues/13274) 问题。[#25634](https://github.com/ClickHouse/ClickHouse/pull/25634) ([Vladimir C](https://github.com/vdimir))。
* 修复 `ALTER TABLE ... DETACH` 与后台合并操作之间可能存在的逻辑竞态条件。[#25605](https://github.com/ClickHouse/ClickHouse/pull/25605) ([Azat Khuzhin](https://github.com/azat))。
* 使 `NetworkReceiveElapsedMicroseconds` 指标能够正确统计等待客户端发送 `INSERT` 数据所花费的时间。关闭 [#9958](https://github.com/ClickHouse/ClickHouse/issues/9958)。[#25602](https://github.com/ClickHouse/ClickHouse/pull/25602)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 支持在 S3 和 HDFS 上使用 `TRUNCATE TABLE`。关闭 [#25530](https://github.com/ClickHouse/ClickHouse/issues/25530)。[#25550](https://github.com/ClickHouse/ClickHouse/pull/25550)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 支持通过动态重新加载配置来调整用于执行后台任务（合并、变更、拉取）的线程池大小。[#25548](https://github.com/ClickHouse/ClickHouse/pull/25548) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 允许使用 `JSONExtract` 将非字符串元素以字符串形式提取。これは为了解决 [#25414](https://github.com/ClickHouse/ClickHouse/issues/25414)。[#25452](https://github.com/ClickHouse/ClickHouse/pull/25452)（[Amos Bird](https://github.com/amosbird)）。
* 为 `StorageMerge` 的 `Database` 参数增加对正则表达式的支持。关闭 [#776](https://github.com/ClickHouse/ClickHouse/issues/776)。[#25064](https://github.com/ClickHouse/ClickHouse/pull/25064)（[flynn](https://github.com/ucasfl)）。
* Web UI：如果该值看起来像 URL，则自动生成链接。[#25965](https://github.com/ClickHouse/ClickHouse/pull/25965) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 使命令 `sudo service clickhouse-server start` 能在使用 `systemd` 的系统（如 Centos 8）上正常工作。关闭 [#14298](https://github.com/ClickHouse/ClickHouse/issues/14298)。关闭 [#17799](https://github.com/ClickHouse/ClickHouse/issues/17799)。[#25921](https://github.com/ClickHouse/ClickHouse/pull/25921) ([alexey-milovidov](https://github.com/alexey-milovidov))。

#### 错误修复 {#bug-fixes-1}


* 修复 `SET ROLE` 语句在某些情况下的不正确行为。[#26707](https://github.com/ClickHouse/ClickHouse/pull/26707)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复窗口函数中可能发生的 `nullptr` 解引用。修复 [#25276](https://github.com/ClickHouse/ClickHouse/issues/25276)。[#26668](https://github.com/ClickHouse/ClickHouse/pull/26668)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* 修正 `groupBitmapAnd/Or/Xor` 函数名错误。修复 [#26557](https://github.com/ClickHouse/ClickHouse/pull/26557)（[Amos Bird](https://github.com/amosbird)）。
* 修复在 RabbitMQ 尚未启动时关闭 RabbitMQ 导致的崩溃。解决 [#26504](https://github.com/ClickHouse/ClickHouse/issues/26504)。[#26529](https://github.com/ClickHouse/ClickHouse/pull/26529)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复当字典名称或数据库名称被加引号时 `CREATE DICTIONARY` 查询中的问题。关闭 [#26491](https://github.com/ClickHouse/ClickHouse/issues/26491)。[#26508](https://github.com/ClickHouse/ClickHouse/pull/26508)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复在重写列别名后出现的名称解析问题。修复 [#26432](https://github.com/ClickHouse/ClickHouse/issues/26432)。[#26475](https://github.com/ClickHouse/ClickHouse/pull/26475)（[Amos Bird](https://github.com/amosbird)）。
* 修复在关闭 `partial_merge_join` 时出现的无限未连接块流问题 [#26325](https://github.com/ClickHouse/ClickHouse/issues/26325)。[#26374](https://github.com/ClickHouse/ClickHouse/pull/26374)（[Vladimir C](https://github.com/vdimir)）。
* 修复当以已删除用户身份登录时可能发生的崩溃问题。修复 [#26073](https://github.com/ClickHouse/ClickHouse/issues/26073)。[#26363](https://github.com/ClickHouse/ClickHouse/pull/26363)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复 `optimize_distributed_group_by_sharding_key` 在使用多列作为分片键时的问题（在 `optimize_skip_unused_shards=1` / `allow_nondeterministic_optimize_skip_unused_shards=1` 且分片键表达式包含多列时会导致结果不正确）。[#26353](https://github.com/ClickHouse/ClickHouse/pull/26353) ([Azat Khuzhin](https://github.com/azat))。
* `CAST` 将 `Date` 转换为 `DateTime`（或 `DateTime64`）时，没有使用 `DateTime` 类型的时区。这也会影响 `Date` 和 `DateTime` 之间的比较。为 `Date` 和 `DateTime` 推断公共类型时同样没有使用相应的时区，从而影响了 `if` 函数的结果以及数组构造。修复了 [#24128](https://github.com/ClickHouse/ClickHouse/issues/24128)。[#24129](https://github.com/ClickHouse/ClickHouse/pull/24129)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复了在丢失副本恢复过程中出现的罕见错误，该错误可能导致副本数据出现不一致。 [#26321](https://github.com/ClickHouse/ClickHouse/pull/26321) ([tavplubix](https://github.com/tavplubix)).
* 修复在内部缓冲区末尾存在转义序列时的 zstd 解压问题。解决 [#26013](https://github.com/ClickHouse/ClickHouse/issues/26013)。[#26314](https://github.com/ClickHouse/ClickHouse/pull/26314)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修正在使用 totals 的 JOIN 操作时的逻辑错误，关闭 [#26017](https://github.com/ClickHouse/ClickHouse/issues/26017)。[#26250](https://github.com/ClickHouse/ClickHouse/pull/26250)（[Vladimir C](https://github.com/vdimir)）。
* 移除 `system.stack_trace` 表中 `thread_name` 列里多余的换行符。修复 [#24124](https://github.com/ClickHouse/ClickHouse/issues/24124)。[#26210](https://github.com/ClickHouse/ClickHouse/pull/26210)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复带有 `LowCardinality` 列的 `joinGet`，关闭 [#25993](https://github.com/ClickHouse/ClickHouse/issues/25993)。[#26118](https://github.com/ClickHouse/ClickHouse/pull/26118)（[Vladimir C](https://github.com/vdimir)）。
* 修复在关闭 `validate_polygons` 设置时，`pointInPolygon` 中可能出现的崩溃问题。 [#26113](https://github.com/ClickHouse/ClickHouse/pull/26113) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复在遍历不存在的远程目录时抛出异常的问题。[#26087](https://github.com/ClickHouse/ClickHouse/pull/26087) ([ianton-ru](https://github.com/ianton-ru))。
* 修复由于 ZooKeeper 客户端中的 `abort` 导致的罕见服务器崩溃问题。修复 [#25813](https://github.com/ClickHouse/ClickHouse/issues/25813)。[#26079](https://github.com/ClickHouse/ClickHouse/pull/26079)（[alesapin](https://github.com/alesapin)）。
* 修复在某些情况下对右侧子查询 JOIN 的线程数估算错误。关闭 [#24075](https://github.com/ClickHouse/ClickHouse/issues/24075)。[#26052](https://github.com/ClickHouse/ClickHouse/pull/26052)（[Vladimir C](https://github.com/vdimir)）。
* 修正了 ClickHouse 在查询执行期间发生异常时通过 MySQL 协议发送的数据包中错误的 `sequence_id`。该问题可能会导致 MySQL 客户端重置与 ClickHouse 服务器的连接。修复了 [#21184](https://github.com/ClickHouse/ClickHouse/issues/21184)。[#26051](https://github.com/ClickHouse/ClickHouse/pull/26051)（[tavplubix](https://github.com/tavplubix)）。
* 修复在使用普通投影配合 `PREWHERE` 时可能出现的表头不匹配问题。修复 [#26020](https://github.com/ClickHouse/ClickHouse/issues/26020)。[#26038](https://github.com/ClickHouse/ClickHouse/pull/26038)（[Amos Bird](https://github.com/amosbird)）。
* 修复将整数键的 `Map` 类型格式化为 `JSON` 时的格式问题。 [#25982](https://github.com/ClickHouse/ClickHouse/pull/25982) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在查询分析器调用栈展开过程中可能出现的死锁问题。修复 [#25968](https://github.com/ClickHouse/ClickHouse/issues/25968)。[#25970](https://github.com/ClickHouse/ClickHouse/pull/25970)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复在使用无效参数调用 `dictGet()` 时发生的崩溃。[#25913](https://github.com/ClickHouse/ClickHouse/pull/25913) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复了 PostgreSQL 引擎的 `scram-sha-256` 认证问题。修复 [#24516](https://github.com/ClickHouse/ClickHouse/issues/24516)。[#25906](https://github.com/ClickHouse/ClickHouse/pull/25906)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在后台线程池已满时后台任务退避时间过长的问题。修复 [#25836](https://github.com/ClickHouse/ClickHouse/issues/25836)。[#25893](https://github.com/ClickHouse/ClickHouse/pull/25893)（[alesapin](https://github.com/alesapin)）。
* 修复在非默认页大小配置下的 ARM 异常处理问题。解决了 [#25512](https://github.com/ClickHouse/ClickHouse/issues/25512)、[#25044](https://github.com/ClickHouse/ClickHouse/issues/25044)、[#24901](https://github.com/ClickHouse/ClickHouse/issues/24901)、[#23183](https://github.com/ClickHouse/ClickHouse/issues/23183)、[#20221](https://github.com/ClickHouse/ClickHouse/issues/20221)、[#19703](https://github.com/ClickHouse/ClickHouse/issues/19703)、[#19028](https://github.com/ClickHouse/ClickHouse/issues/19028)、[#18391](https://github.com/ClickHouse/ClickHouse/issues/18391)、[#18121](https://github.com/ClickHouse/ClickHouse/issues/18121)、[#17994](https://github.com/ClickHouse/ClickHouse/issues/17994)、[#12483](https://github.com/ClickHouse/ClickHouse/issues/12483)。[#25854](https://github.com/ClickHouse/ClickHouse/pull/25854)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复 `remote()` 在未使用函数、直接使用列作为 `sharding_key` 时的行为（此前 `select * from remote('127.1', system.one, dummy)` 会导致 `Unknown column: dummy, there are only columns .` 错误）。[#25824](https://github.com/ClickHouse/ClickHouse/pull/25824)（[Azat Khuzhin](https://github.com/azat)）。
* 修复了从 `MaterializeMySQL` 查询数据时出现的 `Not found column ...` 和 `Missing column ...` 错误。修复了 [#23708](https://github.com/ClickHouse/ClickHouse/issues/23708)、[#24830](https://github.com/ClickHouse/ClickHouse/issues/24830)、[#25794](https://github.com/ClickHouse/ClickHouse/issues/25794)。[#25822](https://github.com/ClickHouse/ClickHouse/pull/25822)（[tavplubix](https://github.com/tavplubix)）。
* 修复针对非 UInt64 类型的 `optimize_skip_unused_shards_rewrite_in`（可能最终选择错误的分片，或抛出 `Cannot infer type of an empty tuple` 或 `Function tuple requires at least one argument`）。 [#25798](https://github.com/ClickHouse/ClickHouse/pull/25798) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在 `ReplicatedMergeTree` 表上执行 `DROP PART` 查询时可能出现的一个罕见 bug，该 bug 可能会导致错误信息 `Unexpected merged part intersecting drop range`。 [#25783](https://github.com/ClickHouse/ClickHouse/pull/25783) ([alesapin](https://github.com/alesapin)).
* 修复了在使用带有 `GROUP BY` 表达式的 `TTL` 时，在数据分片上首次执行后不再继续执行 `TTL` 的错误。[#25743](https://github.com/ClickHouse/ClickHouse/pull/25743) ([alesapin](https://github.com/alesapin))。
* 允许 StorageMerge 访问带别名的表。解决了 [#6051](https://github.com/ClickHouse/ClickHouse/issues/6051)。[#25694](https://github.com/ClickHouse/ClickHouse/pull/25694)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在某些情况下字典关联（dict join）变慢的问题，关闭 [#24209](https://github.com/ClickHouse/ClickHouse/issues/24209)。[#25618](https://github.com/ClickHouse/ClickHouse/pull/25618)（[Vladimir C](https://github.com/vdimir)）。
* 修复对参与 TTL 表达式的列执行 `ALTER MODIFY COLUMN` 时的问题。 [#25554](https://github.com/ClickHouse/ClickHouse/pull/25554) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在 `PREWHERE` 中使用非 UInt8 类型时的断言失败问题，关闭 [#19589](https://github.com/ClickHouse/ClickHouse/issues/19589)。[#25484](https://github.com/ClickHouse/ClickHouse/pull/25484)（[Vladimir C](https://github.com/vdimir)）。
* 修复了一些由模糊测试触发的 msan 崩溃问题。修复了 [#22517](https://github.com/ClickHouse/ClickHouse/issues/22517)。[#26428](https://github.com/ClickHouse/ClickHouse/pull/26428)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 更新 `clickhouse-server` Docker entrypoint 中 `chown` 命令的检查逻辑。这修复了在 Kubernetes 上出现的 “cluster pod restart failed (or timeout)” 错误。 [#26545](https://github.com/ClickHouse/ClickHouse/pull/26545) ([Ky Li](https://github.com/Kylinrix)).

### ClickHouse 版本 v21.7, 2021-07-09 {#clickhouse-release-v217-2021-07-09}

#### 向后不兼容变更 {#backward-incompatible-change-4}

- 改进了显式定义大型集合的查询性能。新增兼容性设置 `legacy_column_name_of_tuple_literal`。在将集群从 21.7 以下版本滚动升级到更高版本时,建议将其设置为 `true`。否则,在升级过程中,`IN` 子句中显式定义集合的分布式查询可能会失败。[#25371](https://github.com/ClickHouse/ClickHouse/pull/25371) ([Anton Popov](https://github.com/CurtizJ))。
- clickhouse-keeper(ZooKeeper 的实验性替代方案)中最大缓冲区大小的前向/后向不兼容变更。建议现在(在投入生产环境之前)进行此变更,而不是以后。[#25421](https://github.com/ClickHouse/ClickHouse/pull/25421) ([alesapin](https://github.com/alesapin))。

#### 新功能 {#new-feature-4}


- 支持使用 YAML 格式配置作为 XML 的替代方案。此更改关闭了 [#3607](https://github.com/ClickHouse/ClickHouse/issues/3607)。[#21858](https://github.com/ClickHouse/ClickHouse/pull/21858) ([BoloniniD](https://github.com/BoloniniD))。
- 提供了一种在数据（可能）存在但 ZooKeeper 元数据丢失时恢复复制表的方法。解决了 [#13458](https://github.com/ClickHouse/ClickHouse/issues/13458)。[#13652](https://github.com/ClickHouse/ClickHouse/pull/13652) ([Mike Kot](https://github.com/myrrc))。
- 支持在 Arrow/Parquet/ORC 中使用结构体和映射,以及在 Arrow 输入/输出格式中使用字典。引入了新设置 `output_format_arrow_low_cardinality_as_dictionary`。[#24341](https://github.com/ClickHouse/ClickHouse/pull/24341) ([Kruglov Pavel](https://github.com/Avogar))。
- 在字典中添加了对 `Array` 类型的支持。[#25119](https://github.com/ClickHouse/ClickHouse/pull/25119) ([Maksim Kita](https://github.com/kitaisreal))。
- 添加了函数 `bitPositionsToArray`。关闭了 [#23792](https://github.com/ClickHouse/ClickHouse/issues/23792)。作者 [Kevin Wan] (@MaxWk)。[#25394](https://github.com/ClickHouse/ClickHouse/pull/25394) ([Maksim Kita](https://github.com/kitaisreal))。
- 添加了函数 `dateName` 以返回类似 'Friday' 或 'April' 的名称。作者 [Daniil Kondratyev] (@dankondr)。[#25372](https://github.com/ClickHouse/ClickHouse/pull/25372) ([Maksim Kita](https://github.com/kitaisreal))。
- 添加了 `toJSONString` 函数以将列序列化为其 JSON 表示形式。[#25164](https://github.com/ClickHouse/ClickHouse/pull/25164) ([Amos Bird](https://github.com/amosbird))。
- 现在 `query_log` 有两个新列:`initial_query_start_time` 和 `initial_query_start_time_microsecond`,用于记录分布式查询的起始时间(如果有)。[#25022](https://github.com/ClickHouse/ClickHouse/pull/25022) ([Amos Bird](https://github.com/amosbird))。
- 添加了聚合函数 `segmentLengthSum`。[#24250](https://github.com/ClickHouse/ClickHouse/pull/24250) ([flynn](https://github.com/ucasfl))。
- 添加了新的布尔设置 `prefer_global_in_and_join`,该设置将所有 IN/JOIN 默认为 GLOBAL IN/JOIN。[#23434](https://github.com/ClickHouse/ClickHouse/pull/23434) ([Amos Bird](https://github.com/amosbird))。
- 支持对 `Join` 表引擎执行 `ALTER DELETE` 查询。[#23260](https://github.com/ClickHouse/ClickHouse/pull/23260) ([foolchi](https://github.com/foolchi))。
- 添加了 `quantileBFloat16` 聚合函数以及相应的 `quantilesBFloat16` 和 `medianBFloat16`。这是一个非常简单且快速的分位数估计器,相对误差不超过 0.390625%。此更改关闭了 [#16641](https://github.com/ClickHouse/ClickHouse/issues/16641)。[#23204](https://github.com/ClickHouse/ClickHouse/pull/23204) ([Ivan Novitskiy](https://github.com/RedClusive))。
- 实现了 `sequenceNextNode()` 函数,该函数对流程分析很有用。[#19766](https://github.com/ClickHouse/ClickHouse/pull/19766) ([achimbab](https://github.com/achimbab))。

#### 实验性功能 {#experimental-feature-4}

- 添加了对基于 HDFS 的虚拟文件系统的支持。[#11058](https://github.com/ClickHouse/ClickHouse/pull/11058) ([overshov](https://github.com/overshov)) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 现在 clickhouse-keeper(ZooKeeper 的实验性替代方案)支持类似 ZooKeeper 的 `digest` ACL。[#24448](https://github.com/ClickHouse/ClickHouse/pull/24448) ([alesapin](https://github.com/alesapin))。

#### 性能改进 {#performance-improvement-4}


- 新增优化功能,将某些函数转换为读取子列以减少读取的数据量。例如,语句 `col IS NULL` 会被转换为读取子列 `col.null`。可以通过设置 `optimize_functions_to_subcolumns` 来启用此优化,该选项目前默认关闭。[#24406](https://github.com/ClickHouse/ClickHouse/pull/24406) ([Anton Popov](https://github.com/CurtizJ))。
- 将更多列重写为可能的别名表达式。这可能会启用更好的优化,例如投影。[#24405](https://github.com/ClickHouse/ClickHouse/pull/24405) ([Amos Bird](https://github.com/amosbird))。
- 类型为 `bloom_filter` 的索引现在可以用于带有常量数组的 `hasAny` 函数表达式。此更改解决了:[#24291](https://github.com/ClickHouse/ClickHouse/issues/24291)。[#24900](https://github.com/ClickHouse/ClickHouse/pull/24900) ([Vasily Nemkov](https://github.com/Enmk))。
- 在 RabbitMQ 队列为空的情况下,为重新调度读取尝试添加指数退避机制。(ClickHouse 支持从 RabbitMQ 导入数据)。解决了 [#24340](https://github.com/ClickHouse/ClickHouse/issues/24340)。[#24415](https://github.com/ClickHouse/ClickHouse/pull/24415) ([Kseniia Sumarokova](https://github.com/kssenii))。

#### 改进 {#improvement-4}


* 允许限制复制的带宽。添加了两个 Replicated*MergeTree 设置：`max_replicated_fetches_network_bandwidth` 和 `max_replicated_sends_network_bandwidth`，用于限制表在复制获取/发送时的最大速度。添加了两个服务器级别的全局设置（位于 `default` 用户配置中）：`max_replicated_fetches_network_bandwidth_for_server` 和 `max_replicated_sends_network_bandwidth_for_server`，用于限制所有表复制的最大速度。这些设置并不会被完全精确地执行。默认关闭。修复了 [#1821](https://github.com/ClickHouse/ClickHouse/issues/1821)。[#24573](https://github.com/ClickHouse/ClickHouse/pull/24573)（[alesapin](https://github.com/alesapin)）。
* 为 ODBC 和 Library bridge 提供资源约束和隔离。为 bridge 进程使用单独的 `clickhouse-bridge` 用户和用户组。设置 `oom_score_adj`，使这些 bridge 进程成为 OOM killer 的首要目标。将最大 RSS 设置为 1 GiB。修复 [#23861](https://github.com/ClickHouse/ClickHouse/issues/23861)。[#25280](https://github.com/ClickHouse/ClickHouse/pull/25280)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 为主 `clickhouse` 二进制文件添加独立的 `clickhouse-keeper` 符号链接。现在可以在没有主 ClickHouse 服务器的情况下运行协调服务。[#24059](https://github.com/ClickHouse/ClickHouse/pull/24059) ([alesapin](https://github.com/alesapin))。
* 针对 `VIEW` 的查询使用全局设置。修复了查询 `VIEW` 时使用本地设置的行为，因为当 `CREATE VIEW` 和 `SELECT` 中的设置不同时，这会导致错误。现在，`VIEW` 将不会使用这些本地修改的设置，但仍然可以在 `CREATE VIEW` 查询的 `SETTINGS` 部分传递额外的设置。关闭 [#20551](https://github.com/ClickHouse/ClickHouse/issues/20551)。[#24095](https://github.com/ClickHouse/ClickHouse/pull/24095)（[Vladimir](https://github.com/vdimir)）。
* 在服务器启动时，分区 ID 不正确的数据分片不会被删除，而是始终被分离（detached）。[#25070](https://github.com/ClickHouse/ClickHouse/issues/25070)。[#25166](https://github.com/ClickHouse/ClickHouse/pull/25166) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 将后台调度池大小增加到 128（`background_schedule_pool_size` 设置）。这可以避免在 ZooKeeper 连接较慢时复制队列发生阻塞。[#25072](https://github.com/ClickHouse/ClickHouse/pull/25072) ([alesapin](https://github.com/alesapin))。
* 添加合并树设置 `max_parts_to_merge_at_once`，用于限制后台一次可合并的数据部分数量。不影响 `OPTIMIZE FINAL` 查询。修复 [#1820](https://github.com/ClickHouse/ClickHouse/issues/1820)。[#24496](https://github.com/ClickHouse/ClickHouse/pull/24496)（[alesapin](https://github.com/alesapin)）。
* 允许在分区剪枝中使用 `NOT IN` 运算符。[#24894](https://github.com/ClickHouse/ClickHouse/pull/24894) ([Amos Bird](https://github.com/amosbird))。
* 将 `127.0.1.1` 等 IPv4 地址识别为本地地址。此变更存在争议，并据此关闭了 [#23504](https://github.com/ClickHouse/ClickHouse/issues/23504)。Michael Filimonov 将测试此功能。[#24316](https://github.com/ClickHouse/ClickHouse/pull/24316)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 使用 MaterializeMySQL 创建的 ClickHouse 数据库（这是一个实验性功能）现在包含来自已物化 MySQL 数据库的所有列注释。[#25199](https://github.com/ClickHouse/ClickHouse/pull/25199) ([Storozhuk Kostiantyn](https://github.com/sand6255))。
* 为 MySQL 存储引擎添加设置（`connection_auto_close`/`connection_max_tries`/`connection_pool_size`）。[#24146](https://github.com/ClickHouse/ClickHouse/pull/24146) ([Azat Khuzhin](https://github.com/azat))。
* 缩短 Distributed 引擎的启动时间。[#25663](https://github.com/ClickHouse/ClickHouse/pull/25663) ([Azat Khuzhin](https://github.com/azat)).
* 针对 Distributed 表的改进。对于 internal&#95;replication=true，从目录名 dirname 中移除副本信息（允许在具有任意数量副本的集群上向 Distributed 表执行 INSERT；此前仅支持最多 15 个副本，超过时在为异步块创建目录时会因目录名过长（ENAMETOOLONG）而失败）。 [#25513](https://github.com/ClickHouse/ClickHouse/pull/25513) ([Azat Khuzhin](https://github.com/azat)).
* 为 `LowCardinality` 新增对 `Interval` 类型的支持。这是某些表达式中间值所必需的。修复了 [#21730](https://github.com/ClickHouse/ClickHouse/issues/21730)。[#25410](https://github.com/ClickHouse/ClickHouse/pull/25410)（[Vladimir](https://github.com/vdimir)）。
* 在 `sequenceMatch` 和 `sequenceCount` 函数的时间条件中添加对 `==` 运算符的支持。例如：sequenceMatch(&#39;(?1)(?t==1)(?2)&#39;)(time, data = 1, data = 2)。[#25299](https://github.com/ClickHouse/ClickHouse/pull/25299) ([Christophe Kalenzaga](https://github.com/mga-chka))。
* 新增设置项 `http_max_fields`、`http_max_field_name_size`、`http_max_field_value_size`。 [#25296](https://github.com/ClickHouse/ClickHouse/pull/25296) ([Ivan](https://github.com/abyss7))。
* 为 `if` 函数的分支添加对 `Decimal` 和 `Int` 类型的支持。关闭了 [#20549](https://github.com/ClickHouse/ClickHouse/issues/20549)。关闭了 [#10142](https://github.com/ClickHouse/ClickHouse/issues/10142)。[#25283](https://github.com/ClickHouse/ClickHouse/pull/25283)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 更新 `clickhouse-client` 中的提示符，并在重新连接时显示一条消息，从而解决 [#10577](https://github.com/ClickHouse/ClickHouse/issues/10577) 问题。[#25281](https://github.com/ClickHouse/ClickHouse/pull/25281)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复聚合函数 `topK` 中的内存跟踪问题，解决了 [#25259](https://github.com/ClickHouse/ClickHouse/issues/25259)。[#25260](https://github.com/ClickHouse/ClickHouse/pull/25260)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复对 IDN 主机（即 `example.рф`）的 `topLevelDomain` 处理，此前对于此类主机会返回空字符串。[#25103](https://github.com/ClickHouse/ClickHouse/pull/25103) ([Azat Khuzhin](https://github.com/azat))。
* 在运行时检测 Linux 内核版本（用于启用可用的嵌套 epoll，这是 `async_socket_for_remote`/`use_hedged_requests` 所必需的，否则远程查询可能会卡住）。[#25067](https://github.com/ClickHouse/ClickHouse/pull/25067) ([Azat Khuzhin](https://github.com/azat))。
* 对于分布式查询，当 `optimize_skip_unused_shards=1` 时，允许在条件为 `(sharding key) IN (one-element-tuple)` 的情况下跳过分片。（此前已支持多元素元组，但单元素元组不起作用，因为它会被解析为字面量）。[#24930](https://github.com/ClickHouse/ClickHouse/pull/24930) ([Amos Bird](https://github.com/amosbird))。
* 改进了 S3 错误的日志记录，在 key 和 bucket 为空时不再出现多余空格。 [#24897](https://github.com/ClickHouse/ClickHouse/pull/24897) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 某些查询需要多轮语义分析。在这种情况下，可以尝试重用已为 `IN` 构建的集合。[#24874](https://github.com/ClickHouse/ClickHouse/pull/24874) ([Amos Bird](https://github.com/amosbird))。
* 使 `insert_distributed_sync` 遵守 `max_distributed_connections`（否则在超大集群和同步写入的情况下，可能会耗尽 `max_thread_pool_size`）。 [#24754](https://github.com/ClickHouse/ClickHouse/pull/24754) ([Azat Khuzhin](https://github.com/azat)).
* 避免在标量子查询中隐藏类似 `Limit for rows or bytes to read exceeded` 的错误。[#24545](https://github.com/ClickHouse/ClickHouse/pull/24545) ([nvartolomei](https://github.com/nvartolomei))。
* 使字符串转整数解析器更严格，使得 `toInt64('+')` 会抛出异常。[#24475](https://github.com/ClickHouse/ClickHouse/pull/24475)（[Amos Bird](https://github.com/amosbird)）。
* 如果使用 DDL 查询创建 `SSD_CACHE`，则只能在 `user_files` 目录下创建。[#24466](https://github.com/ClickHouse/ClickHouse/pull/24466) ([Maksim Kita](https://github.com/kitaisreal))。
* 在 PostgreSQL 插入查询中支持指定非默认 schema。解决 [#24149](https://github.com/ClickHouse/ClickHouse/issues/24149)。[#24413](https://github.com/ClickHouse/ClickHouse/pull/24413)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复 IPv6 地址解析问题（例如修复 `select * from remote('[::1]', system.one)`）。[#24319](https://github.com/ClickHouse/ClickHouse/pull/24319)（[Azat Khuzhin](https://github.com/azat)）。
* 修复多行模式下包含子查询的 FROM 子句中的行尾空格问题，并略微调整查询的输出，使其更便于阅读。[#24151](https://github.com/ClickHouse/ClickHouse/pull/24151) ([Azat Khuzhin](https://github.com/azat))。
* 对 Distributed 表进行了改进。新增在失败时拆分分布式批处理的功能（例如因内存限制或数据损坏），通过 `distributed_directory_monitor_split_batch_on_failure` 控制（默认关闭）。[#23864](https://github.com/ClickHouse/ClickHouse/pull/23864)（[Azat Khuzhin](https://github.com/azat)）。
* 处理 `Join` 表引擎中的列名冲突问题。修复了 [#20309](https://github.com/ClickHouse/ClickHouse/issues/20309)。[#23769](https://github.com/ClickHouse/ClickHouse/pull/23769)（[Vladimir](https://github.com/vdimir)）。
* 当数据通过 stdin 传入时，在 `clickhouse-local` 中的 `File` 表引擎以及在 `clickhouse-client` 中的 INSERT 查询中显示进度。解决了 [#18209](https://github.com/ClickHouse/ClickHouse/issues/18209)。 [#23656](https://github.com/ClickHouse/ClickHouse/pull/23656) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 对 `clickhouse-copier` 进行了缺陷修复和改进。允许在源表和目标表结构不同（但兼容）的情况下进行表复制。修复 [#9159](https://github.com/ClickHouse/ClickHouse/issues/9159)。添加了用于复制 ReplacingMergeTree 的测试。修复 [#22711](https://github.com/ClickHouse/ClickHouse/issues/22711)。支持列上的 TTL 和 Data Skipping Indices。其实现方式是：在创建内部 Distributed 表时简单地移除它们（底层表仍然保留 TTL 和 skipping indices）。修复 [#19384](https://github.com/ClickHouse/ClickHouse/issues/19384)。允许复制 MATERIALIZED 和 ALIAS 列。在某些情况下这会很有用（例如当该列在 PRIMARY KEY 中时）。现在可以通过在任务配置中将 `allow_to_copy_alias_and_materialized_columns` 属性设为 true 来启用。修复 [#9177](https://github.com/ClickHouse/ClickHouse/issues/9177)。修复 [#11007] ([https://github.com/ClickHouse/ClickHouse/issues/11007](https://github.com/ClickHouse/ClickHouse/issues/11007))。修复 [#9514](https://github.com/ClickHouse/ClickHouse/issues/9514)。在任务配置中添加了属性 `allow_to_drop_target_partitions`，以便在移动辅助表之前先删除原始表中的分区。修复 [#20957](https://github.com/ClickHouse/ClickHouse/issues/20957)。移除了对 `OPTIMIZE DEDUPLICATE` 查询的使用。此前需要这个 hack，是因为 `ALTER TABLE MOVE PARTITION` 会被多次重试，而普通 MergeTree 表没有去重能力。修复 [#17966](https://github.com/ClickHouse/ClickHouse/issues/17966)。以 JSON 格式将进度写入路径为 `task_path + /status` 的 ZooKeeper 节点。修复 [#20955](https://github.com/ClickHouse/ClickHouse/issues/20955)。支持无参数的 ReplicatedTables。修复 [#24834](https://github.com/ClickHouse/ClickHouse/issues/24834) .[#23518](https://github.com/ClickHouse/ClickHouse/pull/23518) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 在 S3 读取重试之间增加了带退避的休眠间隔。 [#23461](https://github.com/ClickHouse/ClickHouse/pull/23461) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 在对 `Distributed` 表执行 INSERT 时，遵守 `insert_allow_materialized_columns` 设置（允许物化列）。[#23349](https://github.com/ClickHouse/ClickHouse/pull/23349) ([Azat Khuzhin](https://github.com/azat)).
* 为分布式查询添加了下推 `LIMIT` 的支持。 [#23027](https://github.com/ClickHouse/ClickHouse/pull/23027) ([Azat Khuzhin](https://github.com/azat)).
* 修复在使用多个 S3 卷时的零拷贝复制问题（修复 [#22679](https://github.com/ClickHouse/ClickHouse/issues/22679)）。[#22864](https://github.com/ClickHouse/ClickHouse/pull/22864)（[ianton-ru](https://github.com/ianton-ru)）。
* 当用户向操作系统请求任意可用端口时，解析出实际绑定的端口号，并在日志消息中显示该端口号。[#25569](https://github.com/ClickHouse/ClickHouse/pull/25569) ([bnaecker](https://github.com/bnaecker)).
* 修复了在某些情况下将 Postgres 数组转换为 String 数据类型而非 n 维数组的问题，原因是 `attndims` 在部分场景下工作不正确。关闭了 [#24804](https://github.com/ClickHouse/ClickHouse/issues/24804)。[#25538](https://github.com/ClickHouse/ClickHouse/pull/25538)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复 MySQL、PostgreSQL、ODBC 的带时区 `DateTime` 转换问题。关闭 [#5057](https://github.com/ClickHouse/ClickHouse/issues/5057)。[#25528](https://github.com/ClickHouse/ClickHouse/pull/25528)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 针对不同的表区分 KILL MUTATION（修复意外出现的 `Cancelled mutating parts` 错误）。[#25025](https://github.com/ClickHouse/ClickHouse/pull/25025) ([Azat Khuzhin](https://github.com/azat)).
* 允许在 bucket 的根目录声明 S3 磁盘（S3 虚拟文件系统是一个正在开发中的实验性功能）。[#24898](https://github.com/ClickHouse/ClickHouse/pull/24898) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 为分布式表启用读取子列功能（例如 Tuple 的各个组成部分）。 [#24472](https://github.com/ClickHouse/ClickHouse/pull/24472) ([Anton Popov](https://github.com/CurtizJ)).
* 用于 MySQL 兼容协议的功能：使 `user` 函数返回正确的结果。关闭 [#25697](https://github.com/ClickHouse/ClickHouse/pull/25697)。 [#25697](https://github.com/ClickHouse/ClickHouse/pull/25697) ([sundyli](https://github.com/sundy-li))。

#### 错误修复 {#bug-fix-3}


* 提升向后兼容性。在分区键中使用时，采用旧版本的取模函数。修复 [#23508](https://github.com/ClickHouse/ClickHouse/issues/23508)。 [#24157](https://github.com/ClickHouse/ClickHouse/pull/24157)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复了在低内存服务器上极其罕见的 bug，该问题可能会导致在重启之前无法执行合并操作。可能修复了 [#24603](https://github.com/ClickHouse/ClickHouse/issues/24603)。[#24872](https://github.com/ClickHouse/ClickHouse/pull/24872) ([alesapin](https://github.com/alesapin))。
* 修复在并发执行 `alter move/replace partition` 时，复制队列中极其罕见的错误 `Tagging already tagged part`。可能已修复 [#22142](https://github.com/ClickHouse/ClickHouse/issues/22142)。[#24961](https://github.com/ClickHouse/ClickHouse/pull/24961)（[alesapin](https://github.com/alesapin)）。
* 修复在通过聚合其他聚合函数的状态来计算聚合函数状态时可能发生的崩溃（这并不是一个实际的使用场景）。参见 [#24523](https://github.com/ClickHouse/ClickHouse/issues/24523)。[#25015](https://github.com/ClickHouse/ClickHouse/pull/25015)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在执行 `SYSTEM RESTART REPLICA` 或 `SYSTEM SYNC REPLICA` 查询时可能无法完成的问题。该问题是在内存（RAM）极其紧张的服务器上发现的。[#24457](https://github.com/ClickHouse/ClickHouse/pull/24457) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 修复了可能导致 ZooKeeper 客户端在 clickhouse-server 中挂起的 Bug。 [#24721](https://github.com/ClickHouse/ClickHouse/pull/24721) ([alesapin](https://github.com/alesapin)).
* 如果 ZooKeeper 连接丢失，并且在恢复连接后克隆了副本，其复制队列中可能包含过时的记录。修复了在复制队列包含相互交叠的虚拟数据部分时触发断言失败的问题。如果某些数据部分丢失，这种情况在极少数情况下可能发生。现在改为在日志中打印错误而不是直接终止进程。 [#24777](https://github.com/ClickHouse/ClickHouse/pull/24777) ([tavplubix](https://github.com/tavplubix))。
* 修复在查询计划的表达式下推优化中导致 `WHERE` 条件丢失的问题（并将 `query_plan_filter_push_down` 默认设置为 1）。修复了 [#25368](https://github.com/ClickHouse/ClickHouse/issues/25368)。[#25370](https://github.com/ClickHouse/ClickHouse/pull/25370)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了一个错误，该错误在带 TTL 的合并后可能导致分片发生重叠：`Part all_40_40_0 is covered by all_40_40_1 but should be merged into all_40_41_1. This shouldn't happen often.`。[#25549](https://github.com/ClickHouse/ClickHouse/pull/25549) ([alesapin](https://github.com/alesapin))。
* 在 ZooKeeper 连接丢失时，`ReplicatedMergeTree` 表可能会在尝试重新连接之前等待后台任务完成。该问题已修复，现在会强制停止后台任务。[#25306](https://github.com/ClickHouse/ClickHouse/pull/25306) ([tavplubix](https://github.com/tavplubix))。
* 修复当主键中使用数组时，包含 `ARRAY JOIN` 的查询会出现错误 `Key expression contains comparison between inconvertible types` 的问题。修复了 [#8247](https://github.com/ClickHouse/ClickHouse/issues/8247)。[#25546](https://github.com/ClickHouse/ClickHouse/pull/25546)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复了查询 `WITH TOTALS` 和 `WITH FILL` 的错误总计值。修复了 [#20872](https://github.com/ClickHouse/ClickHouse/issues/20872)。[#25539](https://github.com/ClickHouse/ClickHouse/pull/25539)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复在重新加载集群配置的同时查询 `system.clusters` 时发生的数据竞争问题。 [#25737](https://github.com/ClickHouse/ClickHouse/pull/25737) ([Amos Bird](https://github.com/amosbird)).
* 修复了在数据库之间移动 `Distributed` 表时出现的 `No such file or directory` 错误。修复了 [#24971](https://github.com/ClickHouse/ClickHouse/issues/24971)。[#25667](https://github.com/ClickHouse/ClickHouse/pull/25667)（[tavplubix](https://github.com/tavplubix)）。
* 在极少数情况下，如果源分区为空，`REPLACE PARTITION` 可能会被忽略。现已修复该问题。修复了 [#24869](https://github.com/ClickHouse/ClickHouse/issues/24869)。[#25665](https://github.com/ClickHouse/ClickHouse/pull/25665)（[tavplubix](https://github.com/tavplubix)）。
* 修复了 `Replicated` 数据库引擎中的一个错误，该错误在极少数情况下可能导致某个副本跳过队列中的 DDL 查询。[#24805](https://github.com/ClickHouse/ClickHouse/pull/24805) ([tavplubix](https://github.com/tavplubix))。
* 修复在未指定查询时 `EXPLAIN AST` 中的空指针解引用问题。 [#25631](https://github.com/ClickHouse/ClickHouse/pull/25631) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复对自动删除空数据片段的等待逻辑。这可能会导致后台任务池被完全占用并阻塞复制过程。[#23315](https://github.com/ClickHouse/ClickHouse/pull/23315) ([Anton Popov](https://github.com/CurtizJ))。
* 修复在 S3 虚拟文件系统中存储的表的恢复功能（该功能为实验性特性，尚不适合在生产环境中使用）。[#25601](https://github.com/ClickHouse/ClickHouse/pull/25601) ([ianton-ru](https://github.com/ianton-ru)).
* 修复在 `Arrow` 格式中使用 `Decimal256` 时的 `nullptr` 解引用问题。为 `Arrow` 格式添加对 `Decimal256` 的支持。[#25531](https://github.com/ClickHouse/ClickHouse/pull/25531) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复预处理配置文件名称中多余的下划线。 [#25431](https://github.com/ClickHouse/ClickHouse/pull/25431) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复 `clickhouse-copier` 工具：解决在复制任务配置中缺少 sharding&#95;key 时发生段错误的问题。[#25419](https://github.com/ClickHouse/ClickHouse/pull/25419) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 通过为格式化查询正确加引号，修复了在 DDL 中使用时 `REPLACE` 列转换器的问题。此修复解决了 [#23925](https://github.com/ClickHouse/ClickHouse/issues/23925)。[#25391](https://github.com/ClickHouse/ClickHouse/pull/25391)（[Amos Bird](https://github.com/amosbird)）。
* 修复了 `quantileDeterministic` 函数及类似函数中潜在的非确定性行为问题。此更改解决了 [#20480](https://github.com/ClickHouse/ClickHouse/issues/20480)。[#25313](https://github.com/ClickHouse/ClickHouse/pull/25313)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 `SummingMergeTree` 中增加对 `SimpleAggregateFunction(LowCardinality)` 的支持。修复了 [#25134](https://github.com/ClickHouse/ClickHouse/issues/25134)。[#25300](https://github.com/ClickHouse/ClickHouse/pull/25300)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复逻辑错误，其异常信息为 &quot;Cannot sum Array/Tuple in min/maxMap&quot;。[#25298](https://github.com/ClickHouse/ClickHouse/pull/25298) ([Kruglov Pavel](https://github.com/Avogar))。
* 修复在 IN 子句中使用 `LowCardinality` 参数时出现的错误 `Bad cast from type DB::ColumnLowCardinality to DB::ColumnVector<char8_t>`（该错误首次出现在 21.6 版本中）。修复了 [#25187](https://github.com/ClickHouse/ClickHouse/issues/25187)。[#25290](https://github.com/ClickHouse/ClickHouse/pull/25290)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复 `joinGetOrNull` 在非 Nullable 列上的不正确行为。此更改修复了 [#24261](https://github.com/ClickHouse/ClickHouse/issues/24261)。[#25288](https://github.com/ClickHouse/ClickHouse/pull/25288)（[Amos Bird](https://github.com/amosbird)）。
* 修复大整数中的错误行为并消除 UBSan 报告。在早期版本中，`CAST(1e19 AS UInt128)` 会返回零。[#25279](https://github.com/ClickHouse/ClickHouse/pull/25279)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在使用 CSVWithNames 格式插入部分列时出现的错误。修复 [#25129](https://github.com/ClickHouse/ClickHouse/issues/25129)。[#25169](https://github.com/ClickHouse/ClickHouse/pull/25169)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 不要在带 `FINAL` 的 `SELECT` 查询中使用表的投影。目前尚不支持该用法。[#25163](https://github.com/ClickHouse/ClickHouse/pull/25163) ([Amos Bird](https://github.com/amosbird))。
* 修复在升级到 21.5 后，如果表在分区键中使用了 `UUID`，可能导致部分数据丢失的问题。（不建议在分区键中使用 `UUID`）。修复了 [#25070](https://github.com/ClickHouse/ClickHouse/issues/25070)。[#25127](https://github.com/ClickHouse/ClickHouse/pull/25127)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在 `joined_subquery_requires_alias = 0` 时执行包含 CROSS JOIN 的查询时发生的崩溃问题。修复了 [#24011](https://github.com/ClickHouse/ClickHouse/issues/24011)。[#25082](https://github.com/ClickHouse/ClickHouse/pull/25082)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了 `mapContains` 函数在处理常量 Map 时会触发错误 `empty column was returned by function mapContains` 的问题。关闭 [#25077](https://github.com/ClickHouse/ClickHouse/issues/25077)。[#25080](https://github.com/ClickHouse/ClickHouse/pull/25080)（[Kruglov Pavel](https://github.com/Avogar)）。
* 禁止创建包含自引用列的表，例如 `a UInt32 ALIAS a + 1` 或 `b UInt32 MATERIALIZED b`。修复了 [#24910](https://github.com/ClickHouse/ClickHouse/issues/24910)、[#24292](https://github.com/ClickHouse/ClickHouse/issues/24292)。[#25059](https://github.com/ClickHouse/ClickHouse/pull/25059)（[alesapin](https://github.com/alesapin)）。
* 修复在使用带有*非空* `GROUP BY` 键的聚合投影来执行按*空*键进行 `GROUP BY` 分组的查询时产生错误结果的问题。 [#25055](https://github.com/ClickHouse/ClickHouse/pull/25055) ([Amos Bird](https://github.com/amosbird)).
* 修复 Protobuf 格式中被拆分的嵌套消息的序列化。本 PR 修复了 [#24647](https://github.com/ClickHouse/ClickHouse/issues/24647)。[#25000](https://github.com/ClickHouse/ClickHouse/pull/25000)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复分布式查询的 limit/offset 设置（在远程节点上忽略这些设置）。[#24940](https://github.com/ClickHouse/ClickHouse/pull/24940) ([Azat Khuzhin](https://github.com/azat))。
* 修复 `Arrow` 格式中可能出现的堆缓冲区溢出（heap-buffer-overflow）。 [#24922](https://github.com/ClickHouse/ClickHouse/pull/24922) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复了从 DiskS3 读取文件时可能出现的错误 &#39;Cannot read from istream at offset 0&#39;（S3 虚拟文件系统是一项正在开发中的实验性功能，不应在生产环境中使用）。 [#24885](https://github.com/ClickHouse/ClickHouse/pull/24885) ([Pavel Kovalenko](https://github.com/Jokser))。
* 修复在联接分布式物化视图时出现的 “Missing columns” 异常。[#24870](https://github.com/ClickHouse/ClickHouse/pull/24870) ([Azat Khuzhin](https://github.com/azat))。
* 在 PostgreSQL 兼容协议中允许使用 `NULL` 值。解决了 [#22622](https://github.com/ClickHouse/ClickHouse/issues/22622)。[#24857](https://github.com/ClickHouse/ClickHouse/pull/24857)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复了一个错误：在等待变更完成时，如果该变更尚未加载到内存中，可能会向客户端抛出 `Mutation was killed` 异常。 [#24809](https://github.com/ClickHouse/ClickHouse/pull/24809) ([alesapin](https://github.com/alesapin)).
* 修复了随机数生成器状态反序列化中的一个缺陷，该缺陷可能导致某些数据类型（例如 `AggregateFunction(groupArraySample(N), T))`）出现非确定性行为。 [#24538](https://github.com/ClickHouse/ClickHouse/pull/24538) ([tavplubix](https://github.com/tavplubix)).
* 禁止对其他聚合状态构建 uniqXXXXStates。 [#24523](https://github.com/ClickHouse/ClickHouse/pull/24523)（[Raúl Marín](https://github.com/Algunenano)）。随后通过真正消除相关问题的根本原因，再次允许这样做。（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在 `CREATE .. AS SELECT` 查询中对元组的用法。[#24464](https://github.com/ClickHouse/ClickHouse/pull/24464) ([Anton Popov](https://github.com/CurtizJ)).
* 修复 `Buffer` 表中总字节数的计算。在当前 ClickHouse 版本中，total&#95;writes.bytes 计数器在缓冲区刷新期间减少得过多，这会导致计数器溢出，并在刷新一段时间后使 totalBytes 返回大约 17.44 EB。[#24450](https://github.com/ClickHouse/ClickHouse/pull/24450)（[DimasKovas](https://github.com/DimasKovas)）。
* 修正关于 `toWeek` 函数单调性的错误说明。此修复解决了 [#24422](https://github.com/ClickHouse/ClickHouse/issues/24422)。该缺陷最初在 [https://github.com/ClickHouse/ClickHouse/pull/5212](https://github.com/ClickHouse/ClickHouse/pull/5212) 中被引入，随后被更智能的分区裁剪器暴露出来。[#24446](https://github.com/ClickHouse/ClickHouse/pull/24446)（[Amos Bird](https://github.com/amosbird)）。
* 当用户通过 LDAP 进行身份验证时，修复了在 LDAP 角色（重新）映射期间，当 LDAP 组被映射到不存在的本地角色时可能发生的死锁问题。[#24431](https://github.com/ClickHouse/ClickHouse/pull/24431) ([Denis Glazachev](https://github.com/traceon))。
* 在“multipart/form-data”消息中，将边界前的 CRLF 视为边界的一部分。修复了 [#23905](https://github.com/ClickHouse/ClickHouse/issues/23905)。[#24399](https://github.com/ClickHouse/ClickHouse/pull/24399)（[Ivan](https://github.com/abyss7)）。
* 修复在执行 DROP PARTITION 时与伪数据部分相交的问题。在极少数情况下，可能会存在 mutation 版本号大于当前块编号的数据部分。[#24321](https://github.com/ClickHouse/ClickHouse/pull/24321) ([Amos Bird](https://github.com/amosbird)).
* 修复了使用 `RENAME TABLE` 查询将物化视图从 Ordinary 数据库移动到 Atomic 数据库时的一个错误。现在内部表会连同物化视图一起被移动到新的数据库中。修复了 [#23926](https://github.com/ClickHouse/ClickHouse/issues/23926)。[#24309](https://github.com/ClickHouse/ClickHouse/pull/24309)（[tavplubix](https://github.com/tavplubix)）。
* 允许空的 HTTP 头部。修复 [#23901](https://github.com/ClickHouse/ClickHouse/issues/23901)。[#24285](https://github.com/ClickHouse/ClickHouse/pull/24285)（[Ivan](https://github.com/abyss7)）。
* 在 Memory 表中正确处理变更操作（ALTER UPDATE/DELETE）。关闭 [#24274](https://github.com/ClickHouse/ClickHouse/issues/24274)。[#24275](https://github.com/ClickHouse/ClickHouse/pull/24275)（[flynn](https://github.com/ucasfl)）。
* 使 JOIN 输出中的列具有与输入相同的 LowCardinality 属性，修复 [#23351](https://github.com/ClickHouse/ClickHouse/issues/23351)、[#20315](https://github.com/ClickHouse/ClickHouse/issues/20315)。 [#24061](https://github.com/ClickHouse/ClickHouse/pull/24061) ([Vladimir](https://github.com/vdimir))。
* 针对 Kafka 表的修复。修复了 Engine = Kafka 的故障转移行为中的一个错误：当同一 consumer 之前曾有空的 assignment 时，无法开始消费。关闭 [#21118](https://github.com/ClickHouse/ClickHouse/issues/21118)。[#21267](https://github.com/ClickHouse/ClickHouse/pull/21267)（[filimonov](https://github.com/filimonov)）。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-4}

- 在 CI 中添加 `darwin-aarch64`(Mac M1 / Apple Silicon)构建 [#25560](https://github.com/ClickHouse/ClickHouse/pull/25560)([Ivan](https://github.com/abyss7)),并将链接添加到文档和网站([alexey-milovidov](https://github.com/alexey-milovidov))。
- 添加跨平台的二进制资源嵌入可执行文件功能。支持在 Illumos 上运行。[#25146](https://github.com/ClickHouse/ClickHouse/pull/25146)([bnaecker](https://github.com/bnaecker))。
- 在压力测试中添加 join 相关选项以改进模糊测试。[#25200](https://github.com/ClickHouse/ClickHouse/pull/25200)([Vladimir](https://github.com/vdimir))。
- 在 osx 中启用 s3 模块构建 [#25217](https://github.com/ClickHouse/ClickHouse/issues/25217)。[#25218](https://github.com/ClickHouse/ClickHouse/pull/25218)([kevin wan](https://github.com/MaxWk))。
- 添加集成测试用例以覆盖 JDBC 桥接。[#25047](https://github.com/ClickHouse/ClickHouse/pull/25047)([Zhichun Wu](https://github.com/zhicwu))。
- 集成测试配置对字典进行了特殊处理。移除了剩余的字典手动设置。[#24728](https://github.com/ClickHouse/ClickHouse/pull/24728)([Ilya Yatsishin](https://github.com/qoega))。
- 为 YAMLParser 类添加 libfuzzer 测试。[#24480](https://github.com/ClickHouse/ClickHouse/pull/24480)([BoloniniD](https://github.com/BoloniniD))。
- 现在使用 Ubuntu 20.04 运行集成测试,用于运行集成测试的 docker-compose 版本已更新至 1.28.2。环境变量现在在 docker-compose 中生效。重构 test_dictionaries_all_layouts_separate_sources 以支持并行运行。[#20393](https://github.com/ClickHouse/ClickHouse/pull/20393)([Ilya Yatsishin](https://github.com/qoega))。
- 修复安装脚本中的 TOCTOU 错误。[#25277](https://github.com/ClickHouse/ClickHouse/pull/25277)([alexey-milovidov](https://github.com/alexey-milovidov))。

### ClickHouse 版本 21.6,2021-06-05 {#clickhouse-release-216-2021-06-05}

#### 向后不兼容的变更 {#backward-incompatible-change-5}

- uniqState / uniqHLL12State / uniqCombinedState / uniqCombined64State 对 `UUID` 类型产生不兼容的状态。[#33607](https://github.com/ClickHouse/ClickHouse/issues/33607)。

#### 升级说明 {#upgrade-notes-1}

- `zstd` 压缩库已更新至 v1.5.0。您可能会在复制过程中收到"校验和不匹配"的消息。由于压缩算法的更新,这些消息是预期的,您可以忽略它们。这些消息仅供参考,不表示任何异常行为。
- 设置 `compile_expressions` 默认启用。尽管已在各种场景下进行了充分测试,但如果您在服务器上发现任何异常行为,可以尝试关闭此设置。
- `UUID` 类型的值不能与整数进行比较。例如,应使用 `uuid != '00000000-0000-0000-0000-000000000000'` 而不是 `uuid != 0`。

#### 新功能 {#new-feature-5}


* 添加类似 PostgreSQL 风格的类型转换运算符（`::`）。例如：`[1, 2]::Array(UInt8)`、`0.1::Decimal(4, 4)`、`number::UInt16`。[#23871](https://github.com/ClickHouse/ClickHouse/pull/23871)（[Anton Popov](https://github.com/CurtizJ)）。
* 使大整数功能达到生产可用级别。增加对 `UInt128` 数据类型的支持。修复 `Decimal256` 数据类型的已知问题。在字典中支持大整数。在 `gcd`/`lcm` 函数中支持大整数。在数组搜索和条件函数中支持大整数。支持 `LowCardinality(UUID)`。在 `generateRandom` 表函数和 `clickhouse-obfuscator` 中支持大整数。修复从标量子查询返回 `UUID` 时的错误。修复 [#7834](https://github.com/ClickHouse/ClickHouse/issues/7834)。修复 [#23936](https://github.com/ClickHouse/ClickHouse/issues/23936)。修复 [#4176](https://github.com/ClickHouse/ClickHouse/issues/4176)。修复 [#24018](https://github.com/ClickHouse/ClickHouse/issues/24018)。不向后兼容的变更：`UUID` 类型的值不能再与整数进行比较。例如，应将 `uuid != 0` 改为 `uuid != '00000000-0000-0000-0000-000000000000'`。[#23631](https://github.com/ClickHouse/ClickHouse/pull/23631)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 支持在 `Arrow`、`Parquet` 和 `ORC` 格式中插入和查询数据时使用 `Array` 数据类型。 [#21770](https://github.com/ClickHouse/ClickHouse/pull/21770) ([taylor12805](https://github.com/taylor12805)).
* 实现表注释支持。关闭 [#23225](https://github.com/ClickHouse/ClickHouse/issues/23225)。[#23548](https://github.com/ClickHouse/ClickHouse/pull/23548)（[flynn](https://github.com/ucasFL)）。
* 在 `clickhouse-local` 中支持使用 DDL 查询创建字典。关闭了 [#22354](https://github.com/ClickHouse/ClickHouse/issues/22354)。新增对 `DETACH DICTIONARY PERMANENTLY` 的支持。为 `Atomic` 数据库引擎新增对 `EXCHANGE DICTIONARIES` 的支持。新增使用 `RENAME DICTIONARY` 在数据库之间移动字典的支持。[#23436](https://github.com/ClickHouse/ClickHouse/pull/23436)（[Maksim Kita](https://github.com/kitaisreal)）。
* 在 ClickHouse 中添加聚合函数 `uniqTheta`，以支持 [Theta Sketch](https://datasketches.apache.org/docs/Theta/ThetaSketchFramework.html)。[#23894](https://github.com/ClickHouse/ClickHouse/pull/23894)。[#22609](https://github.com/ClickHouse/ClickHouse/pull/22609)（[Ping Yu](https://github.com/pingyu)）。
* 新增函数 `splitByRegexp`。 [#24077](https://github.com/ClickHouse/ClickHouse/pull/24077) ([abel-cheng](https://github.com/abel-cheng))。
* 添加函数 `arrayProduct`，该函数接受一个数组作为参数，并返回数组中所有元素的乘积。解决 [#21613](https://github.com/ClickHouse/ClickHouse/issues/21613)。[#23782](https://github.com/ClickHouse/ClickHouse/pull/23782)（[Maksim Kita](https://github.com/kitaisreal)）。
* 在 `system.stack_trace` 中添加 `thread_name` 列。此更改解决了 [#23256](https://github.com/ClickHouse/ClickHouse/issues/23256)。[#24124](https://github.com/ClickHouse/ClickHouse/pull/24124)（[abel-cheng](https://github.com/abel-cheng)）。
* 将 `insert_null_as_default` 设置为 1 时，在 `INSERT ... SELECT` 和 `INSERT ... SELECT ... UNION ALL ...` 查询中会插入默认值而不是 NULL。修复 [#22832](https://github.com/ClickHouse/ClickHouse/issues/22832)。[#23524](https://github.com/ClickHouse/ClickHouse/pull/23524)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 为 `clickhouse-local` 添加使用 `--progress` 选项显示进度的支持。 [#23196](https://github.com/ClickHouse/ClickHouse/pull/23196) ([Egor Savin](https://github.com/Amesaru))。
* 在 `http` 字典源中添加对 HTTP 压缩的支持（由 `Content-Encoding` HTTP 头部决定）。修复了 [#8912](https://github.com/ClickHouse/ClickHouse/issues/8912)。[#23946](https://github.com/ClickHouse/ClickHouse/pull/23946)（[FArthur-cmd](https://github.com/FArthur-cmd)）。
* 新增 `SYSTEM QUERY RELOAD MODEL` 和 `SYSTEM QUERY RELOAD MODELS`。修复 [#18722](https://github.com/ClickHouse/ClickHouse/issues/18722)。[#23182](https://github.com/ClickHouse/ClickHouse/pull/23182)（[Maksim Kita](https://github.com/kitaisreal)）。
* 为 `EXPLAIN PLAN` 查询新增名为 `json` 的设置（布尔值，默认值为 0）。启用后，查询输出将为单行 `JSON`。建议使用 `TSVRaw` 格式以避免不必要的转义。[#23082](https://github.com/ClickHouse/ClickHouse/pull/23082)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 为 `EXPLAIN PIPELINE` 查询新增 `indexes` 配置项（布尔类型，默认关闭）。启用后，会显示实际使用的索引，以及每个已应用索引所过滤的分片（parts）和粒度（granules）数量。支持 `MergeTree*` 表。[#22352](https://github.com/ClickHouse/ClickHouse/pull/22352)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* LDAP：实现了用户 DN 检测功能，用于在将 Active Directory 组映射到 ClickHouse 角色时使用。 [#22228](https://github.com/ClickHouse/ClickHouse/pull/22228) ([Denis Glazachev](https://github.com/traceon)).
* 新聚合函数 `deltaSumTimestamp`，用于对连续行之间的差值求和，并通过存储时间戳在合并时保持顺序。[#21888](https://github.com/ClickHouse/ClickHouse/pull/21888) ([Russ Frank](https://github.com/rf))。
* 为 S3 添加了安全性较低的 IMDS 凭证提供程序，该提供程序在 Docker 环境下能够正常工作。 [#21852](https://github.com/ClickHouse/ClickHouse/pull/21852) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 恢复 `indexHint` 函数。此更改对应 [#21238](https://github.com/ClickHouse/ClickHouse/issues/21238)。此次变更回滚了 [#9542](https://github.com/ClickHouse/ClickHouse/pull/9542)，并修复了 [#9540](https://github.com/ClickHouse/ClickHouse/issues/9540)。[#21304](https://github.com/ClickHouse/ClickHouse/pull/21304)（[Amos Bird](https://github.com/amosbird)）。

#### 实验性功能 {#experimental-feature-5}

- 为 `MergeTree*` 表添加 `PROJECTION` 支持。[#20202](https://github.com/ClickHouse/ClickHouse/pull/20202) ([Amos Bird](https://github.com/amosbird))。

#### 性能改进 {#performance-improvement-5}

- 默认启用 `compile_expressions` 设置。启用此设置后,简单函数和运算符的组合将在运行时通过 LLVM 编译为原生代码。[#8482](https://github.com/ClickHouse/ClickHouse/pull/8482) ([Maksim Kita](https://github.com/kitaisreal), [alexey-milovidov](https://github.com/alexey-milovidov))。注意:如果遇到问题,请关闭此选项。
- 更新 `re2` 库。正则表达式匹配性能得到改进。此外,此 PR 添加了对 gcc-11 的兼容性。[#24196](https://github.com/ClickHouse/ClickHouse/pull/24196) ([Raúl Marín](https://github.com/Algunenano))。
- ORC 输入格式按条带读取,而不是一次性将整个表读入内存,避免了在文件大小巨大时消耗过多内存。[#23102](https://github.com/ClickHouse/ClickHouse/pull/23102) ([Chao Ma](https://github.com/godliness))。
- 将查询中的聚合函数 `sum`、`count` 和 `avg` 融合为单个聚合函数。此优化由 `optimize_fuse_sum_count_avg` 设置控制。这通过新的聚合函数 `sumCount` 实现。该函数返回包含两个字段的元组:`sum` 和 `count`。[#21337](https://github.com/ClickHouse/ClickHouse/pull/21337) ([hexiaoting](https://github.com/hexiaoting))。
- 将 `zstd` 更新至 v1.5.0。压缩性能提升了个位数百分比。[#24135](https://github.com/ClickHouse/ClickHouse/pull/24135) ([Raúl Marín](https://github.com/Algunenano))。注意:在复制过程中可能会收到"校验和不匹配"的消息。由于压缩算法的更新,这些消息是预期的,可以忽略。
- 改进了 `Buffer` 表的性能:对于 `Buffer` 引擎,不再为 total_bytes/total_rows 获取锁。[#24066](https://github.com/ClickHouse/ClickHouse/pull/24066) ([Azat Khuzhin](https://github.com/azat))。
- 恢复了对 hashed/sparse_hashed 字典的预分配支持。[#23979](https://github.com/ClickHouse/ClickHouse/pull/23979) ([Azat Khuzhin](https://github.com/azat))。
- 默认启用 `async_socket_for_remote`(在查询具有大扇出的分布式表时减少线程数量)。[#23683](https://github.com/ClickHouse/ClickHouse/pull/23683) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。

#### 改进 {#improvement-5}


* 为 MergeTree 表族添加 `_partition_value` 虚拟列。它可用于以确定性方式进行分区裁剪，这是实现用于 mutation 的分区匹配器所必需的。 [#23673](https://github.com/ClickHouse/ClickHouse/pull/23673) ([Amos Bird](https://github.com/amosbird))。
* 为 S3 存储和磁盘新增了 `region` 参数。[#23846](https://github.com/ClickHouse/ClickHouse/pull/23846) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 允许为不同的日志通道配置不同的日志级别。解决 [#19569](https://github.com/ClickHouse/ClickHouse/issues/19569)。[#23857](https://github.com/ClickHouse/ClickHouse/pull/23857)（[filimonov](https://github.com/filimonov)）。
* 如果在 `DateTime` 运算中未显式指定时区，则保留原有的时区设置不变。例如，如果对一个不带时区的 `DateTime` 类型的值加一秒，结果仍然是不带时区的 `DateTime`。在之前的版本中，默认时区的值会被显式写入返回值的数据类型中，因此会变成 DateTime(&#39;something&#39;)。此更改关闭了 [#4854](https://github.com/ClickHouse/ClickHouse/issues/4854)。[#23392](https://github.com/ClickHouse/ClickHouse/pull/23392)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 允许用户在 `MySQL` 存储中将数据库名称指定为空字符串。此时查询将使用默认数据库。在之前的版本中，这仅适用于 SELECT 查询，现在也为 INSERT 添加了支持。此更改修复了 [#19281](https://github.com/ClickHouse/ClickHouse/issues/19281)。这在使用 `Sphinx` 或其他兼容 MySQL 的外部数据库时会很有用。[#23319](https://github.com/ClickHouse/ClickHouse/pull/23319)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了 `quantile(s)TDigest`。根据 tdunning/t-digest 3.2+ 为单个质心添加了特殊处理。同时修复了该算法早期版本实现中质心过度压缩的一个错误。[#23314](https://github.com/ClickHouse/ClickHouse/pull/23314) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 函数 `now64` 现已支持可选的时区参数。 [#24091](https://github.com/ClickHouse/ClickHouse/pull/24091) ([Vasily Nemkov](https://github.com/Enmk))。
* 修复了在 `clickhouse-client` 交互模式下，进度条在数据中间显示时，可能会覆盖终端中部分可见数据的问题。此更改关闭了 [#19283](https://github.com/ClickHouse/ClickHouse/issues/19283)。[#23050](https://github.com/ClickHouse/ClickHouse/pull/23050)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在 simdjson 中内存分配失败时发生的崩溃。 [https://github.com/simdjson/simdjson/pull/1567](https://github.com/simdjson/simdjson/pull/1567)。标记为改进项，因为这是一个极少出现的缺陷。 [#24147](https://github.com/ClickHouse/ClickHouse/pull/24147) ([Amos Bird](https://github.com/amosbird))。
* 在存储关闭之前保留字典（以避免在服务器关闭期间对 `Buffer` 引擎进行最终刷写时可能出现的 `external dictionary 'DICT' not found` 错误）。[#24068](https://github.com/ClickHouse/ClickHouse/pull/24068) ([Azat Khuzhin](https://github.com/azat)).
* 在关闭同一数据库内的表之前先刷新 `Buffer` 表，以避免由于底层表已被分离而导致数据块被丢弃（以及日志中的 `Destination table default.a_data_01870 doesn't exist. Block of data is discarded` 错误）。 [#24067](https://github.com/ClickHouse/ClickHouse/pull/24067) ([Azat Khuzhin](https://github.com/azat)).
* 现在，`prefer_column_name_to_alias = 1` 也会在 `group by`、`having` 和 `order by` 中优先使用列名。这样修复了 [#23882](https://github.com/ClickHouse/ClickHouse/issues/23882)。[#24022](https://github.com/ClickHouse/ClickHouse/pull/24022)（[Amos Bird](https://github.com/amosbird)）。
* 增加对 `DateTime64` 使用 `ORDER BY WITH FILL` 的支持。 [#24016](https://github.com/ClickHouse/ClickHouse/pull/24016) ([kevin wan](https://github.com/MaxWk)).
* 支持在 `ReplacingMergeTree` 中将 `DateTime64` 用作版本列。[#23992](https://github.com/ClickHouse/ClickHouse/pull/23992) ([kevin wan](https://github.com/MaxWk)).
* 在服务器启动时记录操作系统名称、内核版本和 CPU 架构等信息。[#23988](https://github.com/ClickHouse/ClickHouse/pull/23988) ([Azat Khuzhin](https://github.com/azat)).
* 支持为 `postgresql` 字典源指定表结构。关闭 [#23958](https://github.com/ClickHouse/ClickHouse/issues/23958)。[#23980](https://github.com/ClickHouse/ClickHouse/pull/23980) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 为 `Enum` 元素名称添加提示（在出现拼写错误时提供名称建议）。修复 [#17112](https://github.com/ClickHouse/ClickHouse/issues/17112)。[#23919](https://github.com/ClickHouse/ClickHouse/pull/23919)（[flynn](https://github.com/ucasFL)）。
* 为字典提供命中率统计（找到值的百分比）（参见 `system.dictionaries` 中的 `found_rate`）。[#23916](https://github.com/ClickHouse/ClickHouse/pull/23916) ([Azat Khuzhin](https://github.com/azat)).
* 允许通过表设置 `rabbitmq_queue_settings_list` 添加特定的队列参数。（关闭 [#23737](https://github.com/ClickHouse/ClickHouse/issues/23737) 和 [#23918](https://github.com/ClickHouse/ClickHouse/issues/23918)）。允许用户完全控制 RabbitMQ 的所有设置：如果表设置 `rabbitmq_queue_consume` 被设为 `1`，则 RabbitMQ 表引擎将只连接到指定队列，不会执行任何 RabbitMQ 消费端的初始化操作，例如声明 exchange、queue、binding。（关闭 [#21757](https://github.com/ClickHouse/ClickHouse/issues/21757)）。在删除 RabbitMQ 表时添加正确的清理逻辑——删除该表声明的队列，以及所有与之绑定的 exchange（如果它们是由该表创建的）。[#23887](https://github.com/ClickHouse/ClickHouse/pull/23887) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 将 `broken_data_files` / `broken_data_compressed_bytes` 添加到 `system.distribution_queue` 中。为异步插入到 Distributed 表的、已标记为损坏的文件数量添加指标（`BrokenDistributedFilesToInsert`）。 [#23885](https://github.com/ClickHouse/ClickHouse/pull/23885) ([Azat Khuzhin](https://github.com/azat)).
* 查询 `system.tables` 时不再访问 ZooKeeper。[#23793](https://github.com/ClickHouse/ClickHouse/pull/23793) ([Fuwang Hu](https://github.com/fuwhu))。
* 使 `OPTIMIZE` 查询遵循 `lock_acquire_timeout_for_background_operations`。[#23623](https://github.com/ClickHouse/ClickHouse/pull/23623) ([Azat Khuzhin](https://github.com/azat))。
* 现在可以通过新的 `SYSTEM RESTART DISK` SQL 命令在运行时更改 `S3` 磁盘设置。[#23429](https://github.com/ClickHouse/ClickHouse/pull/23429) ([Pavel Kovalenko](https://github.com/Jokser))。
* 如果用户错误地将 `max_distributed_connections` 配置为零，那么对 `Distributed` 表的每个查询都会抛出一个异常，消息中包含 “logical error”。但这实际上是预期行为，而不是逻辑错误，因此该异常消息略有不准确。它还会触发我们持续集成（CI）环境中的检查（该检查确保不会发生任何逻辑错误）。因此，我们会将被错误配置为零的 `max_distributed_connections` 视为最小可能值（一）。[#23348](https://github.com/ClickHouse/ClickHouse/pull/23348)（[Azat Khuzhin](https://github.com/azat)）。
* 将默认禁用 `min_bytes_to_use_mmap_io`。 [#23322](https://github.com/ClickHouse/ClickHouse/pull/23322) ([Azat Khuzhin](https://github.com/azat)).
* 在启用 `join_use_nulls` 时支持 `LowCardinality` 的可空类型，关闭 [#15101](https://github.com/ClickHouse/ClickHouse/issues/15101)。[#23237](https://github.com/ClickHouse/ClickHouse/pull/23237)（[vdimir](https://github.com/vdimir)）。
* 在 `S3` 磁盘上新增支持将 `MergeTree` 部件恢复到 `detached` 目录的功能。 [#23112](https://github.com/ClickHouse/ClickHouse/pull/23112) ([Pavel Kovalenko](https://github.com/Jokser))。
* 在 S3 中，当 HTTP 连接中断时执行重试。 [#22988](https://github.com/ClickHouse/ClickHouse/pull/22988) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 为 MySQL 表引擎、字典源以及 MaterializeMySQL 的小规模数据读取新增了两个设置：`external_storage_max_read_rows` 和 `external_storage_max_read_rows`。[#22697](https://github.com/ClickHouse/ClickHouse/pull/22697) ([TCeason](https://github.com/TCeason))。
* `MaterializeMySQL`（实验特性）：此前由于 SQL 不兼容，不支持 MySQL 5.7.9。现在由 MaterializeMySQL 负责 MySQL 参数校验。[#23413](https://github.com/ClickHouse/ClickHouse/pull/23413) ([TCeason](https://github.com/TCeason))。
* 支持在分布式表上读取子列。 [#24472](https://github.com/ClickHouse/ClickHouse/pull/24472) ([Anton Popov](https://github.com/CurtizJ))。
* 修复在 `CREATE .. AS SELECT` 查询中使用元组的方式。[#24464](https://github.com/ClickHouse/ClickHouse/pull/24464)（[Anton Popov](https://github.com/CurtizJ)）。
* 在 `Kafka` 表中增加对 `Parquet` 格式的支持。[#23412](https://github.com/ClickHouse/ClickHouse/pull/23412) ([Chao Ma](https://github.com/godliness))。

#### 错误修复 {#bug-fix-4}


* 在分区键和主键中使用时，沿用旧版本的取模函数。修复了 [#23508](https://github.com/ClickHouse/ClickHouse/issues/23508)。[#24157](https://github.com/ClickHouse/ClickHouse/pull/24157)（[Kseniia Sumarokova](https://github.com/kssenii)）。这是之前版本中导致向后不兼容的问题来源。
* 修复了在执行查询 `SYSTEM RESTART REPLICA` 或 `SYSTEM SYNC REPLICA` 时可能出现无限处理的问题。该问题在内存极其有限的服务器上被发现。[#24457](https://github.com/ClickHouse/ClickHouse/pull/24457) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 修复 `toWeek` 函数错误的单调性。此修复解决了 [#24422](https://github.com/ClickHouse/ClickHouse/issues/24422)。该缺陷在 [#5212](https://github.com/ClickHouse/ClickHouse/pull/5212) 中被引入，之后才被更智能的分区裁剪器暴露出来。[#24446](https://github.com/ClickHouse/ClickHouse/pull/24446)（[Amos Bird](https://github.com/amosbird)）。
* 修复在存在相交的伪 part 时执行 `DROP PARTITION` 的行为。在极少数情况下，可能会出现 mutation 版本号大于当前块号的 part。 [#24321](https://github.com/ClickHouse/ClickHouse/pull/24321) ([Amos Bird](https://github.com/amosbird)).
* 修复了在使用 `RENAME TABLE` 查询将物化视图从 Ordinary 数据库迁移到 Atomic 数据库时的一个错误。现在内部表会随物化视图一起迁移到新数据库。修复了 [#23926](https://github.com/ClickHouse/ClickHouse/issues/23926)。[#24309](https://github.com/ClickHouse/ClickHouse/pull/24309)（[tavplubix](https://github.com/tavplubix)）。
* 允许客户端请求中包含空的 HTTP 头部。修复 [#23901](https://github.com/ClickHouse/ClickHouse/issues/23901)。[#24285](https://github.com/ClickHouse/ClickHouse/pull/24285)（[Ivan](https://github.com/abyss7)）。
* 通过将 `max_threads` 设置为 `1` 修复 `Memory` 表的变更失败问题。关闭 [#24274](https://github.com/ClickHouse/ClickHouse/issues/24274)。[#24275](https://github.com/ClickHouse/ClickHouse/pull/24275) ([flynn](https://github.com/ucasFL))。
* 修复 `Memory` 表实现中的拼写错误，该错误是在 [#15127](https://github.com/ClickHouse/ClickHouse/issues/15127) 中引入的。关闭 [#24192](https://github.com/ClickHouse/ClickHouse/issues/24192)。[#24193](https://github.com/ClickHouse/ClickHouse/pull/24193)（[张中南](https://github.com/plugine)）。
* 修复在查询执行过程中 `HDFS` 变得不可访问时导致服务器异常终止的问题。关闭 [#24117](https://github.com/ClickHouse/ClickHouse/issues/24117)。[#24191](https://github.com/ClickHouse/ClickHouse/pull/24191)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在使用常量条件更新 `Nested` 列时发生的崩溃。[#24183](https://github.com/ClickHouse/ClickHouse/pull/24183) ([hexiaoting](https://github.com/hexiaoting)).
* 修复在高负载情况下 RBAC 中可能出现的竞态条件。此 PR 修复了 [#24090](https://github.com/ClickHouse/ClickHouse/issues/24090)、[#24134](https://github.com/ClickHouse/ClickHouse/issues/24134)、[#24176](https://github.com/ClickHouse/ClickHouse/pull/24176)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复了一个罕见的错误，该错误可能导致表在仅部分完成初始化的情况下仍然可以处理写入请求（INSERT/ALTER 等）。现在此类表将处于只读模式。[#24122](https://github.com/ClickHouse/ClickHouse/pull/24122) ([alesapin](https://github.com/alesapin))。
* 修复了一个问题：`EXPLAIN PIPELINE` 在处理 `SELECT xxx FINAL` 时显示了错误的执行管线（[hexiaoting](https://github.com/hexiaoting)）。
* 修复了在 `WHERE` 子句中使用常量 `DateTime` 值与 `DateTime64` 列比较时的问题。 [#24100](https://github.com/ClickHouse/ClickHouse/pull/24100) ([Vasily Nemkov](https://github.com/Enmk))。
* 修复 merge JOIN 中的崩溃问题，关闭 [#24010](https://github.com/ClickHouse/ClickHouse/issues/24010)。[#24013](https://github.com/ClickHouse/ClickHouse/pull/24013)（[vdimir](https://github.com/vdimir)）。
* 某些 `ALTER PARTITION` 查询可能会在复制队列中导致 `Part A intersects previous part B` 和 `Unexpected merged part C intersecting drop range D` 错误。该问题已修复，相关 issue 为 [#23296](https://github.com/ClickHouse/ClickHouse/issues/23296)。[#23997](https://github.com/ClickHouse/ClickHouse/pull/23997)（[tavplubix](https://github.com/tavplubix)）。
* 修复在使用 external GROUP BY 和溢出行时出现的 SIGSEGV 问题（例如如下查询：`SELECT FROM GROUP BY WITH TOTALS SETTINGS max_bytes_before_external_group_by>0, max_rows_to_group_by>0, group_by_overflow_mode='any', totals_mode='before_having'`）。 [#23962](https://github.com/ClickHouse/ClickHouse/pull/23962) ([Azat Khuzhin](https://github.com/azat)).
* 修复在源数据存在重复项时 `CACHE` 字典键相关指标的统计问题（会导致 `DictCacheKeysRequestedMiss` 溢出）。[#23929](https://github.com/ClickHouse/ClickHouse/pull/23929)（[Azat Khuzhin](https://github.com/azat)）。
* 修复 `PostgreSQL` 引擎的连接池实现。修复了 [#23897](https://github.com/ClickHouse/ClickHouse/issues/23897) 中的问题。[#23909](https://github.com/ClickHouse/ClickHouse/pull/23909)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在使用 `GROUP BY` 且聚合函数被包裹在常规函数中时 `distributed_group_by_no_merge = 2` 的问题（此前在 [#23546](https://github.com/ClickHouse/ClickHouse/issues/23546) 中被破坏）。当尝试将 `distributed_group_by_no_merge = 2` 与窗口函数一起使用时抛出异常。对包含窗口函数的查询禁用 `optimize_distributed_group_by_sharding_key`。[#23906](https://github.com/ClickHouse/ClickHouse/pull/23906)（[Azat Khuzhin](https://github.com/azat)）。
* 对 `s3` 表函数进行了修复：改进了对 HTTP 错误的处理。此前会忽略 HTTP 错误的响应体。[#23844](https://github.com/ClickHouse/ClickHouse/pull/23844) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 针对 `s3` 表函数的修复：改进了对 URI 的处理。修复了包含 `+` 符号的 URL 的兼容性问题，此类键对应的数据此前无法读取。[#23822](https://github.com/ClickHouse/ClickHouse/pull/23822) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 修复在包含 `GLOBAL IN/JOIN` 且启用 `use_hedged_requests` 的查询中出现的错误 `Can't initialize pipeline with empty pipe`。对应修复 [#23431](https://github.com/ClickHouse/ClickHouse/issues/23431)。[#23805](https://github.com/ClickHouse/ClickHouse/pull/23805)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复当列被物化视图引用时 `CLEAR COLUMN` 不起作用的问题。关闭 [#23764](https://github.com/ClickHouse/ClickHouse/issues/23764)。[#23781](https://github.com/ClickHouse/ClickHouse/pull/23781)（[flynn](https://github.com/ucasFL)）。
* 修复在使用 `Values` 格式从 HDFS 读取时出现的堆内存释放后使用（use-after-free）问题。[#23761](https://github.com/ClickHouse/ClickHouse/pull/23761) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 在向 Distributed 表执行 INSERT 时，避免在发生异常后可能出现的 &quot;Cannot schedule a task&quot; 错误。 [#23744](https://github.com/ClickHouse/ClickHouse/pull/23744) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在恢复滞后 `ReplicatedMergeTree` 副本时的一个错误。如果在副本停机期间执行了 `ALTER` 查询，那么该滞后副本可能会忽略某些元数据更新。 [#23742](https://github.com/ClickHouse/ClickHouse/pull/23742) ([tavplubix](https://github.com/tavplubix)).
* 修复了 `Join` 和 `WITH TOTALS` 相关的一个 bug，关闭了 [#17718](https://github.com/ClickHouse/ClickHouse/issues/17718)。[#23549](https://github.com/ClickHouse/ClickHouse/pull/23549)（[vdimir](https://github.com/vdimir)）。
* 修复在包含 `UNION` 的查询中可能出现的 `Block structure mismatch` 错误，该错误可能在进行过滤下推（filter pushdown）优化后发生。修复 [#23029](https://github.com/ClickHouse/ClickHouse/issues/23029)。[#23359](https://github.com/ClickHouse/ClickHouse/pull/23359)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 在启用设置 `optimize_skip_unused_shards_rewrite_in` 时添加类型转换。该更改修复了 MSan 报告的问题。[#23219](https://github.com/ClickHouse/ClickHouse/pull/23219) ([Azat Khuzhin](https://github.com/azat)).
* 在更新嵌套子列时补充缺失的检查，关闭 issue：[#22353](https://github.com/ClickHouse/ClickHouse/issues/22353)。[#22503](https://github.com/ClickHouse/ClickHouse/pull/22503)（[hexiaoting](https://github.com/hexiaoting)）。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-5}

- 支持在 Illumos 上构建。[#24144](https://github.com/ClickHouse/ClickHouse/pull/24144)。增加了对 Solaris 衍生操作系统的构建支持。[#23746](https://github.com/ClickHouse/ClickHouse/pull/23746) ([bnaecker](https://github.com/bnaecker))。
- 为哈希表添加更多基准测试,包括 Google 的 Swiss Table(在我们的特定使用场景中,其性能似乎低于 ClickHouse 哈希映射)。[#24111](https://github.com/ClickHouse/ClickHouse/pull/24111) ([Maksim Kita](https://github.com/kitaisreal))。
- 将 librdkafka 从 1.6.0-RC3 更新至 1.6.1。[#23874](https://github.com/ClickHouse/ClickHouse/pull/23874) ([filimonov](https://github.com/filimonov))。
- 始终显式启用 `asynchronous-unwind-tables`。这可能会修复 AArch64 上的查询性能分析器问题。[#23602](https://github.com/ClickHouse/ClickHouse/pull/23602) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 避免构建对区域设置和文件系统顺序产生依赖。这使得构建具有可重现性。[#23600](https://github.com/ClickHouse/ClickHouse/pull/23600) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 消除构建中的一个非确定性来源。现在在不同时间点进行的构建将产生字节级完全相同的二进制文件。部分解决了 [#22113](https://github.com/ClickHouse/ClickHouse/issues/22113)。[#23559](https://github.com/ClickHouse/ClickHouse/pull/23559) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 添加用于 (Zoo)Keeper 基准测试的简单工具。[#23038](https://github.com/ClickHouse/ClickHouse/pull/23038) ([alesapin](https://github.com/alesapin))。


## ClickHouse 版本 21.5, 2021-05-20 {#clickhouse-release-215-2021-05-20}

#### 向后不兼容的变更 {#backward-incompatible-change-6}

- 当整数无法在浮点数据类型中精确表示时,更改整数和浮点数的比较方式。在新版本中,由于会发生舍入误差,比较将返回 false。例如:`9223372036854775808.0 != 9223372036854775808`,因为数字 `9223372036854775808` 无法精确表示为浮点数(并且 `9223372036854775808.0` 会被舍入为 `9223372036854776000.0`)。但在之前的版本中,比较会返回这些数字相等,因为如果将浮点数 `9223372036854776000.0` 转换回 UInt64,它将产生 `9223372036854775808`。作为参考,Python 编程语言也将这些数字视为相等。但这种行为依赖于 CPU 型号(在 AMD64 和 AArch64 上对某些超出范围的数字会产生不同的结果),因此我们使比较更加精确。只有当整数在浮点类型中能够精确表示时,才会将整数和浮点数视为相等。[#22595](https://github.com/ClickHouse/ClickHouse/pull/22595) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 移除对单个 `Tuple` 参数的 `argMin` 和 `argMax` 支持。该代码不是内存安全的。此功能是错误添加的,并且会让用户感到困惑。这些函数可能会在以后以不同的名称重新引入。此更改修复了 [#22384](https://github.com/ClickHouse/ClickHouse/issues/22384) 并回退了 [#17359](https://github.com/ClickHouse/ClickHouse/issues/17359)。[#23393](https://github.com/ClickHouse/ClickHouse/pull/23393) ([alexey-milovidov](https://github.com/alexey-milovidov))。

#### 新功能 {#new-feature-6}

- 添加了函数 `dictGetChildren(dictionary, key)` 和 `dictGetDescendants(dictionary, key, level)`。函数 `dictGetChildren` 以索引数组的形式返回所有子节点。它是 `dictGetHierarchy` 的逆向转换。函数 `dictGetDescendants` 返回所有后代节点,就像递归应用 `dictGetChildren` `level` 次一样。`level` 值为零等同于无限。改进了 `dictGetHierarchy` 和 `dictIsIn` 函数的性能。关闭了 [#14656](https://github.com/ClickHouse/ClickHouse/issues/14656)。[#22096](https://github.com/ClickHouse/ClickHouse/pull/22096) ([Maksim Kita](https://github.com/kitaisreal))。
- 添加了函数 `dictGetOrNull`。它的工作方式类似于 `dictGet`,但在字典中未找到键时返回 `Null`。关闭了 [#22375](https://github.com/ClickHouse/ClickHouse/issues/22375)。[#22413](https://github.com/ClickHouse/ClickHouse/pull/22413) ([Maksim Kita](https://github.com/kitaisreal))。
- 添加了表函数 `s3Cluster`,允许在指定集群的每个节点上并行处理来自 `s3` 的文件。[#22012](https://github.com/ClickHouse/ClickHouse/pull/22012) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 在 MySQL/PostgreSQL 表引擎/表函数中添加了对副本和分片的支持。您可以编写 `SELECT * FROM mysql('host{1,2}-{1|2}', ...)`。关闭了 [#20969](https://github.com/ClickHouse/ClickHouse/issues/20969)。[#22217](https://github.com/ClickHouse/ClickHouse/pull/22217) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 添加了 `ALTER TABLE ... FETCH PART ...` 查询。它类似于 `FETCH PARTITION`,但只获取一个部分。[#22706](https://github.com/ClickHouse/ClickHouse/pull/22706) ([turbo jason](https://github.com/songenjie))。
- 添加了设置 `max_distributed_depth`,用于限制对 `Distributed` 表的递归查询深度。关闭了 [#20229](https://github.com/ClickHouse/ClickHouse/issues/20229)。[#21942](https://github.com/ClickHouse/ClickHouse/pull/21942) ([flynn](https://github.com/ucasFL))。


#### 性能改进 {#performance-improvement-6}

- 通过为 AVX2 实现动态调度,提升了 `intDiv` 的性能。此更改解决了 [#22314](https://github.com/ClickHouse/ClickHouse/issues/22314)。[#23000](https://github.com/ClickHouse/ClickHouse/pull/23000) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 提升了从 `ArrowStream` 输入格式读取非本地文件源(例如 URL)的性能。[#22673](https://github.com/ClickHouse/ClickHouse/pull/22673) ([nvartolomei](https://github.com/nvartolomei))。
- 通过原生协议与 localhost 交互时(使用 clickhouse-client 或分布式查询中的服务器到服务器通信),默认禁用压缩。这可能会提升某些导入/导出操作的性能。此更改解决了 [#22234](https://github.com/ClickHouse/ClickHouse/issues/22234)。[#22237](https://github.com/ClickHouse/ClickHouse/pull/22237) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 在分布式查询中,从 IN 子句的右侧部分排除不属于该分片的值(在 `optimize_skip_unused_shards_rewrite_in` 设置下,默认启用,但仍需要 `optimize_skip_unused_shards`)。[#21511](https://github.com/ClickHouse/ClickHouse/pull/21511) ([Azat Khuzhin](https://github.com/azat))。
- 提升了使用类文件表引擎和列式格式(如 Parquet、Arrow 或 ORC)读取列子集的性能。此更改解决了 [#issue:20129](https://github.com/ClickHouse/ClickHouse/issues/20129)。[#21302](https://github.com/ClickHouse/ClickHouse/pull/21302) ([keenwolf](https://github.com/keen-wolf))。
- 允许将更多条件移动到 `PREWHERE`,恢复到 21.1 版本之前的行为(调整了内部启发式算法)。移动的条件数量不足可能导致性能下降。[#23397](https://github.com/ClickHouse/ClickHouse/pull/23397) ([Anton Popov](https://github.com/CurtizJ))。
- 提升了 ODBC 连接的性能,并修复了积压的所有未解决问题。使用 `nanodbc` 库替代 `Poco::ODBC`。解决了 [#9678](https://github.com/ClickHouse/ClickHouse/issues/9678)。为 ODBC 表引擎添加了对 DateTime64 和 Decimal\* 的支持。解决了 [#21961](https://github.com/ClickHouse/ClickHouse/issues/21961)。修复了西里尔文本被截断的问题。解决了 [#16246](https://github.com/ClickHouse/ClickHouse/issues/16246)。为 odbc bridge 添加了连接池。[#21972](https://github.com/ClickHouse/ClickHouse/pull/21972) ([Kseniia Sumarokova](https://github.com/kssenii))。

#### 改进 {#improvement-6}


* 将 `max_uri_size`（HTTP 接口中 URL 的最大长度）的默认值提高到 1 MiB。此更改解决了 [#21197](https://github.com/ClickHouse/ClickHouse/issues/21197)。[#22997](https://github.com/ClickHouse/ClickHouse/pull/22997)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 将 `background_fetches_pool_size` 设置为 `8`，更适用于存在频繁小批量插入或 ZooKeeper 集群较慢的生产环境。[#22945](https://github.com/ClickHouse/ClickHouse/pull/22945) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* FlatDictionary 新增了 `initial_array_size`、`max_array_size` 选项。 [#22521](https://github.com/ClickHouse/ClickHouse/pull/22521) ([Maksim Kita](https://github.com/kitaisreal)).
* 新增用于非复制 MergeTree 插入去重的设置 `non_replicated_deduplication_window`。[#22514](https://github.com/ClickHouse/ClickHouse/pull/22514) ([alesapin](https://github.com/alesapin))。
* 在重新加载配置时更新 `CatBoost` 模型配置的路径。[#22434](https://github.com/ClickHouse/ClickHouse/pull/22434)（[Kruglov Pavel](https://github.com/Avogar)）。
* 在字典中新增对 `Decimal256` 类型的支持。`Decimal256` 属于实验性功能。修复 [#20979](https://github.com/ClickHouse/ClickHouse/issues/20979)。 [#22960](https://github.com/ClickHouse/ClickHouse/pull/22960) ([Maksim Kita](https://github.com/kitaisreal))。
* 默认启用 `async_socket_for_remote`（在分布式查询中使用更少的操作系统线程）。[#23683](https://github.com/ClickHouse/ClickHouse/pull/23683) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复了 `quantile(s)TDigest`。根据 tdunning/t-digest 3.2+ 对单一质心添加了特殊处理。同时修复了该算法早期版本实现中质心过度压缩的问题。[#23314](https://github.com/ClickHouse/ClickHouse/pull/23314)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* 使函数名 `unhex` 不区分大小写，以兼容 MySQL。 [#23229](https://github.com/ClickHouse/ClickHouse/pull/23229) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 为数组元素类型不同的通用场景实现函数 `arrayHasAny`、`arrayHasAll`、`has`、`indexOf`、`countEqual`。在此前版本中，函数 `arrayHasAny`、`arrayHasAll` 会返回 false，而 `has`、`indexOf`、`countEqual` 会抛出异常。同时在 `has` 及类似函数中增加对 `Decimal` 和大整数类型的支持。此变更关闭了 [#20272](https://github.com/ClickHouse/ClickHouse/issues/20272)。[#23044](https://github.com/ClickHouse/ClickHouse/pull/23044)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 提高了函数 `extractAllGroupsHorizontal` 返回结果中匹配项数量的上限。 [#23036](https://github.com/ClickHouse/ClickHouse/pull/23036) ([Vasily Nemkov](https://github.com/Enmk)).
* 不要在只有一个节点的集群上执行 `optimize_skip_unused_shards`。 [#22999](https://github.com/ClickHouse/ClickHouse/pull/22999) ([Azat Khuzhin](https://github.com/azat)).
* 新增了对使用 SSL 运行 clickhouse-keeper（对 ZooKeeper 的实验性可直接替换方案）的支持。配置项 `keeper_server.tcp_port_secure` 可用于实现客户端与 keeper-server 之间的安全交互，`keeper_server.raft_configuration.secure` 可用于启用节点之间的内部安全通信。[#22992](https://github.com/ClickHouse/ClickHouse/pull/22992) ([alesapin](https://github.com/alesapin))。
* 为 `Buffer` 表新增了仅在后台刷新缓冲区的功能。[#22986](https://github.com/ClickHouse/ClickHouse/pull/22986) ([Azat Khuzhin](https://github.com/azat)).
* 在从 MergeTree 表中进行查询且在 WHERE 条件中包含 NULL 时，在极少数情况下会抛出异常。现已修复该问题，并关闭了 [#20019](https://github.com/ClickHouse/ClickHouse/issues/20019)。[#22978](https://github.com/ClickHouse/ClickHouse/pull/22978)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 Poco HTTP 客户端在 AWS 场景下的错误处理。[#22973](https://github.com/ClickHouse/ClickHouse/pull/22973) ([kreuzerkrieg](https://github.com/kreuzerkrieg))。
* 在 `ReplicatedMergeTree` 中遵守 `max_part_removal_threads` 设置。 [#22971](https://github.com/ClickHouse/ClickHouse/pull/22971) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在 MergeTree 中将 inactive&#95;parts&#95;to&#95;throw&#95;insert 设置为 0 且将 inactive&#95;parts&#95;to&#95;delay&#95;insert 设置为大于 0 时的一个较为隐晦的边缘情况。[#22947](https://github.com/ClickHouse/ClickHouse/pull/22947) ([Azat Khuzhin](https://github.com/azat))。
* `dateDiff` 现在可以用于 `DateTime64` 参数（即使是超出 `DateTime` 范围的值）[#22931](https://github.com/ClickHouse/ClickHouse/pull/22931)（[Vasily Nemkov](https://github.com/Enmk)）。
* MaterializeMySQL（实验特性）：新增功能，可以在复制包含视图的 MySQL 数据库时不会失败。这是通过忽略这些视图来实现的。[#22760](https://github.com/ClickHouse/ClickHouse/pull/22760)（[Christian](https://github.com/cfroystad)）。
* 允许通过 PostgreSQL 协议使用 RBAC 行策略。解决了 [#22658](https://github.com/ClickHouse/ClickHouse/issues/22658)。PostgreSQL 协议在配置中默认启用。[#22755](https://github.com/ClickHouse/ClickHouse/pull/22755) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 添加用于统计等待 Buffer 层锁所花时间的指标。 [#22725](https://github.com/ClickHouse/ClickHouse/pull/22725) ([Azat Khuzhin](https://github.com/azat))。
* 允许在 VIEW 定义中使用 CTE。从而关闭了 [#22491](https://github.com/ClickHouse/ClickHouse/issues/22491)。[#22657](https://github.com/ClickHouse/ClickHouse/pull/22657)（[Amos Bird](https://github.com/amosbird)）。
* 如果前一个程序在终端中留下了残留输出，则在 `clickhouse-client` 中清理屏幕剩余部分并显示光标。关闭了 [#16518](https://github.com/ClickHouse/ClickHouse/issues/16518)。[#22634](https://github.com/ClickHouse/ClickHouse/pull/22634)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 使 `round` 函数在非 x86&#95;64 平台上的行为保持一致。采用“四舍六入五留双”的银行家舍入规则。[#22582](https://github.com/ClickHouse/ClickHouse/pull/22582) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 正确校验通过 Distributed 表发送的数据块结构。 [#22325](https://github.com/ClickHouse/ClickHouse/pull/22325) ([Azat Khuzhin](https://github.com/azat)).
* 允许将 Kafka 错误写入 Kafka 引擎的虚拟列中，并由 `kafka_handle_error_mode` 设置进行控制。[#21850](https://github.com/ClickHouse/ClickHouse/pull/21850) ([fastio](https://github.com/fastio))。
* 为 `visitParam/visitParamExtract{UInt, Int, Bool, Float, Raw, String}` 新增别名 `simpleJSONExtract/simpleJSONHas`。修复 [#21383](https://github.com/ClickHouse/ClickHouse/issues/21383)。[#21519](https://github.com/ClickHouse/ClickHouse/pull/21519)（[fastio](https://github.com/fastio)）。
* 为库字典来源添加 `clickhouse-library-bridge`。修复 [#9502](https://github.com/ClickHouse/ClickHouse/issues/9502)。[#21509](https://github.com/ClickHouse/ClickHouse/pull/21509)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 当某列被物化视图引用时，禁止删除该列。修复了 [#21164](https://github.com/ClickHouse/ClickHouse/issues/21164)。 [#21303](https://github.com/ClickHouse/ClickHouse/pull/21303) ([flynn](https://github.com/ucasFL))。
* 支持服务器间凭证的动态轮换（无停机轮换凭证）。 [#14113](https://github.com/ClickHouse/ClickHouse/pull/14113) ([johnskopis](https://github.com/johnskopis)).
* 为 Kafka 存储新增对 `Arrow` 和 `ArrowStream` 格式消息的支持。[#23415](https://github.com/ClickHouse/ClickHouse/pull/23415)（[Chao Ma](https://github.com/godliness)）。
* 修复了异常信息中缺失的分号。用户可能会觉得这条异常信息的阅读体验不佳。 [#23208](https://github.com/ClickHouse/ClickHouse/pull/23208) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复某些关于 `LowCardinality` 类型的异常消息中缺失空格的问题。 [#23207](https://github.com/ClickHouse/ClickHouse/pull/23207) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 此前，某些值在 Markdown 表格单元格中被设置为居中对齐。现在不再这样。[#23096](https://github.com/ClickHouse/ClickHouse/pull/23096) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 移除 clickhouse-client 提示中的非必要细节。该更改关闭了 [#22158](https://github.com/ClickHouse/ClickHouse/issues/22158)。[#23040](https://github.com/ClickHouse/ClickHouse/pull/23040)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修正了 system.dictionaries 中 sparse&#95;hashed 字典的 `bytes_allocated` 字段计算。[#22867](https://github.com/ClickHouse/ClickHouse/pull/22867) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在从 MergeTree 反向读取时对估算总行数的统计逻辑。 [#22726](https://github.com/ClickHouse/ClickHouse/pull/22726) ([Azat Khuzhin](https://github.com/azat)).
* 修复了可以将字典配置为使用指向自身的 ClickHouse 源，从而导致无限循环的问题。关闭 [#14314](https://github.com/ClickHouse/ClickHouse/issues/14314)。[#22479](https://github.com/ClickHouse/ClickHouse/pull/22479)（[Maksim Kita](https://github.com/kitaisreal)）。

#### 错误修复 {#bug-fix-5}


* 对 hedged 请求进行了多项修复。修复了在开启 `use_hedged_requests` 设置时，带有 `GLOBAL IN/JOIN` 的查询出现 `Can't initialize pipeline with empty pipe` 错误的问题。修复了 [#23431](https://github.com/ClickHouse/ClickHouse/issues/23431)。[#23805](https://github.com/ClickHouse/ClickHouse/pull/23805)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。修复了 hedged 连接中的竞争条件，该问题会导致崩溃。本修复对应 [#22161](https://github.com/ClickHouse/ClickHouse/issues/22161)。[#22443](https://github.com/ClickHouse/ClickHouse/pull/22443)（[Kruglov Pavel](https://github.com/Avogar)）。修复了在启用 `async_socket_for_remote` 时，从远程查询接收到 `unknown packet` 时可能发生的崩溃。修复了 [#21167](https://github.com/ClickHouse/ClickHouse/issues/21167)。[#23309](https://github.com/ClickHouse/ClickHouse/pull/23309)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在禁用 `input_format_with_names_use_header` 设置时会导致使用 CSVWithNames 格式的所有输入被丢弃的问题。此更改修复了 [#22406](https://github.com/ClickHouse/ClickHouse/issues/22406)。[#23202](https://github.com/ClickHouse/ClickHouse/pull/23202)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 修复了远程 JDBC bridge 连接超时的问题。关闭了 [#9609](https://github.com/ClickHouse/ClickHouse/issues/9609)。[#23771](https://github.com/ClickHouse/ClickHouse/pull/23771)（[Maksim Kita](https://github.com/kitaisreal)、[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在指定 `update_field` 时 `complex_key_hashed` 的初始加载逻辑。关闭问题 [#23800](https://github.com/ClickHouse/ClickHouse/issues/23800)。[#23824](https://github.com/ClickHouse/ClickHouse/pull/23824)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复了在 `PREWHERE` 和行级策略过滤器同时生效且结果为空时发生的崩溃。[#23763](https://github.com/ClickHouse/ClickHouse/pull/23763) ([Amos Bird](https://github.com/amosbird))。
* 在向 Distributed 执行 INSERT 时，避免在发生某些异常时可能出现的“Cannot schedule a task”错误。[#23744](https://github.com/ClickHouse/ClickHouse/pull/23744) ([Azat Khuzhin](https://github.com/azat)).
* 在聚合函数 `mannWhitneyUTest` 中，当两个样本的值完全相同时会抛出异常。这修复了 [#23646](https://github.com/ClickHouse/ClickHouse/issues/23646)。[#23654](https://github.com/ClickHouse/ClickHouse/pull/23654)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 修复了通过 HTTP 插入数据时引发异常的服务器错误。修复了 [#23512](https://github.com/ClickHouse/ClickHouse/issues/23512)。[#23643](https://github.com/ClickHouse/ClickHouse/pull/23643)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 修复了某些带有转义序列的 `LIKE` 表达式被错误解析的问题。 [#23610](https://github.com/ClickHouse/ClickHouse/pull/23610) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复了重启/停止命令挂起的问题。关闭了 [#20214](https://github.com/ClickHouse/ClickHouse/issues/20214)。[#23552](https://github.com/ClickHouse/ClickHouse/pull/23552)（[filimonov](https://github.com/filimonov)）。
* 修复了在包含多个 JOIN 的 SELECT 查询中的 `COLUMNS` 匹配器问题。修复了 [#22736](https://github.com/ClickHouse/ClickHouse/issues/22736)。[#23501](https://github.com/ClickHouse/ClickHouse/pull/23501) ([Maksim Kita](https://github.com/kitaisreal))。
* 修复了在某列本身被用作 `ReplacingMergeTree` 的参数时，修改其默认值会导致崩溃的问题。 [#23483](https://github.com/ClickHouse/ClickHouse/pull/23483) ([hexiaoting](https://github.com/hexiaoting)).
* 修复了在使用 `ReplacingMergeTree` 进行纵向合并时的某些边界情况。在极少数情况下，这些问题可能会导致合并操作失败，并抛出类似 `Incomplete granules are not allowed while blocks are granules size` 的异常。[#23459](https://github.com/ClickHouse/ClickHouse/pull/23459)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复了一个导致无法将空数组字面量转换为维度大于 1 的数组的错误，例如 `CAST([] AS Array(Array(String)))`。关闭了 [#14476](https://github.com/ClickHouse/ClickHouse/issues/14476)。[#23456](https://github.com/ClickHouse/ClickHouse/pull/23456)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复了 `deltaSum` 聚合函数在重置计数器后产生错误结果的问题。[#23437](https://github.com/ClickHouse/ClickHouse/pull/23437)（[Russ Frank](https://github.com/rf)）。
* 修复了在多磁盘配置下创建 `ReplicatedMergeTree` 表失败时出现的 `Cannot unlink file` 错误。由此关闭了 [#21755](https://github.com/ClickHouse/ClickHouse/issues/21755)。[#23433](https://github.com/ClickHouse/ClickHouse/pull/23433)（[tavplubix](https://github.com/tavplubix)）。
* 修复了在基于虚拟列进行分区裁剪时生成不兼容常量表达式的问题。此更改修复了 [https://github.com/ClickHouse/ClickHouse/pull/21401#discussion&#95;r611888913](https://github.com/ClickHouse/ClickHouse/pull/21401#discussion_r611888913)。[#23366](https://github.com/ClickHouse/ClickHouse/pull/23366)（[Amos Bird](https://github.com/amosbird)）。
* 修复了在将 join&#95;algorithm 设置为 &#39;auto&#39; 并使用 Dictionary 执行 Join 时出现的崩溃问题。关闭 [#23002](https://github.com/ClickHouse/ClickHouse/issues/23002)。[#23312](https://github.com/ClickHouse/ClickHouse/pull/23312) ([Vladimir](https://github.com/vdimir))。
* 在进行分区裁剪时不要放宽 NOT 条件。这修复了 [#23305](https://github.com/ClickHouse/ClickHouse/issues/23305) 和 [#21539](https://github.com/ClickHouse/ClickHouse/issues/21539)。 [#23310](https://github.com/ClickHouse/ClickHouse/pull/23310)（[Amos Bird](https://github.com/amosbird)）。
* 修复了在旧数据块后台清理时极少出现的竞争条件。如果某个数据块距离去重窗口的结束时间过近，这可能导致该数据块未被去重。 [#23301](https://github.com/ClickHouse/ClickHouse/pull/23301) ([tavplubix](https://github.com/tavplubix)).
* 修复了在创建和删除 `ReplicatedMergeTree` 表之间极其罕见的分布式竞态条件。该问题可能会在尝试创建复制表时导致诸如 `node doesn't exist` 之类的异常。修复了 [#21419](https://github.com/ClickHouse/ClickHouse/issues/21419)。[#23294](https://github.com/ClickHouse/ClickHouse/pull/23294)（[tavplubix](https://github.com/tavplubix)）。
* 修复了当主键不是第一个属性时，通过 DDL 创建的 simple key 字典的问题。修复了 [#23236](https://github.com/ClickHouse/ClickHouse/issues/23236)。[#23262](https://github.com/ClickHouse/ClickHouse/pull/23262)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复了在表中存在许多长列名时通过 ODBC 读取数据的问题。关闭了 [#8853](https://github.com/ClickHouse/ClickHouse/issues/8853)。[#23215](https://github.com/ClickHouse/ClickHouse/pull/23215)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* MaterializeMySQL（实验性功能）：修复在基于键列条件从 `MaterializeMySQL` 查询数据时出现的 `Not found column` 错误。修复了 [#22432](https://github.com/ClickHouse/ClickHouse/issues/22432)。[#23200](https://github.com/ClickHouse/ClickHouse/pull/23200)（[tavplubix](https://github.com/tavplubix)）。
* 在子查询被优化为常量时，修正对别名的处理方式。修复 [#22924](https://github.com/ClickHouse/ClickHouse/issues/22924)。修复 [#10401](https://github.com/ClickHouse/ClickHouse/issues/10401)。[#23191](https://github.com/ClickHouse/ClickHouse/pull/23191)（[Maksim Kita](https://github.com/kitaisreal)）。
* 如果在默认配置中启用了 `data_type_default_nullable` 设置，服务器可能无法启动，该问题已修复。修复了 [#22573](https://github.com/ClickHouse/ClickHouse/issues/22573)。[#23185](https://github.com/ClickHouse/ClickHouse/pull/23185)（[tavplubix](https://github.com/tavplubix)）。
* 修复了由于当前连接数统计错误而导致在关闭过程中发生的崩溃。[#23154](https://github.com/ClickHouse/ClickHouse/pull/23154) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复了将物化视图从 Atomic 数据库分离后再重新附加时，从该物化视图执行查询会出现 `Table .inner_id... doesn't exist` 错误的问题。[#23047](https://github.com/ClickHouse/ClickHouse/pull/23047) ([tavplubix](https://github.com/tavplubix)).
* 修复了在子查询中使用 `untuple` 时可能出现的错误 `Cannot find column in ActionsDAG result`。修复 [#22290](https://github.com/ClickHouse/ClickHouse/issues/22290)。[#22991](https://github.com/ClickHouse/ClickHouse/pull/22991)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复对含可为 NULL 值的 `Map` 类型常量列的使用。 [#22939](https://github.com/ClickHouse/ClickHouse/pull/22939) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了在 `DateTime64` 上使用 `formatDateTime()` 和 &quot;%C&quot; 格式说明符的问题，修复了 `toDateTime64()` 在处理较大数值和非零小数位时的问题。 [#22937](https://github.com/ClickHouse/ClickHouse/pull/22937) ([Vasily Nemkov](https://github.com/Enmk)).
* 修复了在配合窗口函数使用 `mannWhitneyUTest` 和 `rankCorr` 时发生的崩溃问题。此修复对应 [#22728](https://github.com/ClickHouse/ClickHouse/issues/22728)。[#22876](https://github.com/ClickHouse/ClickHouse/pull/22876)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* LIVE VIEW（实验性功能）：修复了在 `TemporaryLiveViewCleaner` 中并发执行 TEMPORARY LIVE VIEW 的 DROP/CREATE 操作时可能出现的挂起问题，详见[此处](https://gist.github.com/vzakaznikov/0c03195960fc86b56bfe2bc73a90019e)。[#22858](https://github.com/ClickHouse/ClickHouse/pull/22858)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复了在聚合中使用过滤列时 `HAVING` 子句下推的问题。[#22763](https://github.com/ClickHouse/ClickHouse/pull/22763) ([Anton Popov](https://github.com/CurtizJ))。
* 修复了在发生 OOM 异常时可能导致 Zookeeper 请求挂起的问题。修复了 [#22438](https://github.com/ClickHouse/ClickHouse/issues/22438)。[#22684](https://github.com/ClickHouse/ClickHouse/pull/22684)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了 `ReplicatedMergeTree` 表引擎在多个副本上等待变更（mutation）的机制。之前，`mutation`/`alter` 查询可能会在变更实际在其他副本上执行之前就结束。[#22669](https://github.com/ClickHouse/ClickHouse/pull/22669)（[alesapin](https://github.com/alesapin)）。
* 修复了当 `Log` 引擎包含嵌套类型且 `SELECT` 子句未包含其列时抛出的异常。[#22654](https://github.com/ClickHouse/ClickHouse/pull/22654) ([Azat Khuzhin](https://github.com/azat))。
* 修复辅助 AWS 请求无限等待的问题。[#22594](https://github.com/ClickHouse/ClickHouse/pull/22594)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* 修复了在客户端过早关闭连接时发生的崩溃问题 [#22579](https://github.com/ClickHouse/ClickHouse/issues/22579)。[#22591](https://github.com/ClickHouse/ClickHouse/pull/22591) ([nvartolomei](https://github.com/nvartolomei))。
* `Map` 数据类型（实验性功能）：修复了在分布式查询中对函数 `map` 的不正确格式化问题。[#22588](https://github.com/ClickHouse/ClickHouse/pull/22588) ([foolchi](https://github.com/foolchi))。
* 修复了在 TSV 格式末尾没有换行符时对空字符串的反序列化问题。此更改关闭了 [#20244](https://github.com/ClickHouse/ClickHouse/issues/20244)。在不更新版本的情况下，可能的解决方法是将 `input_format_null_as_default` 设置为 0。该值在旧版本中默认为 0。[#22527](https://github.com/ClickHouse/ClickHouse/pull/22527)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了 Merge Join 算法中对 `LowCardinality` 类型列的错误类型转换。关闭 [#22386](https://github.com/ClickHouse/ClickHouse/issues/22386)、[#22388](https://github.com/ClickHouse/ClickHouse/issues/22388)。[#22510](https://github.com/ClickHouse/ClickHouse/pull/22510)（[Vladimir](https://github.com/vdimir)）。
* 在 `tokenbf_v1` 全文索引中，读取时可能发生缓冲区溢出。多余的字节不会被使用，但读取操作在极少数情况下可能导致崩溃。此问题关闭了 [#19233](https://github.com/ClickHouse/ClickHouse/issues/19233)。[#22421](https://github.com/ClickHouse/ClickHouse/pull/22421)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 不再限制 HTTP 分块大小。修复了 [#21907](https://github.com/ClickHouse/ClickHouse/issues/21907)。[#22322](https://github.com/ClickHouse/ClickHouse/pull/22322)（[Ivan](https://github.com/abyss7)）。
* 修复了一个错误，该错误在启用 `optimize_aggregation_in_order` 且表中存在大量数据分片时会导致数据聚合不完整。在启用 `optimize_aggregation_in_order` 时略微提升了聚合性能。[#21889](https://github.com/ClickHouse/ClickHouse/pull/21889) ([Anton Popov](https://github.com/CurtizJ)).
* 检查是否将表函数 view 用作列。作为对 #20350 的补充。[#21465](https://github.com/ClickHouse/ClickHouse/pull/21465)（[Amos Bird](https://github.com/amosbird)）。
* 修复在包含 `JOIN` 和聚合的查询中，使用 `Merge` 引擎的表出现的 “unknown column” 错误。关闭 [#18368](https://github.com/ClickHouse/ClickHouse/issues/18368)，关闭 [#22226](https://github.com/ClickHouse/ClickHouse/issues/22226)。[#21370](https://github.com/ClickHouse/ClickHouse/pull/21370)（[Vladimir](https://github.com/vdimir)）。
* 修复了下推优化中的名称冲突问题。该问题会导致 FULL JOIN 之后的 `WHERE` 过滤结果不正确。关闭 [#20497](https://github.com/ClickHouse/ClickHouse/issues/20497)。 [#20622](https://github.com/ClickHouse/ClickHouse/pull/20622) ([Vladimir](https://github.com/vdimir))。
* 修复了一个极少出现的错误：在 `quorum_parallel=1` 时，由于去重，仲裁写入实际上并不是真正的“quorum”。[#18215](https://github.com/ClickHouse/ClickHouse/pull/18215)（[filimonov](https://github.com/filimonov) - 报告， [alesapin](https://github.com/alesapin) - 修复）。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-6}

- 在 CI 中并行运行无状态测试。[#22300](https://github.com/ClickHouse/ClickHouse/pull/22300) ([alesapin](https://github.com/alesapin))。
- 简化 Debian 软件包。此更改修复了 [#21698](https://github.com/ClickHouse/ClickHouse/issues/21698)。[#22976](https://github.com/ClickHouse/ClickHouse/pull/22976) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 新增对在 Apple M1 上构建 ClickHouse 的支持。[#21639](https://github.com/ClickHouse/ClickHouse/pull/21639) ([changvvb](https://github.com/changvvb))。
- 修复了 macOS 上 ClickHouse Keeper 的构建问题。[#22860](https://github.com/ClickHouse/ClickHouse/pull/22860) ([alesapin](https://github.com/alesapin))。
- 修复了 AArch64 平台上的部分测试。[#22596](https://github.com/ClickHouse/ClickHouse/pull/22596) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 新增函数对齐以提升性能。[#21431](https://github.com/ClickHouse/ClickHouse/pull/21431) ([Danila Kutenin](https://github.com/danlark1))。
- 调整部分测试以在 amd64 和 aarch64 (qemu) 上输出一致的结果。之前的结果依赖于特定实现的 CPU 行为。[#22590](https://github.com/ClickHouse/ClickHouse/pull/22590) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 仅允许在 x86_64 上进行查询性能分析。参见 [#15174](https://github.com/ClickHouse/ClickHouse/issues/15174#issuecomment-812954965) 和 [#15638](https://github.com/ClickHouse/ClickHouse/issues/15638#issuecomment-703805337)。此更改关闭了 [#15638](https://github.com/ClickHouse/ClickHouse/issues/15638)。[#22580](https://github.com/ClickHouse/ClickHouse/pull/22580) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 允许使用 `USE_INTERNAL_XZ_LIBRARY=OFF` CMake 选项以非捆绑的 xz (lzma) 进行构建。[#22571](https://github.com/ClickHouse/ClickHouse/pull/22571) ([Kfir Itzhak](https://github.com/mastertheknife))。
- 在 `ppc64le` 上启用捆绑的 `openldap` [#22487](https://github.com/ClickHouse/ClickHouse/pull/22487) ([Kfir Itzhak](https://github.com/mastertheknife))。
- 在 `ppc64le` 上禁用不兼容的库(通常是平台特定的) [#22475](https://github.com/ClickHouse/ClickHouse/pull/22475) ([Kfir Itzhak](https://github.com/mastertheknife))。
- 在 CI 中为 ClickHouse Keeper 新增 Jepsen 测试。[#22373](https://github.com/ClickHouse/ClickHouse/pull/22373) ([alesapin](https://github.com/alesapin))。
- 构建支持[堆性能分析](https://github.com/jemalloc/jemalloc/wiki/Use-Case%3A-Heap-Profiling)的 `jemalloc`。[#22834](https://github.com/ClickHouse/ClickHouse/pull/22834) ([nvartolomei](https://github.com/nvartolomei))。
- 避免 `*Log` 引擎中因从其他线程解锁 rwlock 而导致的未定义行为。[#22583](https://github.com/ClickHouse/ClickHouse/pull/22583) ([Azat Khuzhin](https://github.com/azat))。
- 通过从同一线程解锁 TinyLog 的 rwlock 修复了未定义行为。[#22560](https://github.com/ClickHouse/ClickHouse/pull/22560) ([Azat Khuzhin](https://github.com/azat))。


## ClickHouse 21.4 版本 {#clickhouse-release-214}

### ClickHouse 21.4.1 版本 2021-04-12 {#clickhouse-release-2141-2021-04-12}

#### 向后不兼容变更 {#backward-incompatible-change-7}

- `toStartOfIntervalFunction` 函数现在会将小时间隔对齐到午夜(在之前的版本中对齐到 Unix 纪元的起始时间)。例如,`toStartOfInterval(x, INTERVAL 11 HOUR)` 会将每天分割为三个间隔:`00:00:00..10:59:59`、`11:00:00..21:59:59` 和 `22:00:00..23:59:59`。这种行为更符合实际需求。此变更关闭了 [#9510](https://github.com/ClickHouse/ClickHouse/issues/9510)。[#22060](https://github.com/ClickHouse/ClickHouse/pull/22060) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- Graphite 汇总配置中的 `Age` 和 `Precision` 应该从一个保留期到下一个保留期递增。现在会对此进行检查,错误的配置会抛出异常。[#21496](https://github.com/ClickHouse/ClickHouse/pull/21496) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- 修复了 `cutToFirstSignificantSubdomainCustom()`/`firstSignificantSubdomainCustom()` 对于自定义顶级域名列表中存在的 3 级及以上域名返回错误结果的问题。对于匹配这些自定义顶级域名的输入域名,三级域名被认为是第一个有效域名。此问题现已修复。如果该函数用于分片键等场景,此变更可能会引入不兼容性。[#21946](https://github.com/ClickHouse/ClickHouse/pull/21946) ([Azat Khuzhin](https://github.com/azat))。
- `system.dictionaries` 表中的 `keys` 列已被替换为 `key.names` 和 `key.types` 列。`system.dictionaries` 表中的 `key.names`、`key.types`、`attribute.names`、`attribute.types` 列不再要求字典已加载。[#21884](https://github.com/ClickHouse/ClickHouse/pull/21884) ([Maksim Kita](https://github.com/kitaisreal))。
- 现在处理 `ALTER TABLE ATTACH PART[ITION]` 命令的副本会在从其他副本获取数据之前先在其 `detached/` 文件夹中搜索。作为实现细节,在复制日志中引入了一个新命令 `ATTACH_PART`。数据分区通过其校验和进行搜索和比较。[#18978](https://github.com/ClickHouse/ClickHouse/pull/18978) ([Mike Kot](https://github.com/myrrc))。**注意**:
  - 在集群升级期间,`ATTACH PART[ITION]` 查询可能无法正常工作。
  - 在新版本中执行 `ALTER ... ATTACH` 查询后,无法回滚到旧版本的 ClickHouse,因为旧服务器无法处理复制日志中的 `ATTACH_PART` 条目。
- 在此版本中,空的 `<remote_url_allow_hosts></remote_url_allow_hosts>` 将阻止所有对远程主机的访问,而在之前的版本中它不起作用。如果您想保持旧的行为,并且配置文件中有空的 `remote_url_allow_hosts` 元素,请将其删除。[#20058](https://github.com/ClickHouse/ClickHouse/pull/20058) ([Vladimir Chebotarev](https://github.com/excitoon))。

#### 新功能 {#new-feature-7}


* 将 `DateTime64` 的取值范围扩展为支持从 1925 年到 2283 年的日期。改进了 `DateTime` 在零日期（`1970-01-01`）附近的支持。[#9404](https://github.com/ClickHouse/ClickHouse/pull/9404)（[alexey-milovidov](https://github.com/alexey-milovidov)，[Vasily Nemkov](https://github.com/Enmk)）。并非所有日期和时间函数都支持这一扩展后的日期范围。
* 为预先配置的用户和 HTTP 请求（GSS-SPNEGO）添加了 Kerberos 认证支持。[#14995](https://github.com/ClickHouse/ClickHouse/pull/14995) ([Denis Glazachev](https://github.com/traceon))。
* 添加 `prefer_column_name_to_alias` 设置，以使用原始列名而非别名。此设置用于与常见数据库的别名规则实现更好的兼容性。对应 [#9715](https://github.com/ClickHouse/ClickHouse/issues/9715) 和 [#9887](https://github.com/ClickHouse/ClickHouse/issues/9887)。[#22044](https://github.com/ClickHouse/ClickHouse/pull/22044)（[Amos Bird](https://github.com/amosbird)）。
* 新增了函数 `dictGetChildren(dictionary, key)`、`dictGetDescendants(dictionary, key, level)`。函数 `dictGetChildren` 以索引数组的形式返回所有子节点。它是 `dictGetHierarchy` 的逆转换。函数 `dictGetDescendants` 返回在递归应用 `dictGetChildren` `level` 次时得到的所有后代节点。`level` 为 0 等价于无限大。修复 [#14656](https://github.com/ClickHouse/ClickHouse/issues/14656)。[#22096](https://github.com/ClickHouse/ClickHouse/pull/22096)（[Maksim Kita](https://github.com/kitaisreal)）。
* 新增了 `executable_pool` 字典源。关闭了 [#14528](https://github.com/ClickHouse/ClickHouse/issues/14528)。[#21321](https://github.com/ClickHouse/ClickHouse/pull/21321)（[Maksim Kita](https://github.com/kitaisreal)）。
* 新增了表函数 `dictionary`，其工作方式与 `Dictionary` 引擎相同。已关闭 [#21560](https://github.com/ClickHouse/ClickHouse/issues/21560)。[#21910](https://github.com/ClickHouse/ClickHouse/pull/21910)（[Maksim Kita](https://github.com/kitaisreal)）。
* 支持在 `PolygonDictionary` 属性中使用 `Nullable` 类型。[#21890](https://github.com/ClickHouse/ClickHouse/pull/21890)（[Maksim Kita](https://github.com/kitaisreal)）。
* 函数 `dictGet`、`dictHas` 在未为通过 DDL 创建的字典显式指定数据库名时，会使用当前数据库名。修复了 [#21632](https://github.com/ClickHouse/ClickHouse/issues/21632)。[#21859](https://github.com/ClickHouse/ClickHouse/pull/21859)（[Maksim Kita](https://github.com/kitaisreal)）。
* 新增了函数 `dictGetOrNull`。其行为类似于 `dictGet`，但在字典中找不到键时会返回 `Null`。解决了 [#22375](https://github.com/ClickHouse/ClickHouse/issues/22375)。[#22413](https://github.com/ClickHouse/ClickHouse/pull/22413)（[Maksim Kita](https://github.com/kitaisreal)）。
* 在 `ComplexKeyCache`、`SSDCache`、`SSDComplexKeyCache` 字典中添加了异步更新功能。为 `Cache`、`ComplexKeyCache`、`SSDCache`、`SSDComplexKeyCache` 字典添加了对 `Nullable` 类型的支持。为 `dictGet`、`dictGetOrDefault` 函数添加了对多属性同时获取的支持。修复 [#21517](https://github.com/ClickHouse/ClickHouse/issues/21517)。[#20595](https://github.com/ClickHouse/ClickHouse/pull/20595)（[Maksim Kita](https://github.com/kitaisreal)）。
* 为 `RangeHashedDictionary` 增加对 `dictHas` 函数的支持。修复 [#6680](https://github.com/ClickHouse/ClickHouse/issues/6680)。[#19816](https://github.com/ClickHouse/ClickHouse/pull/19816) ([Maksim Kita](https://github.com/kitaisreal))。
* 添加函数 `timezoneOf`，用于返回 `DateTime` 或 `DateTime64` 数据类型的时区名称。此更改并未关闭 [#9959](https://github.com/ClickHouse/ClickHouse/issues/9959)。修复函数命名中的不一致：新增别名 `timezone` 和 `timeZone`、`toTimezone` 和 `toTimeZone`、`timezoneOf` 和 `timeZoneOf`。 [#22001](https://github.com/ClickHouse/ClickHouse/pull/22001) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 为 `CREATE/ALTER USER` 命令新增可选子句 `GRANTEES`。该子句指定哪些用户或角色被允许从此用户处获得权限授予，前提是此用户自身也已通过带有 GRANT 选项的方式获得所有所需的访问权限。默认使用 `GRANTEES ANY`，表示具有 GRANT 选项的用户可以向任意主体授予权限。语法：`CREATE USER ... GRANTEES {user | role | ANY | NONE} [,...] [EXCEPT {user | role} [,...]]`。[#21641](https://github.com/ClickHouse/ClickHouse/pull/21641)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 在 `system.clusters` 中新增列 `slowdowns_count`。在使用对冲请求时，该列表示由于当前副本响应过慢而切换到其他副本的次数。同时在 `system.clusters` 中显示 `errors_count` 的实际值。[#21480](https://github.com/ClickHouse/ClickHouse/pull/21480)（[Kruglov Pavel](https://github.com/Avogar)）。
* 为 `MergeTree*` 引擎添加 `_partition_id` 虚拟列。允许通过 `_partition_id` 进行分区剪枝。添加 `partitionID()` 函数用于计算分区 ID 字符串。 [#21401](https://github.com/ClickHouse/ClickHouse/pull/21401) ([Amos Bird](https://github.com/amosbird))。
* 添加函数 `isIPAddressInRange`，用于判断某个 IPv4 或 IPv6 地址是否落在给定的 CIDR 网络前缀范围内。 [#21329](https://github.com/ClickHouse/ClickHouse/pull/21329) ([PHO](https://github.com/depressed-pho))。
* 新增了一个 SQL 命令 `ALTER TABLE 'table_name' UNFREEZE [PARTITION 'part_expr'] WITH NAME 'backup_name'`。该命令用于从所有磁盘中正确删除已“冻结”的分区。[#21142](https://github.com/ClickHouse/ClickHouse/pull/21142) ([Pavel Kovalenko](https://github.com/Jokser))。
* 支持在 JOIN 中进行键的隐式类型转换。[#19885](https://github.com/ClickHouse/ClickHouse/pull/19885) ([Vladimir](https://github.com/vdimir)).

#### 实验性功能 {#experimental-feature-6}

- 支持浮点类型的 `RANGE OFFSET` 帧(用于窗口函数)。实现了 `lagInFrame`/`leadInFrame` 窗口函数,它们类似于 `lag`/`lead`,但会遵循窗口帧的定义。当帧为 `between unbounded preceding and unbounded following` 时,两者行为相同。此更改解决了 [#5485](https://github.com/ClickHouse/ClickHouse/issues/5485)。[#21895](https://github.com/ClickHouse/ClickHouse/pull/21895) ([Alexander Kuzmenkov](https://github.com/akuzm))。
- 为基于 S3 存储的 `ReplicatedMergeTree` 提供零拷贝复制功能。[#16240](https://github.com/ClickHouse/ClickHouse/pull/16240) ([ianton-ru](https://github.com/ianton-ru))。
- 新增将现有 S3 磁盘迁移到支持备份恢复功能的架构的能力。[#22070](https://github.com/ClickHouse/ClickHouse/pull/22070) ([Pavel Kovalenko](https://github.com/Jokser))。

#### 性能改进 {#performance-improvement-7}

- 在 `clickhouse-local` 及其他所有场景中支持并行格式化。[#21630](https://github.com/ClickHouse/ClickHouse/pull/21630) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 支持 `CSVWithNames` 和 `TSVWithNames` 格式的并行解析。此更改解决了 [#21085](https://github.com/ClickHouse/ClickHouse/issues/21085)。[#21149](https://github.com/ClickHouse/ClickHouse/pull/21149) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 为 64 MiB 及以上的文件范围启用 mmap IO 读取(通过设置 `min_bytes_to_use_mmap_io`)。这可能带来适度的性能提升。[#22326](https://github.com/ClickHouse/ClickHouse/pull/22326) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 为使用 `min_bytes_to_use_mmap_io` 设置读取的文件添加缓存。当该设置值较小时,通过避免频繁的 mmap/munmap 调用及其导致的页面错误,可实现显著的性能提升(2 倍或更高)。需要注意的是,mmap IO 存在重大缺陷,使其在生产环境中可靠性较低(例如,在故障磁盘上可能挂起或触发 SIGBUS;内存使用难以控制)。尽管如此,它在基准测试中表现良好。[#22206](https://github.com/ClickHouse/ClickHouse/pull/22206) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 使用编解码器 `NONE` 时避免不必要的数据复制。请注意,编解码器 `NONE` 在大多数情况下并无实际用途 - 建议始终使用压缩(默认为 `LZ4`)。与普遍认知相反,禁用压缩可能不会提升性能(甚至可能产生相反效果)。`NONE` 编解码器在以下情况下有用:- 数据不可压缩时;- 用于合成基准测试。[#22145](https://github.com/ClickHouse/ClickHouse/pull/22145) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 在 `max_rows_to_group_by` 较小且 `group_by_overflow_mode='any'` 时,`GROUP BY` 性能更快。[#21856](https://github.com/ClickHouse/ClickHouse/pull/21856) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 优化类似 `SELECT ... FINAL ... WHERE` 的查询性能。现在在使用 `FINAL` 的查询中,允许将排序键中的列移至 `PREWHERE`。[#21830](https://github.com/ClickHouse/ClickHouse/pull/21830) ([foolchi](https://github.com/foolchi))。
- 通过替换 `memcpy` 实现来提升性能。此更改解决了 [#18583](https://github.com/ClickHouse/ClickHouse/issues/18583)。[#21520](https://github.com/ClickHouse/ClickHouse/pull/21520) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 改进按排序键顺序进行聚合的性能(启用 `optimize_aggregation_in_order` 设置时)。[#19401](https://github.com/ClickHouse/ClickHouse/pull/19401) ([Anton Popov](https://github.com/CurtizJ))。

#### 改进 {#improvement-7}


* 为 PostgreSQL 表/数据库引擎和字典源添加了连接池。应已修复 [#21444](https://github.com/ClickHouse/ClickHouse/issues/21444)。[#21839](https://github.com/ClickHouse/ClickHouse/pull/21839)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在 postgres storage/table-function 中支持非默认表模式。关闭 [#21701](https://github.com/ClickHouse/ClickHouse/issues/21701)。[#21711](https://github.com/ClickHouse/ClickHouse/pull/21711)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 支持 PostgreSQL 字典源的副本优先级。 [#21710](https://github.com/ClickHouse/ClickHouse/pull/21710) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 引入一个新的 MergeTree 设置 `min_bytes_to_rebalance_partition_over_jbod`，用于将新的数据分片均衡地分配到 JBOD 卷中的不同磁盘上。[#16481](https://github.com/ClickHouse/ClickHouse/pull/16481) ([Amos Bird](https://github.com/amosbird))。
* 在 `system.query_log` 中为相应查询的 `query_kind` 列新增 `Grant`、`Revoke` 和 `System` 值。 [#21102](https://github.com/ClickHouse/ClickHouse/pull/21102) ([Vasily Nemkov](https://github.com/Enmk)).
* 允许独立于其他 HTTP 超时设置，自定义用于复制的 HTTP 连接的超时时间。 [#20088](https://github.com/ClickHouse/ClickHouse/pull/20088) ([nvartolomei](https://github.com/nvartolomei)).
* 当服务器在写入数据块时发生异常时，为客户端提供了更合理的异常消息。在先前的版本中，客户端可能会收到具有误导性的消息，例如 `Data compressed with different methods`。 [#22427](https://github.com/ClickHouse/ClickHouse/pull/22427) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复在 fetch part 失败后可能出现的错误 `Directory tmp_fetch_XXX already exists`。如果临时拉取目录已存在，则将其删除。修复了 [#14197](https://github.com/ClickHouse/ClickHouse/issues/14197)。[#22411](https://github.com/ClickHouse/ClickHouse/pull/22411)（[nvartolomei](https://github.com/nvartolomei)）。
* 修复函数 `range` 在使用 `UInt256` 参数时的 MSan 报告（对大整数的支持仍为实验性功能）。此更改关闭了 [#22157](https://github.com/ClickHouse/ClickHouse/issues/22157)。[#22387](https://github.com/ClickHouse/ClickHouse/pull/22387)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 向 `system.processes` 表中添加 `current_database` 列，用于表示查询当前所在的数据库。[#22365](https://github.com/ClickHouse/ClickHouse/pull/22365) ([Alexander Kuzmenkov](https://github.com/akuzm))。
* 为 `clickhouse-client` 添加不区分大小写的历史记录搜索/导航以及子单词移动功能。[#22105](https://github.com/ClickHouse/ClickHouse/pull/22105)（[Amos Bird](https://github.com/amosbird)）。
* 如果在 `IN` 运算符中，左侧是由 `NULL` 组成的元组（例如 `(NULL, NULL)`），而右侧是由不含 `NULL` 的元组组成（例如 `SELECT (NULL, NULL) IN ((0, 0), (3, 1))`），则返回 0，而不是抛出类型不兼容的异常。该表达式也可能由于对如下语句进行优化而出现：`SELECT (NULL, NULL) = (8, 0) OR (NULL, NULL) = (3, 2) OR (NULL, NULL) = (0, 0) OR (NULL, NULL) = (3, 1)`。此更改修复了 [#22017](https://github.com/ClickHouse/ClickHouse/issues/22017)。[#22063](https://github.com/ClickHouse/ClickHouse/pull/22063)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 将使用的 simdjson 版本更新为 0.9.1，以修复 [#21984](https://github.com/ClickHouse/ClickHouse/issues/21984)。[#22057](https://github.com/ClickHouse/ClickHouse/pull/22057)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 为 `CONNECTION_ID()` 和 `VERSION()` 函数添加了大小写不敏感的别名，从而修复了 [#22028](https://github.com/ClickHouse/ClickHouse/issues/22028)。[#22042](https://github.com/ClickHouse/ClickHouse/pull/22042)（[Eugene Klimov](https://github.com/Slach)）。
* 为 `windowFunnel` 函数添加 `strict_increase` 选项，使每个事件仅被计算一次（解决 [#21835](https://github.com/ClickHouse/ClickHouse/issues/21835)）。[#22025](https://github.com/ClickHouse/ClickHouse/pull/22025)（[Vladimir](https://github.com/vdimir)）。
* 如果 `MergeTree` 表的分区键未包含 `Date` 或 `DateTime` 列，但恰好包含一列 `DateTime64` 列，则在 `system.parts` 和 `system.parts_columns` 表的 `min_time` 与 `max_time` 列中暴露其取值。向 `system.parts_columns` 表添加 `min_time` 和 `max_time` 列（此前与 `system.parts` 表存在不一致）。修复了 [#18244](https://github.com/ClickHouse/ClickHouse/issues/18244)。[#22011](https://github.com/ClickHouse/ClickHouse/pull/22011)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 `clickhouse-copier` 中新增对在将分区从辅助表移动到目标表时使用 `replication_alter_partitions_sync=1` 设置的支持。缩短了默认超时时间。修复了 [#21911](https://github.com/ClickHouse/ClickHouse/issues/21911)。[#21912](https://github.com/ClickHouse/ClickHouse/pull/21912)（[turbo jason](https://github.com/songenjie)）。
* 在 system 表中显示 `EmbeddedRocksDB` 表的数据目录路径。 [#21903](https://github.com/ClickHouse/ClickHouse/pull/21903) ([tavplubix](https://github.com/tavplubix)).
* 添加 profile 事件 `HedgedRequestsChangeReplica`，将读取数据的超时时间从秒改为毫秒。 [#21886](https://github.com/ClickHouse/ClickHouse/pull/21886) ([Kruglov Pavel](https://github.com/Avogar)).
* DiskS3（开发中的实验性功能）。修复了在目标目录非空且使用缓存磁盘时无法移动目录的错误。 [#21837](https://github.com/ClickHouse/ClickHouse/pull/21837) ([Pavel Kovalenko](https://github.com/Jokser))。
* 改进了 Web UI 中 `Array` 和 `Map` 数据类型的格式化显示。[#21798](https://github.com/ClickHouse/ClickHouse/pull/21798) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 只有在其配置发生变更时才更新集群。[#21685](https://github.com/ClickHouse/ClickHouse/pull/21685) ([Kruglov Pavel](https://github.com/Avogar))。
* 在分布式 DDL 查询中传播查询和会话设置。将 `distributed_ddl_entry_format_version` 设置为 2 以启用此功能。新增 `distributed_ddl_output_mode` 设置。支持的模式：`none`、`throw`（默认）、`null_status_on_timeout` 和 `never_throw`。对 `Replicated` 数据库引擎进行了多项修复和改进。[#21535](https://github.com/ClickHouse/ClickHouse/pull/21535) ([tavplubix](https://github.com/tavplubix))。
* 如果使用元素大小既不是 16 的倍数也不是 16 的因数来实例化 `PODArray`，则可能发生缓冲区溢出。目前发布的版本中不存在相关缺陷。[#21533](https://github.com/ClickHouse/ClickHouse/pull/21533)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 `system.errors` 添加 `last_error_time`/`last_error_message`/`last_error_stacktrace`/`remote` 列。 [#21529](https://github.com/ClickHouse/ClickHouse/pull/21529) ([Azat Khuzhin](https://github.com/azat)).
* 将 `simpleJSONExtract/simpleJSONHas` 添加为 `visitParam/visitParamExtract{UInt, Int, Bool, Float, Raw, String}` 的别名。修复问题 #21383。[#21519](https://github.com/ClickHouse/ClickHouse/pull/21519) ([fastio](https://github.com/fastio))。
* 添加 `optimize_skip_unused_shards_limit` 设置，用于限制 `optimize_skip_unused_shards` 的分片键值数量。 [#21512](https://github.com/ClickHouse/ClickHouse/pull/21512) ([Azat Khuzhin](https://github.com/azat))。
* 改进 `clickhouse-format`，使其在最后一个查询后存在额外空格或注释时不再抛出异常，并在格式化带有数据的 `ASTInsertQuery` 时尽早抛出带有可读错误信息的异常。 [#21311](https://github.com/ClickHouse/ClickHouse/pull/21311) ([flynn](https://github.com/ucasFL)).
* 提升对数据类型 `Map` 中整数键的支持。[#21157](https://github.com/ClickHouse/ClickHouse/pull/21157)（[Anton Popov](https://github.com/CurtizJ)）。
* MaterializeMySQL：在连接丢失时尝试重新连接到 MySQL。[#20961](https://github.com/ClickHouse/ClickHouse/pull/20961)（[Håvard Kvålen](https://github.com/havardk)）。
* 在更多情况下支持将 `CROSS JOIN` 重写为 `INNER JOIN`。[#20392](https://github.com/ClickHouse/ClickHouse/pull/20392) ([Vladimir](https://github.com/vdimir))。
* 在启用 `optimize_on_insert` 设置时，避免在执行 INSERT 时创建空的数据分片。修复了 [#20304](https://github.com/ClickHouse/ClickHouse/issues/20304)。[#20387](https://github.com/ClickHouse/ClickHouse/pull/20387)（[Kruglov Pavel](https://github.com/Avogar)）。
* `MaterializeMySQL`：为 `_version` 列添加 minmax 跳过索引。[#20382](https://github.com/ClickHouse/ClickHouse/pull/20382) ([Stig Bakken](https://github.com/stigsb))。
* 为 `clickhouse-format` 添加选项 `--backslash`，用于在格式化查询的每一行末尾添加反斜杠。[#21494](https://github.com/ClickHouse/ClickHouse/pull/21494) ([flynn](https://github.com/ucasFL))。
* 现在，当我们尝试对已覆盖的部分执行变更操作时，ClickHouse 将不再抛出 `LOGICAL_ERROR` 异常。修复了 [#22013](https://github.com/ClickHouse/ClickHouse/issues/22013)。[#22291](https://github.com/ClickHouse/ClickHouse/pull/22291)（[alesapin](https://github.com/alesapin)）。

#### 错误修复 {#bug-fix-6}


* 在 `HedgedConnections` 中，在取消数据包接收器之前先从 epoll 中移除 socket，以防止潜在的竞态条件。修复 [#22161](https://github.com/ClickHouse/ClickHouse/issues/22161)。[#22443](https://github.com/ClickHouse/ClickHouse/pull/22443)（[Kruglov Pavel](https://github.com/Avogar)）。
* 在并行解析流程中补充缺失的内存统计。在先前版本中，当结果集包含非常大的数据块时，可能会发生 OOM（内存不足）。此更改解决了 [#22008](https://github.com/ClickHouse/ClickHouse/issues/22008)。[#22425](https://github.com/ClickHouse/ClickHouse/pull/22425)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复当 `SELECT` 语句的 `WHERE` 条件为常量且源表中存在以数字命名的列时可能发生的异常。[#22270](https://github.com/ClickHouse/ClickHouse/pull/22270) ([LiuNeng](https://github.com/liuneng1994))。
* 修复在 `use_hedged_requests=0` 且 `async_socket_for_remote=1` 时的查询取消问题。[#22183](https://github.com/ClickHouse/ClickHouse/pull/22183) ([Azat Khuzhin](https://github.com/azat)).
* 修复 `InterserverIOHTTPHandler` 中未捕获的异常。[#22146](https://github.com/ClickHouse/ClickHouse/pull/22146) ([Azat Khuzhin](https://github.com/azat))。
* 在配置中未设置 `http_port` 时修复 Docker 入口点。[#22132](https://github.com/ClickHouse/ClickHouse/pull/22132) ([Ewout](https://github.com/devwout))。
* 修复在 `JOIN` 结合 `TOTALS` 和 `arrayJoin` 时出现的 `Invalid number of rows in Chunk` 错误。关闭 [#19303](https://github.com/ClickHouse/ClickHouse/issues/19303)。[#22129](https://github.com/ClickHouse/ClickHouse/pull/22129)（[Vladimir](https://github.com/vdimir)）。
* 修复用于从 Kafka 轮询消息的后台线程池名称。线程池出现问题的 Kafka 引擎将无法从消息队列中消费消息。[#22122](https://github.com/ClickHouse/ClickHouse/pull/22122) ([fastio](https://github.com/fastio))。
* 修复了 `ReplicatedMergeTree` 表引擎中对 `OPTIMIZE` 和 `ALTER` 查询的等待问题。现在当表被分离或重启时，查询将不会挂起。[#22118](https://github.com/ClickHouse/ClickHouse/pull/22118) ([alesapin](https://github.com/alesapin)).
* 为有缺陷的 Linux 内核禁用 `async_socket_for_remote`/`use_hedged_requests`。 [#22109](https://github.com/ClickHouse/ClickHouse/pull/22109) ([Azat Khuzhin](https://github.com/azat))。
* Docker entrypoint：当 `LOG_PATH` 为空时，避免对 `.` 执行 chown 操作。关闭了 [#22100](https://github.com/ClickHouse/ClickHouse/issues/22100)。[#22102](https://github.com/ClickHouse/ClickHouse/pull/22102)（[filimonov](https://github.com/filimonov)）。
* 函数 `decrypt` 缺少对在 `AEAD` 模式下加密数据最小长度的检查。此更改修复了 [#21897](https://github.com/ClickHouse/ClickHouse/issues/21897)。[#22064](https://github.com/ClickHouse/ClickHouse/pull/22064)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在极少数情况下，`CollapsingMergeTree` 的合并可能会创建包含 `index_granularity + 1` 行的 granule。由于这一点，在 [#18928](https://github.com/ClickHouse/ClickHouse/issues/18928) 中添加的内部检查（影响 21.2 和 21.3）可能会失败，并报错 `Incomplete granules are not allowed while blocks are granules size`。该错误会阻止数据分片进行合并。[#21976](https://github.com/ClickHouse/ClickHouse/pull/21976)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 回滚了可能在加载哈希类型外部字典时导致内存使用量显著增加的更改 [#15454](https://github.com/ClickHouse/ClickHouse/issues/15454)。这解决了 [#21935](https://github.com/ClickHouse/ClickHouse/issues/21935)。[#21948](https://github.com/ClickHouse/ClickHouse/pull/21948)（[Maksim Kita](https://github.com/kitaisreal)）。
* 防止对冲连接出现重叠（`Unknown packet 9 from server` 错误）。 [#21941](https://github.com/ClickHouse/ClickHouse/pull/21941) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在某些情况下读取内容类型为 &quot;multipart/form-data&quot; 的 HTTP POST 请求时的问题。[#21936](https://github.com/ClickHouse/ClickHouse/pull/21936) ([Ivan](https://github.com/abyss7))。
* 修复在查询包含窗口函数并启用了按主键顺序读取优化时，导致 `ORDER BY` 结果错误的问题。修复 [#21828](https://github.com/ClickHouse/ClickHouse/issues/21828)。[#21915](https://github.com/ClickHouse/ClickHouse/pull/21915)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* 修复首次执行 CatBoost 模型时的死锁问题。关闭 [#13832](https://github.com/ClickHouse/ClickHouse/issues/13832)。[#21844](https://github.com/ClickHouse/ClickHouse/pull/21844)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复了当将 `WHERE` 或 `HAVING` 条件下推到 `GROUP BY` 之前时，可能导致查询结果不正确（以及可能崩溃）的问题。修复了 [#21773](https://github.com/ClickHouse/ClickHouse/issues/21773)。[#21841](https://github.com/ClickHouse/ClickHouse/pull/21841)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 在 `WriteBufferFromS3` 中完善错误处理和日志记录。[#21836](https://github.com/ClickHouse/ClickHouse/pull/21836)（[Pavel Kovalenko](https://github.com/Jokser)）。
* 修复在使用两级聚合时，带有 `Distinct` 组合器的聚合函数可能发生的崩溃问题。这是对 [#18365](https://github.com/ClickHouse/ClickHouse/pull/18365) 的后续修复。该问题仅能在生产环境中复现。[#21818](https://github.com/ClickHouse/ClickHouse/pull/21818) ([Amos Bird](https://github.com/amosbird))。
* 修复标量子查询的索引分析。这解决了在 [#18896](https://github.com/ClickHouse/ClickHouse/pull/18896) 中引入的 [#21717](https://github.com/ClickHouse/ClickHouse/issues/21717)。[#21766](https://github.com/ClickHouse/ClickHouse/pull/21766)（[Amos Bird](https://github.com/amosbird)）。
* 修复 `ReplicatedMerge` 表引擎中的一个错误：当执行 `ALTER MODIFY COLUMN` 查询且 `Decimal` 列的大小（32 位或 64 位）未发生变化时，其列类型不会被修改的问题。[#21728](https://github.com/ClickHouse/ClickHouse/pull/21728) ([alesapin](https://github.com/alesapin)).
* 修复在 `ReplicatedMergeTree` 上并发运行 `OPTIMIZE` 和 `DROP` 时可能出现的无限期等待问题。[#21716](https://github.com/ClickHouse/ClickHouse/pull/21716) ([Azat Khuzhin](https://github.com/azat)).
* 修复在数据类型为 `Map` 且整型参数为常量时的 `arrayElement` 函数。[#21699](https://github.com/ClickHouse/ClickHouse/pull/21699) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在使用 `access_to_key_from_attributes` 访问 `ip_trie` 中不存在的属性时发生的 SIGSEGV 错误。 [#21692](https://github.com/ClickHouse/ClickHouse/pull/21692) ([Azat Khuzhin](https://github.com/azat)).
* 服务器现在只有在完成 `DDLWorker` 和字典初始化后才开始接受连接。 [#21676](https://github.com/ClickHouse/ClickHouse/pull/21676) ([Azat Khuzhin](https://github.com/azat)).
* 为 `Join` 类型表的键添加类型转换（此前可能会导致 SIGSEGV）。[#21646](https://github.com/ClickHouse/ClickHouse/pull/21646) ([Azat Khuzhin](https://github.com/azat)).
* 修复在启用 `async_socket_for_remote=1` 时分布式请求的取消行为（例如对多个分片执行带有 LIMIT 的简单查询，即 `select * from remote('127.{2,3}', system.numbers) limit 100`）。[#21643](https://github.com/ClickHouse/ClickHouse/pull/21643)（[Azat Khuzhin](https://github.com/azat)）。
* 修复 `fsync_part_directory` 以支持水平合并。 [#21642](https://github.com/ClickHouse/ClickHouse/pull/21642) ([Azat Khuzhin](https://github.com/azat)).
* 在对外部数据库引擎（MySQL、PostgreSQL）的查询中，从连接表的 `WHERE` 子句中移除未知列。关闭 [#14614](https://github.com/ClickHouse/ClickHouse/issues/14614)、关闭 [#19288](https://github.com/ClickHouse/ClickHouse/issues/19288)（重复）、关闭 [#19645](https://github.com/ClickHouse/ClickHouse/issues/19645)（重复）。[#21640](https://github.com/ClickHouse/ClickHouse/pull/21640)（[Vladimir](https://github.com/vdimir)）。
* 如果在向 S3 写入数据时发生错误，就会调用 `std::terminate`。 [#21624](https://github.com/ClickHouse/ClickHouse/pull/21624) ([Vladimir](https://github.com/vdimir)).
* 修复在启用 `optimize_skip_unused_shards` 且未使用任何分片时可能出现的 `Cannot find column` 错误。[#21579](https://github.com/ClickHouse/ClickHouse/pull/21579) ([Azat Khuzhin](https://github.com/azat)).
* 在查询包含常量 `WHERE` 条件且启用了 `optimize_skip_unused_shards` 设置时，所有分片可能会被跳过，从而导致查询错误地返回空结果。 [#21550](https://github.com/ClickHouse/ClickHouse/pull/21550) ([Amos Bird](https://github.com/amosbird)).
* 修复表函数 `clusterAllReplicas` 返回错误 `_shard_num` 的问题，关闭 [#21481](https://github.com/ClickHouse/ClickHouse/issues/21481)。[#21498](https://github.com/ClickHouse/ClickHouse/pull/21498)（[flynn](https://github.com/ucasFL)）。
* 修复在更新配置后，S3 表仍然保留旧凭证的问题。[#21457](https://github.com/ClickHouse/ClickHouse/pull/21457) ([Grigory Pervakov](https://github.com/GrigoryPervakov))。
* 修复了 Poco 中 `SecureSocket` 内部 SSL 对象上的竞态条件。 [#21456](https://github.com/ClickHouse/ClickHouse/pull/21456) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 修复 `Kafka` 的 `Avro` 格式解析问题。修复 [#21437](https://github.com/ClickHouse/ClickHouse/issues/21437)。[#21438](https://github.com/ClickHouse/ClickHouse/pull/21438)（[Ilya Golshtein](https://github.com/ilejn)）。
* 修复安全套接字中的接收和发送超时以及非阻塞读取。[#21429](https://github.com/ClickHouse/ClickHouse/pull/21429) ([Kruglov Pavel](https://github.com/Avogar))。
* `force_drop_table` 标志对 `MATERIALIZED VIEW` 不起作用的问题已修复。修复了 [#18943](https://github.com/ClickHouse/ClickHouse/issues/18943)。[#20626](https://github.com/ClickHouse/ClickHouse/pull/20626)（[tavplubix](https://github.com/tavplubix)）。
* 修复 `PredicateRewriteVisitor` 中的命名冲突问题。该问题会在执行 FULL JOIN 后导致 `WHERE` 子句过滤不正确。关闭 [#20497](https://github.com/ClickHouse/ClickHouse/issues/20497)。[#20622](https://github.com/ClickHouse/ClickHouse/pull/20622)（[Vladimir](https://github.com/vdimir)）。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-7}


* 为 ClickHouse Keeper 添加 [Jepsen](https://github.com/jepsen-io/jepsen) 测试。[#21677](https://github.com/ClickHouse/ClickHouse/pull/21677) ([alesapin](https://github.com/alesapin))。
* 在 CI 中并行运行无状态测试。取决于 [#22181](https://github.com/ClickHouse/ClickHouse/issues/22181)。[#22300](https://github.com/ClickHouse/ClickHouse/pull/22300)（[alesapin](https://github.com/alesapin)）。
* 为 [SQLancer](https://github.com/sqlancer/sqlancer) 的 CI 运行启用状态检查。[#22015](https://github.com/ClickHouse/ClickHouse/pull/22015)（[Ilya Yatsishin](https://github.com/qoega)）。
* 针对 PowerPC 构建的多项准备工作：在 `ppc64le` 上启用内置的 openldap。[#22487](https://github.com/ClickHouse/ClickHouse/pull/22487) ([Kfir Itzhak](https://github.com/mastertheknife))。在 `ppc64le` 上启用使用 Clang 编译。[#22476](https://github.com/ClickHouse/ClickHouse/pull/22476) ([Kfir Itzhak](https://github.com/mastertheknife))。修复在 `ppc64le` 上编译 boost 的问题。[#22474](https://github.com/ClickHouse/ClickHouse/pull/22474) ([Kfir Itzhak](https://github.com/mastertheknife))。修复在 `ppc64le` 上内部 CMake 变量 `CMAKE_ASM_COMPILE_OBJECT` 未设置导致的 CMake 错误。[#22469](https://github.com/ClickHouse/ClickHouse/pull/22469) ([Kfir Itzhak](https://github.com/mastertheknife))。修复 Fedora/RHEL/CentOS 在 `ppc64le` 上找不到 `libclang_rt.builtins` 的问题。[#22458](https://github.com/ClickHouse/ClickHouse/pull/22458) ([Kfir Itzhak](https://github.com/mastertheknife))。在 `ppc64le` 上启用使用 `jemalloc` 进行构建。[#22447](https://github.com/ClickHouse/ClickHouse/pull/22447) ([Kfir Itzhak](https://github.com/mastertheknife))。修复 ClickHouse 的配置嵌入以及 cctz 的时区嵌入在 `ppc64le` 上的问题。[#22445](https://github.com/ClickHouse/ClickHouse/pull/22445) ([Kfir Itzhak](https://github.com/mastertheknife))。修复在 `ppc64le` 上的编译问题，并在 `ppc64le` 上使用正确的指令指针寄存器。[#22430](https://github.com/ClickHouse/ClickHouse/pull/22430) ([Kfir Itzhak](https://github.com/mastertheknife))。
* 在 `aarch64` 架构上重新启用 S3（AWS）库。[#22484](https://github.com/ClickHouse/ClickHouse/pull/22484) ([Kfir Itzhak](https://github.com/mastertheknife))。
* 将 `tzdata` 添加到 Docker 容器中，因为读取 `ORC` 格式的数据需要它。此更改解决了 [#14156](https://github.com/ClickHouse/ClickHouse/issues/14156)。[#22000](https://github.com/ClickHouse/ClickHouse/pull/22000)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 `clickhouse-server` 镜像的 Dockerfile 新增两个参数：`deb_location` 和 `single_binary_location`。[#21977](https://github.com/ClickHouse/ClickHouse/pull/21977) ([filimonov](https://github.com/filimonov))。
* 当使用 clang-tidy 时启用断言，从而允许在 release 构建中使用 clang-tidy。 [#21914](https://github.com/ClickHouse/ClickHouse/pull/21914) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 在 CMake 脚本中添加对 llvm-12 二进制可执行文件名称的搜索。调整隐式常量转换以消除 clang 警告。更新子模块以使用 CMake 3.19 构建。在 `readpassphrase` 库中静默宏展开中的递归。在 clang 中将已弃用的 `-fuse-ld` 替换为 `--ld-path`。[#21597](https://github.com/ClickHouse/ClickHouse/pull/21597)（[Ilya Yatsishin](https://github.com/qoega)）。
* 将 `docker/test/testflows/runner/dockerd-entrypoint.sh` 更新为使用 Yandex dockerhub-proxy，因为 Docker Hub 已启用非常严格的拉取频率限制 [#21551](https://github.com/ClickHouse/ClickHouse/pull/21551) ([vzakaznikov](https://github.com/vzakaznikov))。
* 修复 macOS 共享库的构建。 [#20184](https://github.com/ClickHouse/ClickHouse/pull/20184) ([nvartolomei](https://github.com/nvartolomei)).
* 为 `zookeeper-dump-tree` 添加 `ctime` 选项，用于导出节点的创建时间。 [#21842](https://github.com/ClickHouse/ClickHouse/pull/21842) ([Ilya](https://github.com/HumanUser)).





## ClickHouse 21.3 版本 (LTS) {#clickhouse-release-213-lts}

### ClickHouse v21.3 版本,2021-03-12 {#clickhouse-release-v213-2021-03-12}

#### 不兼容变更 {#backward-incompatible-change-8}

- 现在不允许使用旧语法创建带有表 TTL 的 MergeTree 表,因为 TTL 设置会被忽略。仍可附加旧表。[#20282](https://github.com/ClickHouse/ClickHouse/pull/20282) ([alesapin](https://github.com/alesapin)).
- 现在所有不区分大小写的函数名称都将被重写为其规范形式。这是投影查询路由(即将推出的功能)所必需的。[#20174](https://github.com/ClickHouse/ClickHouse/pull/20174) ([Amos Bird](https://github.com/amosbird)).
- 修复了当 `TTL` 表达式为函数且与 `ORDER BY` 键相同时创建 `TTL` 的问题。现在允许在带有 `GROUP BY` 的 `TTL` 中为主键列设置自定义聚合。不兼容变更:对于不在 `GROUP BY` 中且未显式设置的主键列,当 TTL 过期时,现在应用 `any` 函数而非 `max` 函数。此外,如果在 TTL 中使用 `WHERE` 或 `GROUP BY`,在进行滚动更新时可能会在合并过程中遇到异常。[#15450](https://github.com/ClickHouse/ClickHouse/pull/15450) ([Anton Popov](https://github.com/CurtizJ)).

#### 新功能 {#new-feature-8}


- 添加文件引擎设置：`engine_file_empty_if_not_exists` 和 `engine_file_truncate_on_insert`。[#20620](https://github.com/ClickHouse/ClickHouse/pull/20620) ([M0r64n](https://github.com/M0r64n))。
- 添加聚合函数 `deltaSum`，用于计算连续行之间的差值总和。[#20057](https://github.com/ClickHouse/ClickHouse/pull/20057) ([Russ Frank](https://github.com/rf))。
- `system.part_log` 表新增 `event_time_microseconds` 列。[#20027](https://github.com/ClickHouse/ClickHouse/pull/20027) ([Bharat Nallan](https://github.com/bharatnc))。
- 添加 `timezoneOffset(datetime)` 函数，返回相对于 UTC 的时区偏移量(以秒为单位)。此功能关闭了 [#issue:19850](https://github.com/ClickHouse/ClickHouse/issues/19850)。[#19962](https://github.com/ClickHouse/ClickHouse/pull/19962) ([keenwolf](https://github.com/keen-wolf))。
- 添加 `insert_shard_id` 设置，支持从分布式表向指定分片插入数据。[#19961](https://github.com/ClickHouse/ClickHouse/pull/19961) ([flynn](https://github.com/ucasFL))。
- 更新 `reinterpretAs` 函数以支持大整数。修复 [#19691](https://github.com/ClickHouse/ClickHouse/issues/19691)。[#19858](https://github.com/ClickHouse/ClickHouse/pull/19858) ([Maksim Kita](https://github.com/kitaisreal))。
- S3 客户端添加服务器端加密客户密钥(`x-amz-server-side-encryption-customer-(key/md5)` 标头)支持。参见[此链接](https://docs.aws.amazon.com/AmazonS3/latest/dev/ServerSideEncryptionCustomerKeys.html)。关闭 [#19428](https://github.com/ClickHouse/ClickHouse/issues/19428)。[#19748](https://github.com/ClickHouse/ClickHouse/pull/19748) ([Vladimir Chebotarev](https://github.com/excitoon))。
- 为 `executable` 字典源添加 `implicit_key` 选项。当记录顺序与输入键顺序一致时，该选项允许避免为每条记录输出键。实现 [#14527](https://github.com/ClickHouse/ClickHouse/issues/14527)。[#19677](https://github.com/ClickHouse/ClickHouse/pull/19677) ([Maksim Kita](https://github.com/kitaisreal))。
- 添加配额类型 `query_selects` 和 `query_inserts`。[#19603](https://github.com/ClickHouse/ClickHouse/pull/19603) ([JackyWoo](https://github.com/JackyWoo))。
- 添加函数 `extractTextFromHTML` [#19600](https://github.com/ClickHouse/ClickHouse/pull/19600) ([zlx19950903](https://github.com/zlx19950903)), ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 使用 `MergeTree*` 引擎的表新增两个表级设置用于查询并发控制。`max_concurrent_queries` 设置限制与该表相关的并发执行查询数量。`min_marks_to_honor_max_concurrent_queries` 设置指定仅当查询读取至少指定数量的标记时才应用前述设置。[#19544](https://github.com/ClickHouse/ClickHouse/pull/19544) ([Amos Bird](https://github.com/amosbird))。
- 添加 `file` 函数，用于从 user_files 目录读取文件并以字符串形式返回。该函数与 `file` 表函数不同。实现 [#issue:18851](https://github.com/ClickHouse/ClickHouse/issues/18851)。[#19204](https://github.com/ClickHouse/ClickHouse/pull/19204) ([keenwolf](https://github.com/keen-wolf))。

#### 实验性功能 {#experimental-feature-7}


- 添加实验性 `Replicated` 数据库引擎。该引擎可在多个主机间复制 DDL 查询。[#16193](https://github.com/ClickHouse/ClickHouse/pull/16193) ([tavplubix](https://github.com/tavplubix))。
- 引入窗口函数的实验性支持,通过 `allow_experimental_window_functions = 1` 启用。这是一个初步的 alpha 质量实现,不适用于生产环境,且在未来版本中将以不向后兼容的方式进行更改。请参阅[文档](https://github.com/ClickHouse/ClickHouse/blob/master/docs/sql-reference/window-functions/index.md#experimental-window-functions)了解支持的功能列表。[#20337](https://github.com/ClickHouse/ClickHouse/pull/20337) ([Alexander Kuzmenkov](https://github.com/akuzm))。
- 添加 DiskS3 元数据文件的备份/恢复功能。[#18377](https://github.com/ClickHouse/ClickHouse/pull/18377) ([Pavel Kovalenko](https://github.com/Jokser))。

#### 性能改进 {#performance-improvement-8}


* 用于远程查询的对冲请求。启用 `use_hedged_requests` 设置（默认关闭）时，允许针对一次查询与不同副本建立多个连接。如果在 `hedged_connection_timeout` 内尚未与副本建立现有连接，或者在 `receive_data_timeout` 内未收到任何数据，则会建立新的连接。查询将使用第一个发送非空进度数据包（或在 `allow_changing_replica_until_first_data_packet` 为真时，第一个发送数据包）的连接，其余连接将被取消。支持 `max_parallel_replicas > 1` 的查询。[#19291](https://github.com/ClickHouse/ClickHouse/pull/19291)（[Kruglov Pavel](https://github.com/Avogar)）。这可以在非常大的集群上显著降低尾部延迟。
* 当表定义了行级安全表达式时，新增对 `PREWHERE` 的支持（并启用相应的优化）。 [#19576](https://github.com/ClickHouse/ClickHouse/pull/19576) ([Denis Glazachev](https://github.com/traceon))。
* 设置 `distributed_aggregation_memory_efficient` 默认启用。它会减少内存占用并提升分布式查询的性能。[#20599](https://github.com/ClickHouse/ClickHouse/pull/20599) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 提升包含多个固定大小键的 GROUP BY 的性能。 [#20472](https://github.com/ClickHouse/ClickHouse/pull/20472) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 通过更严格的别名规则提升聚合函数的性能。 [#19946](https://github.com/ClickHouse/ClickHouse/pull/19946) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 通过简化 pipeline，从而在 pipeline 调度中减少锁竞争，在极端情况下（读取速度可达 50 GB/秒）加速从 `Memory` 表中读取数据。[#20468](https://github.com/ClickHouse/ClickHouse/pull/20468) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 部分重写 HTTP 服务器，以减少对传入和传出数据的复制次数。这在通过 HTTP 插入长记录时最高可带来约 1.5 倍的性能提升。 [#19516](https://github.com/ClickHouse/ClickHouse/pull/19516) ([Ivan](https://github.com/abyss7)).
* 为 `Memory` 表新增 `compress` 设置。启用后，表将使用更少的 RAM。在某些机器和数据集上，它在执行 SELECT 时也可能更快，但并非总是如此。此改动关闭了 [#20093](https://github.com/ClickHouse/ClickHouse/issues/20093)。注意：`Memory` 表有时会比 `MergeTree` 更慢，原因包括：(1) 缺少压缩；(2) 数据块大小固定；(3) 缺少索引和 `PREWHERE`…… [#20168](https://github.com/ClickHouse/ClickHouse/pull/20168) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 对聚合代码进行了小幅改进。[#20978](https://github.com/ClickHouse/ClickHouse/pull/20978) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 为获得更好的性能，恢复 `intDiv`/`modulo` 的特化实现。修复了 [#21293](https://github.com/ClickHouse/ClickHouse/issues/21293)。该回归问题是在 [https://github.com/ClickHouse/ClickHouse/pull/18145](https://github.com/ClickHouse/ClickHouse/pull/18145) 中引入的。[#21307](https://github.com/ClickHouse/ClickHouse/pull/21307)（[Amos Bird](https://github.com/amosbird)）。
* 在对 Memory 表执行 INSERT SELECT 时不要过度合并数据块。在之前的版本中，INSERT SELECT 之后会在 Memory 表中生成低效的数据表示。此更改修复了 [#13052](https://github.com/ClickHouse/ClickHouse/issues/13052)。[#20169](https://github.com/ClickHouse/ClickHouse/pull/20169)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了至少一种可能导致 `DataType` 解析器出现指数级复杂度的情况（由模糊测试工具发现）。解决了 [#20096](https://github.com/ClickHouse/ClickHouse/issues/20096)。[#20132](https://github.com/ClickHouse/ClickHouse/pull/20132)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 当 `do_not_merge_across_partitions_select_final` 设置为 1 且仅有一个 level &gt; 0 的 part 时，使带有 FINAL 的 SELECT 可以并行执行。[#19375](https://github.com/ClickHouse/ClickHouse/pull/19375) ([Kruglov Pavel](https://github.com/Avogar)).
* 在查询 `system.parts` 和 `system.parts_columns` 时仅填充被请求的列。修复 [#19570](https://github.com/ClickHouse/ClickHouse/issues/19570)。[#21035](https://github.com/ClickHouse/ClickHouse/pull/21035)（[Anmol Arora](https://github.com/anmolarora)）。
* 对 `avg` 聚合函数内部的算术表达式进行代数优化。修复 [#20092](https://github.com/ClickHouse/ClickHouse/issues/20092)。[#20183](https://github.com/ClickHouse/ClickHouse/pull/20183)（[flynn](https://github.com/ucasFL)）。

#### 改进 {#improvement-8}


* 为表函数提供不区分大小写的压缩方法。同时修复了此前仅以大写形式进行检查的 LZMA 压缩方法。[#21416](https://github.com/ClickHouse/ClickHouse/pull/21416) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 添加两个设置，用于在存在过多不活跃数据片段时在插入时进行延迟或报错。当服务器清理这些数据片段的速度不够快时，这非常有用。 [#20178](https://github.com/ClickHouse/ClickHouse/pull/20178) ([Amos Bird](https://github.com/amosbird))。
* 为 MySQL 客户端提供更好的兼容性：1. MySQL JDBC 2. mycli。 [#21367](https://github.com/ClickHouse/ClickHouse/pull/21367) ([Amos Bird](https://github.com/amosbird))。
* 不允许删除被物化视图引用的列。关闭 [#21164](https://github.com/ClickHouse/ClickHouse/issues/21164)。[#21303](https://github.com/ClickHouse/ClickHouse/pull/21303)（[flynn](https://github.com/ucasFL)）。
* MySQL 字典源现在会在遇到意外的连接失败（在查询期间与 MySQL 服务器的连接丢失）时重试，这类问题有时会在 SSL/TLS 连接中发生。 [#21237](https://github.com/ClickHouse/ClickHouse/pull/21237) ([Alexander Kazakov](https://github.com/Akazz)).
* 可用性改进：更一致的 `DateTime64` 解析：能够识别以缩放整数形式指定具有子秒精度的 Unix 时间戳的情况（例如使用 `1111111111222` 而不是 `1111111111.222`）。这解决了 [#13194](https://github.com/ClickHouse/ClickHouse/issues/13194)。[#21053](https://github.com/ClickHouse/ClickHouse/pull/21053)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 仅在启用 distributed&#95;group&#95;by&#95;no&#95;merge 时，在发起端合并已排序的数据块。 [#20882](https://github.com/ClickHouse/ClickHouse/pull/20882) ([Azat Khuzhin](https://github.com/azat)).
* 在加载 `mysql` 源配置时，ClickHouse 现在会随机打乱具有相同优先级的副本列表，以确保在选择 `mysql` 端点时遵循轮询逻辑。这解决了 [#20629](https://github.com/ClickHouse/ClickHouse/issues/20629)。[#20632](https://github.com/ClickHouse/ClickHouse/pull/20632)（[Alexander Kazakov](https://github.com/Akazz)）。
* 函数 &#39;reinterpretAs(x, Type)&#39; 重命名为 &#39;reinterpret(x, Type)&#39;。 [#20611](https://github.com/ClickHouse/ClickHouse/pull/20611) ([Maksim Kita](https://github.com/kitaisreal)).
* 为 RabbitMQ 引擎添加 vhost 支持 [#20576](https://github.com/ClickHouse/ClickHouse/issues/20576)。 [#20596](https://github.com/ClickHouse/ClickHouse/pull/20596) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 改进了由 Array 和 Tuple 组合的数据类型的序列化。改进了 Enum 数据类型与 Protobuf Enum 类型的匹配机制。修复了 `Map` 数据类型的序列化。现在默认会设置被省略的值。[#20506](https://github.com/ClickHouse/ClickHouse/pull/20506) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复了分布式 DDL 任务执行与 DDL 队列清理之间的竞态条件。现在在存在活动 worker 时，ZooKeeper 中的 DDL 任务不会被移除。修复了 [#20016](https://github.com/ClickHouse/ClickHouse/issues/20016)。[#20448](https://github.com/ClickHouse/ClickHouse/pull/20448)（[tavplubix](https://github.com/tavplubix)）。
* 使 FQDN 和其他与 DNS 相关的函数在 Alpine 镜像中正常工作。[#20336](https://github.com/ClickHouse/ClickHouse/pull/20336) ([filimonov](https://github.com/filimonov))。
* 不允许对显式禁止的函数进行提前常量折叠。 [#20303](https://github.com/ClickHouse/ClickHouse/pull/20303) ([Azat Khuzhin](https://github.com/azat)).
* 当整数到 `Decimal` 类型的隐式转换在整数值不适合 `Decimal` 类型时可能仍会错误地成功。现在在这种情况下会抛出 `ARGUMENT_OUT_OF_BOUND`。 [#20232](https://github.com/ClickHouse/ClickHouse/pull/20232) ([tavplubix](https://github.com/tavplubix)).
* 无锁 `SYSTEM FLUSH DISTRIBUTED`。 [#20215](https://github.com/ClickHouse/ClickHouse/pull/20215) ([Azat Khuzhin](https://github.com/azat)).
* 将 count(constant) 和 sum(1) 规范化为 count()。这是投影查询路由所需的。[#20175](https://github.com/ClickHouse/ClickHouse/pull/20175) ([Amos Bird](https://github.com/amosbird))。
* 在 bitmap 函数中支持所有原生整数类型。 [#20171](https://github.com/ClickHouse/ClickHouse/pull/20171) ([Amos Bird](https://github.com/amosbird)).
* 将 `CacheDictionary`、`ComplexCacheDictionary`、`SSDCacheDictionary`、`SSDComplexKeyDictionary` 的底层索引改为使用 LRUHashMap。[#20164](https://github.com/ClickHouse/ClickHouse/pull/20164)（[Maksim Kita](https://github.com/kitaisreal)）。
* 现在可以在启动时通过提供 `CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT` 来配置 `access_management` 设置，默认值为禁用（`0`），与之前的值相同。[#20139](https://github.com/ClickHouse/ClickHouse/pull/20139) ([Marquitos](https://github.com/sonirico))。
* 修复针对 DateTime64 的 `toDateTime64(toDate()/toDateTime())`：实现 DateTime64 的钳制（clamping）行为，使其与 DateTime 的行为一致。[#20131](https://github.com/ClickHouse/ClickHouse/pull/20131)（[Azat Khuzhin](https://github.com/azat)）。
* 配额改进：在配额计算中，`SHOW TABLES` 现在被视为一个查询，而不是两个查询。`SYSTEM` 查询现在会消耗配额。修复了配额消耗中区间结束位置的计算。[#20106](https://github.com/ClickHouse/ClickHouse/pull/20106) ([Vitaly Baranov](https://github.com/vitlibar))。
* 在 `system.zookeeper` 表中支持使用 `path IN (set)` 表达式。 [#20105](https://github.com/ClickHouse/ClickHouse/pull/20105) ([小路](https://github.com/nicelulu))。
* 在 `system.tables` 中显示 `MaterializeMySQL` 表的全部详细信息。 [#20051](https://github.com/ClickHouse/ClickHouse/pull/20051) ([Stig Bakken](https://github.com/stigsb)).
* 修复了可执行字典中的数据竞争问题，此问题仅在被误用时才可能发生（当脚本忽略其输入而返回数据时）。 [#20045](https://github.com/ClickHouse/ClickHouse/pull/20045) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 现在可以通过在 mysql replica 的配置部分中设置 &quot;opt&#95;reconnect&quot; 参数来控制 MYSQL&#95;OPT&#95;RECONNECT 选项的值。 [#19998](https://github.com/ClickHouse/ClickHouse/pull/19998) ([Alexander Kazakov](https://github.com/Akazz)).
* 如果用户调用 `JSONExtract` 函数并将返回类型指定为 `Float32`，则允许进行不精确的类型转换。例如，JSON 中的数字 `0.1` 是双精度浮点数，在 Float32 中无法精确表示，但用户仍然希望得到该值。之前的版本对于非 Nullable 类型返回 0，对于 Nullable 类型返回 NULL，以表示转换是不精确的。该逻辑在语义上是 100% 正确的，但会让用户感到意外并引发疑问。此更改关闭了 [#13962](https://github.com/ClickHouse/ClickHouse/issues/13962)。[#19960](https://github.com/ClickHouse/ClickHouse/pull/19960)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在向 `Distributed` 表执行 `INSERT` 时，如果块结构不匹配，则添加自动转换。[#19947](https://github.com/ClickHouse/ClickHouse/pull/19947) ([Azat Khuzhin](https://github.com/azat)).
* 对 `system.distributed_ddl_queue` 表的改进。在重启后将 MaxDDLEntryID 初始化为上一次的最后一个值。在此 PR 之前，MaxDDLEntryID 会一直保持为零，直到有新的 DDL 任务被处理。[#19924](https://github.com/ClickHouse/ClickHouse/pull/19924) ([Amos Bird](https://github.com/amosbird))。
* 在 `system.parts` 中显示 `MaterializeMySQL` 表。[#19770](https://github.com/ClickHouse/ClickHouse/pull/19770) ([Stig Bakken](https://github.com/stigsb))。
* 为 `Buffer` 配置文件添加单独的配置指令。 [#19721](https://github.com/ClickHouse/ClickHouse/pull/19721) ([Azat Khuzhin](https://github.com/azat)).
* 将与 JOIN 无关的条件移到 WHERE 子句中。 [#18720](https://github.com/ClickHouse/ClickHouse/issues/18720)。 [#19685](https://github.com/ClickHouse/ClickHouse/pull/19685) ([hexiaoting](https://github.com/hexiaoting))。
* 为 `Distributed` 引擎新增了基于异步发送时待处理字节数对 INSERT 进行限速的功能（新增了 `bytes_to_delay_insert`/`max_delay_to_insert` 和 `bytes_to_throw_insert` 设置）。 [#19673](https://github.com/ClickHouse/ClickHouse/pull/19673) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在某些罕见情况下析构函数中的写入错误可能被忽略的问题。[#19451](https://github.com/ClickHouse/ClickHouse/pull/19451) ([Azat Khuzhin](https://github.com/azat)).
* 在致命错误的堆栈跟踪中输出内联帧。[#19317](https://github.com/ClickHouse/ClickHouse/pull/19317) ([Ivan](https://github.com/abyss7))。

#### 错误修复 {#bug-fix-7}


* 修复了对 ZooKeeper 的多余重连，以及单个 ClickHouse 服务器上可能存在两个活动会话的问题。这两个问题均是在 #14678 中引入的。[#21264](https://github.com/ClickHouse/ClickHouse/pull/21264) ([alesapin](https://github.com/alesapin))。
* 修复通过 `Values` 格式向包含 `LowCardinality` 列的表插入数据时出现的错误 `Bad cast from type ... to DB::ColumnLowCardinality`。修复了 #21140 [#21357](https://github.com/ClickHouse/ClickHouse/pull/21357)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在非复制的 MergeTree 表引擎中，当 `ALTER DELETE` 变更操作的谓词包含表自身时出现的死锁问题。修复了 [#20558](https://github.com/ClickHouse/ClickHouse/issues/20558)。[#21477](https://github.com/ClickHouse/ClickHouse/pull/21477)（[alesapin](https://github.com/alesapin)）。
* 修复在失败场景下分布式查询中的 SIGSEGV 问题。[#21434](https://github.com/ClickHouse/ClickHouse/pull/21434) ([Azat Khuzhin](https://github.com/azat))
* 现在，`ALTER MODIFY COLUMN` 查询会正确地应用对分区键、跳过索引、TTL 等的修改。修复了 [#13675](https://github.com/ClickHouse/ClickHouse/issues/13675)。[#21334](https://github.com/ClickHouse/ClickHouse/pull/21334) ([alesapin](https://github.com/alesapin))。
* 修复了在启用 `join_use_nulls` 时从子查询关联 `TOTALS` 的 Bug。此更改关闭了 [#19362](https://github.com/ClickHouse/ClickHouse/issues/19362) 和 [#21137](https://github.com/ClickHouse/ClickHouse/issues/21137)。[#21248](https://github.com/ClickHouse/ClickHouse/pull/21248)（[vdimir](https://github.com/vdimir)）。
* 修复在包含 `UNION` 的查询上执行 `EXPLAIN` 时发生的崩溃。修复了 [#20876](https://github.com/ClickHouse/ClickHouse/issues/20876)、[#21170](https://github.com/ClickHouse/ClickHouse/issues/21170)。[#21246](https://github.com/ClickHouse/ClickHouse/pull/21246)（[flynn](https://github.com/ucasFL)）。
* 现在仅允许在支持 mutation 的表引擎（MergeTree 系列、Memory、MaterializedView）上执行 mutation 操作。其他引擎将返回更清晰的错误信息。修复了 [#21168](https://github.com/ClickHouse/ClickHouse/issues/21168)。[#21183](https://github.com/ClickHouse/ClickHouse/pull/21183)（[alesapin](https://github.com/alesapin)）。
* 修复了 [#21112](https://github.com/ClickHouse/ClickHouse/issues/21112)。修复了一个可能在 `insert` 查询中导致重复数据的错误（如果其中一个回调稍有延迟）。[#21138](https://github.com/ClickHouse/ClickHouse/pull/21138)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在类型可为空时 `input_format_null_as_default` 不生效的问题。此更改修复了 [#21116](https://github.com/ClickHouse/ClickHouse/issues/21116)。 [#21121](https://github.com/ClickHouse/ClickHouse/pull/21121)（[Amos Bird](https://github.com/amosbird)）。
* 修复与将 Tuple 类型转换为 Map 类型相关的问题。关闭 [#21029](https://github.com/ClickHouse/ClickHouse/issues/21029)。[#21120](https://github.com/ClickHouse/ClickHouse/pull/21120)（[hexiaoting](https://github.com/hexiaoting)）。
* 修复在删除配置了自定义（非默认）ZooKeeper 集群的 Replicated*MergeTree 时出现的元数据泄露问题。[#21119](https://github.com/ClickHouse/ClickHouse/pull/21119) ([fastio](https://github.com/fastio)).
* 修复在 `joinGet` 中使用 `LowCardinality` 键时的类型不匹配问题，解决了 [#21114](https://github.com/ClickHouse/ClickHouse/issues/21114)。[#21117](https://github.com/ClickHouse/ClickHouse/pull/21117)（[Amos Bird](https://github.com/amosbird)）。
* 修复在 Replicated(*)MergeTree 引擎中，当需要指定其他参数时，default&#95;replica&#95;path 和 default&#95;replica&#95;name 值不起作用的问题。 [#21060](https://github.com/ClickHouse/ClickHouse/pull/21060) ([mxzlxy](https://github.com/mxzlxy)).
* 在对特意构造的、超出范围的 `DateTime64` 类型值进行格式化时，可能发生内存越界访问。此更改修复了 [#20494](https://github.com/ClickHouse/ClickHouse/issues/20494)。此更改修复了 [#20543](https://github.com/ClickHouse/ClickHouse/issues/20543)。[#21023](https://github.com/ClickHouse/ClickHouse/pull/21023)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 阻止向 Join 存储引擎进行并行插入。 [#21009](https://github.com/ClickHouse/ClickHouse/pull/21009) ([vdimir](https://github.com/vdimir)).
* 修复了 `ALTER MODIFY COLUMN` 可能创建明知会失败的 mutation 的问题。 [#21007](https://github.com/ClickHouse/ClickHouse/pull/21007) ([Anton Popov](https://github.com/CurtizJ)).
* 关闭了 [#9969](https://github.com/ClickHouse/ClickHouse/issues/9969)。修复了在数据量较大、结构稍复杂且使用 JSON 输出格式时会出现的 Brotli HTTP 压缩错误。将 Brotli 更新到最新版本，以包含对“修复环形缓冲区中对未初始化数据的罕见访问”的补丁。[#20991](https://github.com/ClickHouse/ClickHouse/pull/20991)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在取消查询时出现的 &#39;Empty task was returned from async task queue&#39; 错误。 [#20881](https://github.com/ClickHouse/ClickHouse/pull/20881) ([Azat Khuzhin](https://github.com/azat)).
* 使用 MySQL 5.7 客户端连接到 ClickHouse 服务器时，`USE database;` 查询不起作用，该问题已修复。修复了 [#18926](https://github.com/ClickHouse/ClickHouse/issues/18926)。[#20878](https://github.com/ClickHouse/ClickHouse/pull/20878)（[tavplubix](https://github.com/tavplubix)）。
* 修复在聚合函数中将 `-Distinct` 组合器与 `-State` 组合器配合使用时的问题。 [#20866](https://github.com/ClickHouse/ClickHouse/pull/20866) ([Anton Popov](https://github.com/CurtizJ)).
* 修复包含 `UNION DISTINCT` 和 `LIMIT` 子句的子查询。关闭 [#20597](https://github.com/ClickHouse/ClickHouse/issues/20597)。[#20610](https://github.com/ClickHouse/ClickHouse/pull/20610) ([flynn](https://github.com/ucasFL))。
* 修复了在查询中查找字典中不存在的键时字典的行为不一致的问题。 [#20578](https://github.com/ClickHouse/ClickHouse/pull/20578) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 修复标量子查询和索引子查询的线程数设置（在 [#19007](https://github.com/ClickHouse/ClickHouse/issues/19007) 之后一直只使用单线程）。修复了 [#20457](https://github.com/ClickHouse/ClickHouse/issues/20457)、[#20512](https://github.com/ClickHouse/ClickHouse/issues/20512) 问题。[#20550](https://github.com/ClickHouse/ClickHouse/pull/20550)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复从远程查询接收到未知数据包时可能发生的崩溃问题（该问题引入于 [#17868](https://github.com/ClickHouse/ClickHouse/issues/17868)）。[#20547](https://github.com/ClickHouse/ClickHouse/pull/20547)（[Azat Khuzhin](https://github.com/azat)）。
* 在解析异步 INSERT 的目录名称时添加必要的检查（修复 SIGSEGV）。[#20498](https://github.com/ClickHouse/ClickHouse/pull/20498) ([Azat Khuzhin](https://github.com/azat)).
* 修复 `transform` 函数在浮点型键值上工作不正确的问题。关闭 [#20460](https://github.com/ClickHouse/ClickHouse/issues/20460)。[#20479](https://github.com/ClickHouse/ClickHouse/pull/20479)（[flynn](https://github.com/ucasFL)）。
* 修复在将 WITH 子句别名传播到子查询时出现的无限循环问题，修复了 [#20388](https://github.com/ClickHouse/ClickHouse/issues/20388)。[#20476](https://github.com/ClickHouse/ClickHouse/pull/20476)（[Amos Bird](https://github.com/amosbird)）。
* 修复在 HTTP 客户端断开连接时服务器异常终止的问题。[#20464](https://github.com/ClickHouse/ClickHouse/pull/20464) ([Azat Khuzhin](https://github.com/azat)).
* 修复在 `JOIN` 中包含来自 `SELECT` 的常量且 `join_use_nulls=1` 时出现的 `LOGICAL_ERROR`。 [#20461](https://github.com/ClickHouse/ClickHouse/pull/20461) ([Azat Khuzhin](https://github.com/azat)).
* 检查是否在表达式列表中使用了表函数 `view`，如果是，则抛出错误。修复了 [#20342](https://github.com/ClickHouse/ClickHouse/issues/20342)。[#20350](https://github.com/ClickHouse/ClickHouse/pull/20350)（[Amos Bird](https://github.com/amosbird)）。
* 避免在 RANGE&#95;HASHED() 字典中发生无效解引用。 [#20345](https://github.com/ClickHouse/ClickHouse/pull/20345) ([Azat Khuzhin](https://github.com/azat)).
* 修复在 `join_use_nulls=1` 情况下出现的空指针解引用问题。 [#20344](https://github.com/ClickHouse/ClickHouse/pull/20344) ([Azat Khuzhin](https://github.com/azat)).
* 修复两个 scale 不同的 Decimal 常量之间二元运算结果错误的问题。修复了 [#20283](https://github.com/ClickHouse/ClickHouse/issues/20283)。[#20339](https://github.com/ClickHouse/ClickHouse/pull/20339)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复 `ReplicatedMergeTree` 表引擎族中对失败的后台任务重试过于频繁的问题。该问题可能导致日志过于冗长以及 CPU 负载增加。修复 [#20203](https://github.com/ClickHouse/ClickHouse/issues/20203)。[#20335](https://github.com/ClickHouse/ClickHouse/pull/20335)（[alesapin](https://github.com/alesapin)）。
* 将 `*CollapsingMergeTree` 和 `ReplacingMergeTree` 表引擎的版本列的操作限制为仅允许 `DROP` 或 `RENAME`。 [#20300](https://github.com/ClickHouse/ClickHouse/pull/20300) ([alesapin](https://github.com/alesapin)).
* 修复了在遇到损坏的 JSON 时会尝试将整个文件读入内存、从而导致内存分配器抛出异常的行为。修复了 [#19719](https://github.com/ClickHouse/ClickHouse/issues/19719)。[#20286](https://github.com/ClickHouse/ClickHouse/pull/20286)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 修复在不支持执行垂直合并的 `MergeTree` 表引擎系列上尝试进行垂直合并时抛出的异常。修复 [#20259](https://github.com/ClickHouse/ClickHouse/issues/20259)。[#20279](https://github.com/ClickHouse/ClickHouse/pull/20279)（[alesapin](https://github.com/alesapin)）。
* 修复在关闭过程中重新加载配置时出现的罕见服务器崩溃问题。已修复 [#19689](https://github.com/ClickHouse/ClickHouse/issues/19689)。[#20224](https://github.com/ClickHouse/ClickHouse/pull/20224)（[alesapin](https://github.com/alesapin)）。
* 修复在 `INSERT SELECT` 中使用 CTE 时的行为。此更改修复了 [#20187](https://github.com/ClickHouse/ClickHouse/issues/20187) 和 [#20195](https://github.com/ClickHouse/ClickHouse/issues/20195)。[#20211](https://github.com/ClickHouse/ClickHouse/pull/20211)（[Amos Bird](https://github.com/amosbird)）。
* 修复 [#19314](https://github.com/ClickHouse/ClickHouse/issues/19314)。[#20156](https://github.com/ClickHouse/ClickHouse/pull/20156)（[Ivan](https://github.com/abyss7)）。
* 修复 `toMinute` 函数，使其能够正确处理特殊时区。 [#20149](https://github.com/ClickHouse/ClickHouse/pull/20149) ([keenwolf](https://github.com/keen-wolf)).
* 修复在执行包含 `if` 函数且 then/else 分支的结果为 `Tuple` 类型的查询时导致的服务器崩溃问题。`Tuple` 类型必须包含 `Array` 或其他复杂类型。修复 [#18356](https://github.com/ClickHouse/ClickHouse/issues/18356)。[#20133](https://github.com/ClickHouse/ClickHouse/pull/20133)（[alesapin](https://github.com/alesapin)）。
* `MongoDB` 表引擎现在只会在需要读取数据时才建立连接。`ATTACH TABLE` 不会再尝试连接。[#20110](https://github.com/ClickHouse/ClickHouse/pull/20110)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复 StorageJoin 中的缺陷。 [#20079](https://github.com/ClickHouse/ClickHouse/pull/20079) ([vdimir](https://github.com/vdimir)).
* 修复了在计算负数对较小除数取模时，由于结果数据类型不够大而无法容纳负结果的问题。由此关闭了 [#20052](https://github.com/ClickHouse/ClickHouse/issues/20052)。[#20067](https://github.com/ClickHouse/ClickHouse/pull/20067)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* MaterializeMySQL：修复对更新多个表的语句的复制问题。[#20066](https://github.com/ClickHouse/ClickHouse/pull/20066)（[Håvard Kvålen](https://github.com/havardk)）。
* 在执行初始化脚本期间，避免 Docker 出现“Connection refused”。[#20012](https://github.com/ClickHouse/ClickHouse/pull/20012) ([filimonov](https://github.com/filimonov))。
* `EmbeddedRocksDB` 是一个实验性的存储引擎。修复了缺少适当类型检查的问题，并简化了代码。此变更关闭了 [#19967](https://github.com/ClickHouse/ClickHouse/issues/19967)。[#19972](https://github.com/ClickHouse/ClickHouse/pull/19972)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复函数 `fromModifiedJulianDay` 在参数类型为 `Nullable(T)` 且 T 为除 Int32 之外的任意整数类型时发生段错误的问题。 [#19959](https://github.com/ClickHouse/ClickHouse/pull/19959) ([PHO](https://github.com/depressed-pho))。
* 修复 BloomFilter 索引崩溃问题。修复了 [#19757](https://github.com/ClickHouse/ClickHouse/issues/19757)。 [#19884](https://github.com/ClickHouse/ClickHouse/pull/19884)（[Maksim Kita](https://github.com/kitaisreal)）。
* 如果启用了 system.text&#95;log，则可能发生死锁。已修复 [#19874](https://github.com/ClickHouse/ClickHouse/issues/19874)。[#19875](https://github.com/ClickHouse/ClickHouse/pull/19875)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在存在默认表达式中使用 `dictGet()` 的表时启动服务器的问题。允许在不加载字典的情况下获取 `dictGet()` 的返回类型。[#19805](https://github.com/ClickHouse/ClickHouse/pull/19805) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复在只执行 `select` 查询时导致 clickhouse-client 异常终止的问题。 [#19790](https://github.com/ClickHouse/ClickHouse/pull/19790) ([taiyang-li](https://github.com/taiyang-li)).
* 修复了一个错误：在同时启动多个 clickhouse-copier 时，将数据分片移动到目标表可能会失败。 [#19743](https://github.com/ClickHouse/ClickHouse/pull/19743) ([madianjun](https://github.com/mdianjun))。
* 后台执行 `ON CLUSTER` 查询的线程可能会在等待已被删除的复制表执行某些操作时挂起。该问题已修复。 [#19684](https://github.com/ClickHouse/ClickHouse/pull/19684) ([yiguolei](https://github.com/yiguolei)).

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-8}

- 允许在全局启用 AVX-2 的情况下构建 ClickHouse。这在现代 CPU 上可以带来轻微的性能提升。目前不建议用于生产环境,暂不作为官方构建版本提供支持。[#20180](https://github.com/ClickHouse/ClickHouse/pull/20180) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 修复了 Coverity 发现的部分问题。参见 [#19964](https://github.com/ClickHouse/ClickHouse/issues/19964)。[#20010](https://github.com/ClickHouse/ClickHouse/pull/20010) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 允许在 gdb 下使用修改过的二进制文件启动。在之前的版本中,如果在启动前在 gdb 中设置断点,服务器会因完整性检查失败而拒绝启动。[#21258](https://github.com/ClickHouse/ClickHouse/pull/21258) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 为 Kafka 中的不同压缩方法添加了测试。[#21111](https://github.com/ClickHouse/ClickHouse/pull/21111) ([filimonov](https://github.com/filimonov))。
- 修复了 test_storage_kerberized_hdfs 测试中的端口冲突问题。[#19974](https://github.com/ClickHouse/ClickHouse/pull/19974) ([Ilya Yatsishin](https://github.com/qoega))。
- 在集成测试中 docker 启动失败时,将 `stdout` 和 `stderr` 输出到日志。在此 PR 之前,这种情况下只有一条非常简短的错误消息,不利于问题排查。[#20631](https://github.com/ClickHouse/ClickHouse/pull/20631) ([Vitaly Baranov](https://github.com/vitlibar))。


## ClickHouse 版本 21.2 {#clickhouse-release-212}

### ClickHouse 版本 v21.2.2.8-stable, 2021-02-07 {#clickhouse-release-v21228-stable-2021-02-07}

#### 向后不兼容的变更 {#backward-incompatible-change-9}

- 位运算函数(`bitAnd`、`bitOr` 等)禁止用于浮点数参数。现在必须显式转换为整数类型。[#19853](https://github.com/ClickHouse/ClickHouse/pull/19853) ([Azat Khuzhin](https://github.com/azat))。
- 禁止对浮点数使用 `lcm`/`gcd` 函数。[#19532](https://github.com/ClickHouse/ClickHouse/pull/19532) ([Azat Khuzhin](https://github.com/azat))。
- 修复 `OPTIMIZE TABLE`/合并操作的内存跟踪;为 `OPTIMIZE TABLE`/合并操作计入查询内存限制和采样。[#18772](https://github.com/ClickHouse/ClickHouse/pull/18772) ([Azat Khuzhin](https://github.com/azat))。
- 不允许将浮点数列作为分区键,参见 [#18421](https://github.com/ClickHouse/ClickHouse/issues/18421#event-4147046255)。[#18464](https://github.com/ClickHouse/ClickHouse/pull/18464) ([hexiaoting](https://github.com/hexiaoting))。
- 类型定义中不再支持多余的括号,例如:`Array((UInt8))`。

#### 新功能 {#new-feature-9}


* 新增了 `PostgreSQL` 表引擎（支持 select/insert 操作及多维数组），也可作为表函数使用。新增了 `PostgreSQL` 字典源。新增了 `PostgreSQL` 数据库引擎。[#18554](https://github.com/ClickHouse/ClickHouse/pull/18554)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 数据类型 `Nested` 现在支持任意层次的嵌套。新增了复杂类型的子列，例如 `Array` 中的 `size0`、`Nullable` 中的 `null`、`Tuple` 的元素名，这些子列可以在不读取整列的情况下单独读取。[#17310](https://github.com/ClickHouse/ClickHouse/pull/17310) ([Anton Popov](https://github.com/CurtizJ)).
* 为 `FlatDictionary`、`HashedDictionary`、`ComplexKeyHashedDictionary`、`DirectDictionary`、`ComplexKeyDirectDictionary`、`RangeHashedDictionary` 添加了对 `Nullable` 的支持。[#18236](https://github.com/ClickHouse/ClickHouse/pull/18236)（[Maksim Kita](https://github.com/kitaisreal)）。
* 添加了一个名为 `system.distributed_ddl_queue` 的新表，用于展示 DDL worker 队列中的查询。[#17656](https://github.com/ClickHouse/ClickHouse/pull/17656)（[Bharat Nallan](https://github.com/bharatnc)）。
* 新增支持将 LDAP 组名（以及一般的属性值）映射到来自 LDAP 用户目录的用户的本地角色。 [#17211](https://github.com/ClickHouse/ClickHouse/pull/17211) ([Denis Glazachev](https://github.com/traceon))。
* 支持对表函数 `cluster` 使用 INSERT INTO；并且对于表函数 `remote` 和 `cluster`，支持通过指定分片键在各节点之间分发数据。关闭 [#16752](https://github.com/ClickHouse/ClickHouse/issues/16752)。[#18264](https://github.com/ClickHouse/ClickHouse/pull/18264) ([flynn](https://github.com/ucasFL))。
* 添加函数 `decodeXMLComponent` 用于解码 XML 字符实体。例如：`SELECT decodeXMLComponent('Hello,&quot;world&quot;!')` [#17659](https://github.com/ClickHouse/ClickHouse/issues/17659)。[#18542](https://github.com/ClickHouse/ClickHouse/pull/18542)（[nauta](https://github.com/nautaa)）。
* 新增函数 `parseDateTimeBestEffortUSOrZero`、`parseDateTimeBestEffortUSOrNull`。 [#19712](https://github.com/ClickHouse/ClickHouse/pull/19712) ([Maksim Kita](https://github.com/kitaisreal))。
* 添加 `sign` 数学函数。[#19527](https://github.com/ClickHouse/ClickHouse/pull/19527) ([flynn](https://github.com/ucasFL))。
* 将已使用的功能（函数、表引擎等）信息添加到 system.query&#95;log 中。[#18495](https://github.com/ClickHouse/ClickHouse/issues/18495)。[#19371](https://github.com/ClickHouse/ClickHouse/pull/19371)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 函数 `formatDateTime` 支持使用 `%Q` 修饰符将日期格式化为所在季度。[#19224](https://github.com/ClickHouse/ClickHouse/pull/19224) ([Jianmei Zhang](https://github.com/zhangjmruc))。
* 在 Play UI 中支持 Meta+Enter 快捷键。 [#19012](https://github.com/ClickHouse/ClickHouse/pull/19012) ([sundyli](https://github.com/sundy-li)).
* 为 `map` 数据类型新增三个函数：1. `mapContains(map, key)` 用于检查 `map` 中的键是否包含第二个参数 `key`。2. `mapKeys(map)` 以 `Array` 格式返回所有键。3. `mapValues(map)` 以 `Array` 格式返回所有值。[#18788](https://github.com/ClickHouse/ClickHouse/pull/18788) ([hexiaoting](https://github.com/hexiaoting)).
* 添加与 [#18494](https://github.com/ClickHouse/ClickHouse/issues/18494) 相关的 `log_comment` 设置。[#18549](https://github.com/ClickHouse/ClickHouse/pull/18549)（[Zijie Lu](https://github.com/TszKitLo40)）。
* 为 `argMin` 和 `argMax` 函数添加对元组参数的支持。[#17359](https://github.com/ClickHouse/ClickHouse/pull/17359) ([Ildus Kurbangaliev](https://github.com/ildus))。
* 支持 `EXISTS VIEW` 语法。[#18552](https://github.com/ClickHouse/ClickHouse/pull/18552) ([Du Chuan](https://github.com/spongedu))。
* 添加 `SELECT ALL` 语法，修复 [#18706](https://github.com/ClickHouse/ClickHouse/issues/18706) 中的问题。[#18723](https://github.com/ClickHouse/ClickHouse/pull/18723)（[flynn](https://github.com/ucasFL)）。

#### 性能改进 {#performance-improvement-9}

- 通过减少 `stat` 系统调用次数加快数据分片删除速度。此更改恢复了之前存在的优化,并提供了更安全的 `IDisk` 接口。此更改关闭了 [#19065](https://github.com/ClickHouse/ClickHouse/issues/19065)。[#19086](https://github.com/ClickHouse/ClickHouse/pull/19086) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 在 `WITH` 语句中声明的别名现在可以正确用于索引分析。类似 `WITH column AS alias SELECT ... WHERE alias = ...` 的查询现在可以使用索引。[#18896](https://github.com/ClickHouse/ClickHouse/pull/18896) ([Amos Bird](https://github.com/amosbird))。
- 添加 `optimize_alias_column_prediction`(默认开启),该选项将:- 在分区裁剪和使用二级索引跳过数据时,在 WHERE 子句中识别别名列;- 在 optimize_trivial_count 的简单计数查询中,在 WHERE 子句中识别别名列;- 在 GROUP BY/ORDER BY 中识别别名列,用于 optimize_aggregation_in_order/optimize_read_in_order。[#16995](https://github.com/ClickHouse/ClickHouse/pull/16995) ([sundyli](https://github.com/sundy-li))。
- 加速聚合函数 `sum`。改进仅在合成基准测试中可见,实际应用价值不大。[#19216](https://github.com/ClickHouse/ClickHouse/pull/19216) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 更新 libc++ 并使用另一个 ABI 以提供更好的性能。[#18914](https://github.com/ClickHouse/ClickHouse/pull/18914) ([Danila Kutenin](https://github.com/danlark1))。
- 在逻辑等价时将 `sumIf()` 和 `sum(if())` 函数重写为 `countIf()` 函数。[#17041](https://github.com/ClickHouse/ClickHouse/pull/17041) ([flynn](https://github.com/ucasFL))。
- 为 S3 连接使用连接池,由 `s3_max_connections` 设置控制。[#13405](https://github.com/ClickHouse/ClickHouse/pull/13405) ([Vladimir Chebotarev](https://github.com/excitoon))。
- 添加对 zstd long 选项的支持,以更好地压缩字符串列从而节省空间。[#17184](https://github.com/ClickHouse/ClickHouse/pull/17184) ([ygrek](https://github.com/ygrek))。
- 通过移除每次连接时对配置的访问,略微改善服务器延迟。[#19863](https://github.com/ClickHouse/ClickHouse/pull/19863) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 减少 `Buffer` 引擎多层的锁竞争。[#19379](https://github.com/ClickHouse/ClickHouse/pull/19379) ([Azat Khuzhin](https://github.com/azat))。
- 支持将查询计划的 `Filter` 步骤拆分为 `Expression + Filter` 对。结合 `Expression + Expression` 合并优化([#17458](https://github.com/ClickHouse/ClickHouse/issues/17458)),可以延迟 `Filter` 步骤之后某些表达式的执行。[#19253](https://github.com/ClickHouse/ClickHouse/pull/19253) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。

#### 改进 {#improvement-9}


* 现在，只要 `table` 中至少有一列可以被选取，就可以执行 `SELECT count() FROM table`。此 PR 修复了 [#10639](https://github.com/ClickHouse/ClickHouse/issues/10639)。[#18233](https://github.com/ClickHouse/ClickHouse/pull/18233)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 与远程 MySQL 服务器交互时将字符集设置为 `utf8mb4`。修复了 [#19795](https://github.com/ClickHouse/ClickHouse/issues/19795)。[#19800](https://github.com/ClickHouse/ClickHouse/pull/19800)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `S3` 表函数现在支持 `auto` 压缩模式（自动识别）。这解决了 [#18754](https://github.com/ClickHouse/ClickHouse/issues/18754)。 [#19793](https://github.com/ClickHouse/ClickHouse/pull/19793) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 为 `formatReadableTimeDelta` 函数正确输出无穷大参数。在之前的版本中，会被隐式转换为与具体实现相关的整数值。[#19791](https://github.com/ClickHouse/ClickHouse/pull/19791) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 当无法精确确定 region 时，表函数 `S3` 将使用全局 region。这解决了 [#10998](https://github.com/ClickHouse/ClickHouse/issues/10998)。[#19750](https://github.com/ClickHouse/ClickHouse/pull/19750)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* 在分布式查询中，如果启用了设置 `async_socket_for_remote`，在表中使用嵌套层级非常深的数据类型时（例如 `Array(Array(Array(...more...)))`），至少在调试构建配置中可能会发生栈溢出。此更改修复了 [#19108](https://github.com/ClickHouse/ClickHouse/issues/19108)。该更改引入了轻微的不向后兼容变更：类型定义中不再支持多余的括号，例如：`Array((UInt8))`。[#19736](https://github.com/ClickHouse/ClickHouse/pull/19736)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为消息代理（RabbitMQ 和 Kafka）添加独立的连接池。[#19722](https://github.com/ClickHouse/ClickHouse/pull/19722) ([Azat Khuzhin](https://github.com/azat))。
* 修复在非复制 MergeTree 中极少数情况下出现的 `max_number_of_merges_with_ttl_in_pool` 限制被超出的问题（可能会分配更多带有 TTL 的合并）。[#19708](https://github.com/ClickHouse/ClickHouse/pull/19708) ([alesapin](https://github.com/alesapin)).
* Dictionary：改进了属性解析时的错误信息。 [#19678](https://github.com/ClickHouse/ClickHouse/pull/19678) ([Maksim Kita](https://github.com/kitaisreal))。
* 添加了一个选项，可在读取数据时禁用校验和验证。不应在生产环境中使用。请不要指望通过禁用它获得任何好处。它只能用于实验和基准测试。该设置仅适用于 MergeTree 系列表。对于其他表引擎以及通过网络接收数据时，始终会验证校验和。根据我的观察，性能没有差异，或者差异小于 0.5%。 [#19588](https://github.com/ClickHouse/ClickHouse/pull/19588) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 支持在函数 `multiIf` 中使用常量结果。[#19533](https://github.com/ClickHouse/ClickHouse/pull/19533) ([Maksim Kita](https://github.com/kitaisreal))。
* 为 Map 数据类型启用 length/empty/notEmpty 函数，使其返回 Map 中键的数量。 [#19530](https://github.com/ClickHouse/ClickHouse/pull/19530) ([taiyang-li](https://github.com/taiyang-li)).
* 为 `clickhouse-benchmark` 添加 `--reconnect` 选项。指定该选项时，将在每个请求前重新建立连接。此功能用于测试。[#19872](https://github.com/ClickHouse/ClickHouse/pull/19872)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 支持新的 `.debug` 文件位置。修复了 [#19348](https://github.com/ClickHouse/ClickHouse/issues/19348)。[#19520](https://github.com/ClickHouse/ClickHouse/pull/19520)（[Amos Bird](https://github.com/amosbird)）。
* `toIPv6` 函数支持解析 `IPv4` 地址。[#19518](https://github.com/ClickHouse/ClickHouse/pull/19518)（[Bharat Nallan](https://github.com/bharatnc)）。
* 将 `http_referer` 字段添加到 `system.query_log`、`system.processes` 等表中，以解决 [#19389](https://github.com/ClickHouse/ClickHouse/issues/19389) 中的问题。[#19390](https://github.com/ClickHouse/ClickHouse/pull/19390)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 通过使更多函数大小写不敏感并添加别名来提高 MySQL 兼容性。 [#19387](https://github.com/ClickHouse/ClickHouse/pull/19387) ([Daniil Kondratyev](https://github.com/dankondr)).
* 为 MergeTree 数据部分（Wide/Compact/InMemory 类型）添加指标。 [#19381](https://github.com/ClickHouse/ClickHouse/pull/19381) ([Azat Khuzhin](https://github.com/azat)).
* 允许以任意 UID 运行 Docker。 [#19374](https://github.com/ClickHouse/ClickHouse/pull/19374) ([filimonov](https://github.com/filimonov)).
* 修正 Pretty 格式中 `IPv4` 数据类型值的错误对齐方式：之前为右对齐，而非左对齐。此更改关闭了 [#19184](https://github.com/ClickHouse/ClickHouse/issues/19184)。[#19339](https://github.com/ClickHouse/ClickHouse/pull/19339)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 允许在无需重启的情况下更改 `max_server_memory_usage`。修复了 [#18154](https://github.com/ClickHouse/ClickHouse/issues/18154)。[#19186](https://github.com/ClickHouse/ClickHouse/pull/19186) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 在早期版本中，当以某些 NaN 参数调用函数 `bar` 时抛出的异常信息可能略显误导。本次变更修复了 [#19088](https://github.com/ClickHouse/ClickHouse/issues/19088)。[#19107](https://github.com/ClickHouse/ClickHouse/pull/19107)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 clickhouse-server 镜像中，将 clickhouse 用户及其用户组的 uid/gid 显式设置为固定值 101。[#19096](https://github.com/ClickHouse/ClickHouse/pull/19096) ([filimonov](https://github.com/filimonov))。
* 修复了在插入包含超长字符串的数据时出现的 `PeekableReadBuffer: Memory limit exceed` 错误，解决了 [#18690](https://github.com/ClickHouse/ClickHouse/issues/18690)。[#18979](https://github.com/ClickHouse/ClickHouse/pull/18979)（[tavplubix](https://github.com/tavplubix)）。
* Docker 镜像：对 clickhouse-server 的 entrypoint 脚本进行了多项改进。[#18954](https://github.com/ClickHouse/ClickHouse/pull/18954) ([filimonov](https://github.com/filimonov))。
* 添加 `normalizeQueryKeepNames` 和 `normalizedQueryHashKeepNames`，以在标准化查询时不再用 `?` 掩盖长名称。这有助于更好地分析复杂查询日志。[#18910](https://github.com/ClickHouse/ClickHouse/pull/18910)（[Amos Bird](https://github.com/amosbird)）。
* 在发送之前在发送端对分布式批次执行按块校验和检查（在读取文件时同时验证校验和，而无需对文件进行两次读取），从而避免在接收端因发送端截断的 .bin 文件导致 INSERT 操作卡住。对批量 INSERT 避免对 .bin 文件进行两次读取（之前为计算行数/字节数并考虑压缩合并而必须这样做，现在这些信息已包含在头部，同时保留了向后兼容性）。[#18853](https://github.com/ClickHouse/ClickHouse/pull/18853)（[Azat Khuzhin](https://github.com/azat)）。
* 修复在包含聚合函数状态的表上执行 RIGHT 和 FULL JOIN 时的问题。在早期版本中会抛出与 `cloneResized` 方法相关的异常。[#18818](https://github.com/ClickHouse/ClickHouse/pull/18818) ([templarzq](https://github.com/templarzq))。
* 添加了基于前缀的 S3 端点设置。[#18812](https://github.com/ClickHouse/ClickHouse/pull/18812) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 为 bitmapTransform、bitmapSubsetInRange、bitmapSubsetLimit、bitmapContains 函数新增对 [UInt8, UInt16, UInt32, UInt64] 参数类型的支持。修复了 [#18713](https://github.com/ClickHouse/ClickHouse/issues/18713)。[#18791](https://github.com/ClickHouse/ClickHouse/pull/18791)（[sundyli](https://github.com/sundy-li)）。
* 允许对 CTE（Common Table Expressions，公用表表达式）进行进一步的别名引用。当 `enable_global_with_statement = 1` 时，将 CSE（Common Subexpressions Elimination，公共子表达式消除）应用到同一层级的子查询中。修复了 [#17378](https://github.com/ClickHouse/ClickHouse/issues/17378)。修复了 [https://github.com/ClickHouse/ClickHouse/pull/16575#issuecomment-753416235](https://github.com/ClickHouse/ClickHouse/pull/16575#issuecomment-753416235)。[#18684](https://github.com/ClickHouse/ClickHouse/pull/18684)（[Amos Bird](https://github.com/amosbird)）。
* 将 librdkafka 更新到 v1.6.0-RC2，修复 [#18668](https://github.com/ClickHouse/ClickHouse/issues/18668)。[#18671](https://github.com/ClickHouse/ClickHouse/pull/18671)（[filimonov](https://github.com/filimonov)）。
* 在遇到意外异常时，自动重启负责执行分布式 DDL 查询的后台线程。修复 [#17991](https://github.com/ClickHouse/ClickHouse/issues/17991)。[#18285](https://github.com/ClickHouse/ClickHouse/pull/18285)（[徐炘](https://github.com/weeds085490)）。
* 更新了 AWS C++ SDK，以便在 S3 中使用全局区域（global region）。 [#17870](https://github.com/ClickHouse/ClickHouse/pull/17870) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 在创建 `LIVE VIEW` 表时，新增支持使用 `WITH ... [AND] [PERIODIC] REFRESH [interval_in_sec]` 子句。[#14822](https://github.com/ClickHouse/ClickHouse/pull/14822) ([vzakaznikov](https://github.com/vzakaznikov))。
* 限制对使用旧语法创建的 `MergeTree` 表执行 `MODIFY TTL` 查询。之前这些查询会成功执行，但实际上不会产生任何效果。[#19064](https://github.com/ClickHouse/ClickHouse/pull/19064) ([Anton Popov](https://github.com/CurtizJ)).

#### 错误修复 {#bug-fix-8}


* 修复在处理具有常量参数的二元函数时的索引分析错误，该错误会导致查询结果不正确。此修复对应 [#18364](https://github.com/ClickHouse/ClickHouse/issues/18364)。[#18373](https://github.com/ClickHouse/ClickHouse/pull/18373)（[Amos Bird](https://github.com/amosbird)）。
* 修复在存在默认表达式中包含 `dictGet()` 的表时服务器启动的问题。允许在不加载字典的情况下获取 `dictGet()` 的返回类型。[#19805](https://github.com/ClickHouse/ClickHouse/pull/19805) ([Vitaly Baranov](https://github.com/vitlibar))。
* 修复了在使用 `if` 函数且 then/else 分支结果类型为 `Tuple` 时导致的服务器崩溃问题。`Tuple` 类型必须包含 `Array` 或其他复杂类型。修复了 [#18356](https://github.com/ClickHouse/ClickHouse/issues/18356)。[#20133](https://github.com/ClickHouse/ClickHouse/pull/20133)（[alesapin](https://github.com/alesapin)）。
* `MaterializeMySQL`（实验性功能）：修复针对更新多个表的语句的复制行为。 [#20066](https://github.com/ClickHouse/ClickHouse/pull/20066) ([Håvard Kvålen](https://github.com/havardk))。
* 在执行初始化脚本时，避免在 Docker 中出现“Connection refused”错误。 [#20012](https://github.com/ClickHouse/ClickHouse/pull/20012) ([filimonov](https://github.com/filimonov)).
* `EmbeddedRocksDB` 是一种实验性存储引擎。修复了缺乏正确类型检查的问题，并简化了代码。此更改关闭了 [#19967](https://github.com/ClickHouse/ClickHouse/issues/19967)。[#19972](https://github.com/ClickHouse/ClickHouse/pull/19972)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复函数 `fromModifiedJulianDay` 在参数类型为除 Int32 以外的任意其他整数类型的 `Nullable(T)` 时发生的段错误。[#19959](https://github.com/ClickHouse/ClickHouse/pull/19959) ([PHO](https://github.com/depressed-pho))。
* 函数 `greatCircleAngle` 在早期版本中会返回不准确的结果。此更改关闭了 [#19769](https://github.com/ClickHouse/ClickHouse/issues/19769)。[#19789](https://github.com/ClickHouse/ClickHouse/pull/19789)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了一个罕见的错误：在数据损坏的情况下，某些复制操作（例如 mutation）无法处理某些数据部件。修复了 [#19593](https://github.com/ClickHouse/ClickHouse/issues/19593)。[#19702](https://github.com/ClickHouse/ClickHouse/pull/19702)（[alesapin](https://github.com/alesapin)）。
* 执行 `ON CLUSTER` 查询的后台线程可能会在等待已删除的复制表完成某些操作时阻塞。该问题已修复。 [#19684](https://github.com/ClickHouse/ClickHouse/pull/19684) ([yiguolei](https://github.com/yiguolei)).
* 修复列描述的反序列化错误。该问题会导致无法向包含名为 `\` 的列的表执行 INSERT 操作。[#19479](https://github.com/ClickHouse/ClickHouse/pull/19479) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 如果某个文件中存在空数据块，则将分布式批处理标记为已损坏。 [#19449](https://github.com/ClickHouse/ClickHouse/pull/19449) ([Azat Khuzhin](https://github.com/azat)).
* 修复了一个极其罕见的 bug，可能会在执行 `DROP/DETACH/REPLACE/MOVE PARTITION` 之后导致 mutation 挂起。该问题在大多数情况下已经由 [#15537](https://github.com/ClickHouse/ClickHouse/issues/15537) 得到部分修复。[#19443](https://github.com/ClickHouse/ClickHouse/pull/19443)（[tavplubix](https://github.com/tavplubix)）。
* 修正可能出现的错误 `Extremes transform was already added to pipeline`。对应修复 [#14100](https://github.com/ClickHouse/ClickHouse/issues/14100)。[#19430](https://github.com/ClickHouse/ClickHouse/pull/19430)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在默认值非零（例如某些 `Enum`）时各类 join 类型中的默认值处理。关闭 [#18197](https://github.com/ClickHouse/ClickHouse/issues/18197)。[#19360](https://github.com/ClickHouse/ClickHouse/pull/19360)（[vdimir](https://github.com/vdimir)）。
* 在遇到 EOF 时，不要将用于分布式发送的文件标记为损坏。 [#19290](https://github.com/ClickHouse/ClickHouse/pull/19290) ([Azat Khuzhin](https://github.com/azat)).
* 修复 `async_socket_for_remote` 中管道文件描述符泄漏的问题。 [#19153](https://github.com/ClickHouse/ClickHouse/pull/19153) ([Azat Khuzhin](https://github.com/azat)).
* 修复以 `ORC` 格式读取文件时出现的无限循环问题（该问题在 [#10580](https://github.com/ClickHouse/ClickHouse/issues/10580) 中引入）。修复 [#19095](https://github.com/ClickHouse/ClickHouse/issues/19095)。[#19134](https://github.com/ClickHouse/ClickHouse/pull/19134)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了 MergeTree 数据写入器中的一个问题，该问题可能导致标记大小超过固定粒度大小。修复了 [#18913](https://github.com/ClickHouse/ClickHouse/issues/18913)。[#19123](https://github.com/ClickHouse/ClickHouse/pull/19123)（[alesapin](https://github.com/alesapin)）。
* 修复启动时的错误：ClickHouse 无法从 `LowCardinality(Nullable(...))` 读取压缩编解码器并导致抛出异常 `Attempt to read after EOF`。修复了 [#18340](https://github.com/ClickHouse/ClickHouse/issues/18340)。[#19101](https://github.com/ClickHouse/ClickHouse/pull/19101)（[alesapin](https://github.com/alesapin)）。
* 简化 `tupleHammingDistance` 的实现。支持长度相同的任意元组。修复 [#19029](https://github.com/ClickHouse/ClickHouse/issues/19029)。[#19084](https://github.com/ClickHouse/ClickHouse/pull/19084)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 确保 `groupUniqArray` 在处理 Enum 类型参数时返回正确的类型。这解决了 [#17875](https://github.com/ClickHouse/ClickHouse/issues/17875)。[#19019](https://github.com/ClickHouse/ClickHouse/pull/19019)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在将 `LowCardinality` 参数用于函数 `ignore` 时可能出现的错误 `Expected single dictionary argument for function`。修复了 [#14275](https://github.com/ClickHouse/ClickHouse/issues/14275)。[#19016](https://github.com/ClickHouse/ClickHouse/pull/19016)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复向使用 `TinyLog` 引擎的表插入 `LowCardinality` 列时的问题。修复 [#18629](https://github.com/ClickHouse/ClickHouse/issues/18629)。[#19010](https://github.com/ClickHouse/ClickHouse/pull/19010)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复 JOIN 中的一个小问题：JOIN 会尝试将常量列物化，但我们的代码会在其他地方等待这些列就绪。[#18982](https://github.com/ClickHouse/ClickHouse/pull/18982) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 禁用 `optimize_move_functions_out_of_any`，因为该优化并不总是正确。由此关闭 [#18051](https://github.com/ClickHouse/ClickHouse/issues/18051)。由此关闭 [#18973](https://github.com/ClickHouse/ClickHouse/issues/18973)。[#18981](https://github.com/ClickHouse/ClickHouse/pull/18981)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复由于合并查询计划中的 `Expression` 步骤而可能引发的异常 `QueryPipeline stream: different number of columns`。修复了 [#18190](https://github.com/ClickHouse/ClickHouse/issues/18190)。[#18980](https://github.com/ClickHouse/ClickHouse/pull/18980)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在关闭时极其罕见发生的死锁问题。 [#18977](https://github.com/ClickHouse/ClickHouse/pull/18977) ([tavplubix](https://github.com/tavplubix)).
* 修复了当服务器内存耗尽时偶发的崩溃问题。 [#18976](https://github.com/ClickHouse/ClickHouse/pull/18976) ([tavplubix](https://github.com/tavplubix)).
* 修复在执行 `ALTER TABLE ... DROP PART 'part_name'` 查询时，会为整个分区删除所有去重块的错误行为。修复 [#18874](https://github.com/ClickHouse/ClickHouse/issues/18874)。[#18969](https://github.com/ClickHouse/ClickHouse/pull/18969)（[alesapin](https://github.com/alesapin)）。
* 修复了问题 [#18894](https://github.com/ClickHouse/ClickHouse/issues/18894)，添加了检查以避免在长列别名（“table.column” 风格，通常由 Looker 等 BI 工具自动生成）与长表名相等时抛出异常。[#18968](https://github.com/ClickHouse/ClickHouse/pull/18968)（[Daniel Qin](https://github.com/mathfool)）。
* 修复错误 `Task was not found in task queue`（仅在远程查询且 `async_socket_for_remote = 1` 时可能出现）。[#18964](https://github.com/ClickHouse/ClickHouse/pull/18964)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在包含某些转义文本的 mutation（例如 `ALTER ... UPDATE e = CAST('foo', 'Enum8(\'foo\' = 1')`）中序列化不正确的 bug。修复了 [#18878](https://github.com/ClickHouse/ClickHouse/issues/18878)。[#18944](https://github.com/ClickHouse/ClickHouse/pull/18944)（[alesapin](https://github.com/alesapin)）。
* ATTACH PARTITION 会重置 mutations。 [#18804](https://github.com/ClickHouse/ClickHouse/issues/18804)。 [#18935](https://github.com/ClickHouse/ClickHouse/pull/18935) ([fastio](https://github.com/fastio))。
* 修复 `bitmapOrCardinality` 中可能导致空指针解引用的问题。该修复关闭了 [#18911](https://github.com/ClickHouse/ClickHouse/issues/18911)。[#18912](https://github.com/ClickHouse/ClickHouse/pull/18912)（[sundyli](https://github.com/sundy-li)）。
* 修复了在尝试将 `NULL` 从 `Nullable(String)` `CAST` 为 `Nullable(Decimal(P, S))` 时出现的 `Attempt to read after eof` 错误。现在，当函数 `CAST` 无法从可空字符串中解析出 Decimal 时，会返回 `NULL`。修复了 [#7690](https://github.com/ClickHouse/ClickHouse/issues/7690)。[#18718](https://github.com/ClickHouse/ClickHouse/pull/18718)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复 MySQL 引擎中的数据类型转换问题。[#18124](https://github.com/ClickHouse/ClickHouse/pull/18124) ([bo zeng](https://github.com/mis98zb)).
* 修复在只执行 `select` 查询时导致 clickhouse-client 异常中止的问题。 [#19790](https://github.com/ClickHouse/ClickHouse/pull/19790) ([taiyang-li](https://github.com/taiyang-li)).

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-9}

- 在 CI 中运行 [SQLancer](https://twitter.com/RiggerManuel/status/1352345625480884228)(逻辑 SQL 模糊测试器)。 [#19006](https://github.com/ClickHouse/ClickHouse/pull/19006) ([Ilya Yatsishin](https://github.com/qoega)).
- Query Fuzzer 将更全面地对新添加的测试进行模糊测试。此更改解决了 [#18916](https://github.com/ClickHouse/ClickHouse/issues/18916)。 [#19185](https://github.com/ClickHouse/ClickHouse/pull/19185) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- 集成 [Big List of Naughty Strings](https://github.com/minimaxir/big-list-of-naughty-strings/) 以改进模糊测试。 [#19480](https://github.com/ClickHouse/ClickHouse/pull/19480) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- 添加使用 MSan 运行的集成测试。 [#18974](https://github.com/ClickHouse/ClickHouse/pull/18974) ([alesapin](https://github.com/alesapin)).
- 修复了 cyrus-sasl 和 musl 中的 MemorySanitizer 错误。 [#19821](https://github.com/ClickHouse/ClickHouse/pull/19821) ([Ilya Yatsishin](https://github.com/qoega)).
- `positionCaseInsensitiveUTF8` 函数中的参数检查不足触发了地址清理器。 [#19720](https://github.com/ClickHouse/ClickHouse/pull/19720) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- 在集成测试中移除 docker-compose 的 --project-directory 参数。修复来自 docker 容器的日志格式。 [#19706](https://github.com/ClickHouse/ClickHouse/pull/19706) ([Ilya Yatsishin](https://github.com/qoega)).
- 简化了集成测试中 macros.xml 的生成。不再有来自 dicttoxml 的过多日志记录。dicttoxml 项目已经超过 5 年未更新。 [#19697](https://github.com/ClickHouse/ClickHouse/pull/19697) ([Ilya Yatsishin](https://github.com/qoega)).
- 允许通过环境变量 `CLICKHOUSE_WATCHDOG_ENABLE` 显式启用或禁用看门狗。默认情况下,如果服务器未连接到终端,则启用该功能。 [#19522](https://github.com/ClickHouse/ClickHouse/pull/19522) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- 允许在 arm64 上构建支持 Kafka 的 ClickHouse。 [#19369](https://github.com/ClickHouse/ClickHouse/pull/19369) ([filimonov](https://github.com/filimonov)).
- 允许在不使用 SSL 的情况下构建 librdkafka。 [#19337](https://github.com/ClickHouse/ClickHouse/pull/19337) ([filimonov](https://github.com/filimonov)).
- 在 FreeBSD 构建中恢复 Kafka 输入。 [#18924](https://github.com/ClickHouse/ClickHouse/pull/18924) ([Alexandre Snarskii](https://github.com/snar)).
- 修复表函数 `VALUES` 中潜在的空指针解引用问题。 [#19357](https://github.com/ClickHouse/ClickHouse/pull/19357) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- 避免 `arrayElement` 函数、`substring` 和 `arraySum` 中的 UBSan 报告。修复了 [#19305](https://github.com/ClickHouse/ClickHouse/issues/19305)。修复了 [#19287](https://github.com/ClickHouse/ClickHouse/issues/19287)。此更改解决了 [#19336](https://github.com/ClickHouse/ClickHouse/issues/19336)。 [#19347](https://github.com/ClickHouse/ClickHouse/pull/19347) ([alexey-milovidov](https://github.com/alexey-milovidov)).


## ClickHouse 21.1 版本 {#clickhouse-release-211}

### ClickHouse v21.1.3.32-stable 版本，2021-02-03 {#clickhouse-release-v211332-stable-2021-02-03}

#### 错误修复 {#bug-fix-9}


* 修复 BloomFilter 索引崩溃问题。修复了 [#19757](https://github.com/ClickHouse/ClickHouse/issues/19757)。[#19884](https://github.com/ClickHouse/ClickHouse/pull/19884)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复在将谓词下推到 `UNION DISTINCT` 子查询时发生的崩溃。修复了 [#19855](https://github.com/ClickHouse/ClickHouse/issues/19855)。[#19861](https://github.com/ClickHouse/ClickHouse/pull/19861)（[Amos Bird](https://github.com/amosbird)）。
* 修复 UInt8 大于 127 时的过滤问题。[#19799](https://github.com/ClickHouse/ClickHouse/pull/19799) ([Anton Popov](https://github.com/CurtizJ))。
* 在之前的版本中，向函数 arrayEnumerateUniq 传入异常参数可能会导致崩溃或无限循环。修复该问题关闭了 [#19787](https://github.com/ClickHouse/ClickHouse/issues/19787)。[#19788](https://github.com/ClickHouse/ClickHouse/pull/19788)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在对算术类型与字符串类型进行精确比较时会出现的栈溢出问题。 [#19773](https://github.com/ClickHouse/ClickHouse/pull/19773) ([tavplubix](https://github.com/tavplubix)).
* 修复在 `WHERE` 或 `PREWHERE` 子句中使用嵌套列名时出现的崩溃。修复了 [#19755](https://github.com/ClickHouse/ClickHouse/issues/19755)。[#19763](https://github.com/ClickHouse/ClickHouse/pull/19763)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复 `bitmapAndnot` 函数中的段错误。修复 [#19668](https://github.com/ClickHouse/ClickHouse/issues/19668)。[#19713](https://github.com/ClickHouse/ClickHouse/pull/19713)（[Maksim Kita](https://github.com/kitaisreal)）。
* 某些使用大整数的函数可能会导致段错误。大整数是实验性特性。此更改解决了 [#19667](https://github.com/ClickHouse/ClickHouse/issues/19667)。[#19672](https://github.com/ClickHouse/ClickHouse/pull/19672)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在 `LowCardinality` 参数情况下 `neighbor` 函数返回错误结果的问题。修复了 [#10333](https://github.com/ClickHouse/ClickHouse/issues/10333)。[#19617](https://github.com/ClickHouse/ClickHouse/pull/19617)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在断开连接后 `Connection` 中 `CompressedWriteBuffer` 的 use-after-free 问题。 [#19599](https://github.com/ClickHouse/ClickHouse/pull/19599) ([Azat Khuzhin](https://github.com/azat)).
* `DROP/DETACH TABLE table ON CLUSTER cluster SYNC` 查询可能会发生挂起，该问题已修复。修复了 [#19568](https://github.com/ClickHouse/ClickHouse/issues/19568)。[#19572](https://github.com/ClickHouse/ClickHouse/pull/19572)（[tavplubix](https://github.com/tavplubix)）。
* 修复 `CREATE DICTIONARY` 查询中 `id` 表达式的处理。 [#19571](https://github.com/ClickHouse/ClickHouse/pull/19571) ([Maksim Kita](https://github.com/kitaisreal)).
* 修复在将 `merge_tree_min_rows_for_concurrent_read/merge_tree_min_bytes_for_concurrent_read` 设置为 0/UINT64&#95;MAX 时发生的 SIGSEGV。 [#19528](https://github.com/ClickHouse/ClickHouse/pull/19528) ([Azat Khuzhin](https://github.com/azat)).
* 如果使用特定构造的参数调用 `addMonth` 函数，在读取内存时可能发生缓冲区溢出。此更改修复了 [#19441](https://github.com/ClickHouse/ClickHouse/issues/19441)。此更改修复了 [#19413](https://github.com/ClickHouse/ClickHouse/issues/19413)。[#19472](https://github.com/ClickHouse/ClickHouse/pull/19472)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 如果将空字符串作为 IV 传入，则在 `encrypt`/`decrypt` 函数中可能会发生未初始化内存读取。此改动关闭了 [#19391](https://github.com/ClickHouse/ClickHouse/issues/19391)。[#19397](https://github.com/ClickHouse/ClickHouse/pull/19397)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 Uber H3 库中可能出现的缓冲区溢出问题。参见 [https://github.com/uber/h3/issues/392](https://github.com/uber/h3/issues/392)。由此关闭了 [#19219](https://github.com/ClickHouse/ClickHouse/issues/19219)。[#19383](https://github.com/ClickHouse/ClickHouse/pull/19383)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `system.parts` 表的 &#95;state 列（由于顺序不正确，在查询该列时会产生 LOGICAL&#95;ERROR）。 [#19346](https://github.com/ClickHouse/ClickHouse/pull/19346) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在物化视图及其目标表结构不同时执行聚合时，可能出现的错误结果或段错误。修复了 [#18063](https://github.com/ClickHouse/ClickHouse/issues/18063)。[#19322](https://github.com/ClickHouse/ClickHouse/pull/19322)（[tavplubix](https://github.com/tavplubix)）。
* 修复错误 `Cannot convert column now64() because it is constant but values of constants are different in source and result`。为 [#7156](https://github.com/ClickHouse/ClickHouse/issues/7156) 的延续。[#19316](https://github.com/ClickHouse/ClickHouse/pull/19316)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复一个错误：并发执行 `ALTER` 和 `DROP` 查询在处理 ReplicatedMergeTree 表时可能导致挂起。[#19237](https://github.com/ClickHouse/ClickHouse/pull/19237) ([alesapin](https://github.com/alesapin))。
* 修复了通过 HTTP 接口使用 `Template` 或 `CustomSeparated` 格式插入数据时出现的 `There is no checkpoint` 错误。对应修复 [#19021](https://github.com/ClickHouse/ClickHouse/issues/19021)。[#19072](https://github.com/ClickHouse/ClickHouse/pull/19072)（[tavplubix](https://github.com/tavplubix)）。
* 在分析阶段，当无法计算其结果时，禁用对子查询的常量折叠。 [#18446](https://github.com/ClickHouse/ClickHouse/pull/18446) ([Azat Khuzhin](https://github.com/azat)).
* 在执行 `MOVE` 或 `REPLACE PARTITION` 之后，或者在极少数情况下执行 `DETACH` 或 `DROP PARTITION` 之后，变更操作可能会因为等待某个不存在的数据片段而卡住。该问题已修复。 [#15537](https://github.com/ClickHouse/ClickHouse/pull/15537) ([tavplubix](https://github.com/tavplubix))。

### ClickHouse 版本 v21.1.2.15-stable 2021-01-18 {#clickhouse-release-v211215-stable-2021-01-18}

#### 向后不兼容的变更 {#backward-incompatible-change-10}

- 设置 `input_format_null_as_default` 默认启用。[#17525](https://github.com/ClickHouse/ClickHouse/pull/17525) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 检查配置文件中 profile 设置的约束条件。如果 users.xml 包含不满足相应约束的设置,服务器将无法启动。[#18486](https://github.com/ClickHouse/ClickHouse/pull/18486) ([tavplubix](https://github.com/tavplubix))。
- 限制 `ALTER MODIFY SETTING` 修改影响数据部分的存储设置(`write_final_mark` 和 `enable_mixed_granularity_parts`)。[#18306](https://github.com/ClickHouse/ClickHouse/pull/18306) ([Amos Bird](https://github.com/amosbird))。
- 将 `insert_quorum_parallel` 默认设置为 1。这比"顺序"仲裁插入使用起来方便得多。但如果您依赖顺序一致性,应将该设置改回零。[#17567](https://github.com/ClickHouse/ClickHouse/pull/17567) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 移除 `sumburConsistentHash` 函数。这解决了 [#18120](https://github.com/ClickHouse/ClickHouse/issues/18120)。[#18656](https://github.com/ClickHouse/ClickHouse/pull/18656) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 移除聚合函数 `timeSeriesGroupSum`、`timeSeriesGroupRateSum`,因为有人说它们从未正常工作过。这修复了 [#16869](https://github.com/ClickHouse/ClickHouse/issues/16869)。如果您曾成功使用这些函数,请发送电子邮件至 feedback@clickhouse.com。[#17423](https://github.com/ClickHouse/ClickHouse/pull/17423) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 禁止使用 toUnixTimestamp(Date())(之前它只返回 Date 的 UInt16 表示)。[#17376](https://github.com/ClickHouse/ClickHouse/pull/17376) ([Azat Khuzhin](https://github.com/azat))。
- 允许在 `avg` 和 `avgWeighted` 函数中使用扩展整数类型(`Int128`、`Int256`、`UInt256`)。同时允许在 `avgWeighted` 函数中对值和权重使用不同类型(整数、十进制、浮点数)。这是一个向后不兼容的变更:现在 `avg` 和 `avgWeighted` 函数始终返回 `Float64`(如文档所述)。在此变更之前,`Decimal` 参数的返回类型也是 `Decimal`。[#15419](https://github.com/ClickHouse/ClickHouse/pull/15419) ([Mike](https://github.com/myrrc))。
- 表达式 `toUUID(N)` 不再有效。请替换为 `toUUID('00000000-0000-0000-0000-000000000000')`。此变更是由于当 N 非零时 `toUUID(N)` 的结果不明确。
- 具有不正确"密钥用途"的 SSL 证书将被拒绝。在以前的版本中它们可以正常工作。参见 [#19262](https://github.com/ClickHouse/ClickHouse/issues/19262)。
- 默认配置中对替换文件(`/etc/metrika.xml`)的 `incl` 引用已被移除(`<remote_servers>`、`<zookeeper>`、`<macros>`、`<compression>`、`<networks>`)。如果您使用了替换文件并依赖这些隐式引用,应在更新前通过添加带有 `incl="..."` 属性的相应部分手动显式地将它们添加回来。参见 [#18740](https://github.com/ClickHouse/ClickHouse/pull/18740) ([alexey-milovidov](https://github.com/alexey-milovidov))。

#### 新功能 {#new-feature-10}


* 在 ClickHouse 中实现 gRPC 协议。[#15111](https://github.com/ClickHouse/ClickHouse/pull/15111) ([Vitaly Baranov](https://github.com/vitlibar))。
* 支持使用多个 ZooKeeper 集群。[#17070](https://github.com/ClickHouse/ClickHouse/pull/17070) ([fastio](https://github.com/fastio)).
* 实现了 `REPLACE TABLE` 和 `CREATE OR REPLACE TABLE` 查询。[#18521](https://github.com/ClickHouse/ClickHouse/pull/18521) ([tavplubix](https://github.com/tavplubix))。
* 实现对 `UNION DISTINCT` 的支持，并默认将普通的 `UNION` 子句视为 `UNION DISTINCT`。新增设置项 `union_default_mode`，允许将其视为 `UNION ALL`，或要求显式指定模式。[#16338](https://github.com/ClickHouse/ClickHouse/pull/16338) ([flynn](https://github.com/ucasFL))。
* 新增函数 `accurateCastOrNull`，修复了 [#10290](https://github.com/ClickHouse/ClickHouse/issues/10290)。在 `x IN (subquery)` 表达式中添加了类型转换，修复了 [#10266](https://github.com/ClickHouse/ClickHouse/issues/10266)。[#16724](https://github.com/ClickHouse/ClickHouse/pull/16724)（[Maksim Kita](https://github.com/kitaisreal)）。
* IP Dictionary 直接支持 `IPv4` / `IPv6` 类型。[#17571](https://github.com/ClickHouse/ClickHouse/pull/17571)（[vdimir](https://github.com/vdimir)）。
* IP Dictionary 支持按键查询。解决了 [#18241](https://github.com/ClickHouse/ClickHouse/issues/18241)。[#18480](https://github.com/ClickHouse/ClickHouse/pull/18480)（[vdimir](https://github.com/vdimir)）。
* 为数据导入和导出添加对 `*.zst` 压缩/解压缩的支持，从而可以在 `file()` 函数中使用 `*.zst`，并在 HTTP 客户端中使用 `Content-encoding: zstd`。由此解决了 [#16791 ](https://github.com/ClickHouse/ClickHouse/issues/16791)。 [#17144](https://github.com/ClickHouse/ClickHouse/pull/17144)（[Abi Palagashvili](https://github.com/fibersel)）。
* 新增了 `mannWitneyUTest`、`studentTTest` 和 `welchTTest` 聚合函数。对 `rankCorr` 进行了部分重构。[#16883](https://github.com/ClickHouse/ClickHouse/pull/16883) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 新增函数 `countMatches`/`countMatchesCaseInsensitive`。 [#17459](https://github.com/ClickHouse/ClickHouse/pull/17459) ([Azat Khuzhin](https://github.com/azat)).
* 实现 `countSubstrings()`/`countSubstringsCaseInsensitive()`/`countSubstringsCaseInsensitiveUTF8()` 函数（用于统计子字符串出现次数）。[#17347](https://github.com/ClickHouse/ClickHouse/pull/17347) ([Azat Khuzhin](https://github.com/azat))。
* 在 system.query&#95;log 中增加记录已使用数据库、表和列的信息。添加 `query_kind` 和 `normalized_query_hash` 字段。[#17726](https://github.com/ClickHouse/ClickHouse/pull/17726)（[Amos Bird](https://github.com/amosbird)）。
* 添加设置 `optimize_on_insert`。启用后，对 INSERT 写入的数据块执行与对该数据块进行合并操作时相同的转换（例如 Replacing、Collapsing、Aggregating 等）。此设置默认启用。这可能会影响物化视图和 MaterializeMySQL 的行为（参见详细说明）。由此关闭了 [#10683](https://github.com/ClickHouse/ClickHouse/issues/10683)。[#16954](https://github.com/ClickHouse/ClickHouse/pull/16954)（[Kruglov Pavel](https://github.com/Avogar)）。
* 为 HDFS 提供 Kerberos 认证。[#16621](https://github.com/ClickHouse/ClickHouse/pull/16621) ([Ilya Golshtein](https://github.com/ilejn))。
* 支持使用 `SHOW SETTINGS` 语句显示 `system.settings` 中的参数，同时也支持 `SHOW CHANGED SETTINGS` 以及 `LIKE/ILIKE` 子句。[#18056](https://github.com/ClickHouse/ClickHouse/pull/18056)（[Jianmei Zhang](https://github.com/zhangjmruc)）。
* 函数 `position` 现在支持 `POSITION(needle IN haystack)` 语法，以提高与 SQL 的兼容性。该改动解决了 [#18701](https://github.com/ClickHouse/ClickHouse/issues/18701)。... [#18779](https://github.com/ClickHouse/ClickHouse/pull/18779) ([Jianmei Zhang](https://github.com/zhangjmruc)).
* 现在，我们为 MergeTree 系列表中添加了一个新的存储设置 `max_partitions_to_read`。它限制单个查询可访问的最大分区数量。同时还新增了一个用户设置 `force_max_partition_limit`，用于强制执行这一约束。[#18712](https://github.com/ClickHouse/ClickHouse/pull/18712) ([Amos Bird](https://github.com/amosbird))。
* 为已写入的 part 在 `system.part_log` 中新增 `query_id` 列。修复 [#10097](https://github.com/ClickHouse/ClickHouse/issues/10097)。[#18644](https://github.com/ClickHouse/ClickHouse/pull/18644) ([flynn](https://github.com/ucasFL))。
* 允许在带有列定义的情况下使用 `CREATE TABLE ... AS SELECT` 语句创建表。示例：`CREATE TABLE t1 (x String) ENGINE = Memory AS SELECT 1;`。[#18060](https://github.com/ClickHouse/ClickHouse/pull/18060)（[Maksim Kita](https://github.com/kitaisreal)）。
* 新增了 `arrayMin`、`arrayMax`、`arrayAvg` 聚合函数。[#18032](https://github.com/ClickHouse/ClickHouse/pull/18032)（[Maksim Kita](https://github.com/kitaisreal)）。
* 实现了 `ATTACH TABLE name FROM 'path/to/data/' (col1 Type1, ...` 查询。该查询会根据给定的表结构创建一张新表，并从 `user_files` 中指定的目录附加表数据。[#17903](https://github.com/ClickHouse/ClickHouse/pull/17903) ([tavplubix](https://github.com/tavplubix))。
* 为 `StorageMemory` 添加变更（mutation）支持。这解决了 [#9117](https://github.com/ClickHouse/ClickHouse/issues/9117)。[#15127](https://github.com/ClickHouse/ClickHouse/pull/15127) ([flynn](https://github.com/ucasFL))。
* 支持 `EXISTS DATABASE name` 语法。 [#18458](https://github.com/ClickHouse/ClickHouse/pull/18458) ([Du Chuan](https://github.com/spongedu)).
* 支持与 [MySQL](https://github.com/ClickHouse/ClickHouse/compare/master...spongedu:support_is_ipv4?expand=1) 类似的内置函数 `isIPv4String` 和 `isIPv6String`。[#18349](https://github.com/ClickHouse/ClickHouse/pull/18349)（[Du Chuan](https://github.com/spongedu)）。
* 新增设置项 `insert_distributed_one_random_shard = 1`，以便在没有任何分布键的情况下向多分片分布式表中插入数据。[#18294](https://github.com/ClickHouse/ClickHouse/pull/18294)（[Amos Bird](https://github.com/amosbird)）。
* 将设置 `min_compress_block_size` 和 `max_compress_block_size` 添加到 MergeTreeSettings 中，它们优先于全局设置，并在配置后生效。关闭 [13890](https://github.com/ClickHouse/ClickHouse/issues/13890)。[#17867](https://github.com/ClickHouse/ClickHouse/pull/17867) ([flynn](https://github.com/ucasFL))。
* 新增对 64 位 Roaring bitmap 的支持。 [#17858](https://github.com/ClickHouse/ClickHouse/pull/17858) ([Andy Yang](https://github.com/andyyzh))。
* 扩展了 `OPTIMIZE ... DEDUPLICATE` 语法，现在可以显式指定（或通过星号/列转换器隐式指定）用于检测重复的列列表。... [#17846](https://github.com/ClickHouse/ClickHouse/pull/17846) ([Vasily Nemkov](https://github.com/Enmk)).
* 新增函数 `toModifiedJulianDay`、`fromModifiedJulianDay`、`toModifiedJulianDayOrNull` 和 `fromModifiedJulianDayOrNull`。这些函数用于在前推格里高利历日期与修正儒略日数之间进行转换。 [#17750](https://github.com/ClickHouse/ClickHouse/pull/17750) ([PHO](https://github.com/depressed-pho))。
* 新增对自定义顶级域名（TLD）列表的支持：添加了函数 `firstSignificantSubdomainCustom`、`cutToFirstSignificantSubdomainCustom`。 [#17748](https://github.com/ClickHouse/ClickHouse/pull/17748) ([Azat Khuzhin](https://github.com/azat)).
* 为原生 TCP 接口增加对 `PROXYv1` 协议的支持。允许按代理转发的 IP 地址作为配额的键（同时适用于 `PROXYv1` 地址以及来自 HTTP 接口的 `X-Forwarded-For`）。当仅通过受信任的代理（例如 CloudFlare）提供对 ClickHouse 的访问，但又希望根据用户的原始 IP 地址来统计其资源使用时，这将非常有用。修复了 [#17268](https://github.com/ClickHouse/ClickHouse/issues/17268)。[#17707](https://github.com/ClickHouse/ClickHouse/pull/17707)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 现在，clickhouse-client 支持通过 `Alt-Shift-E` 打开 `EDITOR` 来编辑命令。[#17665](https://github.com/ClickHouse/ClickHouse/pull/17665)（[Amos Bird](https://github.com/amosbird)）。
* 添加函数 `encodeXMLComponent`，用于对字符进行转义，以便将字符串放入 XML 文本节点或属性中。[#17659](https://github.com/ClickHouse/ClickHouse/pull/17659) ([nauta](https://github.com/nautaa))。
* 引入 `DETACH TABLE/VIEW ... PERMANENTLY` 语法，使得在重启后该表不会自动重新加载（只能通过显式请求恢复）。仍然可以使用简写语法 ATTACH TABLE 将该表重新附加。实现了 [#5555](https://github.com/ClickHouse/ClickHouse/issues/5555)。修复了 [#13850](https://github.com/ClickHouse/ClickHouse/issues/13850)。[#17642](https://github.com/ClickHouse/ClickHouse/pull/17642)（[filimonov](https://github.com/filimonov)）。
* 在 MergeTree 表中添加关于总行数、总字节数和数据片段总数的异步指标。此更改修复了问题 [#11714](https://github.com/ClickHouse/ClickHouse/issues/11714)。[#17639](https://github.com/ClickHouse/ClickHouse/pull/17639) ([flynn](https://github.com/ucasFL))。
* 为 SQL 外分页新增 `limit` 和 `offset` 设置：[ #16176](https://github.com/ClickHouse/ClickHouse/issues/16176)。它们在构建 API 时非常有用。这两个设置对 SELECT 查询的影响等同于在查询中添加 `select * from (your_original_select_query) t limit xxx offset xxx;`。[#17633](https://github.com/ClickHouse/ClickHouse/pull/17633)（[hexiaoting](https://github.com/hexiaoting)）。
* 提供一个新的聚合器组合子：`-SimpleState`，用于在查询中构建 `SimpleAggregateFunction` 类型。它对于定义 AggregatingMergeTree 引擎的物化视图很有用，也同样能让投影受益。[#16853](https://github.com/ClickHouse/ClickHouse/pull/16853) ([Amos Bird](https://github.com/amosbird))。
* 为 `clickhouse-client` 和 `clickhouse-local` 新增了 `queries-file` 参数。[#15930](https://github.com/ClickHouse/ClickHouse/pull/15930) ([Maksim Kita](https://github.com/kitaisreal))。
* 为 `clickhouse-benchmark` 添加了 `query` 参数。 [#17832](https://github.com/ClickHouse/ClickHouse/pull/17832) ([Maksim Kita](https://github.com/kitaisreal)).
* `EXPLAIN AST` 现在也支持非 `SELECT` 类型的查询。[#18136](https://github.com/ClickHouse/ClickHouse/pull/18136) ([taiyang-li](https://github.com/taiyang-li))。

#### 实验性功能 {#experimental-feature-8}

- 新增用于计算文本 n-gram 和 shingle 的 minHash 和 simHash 函数。这些函数用于半重复检测。同时还新增了 `bitHammingDistance` 和 `tupleHammingDistance` 函数。[#7649](https://github.com/ClickHouse/ClickHouse/pull/7649) ([flynn](https://github.com/ucasFL))。
- 新增 `Map` 数据类型。参见 [#1841](https://github.com/ClickHouse/ClickHouse/issues/1841)。Map 的首个版本仅支持 `String` 类型的键和值。[#15806](https://github.com/ClickHouse/ClickHouse/pull/15806) ([hexiaoting](https://github.com/hexiaoting))。
- 实现基于 ANTLR4 运行时并从 EBNF 语法生成的替代 SQL 解析器。[#11298](https://github.com/ClickHouse/ClickHouse/pull/11298) ([Ivan](https://github.com/abyss7))。

#### 性能改进 {#performance-improvement-10}


* 新的 IP 字典实现，内存占用更低，在某些场景下性能有所提升，并修复了一些缺陷。[#16804](https://github.com/ClickHouse/ClickHouse/pull/16804) ([vdimir](https://github.com/vdimir)).
* 数据导出支持并行格式化。 [#11617](https://github.com/ClickHouse/ClickHouse/pull/11617) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* LDAP 集成：在 LDAP 服务器连接配置中新增 `verification_cooldown` 参数，用于在可配置的时间内缓存成功的 “bind” 尝试。[#15988](https://github.com/ClickHouse/ClickHouse/pull/15988) ([Denis Glazachev](https://github.com/traceon))。
* 为 `clickhouse-local` 添加 `--no-system-table` 选项，以便在不加载系统表的情况下运行。这可以避免在启动时初始化 `DateLUT`，从而节省可能达到数十毫秒的时间。 [#18899](https://github.com/ClickHouse/ClickHouse/pull/18899) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 在 `AggregateFunctionWindowFunnelData` 中将 `PODArray` 替换为 `PODArrayWithStackMemory`，从而提升 `windowFunnel` 函数的性能。 [#18817](https://github.com/ClickHouse/ClickHouse/pull/18817) ([flynn](https://github.com/ucasFL)).
* 在对 Distributed 表执行同步 INSERT 时，不再向各分片发送空数据块。此更改解决了 [#14571](https://github.com/ClickHouse/ClickHouse/issues/14571)。[#18775](https://github.com/ClickHouse/ClickHouse/pull/18775)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 优化了 StorageMemory 的读取性能。 [#18052](https://github.com/ClickHouse/ClickHouse/pull/18052) ([Maksim Kita](https://github.com/kitaisreal)).
* 使用 Dragonbox 算法替代 ryu，将浮点数转换为字符串。这显著提升了该转换的性能。[#17831](https://github.com/ClickHouse/ClickHouse/pull/17831) ([Maksim Kita](https://github.com/kitaisreal))。
* 加速 `IPv6CIDRToRange` 的实现。 [#17569](https://github.com/ClickHouse/ClickHouse/pull/17569) ([vdimir](https://github.com/vdimir)).
* 添加 `remerge_sort_lowered_memory_bytes_ratio` 设置项（如果重新合并后的内存使用量未按该比例降低，则会禁用重新合并）。 [#17539](https://github.com/ClickHouse/ClickHouse/pull/17539) ([Azat Khuzhin](https://github.com/azat)).
* 改进在主键中使用 `SimpleAggregateFunction(String)` 时 `AggregatingMergeTree` 的性能。[#17109](https://github.com/ClickHouse/ClickHouse/pull/17109)（[Azat Khuzhin](https://github.com/azat)）。
* 现在 `-If` 组合器已完成去虚拟化处理，`count` 也已正确完成向量化处理。相关变更见 [此 PR](https://github.com/ClickHouse/ClickHouse/pull/17041)。[#17043](https://github.com/ClickHouse/ClickHouse/pull/17043)（[Amos Bird](https://github.com/amosbird)）。
* 优化在包含大量 `MergeTree` 表时从 `Merge` 表读取数据的性能。修复了 [#7748](https://github.com/ClickHouse/ClickHouse/issues/7748)。[#16988](https://github.com/ClickHouse/ClickHouse/pull/16988)（[Anton Popov](https://github.com/CurtizJ)）。
* 提升了函数 `repeat` 的性能。[#16937](https://github.com/ClickHouse/ClickHouse/pull/16937) ([satanson](https://github.com/satanson))。
* 略微提升浮点数解析性能。 [#16809](https://github.com/ClickHouse/ClickHouse/pull/16809) ([Maksim Kita](https://github.com/kitaisreal)).
* 为 `OPTIMIZE TABLE ... FINAL` 新增可跳过已合并分区的功能。[#15939](https://github.com/ClickHouse/ClickHouse/pull/15939) ([Kruglov Pavel](https://github.com/Avogar))。
* 集成 [Daniel Lemire 的 fast&#95;float](https://github.com/lemire/fast_float) 以解析浮点数。 [#16787](https://github.com/ClickHouse/ClickHouse/pull/16787)（[Maksim Kita](https://github.com/kitaisreal)）。目前尚未启用，因为其性能仍然低于 ClickHouse 中的粗略浮点解析器。
* 修复 `max_distributed_connections`（影响 `prefer_localhost_replica = 1` 时以及 `max_threads != max_distributed_connections` 时的行为）。[#17848](https://github.com/ClickHouse/ClickHouse/pull/17848) ([Azat Khuzhin](https://github.com/azat)).
* 向 S3 发送数据时自适应选择单段/多段上传。单段上传由新设置 `max_single_part_upload_size` 控制。[#17934](https://github.com/ClickHouse/ClickHouse/pull/17934) ([Pavel Kovalenko](https://github.com/Jokser)).
* 在 `PipelineExecutor` 中添加了对异步任务的支持。为远程查询提供了初步的异步套接字支持。[#17868](https://github.com/ClickHouse/ClickHouse/pull/17868) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 允许在列大小未知的情况下，对 compact parts 使用 `optimize_move_to_prewhere` 优化。[#17330](https://github.com/ClickHouse/ClickHouse/pull/17330) ([Anton Popov](https://github.com/CurtizJ)).

#### 改进 {#improvement-10}


* 在对使用 `TinyLog` 或 `Log` 表引擎的表执行 `INSERT SELECT`，将数据插入到自身时避免发生死锁。此更改关闭了 [#6802](https://github.com/ClickHouse/ClickHouse/issues/6802)。此更改关闭了 [#18691](https://github.com/ClickHouse/ClickHouse/issues/18691)。此更改关闭了 [#16812](https://github.com/ClickHouse/ClickHouse/issues/16812)。此更改关闭了 [#14570](https://github.com/ClickHouse/ClickHouse/issues/14570)。[#15260](https://github.com/ClickHouse/ClickHouse/pull/15260)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 支持 `SHOW CREATE VIEW name` 语法，与 [MySQL](https://dev.mysql.com/doc/refman/5.7/en/show-create-view.html) 类似。 [#18095](https://github.com/ClickHouse/ClickHouse/pull/18095) ([Du Chuan](https://github.com/spongedu))。
* 允许所有 `Decimal * Float` 或其反向形式的查询，包括聚合查询（例如 `SELECT sum(decimal_field * 1.1)` 或 `SELECT dec_col * float_col`），结果类型为 Float32 或 Float64。[#18145](https://github.com/ClickHouse/ClickHouse/pull/18145)（[Mike](https://github.com/myrrc)）。
* 改进精简版 Web UI：添加历史记录；添加分享功能；避免不同请求之间的竞态条件；添加请求进行中和就绪指示器；添加 favicon；在 textarea 未聚焦时检测 Ctrl+Enter。 [#17293](https://github.com/ClickHouse/ClickHouse/pull/17293) [#17770](https://github.com/ClickHouse/ClickHouse/pull/17770) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* clickhouse-server 未向 ZooKeeper 服务器发送 `close` 请求。[#16837](https://github.com/ClickHouse/ClickHouse/pull/16837) ([alesapin](https://github.com/alesapin))。
* 防止在内存限制过低（`max_memory_usage = 1` / `max_untracked_memory = 1`）的情况下服务器异常终止。 [#17453](https://github.com/ClickHouse/ClickHouse/pull/17453) ([Azat Khuzhin](https://github.com/azat)).
* 修复 `windowFunnel` 函数在不同事件具有相同时间戳时结果非确定的问题。[#18884](https://github.com/ClickHouse/ClickHouse/pull/18884) ([Fuwang Hu](https://github.com/fuwhu)).
* Docker：在 clickhouse-server Docker 镜像中，将 clickhouse 用户及其用户组的 UID/GID 显式设置为固定值 101。[#19096](https://github.com/ClickHouse/ClickHouse/pull/19096) ([filimonov](https://github.com/filimonov)).
* 对 `Distributed` 表进行异步 INSERT：新增了两个设置（类似于 MergeTree 系列表）：- `fsync_after_insert` - 针对每次插入执行 fsync，会降低插入性能。- `fsync_directories` - 在所有操作（写入、重命名等）完成后，对临时目录（仅用于异步 INSERT）执行 fsync。[#18864](https://github.com/ClickHouse/ClickHouse/pull/18864)（[Azat Khuzhin](https://github.com/azat)）。
* `SYSTEM KILL` 命令现在可以在 Docker 中使用。这一更改关闭了 [#18847](https://github.com/ClickHouse/ClickHouse/issues/18847)。[#18848](https://github.com/ClickHouse/ClickHouse/pull/18848)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在执行 `FETCH PARTITION` 时展开 ZooKeeper 路径中的宏。 [#18839](https://github.com/ClickHouse/ClickHouse/pull/18839) ([fastio](https://github.com/fastio)).
* 对所有副本应用 `ALTER TABLE <replicated_table> ON CLUSTER MODIFY SETTING ...`。因为这类 ALTER 命令不会在副本间复制。[#18789](https://github.com/ClickHouse/ClickHouse/pull/18789)（[Amos Bird](https://github.com/amosbird)）。
* 允许列转换器 `EXCEPT` 接受字符串作为正则表达式匹配模式，从而解决了 [#18685](https://github.com/ClickHouse/ClickHouse/issues/18685) 问题。[#18699](https://github.com/ClickHouse/ClickHouse/pull/18699)（[Amos Bird](https://github.com/amosbird)）。
* 修复 `SummingMergeTree` 中的 `SimpleAggregateFunction`，现在它的行为与 `AggregateFunction` 一致。在之前的版本中，值会在不考虑具体聚合函数的情况下被相加。此变更修复了 [#18564](https://github.com/ClickHouse/ClickHouse/issues/18564)、[#8052](https://github.com/ClickHouse/ClickHouse/issues/8052)、[#18637](https://github.com/ClickHouse/ClickHouse/pull/18637)（[Amos Bird](https://github.com/amosbird)）。另外，还修复了在 `SummingMergeTree` 中使用 `SimpleAggregateFunction` 时的问题，修复了 [#18676](https://github.com/ClickHouse/ClickHouse/issues/18676)、[#18677](https://github.com/ClickHouse/ClickHouse/pull/18677)（[Amos Bird](https://github.com/amosbird)）。
* 修复了当函数 `bar` 的最后一个参数为 NaN 时分配器内部触发的断言错误。现在会抛出常规的 ClickHouse 异常。此修复解决了 [#17876](https://github.com/ClickHouse/ClickHouse/issues/17876)。[#18520](https://github.com/ClickHouse/ClickHouse/pull/18520)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 修复一个可用性问题：在某些工具中，异常消息后没有换行。 [#18444](https://github.com/ClickHouse/ClickHouse/pull/18444) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 新增支持修改主键和分区键列的类型，可在 `LowCardinality(Type)` 与 `Type` 之间互相转换。同时新增支持将主键列类型从 `EnumX` 修改为 `IntX` 类型。修复 [#5604](https://github.com/ClickHouse/ClickHouse/issues/5604)。[#18362](https://github.com/ClickHouse/ClickHouse/pull/18362) ([alesapin](https://github.com/alesapin))。
* 实现对 `untuple` 字段访问。[#18133](https://github.com/ClickHouse/ClickHouse/issues/18133)。[#18309](https://github.com/ClickHouse/ClickHouse/pull/18309)（[hexiaoting](https://github.com/hexiaoting)）。
* 允许从 CSV 中解析 Array 字段，如果该字段是一个字符串，且该字符串中包含按嵌套 CSV 方式序列化的数组。例如：`"[""Hello"", ""world"", ""42"""" TV""]"` 将被解析为 `['Hello', 'world', '42" TV']`。允许在 CSV 中解析作为字符串的数组，即使该字符串未带外层方括号。示例：`"'Hello', 'world', '42"" TV'"` 将被解析为 `['Hello', 'world', '42" TV']`。[#18271](https://github.com/ClickHouse/ClickHouse/pull/18271) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 改进 MergeTree 宽部分的自适应粒度计算。 [#18223](https://github.com/ClickHouse/ClickHouse/pull/18223) ([alesapin](https://github.com/alesapin)).
* 现在 `clickhouse install` 已可在 Mac 上运行。之前的问题在于该平台没有 procfs 文件系统。[#18201](https://github.com/ClickHouse/ClickHouse/pull/18201)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 改进了 `SHOW ...` 查询语法的提示。[#18183](https://github.com/ClickHouse/ClickHouse/pull/18183)（[Du Chuan](https://github.com/spongedu)）。
* 数组聚合函数 `arrayMin`、`arrayMax`、`arraySum`、`arrayAvg` 现在支持 `Int128`、`Int256`、`UInt256`。 [#18147](https://github.com/ClickHouse/ClickHouse/pull/18147) ([Maksim Kita](https://github.com/kitaisreal)).
* 在 Set 和 Join 的存储设置中添加 `disk`。[#18112](https://github.com/ClickHouse/ClickHouse/pull/18112)（[Grigory Pervakov](https://github.com/GrigoryPervakov)）。
* 访问控制：现在表函数 `merge()` 要求当前用户对其读取数据的每个表都具有 `SELECT` 权限。此 PR 修复了 [#16964](https://github.com/ClickHouse/ClickHouse/issues/16964)。[#18104](https://github.com/ClickHouse/ClickHouse/pull/18104) [#17983](https://github.com/ClickHouse/ClickHouse/pull/17983)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 临时表现在在系统表 `system.tables` 和 `system.columns` 中仅在其创建所在的会话中可见。内部数据库 `_temporary_and_external_tables` 现在在这些系统表中已被隐藏；临时表会显示为 `database` 为空且 `is_temporary` 标志被设置的表。[#18014](https://github.com/ClickHouse/ClickHouse/pull/18014)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复在终端窗口大小改变时 `clickhouse-client` 的渲染问题。 [#18009](https://github.com/ClickHouse/ClickHouse/pull/18009) ([Amos Bird](https://github.com/amosbird))。
* 当客户端断开连接时，将该事件的日志级别从 Warning 降低为 Information。 [#18005](https://github.com/ClickHouse/ClickHouse/pull/18005) ([filimonov](https://github.com/filimonov)).
* 从文件系统中强制删除 DiskS3 的空或损坏元数据文件。S3 是一项实验性特性。[#17935](https://github.com/ClickHouse/ClickHouse/pull/17935) ([Pavel Kovalenko](https://github.com/Jokser))。
* 访问控制：`allow_introspection_functions=0` 会禁止使用 introspection 函数，但不再禁止为这些函数授予权限（被授予者需要将 `allow_introspection_functions` 设置为 1 才能使用相应授权）。类似地，`allow_ddl=0` 会禁止使用 DDL 命令，但不再禁止为这些命令授予权限。[#17908](https://github.com/ClickHouse/ClickHouse/pull/17908)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 可用性改进：列名提示。[#17112](https://github.com/ClickHouse/ClickHouse/issues/17112)。[#17857](https://github.com/ClickHouse/ClickHouse/pull/17857) ([fastio](https://github.com/fastio))。
* 当两个 `Merge` 表尝试互相读取对方的数据时，添加诊断信息。 [#17854](https://github.com/ClickHouse/ClickHouse/pull/17854) ([徐炘](https://github.com/weeds085490))。
* 允许在使用 ClickHouse Docker 镜像运行脚本时自定义超时时间。 [#17818](https://github.com/ClickHouse/ClickHouse/pull/17818) ([Guillaume Tassery](https://github.com/YiuRULE)).
* 检查系统日志表的引擎定义语法，以防止某些配置错误。请注意，此语法检查不涉及语义分析，这意味着诸如不存在的列或表达式函数之类的错误，只有在创建表时才会被发现。[#17739](https://github.com/ClickHouse/ClickHouse/pull/17739) ([Du Chuan](https://github.com/spongedu))。
* 移除了在初始化 `RabbitMQ` 表时如果没有连接则抛出异常的机制（现在将在后台自动重连）。[#17709](https://github.com/ClickHouse/ClickHouse/pull/17709) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 在执行 Buffer 刷新时不要忽略服务器的内存限制。[#17646](https://github.com/ClickHouse/ClickHouse/pull/17646) ([Azat Khuzhin](https://github.com/azat)).
* 切换到打过补丁的 RocksDB 版本（来自 ClickHouse-Extras），以修复 use-after-free 错误。[#17643](https://github.com/ClickHouse/ClickHouse/pull/17643) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 为并行解析的异常消息添加了偏移信息。修复了 [#17457](https://github.com/ClickHouse/ClickHouse/issues/17457)。[#17641](https://github.com/ClickHouse/ClickHouse/pull/17641)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 在执行 INSERT 查询过程中不再抛出 “Too many parts” 错误。[#17566](https://github.com/ClickHouse/ClickHouse/pull/17566)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 `ALTER` 查询的 `UPDATE` 语句中允许使用查询参数。修复了 [#10976](https://github.com/ClickHouse/ClickHouse/issues/10976)。[#17563](https://github.com/ClickHouse/ClickHouse/pull/17563)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 查询混淆器：避免在标识符名称中使用某些 SQL 关键字。[#17526](https://github.com/ClickHouse/ClickHouse/pull/17526) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 通过服务器指标导出当前由 DDLWorker 已执行的最大 DDL 项。用于检查 DDLWorker 是否在某处卡住。[#17464](https://github.com/ClickHouse/ClickHouse/pull/17464) ([Amos Bird](https://github.com/amosbird))。
* 导出所有服务器上当前线程的异步指标。这有助于排查类似[这个问题](https://github.com/ClickHouse-Extras/poco/pull/28)的故障。[#17463](https://github.com/ClickHouse/ClickHouse/pull/17463)（[Amos Bird](https://github.com/amosbird)）。
* 启用 `asterisk_include_materialized_columns` 和 `asterisk_include_alias_columns` 设置后，在通配符查询中包含 MATERIALIZED / ALIAS 等动态列。 [#17462](https://github.com/ClickHouse/ClickHouse/pull/17462) ([Ken Chen](https://github.com/chenziliang)).
* 允许在 `config.xml` 中使用 `<ttl>` 属性为[系统日志表](/operations/system-tables/)指定 [TTL](/engines/table-engines/mergetree-family/mergetree/#mergetree-table-ttl)，以删除旧条目。[#17438](https://github.com/ClickHouse/ClickHouse/pull/17438)（[Du Chuan](https://github.com/spongedu)）。
* 现在，通过 MySQL 和 PostgreSQL 协议访问服务器的查询具有区分开的接口类型（可在表 `system.query_log` 的 `interface` 列中查看）：MySQL 为 `4`，PostgreSQL 为 `5`，而先前使用的 `1` 现仅用于原生协议。 [#17437](https://github.com/ClickHouse/ClickHouse/pull/17437) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复 `INSERT ... SELECT ... SETTINGS` 查询中 `SETTINGS` 子句的解析。 [#17414](https://github.com/ClickHouse/ClickHouse/pull/17414) ([Azat Khuzhin](https://github.com/azat)).
* 在 RadixSort 中正确统计内存占用。[#17412](https://github.com/ClickHouse/ClickHouse/pull/17412) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 在服务器的 `receiveHello` 中添加 eof 检查，以避免出现 `Attempt to read after eof` 异常。[#17365](https://github.com/ClickHouse/ClickHouse/pull/17365)（[Kruglov Pavel](https://github.com/Avogar)）。
* 避免在 bigint 转换中可能发生的栈溢出。大整数目前为实验性功能。[#17269](https://github.com/ClickHouse/ClickHouse/pull/17269) ([flynn](https://github.com/ucasFL)).
* 现在，`set` 索引可以与 `GLOBAL IN` 一起使用了。这修复了 [#17232](https://github.com/ClickHouse/ClickHouse/issues/17232)、[#5576](https://github.com/ClickHouse/ClickHouse/issues/5576)。[#17253](https://github.com/ClickHouse/ClickHouse/pull/17253)（[Amos Bird](https://github.com/amosbird)）。
* 在对 S3 存储的请求中为 HTTP 重定向添加次数上限（`s3_max_redirects`）。[#17220](https://github.com/ClickHouse/ClickHouse/pull/17220)（[ianton-ru](https://github.com/ianton-ru)）。
* 当 `-OrNull` 组合子与 `-If`、`-Merge`、`-MergeState`、`-State` 组合子组合使用时，应将 `-OrNull` 置于最前。[#16935](https://github.com/ClickHouse/ClickHouse/pull/16935) ([flynn](https://github.com/ucasFL))。
* 支持配置 HTTP 代理和 HTTPS S3 端点。 [#16861](https://github.com/ClickHouse/ClickHouse/pull/16861) ([Pavel Kovalenko](https://github.com/Jokser)).
* 为 S3 客户端添加了通过环境变量、`~/.aws` 和 `AssumeRole` 的正确身份验证。[#16856](https://github.com/ClickHouse/ClickHouse/pull/16856) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 添加更多 OpenTelemetry span，并添加一个将 span 数据导出到 Zipkin 的示例。[#16535](https://github.com/ClickHouse/ClickHouse/pull/16535)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* 缓存字典：在获取时完全消除回调和锁。键在查询期间统一存储在同一个 map 中，而不再区分「未找到」和「已过期」。[#14958](https://github.com/ClickHouse/ClickHouse/pull/14958) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 修复从未生效的 `fsync_part_directory`/`fsync_after_insert`/`in_memory_parts_insert_sync`（实验性特性）。 [#18845](https://github.com/ClickHouse/ClickHouse/pull/18845) ([Azat Khuzhin](https://github.com/azat)).
* 允许为 `MaterializeMySQL` 引擎的嵌套数据库使用 `Atomic` 引擎。 [#14849](https://github.com/ClickHouse/ClickHouse/pull/14849) ([tavplubix](https://github.com/tavplubix)).

#### 错误修复 {#bug-fix-10}


* 修复了在极少数情况下可能导致服务器停止接受连接的问题。[#17542](https://github.com/ClickHouse/ClickHouse/pull/17542) (Amos Bird, [alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复对带常量参数的二元函数进行索引分析时的问题，该问题会导致错误的查询结果。此修复对应 [#18364](https://github.com/ClickHouse/ClickHouse/issues/18364)。[#18373](https://github.com/ClickHouse/ClickHouse/pull/18373)（[Amos Bird](https://github.com/amosbird)）。
* 修复当索引比较两侧的类型不一致时可能出现的错误索引分析，从而修复了 [#17122](https://github.com/ClickHouse/ClickHouse/issues/17122)。[#17145](https://github.com/ClickHouse/ClickHouse/pull/17145)（[Amos Bird](https://github.com/amosbird)）。
* 在合并时禁用使用 AIO 的写入，因为这在极少数情况下可能会导致合并过程中主键列数据损坏。[#18481](https://github.com/ClickHouse/ClickHouse/pull/18481) ([alesapin](https://github.com/alesapin)).
* 限制从宽格式部件到紧凑格式部件的合并。在发生垂直合并时，这可能导致生成的结果部件损坏。[#18381](https://github.com/ClickHouse/ClickHouse/pull/18381) ([Anton Popov](https://github.com/CurtizJ))。
* 修复在发生读取退避时（日志中会出现消息 `<Debug> MergeTreeReadPool: Will lower number of threads`），从 `MergeTree*` 读取可能导致查询结果不完整的问题。该问题引入于 [#16423](https://github.com/ClickHouse/ClickHouse/issues/16423)。此修复解决了 [#18137](https://github.com/ClickHouse/ClickHouse/issues/18137)。[#18216](https://github.com/ClickHouse/ClickHouse/pull/18216)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复 `rocksdb` 库中的释放后使用（use-after-free）缺陷。[#18862](https://github.com/ClickHouse/ClickHouse/pull/18862) ([sundyli](https://github.com/sundy-li))。
* 修复以 `ORC` 格式从文件进行无限循环读取的问题（该问题是在 [#10580](https://github.com/ClickHouse/ClickHouse/issues/10580) 中引入的）。修复了 [#19095](https://github.com/ClickHouse/ClickHouse/issues/19095)。[#19134](https://github.com/ClickHouse/ClickHouse/pull/19134)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了 `MergeTree` 数据写入器中的一个 bug，该 bug 可能导致写出的标记大小大于固定粒度大小。修复 [#18913](https://github.com/ClickHouse/ClickHouse/issues/18913)。[#19123](https://github.com/ClickHouse/ClickHouse/pull/19123)（[alesapin](https://github.com/alesapin)）。
* 修复了一个启动时的错误：clickhouse 无法从 `LowCardinality(Nullable(...))` 中读取压缩编解码器，并抛出异常 `Attempt to read after EOF`。修复了 [#18340](https://github.com/ClickHouse/ClickHouse/issues/18340)。[#19101](https://github.com/ClickHouse/ClickHouse/pull/19101)（[alesapin](https://github.com/alesapin)）。
* 限制对使用旧语法创建的 `MergeTree` 表执行 `MODIFY TTL` 查询。此前此类查询会执行成功，但实际上并不会产生任何效果。[#19064](https://github.com/ClickHouse/ClickHouse/pull/19064) ([Anton Popov](https://github.com/CurtizJ)).
* 确保 `groupUniqArray` 在处理 Enum 类型参数时返回正确的类型。此更改关闭了 [#17875](https://github.com/ClickHouse/ClickHouse/issues/17875)。[#19019](https://github.com/ClickHouse/ClickHouse/pull/19019)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在使用 `ignore` 函数且参数为 `LowCardinality` 时可能出现的错误 `Expected single dictionary argument for function`。修复 [#14275](https://github.com/ClickHouse/ClickHouse/issues/14275)。[#19016](https://github.com/ClickHouse/ClickHouse/pull/19016)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了向 `TinyLog` 引擎表中插入 `LowCardinality` 列时的问题。修复了 [#18629](https://github.com/ClickHouse/ClickHouse/issues/18629)。[#19010](https://github.com/ClickHouse/ClickHouse/pull/19010)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* JOIN 会尝试将 const 列实体化，但我们的代码需要它们位于其他位置。[#18982](https://github.com/ClickHouse/ClickHouse/pull/18982)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 禁用 `optimize_move_functions_out_of_any`，因为该优化在某些情况下并不正确。关闭 [#18051](https://github.com/ClickHouse/ClickHouse/issues/18051)。关闭 [#18973](https://github.com/ClickHouse/ClickHouse/issues/18973)。[#18981](https://github.com/ClickHouse/ClickHouse/pull/18981)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在合并查询计划中的 `Expression` 步骤时可能引发的异常 `QueryPipeline stream: different number of columns`。修复了 [#18190](https://github.com/ClickHouse/ClickHouse/issues/18190)。[#18980](https://github.com/ClickHouse/ClickHouse/pull/18980)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在关闭时极其罕见的死锁问题。 [#18977](https://github.com/ClickHouse/ClickHouse/pull/18977) ([tavplubix](https://github.com/tavplubix)).
* 修复 `ALTER TABLE ... DROP PART 'part_name'` 查询在导致整个分区的所有去重块被删除时的错误行为。修复了 [#18874](https://github.com/ClickHouse/ClickHouse/issues/18874)。[#18969](https://github.com/ClickHouse/ClickHouse/pull/18969)（[alesapin](https://github.com/alesapin)）。
* ATTACH PARTITION 应重置 mutation。 [#18804](https://github.com/ClickHouse/ClickHouse/issues/18804)。 [#18935](https://github.com/ClickHouse/ClickHouse/pull/18935) ([fastio](https://github.com/fastio))。
* 修复 `bitmapOrCardinality` 中可能导致 nullptr 解引用的问题。这解决了 [#18911](https://github.com/ClickHouse/ClickHouse/issues/18911)。[#18912](https://github.com/ClickHouse/ClickHouse/pull/18912)（[sundyli](https://github.com/sundy-li)）。
* 修复 `clickhouse-local` 在关闭时可能发生的挂起问题。此更改修复了 [#18891](https://github.com/ClickHouse/ClickHouse/issues/18891)。[#18893](https://github.com/ClickHouse/ClickHouse/pull/18893)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 当查询中包含形如 `x IN table` 的表达式时，对外部数据库（MySQL、ODBC、JDBC）的查询会被错误地改写。此修复解决了 [#9756](https://github.com/ClickHouse/ClickHouse/issues/9756)。[#18876](https://github.com/ClickHouse/ClickHouse/pull/18876)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 *If 组合器在一元函数和 Nullable 类型上的问题。 [#18806](https://github.com/ClickHouse/ClickHouse/pull/18806) ([Azat Khuzhin](https://github.com/azat)).
* 修复了这样一个问题：当全局将 `network_compression_method` 设置为非默认值时，异步分布式 INSERT 可能会被服务器拒绝。此更改修复了 [#18741](https://github.com/ClickHouse/ClickHouse/issues/18741)。 [#18776](https://github.com/ClickHouse/ClickHouse/pull/18776)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在尝试将 `NULL` 从 `Nullable(String)` `CAST` 为 `Nullable(Decimal(P, S))` 时出现的 `Attempt to read after eof` 错误。现在，当无法从 `Nullable(String)` 中解析出十进制数时，`CAST` 函数会返回 `NULL`。修复了 [#7690](https://github.com/ClickHouse/ClickHouse/issues/7690)。[#18718](https://github.com/ClickHouse/ClickHouse/pull/18718)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复日志记录中的一个小问题。 [#18717](https://github.com/ClickHouse/ClickHouse/pull/18717) ([sundyli](https://github.com/sundy-li)).
* 修复在使用旧语法创建的 `ReplicatedMergeTree` 表中删除空数据部分的问题。修复了 [#18582](https://github.com/ClickHouse/ClickHouse/issues/18582)。[#18614](https://github.com/ClickHouse/ClickHouse/pull/18614)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复之前在不同取值情况下发生的日期溢出问题。严格将 `Date` 类型的取值上限限制为 &quot;2106-02-07&quot;，并将大于 &quot;2106-02-07&quot; 的日期转换为值 0。 [#18565](https://github.com/ClickHouse/ClickHouse/pull/18565) ([hexiaoting](https://github.com/hexiaoting)).
* 为从 MySQL 复制添加对 `FixedString` 数据类型的支持。MySQL 复制目前是实验性功能。此补丁修复了 [#18450](https://github.com/ClickHouse/ClickHouse/issues/18450)，并同时修复了 [#6556](https://github.com/ClickHouse/ClickHouse/issues/6556)。[#18553](https://github.com/ClickHouse/ClickHouse/pull/18553)（[awesomeleo](https://github.com/awesomeleo)）。
* 修复在对包含 `RIGHT` 或 `FULL` JOIN 的子查询结果使用 `ORDER BY` 时可能出现的 `Pipeline stuck` 错误。[#18550](https://github.com/ClickHouse/ClickHouse/pull/18550) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复一个 bug，该 bug 可能会在终止相应的 mutation 后导致 `ALTER` 查询挂起。由 thread fuzzer 发现。[#18518](https://github.com/ClickHouse/ClickHouse/pull/18518) ([alesapin](https://github.com/alesapin))。
* 在 `parseDateTimeBestEffort` 函数中正确支持 12AM（凌晨 0 点）。此更改修复了 [#18402](https://github.com/ClickHouse/ClickHouse/issues/18402)。[#18449](https://github.com/ClickHouse/ClickHouse/pull/18449)（[vladimir-golovchenko](https://github.com/vladimir-golovchenko)）。
* 修复了在执行参数类型为 `Nullable(String)` 的 `toType(...)` 系列函数（如 `toDate`、`toUInt32` 等）时出现的 `value is too short` 错误。现在，此类函数在解析出错时会返回 `NULL`，而不再抛出异常。修复了 [#7673](https://github.com/ClickHouse/ClickHouse/issues/7673)。[#18445](https://github.com/ClickHouse/ClickHouse/pull/18445)（[tavplubix](https://github.com/tavplubix)）。
* 修复 `SHOW TABLES` 的非预期行为。 [#18431](https://github.com/ClickHouse/ClickHouse/pull/18431) ([fastio](https://github.com/fastio)).
* 修复 `-SimpleState` 组合器生成的不兼容参数类型和返回类型的问题。[#18404](https://github.com/ClickHouse/ClickHouse/pull/18404) ([Amos Bird](https://github.com/amosbird))。
* 修复在并发使用 `Set` 或 `Join` 表并从 `system.tables` 中查询时可能出现的竞态条件。 [#18385](https://github.com/ClickHouse/ClickHouse/pull/18385) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复 `system.settings_profile_elements` 表的数据填充问题。此 PR 修复了 [#18231](https://github.com/ClickHouse/ClickHouse/issues/18231)。[#18379](https://github.com/ClickHouse/ClickHouse/pull/18379)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复在使用两级聚合时，带有 `Distinct` 组合器的聚合函数可能导致的崩溃问题。修复 [#17682](https://github.com/ClickHouse/ClickHouse/issues/17682)。[#18365](https://github.com/ClickHouse/ClickHouse/pull/18365)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复了在具有 IPv4/IPv6 双栈的机器上，服务器无法访问 `clickhouse-odbc-bridge` 进程的问题；修复了在使用格式错误的查询执行 ODBC 字典更新时可能导致 `odbc-bridge` 进程崩溃的问题；可能修复了 [#14489](https://github.com/ClickHouse/ClickHouse/issues/14489) 中的问题。[#18278](https://github.com/ClickHouse/ClickHouse/pull/18278)（[Denis Glazachev](https://github.com/traceon)）。
* 访问控制：现在只要用户对表中的至少一列有访问权限，就可以执行 `SELECT count() FROM table`。该 PR 修复了 [#10639](https://github.com/ClickHouse/ClickHouse/issues/10639)。[#18233](https://github.com/ClickHouse/ClickHouse/pull/18233)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 访问控制：`SELECT JOIN` 现在要求对参与 JOIN 的每个表都具备 `SELECT` 权限。此 PR 修复了 [#17654](https://github.com/ClickHouse/ClickHouse/issues/17654)。[#18232](https://github.com/ClickHouse/ClickHouse/pull/18232)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复 `Enum` 与 `Int` 类型之间的键比较问题。这修复了 [#17989](https://github.com/ClickHouse/ClickHouse/issues/17989)。[#18214](https://github.com/ClickHouse/ClickHouse/pull/18214)（[Amos Bird](https://github.com/amosbird)）。
* 从 MySQL 进行复制（实验性功能）。修复 [#18186](https://github.com/ClickHouse/ClickHouse/issues/18186)，修复 [#16372](https://github.com/ClickHouse/ClickHouse/issues/16372)，修复 MaterializeMySQL 数据库引擎中唯一键转换的问题。[#18211](https://github.com/ClickHouse/ClickHouse/pull/18211) ([Winter Zhang](https://github.com/zhang2014))。
* 修复同时包含 `WITH FILL` 和 `WITH TIES` 的查询中行为不一致的问题 [#17466](https://github.com/ClickHouse/ClickHouse/issues/17466)。[#18188](https://github.com/ClickHouse/ClickHouse/pull/18188)（[hexiaoting](https://github.com/hexiaoting)）。
* 修复当最后一列解析出错时仍插入使用默认值的行的问题。修复了 [#17712](https://github.com/ClickHouse/ClickHouse/issues/17712)。[#18182](https://github.com/ClickHouse/ClickHouse/pull/18182)（[Jianmei Zhang](https://github.com/zhangjmruc)）。
* 修复在尝试指定 settings profile 时出现的 `Unknown setting profile` 错误。[#18167](https://github.com/ClickHouse/ClickHouse/pull/18167) ([tavplubix](https://github.com/tavplubix))。
* 修复在执行查询 `MODIFY COLUMN ... REMOVE TTL` 时未实际移除列 TTL 的错误。 [#18130](https://github.com/ClickHouse/ClickHouse/pull/18130) ([alesapin](https://github.com/alesapin)).
* 修复了在解析 S3 URL 时出现的 `std::out_of_range: basic_string` 异常。[#18059](https://github.com/ClickHouse/ClickHouse/pull/18059) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 修复 `DateTime64` 与 `Date` 的比较逻辑。修复了 [#13804](https://github.com/ClickHouse/ClickHouse/issues/13804) 和 [#11222](https://github.com/ClickHouse/ClickHouse/issues/11222)。... [#18050](https://github.com/ClickHouse/ClickHouse/pull/18050)（[Vasily Nemkov](https://github.com/Enmk)）。
* 从 MySQL 进行复制（实验性特性）：修复 [#15187](https://github.com/ClickHouse/ClickHouse/issues/15187)，修复 [#17912](https://github.com/ClickHouse/ClickHouse/issues/17912)，支持在 MaterializeMySQL 中转换 MySQL 前缀索引。[#17944](https://github.com/ClickHouse/ClickHouse/pull/17944) ([Winter Zhang](https://github.com/zhang2014))。
* 当使用数值大于 2^32 的 `logger.size` 参数配置服务器日志轮转时，日志未能正确轮转。该问题已修复。 [#17905](https://github.com/ClickHouse/ClickHouse/pull/17905) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* 当查询包含 ARRAY JOIN 时（即查询实际上并非“简单”），简单查询优化会产生错误结果。[#17887](https://github.com/ClickHouse/ClickHouse/pull/17887) ([sundyli](https://github.com/sundy-li))。
* 修复可能导致 `topK` 聚合函数发生段错误的问题，关闭了 [#17404](https://github.com/ClickHouse/ClickHouse/issues/17404)。[#17845](https://github.com/ClickHouse/ClickHouse/pull/17845)（[Maksim Kita](https://github.com/kitaisreal)）。
* WAL（实验性功能）：如果禁用了 `in_memory_parts_enable_wal`，则不要从 WAL 中恢复数据分片。 [#17802](https://github.com/ClickHouse/ClickHouse/pull/17802) ([detailyang](https://github.com/detailyang))。
* 关于最大可删除表大小的异常消息显示不正确。 [#17764](https://github.com/ClickHouse/ClickHouse/pull/17764) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复了在向 `Distributed` 表插入数据且空间不足时可能发生的段错误问题。 [#17737](https://github.com/ClickHouse/ClickHouse/pull/17737) ([tavplubix](https://github.com/tavplubix)).
* 修复了 ClickHouse 无法重新建立与 MySQL 服务器连接时出现的问题。[#17681](https://github.com/ClickHouse/ClickHouse/pull/17681) ([Alexander Kazakov](https://github.com/Akazz))。
* Windows：修复了在 Windows Subsystem for Linux 上运行 ClickHouse 时，在 `Atomic` 数据库中执行 `RENAME` 查询会出现的 `Function not implemented` 错误。修复了 [#17661](https://github.com/ClickHouse/ClickHouse/issues/17661)。[#17664](https://github.com/ClickHouse/ClickHouse/pull/17664)（[tavplubix](https://github.com/tavplubix)）。
* 在执行 `ON CLUSTER` 查询时，当 `pool_size` &gt; 1 时，由于竞争条件，可能会错误地判断集群是否为环形（交叉）复制集群。该问题已修复。[#17640](https://github.com/ClickHouse/ClickHouse/pull/17640) ([tavplubix](https://github.com/tavplubix)).
* 修复在服务器以守护进程模式运行时 `system.stack_trace` 表为空的问题。[#17630](https://github.com/ClickHouse/ClickHouse/pull/17630) ([Amos Bird](https://github.com/amosbird)).
* 异常 `fmt::v7::format_error` 现在可以在 MergeTree 表的后台记录到日志中。此更改修复了 [#17613](https://github.com/ClickHouse/ClickHouse/issues/17613)。[#17615](https://github.com/ClickHouse/ClickHouse/pull/17615)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在交互模式下使用 clickhouse-client 输入多行查询时，单行注释会被错误地扩展到整个查询的末尾。修复了 [#13654](https://github.com/ClickHouse/ClickHouse/issues/13654)。[#17565](https://github.com/ClickHouse/ClickHouse/pull/17565)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复当相应的 mutation 在其他副本上被终止时 `ALTER` 查询挂起的问题。修复 [#16953](https://github.com/ClickHouse/ClickHouse/issues/16953)。[#17499](https://github.com/ClickHouse/ClickHouse/pull/17499)（[alesapin](https://github.com/alesapin)）。
* 修复了在 ClickHouse 低估 mark cache 大小时的内存统计问题。当存在大量包含标记的小文件时，可能会出现此问题。 [#17496](https://github.com/ClickHouse/ClickHouse/pull/17496) ([alesapin](https://github.com/alesapin)).
* 修复在启用设置 `optimize_redundant_functions_in_order_by` 时 `ORDER BY` 的行为问题。[#17471](https://github.com/ClickHouse/ClickHouse/pull/17471) ([Anton Popov](https://github.com/CurtizJ)).
* 修复由于不正确的优化导致在使用 `DISTINCT` 后仍可能出现的重复行。修复了 [#17294](https://github.com/ClickHouse/ClickHouse/issues/17294)。[#17296](https://github.com/ClickHouse/ClickHouse/pull/17296)（[li chengxiang](https://github.com/chengxianglibra)）。[#17439](https://github.com/ClickHouse/ClickHouse/pull/17439)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了 *MergeTree 表后台任务中 CPU 占用率过高的问题。[#17416](https://github.com/ClickHouse/ClickHouse/pull/17416) ([tavplubix](https://github.com/tavplubix))。
* 修复从包含 `LowCardinality` 类型的 `JOIN` 表读取时可能发生的崩溃问题。解决了 [#17228](https://github.com/ClickHouse/ClickHouse/issues/17228)。[#17397](https://github.com/ClickHouse/ClickHouse/pull/17397)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 从 MySQL 复制（实验性特性）：修复 [#16835](https://github.com/ClickHouse/ClickHouse/issues/16835)，尝试修复与 MySQL SHOW 语句的表头不匹配问题。[#17366](https://github.com/ClickHouse/ClickHouse/pull/17366)（[Winter Zhang](https://github.com/zhang2014)）。
* 通过谓词优化器修复非确定性函数。这修复了 [#17244](https://github.com/ClickHouse/ClickHouse/issues/17244)。[#17273](https://github.com/ClickHouse/ClickHouse/pull/17273)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复在使用 `LIMIT` 的 Distributed 查询中可能出现的 `Unexpected packet Data received from client` 错误。 [#17254](https://github.com/ClickHouse/ClickHouse/pull/17254) ([Azat Khuzhin](https://github.com/azat)).
* 修复当子查询中包含 `const` 列时导致的 set 索引失效问题。此修复解决了 [#17246](https://github.com/ClickHouse/ClickHouse/issues/17246)。[#17249](https://github.com/ClickHouse/ClickHouse/pull/17249)（[Amos Bird](https://github.com/amosbird)）。
* clickhouse-copier：针对非分区表的修复 [#15235](https://github.com/ClickHouse/ClickHouse/issues/15235)。 [#17248](https://github.com/ClickHouse/ClickHouse/pull/17248)（[Qi Chen](https://github.com/kaka11chen)）。
* 修复了在 S3 磁盘上存储的分片上可能失效的变更操作（实验性特性）。[#17227](https://github.com/ClickHouse/ClickHouse/pull/17227)（[Pavel Kovalenko](https://github.com/Jokser)）。
* 修复了 `fuzzBits` 函数中的缺陷，相关问题：[#16980](https://github.com/ClickHouse/ClickHouse/issues/16980)。[#17051](https://github.com/ClickHouse/ClickHouse/pull/17051)（[hexiaoting](https://github.com/hexiaoting)）。
* 修复仅包含 OFFSET 的查询中 `optimize_distributed_group_by_sharding_key` 的问题。[#16996](https://github.com/ClickHouse/ClickHouse/pull/16996)（[Azat Khuzhin](https://github.com/azat)）。
* 修复涉及对 `Distributed` 表进行 JOIN 的 `Merge` 表查询的问题。 [#16993](https://github.com/ClickHouse/ClickHouse/pull/16993) ([Azat Khuzhin](https://github.com/azat)).
* 修复基于单调函数的 ORDER BY 优化。修复了 [#16107](https://github.com/ClickHouse/ClickHouse/issues/16107)。[#16956](https://github.com/ClickHouse/ClickHouse/pull/16956)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复了具有不同 scale 的 `DateTime64` 类型之间比较不正确的问题。修复了 [#16655](https://github.com/ClickHouse/ClickHouse/issues/16655) ... [#16952](https://github.com/ClickHouse/ClickHouse/pull/16952)（[Vasily Nemkov](https://github.com/Enmk)）。
* 修复在启用设置 `optimize_aggregators_of_group_by_keys` 且包含 JOIN 时对 `GROUP BY` 的优化问题。修复了 [#12604](https://github.com/ClickHouse/ClickHouse/issues/12604)。[#16951](https://github.com/ClickHouse/ClickHouse/pull/16951)（[Anton Popov](https://github.com/CurtizJ)）。
* 对 `SHOW ACCESS` 查询进行了小幅修正。 [#16866](https://github.com/ClickHouse/ClickHouse/pull/16866) ([tavplubix](https://github.com/tavplubix)).
* 修复在启用 `optimize_trivial_count_query` 配置项且存在分区谓词时的行为。[#16767](https://github.com/ClickHouse/ClickHouse/pull/16767) ([Azat Khuzhin](https://github.com/azat))。
* 对于通过 MySQL 线协议执行的 INSERT 查询，返回受影响的行数。之前 ClickHouse 总是返回 0，现在已修复。修复了 [#16605](https://github.com/ClickHouse/ClickHouse/issues/16605)。[#16715](https://github.com/ClickHouse/ClickHouse/pull/16715)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复由于 `select_sequential_consistency` 导致的、在已优化的简单计数查询和 system 表中出现的不一致行为。[#16309](https://github.com/ClickHouse/ClickHouse/pull/16309) ([Hao Chen](https://github.com/haoch))。
* 当 `REPLACE` 列转换器作用于不存在的列时，会抛出错误。 [#16183](https://github.com/ClickHouse/ClickHouse/pull/16183) ([hexiaoting](https://github.com/hexiaoting)).
* 在 RIGH|FULL JOIN 中，如果 `ON` 表达式不是等值连接条件，则抛出异常。 [#15162](https://github.com/ClickHouse/ClickHouse/pull/15162) ([Artem Zuikov](https://github.com/4ertus2)).

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-10}


* 为 ClickHouse 二进制程序添加了简单的完整性检查。它可以检测由故障硬件导致的损坏（如存储介质上的位衰减或内存中的位翻转）。 [#18811](https://github.com/ClickHouse/ClickHouse/pull/18811) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 将 `OpenSSL` 替换为 `BoringSSL`，从而避免与 sanitizer 相关的问题。修复了 [#12490](https://github.com/ClickHouse/ClickHouse/issues/12490)。修复了 [#17502](https://github.com/ClickHouse/ClickHouse/issues/17502)。修复了 [#12952](https://github.com/ClickHouse/ClickHouse/issues/12952)。[#18129](https://github.com/ClickHouse/ClickHouse/pull/18129)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 简化 `Sys/V` init 脚本。该脚本在 Ubuntu 12.04 或更早版本上无法正常工作。[#17428](https://github.com/ClickHouse/ClickHouse/pull/17428) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 对 `./clickhouse install` 脚本进行了多项改进。[#17421](https://github.com/ClickHouse/ClickHouse/pull/17421) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 现在 ClickHouse 可以充当一个模拟的 ZooKeeper。目前，存储实现只是基于内存的哈希表，服务器仅部分支持 ZooKeeper 协议。 [#16877](https://github.com/ClickHouse/ClickHouse/pull/16877) ([alesapin](https://github.com/alesapin)).
* 修复 TestKeeperStorage（ZooKeeper 的 mock）中失效列表监视的移除问题。[#18065](https://github.com/ClickHouse/ClickHouse/pull/18065) ([alesapin](https://github.com/alesapin))。
* 添加用于故障注入的 `SYSTEM SUSPEND` 命令，可用于便于故障转移测试。关闭了 [#15979](https://github.com/ClickHouse/ClickHouse/issues/15979)。[#18850](https://github.com/ClickHouse/ClickHouse/pull/18850)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 当 ClickHouse 使用 `lld` 进行链接时生成构建 ID。发现 `lld` 在我的机器上默认不会生成它。构建 ID 用于崩溃报告和程序内省。[#18808](https://github.com/ClickHouse/ClickHouse/pull/18808) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复代码风格检查中的 shellcheck 错误。[#18566](https://github.com/ClickHouse/ClickHouse/pull/18566) ([Ilya Yatsishin](https://github.com/qoega)).
* 将时区信息更新为 2020e 版本。 [#18531](https://github.com/ClickHouse/ClickHouse/pull/18531) ([alesapin](https://github.com/alesapin)).
* 修复 codespell 警告。将样式检查拆分为多个部分。更新样式检查的 Docker 镜像。[#18463](https://github.com/ClickHouse/ClickHouse/pull/18463)（[Ilya Yatsishin](https://github.com/qoega)）。
* 自动检查文档中残留的冲突标记。[#18332](https://github.com/ClickHouse/ClickHouse/pull/18332)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为无状态测试的不稳定性检查启用 Thread Fuzzer。[#18299](https://github.com/ClickHouse/ClickHouse/pull/18299) ([alesapin](https://github.com/alesapin)).
* 不要使用非线程安全的函数 `strerror`。 [#18204](https://github.com/ClickHouse/ClickHouse/pull/18204) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 更新 `anchore/scan-action@main` 工作流操作（已从 `master` 分支迁移到 `main` 分支）。[#18192](https://github.com/ClickHouse/ClickHouse/pull/18192) ([Stig Bakken](https://github.com/stigsb)).
* 现在 `clickhouse-test` 在执行 DROP/CREATE 数据库时带有超时机制。[#18098](https://github.com/ClickHouse/ClickHouse/pull/18098) ([alesapin](https://github.com/alesapin)).
* 为无状态测试启用对 pytest 框架的实验性支持。[#17902](https://github.com/ClickHouse/ClickHouse/pull/17902) ([Ivan](https://github.com/abyss7))。
* 我们现在在集成测试中使用最新版本的 Docker 守护进程。[#17671](https://github.com/ClickHouse/ClickHouse/pull/17671) ([alesapin](https://github.com/alesapin))。
* 如果启用了 Sentry，则会将官方构建信息、内存、CPU 和可用磁盘空间发送到 Sentry。Sentry 是一项需用户主动启用的功能，用于帮助 ClickHouse 开发者。此更改关闭了 [#17279](https://github.com/ClickHouse/ClickHouse/issues/17279)。[#17543](https://github.com/ClickHouse/ClickHouse/pull/17543)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 clickhouse-copier 的代码中有一个未初始化的变量。[#17363](https://github.com/ClickHouse/ClickHouse/pull/17363)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 修复了与 [#17309](https://github.com/ClickHouse/ClickHouse/issues/17309) 相关的 [一条 MSan 报告](https://clickhouse-test-reports.s3.yandex.net/17309/065cd002578f2e8228f12a2744bd40c970065e0c/stress_test_\(memory\)/stderr.log)。[#17344](https://github.com/ClickHouse/ClickHouse/pull/17344)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 修复 Arrow Flight 库中有关 IPv6 的问题。详情请参阅[评论](https://github.com/ClickHouse/ClickHouse/pull/16243#issuecomment-720830294)。[#16664](https://github.com/ClickHouse/ClickHouse/pull/16664)（[Zhanna](https://github.com/FawnD2)）。
* 添加一个库，将某些 `libc` 函数替换为会触发 trap 并终止进程的实现。[#16366](https://github.com/ClickHouse/ClickHouse/pull/16366) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 在发生栈溢出时，在服务器日志中提供诊断信息，并向 clickhouse-client 发送错误消息。此更改解决了 [#14840](https://github.com/ClickHouse/ClickHouse/issues/14840) 中的问题。[#16346](https://github.com/ClickHouse/ClickHouse/pull/16346)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 现在我们可以并行运行几乎所有无状态功能测试。[#15236](https://github.com/ClickHouse/ClickHouse/pull/15236) ([alesapin](https://github.com/alesapin))。
* 修复 `librdkafka` 中 snappy 解压缩导致的数据损坏问题（仅影响使用 gcc10 编译的版本，但官方构建已改用 clang，因此至少近期的官方发行版不受影响）。[#18053](https://github.com/ClickHouse/ClickHouse/pull/18053)（[Azat Khuzhin](https://github.com/azat)）。
* 如果服务器被 OOM killer 终止，则在日志中输出一条消息。[#13516](https://github.com/ClickHouse/ClickHouse/pull/13516) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* PODArray：在调用 memcpy 时避免使用参数为 (nullptr, 0)（修复 UBSan 报告的问题）。修复了 [#18525](https://github.com/ClickHouse/ClickHouse/issues/18525)。[#18526](https://github.com/ClickHouse/ClickHouse/pull/18526)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 对 DDLWorker 中的 ZooKeeper 路径拼接进行了小幅改进。 [#17767](https://github.com/ClickHouse/ClickHouse/pull/17767) ([Bharat Nallan](https://github.com/bharatnc)).
* 允许从调试文件重新加载符号。此 PR 还修复了一个 build-id 问题。[#17637](https://github.com/ClickHouse/ClickHouse/pull/17637) ([Amos Bird](https://github.com/amosbird))。





## [2020 年变更日志](./2020.md) {#changelog-for-2020}
