---
slug: /whats-new/changelog/2020
sidebar_position: 7
sidebar_label: "2020"
title: "2020 更新日志"
description: "2020 年更新日志"
doc_type: "changelog"
keywords:
  [
    "ClickHouse 2020",
    "changelog 2020",
    "发布说明",
    "版本历史",
    "错误修复"
  ]
---

### ClickHouse 20.12 版本 {#clickhouse-release-2012}

### ClickHouse v20.12.5.14-stable 版本,2020-12-28 {#clickhouse-release-v2012514-stable-2020-12-28}

#### 错误修复 {#bug-fix}

- 在合并期间禁用 AIO 写入,因为它可能导致合并过程中主键列出现极其罕见的数据损坏。[#18481](https://github.com/ClickHouse/ClickHouse/pull/18481) ([alesapin](https://github.com/alesapin))。
- 修复了在使用 `Nullable(String)` 类型参数执行 `toType(...)` 函数(`toDate`、`toUInt32` 等)时出现的 `value is too short` 错误。现在此类函数在解析错误时返回 `NULL` 而不是抛出异常。修复 [#7673](https://github.com/ClickHouse/ClickHouse/issues/7673)。[#18445](https://github.com/ClickHouse/ClickHouse/pull/18445) ([tavplubix](https://github.com/tavplubix))。
- 限制从宽格式到紧凑格式部分的合并。在垂直合并的情况下,这会导致结果部分损坏。[#18381](https://github.com/ClickHouse/ClickHouse/pull/18381) ([Anton Popov](https://github.com/CurtizJ))。
- 修复填充表 `system.settings_profile_elements` 的问题。此 PR 修复 [#18231](https://github.com/ClickHouse/ClickHouse/issues/18231)。[#18379](https://github.com/ClickHouse/ClickHouse/pull/18379) ([Vitaly Baranov](https://github.com/vitlibar))。
- 修复在使用两级聚合时,带有 `Distinct` 组合器的聚合函数可能发生的崩溃。修复 [#17682](https://github.com/ClickHouse/ClickHouse/issues/17682)。[#18365](https://github.com/ClickHouse/ClickHouse/pull/18365) ([Anton Popov](https://github.com/CurtizJ))。
- 修复查询 `MODIFY COLUMN ... REMOVE TTL` 实际上未删除列 TTL 的错误。[#18130](https://github.com/ClickHouse/ClickHouse/pull/18130) ([alesapin](https://github.com/alesapin))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement}

- 将时区信息更新至 2020e。[#18531](https://github.com/ClickHouse/ClickHouse/pull/18531) ([alesapin](https://github.com/alesapin))。

### ClickHouse v20.12.4.5-stable 版本,2020-12-24 {#clickhouse-release-v201245-stable-2020-12-24}

#### 错误修复 {#bug-fix-1}


- 修复了在双栈 IPv4/IPv6 机器上服务器无法访问 `clickhouse-odbc-bridge` 进程的问题；- 修复了使用格式错误的查询执行 ODBC 字典更新和/或导致崩溃的问题；可能关闭 [#14489](https://github.com/ClickHouse/ClickHouse/issues/14489)。[#18278](https://github.com/ClickHouse/ClickHouse/pull/18278) ([Denis Glazachev](https://github.com/traceon))。
- 修复了 Enum 和 Int 类型之间的键比较问题。此修复解决了 [#17989](https://github.com/ClickHouse/ClickHouse/issues/17989)。[#18214](https://github.com/ClickHouse/ClickHouse/pull/18214) ([Amos Bird](https://github.com/amosbird))。
- 修复了 `MaterializeMySQL` 数据库引擎中唯一键转换崩溃的问题。此修复解决了 [#18186](https://github.com/ClickHouse/ClickHouse/issues/18186) 和 [#16372](https://github.com/ClickHouse/ClickHouse/issues/16372) [#18211](https://github.com/ClickHouse/ClickHouse/pull/18211) ([Winter Zhang](https://github.com/zhang2014))。
- 修复了 S3 URL 解析中的 `std::out_of_range: basic_string` 错误。[#18059](https://github.com/ClickHouse/ClickHouse/pull/18059) ([Vladimir Chebotarev](https://github.com/excitoon))。
- 修复了由于 MaterializeMySQL 不支持转换 MySQL 前缀索引而导致某些表无法从 MySQL 同步到 ClickHouse 的问题。此修复解决了 [#15187](https://github.com/ClickHouse/ClickHouse/issues/15187) 和 [#17912](https://github.com/ClickHouse/ClickHouse/issues/17912) [#17944](https://github.com/ClickHouse/ClickHouse/pull/17944) ([Winter Zhang](https://github.com/zhang2014))。
- 修复了当查询包含 `ARRAY JOIN` 时查询优化产生错误结果的问题。[#17887](https://github.com/ClickHouse/ClickHouse/pull/17887) ([sundyli](https://github.com/sundy-li))。
- 修复了 `topK` 聚合函数中可能出现的段错误。此修复关闭了 [#17404](https://github.com/ClickHouse/ClickHouse/issues/17404)。[#17845](https://github.com/ClickHouse/ClickHouse/pull/17845) ([Maksim Kita](https://github.com/kitaisreal))。
- 修复了服务器在守护进程模式下运行时 `system.stack_trace` 表为空的问题。[#17630](https://github.com/ClickHouse/ClickHouse/pull/17630) ([Amos Bird](https://github.com/amosbird))。

### ClickHouse 版本 v20.12.3.3-stable，2020-12-13 {#clickhouse-release-v201233-stable-2020-12-13}

#### 向后不兼容的变更 {#backward-incompatible-change}

- 默认启用 `use_compact_format_in_distributed_parts_names`（参见文档以获取参考）。[#16728](https://github.com/ClickHouse/ClickHouse/pull/16728) ([Azat Khuzhin](https://github.com/azat))。
- 在创建使用 `File` 引擎的表时,接受 `SETTINGS` 子句中与文件格式相关的用户设置(例如 `format_csv_delimiter`),并在所有 `INSERT` 和 `SELECT` 中使用这些设置。在当前用户会话中或在 DML 查询本身的 `SETTINGS` 子句中更改的文件格式设置不再影响查询。[#16591](https://github.com/ClickHouse/ClickHouse/pull/16591) ([Alexander Kuzmenkov](https://github.com/akuzm))。

#### 新功能 {#new-feature}


- 新增 `*.xz` 压缩/解压缩支持。现在可以在 `file()` 函数中使用 `*.xz` 格式。此更改关闭了 [#8828](https://github.com/ClickHouse/ClickHouse/issues/8828)。[#16578](https://github.com/ClickHouse/ClickHouse/pull/16578) ([Abi Palagashvili](https://github.com/fibersel))。
- 引入查询语句 `ALTER TABLE ... DROP|DETACH PART 'part_name'`。[#15511](https://github.com/ClickHouse/ClickHouse/pull/15511) ([nvartolomei](https://github.com/nvartolomei))。
- 新增 ALTER UPDATE/DELETE IN PARTITION 语法。[#13403](https://github.com/ClickHouse/ClickHouse/pull/13403) ([Vladimir Chebotarev](https://github.com/excitoon))。
- 允许在使用 JSON 输入/输出格式时将命名元组格式化为 JSON 对象,由 `output_format_json_named_tuples_as_objects` 设置控制,默认禁用。[#17175](https://github.com/ClickHouse/ClickHouse/pull/17175) ([Alexander Kuzmenkov](https://github.com/akuzm))。
- 新增在 TSV 和 CSV 格式中默认将枚举值作为其 ID 输入的功能。[#16834](https://github.com/ClickHouse/ClickHouse/pull/16834) ([Kruglov Pavel](https://github.com/Avogar))。
- 为 Nullable、LowCardinality、Array 和 Tuple(其中嵌套类型为 String)新增 COLLATE 支持。同时重构了 ColumnString.cpp 中与排序规则相关的代码。[#16273](https://github.com/ClickHouse/ClickHouse/pull/16273) ([Kruglov Pavel](https://github.com/Avogar))。
- 新增 `tcpPort` 函数,返回此服务器监听的 TCP 端口。[#17134](https://github.com/ClickHouse/ClickHouse/pull/17134) ([Ivan](https://github.com/abyss7))。
- 新增数学函数:`acosh`、`asinh`、`atan2`、`atanh`、`cosh`、`hypot`、`log1p`、`sinh`。[#16636](https://github.com/ClickHouse/ClickHouse/pull/16636) ([Konstantin Malanchev](https://github.com/hombit))。
- 支持在不同副本之间分配合并操作。引入了 `execute_merges_on_single_replica_time_threshold` MergeTree 设置。[#16424](https://github.com/ClickHouse/ClickHouse/pull/16424) ([filimonov](https://github.com/filimonov))。
- 新增 `aggregate_functions_null_for_empty` 设置以实现 SQL 标准兼容性。此选项将重写查询中的所有聚合函数,为它们添加 -OrNull 后缀。实现了 [10273](https://github.com/ClickHouse/ClickHouse/issues/10273)。[#16123](https://github.com/ClickHouse/ClickHouse/pull/16123) ([flynn](https://github.com/ucasFL))。
- 更新了 DateTime、DateTime64 解析以接受字符串日期字面量格式。[#16040](https://github.com/ClickHouse/ClickHouse/pull/16040) ([Maksim Kita](https://github.com/kitaisreal))。
- 支持通过 `--history_file` 参数更改 `clickhouse-client` 中历史文件的路径。[#15960](https://github.com/ClickHouse/ClickHouse/pull/15960) ([Maksim Kita](https://github.com/kitaisreal))。

#### 错误修复 {#bug-fix-2}


* 修复一种在极少数情况下服务器可能停止接受连接的问题。 [#17542](https://github.com/ClickHouse/ClickHouse/pull/17542) ([Amos Bird](https://github.com/amosbird)).
* 修复了在 Windows Subsystem for Linux 上运行的 ClickHouse 中，在 `Atomic` 数据库执行 `RENAME` 查询时出现的 `Function not implemented` 错误。修复了 [#17661](https://github.com/ClickHouse/ClickHouse/issues/17661)。[#17664](https://github.com/ClickHouse/ClickHouse/pull/17664)（[tavplubix](https://github.com/tavplubix)）。
* 如果禁用了 `in_memory_parts_enable_wal`，则不要从 WAL 中恢复分片。 [#17802](https://github.com/ClickHouse/ClickHouse/pull/17802) ([detailyang](https://github.com/detailyang)).
* 修复 `MergeTreeWriterSettings` 中将 `max_compress_block_size` 误初始化为 `min_compress_block_size` 的问题。 [#17833](https://github.com/ClickHouse/ClickHouse/pull/17833) ([flynn](https://github.com/ucasFL)).
* 关于要删除的最大表大小的异常消息显示不正确的问题已修复。[#17764](https://github.com/ClickHouse/ClickHouse/pull/17764) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复了在向 `Distributed` 表插入数据时，因空间不足可能出现的段错误。 [#17737](https://github.com/ClickHouse/ClickHouse/pull/17737) ([tavplubix](https://github.com/tavplubix)).
* 修复了 ClickHouse 无法恢复与 MySQL 服务器连接的问题。[#17681](https://github.com/ClickHouse/ClickHouse/pull/17681) ([Alexander Kazakov](https://github.com/Akazz))。
* 在执行 `ON CLUSTER` 查询时，当 `pool_size` &gt; 1 时，由于竞争条件，可能会错误地判断集群是否为环形（交叉）复制。该问题已修复。[#17640](https://github.com/ClickHouse/ClickHouse/pull/17640) ([tavplubix](https://github.com/tavplubix))。
* 异常 `fmt::v7::format_error` 现在可以在 MergeTree 表的后台记录到日志中。此更改修复了 [#17613](https://github.com/ClickHouse/ClickHouse/issues/17613)。[#17615](https://github.com/ClickHouse/ClickHouse/pull/17615)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在交互模式下使用 `clickhouse-client` 执行多行查询时，单行注释会被错误地延伸到整个查询的末尾。此更改修复了 [#13654](https://github.com/ClickHouse/ClickHouse/issues/13654)。[#17565](https://github.com/ClickHouse/ClickHouse/pull/17565)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在对应的 mutation 在其他副本上被 kill 时，`ALTER` 查询会挂起的问题。修复了 [#16953](https://github.com/ClickHouse/ClickHouse/issues/16953)。[#17499](https://github.com/ClickHouse/ClickHouse/pull/17499)（[alesapin](https://github.com/alesapin)）。
* 修复了 ClickHouse 低估标记缓存大小的问题。当存在大量包含标记的小文件时，可能会出现该问题。[#17496](https://github.com/ClickHouse/ClickHouse/pull/17496) ([alesapin](https://github.com/alesapin))。
* 修复在启用 `optimize_redundant_functions_in_order_by` 设置时的 `ORDER BY` 行为。[#17471](https://github.com/ClickHouse/ClickHouse/pull/17471) ([Anton Popov](https://github.com/CurtizJ)).
* 修复由于错误优化导致在 `DISTINCT` 之后可能出现的重复值。修复了 [#17294](https://github.com/ClickHouse/ClickHouse/issues/17294)。[#17296](https://github.com/ClickHouse/ClickHouse/pull/17296)（[li chengxiang](https://github.com/chengxianglibra)）。[#17439](https://github.com/ClickHouse/ClickHouse/pull/17439)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复从包含 `LowCardinality` 类型的 `JOIN` 表读取时发生的崩溃。修复了 [#17228](https://github.com/ClickHouse/ClickHouse/issues/17228)。[#17397](https://github.com/ClickHouse/ClickHouse/pull/17397)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复 `toInt256(inf)` 栈溢出问题。`Int256` 是一项试验性功能。已关闭 [#17235](https://github.com/ClickHouse/ClickHouse/issues/17235)。[#17257](https://github.com/ClickHouse/ClickHouse/pull/17257)（[flynn](https://github.com/ucasFL)）。
* 修复在带有 `LIMIT` 的 Distributed 查询中可能记录的 `Unexpected packet Data received from client` 错误日志。 [#17254](https://github.com/ClickHouse/ClickHouse/pull/17254) ([Azat Khuzhin](https://github.com/azat)).
* 修复在子查询中存在 `const` 列时导致的 `set` 索引失效问题。该修复解决了 [#17246](https://github.com/ClickHouse/ClickHouse/issues/17246)。[#17249](https://github.com/ClickHouse/ClickHouse/pull/17249)（[Amos Bird](https://github.com/amosbird)）。
* 修复在索引比较两侧类型不同时可能出现的错误索引分析问题。此更改修复了 [#17122](https://github.com/ClickHouse/ClickHouse/issues/17122)。[#17145](https://github.com/ClickHouse/ClickHouse/pull/17145)（[Amos Bird](https://github.com/amosbird)）。
* 修复了会导致崩溃的 `ColumnConst` 比较问题。此修复解决了 [#17088](https://github.com/ClickHouse/ClickHouse/issues/17088)。[#17135](https://github.com/ClickHouse/ClickHouse/pull/17135)（[Amos Bird](https://github.com/amosbird)）。
* 对 MaterializeMySQL（实验特性）进行了多项修复。修复了 [#16923](https://github.com/ClickHouse/ClickHouse/issues/16923) 和 [#15883](https://github.com/ClickHouse/ClickHouse/issues/15883)，并修复了在修改 MySQL `binlog_checksum` 时导致的 MaterializeMySQL SYNC 失败问题。 [#17091](https://github.com/ClickHouse/ClickHouse/pull/17091) ([Winter Zhang](https://github.com/zhang2014))。
* 修复了一个错误：在非 leader 的 `ReplicatedMergeTree` 表上执行 `ON CLUSTER` 查询时，可能会导致查询一直挂起。 [#17089](https://github.com/ClickHouse/ClickHouse/pull/17089) ([alesapin](https://github.com/alesapin)).
* 修复了在执行 `CREATE TABLE ... AS some_table` 查询时，如果 `some_table` 是通过 `AS table_function()` 创建的会导致的崩溃问题。修复了 [#16944](https://github.com/ClickHouse/ClickHouse/issues/16944)。[#17072](https://github.com/ClickHouse/ClickHouse/pull/17072)（[tavplubix](https://github.com/tavplubix)）。
* 修复函数 fuzzBits 未完成实现的缺陷，相关 issue：[#16980](https://github.com/ClickHouse/ClickHouse/issues/16980)。[#17051](https://github.com/ClickHouse/ClickHouse/pull/17051)（[hexiaoting](https://github.com/hexiaoting)）。
* 修复在 CFA 寄存器为 RAX 时 LLVM 的 libunwind 行为问题。这是 [LLVM 的 libunwind](https://github.com/llvm/llvm-project/tree/master/libunwind) 中的一个 [bug](https://bugs.llvm.org/show_bug.cgi?id=48186)。我们已经为该 bug 提供了变通方案。[#17046](https://github.com/ClickHouse/ClickHouse/pull/17046)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 避免在执行过程中可能被取消的远程查询（例如带有 `LIMIT` 的查询）产生不必要的网络错误。[#17006](https://github.com/ClickHouse/ClickHouse/pull/17006) ([Azat Khuzhin](https://github.com/azat))。
* 修复仅包含 OFFSET 的查询中 `optimize_distributed_group_by_sharding_key` 设置的问题（该设置默认禁用）。[#16996](https://github.com/ClickHouse/ClickHouse/pull/16996) ([Azat Khuzhin](https://github.com/azat)).
* 修复在 `Distributed` 表之上使用 `JOIN` 的 `Merge` 表相关问题。 [#16993](https://github.com/ClickHouse/ClickHouse/pull/16993) ([Azat Khuzhin](https://github.com/azat)).
* 修复了从 double 类型转换为大整数（128、256 位）时产生错误结果的问题。大整数支持仍为实验性特性。[#16986](https://github.com/ClickHouse/ClickHouse/pull/16986) ([Mike](https://github.com/myrrc))。
* 修复在执行 `ALTER TABLE ... MODIFY COLUMN ... NewType` 时，如果有 `SELECT` 查询在被修改的列上使用 `WHERE` 表达式且该 `ALTER` 尚未完成，可能导致服务器崩溃的问题。[#16968](https://github.com/ClickHouse/ClickHouse/pull/16968) ([Amos Bird](https://github.com/amosbird))。
* `clickhouse-git-import` 中的 blame 信息计算有误。[#16959](https://github.com/ClickHouse/ClickHouse/pull/16959) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复包含单调函数的 `ORDER BY` 优化问题。修复了 [#16107](https://github.com/ClickHouse/ClickHouse/issues/16107)。[#16956](https://github.com/ClickHouse/ClickHouse/pull/16956)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复在启用设置 `optimize_aggregators_of_group_by_keys` 时，`GROUP BY` 与 `JOIN` 的优化问题。修复了 [#12604](https://github.com/ClickHouse/ClickHouse/issues/12604)。[#16951](https://github.com/ClickHouse/ClickHouse/pull/16951)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复在包含 `ORDER BY` 的查询中可能出现的 `Illegal type of argument` 错误。修复了 [#16580](https://github.com/ClickHouse/ClickHouse/issues/16580)。[#16928](https://github.com/ClickHouse/ClickHouse/pull/16928)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复 `InterpreterShowAccessQuery` 中异常的代码。 [#16866](https://github.com/ClickHouse/ClickHouse/pull/16866) ([tavplubix](https://github.com/tavplubix)).
* 在使用函数 `timeSeriesGroupSum` 时防止 ClickHouse server 崩溃。该函数已在较新的 ClickHouse 版本中被移除。[#16865](https://github.com/ClickHouse/ClickHouse/pull/16865) ([filimonov](https://github.com/filimonov))。
* 修复在启用查询分析器且 ClickHouse 安装在使用某些函数的异步展开表（据称）存在缺陷的 glibc 版本的操作系统上时出现的极少见静默崩溃问题。修复了 [#15301](https://github.com/ClickHouse/ClickHouse/issues/15301)。修复了 [#13098](https://github.com/ClickHouse/ClickHouse/issues/13098)。[#16846](https://github.com/ClickHouse/ClickHouse/pull/16846)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在未传入任何参数时使用 `any` 导致的崩溃。对应 [#16803](https://github.com/ClickHouse/ClickHouse/issues/16803)。cc @azat。[#16826](https://github.com/ClickHouse/ClickHouse/pull/16826)（[Amos Bird](https://github.com/amosbird)）。
* 如果在将表元数据写入磁盘时无法分配内存，可能会写入损坏的元数据文件。 [#16772](https://github.com/ClickHouse/ClickHouse/pull/16772) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复使用分区谓词时的简单查询优化问题。[#16767](https://github.com/ClickHouse/ClickHouse/pull/16767) ([Azat Khuzhin](https://github.com/azat))。
* 修复在启用 `transform_null_in` 设置时，`IN` 运算符在多列和元组上的行为问题。修复了 [#15310](https://github.com/ClickHouse/ClickHouse/issues/15310)。[#16722](https://github.com/ClickHouse/ClickHouse/pull/16722)（[Anton Popov](https://github.com/CurtizJ)）。
* 通过 MySQL 协议在 `INSERT` 查询中返回受影响的行数。之前 ClickHouse 始终返回 0，现已修复。修复了 [#16605](https://github.com/ClickHouse/ClickHouse/issues/16605)。[#16715](https://github.com/ClickHouse/ClickHouse/pull/16715)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复在使用带有 `if` 后缀的聚合函数时远程查询失败的问题。修复了 [#16574](https://github.com/ClickHouse/ClickHouse/issues/16574)、[#16231](https://github.com/ClickHouse/ClickHouse/issues/16231) 和 [#16610](https://github.com/ClickHouse/ClickHouse/pull/16610)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复由于 `select_sequential_consistency` 导致的在已优化的简单计数查询和 system.tables 上行为不一致的问题。 [#16309](https://github.com/ClickHouse/ClickHouse/pull/16309) ([Hao Chen](https://github.com/haoch)).

#### 改进 {#improvement}


* 在通过 TTL、变更或 collapsing merge 算法裁剪之后，移除空的数据部分。 [#16895](https://github.com/ClickHouse/ClickHouse/pull/16895) ([Anton Popov](https://github.com/CurtizJ)).
* 为 Distributed 表中的异步发送启用目录名的紧凑格式：`use_compact_format_in_distributed_parts_names` 默认设置为 1。[#16788](https://github.com/ClickHouse/ClickHouse/pull/16788) ([Azat Khuzhin](https://github.com/azat))。
* 如果没有向 S3 写入任何数据，则中止分段上传。 [#16840](https://github.com/ClickHouse/ClickHouse/pull/16840) ([Pavel Kovalenko](https://github.com/Jokser)).
* 在发生错误时重新解析 `format_avro_schema_registry_url` 的 IP 地址。 [#16985](https://github.com/ClickHouse/ClickHouse/pull/16985) ([filimonov](https://github.com/filimonov)).
* 在 `system.distribution_queue` 的 `data_path` 中对密码进行隐藏处理。 [#16727](https://github.com/ClickHouse/ClickHouse/pull/16727) ([Azat Khuzhin](https://github.com/azat)).
* 在列转换器尝试替换不存在的列时抛出错误。 [#16183](https://github.com/ClickHouse/ClickHouse/pull/16183) ([hexiaoting](https://github.com/hexiaoting)).
* 当没有足够的内存支持所有线程同时工作时，请关闭并行解析。当有人尝试插入极其巨大的行（&gt; min&#95;chunk&#95;bytes&#95;for&#95;parallel&#95;parsing）时，也可能会出现类似 “Memory limit exceeded” 的异常，因为每个要解析的片段都必须是彼此独立的一组字符串（一个或多个）。 [#16721](https://github.com/ClickHouse/ClickHouse/pull/16721) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 安装脚本现在会始终在配置目录中创建子目录。此更改仅与使用自定义配置的 Docker 构建相关。 [#16936](https://github.com/ClickHouse/ClickHouse/pull/16936) ([filimonov](https://github.com/filimonov)).
* 修正 `JSONEachRow`、`JSONCompactEachRow` 和 `RegexpRow` 输入格式中的错误信息语法。[#17205](https://github.com/ClickHouse/ClickHouse/pull/17205) ([nico piderman](https://github.com/sneako))。
* 将 `SOURCE(CLICKHOUSE(...))` 的默认 `host` 和 `port` 参数设为当前实例，并将默认 `user` 值设为 `'default'`。 [#16997](https://github.com/ClickHouse/ClickHouse/pull/16997) ([vdimir](https://github.com/vdimir)).
* 在执行 `ATTACH/DETACH TABLE <DICTIONARY>` 时抛出一条信息更明确的错误消息。在此 PR 之前，`detach table <dict>` 虽然可以执行，但会导致内存中的元数据格式不正确。[#16885](https://github.com/ClickHouse/ClickHouse/pull/16885) ([Amos Bird](https://github.com/amosbird))。
* 添加了 `cutToFirstSignificantSubdomainWithWWW()`。 [#16845](https://github.com/ClickHouse/ClickHouse/pull/16845) ([Azat Khuzhin](https://github.com/azat)).
* 如果提供了错误的配置（缺少 `metric_log`.`collect_interval_milliseconds`），服务器将拒绝启动并抛出异常。[#16815](https://github.com/ClickHouse/ClickHouse/pull/16815) ([Ivan](https://github.com/abyss7))。
* 当分布式 DDL 配置缺失时，提供更清晰的异常消息。修复了 [#5075](https://github.com/ClickHouse/ClickHouse/issues/5075)。[#16769](https://github.com/ClickHouse/ClickHouse/pull/16769)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 易用性改进：当在 `CREATE TABLE` 查询中错误放置 `CODEC` 表达式时，在语法错误消息中提供更好的建议。修复了 [#12493](https://github.com/ClickHouse/ClickHouse/issues/12493)。[#16768](https://github.com/ClickHouse/ClickHouse/pull/16768)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 Distributed 引擎启动时删除用于异步 `INSERT` 的空目录。 [#16729](https://github.com/ClickHouse/ClickHouse/pull/16729) ([Azat Khuzhin](https://github.com/azat)).
* 针对在使用 nginx 服务器作为代理时访问 S3 的变通方案。Nginx 目前不接受路径为空的 URL，例如 `http://domain.com?delete`，但原始的 aws-sdk-cpp 会生成这种 URL。此提交使用了打过补丁的 aws-sdk-cpp 版本，在这种情况下会将路径设置为 &quot;/&quot;，例如 `http://domain.com/?delete`。 [#16709](https://github.com/ClickHouse/ClickHouse/pull/16709) ([ianton-ru](https://github.com/ianton-ru))。
* 允许 `reinterpretAs*` 函数在相同大小的整数和浮点数之间使用。实现了 [16640](https://github.com/ClickHouse/ClickHouse/issues/16640)。[#16657](https://github.com/ClickHouse/ClickHouse/pull/16657)（[flynn](https://github.com/ucasFL)）。
* 现在，可以在 `config.xml` 中更改 `<auxiliary_zookeepers>` 配置，并在无需重启服务器的情况下重新加载。[#16627](https://github.com/ClickHouse/ClickHouse/pull/16627) ([Amos Bird](https://github.com/amosbird))。
* 在到远程资源的 HTTPS 连接中支持 SNI。这将允许连接到需要 SNI 的 Cloudflare 服务器。修复了 [#10055](https://github.com/ClickHouse/ClickHouse/issues/10055)。[#16252](https://github.com/ClickHouse/ClickHouse/pull/16252)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 支持连接到需要 SNI 的 `clickhouse-server` 安全端点。当 `clickhouse-server` 部署在 TLS 代理之后时即可实现。[#16938](https://github.com/ClickHouse/ClickHouse/pull/16938) ([filimonov](https://github.com/filimonov))。
* 修复在创建物化视图循环时可能发生的栈溢出问题，关闭了 [#15732](https://github.com/ClickHouse/ClickHouse/issues/15732)。[#16048](https://github.com/ClickHouse/ClickHouse/pull/16048)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 简化 MergeTree 表引擎系列的后台任务处理实现。对用户而言不应有任何可见变化。 [#15983](https://github.com/ClickHouse/ClickHouse/pull/15983) ([alesapin](https://github.com/alesapin)).
* 改进 MaterializeMySQL（实验性特性）。当 MySQL 同步用户权限配置错误时，抛出提示需要正确同步权限的异常。 [#15977](https://github.com/ClickHouse/ClickHouse/pull/15977) ([TCeason](https://github.com/TCeason)).
* 使 `indexOf()` 使用 BloomFilter。 [#14977](https://github.com/ClickHouse/ClickHouse/pull/14977) ([achimbab](https://github.com/achimbab)).

#### 性能改进 {#performance-improvement}

- 使用 Floyd-Rivest 算法,这是 ClickHouse 部分排序场景的最佳选择。基准测试结果见 https://github.com/danlark1/miniselect 和[此处](https://drive.google.com/drive/folders/1DHEaeXgZuX6AJ9eByeZ8iQVQv0ueP8XM)。[#16825](https://github.com/ClickHouse/ClickHouse/pull/16825) ([Danila Kutenin](https://github.com/danlark1))。
- 现在 `ReplicatedMergeTree` 引擎系列使用独立的线程池进行副本数据拉取。线程池大小由 `background_fetches_pool_size` 设置限制,可通过重启服务器进行调整。该设置的默认值为 3,表示最大并行拉取数量为 3(可充分利用 10G 网络)。修复 #520。[#16390](https://github.com/ClickHouse/ClickHouse/pull/16390) ([alesapin](https://github.com/alesapin))。
- 修复了 `quantileTDigest` 状态无限增长的问题。[#16680](https://github.com/ClickHouse/ClickHouse/pull/16680) ([hrissan](https://github.com/hrissan))。
- 在 `EXPLAIN` 中添加 `VIEW` 子查询描述。为 `VIEW` 添加 LIMIT 下推优化。将 `Distributed` 表的本地副本添加到查询计划中。[#14936](https://github.com/ClickHouse/ClickHouse/pull/14936) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 修复了当 max_threads > 0 且 ORDER BY 中包含表达式时,optimize_read_in_order/optimize_aggregation_in_order 的问题。[#16637](https://github.com/ClickHouse/ClickHouse/pull/16637) ([Azat Khuzhin](https://github.com/azat))。
- 修复了从 `Merge` 表读取大量 `MergeTree` 表时的性能问题。修复 [#7748](https://github.com/ClickHouse/ClickHouse/issues/7748)。[#16988](https://github.com/ClickHouse/ClickHouse/pull/16988) ([Anton Popov](https://github.com/CurtizJ))。
- 现在可以安全地修剪精确匹配的分区。实用场景:假设表按 `intHash64(x) % 100` 分区,查询条件直接使用 `intHash64(x) % 100` 表达式,而非使用 x。[#16253](https://github.com/ClickHouse/ClickHouse/pull/16253) ([Amos Bird](https://github.com/amosbird))。

#### 实验性功能 {#experimental-feature}

- 添加 `EmbeddedRocksDB` 表引擎(可用于字典)。[#15073](https://github.com/ClickHouse/ClickHouse/pull/15073) ([sundyli](https://github.com/sundy-li))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-1}


* 改进镜像构建的测试覆盖率。 [#17233](https://github.com/ClickHouse/ClickHouse/pull/17233) ([alesapin](https://github.com/alesapin)).
* 将内置时区数据更新到 2020d 版（同时将 cctz 更新到最新的 master 分支）。 [#17204](https://github.com/ClickHouse/ClickHouse/pull/17204) ([filimonov](https://github.com/filimonov)).
* 修复 Poco 中的 UBSan 报告，关闭 [#12719](https://github.com/ClickHouse/ClickHouse/issues/12719)。 [#16765](https://github.com/ClickHouse/ClickHouse/pull/16765) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 不对第三方库启用 UBSan 插桩。 [#16764](https://github.com/ClickHouse/ClickHouse/pull/16764) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复缓存字典中的 UBSan 报告，关闭 [#12641](https://github.com/ClickHouse/ClickHouse/issues/12641)。 [#16763](https://github.com/ClickHouse/ClickHouse/pull/16763) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复在尝试将无穷浮点数转换为整数时的 UBSan 报告，关闭 [#14190](https://github.com/ClickHouse/ClickHouse/issues/14190)。 [#16677](https://github.com/ClickHouse/ClickHouse/pull/16677) ([alexey-milovidov](https://github.com/alexey-milovidov)).



## ClickHouse 版本 20.11 {#clickhouse-release-2011}

### ClickHouse 版本 v20.11.7.16-stable, 2021-03-02 {#clickhouse-release-v2011716-stable-2021-03-02}

#### 改进 {#improvement-1}

- 在 clickhouse-server 镜像中将 clickhouse 用户和组的 uid / gid 显式设置为固定值 (101)。[#19096](https://github.com/ClickHouse/ClickHouse/pull/19096) ([filimonov](https://github.com/filimonov))。

#### 错误修复 {#bug-fix-3}


* 修复 BloomFilter 索引崩溃。修复了 [#19757](https://github.com/ClickHouse/ClickHouse/issues/19757)。[#19884](https://github.com/ClickHouse/ClickHouse/pull/19884)（[Maksim Kita](https://github.com/kitaisreal)）。
* 在启用 system.text&#95;log 时可能会发生死锁。此更改修复了 [#19874](https://github.com/ClickHouse/ClickHouse/issues/19874)。[#19875](https://github.com/ClickHouse/ClickHouse/pull/19875)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在先前的版本中，为函数 `arrayEnumerateUniq` 提供异常参数可能会导致崩溃或无限循环。此更改修复并关闭了 [#19787](https://github.com/ClickHouse/ClickHouse/issues/19787)。[#19788](https://github.com/ClickHouse/ClickHouse/pull/19788)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在对算术类型与字符串类型进行精确比较时导致的栈溢出问题。 [#19773](https://github.com/ClickHouse/ClickHouse/pull/19773) ([tavplubix](https://github.com/tavplubix)).
* 修复 `bitmapAndnot` 函数中的段错误，解决了 [#19668](https://github.com/ClickHouse/ClickHouse/issues/19668)。[#19713](https://github.com/ClickHouse/ClickHouse/pull/19713)（[Maksim Kita](https://github.com/kitaisreal)）。
* 某些使用大整数的函数可能会导致段错误。大整数是实验性功能。此更改关闭了 [#19667](https://github.com/ClickHouse/ClickHouse/issues/19667)。 [#19672](https://github.com/ClickHouse/ClickHouse/pull/19672)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在参数为 `LowCardinality` 时，函数 `neighbor` 返回结果错误的问题。修复了 [#10333](https://github.com/ClickHouse/ClickHouse/issues/10333)。[#19617](https://github.com/ClickHouse/ClickHouse/pull/19617)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在断开连接后 `Connection` 中出现的 `CompressedWriteBuffer` use-after-free 问题。 [#19599](https://github.com/ClickHouse/ClickHouse/pull/19599) ([Azat Khuzhin](https://github.com/azat)).
* `DROP/DETACH TABLE table ON CLUSTER cluster SYNC` 查询可能会挂起，现已修复。修复了 [#19568](https://github.com/ClickHouse/ClickHouse/issues/19568)。[#19572](https://github.com/ClickHouse/ClickHouse/pull/19572) ([tavplubix](https://github.com/tavplubix))。
* 修复 `CREATE DICTIONARY` 查询中的 `id` 表达式。 [#19571](https://github.com/ClickHouse/ClickHouse/pull/19571) ([Maksim Kita](https://github.com/kitaisreal)).
* 修复在将 merge&#95;tree&#95;min&#95;rows&#95;for&#95;concurrent&#95;read/merge&#95;tree&#95;min&#95;bytes&#95;for&#95;concurrent&#95;read 设置为 0/UINT64&#95;MAX 时出现的 SIGSEGV。 [#19528](https://github.com/ClickHouse/ClickHouse/pull/19528) ([Azat Khuzhin](https://github.com/azat)).
* 如果以精心构造的参数调用 `addMonth` 函数，可能在读取内存时发生缓冲区溢出。本次修复了 [#19441](https://github.com/ClickHouse/ClickHouse/issues/19441) 和 [#19413](https://github.com/ClickHouse/ClickHouse/issues/19413)。[#19472](https://github.com/ClickHouse/ClickHouse/pull/19472)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 如果某个文件中存在空数据块，则将该分布式批处理标记为已损坏。 [#19449](https://github.com/ClickHouse/ClickHouse/pull/19449) ([Azat Khuzhin](https://github.com/azat)).
* 修复 Uber H3 库中可能出现的缓冲区溢出问题。参见 [https://github.com/uber/h3/issues/392](https://github.com/uber/h3/issues/392)。此更改关闭了 [#19219](https://github.com/ClickHouse/ClickHouse/issues/19219)。[#19383](https://github.com/ClickHouse/ClickHouse/pull/19383)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `system.parts` 的 `_state` 列（由于顺序不正确，查询该列时会出现 `LOGICAL_ERROR`）。 [#19346](https://github.com/ClickHouse/ClickHouse/pull/19346) ([Azat Khuzhin](https://github.com/azat)).
* 修复错误 `Cannot convert column now64() because it is constant but values of constants are different in source and result`。为 [#7156](https://github.com/ClickHouse/ClickHouse/issues/7156) 的后续工作。[#19316](https://github.com/ClickHouse/ClickHouse/pull/19316)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在处理 `ReplicatedMergeTree` 表时，并发执行 `ALTER` 和 `DROP` 查询可能导致挂起的错误。 [#19237](https://github.com/ClickHouse/ClickHouse/pull/19237) ([alesapin](https://github.com/alesapin)).
* 修复以 `ORC` 格式从文件进行无限读取的问题（该问题是在 [#10580](https://github.com/ClickHouse/ClickHouse/issues/10580) 中引入的）。修复 [#19095](https://github.com/ClickHouse/ClickHouse/issues/19095)。[#19134](https://github.com/ClickHouse/ClickHouse/pull/19134)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了一个启动时的错误：当 clickhouse 无法从 `LowCardinality(Nullable(...))` 读取压缩编解码器并抛出异常 `Attempt to read after EOF` 时会导致启动失败。修复了 [#18340](https://github.com/ClickHouse/ClickHouse/issues/18340)。[#19101](https://github.com/ClickHouse/ClickHouse/pull/19101)（[alesapin](https://github.com/alesapin)）。
* 修复了通过 HTTP 接口使用 `Template` 或 `CustomSeparated` 格式插入数据时出现的 `There is no checkpoint` 错误。修复了 [#19021](https://github.com/ClickHouse/ClickHouse/issues/19021)。[#19072](https://github.com/ClickHouse/ClickHouse/pull/19072)（[tavplubix](https://github.com/tavplubix)）。
* 限制对使用旧语法创建的 `MergeTree` 表执行 `MODIFY TTL` 查询。此前此类查询会执行成功，但实际上不会产生任何效果。[#19064](https://github.com/ClickHouse/ClickHouse/pull/19064) ([Anton Popov](https://github.com/CurtizJ)).
* 确保 `groupUniqArray` 对 Enum 类型的参数返回正确的返回类型。此更改修复了 [#17875](https://github.com/ClickHouse/ClickHouse/issues/17875)。[#19019](https://github.com/ClickHouse/ClickHouse/pull/19019)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在将函数 `ignore` 与 `LowCardinality` 参数一起使用时，可能出现的错误 `Expected single dictionary argument for function`。修复了 [#14275](https://github.com/ClickHouse/ClickHouse/issues/14275)。[#19016](https://github.com/ClickHouse/ClickHouse/pull/19016)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了向使用 `TinyLog` 引擎的表插入 `LowCardinality` 列时的问题。修复了 [#18629](https://github.com/ClickHouse/ClickHouse/issues/18629)。[#19010](https://github.com/ClickHouse/ClickHouse/pull/19010)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 禁用 `optimize_move_functions_out_of_any`，因为该优化并不总是正确的。由此关闭了 [#18051](https://github.com/ClickHouse/ClickHouse/issues/18051)。由此关闭了 [#18973](https://github.com/ClickHouse/ClickHouse/issues/18973)。[#18981](https://github.com/ClickHouse/ClickHouse/pull/18981)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在关闭时极少数情况下会出现的死锁问题。[#18977](https://github.com/ClickHouse/ClickHouse/pull/18977) ([tavplubix](https://github.com/tavplubix))。
* 修复了在包含某些转义文本的 `mutation`（例如 `ALTER ... UPDATE e = CAST('foo', 'Enum8(\'foo\' = 1')`）时序列化不正确的错误。修复了 [#18878](https://github.com/ClickHouse/ClickHouse/issues/18878)。[#18944](https://github.com/ClickHouse/ClickHouse/pull/18944)（[alesapin](https://github.com/alesapin)）。
* Attach partition 应当重置变更（mutation）。 [#18804](https://github.com/ClickHouse/ClickHouse/issues/18804)。 [#18935](https://github.com/ClickHouse/ClickHouse/pull/18935) ([fastio](https://github.com/fastio))。
* 修复 `clickhouse-local` 在关闭时可能出现的挂起问题。修复了 [#18891](https://github.com/ClickHouse/ClickHouse/issues/18891)。[#18893](https://github.com/ClickHouse/ClickHouse/pull/18893)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复带一元函数和 `Nullable` 类型的 `if` 组合子。 [#18806](https://github.com/ClickHouse/ClickHouse/pull/18806) ([Azat Khuzhin](https://github.com/azat)).
* 如果将 `network_compression_method` 在全局范围内设置为非默认值，异步分布式 `INSERT` 可能会被服务器拒绝。此更改修复了 [#18741](https://github.com/ClickHouse/ClickHouse/issues/18741)。[#18776](https://github.com/ClickHouse/ClickHouse/pull/18776)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在尝试将 `NULL` 从 `Nullable(String)` `CAST` 为 `Nullable(Decimal(P, S))` 时出现的 `Attempt to read after eof` 错误。现在当 `CAST` 函数无法从可为空字符串解析出小数时，会返回 `NULL`。修复了 [#7690](https://github.com/ClickHouse/ClickHouse/issues/7690)。[#18718](https://github.com/ClickHouse/ClickHouse/pull/18718)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复 `Logger` 中参数个数不匹配的问题。 [#18717](https://github.com/ClickHouse/ClickHouse/pull/18717) ([sundyli](https://github.com/sundy-li)).
* 添加对 FixedString 数据类型的支持。从 MySQL 复制数据到 ClickHouse 时，我会遇到异常 “Code: 50, e.displayText() = DB::Exception: Unsupported type FixedString(1)”。该补丁修复了 [#18450](https://github.com/ClickHouse/ClickHouse/issues/18450) 中的缺陷，同时也修复了 [#6556](https://github.com/ClickHouse/ClickHouse/issues/6556)。[#18553](https://github.com/ClickHouse/ClickHouse/pull/18553) ([awesomeleo](https://github.com/awesomeleo))。
* 修复在包含 `RIGHT` 或 `FULL` join 的子查询之后使用 `ORDER BY` 时可能出现的 `Pipeline stuck` 错误。[#18550](https://github.com/ClickHouse/ClickHouse/pull/18550) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了一个错误，该错误可能导致在终止相应的 mutation 后，`ALTER` 查询会挂起。由 thread fuzzer 发现。[#18518](https://github.com/ClickHouse/ClickHouse/pull/18518) ([alesapin](https://github.com/alesapin)).
* 在合并期间禁用使用 AIO 的写入，因为这可能在合并时极少数情况下导致主键列数据损坏。[#18481](https://github.com/ClickHouse/ClickHouse/pull/18481) ([alesapin](https://github.com/alesapin)).
* 在分析阶段，当无法计算结果时，禁用对子查询的常量折叠。 [#18446](https://github.com/ClickHouse/ClickHouse/pull/18446) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在对类型为 `Nullable(String)` 的参数执行 `toType(...)` 系列函数（如 `toDate`、`toUInt32` 等）时出现的 `value is too short` 错误。现在，此类函数在解析出错时会返回 `NULL`，而不是抛出异常。修复了 [#7673](https://github.com/ClickHouse/ClickHouse/issues/7673)。[#18445](https://github.com/ClickHouse/ClickHouse/pull/18445)（[tavplubix](https://github.com/tavplubix)）。
* 限制从宽部件到紧凑部件的合并。在垂直合并的情况下，这会导致结果部件损坏。[#18381](https://github.com/ClickHouse/ClickHouse/pull/18381) ([Anton Popov](https://github.com/CurtizJ)).
* 修复填充表 `system.settings_profile_elements` 的方式。此 PR 修复了 [#18231](https://github.com/ClickHouse/ClickHouse/issues/18231)。[#18379](https://github.com/ClickHouse/ClickHouse/pull/18379)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复对带有常量参数的二元函数的索引分析问题，该问题会导致查询结果错误。此修复对应 [#18364](https://github.com/ClickHouse/ClickHouse/issues/18364)。[#18373](https://github.com/ClickHouse/ClickHouse/pull/18373)（[Amos Bird](https://github.com/amosbird)）。
* 修复在使用两级聚合时，带有组合器 `Distinct` 的聚合函数可能发生的崩溃问题。修复了 [#17682](https://github.com/ClickHouse/ClickHouse/issues/17682)。[#18365](https://github.com/ClickHouse/ClickHouse/pull/18365)（[Anton Popov](https://github.com/CurtizJ)）。
* 现在，即使只能从该 `table` 中选出任意一列，也可以执行 `SELECT count() FROM table`。此 PR 修复了 [#10639](https://github.com/ClickHouse/ClickHouse/issues/10639)。[#18233](https://github.com/ClickHouse/ClickHouse/pull/18233)（[Vitaly Baranov](https://github.com/vitlibar)）。
* `SELECT JOIN` 现在要求对每个参与联接的表具有 `SELECT` 权限。此 PR 修复了 [#17654](https://github.com/ClickHouse/ClickHouse/issues/17654)。[#18232](https://github.com/ClickHouse/ClickHouse/pull/18232)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复在发生读取退避（日志中出现消息 `<Debug> MergeTreeReadPool: Will lower number of threads`）时，从 `MergeTree*` 读取可能导致查询结果不完整的问题。该问题引入于 [#16423](https://github.com/ClickHouse/ClickHouse/issues/16423)。此修复解决了问题 [#18137](https://github.com/ClickHouse/ClickHouse/issues/18137)。[#18216](https://github.com/ClickHouse/ClickHouse/pull/18216)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在执行查询 `MODIFY COLUMN ... REMOVE TTL` 时未真正移除列 TTL 的错误。[#18130](https://github.com/ClickHouse/ClickHouse/pull/18130) ([alesapin](https://github.com/alesapin))。
* 使用谓词优化器修复非确定性函数。这修复了 [#17244](https://github.com/ClickHouse/ClickHouse/issues/17244)。[#17273](https://github.com/ClickHouse/ClickHouse/pull/17273)（[Winter Zhang](https://github.com/zhang2014)）。
* 在执行 `MOVE` 或 `REPLACE PARTITION` 后，或者在少见情况下执行 `DETACH` 或 `DROP PARTITION` 后，变更操作（mutation）可能会因为等待某个不存在的 part 而挂起。该问题已修复。 [#15537](https://github.com/ClickHouse/ClickHouse/pull/15537) ([tavplubix](https://github.com/tavplubix)).

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-2}

- 将时区信息更新至 2020e。[#18531](https://github.com/ClickHouse/ClickHouse/pull/18531) ([alesapin](https://github.com/alesapin))。

### ClickHouse 版本 v20.11.6.6-stable,2020-12-24 {#clickhouse-release-v201166-stable-2020-12-24}

#### Bug 修复 {#bug-fix-4}


* 修复了在具有 IPv4/IPv6 双栈的机器上服务器无法访问 `clickhouse-odbc-bridge` 进程的问题，以及在使用格式错误的查询执行 ODBC 字典更新时和/或导致崩溃的问题。该修复可能解决了 [#14489](https://github.com/ClickHouse/ClickHouse/issues/14489)。[#18278](https://github.com/ClickHouse/ClickHouse/pull/18278)（[Denis Glazachev](https://github.com/traceon)）。
* 修复了 `Enum` 和 `Int` 类型之间的定长键比较问题。修复了 [#17989](https://github.com/ClickHouse/ClickHouse/issues/17989)。[#18214](https://github.com/ClickHouse/ClickHouse/pull/18214)（[Amos Bird](https://github.com/amosbird)）。
* 修复了 `MaterializeMySQL` 数据库引擎中唯一键转换导致的崩溃问题。此修复解决了 [#18186](https://github.com/ClickHouse/ClickHouse/issues/18186) 和 [#16372](https://github.com/ClickHouse/ClickHouse/issues/16372) [#18211](https://github.com/ClickHouse/ClickHouse/pull/18211)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复了在解析 S3 URL 时出现的 `std::out_of_range: basic_string` 异常。[#18059](https://github.com/ClickHouse/ClickHouse/pull/18059) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 修复了由于 `MaterializeMySQL` 不支持转换 MySQL 前缀索引，导致某些表无法从 MySQL 同步到 ClickHouse 的问题。该修复解决了 [#15187](https://github.com/ClickHouse/ClickHouse/issues/15187)、[#17912](https://github.com/ClickHouse/ClickHouse/issues/17912) 和 [#17944](https://github.com/ClickHouse/ClickHouse/pull/17944)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复了在查询包含 `ARRAY JOIN` 时，查询优化可能产生错误结果的问题。 [#17887](https://github.com/ClickHouse/ClickHouse/pull/17887) ([sundyli](https://github.com/sundy-li)).
* 修复 `topK` 聚合函数中可能出现的段错误（segfault）。此更改解决了 [#17404](https://github.com/ClickHouse/ClickHouse/issues/17404)。[#17845](https://github.com/ClickHouse/ClickHouse/pull/17845)（[Maksim Kita](https://github.com/kitaisreal)）。
* 如果禁用了 `in_memory_parts_enable_wal`，则不要从 WAL 恢复数据分片。 [#17802](https://github.com/ClickHouse/ClickHouse/pull/17802) ([detailyang](https://github.com/detailyang)).
* 修复了 ClickHouse 无法重新建立与 MySQL 服务器连接的问题。[#17681](https://github.com/ClickHouse/ClickHouse/pull/17681) ([Alexander Kazakov](https://github.com/Akazz)).
* 修复了 `optimize_trivial_count_query` 在包含分区谓词时的不一致行为。[#17644](https://github.com/ClickHouse/ClickHouse/pull/17644) ([Azat Khuzhin](https://github.com/azat)).
* 修复了服务器以守护进程模式运行时 `system.stack_trace` 表为空的问题。[#17630](https://github.com/ClickHouse/ClickHouse/pull/17630) ([Amos Bird](https://github.com/amosbird)).
* 修复了在 MergeTree 表中可能在后台记录异常 `fmt::v7::format_error` 的问题。此更改修复了 [#17613](https://github.com/ClickHouse/ClickHouse/issues/17613)。[#17615](https://github.com/ClickHouse/ClickHouse/pull/17615)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在交互模式下使用 clickhouse-client 输入多行查询时的行为：单行注释会被错误地延伸到整个查询末尾的问题。此修复解决了 [#13654](https://github.com/ClickHouse/ClickHouse/issues/13654)。[#17565](https://github.com/ClickHouse/ClickHouse/pull/17565)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了极少数情况下服务器可能停止接受连接的问题。 [#17542](https://github.com/ClickHouse/ClickHouse/pull/17542) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复了当相应的 mutation 在其他副本上被 kill 时，`ALTER` 查询发生挂起的问题。修复了 [#16953](https://github.com/ClickHouse/ClickHouse/issues/16953)。[#17499](https://github.com/ClickHouse/ClickHouse/pull/17499)（[alesapin](https://github.com/alesapin)）。
* 修复了 ClickHouse 低估 `mark cache` 大小的错误。当存在大量带有 `marks` 的小文件时，可能会出现这种情况。[#17496](https://github.com/ClickHouse/ClickHouse/pull/17496) ([alesapin](https://github.com/alesapin)).
* 修复在启用 `optimize_redundant_functions_in_order_by` 设置时的 `ORDER BY` 行为。[#17471](https://github.com/ClickHouse/ClickHouse/pull/17471)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复了由于错误优化导致在使用 `DISTINCT` 后仍可能出现的重复值问题。修复了 [#17294](https://github.com/ClickHouse/ClickHouse/issues/17294)。[#17296](https://github.com/ClickHouse/ClickHouse/pull/17296)（[li chengxiang](https://github.com/chengxianglibra)）。[#17439](https://github.com/ClickHouse/ClickHouse/pull/17439)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了从包含 `LowCardinality` 类型的 `JOIN` 表读取数据时发生的崩溃问题。此修复解决了 [#17228](https://github.com/ClickHouse/ClickHouse/issues/17228)。[#17397](https://github.com/ClickHouse/ClickHouse/pull/17397)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在子查询中存在 `const` 列时固定集合索引被失效的问题，解决了 [#17246](https://github.com/ClickHouse/ClickHouse/issues/17246)。[#17249](https://github.com/ClickHouse/ClickHouse/pull/17249)（[Amos Bird](https://github.com/amosbird)）。
* 修复了在索引比较两侧类型不同时可能出现的错误索引分析。此更改修复了 [#17122](https://github.com/ClickHouse/ClickHouse/issues/17122)。[#17145](https://github.com/ClickHouse/ClickHouse/pull/17145) ([Amos Bird](https://github.com/amosbird))。
* 修复了导致崩溃的 `ColumnConst` 比较问题，解决了 [#17088](https://github.com/ClickHouse/ClickHouse/issues/17088)。[#17135](https://github.com/ClickHouse/ClickHouse/pull/17135)（[Amos Bird](https://github.com/amosbird)）。
* 修复了一个错误，该错误可能导致在非主副本 `ReplicatedMergeTreeTables` 上执行的 `ON CLUSTER` 查询无限期挂起。 [#17089](https://github.com/ClickHouse/ClickHouse/pull/17089) ([alesapin](https://github.com/alesapin)).
* 修复了模糊测试工具发现的 `fuzzBits` 函数中的错误。此修复解决了 [#16980](https://github.com/ClickHouse/ClickHouse/issues/16980)。[#17051](https://github.com/ClickHouse/ClickHouse/pull/17051) ([hexiaoting](https://github.com/hexiaoting))。
* 避免对在执行过程中可能被取消的远程查询（例如带有 `LIMIT` 的查询）产生不必要的网络错误。 [#17006](https://github.com/ClickHouse/ClickHouse/pull/17006) ([Azat Khuzhin](https://github.com/azat)).
* 修复了从 `double` 类型转换为大整数（128、256 位）时结果错误的问题。 [#16986](https://github.com/ClickHouse/ClickHouse/pull/16986) ([Mike](https://github.com/myrrc)).
* 在发生错误时重新解析 `format_avro_schema_registry_url` 的 IP 地址。[#16985](https://github.com/ClickHouse/ClickHouse/pull/16985) ([filimonov](https://github.com/filimonov))。
* 修复了在执行 `ALTER TABLE ... MODIFY COLUMN ... NewType` 时，如果 `SELECT` 语句在正在修改的列上包含 `WHERE` 表达式且该修改尚未完成，可能导致服务器崩溃的问题。 [#16968](https://github.com/ClickHouse/ClickHouse/pull/16968) ([Amos Bird](https://github.com/amosbird)).
* 在 `clickhouse-git-import` 中未正确计算责任归属信息。[#16959](https://github.com/ClickHouse/ClickHouse/pull/16959)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了对单调函数使用的 `ORDER BY` 的固定排序优化。修复了 [#16107](https://github.com/ClickHouse/ClickHouse/issues/16107)。[#16956](https://github.com/ClickHouse/ClickHouse/pull/16956)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复了在启用 `optimize_aggregators_of_group_by_keys` 设置并使用 `JOIN` 时的 `GROUP BY` 优化行为。这修复了 [#12604](https://github.com/ClickHouse/ClickHouse/issues/12604)。 [#16951](https://github.com/ClickHouse/ClickHouse/pull/16951) ([Anton Popov](https://github.com/CurtizJ)).
* 安装脚本现在会始终在配置目录中创建子目录。此更改仅与使用自定义配置的 Docker 构建相关。[#16936](https://github.com/ClickHouse/ClickHouse/pull/16936) ([filimonov](https://github.com/filimonov))。
* 修复了在带有 `ORDER BY` 的查询中可能出现的 `Illegal type of argument` 错误。此更改修复了 [#16580](https://github.com/ClickHouse/ClickHouse/issues/16580)。[#16928](https://github.com/ClickHouse/ClickHouse/pull/16928)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 如果未向 WriteBufferFromS3 写入任何数据，则终止分段上传。 [#16840](https://github.com/ClickHouse/ClickHouse/pull/16840) ([Pavel Kovalenko](https://github.com/Jokser)).
* 修复了在不带任何参数使用 `any` 时发生的崩溃。修复了 [#16803](https://github.com/ClickHouse/ClickHouse/issues/16803)。[#16826](https://github.com/ClickHouse/ClickHouse/pull/16826)（[Amos Bird](https://github.com/amosbird)）。
* 修复了 ClickHouse 通过 MySQL 协议执行 `INSERT` 查询时总是返回 0 而不是受影响行数的问题。此修复解决了 [#16605](https://github.com/ClickHouse/ClickHouse/issues/16605)。[#16715](https://github.com/ClickHouse/ClickHouse/pull/16715)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复了 `TDigest` 的不受控增长问题。 [#16680](https://github.com/ClickHouse/ClickHouse/pull/16680) ([hrissan](https://github.com/hrissan)).
* 修复了在 Aggregate 函数中使用 `if` 后缀时导致远程查询失败的问题。此更改修复了 [#16574](https://github.com/ClickHouse/ClickHouse/issues/16574)、[#16231](https://github.com/ClickHouse/ClickHouse/issues/16231) 和 [#16610](https://github.com/ClickHouse/ClickHouse/pull/16610)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复了由于 `select_sequential_consistency` 在优化后的简单计数查询和 system.tables 上引发的不一致行为。[#16309](https://github.com/ClickHouse/ClickHouse/pull/16309)（[Hao Chen](https://github.com/haoch)）。
* 在使用 `ColumnTransformer` 替换不存在的列时抛出错误。 [#16183](https://github.com/ClickHouse/ClickHouse/pull/16183) ([hexiaoting](https://github.com/hexiaoting)).

### ClickHouse 版本 v20.11.3.3-stable, 2020-11-13 {#clickhouse-release-v201133-stable-2020-11-13}

#### 错误修复 {#bug-fix-5}

- 修复了当查询分析器开启且 ClickHouse 安装在 glibc 版本存在（疑似）某些函数异步展开表损坏的操作系统上时,偶发的静默崩溃问题。此修复解决了 [#15301](https://github.com/ClickHouse/ClickHouse/issues/15301)。此修复解决了 [#13098](https://github.com/ClickHouse/ClickHouse/issues/13098)。[#16846](https://github.com/ClickHouse/ClickHouse/pull/16846) ([alexey-milovidov](https://github.com/alexey-milovidov))。

### ClickHouse 版本 v20.11.2.1, 2020-11-11 {#clickhouse-release-v201121-2020-11-11}

#### 向后不兼容的变更 {#backward-incompatible-change-1}

- 如果在 `distributed_ddl` 配置段中指定了某个 `profile`,则该配置文件可能会在服务器启动时覆盖 `default` 配置文件的设置。此问题已修复,现在分布式 DDL 查询的设置不会影响全局服务器设置。[#16635](https://github.com/ClickHouse/ClickHouse/pull/16635) ([tavplubix](https://github.com/tavplubix))。
- 限制在键(排序键、主键、分区键等)中使用不可比较的数据类型(如 `AggregateFunction`)。[#16601](https://github.com/ClickHouse/ClickHouse/pull/16601) ([alesapin](https://github.com/alesapin))。
- 移除 `ANALYZE` 和 `AST` 查询,并使设置 `enable_debug_queries` 过时,因为现在它已成为功能完整的 `EXPLAIN` 查询的一部分。[#16536](https://github.com/ClickHouse/ClickHouse/pull/16536) ([Ivan](https://github.com/abyss7))。
- 聚合函数 `boundingRatio`、`rankCorr`、`retention`、`timeSeriesGroupSum`、`timeSeriesGroupRateSum`、`windowFunnel` 被错误地设置为不区分大小写。现在它们的名称已按设计改为区分大小写。只有 SQL 标准中指定的函数、为与其他 DBMS 兼容而设计的函数或类似函数才应不区分大小写。[#16407](https://github.com/ClickHouse/ClickHouse/pull/16407) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 使 `rankCorr` 函数在数据不足时返回 nan [#16124](https://github.com/ClickHouse/ClickHouse/issues/16124)。[#16135](https://github.com/ClickHouse/ClickHouse/pull/16135) ([hexiaoting](https://github.com/hexiaoting))。
- 从 20.5 之前的版本升级时,如果执行滚动更新且集群同时包含 20.5 或更高版本和低于 20.5 的版本,如果重启具有旧版本的 ClickHouse 节点并且在存在较新版本的情况下启动了旧版本,可能会导致 `Part ... intersects previous part` 错误。为防止此错误,请首先在所有集群节点上安装较新的 clickhouse-server 软件包,然后再执行重启(这样,当 clickhouse-server 重启时,它将使用新版本启动)。

#### 新功能 {#new-feature-1}


* 为本地不存在的用户添加了将 LDAP 作为用户目录的支持。[#12736](https://github.com/ClickHouse/ClickHouse/pull/12736) ([Denis Glazachev](https://github.com/traceon)).
* 添加 `system.replicated_fetches` 表，用于显示当前正在运行的后台拉取任务。 [#16428](https://github.com/ClickHouse/ClickHouse/pull/16428) ([alesapin](https://github.com/alesapin)).
* 新增设置 `date_time_output_format`。 [#15845](https://github.com/ClickHouse/ClickHouse/pull/15845) ([Maksim Kita](https://github.com/kitaisreal)).
* 为 ClickHouse 添加了一个最简版的 Web UI。 [#16158](https://github.com/ClickHouse/ClickHouse/pull/16158) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 允许一次性读取/写入单个 protobuf 消息（无长度分隔符）。 [#15199](https://github.com/ClickHouse/ClickHouse/pull/15199) ([filimonov](https://github.com/filimonov))。
* 新增了初步的 OpenTelemetry 支持。ClickHouse 现在可以通过 Native 和 HTTP 协议接收 OpenTelemetry `traceparent` 请求头，并在某些情况下将其向下游传递。已执行查询的 trace span 会被保存到 `system.opentelemetry_span_log` 表中。[#14195](https://github.com/ClickHouse/ClickHouse/pull/14195) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* 允许在 `CREATE TABLE` 查询的列列表中指定主键。这样做是为了与其他 SQL 方言兼容。[#15823](https://github.com/ClickHouse/ClickHouse/pull/15823) ([Maksim Kita](https://github.com/kitaisreal)).
* 在带有 ORDER BY 的 SELECT 查询中实现 `OFFSET offset_row_count {ROW | ROWS} FETCH {FIRST | NEXT} fetch_row_count {ROW | ROWS} {ONLY | WITH TIES}`。这是指定 `LIMIT` 的 SQL 标准用法。[#15855](https://github.com/ClickHouse/ClickHouse/pull/15855) ([hexiaoting](https://github.com/hexiaoting))。
* `errorCodeToName` 函数——返回错误代码对应的名称（对于分析 `query_log` 等日志非常有用）。`system.errors` 表——显示各类错误发生的次数（遵循 `system_events_show_zero_values` 设置）。[#16438](https://github.com/ClickHouse/ClickHouse/pull/16438) ([Azat Khuzhin](https://github.com/azat))。
* 新增了函数 `untuple`，这是一个特殊函数，可以通过展开命名元组，在 SELECT 列表中引入新的列。 [#16242](https://github.com/ClickHouse/ClickHouse/pull/16242) ([Nikolai Kochetov](https://github.com/KochetovNicolai), [Amos Bird](https://github.com/amosbird)).
* 现在我们可以通过查询参数传递标识符了。这些参数可以用作表对象或列。[#16594](https://github.com/ClickHouse/ClickHouse/pull/16594)（[Amos Bird](https://github.com/amosbird)）。
* 为 MergeTree BloomFilter 索引新增了对大整数（UInt256、Int128、Int256）和 UUID 数据类型的支持。大整数是实验性特性。 [#16642](https://github.com/ClickHouse/ClickHouse/pull/16642) ([Maksim Kita](https://github.com/kitaisreal))。
* 添加 `farmFingerprint64` 函数（非加密字符串哈希）。[#16570](https://github.com/ClickHouse/ClickHouse/pull/16570) ([Jacob Hayes](https://github.com/JacobHayes))。
* 新增设置项 `log_queries_min_query_duration_ms`，只有执行时间慢于该设置值的查询才会写入 `query_log`/`query_thread_log`（类似于 MySQL 中的 `slow_query_log`）。[#16529](https://github.com/ClickHouse/ClickHouse/pull/16529) ([Azat Khuzhin](https://github.com/azat)).
* 支持基于 `Alpine` 创建 Docker 镜像。使用来自 Ubuntu 20.04 的预编译二进制文件和 glibc 组件。[#16479](https://github.com/ClickHouse/ClickHouse/pull/16479) ([filimonov](https://github.com/filimonov))。
* 新增 `toUUIDOrNull`、`toUUIDOrZero` 类型转换函数。 [#16337](https://github.com/ClickHouse/ClickHouse/pull/16337) ([Maksim Kita](https://github.com/kitaisreal)).
* 添加 `max_concurrent_queries_for_all_users` 设置，使用场景参见 [#6636](https://github.com/ClickHouse/ClickHouse/issues/6636)。[#16154](https://github.com/ClickHouse/ClickHouse/pull/16154) ([nvartolomei](https://github.com/nvartolomei))。
* 在 clickhouse-client 中添加新选项 `print_query_id`。它可以利用客户端生成的当前查询 ID 来生成任意字符串。同时，默认在 clickhouse-client 中打印查询 ID。 [#15809](https://github.com/ClickHouse/ClickHouse/pull/15809) ([Amos Bird](https://github.com/amosbird))。
* 添加 `tid` 和 `logTrace` 函数。解决了 [#9434](https://github.com/ClickHouse/ClickHouse/issues/9434)。[#15803](https://github.com/ClickHouse/ClickHouse/pull/15803)（[flynn](https://github.com/ucasFL)）。
* 添加函数 `formatReadableTimeDelta`，用于将时间差格式化为易读的字符串 ... [#15497](https://github.com/ClickHouse/ClickHouse/pull/15497) ([Filipe Caixeta](https://github.com/filipecaixeta)).
* 为多磁盘配置中的卷新增了 `disable_merges` 选项。[#13956](https://github.com/ClickHouse/ClickHouse/pull/13956)（[Vladimir Chebotarev](https://github.com/excitoon)）。

#### 实验性功能 {#experimental-feature-1}

- 新增函数 `encrypt`、`aes_encrypt_mysql`、`decrypt`、`aes_decrypt_mysql`。由于这些函数运行速度较慢,因此将其作为实验性功能提供。[#11844](https://github.com/ClickHouse/ClickHouse/pull/11844) ([Vasily Nemkov](https://github.com/Enmk))。

#### 错误修复 {#bug-fix-6}


* 在 `system.distribution_queue` 中对 `data_path` 中的密码进行掩码处理。[#16727](https://github.com/ClickHouse/ClickHouse/pull/16727) ([Azat Khuzhin](https://github.com/azat))。
* 修复在启用 `transform_null_in` 设置时，`IN` 运算符在多列和元组上的行为问题。修复了 [#15310](https://github.com/ClickHouse/ClickHouse/issues/15310)。[#16722](https://github.com/ClickHouse/ClickHouse/pull/16722)（[Anton Popov](https://github.com/CurtizJ)）。
* 当查询的表未启用采样时，`max_parallel_replicas` 设置行为不正确。此更改修复了 [#5733](https://github.com/ClickHouse/ClickHouse/issues/5733)。[#16675](https://github.com/ClickHouse/ClickHouse/pull/16675) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复在 `max_threads` &gt; 0 且 `ORDER BY` 中包含表达式时 `optimize_read_in_order`/`optimize_aggregation_in_order` 的行为。 [#16637](https://github.com/ClickHouse/ClickHouse/pull/16637) ([Azat Khuzhin](https://github.com/azat)).
* 计算 `DEFAULT` 表达式时曾可能导致名称冲突（尽管在实际中几乎不可能遇到）。此更改修复了 [#9359](https://github.com/ClickHouse/ClickHouse/issues/9359)。[#16612](https://github.com/ClickHouse/ClickHouse/pull/16612)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `query_thread_log.query_duration_ms` 的单位。[#16563](https://github.com/ClickHouse/ClickHouse/pull/16563) ([Azat Khuzhin](https://github.com/azat))。
* 修复在使用 MySQL Master -&gt; MySQL Slave -&gt; ClickHouse MaterializeMySQL 引擎时出现的一个错误。`MaterializeMySQL` 是一项实验性功能。 [#16504](https://github.com/ClickHouse/ClickHouse/pull/16504) ([TCeason](https://github.com/TCeason))。
* 为 `round` 函数特定构造的、带有 `Decimal` 类型的参数会导致整数除零错误。此更改修复了 [#13338](https://github.com/ClickHouse/ClickHouse/issues/13338)。[#16451](https://github.com/ClickHouse/ClickHouse/pull/16451)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `Distributed` 表上 `DROP TABLE` 与 `INSERT` 之间的竞争问题。[#16409](https://github.com/ClickHouse/ClickHouse/pull/16409) ([Azat Khuzhin](https://github.com/azat)).
* 修复复制队列中对超大条目的处理。如果在 `ALTER` 查询中表结构极其庞大（接近 1 MB），则可能会出现非常大的条目。此修复解决了 [#16307](https://github.com/ClickHouse/ClickHouse/issues/16307)。[#16332](https://github.com/ClickHouse/ClickHouse/pull/16332)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了这样一种不一致的行为：由于用于过滤的数据集尚未创建，导致部分返回数据可能被丢弃的问题。 [#16308](https://github.com/ClickHouse/ClickHouse/pull/16308) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 修复 `sharding_key` 中的 `dictGet`（以及类似场景，即函数上下文被长期存储的情况）。 [#16205](https://github.com/ClickHouse/ClickHouse/pull/16205) ([Azat Khuzhin](https://github.com/azat)).
* 修复在 `clickhouse-local` 中尝试执行 `OPTIMIZE` 命令时抛出的异常，解决了 [#16076](https://github.com/ClickHouse/ClickHouse/issues/16076)。[#16192](https://github.com/ClickHouse/ClickHouse/pull/16192)（[filimonov](https://github.com/filimonov)）。
* 修复了 [#15780](https://github.com/ClickHouse/ClickHouse/issues/15780) 引入的回归问题，例如 `indexOf([1, 2, 3], toLowCardinality(1))` 现在被禁止，但本不应被禁止。[#16038](https://github.com/ClickHouse/ClickHouse/pull/16038)（[Mike](https://github.com/myrrc)）。
* 修复与 MySQL 数据库相关的错误。当作为数据库引擎使用的 MySQL 服务器宕机时，一些查询会抛出异常，因为它们尝试从已停用的服务器获取表，而这是不必要的。比如，查询 `SELECT ... FROM system.parts` 只应处理 MergeTree 表，完全不应访问 MySQL 数据库。[#16032](https://github.com/ClickHouse/ClickHouse/pull/16032)（[Kruglov Pavel](https://github.com/Avogar)）。
* 现在，当 `ALTER MODIFY COLUMN ... DEFAULT ...` 指定的默认值与列类型不兼容时，将抛出异常。修复了 [#15854](https://github.com/ClickHouse/ClickHouse/issues/15854)。[#15858](https://github.com/ClickHouse/ClickHouse/pull/15858)（[alesapin](https://github.com/alesapin)）。
* 修复了 `IPv4CIDRToRange`/`IPv6CIDRToRange` 函数，使其可以接受常量 IP 列的值。 [#15856](https://github.com/ClickHouse/ClickHouse/pull/15856) ([vladimir-golovchenko](https://github.com/vladimir-golovchenko)).

#### 改进 {#improvement-2}


* 将 `INTERVAL '1 hour'` 视为等同于 `INTERVAL 1 HOUR`，以兼容 Postgres 等系统。此更改修复了 [#15637](https://github.com/ClickHouse/ClickHouse/issues/15637)。[#15978](https://github.com/ClickHouse/ClickHouse/pull/15978)（[flynn](https://github.com/ucasFL)）。
* 为 CSV、TSV 和 JSON 输入格式启用按数值 ID 解析 `Enum` 值。[#15685](https://github.com/ClickHouse/ClickHouse/pull/15685) ([vivarum](https://github.com/vivarum)).
* 针对 JBOD 架构和 `MergeTree` 存储改进了读取任务的调度。新增设置 `read_backoff_min_concurrency`，用于设定读取线程数量的下限。 [#16423](https://github.com/ClickHouse/ClickHouse/pull/16423) ([Amos Bird](https://github.com/amosbird))。
* 为 `Avro` 格式补充对 `LowCardinality` 的缺失支持。[#16521](https://github.com/ClickHouse/ClickHouse/pull/16521)（[Mike](https://github.com/myrrc)）。
* 针对通过 nginx 服务器作为代理使用 `S3` 的变通方案。Nginx 目前不接受路径为空的 URL，例如 `http://domain.com?delete`，但原生 aws-sdk-cpp 会生成这类 URL。此提交使用了打过补丁的 aws-sdk-cpp 版本，在这种情况下会将路径设为 “/”，生成类似 `http://domain.com/?delete` 的 URL。[#16814](https://github.com/ClickHouse/ClickHouse/pull/16814)（[ianton-ru](https://github.com/ianton-ru)）。
* 改进输入数据解析错误的诊断信息。在出现 `Cannot read all data` 错误时提供行号。[#16644](https://github.com/ClickHouse/ClickHouse/pull/16644) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 使 `minMap` 和 `maxMap` 的行为更符合预期。结果中将不再跳过零值。修复了 [#16087](https://github.com/ClickHouse/ClickHouse/issues/16087)。[#16631](https://github.com/ClickHouse/ClickHouse/pull/16631)（[Ildus Kurbangaliev](https://github.com/ildus)）。
* 在运行时更好地更新 ZooKeeper 配置。[#16630](https://github.com/ClickHouse/ClickHouse/pull/16630) ([sundyli](https://github.com/sundy-li)).
* 尽可能早地应用 `SETTINGS` 子句。这样可以在查询中修改更多设置。修复了 [#3178](https://github.com/ClickHouse/ClickHouse/issues/3178)。[#16619](https://github.com/ClickHouse/ClickHouse/pull/16619)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 现在 `event_time_microseconds` 字段使用 Decimal64 类型存储，而不再使用 UInt64 类型。[#16617](https://github.com/ClickHouse/ClickHouse/pull/16617) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 现在可以在 `APPLY` 列转换器中使用参数化函数。[#16589](https://github.com/ClickHouse/ClickHouse/pull/16589) ([Amos Bird](https://github.com/amosbird))。
* 改进了用于删除 `Atomic` 数据库中已删除表数据的后台任务的调度方式。如果表实际上没有数据目录，则 `Atomic` 数据库不再创建指向表数据目录的损坏符号链接。 [#16584](https://github.com/ClickHouse/ClickHouse/pull/16584) ([tavplubix](https://github.com/tavplubix))。
* `WITH` 子句中的子查询（CTE）可以按名称引用同一 `WITH` 子句中之前的子查询。[#16575](https://github.com/ClickHouse/ClickHouse/pull/16575)（[Amos Bird](https://github.com/amosbird)）。
* 在 `system.query_thread_log` 中添加 `current_database` 字段。 [#16558](https://github.com/ClickHouse/ClickHouse/pull/16558) ([Azat Khuzhin](https://github.com/azat)).
* 允许将当前实例中已提交或已过期的数据部分拉取到 `detached` 目录中。在从另一个集群迁移表且使用 N 对 1 分片映射时非常有用。此行为也与当前的 `fetchPartition` 实现保持一致。[#16538](https://github.com/ClickHouse/ClickHouse/pull/16538) ([Amos Bird](https://github.com/amosbird))。
* 对 `RabbitMQ` 进行了多项改进：修复了 [#16263](https://github.com/ClickHouse/ClickHouse/issues/16263) 中描述的错误，同时缩短了事件循环的生命周期，并新增了更高效的队列配置。[#16426](https://github.com/ClickHouse/ClickHouse/pull/16426)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复 `quantileDeterministic` 函数中的调试断言。在之前的版本中，虽然不存在实际的错误，但它可能会通过网络多传输最多两倍的数据。此更改修复了 [#15683](https://github.com/ClickHouse/ClickHouse/issues/15683)。[#16410](https://github.com/ClickHouse/ClickHouse/pull/16410)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 添加 `TablesToDropQueueSize` 指标。其数值为已被删除但仍在等待后台数据清理的表的数量。[#16364](https://github.com/ClickHouse/ClickHouse/pull/16364) ([tavplubix](https://github.com/tavplubix))。
* 当客户端断开连接时提供更完善的诊断信息。在之前的版本中，`Attempt to read after EOF` 和 `Broken pipe` 异常会记录在服务端日志中。在新版本中，它被替换为一条信息级日志：`Client has dropped the connection, cancel the query.`。[#16329](https://github.com/ClickHouse/ClickHouse/pull/16329)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 Set/Join 表引擎添加对来自 system.tables 的 total&#95;rows/total&#95;bytes 的支持。[#16306](https://github.com/ClickHouse/ClickHouse/pull/16306) ([Azat Khuzhin](https://github.com/azat))。
* 现在可以在 MergeTree 表引擎系列中指定不带 `ORDER BY` 的 `PRIMARY KEY`。修复了 [#15591](https://github.com/ClickHouse/ClickHouse/issues/15591)。[#16284](https://github.com/ClickHouse/ClickHouse/pull/16284)（[alesapin](https://github.com/alesapin)）。
* 如果系统中没有 tmp 目录（例如 `chroot` 环境、配置错误等），`clickhouse-local` 会在当前目录中创建一个临时子目录。[#16280](https://github.com/ClickHouse/ClickHouse/pull/16280)（[filimonov](https://github.com/filimonov)）。
* 添加对嵌套数据类型（如具名 `tuple`）作为子类型的支持。修复 [#15587](https://github.com/ClickHouse/ClickHouse/issues/15587)。[#16262](https://github.com/ClickHouse/ClickHouse/pull/16262)（[Ivan](https://github.com/abyss7)）。
* 为 `DROP DATABASE` 添加对 `database_atomic_wait_for_drop_and_detach_synchronously`/`NO DELAY`/`SYNC` 的支持。[#16127](https://github.com/ClickHouse/ClickHouse/pull/16127) ([Azat Khuzhin](https://github.com/azat))。
* 添加 `allow_nondeterministic_optimize_skip_unused_shards`（允许在分片键中使用非确定性函数，例如 `rand()` 或 `dictGet()`）。[#16105](https://github.com/ClickHouse/ClickHouse/pull/16105) ([Azat Khuzhin](https://github.com/azat)).
* 修复通过 HTTP 执行的查询的 `memory_profiler_step`/`max_untracked_memory`（包含测试）。修复一个问题：在 xml 配置中全局调整该值也无效，因为这些设置本来就不会被应用，始终只会[使用](https://github.com/ClickHouse/ClickHouse/blob/17731245336d8c84f75e4c0894c5797ed7732190/src/Common/ThreadStatus.h#L104)默认值（4MB）。修复 HTTP 查询最顶层 ThreadStatus 的 `query_id`（通过在读取 `query_id` 之后初始化 QueryScope）。[#16101](https://github.com/ClickHouse/ClickHouse/pull/16101)（[Azat Khuzhin](https://github.com/azat)）。
* 现在，无论集群配置中的 `<internal_replication>` 设置为何，都可以执行 `ALTER ... ON CLUSTER` 查询。[#16075](https://github.com/ClickHouse/ClickHouse/pull/16075) ([alesapin](https://github.com/alesapin))。
* 修复一个罕见问题：`clickhouse-client` 在退出时可能因为加载建议而异常终止。此修复对应 [#16035](https://github.com/ClickHouse/ClickHouse/issues/16035)。[#16047](https://github.com/ClickHouse/ClickHouse/pull/16047)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为具有复杂键的 `Redis` 字典添加对 `cache` 布局的支持。[#15985](https://github.com/ClickHouse/ClickHouse/pull/15985) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在错误配置（将 `connections_with_failover_max_tries` 设置为 0）时导致查询挂起（陷入无限循环）的问题。[#15876](https://github.com/ClickHouse/ClickHouse/pull/15876) ([Azat Khuzhin](https://github.com/azat)).
* 将部分日志消息的级别从 information 降为 debug，这样 information 消息就不会在每个查询中都出现。关闭了 [#5293](https://github.com/ClickHouse/ClickHouse/issues/5293)。[#15816](https://github.com/ClickHouse/ClickHouse/pull/15816)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 移除 `MemoryTrackingInBackground*` 指标，以避免可能产生误导的结果。修复了 [#15684](https://github.com/ClickHouse/ClickHouse/issues/15684)。[#15813](https://github.com/ClickHouse/ClickHouse/pull/15813)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 `zookeeper-dump-tree` 工具添加重连功能。[#15711](https://github.com/ClickHouse/ClickHouse/pull/15711) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 允许在 `CREATE TABLE table AS table_function(...)` 查询中显式指定列列表。修复 [#9249](https://github.com/ClickHouse/ClickHouse/issues/9249)、[#14214](https://github.com/ClickHouse/ClickHouse/issues/14214)。[#14295](https://github.com/ClickHouse/ClickHouse/pull/14295)（[tavplubix](https://github.com/tavplubix)）。

#### 性能改进 {#performance-improvement-1}

- 在 SELECT FINAL 中不再跨分区合并数据部分。[#15938](https://github.com/ClickHouse/ClickHouse/pull/15938) ([Kruglov Pavel](https://github.com/Avogar)).
- 改进 `-OrNull` 和 `-OrDefault` 聚合函数的性能。[#16661](https://github.com/ClickHouse/ClickHouse/pull/16661) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- 改进 `quantileMerge` 的性能。在之前的版本中它的速度极慢。此更改关闭了 [#1463](https://github.com/ClickHouse/ClickHouse/issues/1463)。[#16643](https://github.com/ClickHouse/ClickHouse/pull/16643) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- 小幅改进逻辑函数的性能。[#16347](https://github.com/ClickHouse/ClickHouse/pull/16347) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- 改进了 MergeTree 表引擎中合并分配的性能。用户不会察觉到此变化。[#16191](https://github.com/ClickHouse/ClickHouse/pull/16191) ([alesapin](https://github.com/alesapin)).
- 通过预分配哈希表加速 hashed/sparse_hashed 字典的加载。[#15454](https://github.com/ClickHouse/ClickHouse/pull/15454) ([Azat Khuzhin](https://github.com/azat)).
- 现在简单计数优化变得稍微复杂了一些。包含精确分区表达式的谓词也可以被优化。此更改还修复了 [#11092](https://github.com/ClickHouse/ClickHouse/issues/11092),该问题在 `max_parallel_replicas > 1` 时返回错误的计数。[#15074](https://github.com/ClickHouse/ClickHouse/pull/15074) ([Amos Bird](https://github.com/amosbird)).

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-3}


* 为无状态测试添加不稳定性检查。在合并之前，它会预先检测出潜在不稳定的功能测试。[#16238](https://github.com/ClickHouse/ClickHouse/pull/16238) ([alesapin](https://github.com/alesapin)).
* 为 `croaring` 使用正确的版本，而不是合并版（amalgamation）。[#16285](https://github.com/ClickHouse/ClickHouse/pull/16285) ([sundyli](https://github.com/sundy-li)).
* 改进为 `ya.make` 构建系统（Arcadia）生成构建文件的方式。[#16700](https://github.com/ClickHouse/ClickHouse/pull/16700) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 为 `MaterializeMySQL` 数据库引擎添加 MySQL BinLog 文件检查工具。`MaterializeMySQL` 是一项实验性特性。[#16223](https://github.com/ClickHouse/ClickHouse/pull/16223) ([Winter Zhang](https://github.com/zhang2014)).
* 检查非可执行文件是否被设置了可执行位。人们经常会不小心在 Windows 上提交可执行文件。[#15843](https://github.com/ClickHouse/ClickHouse/pull/15843) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 检查头文件中是否包含 `#pragma once`。[#15818](https://github.com/ClickHouse/ClickHouse/pull/15818) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复 libhdfs3 中不规范的代码写法 `&vector[idx]`。这修复了 libcxx 调试版本的构建。另见 https://github.com/ClickHouse-Extras/libhdfs3/pull/8 。[#15815](https://github.com/ClickHouse/ClickHouse/pull/15815) ([Amos Bird](https://github.com/amosbird)).
* 修复在 Mac OS 上构建某个杂项示例工具的问题。注意，我们在 CI 中不会在 Mac OS 上构建示例（只构建 ClickHouse 二进制文件），因此它再次出问题的可能性极高。这修复了 [#15804](https://github.com/ClickHouse/ClickHouse/issues/15804)。[#15808](https://github.com/ClickHouse/ClickHouse/pull/15808) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 简化 Sys/V init 脚本。[#14135](https://github.com/ClickHouse/ClickHouse/pull/14135) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 向 `db_generator` 中添加 `boost::program_options` 以提升其易用性。这解决了 [#15940](https://github.com/ClickHouse/ClickHouse/issues/15940)。[#15973](https://github.com/ClickHouse/ClickHouse/pull/15973) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).



## ClickHouse 20.10 版本 {#clickhouse-release-2010}

### ClickHouse v20.10.7.4-stable 版本，2020-12-24 {#clickhouse-release-v201074-stable-2020-12-24}

#### 问题修复 {#bug-fix-7}


* 修复了在具有双栈 `IPv4/IPv6` 的机器上，服务器无法访问 `clickhouse-odbc-bridge` 进程的问题，并修复了使用格式错误的查询执行 ODBC 字典更新时可能导致更新失败和/或崩溃的问题。这可能已解决 [#14489](https://github.com/ClickHouse/ClickHouse/issues/14489)。[#18278](https://github.com/ClickHouse/ClickHouse/pull/18278)（[Denis Glazachev](https://github.com/traceon)）。
* 修复 `Enum` 与 `Int` 类型之间的键比较问题。修复了 [#17989](https://github.com/ClickHouse/ClickHouse/issues/17989)。[#18214](https://github.com/ClickHouse/ClickHouse/pull/18214)（[Amos Bird](https://github.com/amosbird)）。
* 修复了 `MaterializeMySQL` 数据库引擎中唯一键转换导致的崩溃问题。此修复解决了 [#18186](https://github.com/ClickHouse/ClickHouse/issues/18186) 和 [#16372](https://github.com/ClickHouse/ClickHouse/issues/16372) 问题，[#18211](https://github.com/ClickHouse/ClickHouse/pull/18211)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复了解析 S3 URL 时出现的 `std::out_of_range: basic_string` 错误。 [#18059](https://github.com/ClickHouse/ClickHouse/pull/18059) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 修复了由于 `MaterializeMySQL` 不支持转换 MySQL 前缀索引而导致部分表无法从 MySQL 同步到 ClickHouse 的问题。此更改修复了 [#15187](https://github.com/ClickHouse/ClickHouse/issues/15187)、[#17912](https://github.com/ClickHouse/ClickHouse/issues/17912) 和 [#17944](https://github.com/ClickHouse/ClickHouse/pull/17944)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复 `topK` 聚合函数中可能出现的段错误。修复 [#17404](https://github.com/ClickHouse/ClickHouse/issues/17404)。[#17845](https://github.com/ClickHouse/ClickHouse/pull/17845)（[Maksim Kita](https://github.com/kitaisreal)）。
* 如果禁用了 `in_memory_parts_enable_wal`，则不要从 `WAL` 中恢复数据分片。 [#17802](https://github.com/ClickHouse/ClickHouse/pull/17802) ([detailyang](https://github.com/detailyang))。
* 修复了 ClickHouse 无法恢复与 MySQL 服务器连接的问题。[#17681](https://github.com/ClickHouse/ClickHouse/pull/17681) ([Alexander Kazakov](https://github.com/Akazz)).
* 修复了服务器以守护进程模式运行时 `system.stack_trace` 表为空的问题。 [#17630](https://github.com/ClickHouse/ClickHouse/pull/17630) ([Amos Bird](https://github.com/amosbird)).
* 修复了在交互模式下使用 `clickhouse-client` 执行多行查询时，单行注释被错误地延伸到整个查询末尾的行为。修复了 [#13654](https://github.com/ClickHouse/ClickHouse/issues/13654)。[#17565](https://github.com/ClickHouse/ClickHouse/pull/17565) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了在极少数情况下服务器可能会停止接受连接的问题。 [#17542](https://github.com/ClickHouse/ClickHouse/pull/17542) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复了当相应 mutation 在其他副本上被终止时导致 `ALTER` 查询挂起的问题。修复了 [#16953](https://github.com/ClickHouse/ClickHouse/issues/16953)。 [#17499](https://github.com/ClickHouse/ClickHouse/pull/17499) ([alesapin](https://github.com/alesapin))。
* 修复了 ClickHouse 低估标记缓存大小的错误。当存在大量带标记的小文件时，可能会出现这种情况。[#17496](https://github.com/ClickHouse/ClickHouse/pull/17496) ([alesapin](https://github.com/alesapin))。
* 修复了在启用设置 `optimize_redundant_functions_in_order_by` 时的 `ORDER BY` 行为。 [#17471](https://github.com/ClickHouse/ClickHouse/pull/17471) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了由于错误优化导致在使用 `DISTINCT` 后仍可能出现的重复值。修复了 [#17294](https://github.com/ClickHouse/ClickHouse/issues/17294)。[#17296](https://github.com/ClickHouse/ClickHouse/pull/17296)（[li chengxiang](https://github.com/chengxianglibra)）。[#17439](https://github.com/ClickHouse/ClickHouse/pull/17439)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了从包含 `LowCardinality` 类型的 `JOIN` 表读取数据时发生的崩溃问题。此修复对应 [#17228](https://github.com/ClickHouse/ClickHouse/issues/17228)。[#17397](https://github.com/ClickHouse/ClickHouse/pull/17397)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在子查询中存在 `const` 列时固定集合索引失效的问题，解决了 [#17246](https://github.com/ClickHouse/ClickHouse/issues/17246)。[#17249](https://github.com/ClickHouse/ClickHouse/pull/17249)（[Amos Bird](https://github.com/amosbird)）。
* 修复了会导致崩溃的 `ColumnConst` 比较问题。本次修复关闭了 [#17088](https://github.com/ClickHouse/ClickHouse/issues/17088)。[#17135](https://github.com/ClickHouse/ClickHouse/pull/17135)（[Amos Bird](https://github.com/amosbird)）。
* 修复了一个错误：在非主节点的 `ReplicatedMergeTree` 表上，`ON CLUSTER` 查询可能会一直挂起。 [#17089](https://github.com/ClickHouse/ClickHouse/pull/17089) ([alesapin](https://github.com/alesapin)).
* 修复了模糊测试发现的 `fuzzBits` 函数中的错误，解决了 [#16980](https://github.com/ClickHouse/ClickHouse/issues/16980)。[#17051](https://github.com/ClickHouse/ClickHouse/pull/17051)（[hexiaoting](https://github.com/hexiaoting)）。
* 避免在执行过程中可能被取消的远程查询（例如带有 `LIMIT` 的查询）产生不必要的网络错误。[#17006](https://github.com/ClickHouse/ClickHouse/pull/17006) ([Azat Khuzhin](https://github.com/azat))。
* 修复了从 double 类型转换为大整数（128 位、256 位）时出现错误结果的问题。 [#16986](https://github.com/ClickHouse/ClickHouse/pull/16986) ([Mike](https://github.com/myrrc)).
* 在发生错误时重新解析 `format_avro_schema_registry_url` 对应的 IP 地址。[#16985](https://github.com/ClickHouse/ClickHouse/pull/16985) ([filimonov](https://github.com/filimonov)).
* 修复了在执行 `ALTER TABLE ... MODIFY COLUMN ... NewType` 时，如果对正在变更的列执行带有 `WHERE` 表达式的 `SELECT` 且变更尚未完成，可能导致服务器崩溃的问题。 [#16968](https://github.com/ClickHouse/ClickHouse/pull/16968) ([Amos Bird](https://github.com/amosbird))。
* `clickhouse-git-import` 中的归因信息计算不正确。[#16959](https://github.com/ClickHouse/ClickHouse/pull/16959) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了对单调函数的固定 `ORDER BY` 优化问题。修复了 [#16107](https://github.com/ClickHouse/ClickHouse/issues/16107)。[#16956](https://github.com/ClickHouse/ClickHouse/pull/16956)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复在启用 `optimize_aggregators_of_group_by_keys` 设置并使用 JOIN 时对 `GROUP BY` 的优化问题。修复了 [#12604](https://github.com/ClickHouse/ClickHouse/issues/12604)。 [#16951](https://github.com/ClickHouse/ClickHouse/pull/16951) ([Anton Popov](https://github.com/CurtizJ))。
* 安装脚本现在会始终在配置目录中创建子目录。此更改仅与在构建 Docker 镜像时使用自定义配置的情况相关。 [#16936](https://github.com/ClickHouse/ClickHouse/pull/16936) ([filimonov](https://github.com/filimonov)).
* 修复了在带有 `ORDER BY` 的查询中可能出现的 `Illegal type of argument` 错误。这修复了 [#16580](https://github.com/ClickHouse/ClickHouse/issues/16580)。[#16928](https://github.com/ClickHouse/ClickHouse/pull/16928)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 如果未向 `WriteBufferFromS3` 写入任何数据，则终止分段上传。 [#16840](https://github.com/ClickHouse/ClickHouse/pull/16840) ([Pavel Kovalenko](https://github.com/Jokser)).
* 修复了在无参数使用 `any` 时发生的崩溃问题。此修复对应 [#16803](https://github.com/ClickHouse/ClickHouse/issues/16803)。[#16826](https://github.com/ClickHouse/ClickHouse/pull/16826)（[Amos Bird](https://github.com/amosbird)）。
* 修复了通过 MySQL 协议执行 `INSERT` 查询时，ClickHouse 之前总是返回 0 而不是受影响行数的问题。此修复解决了 [#16605](https://github.com/ClickHouse/ClickHouse/issues/16605)。[#16715](https://github.com/ClickHouse/ClickHouse/pull/16715)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复了 `TDigest` 的无控制增长问题。[#16680](https://github.com/ClickHouse/ClickHouse/pull/16680) ([hrissan](https://github.com/hrissan))。
* 修复了在聚合函数中使用后缀 `if` 时远程查询失败的问题。该修复解决了 [#16574](https://github.com/ClickHouse/ClickHouse/issues/16574)、[#16231](https://github.com/ClickHouse/ClickHouse/issues/16231)、[#16610](https://github.com/ClickHouse/ClickHouse/pull/16610)（[Winter Zhang](https://github.com/zhang2014)）。

### ClickHouse 版本 v20.10.4.1-stable, 2020-11-13 {#clickhouse-release-v201041-stable-2020-11-13}

#### 错误修复 {#bug-fix-8}

- 修复了当查询分析器开启且 ClickHouse 安装在使用某些 glibc 版本(这些版本的某些函数的异步展开表可能已损坏)的操作系统上时,偶尔发生的静默崩溃问题。此修复解决了 [#15301](https://github.com/ClickHouse/ClickHouse/issues/15301)。此修复解决了 [#13098](https://github.com/ClickHouse/ClickHouse/issues/13098)。[#16846](https://github.com/ClickHouse/ClickHouse/pull/16846) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 修复了启用 `transform_null_in` 设置时,`IN` 运算符处理多列和元组的问题。修复了 [#15310](https://github.com/ClickHouse/ClickHouse/issues/15310)。[#16722](https://github.com/ClickHouse/ClickHouse/pull/16722) ([Anton Popov](https://github.com/CurtizJ))。
- 此修复解决了当 max_threads>0 且 ORDER BY 中包含表达式时,optimize_read_in_order/optimize_aggregation_in_order 的问题。[#16637](https://github.com/ClickHouse/ClickHouse/pull/16637) ([Azat Khuzhin](https://github.com/azat))。
- 现在从输入解析 AVRO 时会从类型中移除 LowCardinality。修复了 [#16188](https://github.com/ClickHouse/ClickHouse/issues/16188)。[#16521](https://github.com/ClickHouse/ClickHouse/pull/16521) ([Mike](https://github.com/myrrc))。
- 修复了在使用 MySQL Master -> MySQL Slave -> ClickHouse MaterializeMySQL 引擎且 MySQL Slave 上启用 `slave_parallel_worker` 时,通过正确收缩 GTID 集合来解决元数据快速增长的问题。此修复解决了 [#15951](https://github.com/ClickHouse/ClickHouse/issues/15951)。[#16504](https://github.com/ClickHouse/ClickHouse/pull/16504) ([TCeason](https://github.com/TCeason))。
- 修复了 Distributed 表的 DROP TABLE 操作(与 INSERT 存在竞争条件)。[#16409](https://github.com/ClickHouse/ClickHouse/pull/16409) ([Azat Khuzhin](https://github.com/azat))。
- 修复了复制队列中超大条目的处理问题。当表结构极大(接近 1 MB)时,ALTER 查询中可能出现超大条目。此修复解决了 [#16307](https://github.com/ClickHouse/ClickHouse/issues/16307)。[#16332](https://github.com/ClickHouse/ClickHouse/pull/16332) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 修复了 MySQL 数据库的错误。当用作数据库引擎的 MySQL 服务器宕机时,某些查询会抛出异常,因为它们尝试从已禁用的服务器获取表,而这是不必要的。例如,查询 `SELECT ... FROM system.parts` 应该只处理 MergeTree 表,完全不涉及 MySQL 数据库。[#16032](https://github.com/ClickHouse/ClickHouse/pull/16032) ([Kruglov Pavel](https://github.com/Avogar))。

#### 改进 {#improvement-3}

- 针对使用 nginx 服务器作为代理访问 S3 的解决方案。Nginx 目前不接受空路径的 URL,如 http://domain.com?delete,但原生 aws-sdk-cpp 会生成此类 URL。此提交使用了修补版本的 aws-sdk-cpp,在这些情况下会生成带有 "/" 路径的 URL,如 http://domain.com/?delete。[#16813](https://github.com/ClickHouse/ClickHouse/pull/16813) ([ianton-ru](https://github.com/ianton-ru))。

### ClickHouse 版本 v20.10.3.30, 2020-10-28 {#clickhouse-release-v2010330-2020-10-28}

#### 向后不兼容的变更 {#backward-incompatible-change-2}


- 废弃 `multiple_joins_rewriter_version` 设置。移除第一版连接重写器。[#15472](https://github.com/ClickHouse/ClickHouse/pull/15472) ([Artem Zuikov](https://github.com/4ertus2))。
- 将 `format_regexp_escaping_rule` 设置(与 `Regexp` 格式相关)的默认值更改为 `Raw`(表示将整个子模式作为值读取),使其行为更符合用户预期。[#15426](https://github.com/ClickHouse/ClickHouse/pull/15426) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 在 SQL 中添加对嵌套多行注释 `/* comment /* comment */ */` 的支持。这符合 SQL 标准。[#14655](https://github.com/ClickHouse/ClickHouse/pull/14655) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 添加了 MergeTree 设置(`max_replicated_merges_with_ttl_in_queue` 和 `max_number_of_merges_with_ttl_in_pool`)以控制后台池和复制队列中带 TTL 的合并数量。仅当使用删除 TTL 时,此更改才会破坏与旧版本的兼容性。否则,复制将保持兼容。如果一次性更新所有分片副本,或在完成所有副本更新之前执行 `SYSTEM STOP TTL MERGES`,则可以避免不兼容问题。如果复制队列中出现不兼容条目,首先执行 `SYSTEM STOP TTL MERGES`,然后使用 `ALTER TABLE ... DETACH PARTITION ...` 分离分配了不兼容 TTL 合并的分区,并在单个副本上将其重新附加。[#14490](https://github.com/ClickHouse/ClickHouse/pull/14490) ([alesapin](https://github.com/alesapin))。
- 从 20.5 之前的版本升级时,如果执行滚动更新且集群同时包含 20.5 或更高版本和低于 20.5 的版本,当重启具有旧版本的 ClickHouse 节点并且在存在较新版本的情况下启动了旧版本,可能会导致 `Part ... intersects previous part` 错误。为防止此错误,请先在所有集群节点上安装较新的 clickhouse-server 软件包,然后再执行重启(这样,当 clickhouse-server 重启时,将以新版本启动)。

#### 新功能 {#new-feature-2}


* 后台数据重新压缩。为 MergeTree 表引擎系列新增对 `TTL ... RECOMPRESS codec_name` 语法的支持。 [#14494](https://github.com/ClickHouse/ClickHouse/pull/14494) ([alesapin](https://github.com/alesapin)).
* 添加并行 quorum 写入功能。此更改关闭了 [#15601](https://github.com/ClickHouse/ClickHouse/issues/15601)。[#15601](https://github.com/ClickHouse/ClickHouse/pull/15601)（[Latysheva Alexandra](https://github.com/alexelex)）。
* 用于额外强化数据持久性的设置。对非复制部署十分有用。 [#11948](https://github.com/ClickHouse/ClickHouse/pull/11948) ([Anton Popov](https://github.com/CurtizJ)).
* 当向某个副本写入一个在本地不存在（尚未从其他副本拉取）的重复数据块时，不要忽略它，而应在本地也写入，以实现与成功完成复制相同的效果。 [#11684](https://github.com/ClickHouse/ClickHouse/pull/11684) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 现在我们支持在查询上下文中使用 `WITH &lt;identifier&gt; AS (subquery) ... ` 来引入具名子查询。这关闭了 [#2416](https://github.com/ClickHouse/ClickHouse/issues/2416)。这关闭了 [#4967](https://github.com/ClickHouse/ClickHouse/issues/4967)。 [#14771](https://github.com/ClickHouse/ClickHouse/pull/14771)（[Amos Bird](https://github.com/amosbird)）。
* 引入 `enable_global_with_statement` 设置，用于将第一个 `SELECT` 查询的 `WITH` 子句传播到同一层级的其他 `SELECT` 查询，并使 `WITH` 子句中的别名对子查询可见。 [#15451](https://github.com/ClickHouse/ClickHouse/pull/15451) ([Amos Bird](https://github.com/amosbird)).
* 安全的集群间查询执行（将 initial&#95;user 作为当前查询用户）。 [#13156](https://github.com/ClickHouse/ClickHouse/pull/13156) ([Azat Khuzhin](https://github.com/azat)). [#15551](https://github.com/ClickHouse/ClickHouse/pull/15551) ([Azat Khuzhin](https://github.com/azat)).
* 新增了删除列属性和表 TTL 的功能。引入了查询 `ALTER TABLE MODIFY COLUMN col_name REMOVE what_to_remove` 和 `ALTER TABLE REMOVE TTL`。这两种操作都很轻量，只在元数据层面执行。[#14742](https://github.com/ClickHouse/ClickHouse/pull/14742) ([alesapin](https://github.com/alesapin))。
* 新增 `RawBLOB` 格式。用于在没有任何转义和分隔符的情况下输入或输出单个值。解决了 [#15349](https://github.com/ClickHouse/ClickHouse/issues/15349)。[#15364](https://github.com/ClickHouse/ClickHouse/pull/15364)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 添加 `reinterpretAsUUID` 函数，用于将大端字节序的字节串转换为 UUID。 [#15480](https://github.com/ClickHouse/ClickHouse/pull/15480) ([Alexander Kuzmenkov](https://github.com/akuzm))。
* 实现 `force_data_skipping_indices` 设置。 [#15642](https://github.com/ClickHouse/ClickHouse/pull/15642) ([Azat Khuzhin](https://github.com/azat))。
* 添加设置 `output_format_pretty_row_numbers`，用于在 Pretty 格式中为结果行编号。修复了 [#15350](https://github.com/ClickHouse/ClickHouse/issues/15350)。[#15443](https://github.com/ClickHouse/ClickHouse/pull/15443)（[flynn](https://github.com/ucasFL)）。
* 新增查询混淆工具。它允许共享更多查询，以便进行更充分的测试。修复了 [#15268](https://github.com/ClickHouse/ClickHouse/issues/15268)。[#15321](https://github.com/ClickHouse/ClickHouse/pull/15321)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 新增表函数 `null('structure')`。 [#14797](https://github.com/ClickHouse/ClickHouse/pull/14797) ([vxider](https://github.com/Vxider)).
* 新增 `formatReadableQuantity` 函数，可帮助人们更容易地阅读大数值。[#14725](https://github.com/ClickHouse/ClickHouse/pull/14725) ([Artem Hnilov](https://github.com/BooBSD))。
* 新增 `LineAsString` 格式，该格式接受由换行符分隔的行序列，并将每一整行作为单个 String 字段进行解析。 [#14703](https://github.com/ClickHouse/ClickHouse/pull/14703) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)), [#13846](https://github.com/ClickHouse/ClickHouse/pull/13846) ([hexiaoting](https://github.com/hexiaoting)).
* 添加 `JSONStrings` 格式，用于以字符串数组形式输出数据。 [#14333](https://github.com/ClickHouse/ClickHouse/pull/14333) ([hcz](https://github.com/hczhcz)).
* 为 `Regexp` 格式添加对 &quot;Raw&quot; 列格式的支持。它允许直接整体提取子模式，而无需应用任何转义规则。[#15363](https://github.com/ClickHouse/ClickHouse/pull/15363) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 允许为 `TSV` 输出格式配置可自定义的 `NULL` 表示形式。该功能由设置项 `output_format_tsv_null_representation` 控制，默认值为 `\N`。这解决了 [#9375](https://github.com/ClickHouse/ClickHouse/issues/9375)。请注意，该设置仅影响输出格式，对于 `TSV` 输入格式，`\N` 仍然是唯一受支持的 `NULL` 表示形式。[#14586](https://github.com/ClickHouse/ClickHouse/pull/14586)（[Kruglov Pavel](https://github.com/Avogar)）。
* 为 `MaterializeMySQL` 提供对 Decimal 数据类型的支持。`MaterializeMySQL` 是一项实验性功能。[#14535](https://github.com/ClickHouse/ClickHouse/pull/14535) ([Winter Zhang](https://github.com/zhang2014)).
* 新增功能：`SHOW DATABASES LIKE 'xxx'`。 [#14521](https://github.com/ClickHouse/ClickHouse/pull/14521) ([hexiaoting](https://github.com/hexiaoting)).
* 添加了一个脚本，可将任意 git 仓库作为示例数据集导入 ClickHouse。[#14471](https://github.com/ClickHouse/ClickHouse/pull/14471) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 现在在 `INSERT` 语句的列列表中，可以将星号（及其变体）与列转换器组合使用。 [#14453](https://github.com/ClickHouse/ClickHouse/pull/14453) ([Amos Bird](https://github.com/amosbird))。
* 为分布式查询新增查询复杂度限制参数 `max_rows_to_read_leaf`、`max_bytes_to_read_leaf`，用于限制在叶子节点上读取的最大行数/字节数。该限制仅适用于本地读取，*不包括*根节点上的最终合并阶段。[#14221](https://github.com/ClickHouse/ClickHouse/pull/14221) ([Roman Khavronenko](https://github.com/hagen1778)).
* 允许用户在配置文件的 `<replicated_merge_tree>` 部分为 `ReplicatedMergeTree*` 存储引擎指定设置。其工作方式与 `<merge_tree>` 部分类似。对于 `ReplicatedMergeTree*` 存储引擎，会同时应用 `<merge_tree>` 和 `<replicated_merge_tree>` 中的设置，但 `<replicated_merge_tree>` 中的设置优先级更高。新增 `system.replicated_merge_tree_settings` 表。[#13573](https://github.com/ClickHouse/ClickHouse/pull/13573) ([Amos Bird](https://github.com/amosbird))。
* 新增了 `mapPopulateSeries` 函数。[#13166](https://github.com/ClickHouse/ClickHouse/pull/13166) ([Ildus Kurbangaliev](https://github.com/ildus))。
* 支持 MySQL 类型：`decimal`（映射为 ClickHouse 的 `Decimal`）以及具有亚秒级精度的 `datetime`（映射为 `DateTime64`）。 [#11512](https://github.com/ClickHouse/ClickHouse/pull/11512) ([Vasily Nemkov](https://github.com/Enmk))。
* 在 `system.text_log`、`system.trace_log`、`system.query_log` 和 `system.query_thread_log` 表中新增 `event_time_microseconds` 字段。 [#14760](https://github.com/ClickHouse/ClickHouse/pull/14760) ([Bharat Nallan](https://github.com/bharatnc)).
* 将 `event_time_microseconds` 列添加到 `system.asynchronous_metric_log` 和 `system.metric_log` 表。 [#14514](https://github.com/ClickHouse/ClickHouse/pull/14514) ([Bharat Nallan](https://github.com/bharatnc)).
* 在 `system.query_log` 和 `system.query_thread_log` 表中添加 `query_start_time_microseconds` 字段。 [#14252](https://github.com/ClickHouse/ClickHouse/pull/14252) ([Bharat Nallan](https://github.com/bharatnc)).

#### 错误修复 {#bug-fix-9}


* 修复了一种即使设置了内存限制仍可能发生内存过度分配的情况。解决了 [#14560](https://github.com/ClickHouse/ClickHouse/issues/14560)。[#16206](https://github.com/ClickHouse/ClickHouse/pull/16206)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `executable` 字典源挂起的问题。在先前版本中，使用某些格式（例如 `JSONEachRow`）时，在子进程至少输出一些内容之前，数据不会被传递给该子进程。本次修复关闭了 [#1697](https://github.com/ClickHouse/ClickHouse/issues/1697) 和 [#2455](https://github.com/ClickHouse/ClickHouse/issues/2455)。[#14525](https://github.com/ClickHouse/ClickHouse/pull/14525)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复函数 `dictGet` 在发生异常时的双重释放问题。如果字典在加载时出现错误，就可能触发该问题。[#16429](https://github.com/ClickHouse/ClickHouse/pull/16429) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复在使用 `totals`/`rollup`/`cube` 修饰符并对 `GROUP BY` 键应用 `min`/`max` 函数时的 `GROUP BY` 行为。修复了 [#16393](https://github.com/ClickHouse/ClickHouse/issues/16393)。[#16397](https://github.com/ClickHouse/ClickHouse/pull/16397)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复在使用 prefer&#95;localhost&#95;replica=0 和 internal&#95;replication 时异步 Distributed 表 INSERT 的问题。 [#16358](https://github.com/ClickHouse/ClickHouse/pull/16358) ([Azat Khuzhin](https://github.com/azat)).
* 修复 `TwoLevelStringHashTable` 实现中的一段严重错误代码，该错误可能导致内存泄漏。 [#16264](https://github.com/ClickHouse/ClickHouse/pull/16264) ([Amos Bird](https://github.com/amosbird)).
* 修复在某些情况下 `lambda` 中错误聚合导致的段错误（segfault）。 [#16082](https://github.com/ClickHouse/ClickHouse/pull/16082) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在 `ReplicatedVersionedCollapsingMergeTree` 表上执行 `ALTER MODIFY ... ORDER BY` 查询时出现的卡死问题。此更改修复了 [#15980](https://github.com/ClickHouse/ClickHouse/issues/15980)。[#16011](https://github.com/ClickHouse/ClickHouse/pull/16011)（[alesapin](https://github.com/alesapin)）。
* `MaterializeMySQL`（实验特性）：修复排序规则名称和字符集名称解析器，并为字符串类型支持 `length = 0`。 [#16008](https://github.com/ClickHouse/ClickHouse/pull/16008) ([Winter Zhang](https://github.com/zhang2014)).
* 允许在具有复杂键的字典中使用 `direct` 布局。[#16007](https://github.com/ClickHouse/ClickHouse/pull/16007) ([Anton Popov](https://github.com/CurtizJ))。
* 在一段时间无活动后出现复制错误时，避免副本挂起 5–10 分钟。 [#15987](https://github.com/ClickHouse/ClickHouse/pull/15987) ([filimonov](https://github.com/filimonov))。
* 修复在向 `MaterializedView` 插入数据或从其中查询的同时并发删除其目标表（针对 `Atomic` 数据库引擎）时偶发出现的段错误。 [#15984](https://github.com/ClickHouse/ClickHouse/pull/15984) ([tavplubix](https://github.com/tavplubix)).
* 修复了解析设置配置文件时的歧义：`CREATE USER ... SETTINGS profile readonly` 现在被视为使用名为 `readonly` 的配置文件，而不是具有 readonly 约束的名为 `profile` 的设置。修复了 [#15628](https://github.com/ClickHouse/ClickHouse/issues/15628)。[#15982](https://github.com/ClickHouse/ClickHouse/pull/15982)（[Vitaly Baranov](https://github.com/vitlibar)）。
* `MaterializeMySQL`（实验特性）：修复在创建数据库失败时发生的崩溃。[#15954](https://github.com/ClickHouse/ClickHouse/pull/15954) ([Winter Zhang](https://github.com/zhang2014))。
* 修复了在并发重命名表时（针对 Atomic 数据库引擎），`DROP TABLE IF EXISTS` 出现 `Table ... does not exist` 错误而导致失败的问题。修复了在并发执行某些涉及多个表的 DDL 查询（例如 `DROP DATABASE` 和 `RENAME TABLE`）时极少数情况下可能发生的死锁问题。修复了在并发执行 `DROP/DETACH TABLE` 时，`DROP/DETACH DATABASE` 因 `Table ... does not exist` 而失败的问题。[#15934](https://github.com/ClickHouse/ClickHouse/pull/15934) ([tavplubix](https://github.com/tavplubix))。
* 修复从 `Distributed` 表执行同时包含 `WHERE`、`PREWHERE` 和 `GLOBAL IN` 的查询时错误地返回空结果的问题。修复了 [#15792](https://github.com/ClickHouse/ClickHouse/issues/15792)。[#15933](https://github.com/ClickHouse/ClickHouse/pull/15933)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了 [#12513](https://github.com/ClickHouse/ClickHouse/issues/12513)：查询重新分析时具有相同别名的差值表达式之间存在差异的问题。[#15886](https://github.com/ClickHouse/ClickHouse/pull/15886)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复 RBAC 实现中可能出现的极少见死锁。[#15875](https://github.com/ClickHouse/ClickHouse/pull/15875) ([Vitaly Baranov](https://github.com/vitlibar))。
* 修复在执行 `ALTER MODIFY COLUMN` 查询之后运行的 `SELECT ... ORDER BY DESC` 查询中出现的 `Block structure mismatch` 异常。修复了 [#15800](https://github.com/ClickHouse/ClickHouse/issues/15800)。[#15852](https://github.com/ClickHouse/ClickHouse/pull/15852)（[alesapin](https://github.com/alesapin)）。
* `MaterializeMySQL`（实验性功能）：修复 `select count()` 结果不准确的问题。 [#15767](https://github.com/ClickHouse/ClickHouse/pull/15767) ([tavplubix](https://github.com/tavplubix)).
* 修复了一些仅选择虚拟列的查询场景。之前可能会抛出 `Not found column _nothing in block` 异常。修复了 [#12298](https://github.com/ClickHouse/ClickHouse/issues/12298)。[#15756](https://github.com/ClickHouse/ClickHouse/pull/15756)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复在 Atomic 数据库中删除带有内部表的物化视图时的问题（由于对物化视图的内部表执行递归 `DROP TABLE` 导致工作线程挂起，进而使所有后续的 `DROP TABLE` 操作也被挂起）。[#15743](https://github.com/ClickHouse/ClickHouse/pull/15743) ([Azat Khuzhin](https://github.com/azat))。
* 如果首次尝试失败，支持将该部分数据移动到另一块磁盘/卷。 [#15723](https://github.com/ClickHouse/ClickHouse/pull/15723) ([Pavel Kovalenko](https://github.com/Jokser))。
* 修复在向 `MATERIALIZED VIEW` 插入数据时可能出现的 `Cannot find column` 错误，该错误会在 `MV` 的查询包含 `ARRAY JOIN` 时发生。[#15717](https://github.com/ClickHouse/ClickHouse/pull/15717) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复了 `max_replicated_logs_to_keep` 设置默认值过低的问题，该问题可能导致副本过于频繁地被判定为丢失。通过选择最新的副本进行克隆来改进丢失副本的恢复过程。同时不再从丢失的副本中删除旧数据分片，而是将其分离。[#15701](https://github.com/ClickHouse/ClickHouse/pull/15701) ([tavplubix](https://github.com/tavplubix))。
* 修复 MySQL 字典和表中罕见的竞态条件。 [#15686](https://github.com/ClickHouse/ClickHouse/pull/15686) ([alesapin](https://github.com/alesapin)).
* 修复 AMQP-CPP 中的（非致命）竞争条件。 [#15667](https://github.com/ClickHouse/ClickHouse/pull/15667) ([alesapin](https://github.com/alesapin)).
* 修复了在从与目标表结构不同的 `Buffer` 表读取数据时出现的错误 `Cannot add simple transform to empty Pipe`。当目标表对查询返回空结果时，会触发该问题。修复了 [#15529](https://github.com/ClickHouse/ClickHouse/issues/15529)。[#15662](https://github.com/ClickHouse/ClickHouse/pull/15662)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 在向基于 S3 的 MergeTree 中插入数据时实现了正确的错误处理。基于 S3 的 MergeTree 是一项实验性功能。[#15657](https://github.com/ClickHouse/ClickHouse/pull/15657)（[Pavel Kovalenko](https://github.com/Jokser)）。
* 修复了 S3 表函数中的错误：来自 URL 的区域未应用到 S3 客户端配置中。[#15646](https://github.com/ClickHouse/ClickHouse/pull/15646)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* 修复查询计划中 `ReadFromStorage` 步骤的资源析构顺序。在极少数情况下，这可能导致崩溃。可能与 [#15610](https://github.com/ClickHouse/ClickHouse/issues/15610) 相关。[#15645](https://github.com/ClickHouse/ClickHouse/pull/15645)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 在分离只读表时减少 `ReadonlyReplica` 指标。[#15592](https://github.com/ClickHouse/ClickHouse/pull/15592) ([sundyli](https://github.com/sundy-li)).
* 修复了在 `VALUES`、`LIMIT` 或 `IN` 运算符右侧使用 `JSON*` 函数返回结果时出现的 `Element ... is not a constant expression` 错误。 [#15589](https://github.com/ClickHouse/ClickHouse/pull/15589) ([tavplubix](https://github.com/tavplubix)).
* 在出现异常时，使查询更快结束。如果发生异常，则取消在远程副本上的执行。[#15578](https://github.com/ClickHouse/ClickHouse/pull/15578) ([Azat Khuzhin](https://github.com/azat)).
* 避免出现错误消息 `Could not calculate available disk space (statvfs), errno: 4, strerror: Interrupted system call`。修复了 [#15541](https://github.com/ClickHouse/ClickHouse/issues/15541)。[#15557](https://github.com/ClickHouse/ClickHouse/pull/15557)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在发起端不存在该数据库时，修复在包含 `IN` 和 `Distributed` 表的查询中出现的 `Database <db> does not exist.` 错误。[#15538](https://github.com/ClickHouse/ClickHouse/pull/15538) ([Artem Zuikov](https://github.com/4ertus2)).
* 在执行 `MOVE` 或 `REPLACE PARTITION` 之后，或者在罕见情况下执行 `DETACH` 或 `DROP PARTITION` 之后，变更操作可能会因为等待某个不存在的数据块而挂起。该问题已修复。[#15537](https://github.com/ClickHouse/ClickHouse/pull/15537) ([tavplubix](https://github.com/tavplubix))。
* 修复一个错误：在执行了相同模式的 `LIKE` 后，`ILIKE` 运算符不再保持不区分大小写的行为。[#15536](https://github.com/ClickHouse/ClickHouse/pull/15536) ([alesapin](https://github.com/alesapin)).
* 修复在选择数据中不存在的列时出现的 `Missing columns` 错误，这些列依赖的其他列同样不存在于数据中。修复了 [#15530](https://github.com/ClickHouse/ClickHouse/issues/15530)。[#15532](https://github.com/ClickHouse/ClickHouse/pull/15532)（[alesapin](https://github.com/alesapin)）。
* 当向 `ReplicatedMergeTree` 仅传递一个参数时抛出错误，而不再忽略该参数。 [#15516](https://github.com/ClickHouse/ClickHouse/pull/15516) ([nvartolomei](https://github.com/nvartolomei)).
* 修复 `DDLWorker` 中事件订阅的错误，该错误在极少数情况下可能导致 `ON CLUSTER` 查询卡住。该问题引入于 [#13450](https://github.com/ClickHouse/ClickHouse/issues/13450)。[#15477](https://github.com/ClickHouse/ClickHouse/pull/15477)（[alesapin](https://github.com/alesapin)）。
* 当 `boundingRatio` 聚合函数的第二个参数类型错误时，报告正确的错误信息。 [#15407](https://github.com/ClickHouse/ClickHouse/pull/15407) ([detailyang](https://github.com/detailyang)).
* 修复 [#15365](https://github.com/ClickHouse/ClickHouse/issues/15365)：使用 MySQL 引擎附加数据库时抛出异常（无查询上下文）。[#15384](https://github.com/ClickHouse/ClickHouse/pull/15384)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复在 `SELECT` 查询中多次使用列转换器时的处理问题。[#15378](https://github.com/ClickHouse/ClickHouse/pull/15378) ([Amos Bird](https://github.com/amosbird))。
* 修复了 `S3` 存储中的压缩问题。 [#15376](https://github.com/ClickHouse/ClickHouse/pull/15376) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 修复了一个错误：类似 `SELECT toStartOfDay(today())` 的查询会失败，并报错提示 time&#95;zone 参数为空。[#15319](https://github.com/ClickHouse/ClickHouse/pull/15319) ([Bharat Nallan](https://github.com/bharatnc))。
* 修复在重命名 MergeTree 表与执行后台清理时的竞态条件。[#15304](https://github.com/ClickHouse/ClickHouse/pull/15304) ([alesapin](https://github.com/alesapin))。
* 修复在启用系统日志时，服务器启动过程中偶发的竞争条件。 [#15300](https://github.com/ClickHouse/ClickHouse/pull/15300) ([alesapin](https://github.com/alesapin)).
* 修复了在针对同一 `MySQL` 引擎表包含大量子查询时查询发生挂起的问题。之前，如果一个查询中针对同一 `MySQL` 表的子查询超过 16 个，该查询会一直挂起。[#15299](https://github.com/ClickHouse/ClickHouse/pull/15299)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复 QueryLog 中的 MSan 报告。字段 `memory_usage` 可能会使用未初始化内存。[#15258](https://github.com/ClickHouse/ClickHouse/pull/15258) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复在对 Merge 表执行包含 JOIN 的查询时，GROUP BY 中出现的 `Unknown identifier` 错误。[#15242](https://github.com/ClickHouse/ClickHouse/pull/15242) ([Artem Zuikov](https://github.com/4ertus2)).
* 修复了在使用 `joinGet` 搭配 `LowCardinality` 类型时导致实例崩溃的问题。此修复解决了 [#15214](https://github.com/ClickHouse/ClickHouse/issues/15214)。[#15220](https://github.com/ClickHouse/ClickHouse/pull/15220)（[Amos Bird](https://github.com/amosbird)）。
* 修复表引擎 `Buffer` 中的一个错误：在执行 `ALTER` 查询后，无法将具有新结构的数据插入到 `Buffer` 中。修复了 [#15117](https://github.com/ClickHouse/ClickHouse/issues/15117)。[#15192](https://github.com/ClickHouse/ClickHouse/pull/15192)（[alesapin](https://github.com/alesapin)）。
* 调整 MySQL 列定义数据包中的 Decimal 字段大小。 [#15152](https://github.com/ClickHouse/ClickHouse/pull/15152) ([maqroll](https://github.com/maqroll)).
* 修复了在 `join_algorithm='auto'` 中出现的 `Data compressed with different methods` 错误。在 `join_algorithm='partial_merge'` 中保持左表关联键为 LowCardinality 类型。[#15088](https://github.com/ClickHouse/ClickHouse/pull/15088) ([Artem Zuikov](https://github.com/4ertus2)).
* 更新 `jemalloc`，修复带有亲和性掩码的 `percpu_arena`。[#15035](https://github.com/ClickHouse/ClickHouse/pull/15035) ([Azat Khuzhin](https://github.com/azat)). [#14957](https://github.com/ClickHouse/ClickHouse/pull/14957) ([Azat Khuzhin](https://github.com/azat)).
* 我们已经在 `String` 和 `FixedString` 之间使用了填充比较（[https://github.com/ClickHouse/ClickHouse/blob/master/src/Functions/FunctionsComparison.h#L333](https://github.com/ClickHouse/ClickHouse/blob/master/src/Functions/FunctionsComparison.h#L333)）。此 PR 将相同的逻辑应用于字段比较，从而修正了将 `FixedString` 用作主键时的用法。该变更修复了 [#14908](https://github.com/ClickHouse/ClickHouse/issues/14908)。[#15033](https://github.com/ClickHouse/ClickHouse/pull/15033)（[Amos Bird](https://github.com/amosbird)）。
* 如果以特定构造的参数调用函数 `bar`，可能会导致缓冲区溢出。此更改修复了 [#13926](https://github.com/ClickHouse/ClickHouse/issues/13926)。[#15028](https://github.com/ClickHouse/ClickHouse/pull/15028)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在 Mac OS 上通过 Docker 运行 clickhouse-server 时，在 Atomic 数据库中执行 DDL 查询会出现 `Cannot rename ... errno: 22, strerror: Invalid argument` 错误的问题。[#15024](https://github.com/ClickHouse/ClickHouse/pull/15024) ([tavplubix](https://github.com/tavplubix))。
* 修复在使用 join&#95;algorith=&#39;auto&#39; 的 RIGHT 或 FULL JOIN 时，当超出内存限制且需要将 HashJoin 切换为 MergeJoin 时出现的崩溃。 [#15002](https://github.com/ClickHouse/ClickHouse/pull/15002) ([Artem Zuikov](https://github.com/4ertus2)).
* 现在，设置项 `number_of_free_entries_in_pool_to_execute_mutation` 和 `number_of_free_entries_in_pool_to_lower_max_size_of_merge` 现在可以设置为与 `background_pool_size` 相同的值。[#14975](https://github.com/ClickHouse/ClickHouse/pull/14975) ([alesapin](https://github.com/alesapin))。
* 修复在子查询包含 `finalizeAggregation` 函数时谓词下推无法生效的问题。修复了 [#14847](https://github.com/ClickHouse/ClickHouse/issues/14847)。[#14937](https://github.com/ClickHouse/ClickHouse/pull/14937)（[filimonov](https://github.com/filimonov)）。
* 在 `system.asynchronous_metrics` 中按逻辑核心发布 CPU 频率。修复了 [#14923](https://github.com/ClickHouse/ClickHouse/issues/14923)。[#14924](https://github.com/ClickHouse/ClickHouse/pull/14924)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* `MaterializeMySQL`（实验特性）：修复 `.metadata.tmp File exists` 错误。[#14898](https://github.com/ClickHouse/ClickHouse/pull/14898)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复在某些调用 `extractAllGroups` 函数时可能触发 “Memory limit exceeded” 错误的问题。修复了 [#13383](https://github.com/ClickHouse/ClickHouse/issues/13383)。[#14889](https://github.com/ClickHouse/ClickHouse/pull/14889)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在尝试使用文件描述符向 StorageFile 执行 INSERT 时出现的 SIGSEGV。 [#14887](https://github.com/ClickHouse/ClickHouse/pull/14887) ([Azat Khuzhin](https://github.com/azat)).
* 修复了 `cache` 字典中的段错误（segfault）[#14837](https://github.com/ClickHouse/ClickHouse/issues/14837)。[#14879](https://github.com/ClickHouse/ClickHouse/pull/14879)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* `MaterializeMySQL`（实验特性）：修复了解析 MySQL binlog 事件时的错误，该错误会在 `MaterializeMySQL` 数据库引擎中导致 `Attempt to read after eof` 和 `Packet payload is not fully read` 错误。 [#14852](https://github.com/ClickHouse/ClickHouse/pull/14852) ([Winter Zhang](https://github.com/zhang2014)).
* 修复在 `SELECT` 查询中出现的罕见错误：当查询的列带有依赖于另一列的 `DEFAULT` 表达式，而该另一列也有 `DEFAULT`，且既未出现在 `SELECT` 查询中，也不存在于磁盘上时，会触发该错误。部分修复了 [#14531](https://github.com/ClickHouse/ClickHouse/issues/14531)。[#14845](https://github.com/ClickHouse/ClickHouse/pull/14845)（[alesapin](https://github.com/alesapin)）。
* 修复了这样一个问题：当需要通过 `from_zk` include 选项从 ZooKeeper 获取配置文件时，服务器在启动过程中与 ZooKeeper 通信可能会卡住。该修复解决了 [#14814](https://github.com/ClickHouse/ClickHouse/issues/14814)。[#14843](https://github.com/ClickHouse/ClickHouse/pull/14843)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* 修复对收缩式有符号类型 `Int -> Int` 转换的单调性错误检测问题。该问题可能导致查询结果不正确。此错误在 [#14513](https://github.com/ClickHouse/ClickHouse/issues/14513) 中被发现。[#14783](https://github.com/ClickHouse/ClickHouse/pull/14783)（[Amos Bird](https://github.com/amosbird)）。
* `Replace` 列转换器应使用克隆得到的 AST 来替换标识符。这修复了 [#14695](https://github.com/ClickHouse/ClickHouse/issues/14695)。[#14734](https://github.com/ClickHouse/ClickHouse/pull/14734)（[Amos Bird](https://github.com/amosbird)）。
* 修复在执行 `ALTER ... MODIFY QUERY` 时，物化视图元数据中遗漏默认数据库名称的问题。 [#14664](https://github.com/ClickHouse/ClickHouse/pull/14664) ([tavplubix](https://github.com/tavplubix)).
* 修复了这样一个问题：当在赋值表达式中对 `Nullable` 列执行带有常量值（如 `UPDATE x = 42`）的 `ALTER UPDATE` 变更时，会导致列中值不正确或发生段错误。修复了 [#13634](https://github.com/ClickHouse/ClickHouse/issues/13634)、[#14045](https://github.com/ClickHouse/ClickHouse/issues/14045)。[#14646](https://github.com/ClickHouse/ClickHouse/pull/14646)（[alesapin](https://github.com/alesapin)）。
* 修复由于结果列的小数精度错误而导致 `Decimal` 乘法结果不正确的问题。[#14603](https://github.com/ClickHouse/ClickHouse/pull/14603) ([Artem Zuikov](https://github.com/4ertus2)).
* 修复在 `Nullable` 类型的 `LowCardinality` 上使用 `has` 函数的问题。[#14591](https://github.com/ClickHouse/ClickHouse/pull/14591) ([Mike](https://github.com/myrrc)).
* 在 `StorageReplicatedMergeTree` 引擎执行 `CreateQuery` 时遇到 Zookeeper 异常后清理数据目录。 [#14563](https://github.com/ClickHouse/ClickHouse/pull/14563) ([Bharat Nallan](https://github.com/bharatnc)).
* 修复在带有 `-Resample` 组合器的函数中出现的罕见段错误，这些错误可能由于使用超大参数导致溢出而触发。 [#14562](https://github.com/ClickHouse/ClickHouse/pull/14562) ([Anton Popov](https://github.com/CurtizJ)).
* 修复将 `Nullable(String)` 转换为 Enum 时的一个错误。该错误由 [#12745](https://github.com/ClickHouse/ClickHouse/pull/12745) 引入。本次修复解决了 [#14435](https://github.com/ClickHouse/ClickHouse/issues/14435)。[#14530](https://github.com/ClickHouse/ClickHouse/pull/14530)（[Amos Bird](https://github.com/amosbird)）。
* 修复了 `Nullable` 列的错误排序顺序。该修复解决了 [#14344](https://github.com/ClickHouse/ClickHouse/issues/14344)。[#14495](https://github.com/ClickHouse/ClickHouse/pull/14495)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 修复在 `ON CLUSTER` DDL 查询中无法使用 `currentDatabase()` 函数的问题。 [#14211](https://github.com/ClickHouse/ClickHouse/pull/14211) ([Winter Zhang](https://github.com/zhang2014)).
* `MaterializeMySQL`（实验性特性）：修复了 `MaterializeMySQL` 数据库引擎中的 `Packet payload is not fully read` 错误。[#14696](https://github.com/ClickHouse/ClickHouse/pull/14696)（[BohuTANG](https://github.com/BohuTANG)）。

#### 改进 {#improvement-4}


* 默认对新建数据库启用 `Atomic` 数据库引擎。 [#15003](https://github.com/ClickHouse/ClickHouse/pull/15003) ([tavplubix](https://github.com/tavplubix)).
* 为具有子类型的列新增对 `Delta`、`T64` 等专用编解码器的指定能力。实现了 [#12551](https://github.com/ClickHouse/ClickHouse/issues/12551)，修复了 [#11397](https://github.com/ClickHouse/ClickHouse/issues/11397) 和 [#4609](https://github.com/ClickHouse/ClickHouse/issues/4609)。[#15089](https://github.com/ClickHouse/ClickHouse/pull/15089)（[alesapin](https://github.com/alesapin)）。
* 支持动态重新加载 ZooKeeper 配置。 [#14678](https://github.com/ClickHouse/ClickHouse/pull/14678) ([sundyli](https://github.com/sundy-li)).
* 现在，无论集群配置中的 `<internal_replication>` 设置为何，都允许执行 `ALTER ... ON CLUSTER` 查询。[#16075](https://github.com/ClickHouse/ClickHouse/pull/16075) ([alesapin](https://github.com/alesapin)).
* 现在 `joinGet` 支持多键查找。延续了 [#12418](https://github.com/ClickHouse/ClickHouse/issues/12418)。[#13015](https://github.com/ClickHouse/ClickHouse/pull/13015)（[Amos Bird](https://github.com/amosbird)）。
* 在 `Atomic` 数据库中，如果为 `DROP/DETACH TABLE` 指定了 `NO DELAY` 或 `SYNC`，则会等待该操作实际完成。[#15448](https://github.com/ClickHouse/ClickHouse/pull/15448) ([tavplubix](https://github.com/tavplubix))。
* 现在可以使用 `ALTER` 查询来修改 `VersionedCollapsingMergeTree` 的版本列类型。[#15442](https://github.com/ClickHouse/ClickHouse/pull/15442) ([alesapin](https://github.com/alesapin))。
* 在创建复制表时，在 `zookeeper_path` 中展开 `{database}`、`{table}` 和 `{uuid}` 宏。如果在服务器重启后可能导致 `zookeeper_path` 失效，则不允许执行 `RENAME TABLE`。修复了 [#6917](https://github.com/ClickHouse/ClickHouse/issues/6917)。[#15348](https://github.com/ClickHouse/ClickHouse/pull/15348)（[tavplubix](https://github.com/tavplubix)）。
* 函数 `now` 现在允许接受带时区的参数。这修复了 [15264](https://github.com/ClickHouse/ClickHouse/issues/15264)。[#15285](https://github.com/ClickHouse/ClickHouse/pull/15285)（[flynn](https://github.com/ucasFL)）。
* 在 `/docker-entrypoint-initdb.d/` 中的所有脚本执行完毕之前，不允许与 ClickHouse 服务器建立连接。[#15244](https://github.com/ClickHouse/ClickHouse/pull/15244) ([Aleksei Kozharin](https://github.com/alekseik1))。
* 为 `EXPLAIN PLAN` 查询新增 `optimize` 设置。启用后，将对查询计划应用各级别优化。默认启用。[#15201](https://github.com/ClickHouse/ClickHouse/pull/15201) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 为 `CAST` 参数个数错误提供了更合适的异常消息。修复了 [#13992](https://github.com/ClickHouse/ClickHouse/issues/13992)。[#15029](https://github.com/ClickHouse/ClickHouse/pull/15029)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 添加选项，以在插入数据部件时禁用 TTL 移动。[#15000](https://github.com/ClickHouse/ClickHouse/pull/15000)（[Pavel Kovalenko](https://github.com/Jokser)）。
* 在执行 mutation 时忽略键约束。没有这个 pull request，当 `force_index_by_date = 1` 或 `force_primary_key = 1` 时无法执行 mutation。[#14973](https://github.com/ClickHouse/ClickHouse/pull/14973) ([Amos Bird](https://github.com/amosbird))。
* 允许在之前的 `DROP` 尝试因 ZooKeeper 会话过期而失败时删除 `Replicated` 表。修复了 [#11891](https://github.com/ClickHouse/ClickHouse/issues/11891)。[#14926](https://github.com/ClickHouse/ClickHouse/pull/14926)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在分布式表上运行带有 `SETTINGS` 的 `SELECT` 时出现的过多设置约束违规错误。 [#14876](https://github.com/ClickHouse/ClickHouse/pull/14876) ([Amos Bird](https://github.com/amosbird)).
* 提供 `load_balancing_first_offset` 查询设置，用于显式指定哪个是第一个副本。它与 `FIRST_OR_RANDOM` 负载均衡策略配合使用，以便控制各副本的工作负载。[#14867](https://github.com/ClickHouse/ClickHouse/pull/14867)（[Amos Bird](https://github.com/amosbird)）。
* 在 `EXPLAIN` 结果中显示用于 `SET` 和 `JOIN` 的子查询。 [#14856](https://github.com/ClickHouse/ClickHouse/pull/14856) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 允许在 `Distributed` 存储中使用多卷存储配置。[#14839](https://github.com/ClickHouse/ClickHouse/pull/14839)（[Pavel Kovalenko](https://github.com/Jokser)）。
* 从同一个 `timespec` 构造 `query_start_time` 和 `query_start_time_microseconds`。 [#14831](https://github.com/ClickHouse/ClickHouse/pull/14831) ([Bharat Nallan](https://github.com/bharatnc)).
* 为 `StorageJoin` 和 `StorageSet` 提供禁用持久化的支持，可通过设置 `disable_set_and_join_persistency` 来控制该功能。本 PR 解决了问题 [#6318](https://github.com/ClickHouse/ClickHouse/issues/6318)。 [#14776](https://github.com/ClickHouse/ClickHouse/pull/14776) ([vxider](https://github.com/Vxider))。
* 现在可以使用 `COLUMNS` 来包裹一组列，并随后对其应用列转换器。[#14775](https://github.com/ClickHouse/ClickHouse/pull/14775)（[Amos Bird](https://github.com/amosbird)）。
* 将 `merge_algorithm` 添加到 `system.merges` 表中，以改进合并检查。 [#14705](https://github.com/ClickHouse/ClickHouse/pull/14705) ([Amos Bird](https://github.com/amosbird))。
* 修复由 ZooKeeper `exists` 监听导致的潜在内存泄漏。[#14693](https://github.com/ClickHouse/ClickHouse/pull/14693) ([hustnn](https://github.com/hustnn)).
* 允许并行执行分布式 DDL。 [#14684](https://github.com/ClickHouse/ClickHouse/pull/14684) ([Azat Khuzhin](https://github.com/azat)).
* 添加 `QueryMemoryLimitExceeded` 事件计数器。此更改解决了 [#14589](https://github.com/ClickHouse/ClickHouse/issues/14589)。[#14647](https://github.com/ClickHouse/ClickHouse/pull/14647)（[fastio](https://github.com/fastio)）。
* 修复查询格式中的一些末尾空白字符。 [#14595](https://github.com/ClickHouse/ClickHouse/pull/14595) ([Azat Khuzhin](https://github.com/azat)).
* ClickHouse 对分区表达式和键表达式的处理方式不同。分区表达式用于构建包含相关列的 minmax 索引，而主键表达式则以表达式形式进行存储。有时用户可能会在更粗粒度上对表进行分区，例如 `partition by i / 1000`。然而，二元运算符并不是单调的，而这个 PR 试图修复这一点。这项改动也可能对其他使用场景有益。[#14513](https://github.com/ClickHouse/ClickHouse/pull/14513)（[Amos Bird](https://github.com/amosbird)）。
* 为 `DiskS3` 增加一个可跳过访问检查的选项。`s3` 磁盘是一个实验性功能。[#14497](https://github.com/ClickHouse/ClickHouse/pull/14497)（[Pavel Kovalenko](https://github.com/Jokser)）。
* 在存在正在进行的 S3 请求时，加快服务器关闭过程。[#14496](https://github.com/ClickHouse/ClickHouse/pull/14496) ([Pavel Kovalenko](https://github.com/Jokser)).
* `SYSTEM RELOAD CONFIG` 现在在重新加载失败时会抛出异常，并继续使用先前的 users.xml。后台的周期性重新加载在重新加载失败时也会继续使用先前的 users.xml。[#14492](https://github.com/ClickHouse/ClickHouse/pull/14492) ([Vitaly Baranov](https://github.com/vitlibar))。
* 对于在 `clickhouse-client` 脚本模式下使用 VALUES 格式内联数据的 INSERT，除了换行符外，还支持使用分号作为数据结束符。关闭 [#12288](https://github.com/ClickHouse/ClickHouse/issues/12288)。[#13192](https://github.com/ClickHouse/ClickHouse/pull/13192)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* 在 compact 部分中支持自定义编解码器。 [#12183](https://github.com/ClickHouse/ClickHouse/pull/12183) ([Anton Popov](https://github.com/CurtizJ)).

#### 性能改进 {#performance-improvement-2}

- 默认为小数据部分启用紧凑部分。这将使频繁插入的处理效率略有提升(4到100倍)。[#11913](https://github.com/ClickHouse/ClickHouse/pull/11913) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 改进 `quantileTDigest` 性能。此修复解决了 [#2668](https://github.com/ClickHouse/ClickHouse/issues/2668)。[#15542](https://github.com/ClickHouse/ClickHouse/pull/15542) ([Kruglov Pavel](https://github.com/Avogar))。
- 显著降低 AggregatingInOrderTransform/optimize_aggregation_in_order 中的内存使用量。[#15543](https://github.com/ClickHouse/ClickHouse/pull/15543) ([Azat Khuzhin](https://github.com/azat))。
- 更快的256位乘法运算。[#15418](https://github.com/ClickHouse/ClickHouse/pull/15418) ([Artem Zuikov](https://github.com/4ertus2))。
- 通过使用 (u)int64_t 作为宽整数的基础类型来改进256位类型的性能。原始宽整数使用8位类型作为基础。[#14859](https://github.com/ClickHouse/ClickHouse/pull/14859) ([Artem Zuikov](https://github.com/4ertus2))。
- 显式使用临时磁盘存储垂直合并的临时数据。[#15639](https://github.com/ClickHouse/ClickHouse/pull/15639) ([Grigory Pervakov](https://github.com/GrigoryPervakov))。
- 使用单个 S3 DeleteObjects 请求替代循环中的多个 DeleteObject 请求。没有任何功能变更,因此由现有测试(如 integration/test_log_family_s3)覆盖。[#15238](https://github.com/ClickHouse/ClickHouse/pull/15238) ([ianton-ru](https://github.com/ianton-ru))。
- 修复 `DateTime <op> DateTime` 错误地选择缓慢的通用实现。此修复解决了 [#15153](https://github.com/ClickHouse/ClickHouse/issues/15153)。[#15178](https://github.com/ClickHouse/ClickHouse/pull/15178) ([Amos Bird](https://github.com/amosbird))。
- 改进 `FixedString` 类型的 GROUP BY 键的性能。[#15034](https://github.com/ClickHouse/ClickHouse/pull/15034) ([Amos Bird](https://github.com/amosbird))。
- 启动 clickhouse-server 时仅 `mlock` 代码段。在以前的版本中,所有映射区域都被锁定在内存中,包括调试信息。调试信息通常被分割到单独的文件中,但如果没有分割,会导致额外增加2到3 GiB的内存使用量。[#14929](https://github.com/ClickHouse/ClickHouse/pull/14929) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 由于链接时优化,ClickHouse 二进制文件变得更小。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-4}


* 现在我们在 ClickHouse 的生产构建中使用 clang-11。[#15239](https://github.com/ClickHouse/ClickHouse/pull/15239) ([alesapin](https://github.com/alesapin))。
* 现在我们在 CI 中使用 clang-11 来构建 ClickHouse。[#14846](https://github.com/ClickHouse/ClickHouse/pull/14846) ([alesapin](https://github.com/alesapin))。
* 将二进制构建（Linux、Darwin、AArch64、FreeBSD）切换为使用 clang-11。 [#15622](https://github.com/ClickHouse/ClickHouse/pull/15622) ([Ilya Yatsishin](https://github.com/qoega))。
* 现在所有测试镜像都使用 `llvm-symbolizer-11`。[#15069](https://github.com/ClickHouse/ClickHouse/pull/15069) ([alesapin](https://github.com/alesapin))。
* 允许使用 llvm-11 进行构建。[#15366](https://github.com/ClickHouse/ClickHouse/pull/15366) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 从 `clang-tidy-10` 切换为 `clang-tidy-11`。 [#14922](https://github.com/ClickHouse/ClickHouse/pull/14922) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 默认启用 LLVM 的实验性 pass 管理器。[#15608](https://github.com/ClickHouse/ClickHouse/pull/15608)（[Danila Kutenin](https://github.com/danlark1)）。
* 不允许任何 C++ 翻译单元的构建时间超过 10 分钟，或内存使用量超过 10 GB。此更改修复了 [#14925](https://github.com/ClickHouse/ClickHouse/issues/14925)。[#15060](https://github.com/ClickHouse/ClickHouse/pull/15060)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 通过将测试运行与性能分析运行拆分，使性能测试更加稳定且更具代表性。 [#15027](https://github.com/ClickHouse/ClickHouse/pull/15027) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 尝试提高性能测试的可靠性。通过在运行时使用 `madvise` 将进程的可执行内存动态重新映射为透明大页来实现——这可以减少 iTLB 未命中次数，而这正是性能测试不稳定的主要原因。[#14685](https://github.com/ClickHouse/ClickHouse/pull/14685) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 转换为 Python 3。此更改关闭了 [#14886](https://github.com/ClickHouse/ClickHouse/issues/14886)。[#15007](https://github.com/ClickHouse/ClickHouse/pull/15007)（[Azat Khuzhin](https://github.com/azat)）。
* 如果服务器未能响应，则在功能测试中及早失败。这项修改关闭了 [#15262](https://github.com/ClickHouse/ClickHouse/issues/15262)。[#15267](https://github.com/ClickHouse/ClickHouse/pull/15267)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 允许在没有配置文件的情况下运行 AArch64 版本的 clickhouse-server，以便支持 [#15174](https://github.com/ClickHouse/ClickHouse/issues/15174)。[#15266](https://github.com/ClickHouse/ClickHouse/pull/15266)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 改进 CI Docker 镜像：去除 ZooKeeper，并使用单一脚本安装测试配置。 [#15215](https://github.com/ClickHouse/ClickHouse/pull/15215) ([alesapin](https://github.com/alesapin)).
* 修复快速测试脚本中 CMake 选项的转递。修复了 [#14711](https://github.com/ClickHouse/ClickHouse/issues/14711) 中的错误。[#15155](https://github.com/ClickHouse/ClickHouse/pull/15155)（[alesapin](https://github.com/alesapin)）。
* 新增脚本，可通过一条命令执行硬件基准测试。[#15115](https://github.com/ClickHouse/ClickHouse/pull/15115) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 将大型测试 `test_dictionaries_all_layouts_and_sources` 拆分为多个较小的测试。[#15110](https://github.com/ClickHouse/ClickHouse/pull/15110) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 在启用 AVX-512 的服务器上，修复 `base64` 中的 MSan 报告问题。该修复解决了 [#14006](https://github.com/ClickHouse/ClickHouse/issues/14006)。[#15030](https://github.com/ClickHouse/ClickHouse/pull/15030)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 重新格式化并清理所有集成测试 *.py 文件中的代码。[#14864](https://github.com/ClickHouse/ClickHouse/pull/14864) ([Bharat Nallan](https://github.com/bharatnc))。
* 修复在 CI 中发现的 MaterializeMySQL 空事务不稳定测试案例。[#14854](https://github.com/ClickHouse/ClickHouse/pull/14854) ([Winter Zhang](https://github.com/zhang2014))。
* 尝试略微提升构建速度。 [#14808](https://github.com/ClickHouse/ClickHouse/pull/14808) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 通过删除未使用的头文件，略微提升了构建速度。[#14714](https://github.com/ClickHouse/ClickHouse/pull/14714) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复在 OSX 上的构建失败。[#14761](https://github.com/ClickHouse/ClickHouse/pull/14761)（[Winter Zhang](https://github.com/zhang2014)）。
* 如果在操作系统中找到 `ccache`，则在 `cmake` 中默认启用。[#14575](https://github.com/ClickHouse/ClickHouse/pull/14575) ([alesapin](https://github.com/alesapin)).
* 从 ClickHouse 仓库中管理 CI 构建配置。 [#14547](https://github.com/ClickHouse/ClickHouse/pull/14547) ([alesapin](https://github.com/alesapin))。
* 在 CMake 文件中： - 将部分选项描述移到了上方的注释中。 - 在 `option` 的默认值中将 0 替换为 `OFF`，1 替换为 `ON`。 - 为一些选项补充了描述和指向文档的链接。 - 替换了 `FUZZER` 选项（已经有另一个选项 `ENABLE_FUZZING`，同样会启用该功能）。 - 删除了 `ENABLE_GTEST_LIBRARY` 选项，因为已经有 `ENABLE_TESTS`。 完整说明见 PR：[#14711](https://github.com/ClickHouse/ClickHouse/pull/14711)（[Mike](https://github.com/myrrc)）。
* 将二进制文件体积减小一些（调试版本约小 50 MB）。 [#14555](https://github.com/ClickHouse/ClickHouse/pull/14555) ([Artem Zuikov](https://github.com/4ertus2)).
* 在 ConfigProcessor 中使用 std::filesystem::path 来连接文件路径。 [#14558](https://github.com/ClickHouse/ClickHouse/pull/14558) ([Bharat Nallan](https://github.com/bharatnc)).
* 修复在使用负大整数调用 `bitShiftLeft()` 时触发的调试断言错误。 [#14697](https://github.com/ClickHouse/ClickHouse/pull/14697) ([Artem Zuikov](https://github.com/4ertus2)).





## ClickHouse 版本 20.9 {#clickhouse-release-209}

### ClickHouse 版本 v20.9.7.11-stable, 2020-12-07 {#clickhouse-release-v209711-stable-2020-12-07}

#### 性能优化 {#performance-improvement-3}

- 修复从 `Merge` 表读取大量 `MergeTree` 表时的性能问题。修复了 [#7748](https://github.com/ClickHouse/ClickHouse/issues/7748)。[#16988](https://github.com/ClickHouse/ClickHouse/pull/16988) ([Anton Popov](https://github.com/CurtizJ))。

#### 错误修复 {#bug-fix-10}


* 如果禁用了 `in_memory_parts_enable_wal`，则不要从 WAL 恢复数据分片。 [#17802](https://github.com/ClickHouse/ClickHouse/pull/17802) ([detailyang](https://github.com/detailyang))。
* 修复了在向 `Distributed` 表插入数据时由于空间不足导致的段错误。[#17737](https://github.com/ClickHouse/ClickHouse/pull/17737) ([tavplubix](https://github.com/tavplubix)).
* 修复了 ClickHouse 无法重新建立与 MySQL 服务器连接的问题。[#17681](https://github.com/ClickHouse/ClickHouse/pull/17681) ([Alexander Kazakov](https://github.com/Akazz))。
* 修复了在 Windows Subsystem for Linux 上运行 ClickHouse 时，在 `Atomic` 数据库中执行 `RENAME` 查询时出现的 `Function not implemented` 错误。修复了 [#17661](https://github.com/ClickHouse/ClickHouse/issues/17661)。[#17664](https://github.com/ClickHouse/ClickHouse/pull/17664)（[tavplubix](https://github.com/tavplubix)）。
* 当在交互模式下使用 `clickhouse-client` 执行多行查询时，单行注释会被错误地延伸至整个查询的末尾。本次修复了 [#13654](https://github.com/ClickHouse/ClickHouse/issues/13654)。[#17565](https://github.com/ClickHouse/ClickHouse/pull/17565)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复一种极少见情况下服务器可能停止接受连接的问题。 [#17542](https://github.com/ClickHouse/ClickHouse/pull/17542) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复了当对应的 `mutation` 在其他副本上被终止时，`ALTER` 查询会挂起的问题。修复了 [#16953](https://github.com/ClickHouse/ClickHouse/issues/16953)。[#17499](https://github.com/ClickHouse/ClickHouse/pull/17499)（[alesapin](https://github.com/alesapin)）。
* 修复了 ClickHouse 低估标记缓存大小的错误。当存在大量带有标记的小文件时可能会发生该问题。 [#17496](https://github.com/ClickHouse/ClickHouse/pull/17496) ([alesapin](https://github.com/alesapin)).
* 修复在启用 `optimize_redundant_functions_in_order_by` 设置时的 `ORDER BY` 行为。[#17471](https://github.com/ClickHouse/ClickHouse/pull/17471) ([Anton Popov](https://github.com/CurtizJ)).
* 修复由于不正确的优化导致在使用 `DISTINCT` 后仍可能出现的重复数据。修复了 [#17294](https://github.com/ClickHouse/ClickHouse/issues/17294)。[#17296](https://github.com/ClickHouse/ClickHouse/pull/17296)（[li chengxiang](https://github.com/chengxianglibra)）。[#17439](https://github.com/ClickHouse/ClickHouse/pull/17439)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了从包含 `LowCardinality` 类型的 `JOIN` 表读取数据时的崩溃问题。修复了 [#17228](https://github.com/ClickHouse/ClickHouse/issues/17228)。[#17397](https://github.com/ClickHouse/ClickHouse/pull/17397)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在子查询中存在 `const` 列时集合索引失效的问题。此修复解决了 [#17246](https://github.com/ClickHouse/ClickHouse/issues/17246)。[#17249](https://github.com/ClickHouse/ClickHouse/pull/17249)（[Amos Bird](https://github.com/amosbird)）。
* 修复了导致崩溃的 `ColumnConst` 比较问题。已修复 [#17088](https://github.com/ClickHouse/ClickHouse/issues/17088)。[#17135](https://github.com/ClickHouse/ClickHouse/pull/17135)（[Amos Bird](https://github.com/amosbird)）。
* 修复了在执行 `CREATE TABLE ... AS some_table` 查询且 `some_table` 是通过 `AS table_function()` 创建时出现的崩溃问题。修复了 [#16944](https://github.com/ClickHouse/ClickHouse/issues/16944)。[#17072](https://github.com/ClickHouse/ClickHouse/pull/17072)（[tavplubix](https://github.com/tavplubix)）。
* 修复函数 `fuzzBits` 的错误，相关 issue：[#16980](https://github.com/ClickHouse/ClickHouse/issues/16980)。[#17051](https://github.com/ClickHouse/ClickHouse/pull/17051)（[hexiaoting](https://github.com/hexiaoting)）。
* 避免对在执行过程中可能被取消的远程查询（例如带有 `LIMIT` 的查询）产生不必要的网络错误。[#17006](https://github.com/ClickHouse/ClickHouse/pull/17006) ([Azat Khuzhin](https://github.com/azat)).
* 待办事项。 [#16866](https://github.com/ClickHouse/ClickHouse/pull/16866) ([tavplubix](https://github.com/tavplubix))。
* 通过 MySQL 协议在 `INSERT` 查询中返回受影响的行数。之前 ClickHouse 始终返回 0，现已修复。修复了 [#16605](https://github.com/ClickHouse/ClickHouse/issues/16605)。[#16715](https://github.com/ClickHouse/ClickHouse/pull/16715)（[Winter Zhang](https://github.com/zhang2014)）。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-5}

- 将嵌入的时区数据更新至 2020d 版本(同时将 cctz 更新至最新的 master 分支)。[#17204](https://github.com/ClickHouse/ClickHouse/pull/17204) ([filimonov](https://github.com/filimonov))。

### ClickHouse 版本 v20.9.6.14-stable, 2020-11-20 {#clickhouse-release-v209614-stable-2020-11-20}

#### 改进 {#improvement-5}

- 支持连接到需要 SNI 的 `clickhouse-server` 安全端点。当 `clickhouse-server` 部署在 TLS 代理后时可以使用此功能。[#16938](https://github.com/ClickHouse/ClickHouse/pull/16938) ([filimonov](https://github.com/filimonov))。
- 条件聚合函数(例如:`avgIf`、`sumIf`、`maxIf`)在没有匹配行且使用可空参数时应返回 `NULL`。[#13964](https://github.com/ClickHouse/ClickHouse/pull/13964) ([Winter Zhang](https://github.com/zhang2014))。

#### 错误修复 {#bug-fix-11}

- 修复了对于非主节点的 ReplicatedMergeTreeTables,`ON CLUSTER` 查询可能永久挂起的错误。[#17089](https://github.com/ClickHouse/ClickHouse/pull/17089) ([alesapin](https://github.com/alesapin))。
- 在出现错误时重新解析 `format_avro_schema_registry_url` 的 IP 地址。[#16985](https://github.com/ClickHouse/ClickHouse/pull/16985) ([filimonov](https://github.com/filimonov))。
- 修复了在执行 `ALTER TABLE ... MODIFY COLUMN ... NewType` 后,当 `SELECT` 语句在正在修改的列上包含 `WHERE` 表达式且修改尚未完成时可能导致的服务器崩溃。[#16968](https://github.com/ClickHouse/ClickHouse/pull/16968) ([Amos Bird](https://github.com/amosbird))。
- 安装脚本应始终在配置文件夹中创建子目录。这仅与使用自定义配置的 Docker 构建相关。[#16936](https://github.com/ClickHouse/ClickHouse/pull/16936) ([filimonov](https://github.com/filimonov))。
- 修复了带有 `ORDER BY` 的查询可能出现的 `Illegal type of argument` 错误。修复了 [#16580](https://github.com/ClickHouse/ClickHouse/issues/16580)。[#16928](https://github.com/ClickHouse/ClickHouse/pull/16928) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 如果没有数据写入 WriteBufferFromS3,则中止分段上传。[#16840](https://github.com/ClickHouse/ClickHouse/pull/16840) ([Pavel Kovalenko](https://github.com/Jokser))。
- 修复了在不带任何参数使用 `any` 时的崩溃问题。这是针对 [#16803](https://github.com/ClickHouse/ClickHouse/issues/16803)。cc @azat。[#16826](https://github.com/ClickHouse/ClickHouse/pull/16826) ([Amos Bird](https://github.com/amosbird))。
- 修复了在启用 `transform_null_in` 设置时,`IN` 操作符在多列和元组上的问题。修复了 [#15310](https://github.com/ClickHouse/ClickHouse/issues/15310)。[#16722](https://github.com/ClickHouse/ClickHouse/pull/16722) ([Anton Popov](https://github.com/CurtizJ))。
- 修复了当 max_threads>0 且 ORDER BY 中包含表达式时的 optimize_read_in_order/optimize_aggregation_in_order 问题。[#16637](https://github.com/ClickHouse/ClickHouse/pull/16637) ([Azat Khuzhin](https://github.com/azat))。
- 修复了 [#16574](https://github.com/ClickHouse/ClickHouse/issues/16574),修复了 [#16231](https://github.com/ClickHouse/ClickHouse/issues/16231),修复了使用带 'if' 后缀的聚合函数时远程查询失败的问题。[#16610](https://github.com/ClickHouse/ClickHouse/pull/16610) ([Winter Zhang](https://github.com/zhang2014))。
- 在发生异常时查询会更快完成。如果发生异常,则取消远程副本上的执行。[#15578](https://github.com/ClickHouse/ClickHouse/pull/15578) ([Azat Khuzhin](https://github.com/azat))。


### ClickHouse release v20.9.5.5-stable, 2020-11-13 {#clickhouse-release-v20955-stable-2020-11-13}

#### Bug Fix {#bug-fix-12}

- 修复了当查询分析器开启且 ClickHouse 安装在使用某些 glibc 版本的操作系统上时出现的罕见静默崩溃问题,这些 glibc 版本的某些函数的异步展开表(可能)已损坏。此修复解决了 [#15301](https://github.com/ClickHouse/ClickHouse/issues/15301)。此修复解决了 [#13098](https://github.com/ClickHouse/ClickHouse/issues/13098)。[#16846](https://github.com/ClickHouse/ClickHouse/pull/16846) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 现在从输入解析 AVRO 时会从类型中移除 LowCardinality。修复了 [#16188](https://github.com/ClickHouse/ClickHouse/issues/16188)。[#16521](https://github.com/ClickHouse/ClickHouse/pull/16521) ([Mike](https://github.com/myrrc))。
- 修复了使用 MySQL Master -> MySQL Slave -> ClickHouse MaterializeMySQL 引擎且在 MySQL Slave 上启用 `slave_parallel_worker` 时元数据快速增长的问题,通过正确收缩 GTID 集合来解决。此修复解决了 [#15951](https://github.com/ClickHouse/ClickHouse/issues/15951)。[#16504](https://github.com/ClickHouse/ClickHouse/pull/16504) ([TCeason](https://github.com/TCeason))。
- 修复了 Distributed 表的 DROP TABLE 操作(与 INSERT 存在竞态条件)。[#16409](https://github.com/ClickHouse/ClickHouse/pull/16409) ([Azat Khuzhin](https://github.com/azat))。
- 修复了复制队列中超大条目的处理问题。当表结构极大(接近 1 MB)时,ALTER 查询中可能出现超大条目。此修复解决了 [#16307](https://github.com/ClickHouse/ClickHouse/issues/16307)。[#16332](https://github.com/ClickHouse/ClickHouse/pull/16332) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 修复了由于未创建过滤集合而导致部分返回数据可能被丢弃的不一致行为。[#16308](https://github.com/ClickHouse/ClickHouse/pull/16308) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 修复了 MySQL 数据库的错误。当用作数据库引擎的 MySQL 服务器宕机时,某些查询会引发异常,因为它们尝试从已禁用的服务器获取表,而这是不必要的。例如,查询 `SELECT ... FROM system.parts` 应该仅适用于 MergeTree 表,完全不涉及 MySQL 数据库。[#16032](https://github.com/ClickHouse/ClickHouse/pull/16032) ([Kruglov Pavel](https://github.com/Avogar))。

### ClickHouse release v20.9.4.76-stable (2020-10-29) {#clickhouse-release-v209476-stable-2020-10-29}

#### Bug Fix {#bug-fix-13}


* 修复在函数 `dictGet` 抛出异常时可能出现的双重释放问题。如果字典在加载过程中发生错误，就可能触发该问题。[#16429](https://github.com/ClickHouse/ClickHouse/pull/16429) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复在使用 `totals`/`rollup`/`cube` 修饰符并对 `GROUP BY` 键应用 `min`/`max` 函数时的行为。修复了 [#16393](https://github.com/ClickHouse/ClickHouse/issues/16393)。[#16397](https://github.com/ClickHouse/ClickHouse/pull/16397)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复在 `prefer_localhost_replica=0` 且使用内部复制时的异步 Distributed INSERT。 [#16358](https://github.com/ClickHouse/ClickHouse/pull/16358) ([Azat Khuzhin](https://github.com/azat)).
* 修复了 `TwoLevelStringHashTable` 实现中一段严重错误的代码，该问题可能会导致内存泄漏。我很惊讶这个 bug 居然隐藏了这么久…… [#16264](https://github.com/ClickHouse/ClickHouse/pull/16264) ([Amos Bird](https://github.com/amosbird))。
* 修复了一种可能在忽略限制的情况下导致内存过度分配的问题。关闭 [#14560](https://github.com/ClickHouse/ClickHouse/issues/14560)。[#16206](https://github.com/ClickHouse/ClickHouse/pull/16206)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `ReplicatedVersionedCollapsingMergeTree` 中执行 `ALTER MODIFY ... ORDER BY` 查询时发生的挂起问题。此修复对应 [#15980](https://github.com/ClickHouse/ClickHouse/issues/15980)。[#16011](https://github.com/ClickHouse/ClickHouse/pull/16011)（[alesapin](https://github.com/alesapin)）。
* 修复排序规则名称和字符集名称的解析器，并为字符串类型支持 `length = 0`。 [#16008](https://github.com/ClickHouse/ClickHouse/pull/16008) ([Winter Zhang](https://github.com/zhang2014)).
* 允许在具有复杂键的字典中使用 direct 布局。 [#16007](https://github.com/ClickHouse/ClickHouse/pull/16007) ([Anton Popov](https://github.com/CurtizJ)).
* 在经历一段时间空闲后发生复制错误时，避免副本挂起 5–10 分钟。 [#15987](https://github.com/ClickHouse/ClickHouse/pull/15987) ([filimonov](https://github.com/filimonov)).
* 修复在向 `MaterializedView` 插入数据或从中查询时，同时并发删除目标表（适用于 `Atomic` 数据库引擎）可能导致的罕见段错误。 [#15984](https://github.com/ClickHouse/ClickHouse/pull/15984) ([tavplubix](https://github.com/tavplubix)).
* 修复设置配置文件解析中的歧义：`CREATE USER ... SETTINGS profile readonly` 现在被视为使用名为 `readonly` 的配置文件，而不是带有 readonly 约束的名为 `profile` 的设置。修复了 [#15628](https://github.com/ClickHouse/ClickHouse/issues/15628)。[#15982](https://github.com/ClickHouse/ClickHouse/pull/15982)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复了在创建数据库失败时发生的崩溃。[#15954](https://github.com/ClickHouse/ClickHouse/pull/15954) ([Winter Zhang](https://github.com/zhang2014))。
* 修复了在表被并发重命名时，`DROP TABLE IF EXISTS` 操作因报错 `Table ... does not exist` 而失败的问题（针对 Atomic 数据库引擎）。修复了在对多个表并发执行某些 DDL 查询（例如 `DROP DATABASE` 和 `RENAME TABLE`）时可能出现的罕见死锁问题。修复了在并发执行 `DROP/DETACH TABLE` 时，`DROP/DETACH DATABASE` 操作因报错 `Table ... does not exist` 而失败的问题。 [#15934](https://github.com/ClickHouse/ClickHouse/pull/15934) ([tavplubix](https://github.com/tavplubix))。
* 修复在从 `Distributed` 表查询且查询包含 `WHERE`、`PREWHERE` 和 `GLOBAL IN` 时，错误返回空结果的问题。修复了 [#15792](https://github.com/ClickHouse/ClickHouse/issues/15792)。[#15933](https://github.com/ClickHouse/ClickHouse/pull/15933)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复 RBAC 中可能出现的死锁。[#15875](https://github.com/ClickHouse/ClickHouse/pull/15875) （[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复在执行 `ALTER MODIFY COLUMN` 查询之后运行的 `SELECT ... ORDER BY DESC` 查询中出现的 `Block structure mismatch` 异常。修复 [#15800](https://github.com/ClickHouse/ClickHouse/issues/15800)。[#15852](https://github.com/ClickHouse/ClickHouse/pull/15852)（[alesapin](https://github.com/alesapin)）。
* 修复 MaterializeMySQL 中 `select count()` 结果不准确的问题。 [#15767](https://github.com/ClickHouse/ClickHouse/pull/15767) ([tavplubix](https://github.com/tavplubix)).
* 修复了一些仅选择虚拟列的查询。在此前的版本中，这类查询可能会抛出 `Not found column _nothing in block` 异常。修复了 [#12298](https://github.com/ClickHouse/ClickHouse/issues/12298)。[#15756](https://github.com/ClickHouse/ClickHouse/pull/15756)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复了 `max_replicated_logs_to_keep` 默认值过低的问题，该问题可能会导致副本过于频繁地被标记为丢失。通过选择最新的副本进行克隆来改进丢失副本的恢复流程。同时，不再从丢失的副本中删除旧的 part，而是将其分离。[#15701](https://github.com/ClickHouse/ClickHouse/pull/15701) ([tavplubix](https://github.com/tavplubix))。
* 修复在从与目标表结构不同的 `Buffer` 表读取数据时出现的错误 `Cannot add simple transform to empty Pipe`。该错误会在目标表对查询返回空结果时出现。修复了 [#15529](https://github.com/ClickHouse/ClickHouse/issues/15529)。[#15662](https://github.com/ClickHouse/ClickHouse/pull/15662)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了 `S3` 表函数中使用通配符时的错误：来自 URL 的 `region` 未应用到 `S3` 客户端配置。[#15646](https://github.com/ClickHouse/ClickHouse/pull/15646)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* 在分离只读表时对 `ReadonlyReplica` 指标进行递减操作。修复了 [#15598](https://github.com/ClickHouse/ClickHouse/issues/15598)。[#15592](https://github.com/ClickHouse/ClickHouse/pull/15592)（[sundyli](https://github.com/sundy-li)）。
* 当仅向 ReplicatedMergeTree 传递一个参数时抛出错误，而不再忽略该参数。[#15516](https://github.com/ClickHouse/ClickHouse/pull/15516) ([nvartolomei](https://github.com/nvartolomei))。

#### 改进 {#improvement-6}

- 现在允许执行 `ALTER ... ON CLUSTER` 查询,不受集群配置中 `<internal_replication>` 设置的影响。[#16075](https://github.com/ClickHouse/ClickHouse/pull/16075) ([alesapin](https://github.com/alesapin)).
- 在创建表时展开 `ReplicatedMergeTree` 参数中的 `{database}`、`{table}` 和 `{uuid}` 宏。[#16160](https://github.com/ClickHouse/ClickHouse/pull/16160) ([tavplubix](https://github.com/tavplubix)).

### ClickHouse 版本 v20.9.3.45-stable (2020-10-09) {#clickhouse-release-v209345-stable-2020-10-09}

#### 错误修复 {#bug-fix-14}


* 修复在向 `MATERIALIZED VIEW` 插入数据时，若该 `MV` 的查询包含 `ARRAY JOIN`，可能出现的 `Cannot find column` 错误。 [#15717](https://github.com/ClickHouse/ClickHouse/pull/15717) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复 AMQP-CPP 中的竞争状态。 [#15667](https://github.com/ClickHouse/ClickHouse/pull/15667) ([alesapin](https://github.com/alesapin)).
* 修复查询计划中 `ReadFromStorage` 步骤中资源的销毁顺序。在极少数情况下，这可能会导致崩溃。可能与 [#15610](https://github.com/ClickHouse/ClickHouse/issues/15610) 有关。[#15645](https://github.com/ClickHouse/ClickHouse/pull/15645)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在 `VALUES`、`LIMIT` 或 `IN` 运算符右侧中使用 `JSON*` 函数结果时出现的 `Element ... is not a constant expression` 错误。[#15589](https://github.com/ClickHouse/ClickHouse/pull/15589) ([tavplubix](https://github.com/tavplubix)).
* 避免出现错误信息 `Could not calculate available disk space (statvfs), errno: 4, strerror: Interrupted system call`。修复了 [#15541](https://github.com/ClickHouse/ClickHouse/issues/15541)。[#15557](https://github.com/ClickHouse/ClickHouse/pull/15557)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 AggregatingInOrderTransform/optimize&#95;aggregation&#95;in&#95;order 中显著降低内存使用量。[#15543](https://github.com/ClickHouse/ClickHouse/pull/15543) ([Azat Khuzhin](https://github.com/azat)).
* 在执行 `MOVE` 或 `REPLACE PARTITION` 之后，或者在极少数情况下执行 `DETACH` 或 `DROP PARTITION` 之后，`Mutation` 可能会因为等待某个不存在的 part 而一直挂起。该问题已修复。[#15537](https://github.com/ClickHouse/ClickHouse/pull/15537) ([tavplubix](https://github.com/tavplubix))。
* 修复了一个错误：在执行使用相同模式的 `LIKE` 之后，`ILIKE` 运算符不再保持不区分大小写的行为。 [#15536](https://github.com/ClickHouse/ClickHouse/pull/15536) ([alesapin](https://github.com/alesapin)).
* 修复在查询数据中不存在的列时出现的 `Missing columns` 错误，这些列依赖的其他列也同样不存在于数据中。修复了 [#15530](https://github.com/ClickHouse/ClickHouse/issues/15530)。[#15532](https://github.com/ClickHouse/ClickHouse/pull/15532)（[alesapin](https://github.com/alesapin)）。
* 修复 `DDLWorker` 中事件订阅的一个错误，该错误在极少数情况下可能导致 `ON CLUSTER` 查询挂起。该问题引入于 [#13450](https://github.com/ClickHouse/ClickHouse/issues/13450)。[#15477](https://github.com/ClickHouse/ClickHouse/pull/15477)（[alesapin](https://github.com/alesapin)）。
* 当 `boundingRatio` 聚合函数的第二个参数类型不正确时，报告正确的错误。 [#15407](https://github.com/ClickHouse/ClickHouse/pull/15407) ([detailyang](https://github.com/detailyang))。
* 修复了在执行类似 `SELECT toStartOfDay(today())` 的查询时，由于 `time_zone` 参数为空而导致报错的问题。 [#15319](https://github.com/ClickHouse/ClickHouse/pull/15319) ([Bharat Nallan](https://github.com/bharatnc))。
* 修复在重命名 MergeTree 表与后台清理过程中出现的竞态条件。[#15304](https://github.com/ClickHouse/ClickHouse/pull/15304) ([alesapin](https://github.com/alesapin)).
* 修复在启用 system.logs 时，服务器启动过程中出现的罕见竞争条件。[#15300](https://github.com/ClickHouse/ClickHouse/pull/15300) ([alesapin](https://github.com/alesapin)).
* 修复 QueryLog 中的 MSan 报告问题：字段 `memory_usage` 可能会使用未初始化的内存。[#15258](https://github.com/ClickHouse/ClickHouse/pull/15258) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复在使用 `joinGet` 搭配 `LowCardinality` 类型时导致实例崩溃的问题。此更改修复了 [#15214](https://github.com/ClickHouse/ClickHouse/issues/15214)。[#15220](https://github.com/ClickHouse/ClickHouse/pull/15220)（[Amos Bird](https://github.com/amosbird)）。
* 修复表引擎 `Buffer` 中的一个错误：在执行 `ALTER` 查询后，无法向 `Buffer` 插入具有新结构的数据。修复了 [#15117](https://github.com/ClickHouse/ClickHouse/issues/15117)。[#15192](https://github.com/ClickHouse/ClickHouse/pull/15192)（[alesapin](https://github.com/alesapin)）。
* 在 MySQL 列定义数据包中调整小数类型字段的精度大小。 [#15152](https://github.com/ClickHouse/ClickHouse/pull/15152) ([maqroll](https://github.com/maqroll)).
* 修复了在 Mac OS 上通过 Docker 运行 clickhouse-server 时，在 Atomic 数据库中执行 DDL 查询会出现的 `Cannot rename ... errno: 22, strerror: Invalid argument` 错误。[#15024](https://github.com/ClickHouse/ClickHouse/pull/15024) ([tavplubix](https://github.com/tavplubix))。
* 修复了当子查询包含 `finalizeAggregation` 函数时谓词下推无法生效的问题。修复了 [#14847](https://github.com/ClickHouse/ClickHouse/issues/14847)。[#14937](https://github.com/ClickHouse/ClickHouse/pull/14937)（[filimonov](https://github.com/filimonov)）。
* 修复了这样一个问题：当需要通过 ZooKeeper 获取配置文件（使用 `from_zk` include 选项）时，服务器在启动过程中可能会卡住。此修复解决了 [#14814](https://github.com/ClickHouse/ClickHouse/issues/14814)。[#14843](https://github.com/ClickHouse/ClickHouse/pull/14843)（[Alexander Kuzmenkov](https://github.com/akuzm)）。

#### 改进 {#improvement-7}

- 现在可以通过 `ALTER` 查询更改 `VersionedCollapsingMergeTree` 的版本列类型。[#15442](https://github.com/ClickHouse/ClickHouse/pull/15442) ([alesapin](https://github.com/alesapin))。

### ClickHouse 版本 v20.9.2.20, 2020-09-22 {#clickhouse-release-v209220-2020-09-22}

#### 不向后兼容的变更 {#backward-incompatible-change-3}

- 从 20.5 之前的版本升级时,如果执行滚动更新且集群同时包含 20.5 或更高版本以及低于 20.5 的版本,当旧版本的 ClickHouse 节点在存在较新版本的情况下重启并以旧版本启动时,可能会导致 `Part ... intersects previous part` 错误。为防止此错误,请先在所有集群节点上安装较新的 clickhouse-server 软件包,然后再执行重启(这样,当 clickhouse-server 重启时,将以新版本启动)。

#### 新功能 {#new-feature-3}

- 新增列转换器 `EXCEPT`、`REPLACE`、`APPLY`,可应用于选定的列列表(`*` 或 `COLUMNS(...)` 之后)。例如,可以编写 `SELECT * EXCEPT(URL) REPLACE(number + 1 AS number)`。另一个示例:`select * apply(length) apply(max) from wide_string_table` 用于查找所有字符串列的最大长度。[#14233](https://github.com/ClickHouse/ClickHouse/pull/14233) ([Amos Bird](https://github.com/amosbird))。
- 新增聚合函数 `rankCorr`,用于计算秩相关系数。[#11769](https://github.com/ClickHouse/ClickHouse/pull/11769) ([antikvist](https://github.com/antikvist)) [#14411](https://github.com/ClickHouse/ClickHouse/pull/14411) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 新增表函数 `view`,可将子查询转换为表对象。这有助于传递查询。例如,可以在 remote/cluster 表函数中使用。[#12567](https://github.com/ClickHouse/ClickHouse/pull/12567) ([Amos Bird](https://github.com/amosbird))。

#### 错误修复 {#bug-fix-15}


* 修复在 `ALTER UPDATE` 变更中，当赋值表达式中包含 `Nullable` 列且使用常量值（例如 `UPDATE x = 42`）时，可能导致列值错误或发生段错误的 bug。修复了 [#13634](https://github.com/ClickHouse/ClickHouse/issues/13634)、[#14045](https://github.com/ClickHouse/ClickHouse/issues/14045)。[#14646](https://github.com/ClickHouse/ClickHouse/pull/14646)（[alesapin](https://github.com/alesapin)）。
* 修复因结果列的小数精度错误导致的 `Decimal` 乘法结果不正确的问题。[#14603](https://github.com/ClickHouse/ClickHouse/pull/14603) ([Artem Zuikov](https://github.com/4ertus2)).
* 修复了 `Nullable` 列排序顺序不正确的问题。此更改修复了 [#14344](https://github.com/ClickHouse/ClickHouse/issues/14344)。[#14495](https://github.com/ClickHouse/ClickHouse/pull/14495) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 修复了在索引分析中，当主键类型为 `FixedString` 且与更短的字符串进行比较时比较行为不一致的问题。此修复解决了 [#14908](https://github.com/ClickHouse/ClickHouse/issues/14908)。[#15033](https://github.com/ClickHouse/ClickHouse/pull/15033)（[Amos Bird](https://github.com/amosbird)）。
* 修复了在表包含仅有单个 part 的分区时会导致错误合并分配的 bug。[#14444](https://github.com/ClickHouse/ClickHouse/pull/14444) ([alesapin](https://github.com/alesapin))。
* 如果使用特意构造的参数调用函数 `bar`，可能会发生缓冲区溢出。此修复关闭了 [#13926](https://github.com/ClickHouse/ClickHouse/issues/13926)。[#15028](https://github.com/ClickHouse/ClickHouse/pull/15028)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 `system.asynchronous_metrics` 中按逻辑核心公开 CPU 频率。此更改修复了 [#14923](https://github.com/ClickHouse/ClickHouse/issues/14923)。[#14924](https://github.com/ClickHouse/ClickHouse/pull/14924)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* 修复在使用 `MaterializeMySQL` 数据库引擎时出现的 `.metadata.tmp File exists` 错误。[#14898](https://github.com/ClickHouse/ClickHouse/pull/14898) ([Winter Zhang](https://github.com/zhang2014))。
* 修复了在某些调用 `extractAllGroups` 函数时可能触发 “Memory limit exceeded” 错误的问题。此修复对应 [#13383](https://github.com/ClickHouse/ClickHouse/issues/13383)。[#14889](https://github.com/ClickHouse/ClickHouse/pull/14889)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在尝试向 StorageFile(fd) 执行 INSERT 时出现的 SIGSEGV。 [#14887](https://github.com/ClickHouse/ClickHouse/pull/14887) ([Azat Khuzhin](https://github.com/azat))。
* 修复 `SELECT` 查询中的一个罕见错误：当被查询的列带有依赖于另一列的 `DEFAULT` 表达式，而该另一列同样带有 `DEFAULT`，且既未出现在 `SELECT` 查询中也未在磁盘上存在时，会触发该错误。部分修复 [#14531](https://github.com/ClickHouse/ClickHouse/issues/14531)。[#14845](https://github.com/ClickHouse/ClickHouse/pull/14845)（[alesapin](https://github.com/alesapin)）。
* 修复对缩窄的带符号类型 `Int -> Int` 转换的错误单调性检测，该问题可能会导致查询结果不正确。该缺陷在 [#14513](https://github.com/ClickHouse/ClickHouse/issues/14513) 中被发现。[#14783](https://github.com/ClickHouse/ClickHouse/pull/14783)（[Amos Bird](https://github.com/amosbird)）。
* 修复在执行 `ALTER ... MODIFY QUERY` 时，物化视图元数据中遗漏默认数据库名称的问题。[#14664](https://github.com/ClickHouse/ClickHouse/pull/14664) ([tavplubix](https://github.com/tavplubix)).
* 修复在涉及 `LowCardinality` 和 `Nullable` 类型时，`has` 函数可能返回错误结果的问题。 [#14591](https://github.com/ClickHouse/ClickHouse/pull/14591) ([Mike](https://github.com/myrrc)).
* 在对使用 ReplicatedMergeTree 引擎的表执行 `CREATE` 查询时，如果发生 Zookeeper 异常，则清理数据目录。[#14563](https://github.com/ClickHouse/ClickHouse/pull/14563)（[Bharat Nallan](https://github.com/bharatnc)）。
* 修复了在带有组合器 `-Resample` 的函数中出现的罕见段错误问题，该问题可能在使用非常大的参数导致溢出时触发。 [#14562](https://github.com/ClickHouse/ClickHouse/pull/14562) ([Anton Popov](https://github.com/CurtizJ)).
* 在 `topK` 聚合函数中检查数组大小是否溢出。如果没有此检查，用户可以发送带有精心构造参数的查询，从而导致服务器崩溃。此更改修复了 [#14452](https://github.com/ClickHouse/ClickHouse/issues/14452)。[#14467](https://github.com/ClickHouse/ClickHouse/pull/14467)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 如果使用 systemd，则为 SysVinit 的 restart/start/stop/reload 操作提供到 systemd 的代理支持。 [#14460](https://github.com/ClickHouse/ClickHouse/pull/14460) ([Azat Khuzhin](https://github.com/azat)).
* 如果在 `PipelineExecutor` 本身发生异常，则停止查询执行。这可以防止在极少数情况下查询出现挂起问题。[#14334](https://github.com/ClickHouse/ClickHouse/pull/14334) [#14402](https://github.com/ClickHouse/ClickHouse/pull/14402) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了对通过 `AS table_function` 创建的表执行 `ALTER` 查询时发生的崩溃。修复了 [#14212](https://github.com/ClickHouse/ClickHouse/issues/14212)。[#14326](https://github.com/ClickHouse/ClickHouse/pull/14326)（[alesapin](https://github.com/alesapin)）。
* 修复在使用 `REFRESH` 命令的 `ALTER LIVE VIEW` 查询时出现的异常。`LIVE VIEW` 是一项实验性特性。[#14320](https://github.com/ClickHouse/ClickHouse/pull/14320) ([Bharat Nallan](https://github.com/bharatnc))。
* 修复在带有嵌套解释器的查询中 `EXPLAIN PIPELINE graph=1` 的 `QueryPlan` 生命周期。[#14315](https://github.com/ClickHouse/ClickHouse/pull/14315) ([Azat Khuzhin](https://github.com/azat))。
* 在 SSD 缓存的复杂键外部字典中更完善地检查 `tuple` 大小。修复了 [#13981](https://github.com/ClickHouse/ClickHouse/issues/13981)。[#14313](https://github.com/ClickHouse/ClickHouse/pull/14313)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 不允许在 `ALIAS` 列类型上使用 `CODEC`。修复 [#13911](https://github.com/ClickHouse/ClickHouse/issues/13911)。[#14263](https://github.com/ClickHouse/ClickHouse/pull/14263)（[Bharat Nallan](https://github.com/bharatnc)）。
* 修复在非全局级别执行时的 `GRANT ALL` 语句的问题。[#13987](https://github.com/ClickHouse/ClickHouse/pull/13987) ([Vitaly Baranov](https://github.com/vitlibar))。
* 修复在 `lambda` 中捕获 `arrayJoin()` 时的问题（此前会抛出带有逻辑错误信息的异常）。 [#13792](https://github.com/ClickHouse/ClickHouse/pull/13792) ([Azat Khuzhin](https://github.com/azat)).

#### 实验性功能 {#experimental-feature-2}

- 新增 `db-generator` 工具,可根据给定的 SELECT 查询生成随机数据库。当用户仅提供不完整的错误报告时,该工具有助于重现问题。[#14442](https://github.com/ClickHouse/ClickHouse/pull/14442) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)) [#10973](https://github.com/ClickHouse/ClickHouse/issues/10973) ([ZeDRoman](https://github.com/ZeDRoman))。

#### 改进 {#improvement-8}

- 允许在 Distributed 存储引擎中使用多卷存储配置。[#14839](https://github.com/ClickHouse/ClickHouse/pull/14839) ([Pavel Kovalenko](https://github.com/Jokser))。
- 禁止在 `toStartOf*` 类型的函数中使用空的 time_zone 参数。[#14509](https://github.com/ClickHouse/ClickHouse/pull/14509) ([Bharat Nallan](https://github.com/bharatnc))。
- MySQL 处理器对 `SET @@var = value` 类型的查询返回 `OK`。此类语句会被忽略。这是必需的,因为某些 MySQL 驱动程序在握手后会发送 `SET @@` 查询进行设置 https://github.com/ClickHouse/ClickHouse/issues/9336#issuecomment-686222422 。[#14469](https://github.com/ClickHouse/ClickHouse/pull/14469) ([BohuTANG](https://github.com/BohuTANG))。
- 现在,如果 TTL 之前未被物化,将在合并期间应用。[#14438](https://github.com/ClickHouse/ClickHouse/pull/14438) ([alesapin](https://github.com/alesapin))。
- 现在 `clickhouse-obfuscator` 支持 UUID 类型,如 [#13163](https://github.com/ClickHouse/ClickHouse/issues/13163) 中所提议。[#14409](https://github.com/ClickHouse/ClickHouse/pull/14409) ([dimarub2000](https://github.com/dimarub2000))。
- 新增设置 `system_events_show_zero_values`,如 [#11384](https://github.com/ClickHouse/ClickHouse/issues/11384) 中所提议。[#14404](https://github.com/ClickHouse/ClickHouse/pull/14404) ([dimarub2000](https://github.com/dimarub2000))。
- 在 `MaterializeMySQL` 中隐式将主键转换为非空(与 `MySQL` 相同)。修复 [#14114](https://github.com/ClickHouse/ClickHouse/issues/14114)。[#14397](https://github.com/ClickHouse/ClickHouse/pull/14397) ([Winter Zhang](https://github.com/zhang2014))。
- 将 boost multiprecision 的宽整数(256 位)替换为 https://github.com/cerevra/int 的实现。256 位整数为实验性功能。[#14229](https://github.com/ClickHouse/ClickHouse/pull/14229) ([Artem Zuikov](https://github.com/4ertus2))。
- 在 `system.part_log` 中为数据分片添加默认压缩编解码器,名称为 `default_compression_codec`。[#14116](https://github.com/ClickHouse/ClickHouse/pull/14116) ([alesapin](https://github.com/alesapin))。
- 为 `DateTime` 类型添加精度参数。这允许使用 `DateTime` 名称代替 `DateTime64`。[#13761](https://github.com/ClickHouse/ClickHouse/pull/13761) ([Winter Zhang](https://github.com/zhang2014))。
- 为 `Redis` 外部字典添加 requirepass 授权。[#13688](https://github.com/ClickHouse/ClickHouse/pull/13688) ([Ivan Torgashov](https://github.com/it1804))。
- `RabbitMQ` 引擎改进:新增连接和通道故障处理、正确的提交、插入失败处理、更好的交换器、队列持久性和队列恢复功能、新的队列设置。修复了测试。[#12761](https://github.com/ClickHouse/ClickHouse/pull/12761) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 支持在紧凑型数据分片中使用自定义编解码器。[#12183](https://github.com/ClickHouse/ClickHouse/pull/12183) ([Anton Popov](https://github.com/CurtizJ))。

#### 性能改进 {#performance-improvement-4}


- 在 `optimize_skip_unused_shards` 和 `optimize_distributed_group_by_sharding_key` 设置下,优化分布式查询中带有 GROUP BY sharding_key 的 LIMIT/LIMIT BY/ORDER BY。[#10373](https://github.com/ClickHouse/ClickHouse/pull/10373) ([Azat Khuzhin](https://github.com/azat))。
- 并行创建多个 `JOIN` 和 `IN` 的集合。对于包含多个不同 `IN subquery` 表达式的查询,这可能会略微提升性能。[#14412](https://github.com/ClickHouse/ClickHouse/pull/14412) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 通过为每个消费者提供独立线程来提升 Kafka 引擎性能。为流式引擎(如 Kafka)提供单独的线程池。[#13939](https://github.com/ClickHouse/ClickHouse/pull/13939) ([fastio](https://github.com/fastio))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-6}

- 通过从 `Functions` 中移除调试信息来降低调试构建的二进制文件大小。这仅用于 Yandex 内部一个使用非常旧的链接器的项目。[#14549](https://github.com/ClickHouse/ClickHouse/pull/14549) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 为使用 clang 11 构建做准备。[#14455](https://github.com/ClickHouse/ClickHouse/pull/14455) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 修复回溯脚本中的逻辑。在之前的版本中,它会对任何 100% 红色的标签触发。这很奇怪。[#14433](https://github.com/ClickHouse/ClickHouse/pull/14433) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 集成测试使用默认基础配置。所有配置更改都通过实例的 main_configs、user_configs 和 dictionaries 参数显式指定。[#13647](https://github.com/ClickHouse/ClickHouse/pull/13647) ([Ilya Yatsishin](https://github.com/qoega))。


## ClickHouse 版本 20.8 {#clickhouse-release-208}

### ClickHouse 版本 v20.8.12.2-lts, 2021-01-16 {#clickhouse-release-v208122-lts-2021-01-16}

#### 错误修复 {#bug-fix-16}

- 修复 \*If 组合器在使用一元函数和 Nullable 类型时的问题。[#18806](https://github.com/ClickHouse/ClickHouse/pull/18806) ([Azat Khuzhin](https://github.com/azat))。
- 限制从宽格式到紧凑格式数据分区的合并。在垂直合并的情况下会导致结果分区损坏。[#18381](https://github.com/ClickHouse/ClickHouse/pull/18381) ([Anton Popov](https://github.com/CurtizJ))。

### ClickHouse 版本 v20.8.11.17-lts, 2020-12-25 {#clickhouse-release-v2081117-lts-2020-12-25}

#### 错误修复 {#bug-fix-17}

- 在合并期间禁用 AIO 写入,因为这可能导致合并过程中主键列发生极其罕见的数据损坏。[#18481](https://github.com/ClickHouse/ClickHouse/pull/18481) ([alesapin](https://github.com/alesapin))。
- 修复了执行 `toType(...)` 函数(如 `toDate`、`toUInt32` 等)时,当参数类型为 `Nullable(String)` 时出现的 `value is too short` 错误。现在这些函数在解析错误时返回 `NULL` 而不是抛出异常。修复 [#7673](https://github.com/ClickHouse/ClickHouse/issues/7673)。[#18445](https://github.com/ClickHouse/ClickHouse/pull/18445) ([tavplubix](https://github.com/tavplubix))。
- 修复在使用两级聚合时,带有 `Distinct` 组合器的聚合函数可能发生崩溃的问题。修复 [#17682](https://github.com/ClickHouse/ClickHouse/issues/17682)。[#18365](https://github.com/ClickHouse/ClickHouse/pull/18365) ([Anton Popov](https://github.com/CurtizJ))。

### ClickHouse 版本 v20.8.10.13-lts, 2020-12-24 {#clickhouse-release-v2081013-lts-2020-12-24}

#### 错误修复 {#bug-fix-18}


* 当使用数值大于 2^32 的 `logger.size` 参数配置服务器日志轮转时，日志不会被正确轮转。[#17905](https://github.com/ClickHouse/ClickHouse/pull/17905) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* 修复了在 MergeTreeWriterSettings 中将 `max_compress_block_size` 错误初始化为 `min_compress_block_size` 的问题。[#17833](https://github.com/ClickHouse/ClickHouse/pull/17833) ([flynn](https://github.com/ucasFL))。
* 修复了 ClickHouse 无法重新恢复与 MySQL 服务器连接的问题。[#17681](https://github.com/ClickHouse/ClickHouse/pull/17681)（[Alexander Kazakov](https://github.com/Akazz)）。
* 修复了在对应的 mutation 在另一副本上被 kill 时，`ALTER` 查询会挂起的问题。修复了 [#16953](https://github.com/ClickHouse/ClickHouse/issues/16953)。 [#17499](https://github.com/ClickHouse/ClickHouse/pull/17499) ([alesapin](https://github.com/alesapin))。
* 修复了 ClickHouse 低估标记缓存（mark cache）大小的错误。当存在大量包含标记的小文件时，可能会出现这种情况。[#17496](https://github.com/ClickHouse/ClickHouse/pull/17496) ([alesapin](https://github.com/alesapin)).
* 修复在启用设置 `optimize_redundant_functions_in_order_by` 时 `ORDER BY` 的问题。 [#17471](https://github.com/ClickHouse/ClickHouse/pull/17471) ([Anton Popov](https://github.com/CurtizJ))。
* 修复了导致崩溃的 `ColumnConst` 比较问题。此修复解决了 [#17088](https://github.com/ClickHouse/ClickHouse/issues/17088)。[#17135](https://github.com/ClickHouse/ClickHouse/pull/17135)（[Amos Bird](https://github.com/amosbird)）。
* 修复了一个错误：针对非主节点 `ReplicatedMergeTreeTables` 执行的 `ON CLUSTER` 查询可能会一直挂起。 [#17089](https://github.com/ClickHouse/ClickHouse/pull/17089) ([alesapin](https://github.com/alesapin)).
* 避免对在执行过程中可能被取消的远程查询（例如带有 `LIMIT` 的查询）产生不必要的网络错误。[#17006](https://github.com/ClickHouse/ClickHouse/pull/17006)（[Azat Khuzhin](https://github.com/azat)）。
* 在发生错误时重新解析 `format_avro_schema_registry_url` 的 IP 地址。[#16985](https://github.com/ClickHouse/ClickHouse/pull/16985) ([filimonov](https://github.com/filimonov))。
* 修复了在执行 `ALTER TABLE ... MODIFY COLUMN ... NewType` 时，如果有针对正在被修改列并带有 `WHERE` 表达式的 `SELECT` 查询且 `ALTER` 尚未完成，可能导致服务器崩溃的问题。 [#16968](https://github.com/ClickHouse/ClickHouse/pull/16968) ([Amos Bird](https://github.com/amosbird))。
* 安装脚本现在应始终在配置目录中创建子目录。这仅与使用自定义配置的 Docker 构建有关。[#16936](https://github.com/ClickHouse/ClickHouse/pull/16936) ([filimonov](https://github.com/filimonov))。
* 修复了在带有 `ORDER BY` 的查询中可能出现的 `Illegal type of argument` 错误，对应修复了 [#16580](https://github.com/ClickHouse/ClickHouse/issues/16580)。[#16928](https://github.com/ClickHouse/ClickHouse/pull/16928)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 如果没有向 WriteBufferFromS3 写入任何数据，则终止分段上传。 [#16840](https://github.com/ClickHouse/ClickHouse/pull/16840) ([Pavel Kovalenko](https://github.com/Jokser)).
* 修复了在不带任何参数使用 `any` 时发生的崩溃。修复了 [#16803](https://github.com/ClickHouse/ClickHouse/issues/16803)。[#16826](https://github.com/ClickHouse/ClickHouse/pull/16826)（[Amos Bird](https://github.com/amosbird)）。
* 修复了在启用 `transform_null_in` 设置时，应用于多列和元组的 `IN` 运算符的问题。修复了 [#15310](https://github.com/ClickHouse/ClickHouse/issues/15310)。[#16722](https://github.com/ClickHouse/ClickHouse/pull/16722)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复了在 `max_threads > 0` 且 `ORDER BY` 中包含表达式时，`optimize_read_in_order/optimize_aggregation_in_order` 行为不一致的问题。 [#16637](https://github.com/ClickHouse/ClickHouse/pull/16637) ([Azat Khuzhin](https://github.com/azat)).
* 修复了一个问题：当查询包含 `ARRAY JOIN` 时，查询优化会产生错误结果。 [#17887](https://github.com/ClickHouse/ClickHouse/pull/17887) ([sundyli](https://github.com/sundy-li))。
* 在发生异常时，查询会更快结束。如果出现异常，将取消在远程副本上的执行。[#15578](https://github.com/ClickHouse/ClickHouse/pull/15578) ([Azat Khuzhin](https://github.com/azat))。

### ClickHouse release v20.8.6.6-lts, 2020-11-13 {#clickhouse-release-v20866-lts-2020-11-13}

#### Bug Fix {#bug-fix-19}

- 修复了当查询分析器开启且 ClickHouse 安装在使用某些 glibc 版本（这些版本的某些函数的异步展开表可能已损坏）的操作系统上时，偶尔发生的静默崩溃问题。此修复解决了 [#15301](https://github.com/ClickHouse/ClickHouse/issues/15301)。此修复解决了 [#13098](https://github.com/ClickHouse/ClickHouse/issues/13098)。[#16846](https://github.com/ClickHouse/ClickHouse/pull/16846) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 现在从输入解析 AVRO 时，会从类型中移除 LowCardinality。修复了 [#16188](https://github.com/ClickHouse/ClickHouse/issues/16188)。[#16521](https://github.com/ClickHouse/ClickHouse/pull/16521) ([Mike](https://github.com/myrrc))。
- 修复了在使用 MySQL Master -> MySQL Slave -> ClickHouse MaterializeMySQL 引擎且 MySQL Slave 上启用了 `slave_parallel_worker` 时，通过正确收缩 GTID 集合来解决元数据快速增长的问题。此修复解决了 [#15951](https://github.com/ClickHouse/ClickHouse/issues/15951)。[#16504](https://github.com/ClickHouse/ClickHouse/pull/16504) ([TCeason](https://github.com/TCeason))。
- 修复了 Distributed 表的 DROP TABLE 操作（与 INSERT 存在竞态条件）。[#16409](https://github.com/ClickHouse/ClickHouse/pull/16409) ([Azat Khuzhin](https://github.com/azat))。
- 修复了复制队列中超大条目的处理问题。当表结构极大（接近 1 MB）时，ALTER 查询中可能会出现超大条目。此修复解决了 [#16307](https://github.com/ClickHouse/ClickHouse/issues/16307)。[#16332](https://github.com/ClickHouse/ClickHouse/pull/16332) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 修复了由于未创建过滤集合而导致部分返回数据可能被丢弃的不一致行为。[#16308](https://github.com/ClickHouse/ClickHouse/pull/16308) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 修复了 MySQL 数据库的错误。当用作数据库引擎的 MySQL 服务器宕机时，某些查询会引发异常，因为它们尝试从已禁用的服务器获取表，而这是不必要的。例如，查询 `SELECT ... FROM system.parts` 应该仅适用于 MergeTree 表，完全不应涉及 MySQL 数据库。[#16032](https://github.com/ClickHouse/ClickHouse/pull/16032) ([Kruglov Pavel](https://github.com/Avogar))。

### ClickHouse release v20.8.5.45-lts, 2020-10-29 {#clickhouse-release-v208545-lts-2020-10-29}

#### Bug Fix {#bug-fix-20}


* 修复在函数 `dictGet` 中出现异常时的双重释放问题。如果字典在加载时发生错误，可能会触发该问题。[#16429](https://github.com/ClickHouse/ClickHouse/pull/16429) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复在使用 `totals`/`rollup`/`cube` 修饰符并对 `GROUP BY` 键应用 `min`/`max` 函数时的 `GROUP BY` 行为。修复了 [#16393](https://github.com/ClickHouse/ClickHouse/issues/16393)。[#16397](https://github.com/ClickHouse/ClickHouse/pull/16397)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复在 `prefer_localhost_replica=0` 且使用内部复制时异步 Distributed `INSERT` 的问题。 [#16358](https://github.com/ClickHouse/ClickHouse/pull/16358) ([Azat Khuzhin](https://github.com/azat)).
* 修复在使用字符串键进行 `GROUP BY` 时可能出现的内存泄漏问题，该问题是由 `TwoLevelStringHashTable` 实现中的错误引起的。[#16264](https://github.com/ClickHouse/ClickHouse/pull/16264)（[Amos Bird](https://github.com/amosbird)）。
* 修复了一个在不考虑限制的情况下可能导致内存被过度分配的问题。修复了 [#14560](https://github.com/ClickHouse/ClickHouse/issues/14560)。[#16206](https://github.com/ClickHouse/ClickHouse/pull/16206)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在 `ReplicatedVersionedCollapsingMergeTree` 中执行 `ALTER MODIFY ... ORDER BY` 查询时出现的挂起问题。修复了 [#15980](https://github.com/ClickHouse/ClickHouse/issues/15980)。[#16011](https://github.com/ClickHouse/ClickHouse/pull/16011)（[alesapin](https://github.com/alesapin)）。
* 修复 `collate` 名称和字符集名称的解析器，并为字符串类型支持 `length = 0`。 [#16008](https://github.com/ClickHouse/ClickHouse/pull/16008) ([Winter Zhang](https://github.com/zhang2014)).
* 允许在具有复杂键的字典中使用直接布局。 [#16007](https://github.com/ClickHouse/ClickHouse/pull/16007) ([Anton Popov](https://github.com/CurtizJ)).
* 在一段时间无活动后出现复制错误时，避免副本挂起 5–10 分钟。 [#15987](https://github.com/ClickHouse/ClickHouse/pull/15987) ([filimonov](https://github.com/filimonov)).
* 修复在向 MaterializedView 插入数据或从中查询的同时并发删除其目标表（针对 Atomic 数据库引擎）时可能发生的罕见段错误。 [#15984](https://github.com/ClickHouse/ClickHouse/pull/15984) ([tavplubix](https://github.com/tavplubix)).
* 修复了解析设置配置文件时的歧义：`CREATE USER ... SETTINGS profile readonly` 现在被视为使用名为 `readonly` 的配置文件，而不是名为 `profile` 且带有 readonly 约束的设置。此更改修复了 [#15628](https://github.com/ClickHouse/ClickHouse/issues/15628)。[#15982](https://github.com/ClickHouse/ClickHouse/pull/15982)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复在创建数据库失败时发生的崩溃。 [#15954](https://github.com/ClickHouse/ClickHouse/pull/15954) ([Winter Zhang](https://github.com/zhang2014)).
* 修复了在表被并发重命名时（针对 Atomic 数据库引擎），`DROP TABLE IF EXISTS` 失败并报错 `Table ... does not exist` 的问题。修复了在对多个表并发执行某些 DDL 查询（例如 `DROP DATABASE` 和 `RENAME TABLE`）时出现的罕见死锁问题。修复了在并发执行 `DROP/DETACH TABLE` 时，`DROP/DETACH DATABASE` 因报错 `Table ... does not exist` 而失败的问题。[#15934](https://github.com/ClickHouse/ClickHouse/pull/15934) ([tavplubix](https://github.com/tavplubix))。
* 修复从 `Distributed` 表查询且包含 `WHERE`、`PREWHERE` 和 `GLOBAL IN` 时错误返回空结果的问题。修复了 [#15792](https://github.com/ClickHouse/ClickHouse/issues/15792)。[#15933](https://github.com/ClickHouse/ClickHouse/pull/15933)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复 RBAC 中可能出现的死锁。 [#15875](https://github.com/ClickHouse/ClickHouse/pull/15875) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复在执行 `ALTER MODIFY COLUMN` 查询之后运行的 `SELECT ... ORDER BY DESC` 查询中出现的 `Block structure mismatch` 异常。修复 [#15800](https://github.com/ClickHouse/ClickHouse/issues/15800)。[#15852](https://github.com/ClickHouse/ClickHouse/pull/15852) ([alesapin](https://github.com/alesapin))。
* 修复了一些仅选择虚拟列的查询情况。此前可能会抛出 `Not found column _nothing in block` 异常。修复了 [#12298](https://github.com/ClickHouse/ClickHouse/issues/12298)。[#15756](https://github.com/ClickHouse/ClickHouse/pull/15756)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复在向 `MATERIALIZED VIEW` 插入数据时，如果用于 `MV` 的查询包含 `ARRAY JOIN`，可能出现的 `Cannot find column` 错误。[#15717](https://github.com/ClickHouse/ClickHouse/pull/15717) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了 `max_replicated_logs_to_keep` 设置默认值过低的问题，该问题可能会导致副本过于频繁地变为丢失状态。通过选择最新的副本进行克隆，改进了丢失副本的恢复过程。同时不再从丢失的副本中删除旧的数据部分，而是将其分离（detach）。[#15701](https://github.com/ClickHouse/ClickHouse/pull/15701) ([tavplubix](https://github.com/tavplubix))。
* 修复了在从结构与目标表不同的 `Buffer` 表读取数据时出现的错误 `Cannot add simple transform to empty Pipe`。当目标表对查询返回空结果时，会触发该问题。修复了 [#15529](https://github.com/ClickHouse/ClickHouse/issues/15529)。[#15662](https://github.com/ClickHouse/ClickHouse/pull/15662)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了 `S3` 表函数中使用通配符时的错误：来自 URL 的区域没有应用到 `S3` 客户端配置中。[#15646](https://github.com/ClickHouse/ClickHouse/pull/15646)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* 在分离只读表时将 `ReadonlyReplica` 指标减一。修复了 [#15598](https://github.com/ClickHouse/ClickHouse/issues/15598)。[#15592](https://github.com/ClickHouse/ClickHouse/pull/15592)（[sundyli](https://github.com/sundy-li)）。
* 当仅向 ReplicatedMergeTree 传递一个参数时抛出错误，而不是忽略该参数。[#15516](https://github.com/ClickHouse/ClickHouse/pull/15516) ([nvartolomei](https://github.com/nvartolomei)).

#### 改进 {#improvement-9}

- 现在允许执行 `ALTER ... ON CLUSTER` 查询,不受集群配置中 `<internal_replication>` 设置的影响。[#16075](https://github.com/ClickHouse/ClickHouse/pull/16075) ([alesapin](https://github.com/alesapin)).
- 在创建表时展开 `ReplicatedMergeTree` 参数中的 `{database}`、`{table}` 和 `{uuid}` 宏。[#16159](https://github.com/ClickHouse/ClickHouse/pull/16159) ([tavplubix](https://github.com/tavplubix)).

### ClickHouse 版本 v20.8.4.11-lts, 2020-10-09 {#clickhouse-release-v208411-lts-2020-10-09}

#### 错误修复 {#bug-fix-21}


* 修复查询计划中 `ReadFromStorage` 步骤的资源销毁顺序。在极少数情况下可能会导致崩溃。可能与 [#15610](https://github.com/ClickHouse/ClickHouse/issues/15610) 相关。[#15645](https://github.com/ClickHouse/ClickHouse/pull/15645)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在 `VALUES`、`LIMIT` 或 `IN` 运算符右侧使用 `JSON*` 函数的结果时出现的 `Element ... is not a constant expression` 错误。 [#15589](https://github.com/ClickHouse/ClickHouse/pull/15589) ([tavplubix](https://github.com/tavplubix))。
* 防止出现错误消息 `Could not calculate available disk space (statvfs), errno: 4, strerror: Interrupted system call`。此更改修复了 [#15541](https://github.com/ClickHouse/ClickHouse/issues/15541)。[#15557](https://github.com/ClickHouse/ClickHouse/pull/15557)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 AggregatingInOrderTransform/optimize&#95;aggregation&#95;in&#95;order 中大幅降低内存占用。 [#15543](https://github.com/ClickHouse/ClickHouse/pull/15543) ([Azat Khuzhin](https://github.com/azat)).
* 在执行 `MOVE` 或 `REPLACE PARTITION` 之后，或者在少数情况下执行 `DETACH` 或 `DROP PARTITION` 之后，mutation 可能会因为等待某个不存在的 part 而一直挂起。该问题已修复。[#15537](https://github.com/ClickHouse/ClickHouse/pull/15537) ([tavplubix](https://github.com/tavplubix)).
* 修复了一个错误：在执行使用相同模式的 `LIKE` 之后，`ILIKE` 运算符不再保持不区分大小写。 [#15536](https://github.com/ClickHouse/ClickHouse/pull/15536) ([alesapin](https://github.com/alesapin)).
* 修复在选择数据中不存在的列且这些列依赖的其他列同样不存在时出现的 `Missing columns` 错误。修复了 [#15530](https://github.com/ClickHouse/ClickHouse/issues/15530)。[#15532](https://github.com/ClickHouse/ClickHouse/pull/15532)（[alesapin](https://github.com/alesapin)）。
* 修复 `DDLWorker` 中事件订阅的一个错误，该错误在极少数情况下可能导致 `ON CLUSTER` 查询挂起。此问题由 [#13450](https://github.com/ClickHouse/ClickHouse/issues/13450) 引入。[#15477](https://github.com/ClickHouse/ClickHouse/pull/15477)（[alesapin](https://github.com/alesapin)）。
* 当 `boundingRatio` 聚合函数的第二个参数类型不正确时，正确报告错误。 [#15407](https://github.com/ClickHouse/ClickHouse/pull/15407) ([detailyang](https://github.com/detailyang)).
* 修复在重命名 MergeTree 表和后台清理期间出现的竞态条件。 [#15304](https://github.com/ClickHouse/ClickHouse/pull/15304) ([alesapin](https://github.com/alesapin)).
* 修复在启用 `system.logs` 时服务器启动阶段可能出现的罕见竞争条件。[#15300](https://github.com/ClickHouse/ClickHouse/pull/15300) ([alesapin](https://github.com/alesapin))。
* 修复 QueryLog 中的 MSan 报告。字段 `memory_usage` 可能会使用未初始化内存。[#15258](https://github.com/ClickHouse/ClickHouse/pull/15258) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复在使用 `joinGet` 搭配 `LowCardinality` 类型时导致实例崩溃的问题。此修复解决了 [#15214](https://github.com/ClickHouse/ClickHouse/issues/15214)。[#15220](https://github.com/ClickHouse/ClickHouse/pull/15220)（[Amos Bird](https://github.com/amosbird)）。
* 修复表引擎 `Buffer` 中的一个错误：在执行 `ALTER` 查询后，无法将具有新结构的数据插入到 `Buffer` 中。修复了 [#15117](https://github.com/ClickHouse/ClickHouse/issues/15117)。[#15192](https://github.com/ClickHouse/ClickHouse/pull/15192)（[alesapin](https://github.com/alesapin)）。
* 在 MySQL 列定义数据包中调整 Decimal 字段的精度大小。 [#15152](https://github.com/ClickHouse/ClickHouse/pull/15152) ([maqroll](https://github.com/maqroll)).
* 我们已经在 `String` 和 `FixedString` 之间使用了填充比较（[https://github.com/ClickHouse/ClickHouse/blob/master/src/Functions/FunctionsComparison.h#L333](https://github.com/ClickHouse/ClickHouse/blob/master/src/Functions/FunctionsComparison.h#L333)）。此 PR 将相同逻辑应用到字段比较中，从而修正了将 `FixedString` 用作主键时的行为。该改动修复了 [#14908](https://github.com/ClickHouse/ClickHouse/issues/14908)。[#15033](https://github.com/ClickHouse/ClickHouse/pull/15033)（[Amos Bird](https://github.com/amosbird)）。
* 如果使用特意构造的参数调用函数 `bar`，可能会发生缓冲区溢出。此变更修复了 [#13926](https://github.com/ClickHouse/ClickHouse/issues/13926)。[#15028](https://github.com/ClickHouse/ClickHouse/pull/15028)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在 Mac OS 上通过 Docker 运行 clickhouse-server 时，在 Atomic 数据库中执行 DDL 查询时出现的 `Cannot rename ... errno: 22, strerror: Invalid argument` 错误。[#15024](https://github.com/ClickHouse/ClickHouse/pull/15024) ([tavplubix](https://github.com/tavplubix))。
* 现在，设置项 `number_of_free_entries_in_pool_to_execute_mutation` 和 `number_of_free_entries_in_pool_to_lower_max_size_of_merge` 现在可以设置为与 `background_pool_size` 相同的值。 [#14975](https://github.com/ClickHouse/ClickHouse/pull/14975) ([alesapin](https://github.com/alesapin))。
* 修复了当子查询包含 `finalizeAggregation` 函数时导致谓词下推无法生效的问题。修复了 [#14847](https://github.com/ClickHouse/ClickHouse/issues/14847)。[#14937](https://github.com/ClickHouse/ClickHouse/pull/14937)（[filimonov](https://github.com/filimonov)）。
* 在 `system.asynchronous_metrics` 中按逻辑内核发布 CPU 频率。修复了 [#14923](https://github.com/ClickHouse/ClickHouse/issues/14923)。[#14924](https://github.com/ClickHouse/ClickHouse/pull/14924)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* 修复在使用 `MaterializeMySQL` 数据库引擎时出现的 `.metadata.tmp File exists` 错误。[#14898](https://github.com/ClickHouse/ClickHouse/pull/14898) ([Winter Zhang](https://github.com/zhang2014))。
* 修复了一个问题：当需要从 ZooKeeper 获取配置文件（使用 `from_zk` include 选项）时，服务器在启动过程中与 ZooKeeper 通信可能会卡住。此修复对应 [#14814](https://github.com/ClickHouse/ClickHouse/issues/14814)。[#14843](https://github.com/ClickHouse/ClickHouse/pull/14843)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* 修复对收缩的有符号类型 `Int -> Int` 转换的单调性检测错误。该问题可能会导致查询结果不正确。此 bug 在 [#14513](https://github.com/ClickHouse/ClickHouse/issues/14513) 中被发现。[#14783](https://github.com/ClickHouse/ClickHouse/pull/14783)（[Amos Bird](https://github.com/amosbird)）。
* 修复了 `Nullable` 列排序顺序不正确的问题。此修复解决了 [#14344](https://github.com/ClickHouse/ClickHouse/issues/14344)。[#14495](https://github.com/ClickHouse/ClickHouse/pull/14495)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。

#### 改进 {#improvement-10}

- 现在可以使用 `ALTER` 查询更改 `VersionedCollapsingMergeTree` 的版本列类型。[#15442](https://github.com/ClickHouse/ClickHouse/pull/15442) ([alesapin](https://github.com/alesapin))。

### ClickHouse 版本 v20.8.3.18-stable, 2020-09-18 {#clickhouse-release-v208318-stable-2020-09-18}

#### 错误修复 {#bug-fix-22}

- 修复某些 `extractAllGroups` 函数调用可能触发"内存限制超出"错误的问题。此修复解决了 [#13383](https://github.com/ClickHouse/ClickHouse/issues/13383)。[#14889](https://github.com/ClickHouse/ClickHouse/pull/14889) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 修复尝试向 StorageFile(fd) 执行 INSERT 时的 SIGSEGV 错误。[#14887](https://github.com/ClickHouse/ClickHouse/pull/14887) ([Azat Khuzhin](https://github.com/azat))。
- 修复 `SELECT` 查询中的罕见错误:当查询的列具有 `DEFAULT` 表达式,且该表达式依赖于另一个也具有 `DEFAULT` 的列,而该列既不在查询中也不存在于磁盘上时会出现此错误。部分修复了 [#14531](https://github.com/ClickHouse/ClickHouse/issues/14531)。[#14845](https://github.com/ClickHouse/ClickHouse/pull/14845) ([alesapin](https://github.com/alesapin))。
- 修复执行 `ALTER ... MODIFY QUERY` 时物化视图元数据中缺少默认数据库名称的问题。[#14664](https://github.com/ClickHouse/ClickHouse/pull/14664) ([tavplubix](https://github.com/tavplubix))。
- 修复当 `ALTER UPDATE` 变更在赋值表达式中使用 Nullable 列和常量值(如 `UPDATE x = 42`)时导致列中值不正确或段错误的问题。修复了 [#13634](https://github.com/ClickHouse/ClickHouse/issues/13634)、[#14045](https://github.com/ClickHouse/ClickHouse/issues/14045)。[#14646](https://github.com/ClickHouse/ClickHouse/pull/14646) ([alesapin](https://github.com/alesapin))。
- 修复由于结果列的小数精度错误导致的 Decimal 乘法结果错误。[#14603](https://github.com/ClickHouse/ClickHouse/pull/14603) ([Artem Zuikov](https://github.com/4ertus2))。
- 添加了检查器,因为调用 `lc->isNullable()` 或 `ls->getDictionaryPtr()->isNullable()` 都无法返回正确的结果。[#14591](https://github.com/ClickHouse/ClickHouse/pull/14591) ([myrrc](https://github.com/myrrc))。
- 在 StorageReplicatedMergeTree 引擎的 CreateQuery 期间发生 ZooKeeper 异常后清理数据目录。[#14563](https://github.com/ClickHouse/ClickHouse/pull/14563) ([Bharat Nallan](https://github.com/bharatnc))。
- 修复带有 -Resample 组合器的函数中的罕见段错误,该错误可能在使用非常大的参数导致溢出时出现。[#14562](https://github.com/ClickHouse/ClickHouse/pull/14562) ([Anton Popov](https://github.com/CurtizJ))。

#### 改进 {#improvement-11}

- 当存在正在进行的 S3 请求时加快服务器关闭过程。[#14858](https://github.com/ClickHouse/ClickHouse/pull/14858) ([Pavel Kovalenko](https://github.com/Jokser))。
- 允许在 Distributed 存储中使用多卷存储配置。[#14839](https://github.com/ClickHouse/ClickHouse/pull/14839) ([Pavel Kovalenko](https://github.com/Jokser))。
- 当存在正在进行的 S3 请求时加快服务器关闭过程。[#14496](https://github.com/ClickHouse/ClickHouse/pull/14496) ([Pavel Kovalenko](https://github.com/Jokser))。
- 支持在紧凑数据部分中使用自定义编解码器。[#12183](https://github.com/ClickHouse/ClickHouse/pull/12183) ([Anton Popov](https://github.com/CurtizJ))。

### ClickHouse 版本 v20.8.2.3-stable, 2020-09-08 {#clickhouse-release-v20823-stable-2020-09-08}

#### 向后不兼容的变更 {#backward-incompatible-change-4}


- 现在 `OPTIMIZE FINAL` 查询不会为在创建 TTL 之前添加的数据分区重新计算 TTL。请使用 `ALTER TABLE ... MATERIALIZE TTL` 一次性计算它们,之后 `OPTIMIZE FINAL` 将正确评估 TTL。此行为在复制表中从未生效。[#14220](https://github.com/ClickHouse/ClickHouse/pull/14220) ([alesapin](https://github.com/alesapin))。
- 扩展 `parallel_distributed_insert_select` 设置,添加了向本地表执行 `INSERT` 的选项。该设置的类型从 `Bool` 更改为 `UInt64`,因此不再支持 `false` 和 `true` 值。如果您在服务器配置中使用了这些值,服务器将无法启动。请分别将它们替换为 `0` 和 `1`。[#14060](https://github.com/ClickHouse/ClickHouse/pull/14060) ([Azat Khuzhin](https://github.com/azat))。
- 移除对 `ODBCDriver` 输入/输出格式的支持。这是一个已弃用的格式,曾用于与 ClickHouse ODBC 驱动程序通信,现已被 `ODBCDriver2` 格式完全取代。解决了 [#13629](https://github.com/ClickHouse/ClickHouse/issues/13629)。[#13847](https://github.com/ClickHouse/ClickHouse/pull/13847) ([hexiaoting](https://github.com/hexiaoting))。
- 从 20.5 之前的版本升级时,如果执行滚动更新且集群同时包含 20.5 或更高版本和低于 20.5 的版本,当重启运行旧版本的 ClickHouse 节点并且在存在较新版本的情况下启动了旧版本,可能会导致 `Part ... intersects previous part` 错误。为防止此错误,请先在所有集群节点上安装较新的 clickhouse-server 软件包,然后再执行重启(这样,当 clickhouse-server 重启时,它将以新版本启动)。

#### 新功能 {#new-feature-4}


- 新增为列指定 `Default` 压缩编解码器的功能,该列对应于 `config.xml` 中指定的设置。实现:[#9074](https://github.com/ClickHouse/ClickHouse/issues/9074)。[#14049](https://github.com/ClickHouse/ClickHouse/pull/14049) ([alesapin](https://github.com/alesapin))。
- 支持在 Kafka 中使用 Kerberos 身份验证,使用 `krb5` 和 `cyrus-sasl` 库。[#12771](https://github.com/ClickHouse/ClickHouse/pull/12771) ([Ilya Golshtein](https://github.com/ilejn))。
- 新增函数 `normalizeQuery`,用于将字面量、字面量序列和复杂别名替换为占位符。新增函数 `normalizedQueryHash`,为相似查询返回相同的 64 位哈希值。这有助于分析查询日志。此功能解决了 [#11271](https://github.com/ClickHouse/ClickHouse/issues/11271)。[#13816](https://github.com/ClickHouse/ClickHouse/pull/13816) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 新增 `time_zones` 表。[#13880](https://github.com/ClickHouse/ClickHouse/pull/13880) ([Bharat Nallan](https://github.com/bharatnc))。
- 新增函数 `defaultValueOfTypeName`,返回给定类型的默认值。[#13877](https://github.com/ClickHouse/ClickHouse/pull/13877) ([hcz](https://github.com/hczhcz))。
- 新增 `countDigits(x)` 函数,用于计算整数或十进制列中的十进制数字位数。新增 `isDecimalOverflow(d, [p])` 函数,用于检查 Decimal 列中的值是否超出其(或指定的)精度。[#14151](https://github.com/ClickHouse/ClickHouse/pull/14151) ([Artem Zuikov](https://github.com/4ertus2))。
- 新增 `quantileExactLow` 和 `quantileExactHigh` 实现,分别为 `medianExactLow` 和 `medianExactHigh` 的别名。[#13818](https://github.com/ClickHouse/ClickHouse/pull/13818) ([Bharat Nallan](https://github.com/bharatnc))。
- 新增 `date_trunc` 函数,将日期/时间值截断到指定的日期/时间部分。[#13888](https://github.com/ClickHouse/ClickHouse/pull/13888) ([Vladimir Golovchenko](https://github.com/vladimir-golovchenko))。
- 在主配置文件中新增可选配置段 `<user_directories>`。[#13425](https://github.com/ClickHouse/ClickHouse/pull/13425) ([Vitaly Baranov](https://github.com/vitlibar))。
- 新增 `ALTER SAMPLE BY` 语句,允许更改表的采样子句。[#13280](https://github.com/ClickHouse/ClickHouse/pull/13280) ([Amos Bird](https://github.com/amosbird))。
- 函数 `position` 现在支持可选的 `start_pos` 参数。[#13237](https://github.com/ClickHouse/ClickHouse/pull/13237) ([vdimir](https://github.com/vdimir))。

#### 错误修复 {#bug-fix-23}


* 修复交互模式下客户端进度条覆盖可见数据的问题。修复了 [#12562](https://github.com/ClickHouse/ClickHouse/issues/12562)、[#13369](https://github.com/ClickHouse/ClickHouse/issues/13369)、[#13584](https://github.com/ClickHouse/ClickHouse/issues/13584) 以及 [#12964](https://github.com/ClickHouse/ClickHouse/issues/12964)。[#13691](https://github.com/ClickHouse/ClickHouse/pull/13691)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在按多列排序时 `LowCardinality` 列排序顺序不正确的问题。此修复解决了 [#13958](https://github.com/ClickHouse/ClickHouse/issues/13958)。[#14223](https://github.com/ClickHouse/ClickHouse/pull/14223)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 在 `topK` 聚合函数中检查数组大小是否溢出。缺少此检查时，用户可以发送带有精心构造参数的查询，从而导致服务器崩溃。此更改修复了 [#14452](https://github.com/ClickHouse/ClickHouse/issues/14452)。[#14467](https://github.com/ClickHouse/ClickHouse/pull/14467)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了一个 bug：当表包含仅有单个 part 的分区时，可能导致错误的合并任务分配。[#14444](https://github.com/ClickHouse/ClickHouse/pull/14444) ([alesapin](https://github.com/alesapin)).
* 如果在 `PipelineExecutor` 本身中发生异常，则停止查询执行。这可以避免在极少数情况下出现查询挂起。承接 [#14334](https://github.com/ClickHouse/ClickHouse/issues/14334)。[#14402](https://github.com/ClickHouse/ClickHouse/pull/14402) [#14334](https://github.com/ClickHouse/ClickHouse/pull/14334) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复对通过 `AS table_function` 创建的表执行 `ALTER` 查询时发生的崩溃。修复了 [#14212](https://github.com/ClickHouse/ClickHouse/issues/14212)。[#14326](https://github.com/ClickHouse/ClickHouse/pull/14326)（[alesapin](https://github.com/alesapin)）。
* 修复在执行带有 `REFRESH` 命令的 `ALTER LIVE VIEW` 查询时抛出的异常。`LIVE VIEW` 是一项实验性功能。[#14320](https://github.com/ClickHouse/ClickHouse/pull/14320) ([Bharat Nallan](https://github.com/bharatnc))。
* 修复在具有嵌套解释器的查询中用于 `EXPLAIN PIPELINE graph=1` 的 `QueryPlan` 生命周期。 [#14315](https://github.com/ClickHouse/ClickHouse/pull/14315) ([Azat Khuzhin](https://github.com/azat)).
* 修复 `clickhouse-odbc-bridge` 在从某些外部数据源获取 schema 时发生的段错误。此 PR 修复了 [#13861](https://github.com/ClickHouse/ClickHouse/issues/13861)。[#14267](https://github.com/ClickHouse/ClickHouse/pull/14267)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复在标记包含搜索中引入的崩溃，该问题源自 [#12277](https://github.com/ClickHouse/ClickHouse/pull/12277)。[#14225](https://github.com/ClickHouse/ClickHouse/pull/14225)（[Amos Bird](https://github.com/amosbird)）。
* 修复了使用命名元组创建表的问题。此更改修复了 [#13027](https://github.com/ClickHouse/ClickHouse/issues/13027)。[#14143](https://github.com/ClickHouse/ClickHouse/pull/14143)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复极小负十进制数的格式化问题。修复了 [#14111](https://github.com/ClickHouse/ClickHouse/issues/14111)。 [#14119](https://github.com/ClickHouse/ClickHouse/pull/14119)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* 修复 `DistributedFilesToInsert` 指标（在不应被清零时却被清零的问题）。[#14095](https://github.com/ClickHouse/ClickHouse/pull/14095) ([Azat Khuzhin](https://github.com/azat))。
* 修复在使用 const 二维数组作为多边形时的 `pointInPolygon`。 [#14079](https://github.com/ClickHouse/ClickHouse/pull/14079) ([Alexey Ilyukhov](https://github.com/livace)).
* 修复了 `Poco::Exception: no space left on device` 附加信息中错误的挂载点。[#14050](https://github.com/ClickHouse/ClickHouse/pull/14050) ([tavplubix](https://github.com/tavplubix)).
* 修复在非全局级别执行时的 `GRANT ALL` 语句问题。 [#13987](https://github.com/ClickHouse/ClickHouse/pull/13987) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复解析器，使其拒绝带有 `ENGINE` 的 `CREATE TABLE AS` 表函数语句。[#13940](https://github.com/ClickHouse/ClickHouse/pull/13940) ([hcz](https://github.com/hczhcz)).
* 修复在开启 `optimize_duplicate_order_by_and_distinct` 设置时，带有 `DISTINCT` 关键字的 SELECT 查询以及包含 `UNION ALL` 的子查询返回错误结果的问题。 [#13925](https://github.com/ClickHouse/ClickHouse/pull/13925) ([Artem Zuikov](https://github.com/4ertus2)).
* 修复了在重命名 `Distributed` 表时可能出现的死锁问题。[#13922](https://github.com/ClickHouse/ClickHouse/pull/13922) ([tavplubix](https://github.com/tavplubix)).
* 修复在按多个列排序时 `FixedString` 列排序不正确的问题。修复 [#13182](https://github.com/ClickHouse/ClickHouse/issues/13182)。[#13887](https://github.com/ClickHouse/ClickHouse/pull/13887)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在合并使用非默认参数的 `topK`/`topKWeighted` 时可能出现的不精确结果。[#13817](https://github.com/ClickHouse/ClickHouse/pull/13817) ([Azat Khuzhin](https://github.com/azat))。
* 修复了从具有 `SET` 类型 `INDEX` 的 MergeTree 表读取时，与 `NULL` 比较会失败的问题。此修复解决了 [#13686](https://github.com/ClickHouse/ClickHouse/issues/13686)。[#13793](https://github.com/ClickHouse/ClickHouse/pull/13793)（[Amos Bird](https://github.com/amosbird)）。
* 修复 `arrayJoin` 在 lambda 中捕获导致的错误（LOGICAL&#95;ERROR）。[#13792](https://github.com/ClickHouse/ClickHouse/pull/13792)（[Azat Khuzhin](https://github.com/azat)）。
* 在 `range` 函数中添加步长溢出检查。[#13790](https://github.com/ClickHouse/ClickHouse/pull/13790) ([Azat Khuzhin](https://github.com/azat))。
* 修复了在并发执行 `DROP DATABASE` 和 `CREATE TABLE` 时出现的 `Directory not empty` 错误。[#13756](https://github.com/ClickHouse/ClickHouse/pull/13756) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 为 `h3KRing` 函数添加范围检查。修复了 [#13633](https://github.com/ClickHouse/ClickHouse/issues/13633)。[#13752](https://github.com/ClickHouse/ClickHouse/pull/13752)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `DETACH` 与后台合并之间的竞态条件。数据分片在 `DETACH` 之后可能会被重新“复活”。这是对 [#8602](https://github.com/ClickHouse/ClickHouse/issues/8602) 的延续，该 issue 并未修复问题，但引入了一个测试，该测试在极少数情况下会失败，从而暴露了该问题。[#13746](https://github.com/ClickHouse/ClickHouse/pull/13746)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 当 `log_queries_min_type` &gt; `QUERY_START` 时，修复日志中的 `Settings.Names/Values`。 [#13737](https://github.com/ClickHouse/ClickHouse/pull/13737) ([Azat Khuzhin](https://github.com/azat)).
* 修复在 verbose=1 时 `/replicas_status` 端点返回的状态码。[#13722](https://github.com/ClickHouse/ClickHouse/pull/13722) ([javi santana](https://github.com/javisantana)).
* 修复 `clickhouse-server.init` 在检查用户和用户组时的错误消息。 [#13711](https://github.com/ClickHouse/ClickHouse/pull/13711) ([ylchou](https://github.com/ylchou)).
* 在启用 `optimize_move_functions_out_of_any` 设置时，不要将 any(arrayJoin()) 优化为 arrayJoin()。[#13681](https://github.com/ClickHouse/ClickHouse/pull/13681) ([Azat Khuzhin](https://github.com/azat)).
* 修复在使用 StorageMerge 并设置 `set enable_optimize_predicate_expression=1` 时发生的 JOIN 崩溃问题。[#13679](https://github.com/ClickHouse/ClickHouse/pull/13679)（[Artem Zuikov](https://github.com/4ertus2)）。
* 修复了有关 `The value of 'number_of_free_entries_in_pool_to_lower_max_size_of_merge' setting` 的错误消息中的拼写错误。 [#13678](https://github.com/ClickHouse/ClickHouse/pull/13678) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 并发执行 `ALTER ... REPLACE/MOVE PARTITION ...` 查询可能会导致死锁。该问题已修复。[#13626](https://github.com/ClickHouse/ClickHouse/pull/13626) ([tavplubix](https://github.com/tavplubix)).
* 修复了在某些情况下 `cache-dictionary` 本应从源返回已存在的值却返回了默认值的问题。[#13624](https://github.com/ClickHouse/ClickHouse/pull/13624) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 修复紧凑部分中二级索引损坏的问题。紧凑部分是实验性功能。[#13538](https://github.com/ClickHouse/ClickHouse/pull/13538) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了对于必须在单个副本上执行的查询，`ON CLUSTER` 过早超时的问题。修复了 [#6704](https://github.com/ClickHouse/ClickHouse/issues/6704)、[#7228](https://github.com/ClickHouse/ClickHouse/issues/7228)、[#13361](https://github.com/ClickHouse/ClickHouse/issues/13361)、[#11884](https://github.com/ClickHouse/ClickHouse/issues/11884)。[#13450](https://github.com/ClickHouse/ClickHouse/pull/13450)（[alesapin](https://github.com/alesapin)）。
* 修复函数 `netloc` 中不正确的代码。此更改修复了 [#13335](https://github.com/ClickHouse/ClickHouse/issues/13335)。[#13446](https://github.com/ClickHouse/ClickHouse/pull/13446)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `StorageMemory` 中可能存在的竞态条件。 [#13416](https://github.com/ClickHouse/ClickHouse/pull/13416) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复 HTTP 协议中 `TSV/CSVWithNames` 格式缺失或多余表头的问题。此修复解决了 [#12504](https://github.com/ClickHouse/ClickHouse/issues/12504)。[#13343](https://github.com/ClickHouse/ClickHouse/pull/13343)（[Azat Khuzhin](https://github.com/azat)）。
* 修复从 users.xml 解析行级策略时，当数据库或表名包含点号时的解析问题。此更改修复了 [#5779](https://github.com/ClickHouse/ClickHouse/issues/5779)、[#12527](https://github.com/ClickHouse/ClickHouse/issues/12527)。[#13199](https://github.com/ClickHouse/ClickHouse/pull/13199)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复在连接中断一次后对 `redis` 字典的访问问题。此问题可能发生在 `cache` 和 `direct` 字典布局中。[#13082](https://github.com/ClickHouse/ClickHouse/pull/13082) ([Anton Popov](https://github.com/CurtizJ))。
* 在使用 ClickHouseDictionarySource 查询远程表时，移除了不正确的鉴权访问检查。[#12756](https://github.com/ClickHouse/ClickHouse/pull/12756) ([sundyli](https://github.com/sundy-li)).
* 在某些情况下正确区分子查询，以便进行公共子表达式消除（CSE）。 [#8333](https://github.com/ClickHouse/ClickHouse/issues/8333)。 [#8367](https://github.com/ClickHouse/ClickHouse/pull/8367) ([Amos Bird](https://github.com/amosbird))。

#### 改进 {#improvement-12}


* 不允许在 `ALIAS` 列类型上使用 `CODEC`。修复了 [#13911](https://github.com/ClickHouse/ClickHouse/issues/13911)。[#14263](https://github.com/ClickHouse/ClickHouse/pull/14263)（[Bharat Nallan](https://github.com/bharatnc)）。
* 在等待字典更新完成时，请使用 `query_wait_timeout_milliseconds` 设置中指定的超时时间，而不是使用硬编码的数值。 [#14105](https://github.com/ClickHouse/ClickHouse/pull/14105) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 添加了设置 `min_index_granularity_bytes`，用于防止误将表的 `index_granularity_bytes` 设置为过低值。[#14139](https://github.com/ClickHouse/ClickHouse/pull/14139)（[Bharat Nallan](https://github.com/bharatnc)）。
* 现在可以从使用不同 ZooKeeper 的集群中拉取分区：`ALTER TABLE table_name FETCH PARTITION partition_expr FROM 'zk-name:/path-in-zookeeper'`。这对于将数据迁移到新集群非常有用。[#14155](https://github.com/ClickHouse/ClickHouse/pull/14155)（[Amos Bird](https://github.com/amosbird)）。
* 如果 `Memory` 表是由大量非常小的块构建而成，其性能会略有提升（这种情况不太常见）。想法提出者：[Mark Papadakis](https://github.com/markpapadakis)。关闭关联的 [#14043](https://github.com/ClickHouse/ClickHouse/issues/14043)。[#14056](https://github.com/ClickHouse/ClickHouse/pull/14056)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 条件聚合函数（例如：`avgIf`、`sumIf`、`maxIf`）在没有匹配行且使用可为空参数时，应返回 `NULL`。 [#13964](https://github.com/ClickHouse/ClickHouse/pull/13964) ([Winter Zhang](https://github.com/zhang2014))。
* 将 `-Resample` 组合器中的上限提高到 100 万。 [#13947](https://github.com/ClickHouse/ClickHouse/pull/13947) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* 修复了 `AvroConfluent` 格式中的一个错误，该错误会在收到异常小且损坏的消息时导致 `Kafka` 表引擎停止处理消息。[#13941](https://github.com/ClickHouse/ClickHouse/pull/13941)（[Gervasio Varela](https://github.com/gervarela)）。
* 修复长查询的错误类型问题。之前在语法正确的查询中，可能会得到除 `Max query size exceeded` 之外的其他语法错误。[#13928](https://github.com/ClickHouse/ClickHouse/pull/13928) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 为 `TabSeparated` 格式的空值提供了更清晰的错误信息。 [#13906](https://github.com/ClickHouse/ClickHouse/pull/13906) ([jiang tao](https://github.com/tomjiang1987)).
* 当数组元素类型为 Float32/Float64 时，函数 `arrayCompact` 将按位比较 NaN。在之前的版本中，当数组元素类型为 Float32/Float64 时，NaN 始终被视为不相等，而当类型更复杂（例如 Nullable(Float64)）时，NaN 又始终被视为相等。此更改关闭了 [#13857](https://github.com/ClickHouse/ClickHouse/issues/13857)。[#13868](https://github.com/ClickHouse/ClickHouse/pull/13868)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `lgamma` 函数中的数据竞争。该竞争仅在 `tsan` 中被捕获，实际上并未产生任何副作用。[#13842](https://github.com/ClickHouse/ClickHouse/pull/13842) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 在将数组作为字段进行操作时，避免执行过慢的查询，改为抛出异常。[#13753](https://github.com/ClickHouse/ClickHouse/pull/13753) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 为 Redis 字典源添加了 Redis `requirepass` 认证支持。 [#13688](https://github.com/ClickHouse/ClickHouse/pull/13688) ([Ivan Torgashov](https://github.com/it1804)).
* 新增 MergeTree 预写日志（Write-Ahead Log，WAL）转储工具。WAL 是一项实验性特性。[#13640](https://github.com/ClickHouse/ClickHouse/pull/13640) ([BohuTANG](https://github.com/BohuTANG))。
* 在早期版本中，`lcm` 函数在使用特定构造的参数调用时，可能会在调试构建中触发断言失败。此更改修复了 [#13368](https://github.com/ClickHouse/ClickHouse/issues/13368)。[#13510](https://github.com/ClickHouse/ClickHouse/pull/13510)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在更多场景下为 `toDate/toDateTime` 函数提供单调性信息。单调性信息用于索引分析（从而使更复杂的查询也能够利用索引）。现在对输入参数的截断/约束方式更加自然，从而提供了更好的单调性。[#13497](https://github.com/ClickHouse/ClickHouse/pull/13497)（[Amos Bird](https://github.com/amosbird)）。
* 为自定义设置提供对复合标识符的支持。自定义设置是 ClickHouse 代码库与其他代码库的集成点（对 ClickHouse 本身没有直接收益）[#13496](https://github.com/ClickHouse/ClickHouse/pull/13496)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 并行地将部分数据从 DiskLocal 迁移到 DiskS3。`DiskS3` 是一个实验性特性。[#13459](https://github.com/ClickHouse/ClickHouse/pull/13459)（[Pavel Kovalenko](https://github.com/Jokser)）。
* 默认启用混合粒度数据部分。 [#13449](https://github.com/ClickHouse/ClickHouse/pull/13449) ([alesapin](https://github.com/alesapin)).
* 在 S3 重定向中正确校验远程主机（与安全相关的改进）。 [#13404](https://github.com/ClickHouse/ClickHouse/pull/13404) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 将 `QueryTimeMicroseconds`、`SelectQueryTimeMicroseconds` 和 `InsertQueryTimeMicroseconds` 添加到 system.events。 [#13336](https://github.com/ClickHouse/ClickHouse/pull/13336) ([ianton-ru](https://github.com/ianton-ru)).
* 修复当 `Decimal` 具有过大负指数时触发的调试断言。修复了 [#13188](https://github.com/ClickHouse/ClickHouse/issues/13188)。[#13228](https://github.com/ClickHouse/ClickHouse/pull/13228)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 DiskS3 添加了缓存层（将标记和索引文件缓存到本地磁盘）。`DiskS3` 是一项实验性特性。[#13076](https://github.com/ClickHouse/ClickHouse/pull/13076) ([Pavel Kovalenko](https://github.com/Jokser))。
* 修复 `readline`，使其现在会将历史记录写入文件。[#13600](https://github.com/ClickHouse/ClickHouse/pull/13600)（[Amos Bird](https://github.com/amosbird)）。
* 默认使用 `Atomic` 引擎创建 `system` 数据库（为在所有场景下默认启用 `Atomic` 数据库引擎做准备）。 [#13680](https://github.com/ClickHouse/ClickHouse/pull/13680) ([tavplubix](https://github.com/tavplubix)).

#### 性能改进 {#performance-improvement-5}

- 轻微优化使用 `LowCardinality` 的极短查询。[#14129](https://github.com/ClickHouse/ClickHouse/pull/14129) ([Anton Popov](https://github.com/CurtizJ))。
- 当设置 `max_insert_threads` 时,为表引擎 `Null`、`Memory`、`Distributed` 和 `Buffer` 启用并行 INSERT。[#14120](https://github.com/ClickHouse/ClickHouse/pull/14120) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 如果在分区扫描时超过 `max_rows_to_read` 限制,则快速失败。此更改的目的是,当明确 `max_rows_to_read` 已被超过时,跳过所有选定分区的范围扫描。对于涉及大量分区的查询,此更改效果相当明显。[#13677](https://github.com/ClickHouse/ClickHouse/pull/13677) ([Roman Khavronenko](https://github.com/hagen1778))。
- 轻微改进按 UInt8/UInt16 键进行聚合的性能。[#13099](https://github.com/ClickHouse/ClickHouse/pull/13099) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 优化 `has()`、`indexOf()` 和 `countEqual()` 函数,用于 `Array(LowCardinality(T))` 和常量右参数。[#12550](https://github.com/ClickHouse/ClickHouse/pull/12550) ([myrrc](https://github.com/myrrc))。
- 执行简单的 `INSERT SELECT` 查询时,自动将 `max_threads` 设置为 1 或 `max_insert_threads`,并将 `max_block_size` 设置为 `min_insert_block_size_rows`。相关问题:[#5907](https://github.com/ClickHouse/ClickHouse/issues/5907)。[#12195](https://github.com/ClickHouse/ClickHouse/pull/12195) ([flynn](https://github.com/ucasFL))。

#### 实验性功能 {#experimental-feature-3}

- ClickHouse 可以作为 MySQL 副本工作 - 通过 `MaterializeMySQL` 数据库引擎实现。实现了 [#4006](https://github.com/ClickHouse/ClickHouse/issues/4006)。[#10851](https://github.com/ClickHouse/ClickHouse/pull/10851) ([Winter Zhang](https://github.com/zhang2014))。
- 添加类型 `Int128`、`Int256`、`UInt256` 及其相关函数。使用 Decimal256(精度最高 76 位)扩展 Decimal 类型。新类型在设置 `allow_experimental_bigint_types` 下可用。其运行速度极慢且效果不佳。实现尚不完整。请勿使用此功能。[#13097](https://github.com/ClickHouse/ClickHouse/pull/13097) ([Artem Zuikov](https://github.com/4ertus2))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-7}


* 新增了 `clickhouse install` 脚本，在你只有单个二进制文件时非常有用。 [#13528](https://github.com/ClickHouse/ClickHouse/pull/13528) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 允许在无配置文件的情况下运行 `clickhouse` 可执行文件。 [#13515](https://github.com/ClickHouse/ClickHouse/pull/13515) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 使用 `codespell` 对代码启用拼写检查。 [#13513](https://github.com/ClickHouse/ClickHouse/pull/13513) [#13511](https://github.com/ClickHouse/ClickHouse/pull/13511) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 在 CI 中启用 Shellcheck 作为 `.sh` 测试的 linter。该更改解决了 [#13168](https://github.com/ClickHouse/ClickHouse/issues/13168)。[#13530](https://github.com/ClickHouse/ClickHouse/pull/13530) [#13529](https://github.com/ClickHouse/ClickHouse/pull/13529)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 添加一个 CMake 选项，使其在配置失败时终止而不是自动重新配置，默认启用。 [#13687](https://github.com/ClickHouse/ClickHouse/pull/13687) ([Konstantin](https://github.com/podshumok)).
* 通过 `TZDATA_VERSION` 在 `system.build_options` 中公开嵌入式 `tzdata` 的版本。 [#13648](https://github.com/ClickHouse/ClickHouse/pull/13648) ([filimonov](https://github.com/filimonov)).
* 改进在构建过程中生成 `system.time_zones` 表的方式。修复了 [#14209](https://github.com/ClickHouse/ClickHouse/issues/14209)。[#14215](https://github.com/ClickHouse/ClickHouse/pull/14215) ([filimonov](https://github.com/filimonov)).
* 使用软件包仓库中最新的 tzdata 构建 ClickHouse。 [#13623](https://github.com/ClickHouse/ClickHouse/pull/13623) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 在 skip&#95;list.json 中新增对 JS 风格注释的支持。 [#14159](https://github.com/ClickHouse/ClickHouse/pull/14159) ([alesapin](https://github.com/alesapin)).
* 确保不存在复制粘贴的 GPL 代码。[#13514](https://github.com/ClickHouse/ClickHouse/pull/13514)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 将测试用 docker 镜像切换为以 test-base 作为父镜像。 [#14167](https://github.com/ClickHouse/ClickHouse/pull/14167) ([Ilya Yatsishin](https://github.com/qoega)).
* 在启动 docker-compose 集群时添加重试逻辑；增大 COMPOSE&#95;HTTP&#95;TIMEOUT。 [#14112](https://github.com/ClickHouse/ClickHouse/pull/14112) ([vzakaznikov](https://github.com/vzakaznikov)).
* 在压力测试中启用了 `system.text_log`，以发现更多错误。[#13855](https://github.com/ClickHouse/ClickHouse/pull/13855) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* Testflows LDAP 模块：为 openldap4 补充缺失的证书和 dhparam.pem。 [#13780](https://github.com/ClickHouse/ClickHouse/pull/13780) ([vzakaznikov](https://github.com/vzakaznikov)).
* ZooKeeper 在 CI 基础设施中的单元测试里无法可靠工作。从一开始，用真实的 ZooKeeper 来做与 ZooKeeper 交互的单元测试就是一个很糟糕的主意（单元测试本就不是用来验证复杂分布式系统的）。我们已经为此目的使用集成测试，而且它们更为合适。 [#13745](https://github.com/ClickHouse/ClickHouse/pull/13745) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 添加用于样式检查的 Docker 镜像。添加样式检查以确保所有 Docker 和 Docker Compose 文件都位于 docker 目录中。[#13724](https://github.com/ClickHouse/ClickHouse/pull/13724)（[Ilya Yatsishin](https://github.com/qoega)）。
* 修复在 Mac OS 上的 Cassandra 构建。[#13708](https://github.com/ClickHouse/ClickHouse/pull/13708) ([Ilya Yatsishin](https://github.com/qoega)).
* 修复共享构建中的链接错误。 [#13700](https://github.com/ClickHouse/ClickHouse/pull/13700) ([Amos Bird](https://github.com/amosbird)).
* 更新 LDAP 用户认证套件，验证其在 RBAC 下的工作情况。[#13656](https://github.com/ClickHouse/ClickHouse/pull/13656) ([vzakaznikov](https://github.com/vzakaznikov))。
* 已为 `contrib/aws` 移除 `-DENABLE_CURL_CLIENT`。 [#13628](https://github.com/ClickHouse/ClickHouse/pull/13628) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 增加 ClickHouse 节点健康检查的超时时间，并在发现不健康的容器时增加导出 docker-compose 日志的支持。 [#13612](https://github.com/ClickHouse/ClickHouse/pull/13612) ([vzakaznikov](https://github.com/vzakaznikov)).
* 确保 [#10977](https://github.com/ClickHouse/ClickHouse/issues/10977) 已无效。 [#13539](https://github.com/ClickHouse/ClickHouse/pull/13539)（[Amos Bird](https://github.com/amosbird)）。
* 跳过来自 robot-clickhouse 的 PR。[#13489](https://github.com/ClickHouse/ClickHouse/pull/13489) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 将 Dockerfile 从集成测试中移动到 `docker/test` 目录。`docker&#95;compose` 文件可在 `runner` Docker 容器中使用。Docker 镜像在 CI 中构建，而不是在集成测试中构建。[#13448](https://github.com/ClickHouse/ClickHouse/pull/13448) ([Ilya Yatsishin](https://github.com/qoega))。





## ClickHouse 20.7 版本 {#clickhouse-release-207}

### ClickHouse v20.7.2.30-stable 版本,2020-08-31 {#clickhouse-release-v207230-stable-2020-08-31}

#### 向后不兼容的变更 {#backward-incompatible-change-5}

- 函数 `modulo`(运算符 `%`)在至少有一个浮点数作为参数时,将直接对浮点数计算除法余数,而不会将两个参数都转换为整数。这使得其行为与大多数数据库管理系统兼容。此规则同样适用于 Date 和 DateTime 数据类型。添加了别名 `mod`。此变更关闭了 [#7323](https://github.com/ClickHouse/ClickHouse/issues/7323)。[#12585](https://github.com/ClickHouse/ClickHouse/pull/12585) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 弃用将零值 Date/DateTime 特殊打印为 `0000-00-00` 和 `0000-00-00 00:00:00` 的方式。[#12442](https://github.com/ClickHouse/ClickHouse/pull/12442) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 函数 `groupArrayMoving*` 在分布式查询中无法正常工作。其结果使用了错误的数据类型进行计算(未提升到最大类型)。函数 `groupArrayMovingAvg` 返回的整数与 `avg` 函数不一致。此变更修复了 [#12568](https://github.com/ClickHouse/ClickHouse/issues/12568)。[#12622](https://github.com/ClickHouse/ClickHouse/pull/12622) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 为 MergeTree 设置添加了合理性检查。如果设置不正确,服务器将拒绝启动或创建表,并向用户输出详细说明。[#13153](https://github.com/ClickHouse/ClickHouse/pull/13153) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 防止用户将 `background_pool_size` 设置为低于 `number_of_free_entries_in_pool_to_execute_mutation` 或 `number_of_free_entries_in_pool_to_lower_max_size_of_merge` 的值。在这些情况下,ALTER 操作将无法工作,或者合并的最大大小将受到过度限制。系统将抛出异常并说明应采取的措施。此变更关闭了 [#10897](https://github.com/ClickHouse/ClickHouse/issues/10897)。[#12728](https://github.com/ClickHouse/ClickHouse/pull/12728) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 从 20.5 之前的版本升级时,如果执行滚动更新且集群同时包含 20.5 或更高版本以及低于 20.5 的版本,当旧版本的 ClickHouse 节点在存在新版本的情况下重启并以旧版本启动时,可能会导致 `Part ... intersects previous part` 错误。为防止此错误,请先在所有集群节点上安装较新的 clickhouse-server 软件包,然后再执行重启(这样,当 clickhouse-server 重启时,它将以新版本启动)。

#### 新功能 {#new-feature-5}


- Polygon 字典类型,提供高效的"反向地理编码"查找功能 - 在包含多个多边形(世界地图)的字典中通过坐标查找区域。它使用经过精心优化的递归网格算法,以保持较低的 CPU 和内存使用率。[#9278](https://github.com/ClickHouse/ClickHouse/pull/9278) ([achulkov2](https://github.com/achulkov2))。
- 为预配置用户添加了 LDAP 身份验证支持("Simple Bind"方法)。[#11234](https://github.com/ClickHouse/ClickHouse/pull/11234) ([Denis Glazachev](https://github.com/traceon))。
- 引入设置 `alter_partition_verbose_result`,用于输出某些类型的 `ALTER TABLE ... PARTITION ...` 查询(目前为 `ATTACH` 和 `FREEZE`)所涉及分区的信息。关闭 [#8076](https://github.com/ClickHouse/ClickHouse/issues/8076)。[#13017](https://github.com/ClickHouse/ClickHouse/pull/13017) ([alesapin](https://github.com/alesapin))。
- 添加 `bayesAB` 函数用于贝叶斯 AB 测试。[#12327](https://github.com/ClickHouse/ClickHouse/pull/12327) ([achimbab](https://github.com/achimbab))。
- 添加 `system.crash_log` 表,用于收集致命错误的堆栈跟踪信息。该表应为空。[#12316](https://github.com/ClickHouse/ClickHouse/pull/12316) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 添加 HTTP 头 `X-ClickHouse-Database` 和 `X-ClickHouse-Format`,可用于设置默认数据库和输出格式。[#12981](https://github.com/ClickHouse/ClickHouse/pull/12981) ([hcz](https://github.com/hczhcz))。
- 为 `SimpleAggregateFunction` 添加 `minMap` 和 `maxMap` 函数支持。[#12662](https://github.com/ClickHouse/ClickHouse/pull/12662) ([Ildus Kurbangaliev](https://github.com/ildus))。
- 添加设置 `allow_non_metadata_alters`,用于限制执行修改磁盘数据的 `ALTER` 查询。默认禁用。关闭 [#11547](https://github.com/ClickHouse/ClickHouse/issues/11547)。[#12635](https://github.com/ClickHouse/ClickHouse/pull/12635) ([alesapin](https://github.com/alesapin))。
- 添加函数 `formatRow`,支持通过给定格式将任意表达式转换为字符串。它对于操作 SQL 输出非常有用,与 `columns` 函数结合使用时功能强大。[#12574](https://github.com/ClickHouse/ClickHouse/pull/12574) ([Amos Bird](https://github.com/amosbird))。
- 添加 `FROM_UNIXTIME` 函数以兼容 MySQL,相关问题 [12149](https://github.com/ClickHouse/ClickHouse/issues/12149)。[#12484](https://github.com/ClickHouse/ClickHouse/pull/12484) ([flynn](https://github.com/ucasFL))。
- 如果启用了 `allow_nullable_key` 表设置,则允许在 MergeTree 表中使用 Nullable 类型作为键。关闭 [#5319](https://github.com/ClickHouse/ClickHouse/issues/5319)。[#12433](https://github.com/ClickHouse/ClickHouse/pull/12433) ([Amos Bird](https://github.com/amosbird))。
- 与 [COS](https://intl.cloud.tencent.com/product/cos) 集成。[#12386](https://github.com/ClickHouse/ClickHouse/pull/12386) ([fastio](https://github.com/fastio))。
- 添加 `mapAdd` 和 `mapSubtract` 函数,用于对键映射值进行加法/减法运算。[#11735](https://github.com/ClickHouse/ClickHouse/pull/11735) ([Ildus Kurbangaliev](https://github.com/ildus))。

#### 错误修复 {#bug-fix-24}


* 修复了在必须在单个副本上执行的查询中，`ON CLUSTER` 过早超时的问题。修复了 [#6704](https://github.com/ClickHouse/ClickHouse/issues/6704)、[#7228](https://github.com/ClickHouse/ClickHouse/issues/7228)、[#13361](https://github.com/ClickHouse/ClickHouse/issues/13361)、[#11884](https://github.com/ClickHouse/ClickHouse/issues/11884)。[#13450](https://github.com/ClickHouse/ClickHouse/pull/13450)（[alesapin](https://github.com/alesapin)）。
* 修复了在标记包含搜索中引入的崩溃问题（见 [#12277](https://github.com/ClickHouse/ClickHouse/pull/12277)）。 [#14225](https://github.com/ClickHouse/ClickHouse/pull/14225)（[Amos Bird](https://github.com/amosbird)）。
* 修复使用 `cache` 布局的外部字典中的竞态条件，该问题可能导致服务器崩溃。[#12566](https://github.com/ClickHouse/ClickHouse/pull/12566) ([alesapin](https://github.com/alesapin)).
* 修复交互模式下客户端进度条遮挡可见数据的问题。此更改修复了 [#12562](https://github.com/ClickHouse/ClickHouse/issues/12562)、[#13369](https://github.com/ClickHouse/ClickHouse/issues/13369)、[#13584](https://github.com/ClickHouse/ClickHouse/issues/13584) 和 [#12964](https://github.com/ClickHouse/ClickHouse/issues/12964)。[#13691](https://github.com/ClickHouse/ClickHouse/pull/13691)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在使用多列表达式进行 `ORDER BY` 时 `LowCardinality` 列排序顺序不正确的问题。此修复解决了 [#13958](https://github.com/ClickHouse/ClickHouse/issues/13958)。[#14223](https://github.com/ClickHouse/ClickHouse/pull/14223)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 移除了一个硬编码的超时值，该值错误地覆盖了 cache-dictionary 的 `query_wait_timeout_milliseconds` 配置。 [#14105](https://github.com/ClickHouse/ClickHouse/pull/14105) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 修复了 `Poco::Exception: no space left on device` 错误附加信息中错误的挂载点。[#14050](https://github.com/ClickHouse/ClickHouse/pull/14050) ([tavplubix](https://github.com/tavplubix))。
* 修复在启用 `optimize_duplicate_order_by_and_distinct` 设置时，对于带有 `DISTINCT` 关键字且其子查询中也包含 `DISTINCT` 的 `SELECT` 查询，出现的错误查询优化问题。 [#13925](https://github.com/ClickHouse/ClickHouse/pull/13925) ([Artem Zuikov](https://github.com/4ertus2)).
* 修复了在重命名 `Distributed` 表时可能出现的死锁问题。[#13922](https://github.com/ClickHouse/ClickHouse/pull/13922) ([tavplubix](https://github.com/tavplubix)).
* 修复在使用多列 `ORDER BY` 时 `FixedString` 列排序不正确的问题。修复 [#13182](https://github.com/ClickHouse/ClickHouse/issues/13182)。[#13887](https://github.com/ClickHouse/ClickHouse/pull/13887)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在使用非默认参数时 `topK`/`topKWeighted` 聚合可能出现的精度降低问题。[#13817](https://github.com/ClickHouse/ClickHouse/pull/13817) ([Azat Khuzhin](https://github.com/azat))。
* 修复了从带有 SET 类型 `INDEX` 的 MergeTree 表中读取时，与 `NULL` 比较会失败的问题。此修复解决了 [#13686](https://github.com/ClickHouse/ClickHouse/issues/13686)。[#13793](https://github.com/ClickHouse/ClickHouse/pull/13793)（[Amos Bird](https://github.com/amosbird)）。
* 修复函数 `range()` 中 step 的溢出问题。[#13790](https://github.com/ClickHouse/ClickHouse/pull/13790)（[Azat Khuzhin](https://github.com/azat)）。
* 修复了在并发执行 `DROP DATABASE` 和 `CREATE TABLE` 时出现的 `Directory not empty` 错误。[#13756](https://github.com/ClickHouse/ClickHouse/pull/13756) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 为 `h3KRing` 函数添加范围检查。修复了 [#13633](https://github.com/ClickHouse/ClickHouse/issues/13633)。[#13752](https://github.com/ClickHouse/ClickHouse/pull/13752)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `DETACH` 与后台合并之间的竞态条件。数据分片在分离（detach）后可能会被“复活”。这是对 [#8602](https://github.com/ClickHouse/ClickHouse/issues/8602) 的延续，该问题并未被修复，但引入了一个测试，该测试在极少数情况下开始失败，从而暴露了该问题。[#13746](https://github.com/ClickHouse/ClickHouse/pull/13746)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 当 `log_queries_min_type` 大于 `QUERY_START` 时，修复日志中的 Settings.Names/Values 记录。 [#13737](https://github.com/ClickHouse/ClickHouse/pull/13737) ([Azat Khuzhin](https://github.com/azat)).
* 修复在检查用户和用户组时 `clickhouse-server.init` 中的错误消息。[#13711](https://github.com/ClickHouse/ClickHouse/pull/13711) ([ylchou](https://github.com/ylchou)).
* 在启用 `optimize_move_functions_out_of_any` 时，不要将 `any(arrayJoin())` 优化为 `arrayJoin()`。[#13681](https://github.com/ClickHouse/ClickHouse/pull/13681) ([Azat Khuzhin](https://github.com/azat)).
* 修复了并发执行 `ALTER ... REPLACE/MOVE PARTITION ...` 查询时可能出现的死锁问题。[#13626](https://github.com/ClickHouse/ClickHouse/pull/13626) ([tavplubix](https://github.com/tavplubix)).
* 修复了 `cache-dictionary` 有时会在源中存在值的情况下错误返回默认值的问题。[#13624](https://github.com/ClickHouse/ClickHouse/pull/13624) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 修复紧凑分片中二级索引损坏的问题（紧凑分片是一个实验性功能）。[#13538](https://github.com/ClickHouse/ClickHouse/pull/13538) ([Anton Popov](https://github.com/CurtizJ))。
* 修复函数 `netloc` 中的错误代码。此更改修复了 [#13335](https://github.com/ClickHouse/ClickHouse/issues/13335)。[#13446](https://github.com/ClickHouse/ClickHouse/pull/13446)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在将 Unix 时间戳作为参数传递时 `parseDateTimeBestEffort` 函数中的错误。此修复解决了 [#13362](https://github.com/ClickHouse/ClickHouse/issues/13362)。[#13441](https://github.com/ClickHouse/ClickHouse/pull/13441)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复包含 `NULL` 元素的元组比较时的返回类型无效问题。修复了 [#12461](https://github.com/ClickHouse/ClickHouse/issues/12461)。[#13420](https://github.com/ClickHouse/ClickHouse/pull/13420)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了错误的优化：在设置 `SET optimize_move_functions_out_of_any = 1` 且在 `any()` 中使用别名时，会导致 `aggregate function any(x) is found inside another aggregate function in query` 错误。 [#13419](https://github.com/ClickHouse/ClickHouse/pull/13419) ([Artem Zuikov](https://github.com/4ertus2)).
* 修复 `StorageMemory` 中可能出现的竞争条件。 [#13416](https://github.com/ClickHouse/ClickHouse/pull/13416) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复在查询返回零行时 `Arrow` 和 `Parquet` 格式产生空输出的问题。之所以进行此更改，是因为对于这些格式来说，空输出是无效的。[#13399](https://github.com/ClickHouse/ClickHouse/pull/13399) ([hcz](https://github.com/hczhcz))。
* 修复在 `ORDER BY` 子句中包含常量列和主键前缀的 `SELECT` 查询。[#13396](https://github.com/ClickHouse/ClickHouse/pull/13396) ([Anton Popov](https://github.com/CurtizJ))。
* 修复 `clickhouse-local` 中的 `PrettyCompactMonoBlock`。修复使用 `PrettyCompactMonoBlock` 时的 extremes/totals。修复 [#7746](https://github.com/ClickHouse/ClickHouse/issues/7746)。[#13394](https://github.com/ClickHouse/ClickHouse/pull/13394)（[Azat Khuzhin](https://github.com/azat)）。
* 修复了 `system.text_log` 中的死锁问题。 [#12452](https://github.com/ClickHouse/ClickHouse/pull/12452) ([alexey-milovidov](https://github.com/alexey-milovidov))。该修复是 [#12339](https://github.com/ClickHouse/ClickHouse/issues/12339) 的一部分，并修复了 [#12325](https://github.com/ClickHouse/ClickHouse/issues/12325)。 [#13386](https://github.com/ClickHouse/ClickHouse/pull/13386) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 修复了 `File(TSVWithNames*)`（表头被多次写入），修复了 `clickhouse-local --format CSVWithNames*`（缺少表头，在 [#12197](https://github.com/ClickHouse/ClickHouse/issues/12197) 之后出现问题），修复了在零行情况下的 `clickhouse-local --format CSVWithNames*`（缺少表头）。[#13343](https://github.com/ClickHouse/ClickHouse/pull/13343)（[Azat Khuzhin](https://github.com/azat)）。
* 修复函数 `groupArrayMovingSum` 在反序列化空状态时发生的段错误。修复了 [#13339](https://github.com/ClickHouse/ClickHouse/issues/13339)。[#13341](https://github.com/ClickHouse/ClickHouse/pull/13341)（[alesapin](https://github.com/alesapin)）。
* 在 `JOIN ON` 子句中使用 `arrayJoin()` 函数时抛出错误。 [#13330](https://github.com/ClickHouse/ClickHouse/pull/13330) ([Artem Zuikov](https://github.com/4ertus2)).
* 修复在 `join_use_nulls=1` 时发生的 `LEFT ASOF JOIN` 崩溃问题。 [#13291](https://github.com/ClickHouse/ClickHouse/pull/13291) ([Artem Zuikov](https://github.com/4ertus2)).
* 修复在从延迟副本查询时可能出现的错误 `Totals having transform was already added to pipeline`。[#13290](https://github.com/ClickHouse/ClickHouse/pull/13290)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 如果用户向函数 `h3ToChildren` 传递特制构造的参数，服务器可能会崩溃。本修复解决了 [#13275](https://github.com/ClickHouse/ClickHouse/issues/13275)。[#13277](https://github.com/ClickHouse/ClickHouse/pull/13277)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在对包含 `NaN` 值的 Float 类型列调用 `uniqExact`、`topK`、`sumDistinct` 等聚合函数时可能出现的性能较低和结果略有不准确的问题。这些问题还会在调试构建中触发断言。本次修复了 [#12491](https://github.com/ClickHouse/ClickHouse/issues/12491)。[#13254](https://github.com/ClickHouse/ClickHouse/pull/13254)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `KeyCondition` 中的断言问题：当主键包含带有单调函数的表达式且查询中包含与常量的比较（该常量的类型不同）时会触发此问题。本修复解决了 [#12465](https://github.com/ClickHouse/ClickHouse/issues/12465)。[#13251](https://github.com/ClickHouse/ClickHouse/pull/13251)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在函数 `roundUpToPowerOfTwoOrZero()` 中，对于最高有效位（MSB）已设置的数字，返回传入的数字本身。这样可以在数组大小发生溢出时避免潜在错误。[#13234](https://github.com/ClickHouse/ClickHouse/pull/13234)（[Azat Khuzhin](https://github.com/azat)）。
* 修复 `if` 函数在条件为可空 `constexpr` 且不是字面量 `NULL` 时的行为。修复了 [#12463](https://github.com/ClickHouse/ClickHouse/issues/12463)。[#13226](https://github.com/ClickHouse/ClickHouse/pull/13226)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `arrayElement` 函数在数组元素为 Nullable 且数组下标也为 Nullable 时的断言。修复了 [#12172](https://github.com/ClickHouse/ClickHouse/issues/12172)。[#13224](https://github.com/ClickHouse/ClickHouse/pull/13224)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复带有常量参数的 `DateTime64` 转换函数。 [#13205](https://github.com/ClickHouse/ClickHouse/pull/13205) ([Azat Khuzhin](https://github.com/azat)).
* 修复从 `users.xml` 中解析行策略时，当数据库或表名包含点号时的解析问题。修复了 [#5779](https://github.com/ClickHouse/ClickHouse/issues/5779)、[#12527](https://github.com/ClickHouse/ClickHouse/issues/12527)。[#13199](https://github.com/ClickHouse/ClickHouse/pull/13199)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复在连接被中断一次后无法访问 `redis` 字典的问题。该问题可能会出现在 `cache` 和 `direct` 字典布局中。[#13082](https://github.com/ClickHouse/ClickHouse/pull/13082) ([Anton Popov](https://github.com/CurtizJ))。
* 修复使用函数时的错误索引分析。该问题可能会导致从 `MergeTree` 表读取时跳过某些数据部分。修复了 [#13060](https://github.com/ClickHouse/ClickHouse/issues/13060)。修复了 [#12406](https://github.com/ClickHouse/ClickHouse/issues/12406)。[#13081](https://github.com/ClickHouse/ClickHouse/pull/13081)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复在远程查询中使用在当前查询范围内是确定性的、但在不同查询之间并不确定的函数（如 `now()`, `now64()`, `randConstant()`）时出现的错误 `Cannot convert column because it is constant but values of constants are different in source and result`。修复了 [#11327](https://github.com/ClickHouse/ClickHouse/issues/11327)。[#13075](https://github.com/ClickHouse/ClickHouse/pull/13075)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在带有 `ORDER BY` 元组且设置了较小 `LIMIT` 的查询中可能发生的崩溃问题。修复了 [#12623](https://github.com/ClickHouse/ClickHouse/issues/12623)。[#13009](https://github.com/ClickHouse/ClickHouse/pull/13009)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复含有 `UNION` 和 `JOIN` 的查询中的 `Block structure mismatch` 错误。修复了 [#12602](https://github.com/ClickHouse/ClickHouse/issues/12602)。[#12989](https://github.com/ClickHouse/ClickHouse/pull/12989)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修正了 `merge_with_ttl_timeout` 逻辑，该逻辑在同一时间区间内有多个分区到期时工作不佳。（由 @excitoon 编写）。[#12982](https://github.com/ClickHouse/ClickHouse/pull/12982)（[Alexander Kazakov](https://github.com/Akazz)）。
* 修复通过 DDL 查询创建的范围哈希字典中列重复的问题。此更改修复了 [#10605](https://github.com/ClickHouse/ClickHouse/issues/10605)。[#12857](https://github.com/ClickHouse/ClickHouse/pull/12857)（[alesapin](https://github.com/alesapin)）。
* 修复从本地副本执行 `SELECT` 时对线程数量施加的非必要限制。[#12840](https://github.com/ClickHouse/ClickHouse/pull/12840) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复了一个罕见的 bug：当 `ALTER DELETE` 和 `ALTER MODIFY COLUMN` 查询作为单个 mutation 同时执行时，会导致 `count.txt` 中的行数不正确，进而导致数据分片中的数据不正确。同时还修复了一个在同时执行 `ALTER RENAME COLUMN` 和 `ALTER ADD COLUMN` 时出现的小 bug。 [#12760](https://github.com/ClickHouse/ClickHouse/pull/12760) ([alesapin](https://github.com/alesapin)).
* 在使用 `clickhouse` 字典源查询远程表时，会使用错误的凭据。[#12756](https://github.com/ClickHouse/ClickHouse/pull/12756) ([sundyli](https://github.com/sundy-li)).
* 修复 `CAST(Nullable(String), Enum())`。 [#12745](https://github.com/ClickHouse/ClickHouse/pull/12745)（[Azat Khuzhin](https://github.com/azat)）。
* 修复在 `IN` 子句中处理大型元组（`tuple`）时的性能问题，此类元组会被解释为函数。即用户出于某些不明原因，将 `WHERE x IN (1, 2, ...)` 写成 `WHERE x IN tuple(1, 2, ...)` 的情况。[#12700](https://github.com/ClickHouse/ClickHouse/pull/12700)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复 `input&#95;format&#95;parallel&#95;parsing` 的内存跟踪问题（通过将线程附加到组）。 [#12672](https://github.com/ClickHouse/ClickHouse/pull/12672) ([Azat Khuzhin](https://github.com/azat)).
* 在 `any(func(&lt;lambda&gt;))` 的情况下，修复错误的优化 `optimize_move_functions_out_of_any=1`。[#12664](https://github.com/ClickHouse/ClickHouse/pull/12664) ([Artem Zuikov](https://github.com/4ertus2))。
* 修复了 [#10572](https://github.com/ClickHouse/ClickHouse/issues/10572) 中 `bloom filter` 索引与常量表达式配合使用的问题。[#12659](https://github.com/ClickHouse/ClickHouse/pull/12659)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复在代理不可用（及其他情况）时 `StorageKafka` 中出现的 SIGSEGV。 [#12658](https://github.com/ClickHouse/ClickHouse/pull/12658) ([Azat Khuzhin](https://github.com/azat)).
* 为函数 `if` 添加对 `Array(UUID)` 参数的支持。修复了 [#11066](https://github.com/ClickHouse/ClickHouse/issues/11066)。[#12648](https://github.com/ClickHouse/ClickHouse/pull/12648)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `CREATE USER IF NOT EXISTS` 在用户已存在时，现在不会抛出异常。修复了 [#12507](https://github.com/ClickHouse/ClickHouse/issues/12507)。[#12646](https://github.com/ClickHouse/ClickHouse/pull/12646)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 在某些非预期情况下（例如对 UInt64 列执行减法运算时），`ALTER ... UPDATE` 可能会抛出异常 `There is no supertype...`。此更改修复了 [#7306](https://github.com/ClickHouse/ClickHouse/issues/7306)。此更改修复了 [#4165](https://github.com/ClickHouse/ClickHouse/issues/4165)。[#12633](https://github.com/ClickHouse/ClickHouse/pull/12633)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在使用外部排序的查询中可能出现的 `Pipeline stuck` 错误。修复了 [#12617](https://github.com/ClickHouse/ClickHouse/issues/12617)。[#12618](https://github.com/ClickHouse/ClickHouse/pull/12618)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复 `OPTIMIZE DEDUPLICATE` 中的错误 `Output of TreeExecutor is not sorted`。修复了 [#11572](https://github.com/ClickHouse/ClickHouse/issues/11572)。 [#12613](https://github.com/ClickHouse/ClickHouse/pull/12613)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在查询优化期间，函数 `any` 结果的别名可能丢失的问题。 [#12593](https://github.com/ClickHouse/ClickHouse/pull/12593) ([Anton Popov](https://github.com/CurtizJ))。
* 在执行 DROP TABLE 时，删除 Distributed 表的数据（来自异步 INSERT 的数据块）。[#12556](https://github.com/ClickHouse/ClickHouse/pull/12556)（[Azat Khuzhin](https://github.com/azat)）。
* 现在，当文件 `checksums.txt` 缺失时，ClickHouse 将重新计算各个 part 的校验和。该问题自 [#9827](https://github.com/ClickHouse/ClickHouse/issues/9827) 起出现。[#12545](https://github.com/ClickHouse/ClickHouse/pull/12545)（[alesapin](https://github.com/alesapin)）。
* 修复了在 `enable_mixed_granularity_parts=1` 时执行 `ALTER DELETE` 查询会导致旧部件损坏的错误。修复了 [#12536](https://github.com/ClickHouse/ClickHouse/issues/12536)。[#12543](https://github.com/ClickHouse/ClickHouse/pull/12543)（[alesapin](https://github.com/alesapin)）。
* 修复了 live view 表中的竞态条件问题，该问题可能导致数据重复。`LIVE VIEW` 是一项实验性功能。 [#12519](https://github.com/ClickHouse/ClickHouse/pull/12519) ([vzakaznikov](https://github.com/vzakaznikov)).
* 修复 `AggregateFunction(avg, ...)` 值的二进制格式的向后兼容性问题。此修复解决了 [#12342](https://github.com/ClickHouse/ClickHouse/issues/12342)。[#12486](https://github.com/ClickHouse/ClickHouse/pull/12486)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在使用字典进行 `JOIN` 时，当按照字典键的表达式进行关联（`t JOIN dict ON expr(dict.id) = t.id`）会导致崩溃的问题。针对该场景禁用字典 `JOIN` 的优化。 [#12458](https://github.com/ClickHouse/ClickHouse/pull/12458) ([Artem Zuikov](https://github.com/4ertus2)).
* 修复在指定非常大的 `LIMIT` 或 `OFFSET` 时发生的溢出问题。修复了 [#10470](https://github.com/ClickHouse/ClickHouse/issues/10470)。修复了 [#11372](https://github.com/ClickHouse/ClickHouse/issues/11372)。[#12427](https://github.com/ClickHouse/ClickHouse/pull/12427)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* kafka：修复在批次中间存在出错消息时发生 SIGSEGV 的问题。[#12302](https://github.com/ClickHouse/ClickHouse/pull/12302)（[Azat Khuzhin](https://github.com/azat)）。

#### 改进 {#improvement-13}


* 在 ZooKeeper 中保留较少数量的日志。避免在存在大量服务器/表/插入操作且有副本离线的情况下导致 ZooKeeper 节点过度增长。[#13100](https://github.com/ClickHouse/ClickHouse/pull/13100) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 现在在执行 `ALTER` 或变更操作时，如果发生错误，会将异常转发给客户端。修复了 [#11329](https://github.com/ClickHouse/ClickHouse/issues/11329)。[#12666](https://github.com/ClickHouse/ClickHouse/pull/12666)（[alesapin](https://github.com/alesapin)）。
* 将 `QueryTimeMicroseconds`、`SelectQueryTimeMicroseconds` 和 `InsertQueryTimeMicroseconds` 添加到 `system.events` 中，并在 `system.metrics`、`processes`、`query_log` 等系统中提供。[#13028](https://github.com/ClickHouse/ClickHouse/pull/13028) ([ianton-ru](https://github.com/ianton-ru))。
* 在 `system.events` 中新增了 `SelectedRows` 和 `SelectedBytes`，并在 `system.metrics`、`processes`、`query_log` 等中同样添加了这些指标。[#12638](https://github.com/ClickHouse/ClickHouse/pull/12638) ([ianton-ru](https://github.com/ianton-ru))。
* 在 `system.query_log` 中新增了 `current_database` 字段。[#12652](https://github.com/ClickHouse/ClickHouse/pull/12652)（[Amos Bird](https://github.com/amosbird)）。
* 允许使用 `TabSeparatedRaw` 作为输入格式。 [#12009](https://github.com/ClickHouse/ClickHouse/pull/12009) ([hcz](https://github.com/hczhcz)).
* 现在 `joinGet` 支持多键查询。[#12418](https://github.com/ClickHouse/ClickHouse/pull/12418) ([Amos Bird](https://github.com/amosbird))。
* 允许 `*Map` 聚合函数可用于包含 NULL 的数组。修复 [#13157](https://github.com/ClickHouse/ClickHouse/issues/13157)。[#13225](https://github.com/ClickHouse/ClickHouse/pull/13225)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在解析 DateTime 值时，避免发生溢出从而在其所在时区产生负的 Unix 时间戳（例如莫斯科时区的 `1970-01-01 00:00:00`）。改为饱和到零。修复了 [#3470](https://github.com/ClickHouse/ClickHouse/issues/3470)。修复了 [#4172](https://github.com/ClickHouse/ClickHouse/issues/4172)。[#12443](https://github.com/ClickHouse/ClickHouse/pull/12443)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* AvroConfluent：跳过 Kafka tombstone 记录 — 支持跳过损坏的记录 [#13203](https://github.com/ClickHouse/ClickHouse/pull/13203) ([Andrew Onyshchuk](https://github.com/oandrew))。
* 修复长查询返回错误错误类型的问题。对于正确的查询，有可能得到除 `Max query size exceeded` 之外的语法错误。[#13928](https://github.com/ClickHouse/ClickHouse/pull/13928)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复 `lgamma` 函数中的数据竞争问题。该问题仅在使用 `tsan` 时被捕获，实际并未产生任何副作用。[#13842](https://github.com/ClickHouse/ClickHouse/pull/13842)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复 ATTACH/ALTER/CREATE QUOTA 语句中 &#39;Week&#39; 间隔的格式化方式。 [#13417](https://github.com/ClickHouse/ClickHouse/pull/13417) ([vladimir-golovchenko](https://github.com/vladimir-golovchenko)).
* 现在，在处理紧凑部件（`compact parts`）时遇到的损坏部件也会被报告。`compact parts` 是一项实验性功能。[#13282](https://github.com/ClickHouse/ClickHouse/pull/13282) ([Amos Bird](https://github.com/amosbird))。
* 修复 `geohashesInBox` 中的断言，解决了 [#12554](https://github.com/ClickHouse/ClickHouse/issues/12554)。[#13229](https://github.com/ClickHouse/ClickHouse/pull/13229)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `parseDateTimeBestEffort` 中的断言问题，解决了 [#12649](https://github.com/ClickHouse/ClickHouse/issues/12649)。[#13227](https://github.com/ClickHouse/ClickHouse/pull/13227)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 Processors/PipelineExecutor 中进行了一项小优化：在合适的情况下提前跳出循环。[#13058](https://github.com/ClickHouse/ClickHouse/pull/13058)（[Mark Papadakis](https://github.com/markpapadakis)）。
* 支持在执行 `TRUNCATE` 时省略 `TABLE` 关键字。 [#12653](https://github.com/ClickHouse/ClickHouse/pull/12653) ([Winter Zhang](https://github.com/zhang2014)).
* 修复默认情况下 `EXPLAIN` 查询格式被覆盖的问题。此更改修复了 [#12541](https://github.com/ClickHouse/ClickHouse/issues/12432)。[#12541](https://github.com/ClickHouse/ClickHouse/pull/12541)（[BohuTANG](https://github.com/BohuTANG)）。
* 允许以更标准的方式设置 JOIN 的类型：使用 `LEFT SEMI JOIN` 而不是 `SEMI LEFT JOIN`。目前两种写法都有效。[#12520](https://github.com/ClickHouse/ClickHouse/pull/12520) ([Artem Zuikov](https://github.com/4ertus2)).
* 将 `multiple_joins_rewriter_version` 的默认值更改为 2。此举启用了新的多表 JOIN 重写器，该重写器能够识别列名。[#12469](https://github.com/ClickHouse/ClickHouse/pull/12469) ([Artem Zuikov](https://github.com/4ertus2))。
* 为针对 S3 存储的请求添加若干指标。 [#12464](https://github.com/ClickHouse/ClickHouse/pull/12464) ([ianton-ru](https://github.com/ianton-ru)).
* 为使用 `--secure` 参数的 clickhouse-benchmark 使用正确的默认安全端口。此更改修复了 [#11044](https://github.com/ClickHouse/ClickHouse/issues/11044)。[#12440](https://github.com/ClickHouse/ClickHouse/pull/12440)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 `Log`、`TinyLog`、`StripeLog` 引擎中回滚插入错误。在之前的版本中，插入错误会导致表状态不一致（这符合文档描述，对于这些表引擎来说是预期行为）。此更改修复了 [#12402](https://github.com/ClickHouse/ClickHouse/issues/12402)。[#12426](https://github.com/ClickHouse/ClickHouse/pull/12426)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 实现 `RENAME DATABASE` 和 `RENAME DICTIONARY` 以支持 `Atomic` 数据库引擎。- 添加隐式 `{uuid}` 宏，可在 `ReplicatedMergeTree` 的 ZooKeeper 路径中使用。它可与 `CREATE ... ON CLUSTER ...` 查询配合使用。将 `show_table_uuid_in_table_create_query_if_not_nil` 设置为 `true` 即可启用。- 将 `ReplicatedMergeTree` 引擎参数设为可选，默认使用 `/clickhouse/tables/{uuid}/{shard}/` 和 `{replica}`。修复了 [#12135](https://github.com/ClickHouse/ClickHouse/issues/12135)。- 小幅修复。- 这些更改破坏了 `Atomic` 数据库引擎的向后兼容性。之前创建的 `Atomic` 数据库必须手动转换为新格式。`Atomic` 数据库是一个实验性特性。[#12343](https://github.com/ClickHouse/ClickHouse/pull/12343) ([tavplubix](https://github.com/tavplubix))。
* 将 `AWSAuthV4Signer` 拆分到单独的日志记录器中，并移除了日志消息中多余的 `AWSClient: AWSClient`。 [#12320](https://github.com/ClickHouse/ClickHouse/pull/12320) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 改进磁盘访问存储中的异常信息。 [#12625](https://github.com/ClickHouse/ClickHouse/pull/12625) ([alesapin](https://github.com/alesapin)).
* 针对函数 `in` 的无效参数个数提供了更清晰的异常信息。[#12529](https://github.com/ClickHouse/ClickHouse/pull/12529) ([Anton Popov](https://github.com/CurtizJ)).
* 修复与自适应粒度相关的错误信息。[#12624](https://github.com/ClickHouse/ClickHouse/pull/12624) ([alesapin](https://github.com/alesapin)).
* 修复 FORMAT 之后解析 SETTINGS 的问题。 [#12480](https://github.com/ClickHouse/ClickHouse/pull/12480) ([Azat Khuzhin](https://github.com/azat)).
* 如果 MergeTree 表未包含 ORDER BY 或 PARTITION BY，则可以执行 ALTER 来 CLEAR 所有列，但 ALTER 会卡住不前。已修复 [#7941](https://github.com/ClickHouse/ClickHouse/issues/7941)。[#12382](https://github.com/ClickHouse/ClickHouse/pull/12382)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 避免在每个查询后从历史文件重新加载补全信息（以避免与其他客户端会话的历史记录产生冲突）。 [#13086](https://github.com/ClickHouse/ClickHouse/pull/13086) ([Azat Khuzhin](https://github.com/azat)).

#### 性能改进 {#performance-improvement-6}

- 某些操作的内存使用量最多降低 2 倍。[#12424](https://github.com/ClickHouse/ClickHouse/pull/12424) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 优化精确主键范围匹配查询的主键查找。[#12277](https://github.com/ClickHouse/ClickHouse/pull/12277) ([Ivan Babrou](https://github.com/bobrik))。
- 轻微优化使用 `LowCardinality` 的极短查询。[#14129](https://github.com/ClickHouse/ClickHouse/pull/14129) ([Anton Popov](https://github.com/CurtizJ))。
- 轻微提升按 UInt8/UInt16 键聚合的性能。[#13091](https://github.com/ClickHouse/ClickHouse/pull/13091) 和 [#13055](https://github.com/ClickHouse/ClickHouse/pull/13055) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 在查询计划中下推 `LIMIT` 步骤(子查询内部)。[#13016](https://github.com/ClickHouse/ClickHouse/pull/13016) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 在数据分片上并行执行主键查找和跳数索引阶段,如 [#11564](https://github.com/ClickHouse/ClickHouse/issues/11564) 中所述。[#12589](https://github.com/ClickHouse/ClickHouse/pull/12589) ([Ivan Babrou](https://github.com/bobrik))。
- 当设置 `optimize_if_transform_strings_to_enum = 1` 时,将函数 "if" 和 "transform" 的字符串类型参数转换为枚举。[#12515](https://github.com/ClickHouse/ClickHouse/pull/12515) ([Artem Zuikov](https://github.com/4ertus2))。
- 当设置 `optimize_monotonous_functions_in_order_by=1` 时,在 `ORDER BY` 中用单调函数的参数替换该函数。[#12467](https://github.com/ClickHouse/ClickHouse/pull/12467) ([Artem Zuikov](https://github.com/4ertus2))。
- 添加排序优化,当设置 `optimize_redundant_functions_in_order_by = 1` 时,将 `ORDER BY x, f(x)` 重写为 `ORDER BY x`。[#12404](https://github.com/ClickHouse/ClickHouse/pull/12404) ([Artem Zuikov](https://github.com/4ertus2))。
- 允许在子查询包含 `WITH` 子句时下推谓词。这修复了 [#12293](https://github.com/ClickHouse/ClickHouse/issues/12293)。[#12663](https://github.com/ClickHouse/ClickHouse/pull/12663) ([Winter Zhang](https://github.com/zhang2014))。
- 提升从紧凑分片读取的性能。紧凑分片是一个实验性功能。[#12492](https://github.com/ClickHouse/ClickHouse/pull/12492) ([Anton Popov](https://github.com/CurtizJ))。
- 尝试在 `DiskS3` 中实现流式优化。DiskS3 是一个实验性功能。[#12434](https://github.com/ClickHouse/ClickHouse/pull/12434) ([Vladimir Chebotarev](https://github.com/excitoon))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-8}


* 使用 `shellcheck` 对 sh 测试进行 Lint 检查。 [#13200](https://github.com/ClickHouse/ClickHouse/pull/13200) [#13207](https://github.com/ClickHouse/ClickHouse/pull/13207) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 在 GitHub 钩子中添加用于为 pull request 设置标签的脚本。 [#13183](https://github.com/ClickHouse/ClickHouse/pull/13183) ([alesapin](https://github.com/alesapin)).
* 移除部分递归子模块。参见 [#13378](https://github.com/ClickHouse/ClickHouse/issues/13378)、[#13379](https://github.com/ClickHouse/ClickHouse/pull/13379)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 确保所有子模块都来自正确的 URL。[#13379](https://github.com/ClickHouse/ClickHouse/issues/13379) 的后续。此更改修复了 [#13378](https://github.com/ClickHouse/ClickHouse/issues/13378)。[#13397](https://github.com/ClickHouse/ClickHouse/pull/13397)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 新增了对用户自定义设置的支持，这些设置可以在查询中访问。当将 ClickHouse 引擎作为其他系统的组件使用时，需要此功能。[#13013](https://github.com/ClickHouse/ClickHouse/pull/13013)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 在 TestFlows 中新增了对 `INSERT` 权限 RBAC 功能的测试。扩展了用于进行 `SELECT` 测试的表范围。新增了 Requirements 以涵盖新的表引擎测试。[#13340](https://github.com/ClickHouse/ClickHouse/pull/13340) ([MyroTk](https://github.com/MyroTk)).
* 在压力测试中修复服务器重启时出现的超时错误。 [#13321](https://github.com/ClickHouse/ClickHouse/pull/13321) ([alesapin](https://github.com/alesapin)).
* 现在快速测试会通过多次重试来等待服务器。[#13284](https://github.com/ClickHouse/ClickHouse/pull/13284) ([alesapin](https://github.com/alesapin)).
* 函数 `materialize()`（用于 ClickHouse 测试的函数）在处理 NULL 时将按预期工作——通过将其转换为非常量列。[#13212](https://github.com/ClickHouse/ClickHouse/pull/13212)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 AArch64 上的 `libunwind` 编译问题。修复了 [#13204](https://github.com/ClickHouse/ClickHouse/issues/13204)。[#13208](https://github.com/ClickHouse/ClickHouse/pull/13208)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 `zkutil` 的 `gtest` 中进一步增加了重试次数，以减少测试不稳定性。[#13165](https://github.com/ClickHouse/ClickHouse/pull/13165) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 对 RBAC TestFlows 进行了一些小修复。 [#13152](https://github.com/ClickHouse/ClickHouse/pull/13152) ([vzakaznikov](https://github.com/vzakaznikov)).
* 修复 `00960_live_view_watch_events_live.py` 测试。[#13108](https://github.com/ClickHouse/ClickHouse/pull/13108) ([vzakaznikov](https://github.com/vzakaznikov)).
* 改进文档部署脚本中的缓存刷新。 [#13107](https://github.com/ClickHouse/ClickHouse/pull/13107) ([alesapin](https://github.com/alesapin)).
* 将一些孤立的测试重写为 `gtest`。从测试中移除了多余的 `include`。 [#13073](https://github.com/ClickHouse/ClickHouse/pull/13073) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 在 TestFlows 中为 `SELECT` 权限的 RBAC 功能增加了测试。[#13061](https://github.com/ClickHouse/ClickHouse/pull/13061) ([Ritaank Tiwari](https://github.com/ritaank)).
* 在快速测试检查中重新执行了一些测试。 [#12992](https://github.com/ClickHouse/ClickHouse/pull/12992) ([alesapin](https://github.com/alesapin)).
* 修复 `rdkafka` 库中的 MSan 错误，修复完成后关闭了 [#12990](https://github.com/ClickHouse/ClickHouse/issues/12990)。将 `rdkafka` 更新到 1.5 版本（master）。[#12991](https://github.com/ClickHouse/ClickHouse/pull/12991)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在启用 AVX-512 的服务器上运行测试时，修复了 `base64` 中的 UBSan 报告。此修复解决了 [#12318](https://github.com/ClickHouse/ClickHouse/issues/12318)。作者：@qoega。[#12441](https://github.com/ClickHouse/ClickHouse/pull/12441)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 HDFS 库中的 UBSan 报告问题。关闭 [#12330](https://github.com/ClickHouse/ClickHouse/issues/12330)。[#12453](https://github.com/ClickHouse/ClickHouse/pull/12453)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 检查是否能够从旧版本恢复备份到新版本。修复了 [#8979](https://github.com/ClickHouse/ClickHouse/issues/8979)。[#12959](https://github.com/ClickHouse/ClickHouse/pull/12959)（[alesapin](https://github.com/alesapin)）。
* 不要在集成测试中构建 helper&#95;container 镜像。应在 CI 中构建 Docker 容器，并在集成测试中使用预先构建好的 helper&#95;container。[#12953](https://github.com/ClickHouse/ClickHouse/pull/12953) ([Ilya Yatsishin](https://github.com/qoega))。
* 为主键列的 `ALTER TABLE CLEAR COLUMN` 查询添加了测试。[#12951](https://github.com/ClickHouse/ClickHouse/pull/12951) ([alesapin](https://github.com/alesapin))。
* 增加了 testflows 测试的超时时间。[#12949](https://github.com/ClickHouse/ClickHouse/pull/12949) ([vzakaznikov](https://github.com/vzakaznikov))。
* 修复在 Mac OS X 下测试构建的问题。此更改关闭了 [#12767](https://github.com/ClickHouse/ClickHouse/issues/12767)。[#12772](https://github.com/ClickHouse/ClickHouse/pull/12772)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* Connector-ODBC 升级为 mysql-connector-odbc-8.0.21。 [#12739](https://github.com/ClickHouse/ClickHouse/pull/12739) ([Ilya Yatsishin](https://github.com/qoega)).
* 在 TestFlows 中添加 RBAC 语法测试。[#12642](https://github.com/ClickHouse/ClickHouse/pull/12642)（[vzakaznikov](https://github.com/vzakaznikov)）。
* 提升 TestKeeper 的性能，从而加速大量使用 Replicated 表的测试。[#12505](https://github.com/ClickHouse/ClickHouse/pull/12505) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 现在我们检查在压力测试运行完成后，服务器是否仍然能够启动。这修复了 [#12473](https://github.com/ClickHouse/ClickHouse/issues/12473)。[#12496](https://github.com/ClickHouse/ClickHouse/pull/12496)（[alesapin](https://github.com/alesapin)）。
* 将 `fmtlib` 更新到 master（7.0.1）。[#12446](https://github.com/ClickHouse/ClickHouse/pull/12446) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 为快速测试添加 Docker 镜像。[#12294](https://github.com/ClickHouse/ClickHouse/pull/12294) ([alesapin](https://github.com/alesapin)).
* 重构集成测试的配置路径。[#12285](https://github.com/ClickHouse/ClickHouse/pull/12285)（[Ilya Yatsishin](https://github.com/qoega)）。
* 添加编译器选项，用于限制栈帧大小，避免其过大。这有助于在栈空间较小的 fiber 中运行代码。[#11524](https://github.com/ClickHouse/ClickHouse/pull/11524) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 更新 gitignore 文件。 [#13447](https://github.com/ClickHouse/ClickHouse/pull/13447) ([vladimir-golovchenko](https://github.com/vladimir-golovchenko)).





## ClickHouse 版本 20.6 {#clickhouse-release-206}

### ClickHouse 版本 v20.6.3.28-stable {#clickhouse-release-v206328-stable}

#### 向后不兼容的变更 {#backward-incompatible-change-6}

- 从 20.5 之前的版本升级时,如果执行滚动更新且集群同时包含 20.5 或更高版本和低于 20.5 的版本,当重启运行旧版本的 ClickHouse 节点时,如果旧版本在存在较新版本的情况下启动,可能会导致 `Part ... intersects previous part` 错误。为防止此错误,请先在所有集群节点上安装较新的 clickhouse-server 软件包,然后再执行重启(这样 clickhouse-server 重启时将以新版本启动)。

#### 新功能 {#new-feature-6}

- 添加了 `EXPLAIN` 查询的初始实现。语法:`EXPLAIN SELECT ...`。修复了 [#1118](https://github.com/ClickHouse/ClickHouse/issues/1118)。[#11873](https://github.com/ClickHouse/ClickHouse/pull/11873) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 添加了 `RabbitMQ` 存储引擎。[#11069](https://github.com/ClickHouse/ClickHouse/pull/11069) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 实现了类似 PostgreSQL 的 `ILIKE` 操作符,用于 [#11710](https://github.com/ClickHouse/ClickHouse/issues/11710)。[#12125](https://github.com/ClickHouse/ClickHouse/pull/12125) ([Mike](https://github.com/myrrc))。
- 支持使用 `SET join_algorithm = 'partial_merge'` 的 RIGHT 和 FULL JOIN。仅允许 ALL 严格性(不支持 ANY、SEMI、ANTI、ASOF)。[#12118](https://github.com/ClickHouse/ClickHouse/pull/12118) ([Artem Zuikov](https://github.com/4ertus2))。
- 添加了函数 `initializeAggregation`,用于基于单个值初始化聚合。[#12109](https://github.com/ClickHouse/ClickHouse/pull/12109) ([Guillaume Tassery](https://github.com/YiuRULE))。
- 支持 `ALTER TABLE ... [ADD|MODIFY] COLUMN ... FIRST` [#4006](https://github.com/ClickHouse/ClickHouse/issues/4006)。[#12073](https://github.com/ClickHouse/ClickHouse/pull/12073) ([Winter Zhang](https://github.com/zhang2014))。
- 添加了函数 `parseDateTimeBestEffortUS`。[#12028](https://github.com/ClickHouse/ClickHouse/pull/12028) ([flynn](https://github.com/ucasFL))。
- 支持 `ORC` 格式的输出(之前仅支持输入)。[#11662](https://github.com/ClickHouse/ClickHouse/pull/11662) ([Kruglov Pavel](https://github.com/Avogar))。

#### 错误修复 {#bug-fix-25}


* 修复了在查询中出现的 `aggregate function any(x) is found inside another aggregate function in query` 错误，方法是设置 `SET optimize_move_functions_out_of_any = 1` 并在 `any()` 中使用别名。[#13419](https://github.com/ClickHouse/ClickHouse/pull/13419) ([Artem Zuikov](https://github.com/4ertus2)).
* 修复了 clickhouse-local 中的 `PrettyCompactMonoBlock`。修复了 `PrettyCompactMonoBlock` 与 extremes/totals 的配合行为。这修复了 [#7746](https://github.com/ClickHouse/ClickHouse/issues/7746)。[#13394](https://github.com/ClickHouse/ClickHouse/pull/13394)（[Azat Khuzhin](https://github.com/azat)）。
* 修复了在从延迟副本执行查询时可能出现的错误 `Totals having transform was already added to pipeline`。 [#13290](https://github.com/ClickHouse/ClickHouse/pull/13290) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 如果用户向函数 `h3ToChildren` 传递特定构造的参数，服务器可能会崩溃。此更改修复了 [#13275](https://github.com/ClickHouse/ClickHouse/issues/13275)。[#13277](https://github.com/ClickHouse/ClickHouse/pull/13277)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在包含 NaN 值的 Float 类型上调用 `uniqExact`、`topK`、`sumDistinct` 等聚合函数时，可能出现的性能较低以及结果略有不准确的问题。这些情况还会在 debug 构建中触发断言。本次修复解决了 [#12491](https://github.com/ClickHouse/ClickHouse/issues/12491)。[#13254](https://github.com/ClickHouse/ClickHouse/pull/13254)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在 `if` 函数中，将可为空的 `constexpr`（且非字面量 `NULL`）用作条件时的问题。修复了 [#12463](https://github.com/ClickHouse/ClickHouse/issues/12463)。[#13226](https://github.com/ClickHouse/ClickHouse/pull/13226)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在数组元素为 Nullable 且数组下标也为 Nullable 时，`arrayElement` 函数中的断言。此更改修复了 [#12172](https://github.com/ClickHouse/ClickHouse/issues/12172)。[#13224](https://github.com/ClickHouse/ClickHouse/pull/13224)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在使用常量参数时的 `DateTime64` 转换函数。 [#13205](https://github.com/ClickHouse/ClickHouse/pull/13205) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在使用函数时的错误索引分析。在从 `MergeTree` 表读取时，该问题可能会导致错误地裁剪数据分区。修复了 [#13060](https://github.com/ClickHouse/ClickHouse/issues/13060)。修复了 [#12406](https://github.com/ClickHouse/ClickHouse/issues/12406)。[#13081](https://github.com/ClickHouse/ClickHouse/pull/13081)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复了在远程查询中使用在单个查询范围内是确定性的、但在不同查询之间并非确定性的函数（如 `now()`, `now64()`, `randConstant()`）时出现的错误 `Cannot convert column because it is constant but values of constants are different in source and result`。修复了 [#11327](https://github.com/ClickHouse/ClickHouse/issues/11327)。 [#13075](https://github.com/ClickHouse/ClickHouse/pull/13075)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在从本地副本执行 `SELECT` 时对线程数量施加的多余限制。[#12840](https://github.com/ClickHouse/ClickHouse/pull/12840)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了一个罕见的 bug：当同时将 `ALTER DELETE` 和 `ALTER MODIFY COLUMN` 查询作为单个 mutation 执行时，会导致 `count.txt` 中的行数不正确，进而导致分片中的数据不正确。同时还修复了一个在同时执行 `ALTER RENAME COLUMN` 和 `ALTER ADD COLUMN` 时出现的小 bug。 [#12760](https://github.com/ClickHouse/ClickHouse/pull/12760) ([alesapin](https://github.com/alesapin))。
* 修复了 `CAST(Nullable(String), Enum())`。[#12745](https://github.com/ClickHouse/ClickHouse/pull/12745)（[Azat Khuzhin](https://github.com/azat)）。
* 修复了在处理大型 `tuple` 时的性能问题，此前这些 `tuple` 会在 `IN` 子句中被解释为函数。即在某些少见的情况下，用户会写成 `WHERE x IN tuple(1, 2, ...)`，而不是 `WHERE x IN (1, 2, ...)`。 [#12700](https://github.com/ClickHouse/ClickHouse/pull/12700) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了 `input_format_parallel_parsing` 的内存跟踪问题（通过将线程附加到组）。[#12672](https://github.com/ClickHouse/ClickHouse/pull/12672) ([Azat Khuzhin](https://github.com/azat)).
* 修复了使用常量表达式的 Bloom 过滤器索引。此更改修复了 [#10572](https://github.com/ClickHouse/ClickHouse/issues/10572)。[#12659](https://github.com/ClickHouse/ClickHouse/pull/12659)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复了在 broker 不可用（以及其他情况）时 `StorageKafka` 中发生的 `SIGSEGV`。[#12658](https://github.com/ClickHouse/ClickHouse/pull/12658) ([Azat Khuzhin](https://github.com/azat)).
* 为 `if` 函数新增对 `Array(UUID)` 参数的支持。修复了 [#11066](https://github.com/ClickHouse/ClickHouse/issues/11066)。[#12648](https://github.com/ClickHouse/ClickHouse/pull/12648)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `CREATE USER IF NOT EXISTS` 现在在用户已存在时不会抛出异常。修复了 [#12507](https://github.com/ClickHouse/ClickHouse/issues/12507)。[#12646](https://github.com/ClickHouse/ClickHouse/pull/12646)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 改进磁盘访问存储中的异常信息。 [#12625](https://github.com/ClickHouse/ClickHouse/pull/12625) ([alesapin](https://github.com/alesapin)).
* 函数 `groupArrayMoving*` 在分布式查询中无法正常工作。其结果在错误的数据类型下计算（没有提升到最大的数据类型）。函数 `groupArrayMovingAvg` 返回的整数值与 `avg` 函数不一致。此更改修复了 [#12568](https://github.com/ClickHouse/ClickHouse/issues/12568)。[#12622](https://github.com/ClickHouse/ClickHouse/pull/12622)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了函数 `any` 缺少别名的情况。[#12593](https://github.com/ClickHouse/ClickHouse/pull/12593) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了在使用缓存布局的外部字典中可能导致服务器崩溃的竞态条件。[#12566](https://github.com/ClickHouse/ClickHouse/pull/12566) ([alesapin](https://github.com/alesapin)).
* 在执行 DROP TABLE 时删除 Distributed 表的数据（来自异步 INSERT 的数据块）。[#12556](https://github.com/ClickHouse/ClickHouse/pull/12556) ([Azat Khuzhin](https://github.com/azat))。
* 修复了在 `enable_mixed_granularity_parts=1` 时执行 `ALTER DELETE` 查询会导致旧分片损坏的错误。修复了 [#12536](https://github.com/ClickHouse/ClickHouse/issues/12536)。[#12543](https://github.com/ClickHouse/ClickHouse/pull/12543)（[alesapin](https://github.com/alesapin)）。
* 为函数 `in` 在参数数量无效时提供更清晰的异常信息。[#12529](https://github.com/ClickHouse/ClickHouse/pull/12529) ([Anton Popov](https://github.com/CurtizJ)).
* 修复 `live view` 表中的竞态条件问题，该问题可能导致数据重复。 [#12519](https://github.com/ClickHouse/ClickHouse/pull/12519) ([vzakaznikov](https://github.com/vzakaznikov)).
* 修复了从 compact 部分读取时的性能问题。 [#12492](https://github.com/ClickHouse/ClickHouse/pull/12492) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了 `AggregateFunction(avg, ...)` 值的二进制格式向后兼容性问题。修复了 [#12342](https://github.com/ClickHouse/ClickHouse/issues/12342)。[#12486](https://github.com/ClickHouse/ClickHouse/pull/12486)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在 `FORMAT` 之后解析 `SETTINGS` 的问题。 [#12480](https://github.com/ClickHouse/ClickHouse/pull/12480) ([Azat Khuzhin](https://github.com/azat))。
* 修复了在启用 `text_log` 时可能出现的死锁问题。[#12452](https://github.com/ClickHouse/ClickHouse/pull/12452) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了在指定非常大的 `LIMIT` 或 `OFFSET` 时出现的溢出问题。修复了 [#10470](https://github.com/ClickHouse/ClickHouse/issues/10470)。修复了 [#11372](https://github.com/ClickHouse/ClickHouse/issues/11372)。[#12427](https://github.com/ClickHouse/ClickHouse/pull/12427)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了 `StorageMerge` 中可能发生的段错误。修复了 [#12054](https://github.com/ClickHouse/ClickHouse/issues/12054)。[#12401](https://github.com/ClickHouse/ClickHouse/pull/12401)（[tavplubix](https://github.com/tavplubix)）。
* 回滚在 [#11079](https://github.com/ClickHouse/ClickHouse/issues/11079) 中引入的变更，以解决 [#12098](https://github.com/ClickHouse/ClickHouse/issues/12098)。[#12397](https://github.com/ClickHouse/ClickHouse/pull/12397)（[Mike](https://github.com/myrrc)）。
* 对 Bloom filter 索引参数增加了额外检查。修复了 [#11408](https://github.com/ClickHouse/ClickHouse/issues/11408)。[#12388](https://github.com/ClickHouse/ClickHouse/pull/12388)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 避免在已建立索引的表中，当在 `WHERE` 条件里使用负数或浮点常量时抛出异常。此修复解决了 [#11905](https://github.com/ClickHouse/ClickHouse/issues/11905)。[#12384](https://github.com/ClickHouse/ClickHouse/pull/12384)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 即使存在依赖它的 `DEFAULT` 表达式，也允许对列执行 `CLEAR`。这修复了 [#12333](https://github.com/ClickHouse/ClickHouse/issues/12333)。[#12378](https://github.com/ClickHouse/ClickHouse/pull/12378)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在使用 `TOTALS/ROLLUP/CUBE` 时，带有 `-State` 和 `Nullable` 参数的聚合函数的行为。修复了 [#12163](https://github.com/ClickHouse/ClickHouse/issues/12163)。[#12376](https://github.com/ClickHouse/ClickHouse/pull/12376)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修正了在不允许使用 `RENAME` 时，`ALTER RENAME COLUMN` 查询的错误消息和退出码。修复了 [#12301](https://github.com/ClickHouse/ClickHouse/issues/12301) 和 [#12303](https://github.com/ClickHouse/ClickHouse/issues/12303)。[#12335](https://github.com/ClickHouse/ClickHouse/pull/12335)（[alesapin](https://github.com/alesapin)）。
* 修复了 `ReplicatedMergeTreeQueue` 中一个极其罕见的竞争问题。 [#12315](https://github.com/ClickHouse/ClickHouse/pull/12315) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 在将编解码器 `Delta` 或 `DoubleDelta` 与非定宽类型一起使用时，本应返回错误代码为 `BAD_ARGUMENTS` 的异常，却返回了错误代码为 `LOGICAL_ERROR` 的异常（我们保证不会出现代码为 `LOGICAL_ERROR` 的异常）。此变更修复了 [#12110](https://github.com/ClickHouse/ClickHouse/issues/12110)。[#12308](https://github.com/ClickHouse/ClickHouse/pull/12308)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了 `WITH FILL` 修饰符中列顺序的处理问题。此前不会按照 `ORDER BY` 子句中列的顺序进行填充。[#12306](https://github.com/ClickHouse/ClickHouse/pull/12306) ([Anton Popov](https://github.com/CurtizJ)).
* 当存在按虚拟列（例如 `Merge` 表中的 `_table`）或系统表中的 “index” 列过滤数据的表达式（例如在查询 `system.tables` 时按数据库名过滤），并且该表达式返回 `Nullable` 类型时，避免抛出 “bad cast” 异常。此更改修复了 [#12166](https://github.com/ClickHouse/ClickHouse/issues/12166)。[#12305](https://github.com/ClickHouse/ClickHouse/pull/12305)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在重命名作为 `TTL` 表达式依赖列后的 `TTL` 行为问题。[#12304](https://github.com/ClickHouse/ClickHouse/pull/12304) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了在 `Kafka` 引擎中，当批次中间存在包含错误的消息时会触发的 SIGSEGV。 [#12302](https://github.com/ClickHouse/ClickHouse/pull/12302) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在更新 `DNS` 缓存时，某些线程可能会随机挂起几秒钟的问题。[#12296](https://github.com/ClickHouse/ClickHouse/pull/12296) ([tavplubix](https://github.com/tavplubix)).
* 修复了设置名称中的拼写错误。 [#12292](https://github.com/ClickHouse/ClickHouse/pull/12292) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 在 `TrieDictionary` 加载失败后显示错误。[#12290](https://github.com/ClickHouse/ClickHouse/pull/12290) ([Vitaly Baranov](https://github.com/vitlibar))。
* 函数 `arrayFill` 在处理空数组时行为不正确，可能导致崩溃。此更改修复了 [#12263](https://github.com/ClickHouse/ClickHouse/issues/12263)。[#12279](https://github.com/ClickHouse/ClickHouse/pull/12279)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 `LowCardinality` 类型实现向通用类型的转换。这样可以对包含 LowCardinality 列和其他列的表执行 UNION ALL。修复了 [#8212](https://github.com/ClickHouse/ClickHouse/issues/8212)。修复了 [#4342](https://github.com/ClickHouse/ClickHouse/issues/4342)。[#12275](https://github.com/ClickHouse/ClickHouse/pull/12275)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在请求 `S3` 存储时达到重定向次数上限时的行为。[#12256](https://github.com/ClickHouse/ClickHouse/pull/12256) ([ianton-ru](https://github.com/ianton-ru)).
* 修复了在对 `StorageFile` 进行多次连续插入时，对于某些特殊类型，其头部会被重复写入的问题。此修复解决了 [#6155](https://github.com/ClickHouse/ClickHouse/issues/6155)。[#12197](https://github.com/ClickHouse/ClickHouse/pull/12197)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 修复了当 `UInt8` 值不为 0 或 1 时的逻辑函数行为。 [#12196](https://github.com/ClickHouse/ClickHouse/pull/12196) ([Alexander Kazakov](https://github.com/Akazz))。
* 将 max&#95;memory&#95;usage* 上限限制为进程的常驻内存。 [#12182](https://github.com/ClickHouse/ClickHouse/pull/12182) ([Azat Khuzhin](https://github.com/azat)).
* 修复在消除 `GROUP BY` 中单射函数时对 `dictGet` 参数的检查。[#12179](https://github.com/ClickHouse/ClickHouse/pull/12179) ([Azat Khuzhin](https://github.com/azat)).
* 修复了 `SummingMergeTree` 引擎在对分区键中的列进行求和时的行为。现在如果显式指定的聚合列与分区键列有交集，则会抛出异常。此更改修复了 [#7867](https://github.com/ClickHouse/ClickHouse/issues/7867)。[#12173](https://github.com/ClickHouse/ClickHouse/pull/12173)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 如果 ODBC 连接不支持 schema，则不要将字典源的表名拆分为 schema 和表名本身。[#12165](https://github.com/ClickHouse/ClickHouse/pull/12165) ([Vitaly Baranov](https://github.com/vitlibar))。
* 修复了 `ALTER DELETE` 中的错误逻辑，该逻辑会在条件计算结果为 NULL 时删除记录。修复了 [#9088](https://github.com/ClickHouse/ClickHouse/issues/9088)。关闭 [#12106](https://github.com/ClickHouse/ClickHouse/issues/12106)。[#12153](https://github.com/ClickHouse/ClickHouse/pull/12153)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在存在别名的情况下，修复了发送到外部 DBMS（例如 MySQL、ODBC）的查询转换。此更改修复了 [#12032](https://github.com/ClickHouse/ClickHouse/issues/12032)。[#12151](https://github.com/ClickHouse/ClickHouse/pull/12151)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了冗余 `ORDER BY` 优化中的不良代码。该缺陷是在 [#10067](https://github.com/ClickHouse/ClickHouse/issues/10067) 中引入的。[#12148](https://github.com/ClickHouse/ClickHouse/pull/12148)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了整数除法中的潜在溢出问题。解决了 [#12119](https://github.com/ClickHouse/ClickHouse/issues/12119)。[#12140](https://github.com/ClickHouse/ClickHouse/pull/12140)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了 `greatCircleDistance`、`geoDistance` 中潜在的无限循环问题。该修复解决了 [#12117](https://github.com/ClickHouse/ClickHouse/issues/12117)。[#12137](https://github.com/ClickHouse/ClickHouse/pull/12137)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 规范化处理 &quot;pid&quot; 文件。在之前的版本中，如果服务器在没有正确关闭的情况下被强制终止，并且此时存在另一个进程，其 pid 与之前运行的服务器相同，服务器可能会拒绝启动。此外，在服务器启动失败时，即使仍有另一个服务器进程在运行，pid 文件也可能被删除。本更新修复了 [#3501](https://github.com/ClickHouse/ClickHouse/issues/3501)。[#12133](https://github.com/ClickHouse/ClickHouse/pull/12133) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了在 ZooKeepeer 中导致 ReplicatedVersionedCollapsingMergeTree 表元数据不正确的错误。修复了 [#12093](https://github.com/ClickHouse/ClickHouse/issues/12093)。[#12121](https://github.com/ClickHouse/ClickHouse/pull/12121) ([alesapin](https://github.com/alesapin))。
* 避免在包含 `join` 或子查询且引用 system 日志（如 `system.query_log`、`metric_log` 等）或引用 `engine=Buffer` 底层表的物化视图中出现 “There is no query” 异常。 [#12120](https://github.com/ClickHouse/ClickHouse/pull/12120) ([filimonov](https://github.com/filimonov)).
* 修复了对使用 ENGINE=Dictionary 的表与字典之间依赖关系的处理，解决了 [#10994](https://github.com/ClickHouse/ClickHouse/issues/10994) 和 [#10397](https://github.com/ClickHouse/ClickHouse/issues/10397) 问题。[#12116](https://github.com/ClickHouse/ClickHouse/pull/12116)（[Vitaly Baranov](https://github.com/vitlibar)）。
* `Parquet` 格式现在可以正确处理 `LowCardinality` 和 `LowCardinality(Nullable)` 类型。修复了 [#12086](https://github.com/ClickHouse/ClickHouse/issues/12086)、[#8406](https://github.com/ClickHouse/ClickHouse/issues/8406)。[#12108](https://github.com/ClickHouse/ClickHouse/pull/12108)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了由于线程总数限制错误而导致包含 `UNION` 的 `SELECT` 查询性能下降的问题。修复了 [#12030](https://github.com/ClickHouse/ClickHouse/issues/12030)。[#12103](https://github.com/ClickHouse/ClickHouse/pull/12103) （[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了使用 `-StateResample` 组合器时出现的段错误。[#12092](https://github.com/ClickHouse/ClickHouse/pull/12092) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了在 `system.quey_log` 中针对 `SELECT` 查询的 `result_rows` 和 `result_bytes` 指标为空的问题。修复了 [#11595](https://github.com/ClickHouse/ClickHouse/issues/11595)。[#12089](https://github.com/ClickHouse/ClickHouse/pull/12089)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在从 `VIEW` 进行查询时不必要地限制线程数量的问题。修复了 [#11937](https://github.com/ClickHouse/ClickHouse/issues/11937)。[#12085](https://github.com/ClickHouse/ClickHouse/pull/12085)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在执行 `DROP TABLE` 时 `StorageKafka` 中出现的 SIGSEGV 问题。 [#12075](https://github.com/ClickHouse/ClickHouse/pull/12075) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在 `PREWHERE` 使用错误类型时可能发生的崩溃问题。修复了 [#12053](https://github.com/ClickHouse/ClickHouse/issues/12053)、[#12060](https://github.com/ClickHouse/ClickHouse/issues/12060)。[#12060](https://github.com/ClickHouse/ClickHouse/pull/12060)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在带有 `Tuple(LowCardinality)` 参数的高阶函数中出现的错误 `Cannot capture column`。修复了 [#9766](https://github.com/ClickHouse/ClickHouse/issues/9766)。[#12055](https://github.com/ClickHouse/ClickHouse/pull/12055)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了约束检查逻辑，现在会检查约束是否为常量表达式。此修复解决了 [#11360](https://github.com/ClickHouse/ClickHouse/issues/11360)。[#12042](https://github.com/ClickHouse/ClickHouse/pull/12042)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在调用函数 `if` 且参数为不同大小的 `FixedString` 类型时可能产生错误结果和潜在崩溃的问题。此修复解决了 [#11362](https://github.com/ClickHouse/ClickHouse/issues/11362)。[#12021](https://github.com/ClickHouse/ClickHouse/pull/12021)（[alexey-milovidov](https://github.com/alexey-milovidov)）。

#### 改进 {#improvement-14}

- 允许以更标准的方式设置 `JOIN` 类型和种类:`LEFT SEMI JOIN` 而不是 `SEMI LEFT JOIN`。目前两种写法都是正确的。[#12520](https://github.com/ClickHouse/ClickHouse/pull/12520) ([Artem Zuikov](https://github.com/4ertus2))。
- 为 Buffer 引擎添加 lifetime_rows/lifetime_bytes。[#12421](https://github.com/ClickHouse/ClickHouse/pull/12421) ([Azat Khuzhin](https://github.com/azat))。
- 向客户端写入详细的异常消息,而不是 'MySQL server has gone away'。[#12383](https://github.com/ClickHouse/ClickHouse/pull/12383) ([BohuTANG](https://github.com/BohuTANG))。
- 允许更改用于打印网格边框的字符集。可用的字符集包括:UTF-8、ASCII。设置 `output_format_pretty_grid_charset` 可启用此功能。[#12372](https://github.com/ClickHouse/ClickHouse/pull/12372) ([Sabyanin Maxim](https://github.com/s-mx))。
- 支持 MySQL 'SELECT DATABASE()' [#9336](https://github.com/ClickHouse/ClickHouse/issues/9336) 2. 添加 MySQL 替换查询集成测试。[#12314](https://github.com/ClickHouse/ClickHouse/pull/12314) ([BohuTANG](https://github.com/BohuTANG))。
- 为 MySQL 客户端/驱动程序添加 `KILL QUERY [connection_id]` 以取消长时间运行的查询,问题 [#12038](https://github.com/ClickHouse/ClickHouse/issues/12038)。[#12152](https://github.com/ClickHouse/ClickHouse/pull/12152) ([BohuTANG](https://github.com/BohuTANG))。
- 在 `formatDateTime` 函数中添加对 `%g`(两位数 ISO 年份)和 `%G`(四位数 ISO 年份)替换的支持。[#12136](https://github.com/ClickHouse/ClickHouse/pull/12136) ([vivarum](https://github.com/vivarum))。
- 在 system.disks 中添加 'type' 列。[#12115](https://github.com/ClickHouse/ClickHouse/pull/12115) ([ianton-ru](https://github.com/ianton-ru))。
- 改进 `REVOKE` 命令:现在它仅对将被撤销的访问权限要求 grant/admin 选项。例如,执行 `REVOKE ALL ON *.* FROM user1` 现在不再需要拥有带 grant 选项的完整访问权限。添加命令 `REVOKE ALL FROM user1` - 它会撤销 `user1` 的所有已授予角色。[#12083](https://github.com/ClickHouse/ClickHouse/pull/12083) ([Vitaly Baranov](https://github.com/vitlibar))。
- 为 load_balancing 添加副本优先级(用于手动设置负载均衡的优先级)。[#11995](https://github.com/ClickHouse/ClickHouse/pull/11995) ([Azat Khuzhin](https://github.com/azat))。
- 将 S3 元数据中的路径切换为相对路径,从而更容易处理 S3 blob。[#11892](https://github.com/ClickHouse/ClickHouse/pull/11892) ([Vladimir Chebotarev](https://github.com/excitoon))。

#### 性能改进 {#performance-improvement-7}


- 改进了按排序键前缀进行 'ORDER BY' 和 'GROUP BY' 的性能(通过 `optimize_aggregation_in_order` 设置启用,默认禁用)。[#11696](https://github.com/ClickHouse/ClickHouse/pull/11696) ([Anton Popov](https://github.com/CurtizJ))。
- 当设置 `optimize_injective_functions_inside_uniq=1` 时,移除 `uniq*()` 内部的单射函数。[#12337](https://github.com/ClickHouse/ClickHouse/pull/12337) ([Ruslan Kamalov](https://github.com/kamalov-ruslan))。
- 修复了 IN 运算符使用字面量时未使用索引的问题,该性能回退在 v19.3 左右引入。此修复解决了 [#10574](https://github.com/ClickHouse/ClickHouse/issues/10574)。[#12062](https://github.com/ClickHouse/ClickHouse/pull/12062) ([nvartolomei](https://github.com/nvartolomei))。
- 为 DiskS3 实现了单部分上传功能(实验性功能)。[#12026](https://github.com/ClickHouse/ClickHouse/pull/12026) ([Vladimir Chebotarev](https://github.com/excitoon))。

#### 实验性功能 {#experimental-feature-4}

- 为 `MergeTree` 系列表添加了新的内存格式数据分区,将数据存储在内存中。数据分区在首次合并时写入磁盘。如果数据分区的行数或字节数低于阈值 `min_rows_for_compact_part` 和 `min_bytes_for_compact_part`,则会以内存格式创建。此外还提供了可选的预写日志(Write-Ahead-Log)支持,默认启用,由设置 `in_memory_parts_enable_wal` 控制。[#10697](https://github.com/ClickHouse/ClickHouse/pull/10697) ([Anton Popov](https://github.com/CurtizJ))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-9}


* 为 `clickhouse-client` 实现基于 AST 的查询模糊测试模式。我们最近通过模糊测试发现的问题列表见[此标签](https://github.com/ClickHouse/ClickHouse/issues?q=label%3Afuzz+is%3Aissue)。其中大部分是通过此工具发现的，另有少数是通过 SQLancer 和 `00746_sql_fuzzy.pl` 发现的。[#12111](https://github.com/ClickHouse/ClickHouse/pull/12111) ([Alexander Kuzmenkov](https://github.com/akuzm))。
* 添加一类基于 Testflows 框架的新测试。[#12090](https://github.com/ClickHouse/ClickHouse/pull/12090) ([vzakaznikov](https://github.com/vzakaznikov))。
* 新增 S3 HTTPS 集成测试。[#12412](https://github.com/ClickHouse/ClickHouse/pull/12412) ([Pavel Kovalenko](https://github.com/Jokser))。
* 在单独的线程中记录 sanitizer trap 消息。这将防止在线程 sanitizer 下可能出现的死锁。[#12313](https://github.com/ClickHouse/ClickHouse/pull/12313) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 现在功能测试和压力测试可以使用旧版本的 `clickhouse-test` 脚本运行。[#12287](https://github.com/ClickHouse/ClickHouse/pull/12287) ([alesapin](https://github.com/alesapin))。
* 移除在构建 `orc` 时产生的异常文件创建操作。[#12258](https://github.com/ClickHouse/ClickHouse/pull/12258) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 将通用的 docker compose 文件放入集成测试用的 docker 容器中。[#12168](https://github.com/ClickHouse/ClickHouse/pull/12168) ([Ilya Yatsishin](https://github.com/qoega))。
* 修复来自 CodeQL 的警告。`CodeQL` 是我们将在现有的 `clang-tidy` 和 `PVS-Studio` 之外同时使用的另一款静态分析器。[#12138](https://github.com/ClickHouse/ClickHouse/pull/12138) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 对 UNBUNDLED 构建进行一些小的 CMake 修复。[#12131](https://github.com/ClickHouse/ClickHouse/pull/12131) ([Matwey V. Kornilov](https://github.com/matwey))。
* 新增一个不使用任何 Linux 发行版的最小化 Docker 镜像示例。[#12126](https://github.com/ClickHouse/ClickHouse/pull/12126) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 在 `clickhouse-server` Docker 镜像中升级系统软件包。[#12124](https://github.com/ClickHouse/ClickHouse/pull/12124) ([Ivan Blinkov](https://github.com/blinkov))。
* 向 `system.build_options` 表添加 `UNBUNDLED` 标志。将 `clickhouse-test` 的跳过列表迁移到 ClickHouse 仓库中。[#12107](https://github.com/ClickHouse/ClickHouse/pull/12107) ([alesapin](https://github.com/alesapin))。
* 使用 [Anchore Container Analysis](https://docs.anchore.com) 安全分析工具对 `clickhouse-server` Docker 镜像进行定期检查，以查找其中的 [CVE](https://cve.mitre.org/)。同时确认 `Dockerfile` 可成功构建。每天在 `master` 分支以及针对 `Dockerfile` 的 pull request 上运行。[#12102](https://github.com/ClickHouse/ClickHouse/pull/12102) ([Ivan Blinkov](https://github.com/blinkov))。
* 使用 [GitHub CodeQL](https://securitylab.github.com/tools/codeql) 安全分析工具进行每日检查，以查找 [CWE](https://cwe.mitre.org/)。[#12101](https://github.com/ClickHouse/ClickHouse/pull/12101) ([Ivan Blinkov](https://github.com/blinkov))。
* 在 Dockerfile 中首次执行 `apt-get update` 之前安装 `ca-certificates`。[#12095](https://github.com/ClickHouse/ClickHouse/pull/12095) ([Ivan Blinkov](https://github.com/blinkov))。



## ClickHouse 版本 20.5 {#clickhouse-release-205}

### ClickHouse 版本 v20.5.4.40-stable 2020-08-10 {#clickhouse-release-v205440-stable-2020-08-10}

#### 问题修复 {#bug-fix-26}


* 修复了在使用函数时的错误索引分析。在从 `MergeTree` 表读取数据时，这可能会导致错误地剪枝数据分片。修复了 [#13060](https://github.com/ClickHouse/ClickHouse/issues/13060)。修复了 [#12406](https://github.com/ClickHouse/ClickHouse/issues/12406)。[#13081](https://github.com/ClickHouse/ClickHouse/pull/13081)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复了从本地副本执行 `select` 时对线程数量的非必要限制。[#12840](https://github.com/ClickHouse/ClickHouse/pull/12840) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了在 `IN` 子句中将大型元组解释为函数时的性能问题。也就是用户出于某种莫名其妙的原因，写成 `WHERE x IN tuple(1, 2, ...)` 而不是 `WHERE x IN (1, 2, ...)` 的情况。[#12700](https://github.com/ClickHouse/ClickHouse/pull/12700)（[Anton Popov](https://github.com/CurtizJ)）。
* 通过将线程附加到组，修复了 `input_format_parallel_parsing` 的内存跟踪。[#12672](https://github.com/ClickHouse/ClickHouse/pull/12672) ([Azat Khuzhin](https://github.com/azat))。
* 修复了使用常量表达式的 Bloom filter 索引，解决了 [#10572](https://github.com/ClickHouse/ClickHouse/issues/10572)。[#12659](https://github.com/ClickHouse/ClickHouse/pull/12659)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复了在 broker 不可用（以及其他情况）时 `StorageKafka` 中出现的 `SIGSEGV`。 [#12658](https://github.com/ClickHouse/ClickHouse/pull/12658) ([Azat Khuzhin](https://github.com/azat)).
* 为 `if` 函数添加了对 `Array(UUID)` 参数的支持。修复了 [#11066](https://github.com/ClickHouse/ClickHouse/issues/11066)。[#12648](https://github.com/ClickHouse/ClickHouse/pull/12648)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了函数 `any` 不支持别名的问题。[#12593](https://github.com/ClickHouse/ClickHouse/pull/12593) ([Anton Popov](https://github.com/CurtizJ))。
* 修复了使用 `cache` 布局的外部字典中的竞态条件，该问题可能导致服务器崩溃。[#12566](https://github.com/ClickHouse/ClickHouse/pull/12566) ([alesapin](https://github.com/alesapin)).
* 在执行 DROP TABLE 时删除 Distributed 表的数据（来自异步 INSERT 的数据块）。[#12556](https://github.com/ClickHouse/ClickHouse/pull/12556) ([Azat Khuzhin](https://github.com/azat))。
* 修复了在 `enable_mixed_granularity_parts=1` 时执行 `ALTER DELETE` 查询会导致旧数据分片损坏的错误。修复了 [#12536](https://github.com/ClickHouse/ClickHouse/issues/12536)。[#12543](https://github.com/ClickHouse/ClickHouse/pull/12543)（[alesapin](https://github.com/alesapin)）。
* 为函数 `in` 在参数数量无效时提供更清晰的异常信息。[#12529](https://github.com/ClickHouse/ClickHouse/pull/12529) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了 `live view` 表中的竞态条件问题，该问题可能导致数据重复。 [#12519](https://github.com/ClickHouse/ClickHouse/pull/12519) ([vzakaznikov](https://github.com/vzakaznikov)).
* 修复了从紧凑部件读取时的性能问题。 [#12492](https://github.com/ClickHouse/ClickHouse/pull/12492) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了 `AggregateFunction(avg, ...)` 值二进制格式的向后兼容性问题。该修复解决了 [#12342](https://github.com/ClickHouse/ClickHouse/issues/12342)。[#12486](https://github.com/ClickHouse/ClickHouse/pull/12486)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在启用 `text_log` 时可能出现的死锁问题。[#12452](https://github.com/ClickHouse/ClickHouse/pull/12452) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复在指定非常大的 LIMIT 或 OFFSET 时发生的溢出问题。修复了 [#10470](https://github.com/ClickHouse/ClickHouse/issues/10470)。修复了 [#11372](https://github.com/ClickHouse/ClickHouse/issues/11372)。[#12427](https://github.com/ClickHouse/ClickHouse/pull/12427)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了 `StorageMerge` 中可能发生的段错误。修复关联 [#12054](https://github.com/ClickHouse/ClickHouse/issues/12054)。[#12401](https://github.com/ClickHouse/ClickHouse/pull/12401)（[tavplubix](https://github.com/tavplubix)）。
* 回滚在 [#11079](https://github.com/ClickHouse/ClickHouse/issues/11079) 中引入的更改，以解决 [#12098](https://github.com/ClickHouse/ClickHouse/issues/12098)。[#12397](https://github.com/ClickHouse/ClickHouse/pull/12397)（[Mike](https://github.com/myrrc)）。
* 在对带有索引的表进行查询时，如果在 `WHERE` 条件中使用负数或浮点常量，将不再抛出异常。修复了 [#11905](https://github.com/ClickHouse/ClickHouse/issues/11905)。[#12384](https://github.com/ClickHouse/ClickHouse/pull/12384)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 即使存在依赖的 `DEFAULT` 表达式，也允许对列执行 `CLEAR` 操作。修复了 [#12333](https://github.com/ClickHouse/ClickHouse/issues/12333)。[#12378](https://github.com/ClickHouse/ClickHouse/pull/12378)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了对带有 `-State` 和 `Nullable` 参数的聚合函数执行 TOTALS/ROLLUP/CUBE 时的行为问题。此修复对应 [#12163](https://github.com/ClickHouse/ClickHouse/issues/12163)。[#12376](https://github.com/ClickHouse/ClickHouse/pull/12376)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在 `Kafka` 引擎中，当批处理中间出现出错消息时触发的 SIGSEGV。 [#12302](https://github.com/ClickHouse/ClickHouse/pull/12302) ([Azat Khuzhin](https://github.com/azat)).
* 修复了 `SummingMergeTree` 引擎在对分区键中的列进行求和时的行为。现在如果显式指定的求和列与分区键列有交集，则会抛出异常。此更改修复了 [#7867](https://github.com/ClickHouse/ClickHouse/issues/7867)。[#12173](https://github.com/ClickHouse/ClickHouse/pull/12173)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 修复了在存在别名时将查询转换后发送到外部 DBMS（例如 MySQL、ODBC）的过程。此修复解决了 [#12032](https://github.com/ClickHouse/ClickHouse/issues/12032)。[#12151](https://github.com/ClickHouse/ClickHouse/pull/12151)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了导致 ZooKeeper 中 `ReplicatedVersionedCollapsingMergeTree` 表元数据不正确的错误。这一修复解决了 [#12093](https://github.com/ClickHouse/ClickHouse/issues/12093)。[#12121](https://github.com/ClickHouse/ClickHouse/pull/12121)（[alesapin](https://github.com/alesapin)）。
* 修复了从 `VIEW` 执行查询时对线程数量的不必要限制。修复了 [#11937](https://github.com/ClickHouse/ClickHouse/issues/11937)。[#12085](https://github.com/ClickHouse/ClickHouse/pull/12085)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在使用 `join_algorithm=partial_merge` 时，`JOIN` 搭配 `LowCardinality` 类型会导致崩溃的问题。 [#12035](https://github.com/ClickHouse/ClickHouse/pull/12035) ([Artem Zuikov](https://github.com/4ertus2)).
* 修复了在条件中包含 NULL 时 `if()` 返回错误结果的问题。 [#11807](https://github.com/ClickHouse/ClickHouse/pull/11807) ([Artem Zuikov](https://github.com/4ertus2)).

#### 性能改进 {#performance-improvement-8}

- 修复了 IN 运算符使用字面量时未使用索引的问题,该性能回退在 v19.3 左右引入。此修复解决了 [#10574](https://github.com/ClickHouse/ClickHouse/issues/10574)。[#12062](https://github.com/ClickHouse/ClickHouse/pull/12062) ([nvartolomei](https://github.com/nvartolomei))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-10}

- 在 Dockerfile 中首次执行 `apt-get update` 之前安装 `ca-certificates`。[#12095](https://github.com/ClickHouse/ClickHouse/pull/12095) ([Ivan Blinkov](https://github.com/blinkov))。

### ClickHouse 版本 v20.5.2.7-stable 2020-07-02 {#clickhouse-release-v20527-stable-2020-07-02}

#### 向后不兼容的变更 {#backward-incompatible-change-7}

- COUNT(DISTINCT) 和 `uniq` 聚合函数系列现在返回非 Nullable 结果。如果所有传入的值都是 NULL,则返回零。这提高了 SQL 兼容性。[#11661](https://github.com/ClickHouse/ClickHouse/pull/11661) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 添加了对用户级设置指定在错误位置的检查。用户级设置应在 `users.xml` 中为特定用户配置文件的 `<profile>` 部分内指定(或在 `<default>` 中指定默认设置)。服务器将不会启动并在日志中记录异常消息。此修复解决了 [#9051](https://github.com/ClickHouse/ClickHouse/issues/9051)。如果您想跳过此检查,可以将设置移动到适当的位置,或在 config.xml 中添加 `<skip_check_for_incorrect_settings>1</skip_check_for_incorrect_settings>`。[#11449](https://github.com/ClickHouse/ClickHouse/pull/11449) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 设置 `input_format_with_names_use_header` 默认启用。这将影响输入格式 `-WithNames` 和 `-WithNamesAndTypes` 的解析。[#10937](https://github.com/ClickHouse/ClickHouse/pull/10937) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 移除 `experimental_use_processors` 设置。该功能默认启用。[#10924](https://github.com/ClickHouse/ClickHouse/pull/10924) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 将 `zstd` 更新至 1.4.4。该版本在性能和压缩率方面有一些小幅改进。如果您运行不同版本的 ClickHouse 副本,可能会看到合理的错误消息 `Data after merge is not byte-identical to data on another replicas.` 及其解释。这些消息是正常的,无需担心。此变更向后兼容,但我们在此变更日志中列出,以防您对这些消息产生疑问。[#10663](https://github.com/ClickHouse/ClickHouse/pull/10663) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 添加了对无意义编解码器的检查,以及用于控制此检查的设置 `allow_suspicious_codecs`。此修复关闭了 [#4966](https://github.com/ClickHouse/ClickHouse/issues/4966)。[#10645](https://github.com/ClickHouse/ClickHouse/pull/10645) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 多个 Kafka 设置更改了其默认值。请参阅 [#11388](https://github.com/ClickHouse/ClickHouse/pull/11388)。
- 从 20.5 之前的版本升级时,如果执行滚动更新且集群同时包含 20.5 或更高版本和低于 20.5 的版本,如果重启旧版本的 ClickHouse 节点并且在存在新版本的情况下启动了旧版本,可能会导致 `Part ... intersects previous part` 错误。为防止此错误,请先在所有集群节点上安装较新的 clickhouse-server 软件包,然后再执行重启(这样,当 clickhouse-server 重启时,将使用新版本启动)。

#### 新功能 {#new-feature-7}


* `TTL DELETE WHERE` 和 `TTL GROUP BY` 用于在表中自动进行数据聚合粗化和汇总。[#10537](https://github.com/ClickHouse/ClickHouse/pull/10537) ([expl0si0nn](https://github.com/expl0si0nn)).
* 实现 PostgreSQL 线路协议。 [#10242](https://github.com/ClickHouse/ClickHouse/pull/10242) ([Movses](https://github.com/MovElb)).
* 为用户、角色、权限、`settings profiles`、配额、行策略新增了系统表；新增了命令 `SHOW USER`、`SHOW [CURRENT|ENABLED] ROLES`、`SHOW SETTINGS PROFILES`。 [#10387](https://github.com/ClickHouse/ClickHouse/pull/10387) ([Vitaly Baranov](https://github.com/vitlibar)).
* 在 ODBC 表函数中增加对 `INSERT` 的支持 [#10554](https://github.com/ClickHouse/ClickHouse/pull/10554)（[ageraab](https://github.com/ageraab)）。[#10901](https://github.com/ClickHouse/ClickHouse/pull/10901)（[tavplubix](https://github.com/tavplubix)）。
* 基于 Linux `perf_events` 新增查询性能指标（这些指标通过硬件 CPU 计数器和操作系统计数器计算）。该功能为可选项，并且需要在 clickhouse 可执行文件上设置 `CAP_SYS_ADMIN`。[#9545](https://github.com/ClickHouse/ClickHouse/pull/9545) [Andrey Skobtsov](https://github.com/And42)。[#11226](https://github.com/ClickHouse/ClickHouse/pull/11226) ([Alexander Kuzmenkov](https://github.com/akuzm))。
* 现在在 `CREATE` 查询中支持为数据类型使用 `NULL` 和 `NOT NULL` 修饰符。[#11057](https://github.com/ClickHouse/ClickHouse/pull/11057) ([Павел Потемкин](https://github.com/Potya))。
* 添加 `ArrowStream` 输入和输出格式。[#11088](https://github.com/ClickHouse/ClickHouse/pull/11088) ([hcz](https://github.com/hczhcz))。
* 支持将 Cassandra 用作外部字典源。[#4978](https://github.com/ClickHouse/ClickHouse/pull/4978) ([favstovol](https://github.com/favstovol)).
* 新增了一个布局 `direct`，该布局在每次查询时都直接从源加载全部数据，而不进行数据存储或缓存。[#10622](https://github.com/ClickHouse/ClickHouse/pull/10622) ([Artem Streltsov](https://github.com/kekekekule)).
* 为字典新增了 `complex_key_direct` 布局，该布局在查询执行期间不会在本地存储任何内容。[#10850](https://github.com/ClickHouse/ClickHouse/pull/10850) ([Artem Streltsov](https://github.com/kekekekule))。
* 添加了对 MySQL 风格全局变量语法（占位实现）的支持。这是为了兼容 MySQL 协议所必需的。[#11832](https://github.com/ClickHouse/ClickHouse/pull/11832)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 使用 `replxx` 为 `clickhouse-client` 添加了语法高亮功能。[#11422](https://github.com/ClickHouse/ClickHouse/pull/11422) ([Tagir Kuskarov](https://github.com/kuskarov))。
* 添加了 `minMap` 和 `maxMap` 函数。[#11603](https://github.com/ClickHouse/ClickHouse/pull/11603)（[Ildus Kurbangaliev](https://github.com/ildus)）。
* 添加 `system.asynchronous_metric_log` 表，用于记录 `system.asynchronous_metrics` 中的历史指标。 [#11588](https://github.com/ClickHouse/ClickHouse/pull/11588) ([Alexander Kuzmenkov](https://github.com/akuzm))。
* 添加了函数 `extractAllGroupsHorizontal(haystack, re)` 和 `extractAllGroupsVertical(haystack, re)`。[#11554](https://github.com/ClickHouse/ClickHouse/pull/11554)（[Vasily Nemkov](https://github.com/Enmk)）。
* 添加 `SHOW CLUSTER(S)` 查询语句。 [#11467](https://github.com/ClickHouse/ClickHouse/pull/11467) ([hexiaoting](https://github.com/hexiaoting)).
* 添加 `netloc` 函数用于提取网络位置，类似于 Python 中 `urlparse(url)` 的 `netloc`。 [#11356](https://github.com/ClickHouse/ClickHouse/pull/11356) ([Guillaume Tassery](https://github.com/YiuRULE))。
* 为 `engine=Kafka` 新增 2 个用于访问消息头部的虚拟列。 [#11283](https://github.com/ClickHouse/ClickHouse/pull/11283) ([filimonov](https://github.com/filimonov)).
* 为 Kafka 引擎添加 `_timestamp_ms` 虚拟列（类型为 `Nullable(DateTime64(3))`）。 [#11260](https://github.com/ClickHouse/ClickHouse/pull/11260) ([filimonov](https://github.com/filimonov))。
* 添加了函数 `randomFixedString`。 [#10866](https://github.com/ClickHouse/ClickHouse/pull/10866) ([Andrei Nekrashevich](https://github.com/xolm)).
* 添加函数 `fuzzBits`，用于以给定概率随机翻转字符串中的位。[#11237](https://github.com/ClickHouse/ClickHouse/pull/11237)（[Andrei Nekrashevich](https://github.com/xolm)）。
* 允许在比较运算符以及 `IN` 和 `VALUES` 子句中，将数字与常量字符串进行比较。[#11647](https://github.com/ClickHouse/ClickHouse/pull/11647) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 添加 `round_robin` 负载均衡模式。 [#11645](https://github.com/ClickHouse/ClickHouse/pull/11645) ([Azat Khuzhin](https://github.com/azat))。
* 添加 `cast_keep_nullable` 设置。启用后，`CAST(something_nullable AS Type)` 将返回 `Nullable(Type)`。 [#11733](https://github.com/ClickHouse/ClickHouse/pull/11733) ([Artem Zuikov](https://github.com/4ertus2)).
* 在 `system.columns` 表中新增了 `position` 列，在 `system.parts_columns` 表中新增了 `column_position` 列。它表示表中列的序号，从 1 开始计数。此更改关闭了 [#7744](https://github.com/ClickHouse/ClickHouse/issues/7744)。[#11655](https://github.com/ClickHouse/ClickHouse/pull/11655)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 SYSTEM `{FLUSH DISTRIBUTED, STOP/START DISTRIBUTED SEND}` 命令提供 ON CLUSTER 支持。[#11415](https://github.com/ClickHouse/ClickHouse/pull/11415) ([Azat Khuzhin](https://github.com/azat))。
* 添加了 `system.distribution_queue` 表。 [#11394](https://github.com/ClickHouse/ClickHouse/pull/11394) ([Azat Khuzhin](https://github.com/azat)).
* 为 Kafka 提供对所有格式设置的支持，在表级别公开部分设置，并调整默认值以获得更好的性能。 [#11388](https://github.com/ClickHouse/ClickHouse/pull/11388) ([filimonov](https://github.com/filimonov)).
* 添加 `port` 函数（用于从 URL 中提取端口）。 [#11120](https://github.com/ClickHouse/ClickHouse/pull/11120) ([Azat Khuzhin](https://github.com/azat))。
* 现在 `dictGet*` 函数支持使用表名。[#11050](https://github.com/ClickHouse/ClickHouse/pull/11050) ([Vitaly Baranov](https://github.com/vitlibar))。
* 在使用 `-n` 参数时，`clickhouse-format` 工具现在能够格式化多个查询。[#10852](https://github.com/ClickHouse/ClickHouse/pull/10852)（[Darío](https://github.com/dgrr)）。
* 支持为 DiskS3 配置 proxy-resolver。[#10744](https://github.com/ClickHouse/ClickHouse/pull/10744) ([Pavel Kovalenko](https://github.com/Jokser))。
* 使 `pointInPolygon` 能够处理非常量多边形。`pointInPolygon` 现在可以将 Array(Array(Tuple(..., ...))) 作为第二个参数，即多边形及其孔的数组。[#10623](https://github.com/ClickHouse/ClickHouse/pull/10623) ([Alexey Ilyukhov](https://github.com/livace)) [#11421](https://github.com/ClickHouse/ClickHouse/pull/11421) ([Alexey Ilyukhov](https://github.com/livace))。
* 在 `system.parts` 中新增了 `move_ttl_info`，以便对 move TTL 功能进行查看和分析。 [#10591](https://github.com/ClickHouse/ClickHouse/pull/10591) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 通过代理使用 S3 的能力。[#10576](https://github.com/ClickHouse/ClickHouse/pull/10576) ([Pavel Kovalenko](https://github.com/Jokser))。
* 为数据类型添加 `NCHAR` 和 `NVARCHAR` 别名。 [#11025](https://github.com/ClickHouse/ClickHouse/pull/11025) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 已解决 [#7224](https://github.com/ClickHouse/ClickHouse/issues/7224)：在 `system.events` 表中添加了 `FailedQuery`、`FailedSelectQuery` 和 `FailedInsertQuery` 指标。 [#11151](https://github.com/ClickHouse/ClickHouse/pull/11151)（[Nikita Orlov](https://github.com/naorlov)）。
* 向 `system.asynchronous_metrics` 添加更多 `jemalloc` 统计信息，并确保这些统计值始终是最新的。[#11748](https://github.com/ClickHouse/ClickHouse/pull/11748) ([Alexander Kuzmenkov](https://github.com/akuzm))。
* 允许指定默认的 S3 凭据以及自定义认证头。 [#11134](https://github.com/ClickHouse/ClickHouse/pull/11134) ([Grigory Pervakov](https://github.com/GrigoryPervakov)).
* 新增了用于以不同精度将 `DateTime64` 作为 `Int64` 导入/导出的函数：`to-/fromUnixTimestamp64Milli/-Micro/-Nano`。 [#10923](https://github.com/ClickHouse/ClickHouse/pull/10923) ([Vasily Nemkov](https://github.com/Enmk))。
* 允许为 MongoDB 字典指定 `mongodb://` URI。 [#10915](https://github.com/ClickHouse/ClickHouse/pull/10915) ([Alexander Kuzmenkov](https://github.com/akuzm))。
* `OFFSET` 关键字现在可以在没有关联的 `LIMIT` 子句的情况下使用。 [#10802](https://github.com/ClickHouse/ClickHouse/pull/10802) ([Guillaume Tassery](https://github.com/YiuRULE)).
* 新增了 `system.licenses` 表。该表包含位于 `contrib` 目录中的第三方库的许可证。修复了 [#2890](https://github.com/ClickHouse/ClickHouse/issues/2890)。[#10795](https://github.com/ClickHouse/ClickHouse/pull/10795)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 新增函数 `toStartOfSecond(DateTime64) -&gt; DateTime64`，用于将 `DateTime64` 值的子秒部分清零。 [#10722](https://github.com/ClickHouse/ClickHouse/pull/10722) ([Vasily Nemkov](https://github.com/Enmk)).
* 添加新的输入格式 `JSONAsString`，可接收由换行符、空格和/或逗号分隔的一系列 JSON 对象。[#10607](https://github.com/ClickHouse/ClickHouse/pull/10607) ([Kruglov Pavel](https://github.com/Avogar))。
* 允许以内存粒度小于 4 MiB 的步长进行分析。新增采样内存分析器，用于捕获随机的内存分配/释放操作。[#10598](https://github.com/ClickHouse/ClickHouse/pull/10598) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `SimpleAggregateFunction` 现在也支持 `sumMap`。 [#10000](https://github.com/ClickHouse/ClickHouse/pull/10000) ([Ildus Kurbangaliev](https://github.com/ildus)).
* 为分布式表引擎增加对 `ALTER RENAME COLUMN` 的支持。[#10727](https://github.com/ClickHouse/ClickHouse/issues/10727) 的后续工作。修复 [#10747](https://github.com/ClickHouse/ClickHouse/issues/10747)。[#10887](https://github.com/ClickHouse/ClickHouse/pull/10887)（[alesapin](https://github.com/alesapin)）。

#### 错误修复 {#bug-fix-27}


* 修复 Decimal 解析中的 UBSan 报告。这一更改修复了 [#7540](https://github.com/ClickHouse/ClickHouse/issues/7540)。[#10512](https://github.com/ClickHouse/ClickHouse/pull/10512)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在解析 `DateTime64` 时可能出现的浮点异常。这一修复解决了 [#11374](https://github.com/ClickHouse/ClickHouse/issues/11374)。[#11875](https://github.com/ClickHouse/ClickHouse/pull/11875)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在 `prewhere` 条件中使用 `Nullable` 列时可能导致的罕见崩溃。[#11895](https://github.com/ClickHouse/ClickHouse/pull/11895) [#11608](https://github.com/ClickHouse/ClickHouse/issues/11608) [#11869](https://github.com/ClickHouse/ClickHouse/pull/11869) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 禁止在高阶函数中使用 arrayJoin。这会导致协议同步出错。此更改关闭了 [#3933](https://github.com/ClickHouse/ClickHouse/issues/3933)。[#11846](https://github.com/ClickHouse/ClickHouse/pull/11846) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复 `FixedString` 与常量 `String` 比较时返回错误结果的问题。此修复对应 [#11393](https://github.com/ClickHouse/ClickHouse/issues/11393)。该缺陷出现在 20.4 版本中。[#11828](https://github.com/ClickHouse/ClickHouse/pull/11828)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在条件中包含 NULL 时 `if` 返回错误结果的问题。 [#11807](https://github.com/ClickHouse/ClickHouse/pull/11807) ([Artem Zuikov](https://github.com/4ertus2)).
* 修复查询使用线程数过多的问题。 [#11788](https://github.com/ClickHouse/ClickHouse/pull/11788) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复了在 `SELECT ... FROM merge_tree_table ...` 中使用 `WITH <scalar subquery> ...` 时出现的 `Scalar does not exist` 异常 [#11621](https://github.com/ClickHouse/ClickHouse/issues/11621)。 [#11767](https://github.com/ClickHouse/ClickHouse/pull/11767) ([Amos Bird](https://github.com/amosbird)).
* 修复了类似 `SELECT *, xyz.*` 这类查询的异常行为，此前在应当报错的情况下却被错误地执行成功。 [#11753](https://github.com/ClickHouse/ClickHouse/pull/11753) ([hexiaoting](https://github.com/hexiaoting)).
* 现在，在元数据变更期间会取消副本抓取操作。 [#11744](https://github.com/ClickHouse/ClickHouse/pull/11744) ([alesapin](https://github.com/alesapin)).
* 在检查是否相等之前，先解析存储在 zookeeper 中的元数据。[#11739](https://github.com/ClickHouse/ClickHouse/pull/11739) ([Azat Khuzhin](https://github.com/azat))。
* 修复了在 `Values` 输入格式中对复杂字面量进行错误类型推导而导致的 `LOGICAL_ERROR`。 [#11732](https://github.com/ClickHouse/ClickHouse/pull/11732) ([tavplubix](https://github.com/tavplubix)).
* 修复在常量列上使用 `ORDER BY ... WITH FILL` 时的问题。 [#11697](https://github.com/ClickHouse/ClickHouse/pull/11697) ([Anton Popov](https://github.com/CurtizJ)).
* 修复 `SYSTEM SYNC REPLICA` 中一个极其罕见的竞态条件。如果在创建复制表的同时，另一个客户端通过单独的连接对该表执行 `SYSTEM SYNC REPLICA` 命令（这不太可能，因为另一个客户端理应知道该表正在创建），则有可能发生对 `nullptr` 的解引用。[#11691](https://github.com/ClickHouse/ClickHouse/pull/11691)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在与 XDBC bridge 通信时传递正确的超时参数。此前在检查 bridge 存活性和接收元信息时不会正确应用超时设置。[#11690](https://github.com/ClickHouse/ClickHouse/pull/11690)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在 `ORDER BY` 语句中使用包含别名的 `LIMIT n WITH TIES` 时的问题。 [#11689](https://github.com/ClickHouse/ClickHouse/pull/11689) ([Anton Popov](https://github.com/CurtizJ))。
* 修复在带有并行 `FINAL` 的查询中可能出现的 `Pipeline stuck` 问题。修复 [#11636](https://github.com/ClickHouse/ClickHouse/issues/11636)。[#11682](https://github.com/ClickHouse/ClickHouse/pull/11682)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了导致 `system.mutations` 状态不正确的错误。该错误可能会导致其显示整个 mutation 已经完成，但服务器在复制队列中仍然存在 `MUTATE_PART` 任务并尝试执行它们。此修复对应 [#11611](https://github.com/ClickHouse/ClickHouse/issues/11611)。[#11681](https://github.com/ClickHouse/ClickHouse/pull/11681)（[alesapin](https://github.com/alesapin)）。
* 修复 `CREATE USER` 查询中的语法高亮显示。 [#11664](https://github.com/ClickHouse/ClickHouse/pull/11664) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 添加对带有不区分大小写标志的正则表达式的支持。修复了 [#11101](https://github.com/ClickHouse/ClickHouse/issues/11101) 和 [#11506](https://github.com/ClickHouse/ClickHouse/issues/11506)。[#11649](https://github.com/ClickHouse/ClickHouse/pull/11649)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 如果启用了行级安全性，则移除简单的 `count` 查询优化。在之前的版本中，用户会得到表中记录的总数，而不是过滤后的数量。此更改修复了 [#11352](https://github.com/ClickHouse/ClickHouse/issues/11352)。[#11644](https://github.com/ClickHouse/ClickHouse/pull/11644)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `String` 类型的布隆过滤器（数据跳过索引）。 [#11638](https://github.com/ClickHouse/ClickHouse/pull/11638) ([Azat Khuzhin](https://github.com/azat)).
* 在不使用 `-q` 选项的情况下，启动时不会创建数据库。[#11604](https://github.com/ClickHouse/ClickHouse/pull/11604) ([giordyb](https://github.com/giordyb))。
* 修复在对 `Buffer` 表执行采样读取的查询中出现的 `Block structure mismatch` 错误。[#11602](https://github.com/ClickHouse/ClickHouse/pull/11602) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复在 `exception.code() % 256 == 0` 时，clickhouse-client 使用的错误退出码。[#11601](https://github.com/ClickHouse/ClickHouse/pull/11601) ([filimonov](https://github.com/filimonov))。
* 修复 `ReplicatedMergeTree` 不同副本在执行 `CREATE`/`DROP` 操作时的竞争条件。当表未从 ZooKeeper 中完全删除或未成功创建时，系统仍能继续工作。修复了 [#11432](https://github.com/ClickHouse/ClickHouse/issues/11432)。[#11592](https://github.com/ClickHouse/ClickHouse/pull/11592)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复服务器启动时关于“Mark cache size was lowered”这条日志消息中的一个小错误。此更改关闭了 [#11399](https://github.com/ClickHouse/ClickHouse/issues/11399)。[#11589](https://github.com/ClickHouse/ClickHouse/pull/11589)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在包含 `PREWHERE column in (subquery)` 和 `ARRAY JOIN` 的查询中出现的错误 `Size of offsets does not match size of column`。 [#11580](https://github.com/ClickHouse/ClickHouse/pull/11580) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复了在执行 `SHOW CREATE TABLE` 时极少发生的段错误。修复了 [#11490](https://github.com/ClickHouse/ClickHouse/issues/11490)。[#11579](https://github.com/ClickHouse/ClickHouse/pull/11579)（[tavplubix](https://github.com/tavplubix)）。
* HTTP 会话中的所有查询都具有相同的 `query_id`。该问题已修复。 [#11578](https://github.com/ClickHouse/ClickHouse/pull/11578) ([tavplubix](https://github.com/tavplubix)).
* 现在，`clickhouse-server` 的 Docker 容器在检查服务器存活状态时将优先使用 IPv6。 [#11550](https://github.com/ClickHouse/ClickHouse/pull/11550) ([Ivan Starkov](https://github.com/istarkov))。
* 修复在启用 `min_bytes_to_use_direct_io`、PREWHERE 生效且使用 SAMPLE 或大量线程时可能出现的错误 `Data compressed with different methods`。此修复对应问题 [#11539](https://github.com/ClickHouse/ClickHouse/issues/11539)。[#11540](https://github.com/ClickHouse/ClickHouse/pull/11540)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `<node>` 的 shard&#95;num/replica&#95;num（否则会破坏 use&#95;compact&#95;format&#95;in&#95;distributed&#95;parts&#95;names 的使用）。[#11528](https://github.com/ClickHouse/ClickHouse/pull/11528) ([Azat Khuzhin](https://github.com/azat))。
* 修复在 `prefer_localhost_replica=0` 且未启用 `internal_replication` 的情况下，对 `Distributed` 表执行异步 `INSERT` 时的问题。 [#11527](https://github.com/ClickHouse/ClickHouse/pull/11527) ([Azat Khuzhin](https://github.com/azat)).
* 修复在使用 `-State` 函数进行聚合时，中途抛出异常导致的内存泄漏问题。此修复解决了 [#8995](https://github.com/ClickHouse/ClickHouse/issues/8995)。[#11496](https://github.com/ClickHouse/ClickHouse/pull/11496)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `INSERT SELECT FINAL` 中的 `Pipeline stuck` 异常：当 `SELECT`（`max_threads` &gt; 1）有多个数据流而 `INSERT` 只有一个（`max_insert_threads` == 0）时会触发该问题。[#11455](https://github.com/ClickHouse/ClickHouse/pull/11455) ([Azat Khuzhin](https://github.com/azat)).
* 修复在类似 `select count() from t, u` 这样的查询中产生错误结果的问题。[#11454](https://github.com/ClickHouse/ClickHouse/pull/11454) ([Artem Zuikov](https://github.com/4ertus2)).
* 修复编解码器返回的压缩大小值。 [#11448](https://github.com/ClickHouse/ClickHouse/pull/11448) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复当某列的压缩 `codec` 使用非字面量参数时导致的服务器崩溃问题。修复 [#11365](https://github.com/ClickHouse/ClickHouse/issues/11365)。[#11431](https://github.com/ClickHouse/ClickHouse/pull/11431)（[alesapin](https://github.com/alesapin)）。
* 修复在 `MergeTree` 关闭过程中，如果表未成功创建，可能发生的未初始化内存读取问题。 [#11420](https://github.com/ClickHouse/ClickHouse/pull/11420) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复在 `LowCarinality(T)` 和 `Nullable(T)` 上执行 `JOIN` 时出现的崩溃问题。[#11380](https://github.com/ClickHouse/ClickHouse/issues/11380)。[#11414](https://github.com/ClickHouse/ClickHouse/pull/11414)（[Artem Zuikov](https://github.com/4ertus2)）。
* 修正针对错误 `USING` 键的错误码。[#11373](https://github.com/ClickHouse/ClickHouse/issues/11373)。[#11404](https://github.com/ClickHouse/ClickHouse/pull/11404)（[Artem Zuikov](https://github.com/4ertus2)）。
* 修复了在参数超出纬度/经度范围时的 `geohashesInBox` 问题。 [#11403](https://github.com/ClickHouse/ClickHouse/pull/11403) ([Vasily Nemkov](https://github.com/Enmk))。
* 改进 `joinGet()` 函数的错误信息。[#11389](https://github.com/ClickHouse/ClickHouse/pull/11389)（[Artem Zuikov](https://github.com/4ertus2)）。
* 修复在包含外部排序和 `LIMIT` 的查询中可能出现的 `Pipeline stuck` 错误。修复 [#11359](https://github.com/ClickHouse/ClickHouse/issues/11359)。[#11366](https://github.com/ClickHouse/ClickHouse/pull/11366)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 在 `ReplicatedMergeTree` 中发送数据分片时移除冗余锁。[#11354](https://github.com/ClickHouse/ClickHouse/pull/11354) ([alesapin](https://github.com/alesapin)).
* 修复 `clickhouse-client` 在多行模式下对 `\G`（纵向输出）的支持。此更改关闭了 [#9933](https://github.com/ClickHouse/ClickHouse/issues/9933)。[#11350](https://github.com/ClickHouse/ClickHouse/pull/11350)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在使用 `Lazy` 数据库时可能发生的段错误。[#11348](https://github.com/ClickHouse/ClickHouse/pull/11348) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了直接从 `Join` 表引擎（未使用 JOIN）进行查询时的崩溃问题以及错误的可空性处理。[#11340](https://github.com/ClickHouse/ClickHouse/pull/11340) ([Artem Zuikov](https://github.com/4ertus2))。
* 修复 `quantilesExactWeightedArray` 中的崩溃问题。 [#11337](https://github.com/ClickHouse/ClickHouse/pull/11337) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 现在在执行 `ALTER` 查询时，会在修改元数据之前先停止合并操作。[#11335](https://github.com/ClickHouse/ClickHouse/pull/11335) ([alesapin](https://github.com/alesapin)).
* 在设置 `parallel_view_processing = 1` 时重新启用对 `MATERIALIZED VIEW` 的并行写入。修复了 [#10241](https://github.com/ClickHouse/ClickHouse/issues/10241)。[#11330](https://github.com/ClickHouse/ClickHouse/pull/11330)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复当提取的 JSON 中包含含有不成对 &#123; 或 [ 的字符串时 `visitParamExtractRaw` 的行为。 [#11318](https://github.com/ClickHouse/ClickHouse/pull/11318) ([Ewout](https://github.com/devwout)).
* 修复 `ThreadPool` 中极少见的竞态条件。 [#11314](https://github.com/ClickHouse/ClickHouse/pull/11314) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复 `clickhouse-copier` 中一个无关紧要的数据竞争问题，由集成测试发现。[#11313](https://github.com/ClickHouse/ClickHouse/pull/11313) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复转换过程中可能使用未初始化内存的问题。例如：`SELECT toIntervalSecond(now64())`。[#11311](https://github.com/ClickHouse/ClickHouse/pull/11311)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复以下问题：当表的主键中包含 `Array` 列，并且查询使用 `empty` 或 `notEmpty` 函数按该列进行过滤时，索引分析无法生效。此修复解决了 [#11286](https://github.com/ClickHouse/ClickHouse/issues/11286)。[#11303](https://github.com/ClickHouse/ClickHouse/pull/11303)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了一个错误：当查询被 `max_network_bandwidth`、`max_execution_speed` 或 `priority` 设置限速时，查询速度估算可能不准确，从而导致 `min_execution_speed` 的限制不生效或工作异常。将 `timeout_before_checking_execution_speed` 的默认值改为非零，否则 `min_execution_speed` 和 `max_execution_speed` 设置将不会生效。修复了 [#11297](https://github.com/ClickHouse/ClickHouse/issues/11297)。修复了 [#5732](https://github.com/ClickHouse/ClickHouse/issues/5732)。修复了 [#6228](https://github.com/ClickHouse/ClickHouse/issues/6228)。可用性改进：在 `clickhouse-client` 中避免将异常消息与进度条拼接显示。[#11296](https://github.com/ClickHouse/ClickHouse/pull/11296)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在使用错误参数调用 `SET DEFAULT ROLE` 时发生的崩溃问题。该修复解决了 [#10586](https://github.com/ClickHouse/ClickHouse/issues/10586)。[#11278](https://github.com/ClickHouse/ClickHouse/pull/11278)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复在读取格式错误的 `Protobuf` 数据时发生的崩溃。修复了 [#5957](https://github.com/ClickHouse/ClickHouse/issues/5957) 和 [#11203](https://github.com/ClickHouse/ClickHouse/issues/11203)。[#11258](https://github.com/ClickHouse/ClickHouse/pull/11258)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复了一个错误：在 `cache` 字典中，当只有已过期的键时，可能会返回默认值而非正常值。此问题仅影响字符串字段。[#11233](https://github.com/ClickHouse/ClickHouse/pull/11233) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 修复在从含有内层查询常量的 `VIEW` 读取时出现的错误 `Block structure mismatch in QueryPipeline`。修复了 [#11181](https://github.com/ClickHouse/ClickHouse/issues/11181)。[#11205](https://github.com/ClickHouse/ClickHouse/pull/11205)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复可能出现的异常 `Invalid status for associated output`。 [#11200](https://github.com/ClickHouse/ClickHouse/pull/11200) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 现在如果在 `CREATE` 查询中定义了 `primary.idx`，就会对其进行检查。[#11199](https://github.com/ClickHouse/ClickHouse/pull/11199) ([alesapin](https://github.com/alesapin))。
* 修复高阶函数在捕获参数为 `Array(Array(LowCardinality))` 时可能出现的错误 `Cannot capture column`。 [#11185](https://github.com/ClickHouse/ClickHouse/pull/11185) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复了 `S3` 通配符匹配功能，在键数量超过 1000 且使用某些后端时可能会失败的问题。 [#11179](https://github.com/ClickHouse/ClickHouse/pull/11179) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 如果 data skipping 索引依赖于在后台合并过程中会被修改的列（对于 `SummingMergeTree`、`AggregatingMergeTree` 以及 `TTL GROUP BY`），则其计算结果会不正确。此问题已通过将索引计算移动到合并之后来修复，从而使索引基于合并后的数据进行计算。[#11162](https://github.com/ClickHouse/ClickHouse/pull/11162) ([Azat Khuzhin](https://github.com/azat))。
* 修复了在 `DROP` 使用 `engine=Kafka` 的表（或在服务器重启期间）时偶发的挂起问题。 [#11145](https://github.com/ClickHouse/ClickHouse/pull/11145) ([filimonov](https://github.com/filimonov))。
* 修复针对简单查询的线程过度预留问题（用于减少线程数量的优化在流水线变更后部分失效）。 [#11114](https://github.com/ClickHouse/ClickHouse/pull/11114) ([Azat Khuzhin](https://github.com/azat)).
* 如果在变更最终化任务中没有实际完成任何最终化操作，则移除对应的日志记录。 [#11109](https://github.com/ClickHouse/ClickHouse/pull/11109) ([alesapin](https://github.com/alesapin)).
* 修复了在更新后 `system` 日志表结构发生变化时，服务器启动期间可能出现的死锁问题。 [#11106](https://github.com/ClickHouse/ClickHouse/pull/11106) ([alesapin](https://github.com/alesapin)).
* 修复了 `registerDiskS3` 中的内存泄漏。[#11074](https://github.com/ClickHouse/ClickHouse/pull/11074) ([Pavel Kovalenko](https://github.com/Jokser))。
* 修复在 JOIN 与 PREWHERE 同时出现，或 `optimize_move_to_prewhere` 将 WHERE 转换为 PREWHERE 时触发的错误 `No such name in Block::erase()`。[#11051](https://github.com/ClickHouse/ClickHouse/pull/11051) ([Artem Zuikov](https://github.com/4ertus2))。
* 修复了在终止 Kafka 引擎表时可能出现的数据丢失问题。[#11048](https://github.com/ClickHouse/ClickHouse/pull/11048) ([filimonov](https://github.com/filimonov))。
* 修复了 `parseDateTime64BestEffort` 参数解析中的问题。[#10925](https://github.com/ClickHouse/ClickHouse/issues/10925)。[#11038](https://github.com/ClickHouse/ClickHouse/pull/11038)（[Vasily Nemkov](https://github.com/Enmk)）。
* 现在可以在单个 `ALTER` 查询中对同一列同时执行 `ADD/DROP` 和 `RENAME` 操作。对于同时使用 `MODIFY` 和 `RENAME` 的情况，异常消息变得更加清晰。部分修复了 [#10669](https://github.com/ClickHouse/ClickHouse/issues/10669)。[#11037](https://github.com/ClickHouse/ClickHouse/pull/11037)（[alesapin](https://github.com/alesapin)）。
* 修复了 S3 URL 的解析。 [#11036](https://github.com/ClickHouse/ClickHouse/pull/11036) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 修复在存在 `LIMIT` 时，两级 `GROUP BY` 的内存跟踪问题。 [#11022](https://github.com/ClickHouse/ClickHouse/pull/11022) ([Azat Khuzhin](https://github.com/azat))。
* 修复 `MergeTree` 中一种极其罕见的潜在 use-after-free 错误，该错误可能在数据表创建未成功时出现。 [#10986](https://github.com/ClickHouse/ClickHouse/pull/10986) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复 Atomic 数据库中元数据（重命名的相对路径）和数据（符号链接的相对路径）的处理。[#10980](https://github.com/ClickHouse/ClickHouse/pull/10980) ([Azat Khuzhin](https://github.com/azat)).
* 修复在使用 `Atomic` 数据库引擎时，并发执行 `ALTER` 和 `DROP DATABASE` 查询可能导致的服务器崩溃问题。 [#10968](https://github.com/ClickHouse/ClickHouse/pull/10968) ([tavplubix](https://github.com/tavplubix)).
* 修复 `getRawData()` 方法中原始数据大小计算不正确的问题。 [#10964](https://github.com/ClickHouse/ClickHouse/pull/10964) ([Igr](https://github.com/ObjatieGroba)).
* 修复 20.1 与更早版本在两级聚合上的不兼容问题。当 initiator 节点和远程节点上运行的 ClickHouse 版本不一致，且 `GROUP BY` 结果集很大并且聚合仅基于单个 `String` 字段进行时，就会出现该不兼容问题。它会导致结果中同一个键对应出现多行未合并的数据。[#10952](https://github.com/ClickHouse/ClickHouse/pull/10952)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 避免通过 DistributedBlockOutputStream 发送未写完整的文件。 [#10940](https://github.com/ClickHouse/ClickHouse/pull/10940) ([Azat Khuzhin](https://github.com/azat)).
* 修复在执行 `SELECT count(notNullIn(NULL, []))` 时出现的崩溃。 [#10920](https://github.com/ClickHouse/ClickHouse/pull/10920) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复了在执行引擎为 Kafka 的表的 `DROP` 操作（或在服务器重启期间）时偶尔出现的挂起问题。[#10910](https://github.com/ClickHouse/ClickHouse/pull/10910) ([filimonov](https://github.com/filimonov))。
* 现在可以一次性执行多个 `ALTER RENAME`，例如 `a TO b, c TO a`。[#10895](https://github.com/ClickHouse/ClickHouse/pull/10895)（[alesapin](https://github.com/alesapin)）。
* 修复了在多个线程针对同一列获取聚合函数状态结果时可能出现的竞态问题。我发现它发生的唯一情况是：在读取使用 `Memory` 引擎、且为 `quanite*` 函数存储 `AggregateFunction` 状态的表时，调用了 `finalizeAggregation` 函数。[#10890](https://github.com/ClickHouse/ClickHouse/pull/10890)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复 `Distributed` 表中使用 `tuple` 时的向后兼容性。 [#10889](https://github.com/ClickHouse/ClickHouse/pull/10889) ([Anton Popov](https://github.com/CurtizJ)).
* 修复 `StringHashTable` 中在键不存在时出现的 SIGSEGV 问题。[#10870](https://github.com/ClickHouse/ClickHouse/pull/10870)（[Azat Khuzhin](https://github.com/azat)）。
* 修复了在使用 `Atomic` 引擎的数据库中删除 `LiveView` 表后，`WATCH` 命令会挂起的问题。[#10859](https://github.com/ClickHouse/ClickHouse/pull/10859) ([tavplubix](https://github.com/tavplubix)).
* 修复了 `ReplicatedMergeTree` 中的一个错误，该错误可能导致某些对 `OPTIMIZE` 查询执行的 `ALTER` 在某个副本变为非活动状态后仍一直等待该副本，从而出现挂起。 [#10849](https://github.com/ClickHouse/ClickHouse/pull/10849) ([tavplubix](https://github.com/tavplubix))。
* 现在，如果参与 `CONSTRAINT` 表达式的列被重命名，则会同步更新相应的约束。修复了 [#10844](https://github.com/ClickHouse/ClickHouse/issues/10844)。 [#10847](https://github.com/ClickHouse/ClickHouse/pull/10847)（[alesapin](https://github.com/alesapin)）。
* 修复缓存字典中可能出现的未初始化内存读取问题。[#10834](https://github.com/ClickHouse/ClickHouse/pull/10834)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 `Block::sortColumns()` 之后修正列顺序（并添加一个测试，用于展示它会影响某些实际用例，例如 `Buffer` 引擎）。 [#10826](https://github.com/ClickHouse/ClickHouse/pull/10826) ([Azat Khuzhin](https://github.com/azat)).
* 修复在未请求给标识符加引号时 `ODBC bridge` 的问题。此更改修复了 [#7984](https://github.com/ClickHouse/ClickHouse/issues/7984)。[#10821](https://github.com/ClickHouse/ClickHouse/pull/10821)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `DateLUT` 中 UBSan 和 MSan 的报告。 [#10798](https://github.com/ClickHouse/ClickHouse/pull/10798) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 在键条件中使用 `src_type` 以确保正确的类型转换。修复了 [#6287](https://github.com/ClickHouse/ClickHouse/issues/6287)。[#10791](https://github.com/ClickHouse/ClickHouse/pull/10791)（[Andrew Onyshchuk](https://github.com/oandrew)）。
* 移除旧的 libunwind 补丁。[https://github.com/ClickHouse-Extras/libunwind/commit/500aa227911bd185a94bfc071d68f4d3b03cb3b1#r39048012](https://github.com/ClickHouse-Extras/libunwind/commit/500aa227911bd185a94bfc071d68f4d3b03cb3b1#r39048012) 这使得在使用 `clang` 的构建中可以禁用 `-fno-omit-frame-pointer`，从而平均至少提升 1% 的性能。[#10761](https://github.com/ClickHouse/ClickHouse/pull/10761) ([Amos Bird](https://github.com/amosbird))。
* 修复在多个分片上使用浮点型权重时的 `avgWeighted`。 [#10758](https://github.com/ClickHouse/ClickHouse/pull/10758) ([Baudouin Giard](https://github.com/bgiard)).
* 修复 `parallel_view_processing` 的行为。现在在发生异常时，所有对 `MATERIALIZED VIEW` 的插入无一例外都应完成。修复 [#10241](https://github.com/ClickHouse/ClickHouse/issues/10241)。[#10757](https://github.com/ClickHouse/ClickHouse/pull/10757)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在与 `-State` 组合使用时的 `-OrNull` 和 `-OrDefault` 组合器。 [#10741](https://github.com/ClickHouse/ClickHouse/pull/10741) ([hcz](https://github.com/hczhcz)).
* 修复在处理嵌套类型时 `generateRandom` 的崩溃问题。修复了 [#10583](https://github.com/ClickHouse/ClickHouse/issues/10583)。[#10734](https://github.com/ClickHouse/ClickHouse/pull/10734)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在合并后可能发生的 `SummingMergeTree` 中 `LowCardinality(FixedString)` 键列数据损坏的问题。修复了 [#10489](https://github.com/ClickHouse/ClickHouse/issues/10489)。[#10721](https://github.com/ClickHouse/ClickHouse/pull/10721)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在主键被函数包裹时，`FINAL` 修饰符与 `ORDER BY` 优化的使用问题。 [#10715](https://github.com/ClickHouse/ClickHouse/pull/10715) ([Anton Popov](https://github.com/CurtizJ)).
* 修复函数 `h3EdgeAngle` 中可能发生的缓冲区溢出问题。[#10711](https://github.com/ClickHouse/ClickHouse/pull/10711) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复 totals 丢失的问题。如果查询包含带有外层 WHERE 条件的 JOIN 或子查询，totals 可能会被过滤掉。修复了 [#10674](https://github.com/ClickHouse/ClickHouse/issues/10674)。[#10698](https://github.com/ClickHouse/ClickHouse/pull/10698)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复 HTTP 插入的原子性问题。修复了 [#9666](https://github.com/ClickHouse/ClickHouse/issues/9666)。[#10687](https://github.com/ClickHouse/ClickHouse/pull/10687)（[Andrew Onyshchuk](https://github.com/oandrew)）。
* 修复在单个查询中多次对相同集合使用 `IN` 运算符的问题。 [#10686](https://github.com/ClickHouse/ClickHouse/pull/10686) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了一个错误：在 `readonly=2` 且 `cancel_http_readonly_queries_on_client_close=1` 时，客户端关闭会导致 HTTP 请求卡死。修复了 [#7939](https://github.com/ClickHouse/ClickHouse/issues/7939)、[#7019](https://github.com/ClickHouse/ClickHouse/issues/7019)、[#7736](https://github.com/ClickHouse/ClickHouse/issues/7736)、[#7091](https://github.com/ClickHouse/ClickHouse/issues/7091)。[#10684](https://github.com/ClickHouse/ClickHouse/pull/10684)（[tavplubix](https://github.com/tavplubix)）。
* 修复 `AggregateTransform` 构造函数中的参数顺序。[#10667](https://github.com/ClickHouse/ClickHouse/pull/10667) ([palasonic1](https://github.com/palasonic1)).
* 修复在启用 `distributed_aggregation_memory_efficient` 时远程查询无法并行执行的问题。修复了 [#10655](https://github.com/ClickHouse/ClickHouse/issues/10655)。[#10664](https://github.com/ClickHouse/ClickHouse/pull/10664)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复包含 `LIMIT` 的查询可能返回的行数不正确的问题。修复了 [#10566](https://github.com/ClickHouse/ClickHouse/issues/10566)、[#10709](https://github.com/ClickHouse/ClickHouse/issues/10709)。[#10660](https://github.com/ClickHouse/ClickHouse/pull/10660)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复当表包含大量数据分片时会锁住并发 `ALTER` 的错误。 [#10659](https://github.com/ClickHouse/ClickHouse/pull/10659) ([alesapin](https://github.com/alesapin))。
* 修复在服务器在表启动前关闭时，`StorageBuffer` 中发生的 `nullptr` 解引用问题。 [#10641](https://github.com/ClickHouse/ClickHouse/pull/10641) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复分布式查询中谓词优化（`enable_optimize_predicate_expression=1`）在带有 `HAVING` 子句的查询中的问题（即需要在发起查询的服务器上进行过滤的情况），通过保留表达式的顺序（这样即可修复问题），并强制聚合器优先使用列名而不是索引。修复问题：[#10613](https://github.com/ClickHouse/ClickHouse/issues/10613)、[#11413](https://github.com/ClickHouse/ClickHouse/issues/11413)。[#10621](https://github.com/ClickHouse/ClickHouse/pull/10621)（[Azat Khuzhin](https://github.com/azat)）。
* 修复在使用 LowCardinality 时 optimize&#95;skip&#95;unused&#95;shards 的问题。 [#10611](https://github.com/ClickHouse/ClickHouse/pull/10611) ([Azat Khuzhin](https://github.com/azat)).
* 修复在服务器启动时抛出异常会导致 `StorageBuffer` 段错误的问题。修复 [#10550](https://github.com/ClickHouse/ClickHouse/issues/10550)。[#10609](https://github.com/ClickHouse/ClickHouse/pull/10609)（[tavplubix](https://github.com/tavplubix)）。
* 在执行 `SYSTEM DROP DNS CACHE` 查询时，同时清除用于检查用户是否被允许从特定 IP 地址连接的缓存。[#10608](https://github.com/ClickHouse/ClickHouse/pull/10608) ([tavplubix](https://github.com/tavplubix))。
* 修复了在 `MATERIALIZED VIEW` 的内部查询中，当该查询包含依赖表时返回错误标量结果的问题。 [#10603](https://github.com/ClickHouse/ClickHouse/pull/10603) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了同步变更的条件变量处理。在某些情况下，发往该条件变量的信号可能会丢失。 [#10588](https://github.com/ClickHouse/ClickHouse/pull/10588) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 修复了在 `loadStoredObject()` 尚未完成时调用 `createDictionary()` 可能导致崩溃的问题。[#10587](https://github.com/ClickHouse/ClickHouse/pull/10587) ([Vitaly Baranov](https://github.com/vitlibar))。
* 修复错误 `the BloomFilter false positive must be a double number between 0 and 1` [#10551](https://github.com/ClickHouse/ClickHouse/issues/10551)。[#10569](https://github.com/ClickHouse/ClickHouse/pull/10569)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复在 `SELECT` 中使用列 `ALIAS` 时，其默认表达式类型与列类型不一致的问题。[#10563](https://github.com/ClickHouse/ClickHouse/pull/10563) ([Azat Khuzhin](https://github.com/azat)).
* 实现了 `DateTime64` 与 `String` 值之间的比较（与 `DateTime` 相同）。 [#10560](https://github.com/ClickHouse/ClickHouse/pull/10560) ([Vasily Nemkov](https://github.com/Enmk))。
* 修复索引损坏问题，该问题在某些情况下会在将紧凑部分合并为另一个紧凑部分后发生。 [#10531](https://github.com/ClickHouse/ClickHouse/pull/10531) ([Anton Popov](https://github.com/CurtizJ)).
* 默认禁用 GROUP BY `sharding_key` 优化（`optimize_distributed_group_by_sharding_key` 已引入但默认关闭，这是由于对 `sharding_key` 的分析存在一些棘手情况，一个简单示例是分片键中包含 `if` 表达式），并修复其在 WITH ROLLUP/CUBE/TOTALS 中的行为。[#10516](https://github.com/ClickHouse/ClickHouse/pull/10516) ([Azat Khuzhin](https://github.com/azat)).
* 修复：[#10263](https://github.com/ClickHouse/ClickHouse/issues/10263)（合并该 PR 之后，通过 `INSERT` 发送到 `dist` 的操作在每次 `INSERT` 时都会被延后）。修复：[#8756](https://github.com/ClickHouse/ClickHouse/issues/8756)（该 PR 会在同时满足以下所有条件时导致分布式发送出错（目前来看是不太常见的部署）：`internal_replication == false`、存在多个本地分片（会触发硬链接代码）以及使用 `distributed_storage_policy`（会导致 `link(2)` 因 `EXDEV` 而失败））。[#10486](https://github.com/ClickHouse/ClickHouse/pull/10486)（[Azat Khuzhin](https://github.com/azat)）。
* 修复了与 `max_rows_to_sort` 限制相关的错误。[#10268](https://github.com/ClickHouse/ClickHouse/pull/10268) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 对任何读取外部字典的函数，在每次调用时只获取一次字典并检查访问权限。 [#10928](https://github.com/ClickHouse/ClickHouse/pull/10928) ([Vitaly Baranov](https://github.com/vitlibar)).

#### 改进 {#improvement-15}


* 在执行 `ALTER MODIFY TTL` 查询后，对旧数据应用 `TTL`。此行为由设置 `materialize_ttl_after_modify` 控制，默认启用。[#11042](https://github.com/ClickHouse/ClickHouse/pull/11042)（[Anton Popov](https://github.com/CurtizJ)）。
* 在解析字符串字面量、`VALUES` 以及各种文本格式中的 C 风格反斜杠转义序列时（这是 ClickHouse 和 MySQL 中常见、超出 SQL 标准的扩展），如果遇到未知的转义序列（例如 `\%` 或 `\w`），则保留反斜杠，这将使 `LIKE` 和 `match` 正则表达式的使用更加方便（只需写 `name LIKE 'used\_cars'` 而不是 `name LIKE 'used\\_cars'`），并同时提高兼容性。此更改修复了 [#10922](https://github.com/ClickHouse/ClickHouse/issues/10922)。[#11208](https://github.com/ClickHouse/ClickHouse/pull/11208)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在读取 `Decimal` 值时，会截断小数点后的多余数字。此行为与 MySQL 和 PostgreSQL 更加兼容。修复了 [#10202](https://github.com/ClickHouse/ClickHouse/issues/10202)。[#11831](https://github.com/ClickHouse/ClickHouse/pull/11831)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 允许在 ZooKeeper 中的元数据已被移除且不再存在时（例如使用 TestKeeper 进行测试并且服务器已重启时也会出现这种情况）对 replicated 表执行 DROP 操作。允许即使在与 ZooKeeper 通信出错的情况下也能对 replicated 表执行 RENAME 操作。修复了 [#10720](https://github.com/ClickHouse/ClickHouse/issues/10720)。[#11652](https://github.com/ClickHouse/ClickHouse/pull/11652)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 略微改进了从字符串读取 `Decimal` 时的诊断信息。这解决了 [#10202](https://github.com/ClickHouse/ClickHouse/issues/10202)。[#11829](https://github.com/ClickHouse/ClickHouse/pull/11829) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复在信号处理程序中调用 `sleep` 的问题。此前的休眠时间短于预期。[#11825](https://github.com/ClickHouse/ClickHouse/pull/11825) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* （仅限 Linux）即使没有 `CAP_NET_ADMIN` 权限，与操作系统相关的性能指标（CPU 和 I/O）也可以正常使用。[#10544](https://github.com/ClickHouse/ClickHouse/pull/10544) ([Alexander Kazakov](https://github.com/Akazz))。
* 添加了 `hostname` 作为函数 `hostName` 的别名。该功能由 Yandex.Metrica 的 Victor Tarnavskiy 提出。[#11821](https://github.com/ClickHouse/ClickHouse/pull/11821) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 在跨复制集群上新增对分布式 `DDL`（更新/删除/丢弃分区）的支持。[#11703](https://github.com/ClickHouse/ClickHouse/pull/11703)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 在启动时，如果无法监听某个监听地址（例如在 Docker 中 IPv6 不可用），则在服务器日志中输出警告而不是错误。请注意，如果服务器无法监听所有列出的地址，它仍会像之前一样拒绝启动。此更改修复了 [#4406](https://github.com/ClickHouse/ClickHouse/issues/4406)。[#11687](https://github.com/ClickHouse/ClickHouse/pull/11687)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 Docker 镜像启动时创建默认用户和数据库。 [#10637](https://github.com/ClickHouse/ClickHouse/pull/10637) ([Paramtamtam](https://github.com/tarampampam))。
* 当多行查询被打印到服务器日志时，这些行会被连接成一行。使其在包含多行字符串字面量、标识符和单行注释的情况下也能正确工作。修复了 [#3853](https://github.com/ClickHouse/ClickHouse/issues/3853)。[#11686](https://github.com/ClickHouse/ClickHouse/pull/11686)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 现在在以下命令中支持指定多个名称：CREATE USER、CREATE ROLE、ALTER USER、SHOW CREATE USER、SHOW GRANTS 等。[#11670](https://github.com/ClickHouse/ClickHouse/pull/11670)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 为跨复制集群添加对分布式 DDL（`UPDATE/DELETE/DROP PARTITION`）的支持。 [#11508](https://github.com/ClickHouse/ClickHouse/pull/11508) ([frank lee](https://github.com/etah000)).
* 如果用户在命令行中以明文方式指定了密码，则会在 `clickhouse-client` 和 `clickhouse-benchmark` 中清除该密码，以防止其被 `ps` 和类似工具泄露。[#11665](https://github.com/ClickHouse/ClickHouse/pull/11665) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 如果 ELF 文件中的调试信息与正在运行的二进制文件不对应，则不要使用这些调试信息。这样可以避免在堆栈跟踪中打印错误的函数名和源代码位置。此更改修复了 [#7514](https://github.com/ClickHouse/ClickHouse/issues/7514)。[#11657](https://github.com/ClickHouse/ClickHouse/pull/11657)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 `parseDateTimeBestEffortOrNull`/`parseDateTimeBestEffortOrZero` 函数中，当值未被完整解析时返回 NULL/零。修复了 [#7876](https://github.com/ClickHouse/ClickHouse/issues/7876)。[#11653](https://github.com/ClickHouse/ClickHouse/pull/11653)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在请求的 URL 中跳过空参数。当你写 `http://localhost:8123/?&a=b` 或 `http://localhost:8123/?a=b&&c=d` 时，可能会出现这种情况。此更改修复了 [#10749](https://github.com/ClickHouse/ClickHouse/issues/10749)。[#11651](https://github.com/ClickHouse/ClickHouse/pull/11651)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 允许将 `groupArrayArray` 和 `groupUniqArrayArray` 用作 `SimpleAggregateFunction`。 [#11650](https://github.com/ClickHouse/ClickHouse/pull/11650) ([Volodymyr Kuznetsov](https://github.com/ksvladimir)).
* 在分析其他类型的索引条件时，通过隐式转换允许与常量字符串进行比较。这可能会解决 [#11630](https://github.com/ClickHouse/ClickHouse/issues/11630)。[#11648](https://github.com/ClickHouse/ClickHouse/pull/11648)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* [https://github.com/ClickHouse/ClickHouse/pull/7572#issuecomment-642815377](https://github.com/ClickHouse/ClickHouse/pull/7572#issuecomment-642815377) 支持配置默认的 HTTP 处理器。[#11628](https://github.com/ClickHouse/ClickHouse/pull/11628)（[Winter Zhang](https://github.com/zhang2014)）。
* 为 Kafka 引擎支持更多输入格式。修复提前刷新的问题。修复当 `kafka_num_consumers` 大于 topic 中分区数时的性能问题。[#11599](https://github.com/ClickHouse/ClickHouse/pull/11599) ([filimonov](https://github.com/filimonov))。
* 改进 `multiple_joins_rewriter_version=2` 的逻辑。修复因 lambda 别名导致的未知列错误。[#11587](https://github.com/ClickHouse/ClickHouse/pull/11587) ([Artem Zuikov](https://github.com/4ertus2))。
* 在无法解析列声明列表时提供更清晰的异常消息。修复了 [#10403](https://github.com/ClickHouse/ClickHouse/issues/10403)。[#11537](https://github.com/ClickHouse/ClickHouse/pull/11537)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 改进在 VIEW 中使用 `enable_optimize_predicate_expression=1` 时的逻辑。 [#11513](https://github.com/ClickHouse/ClickHouse/pull/11513) ([Artem Zuikov](https://github.com/4ertus2)).
* 为 live view 表添加对 PREWHERE 的支持。 [#11495](https://github.com/ClickHouse/ClickHouse/pull/11495) ([vzakaznikov](https://github.com/vzakaznikov))。
* 自动更新用于检查用户是否被允许从某个地址连接的 DNS 缓存。 [#11487](https://github.com/ClickHouse/ClickHouse/pull/11487) ([tavplubix](https://github.com/tavplubix))。
* 即使正在执行并发合并，`OPTIMIZE FINAL` 也会强制进行合并。关闭了 [#11309](https://github.com/ClickHouse/ClickHouse/issues/11309) 和 [#11322](https://github.com/ClickHouse/ClickHouse/issues/11322)。[#11346](https://github.com/ClickHouse/ClickHouse/pull/11346)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 clickhouse-client 中屏蔽已取消查询的输出。在先前版本中，即使按下 Ctrl+C 取消查询，结果仍可能继续在终端中打印。此更改修复了 [#9473](https://github.com/ClickHouse/ClickHouse/issues/9473)。[#11342](https://github.com/ClickHouse/ClickHouse/pull/11342)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 现在历史文件会在每次查询后更新，即使多个客户端共用同一个历史文件也不会出现竞争条件。此更改修复了 [#9897](https://github.com/ClickHouse/ClickHouse/issues/9897)。[#11453](https://github.com/ClickHouse/ClickHouse/pull/11453)（[Tagir Kuskarov](https://github.com/kuskarov)）。
* 在重新加载配置时改进日志消息。[#11341](https://github.com/ClickHouse/ClickHouse/pull/11341) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 在某些情况下，从 `clickhouse-client` 或 `clickhouse-format` 输出的格式化查询中移除末尾空白字符。[#11325](https://github.com/ClickHouse/ClickHouse/pull/11325) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 添加设置 &quot;output&#95;format&#95;pretty&#95;max&#95;value&#95;width&quot;。如果值长度超过该限制，将被截断，以避免在终端中输出过大的值。修复了 [#11140](https://github.com/ClickHouse/ClickHouse/issues/11140)。[#11324](https://github.com/ClickHouse/ClickHouse/pull/11324)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在内存映射不足的情况下提供了更明确的异常消息。修复了 [#11027](https://github.com/ClickHouse/ClickHouse/issues/11027)。[#11316](https://github.com/ClickHouse/ClickHouse/pull/11316)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 ASOF JOIN 中支持 (U)Int8、(U)Int16 和 Date 类型。[#11301](https://github.com/ClickHouse/ClickHouse/pull/11301) ([Artem Zuikov](https://github.com/4ertus2)).
* 为 Kafka 表增加对 kafka&#95;client&#95;id 参数的支持。同时，将 ClickHouse 在与 Kafka 通信时使用的默认 `client.id` 改为更具可读性且更便于使用的值。[#11252](https://github.com/ClickHouse/ClickHouse/pull/11252) ([filimonov](https://github.com/filimonov)).
* 在发生异常时保留 `DistributedFilesToInsert` 指标的值。在之前的版本中，当我们即将发送一些文件时会设置该值，但如果发生异常且仍有部分文件处于挂起状态，该值会被重置为零。现在，该值与文件系统中挂起文件的数量保持一致。[#11220](https://github.com/ClickHouse/ClickHouse/pull/11220)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 增加对多单词数据类型名称（例如 `DOUBLE PRECISION` 和 `CHAR VARYING`）的支持，以提升 SQL 兼容性。[#11214](https://github.com/ClickHouse/ClickHouse/pull/11214) ([Павел Потемкин](https://github.com/Potya))。
* 为部分数据类型提供同义词。 [#10856](https://github.com/ClickHouse/ClickHouse/pull/10856) ([Павел Потемкин](https://github.com/Potya)).
* 查询日志（`query_log`）现已默认启用。[#11184](https://github.com/ClickHouse/ClickHouse/pull/11184)（[Ivan Blinkov](https://github.com/blinkov)）。
* 在 `system.users` 表中以及执行 `SHOW CREATE USER` 查询时显示身份验证类型。 [#11080](https://github.com/ClickHouse/ClickHouse/pull/11080) ([Vitaly Baranov](https://github.com/vitlibar)).
* 在显式执行 `DROP DATABASE` 时清除 `Memory` 数据库引擎中的数据。修复 [#10557](https://github.com/ClickHouse/ClickHouse/issues/10557)。[#11021](https://github.com/ClickHouse/ClickHouse/pull/11021) ([tavplubix](https://github.com/tavplubix))。
* 为 rdkafka 库的内部线程设置线程名称。将 rdkafka 的日志输出到服务器日志中。[#10983](https://github.com/ClickHouse/ClickHouse/pull/10983) ([Azat Khuzhin](https://github.com/azat)).
* 在查询中支持 Unicode 空白字符。这在从 Word 或网页复制粘贴查询时很有帮助。此更改修复了 [#10896](https://github.com/ClickHouse/ClickHouse/issues/10896)。[#10903](https://github.com/ClickHouse/ClickHouse/pull/10903)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 允许在函数 `tupleElement` 中使用较大的 UInt 类型作为索引。 [#10874](https://github.com/ClickHouse/ClickHouse/pull/10874) ([hcz](https://github.com/hczhcz)).
* 在对 Distributed 表执行 INSERT 时，遵循 prefer&#95;localhost&#95;replica/load&#95;balancing 设置。 [#10867](https://github.com/ClickHouse/ClickHouse/pull/10867) ([Azat Khuzhin](https://github.com/azat)).
* 引入 `min_insert_block_size_rows_for_materialized_views` 和 `min_insert_block_size_bytes_for_materialized_views` 设置。这些设置与 `min_insert_block_size_rows` 和 `min_insert_block_size_bytes` 类似，但仅适用于插入到 `MATERIALIZED VIEW` 的数据块。它有助于在向物化视图写入时控制数据块合并，并避免过度的内存占用。[#10858](https://github.com/ClickHouse/ClickHouse/pull/10858) ([Azat Khuzhin](https://github.com/azat))。
* 在服务器关闭期间消除复制队列中的异常。修复了 [#10819](https://github.com/ClickHouse/ClickHouse/issues/10819)。[#10841](https://github.com/ClickHouse/ClickHouse/pull/10841)（[alesapin](https://github.com/alesapin)）。
* 确保 `varSamp`、`varPop` 不会因数值误差而返回负结果，并且禁止从负方差计算 `stddevSamp`、`stddevPop`。这修复了 [#10532](https://github.com/ClickHouse/ClickHouse/issues/10532)。[#10829](https://github.com/ClickHouse/ClickHouse/pull/10829)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 更清晰的 DNS 异常消息。修复了 [#10813](https://github.com/ClickHouse/ClickHouse/issues/10813)。[#10828](https://github.com/ClickHouse/ClickHouse/pull/10828)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在发生某些解析错误时，将 HTTP 响应码改为 400 Bad Request。此修复关联问题 [#10636](https://github.com/ClickHouse/ClickHouse/issues/10636)。[#10640](https://github.com/ClickHouse/ClickHouse/pull/10640)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 如果 `clickhouse-client` 版本高于 `clickhouse-server`，则打印一条消息。 [#10627](https://github.com/ClickHouse/ClickHouse/pull/10627) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 增加对 `INSERT INTO [db.]table WATCH` 查询的支持。 [#10498](https://github.com/ClickHouse/ClickHouse/pull/10498) ([vzakaznikov](https://github.com/vzakaznikov)).
* 允许在 clickhouse-client 中传递 quota&#95;key。修复了 [#10227](https://github.com/ClickHouse/ClickHouse/issues/10227)。[#10270](https://github.com/ClickHouse/ClickHouse/pull/10270)（[alexey-milovidov](https://github.com/alexey-milovidov)）。

#### 性能改进 {#performance-improvement-9}


* 允许多个副本并发分配合并、变更、分区删除、移动和替换操作。修复了 [#10367](https://github.com/ClickHouse/ClickHouse/issues/10367)。[#11639](https://github.com/ClickHouse/ClickHouse/pull/11639)（[alexey-milovidov](https://github.com/alexey-milovidov)）[#11795](https://github.com/ClickHouse/ClickHouse/pull/11795)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 根据表的排序键对 GROUP BY 进行优化，通过 `optimize_aggregation_in_order` 设置启用。[#9113](https://github.com/ClickHouse/ClickHouse/pull/9113)（[dimarub2000](https://github.com/dimarub2000)）。
* 带有 `FINAL` 的 `SELECT` 查询将并行执行。新增设置项 `max_final_threads` 用于限制使用的线程数。 [#10463](https://github.com/ClickHouse/ClickHouse/pull/10463) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 通过在生成小数据块时（并行解析的典型场景）使用 `INSERT SELECT` 或通过 clickhouse-client 执行 INSERT 来提升 INSERT 查询性能。修复了 `DEFAULT` 字段上的 `CONSTRAINT` 未生效的问题（[#11275](https://github.com/ClickHouse/ClickHouse/issues/11275)、[#11273](https://github.com/ClickHouse/ClickHouse/issues/11273)）。修复了在 `TEMPORARY` 表上忽略 `CONSTRAINTS` 的问题（[#11274](https://github.com/ClickHouse/ClickHouse/issues/11274)）。[#11276](https://github.com/ClickHouse/ClickHouse/pull/11276)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 对 `SELECT` 子句中 `GROUP BY` 键上的 `min`/`max`/`any` 聚合函数进行消除的优化，通过 `optimize_aggregators_of_group_by_keys` 设置启用。[#11667](https://github.com/ClickHouse/ClickHouse/pull/11667) ([xPoSx](https://github.com/xPoSx)). [#11806](https://github.com/ClickHouse/ClickHouse/pull/11806) ([Azat Khuzhin](https://github.com/azat)).
* 新增了一项优化，可将所有操作从 `any` 函数中移出，通过 `optimize_move_functions_out_of_any` 启用 [#11529](https://github.com/ClickHouse/ClickHouse/pull/11529) ([Ruslan](https://github.com/kamalov-ruslan))。
* 在交互模式下使用 Pretty 格式时提升 `clickhouse-client` 的性能。在之前的版本中，计算 UTF-8 字符串的可见宽度可能会耗费大量时间。此更改关闭了 [#11323](https://github.com/ClickHouse/ClickHouse/issues/11323)。[#11323](https://github.com/ClickHouse/ClickHouse/pull/11323)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 提升了包含 `ORDER BY` 且 `LIMIT` 较小（小于 `max_block_size`）的查询的性能。[#11171](https://github.com/ClickHouse/ClickHouse/pull/11171) ([Albert Kidrachev](https://github.com/Provet))。
* 添加运行时 CPU 检测，用于选择并调度最佳函数实现。添加对面向多个目标的代码生成的支持。此更改关闭了 [#1017](https://github.com/ClickHouse/ClickHouse/issues/1017)。[#10058](https://github.com/ClickHouse/ClickHouse/pull/10058)（[DimasKovas](https://github.com/DimasKovas)）。
* 默认启用对 clickhouse 二进制文件的 `mlock`。这将防止在高 IO 负载下 clickhouse 可执行文件被换出内存。 [#11139](https://github.com/ClickHouse/ClickHouse/pull/11139) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 在查询中使用 `sum` 聚合函数且不包含 GROUP BY 键，可以使查询运行速度提高数倍。 [#10992](https://github.com/ClickHouse/ClickHouse/pull/10992) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 通过移除部分冗余数据搬移操作来改进基数排序（用于简单键的 `ORDER BY`）。[#10981](https://github.com/ClickHouse/ClickHouse/pull/10981) ([Arslan Gumerov](https://github.com/g-arslan))。
* 在 MergeJoin 中对左表较大的部分进行排序，并在内存中缓冲左表数据块。新增 `partial_merge_join_left_table_buffer_bytes` 设置，用于管理左表数据块缓冲区的大小。 [#10601](https://github.com/ClickHouse/ClickHouse/pull/10601) ([Artem Zuikov](https://github.com/4ertus2)).
* 从子查询中移除重复的 ORDER BY 和 DISTINCT，该优化可通过设置 `optimize_duplicate_order_by_and_distinct` 启用 [#10067](https://github.com/ClickHouse/ClickHouse/pull/10067)（[Mikhail Malafeev](https://github.com/demo-99)）。
* 此功能在启用 `optimize_group_by_function_keys` 时，会在 `GROUP BY` 子句中去除其他键上的函数 [#10051](https://github.com/ClickHouse/ClickHouse/pull/10051)（[xPoSx](https://github.com/xPoSx)）。
* 新增了一项优化，可将算术运算从聚合函数中提取出来，通过 `optimize_arithmetic_operations_in_aggregate_functions` 启用 [#10047](https://github.com/ClickHouse/ClickHouse/pull/10047)（[Ruslan](https://github.com/kamalov-ruslan)）。
* 使用基于 Poco 而非 curl 的 S3 HTTP 客户端。这将提升 S3 存储和表函数的性能，并降低内存使用。[#11230](https://github.com/ClickHouse/ClickHouse/pull/11230)（[Pavel Kovalenko](https://github.com/Jokser)）。
* 修复与基于限制的重新调度相关的 Kafka 性能问题，之前这些限制总是会被应用。 [#11149](https://github.com/ClickHouse/ClickHouse/pull/11149) ([filimonov](https://github.com/filimonov)).
* 为 jemalloc 启用 percpu&#95;arena:percpu（这将减少线程池导致的内存碎片）。[#11084](https://github.com/ClickHouse/ClickHouse/pull/11084) ([Azat Khuzhin](https://github.com/azat)).
* 在通过 S3 HTTP 客户端读取响应时优化内存使用。[#11561](https://github.com/ClickHouse/ClickHouse/pull/11561)（[Pavel Kovalenko](https://github.com/Jokser)）。
* 调整 Kafka 默认设置以提升性能。 [#11388](https://github.com/ClickHouse/ClickHouse/pull/11388) ([filimonov](https://github.com/filimonov)).

#### 实验性功能 {#experimental-feature-5}

- 新增数据类型 `Point` (Tuple(Float64, Float64)) 和 `Polygon` (Array(Array(Tuple(Float64, Float64))))。[#10678](https://github.com/ClickHouse/ClickHouse/pull/10678) ([Alexey Ilyukhov](https://github.com/livace))。
- 新增 `hasSubstr` 函数,用于在数组中查找子序列。注意:此函数可能会在不另行通知的情况下重命名。[#11071](https://github.com/ClickHouse/ClickHouse/pull/11071) ([Ryad Zenine](https://github.com/r-zenine))。
- 新增 OpenCL 支持和双调排序算法,可用于对单列中的整数类型数据进行排序。需要使用 `-DENABLE_OPENCL=1` 标志进行构建。要使用双调排序算法替代其他算法,需要将设置选项 `special_sort` 设为 `bitonic_sort`,并确保 OpenCL 可用。此功能不会提升性能,仅作为示例和演示用途提供。如果该方向没有进一步开发,此功能可能会在不久的将来被移除。[#10232](https://github.com/ClickHouse/ClickHouse/pull/10232) ([Ri](https://github.com/margaritiko))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-11}


* 为 `programs` 和 `utils` 启用 `clang-tidy`。[#10991](https://github.com/ClickHouse/ClickHouse/pull/10991) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 移除对 `tzdata` 的依赖：即使 `/usr/share/zoneinfo` 目录不存在也不要报错。请注意，即使系统中未安装 tzdata，所有时区在 ClickHouse 中仍然可以正常工作。[#11827](https://github.com/ClickHouse/ClickHouse/pull/11827) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 添加了 MSan 和 UBSan 压力测试。请注意，我们已经在功能测试中使用了 MSan 和 UBSan，而“压力”测试是另一类测试。[#10871](https://github.com/ClickHouse/ClickHouse/pull/10871) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 在崩溃信息中打印编译构建 ID，这样我们就能更准确地判断是哪个二进制文件崩溃了。新增函数 `buildId`。[#11824](https://github.com/ClickHouse/ClickHouse/pull/11824) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 添加了一个测试，用于确保在执行 FREEZE 查询后变更操作仍能正常工作。[#11820](https://github.com/ClickHouse/ClickHouse/pull/11820) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 不允许测试名称中包含子串 &quot;fail&quot;，因为当你在浏览器中按 Ctrl+F 搜索 &quot;fail&quot; 时，这会让查看测试结果变得不太方便。[#11817](https://github.com/ClickHouse/ClickHouse/pull/11817) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 从 HTTPHandlerFactory 中移除未使用的导入。[#11660](https://github.com/ClickHouse/ClickHouse/pull/11660) ([Bharat Nallan](https://github.com/bharatnc)).
* 为 `copier` 的执行新增了随机抽样机制，以避免出现 `Too many simultaneous queries` 错误。同时增加了超时时间并降低了故障概率。[#11573](https://github.com/ClickHouse/ClickHouse/pull/11573) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 修复遗漏的 include 语句。 [#11525](https://github.com/ClickHouse/ClickHouse/pull/11525) ([Matwey V. Kornilov](https://github.com/matwey)).
* 通过移除旧的示例程序来加快构建速度。同时还发现了一些孤立的功能测试。[#11486](https://github.com/ClickHouse/ClickHouse/pull/11486) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 在 CI 中增大构建所用的 ccache 大小。 [#11450](https://github.com/ClickHouse/ClickHouse/pull/11450) ([alesapin](https://github.com/alesapin)).
* 在 deb 构建中仅保留 unit&#95;tests&#95;dbms。[#11429](https://github.com/ClickHouse/ClickHouse/pull/11429) ([Ilya Yatsishin](https://github.com/qoega))。
* 将 librdkafka 更新至版本 [1.4.2](https://github.com/edenhill/librdkafka/releases/tag/v1.4.2)。[#11256](https://github.com/ClickHouse/ClickHouse/pull/11256)（[filimonov](https://github.com/filimonov)）。
* 重构 CMake 构建文件。 [#11390](https://github.com/ClickHouse/ClickHouse/pull/11390) ([Ivan](https://github.com/abyss7))。
* 修复了若干不稳定的集成测试。[#11355](https://github.com/ClickHouse/ClickHouse/pull/11355) ([alesapin](https://github.com/alesapin))。
* 为使用 UBSan 运行的单元测试添加支持。[#11345](https://github.com/ClickHouse/ClickHouse/pull/11345) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 从集成测试 `test_insertion_sync_fails_with_timeout` 中移除冗余的超时设置。 [#11343](https://github.com/ClickHouse/ClickHouse/pull/11343) ([alesapin](https://github.com/alesapin)).
* 改进 `clickhouse-test` 中对挂起查询的检查。 [#11321](https://github.com/ClickHouse/ClickHouse/pull/11321) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 如果服务器是以 debug 模式或启用了 sanitizers 构建的，则发出警告。[#11304](https://github.com/ClickHouse/ClickHouse/pull/11304) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 现在 `clickhouse-test` 会在运行测试前检查服务器是否存活。[#11285](https://github.com/ClickHouse/ClickHouse/pull/11285) ([alesapin](https://github.com/alesapin))。
* 修复可能不稳定的测试 `00731_long_merge_tree_select_opened_files.sh`。它虽然失败得不算频繁，但我们在使用 ThreadFuzzer 做实验时，在该测试中发现了潜在的竞争条件：[#9814](https://github.com/ClickHouse/ClickHouse/issues/9814)。示例见此[链接](https://clickhouse-test-reports.s3.yandex.net/9814/40e3023e215df22985d275bf85f4d2290897b76b/functional_stateless_tests_\(unbundled\).html#fail1)。[#11270](https://github.com/ClickHouse/ClickHouse/pull/11270)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 如果 `curl` 调用发生超时，则在 CI 中重新运行测试。这可能是由于我们的 CI 基础设施中常见的、持续 10 秒以上的系统挂起所致。此更改修复了 [#11267](https://github.com/ClickHouse/ClickHouse/issues/11267)。[#11268](https://github.com/ClickHouse/ClickHouse/pull/11268) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 为 @donmikel 提交的 `Join` 表引擎添加测试。关闭了 [#9158](https://github.com/ClickHouse/ClickHouse/issues/9158)。[#11265](https://github.com/ClickHouse/ClickHouse/pull/11265)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复单元测试中的若干次要错误。 [#11262](https://github.com/ClickHouse/ClickHouse/pull/11262) ([alesapin](https://github.com/alesapin)).
* 现在，`cctz` 库的链接命令各部分将不会再与其他库混在一起。[#11213](https://github.com/ClickHouse/ClickHouse/pull/11213) ([alesapin](https://github.com/alesapin)).
* 将 /programs/server 拆分为独立的可执行程序和库。[#11186](https://github.com/ClickHouse/ClickHouse/pull/11186) ([Ivan](https://github.com/abyss7))。
* 改进 protobuf 和 gRPC 的构建脚本。 [#11172](https://github.com/ClickHouse/ClickHouse/pull/11172) ([Vitaly Baranov](https://github.com/vitlibar)).
* 启用此前无法运行的性能测试。 [#11158](https://github.com/ClickHouse/ClickHouse/pull/11158) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 在启动任何 CH 实例之前，为测试创建根 S3 桶。[#11142](https://github.com/ClickHouse/ClickHouse/pull/11142)（[Pavel Kovalenko](https://github.com/Jokser)）。
* 为非恒定多边形添加性能测试。 [#11141](https://github.com/ClickHouse/ClickHouse/pull/11141) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复 `00979_live_view_watch_continuous_aggregates` 测试。[#11024](https://github.com/ClickHouse/ClickHouse/pull/11024)（[vzakaznikov](https://github.com/vzakaznikov)）。
* 在集成测试中新增通过 tmpfs 运行 zookeeper 的功能。[#11002](https://github.com/ClickHouse/ClickHouse/pull/11002)（[alesapin](https://github.com/alesapin)）。
* 采用指数退避策略等待 odbc-bridge。之前在我们的 CI 环境中，200 ms 的等待时间不够。[#10990](https://github.com/ClickHouse/ClickHouse/pull/10990) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复不确定性的测试。[#10989](https://github.com/ClickHouse/ClickHouse/pull/10989)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为外部空数据添加了测试。[#10926](https://github.com/ClickHouse/ClickHouse/pull/10926) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 在每个测试中都会重新创建数据库，从而提高了测试之间的隔离性。 [#10902](https://github.com/ClickHouse/ClickHouse/pull/10902) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 在列相关代码中增加了更多 `assert`。 [#10833](https://github.com/ClickHouse/ClickHouse/pull/10833) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 与 sanitizer 更好地协同工作。在 sanitizer 失败的消息中打印 query&#95;id 信息。 [#10832](https://github.com/ClickHouse/ClickHouse/pull/10832) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复 “Split build smoke test” 检查中的明显竞争条件。[#10820](https://github.com/ClickHouse/ClickHouse/pull/10820)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `MergeTreeIndexFullText` 中的误报 MSan 报告。该问题最早出现在 [#9968](https://github.com/ClickHouse/ClickHouse/issues/9968)。[#10801](https://github.com/ClickHouse/ClickHouse/pull/10801)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 MariaDB Client 库添加 MSan 抑制规则。 [#10800](https://github.com/ClickHouse/ClickHouse/pull/10800) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* GRPC 的 `make` 无法找到 protobuf 文件，通过在 `make` 文件中添加正确的路径进行了修复。 [#10794](https://github.com/ClickHouse/ClickHouse/pull/10794) ([mnkonkova](https://github.com/mnkonkova)).
* 为 base、utils、programs 启用额外的警告（`-Weverything`）。请注意，我们已经在大部分代码中启用了该选项。[#10779](https://github.com/ClickHouse/ClickHouse/pull/10779) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 来自库的警告屏蔽在 [#10396](https://github.com/ClickHouse/ClickHouse/issues/10396) 中被错误地声明为 public。[#10776](https://github.com/ClickHouse/ClickHouse/pull/10776)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 恢复在 [#10396](https://github.com/ClickHouse/ClickHouse/issues/10396) 中被误删的补丁。[#10774](https://github.com/ClickHouse/ClickHouse/pull/10774) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复性能测试错误（第 2 部分）。[#10773](https://github.com/ClickHouse/ClickHouse/pull/10773)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复性能测试中的错误。 [#10766](https://github.com/ClickHouse/ClickHouse/pull/10766) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 更新交叉编译构建以使用 clang-10 编译器。[#10724](https://github.com/ClickHouse/ClickHouse/pull/10724)（[Ivan](https://github.com/abyss7)）。
* 更新 RPM 包的安装说明。该建议由 Denis（TG 登录名 @ldviolet）提出，并由 Arkady Shejn 实现。[#10707](https://github.com/ClickHouse/ClickHouse/pull/10707)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 尝试修复 `tests/queries/0_stateless/01246_insert_into_watch_live_view.py` 测试。[#10670](https://github.com/ClickHouse/ClickHouse/pull/10670)（[vzakaznikov](https://github.com/vzakaznikov)）。
* 修复并重新启用 00979&#95;live&#95;view&#95;watch&#95;continuous&#95;aggregates.py 测试。[#10658](https://github.com/ClickHouse/ClickHouse/pull/10658) ([vzakaznikov](https://github.com/vzakaznikov))。
* 修复 ASan 压力测试中的内存不足（OOM）问题。 [#10646](https://github.com/ClickHouse/ClickHouse/pull/10646) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复在迁移到 clang-10 后出现在 `HashTable` 中的 UBSan 报告（对 `nullptr` 执行加零操作）。 [#10638](https://github.com/ClickHouse/ClickHouse/pull/10638) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 在编译时处理 tzdata 的过程中，移除对外部 `ld`（bfd）链接器的调用。[#10634](https://github.com/ClickHouse/ClickHouse/pull/10634) ([alesapin](https://github.com/alesapin))。
* 允许使用 `lld` 链接二进制大对象（资源）。 [#10632](https://github.com/ClickHouse/ClickHouse/pull/10632) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复 `LZ4` 库中的 UBSan 报告。[#10631](https://github.com/ClickHouse/ClickHouse/pull/10631)（[alexey-milovidov](https://github.com/alexey-milovidov)）。另请参见 [https://github.com/lz4/lz4/issues/857](https://github.com/lz4/lz4/issues/857)
* 将 LZ4 更新到最新的开发分支。[#10630](https://github.com/ClickHouse/ClickHouse/pull/10630) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 添加了一个自动生成的、机器可读的稳定版本列表文件。 [#10628](https://github.com/ClickHouse/ClickHouse/pull/10628) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复针对 `capnp::UnalignedFlatArrayMessageReader` 的 `capnproto` 版本检查。[#10618](https://github.com/ClickHouse/ClickHouse/pull/10618) ([Matwey V. Kornilov](https://github.com/matwey)).
* 在测试中降低内存占用。[#10617](https://github.com/ClickHouse/ClickHouse/pull/10617) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复新 live view 测试中硬编码的超时设置。[#10604](https://github.com/ClickHouse/ClickHouse/pull/10604) ([vzakaznikov](https://github.com/vzakaznikov))。
* 在 tests/queries/0&#95;stateless/helpers/client.py 中增加打开客户端时的超时设置。[#10599](https://github.com/ClickHouse/ClickHouse/pull/10599)（[vzakaznikov](https://github.com/vzakaznikov)）。
* 为 clang 编译启用 ThinLTO，延续自 [#10435](https://github.com/ClickHouse/ClickHouse/pull/10435)。 [#10585](https://github.com/ClickHouse/ClickHouse/pull/10585)（[Amos Bird](https://github.com/amosbird)）。
* 添加 Fuzzer，并为集成 oss-fuzz 做准备。 [#10546](https://github.com/ClickHouse/ClickHouse/pull/10546) ([kyprizel](https://github.com/kyprizel)).
* 修复 FreeBSD 构建。[#10150](https://github.com/ClickHouse/ClickHouse/pull/10150) ([Ivan](https://github.com/abyss7))。
* 使用 pytest 框架为查询测试添加新的构建。 [#10039](https://github.com/ClickHouse/ClickHouse/pull/10039) ([Ivan](https://github.com/abyss7))。





## ClickHouse 版本 v20.4 {#clickhouse-release-v204}

### ClickHouse 版本 v20.4.8.99-stable 2020-08-10 {#clickhouse-release-v204899-stable-2020-08-10}

#### Bug 修复 {#bug-fix-28}


* 修复了在将 Unix 时间戳作为参数传入时 `parseDateTimeBestEffort` 函数中的错误。此修复解决了 [#13362](https://github.com/ClickHouse/ClickHouse/issues/13362)。[#13441](https://github.com/ClickHouse/ClickHouse/pull/13441)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在包含 NaN 值的 Float 类型上调用 `uniqExact`、`topK`、`sumDistinct` 以及类似聚合函数时，可能出现的性能较低和结果略有偏差的问题。该问题还会在 debug 构建中触发断言。本次修复了 [#12491](https://github.com/ClickHouse/ClickHouse/issues/12491)。[#13254](https://github.com/ClickHouse/ClickHouse/pull/13254)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在 `if` 函数中使用可为空的 `constexpr` 作为条件且其值不是字面量 `NULL` 时的行为。修复了 [#12463](https://github.com/ClickHouse/ClickHouse/issues/12463)。[#13226](https://github.com/ClickHouse/ClickHouse/pull/13226)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在数组元素为 Nullable 且数组下标也为 Nullable 时，`arrayElement` 函数中的断言。此更改修复了 [#12172](https://github.com/ClickHouse/ClickHouse/issues/12172)。 [#13224](https://github.com/ClickHouse/ClickHouse/pull/13224)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了涉及函数的错误索引分析。这可能会在从 `MergeTree` 表读取时导致错误地剪枝数据分片。修复了 [#13060](https://github.com/ClickHouse/ClickHouse/issues/13060)。修复了 [#12406](https://github.com/ClickHouse/ClickHouse/issues/12406)。[#13081](https://github.com/ClickHouse/ClickHouse/pull/13081)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复了从本地副本执行 `SELECT` 时对线程数量的不必要限制。[#12840](https://github.com/ClickHouse/ClickHouse/pull/12840) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了在使用 `WITH TOTALS` 的查询中，数据中可能出现的多余溢出行。 [#12747](https://github.com/ClickHouse/ClickHouse/pull/12747) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复了在 `IN` 子句中将大型 `tuple` 作为函数解释时的性能问题。即在某些难以理解的情况下，用户写成 `WHERE x IN tuple(1, 2, ...)` 而不是 `WHERE x IN (1, 2, ...)` 的用法。[#12700](https://github.com/ClickHouse/ClickHouse/pull/12700) ([Anton Popov](https://github.com/CurtizJ)).
* 通过将线程附加到组来修复 `input_format_parallel_parsing` 的内存跟踪。[#12672](https://github.com/ClickHouse/ClickHouse/pull/12672)（[Azat Khuzhin](https://github.com/azat)）。
* 修复了 [#12293](https://github.com/ClickHouse/ClickHouse/issues/12293) 中的问题：当子查询包含 `WITH` 子句时，允许进行谓词下推。[#12663](https://github.com/ClickHouse/ClickHouse/pull/12663)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复了 [#10572](https://github.com/ClickHouse/ClickHouse/issues/10572) 中 bloom filter 索引在使用 const 表达式时的问题。[#12659](https://github.com/ClickHouse/ClickHouse/pull/12659)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复了在 broker 不可用（及其他情况）时 `StorageKafka` 中出现的 `SIGSEGV`。 [#12658](https://github.com/ClickHouse/ClickHouse/pull/12658) ([Azat Khuzhin](https://github.com/azat)).
* 为 `if` 函数添加了对 `Array(UUID)` 参数的支持。修复了 [#11066](https://github.com/ClickHouse/ClickHouse/issues/11066)。[#12648](https://github.com/ClickHouse/ClickHouse/pull/12648)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了使用 `cache` 布局的外部字典中的竞争条件，该问题可能导致服务器崩溃。 [#12566](https://github.com/ClickHouse/ClickHouse/pull/12566) ([alesapin](https://github.com/alesapin))。
* 在执行 DROP TABLE 时，移除 Distributed 表的数据（来自异步 INSERT 的数据块）。[#12556](https://github.com/ClickHouse/ClickHouse/pull/12556) ([Azat Khuzhin](https://github.com/azat))。
* 修复了在 `enable_mixed_granularity_parts=1` 时执行 `ALTER DELETE` 查询会导致旧分片损坏的错误。修复了 [#12536](https://github.com/ClickHouse/ClickHouse/issues/12536)。[#12543](https://github.com/ClickHouse/ClickHouse/pull/12543)（[alesapin](https://github.com/alesapin)）。
* 为函数 `in` 在参数数量无效时提供了更清晰的异常信息。[#12529](https://github.com/ClickHouse/ClickHouse/pull/12529) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了从 compact 部件读取时的性能问题。[#12492](https://github.com/ClickHouse/ClickHouse/pull/12492) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了在与字典进行 `JOIN` 时，当按照字典键的表达式进行连接（`t JOIN dict ON expr(dict.id) = t.id`）时发生的崩溃。针对这种情况禁用了字典 `JOIN` 优化。 [#12458](https://github.com/ClickHouse/ClickHouse/pull/12458) ([Artem Zuikov](https://github.com/4ertus2)).
* 修复了在 `StorageMerge` 中可能发生的段错误。修复 [#12054](https://github.com/ClickHouse/ClickHouse/issues/12054)。[#12401](https://github.com/ClickHouse/ClickHouse/pull/12401)（[tavplubix](https://github.com/tavplubix)）。
* 修复了 `WITH FILL` 修饰符中列顺序的问题。此前未能遵循 `ORDER BY` 子句中列的顺序。[#12306](https://github.com/ClickHouse/ClickHouse/pull/12306) ([Anton Popov](https://github.com/CurtizJ))。
* 当存在按虚拟列（例如 `Merge` 表中的 `_table`）或按系统表中的 “index” 列过滤数据的表达式（例如在查询 `system.tables` 时按数据库名过滤），且该表达式返回 `Nullable` 类型时，避免抛出 “bad cast” 异常。修复了 [#12166](https://github.com/ClickHouse/ClickHouse/issues/12166)。[#12305](https://github.com/ClickHouse/ClickHouse/pull/12305)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 TrieDictionary 加载失败时显示错误。 [#12290](https://github.com/ClickHouse/ClickHouse/pull/12290) ([Vitaly Baranov](https://github.com/vitlibar)).
* 函数 `arrayFill` 在处理空数组时工作不正确，可能导致崩溃。此修复解决了 [#12263](https://github.com/ClickHouse/ClickHouse/issues/12263)。[#12279](https://github.com/ClickHouse/ClickHouse/pull/12279)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 `LowCardinality` 类型实现了向通用类型的转换。这样就可以对包含 `LowCardinality` 列和其他列的表执行 `UNION ALL` 操作。修复了 [#8212](https://github.com/ClickHouse/ClickHouse/issues/8212)。修复了 [#4342](https://github.com/ClickHouse/ClickHouse/issues/4342)。[#12275](https://github.com/ClickHouse/ClickHouse/pull/12275)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在对 `StorageFile` 进行多次连续插入时，某些特殊类型的 header 被重复写入的问题。此修复解决了 [#6155](https://github.com/ClickHouse/ClickHouse/issues/6155)。[#12197](https://github.com/ClickHouse/ClickHouse/pull/12197)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 修复了对于不等于 0 或 1 的 `UInt8` 值的逻辑函数行为。[#12196](https://github.com/ClickHouse/ClickHouse/pull/12196)（[Alexander Kazakov](https://github.com/Akazz)）。
* 将 max&#95;memory&#95;usage* 的限制上限约束为进程的常驻内存。 [#12182](https://github.com/ClickHouse/ClickHouse/pull/12182) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在消除 `GROUP BY` 中的单射函数时对 `dictGet` 参数的检查。[#12179](https://github.com/ClickHouse/ClickHouse/pull/12179) ([Azat Khuzhin](https://github.com/azat)).
* 如果 ODBC 连接不支持 schema，则不要将字典源的表名拆分为 schema 和表名本身。[#12165](https://github.com/ClickHouse/ClickHouse/pull/12165)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复了 `ALTER DELETE` 中的错误逻辑，该逻辑会在条件计算结果为 NULL 时误删记录。此修复解决了 [#9088](https://github.com/ClickHouse/ClickHouse/issues/9088)，并关闭了 [#12106](https://github.com/ClickHouse/ClickHouse/issues/12106)。[#12153](https://github.com/ClickHouse/ClickHouse/pull/12153)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在存在别名时，将查询转换后发送到外部 DBMS（例如 MySQL、ODBC）的逻辑。此修复解决了 [#12032](https://github.com/ClickHouse/ClickHouse/issues/12032)。[#12151](https://github.com/ClickHouse/ClickHouse/pull/12151)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了整数除法中的潜在溢出问题。修复了 [#12119](https://github.com/ClickHouse/ClickHouse/issues/12119)。[#12140](https://github.com/ClickHouse/ClickHouse/pull/12140)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了 `greatCircleDistance` 和 `geoDistance` 中潜在的无限循环问题。此修复对应 [#12117](https://github.com/ClickHouse/ClickHouse/issues/12117)。[#12137](https://github.com/ClickHouse/ClickHouse/pull/12137)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 规范化对 “pid” 文件的处理。在之前的版本中，如果服务器被非正常终止，并且此时存在另一个进程恰好使用了之前运行服务器相同的 pid，服务器可能会拒绝启动。此外，在服务器启动失败时，即使还有另一个服务器正在运行，其 pid 文件也可能被删除。此改动修复了 [#3501](https://github.com/ClickHouse/ClickHouse/issues/3501)。[#12133](https://github.com/ClickHouse/ClickHouse/pull/12133) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了对使用 ENGINE=Dictionary 的表与字典之间依赖关系的处理问题。此修复解决了 [#10994](https://github.com/ClickHouse/ClickHouse/issues/10994)。此修复解决了 [#10397](https://github.com/ClickHouse/ClickHouse/issues/10397)。[#12116](https://github.com/ClickHouse/ClickHouse/pull/12116)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复了由于总线程数限制错误而导致包含 `UNION` 的 `SELECT` 查询性能下降的问题。修复了 [#12030](https://github.com/ClickHouse/ClickHouse/issues/12030)。[#12103](https://github.com/ClickHouse/ClickHouse/pull/12103)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了使用 `-StateResample` 组合器时出现的段错误。 [#12092](https://github.com/ClickHouse/ClickHouse/pull/12092) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了在 `system.quey_log` 中针对 `SELECT` 查询的 `result_rows` 和 `result_bytes` 指标为空的问题。修复了 [#11595](https://github.com/ClickHouse/ClickHouse/issues/11595)。[#12089](https://github.com/ClickHouse/ClickHouse/pull/12089)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了从 `VIEW` 中执行 `SELECT` 时对线程数量的不必要限制。修复了 [#11937](https://github.com/ClickHouse/ClickHouse/issues/11937)。[#12085](https://github.com/ClickHouse/ClickHouse/pull/12085)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在为 `PREWHERE` 使用错误类型时可能发生的崩溃。修复了 [#12053](https://github.com/ClickHouse/ClickHouse/issues/12053)、[#12060](https://github.com/ClickHouse/ClickHouse/issues/12060)。[#12060](https://github.com/ClickHouse/ClickHouse/pull/12060)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在 `LowCardinality` 类型下使用函数 `defaultValueOfArgumentType` 时出现的错误 `Expected single dictionary argument for function`。修复了 [#11808](https://github.com/ClickHouse/ClickHouse/issues/11808)。[#12056](https://github.com/ClickHouse/ClickHouse/pull/12056)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在高阶函数使用 `Tuple(LowCardinality)` 参数时出现的 `Cannot capture column` 错误。修复了 [#9766](https://github.com/ClickHouse/ClickHouse/issues/9766)。[#12055](https://github.com/ClickHouse/ClickHouse/pull/12055)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 在加载数据库时并行解析表元数据，修复了在存在大量表时服务器启动缓慢的问题。[#12045](https://github.com/ClickHouse/ClickHouse/pull/12045) ([tavplubix](https://github.com/tavplubix)).
* 使 `topK` 聚合函数在处理 Enum 类型时返回 Enum 类型。修复了 [#3740](https://github.com/ClickHouse/ClickHouse/issues/3740)。[#12043](https://github.com/ClickHouse/ClickHouse/pull/12043)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了对约束的检查逻辑，使其验证约束是否为常量表达式。这修复了 [#11360](https://github.com/ClickHouse/ClickHouse/issues/11360)。[#12042](https://github.com/ClickHouse/ClickHouse/pull/12042)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在比较包含 `Nullable` 列的元组时的错误。修复了 [#11985](https://github.com/ClickHouse/ClickHouse/issues/11985)。[#12039](https://github.com/ClickHouse/ClickHouse/pull/12039)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在 allow&#95;introspection&#95;functions=0 时访问权限计算方式的问题。 [#12031](https://github.com/ClickHouse/ClickHouse/pull/12031) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复了在调用函数 `if` 时，当参数为不同大小的 `FixedString` 类型时可能产生的错误结果和潜在崩溃的问题。此修复对应 [#11362](https://github.com/ClickHouse/ClickHouse/issues/11362)。[#12021](https://github.com/ClickHouse/ClickHouse/pull/12021)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 当查询中仅包含 `neighbor` 函数作为返回表达式时，如果以偏移量 `-9223372036854775808` 调用该函数，查询可能返回空结果。此更改修复了 [#11367](https://github.com/ClickHouse/ClickHouse/issues/11367)。[#12019](https://github.com/ClickHouse/ClickHouse/pull/12019)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在 `allow_ddl=0` 时对访问权限的计算。 [#12015](https://github.com/ClickHouse/ClickHouse/pull/12015) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复了 `generateRandom` 中可能导致崩溃的数组大小潜在溢出问题。此修复对应 [#11371](https://github.com/ClickHouse/ClickHouse/issues/11371)。[#12013](https://github.com/ClickHouse/ClickHouse/pull/12013)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了潜在的浮点异常，关闭了 [#11378](https://github.com/ClickHouse/ClickHouse/issues/11378)。[#12005](https://github.com/ClickHouse/ClickHouse/pull/12005)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了服务器启动时日志消息中错误的配置名称。[#11997](https://github.com/ClickHouse/ClickHouse/pull/11997)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在 `Values` 格式中出现的 `Query parameter was not set` 错误。修复了 [#11918](https://github.com/ClickHouse/ClickHouse/issues/11918)。[#11936](https://github.com/ClickHouse/ClickHouse/pull/11936)（[tavplubix](https://github.com/tavplubix)）。
* 在查询中保留用于替换的别名（参数化查询）。修复了 [#11914](https://github.com/ClickHouse/ClickHouse/issues/11914)。[#11916](https://github.com/ClickHouse/ClickHouse/pull/11916)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了从默认存储策略切换时未发生数据迁移的错误。[#11893](https://github.com/ClickHouse/ClickHouse/pull/11893) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 修复了解析 `DateTime64` 时可能出现的浮点运算异常。修复了 [#11374](https://github.com/ClickHouse/ClickHouse/issues/11374)。[#11875](https://github.com/ClickHouse/ClickHouse/pull/11875)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了通过 HTTP 接口进行的内存统计（在 `wait_end_of_query=1` 时影响可能较大）。 [#11840](https://github.com/ClickHouse/ClickHouse/pull/11840) ([Azat Khuzhin](https://github.com/azat)).
* 在检查是否相等之前，先解析存储在 zookeeper 中的元数据。 [#11739](https://github.com/ClickHouse/ClickHouse/pull/11739) ([Azat Khuzhin](https://github.com/azat)).

#### 性能改进 {#performance-improvement-10}

- 修复了 IN 运算符使用字面量时未使用索引的问题,该性能退化在 v19.3 版本左右引入。此修复解决了 [#10574](https://github.com/ClickHouse/ClickHouse/issues/10574)。[#12062](https://github.com/ClickHouse/ClickHouse/pull/12062) ([nvartolomei](https://github.com/nvartolomei))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-12}

- 在 Dockerfile 中首次执行 `apt-get update` 之前安装 `ca-certificates`。[#12095](https://github.com/ClickHouse/ClickHouse/pull/12095) ([Ivan Blinkov](https://github.com/blinkov))。

### ClickHouse 版本 v20.4.6.53-stable 2020-06-25 {#clickhouse-release-v204653-stable-2020-06-25}

#### 错误修复 {#bug-fix-29}


* 修复在 `prewhere` 条件中使用 `Nullable` 列时导致的罕见崩溃问题。是对 [#11608](https://github.com/ClickHouse/ClickHouse/issues/11608) 的后续修复。[#11869](https://github.com/ClickHouse/ClickHouse/pull/11869)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 不允许在高阶函数中使用 arrayJoin。这样会导致协议同步出现问题。此更改关闭了 [#3933](https://github.com/ClickHouse/ClickHouse/issues/3933)。[#11846](https://github.com/ClickHouse/ClickHouse/pull/11846)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `FixedString` 与常量 `String` 比较结果错误的问题。此修复解决了 [#11393](https://github.com/ClickHouse/ClickHouse/issues/11393)。该缺陷首次出现在 20.4 版本中。[#11828](https://github.com/ClickHouse/ClickHouse/pull/11828)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在条件中包含 NULL 时 `if()` 返回错误结果的问题。[#11807](https://github.com/ClickHouse/ClickHouse/pull/11807) ([Artem Zuikov](https://github.com/4ertus2)).
* 修复查询使用线程数过多的问题。 [#11788](https://github.com/ClickHouse/ClickHouse/pull/11788) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复了类似 `SELECT *, xyz.*` 这类查询的异常行为，此前这类查询会被错误地执行成功，而本应返回错误。 [#11753](https://github.com/ClickHouse/ClickHouse/pull/11753) ([hexiaoting](https://github.com/hexiaoting)).
* 现在在执行元数据变更时，将会取消复制拉取操作。[#11744](https://github.com/ClickHouse/ClickHouse/pull/11744) ([alesapin](https://github.com/alesapin)).
* 修复了由于在 Values 输入格式中对复杂字面值进行错误类型推导而导致的 LOGICAL&#95;ERROR。 [#11732](https://github.com/ClickHouse/ClickHouse/pull/11732) ([tavplubix](https://github.com/tavplubix)).
* 修复在常量列上使用 `ORDER BY ... WITH FILL` 时的问题。 [#11697](https://github.com/ClickHouse/ClickHouse/pull/11697) ([Anton Popov](https://github.com/CurtizJ)).
* 在与 XDBC bridge 通信时传递正确的超时时间。此前在检查 bridge 存活性和接收元信息时未正确遵守超时时间。[#11690](https://github.com/ClickHouse/ClickHouse/pull/11690) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复在包含别名的 `ORDER BY` 子句中使用 `LIMIT n WITH TIES` 时的问题。 [#11689](https://github.com/ClickHouse/ClickHouse/pull/11689) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了导致 `system.mutations` 状态不正确的错误。该错误可能会导致其显示整个 mutation 已经完成，但服务器在复制队列中仍然存在 `MUTATE_PART` 任务并尝试执行它们。此修复解决了 [#11611](https://github.com/ClickHouse/ClickHouse/issues/11611)。[#11681](https://github.com/ClickHouse/ClickHouse/pull/11681)（[alesapin](https://github.com/alesapin)）。
* 为正则表达式添加对不区分大小写标志的支持。修复了 [#11101](https://github.com/ClickHouse/ClickHouse/issues/11101) 和 [#11506](https://github.com/ClickHouse/ClickHouse/issues/11506)。[#11649](https://github.com/ClickHouse/ClickHouse/pull/11649)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 如果启用了行级安全，则移除对简单 `count` 查询的优化。在先前的版本中，用户获得的是表中记录的总数，而不是过滤后的记录数。此更改修复了 [#11352](https://github.com/ClickHouse/ClickHouse/issues/11352)。[#11644](https://github.com/ClickHouse/ClickHouse/pull/11644)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复用于 `String` 的布隆过滤器（数据跳过索引）。 [#11638](https://github.com/ClickHouse/ClickHouse/pull/11638) ([Azat Khuzhin](https://github.com/azat)).
* 修复在 `prewhere` 条件中使用 `Nullable` 列时导致的罕见崩溃。（可能与 [#11572](https://github.com/ClickHouse/ClickHouse/issues/11572) 有关）。[#11608](https://github.com/ClickHouse/ClickHouse/pull/11608)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在从 `Buffer` 表进行采样读取的查询时出现的 `Block structure mismatch` 错误。[#11602](https://github.com/ClickHouse/ClickHouse/pull/11602) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复了在 `exception.code() % 256 = 0` 时 `clickhouse-client` 返回错误退出代码的问题。 [#11601](https://github.com/ClickHouse/ClickHouse/pull/11601) ([filimonov](https://github.com/filimonov)).
* 修复服务器启动时关于“Mark cache size was lowered”的日志消息中的一个小错误。此更改关闭了 [#11399](https://github.com/ClickHouse/ClickHouse/issues/11399)。[#11589](https://github.com/ClickHouse/ClickHouse/pull/11589)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在包含 `PREWHERE column in (subquery)` 和 `ARRAY JOIN` 的查询中出现的错误 `Size of offsets does not match size of column`。 [#11580](https://github.com/ClickHouse/ClickHouse/pull/11580) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了在 `SHOW CREATE TABLE` 中出现的罕见段错误。解决了 [#11490](https://github.com/ClickHouse/ClickHouse/issues/11490)。[#11579](https://github.com/ClickHouse/ClickHouse/pull/11579)（[tavplubix](https://github.com/tavplubix)）。
* HTTP 会话中的所有查询此前都使用相同的 `query_id`。现已修复。[#11578](https://github.com/ClickHouse/ClickHouse/pull/11578) ([tavplubix](https://github.com/tavplubix))。
* 现在，`clickhouse-server` Docker 容器在检查服务器存活状态时将优先使用 IPv6。 [#11550](https://github.com/ClickHouse/ClickHouse/pull/11550) ([Ivan Starkov](https://github.com/istarkov))。
* 修复 `<node>` 的 shard&#95;num/replica&#95;num（此前会导致 use&#95;compact&#95;format&#95;in&#95;distributed&#95;parts&#95;names 失效）。[#11528](https://github.com/ClickHouse/ClickHouse/pull/11528) ([Azat Khuzhin](https://github.com/azat))。
* 修复了在删除表时可能导致异常的竞争条件。这个问题有点棘手，但完全无害。如果你想了解详细解释，可以在 Telegram 上给我发消息。[#11523](https://github.com/ClickHouse/ClickHouse/pull/11523) ([alesapin](https://github.com/alesapin))。
* 修复在使用 `-State` 函数进行聚合时，如果在中途抛出异常会导致的内存泄漏问题。修复了 [#8995](https://github.com/ClickHouse/ClickHouse/issues/8995)。[#11496](https://github.com/ClickHouse/ClickHouse/pull/11496)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 如果 `data skipping index` 依赖于在后台合并过程中会被修改的列（适用于 `SummingMergeTree`、`AggregatingMergeTree` 以及 `TTL GROUP BY`），则其计算结果是不正确的。此问题已通过将索引计算移动到合并之后来修复，从而在合并后的数据上计算索引。[#11162](https://github.com/ClickHouse/ClickHouse/pull/11162) ([Azat Khuzhin](https://github.com/azat))。
* 移除旧的 libunwind 补丁。[https://github.com/ClickHouse-Extras/libunwind/commit/500aa227911bd185a94bfc071d68f4d3b03cb3b1#r39048012](https://github.com/ClickHouse-Extras/libunwind/commit/500aa227911bd185a94bfc071d68f4d3b03cb3b1#r39048012) 这使得可以在 `clang` 构建中禁用 `-fno-omit-frame-pointer`，从而平均至少提升 1% 的性能。[#10761](https://github.com/ClickHouse/ClickHouse/pull/10761)（[Amos Bird](https://github.com/amosbird)）。
* 修复在使用 &#39;FINAL&#39; 修饰符和 &#39;ORDER BY&#39; 优化时，将主键包裹在函数中的情况。[#10715](https://github.com/ClickHouse/ClickHouse/pull/10715) ([Anton Popov](https://github.com/CurtizJ))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-13}

- 修复单元测试中的几个非关键错误。[#11262](https://github.com/ClickHouse/ClickHouse/pull/11262) ([alesapin](https://github.com/alesapin)).
- 修复 MergeTreeIndexFullText 中的 MSan 误报。该问题首次出现在 [#9968](https://github.com/ClickHouse/ClickHouse/issues/9968)。[#10801](https://github.com/ClickHouse/ClickHouse/pull/10801) ([alexey-milovidov](https://github.com/alexey-milovidov)).

### ClickHouse 版本 v20.4.5.36-stable 2020-06-10 {#clickhouse-release-v204536-stable-2020-06-10}

#### Bug 修复 {#bug-fix-30}


* 修复在启用 `min_bytes_to_use_direct_io` 且 PREWHERE 处于活动状态，并使用 SAMPLE 或较多线程时可能出现的错误 `Data compressed with different methods`。此修复解决了 [#11539](https://github.com/ClickHouse/ClickHouse/issues/11539)。[#11540](https://github.com/ClickHouse/ClickHouse/pull/11540)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复编解码器返回的压缩大小。[#11448](https://github.com/ClickHouse/ClickHouse/pull/11448) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复当列的压缩 `codec` 使用非字面量参数时导致的服务器崩溃问题。修复了 [#11365](https://github.com/ClickHouse/ClickHouse/issues/11365)。[#11431](https://github.com/ClickHouse/ClickHouse/pull/11431)（[alesapin](https://github.com/alesapin)）。
* 修复点为 `nan` 时的 `pointInPolygon` 行为。修复了 [#11375](https://github.com/ClickHouse/ClickHouse/issues/11375)。[#11421](https://github.com/ClickHouse/ClickHouse/pull/11421)（[Alexey Ilyukhov](https://github.com/livace)）。
* 修复在表未成功创建时，MergeTree 关闭过程中可能发生的未初始化内存读取问题。[#11420](https://github.com/ClickHouse/ClickHouse/pull/11420) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了在参数超出纬度/经度范围时的 `geohashesInBox` 行为。 [#11403](https://github.com/ClickHouse/ClickHouse/pull/11403) ([Vasily Nemkov](https://github.com/Enmk)).
* 修复在带有外部排序和 limit 的查询中可能出现的 `Pipeline stuck` 错误。修复了 [#11359](https://github.com/ClickHouse/ClickHouse/issues/11359)。[#11366](https://github.com/ClickHouse/ClickHouse/pull/11366)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 删除 ReplicatedMergeTree 在发送数据片时使用的多余锁。[#11354](https://github.com/ClickHouse/ClickHouse/pull/11354) ([alesapin](https://github.com/alesapin))。
* 修复了在多行模式下 `clickhouse-client` 中对 `\G`（垂直输出）的支持。此变更关闭了 [#9933](https://github.com/ClickHouse/ClickHouse/issues/9933)。[#11350](https://github.com/ClickHouse/ClickHouse/pull/11350)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在使用 `Lazy` 数据库时可能发生的段错误。[#11348](https://github.com/ClickHouse/ClickHouse/pull/11348) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复 `quantilesExactWeightedArray` 中的崩溃。 [#11337](https://github.com/ClickHouse/ClickHouse/pull/11337) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 现在在执行 `ALTER` 查询时，会先停止合并操作，然后再修改元数据。 [#11335](https://github.com/ClickHouse/ClickHouse/pull/11335) ([alesapin](https://github.com/alesapin)).
* 在设置 `parallel_view_processing = 1` 的情况下，使对 `MATERIALIZED VIEW` 的写入重新支持并行处理。修复了 [#10241](https://github.com/ClickHouse/ClickHouse/issues/10241)。[#11330](https://github.com/ClickHouse/ClickHouse/pull/11330)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复当提取的 JSON 中包含带有不成对 &#123; 或 [ 的字符串时，`visitParamExtractRaw` 的行为。[#11318](https://github.com/ClickHouse/ClickHouse/pull/11318) ([Ewout](https://github.com/devwout)).
* 修复 `ThreadPool` 中极少出现的竞态条件。 [#11314](https://github.com/ClickHouse/ClickHouse/pull/11314) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复了 `clickhouse-copier` 中一个影响不大的数据竞争问题，由集成测试发现。[#11313](https://github.com/ClickHouse/ClickHouse/pull/11313) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复转换过程中可能使用未初始化内存的问题。例如：`SELECT toIntervalSecond(now64())`。 [#11311](https://github.com/ClickHouse/ClickHouse/pull/11311) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复以下问题：当表的主键中包含 `Array` 列，并且查询使用 `empty` 或 `notEmpty` 函数按该列进行过滤时，索引分析无法生效。此修复对应 [#11286](https://github.com/ClickHouse/ClickHouse/issues/11286)。[#11303](https://github.com/ClickHouse/ClickHouse/pull/11303)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了一个错误：当查询被 `max_network_bandwidth`、`max_execution_speed` 或 `priority` 设置限速时，查询速度估算可能不正确，从而导致 `min_execution_speed` 的限制不起作用或行为异常。将 `timeout_before_checking_execution_speed` 的默认值更改为非零值，否则 `min_execution_speed` 和 `max_execution_speed` 设置不会生效。此更改修复了 [#11297](https://github.com/ClickHouse/ClickHouse/issues/11297)。此更改修复了 [#5732](https://github.com/ClickHouse/ClickHouse/issues/5732)。此更改修复了 [#6228](https://github.com/ClickHouse/ClickHouse/issues/6228)。易用性改进：在 `clickhouse-client` 中避免将异常消息与进度条拼接显示。[#11296](https://github.com/ClickHouse/ClickHouse/pull/11296)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在以错误参数调用 `SET DEFAULT ROLE` 时发生的崩溃。此更改修复了 [#10586](https://github.com/ClickHouse/ClickHouse/issues/10586)。[#11278](https://github.com/ClickHouse/ClickHouse/pull/11278)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复读取格式异常的 Protobuf 数据时发生的崩溃。修复了 [#5957](https://github.com/ClickHouse/ClickHouse/issues/5957)，修复了 [#11203](https://github.com/ClickHouse/ClickHouse/issues/11203)。[#11258](https://github.com/ClickHouse/ClickHouse/pull/11258)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复了一个错误：在仅存在已过期键时，`cache-dictionary` 可能返回默认值而不是正确的值。该问题仅影响字符串字段。 [#11233](https://github.com/ClickHouse/ClickHouse/pull/11233) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 修复了在从内部查询中包含常量的 `VIEW` 读取时出现的错误 `Block structure mismatch in QueryPipeline`。修复了 [#11181](https://github.com/ClickHouse/ClickHouse/issues/11181)。[#11205](https://github.com/ClickHouse/ClickHouse/pull/11205)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复可能出现的异常 `Invalid status for associated output`。 [#11200](https://github.com/ClickHouse/ClickHouse/pull/11200) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复在高阶函数中，当被捕获参数为 `Array(Array(LowCardinality))` 时可能出现的错误 `Cannot capture column`。[#11185](https://github.com/ClickHouse/ClickHouse/pull/11185) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复了 S3 通配符匹配（globbing）的问题：在键数量超过 1000 且使用某些后端时可能会失败。[#11179](https://github.com/ClickHouse/ClickHouse/pull/11179) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 如果 data skipping 索引依赖于在后台合并过程中会被修改的列（对于 `SummingMergeTree`、`AggregatingMergeTree` 以及 `TTL GROUP BY`），则其计算结果会不正确。该问题已通过将索引计算移动到合并之后来修复，因此索引会基于合并后的数据进行计算。 [#11162](https://github.com/ClickHouse/ClickHouse/pull/11162) ([Azat Khuzhin](https://github.com/azat))。
* 修复与基于限制的重新调度有关的 Kafka 性能问题，此前这些限制会被始终应用。 [#11149](https://github.com/ClickHouse/ClickHouse/pull/11149) ([filimonov](https://github.com/filimonov))。
* 修复了在执行 `DROP` Kafka 表引擎的表（或在服务器重启期间）时偶尔发生的挂起问题。 [#11145](https://github.com/ClickHouse/ClickHouse/pull/11145) ([filimonov](https://github.com/filimonov))。
* 修复简单查询中过度保留线程的问题（用于减少线程数量的优化在流水线变更后部分失效）。 [#11114](https://github.com/ClickHouse/ClickHouse/pull/11114) ([Azat Khuzhin](https://github.com/azat)).
* 修复在分布式查询中（`enable_optimize_predicate_expression=1`）针对包含 `HAVING` 子句的查询（即需要在发起查询的服务器上进行过滤的情况）的谓词优化：通过保留表达式的顺序（这就足以修复该问题），并且强制聚合器优先使用列名而非索引。修复问题：[#10613](https://github.com/ClickHouse/ClickHouse/issues/10613)、[#11413](https://github.com/ClickHouse/ClickHouse/issues/11413)。[#10621](https://github.com/ClickHouse/ClickHouse/pull/10621)（[Azat Khuzhin](https://github.com/azat)）。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-14}

- 修复了多个不稳定的集成测试。[#11355](https://github.com/ClickHouse/ClickHouse/pull/11355) ([alesapin](https://github.com/alesapin))。

### ClickHouse 版本 v20.4.4.18-stable 2020-05-26 {#clickhouse-release-v204418-stable-2020-05-26}

与 v20.4.3.16-stable 版本相比无变化。

### ClickHouse 版本 v20.4.3.16-stable 2020-05-23 {#clickhouse-release-v204316-stable-2020-05-23}

#### 问题修复 {#bug-fix-31}


* 如果没有任何内容被最终确定，则不再在变更最终化任务中记录日志。[#11109](https://github.com/ClickHouse/ClickHouse/pull/11109) ([alesapin](https://github.com/alesapin))。
* 修复了 `registerDiskS3` 中的内存泄漏。[#11074](https://github.com/ClickHouse/ClickHouse/pull/11074) ([Pavel Kovalenko](https://github.com/Jokser))。
* 修复了在终止 Kafka 引擎表时可能出现的数据遗漏问题。 [#11048](https://github.com/ClickHouse/ClickHouse/pull/11048) ([filimonov](https://github.com/filimonov)).
* 修复了 `parseDateTime64BestEffort` 参数解析相关的缺陷。[#11038](https://github.com/ClickHouse/ClickHouse/pull/11038) ([Vasily Nemkov](https://github.com/Enmk)).
* 修复了在表未成功创建时，`MergeTree` 中一种极其罕见的潜在 use-after-free 错误。[#10986](https://github.com/ClickHouse/ClickHouse/pull/10986), [#10970](https://github.com/ClickHouse/ClickHouse/pull/10970) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复了 Atomic 数据库中元数据（重命名的相对路径）和数据（符号链接的相对路径）的处理。[#10980](https://github.com/ClickHouse/ClickHouse/pull/10980) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在使用 `Atomic` 数据库引擎时并发执行 `ALTER` 和 `DROP DATABASE` 查询会导致服务器崩溃的问题。 [#10968](https://github.com/ClickHouse/ClickHouse/pull/10968) ([tavplubix](https://github.com/tavplubix)).
* 修复了 `getRawData()` 方法中原始数据大小不正确的问题。 [#10964](https://github.com/ClickHouse/ClickHouse/pull/10964) ([Igr](https://github.com/ObjatieGroba))。
* 修复了 20.1 与更早版本之间两级聚合的不兼容问题。当在发起节点和远程节点上使用不同版本的 ClickHouse，且 `GROUP BY` 结果集较大并且聚合是基于单个 `String` 字段执行时，就会出现这种不兼容性。这会导致结果中针对同一个键出现多行未被合并的数据。 [#10952](https://github.com/ClickHouse/ClickHouse/pull/10952) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复了 `DistributedBlockOutputStream` 发送部分写入文件的问题。 [#10940](https://github.com/ClickHouse/ClickHouse/pull/10940) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在执行 `SELECT count(notNullIn(NULL, []))` 时出现的崩溃问题。[#10920](https://github.com/ClickHouse/ClickHouse/pull/10920) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复了在对 `Kafka` 表引擎执行 `DROP` 操作（或在服务器重启期间）时偶尔出现的卡死问题。 [#10910](https://github.com/ClickHouse/ClickHouse/pull/10910) ([filimonov](https://github.com/filimonov))。
* 修复了无法执行多个类似 `a TO b, c TO a` 的 `ALTER RENAME` 语句的问题。 [#10895](https://github.com/ClickHouse/ClickHouse/pull/10895) ([alesapin](https://github.com/alesapin)).
* 修复了一个可能出现的数据竞争问题：当在同一列上，从多个线程获取聚合函数状态的结果时，可能会触发该问题。它只会在以下情况下发生：在读取使用 `Memory` 引擎的表时使用 `finalizeAggregation` 函数，而该表为 `quantile*` 函数存储了 `AggregateFunction` 状态。[#10890](https://github.com/ClickHouse/ClickHouse/pull/10890) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了 `Distributed` 表中元组的向后兼容问题。 [#10889](https://github.com/ClickHouse/ClickHouse/pull/10889) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了在 `StringHashTable` 中访问不存在的此类键时产生的 `SIGSEGV`。[#10870](https://github.com/ClickHouse/ClickHouse/pull/10870) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在使用 `Atomic` 引擎的数据库中删除 `LiveView` 表后，`WATCH` 命令发生挂起的问题。 [#10859](https://github.com/ClickHouse/ClickHouse/pull/10859) ([tavplubix](https://github.com/tavplubix)).
* 修复了 `ReplicatedMergeTree` 中的一个错误，该错误可能导致在某个副本变为非活跃状态后，针对 `OPTIMIZE` 查询执行的某些 `ALTER` 操作挂起并一直等待该副本。[#10849](https://github.com/ClickHouse/ClickHouse/pull/10849) ([tavplubix](https://github.com/tavplubix))。
* 现在，如果参与 `CONSTRAINT` 表达式的列被重命名，相应的约束也会被更新。修复了 [#10844](https://github.com/ClickHouse/ClickHouse/issues/10844)。[#10847](https://github.com/ClickHouse/ClickHouse/pull/10847)（[alesapin](https://github.com/alesapin)）。
* 修复了在 `cache-dictionary` 中可能读取未初始化内存的潜在问题。 [#10834](https://github.com/ClickHouse/ClickHouse/pull/10834) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 在调用 `Block::sortColumns()` 后修正了列的顺序。[#10826](https://github.com/ClickHouse/ClickHouse/pull/10826) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在未请求对标识符加引号时 `ODBC` bridge 的问题。修复了 [#7984](https://github.com/ClickHouse/ClickHouse/issues/7984)。[#10821](https://github.com/ClickHouse/ClickHouse/pull/10821)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了 `DateLUT` 中的 `UBSan` 和 `MSan` 报告。 [#10798](https://github.com/ClickHouse/ClickHouse/pull/10798) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复了键条件中的错误类型转换。修复了 [#6287](https://github.com/ClickHouse/ClickHouse/issues/6287)。[#10791](https://github.com/ClickHouse/ClickHouse/pull/10791)（[Andrew Onyshchuk](https://github.com/oandrew)）。
* 修复了 `parallel_view_processing` 的行为。现在，如果发生异常，所有对 `MATERIALIZED VIEW` 的插入也应无一例外地完成。修复了 [#10241](https://github.com/ClickHouse/ClickHouse/issues/10241)。[#10757](https://github.com/ClickHouse/ClickHouse/pull/10757)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在与 `-State` 组合使用时的组合器 `-OrNull` 和 `-OrDefault`。 [#10741](https://github.com/ClickHouse/ClickHouse/pull/10741) ([hcz](https://github.com/hczhcz)).
* 修复了函数 `h3EdgeAngle` 中可能发生的缓冲区溢出问题。[#10711](https://github.com/ClickHouse/ClickHouse/pull/10711) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复了在表包含大量数据分片时会阻塞并发 `ALTER` 的错误。 [#10659](https://github.com/ClickHouse/ClickHouse/pull/10659) ([alesapin](https://github.com/alesapin)).
* 修复了在服务器于表启动前关闭时，`StorageBuffer` 中发生的 `nullptr` 解引用问题。[#10641](https://github.com/ClickHouse/ClickHouse/pull/10641) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了 `optimize_skip_unused_shards` 与 `LowCardinality` 一起使用时的问题。 [#10611](https://github.com/ClickHouse/ClickHouse/pull/10611) ([Azat Khuzhin](https://github.com/azat)).
* 修复了同步变更操作中对条件变量的处理。在某些情况下，发往该条件变量的信号可能会丢失。[#10588](https://github.com/ClickHouse/ClickHouse/pull/10588) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 修复了在 `loadStoredObject()` 尚未完成时调用 `createDictionary()` 可能导致的崩溃问题。 [#10587](https://github.com/ClickHouse/ClickHouse/pull/10587) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复了在 `ALIAS` 列的默认表达式类型与列类型不同时执行 `SELECT` 的问题。 [#10563](https://github.com/ClickHouse/ClickHouse/pull/10563) ([Azat Khuzhin](https://github.com/azat)).
* 实现了 `DateTime64` 与 `String` 类型值之间的比较功能。 [#10560](https://github.com/ClickHouse/ClickHouse/pull/10560) ([Vasily Nemkov](https://github.com/Enmk)).
* 默认禁用 `GROUP BY` 分片键优化（`optimize_distributed_group_by_sharding_key` 已被引入并默认关闭，这是由于分片键分析较为复杂，一个简单的例子是在分片键中使用 `if`），并修复其在 `WITH ROLLUP/CUBE/TOTALS` 中的行为。[#10516](https://github.com/ClickHouse/ClickHouse/pull/10516) ([Azat Khuzhin](https://github.com/azat))。
* 修复了 [#10263](https://github.com/ClickHouse/ClickHouse/issues/10263)。 [#10486](https://github.com/ClickHouse/ClickHouse/pull/10486)（[Azat Khuzhin](https://github.com/azat)）。
* 增加了关于 `max_rows_to_sort` 设置的测试。[#10268](https://github.com/ClickHouse/ClickHouse/pull/10268) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 为创建 Bloom filter 索引添加了向后兼容性。[#10551](https://github.com/ClickHouse/ClickHouse/issues/10551)。[#10569](https://github.com/ClickHouse/ClickHouse/pull/10569)（[Winter Zhang](https://github.com/zhang2014)）。

### ClickHouse release v20.4.2.9, 2020-05-12 {#clickhouse-release-v20429-2020-05-12}

#### 向后不兼容的变更 {#backward-incompatible-change-8}

- 系统表(例如 system.query_log、system.trace_log、system.metric_log)对小于 10 MiB 的数据部分使用紧凑数据部分格式。紧凑数据部分格式从 20.3 版本开始支持。如果您要降级到低于 20.3 的版本,应手动删除 `/var/lib/clickhouse/data/system/` 中系统日志的表数据。
- 当字符串比较涉及 FixedString 且比较的参数大小不同时,执行比较时会将较小的字符串填充到较大字符串的长度。如果我们将 FixedString 数据类型对应于 SQL CHAR,这是为了实现 SQL 兼容性。此变更关闭了 [#9272](https://github.com/ClickHouse/ClickHouse/issues/9272)。[#10363](https://github.com/ClickHouse/ClickHouse/pull/10363) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 使 SHOW CREATE TABLE 多行显示。现在更具可读性,更类似于 MySQL。[#10049](https://github.com/ClickHouse/ClickHouse/pull/10049) ([Azat Khuzhin](https://github.com/azat))
- 添加了设置 `validate_polygons`,用于 `pointInPolygon` 函数,默认启用。[#9857](https://github.com/ClickHouse/ClickHouse/pull/9857) ([alexey-milovidov](https://github.com/alexey-milovidov))


#### 新功能 {#new-feature-8}

- 添加从 ClickHouse 到 Zookeeper 的安全连接支持 [#10184](https://github.com/ClickHouse/ClickHouse/pull/10184) ([Konstantin Lebedev](https://github.com/xzkostyan))
- 支持自定义 HTTP 处理器。详见 [#5436](https://github.com/ClickHouse/ClickHouse/issues/5436) 了解说明。[#7572](https://github.com/ClickHouse/ClickHouse/pull/7572) ([Winter Zhang](https://github.com/zhang2014))
- 添加 MessagePack 输入/输出格式。[#9889](https://github.com/ClickHouse/ClickHouse/pull/9889) ([Kruglov Pavel](https://github.com/Avogar))
- 添加 Regexp 输入格式。[#9196](https://github.com/ClickHouse/ClickHouse/pull/9196) ([Kruglov Pavel](https://github.com/Avogar))
- 添加 `Markdown` 输出格式,用于在 Markdown 文档中嵌入表格。[#10317](https://github.com/ClickHouse/ClickHouse/pull/10317) ([Kruglov Pavel](https://github.com/Avogar))
- 添加对字典中自定义设置部分的支持。同时修复了问题 [#2829](https://github.com/ClickHouse/ClickHouse/issues/2829)。[#10137](https://github.com/ClickHouse/ClickHouse/pull/10137) ([Artem Streltsov](https://github.com/kekekekule))
- 在 `CREATE DICTIONARY` 的 DDL 查询中添加自定义设置支持 [#10465](https://github.com/ClickHouse/ClickHouse/pull/10465) ([Artem Streltsov](https://github.com/kekekekule))
- 添加简单的服务器级内存分析器,当服务器内存使用量超过下一个分配阈值时收集分配上下文。[#10444](https://github.com/ClickHouse/ClickHouse/pull/10444) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 添加 `always_fetch_merged_part` 设置,限制副本自行合并数据分片,始终优先从其他副本下载。[#10379](https://github.com/ClickHouse/ClickHouse/pull/10379) ([alesapin](https://github.com/alesapin))
- 添加 `JSONExtractKeysAndValuesRaw` 函数,从 JSON 对象中提取原始数据 [#10378](https://github.com/ClickHouse/ClickHouse/pull/10378) ([hcz](https://github.com/hczhcz))
- 将操作系统的内存使用情况添加到 `system.asynchronous_metrics`。[#10361](https://github.com/ClickHouse/ClickHouse/pull/10361) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 为 `least` 和 `greatest` 函数添加通用变体。现在它们可以处理任意数量的任意类型参数。这修复了 [#4767](https://github.com/ClickHouse/ClickHouse/issues/4767) [#10318](https://github.com/ClickHouse/ClickHouse/pull/10318) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 现在 ClickHouse 在其端控制字典源的超时。缓存字典配置中添加了两个新设置:`strict_max_lifetime_seconds`(默认为 `max_lifetime`)和 `query_wait_timeout_milliseconds`(默认为一分钟)。第一个设置与 `allow_read_expired_keys` 设置配合使用也很有用(用于禁止读取已严重过期的键)。[#10337](https://github.com/ClickHouse/ClickHouse/pull/10337) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- 添加 log_queries_min_type 以过滤将写入 query_log 的条目 [#10053](https://github.com/ClickHouse/ClickHouse/pull/10053) ([Azat Khuzhin](https://github.com/azat))
- 添加 `isConstant` 函数。该函数检查其参数是否为常量表达式,并返回 1 或 0。它用于开发、调试和演示目的。[#10198](https://github.com/ClickHouse/ClickHouse/pull/10198) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 添加 joinGetOrNull,当键缺失时返回 NULL 而不是返回默认值。[#10094](https://github.com/ClickHouse/ClickHouse/pull/10094) ([Amos Bird](https://github.com/amosbird))
- 如果设置了 `transform_null_in` 选项,则在 `IN` 运算符中将 `NULL` 视为等于 `NULL`。[#10085](https://github.com/ClickHouse/ClickHouse/pull/10085) ([achimbab](https://github.com/achimbab))
- 为 MergeTree 表引擎系列添加 `ALTER TABLE ... RENAME COLUMN`。[#9948](https://github.com/ClickHouse/ClickHouse/pull/9948) ([alesapin](https://github.com/alesapin))
- 支持并行分布式 INSERT SELECT。[#9759](https://github.com/ClickHouse/ClickHouse/pull/9759) ([vxider](https://github.com/Vxider))
- 添加查询 Distributed over Distributed 的能力(不使用 `distributed_group_by_no_merge`)... [#9923](https://github.com/ClickHouse/ClickHouse/pull/9923) ([Azat Khuzhin](https://github.com/azat))
- 添加 `arrayReduceInRanges` 函数,在给定范围内聚合数组元素。[#9598](https://github.com/ClickHouse/ClickHouse/pull/9598) ([hcz](https://github.com/hczhcz))
- 在 Prometheus 导出器上添加字典状态。[#9622](https://github.com/ClickHouse/ClickHouse/pull/9622) ([Guillaume Tassery](https://github.com/YiuRULE))
- 添加 `arrayAUC` 函数 [#8698](https://github.com/ClickHouse/ClickHouse/pull/8698) ([taiyang-li](https://github.com/taiyang-li))
- 支持 `DROP VIEW` 语句以提高 TPC-H 兼容性。[#9831](https://github.com/ClickHouse/ClickHouse/pull/9831) ([Amos Bird](https://github.com/amosbird))
- 为 windowFunnel() 添加 'strict_order' 选项 [#9773](https://github.com/ClickHouse/ClickHouse/pull/9773) ([achimbab](https://github.com/achimbab))
- 支持 `DATE` 和 `TIMESTAMP` SQL 运算符,例如 `SELECT date '2001-01-01'` [#9691](https://github.com/ClickHouse/ClickHouse/pull/9691) ([Artem Zuikov](https://github.com/4ertus2))

#### 实验性功能 {#experimental-feature-6}

- 新增实验性数据库引擎 Atomic。支持非阻塞的 `DROP` 和 `RENAME TABLE` 查询,以及原子性的 `EXCHANGE TABLES t1 AND t2` 查询 [#7512](https://github.com/ClickHouse/ClickHouse/pull/7512) ([tavplubix](https://github.com/tavplubix))
- 初步支持基于 S3 的 ReplicatedMergeTree(目前以次优方式运行) [#10126](https://github.com/ClickHouse/ClickHouse/pull/10126) ([Pavel Kovalenko](https://github.com/Jokser))


#### 错误修复 {#bug-fix-32}

- Fixed incorrect scalar results inside inner query of `MATERIALIZED VIEW` in case if this query contained dependent table [#10603](https://github.com/ClickHouse/ClickHouse/pull/10603) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed bug, which caused HTTP requests to get stuck on client closing connection when `readonly=2` and `cancel_http_readonly_queries_on_client_close=1`. [#10684](https://github.com/ClickHouse/ClickHouse/pull/10684) ([tavplubix](https://github.com/tavplubix))
- Fix segfault in StorageBuffer when exception is thrown on server startup. Fixes [#10550](https://github.com/ClickHouse/ClickHouse/issues/10550) [#10609](https://github.com/ClickHouse/ClickHouse/pull/10609) ([tavplubix](https://github.com/tavplubix))
- The query`SYSTEM DROP DNS CACHE` now also drops caches used to check if user is allowed to connect from some IP addresses [#10608](https://github.com/ClickHouse/ClickHouse/pull/10608) ([tavplubix](https://github.com/tavplubix))
- Fix usage of multiple `IN` operators with an identical set in one query. Fixes [#10539](https://github.com/ClickHouse/ClickHouse/issues/10539) [#10686](https://github.com/ClickHouse/ClickHouse/pull/10686) ([Anton Popov](https://github.com/CurtizJ))
- Fix crash in `generateRandom` with nested types. Fixes [#10583](https://github.com/ClickHouse/ClickHouse/issues/10583). [#10734](https://github.com/ClickHouse/ClickHouse/pull/10734) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix data corruption for `LowCardinality(FixedString)` key column in `SummingMergeTree` which could have happened after merge. Fixes [#10489](https://github.com/ClickHouse/ClickHouse/issues/10489). [#10721](https://github.com/ClickHouse/ClickHouse/pull/10721) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix logic for aggregation_memory_efficient_merge_threads setting. [#10667](https://github.com/ClickHouse/ClickHouse/pull/10667) ([palasonic1](https://github.com/palasonic1))
- Fix disappearing totals. Totals could have being filtered if query had `JOIN` or subquery with external `WHERE` condition. Fixes [#10674](https://github.com/ClickHouse/ClickHouse/issues/10674) [#10698](https://github.com/ClickHouse/ClickHouse/pull/10698) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix the lack of parallel execution of remote queries with `distributed_aggregation_memory_efficient` enabled. Fixes [#10655](https://github.com/ClickHouse/ClickHouse/issues/10655) [#10664](https://github.com/ClickHouse/ClickHouse/pull/10664) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix possible incorrect number of rows for queries with `LIMIT`. Fixes [#10566](https://github.com/ClickHouse/ClickHouse/issues/10566), [#10709](https://github.com/ClickHouse/ClickHouse/issues/10709) [#10660](https://github.com/ClickHouse/ClickHouse/pull/10660) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix index corruption, which may occur in some cases after merging compact parts into another compact part. [#10531](https://github.com/ClickHouse/ClickHouse/pull/10531) ([Anton Popov](https://github.com/CurtizJ))
- Fix the situation, when mutation finished all parts, but hung up in `is_done=0`. [#10526](https://github.com/ClickHouse/ClickHouse/pull/10526) ([alesapin](https://github.com/alesapin))
- Fix overflow at beginning of unix epoch for timezones with fractional offset from UTC. Fixes [#9335](https://github.com/ClickHouse/ClickHouse/issues/9335). [#10513](https://github.com/ClickHouse/ClickHouse/pull/10513) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Better diagnostics for input formats. Fixes [#10204](https://github.com/ClickHouse/ClickHouse/issues/10204) [#10418](https://github.com/ClickHouse/ClickHouse/pull/10418) ([tavplubix](https://github.com/tavplubix))
- Fix numeric overflow in `simpleLinearRegression()` over large integers [#10474](https://github.com/ClickHouse/ClickHouse/pull/10474) ([hcz](https://github.com/hczhcz))
- Fix use-after-free in Distributed shutdown, avoid waiting for sending all batches [#10491](https://github.com/ClickHouse/ClickHouse/pull/10491) ([Azat Khuzhin](https://github.com/azat))
- Add CA certificates to clickhouse-server docker image [#10476](https://github.com/ClickHouse/ClickHouse/pull/10476) ([filimonov](https://github.com/filimonov))
- Fix a rare endless loop that might have occurred when using the `addressToLine` function or AggregateFunctionState columns. [#10466](https://github.com/ClickHouse/ClickHouse/pull/10466) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Handle zookeeper "no node error" during distributed query [#10050](https://github.com/ClickHouse/ClickHouse/pull/10050) ([Daniel Chen](https://github.com/Phantomape))
- Fix bug when server cannot attach table after column's default was altered. [#10441](https://github.com/ClickHouse/ClickHouse/pull/10441) ([alesapin](https://github.com/alesapin))
- Implicitly cast the default expression type to the column type for the ALIAS columns [#10563](https://github.com/ClickHouse/ClickHouse/pull/10563) ([Azat Khuzhin](https://github.com/azat))
- Don't remove metadata directory if `ATTACH DATABASE` fails [#10442](https://github.com/ClickHouse/ClickHouse/pull/10442) ([Winter Zhang](https://github.com/zhang2014))
- Avoid dependency on system tzdata. Fixes loading of `Africa/Casablanca` timezone on CentOS 8. Fixes [#10211](https://github.com/ClickHouse/ClickHouse/issues/10211) [#10425](https://github.com/ClickHouse/ClickHouse/pull/10425) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix some issues if data is inserted with quorum and then gets deleted (DROP PARTITION, TTL, etc.). It led to stuck of INSERTs or false-positive exceptions in SELECTs. Fixes [#9946](https://github.com/ClickHouse/ClickHouse/issues/9946) [#10188](https://github.com/ClickHouse/ClickHouse/pull/10188) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Check the number and type of arguments when creating BloomFilter index [#9623](https://github.com/ClickHouse/ClickHouse/issues/9623) [#10431](https://github.com/ClickHouse/ClickHouse/pull/10431) ([Winter Zhang](https://github.com/zhang2014))
- Prefer `fallback_to_stale_replicas` over `skip_unavailable_shards`, otherwise when both settings specified and there are no up-to-date replicas the query will fail (patch from @alex-zaitsev ) [#10422](https://github.com/ClickHouse/ClickHouse/pull/10422) ([Azat Khuzhin](https://github.com/azat))
- Fix the issue when a query with ARRAY JOIN, ORDER BY and LIMIT may return incomplete result. Fixes [#10226](https://github.com/ClickHouse/ClickHouse/issues/10226). [#10427](https://github.com/ClickHouse/ClickHouse/pull/10427) ([Vadim Plakhtinskiy](https://github.com/VadimPlh))
- Add database name to dictionary name after DETACH/ATTACH. Fixes system.dictionaries table and `SYSTEM RELOAD` query [#10415](https://github.com/ClickHouse/ClickHouse/pull/10415) ([Azat Khuzhin](https://github.com/azat))
- Fix possible incorrect result for extremes in processors pipeline. [#10131](https://github.com/ClickHouse/ClickHouse/pull/10131) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix possible segfault when the setting `distributed_group_by_no_merge` is enabled (introduced in 20.3.7.46 by [#10131](https://github.com/ClickHouse/ClickHouse/issues/10131)). [#10399](https://github.com/ClickHouse/ClickHouse/pull/10399) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix wrong flattening of `Array(Tuple(...))` data types. Fixes [#10259](https://github.com/ClickHouse/ClickHouse/issues/10259) [#10390](https://github.com/ClickHouse/ClickHouse/pull/10390) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix column names of constants inside JOIN that may clash with names of constants outside of JOIN [#9950](https://github.com/ClickHouse/ClickHouse/pull/9950) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Fix order of columns after Block::sortColumns() [#10826](https://github.com/ClickHouse/ClickHouse/pull/10826) ([Azat Khuzhin](https://github.com/azat))
- Fix possible `Pipeline stuck` error in `ConcatProcessor` which may happen in remote query. [#10381](https://github.com/ClickHouse/ClickHouse/pull/10381) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Don't make disk reservations for aggregations. Fixes [#9241](https://github.com/ClickHouse/ClickHouse/issues/9241) [#10375](https://github.com/ClickHouse/ClickHouse/pull/10375) ([Azat Khuzhin](https://github.com/azat))
- Fix wrong behaviour of datetime functions for timezones that has altered between positive and negative offsets from UTC (e.g. Pacific/Kiritimati). Fixes [#7202](https://github.com/ClickHouse/ClickHouse/issues/7202) [#10369](https://github.com/ClickHouse/ClickHouse/pull/10369) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Avoid infinite loop in `dictIsIn` function. Fixes #515 [#10365](https://github.com/ClickHouse/ClickHouse/pull/10365) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Disable GROUP BY sharding_key optimization by default and fix it for WITH ROLLUP/CUBE/TOTALS [#10516](https://github.com/ClickHouse/ClickHouse/pull/10516) ([Azat Khuzhin](https://github.com/azat))
- Check for error code when checking parts and don't mark part as broken if the error is like "not enough memory". Fixes [#6269](https://github.com/ClickHouse/ClickHouse/issues/6269) [#10364](https://github.com/ClickHouse/ClickHouse/pull/10364) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Show information about not loaded dictionaries in system tables. [#10234](https://github.com/ClickHouse/ClickHouse/pull/10234) ([Vitaly Baranov](https://github.com/vitlibar))
- Fix nullptr dereference in StorageBuffer if server was shutdown before table startup. [#10641](https://github.com/ClickHouse/ClickHouse/pull/10641) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed `DROP` vs `OPTIMIZE` race in `ReplicatedMergeTree`. `DROP` could left some garbage in replica path in ZooKeeper if there was concurrent `OPTIMIZE` query. [#10312](https://github.com/ClickHouse/ClickHouse/pull/10312) ([tavplubix](https://github.com/tavplubix))
- Fix 'Logical error: CROSS JOIN has expressions' error for queries with comma and names joins mix. Fixes [#9910](https://github.com/ClickHouse/ClickHouse/issues/9910) [#10311](https://github.com/ClickHouse/ClickHouse/pull/10311) ([Artem Zuikov](https://github.com/4ertus2))
- Fix queries with `max_bytes_before_external_group_by`. [#10302](https://github.com/ClickHouse/ClickHouse/pull/10302) ([Artem Zuikov](https://github.com/4ertus2))
- Fix the issue with limiting maximum recursion depth in parser in certain cases. This fixes [#10283](https://github.com/ClickHouse/ClickHouse/issues/10283) This fix may introduce minor incompatibility: long and deep queries via clickhouse-client may refuse to work, and you should adjust settings `max_query_size` and `max_parser_depth` accordingly. [#10295](https://github.com/ClickHouse/ClickHouse/pull/10295) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Allow to use `count(*)` with multiple JOINs. Fixes [#9853](https://github.com/ClickHouse/ClickHouse/issues/9853) [#10291](https://github.com/ClickHouse/ClickHouse/pull/10291) ([Artem Zuikov](https://github.com/4ertus2))
- Fix error `Pipeline stuck` with `max_rows_to_group_by` and `group_by_overflow_mode = 'break'`. [#10279](https://github.com/ClickHouse/ClickHouse/pull/10279) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix 'Cannot add column' error while creating `range_hashed` dictionary using DDL query. Fixes [#10093](https://github.com/ClickHouse/ClickHouse/issues/10093). [#10235](https://github.com/ClickHouse/ClickHouse/pull/10235) ([alesapin](https://github.com/alesapin))
- Fix rare possible exception `Cannot drain connections: cancel first`. [#10239](https://github.com/ClickHouse/ClickHouse/pull/10239) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed bug where ClickHouse would throw "Unknown function lambda." error message when user tries to run ALTER UPDATE/DELETE on tables with ENGINE = Replicated\*. Check for nondeterministic functions now handles lambda expressions correctly. [#10237](https://github.com/ClickHouse/ClickHouse/pull/10237) ([Alexander Kazakov](https://github.com/Akazz))
- Fixed reasonably rare segfault in StorageSystemTables that happens when SELECT ... FROM system.tables is run on a database with Lazy engine. [#10209](https://github.com/ClickHouse/ClickHouse/pull/10209) ([Alexander Kazakov](https://github.com/Akazz))
- Fix possible infinite query execution when the query actually should stop on LIMIT, while reading from infinite source like `system.numbers` or `system.zeros`. [#10206](https://github.com/ClickHouse/ClickHouse/pull/10206) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed "generateRandom" function for Date type. This fixes [#9973](https://github.com/ClickHouse/ClickHouse/issues/9973). Fix an edge case when dates with year 2106 are inserted to MergeTree tables with old-style partitioning but partitions are named with year 1970. [#10218](https://github.com/ClickHouse/ClickHouse/pull/10218) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Convert types if the table definition of a View does not correspond to the SELECT query. This fixes [#10180](https://github.com/ClickHouse/ClickHouse/issues/10180) and [#10022](https://github.com/ClickHouse/ClickHouse/issues/10022) [#10217](https://github.com/ClickHouse/ClickHouse/pull/10217) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix `parseDateTimeBestEffort` for strings in RFC-2822 when day of week is Tuesday or Thursday. This fixes [#10082](https://github.com/ClickHouse/ClickHouse/issues/10082) [#10214](https://github.com/ClickHouse/ClickHouse/pull/10214) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix column names of constants inside JOIN that may clash with names of constants outside of JOIN. [#10207](https://github.com/ClickHouse/ClickHouse/pull/10207) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix move-to-prewhere optimization in presense of arrayJoin functions (in certain cases). This fixes [#10092](https://github.com/ClickHouse/ClickHouse/issues/10092) [#10195](https://github.com/ClickHouse/ClickHouse/pull/10195) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix issue with separator appearing in SCRAMBLE for native mysql-connector-java (JDBC) [#10140](https://github.com/ClickHouse/ClickHouse/pull/10140) ([BohuTANG](https://github.com/BohuTANG))
- Fix using the current database for an access checking when the database isn't specified. [#10192](https://github.com/ClickHouse/ClickHouse/pull/10192) ([Vitaly Baranov](https://github.com/vitlibar))
- Fix ALTER of tables with compact parts. [#10130](https://github.com/ClickHouse/ClickHouse/pull/10130) ([Anton Popov](https://github.com/CurtizJ))
- Add the ability to relax the restriction on non-deterministic functions usage in mutations with `allow_nondeterministic_mutations` setting. [#10186](https://github.com/ClickHouse/ClickHouse/pull/10186) ([filimonov](https://github.com/filimonov))
- Fix `DROP TABLE` invoked for dictionary [#10165](https://github.com/ClickHouse/ClickHouse/pull/10165) ([Azat Khuzhin](https://github.com/azat))
- Convert blocks if structure does not match when doing `INSERT` into Distributed table [#10135](https://github.com/ClickHouse/ClickHouse/pull/10135) ([Azat Khuzhin](https://github.com/azat))
- The number of rows was logged incorrectly (as sum across all parts) when inserted block is split by parts with partition key. [#10138](https://github.com/ClickHouse/ClickHouse/pull/10138) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add some arguments check and support identifier arguments for MySQL Database Engine [#10077](https://github.com/ClickHouse/ClickHouse/pull/10077) ([Winter Zhang](https://github.com/zhang2014))
- Fix incorrect `index_granularity_bytes` check while creating new replica. Fixes [#10098](https://github.com/ClickHouse/ClickHouse/issues/10098). [#10121](https://github.com/ClickHouse/ClickHouse/pull/10121) ([alesapin](https://github.com/alesapin))
- Fix bug in `CHECK TABLE` query when table contain skip indices. [#10068](https://github.com/ClickHouse/ClickHouse/pull/10068) ([alesapin](https://github.com/alesapin))
- Fix Distributed-over-Distributed with the only one shard in a nested table [#9997](https://github.com/ClickHouse/ClickHouse/pull/9997) ([Azat Khuzhin](https://github.com/azat))
- Fix possible rows loss for queries with `JOIN` and `UNION ALL`. Fixes [#9826](https://github.com/ClickHouse/ClickHouse/issues/9826), [#10113](https://github.com/ClickHouse/ClickHouse/issues/10113). ... [#10099](https://github.com/ClickHouse/ClickHouse/pull/10099) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix bug in dictionary when local clickhouse server is used as source. It may caused memory corruption if types in dictionary and source are not compatible. [#10071](https://github.com/ClickHouse/ClickHouse/pull/10071) ([alesapin](https://github.com/alesapin))
- Fixed replicated tables startup when updating from an old ClickHouse version where `/table/replicas/replica_name/metadata` node does not exist. Fixes [#10037](https://github.com/ClickHouse/ClickHouse/issues/10037). [#10095](https://github.com/ClickHouse/ClickHouse/pull/10095) ([alesapin](https://github.com/alesapin))
- Fix error `Cannot clone block with columns because block has 0 columns ... While executing GroupingAggregatedTransform`. It happened when setting `distributed_aggregation_memory_efficient` was enabled, and distributed query read aggregating data with mixed single and two-level aggregation from different shards. [#10063](https://github.com/ClickHouse/ClickHouse/pull/10063) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix deadlock when database with materialized view failed attach at start [#10054](https://github.com/ClickHouse/ClickHouse/pull/10054) ([Azat Khuzhin](https://github.com/azat))
- Fix a segmentation fault that could occur in GROUP BY over string keys containing trailing zero bytes ([#8636](https://github.com/ClickHouse/ClickHouse/issues/8636), [#8925](https://github.com/ClickHouse/ClickHouse/issues/8925)). ... [#10025](https://github.com/ClickHouse/ClickHouse/pull/10025) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Fix wrong results of distributed queries when alias could override qualified column name. Fixes [#9672](https://github.com/ClickHouse/ClickHouse/issues/9672) [#9714](https://github.com/ClickHouse/ClickHouse/issues/9714) [#9972](https://github.com/ClickHouse/ClickHouse/pull/9972) ([Artem Zuikov](https://github.com/4ertus2))
- Fix possible deadlock in `SYSTEM RESTART REPLICAS` [#9955](https://github.com/ClickHouse/ClickHouse/pull/9955) ([tavplubix](https://github.com/tavplubix))
- Fix the number of threads used for remote query execution (performance regression, since 20.3). This happened when query from `Distributed` table was executed simultaneously on local and remote shards. Fixes [#9965](https://github.com/ClickHouse/ClickHouse/issues/9965) [#9971](https://github.com/ClickHouse/ClickHouse/pull/9971) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed `DeleteOnDestroy` logic in `ATTACH PART` which could lead to automatic removal of attached part and added few tests [#9410](https://github.com/ClickHouse/ClickHouse/pull/9410) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix a bug with `ON CLUSTER` DDL queries freezing on server startup. [#9927](https://github.com/ClickHouse/ClickHouse/pull/9927) ([Gagan Arneja](https://github.com/garneja))
- Fix bug in which the necessary tables weren't retrieved at one of the processing stages of queries to some databases. Fixes [#9699](https://github.com/ClickHouse/ClickHouse/issues/9699). [#9949](https://github.com/ClickHouse/ClickHouse/pull/9949) ([achulkov2](https://github.com/achulkov2))
- Fix 'Not found column in block' error when `JOIN` appears with `TOTALS`. Fixes [#9839](https://github.com/ClickHouse/ClickHouse/issues/9839) [#9939](https://github.com/ClickHouse/ClickHouse/pull/9939) ([Artem Zuikov](https://github.com/4ertus2))
- Fix parsing multiple hosts set in the CREATE USER command [#9924](https://github.com/ClickHouse/ClickHouse/pull/9924) ([Vitaly Baranov](https://github.com/vitlibar))
- Fix `TRUNCATE` for Join table engine ([#9917](https://github.com/ClickHouse/ClickHouse/issues/9917)). [#9920](https://github.com/ClickHouse/ClickHouse/pull/9920) ([Amos Bird](https://github.com/amosbird))
- Fix race condition between drop and optimize in `ReplicatedMergeTree`. [#9901](https://github.com/ClickHouse/ClickHouse/pull/9901) ([alesapin](https://github.com/alesapin))
- Fix `DISTINCT` for Distributed when `optimize_skip_unused_shards` is set. [#9808](https://github.com/ClickHouse/ClickHouse/pull/9808) ([Azat Khuzhin](https://github.com/azat))
- Fix "scalar does not exist" error in ALTERs ([#9878](https://github.com/ClickHouse/ClickHouse/issues/9878)). ... [#9904](https://github.com/ClickHouse/ClickHouse/pull/9904) ([Amos Bird](https://github.com/amosbird))
- Fix error with qualified names in `distributed_product_mode=\'local\'`. Fixes [#4756](https://github.com/ClickHouse/ClickHouse/issues/4756) [#9891](https://github.com/ClickHouse/ClickHouse/pull/9891) ([Artem Zuikov](https://github.com/4ertus2))
- For INSERT queries shards now do clamp the settings from the initiator to their constraints instead of throwing an exception. This fix allows to send INSERT queries to a shard with another constraints. This change improves fix [#9447](https://github.com/ClickHouse/ClickHouse/issues/9447). [#9852](https://github.com/ClickHouse/ClickHouse/pull/9852) ([Vitaly Baranov](https://github.com/vitlibar))
- Add some retries when commiting offsets to Kafka broker, since it can reject commit if during `offsets.commit.timeout.ms` there were no enough replicas available for the `__consumer_offsets` topic [#9884](https://github.com/ClickHouse/ClickHouse/pull/9884) ([filimonov](https://github.com/filimonov))
- Fix Distributed engine behavior when virtual columns of the underlying table used in `WHERE` [#9847](https://github.com/ClickHouse/ClickHouse/pull/9847) ([Azat Khuzhin](https://github.com/azat))
- Fixed some cases when timezone of the function argument wasn't used properly. [#9574](https://github.com/ClickHouse/ClickHouse/pull/9574) ([Vasily Nemkov](https://github.com/Enmk))
- Fix 'Different expressions with the same alias' error when query has PREWHERE and WHERE on distributed table and `SET distributed_product_mode = 'local'`. [#9871](https://github.com/ClickHouse/ClickHouse/pull/9871) ([Artem Zuikov](https://github.com/4ertus2))
- Fix mutations excessive memory consumption for tables with a composite primary key. This fixes [#9850](https://github.com/ClickHouse/ClickHouse/issues/9850). [#9860](https://github.com/ClickHouse/ClickHouse/pull/9860) ([alesapin](https://github.com/alesapin))
- Fix calculating grants for introspection functions from the setting `allow_introspection_functions`. [#9840](https://github.com/ClickHouse/ClickHouse/pull/9840) ([Vitaly Baranov](https://github.com/vitlibar))
- Fix max_distributed_connections (w/ and w/o Processors) [#9673](https://github.com/ClickHouse/ClickHouse/pull/9673) ([Azat Khuzhin](https://github.com/azat))
- Fix possible exception `Got 0 in totals chunk, expected 1` on client. It happened for queries with `JOIN` in case if right joined table had zero rows. Example: `select * from system.one t1 join system.one t2 on t1.dummy = t2.dummy limit 0 FORMAT TabSeparated;`. Fixes [#9777](https://github.com/ClickHouse/ClickHouse/issues/9777). ... [#9823](https://github.com/ClickHouse/ClickHouse/pull/9823) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix 'COMMA to CROSS JOIN rewriter is not enabled or cannot rewrite query' error in case of subqueries with COMMA JOIN out of tables lists (i.e. in WHERE). Fixes [#9782](https://github.com/ClickHouse/ClickHouse/issues/9782) [#9830](https://github.com/ClickHouse/ClickHouse/pull/9830) ([Artem Zuikov](https://github.com/4ertus2))
- Fix server crashing when `optimize_skip_unused_shards` is set and expression for key can't be converted to its field type [#9804](https://github.com/ClickHouse/ClickHouse/pull/9804) ([Azat Khuzhin](https://github.com/azat))
- Fix empty string handling in `splitByString`. [#9767](https://github.com/ClickHouse/ClickHouse/pull/9767) ([hcz](https://github.com/hczhcz))
- Fix broken `ALTER TABLE DELETE COLUMN` query for compact parts. [#9779](https://github.com/ClickHouse/ClickHouse/pull/9779) ([alesapin](https://github.com/alesapin))
- Fixed missing `rows_before_limit_at_least` for queries over http (with processors pipeline). Fixes [#9730](https://github.com/ClickHouse/ClickHouse/issues/9730) [#9757](https://github.com/ClickHouse/ClickHouse/pull/9757) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix excessive memory consumption in `ALTER` queries (mutations). This fixes [#9533](https://github.com/ClickHouse/ClickHouse/issues/9533) and [#9670](https://github.com/ClickHouse/ClickHouse/issues/9670). [#9754](https://github.com/ClickHouse/ClickHouse/pull/9754) ([alesapin](https://github.com/alesapin))
- Fix possible permanent "Cannot schedule a task" error. [#9154](https://github.com/ClickHouse/ClickHouse/pull/9154) ([Azat Khuzhin](https://github.com/azat))
- Fix bug in backquoting in external dictionaries DDL. Fixes [#9619](https://github.com/ClickHouse/ClickHouse/issues/9619). [#9734](https://github.com/ClickHouse/ClickHouse/pull/9734) ([alesapin](https://github.com/alesapin))
- Fixed data race in `text_log`. It does not correspond to any real bug. [#9726](https://github.com/ClickHouse/ClickHouse/pull/9726) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix bug in a replication that does not allow replication to work if the user has executed mutations on the previous version. This fixes [#9645](https://github.com/ClickHouse/ClickHouse/issues/9645). [#9652](https://github.com/ClickHouse/ClickHouse/pull/9652) ([alesapin](https://github.com/alesapin))
- Fixed incorrect internal function names for `sumKahan` and `sumWithOverflow`. It led to exception while using this functions in remote queries. [#9636](https://github.com/ClickHouse/ClickHouse/pull/9636) ([Azat Khuzhin](https://github.com/azat))
- Add setting `use_compact_format_in_distributed_parts_names` which allows to write files for `INSERT` queries into `Distributed` table with more compact format. This fixes [#9647](https://github.com/ClickHouse/ClickHouse/issues/9647). [#9653](https://github.com/ClickHouse/ClickHouse/pull/9653) ([alesapin](https://github.com/alesapin))
- Fix RIGHT and FULL JOIN with LowCardinality in JOIN keys. [#9610](https://github.com/ClickHouse/ClickHouse/pull/9610) ([Artem Zuikov](https://github.com/4ertus2))
- Fix possible exceptions `Size of filter does not match size of column` and `Invalid number of rows in Chunk` in `MergeTreeRangeReader`. They could appear while executing `PREWHERE` in some cases. [#9612](https://github.com/ClickHouse/ClickHouse/pull/9612) ([Anton Popov](https://github.com/CurtizJ))
- Allow `ALTER ON CLUSTER` of Distributed tables with internal replication. This fixes [#3268](https://github.com/ClickHouse/ClickHouse/issues/3268) [#9617](https://github.com/ClickHouse/ClickHouse/pull/9617) ([shinoi2](https://github.com/shinoi2))
- Fix issue when timezone was not preserved if you write a simple arithmetic expression like `time + 1` (in contrast to an expression like `time + INTERVAL 1 SECOND`). This fixes [#5743](https://github.com/ClickHouse/ClickHouse/issues/5743) [#9323](https://github.com/ClickHouse/ClickHouse/pull/9323) ([alexey-milovidov](https://github.com/alexey-milovidov))





#### 改进 {#improvement-16}

- Use time zone when comparing DateTime with string literal. This fixes [#5206](https://github.com/ClickHouse/ClickHouse/issues/5206). [#10515](https://github.com/ClickHouse/ClickHouse/pull/10515) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Print verbose diagnostic info if Decimal value cannot be parsed from text input format. [#10205](https://github.com/ClickHouse/ClickHouse/pull/10205) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add tasks/memory metrics for distributed/buffer schedule pools [#10449](https://github.com/ClickHouse/ClickHouse/pull/10449) ([Azat Khuzhin](https://github.com/azat))
- Display result as soon as it's ready for SELECT DISTINCT queries in clickhouse-local and HTTP interface. This fixes [#8951](https://github.com/ClickHouse/ClickHouse/issues/8951) [#9559](https://github.com/ClickHouse/ClickHouse/pull/9559) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Allow to use `SAMPLE OFFSET` query instead of `cityHash64(PRIMARY KEY) % N == n` for splitting in `clickhouse-copier`. To use this feature, pass `--experimental-use-sample-offset 1` as a command line argument. [#10414](https://github.com/ClickHouse/ClickHouse/pull/10414) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Allow to parse BOM in TSV if the first column cannot contain BOM in its value. This fixes [#10301](https://github.com/ClickHouse/ClickHouse/issues/10301) [#10424](https://github.com/ClickHouse/ClickHouse/pull/10424) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add Avro nested fields insert support [#10354](https://github.com/ClickHouse/ClickHouse/pull/10354) ([Andrew Onyshchuk](https://github.com/oandrew))
- Allowed to alter column in non-modifying data mode when the same type is specified. [#10382](https://github.com/ClickHouse/ClickHouse/pull/10382) ([Vladimir Chebotarev](https://github.com/excitoon))
- Auto `distributed_group_by_no_merge` on GROUP BY sharding key (if `optimize_skip_unused_shards` is set) [#10341](https://github.com/ClickHouse/ClickHouse/pull/10341) ([Azat Khuzhin](https://github.com/azat))
- Optimize queries with LIMIT/LIMIT BY/ORDER BY for distributed with GROUP BY sharding_key [#10373](https://github.com/ClickHouse/ClickHouse/pull/10373) ([Azat Khuzhin](https://github.com/azat))
- Added a setting `max_server_memory_usage` to limit total memory usage of the server. The metric `MemoryTracking` is now calculated without a drift. The setting `max_memory_usage_for_all_queries` is now obsolete and does nothing. This closes [#10293](https://github.com/ClickHouse/ClickHouse/issues/10293). [#10362](https://github.com/ClickHouse/ClickHouse/pull/10362) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add config option `system_tables_lazy_load`. If it's set to false, then system tables with logs are loaded at the server startup. [Alexander Burmak](https://github.com/Alex-Burmak), [Svyatoslav Tkhon Il Pak](https://github.com/DeifyTheGod), [#9642](https://github.com/ClickHouse/ClickHouse/pull/9642) [#10359](https://github.com/ClickHouse/ClickHouse/pull/10359) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Use background thread pool (background_schedule_pool_size) for distributed sends [#10263](https://github.com/ClickHouse/ClickHouse/pull/10263) ([Azat Khuzhin](https://github.com/azat))
- Use background thread pool for background buffer flushes. [#10315](https://github.com/ClickHouse/ClickHouse/pull/10315) ([Azat Khuzhin](https://github.com/azat))
- Support for one special case of removing incompletely written parts. This fixes [#9940](https://github.com/ClickHouse/ClickHouse/issues/9940). [#10221](https://github.com/ClickHouse/ClickHouse/pull/10221) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Use isInjective() over manual list of such functions for GROUP BY optimization. [#10342](https://github.com/ClickHouse/ClickHouse/pull/10342) ([Azat Khuzhin](https://github.com/azat))
- Avoid printing error message in log if client sends RST packet immediately on connect. It is typical behaviour of IPVS balancer with keepalived and VRRP. This fixes [#1851](https://github.com/ClickHouse/ClickHouse/issues/1851) [#10274](https://github.com/ClickHouse/ClickHouse/pull/10274) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Allow to parse `+inf` for floating point types. This closes [#1839](https://github.com/ClickHouse/ClickHouse/issues/1839) [#10272](https://github.com/ClickHouse/ClickHouse/pull/10272) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Implemented `generateRandom` table function for Nested types. This closes [#9903](https://github.com/ClickHouse/ClickHouse/issues/9903) [#10219](https://github.com/ClickHouse/ClickHouse/pull/10219) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Provide `max_allowed_packed` in MySQL compatibility interface that will help some clients to communicate with ClickHouse via MySQL protocol. [#10199](https://github.com/ClickHouse/ClickHouse/pull/10199) ([BohuTANG](https://github.com/BohuTANG))
- Allow literals for GLOBAL IN (i.e. `SELECT * FROM remote('localhost', system.one) WHERE dummy global in (0)`) [#10196](https://github.com/ClickHouse/ClickHouse/pull/10196) ([Azat Khuzhin](https://github.com/azat))
- Fix various small issues in interactive mode of clickhouse-client [#10194](https://github.com/ClickHouse/ClickHouse/pull/10194) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Avoid superfluous dictionaries load (system.tables, DROP/SHOW CREATE TABLE) [#10164](https://github.com/ClickHouse/ClickHouse/pull/10164) ([Azat Khuzhin](https://github.com/azat))
- Update to RWLock: timeout parameter for getLock() + implementation reworked to be phase fair [#10073](https://github.com/ClickHouse/ClickHouse/pull/10073) ([Alexander Kazakov](https://github.com/Akazz))
- Enhanced compatibility with native mysql-connector-java(JDBC) [#10021](https://github.com/ClickHouse/ClickHouse/pull/10021) ([BohuTANG](https://github.com/BohuTANG))
- The function `toString` is considered monotonic and can be used for index analysis even when applied in tautological cases with String or LowCardinality(String) argument. [#10110](https://github.com/ClickHouse/ClickHouse/pull/10110) ([Amos Bird](https://github.com/amosbird))
- Add `ON CLUSTER` clause support to commands `{CREATE|DROP} USER/ROLE/ROW POLICY/SETTINGS PROFILE/QUOTA`, `GRANT`. [#9811](https://github.com/ClickHouse/ClickHouse/pull/9811) ([Vitaly Baranov](https://github.com/vitlibar))
- Virtual hosted-style support for S3 URI [#9998](https://github.com/ClickHouse/ClickHouse/pull/9998) ([Pavel Kovalenko](https://github.com/Jokser))
- Now layout type for dictionaries with no arguments can be specified without round brackets in dictionaries DDL-queries. Fixes [#10057](https://github.com/ClickHouse/ClickHouse/issues/10057). [#10064](https://github.com/ClickHouse/ClickHouse/pull/10064) ([alesapin](https://github.com/alesapin))
- Add ability to use number ranges with leading zeros in filepath [#9989](https://github.com/ClickHouse/ClickHouse/pull/9989) ([Olga Khvostikova](https://github.com/stavrolia))
- Better memory usage in CROSS JOIN. [#10029](https://github.com/ClickHouse/ClickHouse/pull/10029) ([Artem Zuikov](https://github.com/4ertus2))
- Try to connect to all shards in cluster when getting structure of remote table and skip_unavailable_shards is set. [#7278](https://github.com/ClickHouse/ClickHouse/pull/7278) ([nvartolomei](https://github.com/nvartolomei))
- Add `total_rows`/`total_bytes` into the `system.tables` table. [#9919](https://github.com/ClickHouse/ClickHouse/pull/9919) ([Azat Khuzhin](https://github.com/azat))
- System log tables now use polymorpic parts by default. [#9905](https://github.com/ClickHouse/ClickHouse/pull/9905) ([Anton Popov](https://github.com/CurtizJ))
- Add type column into system.settings/merge_tree_settings [#9909](https://github.com/ClickHouse/ClickHouse/pull/9909) ([Azat Khuzhin](https://github.com/azat))
- Check for available CPU instructions at server startup as early as possible. [#9888](https://github.com/ClickHouse/ClickHouse/pull/9888) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Remove `ORDER BY` stage from mutations because we read from a single ordered part in a single thread. Also add check that the rows in mutation are ordered by sorting key and this order is not violated. [#9886](https://github.com/ClickHouse/ClickHouse/pull/9886) ([alesapin](https://github.com/alesapin))
- Implement operator LIKE for FixedString at left hand side. This is needed to better support TPC-DS queries. [#9890](https://github.com/ClickHouse/ClickHouse/pull/9890) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add `force_optimize_skip_unused_shards_no_nested` that will disable `force_optimize_skip_unused_shards` for nested Distributed table [#9812](https://github.com/ClickHouse/ClickHouse/pull/9812) ([Azat Khuzhin](https://github.com/azat))
- Now columns size is calculated only once for MergeTree data parts. [#9827](https://github.com/ClickHouse/ClickHouse/pull/9827) ([alesapin](https://github.com/alesapin))
- Evaluate constant expressions for `optimize_skip_unused_shards` (i.e. `SELECT * FROM foo_dist WHERE key=xxHash32(0)`) [#8846](https://github.com/ClickHouse/ClickHouse/pull/8846) ([Azat Khuzhin](https://github.com/azat))
- Check for using `Date` or `DateTime` column from TTL expressions was removed. [#9967](https://github.com/ClickHouse/ClickHouse/pull/9967) ([Vladimir Chebotarev](https://github.com/excitoon))
- DiskS3 hard links optimal implementation. [#9760](https://github.com/ClickHouse/ClickHouse/pull/9760) ([Pavel Kovalenko](https://github.com/Jokser))
- If `set multiple_joins_rewriter_version = 2` enables second version of multiple JOIN rewrites that keeps not clashed column names as is. It supports multiple JOINs with `USING` and allow `select *` for JOINs with subqueries. [#9739](https://github.com/ClickHouse/ClickHouse/pull/9739) ([Artem Zuikov](https://github.com/4ertus2))
- Implementation of "non-blocking" alter for StorageMergeTree [#9606](https://github.com/ClickHouse/ClickHouse/pull/9606) ([alesapin](https://github.com/alesapin))
- Add MergeTree full support for DiskS3 [#9646](https://github.com/ClickHouse/ClickHouse/pull/9646) ([Pavel Kovalenko](https://github.com/Jokser))
- Extend `splitByString` to support empty strings as separators. [#9742](https://github.com/ClickHouse/ClickHouse/pull/9742) ([hcz](https://github.com/hczhcz))
- Add a `timestamp_ns` column to `system.trace_log`. It contains a high-definition timestamp of the trace event, and allows to build timelines of thread profiles ("flame charts"). [#9696](https://github.com/ClickHouse/ClickHouse/pull/9696) ([Alexander Kuzmenkov](https://github.com/akuzm))
- When the setting `send_logs_level` is enabled, avoid intermixing of log messages and query progress. [#9634](https://github.com/ClickHouse/ClickHouse/pull/9634) ([Azat Khuzhin](https://github.com/azat))
- Added support of `MATERIALIZE TTL IN PARTITION`. [#9581](https://github.com/ClickHouse/ClickHouse/pull/9581) ([Vladimir Chebotarev](https://github.com/excitoon))
- Support complex types inside Avro nested fields [#10502](https://github.com/ClickHouse/ClickHouse/pull/10502) ([Andrew Onyshchuk](https://github.com/oandrew))

#### 性能改进 {#performance-improvement-11}

- 改进了 Partial MergeJoin 右表的插入逻辑。[#10467](https://github.com/ClickHouse/ClickHouse/pull/10467) ([Artem Zuikov](https://github.com/4ertus2))
- 提升了行式格式的性能(对于窄表,CSV 提升超过 10%,Avro 提升超过 35%)。[#10503](https://github.com/ClickHouse/ClickHouse/pull/10503) ([Andrew Onyshchuk](https://github.com/oandrew))
- 提升了 IN 操作符右侧显式定义集合且左侧为元组的查询性能。[#10385](https://github.com/ClickHouse/ClickHouse/pull/10385) ([Anton Popov](https://github.com/CurtizJ))
- 降低了 HashJoin 中哈希表的内存使用量。[#10416](https://github.com/ClickHouse/ClickHouse/pull/10416) ([Artem Zuikov](https://github.com/4ertus2))
- 针对 StorageDictionary 实现了特殊的 HashJoin。允许使用 JOIN 重写 `dictGet()` 函数。这本身不会导致向后不兼容,但可能会在某些安装环境中暴露 [#8400](https://github.com/ClickHouse/ClickHouse/issues/8400) 问题。[#10133](https://github.com/ClickHouse/ClickHouse/pull/10133) ([Artem Zuikov](https://github.com/4ertus2))
- 当目标表支持时,启用物化视图的并行插入。[#10052](https://github.com/ClickHouse/ClickHouse/pull/10052) ([vxider](https://github.com/Vxider))
- 提升了使用单调函数进行索引分析的性能。[#9607](https://github.com/ClickHouse/ClickHouse/pull/9607)[#10026](https://github.com/ClickHouse/ClickHouse/pull/10026) ([Anton Popov](https://github.com/CurtizJ))
- 使用 SSE2 或 SSE4.2 SIMD 指令加速布隆过滤器中的分词处理。[#9968](https://github.com/ClickHouse/ClickHouse/pull/9968) ([Vasily Nemkov](https://github.com/Enmk))
- 提升了 `IN` 操作符右侧显式定义集合的查询性能。这修复了 20.3 版本中的性能回退问题。[#9740](https://github.com/ClickHouse/ClickHouse/pull/9740) ([Anton Popov](https://github.com/CurtizJ))
- 现在 clickhouse-copier 会将每个分区拆分为多个片段并独立复制。[#9075](https://github.com/ClickHouse/ClickHouse/pull/9075) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- 增加了更多聚合方法。例如,TPC-H 查询 1 现在会选择 `FixedHashMap<UInt16, AggregateDataPtr>` 并获得 25% 的性能提升。[#9829](https://github.com/ClickHouse/ClickHouse/pull/9829) ([Amos Bird](https://github.com/amosbird))
- 在预限制转换中对多个流使用单一行计数器。这有助于避免在带有 `limit` 但没有 `order by` 的查询(如 `select f(x) from (select x from t limit 1000000000)`)中合并管道流,从而使用多线程进行后续处理。[#9602](https://github.com/ClickHouse/ClickHouse/pull/9602) ([Nikolai Kochetov](https://github.com/KochetovNicolai))


#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-15}

- Use a fork of AWS SDK libraries from ClickHouse-Extras [#10527](https://github.com/ClickHouse/ClickHouse/pull/10527) ([Pavel Kovalenko](https://github.com/Jokser))
- Add integration tests for new ALTER RENAME COLUMN query. [#10654](https://github.com/ClickHouse/ClickHouse/pull/10654) ([vzakaznikov](https://github.com/vzakaznikov))
- Fix possible signed integer overflow in invocation of function `now64` with wrong arguments. This fixes [#8973](https://github.com/ClickHouse/ClickHouse/issues/8973) [#10511](https://github.com/ClickHouse/ClickHouse/pull/10511) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Split fuzzer and sanitizer configurations to make build config compatible with Oss-fuzz. [#10494](https://github.com/ClickHouse/ClickHouse/pull/10494) ([kyprizel](https://github.com/kyprizel))
- Fixes for clang-tidy on clang-10. [#10420](https://github.com/ClickHouse/ClickHouse/pull/10420) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Display absolute paths in error messages. Otherwise KDevelop fails to navigate to correct file and opens a new file instead. [#10434](https://github.com/ClickHouse/ClickHouse/pull/10434) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Added `ASAN_OPTIONS` environment variable to investigate errors in CI stress tests with Address sanitizer. [#10440](https://github.com/ClickHouse/ClickHouse/pull/10440) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Enable ThinLTO for clang builds (experimental). [#10435](https://github.com/ClickHouse/ClickHouse/pull/10435) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Remove accidential dependency on Z3 that may be introduced if the system has Z3 solver installed. [#10426](https://github.com/ClickHouse/ClickHouse/pull/10426) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Move integration tests docker files to docker/ directory. [#10335](https://github.com/ClickHouse/ClickHouse/pull/10335) ([Ilya Yatsishin](https://github.com/qoega))
- Allow to use `clang-10` in CI. It ensures that [#10238](https://github.com/ClickHouse/ClickHouse/issues/10238) is fixed. [#10384](https://github.com/ClickHouse/ClickHouse/pull/10384) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Update OpenSSL to upstream master. Fixed the issue when TLS connections may fail with the message `OpenSSL SSL_read: error:14094438:SSL routines:ssl3_read_bytes:tlsv1 alert internal error` and `SSL Exception: error:2400006E:random number generator::error retrieving entropy`. The issue was present in version 20.1. [#8956](https://github.com/ClickHouse/ClickHouse/pull/8956) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix clang-10 build. [#10238](https://github.com/ClickHouse/ClickHouse/issues/10238) [#10370](https://github.com/ClickHouse/ClickHouse/pull/10370) ([Amos Bird](https://github.com/amosbird))
- Add performance test for [Parallel INSERT for materialized view](https://github.com/ClickHouse/ClickHouse/pull/10052). [#10345](https://github.com/ClickHouse/ClickHouse/pull/10345) ([vxider](https://github.com/Vxider))
- Fix flaky test `test_settings_constraints_distributed.test_insert_clamps_settings`. [#10346](https://github.com/ClickHouse/ClickHouse/pull/10346) ([Vitaly Baranov](https://github.com/vitlibar))
- Add util to test results upload in CI ClickHouse [#10330](https://github.com/ClickHouse/ClickHouse/pull/10330) ([Ilya Yatsishin](https://github.com/qoega))
- Convert test results to JSONEachRow format in junit_to_html tool [#10323](https://github.com/ClickHouse/ClickHouse/pull/10323) ([Ilya Yatsishin](https://github.com/qoega))
- Update cctz. [#10215](https://github.com/ClickHouse/ClickHouse/pull/10215) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Allow to create HTML report from the purest JUnit XML report. [#10247](https://github.com/ClickHouse/ClickHouse/pull/10247) ([Ilya Yatsishin](https://github.com/qoega))
- Update the check for minimal compiler version. Fix the root cause of the issue [#10250](https://github.com/ClickHouse/ClickHouse/issues/10250) [#10256](https://github.com/ClickHouse/ClickHouse/pull/10256) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Initial support for live view tables over distributed [#10179](https://github.com/ClickHouse/ClickHouse/pull/10179) ([vzakaznikov](https://github.com/vzakaznikov))
- Fix (false) MSan report in MergeTreeIndexFullText. The issue first appeared in [#9968](https://github.com/ClickHouse/ClickHouse/issues/9968). [#10801](https://github.com/ClickHouse/ClickHouse/pull/10801) ([alexey-milovidov](https://github.com/alexey-milovidov))
- clickhouse-docker-util [#10151](https://github.com/ClickHouse/ClickHouse/pull/10151) ([filimonov](https://github.com/filimonov))
- Update pdqsort to recent version [#10171](https://github.com/ClickHouse/ClickHouse/pull/10171) ([Ivan](https://github.com/abyss7))
- Update libdivide to v3.0 [#10169](https://github.com/ClickHouse/ClickHouse/pull/10169) ([Ivan](https://github.com/abyss7))
- Add check with enabled polymorphic parts. [#10086](https://github.com/ClickHouse/ClickHouse/pull/10086) ([Anton Popov](https://github.com/CurtizJ))
- Add cross-compile build for FreeBSD. This fixes [#9465](https://github.com/ClickHouse/ClickHouse/issues/9465) [#9643](https://github.com/ClickHouse/ClickHouse/pull/9643) ([Ivan](https://github.com/abyss7))
- Add performance test for [#6924](https://github.com/ClickHouse/ClickHouse/issues/6924) [#6980](https://github.com/ClickHouse/ClickHouse/pull/6980) ([filimonov](https://github.com/filimonov))
- Add support of `/dev/null` in the `File` engine for better performance testing [#8455](https://github.com/ClickHouse/ClickHouse/pull/8455) ([Amos Bird](https://github.com/amosbird))
- Move all folders inside /dbms one level up [#9974](https://github.com/ClickHouse/ClickHouse/pull/9974) ([Ivan](https://github.com/abyss7))
- Add a test that checks that read from MergeTree with single thread is performed in order. Addition to [#9670](https://github.com/ClickHouse/ClickHouse/issues/9670) [#9762](https://github.com/ClickHouse/ClickHouse/pull/9762) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix the `00964_live_view_watch_events_heartbeat.py` test to avoid race condition. [#9944](https://github.com/ClickHouse/ClickHouse/pull/9944) ([vzakaznikov](https://github.com/vzakaznikov))
- Fix integration test `test_settings_constraints` [#9962](https://github.com/ClickHouse/ClickHouse/pull/9962) ([Vitaly Baranov](https://github.com/vitlibar))
- Every function in its own file, part 12. [#9922](https://github.com/ClickHouse/ClickHouse/pull/9922) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Added performance test for the case of extremely slow analysis of array of tuples. [#9872](https://github.com/ClickHouse/ClickHouse/pull/9872) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Update zstd to 1.4.4. It has some minor improvements in performance and compression ratio. If you run replicas with different versions of ClickHouse you may see reasonable error messages `Data after merge is not byte-identical to data on another replicas.` with explanation. These messages are Ok and you should not worry. [#10663](https://github.com/ClickHouse/ClickHouse/pull/10663) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix TSan report in `system.stack_trace`. [#9832](https://github.com/ClickHouse/ClickHouse/pull/9832) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Removed dependency on `clock_getres`. [#9833](https://github.com/ClickHouse/ClickHouse/pull/9833) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Added identifier names check with clang-tidy. [#9799](https://github.com/ClickHouse/ClickHouse/pull/9799) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Update "builder" docker image. This image is not used in CI but is useful for developers. [#9809](https://github.com/ClickHouse/ClickHouse/pull/9809) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Remove old `performance-test` tool that is no longer used in CI. `clickhouse-performance-test` is great but now we are using way superior tool that is doing comparison testing with sophisticated statistical formulas to achieve confident results regardless to various changes in environment. [#9796](https://github.com/ClickHouse/ClickHouse/pull/9796) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Added most of clang-static-analyzer checks. [#9765](https://github.com/ClickHouse/ClickHouse/pull/9765) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Update Poco to 1.9.3 in preparation for MongoDB URI support. [#6892](https://github.com/ClickHouse/ClickHouse/pull/6892) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Fix build with `-DUSE_STATIC_LIBRARIES=0 -DENABLE_JEMALLOC=0` [#9651](https://github.com/ClickHouse/ClickHouse/pull/9651) ([Artem Zuikov](https://github.com/4ertus2))
- For change log script, if merge commit was cherry-picked to release branch, take PR name from commit description. [#9708](https://github.com/ClickHouse/ClickHouse/pull/9708) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Support `vX.X-conflicts` tag in backport script. [#9705](https://github.com/ClickHouse/ClickHouse/pull/9705) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix `auto-label` for backporting script. [#9685](https://github.com/ClickHouse/ClickHouse/pull/9685) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Use libc++ in Darwin cross-build to make it consistent with native build. [#9665](https://github.com/ClickHouse/ClickHouse/pull/9665) ([Hui Wang](https://github.com/huiwang))
- Fix flacky test `01017_uniqCombined_memory_usage`. Continuation of [#7236](https://github.com/ClickHouse/ClickHouse/issues/7236). [#9667](https://github.com/ClickHouse/ClickHouse/pull/9667) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix build for native macOS Clang compiler [#9649](https://github.com/ClickHouse/ClickHouse/pull/9649) ([Ivan](https://github.com/abyss7))
- Allow to add various glitches around `pthread_mutex_lock`, `pthread_mutex_unlock` functions. [#9635](https://github.com/ClickHouse/ClickHouse/pull/9635) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add support for `clang-tidy` in `packager` script. [#9625](https://github.com/ClickHouse/ClickHouse/pull/9625) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add ability to use unbundled msgpack. [#10168](https://github.com/ClickHouse/ClickHouse/pull/10168) ([Azat Khuzhin](https://github.com/azat))





## ClickHouse 版本 v20.3 {#clickhouse-release-v203}

### ClickHouse 版本 v20.3.21.2-lts, 2020-11-02 {#clickhouse-release-v203212-lts-2020-11-02}

#### Bug Fix {#bug-fix-33}

- 修复 sharding_key 中的 dictGet 问题(以及类似场景,即函数上下文被永久存储时)。[#16205](https://github.com/ClickHouse/ClickHouse/pull/16205) ([Azat Khuzhin](https://github.com/azat))。
- 修复当查询包含 `WHERE`、`PREWHERE` 和 `GLOBAL IN` 时,从 `Distributed` 表查询返回错误空结果的问题。修复 [#15792](https://github.com/ClickHouse/ClickHouse/issues/15792)。[#15933](https://github.com/ClickHouse/ClickHouse/pull/15933) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 修复 `TSV/CSVWithNames` 格式中缺失或多余的标题行问题。此修复解决 [#12504](https://github.com/ClickHouse/ClickHouse/issues/12504)。[#13343](https://github.com/ClickHouse/ClickHouse/pull/13343) ([Azat Khuzhin](https://github.com/azat))。

### ClickHouse 版本 v20.3.20.6-lts, 2020-10-09 {#clickhouse-release-v203206-lts-2020-10-09}

#### Bug Fix {#bug-fix-34}

- Mutation 可能在 `MOVE` 或 `REPLACE PARTITION` 之后,或在极少数情况下在 `DETACH` 或 `DROP PARTITION` 之后,挂起等待某些不存在的数据部分。此问题已修复。[#15724](https://github.com/ClickHouse/ClickHouse/pull/15724), [#15537](https://github.com/ClickHouse/ClickHouse/pull/15537) ([tavplubix](https://github.com/tavplubix))。
- 修复对 `MySQL` 引擎的同一表进行大量子查询时查询挂起的问题。之前,如果查询中对同一 `MySQL` 表的子查询超过 16 个,查询会永久挂起。[#15299](https://github.com/ClickHouse/ClickHouse/pull/15299) ([Anton Popov](https://github.com/CurtizJ))。
- 修复当查询对 Merge 表执行 JOIN 时,GROUP BY 中出现 'Unknown identifier' 错误的问题。[#15242](https://github.com/ClickHouse/ClickHouse/pull/15242) ([Artem Zuikov](https://github.com/4ertus2))。
- 修复当子查询包含 finalizeAggregation 函数时谓词下推无法工作的问题。修复 [#14847](https://github.com/ClickHouse/ClickHouse/issues/14847)。[#14937](https://github.com/ClickHouse/ClickHouse/pull/14937) ([filimonov](https://github.com/filimonov))。
- 并发执行的 `ALTER ... REPLACE/MOVE PARTITION ...` 查询可能导致死锁。此问题已修复。[#13626](https://github.com/ClickHouse/ClickHouse/pull/13626) ([tavplubix](https://github.com/tavplubix))。

### ClickHouse 版本 v20.3.19.4-lts, 2020-09-18 {#clickhouse-release-v203194-lts-2020-09-18}

#### Bug Fix {#bug-fix-35}


- 修复 `SELECT` 查询中的罕见错误:当查询的列具有 `DEFAULT` 表达式且该表达式依赖于另一个也具有 `DEFAULT` 的列,而该列既不在查询中也不存在于磁盘上时。部分修复 [#14531](https://github.com/ClickHouse/ClickHouse/issues/14531)。[#14845](https://github.com/ClickHouse/ClickHouse/pull/14845) ([alesapin](https://github.com/alesapin))。
- 修复 `ALTER UPDATE` 变更的错误:当赋值表达式中使用 Nullable 列和常量值(如 `UPDATE x = 42`)时,会导致列中的值不正确或发生段错误。修复 [#13634](https://github.com/ClickHouse/ClickHouse/issues/13634)、[#14045](https://github.com/ClickHouse/ClickHouse/issues/14045)。[#14646](https://github.com/ClickHouse/ClickHouse/pull/14646) ([alesapin](https://github.com/alesapin))。
- 修复由结果列的小数精度错误导致的 Decimal 乘法结果错误。[#14603](https://github.com/ClickHouse/ClickHouse/pull/14603) ([Artem Zuikov](https://github.com/4ertus2))。

#### 改进 {#improvement-17}

- 支持在紧凑数据部分中使用自定义编解码器。[#12183](https://github.com/ClickHouse/ClickHouse/pull/12183) ([Anton Popov](https://github.com/CurtizJ))。

### ClickHouse 版本 v20.3.18.10-lts, 2020-09-08 {#clickhouse-release-v2031810-lts-2020-09-08}

#### 错误修复 {#bug-fix-36}

- 如果 `PipelineExecutor` 本身发生异常,则停止查询执行。这可以防止罕见的查询挂起情况。延续 [#14334](https://github.com/ClickHouse/ClickHouse/issues/14334)。[#14402](https://github.com/ClickHouse/ClickHouse/pull/14402) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 修复缓存字典有时返回默认值而非源中实际存在值的行为。[#13624](https://github.com/ClickHouse/ClickHouse/pull/13624) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 修复当数据库或表名称包含点号时从 users.xml 解析行策略的问题。修复 [#5779](https://github.com/ClickHouse/ClickHouse/issues/5779)、[#12527](https://github.com/ClickHouse/ClickHouse/issues/12527)。[#13199](https://github.com/ClickHouse/ClickHouse/pull/13199) ([Vitaly Baranov](https://github.com/vitlibar))。
- 修复 CAST(Nullable(String), Enum())。[#12745](https://github.com/ClickHouse/ClickHouse/pull/12745) ([Azat Khuzhin](https://github.com/azat))。
- 修复 `text_log` 中的数据竞争。这不对应任何实际错误。[#9726](https://github.com/ClickHouse/ClickHouse/pull/9726) ([alexey-milovidov](https://github.com/alexey-milovidov))。

#### 改进 {#improvement-18}

- 修复长查询的错误提示。对于正确的查询,可能会收到 `Max query size exceeded` 之外的语法错误。[#13928](https://github.com/ClickHouse/ClickHouse/pull/13928) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 当 parseDateTimeBestEffortOrNull/Zero 函数中的值未完全解析时返回 NULL/零值。修复 [#7876](https://github.com/ClickHouse/ClickHouse/issues/7876)。[#11653](https://github.com/ClickHouse/ClickHouse/pull/11653) ([alexey-milovidov](https://github.com/alexey-milovidov))。

#### 性能改进 {#performance-improvement-12}

- 轻微优化使用 LowCardinality 的极短查询。[#14129](https://github.com/ClickHouse/ClickHouse/pull/14129) ([Anton Popov](https://github.com/CurtizJ))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-16}


- 修复迁移到 clang-10 后 HashTable 中出现的 UBSan 报告(向 nullptr 添加零)。[#10638](https://github.com/ClickHouse/ClickHouse/pull/10638) ([alexey-milovidov](https://github.com/alexey-milovidov))。

### ClickHouse 版本 v20.3.17.173-lts,2020-08-15 {#clickhouse-release-v20317173-lts-2020-08-15}

#### 错误修复 {#bug-fix-37}

- 修复使用 StorageMerge 和 `set enable_optimize_predicate_expression=1` 时 JOIN 崩溃的问题。[#13679](https://github.com/ClickHouse/ClickHouse/pull/13679) ([Artem Zuikov](https://github.com/4ertus2))。
- 修复包含 `NULL` 元素的元组比较返回类型错误的问题。修复 [#12461](https://github.com/ClickHouse/ClickHouse/issues/12461)。[#13420](https://github.com/ClickHouse/ClickHouse/pull/13420) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 修复包含常量列和主键 `ORDER BY` 前缀的查询问题。[#13396](https://github.com/ClickHouse/ClickHouse/pull/13396) ([Anton Popov](https://github.com/CurtizJ))。
- 在 roundUpToPowerOfTwoOrZero() 中,对于设置了 MSB 的数字返回传入的数字。[#13234](https://github.com/ClickHouse/ClickHouse/pull/13234) ([Azat Khuzhin](https://github.com/azat))。

### ClickHouse 版本 v20.3.16.165-lts 2020-08-10 {#clickhouse-release-v20316165-lts-2020-08-10}

#### 错误修复 {#bug-fix-38}


* 修复了在将 unix 时间戳作为参数传入时，`parseDateTimeBestEffort` 函数中的错误。该修复解决了 [#13362](https://github.com/ClickHouse/ClickHouse/issues/13362)。[#13441](https://github.com/ClickHouse/ClickHouse/pull/13441)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在对包含 `NaN` 值的 Float 类型列调用 `uniqExact`、`topK`、`sumDistinct` 等类似聚合函数时，可能出现的性能较低及结果略有不准确的问题。该问题还会在 debug 构建中触发断言。本修复对应 [#12491](https://github.com/ClickHouse/ClickHouse/issues/12491)。[#13254](https://github.com/ClickHouse/ClickHouse/pull/13254)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在 `if` 函数中使用可为空的 `constexpr` 作为条件且该条件不是字面量 `NULL` 时的行为。修复了 [#12463](https://github.com/ClickHouse/ClickHouse/issues/12463)。[#13226](https://github.com/ClickHouse/ClickHouse/pull/13226)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在数组元素为 Nullable 且数组下标也为 Nullable 的情况下，`arrayElement` 函数中的断言错误。修复了 [#12172](https://github.com/ClickHouse/ClickHouse/issues/12172)。[#13224](https://github.com/ClickHouse/ClickHouse/pull/13224)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了从本地副本执行 SELECT 时对线程数量的不必要限制。[#12840](https://github.com/ClickHouse/ClickHouse/pull/12840) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复了在执行 `WITH TOTALS` 查询时，数据中可能出现的额外溢出行。 [#12747](https://github.com/ClickHouse/ClickHouse/pull/12747) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复了在 `IN` 子句中将大型元组解释为函数时的性能问题。即用户出于某些莫名其妙的原因编写 `WHERE x IN tuple(1, 2, ...)` 而不是 `WHERE x IN (1, 2, ...)` 的情况。 [#12700](https://github.com/ClickHouse/ClickHouse/pull/12700) ([Anton Popov](https://github.com/CurtizJ))。
* 通过将线程附加到组，修复了 `input_format_parallel_parsing` 的内存跟踪。 [#12672](https://github.com/ClickHouse/ClickHouse/pull/12672) ([Azat Khuzhin](https://github.com/azat)).
* 修复了 [#12293](https://github.com/ClickHouse/ClickHouse/issues/12293) 中的问题，允许在子查询包含 `WITH` 子句时下推谓词。 [#12663](https://github.com/ClickHouse/ClickHouse/pull/12663) ([Winter Zhang](https://github.com/zhang2014)).
* 修复了 [#10572](https://github.com/ClickHouse/ClickHouse/issues/10572) 中关于使用 const 表达式的 Bloom 过滤器索引的问题。[#12659](https://github.com/ClickHouse/ClickHouse/pull/12659)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复了在 broker 不可用（及其他情况）时 `StorageKafka` 中出现的 `SIGSEGV`。 [#12658](https://github.com/ClickHouse/ClickHouse/pull/12658) ([Azat Khuzhin](https://github.com/azat)).
* 修复了采用 `cache` 布局的外部字典中的竞争条件，该问题可能导致服务器崩溃。 [#12566](https://github.com/ClickHouse/ClickHouse/pull/12566) ([alesapin](https://github.com/alesapin)).
* 修复了在 `enable_mixed_granularity_parts=1` 时执行 `ALTER DELETE` 查询会导致旧数据分片损坏的错误。修复了 [#12536](https://github.com/ClickHouse/ClickHouse/issues/12536)。[#12543](https://github.com/ClickHouse/ClickHouse/pull/12543)（[alesapin](https://github.com/alesapin)）。
* 为函数 `in` 在参数数量无效时提供更清晰的异常。[#12529](https://github.com/ClickHouse/ClickHouse/pull/12529) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了从 compact 部分读取时的性能问题。 [#12492](https://github.com/ClickHouse/ClickHouse/pull/12492) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在启用 `text_log` 时出现的死锁问题。[#12452](https://github.com/ClickHouse/ClickHouse/pull/12452) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复了 `StorageMerge` 中可能出现的段错误。关闭 [#12054](https://github.com/ClickHouse/ClickHouse/issues/12054)。[#12401](https://github.com/ClickHouse/ClickHouse/pull/12401) ([tavplubix](https://github.com/tavplubix))。
* 修复了在带有 `-State` 和 `Nullable` 参数的聚合函数中使用 `TOTALS/ROLLUP/CUBE` 时的问题。此修复解决了 [#12163](https://github.com/ClickHouse/ClickHouse/issues/12163)。[#12376](https://github.com/ClickHouse/ClickHouse/pull/12376)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了 `WITH FILL` 修饰符中列顺序的问题。此前没有遵循 `ORDER BY` 子句中列的顺序。[#12306](https://github.com/ClickHouse/ClickHouse/pull/12306) ([Anton Popov](https://github.com/CurtizJ))。
* 当存在按虚拟列（例如 `Merge` 表中的 `_table`）或按系统表中的 “index” 列过滤数据的表达式（例如在查询 `system.tables` 时按数据库名过滤），且该表达式返回 `Nullable` 类型时，避免抛出 “bad cast” 异常。修复了 [#12166](https://github.com/ClickHouse/ClickHouse/issues/12166)。[#12305](https://github.com/ClickHouse/ClickHouse/pull/12305)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 `TrieDictionary` 加载失败时显示错误。[#12290](https://github.com/ClickHouse/ClickHouse/pull/12290)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 函数 `arrayFill` 在处理空数组时行为不正确，可能会导致崩溃。此更改修复了 [#12263](https://github.com/ClickHouse/ClickHouse/issues/12263)。[#12279](https://github.com/ClickHouse/ClickHouse/pull/12279)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 为 `LowCardinality` 类型实现向其公共类型的转换。这允许对包含 LowCardinality 列和其他类型列的表执行 UNION ALL。修复了 [#8212](https://github.com/ClickHouse/ClickHouse/issues/8212)。修复了 [#4342](https://github.com/ClickHouse/ClickHouse/issues/4342)。[#12275](https://github.com/ClickHouse/ClickHouse/pull/12275)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在对 `StorageFile` 进行多次连续插入时，对于某些特殊类型其头信息会被重复写入的问题。此修复解决了 [#6155](https://github.com/ClickHouse/ClickHouse/issues/6155)。[#12197](https://github.com/ClickHouse/ClickHouse/pull/12197)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 修复了在 `UInt8` 值不为 0 或 1 时对其进行处理的逻辑函数。[#12196](https://github.com/ClickHouse/ClickHouse/pull/12196) ([Alexander Kazakov](https://github.com/Akazz)).
* 修复了在消除 `GROUP BY` 单射函数期间对 `dictGet` 参数的检查。[#12179](https://github.com/ClickHouse/ClickHouse/pull/12179) ([Azat Khuzhin](https://github.com/azat)).
* 修复了 `ALTER DELETE` 中的错误逻辑，该逻辑会在条件计算结果为 NULL 时删除记录。此修复解决了 [#9088](https://github.com/ClickHouse/ClickHouse/issues/9088) 并关闭了 [#12106](https://github.com/ClickHouse/ClickHouse/issues/12106)。[#12153](https://github.com/ClickHouse/ClickHouse/pull/12153)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在存在别名时将查询转换后发送到外部 DBMS（例如 MySQL、ODBC）的问题。此修复解决了 [#12032](https://github.com/ClickHouse/ClickHouse/issues/12032)。[#12151](https://github.com/ClickHouse/ClickHouse/pull/12151)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了整数除法中可能发生的溢出问题。该修改修复了 [#12119](https://github.com/ClickHouse/ClickHouse/issues/12119)。[#12140](https://github.com/ClickHouse/ClickHouse/pull/12140)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了 `greatCircleDistance` 和 `geoDistance` 中可能出现的无限循环问题。此更改修复了 [#12117](https://github.com/ClickHouse/ClickHouse/issues/12117)。[#12137](https://github.com/ClickHouse/ClickHouse/pull/12137)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 避免在物化视图包含 `JOIN` 或子查询并附加到系统日志（`system.query_log`、`metric_log` 等）或附加到底层 `engine=Buffer` 表时出现 `There is no query` 异常。 [#12120](https://github.com/ClickHouse/ClickHouse/pull/12120) ([filimonov](https://github.com/filimonov)).
* 修复了由于总线程数限制错误而导致包含 `UNION` 的 `SELECT` 查询性能下降的问题。修复了 [#12030](https://github.com/ClickHouse/ClickHouse/issues/12030)。 [#12103](https://github.com/ClickHouse/ClickHouse/pull/12103)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了 `-StateResample` 组合器中的段错误。 [#12092](https://github.com/ClickHouse/ClickHouse/pull/12092) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了从 `VIEW` 执行 `SELECT` 时对线程数量的不必要限制。修复了 [#11937](https://github.com/ClickHouse/ClickHouse/issues/11937)。[#12085](https://github.com/ClickHouse/ClickHouse/pull/12085)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在为 `PREWHERE` 使用错误类型时可能发生的崩溃。修复了 [#12053](https://github.com/ClickHouse/ClickHouse/issues/12053)、[#12060](https://github.com/ClickHouse/ClickHouse/issues/12060)。[#12060](https://github.com/ClickHouse/ClickHouse/pull/12060)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在 `LowCardinality` 类型上使用函数 `defaultValueOfArgumentType` 时出现的错误 `Expected single dictionary argument for function`。修复了 [#11808](https://github.com/ClickHouse/ClickHouse/issues/11808)。[#12056](https://github.com/ClickHouse/ClickHouse/pull/12056)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在高阶函数使用 `Tuple(LowCardinality)` 参数时出现的 `Cannot capture column` 错误。修复了 [#9766](https://github.com/ClickHouse/ClickHouse/issues/9766)。[#12055](https://github.com/ClickHouse/ClickHouse/pull/12055)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 在加载数据库时并行解析表元数据，修复了在表数量较多时服务器启动缓慢的问题。 [#12045](https://github.com/ClickHouse/ClickHouse/pull/12045) ([tavplubix](https://github.com/tavplubix)).
* 使 `topK` 聚合函数在处理 Enum 类型时返回 Enum 类型。这修复了 [#3740](https://github.com/ClickHouse/ClickHouse/issues/3740)。[#12043](https://github.com/ClickHouse/ClickHouse/pull/12043)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了对约束的检查，确保约束为常量表达式。此更改修复了 [#11360](https://github.com/ClickHouse/ClickHouse/issues/11360)。[#12042](https://github.com/ClickHouse/ClickHouse/pull/12042)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了包含 `Nullable` 列的元组比较错误。修复了 [#11985](https://github.com/ClickHouse/ClickHouse/issues/11985)。[#12039](https://github.com/ClickHouse/ClickHouse/pull/12039)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在调用函数 `if` 且参数为不同大小的 `FixedString` 类型时可能产生的错误结果和潜在崩溃问题。此修复对应 [#11362](https://github.com/ClickHouse/ClickHouse/issues/11362)。[#12021](https://github.com/ClickHouse/ClickHouse/pull/12021) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 如果在查询中仅返回函数 `neighbor` 的表达式，那么当以偏移量 `-9223372036854775808` 调用该函数时，查询可能返回空结果。此更改修复了 [#11367](https://github.com/ClickHouse/ClickHouse/issues/11367)。[#12019](https://github.com/ClickHouse/ClickHouse/pull/12019)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了 `generateRandom` 中可能导致崩溃的数组大小溢出问题。此修复解决了 [#11371](https://github.com/ClickHouse/ClickHouse/issues/11371)。[#12013](https://github.com/ClickHouse/ClickHouse/pull/12013)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了潜在的浮点异常。已关闭 [#11378](https://github.com/ClickHouse/ClickHouse/issues/11378)。[#12005](https://github.com/ClickHouse/ClickHouse/pull/12005)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了服务启动时日志消息中错误的设置名称。[#11997](https://github.com/ClickHouse/ClickHouse/pull/11997) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复了在 `Values` 格式中出现的 `Query parameter was not set` 错误。修复了 [#11918](https://github.com/ClickHouse/ClickHouse/issues/11918)。[#11936](https://github.com/ClickHouse/ClickHouse/pull/11936)（[tavplubix](https://github.com/tavplubix)）。
* 在查询中保留用于替换的别名（参数化查询）。已修复 [#11914](https://github.com/ClickHouse/ClickHouse/issues/11914)。[#11916](https://github.com/ClickHouse/ClickHouse/pull/11916)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了解析 `DateTime64` 时可能出现的浮点运算异常。这修复了 [#11374](https://github.com/ClickHouse/ClickHouse/issues/11374)。[#11875](https://github.com/ClickHouse/ClickHouse/pull/11875)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 通过 `HTTP` 接口修复内存统计（在 `wait_end_of_query=1` 时影响可能较大）。[#11840](https://github.com/ClickHouse/ClickHouse/pull/11840) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在条件包含 NULL 时 `if()` 返回错误结果的问题。[#11807](https://github.com/ClickHouse/ClickHouse/pull/11807) ([Artem Zuikov](https://github.com/4ertus2)).
* 在进行相等性检查之前，先解析存储在 ZooKeeper 中的元数据。[#11739](https://github.com/ClickHouse/ClickHouse/pull/11739) ([Azat Khuzhin](https://github.com/azat))。
* 修复了在 `ORDER BY` 子句中使用包含别名的表达式时与 `LIMIT n WITH TIES` 搭配的问题。[#11689](https://github.com/ClickHouse/ClickHouse/pull/11689) ([Anton Popov](https://github.com/CurtizJ)).
* 修复 `cache dictionary` 中可能发生的未初始化内存读取问题。[#10834](https://github.com/ClickHouse/ClickHouse/pull/10834) ([alexey-milovidov](https://github.com/alexey-milovidov))。

#### 性能改进 {#performance-improvement-13}

- 修复了 IN 运算符使用字面量时未使用索引的问题,该性能退化在 v19.3 版本左右引入。此修复解决了 [#10574](https://github.com/ClickHouse/ClickHouse/issues/10574)。[#12062](https://github.com/ClickHouse/ClickHouse/pull/12062) ([nvartolomei](https://github.com/nvartolomei))。

### ClickHouse 版本 v20.3.12.112-lts 2020-06-25 {#clickhouse-release-v20312112-lts-2020-06-25}

#### Bug 修复 {#bug-fix-39}


* 修复在 `prewhere` 条件中使用 `Nullable` 列时可能导致的罕见崩溃。作为对 [#11608](https://github.com/ClickHouse/ClickHouse/issues/11608) 的后续修复。[#11869](https://github.com/ClickHouse/ClickHouse/pull/11869)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 不允许在高阶函数内部使用 arrayJoin。此前这样做会导致协议同步出错。本次更改关闭了 [#3933](https://github.com/ClickHouse/ClickHouse/issues/3933)。[#11846](https://github.com/ClickHouse/ClickHouse/pull/11846) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复查询使用过多线程的情况。 [#11788](https://github.com/ClickHouse/ClickHouse/pull/11788) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复类似 `SELECT *, xyz.*` 这类查询的非预期行为：这些查询原本应当报错，却被错误地成功执行。 [#11753](https://github.com/ClickHouse/ClickHouse/pull/11753) ([hexiaoting](https://github.com/hexiaoting)).
* 现在在执行元数据变更时，将会取消复制拉取操作。 [#11744](https://github.com/ClickHouse/ClickHouse/pull/11744) ([alesapin](https://github.com/alesapin)).
* 修复了在 Values 输入格式中对复杂字面量进行错误类型推导而引发的 LOGICAL&#95;ERROR。 [#11732](https://github.com/ClickHouse/ClickHouse/pull/11732) ([tavplubix](https://github.com/tavplubix)).
* 修复在常量列上使用 `ORDER BY ... WITH FILL` 时的问题。[#11697](https://github.com/ClickHouse/ClickHouse/pull/11697) ([Anton Popov](https://github.com/CurtizJ)).
* 在与 XDBC bridge 通信时传递合适的超时时间。之前在检查 bridge 存活状态和接收元信息时没有正确遵守这些超时时间。[#11690](https://github.com/ClickHouse/ClickHouse/pull/11690) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复一个会导致 `system.mutations` 状态不正确的错误。该错误可能会显示整个 mutation 已经完成，但服务器在复制队列中仍然有 `MUTATE_PART` 任务并尝试继续执行。此修复对应 [#11611](https://github.com/ClickHouse/ClickHouse/issues/11611)。[#11681](https://github.com/ClickHouse/ClickHouse/pull/11681)（[alesapin](https://github.com/alesapin)）。
* 为正则表达式添加对不区分大小写标志的支持。修复了 [#11101](https://github.com/ClickHouse/ClickHouse/issues/11101) 和 [#11506](https://github.com/ClickHouse/ClickHouse/issues/11506)。[#11649](https://github.com/ClickHouse/ClickHouse/pull/11649)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在启用了行级安全时，移除对简单 `count` 查询的优化。在之前的版本中，用户得到的是表中记录的总数，而不是过滤后的记录数。此更改修复了 [#11352](https://github.com/ClickHouse/ClickHouse/issues/11352)。[#11644](https://github.com/ClickHouse/ClickHouse/pull/11644) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复 `String` 类型的布隆过滤器（数据跳过索引）。[#11638](https://github.com/ClickHouse/ClickHouse/pull/11638)（[Azat Khuzhin](https://github.com/azat)）。
* 修复了在 `prewhere` 条件中使用 `Nullable` 列时导致的偶发崩溃问题。（很可能与 [#11572](https://github.com/ClickHouse/ClickHouse/issues/11572) 有所关联）。[#11608](https://github.com/ClickHouse/ClickHouse/pull/11608)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在从 `Buffer` 表进行采样读取的查询中出现的 `Block structure mismatch` 错误。[#11602](https://github.com/ClickHouse/ClickHouse/pull/11602)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复 `clickhouse-client` 在 `exception.code() % 256 = 0` 时错误的退出码。 [#11601](https://github.com/ClickHouse/ClickHouse/pull/11601) ([filimonov](https://github.com/filimonov)).
* 修复了服务器启动时关于 “Mark cache size was lowered” 的日志消息中的一个小错误。修复了 [#11399](https://github.com/ClickHouse/ClickHouse/issues/11399)。[#11589](https://github.com/ClickHouse/ClickHouse/pull/11589)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在包含 `PREWHERE column in (subquery)` 和 `ARRAY JOIN` 的查询中出现的错误 `Size of offsets does not match size of column`。 [#11580](https://github.com/ClickHouse/ClickHouse/pull/11580) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* HTTP 会话中的所有查询此前具有相同的 `query_id`。该问题已修复。 [#11578](https://github.com/ClickHouse/ClickHouse/pull/11578) ([tavplubix](https://github.com/tavplubix)).
* 现在，`clickhouse-server` Docker 容器在检查服务器存活状态时将优先使用 IPv6。[#11550](https://github.com/ClickHouse/ClickHouse/pull/11550) ([Ivan Starkov](https://github.com/istarkov))。
* 修复 `<node>` 的 shard&#95;num/replica&#95;num（此前会导致 use&#95;compact&#95;format&#95;in&#95;distributed&#95;parts&#95;names 失效）。[#11528](https://github.com/ClickHouse/ClickHouse/pull/11528)（[Azat Khuzhin](https://github.com/azat)）。
* 修复在使用 `-State` 函数进行聚合时，处理中途抛出异常导致的内存泄漏问题。该修复解决了 [#8995](https://github.com/ClickHouse/ClickHouse/issues/8995)。[#11496](https://github.com/ClickHouse/ClickHouse/pull/11496)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在别名可能覆盖限定列名时导致分布式查询结果错误的问题。修复了 [#9672](https://github.com/ClickHouse/ClickHouse/issues/9672) [#9714](https://github.com/ClickHouse/ClickHouse/issues/9714)。[#9972](https://github.com/ClickHouse/ClickHouse/pull/9972)（[Artem Zuikov](https://github.com/4ertus2)）。

### ClickHouse release v20.3.11.97-lts 2020-06-10 {#clickhouse-release-v2031197-lts-2020-06-10}

#### 新特性 {#new-feature-9}

- 现在 ClickHouse 在服务端控制字典源的超时时间。缓存字典配置中新增了两个设置:`strict_max_lifetime_seconds`,默认值为 `max_lifetime`;以及 `query_wait_timeout_milliseconds`,默认值为一分钟。第一个设置与 `allow_read_expired_keys` 设置配合使用也很有用(用于禁止读取已严重过期的键)。[#10337](https://github.com/ClickHouse/ClickHouse/pull/10337) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。

#### 错误修复 {#bug-fix-40}


* 修复在启用 `min_bytes_to_use_direct_io`，且 PREWHERE 激活并使用 SAMPLE 或较多线程数时可能出现的 `Data compressed with different methods` 错误。此更改修复了 [#11539](https://github.com/ClickHouse/ClickHouse/issues/11539)。[#11540](https://github.com/ClickHouse/ClickHouse/pull/11540)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复编解码器返回的压缩大小值。 [#11448](https://github.com/ClickHouse/ClickHouse/pull/11448) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复当列使用带有非字面量参数的压缩编解码器时导致的服务器崩溃问题。修复了 [#11365](https://github.com/ClickHouse/ClickHouse/issues/11365)。[#11431](https://github.com/ClickHouse/ClickHouse/pull/11431)（[alesapin](https://github.com/alesapin)）。
* 修复点为 `nan` 时的 `pointInPolygon` 问题。修复了 [#11375](https://github.com/ClickHouse/ClickHouse/issues/11375)。[#11421](https://github.com/ClickHouse/ClickHouse/pull/11421)（[Alexey Ilyukhov](https://github.com/livace)）。
* 修复在对 LowCarinality(T) 和 Nullable(T) 执行 JOIN 时发生的崩溃。 [#11380](https://github.com/ClickHouse/ClickHouse/issues/11380)。 [#11414](https://github.com/ClickHouse/ClickHouse/pull/11414) ([Artem Zuikov](https://github.com/4ertus2)).
* 修复错误 `USING` 键时返回的错误码。[#11373](https://github.com/ClickHouse/ClickHouse/issues/11373)。[#11404](https://github.com/ClickHouse/ClickHouse/pull/11404) ([Artem Zuikov](https://github.com/4ertus2))。
* 修复了在纬度/经度范围之外使用参数时的 `geohashesInBox`。 [#11403](https://github.com/ClickHouse/ClickHouse/pull/11403) ([Vasily Nemkov](https://github.com/Enmk))。
* 为 `joinGet()` 函数提供了更清晰的错误信息。[#11389](https://github.com/ClickHouse/ClickHouse/pull/11389) ([Artem Zuikov](https://github.com/4ertus2))。
* 修复在使用外部排序并带有 limit 的查询中可能出现的 `Pipeline stuck` 错误。修复了 [#11359](https://github.com/ClickHouse/ClickHouse/issues/11359)。[#11366](https://github.com/ClickHouse/ClickHouse/pull/11366)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 在 ReplicatedMergeTree 中发送分片时移除了多余的锁。 [#11354](https://github.com/ClickHouse/ClickHouse/pull/11354) ([alesapin](https://github.com/alesapin)).
* 修复了 clickhouse-client 在多行模式下对 `\G`（纵向输出）的支持。这一更改解决了 [#9933](https://github.com/ClickHouse/ClickHouse/issues/9933)。[#11350](https://github.com/ClickHouse/ClickHouse/pull/11350)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在直接从 StorageJoin 执行 `SELECT`（不带 `JOIN`）时的崩溃问题，以及错误的可空性处理。 [#11340](https://github.com/ClickHouse/ClickHouse/pull/11340) ([Artem Zuikov](https://github.com/4ertus2)).
* 修复 `quantilesExactWeightedArray` 中的崩溃。[#11337](https://github.com/ClickHouse/ClickHouse/pull/11337) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 现在在执行 `ALTER` 查询时，会先停止合并操作，然后再修改元数据。[#11335](https://github.com/ClickHouse/ClickHouse/pull/11335) ([alesapin](https://github.com/alesapin)).
* 在将 `parallel_view_processing` 设置为 `1` 时，使对 `MATERIALIZED VIEW` 的写入重新实现并行处理。修复了 [#10241](https://github.com/ClickHouse/ClickHouse/issues/10241)。[#11330](https://github.com/ClickHouse/ClickHouse/pull/11330)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复当提取的 JSON 中的字符串包含不匹配的 &#123; 或 [ 时 `visitParamExtractRaw` 的行为。 [#11318](https://github.com/ClickHouse/ClickHouse/pull/11318) ([Ewout](https://github.com/devwout)).
* 修复 `ThreadPool` 中极其罕见的竞态条件。[#11314](https://github.com/ClickHouse/ClickHouse/pull/11314) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复类型转换过程中可能出现的未初始化内存问题。例如：`SELECT toIntervalSecond(now64())`。[#11311](https://github.com/ClickHouse/ClickHouse/pull/11311)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复这样的问题：当表的主键中包含 `Array` 列，并且查询使用 `empty` 或 `notEmpty` 函数对该列进行过滤时，索引分析无法工作。此修复解决了 [#11286](https://github.com/ClickHouse/ClickHouse/issues/11286)。[#11303](https://github.com/ClickHouse/ClickHouse/pull/11303)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了一个错误：当查询速度估算不正确，且查询因 `max_network_bandwidth`、`max_execution_speed` 或 `priority` 设置被限速时，`min_execution_speed` 的限制可能不起作用或行为异常。将 `timeout_before_checking_execution_speed` 的默认值更改为非零，否则 `min_execution_speed` 和 `max_execution_speed` 这两个设置将不会产生任何效果。此更改修复了 [#11297](https://github.com/ClickHouse/ClickHouse/issues/11297)。此更改修复了 [#5732](https://github.com/ClickHouse/ClickHouse/issues/5732)。此更改修复了 [#6228](https://github.com/ClickHouse/ClickHouse/issues/6228)。可用性改进：在 `clickhouse-client` 中避免将异常消息与进度条拼接在一起。[#11296](https://github.com/ClickHouse/ClickHouse/pull/11296)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在读取 Protobuf 格式的畸形数据时发生的崩溃。修复了 [#5957](https://github.com/ClickHouse/ClickHouse/issues/5957)，修复了 [#11203](https://github.com/ClickHouse/ClickHouse/issues/11203)。[#11258](https://github.com/ClickHouse/ClickHouse/pull/11258)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复了一个错误：当只存在已过期键时，`cache-dictionary` 可能返回默认值而不是正常值。该问题仅影响字符串字段。[#11233](https://github.com/ClickHouse/ClickHouse/pull/11233) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 修复在从包含内部查询常量的 `VIEW` 读取时出现的错误 `Block structure mismatch in QueryPipeline`。修复了 [#11181](https://github.com/ClickHouse/ClickHouse/issues/11181)。[#11205](https://github.com/ClickHouse/ClickHouse/pull/11205)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复可能出现的 `Invalid status for associated output` 异常。 [#11200](https://github.com/ClickHouse/ClickHouse/pull/11200) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复高阶函数在捕获参数为 `Array(Array(LowCardinality))` 时可能出现的错误 `Cannot capture column`。[#11185](https://github.com/ClickHouse/ClickHouse/pull/11185) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复了在键数量超过 1000 且在某些后端上可能失败的 S3 通配符匹配问题。 [#11179](https://github.com/ClickHouse/ClickHouse/pull/11179) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 如果数据跳过索引依赖于在后台合并期间将要被修改的列（对于 `SummingMergeTree`、`AggregatingMergeTree` 以及 `TTL GROUP BY`），则其计算结果会不正确。通过将索引计算移动到合并之后，使索引基于合并后的数据进行计算，已修复此问题。[#11162](https://github.com/ClickHouse/ClickHouse/pull/11162)（[Azat Khuzhin](https://github.com/azat)）。
* 修复简单查询中过度预留线程的问题（用于减少线程数量的优化在流水线变更后部分失效）。 [#11114](https://github.com/ClickHouse/ClickHouse/pull/11114) ([Azat Khuzhin](https://github.com/azat)).
* 修复分布式查询中谓词优化（`enable_optimize_predicate_expression=1`）在包含 `HAVING` 子句的查询中的行为（即需要在发起查询的服务器端进行过滤的场景），通过保留表达式的顺序（这就足以完成修复），并强制聚合器优先使用列名而不是索引。修复问题：[#10613](https://github.com/ClickHouse/ClickHouse/issues/10613)、[#11413](https://github.com/ClickHouse/ClickHouse/issues/11413)。[#10621](https://github.com/ClickHouse/ClickHouse/pull/10621)（[Azat Khuzhin](https://github.com/azat)）。
* 引入提交重试逻辑，以降低在偏移量提交失败的极少数情况下从 Kafka 产生重复数据的可能性。 [#9884](https://github.com/ClickHouse/ClickHouse/pull/9884) ([filimonov](https://github.com/filimonov)).

#### 性能改进 {#performance-improvement-14}

- 对于读取外部字典的任何函数,每次调用时仅获取字典并检查访问权限一次。[#10928](https://github.com/ClickHouse/ClickHouse/pull/10928) ([Vitaly Baranov](https://github.com/vitlibar))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-17}

- 修复了多个不稳定的集成测试。[#11355](https://github.com/ClickHouse/ClickHouse/pull/11355) ([alesapin](https://github.com/alesapin))。

### ClickHouse 版本 v20.3.10.75-lts 2020-05-23 {#clickhouse-release-v2031075-lts-2020-05-23}

#### 错误修复 {#bug-fix-41}


* 如果在变更最终确定任务中没有任何内容被最终确定，则不再记录日志。 [#11109](https://github.com/ClickHouse/ClickHouse/pull/11109) ([alesapin](https://github.com/alesapin)).
* 修复了 `parseDateTime64BestEffort` 参数解析中的错误。[#11038](https://github.com/ClickHouse/ClickHouse/pull/11038)（[Vasily Nemkov](https://github.com/Enmk)）。
* 修复了 `getRawData()` 方法中计算原始数据大小不正确的问题。 [#10964](https://github.com/ClickHouse/ClickHouse/pull/10964) ([Igr](https://github.com/ObjatieGroba)).
* 修复了 20.1 与更早版本之间在两级聚合上的不兼容问题。当在发起节点和远程节点上使用不同版本的 ClickHouse，且 `GROUP BY` 结果集很大并且聚合仅针对单个 `String` 字段执行时，就会出现这种不兼容问题。它会导致结果中同一键对应的多行数据未被合并。[#10952](https://github.com/ClickHouse/ClickHouse/pull/10952)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了 `Distributed` 表中元组的向后兼容性问题。[#10889](https://github.com/ClickHouse/ClickHouse/pull/10889) ([Anton Popov](https://github.com/CurtizJ))。
* 修复了在 `StringHashTable` 中访问不存在的键时出现的 `SIGSEGV` 问题。 [#10870](https://github.com/ClickHouse/ClickHouse/pull/10870) ([Azat Khuzhin](https://github.com/azat)).
* 修复了 `ReplicatedMergeTree` 中的一个错误，该错误可能会导致在某个副本变为非活动状态后，某些带有 `OPTIMIZE` 的 `ALTER` 查询在等待该副本时一直挂起。[#10849](https://github.com/ClickHouse/ClickHouse/pull/10849) ([tavplubix](https://github.com/tavplubix))。
* 在执行 `Block::sortColumns()` 后修正了列顺序。[#10826](https://github.com/ClickHouse/ClickHouse/pull/10826) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在未请求为标识符添加引号时 `ODBC` bridge 出现的问题。修复了 [#7984](https://github.com/ClickHouse/ClickHouse/issues/7984)。[#10821](https://github.com/ClickHouse/ClickHouse/pull/10821)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了 `DateLUT` 中的 `UBSan` 和 `MSan` 报告。 [#10798](https://github.com/ClickHouse/ClickHouse/pull/10798) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复了键条件中的不正确类型转换。修复了 [#6287](https://github.com/ClickHouse/ClickHouse/issues/6287)。[#10791](https://github.com/ClickHouse/ClickHouse/pull/10791)（[Andrew Onyshchuk](https://github.com/oandrew)）
* 修复了 `parallel_view_processing` 的行为。现在即使发生异常，所有对 `MATERIALIZED VIEW` 的插入操作也都应能完整完成，无一例外。修复了 [#10241](https://github.com/ClickHouse/ClickHouse/issues/10241)。[#10757](https://github.com/ClickHouse/ClickHouse/pull/10757)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在与 `-State` 组合使用时的组合子 `-OrNull` 和 `-OrDefault` 的问题。 [#10741](https://github.com/ClickHouse/ClickHouse/pull/10741) ([hcz](https://github.com/hczhcz)).
* 修复了 `generateRandom` 在处理嵌套类型时的崩溃问题。修复了 [#10583](https://github.com/ClickHouse/ClickHouse/issues/10583)。[#10734](https://github.com/ClickHouse/ClickHouse/pull/10734)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在合并后可能发生的 `SummingMergeTree` 中 `LowCardinality(FixedString)` 键列数据损坏的问题。修复了 [#10489](https://github.com/ClickHouse/ClickHouse/issues/10489)。[#10721](https://github.com/ClickHouse/ClickHouse/pull/10721)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了函数 `h3EdgeAngle` 中可能发生的缓冲区溢出问题。[#10711](https://github.com/ClickHouse/ClickHouse/pull/10711) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了总计消失的问题。如果查询包含 `JOIN` 或带有外层 `WHERE` 条件的子查询，总计可能会被过滤掉。修复了 [#10674](https://github.com/ClickHouse/ClickHouse/issues/10674)。[#10698](https://github.com/ClickHouse/ClickHouse/pull/10698)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在同一查询中使用 `IN` 运算符对相同集合进行多次判断的问题。 [#10686](https://github.com/ClickHouse/ClickHouse/pull/10686) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了一个错误：在 `readonly=2` 且 `cancel_http_readonly_queries_on_client_close=1` 时，客户端关闭会导致 HTTP 请求卡住的问题。修复了 [#7939](https://github.com/ClickHouse/ClickHouse/issues/7939)、[#7019](https://github.com/ClickHouse/ClickHouse/issues/7019)、[#7736](https://github.com/ClickHouse/ClickHouse/issues/7736)、[#7091](https://github.com/ClickHouse/ClickHouse/issues/7091)。[#10684](https://github.com/ClickHouse/ClickHouse/pull/10684)（[tavplubix](https://github.com/tavplubix)）。
* 修复了 `AggregateTransform` 构造函数中参数的顺序。[#10667](https://github.com/ClickHouse/ClickHouse/pull/10667)（[palasonic1](https://github.com/palasonic1)）。
* 修复了在启用 `distributed_aggregation_memory_efficient` 时远程查询无法并行执行的问题。修复了 [#10655](https://github.com/ClickHouse/ClickHouse/issues/10655)。[#10664](https://github.com/ClickHouse/ClickHouse/pull/10664)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了带有 `LIMIT` 的查询中可能出现的行数不正确的问题。修复了 [#10566](https://github.com/ClickHouse/ClickHouse/issues/10566)、[#10709](https://github.com/ClickHouse/ClickHouse/issues/10709)。[#10660](https://github.com/ClickHouse/ClickHouse/pull/10660)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在表包含大量数据分片时会锁住并发 `ALTER` 操作的错误。 [#10659](https://github.com/ClickHouse/ClickHouse/pull/10659) ([alesapin](https://github.com/alesapin)).
* 修复了一个错误：执行 `SYSTEM DROP DNS CACHE` 查询时，会同时删除用于检查用户是否被允许从某些 IP 地址连接的缓存。 [#10608](https://github.com/ClickHouse/ClickHouse/pull/10608) ([tavplubix](https://github.com/tavplubix)).
* 修复了在 `MATERIALIZED VIEW` 的内部查询中，当该查询包含依赖表时出现的标量结果不正确的问题。 [#10603](https://github.com/ClickHouse/ClickHouse/pull/10603) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复了在列 `ALIAS` 的默认表达式类型与列类型不同时执行 `SELECT` 的问题。[#10563](https://github.com/ClickHouse/ClickHouse/pull/10563) ([Azat Khuzhin](https://github.com/azat))。
* 实现了对 `DateTime64` 与 `String` 值之间的比较。 [#10560](https://github.com/ClickHouse/ClickHouse/pull/10560) ([Vasily Nemkov](https://github.com/Enmk))。
* 修复了在某些情况下将紧凑部分合并为另一个紧凑部分后可能出现的索引损坏问题。[#10531](https://github.com/ClickHouse/ClickHouse/pull/10531) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了这样一种情况：`mutation` 已处理完所有 `part`，但仍然卡在 `is_done=0` 状态。[#10526](https://github.com/ClickHouse/ClickHouse/pull/10526) ([alesapin](https://github.com/alesapin)).
* 修复了在相对于 `UTC` 具有小数偏移的时区中，Unix 纪元起始时发生的溢出问题。此更改修复了 [#9335](https://github.com/ClickHouse/ClickHouse/issues/9335)。[#10513](https://github.com/ClickHouse/ClickHouse/pull/10513)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了 `Distributed` 存储的不正确关闭问题。[#10491](https://github.com/ClickHouse/ClickHouse/pull/10491)（[Azat Khuzhin](https://github.com/azat)）。
* 修复了 `simpleLinearRegression` 在处理大整数时的数值溢出问题。[#10474](https://github.com/ClickHouse/ClickHouse/pull/10474) ([hcz](https://github.com/hczhcz))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-18}

- 修复 LZ4 库中的 UBSan 报告。[#10631](https://github.com/ClickHouse/ClickHouse/pull/10631) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 修复 clang-10 构建问题。[#10238](https://github.com/ClickHouse/ClickHouse/issues/10238)。[#10370](https://github.com/ClickHouse/ClickHouse/pull/10370) ([Amos Bird](https://github.com/amosbird))。
- 添加了关于 `max_rows_to_sort` 设置的失败测试用例。[#10268](https://github.com/ClickHouse/ClickHouse/pull/10268) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 改进了输入格式中诊断信息的打印输出。修复 [#10204](https://github.com/ClickHouse/ClickHouse/issues/10204)。[#10418](https://github.com/ClickHouse/ClickHouse/pull/10418) ([tavplubix](https://github.com/tavplubix))。
- 为 clickhouse-server Docker 镜像添加了 CA 证书。[#10476](https://github.com/ClickHouse/ClickHouse/pull/10476) ([filimonov](https://github.com/filimonov))。

#### 错误修复 {#bug-fix-42}

- 修复错误 `the BloomFilter false positive must be a double number between 0 and 1` [#10551](https://github.com/ClickHouse/ClickHouse/issues/10551)。[#10569](https://github.com/ClickHouse/ClickHouse/pull/10569) ([Winter Zhang](https://github.com/zhang2014))。

### ClickHouse 版本 v20.3.8.53, 2020-04-23 {#clickhouse-release-v203853-2020-04-23}


#### 错误修复 {#bug-fix-43}

- 修复了日期时间函数在 UTC 偏移量在正负之间变化的时区(例如 Pacific/Kiritimati)下的错误行为。此修复解决了 [#7202](https://github.com/ClickHouse/ClickHouse/issues/7202) [#10369](https://github.com/ClickHouse/ClickHouse/pull/10369) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了启用 `distributed_group_by_no_merge` 时可能发生的段错误(由 20.3.7.46 版本中的 [#10131](https://github.com/ClickHouse/ClickHouse/issues/10131) 引入)。[#10399](https://github.com/ClickHouse/ClickHouse/pull/10399) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- 修复了 `Array(Tuple(...))` 数据类型的错误展平问题。此修复解决了 [#10259](https://github.com/ClickHouse/ClickHouse/issues/10259) [#10390](https://github.com/ClickHouse/ClickHouse/pull/10390) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 移除 Aggregator 中的磁盘预留。此修复解决了磁盘空间预留中的错误,该错误可能导致大型外部聚合失败,即使它本可以成功完成 [#10375](https://github.com/ClickHouse/ClickHouse/pull/10375) ([Azat Khuzhin](https://github.com/azat))
- 修复了 `ReplicatedMergeTree` 中 `DROP` 与 `OPTIMIZE` 的竞争条件。如果存在并发的 `OPTIMIZE` 查询,`DROP` 可能会在 ZooKeeper 的副本路径中留下一些垃圾数据。[#10312](https://github.com/ClickHouse/ClickHouse/pull/10312) ([tavplubix](https://github.com/tavplubix))
- 修复了在列默认值被修改后服务器无法附加表的错误。[#10441](https://github.com/ClickHouse/ClickHouse/pull/10441) ([alesapin](https://github.com/alesapin))
- 在加载表之前附加数据库失败时,不再删除元数据目录。[#10442](https://github.com/ClickHouse/ClickHouse/pull/10442) ([Winter Zhang](https://github.com/zhang2014))
- 修复了多个错误:当某些数据以仲裁方式插入,然后以某种方式删除(DROP PARTITION、TTL)时,会导致 INSERT 卡住或 SELECT 中出现误报异常。此修复解决了 [#9946](https://github.com/ClickHouse/ClickHouse/issues/9946) [#10188](https://github.com/ClickHouse/ClickHouse/pull/10188) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- 修复了 `ConcatProcessor` 中可能在远程查询中发生的 `Pipeline stuck` 错误。[#10381](https://github.com/ClickHouse/ClickHouse/pull/10381) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- 修复了 HashTable 中的错误行为,该行为在尝试从缓冲区读取 HashMap 时导致编译错误。[#10386](https://github.com/ClickHouse/ClickHouse/pull/10386) ([palasonic1](https://github.com/palasonic1))
- 允许在多个 JOIN 中使用 `count(*)`。修复了 [#9853](https://github.com/ClickHouse/ClickHouse/issues/9853) [#10291](https://github.com/ClickHouse/ClickHouse/pull/10291) ([Artem Zuikov](https://github.com/4ertus2))
- 优先使用 `fallback_to_stale_replicas` 而不是 `skip_unavailable_shards`,否则当两个设置都指定且没有最新副本时,查询将失败(补丁来自 @alex-zaitsev)。修复了:[#2564](https://github.com/ClickHouse/ClickHouse/issues/2564)。[#10422](https://github.com/ClickHouse/ClickHouse/pull/10422) ([Azat Khuzhin](https://github.com/azat))
- 修复了带有 ARRAY JOIN、ORDER BY 和 LIMIT 的查询可能返回不完整结果的问题。此修复解决了 [#10226](https://github.com/ClickHouse/ClickHouse/issues/10226)。作者:[Vadim Plakhtinskiy](https://github.com/VadimPlh)。[#10427](https://github.com/ClickHouse/ClickHouse/pull/10427) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 在创建 BloomFilter 索引时检查参数的数量和类型 [#9623](https://github.com/ClickHouse/ClickHouse/issues/9623) [#10431](https://github.com/ClickHouse/ClickHouse/pull/10431) ([Winter Zhang](https://github.com/zhang2014))

#### 性能改进 {#performance-improvement-15}

- 改进了 `IN` 运算符右侧显式定义集合且左侧为元组的查询性能。此修复解决了版本 20.3 中的性能回退问题。[#9740](https://github.com/ClickHouse/ClickHouse/pull/9740), [#10385](https://github.com/ClickHouse/ClickHouse/pull/10385) ([Anton Popov](https://github.com/CurtizJ))

### ClickHouse 版本 v20.3.7.46, 2020-04-17 {#clickhouse-release-v203746-2020-04-17}

#### 错误修复 {#bug-fix-44}

- 修复了混合使用逗号和命名连接的查询中出现的 `Logical error: CROSS JOIN has expressions` 错误。[#10311](https://github.com/ClickHouse/ClickHouse/pull/10311) ([Artem Zuikov](https://github.com/4ertus2))。
- 修复了使用 `max_bytes_before_external_group_by` 的查询问题。[#10302](https://github.com/ClickHouse/ClickHouse/pull/10302) ([Artem Zuikov](https://github.com/4ertus2))。
- 修复了存在 arrayJoin 函数时(在某些情况下)移动到 prewhere 的优化问题。此修复解决了 [#10092](https://github.com/ClickHouse/ClickHouse/issues/10092)。[#10195](https://github.com/ClickHouse/ClickHouse/pull/10195) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 添加了通过 `allow_nondeterministic_mutations` 设置放宽 mutation 中非确定性函数使用限制的功能。[#10186](https://github.com/ClickHouse/ClickHouse/pull/10186) ([filimonov](https://github.com/filimonov))。

### ClickHouse 版本 v20.3.6.40, 2020-04-16 {#clickhouse-release-v203640-2020-04-16}

#### 新功能 {#new-feature-10}

- 添加了 `isConstant` 函数。该函数检查其参数是否为常量表达式,并返回 1 或 0。此函数用于开发、调试和演示目的。[#10198](https://github.com/ClickHouse/ClickHouse/pull/10198) ([alexey-milovidov](https://github.com/alexey-milovidov))。

#### 错误修复 {#bug-fix-45}


* 修复在使用 `max_rows_to_group_by` 且 `group_by_overflow_mode = 'break'` 时出现的 `Pipeline stuck` 错误。[#10279](https://github.com/ClickHouse/ClickHouse/pull/10279) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复一个极少出现但可能发生的异常 `Cannot drain connections: cancel first`。 [#10239](https://github.com/ClickHouse/ClickHouse/pull/10239) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复了一个错误：当用户尝试在 `ENGINE = Replicated*` 的表上执行 `ALTER UPDATE/DELETE` 时，ClickHouse 会抛出 “Unknown function lambda.” 错误信息。用于检查非确定性函数的逻辑现在已能正确处理 `lambda` 表达式。[#10237](https://github.com/ClickHouse/ClickHouse/pull/10237) ([Alexander Kazakov](https://github.com/Akazz)).
* 修复了 Date 类型的 `generateRandom` 函数，解决了 [#9973](https://github.com/ClickHouse/ClickHouse/issues/9973)。同时修复了这样一个边界情况：当包含年份为 2106 的日期插入到使用旧式分区方式的 MergeTree 表中，而分区名称却使用 1970 年时。 [#10218](https://github.com/ClickHouse/ClickHouse/pull/10218) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 当 View 的表定义与其 `SELECT` 查询不一致时，自动执行类型转换。此更改修复了 [#10180](https://github.com/ClickHouse/ClickHouse/issues/10180) 和 [#10022](https://github.com/ClickHouse/ClickHouse/issues/10022)。[#10217](https://github.com/ClickHouse/ClickHouse/pull/10217)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `parseDateTimeBestEffort` 在解析 RFC-2822 格式字符串且星期为星期二或星期四时的行为。此更改修复了 [#10082](https://github.com/ClickHouse/ClickHouse/issues/10082)。[#10214](https://github.com/ClickHouse/ClickHouse/pull/10214)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `JOIN` 内部常量列名与 `JOIN` 外部常量列名可能发生冲突的问题。 [#10207](https://github.com/ClickHouse/ClickHouse/pull/10207) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复了在从 `system.numbers` 或 `system.zeros` 等无限数据源读取时，本应在 LIMIT 处停止的查询可能出现无限执行的问题。[#10206](https://github.com/ClickHouse/ClickHouse/pull/10206)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在未指定数据库时无法使用当前数据库进行访问检查的问题。 [#10192](https://github.com/ClickHouse/ClickHouse/pull/10192) ([Vitaly Baranov](https://github.com/vitlibar)).
* 在向 Distributed() 执行 INSERT 时，如果结构不匹配则转换数据块。 [#10135](https://github.com/ClickHouse/ClickHouse/pull/10135) ([Azat Khuzhin](https://github.com/azat))。
* 修复 processors pipeline 中 `extremes` 可能产生错误结果的潜在问题。 [#10131](https://github.com/ClickHouse/ClickHouse/pull/10131) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复在紧凑部件上执行某些类型 `ALTER` 时的问题。[#10130](https://github.com/ClickHouse/ClickHouse/pull/10130) ([Anton Popov](https://github.com/CurtizJ))。
* 修复在创建新副本时对 `index_granularity_bytes` 的错误检查。修复 [#10098](https://github.com/ClickHouse/ClickHouse/issues/10098)。[#10121](https://github.com/ClickHouse/ClickHouse/pull/10121)（[alesapin](https://github.com/alesapin)）。
* 修复在向 Distributed 表执行 INSERT 时，当其结构与底层表不同时会发生的 SIGSEGV。 [#10105](https://github.com/ClickHouse/ClickHouse/pull/10105) ([Azat Khuzhin](https://github.com/azat)).
* 修复在包含 `JOIN` 和 `UNION ALL` 的查询中可能出现的行丢失问题。修复了 [#9826](https://github.com/ClickHouse/ClickHouse/issues/9826)、[#10113](https://github.com/ClickHouse/ClickHouse/issues/10113)。参见 [#10099](https://github.com/ClickHouse/ClickHouse/pull/10099)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在从旧版 ClickHouse 升级时，由于不存在 `/table/replicas/replica_name/metadata` 节点而导致复制表无法启动的问题。修复了 [#10037](https://github.com/ClickHouse/ClickHouse/issues/10037)。[#10095](https://github.com/ClickHouse/ClickHouse/pull/10095)（[alesapin](https://github.com/alesapin)）。
* 为 MySQL 数据库引擎新增部分参数检查，并支持标识符类型参数。[#10077](https://github.com/ClickHouse/ClickHouse/pull/10077) ([Winter Zhang](https://github.com/zhang2014))。
* 修复从本地 ClickHouse 服务器获取的 ClickHouse 字典源中的一个 bug。该 bug 在字典与源中的类型不兼容时可能导致内存损坏。 [#10071](https://github.com/ClickHouse/ClickHouse/pull/10071) ([alesapin](https://github.com/alesapin))。
* 修复了在表包含跳过索引时，`CHECK TABLE` 查询中的错误。[#10068](https://github.com/ClickHouse/ClickHouse/pull/10068) ([alesapin](https://github.com/alesapin)).
* 修复错误 `Cannot clone block with columns because block has 0 columns ... While executing GroupingAggregatedTransform`。该问题在启用 `distributed_aggregation_memory_efficient` 设置，并且分布式查询从不同分片读取不同聚合层级的数据时出现（单层聚合与双层聚合混用）。[#10063](https://github.com/ClickHouse/ClickHouse/pull/10063) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了在对包含尾部零字节的字符串键执行 GROUP BY 时可能发生的段错误（[#8636](https://github.com/ClickHouse/ClickHouse/issues/8636)、[#8925](https://github.com/ClickHouse/ClickHouse/issues/8925)）。[#10025](https://github.com/ClickHouse/ClickHouse/pull/10025)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* 修复用于远程查询执行的线程数问题（自 20.3 起出现的性能回退）。当对 `Distributed` 表的查询在本地和远程分片上同时执行时会触发该问题。修复了 [#9965](https://github.com/ClickHouse/ClickHouse/issues/9965)。[#9971](https://github.com/ClickHouse/ClickHouse/pull/9971)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了一个错误：在针对某些数据库执行查询的某个处理阶段中，未能获取到所需的表。修复了 [#9699](https://github.com/ClickHouse/ClickHouse/issues/9699)。[#9949](https://github.com/ClickHouse/ClickHouse/pull/9949)（[achulkov2](https://github.com/achulkov2)）。
* 修复在 `JOIN` 与 `TOTALS` 一起使用时出现的 “Not found column in block” 错误。修复了 [#9839](https://github.com/ClickHouse/ClickHouse/issues/9839)。[#9939](https://github.com/ClickHouse/ClickHouse/pull/9939)（[Artem Zuikov](https://github.com/4ertus2)）。
* 修复在服务器启动时会导致 `ON CLUSTER` DDL 查询卡死的错误。[#9927](https://github.com/ClickHouse/ClickHouse/pull/9927) ([Gagan Arneja](https://github.com/garneja))。
* 修复在 `CREATE USER` 命令中解析多个主机定义时的问题，例如 `CREATE USER user6 HOST NAME REGEXP 'lo.?*host', NAME REGEXP 'lo*host'`。 [#9924](https://github.com/ClickHouse/ClickHouse/pull/9924) ([Vitaly Baranov](https://github.com/vitlibar))。
* 修复 Join 表引擎中 `TRUNCATE` 的问题（[#9917](https://github.com/ClickHouse/ClickHouse/issues/9917)）。[#9920](https://github.com/ClickHouse/ClickHouse/pull/9920)（[Amos Bird](https://github.com/amosbird)）。
* 修复在 `ALTER` 中出现的“scalar does not exist”错误（[#9878](https://github.com/ClickHouse/ClickHouse/issues/9878)）。[#9904](https://github.com/ClickHouse/ClickHouse/pull/9904)（[Amos Bird](https://github.com/amosbird)）。
* 修复 `ReplicatedMergeTree` 中 `drop` 与 `optimize` 之间的竞争状态。 [#9901](https://github.com/ClickHouse/ClickHouse/pull/9901) ([alesapin](https://github.com/alesapin)).
* 修复在 `distributed_product_mode='local'` 模式下使用限定名称时的错误。修复了 [#4756](https://github.com/ClickHouse/ClickHouse/issues/4756)。[#9891](https://github.com/ClickHouse/ClickHouse/pull/9891)（[Artem Zuikov](https://github.com/4ertus2)）。
* 修复基于设置 &#39;allow&#95;introspection&#95;functions&#39; 计算自省函数权限授予方式的问题。[#9840](https://github.com/ClickHouse/ClickHouse/pull/9840) ([Vitaly Baranov](https://github.com/vitlibar))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-19}

- 修复集成测试 `test_settings_constraints`。[#9962](https://github.com/ClickHouse/ClickHouse/pull/9962) ([Vitaly Baranov](https://github.com/vitlibar))。
- 移除对 `clock_getres` 的依赖。[#9833](https://github.com/ClickHouse/ClickHouse/pull/9833) ([alexey-milovidov](https://github.com/alexey-milovidov))。

### ClickHouse 版本 v20.3.5.21, 2020-03-27 {#clickhouse-release-v203521-2020-03-27}

#### 错误修复 {#bug-fix-46}

- 修复当查询在分布式表上同时使用 PREWHERE 和 WHERE,且设置 `SET distributed_product_mode = 'local'` 时出现的"具有相同别名的不同表达式"错误。[#9871](https://github.com/ClickHouse/ClickHouse/pull/9871) ([Artem Zuikov](https://github.com/4ertus2))。
- 修复具有复合主键的表在执行 mutation 时内存消耗过高的问题。此修复解决了 [#9850](https://github.com/ClickHouse/ClickHouse/issues/9850)。[#9860](https://github.com/ClickHouse/ClickHouse/pull/9860) ([alesapin](https://github.com/alesapin))。
- 对于 INSERT 查询,分片现在会将从发起者获取的设置限制在分片自身的约束范围内,而不是抛出异常。此修复允许向具有不同约束的分片发送 INSERT 查询。此更改改进了 [#9447](https://github.com/ClickHouse/ClickHouse/issues/9447) 的修复。[#9852](https://github.com/ClickHouse/ClickHouse/pull/9852) ([Vitaly Baranov](https://github.com/vitlibar))。
- 修复当子查询在表列表之外(即在 WHERE 子句中)使用 COMMA JOIN 时出现的"COMMA to CROSS JOIN 重写器未启用或无法重写查询"错误。修复了 [#9782](https://github.com/ClickHouse/ClickHouse/issues/9782)。[#9830](https://github.com/ClickHouse/ClickHouse/pull/9830) ([Artem Zuikov](https://github.com/4ertus2))。
- 修复客户端可能出现的异常 `Got 0 in totals chunk, expected 1`。当使用 `JOIN` 的查询中右连接表的行数为零时会发生此问题。示例:`select * from system.one t1 join system.one t2 on t1.dummy = t2.dummy limit 0 FORMAT TabSeparated;`。修复了 [#9777](https://github.com/ClickHouse/ClickHouse/issues/9777)。[#9823](https://github.com/ClickHouse/ClickHouse/pull/9823) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 修复当类型无法转换时 optimize_skip_unused_shards 导致的 SIGSEGV 错误。[#9804](https://github.com/ClickHouse/ClickHouse/pull/9804) ([Azat Khuzhin](https://github.com/azat))。
- 修复针对紧凑数据部分(compact parts)的 `ALTER TABLE DELETE COLUMN` 查询失效的问题。[#9779](https://github.com/ClickHouse/ClickHouse/pull/9779) ([alesapin](https://github.com/alesapin))。
- 修复 max_distributed_connections(包括使用和不使用 Processors 的情况)。[#9673](https://github.com/ClickHouse/ClickHouse/pull/9673) ([Azat Khuzhin](https://github.com/azat))。
- 修复了几种函数参数的时区未正确使用的情况。[#9574](https://github.com/ClickHouse/ClickHouse/pull/9574) ([Vasily Nemkov](https://github.com/Enmk))。

#### 改进 {#improvement-19}

- 从 mutation 中移除排序阶段,因为我们在单个线程中从单个有序数据部分读取数据。同时添加检查以确保 mutation 中的行顺序按排序键顺序排列且此顺序未被破坏。[#9886](https://github.com/ClickHouse/ClickHouse/pull/9886) ([alesapin](https://github.com/alesapin))。

### ClickHouse 版本 v20.3.4.10, 2020-03-20 {#clickhouse-release-v203410-2020-03-20}


#### 错误修复 {#bug-fix-47}

- 此版本还包含 20.1.8.41 的所有错误修复
- 修复通过 HTTP 查询(使用处理器流水线)时缺少 `rows_before_limit_at_least` 的问题。此修复解决了 [#9730](https://github.com/ClickHouse/ClickHouse/issues/9730)。[#9757](https://github.com/ClickHouse/ClickHouse/pull/9757) ([Nikolai Kochetov](https://github.com/KochetovNicolai))

### ClickHouse 版本 v20.3.3.6,2020-03-17 {#clickhouse-release-v20336-2020-03-17}

#### 错误修复 {#bug-fix-48}

- 此版本还包含 20.1.7.38 的所有错误修复
- 修复复制中的错误,该错误导致用户在先前版本上执行变更操作后复制无法正常工作。此修复解决了 [#9645](https://github.com/ClickHouse/ClickHouse/issues/9645)。[#9652](https://github.com/ClickHouse/ClickHouse/pull/9652) ([alesapin](https://github.com/alesapin))。这使得版本 20.3 恢复向后兼容性。
- 添加设置 `use_compact_format_in_distributed_parts_names`,允许以更紧凑的格式将 `INSERT` 查询的文件写入 `Distributed` 表。此修复解决了 [#9647](https://github.com/ClickHouse/ClickHouse/issues/9647)。[#9653](https://github.com/ClickHouse/ClickHouse/pull/9653) ([alesapin](https://github.com/alesapin))。这使得版本 20.3 恢复向后兼容性。

### ClickHouse 版本 v20.3.2.1,2020-03-12 {#clickhouse-release-v20321-2020-03-12}

#### 向后不兼容的变更 {#backward-incompatible-change-9}


* 修复了在大量副本情况下向 `Distributed` 表发送数据时出现的 `file name too long` 问题。修复了副本凭据暴露在服务器日志中的问题。磁盘上的目录名称格式更改为 `[shard{shard_index}[_replica{replica_index}]]`。[#8911](https://github.com/ClickHouse/ClickHouse/pull/8911)（[Mikhail Korotov](https://github.com/millb)）升级到新版本后，如果不进行人工干预，将无法降级，因为旧版本服务器无法识别新的目录格式。如果您需要降级，必须手动将相应目录重命名为旧格式。此更改仅在您曾对 `Distributed` 表使用异步 `INSERT` 时才会生效。在 20.3.3 版本中，我们将引入一个设置，允许您逐步启用新的格式。
* 更改了用于 `mutation` 命令的复制日志记录格式。在安装新版本之前，必须先等待旧的 `mutation` 全部执行完成。
* 实现了一个简单的内存分析器，在软内存分配上限每增加 N 字节时将堆栈跟踪转储到 `system.trace_log` 中 [#8765](https://github.com/ClickHouse/ClickHouse/pull/8765) ([Ivan](https://github.com/abyss7)) [#9472](https://github.com/ClickHouse/ClickHouse/pull/9472) ([alexey-milovidov](https://github.com/alexey-milovidov))。`system.trace_log` 中的一列已从 `timer_type` 重命名为 `trace_type`。这将需要对第三方性能分析和 flamegraph 处理工具进行相应修改。
* 在所有地方使用 OS 线程 id 来代替内部线程编号。这修复了 [#7477](https://github.com/ClickHouse/ClickHouse/issues/7477)：旧版本的 `clickhouse-client` 在启用 `send_logs_level` 设置时，无法接收服务器发送的日志，因为结构化日志消息的名称和类型已经发生变化。另一方面，不同版本的服务器之间可以互相发送类型不同的日志。当你不使用 `send_logs_level` 设置时，则无需关心这一点。[#8954](https://github.com/ClickHouse/ClickHouse/pull/8954) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 移除 `indexHint` 函数 [#9542](https://github.com/ClickHouse/ClickHouse/pull/9542) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 移除 `findClusterIndex`、`findClusterValue` 函数。此更改修复了 [#8641](https://github.com/ClickHouse/ClickHouse/issues/8641)。如果你曾使用这些函数，请发送邮件至 `clickhouse-feedback@yandex-team.com` [#9543](https://github.com/ClickHouse/ClickHouse/pull/9543)（[alexey-milovidov](https://github.com/alexey-milovidov)）
* 现在不允许创建或添加以 `SELECT` 子查询作为默认表达式的列。[#9481](https://github.com/ClickHouse/ClickHouse/pull/9481) ([alesapin](https://github.com/alesapin))
* 在 `JOIN` 中要求为子查询指定别名。[#9274](https://github.com/ClickHouse/ClickHouse/pull/9274) ([Artem Zuikov](https://github.com/4ertus2))
* 改进了 `ALTER MODIFY/ADD` 查询逻辑。现在不允许在未指定类型的情况下 `ADD` 列；`MODIFY` 默认表达式不会改变列的类型；`MODIFY` 类型时也不会丢失默认表达式的值。修复了 [#8669](https://github.com/ClickHouse/ClickHouse/issues/8669)。[#9227](https://github.com/ClickHouse/ClickHouse/pull/9227) ([alesapin](https://github.com/alesapin))
* 需要重启服务器才能使日志配置中的更改生效。这是一个临时解决方案，用于避免服务器继续写入已被删除的日志文件的 bug（参见 [#8696](https://github.com/ClickHouse/ClickHouse/issues/8696)）。[#8707](https://github.com/ClickHouse/ClickHouse/pull/8707)（[Alexander Kuzmenkov](https://github.com/akuzm)）
* `experimental_use_processors` 设置默认开启。此设置会启用新的查询流水线。这是一次内部重构，我们预计不会有任何可见变化。如果你发现任何问题，请将其重新设置为 0。[#8768](https://github.com/ClickHouse/ClickHouse/pull/8768) ([alexey-milovidov](https://github.com/alexey-milovidov))





#### 新功能 {#new-feature-11}

- 添加 `Avro` 和 `AvroConfluent` 输入/输出格式 [#8571](https://github.com/ClickHouse/ClickHouse/pull/8571) ([Andrew Onyshchuk](https://github.com/oandrew)) [#8957](https://github.com/ClickHouse/ClickHouse/pull/8957) ([Andrew Onyshchuk](https://github.com/oandrew)) [#8717](https://github.com/ClickHouse/ClickHouse/pull/8717) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `cache` 字典中过期键的多线程和非阻塞更新(可选允许读取旧值)。[#8303](https://github.com/ClickHouse/ClickHouse/pull/8303) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- 添加查询 `ALTER ... MATERIALIZE TTL`。它运行变更操作,强制删除 TTL 过期的数据并重新计算所有数据部分中的 TTL 元信息。[#8775](https://github.com/ClickHouse/ClickHouse/pull/8775) ([Anton Popov](https://github.com/CurtizJ))
- 在需要时从 HashJoin 切换到 MergeJoin(基于磁盘)[#9082](https://github.com/ClickHouse/ClickHouse/pull/9082) ([Artem Zuikov](https://github.com/4ertus2))
- 为 `ALTER TABLE` 添加 `MOVE PARTITION` 命令 [#4729](https://github.com/ClickHouse/ClickHouse/issues/4729) [#6168](https://github.com/ClickHouse/ClickHouse/pull/6168) ([Guillaume Tassery](https://github.com/YiuRULE))
- 支持从配置文件动态重新加载存储配置。[#8594](https://github.com/ClickHouse/ClickHouse/pull/8594) ([Vladimir Chebotarev](https://github.com/excitoon))
- 允许将 `storage_policy` 更改为功能不低于当前策略的配置。[#8107](https://github.com/ClickHouse/ClickHouse/pull/8107) ([Vladimir Chebotarev](https://github.com/excitoon))
- 为 S3 存储和表函数添加通配符/模式匹配支持。[#8851](https://github.com/ClickHouse/ClickHouse/pull/8851) ([Vladimir Chebotarev](https://github.com/excitoon))
- 为 `FixedString(N)` 数据类型实现 `bitAnd`、`bitOr`、`bitXor`、`bitNot` 函数。[#9091](https://github.com/ClickHouse/ClickHouse/pull/9091) ([Guillaume Tassery](https://github.com/YiuRULE))
- 添加函数 `bitCount`。这修复了 [#8702](https://github.com/ClickHouse/ClickHouse/issues/8702)。[#8708](https://github.com/ClickHouse/ClickHouse/pull/8708) ([alexey-milovidov](https://github.com/alexey-milovidov)) [#8749](https://github.com/ClickHouse/ClickHouse/pull/8749) ([ikopylov](https://github.com/ikopylov))
- 添加 `generateRandom` 表函数,用于根据给定模式生成随机行。允许为任意测试表填充数据。[#8994](https://github.com/ClickHouse/ClickHouse/pull/8994) ([Ilya Yatsishin](https://github.com/qoega))
- `JSONEachRowFormat`:支持对象包含在顶层数组中的特殊情况。[#8860](https://github.com/ClickHouse/ClickHouse/pull/8860) ([Kruglov Pavel](https://github.com/Avogar))
- 现在可以创建带有 `DEFAULT` 表达式的列,该表达式依赖于具有 `ALIAS` 默认表达式的列。[#9489](https://github.com/ClickHouse/ClickHouse/pull/9489) ([alesapin](https://github.com/alesapin))
- 允许在 `clickhouse-obfuscator` 中指定大于源数据大小的 `--limit`。数据将使用不同的随机种子重复生成。[#9155](https://github.com/ClickHouse/ClickHouse/pull/9155) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 添加 `groupArraySample` 函数(类似于 `groupArray`),使用水塘采样算法。[#8286](https://github.com/ClickHouse/ClickHouse/pull/8286) ([Amos Bird](https://github.com/amosbird))
- 现在可以通过系统指标监控 `cache`/`complex_key_cache` 字典中更新队列的大小。[#9413](https://github.com/ClickHouse/ClickHouse/pull/9413) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- 当设置 `output_format_csv_crlf_end_of_line` 为 1 时,允许在 CSV 输出格式中使用 CRLF 作为行分隔符 [#8934](https://github.com/ClickHouse/ClickHouse/pull/8934) [#8935](https://github.com/ClickHouse/ClickHouse/pull/8935) [#8963](https://github.com/ClickHouse/ClickHouse/pull/8963) ([Mikhail Korotov](https://github.com/millb))
- 实现更多 [H3](https://github.com/uber/h3) API 函数:`h3GetBaseCell`、`h3HexAreaM2`、`h3IndexesAreNeighbors`、`h3ToChildren`、`h3ToString` 和 `stringToH3` [#8938](https://github.com/ClickHouse/ClickHouse/pull/8938) ([Nico Mandery](https://github.com/nmandery))
- 引入新设置:`max_parser_depth`,用于控制最大堆栈大小并允许大型复杂查询。这修复了 [#6681](https://github.com/ClickHouse/ClickHouse/issues/6681) 和 [#7668](https://github.com/ClickHouse/ClickHouse/issues/7668)。[#8647](https://github.com/ClickHouse/ClickHouse/pull/8647) ([Maxim Smirnov](https://github.com/qMBQx8GH))
- 添加设置 `force_optimize_skip_unused_shards`,当无法跳过未使用的分片时抛出异常 [#8805](https://github.com/ClickHouse/ClickHouse/pull/8805) ([Azat Khuzhin](https://github.com/azat))
- 允许为 `Distributed` 引擎配置多个磁盘/卷来存储待发送的数据 [#8756](https://github.com/ClickHouse/ClickHouse/pull/8756) ([Azat Khuzhin](https://github.com/azat))
- 支持用于存储临时数据的存储策略(`<tmp_policy>`)。[#8750](https://github.com/ClickHouse/ClickHouse/pull/8750) ([Azat Khuzhin](https://github.com/azat))
- 添加 `X-ClickHouse-Exception-Code` HTTP 头,当在发送数据之前抛出异常时设置。这实现了 [#4971](https://github.com/ClickHouse/ClickHouse/issues/4971)。[#8786](https://github.com/ClickHouse/ClickHouse/pull/8786) ([Mikhail Korotov](https://github.com/millb))
- 添加函数 `ifNotFinite`。这只是一个语法糖:`ifNotFinite(x, y) = isFinite(x) ? x : y`。[#8710](https://github.com/ClickHouse/ClickHouse/pull/8710) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 在 `system.dictionaries` 表中添加 `last_successful_update_time` 列 [#9394](https://github.com/ClickHouse/ClickHouse/pull/9394) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- 添加 `blockSerializedSize` 函数(磁盘上未压缩的大小)[#8952](https://github.com/ClickHouse/ClickHouse/pull/8952) ([Azat Khuzhin](https://github.com/azat))
- 添加函数 `moduloOrZero` [#9358](https://github.com/ClickHouse/ClickHouse/pull/9358) ([hcz](https://github.com/hczhcz))
- 添加系统表 `system.zeros` 和 `system.zeros_mt` 以及表函数 `zeros()` 和 `zeros_mt()`。表(和表函数)包含名为 `zero`、类型为 `UInt8` 的单列。该列包含零值。这用于测试目的,是生成大量行的最快方法。这修复了 [#6604](https://github.com/ClickHouse/ClickHouse/issues/6604) [#9593](https://github.com/ClickHouse/ClickHouse/pull/9593) ([Nikolai Kochetov](https://github.com/KochetovNicolai))

#### 实验性功能 {#experimental-feature-7}

- 为 `MergeTree` 系列表新增紧凑格式的数据部分,将所有列存储在单个文件中。这有助于提升小批量频繁插入的性能。旧格式(每列一个文件)现称为宽格式。数据存储格式由 `min_bytes_for_wide_part` 和 `min_rows_for_wide_part` 设置控制。[#8290](https://github.com/ClickHouse/ClickHouse/pull/8290) ([Anton Popov](https://github.com/CurtizJ))
- 为 `Log`、`TinyLog` 和 `StripeLog` 表新增 S3 存储支持。[#8862](https://github.com/ClickHouse/ClickHouse/pull/8862) ([Pavel Kovalenko](https://github.com/Jokser))


#### 错误修复 {#bug-fix-49}

- 修复了日志消息中不一致的空白字符。 [#9322](https://github.com/ClickHouse/ClickHouse/pull/9322) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了在创建表时未命名元组数组被展平为 Nested 结构的错误。 [#8866](https://github.com/ClickHouse/ClickHouse/pull/8866) ([achulkov2](https://github.com/achulkov2))
- 修复了当 `File` 表或 `file` 表函数中有太多匹配 glob 模式的文件时可能发生"打开文件过多"错误的问题。现在文件采用延迟打开方式。此修复解决了 [#8857](https://github.com/ClickHouse/ClickHouse/issues/8857) [#8861](https://github.com/ClickHouse/ClickHouse/pull/8861) ([alexey-milovidov](https://github.com/alexey-milovidov))
- DROP TEMPORARY TABLE 现在仅删除临时表。 [#8907](https://github.com/ClickHouse/ClickHouse/pull/8907) ([Vitaly Baranov](https://github.com/vitlibar))
- 在关闭服务器或 DETACH/ATTACH 表时删除过时的分区。 [#8602](https://github.com/ClickHouse/ClickHouse/pull/8602) ([Guillaume Tassery](https://github.com/YiuRULE))
- 针对默认磁盘如何从 `data` 子目录计算可用空间。修复了当 `data` 目录挂载到单独设备时可用空间计算不正确的问题(罕见情况)。此修复解决了 [#7441](https://github.com/ClickHouse/ClickHouse/issues/7441) [#9257](https://github.com/ClickHouse/ClickHouse/pull/9257) ([Mikhail Korotov](https://github.com/millb))
- 允许在逗号(交叉)连接内部使用 IN ()。 [#9251](https://github.com/ClickHouse/ClickHouse/pull/9251) ([Artem Zuikov](https://github.com/4ertus2))
- 允许在 WHERE 部分存在 [NOT] LIKE 运算符时将 CROSS 重写为 INNER JOIN。 [#9229](https://github.com/ClickHouse/ClickHouse/pull/9229) ([Artem Zuikov](https://github.com/4ertus2))
- 修复了启用 `distributed_aggregation_memory_efficient` 设置后 `GROUP BY` 可能产生不正确结果的问题。修复了 [#9134](https://github.com/ClickHouse/ClickHouse/issues/9134). [#9289](https://github.com/ClickHouse/ClickHouse/pull/9289) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- 在缓存字典的指标中,已找到的键被计为未命中。 [#9411](https://github.com/ClickHouse/ClickHouse/pull/9411) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- 修复了在 [#8598](https://github.com/ClickHouse/ClickHouse/issues/8598). [#9412](https://github.com/ClickHouse/ClickHouse/pull/9412) ([alesapin](https://github.com/alesapin))
- 修复了 `ReplicatedMergeTree` 表启动时 `queue_task_handle` 上的竞态条件。 [#9552](https://github.com/ClickHouse/ClickHouse/pull/9552) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `SHOW TABLES NOT LIKE` 查询中的 `NOT` 标记不起作用 [#8727](https://github.com/ClickHouse/ClickHouse/issues/8727) [#8940](https://github.com/ClickHouse/ClickHouse/pull/8940) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 为函数 `h3EdgeLengthM` 添加了范围检查。如果没有此检查,可能会发生缓冲区溢出。 [#8945](https://github.com/ClickHouse/ClickHouse/pull/8945) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了对多个参数(超过 10 个)进行三元逻辑运算批量计算时的错误。 [#8718](https://github.com/ClickHouse/ClickHouse/pull/8718) ([Alexander Kazakov](https://github.com/Akazz))
- 修复了 PREWHERE 优化的错误,该错误可能导致段错误或 `Inconsistent number of columns got from MergeTreeRangeReader` 异常。 [#9024](https://github.com/ClickHouse/ClickHouse/pull/9024) ([Anton Popov](https://github.com/CurtizJ))
- 修复了意外的 `Timeout exceeded while reading from socket` 异常,该异常在启用查询分析器时会在超时实际超出之前随机发生在安全连接上。同时添加了 `connect_timeout_with_failover_secure_ms` 设置(默认 100ms),类似于 `connect_timeout_with_failover_ms`,但用于安全连接(因为 SSL 握手比普通 TCP 连接慢) [#9026](https://github.com/ClickHouse/ClickHouse/pull/9026) ([tavplubix](https://github.com/tavplubix))
- 修复了变更完成时的错误,变更可能会挂起在 `parts_to_do=0` 和 `is_done=0` 的状态。 [#9022](https://github.com/ClickHouse/ClickHouse/pull/9022) ([alesapin](https://github.com/alesapin))
- 在 `partial_merge_join` 设置中使用新的 ANY JOIN 逻辑。现在可以使用 `partial_merge_join=1` 执行 `ANY|ALL|SEMI LEFT` 和 `ALL INNER` 连接。 [#8932](https://github.com/ClickHouse/ClickHouse/pull/8932) ([Artem Zuikov](https://github.com/4ertus2))
- 分片现在将从发起者获得的设置限制在分片的约束范围内,而不是抛出异常。此修复允许向具有不同约束的分片发送查询。 [#9447](https://github.com/ClickHouse/ClickHouse/pull/9447) ([Vitaly Baranov](https://github.com/vitlibar))
- 修复了 `MergeTreeReadPool` 中的内存管理问题。 [#8791](https://github.com/ClickHouse/ClickHouse/pull/8791) ([Vladimir Chebotarev](https://github.com/excitoon))
- 修复了使用字符串 `e` 调用 `toDecimal*OrNull()` 函数族时的问题。修复了 [#8312](https://github.com/ClickHouse/ClickHouse/issues/8312) [#8764](https://github.com/ClickHouse/ClickHouse/pull/8764) ([Artem Zuikov](https://github.com/4ertus2))
- 确保 `FORMAT Null` 不向客户端发送任何数据。 [#8767](https://github.com/ClickHouse/ClickHouse/pull/8767) ([Alexander Kuzmenkov](https://github.com/akuzm))
- 修复了 `LiveViewBlockInputStream` 中时间戳不会更新的错误。`LIVE VIEW` 是一个实验性功能。 [#8644](https://github.com/ClickHouse/ClickHouse/pull/8644) ([vxider](https://github.com/Vxider)) [#8625](https://github.com/ClickHouse/ClickHouse/pull/8625) ([vxider](https://github.com/Vxider))
- 修复了 `ALTER MODIFY TTL` 的错误行为,该行为不允许删除旧的 TTL 表达式。 [#8422](https://github.com/ClickHouse/ClickHouse/pull/8422) ([Vladimir Chebotarev](https://github.com/excitoon))
- 修复了 MergeTreeIndexSet 中的 UBSan 报告。此修复解决了 [#9250](https://github.com/ClickHouse/ClickHouse/issues/9250) [#9365](https://github.com/ClickHouse/ClickHouse/pull/9365) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了当 haystack 包含零字节时 `match` 和 `extract` 函数的行为。当 haystack 为常量时行为是错误的。此修复解决了 [#9160](https://github.com/ClickHouse/ClickHouse/issues/9160) [#9163](https://github.com/ClickHouse/ClickHouse/pull/9163) ([alexey-milovidov](https://github.com/alexey-milovidov)) [#9345](https://github.com/ClickHouse/ClickHouse/pull/9345) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 避免在 Apache Avro 第三方库的析构函数中抛出异常。 [#9066](https://github.com/ClickHouse/ClickHouse/pull/9066) ([Andrew Onyshchuk](https://github.com/oandrew))
- 不要部分提交从 `Kafka` 轮询的批次,因为这可能导致数据出现空洞。 [#8876](https://github.com/ClickHouse/ClickHouse/pull/8876) ([filimonov](https://github.com/filimonov))
- 修复了具有可空返回类型的 `joinGet`。 [#8919](https://github.com/ClickHouse/ClickHouse/issues/8919) [#9014](https://github.com/ClickHouse/ClickHouse/pull/9014) ([Amos Bird](https://github.com/amosbird))
- 修复了使用 `T64` 编解码器压缩时的数据不兼容问题。 [#9016](https://github.com/ClickHouse/ClickHouse/pull/9016) ([Artem Zuikov](https://github.com/4ertus2)) 修复了 `T64` 压缩编解码器中的数据类型 ID,该问题导致受影响版本中的(解)压缩错误。 [#9033](https://github.com/ClickHouse/ClickHouse/pull/9033) ([Artem Zuikov](https://github.com/4ertus2))
- 添加了 `enable_early_constant_folding` 设置,并在某些导致错误的情况下禁用它。 [#9010](https://github.com/ClickHouse/ClickHouse/pull/9010) ([Artem Zuikov](https://github.com/4ertus2))
- 修复了 VIEW 的下推谓词优化器并启用了测试 [#9011](https://github.com/ClickHouse/ClickHouse/pull/9011) ([Winter Zhang](https://github.com/zhang2014))
- 修复了从 `File` 存储读取时 `Merge` 表可能发生的段错误 [#9387](https://github.com/ClickHouse/ClickHouse/pull/9387) ([tavplubix](https://github.com/tavplubix))
- 在 `ATTACH PARTITION FROM`、`REPLACE PARTITION`、`MOVE TO TABLE` 中添加了存储策略检查。否则可能会导致重启后部分数据无法访问并阻止 ClickHouse 启动。 [#9383](https://github.com/ClickHouse/ClickHouse/pull/9383) ([Vladimir Chebotarev](https://github.com/excitoon))
- 修复了为表设置 TTL 时的 alter 操作。 [#8800](https://github.com/ClickHouse/ClickHouse/pull/8800) ([Anton Popov](https://github.com/CurtizJ))
- 修复了在某个字典正在被修改/添加/删除时执行 `SYSTEM RELOAD ALL DICTIONARIES` 可能发生的竞态条件。 [#8801](https://github.com/ClickHouse/ClickHouse/pull/8801) ([Vitaly Baranov](https://github.com/vitlibar))
- 在以前的版本中,`Memory` 数据库引擎使用空数据路径,因此表在 `path` 目录(例如 `/var/lib/clickhouse/`)中创建,而不是在数据库的数据目录(例如 `/var/lib/clickhouse/db_name`)中创建。 [#8753](https://github.com/ClickHouse/ClickHouse/pull/8753) ([tavplubix](https://github.com/tavplubix))
- 修复了关于缺少默认磁盘或策略的错误日志消息。 [#9530](https://github.com/ClickHouse/ClickHouse/pull/9530) ([Vladimir Chebotarev](https://github.com/excitoon))
- 修复了数组类型的 bloom_filter 索引的 not(has())。 [#9407](https://github.com/ClickHouse/ClickHouse/pull/9407) ([achimbab](https://github.com/achimbab))
- 允许使用 `Log` 引擎的表中的第一列为别名 [#9231](https://github.com/ClickHouse/ClickHouse/pull/9231) ([Ivan](https://github.com/abyss7))
- 修复了在单线程中从 `MergeTree` 表读取时的范围顺序。这可能导致 `MergeTreeRangeReader` 异常或错误的查询结果。 [#9050](https://github.com/ClickHouse/ClickHouse/pull/9050) ([Anton Popov](https://github.com/CurtizJ))
- 使 `reinterpretAsFixedString` 返回 `FixedString` 而不是 `String`。 [#9052](https://github.com/ClickHouse/ClickHouse/pull/9052) ([Andrew Onyshchuk](https://github.com/oandrew))
- 避免用户可能获得错误的错误消息(`Success` 而不是详细的错误描述)的极其罕见的情况。 [#9457](https://github.com/ClickHouse/ClickHouse/pull/9457) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 使用空行模板的 `Template` 格式时不会崩溃。 [#8785](https://github.com/ClickHouse/ClickHouse/pull/8785) ([Alexander Kuzmenkov](https://github.com/akuzm))
- 系统表的元数据文件可能在错误的位置创建 [#8653](https://github.com/ClickHouse/ClickHouse/pull/8653) ([tavplubix](https://github.com/tavplubix)) Fixes [#8581](https://github.com/ClickHouse/ClickHouse/issues/8581).
- 修复缓存字典中 exception_ptr 的数据竞争 [#8303](https://github.com/ClickHouse/ClickHouse/issues/8303). [#9379](https://github.com/ClickHouse/ClickHouse/pull/9379) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- 对于查询 `ATTACH TABLE IF NOT EXISTS` 不抛出异常。以前,即使有 `IF NOT EXISTS` 子句,如果表已存在也会抛出异常。 [#8967](https://github.com/ClickHouse/ClickHouse/pull/8967) ([Anton Popov](https://github.com/CurtizJ))
- 修复了异常消息中缺少的右括号。 [#8811](https://github.com/ClickHouse/ClickHouse/pull/8811) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 避免在交互模式下启动 clickhouse-client 时出现 `Possible deadlock avoided` 消息。 [#9455](https://github.com/ClickHouse/ClickHouse/pull/9455) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了 base64 编码值末尾的填充可能格式错误的问题。更新了 base64 库。此修复解决了 [#9491](https://github.com/ClickHouse/ClickHouse/issues/9491),关闭了 [#9492](https://github.com/ClickHouse/ClickHouse/issues/9492) [#9500](https://github.com/ClickHouse/ClickHouse/pull/9500) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 防止在读取后缀之后但提交之前发生异常的罕见情况下 `Kafka` 中的数据丢失。修复了 [#9378](https://github.com/ClickHouse/ClickHouse/issues/9378) [#9507](https://github.com/ClickHouse/ClickHouse/pull/9507) ([filimonov](https://github.com/filimonov))
- 修复了 `DROP TABLE IF EXISTS` 中的异常 [#8663](https://github.com/ClickHouse/ClickHouse/pull/8663) ([Nikita Vasilev](https://github.com/nikvas0))
- 修复了用户尝试对旧格式的 `MergeTree` 表引擎系列执行 `ALTER MODIFY SETTING` 时的崩溃。 [#9435](https://github.com/ClickHouse/ClickHouse/pull/9435) ([alesapin](https://github.com/alesapin))
- 在 JSON 相关函数中支持不适合 Int64 的 UInt64 数字。将 SIMDJSON 更新到 master。此修复解决了 [#9209](https://github.com/ClickHouse/ClickHouse/issues/9209) [#9344](https://github.com/ClickHouse/ClickHouse/pull/9344) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了使用非严格单调函数索引时反向谓词的执行。 [#9223](https://github.com/ClickHouse/ClickHouse/pull/9223) ([Alexander Kazakov](https://github.com/Akazz))
- 不要尝试在 `GROUP BY` 中折叠 `IN` 常量 [#8868](https://github.com/ClickHouse/ClickHouse/pull/8868) ([Amos Bird](https://github.com/amosbird))
- 修复了 `ALTER DELETE` 变更中导致索引损坏的错误。此修复解决了 [#9019](https://github.com/ClickHouse/ClickHouse/issues/9019) 和 [#8982](https://github.com/ClickHouse/ClickHouse/issues/8982)。此外修复了 `ReplicatedMergeTree` `ALTER` 查询中极其罕见的竞态条件。 [#9048](https://github.com/ClickHouse/ClickHouse/pull/9048) ([alesapin](https://github.com/alesapin))
- 当启用 `compile_expressions` 设置时,使用 `Nullable` 类型时可能会在 `LLVMExecutableFunction` 中得到 `unexpected column` [#8910](https://github.com/ClickHouse/ClickHouse/pull/8910) ([Guillaume Tassery](https://github.com/YiuRULE))
- `Kafka` 引擎的多项修复:1) 修复了在消费者组重新平衡期间出现的重复项。2) 修复了当通过一次轮询从多个分区轮询数据并部分提交时出现的罕见"空洞"(现在我们总是处理/提交整个轮询的消息块)。3) 修复了按块大小刷新(在此之前只有按超时刷新正常工作)。4) 更好的订阅过程(带有分配反馈)。5) 使测试运行更快(使用默认间隔和超时)。由于之前数据没有按块大小刷新(根据文档应该如此),该 PR 可能会导致默认设置下的一些性能下降(由于更频繁和更小的刷新,这不太理想)。如果在此更改后遇到性能问题 - 请将表中的 `kafka_max_block_size` 增加到更大的值(例如 `CREATE TABLE ...Engine=Kafka ... SETTINGS ... kafka_max_block_size=524288`)。修复了 [#7259](https://github.com/ClickHouse/ClickHouse/issues/7259) [#8917](https://github.com/ClickHouse/ClickHouse/pull/8917) ([filimonov](https://github.com/filimonov))
- 修复了 PREWHERE 优化后某些查询中的 `Parameter out of bound` 异常。 [#8914](https://github.com/ClickHouse/ClickHouse/pull/8914) ([Baudouin Giard](https://github.com/bgiard))
- 修复了函数 `arrayZip` 参数的混合常量性情况。 [#8705](https://github.com/ClickHouse/ClickHouse/pull/8705) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 执行 `CREATE` 查询时,折叠存储引擎参数中的常量表达式。用当前数据库替换空数据库名称。修复了 [#6508](https://github.com/ClickHouse/ClickHouse/issues/6508),[#3492](https://github.com/ClickHouse/ClickHouse/issues/3492) [#9262](https://github.com/ClickHouse/ClickHouse/pull/9262) ([tavplubix](https://github.com/tavplubix))
- 现在无法创建或添加具有简单循环别名的列,例如 `a DEFAULT b, b DEFAULT a`。 [#9603](https://github.com/ClickHouse/ClickHouse/pull/9603) ([alesapin](https://github.com/alesapin))
- 修复了可能损坏原始部分的双重移动错误。如果您使用 `ALTER TABLE MOVE`,这是相关的 [#8680](https://github.com/ClickHouse/ClickHouse/pull/8680) ([Vladimir Chebotarev](https://github.com/excitoon))
- 允许 `interval` 标识符在没有反引号的情况下正确解析。修复了即使 `interval` 标识符用反引号或双引号括起来也无法执行查询的问题。此修复解决了 [#9124](https://github.com/ClickHouse/ClickHouse/issues/9124). [#9142](https://github.com/ClickHouse/ClickHouse/pull/9142) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了模糊测试和 `bitTestAll`/`bitTestAny` 函数的不正确行为。 [#9143](https://github.com/ClickHouse/ClickHouse/pull/9143) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了当有大量行等于第 n 行时 `LIMIT n WITH TIES` 中可能的崩溃/错误行数。 [#9464](https://github.com/ClickHouse/ClickHouse/pull/9464) ([tavplubix](https://github.com/tavplubix))
- 修复了启用 `insert_quorum` 写入的部分的变更。 [#9463](https://github.com/ClickHouse/ClickHouse/pull/9463) ([alesapin](https://github.com/alesapin))
- 修复了 `Poco::HTTPServer` 销毁时的数据竞争。当服务器启动后立即关闭时可能会发生这种情况。 [#9468](https://github.com/ClickHouse/ClickHouse/pull/9468) ([Anton Popov](https://github.com/CurtizJ))
- 修复了运行 `SHOW CREATE TABLE a_table_that_does_not_exist` 时显示误导性错误消息的错误。 [#8899](https://github.com/ClickHouse/ClickHouse/pull/8899) ([achulkov2](https://github.com/achulkov2))
- 修复了在某些罕见情况下,当我们在 `SELECT` 子句中有常量且有 `ORDER BY` 和 `LIMIT` 子句时出现的 `Parameters are out of bound` 异常。 [#8892](https://github.com/ClickHouse/ClickHouse/pull/8892) ([Guillaume Tassery](https://github.com/YiuRULE))
- 修复了变更完成问题,已完成的变更可能具有 `is_done=0` 状态。 [#9217](https://github.com/ClickHouse/ClickHouse/pull/9217) ([alesapin](https://github.com/alesapin))
- 防止对使用旧语法的 MergeTree 表执行 `ALTER ADD INDEX`,因为它不起作用。 [#8822](https://github.com/ClickHouse/ClickHouse/pull/8822) ([Mikhail Korotov](https://github.com/millb))
- 在服务器启动期间不访问 `LIVE VIEW` 依赖的表,以便服务器能够启动。同时在分离 `LIVE VIEW` 时删除 `LIVE VIEW` 依赖项。`LIVE VIEW` 是一个实验性功能。 [#8824](https://github.com/ClickHouse/ClickHouse/pull/8824) ([tavplubix](https://github.com/tavplubix))
- 修复了执行 `PREWHERE` 时 `MergeTreeRangeReader` 中可能的段错误。 [#9106](https://github.com/ClickHouse/ClickHouse/pull/9106) ([Anton Popov](https://github.com/CurtizJ))
- 修复了列 TTL 可能的校验和不匹配。 [#9451](https://github.com/ClickHouse/ClickHouse/pull/9451) ([Anton Popov](https://github.com/CurtizJ))
- 修复了当只有一个卷时,TTL 规则不会在后台移动部分的错误。 [#8672](https://github.com/ClickHouse/ClickHouse/pull/8672) ([Vladimir Chebotarev](https://github.com/excitoon))
- 修复了 `Method createColumn() is not implemented for data type Set` 问题。此修复解决了 [#7799](https://github.com/ClickHouse/ClickHouse/issues/7799). [#8674](https://github.com/ClickHouse/ClickHouse/pull/8674) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 现在我们将更频繁地尝试完成变更。 [#9427](https://github.com/ClickHouse/ClickHouse/pull/9427) ([alesapin](https://github.com/alesapin))
- 修复了 `intDiv` 除以负一常量的问题 [#9351](https://github.com/ClickHouse/ClickHouse/pull/9351) ([hcz](https://github.com/hczhcz))
- 修复了 `BlockIO` 中可能的竞态条件。 [#9356](https://github.com/ClickHouse/ClickHouse/pull/9356) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- 修复了尝试使用/删除使用错误参数创建的 `Kafka` 表时导致服务器终止的错误。 [#9513](https://github.com/ClickHouse/ClickHouse/pull/9513) ([filimonov](https://github.com/filimonov))
- 添加了当操作系统为 `timer_create` 函数返回错误结果时的解决方法。 [#8837](https://github.com/ClickHouse/ClickHouse/pull/8837) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了 `min_marks_for_seek` 参数使用中的错误。修复了当 Distributed 表中没有分片键且我们尝试跳过未使用的分片时的错误消息。 [#8908](https://github.com/ClickHouse/ClickHouse/pull/8908) ([Azat Khuzhin](https://github.com/azat))





#### 改进 {#improvement-20}

- 在 `ReplicatedMergeTree*` 引擎系列中基于 mutation 实现 `ALTER MODIFY/DROP` 查询。现在 `ALTERS` 仅在元数据更新阶段阻塞,之后不再阻塞。[#8701](https://github.com/ClickHouse/ClickHouse/pull/8701) ([alesapin](https://github.com/alesapin))
- 添加将 CROSS JOIN 重写为 INNER JOIN 的功能,支持 `WHERE` 子句包含非限定名称。[#9512](https://github.com/ClickHouse/ClickHouse/pull/9512) ([Artem Zuikov](https://github.com/4ertus2))
- 使 `SHOW TABLES` 和 `SHOW DATABASES` 查询支持 `WHERE` 表达式和 `FROM`/`IN` [#9076](https://github.com/ClickHouse/ClickHouse/pull/9076) ([sundyli](https://github.com/sundy-li))
- 添加了 `deduplicate_blocks_in_dependent_materialized_views` 设置。[#9070](https://github.com/ClickHouse/ClickHouse/pull/9070) ([urykhy](https://github.com/urykhy))
- 最近的更改导致 MySQL 客户端开始以十六进制打印二进制字符串,使其不可读 ([#9032](https://github.com/ClickHouse/ClickHouse/issues/9032))。ClickHouse 中的解决方法是将字符串列标记为 UTF-8,虽然并非总是如此,但通常情况下是这样。[#9079](https://github.com/ClickHouse/ClickHouse/pull/9079) ([Yuriy Baranov](https://github.com/yurriy))
- 为 `sumMap` 添加 String 和 FixedString 键的支持 [#8903](https://github.com/ClickHouse/ClickHouse/pull/8903) ([Baudouin Giard](https://github.com/bgiard))
- 在 SummingMergeTree 映射中支持字符串键 [#8933](https://github.com/ClickHouse/ClickHouse/pull/8933) ([Baudouin Giard](https://github.com/bgiard))
- 即使线程抛出异常,也向线程池发送线程终止信号 [#8736](https://github.com/ClickHouse/ClickHouse/pull/8736) ([Ding Xiang Fei](https://github.com/dingxiangfei2009))
- 允许在 `clickhouse-benchmark` 中设置 `query_id` [#9416](https://github.com/ClickHouse/ClickHouse/pull/9416) ([Anton Popov](https://github.com/CurtizJ))
- 不允许在 `ALTER TABLE ... PARTITION partition` 查询中使用异常表达式。这解决了 [#7192](https://github.com/ClickHouse/ClickHouse/issues/7192) [#8835](https://github.com/ClickHouse/ClickHouse/pull/8835) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 表 `system.table_engines` 现在提供有关功能支持的信息(如 `supports_ttl` 或 `supports_sort_order`)。[#8830](https://github.com/ClickHouse/ClickHouse/pull/8830) ([Max Akhmedov](https://github.com/zlobober))
- 默认启用 `system.metric_log`。它将包含以 "collect_interval_milliseconds" 间隔(默认为一秒)收集的 ProfileEvents、CurrentMetrics 值的行。该表非常小(通常为兆字节级别),默认收集这些数据是合理的。[#9225](https://github.com/ClickHouse/ClickHouse/pull/9225) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 为组中的所有线程初始化查询分析器,例如它允许完整分析插入查询。修复 [#6964](https://github.com/ClickHouse/ClickHouse/issues/6964) [#8874](https://github.com/ClickHouse/ClickHouse/pull/8874) ([Ivan](https://github.com/abyss7))
- 现在临时 `LIVE VIEW` 通过 `CREATE LIVE VIEW name WITH TIMEOUT [42] ...` 创建,而不是 `CREATE TEMPORARY LIVE VIEW ...`,因为之前的语法与 `CREATE TEMPORARY TABLE ...` 不一致 [#9131](https://github.com/ClickHouse/ClickHouse/pull/9131) ([tavplubix](https://github.com/tavplubix))
- 添加 text_log.level 配置参数以限制写入 `system.text_log` 表的条目 [#8809](https://github.com/ClickHouse/ClickHouse/pull/8809) ([Azat Khuzhin](https://github.com/azat))
- 允许根据 TTL 规则将下载的数据部分放置到磁盘/卷 [#8598](https://github.com/ClickHouse/ClickHouse/pull/8598) ([Vladimir Chebotarev](https://github.com/excitoon))
- 对于外部 MySQL 字典,允许共享 MySQL 连接池以在字典之间"共享"它们。此选项显著减少了到 MySQL 服务器的连接数。[#9409](https://github.com/ClickHouse/ClickHouse/pull/9409) ([Clément Rodriguez](https://github.com/clemrodriguez))
- 在 `clickhouse-benchmark` 输出中显示分位数的最近查询执行时间,而不是插值。最好显示与某些查询实际执行时间相对应的值。[#8712](https://github.com/ClickHouse/ClickHouse/pull/8712) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 在向 Kafka 插入数据时可以为消息添加键和时间戳。修复 [#7198](https://github.com/ClickHouse/ClickHouse/issues/7198) [#8969](https://github.com/ClickHouse/ClickHouse/pull/8969) ([filimonov](https://github.com/filimonov))
- 如果服务器从终端运行,则用颜色突出显示线程号、查询 ID 和日志优先级。这是为了提高开发人员对相关日志消息的可读性。[#8961](https://github.com/ClickHouse/ClickHouse/pull/8961) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 改进了为 `Ordinary` 数据库加载表时的异常消息。[#9527](https://github.com/ClickHouse/ClickHouse/pull/9527) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 为包含聚合函数状态的数组实现 `arraySlice`。这修复了 [#9388](https://github.com/ClickHouse/ClickHouse/issues/9388) [#9391](https://github.com/ClickHouse/ClickHouse/pull/9391) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 允许在 IN 运算符的右侧使用常量函数和常量数组。[#8813](https://github.com/ClickHouse/ClickHouse/pull/8813) ([Anton Popov](https://github.com/CurtizJ))
- 如果在获取 system.replicas 数据时发生 zookeeper 异常,则在单独的列中显示它。这实现了 [#9137](https://github.com/ClickHouse/ClickHouse/issues/9137) [#9138](https://github.com/ClickHouse/ClickHouse/pull/9138) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 在销毁时原子性地删除 MergeTree 数据部分。[#8402](https://github.com/ClickHouse/ClickHouse/pull/8402) ([Vladimir Chebotarev](https://github.com/excitoon))
- 支持 Distributed 表的行级安全性。[#8926](https://github.com/ClickHouse/ClickHouse/pull/8926) ([Ivan](https://github.com/abyss7))
- 现在我们识别设置值中的后缀(如 KB、KiB...)。[#8072](https://github.com/ClickHouse/ClickHouse/pull/8072) ([Mikhail Korotov](https://github.com/millb))
- 防止在构造大型 JOIN 结果时出现内存不足。[#8637](https://github.com/ClickHouse/ClickHouse/pull/8637) ([Artem Zuikov](https://github.com/4ertus2))
- 在 `clickhouse-client` 的交互模式中向建议添加了集群名称。[#8709](https://github.com/ClickHouse/ClickHouse/pull/8709) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 为组中的所有线程初始化查询分析器,例如它允许完整分析插入查询 [#8820](https://github.com/ClickHouse/ClickHouse/pull/8820) ([Ivan](https://github.com/abyss7))
- 在 `system.query_log` 表中添加了 `exception_code` 列。[#8770](https://github.com/ClickHouse/ClickHouse/pull/8770) ([Mikhail Korotov](https://github.com/millb))
- 在默认服务器配置文件中启用了端口 `9004` 上的 MySQL 兼容性服务器。修复了配置示例中的密码生成命令。[#8771](https://github.com/ClickHouse/ClickHouse/pull/8771) ([Yuriy Baranov](https://github.com/yurriy))
- 如果文件系统为只读,则防止在关闭时中止。这修复了 [#9094](https://github.com/ClickHouse/ClickHouse/issues/9094) [#9100](https://github.com/ClickHouse/ClickHouse/pull/9100) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 改进了 HTTP POST 查询中需要长度时的异常消息。[#9453](https://github.com/ClickHouse/ClickHouse/pull/9453) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 向 `HDFS` 和 `File` 引擎以及 `hdfs` 和 `file` 表函数添加 `_path` 和 `_file` 虚拟列 [#8489](https://github.com/ClickHouse/ClickHouse/pull/8489) ([Olga Khvostikova](https://github.com/stavrolia))
- 修复在向 `MATERIALIZED VIEW` 插入数据时,如果向视图的内部表添加了新列,会出现 `Cannot find column` 错误的问题。[#8766](https://github.com/ClickHouse/ClickHouse/pull/8766) [#8788](https://github.com/ClickHouse/ClickHouse/pull/8788) ([vzakaznikov](https://github.com/vzakaznikov)) [#8788](https://github.com/ClickHouse/ClickHouse/issues/8788) [#8806](https://github.com/ClickHouse/ClickHouse/pull/8806) ([Nikolai Kochetov](https://github.com/KochetovNicolai)) [#8803](https://github.com/ClickHouse/ClickHouse/pull/8803) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- 修复原生客户端-服务器协议上的进度,通过在最终更新后发送进度(如日志)。这可能仅与使用原生协议的某些第三方工具相关。[#9495](https://github.com/ClickHouse/ClickHouse/pull/9495) ([Azat Khuzhin](https://github.com/azat))
- 添加跟踪使用 MySQL 协议的客户端连接数的系统指标 ([#9013](https://github.com/ClickHouse/ClickHouse/issues/9013))。[#9015](https://github.com/ClickHouse/ClickHouse/pull/9015) ([Eugene Klimov](https://github.com/Slach))
- 从现在开始,HTTP 响应将具有 `X-ClickHouse-Timezone` 标头,设置为与 `SELECT timezone()` 报告的相同时区值。[#9493](https://github.com/ClickHouse/ClickHouse/pull/9493) ([Denis Glazachev](https://github.com/traceon))

#### 性能改进 {#performance-improvement-16}

- 改进使用 IN 运算符分析索引的性能 [#9261](https://github.com/ClickHouse/ClickHouse/pull/9261) ([Anton Popov](https://github.com/CurtizJ))
- 简化并优化逻辑函数代码 + 代码清理。这是 [#8718](https://github.com/ClickHouse/ClickHouse/issues/8718) 的后续工作 [#8728](https://github.com/ClickHouse/ClickHouse/pull/8728) ([Alexander Kazakov](https://github.com/Akazz))
- 通过利用 C++20 特性确保更严格的别名规则,实现整体性能改进(受影响查询的性能提升范围为 5%..200%)。[#9304](https://github.com/ClickHouse/ClickHouse/pull/9304) ([Amos Bird](https://github.com/amosbird))
- 为比较函数的内部循环应用更严格的别名规则。[#9327](https://github.com/ClickHouse/ClickHouse/pull/9327) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 为算术函数的内部循环应用更严格的别名规则。[#9325](https://github.com/ClickHouse/ClickHouse/pull/9325) ([alexey-milovidov](https://github.com/alexey-milovidov))
- ColumnVector::replicate() 的实现速度提升约 3 倍,ColumnConst::convertToFullColumn() 通过该方法实现。在测试中物化常量时也很有用。[#9293](https://github.com/ClickHouse/ClickHouse/pull/9293) ([Alexander Kazakov](https://github.com/Akazz))
- 对 `ColumnVector::replicate()` 的另一项小幅性能改进(这加快了 `materialize` 函数和高阶函数的速度),是对 [#9293](https://github.com/ClickHouse/ClickHouse/issues/9293) 的进一步改进 [#9442](https://github.com/ClickHouse/ClickHouse/pull/9442) ([Alexander Kazakov](https://github.com/Akazz))
- 改进 `stochasticLinearRegression` 聚合函数的性能。此补丁由 Intel 贡献。[#8652](https://github.com/ClickHouse/ClickHouse/pull/8652) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 改进 `reinterpretAsFixedString` 函数的性能。[#9342](https://github.com/ClickHouse/ClickHouse/pull/9342) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 在处理器管道中,对于 `Null` 格式不向客户端发送数据块。[#8797](https://github.com/ClickHouse/ClickHouse/pull/8797) ([Nikolai Kochetov](https://github.com/KochetovNicolai)) [#8767](https://github.com/ClickHouse/ClickHouse/pull/8767) ([Alexander Kuzmenkov](https://github.com/akuzm))


#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-20}

- 异常处理现在可以在 Windows Subsystem for Linux 上正常工作。参见 https://github.com/ClickHouse-Extras/libunwind/pull/3 这修复了 [#6480](https://github.com/ClickHouse/ClickHouse/issues/6480) [#9564](https://github.com/ClickHouse/ClickHouse/pull/9564) ([sobolevsv](https://github.com/sobolevsv))
- 在 `clickhouse-client` 中使用 `replxx` 替换 `readline` 以实现交互式行编辑 [#8416](https://github.com/ClickHouse/ClickHouse/pull/8416) ([Ivan](https://github.com/abyss7))
- 改进了 FunctionsComparison 的构建时间并减少了模板实例化。[#9324](https://github.com/ClickHouse/ClickHouse/pull/9324) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 在 CI 中添加了与 `clang-tidy` 的集成。另请参见 [#6044](https://github.com/ClickHouse/ClickHouse/issues/6044) [#9566](https://github.com/ClickHouse/ClickHouse/pull/9566) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 现在我们在 CI 中使用 `lld` 链接 ClickHouse,即使对于 `gcc` 也是如此。[#9049](https://github.com/ClickHouse/ClickHouse/pull/9049) ([alesapin](https://github.com/alesapin))
- 当设置 `THREAD_FUZZER_*` 环境变量时,允许随机化线程调度并插入故障。这有助于测试。[#9459](https://github.com/ClickHouse/ClickHouse/pull/9459) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 在无状态测试中启用安全套接字 [#9288](https://github.com/ClickHouse/ClickHouse/pull/9288) ([tavplubix](https://github.com/tavplubix))
- 使 SPLIT_SHARED_LIBRARIES=OFF 更加健壮 [#9156](https://github.com/ClickHouse/ClickHouse/pull/9156) ([Azat Khuzhin](https://github.com/azat))
- 使 "performance_introspection_and_logging" 测试在服务器随机卡住时保持可靠。这可能在 CI 环境中发生。另请参见 [#9515](https://github.com/ClickHouse/ClickHouse/issues/9515) [#9528](https://github.com/ClickHouse/ClickHouse/pull/9528) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 在样式检查中验证 XML。[#9550](https://github.com/ClickHouse/ClickHouse/pull/9550) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了测试 `00738_lock_for_inner_table` 中的竞态条件。该测试依赖于 sleep。[#9555](https://github.com/ClickHouse/ClickHouse/pull/9555) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 移除类型为 `once` 的性能测试。这是为了在统计比较模式下运行所有性能测试(更可靠)。[#9557](https://github.com/ClickHouse/ClickHouse/pull/9557) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 为算术函数添加了性能测试。[#9326](https://github.com/ClickHouse/ClickHouse/pull/9326) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 为 `sumMap` 和 `sumMapWithOverflow` 聚合函数添加了性能测试。后续跟进 [#8933](https://github.com/ClickHouse/ClickHouse/issues/8933) [#8947](https://github.com/ClickHouse/ClickHouse/pull/8947) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 通过样式检查确保 ErrorCodes 的样式。[#9370](https://github.com/ClickHouse/ClickHouse/pull/9370) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 添加测试历史记录脚本。[#8796](https://github.com/ClickHouse/ClickHouse/pull/8796) ([alesapin](https://github.com/alesapin))
- 添加 GCC 警告 `-Wsuggest-override` 以定位并修复所有必须使用 `override` 关键字的位置。[#8760](https://github.com/ClickHouse/ClickHouse/pull/8760) ([kreuzerkrieg](https://github.com/kreuzerkrieg))
- 在 Mac OS X 下忽略弱符号,因为它必须被定义 [#9538](https://github.com/ClickHouse/ClickHouse/pull/9538) ([Deleted user](https://github.com/ghost))
- 规范化性能测试中某些查询的运行时间。这是为了在比较模式下运行所有性能测试而做的准备。[#9565](https://github.com/ClickHouse/ClickHouse/pull/9565) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复一些测试以支持使用 pytest 进行查询测试 [#9062](https://github.com/ClickHouse/ClickHouse/pull/9062) ([Ivan](https://github.com/abyss7))
- 在使用 MSan 的构建中启用 SSL,以便在运行无状态测试时服务器不会在启动时失败 [#9531](https://github.com/ClickHouse/ClickHouse/pull/9531) ([tavplubix](https://github.com/tavplubix))
- 修复测试结果中的数据库替换 [#9384](https://github.com/ClickHouse/ClickHouse/pull/9384) ([Ilya Yatsishin](https://github.com/qoega))
- 针对各种平台的构建修复 [#9381](https://github.com/ClickHouse/ClickHouse/pull/9381) ([proller](https://github.com/proller)) [#8755](https://github.com/ClickHouse/ClickHouse/pull/8755) ([proller](https://github.com/proller)) [#8631](https://github.com/ClickHouse/ClickHouse/pull/8631) ([proller](https://github.com/proller))
- 在 stateless-with-coverage 测试 docker 镜像中添加了磁盘部分 [#9213](https://github.com/ClickHouse/ClickHouse/pull/9213) ([Pavel Kovalenko](https://github.com/Jokser))
- 在使用 GRPC 构建时去除源代码树中的文件 [#9588](https://github.com/ClickHouse/ClickHouse/pull/9588) ([Amos Bird](https://github.com/amosbird))
- 通过从 Context 中移除 SessionCleaner 来略微加快构建时间。使 SessionCleaner 的代码更简单。[#9232](https://github.com/ClickHouse/ClickHouse/pull/9232) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 更新了 clickhouse-test 脚本中对挂起查询的检查 [#8858](https://github.com/ClickHouse/ClickHouse/pull/8858) ([Alexander Kazakov](https://github.com/Akazz))
- 从仓库中移除了一些无用的文件。[#8843](https://github.com/ClickHouse/ClickHouse/pull/8843) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 将数学性能测试的类型从 `once` 更改为 `loop`。[#8783](https://github.com/ClickHouse/ClickHouse/pull/8783) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- 添加 docker 镜像,允许为我们的代码库构建交互式代码浏览器 HTML 报告。[#8781](https://github.com/ClickHouse/ClickHouse/pull/8781) ([alesapin](https://github.com/alesapin)) 参见 [Woboq Code Browser](https://clickhouse-test-reports.s3.yandex.net/codebrowser/ClickHouse/dbms/index.html)
- 抑制 MSan 下的一些测试失败。[#8780](https://github.com/ClickHouse/ClickHouse/pull/8780) ([Alexander Kuzmenkov](https://github.com/akuzm))
- 加速 "exception while insert" 测试。该测试在 debug-with-coverage 构建中经常超时。[#8711](https://github.com/ClickHouse/ClickHouse/pull/8711) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 将 `libcxx` 和 `libcxxabi` 更新到 master。为 [#9304](https://github.com/ClickHouse/ClickHouse/issues/9304) 做准备 [#9308](https://github.com/ClickHouse/ClickHouse/pull/9308) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复不稳定的测试 `00910_zookeeper_test_alter_compression_codecs`。[#9525](https://github.com/ClickHouse/ClickHouse/pull/9525) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 清理重复的链接器标志。确保链接器不会查找意外的符号。[#9433](https://github.com/ClickHouse/ClickHouse/pull/9433) ([Amos Bird](https://github.com/amosbird))
- 将 `clickhouse-odbc` 驱动程序添加到测试镜像中。这允许通过其自己的 ODBC 驱动程序测试 ClickHouse 与 ClickHouse 的交互。[#9348](https://github.com/ClickHouse/ClickHouse/pull/9348) ([filimonov](https://github.com/filimonov))
- 修复单元测试中的几个错误。[#9047](https://github.com/ClickHouse/ClickHouse/pull/9047) ([alesapin](https://github.com/alesapin))
- 启用 `-Wmissing-include-dirs` GCC 警告以消除所有不存在的包含 - 主要是由于 CMake 脚本错误 [#8704](https://github.com/ClickHouse/ClickHouse/pull/8704) ([kreuzerkrieg](https://github.com/kreuzerkrieg))
- 描述查询分析器无法工作的原因。这是为 [#9049](https://github.com/ClickHouse/ClickHouse/issues/9049) 准备的 [#9144](https://github.com/ClickHouse/ClickHouse/pull/9144) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 将 OpenSSL 更新到上游 master。修复了 TLS 连接可能失败并显示消息 `OpenSSL SSL_read: error:14094438:SSL routines:ssl3_read_bytes:tlsv1 alert internal error` 和 `SSL Exception: error:2400006E:random number generator::error retrieving entropy` 的问题。该问题存在于 20.1 版本中。[#8956](https://github.com/ClickHouse/ClickHouse/pull/8956) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 更新服务器的 Dockerfile [#8893](https://github.com/ClickHouse/ClickHouse/pull/8893) ([Ilya Mazaev](https://github.com/ne-ray))
- build-gcc-from-sources 脚本中的小修复 [#8774](https://github.com/ClickHouse/ClickHouse/pull/8774) ([Michael Nacharov](https://github.com/mnach))
- 在不使用 `number` 列的性能测试中将 `numbers` 替换为 `zeros`。这将产生更清晰的测试结果。[#9600](https://github.com/ClickHouse/ClickHouse/pull/9600) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- 修复在 Column 构造函数中使用 initializer_list 时的栈溢出问题。[#9367](https://github.com/ClickHouse/ClickHouse/pull/9367) ([Deleted user](https://github.com/ghost))
- 将 librdkafka 升级到 v1.3.0。在 Mac OS X 上启用捆绑的 `rdkafka` 和 `gsasl` 库。[#9000](https://github.com/ClickHouse/ClickHouse/pull/9000) ([Andrew Onyshchuk](https://github.com/oandrew))
- 在 GCC 9.2.0 上的构建修复 [#9306](https://github.com/ClickHouse/ClickHouse/pull/9306) ([vxider](https://github.com/Vxider))





## ClickHouse 版本 v20.1 {#clickhouse-release-v201}

### ClickHouse 版本 v20.1.16.120-stable 2020-60-26 {#clickhouse-release-v20116120-stable-2020-60-26}

#### 错误修复 {#bug-fix-50}

- 修复在 prewhere 条件中使用 `Nullable` 列导致的罕见崩溃。延续 [#11608](https://github.com/ClickHouse/ClickHouse/issues/11608)。[#11869](https://github.com/ClickHouse/ClickHouse/pull/11869) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 禁止在高阶函数内使用 arrayJoin,该用法会导致协议同步中断。此修复关闭 [#3933](https://github.com/ClickHouse/ClickHouse/issues/3933)。[#11846](https://github.com/ClickHouse/ClickHouse/pull/11846) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 修复类似 `SELECT *, xyz.*` 的查询的异常行为,这些查询本应报错却成功执行。[#11753](https://github.com/ClickHouse/ClickHouse/pull/11753) ([hexiaoting](https://github.com/hexiaoting))。
- 修复 Values 输入格式中复杂字面量的错误类型推导导致的 LOGICAL_ERROR。[#11732](https://github.com/ClickHouse/ClickHouse/pull/11732) ([tavplubix](https://github.com/tavplubix))。
- 修复对常量列使用 `ORDER BY ... WITH FILL` 的问题。[#11697](https://github.com/ClickHouse/ClickHouse/pull/11697) ([Anton Popov](https://github.com/CurtizJ))。
- 在与 XDBC 桥接通信时传递正确的超时时间。之前在检查桥接存活状态和接收元信息时未遵守超时设置。[#11690](https://github.com/ClickHouse/ClickHouse/pull/11690) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 添加对带有不区分大小写标志的正则表达式的支持。此修复解决 [#11101](https://github.com/ClickHouse/ClickHouse/issues/11101) 和 [#11506](https://github.com/ClickHouse/ClickHouse/issues/11506)。[#11649](https://github.com/ClickHouse/ClickHouse/pull/11649) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 修复 String 类型的布隆过滤器(数据跳过索引)。[#11638](https://github.com/ClickHouse/ClickHouse/pull/11638) ([Azat Khuzhin](https://github.com/azat))。
- 修复在 prewhere 条件中使用 `Nullable` 列导致的罕见崩溃。(可能与 [#11572](https://github.com/ClickHouse/ClickHouse/issues/11572) 有某种关联)。[#11608](https://github.com/ClickHouse/ClickHouse/pull/11608) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 修复当 exception.code() % 256 = 0 时 clickhouse-client 的错误退出码。[#11601](https://github.com/ClickHouse/ClickHouse/pull/11601) ([filimonov](https://github.com/filimonov))。
- 修复服务器启动时关于 "Mark cache size was lowered" 日志消息中的小错误。此修复关闭 [#11399](https://github.com/ClickHouse/ClickHouse/issues/11399)。[#11589](https://github.com/ClickHouse/ClickHouse/pull/11589) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 现在 clickhouse-server docker 容器在检查服务器存活状态时将优先使用 IPv6。[#11550](https://github.com/ClickHouse/ClickHouse/pull/11550) ([Ivan Starkov](https://github.com/istarkov))。
- 修复在使用 -State 函数进行聚合时中途抛出异常导致的内存泄漏。此修复解决 [#8995](https://github.com/ClickHouse/ClickHouse/issues/8995)。[#11496](https://github.com/ClickHouse/ClickHouse/pull/11496) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 修复将主键包装在函数中并使用 'FINAL' 修饰符和 'ORDER BY' 优化时的使用问题。[#10715](https://github.com/ClickHouse/ClickHouse/pull/10715) ([Anton Popov](https://github.com/CurtizJ))。


### ClickHouse release v20.1.15.109-stable 2020-06-19 {#clickhouse-release-v20115109-stable-2020-06-19}

#### Bug Fix {#bug-fix-51}

- 修复 ALTER 操作期间对结构的过度锁定问题。[#11790](https://github.com/ClickHouse/ClickHouse/pull/11790) ([alesapin](https://github.com/alesapin))。

### ClickHouse release v20.1.14.107-stable 2020-06-11 {#clickhouse-release-v20114107-stable-2020-06-11}

#### Bug Fix {#bug-fix-52}

- 修复在包含 `PREWHERE column in (subquery)` 和 `ARRAY JOIN` 的查询中出现的 `Size of offsets does not match size of column` 错误。[#11580](https://github.com/ClickHouse/ClickHouse/pull/11580) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。

### ClickHouse release v20.1.13.105-stable 2020-06-10 {#clickhouse-release-v20113105-stable-2020-06-10}

#### Bug Fix {#bug-fix-53}


* 修复在启用 `min_bytes_to_use_direct_io`，且 PREWHERE 处于启用状态并使用 SAMPLE 或高线程数时可能出现的错误 `Data compressed with different methods`。修复了 [#11539](https://github.com/ClickHouse/ClickHouse/issues/11539)。[#11540](https://github.com/ClickHouse/ClickHouse/pull/11540)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复编解码器返回的压缩大小。[#11448](https://github.com/ClickHouse/ClickHouse/pull/11448) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复了在列使用带有非字面量参数的压缩 `codec` 时导致的服务器崩溃问题。修复了 [#11365](https://github.com/ClickHouse/ClickHouse/issues/11365)。[#11431](https://github.com/ClickHouse/ClickHouse/pull/11431)（[alesapin](https://github.com/alesapin)）。
* 修复点为 `nan` 时的 `pointInPolygon` 行为。修复了 [#11375](https://github.com/ClickHouse/ClickHouse/issues/11375)。[#11421](https://github.com/ClickHouse/ClickHouse/pull/11421)（[Alexey Ilyukhov](https://github.com/livace)）。
* 修复了在参数超出纬度/经度范围时的 `geohashesInBox` 行为。 [#11403](https://github.com/ClickHouse/ClickHouse/pull/11403) ([Vasily Nemkov](https://github.com/Enmk))。
* 修复了在使用外部排序和 LIMIT 的查询中可能出现的 `Pipeline stuck` 错误。修复了 [#11359](https://github.com/ClickHouse/ClickHouse/issues/11359)。[#11366](https://github.com/ClickHouse/ClickHouse/pull/11366)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复 `quantilesExactWeightedArray` 中的崩溃。 [#11337](https://github.com/ClickHouse/ClickHouse/pull/11337) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 在设置 `parallel_view_processing = 1` 时，使对 `MATERIALIZED VIEW` 的写入重新实现并行处理。修复了 [#10241](https://github.com/ClickHouse/ClickHouse/issues/10241)。[#11330](https://github.com/ClickHouse/ClickHouse/pull/11330) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复当提取的 JSON 中的字符串包含不成对的 &#123; 或 [ 时 `visitParamExtractRaw` 的行为。 [#11318](https://github.com/ClickHouse/ClickHouse/pull/11318) ([Ewout](https://github.com/devwout)).
* 修复 `ThreadPool` 中极少见的竞争条件。 [#11314](https://github.com/ClickHouse/ClickHouse/pull/11314) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复转换过程中可能使用未初始化内存的问题。例如：`SELECT toIntervalSecond(now64())`。 [#11311](https://github.com/ClickHouse/ClickHouse/pull/11311) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了这样一个问题：当表的主键中包含 `Array` 列，且查询使用 `empty` 或 `notEmpty` 函数对该列进行过滤时，索引分析无法生效。此修复对应 [#11286](https://github.com/ClickHouse/ClickHouse/issues/11286)。[#11303](https://github.com/ClickHouse/ClickHouse/pull/11303)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复一个错误：当查询速度估计不准确且查询被 `max_network_bandwidth`、`max_execution_speed` 或 `priority` 设置限流时，`min_execution_speed` 的限制可能不起作用或行为不正确。将 `timeout_before_checking_execution_speed` 的默认值更改为非零值，否则 `min_execution_speed` 和 `max_execution_speed` 设置将不会生效。修复 [#11297](https://github.com/ClickHouse/ClickHouse/issues/11297)。修复 [#5732](https://github.com/ClickHouse/ClickHouse/issues/5732)。修复 [#6228](https://github.com/ClickHouse/ClickHouse/issues/6228)。可用性改进：在 `clickhouse-client` 中避免将异常消息与进度条拼接显示。[#11296](https://github.com/ClickHouse/ClickHouse/pull/11296) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复在读取 Protobuf 格式的格式错误数据时发生的崩溃。修复了 [#5957](https://github.com/ClickHouse/ClickHouse/issues/5957)，[#11203](https://github.com/ClickHouse/ClickHouse/issues/11203)。[#11258](https://github.com/ClickHouse/ClickHouse/pull/11258)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复在高阶函数中，当捕获的参数为 `Array(Array(LowCardinality))` 时可能出现的错误 `Cannot capture column`。[#11185](https://github.com/ClickHouse/ClickHouse/pull/11185)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 如果 `data skipping index` 依赖于在后台合并过程中会被修改的列（对于 `SummingMergeTree`、`AggregatingMergeTree` 以及 `TTL GROUP BY`），则其计算结果会不正确。通过将索引计算移动到合并之后，使索引基于合并后的数据进行计算，已修复此问题。[#11162](https://github.com/ClickHouse/ClickHouse/pull/11162) ([Azat Khuzhin](https://github.com/azat))。
* 如果没有任何内容被最终提交，则在变更完成任务中移除日志记录。 [#11109](https://github.com/ClickHouse/ClickHouse/pull/11109) ([alesapin](https://github.com/alesapin)).
* 修复了 `parseDateTime64BestEffort` 参数解析中的错误。 [#10925](https://github.com/ClickHouse/ClickHouse/issues/10925)。 [#11038](https://github.com/ClickHouse/ClickHouse/pull/11038)（[Vasily Nemkov](https://github.com/Enmk)）。
* 修复方法 `getRawData()` 中错误的原始数据大小。 [#10964](https://github.com/ClickHouse/ClickHouse/pull/10964) ([Igr](https://github.com/ObjatieGroba)).
* 修复 Distributed 表中元组的向后兼容问题。 [#10889](https://github.com/ClickHouse/ClickHouse/pull/10889) ([Anton Popov](https://github.com/CurtizJ)).
* 修复 `StringHashTable` 中在键不存在时出现的 `SIGSEGV`。 [#10870](https://github.com/ClickHouse/ClickHouse/pull/10870) ([Azat Khuzhin](https://github.com/azat)).
* 修复了 `ReplicatedMergeTree` 中的一个错误，该错误可能会导致在某个副本变为非活动状态后，一些带有 `OPTIMIZE` 的 `ALTER` 查询一直挂起，等待该副本。 [#10849](https://github.com/ClickHouse/ClickHouse/pull/10849) ([tavplubix](https://github.com/tavplubix)).
* 在 `Block::sortColumns()` 之后修正列顺序（并添加一个测试，用于展示这会影响某些真实用例——`Buffer` 引擎）。[#10826](https://github.com/ClickHouse/ClickHouse/pull/10826) ([Azat Khuzhin](https://github.com/azat))。
* 修复在未请求对标识符加引号时 `ODBC bridge` 的问题。此更改修复了 [#7984](https://github.com/ClickHouse/ClickHouse/issues/7984)。[#10821](https://github.com/ClickHouse/ClickHouse/pull/10821)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 DateLUT 中 UBSan 和 MSan 的报告。[#10798](https://github.com/ClickHouse/ClickHouse/pull/10798) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* * 在键条件中使用 `src_type` 以进行正确的类型转换。修复了 [#6287](https://github.com/ClickHouse/ClickHouse/issues/6287)。[#10791](https://github.com/ClickHouse/ClickHouse/pull/10791)（[Andrew Onyshchuk](https://github.com/oandrew)）。
* 修复 `parallel_view_processing` 的行为。现在即使发生异常，所有对 `MATERIALIZED VIEW` 的插入操作也都应无一例外地完成。修复了 [#10241](https://github.com/ClickHouse/ClickHouse/issues/10241)。[#10757](https://github.com/ClickHouse/ClickHouse/pull/10757) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复组合器 `-OrNull` 和 `-OrDefault` 在与 `-State` 一起使用时的问题。 [#10741](https://github.com/ClickHouse/ClickHouse/pull/10741) ([hcz](https://github.com/hczhcz)).
* 修复 totals 消失的问题。如果查询包含带有外部 WHERE 条件的 `JOIN` 或子查询，`totals` 可能会被过滤掉。修复了 [#10674](https://github.com/ClickHouse/ClickHouse/issues/10674)。[#10698](https://github.com/ClickHouse/ClickHouse/pull/10698)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在一个查询中多次使用同一集合的 `IN` 运算符的问题。 [#10686](https://github.com/ClickHouse/ClickHouse/pull/10686) ([Anton Popov](https://github.com/CurtizJ)).
* 修正 `AggregateTransform` 构造函数中参数的顺序。[#10667](https://github.com/ClickHouse/ClickHouse/pull/10667) ([palasonic1](https://github.com/palasonic1)).
* 修复在启用 `distributed_aggregation_memory_efficient` 时远程查询无法并行执行的问题。修复了 [#10655](https://github.com/ClickHouse/ClickHouse/issues/10655)。[#10664](https://github.com/ClickHouse/ClickHouse/pull/10664)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复包含 `HAVING` 子句的分布式查询（即需要在发起查询的服务器上进行过滤）的谓词优化（`enable_optimize_predicate_expression=1`）：通过保留表达式的顺序（这就足以修复问题），并强制聚合器优先使用列名而不是索引。修复：[#10613](https://github.com/ClickHouse/ClickHouse/issues/10613)、[#11413](https://github.com/ClickHouse/ClickHouse/issues/11413)。[#10621](https://github.com/ClickHouse/ClickHouse/pull/10621)（[Azat Khuzhin](https://github.com/azat)）。
* 修复错误 `the BloomFilter false positive must be a double number between 0 and 1` [#10551](https://github.com/ClickHouse/ClickHouse/issues/10551)。[#10569](https://github.com/ClickHouse/ClickHouse/pull/10569)（[Winter Zhang](https://github.com/zhang2014)）。
* 修复在执行 `SELECT` 时，当别名列的默认表达式类型与其列类型不一致时的行为。[#10563](https://github.com/ClickHouse/ClickHouse/pull/10563) ([Azat Khuzhin](https://github.com/azat)).
* * 实现了对 `DateTime64` 与 `String` 值之间的比较（与 `DateTime` 的处理方式相同）。 [#10560](https://github.com/ClickHouse/ClickHouse/pull/10560) ([Vasily Nemkov](https://github.com/Enmk)).

### ClickHouse 版本 v20.1.12.86，2020-05-26 {#clickhouse-release-v2011286-2020-05-26}

#### 错误修复 {#bug-fix-54}


* 修复了 20.1 及更早版本之间在两级聚合上的不兼容问题。当在发起节点和远程节点上使用不同版本的 ClickHouse，且 `GROUP BY` 结果集较大并且聚合仅基于单个 `String` 字段进行时，就会出现这种不兼容性。这会导致结果中针对同一个键出现多行未合并的数据。[#10952](https://github.com/ClickHouse/ClickHouse/pull/10952)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在 `SummingMergeTree` 中，`LowCardinality(FixedString)` 键列在合并后可能出现的数据损坏问题。修复了 [#10489](https://github.com/ClickHouse/ClickHouse/issues/10489)。[#10721](https://github.com/ClickHouse/ClickHouse/pull/10721)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在 `readonly=2` 且 `cancel_http_readonly_queries_on_client_close=1` 时，客户端关闭会导致 HTTP 请求卡住的错误。修复了 [#7939](https://github.com/ClickHouse/ClickHouse/issues/7939)、[#7019](https://github.com/ClickHouse/ClickHouse/issues/7019)、[#7736](https://github.com/ClickHouse/ClickHouse/issues/7736)、[#7091](https://github.com/ClickHouse/ClickHouse/issues/7091)。[#10684](https://github.com/ClickHouse/ClickHouse/pull/10684)（[tavplubix](https://github.com/tavplubix)）。
* 修复了一个错误：在执行 `SYSTEM DROP DNS CACHE` 查询时，会同时删除用于检查用户是否被允许从某些 IP 地址连接的缓存。[#10608](https://github.com/ClickHouse/ClickHouse/pull/10608) ([tavplubix](https://github.com/tavplubix))。
* 修复了在 `MATERIALIZED VIEW` 的内部查询中，当该查询包含被依赖表时产生错误标量结果的问题。[#10603](https://github.com/ClickHouse/ClickHouse/pull/10603) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复了这样一种情况：mutation 已处理完所有分片，但仍卡在 `is_done=0` 状态。 [#10526](https://github.com/ClickHouse/ClickHouse/pull/10526) ([alesapin](https://github.com/alesapin)).
* 修复了对于相对于 UTC 具有小数偏移量的时区，在 Unix 纪元起始时发生的溢出问题。该修复解决了 [#9335](https://github.com/ClickHouse/ClickHouse/issues/9335)。[#10513](https://github.com/ClickHouse/ClickHouse/pull/10513)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了 `Distributed` 存储的不正确关闭问题。 [#10491](https://github.com/ClickHouse/ClickHouse/pull/10491) ([Azat Khuzhin](https://github.com/azat)).
* 修复了 `simpleLinearRegression` 在处理大整数时的数值溢出问题。 [#10474](https://github.com/ClickHouse/ClickHouse/pull/10474) ([hcz](https://github.com/hczhcz)).
* 修复了在执行 `ATTACH DATABASE` 失败时删除 `metadata` 目录的问题。 [#10442](https://github.com/ClickHouse/ClickHouse/pull/10442) ([Winter Zhang](https://github.com/zhang2014)).
* 在创建 `BloomFilter` 索引时，增加了对参数数量和类型的校验 [#9623](https://github.com/ClickHouse/ClickHouse/issues/9623)。[#10431](https://github.com/ClickHouse/ClickHouse/pull/10431) ([Winter Zhang](https://github.com/zhang2014))。
* 修复了在查询包含 `ARRAY JOIN`、`ORDER BY` 和 `LIMIT` 时可能返回不完整结果的问题。修复了 [#10226](https://github.com/ClickHouse/ClickHouse/issues/10226)。[#10427](https://github.com/ClickHouse/ClickHouse/pull/10427)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 优先使用 `fallback_to_stale_replicas` 而非 `skip_unavailable_shards`。 [#10422](https://github.com/ClickHouse/ClickHouse/pull/10422) ([Azat Khuzhin](https://github.com/azat))。
* 修复了对 `Array(Tuple(...))` 数据类型的不正确扁平化处理。此更改修复了 [#10259](https://github.com/ClickHouse/ClickHouse/issues/10259)。[#10390](https://github.com/ClickHouse/ClickHouse/pull/10390)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了 `HashTable` 中的不正确行为，该行为会在尝试从缓冲区读取 `HashMap` 时导致编译错误。[#10386](https://github.com/ClickHouse/ClickHouse/pull/10386) ([palasonic1](https://github.com/palasonic1))。
* 修复了在远程查询中可能出现的 `ConcatProcessor` 的 `Pipeline stuck` 错误。[#10381](https://github.com/ClickHouse/ClickHouse/pull/10381)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在使用 `max_rows_to_group_by` 且 `group_by_overflow_mode = 'break'` 时出现的 `Pipeline stuck` 错误。[#10279](https://github.com/ClickHouse/ClickHouse/pull/10279) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了若干错误：在部分数据使用 quorum 插入后又通过某种方式（`DROP PARTITION`、`TTL`）被删除时，可能导致后续的 `INSERT` 卡住，或在执行 `SELECT` 时出现误报异常。本修复对应 [#9946](https://github.com/ClickHouse/ClickHouse/issues/9946)。[#10188](https://github.com/ClickHouse/ClickHouse/pull/10188)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 修复了以下情况下的兼容性问题：远程服务器使用 18.12.17 之前的版本，而发起服务器使用更新版本，并且 `GROUP BY` 同时包含定长键和非定长键，且启用了两级 `GROUP BY` 方法时。 [#3254](https://github.com/ClickHouse/ClickHouse/pull/3254) ([alexey-milovidov](https://github.com/alexey-milovidov)).

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-21}

- 为 clickhouse-server Docker 镜像添加了 CA 证书。[#10476](https://github.com/ClickHouse/ClickHouse/pull/10476) ([filimonov](https://github.com/filimonov))。

### ClickHouse 版本 v20.1.10.70, 2020-04-17 {#clickhouse-release-v2011070-2020-04-17}

#### Bug 修复 {#bug-fix-55}


* 修复一种罕见但可能出现的异常 `Cannot drain connections: cancel first`。 [#10239](https://github.com/ClickHouse/ClickHouse/pull/10239) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复了一个错误：当用户尝试在 `ENGINE = Replicated*` 的表上执行 `ALTER UPDATE/DELETE` 时，ClickHouse 会抛出 `'Unknown function lambda.'` 错误消息。用于检查非确定性函数的逻辑现在已能正确处理 lambda 表达式。[#10237](https://github.com/ClickHouse/ClickHouse/pull/10237)（[Alexander Kazakov](https://github.com/Akazz)）。
* 修复 `parseDateTimeBestEffort` 在处理 RFC-2822 字符串时，当星期几为星期二或星期四的行为。此修复解决了 [#10082](https://github.com/ClickHouse/ClickHouse/issues/10082)。[#10214](https://github.com/ClickHouse/ClickHouse/pull/10214)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `JOIN` 内部常量列名与 `JOIN` 外部常量列名可能发生冲突的问题。 [#10207](https://github.com/ClickHouse/ClickHouse/pull/10207) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 修复了在从 `system.numbers` 或 `system.zeros` 等无限源读取数据时，本应在 `LIMIT` 处停止却可能导致查询无限执行的问题。 [#10206](https://github.com/ClickHouse/ClickHouse/pull/10206) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 在存在 `arrayJoin` 函数的情况下（在某些场景中）修复 move-to-prewhere 优化问题。修复了 [#10092](https://github.com/ClickHouse/ClickHouse/issues/10092)。[#10195](https://github.com/ClickHouse/ClickHouse/pull/10195)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 通过 `allow_nondeterministic_mutations` 设置，新增在变更中放宽对非确定性函数使用限制的功能。[#10186](https://github.com/ClickHouse/ClickHouse/pull/10186) ([filimonov](https://github.com/filimonov))。
* 在向使用 `Distributed` 引擎的表执行 `INSERT` 时，如果结构不匹配则转换数据块。[#10135](https://github.com/ClickHouse/ClickHouse/pull/10135) ([Azat Khuzhin](https://github.com/azat)).
* 修复在向 `Distributed` 表执行 `INSERT` 时，当其结构与底层表不一致时出现的 `SIGSEGV` 问题。 [#10105](https://github.com/ClickHouse/ClickHouse/pull/10105) ([Azat Khuzhin](https://github.com/azat)).
* 修复在包含 `JOIN` 和 `UNION ALL` 的查询中可能出现的行丢失问题。修复了 [#9826](https://github.com/ClickHouse/ClickHouse/issues/9826)、[#10113](https://github.com/ClickHouse/ClickHouse/issues/10113)。[#10099](https://github.com/ClickHouse/ClickHouse/pull/10099)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 为 MySQL Database 引擎添加参数检查，并支持标识符类型参数。 [#10077](https://github.com/ClickHouse/ClickHouse/pull/10077) ([Winter Zhang](https://github.com/zhang2014)).
* 修复从本地 ClickHouse 服务器获取 ClickHouse 字典源时的错误。当字典与数据源的类型不兼容时，该错误可能导致内存损坏。 [#10071](https://github.com/ClickHouse/ClickHouse/pull/10071) ([alesapin](https://github.com/alesapin)).
* 修复错误 `Cannot clone block with columns because block has 0 columns ... While executing GroupingAggregatedTransform`。该问题会在开启 `distributed_aggregation_memory_efficient` 设置，并且分布式查询从不同分片读取不同聚合层级的数据（单层聚合与两层聚合混用）时出现。[#10063](https://github.com/ClickHouse/ClickHouse/pull/10063) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了在对包含尾随零字节的字符串键执行 `GROUP BY` 时可能发生的段错误（[#8636](https://github.com/ClickHouse/ClickHouse/issues/8636)、[#8925](https://github.com/ClickHouse/ClickHouse/issues/8925)）。[#10025](https://github.com/ClickHouse/ClickHouse/pull/10025)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* 修复了一个错误：在对某些数据库执行查询的某个处理阶段中，未能获取到所需的表。修复 [#9699](https://github.com/ClickHouse/ClickHouse/issues/9699)。[#9949](https://github.com/ClickHouse/ClickHouse/pull/9949)（[achulkov2](https://github.com/achulkov2)）。
* 修复在同时使用 `JOIN` 和 `TOTALS` 时出现的 `'Not found column in block'` 错误。修复 [#9839](https://github.com/ClickHouse/ClickHouse/issues/9839)。[#9939](https://github.com/ClickHouse/ClickHouse/pull/9939)（[Artem Zuikov](https://github.com/4ertus2)）。
* 修复了在服务器启动时导致 `ON CLUSTER` DDL 查询卡死的错误。[#9927](https://github.com/ClickHouse/ClickHouse/pull/9927) ([Gagan Arneja](https://github.com/garneja)).
* 修复 Join 表引擎的 `TRUNCATE` 问题（[#9917](https://github.com/ClickHouse/ClickHouse/issues/9917)）。[#9920](https://github.com/ClickHouse/ClickHouse/pull/9920)（[Amos Bird](https://github.com/amosbird)）。
* 修复 `ALTER` 查询中的 `'scalar does not exist'` 错误（[#9878](https://github.com/ClickHouse/ClickHouse/issues/9878)）。[#9904](https://github.com/ClickHouse/ClickHouse/pull/9904)（[Amos Bird](https://github.com/amosbird)）。
* 修复 `ReplicatedMergeTree` 中 `drop` 与 `optimize` 之间的竞态问题。 [#9901](https://github.com/ClickHouse/ClickHouse/pull/9901) ([alesapin](https://github.com/alesapin))。
* 修复了 `ATTACH PART` 中的 `DeleteOnDestroy` 逻辑，该逻辑可能导致已附加的 part 被自动删除，并补充了若干测试。[#9410](https://github.com/ClickHouse/ClickHouse/pull/9410) ([Vladimir Chebotarev](https://github.com/excitoon)).

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-22}

- 修复单元测试 `collapsing_sorted_stream`。[#9367](https://github.com/ClickHouse/ClickHouse/pull/9367) ([Deleted user](https://github.com/ghost))。

### ClickHouse 版本 v20.1.9.54, 2020-03-28 {#clickhouse-release-v201954-2020-03-28}

#### 错误修复 {#bug-fix-56}

- 修复当查询在分布式表上同时使用 `PREWHERE` 和 `WHERE` 且设置 `SET distributed_product_mode = 'local'` 时出现的 `'Different expressions with the same alias'` 错误。[#9871](https://github.com/ClickHouse/ClickHouse/pull/9871) ([Artem Zuikov](https://github.com/4ertus2))。
- 修复具有复合主键的表在执行 mutation 操作时过度消耗内存的问题。此修复解决了 [#9850](https://github.com/ClickHouse/ClickHouse/issues/9850)。[#9860](https://github.com/ClickHouse/ClickHouse/pull/9860) ([alesapin](https://github.com/alesapin))。
- 对于 INSERT 查询,分片现在会将从发起者获取的设置限制在分片的约束范围内,而不是抛出异常。此修复允许向具有不同约束的分片发送 `INSERT` 查询。此更改改进了 [#9447](https://github.com/ClickHouse/ClickHouse/issues/9447) 的修复。[#9852](https://github.com/ClickHouse/ClickHouse/pull/9852) ([Vitaly Baranov](https://github.com/vitlibar))。
- 修复客户端可能出现的 `Got 0 in totals chunk, expected 1` 异常。当包含 `JOIN` 的查询中右连接表的行数为零时会发生此问题。示例:`select * from system.one t1 join system.one t2 on t1.dummy = t2.dummy limit 0 FORMAT TabSeparated;`。修复了 [#9777](https://github.com/ClickHouse/ClickHouse/issues/9777)。[#9823](https://github.com/ClickHouse/ClickHouse/pull/9823) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 修复当类型无法转换时使用 `optimize_skip_unused_shards` 导致的 `SIGSEGV` 问题。[#9804](https://github.com/ClickHouse/ClickHouse/pull/9804) ([Azat Khuzhin](https://github.com/azat))。
- 修复了几种函数参数的时区未正确使用的情况。[#9574](https://github.com/ClickHouse/ClickHouse/pull/9574) ([Vasily Nemkov](https://github.com/Enmk))。

#### 改进 {#improvement-21}

- 从 mutation 操作中移除 `ORDER BY` 阶段,因为我们在单个线程中从单个有序部分读取数据。同时添加检查以确保 mutation 中的行顺序按照排序键顺序排列且此顺序不被破坏。[#9886](https://github.com/ClickHouse/ClickHouse/pull/9886) ([alesapin](https://github.com/alesapin))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-23}

- 清理重复的链接器标志。确保链接器不会查找意外的符号。[#9433](https://github.com/ClickHouse/ClickHouse/pull/9433) ([Amos Bird](https://github.com/amosbird))。

### ClickHouse 版本 v20.1.8.41, 2020-03-20 {#clickhouse-release-v201841-2020-03-20}


#### 错误修复 {#bug-fix-57}

- 修复可能永久出现 `Cannot schedule a task` 错误的问题(由于 `ParallelAggregatingBlockInputStream::Handler::onFinish/onFinishThread` 中未处理的异常)。此修复解决了 [#6833](https://github.com/ClickHouse/ClickHouse/issues/6833)。[#9154](https://github.com/ClickHouse/ClickHouse/pull/9154) ([Azat Khuzhin](https://github.com/azat))
- 修复 `ALTER` 查询(变更)中过度内存消耗的问题。此修复解决了 [#9533](https://github.com/ClickHouse/ClickHouse/issues/9533) 和 [#9670](https://github.com/ClickHouse/ClickHouse/issues/9670)。[#9754](https://github.com/ClickHouse/ClickHouse/pull/9754) ([alesapin](https://github.com/alesapin))
- 修复外部字典 DDL 中反引号的错误。此修复解决了 [#9619](https://github.com/ClickHouse/ClickHouse/issues/9619)。[#9734](https://github.com/ClickHouse/ClickHouse/pull/9734) ([alesapin](https://github.com/alesapin))

### ClickHouse 版本 v20.1.7.38,2020-03-18 {#clickhouse-release-v201738-2020-03-18}


#### 错误修复 {#bug-fix-58}

- 修复了 `sumKahan` 和 `sumWithOverflow` 的内部函数名称错误。该问题会导致在远程查询中使用这些函数时抛出异常。[#9636](https://github.com/ClickHouse/ClickHouse/pull/9636) ([Azat Khuzhin](https://github.com/azat))。此问题存在于所有 ClickHouse 版本中。
- 允许对具有内部复制的 `Distributed` 表执行 `ALTER ON CLUSTER` 操作。这修复了 [#3268](https://github.com/ClickHouse/ClickHouse/issues/3268)。[#9617](https://github.com/ClickHouse/ClickHouse/pull/9617) ([shinoi2](https://github.com/shinoi2))。此问题存在于所有 ClickHouse 版本中。
- 修复了 `MergeTreeRangeReader` 中可能出现的 `Size of filter does not match size of column` 和 `Invalid number of rows in Chunk` 异常。在某些情况下执行 `PREWHERE` 时可能会出现这些异常。修复了 [#9132](https://github.com/ClickHouse/ClickHouse/issues/9132)。[#9612](https://github.com/ClickHouse/ClickHouse/pull/9612) ([Anton Popov](https://github.com/CurtizJ))
- 修复了时区未保留的问题:当编写简单的算术表达式(如 `time + 1`)时,时区不会被保留(与 `time + INTERVAL 1 SECOND` 这样的表达式相反)。这修复了 [#5743](https://github.com/ClickHouse/ClickHouse/issues/5743)。[#9323](https://github.com/ClickHouse/ClickHouse/pull/9323) ([alexey-milovidov](https://github.com/alexey-milovidov))。此问题存在于所有 ClickHouse 版本中。
- 现在无法创建或添加具有简单循环别名的列,例如 `a DEFAULT b, b DEFAULT a`。[#9603](https://github.com/ClickHouse/ClickHouse/pull/9603) ([alesapin](https://github.com/alesapin))
- 修复了 base64 编码值末尾填充可能格式错误的问题。更新了 base64 库。这修复了 [#9491](https://github.com/ClickHouse/ClickHouse/issues/9491),关闭了 [#9492](https://github.com/ClickHouse/ClickHouse/issues/9492) [#9500](https://github.com/ClickHouse/ClickHouse/pull/9500) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了 `Poco::HTTPServer` 销毁时的数据竞争问题。当服务器启动后立即关闭时可能会发生此问题。[#9468](https://github.com/ClickHouse/ClickHouse/pull/9468) ([Anton Popov](https://github.com/CurtizJ))
- 修复了当存在大量与第 n 行相等的行时,`LIMIT n WITH TIES` 可能崩溃或返回错误行数的问题。[#9464](https://github.com/ClickHouse/ClickHouse/pull/9464) ([tavplubix](https://github.com/tavplubix))
- 修复了列 TTL 可能导致校验和不匹配的问题。[#9451](https://github.com/ClickHouse/ClickHouse/pull/9451) ([Anton Popov](https://github.com/CurtizJ))
- 修复了当用户尝试对旧格式的 `MergeTree` 表引擎系列执行 `ALTER MODIFY SETTING` 时发生崩溃的问题。[#9435](https://github.com/ClickHouse/ClickHouse/pull/9435) ([alesapin](https://github.com/alesapin))
- 现在将更频繁地尝试完成变更操作。[#9427](https://github.com/ClickHouse/ClickHouse/pull/9427) ([alesapin](https://github.com/alesapin))
- 修复了在 [#8598](https://github.com/ClickHouse/ClickHouse/issues/8598) 中引入的复制协议不兼容问题。[#9412](https://github.com/ClickHouse/ClickHouse/pull/9412) ([alesapin](https://github.com/alesapin))
- 修复了数组类型的 bloom_filter 索引的 not(has()) 问题。[#9407](https://github.com/ClickHouse/ClickHouse/pull/9407) ([achimbab](https://github.com/achimbab))
- 修复了当 haystack 包含零字节时 `match` 和 `extract` 函数的行为。当 haystack 为常量时,行为是错误的。这修复了 [#9160](https://github.com/ClickHouse/ClickHouse/issues/9160) [#9163](https://github.com/ClickHouse/ClickHouse/pull/9163) ([alexey-milovidov](https://github.com/alexey-milovidov)) [#9345](https://github.com/ClickHouse/ClickHouse/pull/9345) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-24}

- 异常处理现在可以在 Windows Subsystem for Linux 上正常工作。参见 https://github.com/ClickHouse-Extras/libunwind/pull/3 此修复解决了 [#6480](https://github.com/ClickHouse/ClickHouse/issues/6480) [#9564](https://github.com/ClickHouse/ClickHouse/pull/9564) ([sobolevsv](https://github.com/sobolevsv))

### ClickHouse 版本 v20.1.6.30, 2020-03-05 {#clickhouse-release-v201630-2020-03-05}

#### 错误修复 {#bug-fix-59}


* 修复使用 `T64` 编码器压缩时的数据不兼容问题。
  [#9039](https://github.com/ClickHouse/ClickHouse/pull/9039) [(abyss7)](https://github.com/abyss7)
* 修复在单线程从 MergeTree 表读取时的范围顺序问题。修复了 [#8964](https://github.com/ClickHouse/ClickHouse/issues/8964)。
  [#9050](https://github.com/ClickHouse/ClickHouse/pull/9050) [(CurtizJ)](https://github.com/CurtizJ)
* 修复在执行 `PREWHERE` 时 `MergeTreeRangeReader` 中可能出现的段错误，对应修复了 [#9064](https://github.com/ClickHouse/ClickHouse/issues/9064)。
  [#9106](https://github.com/ClickHouse/ClickHouse/pull/9106) [(CurtizJ)](https://github.com/CurtizJ)
* 修复 `reinterpretAsFixedString`，使其返回 `FixedString` 而不是 `String`。
  [#9052](https://github.com/ClickHouse/ClickHouse/pull/9052) [(oandrew)](https://github.com/oandrew)
* 修复返回类型为可空的 `joinGet`。修复了 [#8919](https://github.com/ClickHouse/ClickHouse/issues/8919)
  [#9014](https://github.com/ClickHouse/ClickHouse/pull/9014) [(amosbird)](https://github.com/amosbird)
* 修复模糊测试（fuzz test）以及 `bitTestAll`/`bitTestAny` 函数的不正确行为。
  [#9143](https://github.com/ClickHouse/ClickHouse/pull/9143) [(alexey-milovidov)](https://github.com/alexey-milovidov)
* 修复当 `haystack` 为空（零字节）时 `match` 和 `extract` 函数的行为。当 `haystack` 为常量时，该行为不正确。修复了 [#9160](https://github.com/ClickHouse/ClickHouse/issues/9160)
  [#9163](https://github.com/ClickHouse/ClickHouse/pull/9163) [(alexey-milovidov)](https://github.com/alexey-milovidov)
* 修复了在使用非严格单调函数索引时，反向谓词执行的问题。修复了 [#9034](https://github.com/ClickHouse/ClickHouse/issues/9034)
  [#9223](https://github.com/ClickHouse/ClickHouse/pull/9223) [(Akazz)](https://github.com/Akazz)
* 允许在 `WHERE` 子句中存在 `[NOT] LIKE` 运算符时，将 `CROSS` 重写为 `INNER JOIN`。修复 [#9191](https://github.com/ClickHouse/ClickHouse/issues/9191)
  [#9229](https://github.com/ClickHouse/ClickHouse/pull/9229) [(4ertus2)](https://github.com/4ertus2)
* 允许 Log 引擎表中的首列（或前几列）为别名。
  [#9231](https://github.com/ClickHouse/ClickHouse/pull/9231) [(abyss7)](https://github.com/abyss7)
* 允许在 `IN()` 中使用逗号分隔的联接。修复了 [#7314](https://github.com/ClickHouse/ClickHouse/issues/7314)。
  [#9251](https://github.com/ClickHouse/ClickHouse/pull/9251) [(4ertus2)](https://github.com/4ertus2)
* 改进了 `ALTER MODIFY/ADD` 查询的逻辑。现在不允许在未指定类型的情况下 `ADD` 列，`MODIFY` 默认表达式不会改变列的类型，`MODIFY` 类型也不会丢失默认表达式的值。修复 [#8669](https://github.com/ClickHouse/ClickHouse/issues/8669)。
  [#9227](https://github.com/ClickHouse/ClickHouse/pull/9227)  [(alesapin)](https://github.com/alesapin)
* 修复变更完成逻辑，避免已完成的变更仍然出现状态 `is_done=0` 的情况。
  [#9217](https://github.com/ClickHouse/ClickHouse/pull/9217) [(alesapin)](https://github.com/alesapin)
* 为 system.numbers 和 system.numbers&#95;mt 提供对 “Processors” 管道的支持。同时修复了未正确生效的 `max_execution_time` 设置的问题。
  [#7796](https://github.com/ClickHouse/ClickHouse/pull/7796)  [(KochetovNicolai)](https://github.com/KochetovNicolai)
* 修复 `DictCacheKeysRequestedFound` 指标的错误统计。
  [#9411](https://github.com/ClickHouse/ClickHouse/pull/9411) [(nikitamikhaylov)](https://github.com/nikitamikhaylov)
* 在 `ATTACH PARTITION FROM`、`REPLACE PARTITION`、`MOVE TO TABLE` 中增加了对存储策略的检查，否则在重启后可能导致某个数据分片不可访问，并阻止 ClickHouse 启动。
  [#9383](https://github.com/ClickHouse/ClickHouse/pull/9383) [(excitoon)](https://github.com/excitoon)
* 修复了 `MergeTreeIndexSet` 中的 UBSan 报错。此更改修复了 [#9250](https://github.com/ClickHouse/ClickHouse/issues/9250)
  [#9365](https://github.com/ClickHouse/ClickHouse/pull/9365) [(alexey-milovidov)](https://github.com/alexey-milovidov)
* 修复 `BlockIO` 中可能存在的数据竞争问题。
  [#9356](https://github.com/ClickHouse/ClickHouse/pull/9356) [(KochetovNicolai)](https://github.com/KochetovNicolai)
* 在与 JSON 相关的函数中支持那些无法用 Int64 表示的 `UInt64` 数值。将 `SIMDJSON` 更新到 master 分支。此更改修复了 [#9209](https://github.com/ClickHouse/ClickHouse/issues/9209)
  [#9344](https://github.com/ClickHouse/ClickHouse/pull/9344) [(alexey-milovidov)](https://github.com/alexey-milovidov)
* 修复当数据目录挂载到单独设备时可用空间计算不正确的问题。对于默认磁盘，从 data 子目录计算可用空间。该修复对应 [#7441](https://github.com/ClickHouse/ClickHouse/issues/7441)
  [#9257](https://github.com/ClickHouse/ClickHouse/pull/9257) [(millb)](https://github.com/millb)
* 修复 TLS 连接可能失败并出现以下消息的问题：`OpenSSL SSL_read: error:14094438:SSL routines:ssl3_read_bytes:tlsv1 alert internal error and SSL Exception: error:2400006E:random number generator::error retrieving entropy.` 将 OpenSSL 更新到上游 master 版本。
  [#8956](https://github.com/ClickHouse/ClickHouse/pull/8956) [(alexey-milovidov)](https://github.com/alexey-milovidov)
* 在执行 `CREATE` 查询时，对存储引擎参数中的常量表达式进行折叠。将空的数据库名称替换为当前数据库。修复 [#6508](https://github.com/ClickHouse/ClickHouse/issues/6508)、[#3492](https://github.com/ClickHouse/ClickHouse/issues/3492)。同时修复 ClickHouseDictionarySource 中对本地地址的检查。
  [#9262](https://github.com/ClickHouse/ClickHouse/pull/9262) [(tabplubix)](https://github.com/tavplubix)
* 修复 `StorageMerge` 中的段错误，该错误可能在从 StorageFile 读取时发生。
  [#9387](https://github.com/ClickHouse/ClickHouse/pull/9387) [(tabplubix)](https://github.com/tavplubix)
* 在极少数情况下，当在读取后缀之后但在提交之前发生异常时，避免在 `Kafka` 中丢失数据。修复了 [#9378](https://github.com/ClickHouse/ClickHouse/issues/9378)。相关问题：[#7175](https://github.com/ClickHouse/ClickHouse/issues/7175)
  [#9507](https://github.com/ClickHouse/ClickHouse/pull/9507) [(filimonov)](https://github.com/filimonov)
* 修复了在尝试使用 / 删除以错误参数创建的 `Kafka` 表时会导致服务器终止的错误。修复了 [#9494](https://github.com/ClickHouse/ClickHouse/issues/9494)。合并了 [#9507](https://github.com/ClickHouse/ClickHouse/issues/9507)。
  [#9513](https://github.com/ClickHouse/ClickHouse/pull/9513) [(filimonov)](https://github.com/filimonov)

#### 新功能 {#new-feature-12}

- 添加 `deduplicate_blocks_in_dependent_materialized_views` 选项,用于控制向带有物化视图的表进行幂等插入时的行为。应 Altinity 的特别请求,此新功能已添加到错误修复版本中。
  [#9070](https://github.com/ClickHouse/ClickHouse/pull/9070) [(urykhy)](https://github.com/urykhy)

### ClickHouse 版本 v20.1.2.4, 2020-01-22 {#clickhouse-release-v20124-2020-01-22}

#### 向后不兼容的变更 {#backward-incompatible-change-10}

- 废弃 `merge_tree_uniform_read_distribution` 设置。服务器仍然识别此设置,但已不再生效。[#8308](https://github.com/ClickHouse/ClickHouse/pull/8308) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 将函数 `greatCircleDistance` 的返回类型更改为 `Float32`,因为现在计算结果为 `Float32`。[#7993](https://github.com/ClickHouse/ClickHouse/pull/7993) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 现在要求查询参数以"转义"格式表示。例如,要传递字符串 `a<tab>b`,您必须写成 `a\tb` 或 `a\<tab>b`,在 URL 中相应地写成 `a%5Ctb` 或 `a%5C%09b`。这是为了支持将 NULL 作为 `\N` 传递。此变更修复了 [#7488](https://github.com/ClickHouse/ClickHouse/issues/7488)。[#8517](https://github.com/ClickHouse/ClickHouse/pull/8517) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 默认为 `ReplicatedMergeTree` 启用 `use_minimalistic_part_header_in_zookeeper` 设置。这将显著减少存储在 ZooKeeper 中的数据量。此设置自 19.1 版本起受支持,我们已在多个服务的生产环境中使用超过半年,未遇到任何问题。如果您可能需要降级到 19.1 之前的版本,请禁用此设置。[#6850](https://github.com/ClickHouse/ClickHouse/pull/6850) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 数据跳过索引已可用于生产环境并默认启用。设置 `allow_experimental_data_skipping_indices`、`allow_experimental_cross_to_join_conversion` 和 `allow_experimental_multiple_joins_emulation` 现已废弃且不再生效。[#7974](https://github.com/ClickHouse/ClickHouse/pull/7974) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 为 `StorageJoin` 添加与 `JOIN` 操作一致的新 `ANY JOIN` 逻辑。要在不改变行为的情况下升级,您需要将 `SETTINGS any_join_distinct_right_table_keys = 1` 添加到 Engine Join 表的元数据中,或在升级后重新创建这些表。[#8400](https://github.com/ClickHouse/ClickHouse/pull/8400) ([Artem Zuikov](https://github.com/4ertus2))
- 需要重启服务器以应用日志配置的更改。这是一个临时解决方案,用于避免服务器向已删除的日志文件写入日志的错误(参见 [#8696](https://github.com/ClickHouse/ClickHouse/issues/8696))。[#8707](https://github.com/ClickHouse/ClickHouse/pull/8707) ([Alexander Kuzmenkov](https://github.com/akuzm))


#### 新功能 {#new-feature-13}

- 向 `system.merges` 添加了数据分片路径信息。[#8043](https://github.com/ClickHouse/ClickHouse/pull/8043) ([Vladimir Chebotarev](https://github.com/excitoon))
- 添加了在 `ON CLUSTER` 模式下执行 `SYSTEM RELOAD DICTIONARY` 查询的能力。[#8288](https://github.com/ClickHouse/ClickHouse/pull/8288) ([Guillaume Tassery](https://github.com/YiuRULE))
- 添加了在 `ON CLUSTER` 模式下执行 `CREATE DICTIONARY` 查询的能力。[#8163](https://github.com/ClickHouse/ClickHouse/pull/8163) ([alesapin](https://github.com/alesapin))
- 现在 `users.xml` 中的用户配置可以继承多个配置文件。[#8343](https://github.com/ClickHouse/ClickHouse/pull/8343) ([Mikhail f. Shiryaev](https://github.com/Felixoid))
- 添加了 `system.stack_trace` 表,允许查看所有服务器线程的堆栈跟踪。这对开发人员检查服务器状态很有用。此功能修复了 [#7576](https://github.com/ClickHouse/ClickHouse/issues/7576)。[#8344](https://github.com/ClickHouse/ClickHouse/pull/8344) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 添加了 `DateTime64` 数据类型,支持可配置的亚秒级精度。[#7170](https://github.com/ClickHouse/ClickHouse/pull/7170) ([Vasily Nemkov](https://github.com/Enmk))
- 添加了表函数 `clusterAllReplicas`,允许查询集群中的所有节点。[#8493](https://github.com/ClickHouse/ClickHouse/pull/8493) ([kiran sunkari](https://github.com/kiransunkari))
- 添加了聚合函数 `categoricalInformationValue`,用于计算离散特征的信息值。[#8117](https://github.com/ClickHouse/ClickHouse/pull/8117) ([hcz](https://github.com/hczhcz))
- 通过并行处理加快了 `CSV`、`TSV` 和 `JSONEachRow` 格式数据文件的解析速度。[#7780](https://github.com/ClickHouse/ClickHouse/pull/7780) ([Alexander Kuzmenkov](https://github.com/akuzm))
- 添加了函数 `bankerRound`,执行银行家舍入法。[#8112](https://github.com/ClickHouse/ClickHouse/pull/8112) ([hcz](https://github.com/hczhcz))
- 在嵌入式区域名称字典中支持更多语言:'ru'、'en'、'ua'、'uk'、'by'、'kz'、'tr'、'de'、'uz'、'lv'、'lt'、'et'、'pt'、'he'、'vi'。[#8189](https://github.com/ClickHouse/ClickHouse/pull/8189) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 改进了 `ANY JOIN` 逻辑的一致性。现在 `t1 ANY LEFT JOIN t2` 等同于 `t2 ANY RIGHT JOIN t1`。[#7665](https://github.com/ClickHouse/ClickHouse/pull/7665) ([Artem Zuikov](https://github.com/4ertus2))
- 添加了设置 `any_join_distinct_right_table_keys`,用于启用 `ANY INNER JOIN` 的旧行为。[#7665](https://github.com/ClickHouse/ClickHouse/pull/7665) ([Artem Zuikov](https://github.com/4ertus2))
- 添加了新的 `SEMI` 和 `ANTI JOIN`。旧的 `ANY INNER JOIN` 行为现在作为 `SEMI LEFT JOIN` 提供。[#7665](https://github.com/ClickHouse/ClickHouse/pull/7665) ([Artem Zuikov](https://github.com/4ertus2))
- 为 `File` 引擎和 `file` 表函数添加了 `Distributed` 格式,允许读取由异步插入 `Distributed` 表生成的 `.bin` 文件。[#8535](https://github.com/ClickHouse/ClickHouse/pull/8535) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- 为 `runningAccumulate` 添加了可选的重置列参数,允许为每个新键值重置聚合结果。[#8326](https://github.com/ClickHouse/ClickHouse/pull/8326) ([Sergey Kononenko](https://github.com/kononencheg))
- 添加了将 ClickHouse 用作 Prometheus 端点的能力。[#7900](https://github.com/ClickHouse/ClickHouse/pull/7900) ([vdimir](https://github.com/Vdimir))
- 在 `config.xml` 中添加了 `<remote_url_allow_hosts>` 配置段,用于限制远程表引擎和表函数 `URL`、`S3`、`HDFS` 允许访问的主机。[#7154](https://github.com/ClickHouse/ClickHouse/pull/7154) ([Mikhail Korotov](https://github.com/millb))
- 添加了函数 `greatCircleAngle`,用于计算球面上的角度距离(以度为单位)。[#8105](https://github.com/ClickHouse/ClickHouse/pull/8105) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 更改了地球半径以与 H3 库保持一致。[#8105](https://github.com/ClickHouse/ClickHouse/pull/8105) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 添加了用于输入和输出的 `JSONCompactEachRow` 和 `JSONCompactEachRowWithNamesAndTypes` 格式。[#7841](https://github.com/ClickHouse/ClickHouse/pull/7841) ([Mikhail Korotov](https://github.com/millb))
- 为文件相关的表引擎和表函数(`File`、`S3`、`URL`、`HDFS`)添加了功能,允许根据附加引擎参数或文件扩展名读写 `gzip` 文件。[#7840](https://github.com/ClickHouse/ClickHouse/pull/7840) ([Andrey Bodrov](https://github.com/apbodrov))
- 添加了 `randomASCII(length)` 函数,生成包含随机 [ASCII](https://en.wikipedia.org/wiki/ASCII#Printable_characters) 可打印字符集的字符串。[#8401](https://github.com/ClickHouse/ClickHouse/pull/8401) ([BayoNet](https://github.com/BayoNet))
- 添加了函数 `JSONExtractArrayRaw`,从 `JSON` 字符串中返回未解析的 JSON 数组元素的数组。[#8081](https://github.com/ClickHouse/ClickHouse/pull/8081) ([Oleg Matrokhin](https://github.com/errx))
- 添加了 `arrayZip` 函数,允许将多个长度相等的数组组合成一个元组数组。[#8149](https://github.com/ClickHouse/ClickHouse/pull/8149) ([Winter Zhang](https://github.com/zhang2014))
- 为 `*MergeTree` 表引擎系列添加了根据配置的 `TTL` 表达式在磁盘之间移动数据的能力。[#8140](https://github.com/ClickHouse/ClickHouse/pull/8140) ([Vladimir Chebotarev](https://github.com/excitoon))
- 添加了新的聚合函数 `avgWeighted`,允许计算加权平均值。[#7898](https://github.com/ClickHouse/ClickHouse/pull/7898) ([Andrey Bodrov](https://github.com/apbodrov))
- 现在默认为 `TSV`、`TSKV`、`CSV` 和 `JSONEachRow` 格式启用并行解析。[#7894](https://github.com/ClickHouse/ClickHouse/pull/7894) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- 从 `H3` 库添加了多个地理函数:`h3GetResolution`、`h3EdgeAngle`、`h3EdgeLength`、`h3IsValid` 和 `h3kRing`。[#8034](https://github.com/ClickHouse/ClickHouse/pull/8034) ([Konstantin Malanchev](https://github.com/hombit))
- 在文件相关的存储和表函数中添加了对 brotli(`br`)压缩的支持。此功能修复了 [#8156](https://github.com/ClickHouse/ClickHouse/issues/8156)。[#8526](https://github.com/ClickHouse/ClickHouse/pull/8526) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 为 `SimpleAggregationFunction` 类型添加了 `groupBit*` 函数。[#8485](https://github.com/ClickHouse/ClickHouse/pull/8485) ([Guillaume Tassery](https://github.com/YiuRULE))





#### 错误修复 {#bug-fix-60}

- Fix rename of tables with `Distributed` engine. Fixes issue [#7868](https://github.com/ClickHouse/ClickHouse/issues/7868). [#8306](https://github.com/ClickHouse/ClickHouse/pull/8306) ([tavplubix](https://github.com/tavplubix))
- Now dictionaries support `EXPRESSION` for attributes in arbitrary string in non-ClickHouse SQL dialect. [#8098](https://github.com/ClickHouse/ClickHouse/pull/8098) ([alesapin](https://github.com/alesapin))
- Fix broken `INSERT SELECT FROM mysql(...)` query. This fixes [#8070](https://github.com/ClickHouse/ClickHouse/issues/8070) and [#7960](https://github.com/ClickHouse/ClickHouse/issues/7960). [#8234](https://github.com/ClickHouse/ClickHouse/pull/8234) ([tavplubix](https://github.com/tavplubix))
- Fix error "Mismatch column sizes" when inserting default `Tuple` from `JSONEachRow`. This fixes [#5653](https://github.com/ClickHouse/ClickHouse/issues/5653). [#8606](https://github.com/ClickHouse/ClickHouse/pull/8606) ([tavplubix](https://github.com/tavplubix))
- Now an exception will be thrown in case of using `WITH TIES` alongside `LIMIT BY`. Also add ability to use `TOP` with `LIMIT BY`. This fixes [#7472](https://github.com/ClickHouse/ClickHouse/issues/7472). [#7637](https://github.com/ClickHouse/ClickHouse/pull/7637) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Fix unintendent dependency from fresh glibc version in `clickhouse-odbc-bridge` binary. [#8046](https://github.com/ClickHouse/ClickHouse/pull/8046) ([Amos Bird](https://github.com/amosbird))
- Fix bug in check function of `*MergeTree` engines family. Now it does not fail in case when we have equal amount of rows in last granule and last mark (non-final). [#8047](https://github.com/ClickHouse/ClickHouse/pull/8047) ([alesapin](https://github.com/alesapin))
- Fix insert into `Enum*` columns after `ALTER` query, when underlying numeric type is equal to table specified type. This fixes [#7836](https://github.com/ClickHouse/ClickHouse/issues/7836). [#7908](https://github.com/ClickHouse/ClickHouse/pull/7908) ([Anton Popov](https://github.com/CurtizJ))
- Allowed non-constant negative "size" argument for function `substring`. It was not allowed by mistake. This fixes [#4832](https://github.com/ClickHouse/ClickHouse/issues/4832). [#7703](https://github.com/ClickHouse/ClickHouse/pull/7703) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix parsing bug when wrong number of arguments passed to `(O|J)DBC` table engine. [#7709](https://github.com/ClickHouse/ClickHouse/pull/7709) ([alesapin](https://github.com/alesapin))
- Using command name of the running clickhouse process when sending logs to syslog. In previous versions, empty string was used instead of command name. [#8460](https://github.com/ClickHouse/ClickHouse/pull/8460) ([Michael Nacharov](https://github.com/mnach))
- Fix check of allowed hosts for `localhost`. This PR fixes the solution provided in [#8241](https://github.com/ClickHouse/ClickHouse/pull/8241). [#8342](https://github.com/ClickHouse/ClickHouse/pull/8342) ([Vitaly Baranov](https://github.com/vitlibar))
- Fix rare crash in `argMin` and `argMax` functions for long string arguments, when result is used in `runningAccumulate` function. This fixes [#8325](https://github.com/ClickHouse/ClickHouse/issues/8325) [#8341](https://github.com/ClickHouse/ClickHouse/pull/8341) ([dinosaur](https://github.com/769344359))
- Fix memory overcommit for tables with `Buffer` engine. [#8345](https://github.com/ClickHouse/ClickHouse/pull/8345) ([Azat Khuzhin](https://github.com/azat))
- Fixed potential bug in functions that can take `NULL` as one of the arguments and return non-NULL. [#8196](https://github.com/ClickHouse/ClickHouse/pull/8196) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Better metrics calculations in thread pool for background processes for `MergeTree` table engines. [#8194](https://github.com/ClickHouse/ClickHouse/pull/8194) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix function `IN` inside `WHERE` statement when row-level table filter is present. Fixes [#6687](https://github.com/ClickHouse/ClickHouse/issues/6687) [#8357](https://github.com/ClickHouse/ClickHouse/pull/8357) ([Ivan](https://github.com/abyss7))
- Now an exception is thrown if the integral value is not parsed completely for settings values. [#7678](https://github.com/ClickHouse/ClickHouse/pull/7678) ([Mikhail Korotov](https://github.com/millb))
- Fix exception when aggregate function is used in query to distributed table with more than two local shards. [#8164](https://github.com/ClickHouse/ClickHouse/pull/8164) ([小路](https://github.com/nicelulu))
- Now bloom filter can handle zero length arrays and does not perform redundant calculations. [#8242](https://github.com/ClickHouse/ClickHouse/pull/8242) ([achimbab](https://github.com/achimbab))
- Fixed checking if a client host is allowed by matching the client host to `host_regexp` specified in `users.xml`. [#8241](https://github.com/ClickHouse/ClickHouse/pull/8241) ([Vitaly Baranov](https://github.com/vitlibar))
- Relax ambiguous column check that leads to false positives in multiple `JOIN ON` section. [#8385](https://github.com/ClickHouse/ClickHouse/pull/8385) ([Artem Zuikov](https://github.com/4ertus2))
- Fixed possible server crash (`std::terminate`) when the server cannot send or write data in `JSON` or `XML` format with values of `String` data type (that require `UTF-8` validation) or when compressing result data with Brotli algorithm or in some other rare cases. This fixes [#7603](https://github.com/ClickHouse/ClickHouse/issues/7603) [#8384](https://github.com/ClickHouse/ClickHouse/pull/8384) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix race condition in `StorageDistributedDirectoryMonitor` found by CI. This fixes [#8364](https://github.com/ClickHouse/ClickHouse/issues/8364). [#8383](https://github.com/ClickHouse/ClickHouse/pull/8383) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Now background merges in `*MergeTree` table engines family preserve storage policy volume order more accurately. [#8549](https://github.com/ClickHouse/ClickHouse/pull/8549) ([Vladimir Chebotarev](https://github.com/excitoon))
- Now table engine `Kafka` works properly with `Native` format. This fixes [#6731](https://github.com/ClickHouse/ClickHouse/issues/6731) [#7337](https://github.com/ClickHouse/ClickHouse/issues/7337) [#8003](https://github.com/ClickHouse/ClickHouse/issues/8003). [#8016](https://github.com/ClickHouse/ClickHouse/pull/8016) ([filimonov](https://github.com/filimonov))
- Fixed formats with headers (like `CSVWithNames`) which were throwing exception about EOF for table engine `Kafka`. [#8016](https://github.com/ClickHouse/ClickHouse/pull/8016) ([filimonov](https://github.com/filimonov))
- Fixed a bug with making set from subquery in right part of `IN` section. This fixes [#5767](https://github.com/ClickHouse/ClickHouse/issues/5767) and [#2542](https://github.com/ClickHouse/ClickHouse/issues/2542). [#7755](https://github.com/ClickHouse/ClickHouse/pull/7755) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Fix possible crash while reading from storage `File`. [#7756](https://github.com/ClickHouse/ClickHouse/pull/7756) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed reading of the files in `Parquet` format containing columns of type `list`. [#8334](https://github.com/ClickHouse/ClickHouse/pull/8334) ([maxulan](https://github.com/maxulan))
- Fix error `Not found column` for distributed queries with `PREWHERE` condition dependent on sampling key if `max_parallel_replicas > 1`. [#7913](https://github.com/ClickHouse/ClickHouse/pull/7913) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix error `Not found column` if query used `PREWHERE` dependent on table's alias and the result set was empty because of primary key condition. [#7911](https://github.com/ClickHouse/ClickHouse/pull/7911) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed return type for functions `rand` and `randConstant` in case of `Nullable` argument. Now functions always return `UInt32` and never `Nullable(UInt32)`. [#8204](https://github.com/ClickHouse/ClickHouse/pull/8204) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Disabled predicate push-down for `WITH FILL` expression. This fixes [#7784](https://github.com/ClickHouse/ClickHouse/issues/7784). [#7789](https://github.com/ClickHouse/ClickHouse/pull/7789) ([Winter Zhang](https://github.com/zhang2014))
- Fixed incorrect `count()` result for `SummingMergeTree` when `FINAL` section is used. [#3280](https://github.com/ClickHouse/ClickHouse/issues/3280) [#7786](https://github.com/ClickHouse/ClickHouse/pull/7786) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Fix possible incorrect result for constant functions from remote servers. It happened for queries with functions like `version()`, `uptime()`, etc. which returns different constant values for different servers. This fixes [#7666](https://github.com/ClickHouse/ClickHouse/issues/7666). [#7689](https://github.com/ClickHouse/ClickHouse/pull/7689) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix complicated bug in push-down predicate optimization which leads to wrong results. This fixes a lot of issues on push-down predicate optimization. [#8503](https://github.com/ClickHouse/ClickHouse/pull/8503) ([Winter Zhang](https://github.com/zhang2014))
- Fix crash in `CREATE TABLE .. AS dictionary` query. [#8508](https://github.com/ClickHouse/ClickHouse/pull/8508) ([Azat Khuzhin](https://github.com/azat))
- Several improvements ClickHouse grammar in `.g4` file. [#8294](https://github.com/ClickHouse/ClickHouse/pull/8294) ([taiyang-li](https://github.com/taiyang-li))
- Fix bug that leads to crashes in `JOIN`s with tables with engine `Join`. This fixes [#7556](https://github.com/ClickHouse/ClickHouse/issues/7556) [#8254](https://github.com/ClickHouse/ClickHouse/issues/8254) [#7915](https://github.com/ClickHouse/ClickHouse/issues/7915) [#8100](https://github.com/ClickHouse/ClickHouse/issues/8100). [#8298](https://github.com/ClickHouse/ClickHouse/pull/8298) ([Artem Zuikov](https://github.com/4ertus2))
- Fix redundant dictionaries reload on `CREATE DATABASE`. [#7916](https://github.com/ClickHouse/ClickHouse/pull/7916) ([Azat Khuzhin](https://github.com/azat))
- Limit maximum number of streams for read from `StorageFile` and `StorageHDFS`. Fixes [#7650](https://github.com/ClickHouse/ClickHouse/issues/7650). [#7981](https://github.com/ClickHouse/ClickHouse/pull/7981) ([alesapin](https://github.com/alesapin))
- Fix bug in `ALTER ... MODIFY ... CODEC` query, when user specify both default expression and codec. Fixes [8593](https://github.com/ClickHouse/ClickHouse/issues/8593). [#8614](https://github.com/ClickHouse/ClickHouse/pull/8614) ([alesapin](https://github.com/alesapin))
- Fix error in background merge of columns with `SimpleAggregateFunction(LowCardinality)` type. [#8613](https://github.com/ClickHouse/ClickHouse/pull/8613) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed type check in function `toDateTime64`. [#8375](https://github.com/ClickHouse/ClickHouse/pull/8375) ([Vasily Nemkov](https://github.com/Enmk))
- Now server do not crash on `LEFT` or `FULL JOIN` with and Join engine and unsupported `join_use_nulls` settings. [#8479](https://github.com/ClickHouse/ClickHouse/pull/8479) ([Artem Zuikov](https://github.com/4ertus2))
- Now `DROP DICTIONARY IF EXISTS db.dict` query does not throw exception if `db` does not exist. [#8185](https://github.com/ClickHouse/ClickHouse/pull/8185) ([Vitaly Baranov](https://github.com/vitlibar))
- Fix possible crashes in table functions (`file`, `mysql`, `remote`) caused by usage of reference to removed `IStorage` object. Fix incorrect parsing of columns specified at insertion into table function. [#7762](https://github.com/ClickHouse/ClickHouse/pull/7762) ([tavplubix](https://github.com/tavplubix))
- Ensure network be up before starting `clickhouse-server`. This fixes [#7507](https://github.com/ClickHouse/ClickHouse/issues/7507). [#8570](https://github.com/ClickHouse/ClickHouse/pull/8570) ([Zhichang Yu](https://github.com/yuzhichang))
- Fix timeouts handling for secure connections, so queries does not hang indefenitely. This fixes [#8126](https://github.com/ClickHouse/ClickHouse/issues/8126). [#8128](https://github.com/ClickHouse/ClickHouse/pull/8128) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix `clickhouse-copier`'s redundant contention between concurrent workers. [#7816](https://github.com/ClickHouse/ClickHouse/pull/7816) ([Ding Xiang Fei](https://github.com/dingxiangfei2009))
- Now mutations does not skip attached parts, even if their mutation version were larger than current mutation version. [#7812](https://github.com/ClickHouse/ClickHouse/pull/7812) ([Zhichang Yu](https://github.com/yuzhichang)) [#8250](https://github.com/ClickHouse/ClickHouse/pull/8250) ([alesapin](https://github.com/alesapin))
- Ignore redundant copies of `*MergeTree` data parts after move to another disk and server restart. [#7810](https://github.com/ClickHouse/ClickHouse/pull/7810) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix crash in `FULL JOIN` with `LowCardinality` in `JOIN` key. [#8252](https://github.com/ClickHouse/ClickHouse/pull/8252) ([Artem Zuikov](https://github.com/4ertus2))
- Forbidden to use column name more than once in insert query like `INSERT INTO tbl (x, y, x)`. This fixes [#5465](https://github.com/ClickHouse/ClickHouse/issues/5465), [#7681](https://github.com/ClickHouse/ClickHouse/issues/7681). [#7685](https://github.com/ClickHouse/ClickHouse/pull/7685) ([alesapin](https://github.com/alesapin))
- Added fallback for detection the number of physical CPU cores for unknown CPUs (using the number of logical CPU cores). This fixes [#5239](https://github.com/ClickHouse/ClickHouse/issues/5239). [#7726](https://github.com/ClickHouse/ClickHouse/pull/7726) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix `There's no column` error for materialized and alias columns. [#8210](https://github.com/ClickHouse/ClickHouse/pull/8210) ([Artem Zuikov](https://github.com/4ertus2))
- Fixed sever crash when `EXISTS` query was used without `TABLE` or `DICTIONARY` qualifier. Just like `EXISTS t`. This fixes [#8172](https://github.com/ClickHouse/ClickHouse/issues/8172). This bug was introduced in version 19.17. [#8213](https://github.com/ClickHouse/ClickHouse/pull/8213) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix rare bug with error `"Sizes of columns does not match"` that might appear when using `SimpleAggregateFunction` column. [#7790](https://github.com/ClickHouse/ClickHouse/pull/7790) ([Boris Granveaud](https://github.com/bgranvea))
- Fix bug where user with empty `allow_databases` got access to all databases (and same for `allow_dictionaries`). [#7793](https://github.com/ClickHouse/ClickHouse/pull/7793) ([DeifyTheGod](https://github.com/DeifyTheGod))
- Fix client crash when server already disconnected from client. [#8071](https://github.com/ClickHouse/ClickHouse/pull/8071) ([Azat Khuzhin](https://github.com/azat))
- Fix `ORDER BY` behaviour in case of sorting by primary key prefix and non primary key suffix. [#7759](https://github.com/ClickHouse/ClickHouse/pull/7759) ([Anton Popov](https://github.com/CurtizJ))
- Check if qualified column present in the table. This fixes [#6836](https://github.com/ClickHouse/ClickHouse/issues/6836). [#7758](https://github.com/ClickHouse/ClickHouse/pull/7758) ([Artem Zuikov](https://github.com/4ertus2))
- Fixed behavior with `ALTER MOVE` ran immediately after merge finish moves superpart of specified. Fixes [#8103](https://github.com/ClickHouse/ClickHouse/issues/8103). [#8104](https://github.com/ClickHouse/ClickHouse/pull/8104) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix possible server crash while using `UNION` with different number of columns. Fixes [#7279](https://github.com/ClickHouse/ClickHouse/issues/7279). [#7929](https://github.com/ClickHouse/ClickHouse/pull/7929) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix size of result substring for function `substr` with negative size. [#8589](https://github.com/ClickHouse/ClickHouse/pull/8589) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Now server does not execute part mutation in `MergeTree` if there are not enough free threads in background pool. [#8588](https://github.com/ClickHouse/ClickHouse/pull/8588) ([tavplubix](https://github.com/tavplubix))
- Fix a minor typo on formatting `UNION ALL` AST. [#7999](https://github.com/ClickHouse/ClickHouse/pull/7999) ([litao91](https://github.com/litao91))
- Fixed incorrect bloom filter results for negative numbers. This fixes [#8317](https://github.com/ClickHouse/ClickHouse/issues/8317). [#8566](https://github.com/ClickHouse/ClickHouse/pull/8566) ([Winter Zhang](https://github.com/zhang2014))
- Fixed potential buffer overflow in decompress. Malicious user can pass fabricated compressed data that will cause read after buffer. This issue was found by Eldar Zaitov from Yandex information security team. [#8404](https://github.com/ClickHouse/ClickHouse/pull/8404) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix incorrect result because of integers overflow in `arrayIntersect`. [#7777](https://github.com/ClickHouse/ClickHouse/pull/7777) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Now `OPTIMIZE TABLE` query will not wait for offline replicas to perform the operation. [#8314](https://github.com/ClickHouse/ClickHouse/pull/8314) ([javi santana](https://github.com/javisantana))
- Fixed `ALTER TTL` parser for `Replicated*MergeTree` tables. [#8318](https://github.com/ClickHouse/ClickHouse/pull/8318) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix communication between server and client, so server read temporary tables info after query failure. [#8084](https://github.com/ClickHouse/ClickHouse/pull/8084) ([Azat Khuzhin](https://github.com/azat))
- Fix `bitmapAnd` function error when intersecting an aggregated bitmap and a scalar bitmap. [#8082](https://github.com/ClickHouse/ClickHouse/pull/8082) ([Yue Huang](https://github.com/moon03432))
- Refine the definition of `ZXid` according to the ZooKeeper Programmer's Guide which fixes bug in `clickhouse-cluster-copier`. [#8088](https://github.com/ClickHouse/ClickHouse/pull/8088) ([Ding Xiang Fei](https://github.com/dingxiangfei2009))
- `odbc` table function now respects `external_table_functions_use_nulls` setting. [#7506](https://github.com/ClickHouse/ClickHouse/pull/7506) ([Vasily Nemkov](https://github.com/Enmk))
- Fixed bug that lead to a rare data race. [#8143](https://github.com/ClickHouse/ClickHouse/pull/8143) ([Alexander Kazakov](https://github.com/Akazz))
- Now `SYSTEM RELOAD DICTIONARY` reloads a dictionary completely, ignoring `update_field`. This fixes [#7440](https://github.com/ClickHouse/ClickHouse/issues/7440). [#8037](https://github.com/ClickHouse/ClickHouse/pull/8037) ([Vitaly Baranov](https://github.com/vitlibar))
- Add ability to check if dictionary exists in create query. [#8032](https://github.com/ClickHouse/ClickHouse/pull/8032) ([alesapin](https://github.com/alesapin))
- Fix `Float*` parsing in `Values` format. This fixes [#7817](https://github.com/ClickHouse/ClickHouse/issues/7817). [#7870](https://github.com/ClickHouse/ClickHouse/pull/7870) ([tavplubix](https://github.com/tavplubix))
- Fix crash when we cannot reserve space in some background operations of `*MergeTree` table engines family. [#7873](https://github.com/ClickHouse/ClickHouse/pull/7873) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix crash of merge operation when table contains `SimpleAggregateFunction(LowCardinality)` column. This fixes [#8515](https://github.com/ClickHouse/ClickHouse/issues/8515). [#8522](https://github.com/ClickHouse/ClickHouse/pull/8522) ([Azat Khuzhin](https://github.com/azat))
- Restore support of all ICU locales and add the ability to apply collations for constant expressions. Also add language name to `system.collations` table. [#8051](https://github.com/ClickHouse/ClickHouse/pull/8051) ([alesapin](https://github.com/alesapin))
- Fix bug when external dictionaries with zero minimal lifetime (`LIFETIME(MIN 0 MAX N)`, `LIFETIME(N)`) don't update in background. [#7983](https://github.com/ClickHouse/ClickHouse/pull/7983) ([alesapin](https://github.com/alesapin))
- Fix crash when external dictionary with ClickHouse source has subquery in query. [#8351](https://github.com/ClickHouse/ClickHouse/pull/8351) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix incorrect parsing of file extension in table with engine `URL`. This fixes [#8157](https://github.com/ClickHouse/ClickHouse/issues/8157). [#8419](https://github.com/ClickHouse/ClickHouse/pull/8419) ([Andrey Bodrov](https://github.com/apbodrov))
- Fix `CHECK TABLE` query for `*MergeTree` tables without key. Fixes [#7543](https://github.com/ClickHouse/ClickHouse/issues/7543). [#7979](https://github.com/ClickHouse/ClickHouse/pull/7979) ([alesapin](https://github.com/alesapin))
- Fixed conversion of `Float64` to MySQL type. [#8079](https://github.com/ClickHouse/ClickHouse/pull/8079) ([Yuriy Baranov](https://github.com/yurriy))
- Now if table was not completely dropped because of server crash, server will try to restore and load it. [#8176](https://github.com/ClickHouse/ClickHouse/pull/8176) ([tavplubix](https://github.com/tavplubix))
- Fixed crash in table function `file` while inserting into file that does not exist. Now in this case file would be created and then insert would be processed. [#8177](https://github.com/ClickHouse/ClickHouse/pull/8177) ([Olga Khvostikova](https://github.com/stavrolia))
- Fix rare deadlock which can happen when `trace_log` is in enabled. [#7838](https://github.com/ClickHouse/ClickHouse/pull/7838) ([filimonov](https://github.com/filimonov))
- Add ability to work with different types besides `Date` in `RangeHashed` external dictionary created from DDL query. Fixes [7899](https://github.com/ClickHouse/ClickHouse/issues/7899). [#8275](https://github.com/ClickHouse/ClickHouse/pull/8275) ([alesapin](https://github.com/alesapin))
- Fixes crash when `now64()` is called with result of another function. [#8270](https://github.com/ClickHouse/ClickHouse/pull/8270) ([Vasily Nemkov](https://github.com/Enmk))
- Fixed bug with detecting client IP for connections through mysql wire protocol. [#7743](https://github.com/ClickHouse/ClickHouse/pull/7743) ([Dmitry Muzyka](https://github.com/dmitriy-myz))
- Fix empty array handling in `arraySplit` function. This fixes [#7708](https://github.com/ClickHouse/ClickHouse/issues/7708). [#7747](https://github.com/ClickHouse/ClickHouse/pull/7747) ([hcz](https://github.com/hczhcz))
- Fixed the issue when `pid-file` of another running `clickhouse-server` may be deleted. [#8487](https://github.com/ClickHouse/ClickHouse/pull/8487) ([Weiqing Xu](https://github.com/weiqxu))
- Fix dictionary reload if it has `invalidate_query`, which stopped updates and some exception on previous update tries. [#8029](https://github.com/ClickHouse/ClickHouse/pull/8029) ([alesapin](https://github.com/alesapin))
- Fixed error in function `arrayReduce` that may lead to "double free" and error in aggregate function combinator `Resample` that may lead to memory leak. Added aggregate function `aggThrow`. This function can be used for testing purposes. [#8446](https://github.com/ClickHouse/ClickHouse/pull/8446) ([alexey-milovidov](https://github.com/alexey-milovidov))





#### 改进 {#improvement-22}

- Improved logging when working with `S3` table engine. [#8251](https://github.com/ClickHouse/ClickHouse/pull/8251) ([Grigory Pervakov](https://github.com/GrigoryPervakov))
- Printed help message when no arguments are passed when calling `clickhouse-local`. This fixes [#5335](https://github.com/ClickHouse/ClickHouse/issues/5335). [#8230](https://github.com/ClickHouse/ClickHouse/pull/8230) ([Andrey Nagorny](https://github.com/Melancholic))
- Add setting `mutations_sync` which allows to wait `ALTER UPDATE/DELETE` queries synchronously. [#8237](https://github.com/ClickHouse/ClickHouse/pull/8237) ([alesapin](https://github.com/alesapin))
- Allow to set up relative `user_files_path` in `config.xml` (in the way similar to `format_schema_path`). [#7632](https://github.com/ClickHouse/ClickHouse/pull/7632) ([hcz](https://github.com/hczhcz))
- Add exception for illegal types for conversion functions with `-OrZero` postfix. [#7880](https://github.com/ClickHouse/ClickHouse/pull/7880) ([Andrey Konyaev](https://github.com/akonyaev90))
- Simplify format of the header of data sending to a shard in a distributed query. [#8044](https://github.com/ClickHouse/ClickHouse/pull/8044) ([Vitaly Baranov](https://github.com/vitlibar))
- `Live View` table engine refactoring. [#8519](https://github.com/ClickHouse/ClickHouse/pull/8519) ([vzakaznikov](https://github.com/vzakaznikov))
- Add additional checks for external dictionaries created from DDL-queries. [#8127](https://github.com/ClickHouse/ClickHouse/pull/8127) ([alesapin](https://github.com/alesapin))
- Fix error `Column ... already exists` while using `FINAL` and `SAMPLE` together, e.g. `select count() from table final sample 1/2`. Fixes [#5186](https://github.com/ClickHouse/ClickHouse/issues/5186). [#7907](https://github.com/ClickHouse/ClickHouse/pull/7907) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Now table the first argument of `joinGet` function can be table identifier. [#7707](https://github.com/ClickHouse/ClickHouse/pull/7707) ([Amos Bird](https://github.com/amosbird))
- Allow using `MaterializedView` with subqueries above `Kafka` tables. [#8197](https://github.com/ClickHouse/ClickHouse/pull/8197) ([filimonov](https://github.com/filimonov))
- Now background moves between disks run it the seprate thread pool. [#7670](https://github.com/ClickHouse/ClickHouse/pull/7670) ([Vladimir Chebotarev](https://github.com/excitoon))
- `SYSTEM RELOAD DICTIONARY` now executes synchronously. [#8240](https://github.com/ClickHouse/ClickHouse/pull/8240) ([Vitaly Baranov](https://github.com/vitlibar))
- Stack traces now display physical addresses (offsets in object file) instead of virtual memory addresses (where the object file was loaded). That allows the use of `addr2line` when binary is position independent and ASLR is active. This fixes [#8360](https://github.com/ClickHouse/ClickHouse/issues/8360). [#8387](https://github.com/ClickHouse/ClickHouse/pull/8387) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Support new syntax for row-level security filters: `<table name='table_name'>...</table>`. Fixes [#5779](https://github.com/ClickHouse/ClickHouse/issues/5779). [#8381](https://github.com/ClickHouse/ClickHouse/pull/8381) ([Ivan](https://github.com/abyss7))
- Now `cityHash` function can work with `Decimal` and `UUID` types. Fixes [#5184](https://github.com/ClickHouse/ClickHouse/issues/5184). [#7693](https://github.com/ClickHouse/ClickHouse/pull/7693) ([Mikhail Korotov](https://github.com/millb))
- Removed fixed index granularity (it was 1024) from system logs because it's obsolete after implementation of adaptive granularity. [#7698](https://github.com/ClickHouse/ClickHouse/pull/7698) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Enabled MySQL compatibility server when ClickHouse is compiled without SSL. [#7852](https://github.com/ClickHouse/ClickHouse/pull/7852) ([Yuriy Baranov](https://github.com/yurriy))
- Now server checksums distributed batches, which gives more verbose errors in case of corrupted data in batch. [#7914](https://github.com/ClickHouse/ClickHouse/pull/7914) ([Azat Khuzhin](https://github.com/azat))
- Support `DROP DATABASE`, `DETACH TABLE`, `DROP TABLE` and `ATTACH TABLE` for `MySQL` database engine. [#8202](https://github.com/ClickHouse/ClickHouse/pull/8202) ([Winter Zhang](https://github.com/zhang2014))
- Add authentication in S3 table function and table engine. [#7623](https://github.com/ClickHouse/ClickHouse/pull/7623) ([Vladimir Chebotarev](https://github.com/excitoon))
- Added check for extra parts of `MergeTree` at different disks, in order to not allow to miss data parts at undefined disks. [#8118](https://github.com/ClickHouse/ClickHouse/pull/8118) ([Vladimir Chebotarev](https://github.com/excitoon))
- Enable SSL support for Mac client and server. [#8297](https://github.com/ClickHouse/ClickHouse/pull/8297) ([Ivan](https://github.com/abyss7))
- Now ClickHouse can work as MySQL federated server (see https://dev.mysql.com/doc/refman/5.7/en/federated-create-server.html). [#7717](https://github.com/ClickHouse/ClickHouse/pull/7717) ([Maxim Fedotov](https://github.com/MaxFedotov))
- `clickhouse-client` now only enable `bracketed-paste` when multiquery is on and multiline is off. This fixes [#7757](https://github.com/ClickHouse/ClickHouse/issues/7757). [#7761](https://github.com/ClickHouse/ClickHouse/pull/7761) ([Amos Bird](https://github.com/amosbird))
- Support `Array(Decimal)` in `if` function. [#7721](https://github.com/ClickHouse/ClickHouse/pull/7721) ([Artem Zuikov](https://github.com/4ertus2))
- Support Decimals in `arrayDifference`, `arrayCumSum` and `arrayCumSumNegative` functions. [#7724](https://github.com/ClickHouse/ClickHouse/pull/7724) ([Artem Zuikov](https://github.com/4ertus2))
- Added `lifetime` column to `system.dictionaries` table. [#6820](https://github.com/ClickHouse/ClickHouse/issues/6820) [#7727](https://github.com/ClickHouse/ClickHouse/pull/7727) ([kekekekule](https://github.com/kekekekule))
- Improved check for existing parts on different disks for `*MergeTree` table engines. Addresses [#7660](https://github.com/ClickHouse/ClickHouse/issues/7660). [#8440](https://github.com/ClickHouse/ClickHouse/pull/8440) ([Vladimir Chebotarev](https://github.com/excitoon))
- Integration with `AWS SDK` for `S3` interactions which allows to use all S3 features out of the box. [#8011](https://github.com/ClickHouse/ClickHouse/pull/8011) ([Pavel Kovalenko](https://github.com/Jokser))
- Added support for subqueries in `Live View` tables. [#7792](https://github.com/ClickHouse/ClickHouse/pull/7792) ([vzakaznikov](https://github.com/vzakaznikov))
- Check for using `Date` or `DateTime` column from `TTL` expressions was removed. [#7920](https://github.com/ClickHouse/ClickHouse/pull/7920) ([Vladimir Chebotarev](https://github.com/excitoon))
- Information about disk was added to `system.detached_parts` table. [#7833](https://github.com/ClickHouse/ClickHouse/pull/7833) ([Vladimir Chebotarev](https://github.com/excitoon))
- Now settings `max_(table|partition)_size_to_drop` can be changed without a restart. [#7779](https://github.com/ClickHouse/ClickHouse/pull/7779) ([Grigory Pervakov](https://github.com/GrigoryPervakov))
- Slightly better usability of error messages. Ask user not to remove the lines below `Stack trace:`. [#7897](https://github.com/ClickHouse/ClickHouse/pull/7897) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Better reading messages from `Kafka` engine in various formats after [#7935](https://github.com/ClickHouse/ClickHouse/issues/7935). [#8035](https://github.com/ClickHouse/ClickHouse/pull/8035) ([Ivan](https://github.com/abyss7))
- Better compatibility with MySQL clients which don't support `sha2_password` auth plugin. [#8036](https://github.com/ClickHouse/ClickHouse/pull/8036) ([Yuriy Baranov](https://github.com/yurriy))
- Support more column types in MySQL compatibility server. [#7975](https://github.com/ClickHouse/ClickHouse/pull/7975) ([Yuriy Baranov](https://github.com/yurriy))
- Implement `ORDER BY` optimization for `Merge`, `Buffer` and `Materilized View` storages with underlying `MergeTree` tables. [#8130](https://github.com/ClickHouse/ClickHouse/pull/8130) ([Anton Popov](https://github.com/CurtizJ))
- Now we always use POSIX implementation of `getrandom` to have better compatibility with old kernels (< 3.17). [#7940](https://github.com/ClickHouse/ClickHouse/pull/7940) ([Amos Bird](https://github.com/amosbird))
- Better check for valid destination in a move TTL rule. [#8410](https://github.com/ClickHouse/ClickHouse/pull/8410) ([Vladimir Chebotarev](https://github.com/excitoon))
- Better checks for broken insert batches for `Distributed` table engine. [#7933](https://github.com/ClickHouse/ClickHouse/pull/7933) ([Azat Khuzhin](https://github.com/azat))
- Add column with array of parts name which mutations must process in future to `system.mutations` table. [#8179](https://github.com/ClickHouse/ClickHouse/pull/8179) ([alesapin](https://github.com/alesapin))
- Parallel merge sort optimization for processors. [#8552](https://github.com/ClickHouse/ClickHouse/pull/8552) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- The settings `mark_cache_min_lifetime` is now obsolete and does nothing. In previous versions, mark cache can grow in memory larger than `mark_cache_size` to accomodate data within `mark_cache_min_lifetime` seconds. That was leading to confusion and higher memory usage than expected, that is especially bad on memory constrained systems. If you will see performance degradation after installing this release, you should increase the `mark_cache_size`. [#8484](https://github.com/ClickHouse/ClickHouse/pull/8484) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Preparation to use `tid` everywhere. This is needed for [#7477](https://github.com/ClickHouse/ClickHouse/issues/7477). [#8276](https://github.com/ClickHouse/ClickHouse/pull/8276) ([alexey-milovidov](https://github.com/alexey-milovidov))





#### 性能改进 {#performance-improvement-17}

- 优化处理器管道性能。[#7988](https://github.com/ClickHouse/ClickHouse/pull/7988) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- 缓存字典中过期键的非阻塞更新(允许读取旧值)。[#8303](https://github.com/ClickHouse/ClickHouse/pull/8303) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- 编译 ClickHouse 时全局禁用 `-fno-omit-frame-pointer` 以节省一个寄存器。[#8097](https://github.com/ClickHouse/ClickHouse/pull/8097) ([Amos Bird](https://github.com/amosbird))
- 加速 `greatCircleDistance` 函数并添加性能测试。[#7307](https://github.com/ClickHouse/ClickHouse/pull/7307) ([Olga Khvostikova](https://github.com/stavrolia))
- 改进 `roundDown` 函数性能。[#8465](https://github.com/ClickHouse/ClickHouse/pull/8465) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 改进 `DateTime64` 数据类型的 `max`、`min`、`argMin`、`argMax` 函数性能。[#8199](https://github.com/ClickHouse/ClickHouse/pull/8199) ([Vasily Nemkov](https://github.com/Enmk))
- 改进无限制或大限制排序以及外部排序的性能。[#8545](https://github.com/ClickHouse/ClickHouse/pull/8545) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 改进浮点数格式化性能,提升最高达 6 倍。[#8542](https://github.com/ClickHouse/ClickHouse/pull/8542) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 改进 `modulo` 函数性能。[#7750](https://github.com/ClickHouse/ClickHouse/pull/7750) ([Amos Bird](https://github.com/amosbird))
- 优化单列键的 `ORDER BY` 和合并操作。[#8335](https://github.com/ClickHouse/ClickHouse/pull/8335) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 改进 `arrayReduce`、`-Array` 和 `-State` 组合器的实现。[#7710](https://github.com/ClickHouse/ClickHouse/pull/7710) ([Amos Bird](https://github.com/amosbird))
- 优化 `PREWHERE`,使其效率至少与 `WHERE` 相当。[#7769](https://github.com/ClickHouse/ClickHouse/pull/7769) ([Amos Bird](https://github.com/amosbird))
- 改进 `round` 和 `roundBankers` 处理负数的方式。[#8229](https://github.com/ClickHouse/ClickHouse/pull/8229) ([hcz](https://github.com/hczhcz))
- 改进 `DoubleDelta` 和 `Gorilla` 编解码器的解码性能,提升约 30-40%。修复了 [#7082](https://github.com/ClickHouse/ClickHouse/issues/7082)。[#8019](https://github.com/ClickHouse/ClickHouse/pull/8019) ([Vasily Nemkov](https://github.com/Enmk))
- 改进 `base64` 相关函数性能。[#8444](https://github.com/ClickHouse/ClickHouse/pull/8444) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 添加 `geoDistance` 函数。该函数类似于 `greatCircleDistance`,但使用 WGS-84 椭球模型近似值。两个函数性能相近。[#8086](https://github.com/ClickHouse/ClickHouse/pull/8086) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 加快 `Decimal` 数据类型的 `min` 和 `max` 聚合函数。[#8144](https://github.com/ClickHouse/ClickHouse/pull/8144) ([Artem Zuikov](https://github.com/4ertus2))
- 向量化 `arrayReduce` 处理。[#7608](https://github.com/ClickHouse/ClickHouse/pull/7608) ([Amos Bird](https://github.com/amosbird))
- `if` 链现在优化为 `multiIf`。[#8355](https://github.com/ClickHouse/ClickHouse/pull/8355) ([kamalov-ruslan](https://github.com/kamalov-ruslan))
- 修复 19.15 版本中引入的 `Kafka` 表引擎性能回退问题。修复了 [#7261](https://github.com/ClickHouse/ClickHouse/issues/7261)。[#7935](https://github.com/ClickHouse/ClickHouse/pull/7935) ([filimonov](https://github.com/filimonov))
- 移除 Debian 软件包中 `gcc` 偶尔默认启用的 "pie" 代码生成。[#8483](https://github.com/ClickHouse/ClickHouse/pull/8483) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 并行解析数据格式。[#6553](https://github.com/ClickHouse/ClickHouse/pull/6553) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- 默认启用带表达式的 `Values` 优化解析器(`input_format_values_deduce_templates_of_expressions=1`)。[#8231](https://github.com/ClickHouse/ClickHouse/pull/8231) ([tavplubix](https://github.com/tavplubix))





#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-25}

- Build fixes for `ARM` and in minimal mode. [#8304](https://github.com/ClickHouse/ClickHouse/pull/8304) ([proller](https://github.com/proller))
- Add coverage file flush for `clickhouse-server` when std::atexit is not called. Also slightly improved logging in stateless tests with coverage. [#8267](https://github.com/ClickHouse/ClickHouse/pull/8267) ([alesapin](https://github.com/alesapin))
- Update LLVM library in contrib. Avoid using LLVM from OS packages. [#8258](https://github.com/ClickHouse/ClickHouse/pull/8258) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Make bundled `curl` build fully quiet. [#8232](https://github.com/ClickHouse/ClickHouse/pull/8232) [#8203](https://github.com/ClickHouse/ClickHouse/pull/8203) ([Pavel Kovalenko](https://github.com/Jokser))
- Fix some `MemorySanitizer` warnings. [#8235](https://github.com/ClickHouse/ClickHouse/pull/8235) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Use `add_warning` and `no_warning` macros in `CMakeLists.txt`. [#8604](https://github.com/ClickHouse/ClickHouse/pull/8604) ([Ivan](https://github.com/abyss7))
- Add support of Minio S3 Compatible object (https://min.io/) for better integration tests. [#7863](https://github.com/ClickHouse/ClickHouse/pull/7863) [#7875](https://github.com/ClickHouse/ClickHouse/pull/7875) ([Pavel Kovalenko](https://github.com/Jokser))
- Imported `libc` headers to contrib. It allows to make builds more consistent across various systems (only for `x86_64-linux-gnu`). [#5773](https://github.com/ClickHouse/ClickHouse/pull/5773) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Remove `-fPIC` from some libraries. [#8464](https://github.com/ClickHouse/ClickHouse/pull/8464) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Clean `CMakeLists.txt` for curl. See https://github.com/ClickHouse/ClickHouse/pull/8011#issuecomment-569478910 [#8459](https://github.com/ClickHouse/ClickHouse/pull/8459) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Silent warnings in `CapNProto` library. [#8220](https://github.com/ClickHouse/ClickHouse/pull/8220) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add performance tests for short string optimized hash tables. [#7679](https://github.com/ClickHouse/ClickHouse/pull/7679) ([Amos Bird](https://github.com/amosbird))
- Now ClickHouse will build on `AArch64` even if `MADV_FREE` is not available. This fixes [#8027](https://github.com/ClickHouse/ClickHouse/issues/8027). [#8243](https://github.com/ClickHouse/ClickHouse/pull/8243) ([Amos Bird](https://github.com/amosbird))
- Update `zlib-ng` to fix memory sanitizer problems. [#7182](https://github.com/ClickHouse/ClickHouse/pull/7182) [#8206](https://github.com/ClickHouse/ClickHouse/pull/8206) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Enable internal MySQL library on non-Linux system, because usage of OS packages is very fragile and usually does not work at all. This fixes [#5765](https://github.com/ClickHouse/ClickHouse/issues/5765). [#8426](https://github.com/ClickHouse/ClickHouse/pull/8426) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed build on some systems after enabling `libc++`. This supersedes [#8374](https://github.com/ClickHouse/ClickHouse/issues/8374). [#8380](https://github.com/ClickHouse/ClickHouse/pull/8380) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Make `Field` methods more type-safe to find more errors. [#7386](https://github.com/ClickHouse/ClickHouse/pull/7386) [#8209](https://github.com/ClickHouse/ClickHouse/pull/8209) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Added missing files to the `libc-headers` submodule. [#8507](https://github.com/ClickHouse/ClickHouse/pull/8507) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix wrong `JSON` quoting in performance test output. [#8497](https://github.com/ClickHouse/ClickHouse/pull/8497) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Now stack trace is displayed for `std::exception` and `Poco::Exception`. In previous versions it was available only for `DB::Exception`. This improves diagnostics. [#8501](https://github.com/ClickHouse/ClickHouse/pull/8501) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Porting `clock_gettime` and `clock_nanosleep` for fresh glibc versions. [#8054](https://github.com/ClickHouse/ClickHouse/pull/8054) ([Amos Bird](https://github.com/amosbird))
- Enable `part_log` in example config for developers. [#8609](https://github.com/ClickHouse/ClickHouse/pull/8609) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix async nature of reload in `01036_no_superfluous_dict_reload_on_create_database*`. [#8111](https://github.com/ClickHouse/ClickHouse/pull/8111) ([Azat Khuzhin](https://github.com/azat))
- Fixed codec performance tests. [#8615](https://github.com/ClickHouse/ClickHouse/pull/8615) ([Vasily Nemkov](https://github.com/Enmk))
- Add install scripts for `.tgz` build and documentation for them. [#8612](https://github.com/ClickHouse/ClickHouse/pull/8612) [#8591](https://github.com/ClickHouse/ClickHouse/pull/8591) ([alesapin](https://github.com/alesapin))
- Removed old `ZSTD` test (it was created in year 2016 to reproduce the bug that pre 1.0 version of ZSTD has had). This fixes [#8618](https://github.com/ClickHouse/ClickHouse/issues/8618). [#8619](https://github.com/ClickHouse/ClickHouse/pull/8619) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed build on Mac OS Catalina. [#8600](https://github.com/ClickHouse/ClickHouse/pull/8600) ([meo](https://github.com/meob))
- Increased number of rows in codec performance tests to make results noticeable. [#8574](https://github.com/ClickHouse/ClickHouse/pull/8574) ([Vasily Nemkov](https://github.com/Enmk))
- In debug builds, treat `LOGICAL_ERROR` exceptions as assertion failures, so that they are easier to notice. [#8475](https://github.com/ClickHouse/ClickHouse/pull/8475) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Make formats-related performance test more deterministic. [#8477](https://github.com/ClickHouse/ClickHouse/pull/8477) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Update `lz4` to fix a MemorySanitizer failure. [#8181](https://github.com/ClickHouse/ClickHouse/pull/8181) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Suppress a known MemorySanitizer false positive in exception handling. [#8182](https://github.com/ClickHouse/ClickHouse/pull/8182) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Update `gcc` and `g++` to version 9 in `build/docker/build.sh` [#7766](https://github.com/ClickHouse/ClickHouse/pull/7766) ([TLightSky](https://github.com/tlightsky))
- Add performance test case to test that `PREWHERE` is worse than `WHERE`. [#7768](https://github.com/ClickHouse/ClickHouse/pull/7768) ([Amos Bird](https://github.com/amosbird))
- Progress towards fixing one flacky test. [#8621](https://github.com/ClickHouse/ClickHouse/pull/8621) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Avoid MemorySanitizer report for data from `libunwind`. [#8539](https://github.com/ClickHouse/ClickHouse/pull/8539) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Updated `libc++` to the latest version. [#8324](https://github.com/ClickHouse/ClickHouse/pull/8324) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Build ICU library from sources. This fixes [#6460](https://github.com/ClickHouse/ClickHouse/issues/6460). [#8219](https://github.com/ClickHouse/ClickHouse/pull/8219) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Switched from `libressl` to `openssl`. ClickHouse should support TLS 1.3 and SNI after this change. This fixes [#8171](https://github.com/ClickHouse/ClickHouse/issues/8171). [#8218](https://github.com/ClickHouse/ClickHouse/pull/8218) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed UBSan report when using `chacha20_poly1305` from SSL (happens on connect to https://yandex.ru/). [#8214](https://github.com/ClickHouse/ClickHouse/pull/8214) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix mode of default password file for `.deb` linux distros. [#8075](https://github.com/ClickHouse/ClickHouse/pull/8075) ([proller](https://github.com/proller))
- Improved expression for getting `clickhouse-server` PID in `clickhouse-test`. [#8063](https://github.com/ClickHouse/ClickHouse/pull/8063) ([Alexander Kazakov](https://github.com/Akazz))
- Updated contrib/googletest to v1.10.0. [#8587](https://github.com/ClickHouse/ClickHouse/pull/8587) ([Alexander Burmak](https://github.com/Alex-Burmak))
- Fixed ThreadSaninitizer report in `base64` library. Also updated this library to the latest version, but it does not matter. This fixes [#8397](https://github.com/ClickHouse/ClickHouse/issues/8397). [#8403](https://github.com/ClickHouse/ClickHouse/pull/8403) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix `00600_replace_running_query` for processors. [#8272](https://github.com/ClickHouse/ClickHouse/pull/8272) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Remove support for `tcmalloc` to make `CMakeLists.txt` simpler. [#8310](https://github.com/ClickHouse/ClickHouse/pull/8310) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Release gcc builds now use `libc++` instead of `libstdc++`. Recently `libc++` was used only with clang. This will improve consistency of build configurations and portability. [#8311](https://github.com/ClickHouse/ClickHouse/pull/8311) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Enable ICU library for build with MemorySanitizer. [#8222](https://github.com/ClickHouse/ClickHouse/pull/8222) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Suppress warnings from `CapNProto` library. [#8224](https://github.com/ClickHouse/ClickHouse/pull/8224) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Removed special cases of code for `tcmalloc`, because it's no longer supported. [#8225](https://github.com/ClickHouse/ClickHouse/pull/8225) ([alexey-milovidov](https://github.com/alexey-milovidov))
- In CI coverage task, kill the server gracefully to allow it to save the coverage report. This fixes incomplete coverage reports we've been seeing lately. [#8142](https://github.com/ClickHouse/ClickHouse/pull/8142) ([alesapin](https://github.com/alesapin))
- Performance tests for all codecs against `Float64` and `UInt64` values. [#8349](https://github.com/ClickHouse/ClickHouse/pull/8349) ([Vasily Nemkov](https://github.com/Enmk))
- `termcap` is very much deprecated and lead to various problems (f.g. missing "up" cap and echoing `^J` instead of multi line) . Favor `terminfo` or bundled `ncurses`. [#7737](https://github.com/ClickHouse/ClickHouse/pull/7737) ([Amos Bird](https://github.com/amosbird))
- Fix `test_storage_s3` integration test. [#7734](https://github.com/ClickHouse/ClickHouse/pull/7734) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Support `StorageFile(<format>, null) ` to insert block into given format file without actually write to disk. This is required for performance tests. [#8455](https://github.com/ClickHouse/ClickHouse/pull/8455) ([Amos Bird](https://github.com/amosbird))
- Added argument `--print-time` to functional tests which prints execution time per test. [#8001](https://github.com/ClickHouse/ClickHouse/pull/8001) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Added asserts to `KeyCondition` while evaluating RPN. This will fix warning from gcc-9. [#8279](https://github.com/ClickHouse/ClickHouse/pull/8279) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Dump cmake options in CI builds. [#8273](https://github.com/ClickHouse/ClickHouse/pull/8273) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Don't generate debug info for some fat libraries. [#8271](https://github.com/ClickHouse/ClickHouse/pull/8271) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Make `log_to_console.xml` always log to stderr, regardless of is it interactive or not. [#8395](https://github.com/ClickHouse/ClickHouse/pull/8395) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Removed some unused features from `clickhouse-performance-test` tool. [#8555](https://github.com/ClickHouse/ClickHouse/pull/8555) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Now we will also search for `lld-X` with corresponding `clang-X` version. [#8092](https://github.com/ClickHouse/ClickHouse/pull/8092) ([alesapin](https://github.com/alesapin))
- Parquet build improvement. [#8421](https://github.com/ClickHouse/ClickHouse/pull/8421) ([maxulan](https://github.com/maxulan))
- More GCC warnings [#8221](https://github.com/ClickHouse/ClickHouse/pull/8221) ([kreuzerkrieg](https://github.com/kreuzerkrieg))
- Package for Arch Linux now allows to run ClickHouse server, and not only client. [#8534](https://github.com/ClickHouse/ClickHouse/pull/8534) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix test with processors. Tiny performance fixes. [#7672](https://github.com/ClickHouse/ClickHouse/pull/7672) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Update contrib/protobuf. [#8256](https://github.com/ClickHouse/ClickHouse/pull/8256) ([Matwey V. Kornilov](https://github.com/matwey))
- In preparation of switching to c++20 as a new year celebration. "May the C++ force be with ClickHouse." [#8447](https://github.com/ClickHouse/ClickHouse/pull/8447) ([Amos Bird](https://github.com/amosbird))

#### 实验性功能 {#experimental-feature-8}

- 新增实验性设置 `min_bytes_to_use_mmap_io`。该设置允许在读取大文件时无需将数据从内核空间复制到用户空间。此设置默认禁用。建议阈值约为 64 MB,因为 mmap/munmap 操作较慢。[#8520](https://github.com/ClickHouse/ClickHouse/pull/8520) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 重构了配额功能,作为访问控制系统的一部分。新增了 `system.quotas` 表、`currentQuota` 和 `currentQuotaKey` 函数,以及新的 SQL 语法 `CREATE QUOTA`、`ALTER QUOTA`、`DROP QUOTA`、`SHOW QUOTA`。[#7257](https://github.com/ClickHouse/ClickHouse/pull/7257) ([Vitaly Baranov](https://github.com/vitlibar))
- 允许跳过未知设置并发出警告,而非抛出异常。[#7653](https://github.com/ClickHouse/ClickHouse/pull/7653) ([Vitaly Baranov](https://github.com/vitlibar))
- 重构了行级策略功能,作为访问控制系统的一部分。新增了 `system.row_policies` 表、`currentRowPolicies()` 函数,以及新的 SQL 语法 `CREATE POLICY`、`ALTER POLICY`、`DROP POLICY`、`SHOW CREATE POLICY`、`SHOW POLICIES`。[#7808](https://github.com/ClickHouse/ClickHouse/pull/7808) ([Vitaly Baranov](https://github.com/vitlibar))

#### 安全修复 {#security-fix}

- 修复了使用 `File` 表引擎的表可能读取目录结构的安全问题。此修复解决了 [#8536](https://github.com/ClickHouse/ClickHouse/issues/8536)。[#8537](https://github.com/ClickHouse/ClickHouse/pull/8537) ([alexey-milovidov](https://github.com/alexey-milovidov))


## [2019 年更新日志](./2019.md) {#changelog-for-2019}
