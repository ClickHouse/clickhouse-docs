---
slug: /whats-new/changelog/2022
sidebar_position: 5
sidebar_label: "2022"
title: "2022 更新日志"
description: "2022 年更新日志"
keywords:
  [
    "ClickHouse 2022",
    "changelog 2022",
    "发布说明",
    "版本历史",
    "功能更新"
  ]
doc_type: "changelog"
---

### <a id="2212"></a> ClickHouse 版本 22.12, 2022-12-15 {#a-id2212a-clickhouse-release-2212-2022-12-15}

:::warning

此版本包含一个有缺陷的 systemd 服务注释,可能会在某些 Linux 发行版升级时导致 ClickHouse 安装失败。该 systemd 服务会更改 `/run/systemd` 的目录所有者权限,导致所有后续 systemd 操作失败。建议跳过此版本,直接升级到更新的 ClickHouse 版本。

有关更多详细信息,请参阅 GitHub 上的此问题:https://github.com/ClickHouse/ClickHouse/issues/48285

:::

#### 升级说明 {#upgrade-notes}

- 修复了带有 `String` 参数的 `min`、`max`、`any*`、`argMin`、`argMax` 聚合函数状态在(反)序列化时的向后不兼容问题。该不兼容性影响 22.9、22.10 和 22.11 分支(分别在 22.9.6、22.10.4 和 22.11.2 中修复)。22.3、22.7 和 22.8 分支的部分次要版本也受到影响:22.3.13...22.3.14(自 22.3.15 起修复)、22.8.6...22.8.9(自 22.8.10 起修复)、22.7.6 及更高版本(不会在 22.7 中修复,建议从 22.7.* 升级到 22.8.10 或更高版本)。此发布说明不涉及从未使用过受影响版本的用户。不兼容版本在读取上述聚合函数的状态时会在字符串末尾附加一个额外的 `'\0'`。例如,如果旧版本将 `anyState('foobar')` 的状态保存到 `state_column`,则不兼容版本在执行 `anyMerge(state_column)` 时会输出 `'foobar\0'`。此外,不兼容版本在写入聚合函数状态时不带尾随 `'\0'`。较新版本(已包含修复)可以正确读取所有版本(包括不兼容版本)写入的数据,但有一个特殊情况除外。如果不兼容版本保存的状态包含实际以空字符结尾的字符串,则较新版本在读取受影响聚合函数的状态时会修剪尾随的 `'\0'`。例如,如果不兼容版本将 `anyState('abrac\0dabra\0')` 的状态保存到 `state_column`,则较新版本在执行 `anyMerge(state_column)` 时会输出 `'abrac\0dabra'`。当不兼容版本与旧版本或新版本在集群中一起运行时,该问题也会影响分布式查询。[#43038](https://github.com/ClickHouse/ClickHouse/pull/43038) ([Alexander Tokmakov](https://github.com/tavplubix), [Raúl Marín](https://github.com/Algunenano))。注意:所有官方 ClickHouse 构建版本均已包含该补丁。非官方第三方构建版本不一定包含此修复,应避免使用。


#### 新功能 {#new-feature}

- 新增 `BSONEachRow` 输入/输出格式。在此格式中,ClickHouse 将每一行格式化/解析为独立的 BSON 文档,每一列格式化/解析为单个 BSON 字段,列名作为键。[#42033](https://github.com/ClickHouse/ClickHouse/pull/42033) ([mark-polokhov](https://github.com/mark-polokhov)).
- 新增 `grace_hash` JOIN 算法,可通过 `SET join_algorithm = 'grace_hash'` 启用。[#38191](https://github.com/ClickHouse/ClickHouse/pull/38191) ([BigRedEye](https://github.com/BigRedEye), [Vladimir C](https://github.com/vdimir)).
- 支持配置密码复杂度规则和检查,用于创建和修改用户。[#43719](https://github.com/ClickHouse/ClickHouse/pull/43719) ([Nikolay Degterinsky](https://github.com/evillique)).
- 在日志中屏蔽敏感信息;在 `SHOW CREATE TABLE` 和 `SELECT FROM system.tables` 查询输出中屏蔽机密部分。同时解决了 [#41418](https://github.com/ClickHouse/ClickHouse/issues/41418)。[#43227](https://github.com/ClickHouse/ClickHouse/pull/43227) ([Vitaly Baranov](https://github.com/vitlibar)).
- 新增 `GROUP BY ALL` 语法:[#37631](https://github.com/ClickHouse/ClickHouse/issues/37631)。[#42265](https://github.com/ClickHouse/ClickHouse/pull/42265) ([刘陶峰](https://github.com/taofengliu)).
- 新增 `FROM table SELECT column` 语法。[#41095](https://github.com/ClickHouse/ClickHouse/pull/41095) ([Nikolay Degterinsky](https://github.com/evillique)).
- 新增函数 `concatWithSeparator` 及其别名 `concat_ws`,以实现 Spark SQL 兼容性。新增函数 `concatWithSeparatorAssumeInjective` 作为变体以启用 GROUP BY 优化,类似于 `concatAssumeInjective`。[#43749](https://github.com/ClickHouse/ClickHouse/pull/43749) ([李扬](https://github.com/taiyang-li)).
- 新增 `multiplyDecimal` 和 `divideDecimal` 函数,用于固定精度的十进制运算。[#42438](https://github.com/ClickHouse/ClickHouse/pull/42438) ([Andrey Zvonov](https://github.com/zvonand)).
- 新增 `system.moves` 表,包含当前正在移动的数据部分列表。[#42660](https://github.com/ClickHouse/ClickHouse/pull/42660) ([Sergei Trifonov](https://github.com/serxa)).
- 为 ClickHouse Keeper 新增嵌入式 Prometheus 端点支持。[#43087](https://github.com/ClickHouse/ClickHouse/pull/43087) ([Antonio Andelic](https://github.com/antonio2368)).
- 支持使用 `_` 作为分隔符的数字字面量,例如 `1_000_000`。[#43925](https://github.com/ClickHouse/ClickHouse/pull/43925) ([jh0x](https://github.com/jh0x)).
- 新增将数组用作 `cutURLParameter` 函数第二个参数的功能,可截取多个参数。关闭 [#6827](https://github.com/ClickHouse/ClickHouse/issues/6827)。[#43788](https://github.com/ClickHouse/ClickHouse/pull/43788) ([Roman Vasin](https://github.com/rvasin)).
- 在 `system.data_skipping_indices` 表中新增包含索引表达式的列。[#43308](https://github.com/ClickHouse/ClickHouse/pull/43308) ([Guillaume Tassery](https://github.com/YiuRULE)).
- 在系统表 `databases` 中新增 `engine_full` 列,以便用户可以通过系统表访问数据库的完整引擎定义。[#43468](https://github.com/ClickHouse/ClickHouse/pull/43468) ([凌涛](https://github.com/lingtaolf)).
- 新增哈希函数 [xxh3](https://github.com/Cyan4973/xxHash)。此外,由于库更新,`xxHash32` 和 `xxHash64` 在 ARM 上的性能得到了改进。[#43411](https://github.com/ClickHouse/ClickHouse/pull/43411) ([Nikita Taranov](https://github.com/nickitat)).
- 新增为合并树设置定义约束的支持。例如,您可以禁止用户覆盖 `storage_policy`。[#43903](https://github.com/ClickHouse/ClickHouse/pull/43903) ([Sergei Trifonov](https://github.com/serxa)).
- 新增设置 `input_format_json_read_objects_as_strings`,允许在所有 JSON 输入格式中将嵌套的 JSON 对象解析为字符串。此设置默认禁用。[#44052](https://github.com/ClickHouse/ClickHouse/pull/44052) ([Kruglov Pavel](https://github.com/Avogar)).

#### 实验性功能 {#experimental-feature}

- 支持异步插入的去重。在此更改之前,异步插入不支持去重,因为多个小型插入会共存于一个插入批次中。关闭 [#38075](https://github.com/ClickHouse/ClickHouse/issues/38075)。[#43304](https://github.com/ClickHouse/ClickHouse/pull/43304) ([Han Fei](https://github.com/hanfei1991))。
- 为实验性的 Annoy(向量相似度搜索)索引添加余弦距离支持。[#42778](https://github.com/ClickHouse/ClickHouse/pull/42778) ([Filatenkov Artur](https://github.com/FArthur-cmd))。
- 添加 `CREATE / ALTER / DROP NAMED COLLECTION` 查询。[#43252](https://github.com/ClickHouse/ClickHouse/pull/43252) ([Kseniia Sumarokova](https://github.com/kssenii))。此功能正在开发中,截至 22.12 版本这些查询尚未生效。添加此更新日志条目仅为避免混淆。将命名集合的默认访问权限限制为配置中定义的用户。这要求设置 `show_named_collections = 1` 才能查看它们。[#43325](https://github.com/ClickHouse/ClickHouse/pull/43325) ([Kseniia Sumarokova](https://github.com/kssenii))。引入 `system.named_collections` 表 [#43147](https://github.com/ClickHouse/ClickHouse/pull/43147) ([Kseniia Sumarokova](https://github.com/kssenii))。


#### 性能改进 {#performance-improvement}

- 新增设置 `max_streams_for_merge_tree_reading` 和 `allow_asynchronous_read_from_io_pool_for_merge_tree`。`max_streams_for_merge_tree_reading` 设置用于限制 MergeTree 表的读取流数量。`allow_asynchronous_read_from_io_pool_for_merge_tree` 设置用于启用后台 I/O 池来读取 `MergeTree` 表数据。如果与 `max_streams_to_max_threads_ratio` 或 `max_streams_for_merge_tree_reading` 配合使用,可以提高 I/O 密集型查询的性能。[#43260](https://github.com/ClickHouse/ClickHouse/pull/43260) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。在高延迟存储、CPU 核心数较少且数据分区数量较多的场景下,性能最高可提升 100 倍。
- `merge_tree_min_rows_for_concurrent_read_for_remote_filesystem/merge_tree_min_bytes_for_concurrent_read_for_remote_filesystem` 设置未遵循自适应粒度。宽行数据未能减少读取的行数(与 `merge_tree_min_rows_for_concurrent_read/merge_tree_min_bytes_for_concurrent_read` 的处理方式不同),这可能导致使用远程文件系统时内存占用过高。[#43965](https://github.com/ClickHouse/ClickHouse/pull/43965) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 优化了选择待合并分区时向 ZooKeeper 或 ClickHouse Keeper 发出的列表请求数量。在某些情况下,之前可能会产生数千个请求。修复 [#43647](https://github.com/ClickHouse/ClickHouse/issues/43647)。[#43675](https://github.com/ClickHouse/ClickHouse/pull/43675) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 当 `max_size_to_preallocate_for_aggregation` 的值过小时,现在会跳过优化。此设置的默认值已提高到 `10^8`。[#43945](https://github.com/ClickHouse/ClickHouse/pull/43945) ([Nikita Taranov](https://github.com/nickitat))。
- 通过避免清理旧数据分区来加快服务器关闭速度。因为在 https://github.com/ClickHouse/ClickHouse/pull/41145 之后这已不再必要。[#43760](https://github.com/ClickHouse/ClickHouse/pull/43760) ([Sema Checherinda](https://github.com/CheSema))。
- 如果设置了 `enable_memory_bound_merging_of_aggregation_results`,发起节点上的合并现在使用与本地聚合结果合并相同的内存限制方法。[#40879](https://github.com/ClickHouse/ClickHouse/pull/40879) ([Nikita Taranov](https://github.com/nickitat))。
- Keeper 改进:尝试在复制的同时并行将日志同步到磁盘。[#43450](https://github.com/ClickHouse/ClickHouse/pull/43450) ([Antonio Andelic](https://github.com/antonio2368))。
- Keeper 改进:请求批处理更加频繁。可以通过新设置 `max_requests_quick_batch_size` 控制批处理行为。[#43686](https://github.com/ClickHouse/ClickHouse/pull/43686) ([Antonio Andelic](https://github.com/antonio2368))。


#### 改进 {#improvement}

- 实现引用依赖关系,并在从备份恢复时使用它们按正确顺序创建表。[#43834](https://github.com/ClickHouse/ClickHouse/pull/43834) ([Vitaly Baranov](https://github.com/vitlibar))。
- 在 `CREATE` 查询中替换 UDF 以避免启动时加载失败。此外,UDF 现在可以用作列的 `DEFAULT` 表达式。[#43539](https://github.com/ClickHouse/ClickHouse/pull/43539) ([Antonio Andelic](https://github.com/antonio2368))。
- 更改以下查询删除数据分区的方式:TRUNCATE TABLE、ALTER TABLE DROP PART、ALTER TABLE DROP PARTITION。现在,这些查询会创建覆盖旧分区的空分区。这使得 TRUNCATE 查询无需后续排他锁即可工作,意味着并发读取不会被阻塞。同时在所有这些查询中实现了持久性。如果请求成功,则不会在之后出现复活的分区。请注意,原子性仅在事务范围内实现。[#41145](https://github.com/ClickHouse/ClickHouse/pull/41145) ([Sema Checherinda](https://github.com/CheSema))。
- `SET param_x` 查询不再需要手动对参数值进行字符串序列化。例如,查询 `SET param_a = '[\'a\', \'b\']'` 现在可以写成 `SET param_a = ['a', 'b']`。[#41874](https://github.com/ClickHouse/ClickHouse/pull/41874) ([Nikolay Degterinsky](https://github.com/evillique))。
- 在客户端从 STDIN 读取时,在进度指示中显示已读取的行数。关闭 [#43423](https://github.com/ClickHouse/ClickHouse/issues/43423)。[#43442](https://github.com/ClickHouse/ClickHouse/pull/43442) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 从 s3 表函数/引擎读取时显示进度条。[#43454](https://github.com/ClickHouse/ClickHouse/pull/43454) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 进度条将同时显示读取和写入的行数。[#43496](https://github.com/ClickHouse/ClickHouse/pull/43496) ([Ilya Yatsishin](https://github.com/qoega))。
- `filesystemAvailable` 及相关函数支持一个可选的磁盘名称参数,并将 `filesystemFree` 更改为 `filesystemUnreserved`。关闭 [#35076](https://github.com/ClickHouse/ClickHouse/issues/35076)。[#42064](https://github.com/ClickHouse/ClickHouse/pull/42064) ([flynn](https://github.com/ucasfl))。
- LDAP 集成:将 search_limit 的默认值增加到 256,并添加了 LDAP 服务器配置选项以将其更改为任意值。关闭:[#42276](https://github.com/ClickHouse/ClickHouse/issues/42276)。[#42461](https://github.com/ClickHouse/ClickHouse/pull/42461) ([Vasily Nemkov](https://github.com/Enmk))。
- 允许从异常消息中删除敏感信息(参见配置文件中的 `query_masking_rules`)。解决 [#41418](https://github.com/ClickHouse/ClickHouse/issues/41418)。[#42940](https://github.com/ClickHouse/ClickHouse/pull/42940) ([filimonov](https://github.com/filimonov))。
- 支持 `SHOW FULL TABLES ...` 等查询以实现 MySQL 兼容性。[#43910](https://github.com/ClickHouse/ClickHouse/pull/43910) ([Filatenkov Artur](https://github.com/FArthur-cmd))。
- Keeper 改进:添加 4lw 命令 `rqld`,可以手动将节点指定为 leader。[#43026](https://github.com/ClickHouse/ClickHouse/pull/43026) ([JackyWoo](https://github.com/JackyWoo))。
- 对来自查询的分布式异步 INSERT 应用连接超时设置。[#43156](https://github.com/ClickHouse/ClickHouse/pull/43156) ([Azat Khuzhin](https://github.com/azat))。
- `unhex` 函数现在支持 `FixedString` 参数。[issue42369](https://github.com/ClickHouse/ClickHouse/issues/42369)。[#43207](https://github.com/ClickHouse/ClickHouse/pull/43207) ([DR](https://github.com/freedomDR))。
- 根据 TTL 规则优先删除完全过期的分区,参见 [#42869](https://github.com/ClickHouse/ClickHouse/issues/42869)。[#43222](https://github.com/ClickHouse/ClickHouse/pull/43222) ([zhongyuankai](https://github.com/zhongyuankai))。
- 在 clickhouse-client 中提供更精确和响应更快的 CPU 负载指示。[#43307](https://github.com/ClickHouse/ClickHouse/pull/43307) ([Sergei Trifonov](https://github.com/serxa))。
- 支持从存储 `S3` 和表函数 `s3` 中读取嵌套类型的子列,格式包括 `Parquet`、`Arrow` 和 `ORC`。[#43329](https://github.com/ClickHouse/ClickHouse/pull/43329) ([chen](https://github.com/xiedeyantu))。
- 向 `system.parts` 表添加 `table_uuid` 列。[#43404](https://github.com/ClickHouse/ClickHouse/pull/43404) ([Azat Khuzhin](https://github.com/azat))。
- 添加客户端选项以在非交互模式下显示本地处理的行数(`--print-num-processed-rows`)。[#43407](https://github.com/ClickHouse/ClickHouse/pull/43407) ([jh0x](https://github.com/jh0x))。
- 在查询计划之上实现 `aggregation-in-order` 优化。默认启用(但仅与 `optimize_aggregation_in_order` 一起工作,后者默认禁用)。设置 `query_plan_aggregation_in_order = 0` 以使用之前基于 AST 的版本。[#43592](https://github.com/ClickHouse/ClickHouse/pull/43592) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 允许在每次增量时将 `trace_type = 'ProfileEvent'` 的性能事件收集到 `system.trace_log`,包含当前堆栈、性能事件名称和增量值。可以通过设置 `trace_profile_events` 启用,用于调查查询性能。[#43639](https://github.com/ClickHouse/ClickHouse/pull/43639) ([Anton Popov](https://github.com/CurtizJ))。
- 添加新设置 `input_format_max_binary_string_size` 以限制 RowBinary 格式中的字符串大小。[#43842](https://github.com/ClickHouse/ClickHouse/pull/43842) ([Kruglov Pavel](https://github.com/Avogar))。
- 当 ClickHouse 请求远程 HTTP 服务器并返回错误时,异常消息中未正确显示数字 HTTP 代码。关闭 [#43919](https://github.com/ClickHouse/ClickHouse/issues/43919)。[#43920](https://github.com/ClickHouse/ClickHouse/pull/43920) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 即使在进行多个 JOIN 优化时也能正确报告查询中的错误。[#43583](https://github.com/ClickHouse/ClickHouse/pull/43583) ([Salvatore](https://github.com/tbsal))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement}

- Systemd 集成现在可以正确通知 systemd 服务已真正启动并准备好处理请求。[#43400](https://github.com/ClickHouse/ClickHouse/pull/43400) ([Коренберг Марк](https://github.com/socketpair))。
- 新增了使用 [OpenSSL FIPS Module](https://www.openssl.org/docs/man3.0/man7/fips_module.html) 构建 ClickHouse 的选项。此构建类型尚未经过安全验证测试,且不受支持。[#43991](https://github.com/ClickHouse/ClickHouse/pull/43991) ([Boris Kuschel](https://github.com/bkuschel))。
- 升级到新的 `DeflateQpl` 压缩编解码器,该编解码器已在之前的 PR 中实现(详情:https://github.com/ClickHouse/ClickHouse/pull/39494)。此补丁在以下方面改进了编解码器:1. 从 QPL v0.2.0 升级到 QPL v0.3.0 [Intel® Query Processing Library (QPL)](https://github.com/intel/qpl) 2. 改进 CMake 文件以修复 QPL v0.3.0 的构建问题。3. 在构建时将 QPL 库与 libaccel-config 链接,而不是在 QPL v0.2.0 中运行时加载(dlopen)。4. 修复了 CompressionCodecDeflateQpl.cpp 中的日志打印问题。[#44024](https://github.com/ClickHouse/ClickHouse/pull/44024) ([jasperzhu](https://github.com/jinjunzh))。

#### Bug 修复(官方稳定版或预发布版本中用户可见的异常行为) {#bug-fix-user-visible-misbehavior-in-official-stable-or-prestable-release}


* 修复了在使用异步插入时可能导致死锁的缺陷。 [#43233](https://github.com/ClickHouse/ClickHouse/pull/43233) ([Anton Popov](https://github.com/CurtizJ)).
* 修复 AST 层优化 `optimize_normalize_count_variants` 中的一些错误逻辑。[#43873](https://github.com/ClickHouse/ClickHouse/pull/43873) ([Duc Canh Le](https://github.com/canhld94)).
* 修复一种情况：当副本之间的校验和不匹配时（例如由于升级导致数据格式发生变化），导致 `mutation` 无法推进的问题。 [#36877](https://github.com/ClickHouse/ClickHouse/pull/36877) ([nvartolomei](https://github.com/nvartolomei)).
* 修复了 `skip_unavailable_shards` 优化在 `hdfsCluster` 表函数中不生效的问题。 [#43236](https://github.com/ClickHouse/ClickHouse/pull/43236) ([chen](https://github.com/xiedeyantu))。
* 修复 `s3` 对 `?` 通配符的支持。关闭 [#42731](https://github.com/ClickHouse/ClickHouse/issues/42731)。[#43253](https://github.com/ClickHouse/ClickHouse/pull/43253)（[chen](https://github.com/xiedeyantu)）。
* 修复当数组包含 `Nullable` 元素时，函数 `arrayFirstOrNull` 和 `arrayLastOrNull` 返回 `null` 的问题。 [#43274](https://github.com/ClickHouse/ClickHouse/pull/43274) ([Duc Canh Le](https://github.com/canhld94)).
* 修复与 Kafka 表相关的 `UserTimeMicroseconds`/`SystemTimeMicroseconds` 统计不正确的问题。[#42791](https://github.com/ClickHouse/ClickHouse/pull/42791) ([Azat Khuzhin](https://github.com/azat))。
* 不要在 `web` 磁盘中屏蔽异常。修复 `web` 磁盘的重试机制。[#42800](https://github.com/ClickHouse/ClickHouse/pull/42800) ([Azat Khuzhin](https://github.com/azat)).
* 修复了插入与删除物化视图之间的（逻辑）竞争条件。当物化视图在执行 `INSERT` 的同时被删除时会出现竞争：在执行开始时，这些 MV 作为插入的依赖是存在的，但当插入链尝试访问它时，表已经被删除，从而抛出 `UNKNOWN_TABLE` 或 `TABLE_IS_DROPPED` 异常并中止插入。此更改后，如果依赖已经消失，我们会避免这些异常并继续执行插入。[#43161](https://github.com/ClickHouse/ClickHouse/pull/43161)（[AlfVII](https://github.com/AlfVII)）。
* 修复 `quantiles` 函数中的未定义行为，该行为可能导致使用未初始化的内存。由 fuzzer 发现。此更改关闭了 [#44066](https://github.com/ClickHouse/ClickHouse/issues/44066)。[#44067](https://github.com/ClickHouse/ClickHouse/pull/44067)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 在 `CompressionCodecDelta` 中新增了对未压缩大小为零的额外检查。 [#43255](https://github.com/ClickHouse/ClickHouse/pull/43255) ([Nikita Taranov](https://github.com/nickitat)).
* 从 Parquet 中扁平化数组，以避免数组中出现数据不一致的问题。这些错误文件可能由 Apache Iceberg 生成。[#43297](https://github.com/ClickHouse/ClickHouse/pull/43297) ([Arthur Passos](https://github.com/arthurpassos))。
* 修复在使用短路函数执行时，从 `LowCardinality` 列进行错误类型转换的问题。[#43311](https://github.com/ClickHouse/ClickHouse/pull/43311) ([Kruglov Pavel](https://github.com/Avogar))。
* 修复了在使用 `Merge` 引擎的表上，含有 `SAMPLE BY` 且启用 prewhere 优化的查询。[#43315](https://github.com/ClickHouse/ClickHouse/pull/43315) ([Antonio Andelic](https://github.com/antonio2368))。
* 检查并比较 `MergeTreeData` 中 `format_version` 文件的内容，以便在存储策略发生更改时，仍然可以加载表。[#43328](https://github.com/ClickHouse/ClickHouse/pull/43328) ([Antonio Andelic](https://github.com/antonio2368))。
* 修复在向 `Buffer` 表执行 INSERT 时，极小概率出现的 “No column to rollback” 逻辑错误。 [#43336](https://github.com/ClickHouse/ClickHouse/pull/43336) ([Azat Khuzhin](https://github.com/azat)).
* 修复了一个错误：当启用 `allow_function_parameters` 时，解析器会将无限数量的圆括号解析为一个函数。 [#43350](https://github.com/ClickHouse/ClickHouse/pull/43350) ([Nikolay Degterinsky](https://github.com/evillique))。
* `MaterializeMySQL`（实验性功能）支持 DDL：`drop table t1, t2`，并与大多数 MySQL 的 DROP DDL 语句兼容。[#43366](https://github.com/ClickHouse/ClickHouse/pull/43366)（[zzsmdfj](https://github.com/zzsmdfj)）。
* `session_log`（实验特性）：修复了在一种极少见的、设置配置文件混乱的情况下，由于无法创建 session&#95;log 记录而导致无法登录的问题。[#42641](https://github.com/ClickHouse/ClickHouse/pull/42641)（[Vasily Nemkov](https://github.com/Enmk)）。
* 修复在 `if`/`multiIf` 函数中可能出现的 `Cannot create non-empty column with type Nothing` 错误。修复关闭 [#43356](https://github.com/ClickHouse/ClickHouse/issues/43356)。[#43368](https://github.com/ClickHouse/ClickHouse/pull/43368)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复了在行级过滤器使用列默认值时出现的错误。 [#43387](https://github.com/ClickHouse/ClickHouse/pull/43387) ([Alexander Gololobov](https://github.com/davenger)).
* 包含 `DISTINCT` + `LIMIT BY` + `LIMIT` 的查询可能返回少于预期的行数。修复了 [#43377](https://github.com/ClickHouse/ClickHouse/issues/43377)。[#43410](https://github.com/ClickHouse/ClickHouse/pull/43410)（[Igor Nikonov](https://github.com/devcrafter)）。
* 修复针对 `Nullable(Decimal(...))` 的 `sumMap`。 [#43414](https://github.com/ClickHouse/ClickHouse/pull/43414) ([Azat Khuzhin](https://github.com/azat)).
* 修复 macOS 上关于小时/分钟的 `date_diff`。关闭 [#42742](https://github.com/ClickHouse/ClickHouse/issues/42742)。[#43466](https://github.com/ClickHouse/ClickHouse/pull/43466)（[zzsmdfj](https://github.com/zzsmdfj)）。
* 修复由合并/变更导致的错误内存计量。 [#43516](https://github.com/ClickHouse/ClickHouse/pull/43516) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在含有 `toString(enum)` 条件时的主键分析问题。[#43596](https://github.com/ClickHouse/ClickHouse/pull/43596)（[Nikita Taranov](https://github.com/nickitat)）。该错误由 @tisonkun 发现。
* 在分区附加完成后，确保 `clickhouse-copier` 在 Keeper 中更新状态和 `attach_is_done` 时保持一致性。 [#43602](https://github.com/ClickHouse/ClickHouse/pull/43602) ([lzydmxy](https://github.com/lzydmxy)).
* 在恢复丢失的 `Replicated` 数据库副本（实验特性）的过程中，可能会出现需要使用 EXCHANGE 原子性地交换两个表名的情况。此前我们尝试使用两个 RENAME 查询，这显然会失败，而且还会导致整个数据库副本的恢复过程失败。[#43628](https://github.com/ClickHouse/ClickHouse/pull/43628)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 修复 `s3Cluster` 函数抛出 `NOT_FOUND_COLUMN_IN_BLOCK` 错误的问题。关联问题 [#43534](https://github.com/ClickHouse/ClickHouse/issues/43534)。[#43629](https://github.com/ClickHouse/ClickHouse/pull/43629)（[chen](https://github.com/xiedeyantu)）。
* 修复在解析包含键名相同但嵌套层级不同的数组的 JSON 对象时可能出现的逻辑错误 `Array sizes mismatched`。关闭 [#43569](https://github.com/ClickHouse/ClickHouse/issues/43569)。[#43693](https://github.com/ClickHouse/ClickHouse/pull/43693)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复了在分布式执行 `GROUP BY` 时，当聚合键中包含 `ALIAS` 列时可能引发的异常。[#43709](https://github.com/ClickHouse/ClickHouse/pull/43709) ([Nikita Taranov](https://github.com/nickitat)).
* 修复在启用并使用零拷贝复制（实验性特性）时可能导致投影损坏的缺陷。 [#43764](https://github.com/ClickHouse/ClickHouse/pull/43764) ([alesapin](https://github.com/alesapin)).
* 修复在 AWS S3 中对超大 S3 对象使用分段上传时的问题。 [#43824](https://github.com/ClickHouse/ClickHouse/pull/43824) ([ianton-ru](https://github.com/ianton-ru)).
* 修复了在使用 `ON CLUSTER` 时的 `ALTER ... RESET SETTING`，之前它可能只会应用到一个副本。修复了 [#43843](https://github.com/ClickHouse/ClickHouse/issues/43843)。[#43848](https://github.com/ClickHouse/ClickHouse/pull/43848)（[Elena Torró](https://github.com/elenatorro)）。
* 修复在右侧使用 `Join` 表引擎且使用 `USING` 时 `JOIN` 中的逻辑错误。[#43963](https://github.com/ClickHouse/ClickHouse/pull/43963)（[Vladimir C](https://github.com/vdimir)）。修复 `Join` 表引擎中键顺序错误的问题。[#44012](https://github.com/ClickHouse/ClickHouse/pull/44012)（[Vladimir C](https://github.com/vdimir)）。
* Keeper 修复：当用于 Raft 的 interserver 端口已被占用时抛出异常。 [#43984](https://github.com/ClickHouse/ClickHouse/pull/43984) ([Antonio Andelic](https://github.com/antonio2368))。
* 在对子查询进行不必要的列裁剪时，修复 `ORDER BY` 位置参数（例如：`ORDER BY 1, 2`）的问题。关闭 [#43964](https://github.com/ClickHouse/ClickHouse/issues/43964)。[#43987](https://github.com/ClickHouse/ClickHouse/pull/43987)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复了当子查询包含 HAVING 子句但不包含实际聚合时抛出的异常。[#44051](https://github.com/ClickHouse/ClickHouse/pull/44051)（[Nikita Taranov](https://github.com/nickitat)）。
* 修复 S3 分片上传中的竞态问题。该问题可能会在从备份恢复时导致错误 `Part number must be an integer between 1 and 10000, inclusive. (S3_ERROR)`。 [#44065](https://github.com/ClickHouse/ClickHouse/pull/44065) ([Vitaly Baranov](https://github.com/vitlibar)).

### <a id="2211"></a> ClickHouse release 22.11, 2022-11-17 {#a-id2211a-clickhouse-release-2211-2022-11-17}

#### 不向后兼容的变更 {#backward-incompatible-change}

- `JSONExtract` 系列函数现在会尝试强制转换为所请求的类型。[#41502](https://github.com/ClickHouse/ClickHouse/pull/41502) ([Márcio Martins](https://github.com/marcioapm))。


#### 新功能 {#new-feature-1}

- 为 ReplicatedMergeTree 的 INSERT 操作添加重试支持,当与 ClickHouse Keeper 的会话丢失时可自动重试。除了提高容错性之外,该功能还旨在提供更好的用户体验 - 避免在 keeper 重启时(例如升级期间)向用户返回插入错误。[#42607](https://github.com/ClickHouse/ClickHouse/pull/42607) ([Igor Nikonov](https://github.com/devcrafter))。
- 添加 `Hudi` 和 `DeltaLake` 表引擎,只读模式,仅支持 S3 上的表。[#41054](https://github.com/ClickHouse/ClickHouse/pull/41054) ([Daniil Rubin](https://github.com/rubin-do), [Kseniia Sumarokova](https://github.com/kssenii))。
- 添加表函数 `hudi` 和 `deltaLake`。[#43080](https://github.com/ClickHouse/ClickHouse/pull/43080) ([flynn](https://github.com/ucasfl))。
- 支持复合时间间隔。1. 现在可以对 Interval 进行加法、减法和取反操作。当 Interval 类型不同时,它们将被转换为这些类型的元组。2. 间隔元组可以与 Date/DateTime 字段进行加减运算。3. 添加了对不同类型 Interval 的解析支持,例如:`INTERVAL '1 HOUR 1 MINUTE 1 SECOND'`。[#42195](https://github.com/ClickHouse/ClickHouse/pull/42195) ([Nikolay Degterinsky](https://github.com/evillique))。
- 添加 `**` 通配符支持,用于文件系统和 S3 的递归目录遍历。解决了 [#36316](https://github.com/ClickHouse/ClickHouse/issues/36316)。[#42376](https://github.com/ClickHouse/ClickHouse/pull/42376) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
- 引入 `s3_plain` 磁盘类型,用于一次写入多次读取的操作。为 `s3_plain` 磁盘实现 `MergeTree` 表的 `ATTACH` 功能。[#42628](https://github.com/ClickHouse/ClickHouse/pull/42628) ([Azat Khuzhin](https://github.com/azat))。
- 在 `system.query_log` 中添加已应用的行级策略信息。[#39819](https://github.com/ClickHouse/ClickHouse/pull/39819) ([Vladimir Chebotaryov](https://github.com/quickhouse))。
- 添加四字母命令 `csnp`,用于在 ClickHouse Keeper 中手动创建快照。此外,还添加了 `lgif` 命令以获取特定节点的 Raft 信息(例如最后创建的快照索引、最后提交的日志索引)。[#41766](https://github.com/ClickHouse/ClickHouse/pull/41766) ([JackyWoo](https://github.com/JackyWoo))。
- 添加函数 `ascii`,类似于 Apache Spark 中的实现:https://spark.apache.org/docs/latest/api/sql/#ascii。[#42670](https://github.com/ClickHouse/ClickHouse/pull/42670) ([李扬](https://github.com/taiyang-li))。
- 添加函数 `pmod`,基于取模运算返回非负结果。[#42755](https://github.com/ClickHouse/ClickHouse/pull/42755) ([李扬](https://github.com/taiyang-li))。
- 添加函数 `formatReadableDecimalSize`。[#42774](https://github.com/ClickHouse/ClickHouse/pull/42774) ([Alejandro](https://github.com/alexon1234))。
- 添加函数 `randCanonical`,类似于 Apache Spark 或 Impala 中的 `rand` 函数。该函数生成伪随机结果,其值在 [0, 1) 区间内独立同分布且均匀分布。[#43124](https://github.com/ClickHouse/ClickHouse/pull/43124) ([李扬](https://github.com/taiyang-li))。
- 添加函数 `displayName`,关闭了 [#36770](https://github.com/ClickHouse/ClickHouse/issues/36770)。[#37681](https://github.com/ClickHouse/ClickHouse/pull/37681) ([hongbin](https://github.com/xlwh))。
- 添加 `min_age_to_force_merge_on_partition_only` 设置,仅对整个分区的旧数据部分进行优化合并。[#42659](https://github.com/ClickHouse/ClickHouse/pull/42659) ([Antonio Andelic](https://github.com/antonio2368))。
- 为任意结构化命名集合、访问类型和 `system.named_collections` 添加通用实现。[#43147](https://github.com/ClickHouse/ClickHouse/pull/43147) ([Kseniia Sumarokova](https://github.com/kssenii))。

#### 性能改进 {#performance-improvement-1}

- 当 `match` 函数作用于字符串前缀条件时可以使用索引。此更改解决了 [#37333](https://github.com/ClickHouse/ClickHouse/issues/37333)。[#42458](https://github.com/ClickHouse/ClickHouse/pull/42458) ([clarkcaoliu](https://github.com/Clark0))。
- 加速连续的 AND 和 OR 运算符。[#42214](https://github.com/ClickHouse/ClickHouse/pull/42214) ([Zhiguo Zhou](https://github.com/ZhiguoZh))。
- 支持 `LineAsString` 输入格式的并行解析。此改进略微提升了性能。此更改解决了 [#42502](https://github.com/ClickHouse/ClickHouse/issues/42502)。[#42780](https://github.com/ClickHouse/ClickHouse/pull/42780) ([Kruglov Pavel](https://github.com/Avogar))。
- ClickHouse Keeper 性能改进:改进了多个不同节点存在未提交状态时的提交性能。这有助于解决从节点无法足够快地同步的情况。[#42926](https://github.com/ClickHouse/ClickHouse/pull/42926) ([Antonio Andelic](https://github.com/antonio2368))。
- 类似 `NOT LIKE 'prefix%'` 的条件可以使用主索引。[#42209](https://github.com/ClickHouse/ClickHouse/pull/42209) ([Duc Canh Le](https://github.com/canhld94))。

#### 实验性功能 {#experimental-feature-1}

- 支持在其他类型中使用 `Object` 类型,例如 `Array(JSON)`。[#36969](https://github.com/ClickHouse/ClickHouse/pull/36969) ([Anton Popov](https://github.com/CurtizJ))。
- 在 MaterializedMySQL 中忽略 MySQL binlog SAVEPOINT 事件。[#42931](https://github.com/ClickHouse/ClickHouse/pull/42931) ([zzsmdfj](https://github.com/zzsmdfj))。在 MaterializedMySQL 中处理(忽略)SAVEPOINT 查询。[#43086](https://github.com/ClickHouse/ClickHouse/pull/43086) ([Stig Bakken](https://github.com/stigsb))。


#### 改进 {#improvement-1}

- 带有小 LIMIT 的简单查询现在能够正确确定预估读取的行数,从而正确检查阈值。关闭 [#7071](https://github.com/ClickHouse/ClickHouse/issues/7071)。[#42580](https://github.com/ClickHouse/ClickHouse/pull/42580) ([Han Fei](https://github.com/hanfei1991))。
- 在 INSERT VALUES 查询中添加对交互式参数的支持。[#43077](https://github.com/ClickHouse/ClickHouse/pull/43077) ([Nikolay Degterinsky](https://github.com/evillique))。
- 在 `system.table_functions` 中添加了新字段 `allow_readonly`,以允许在只读模式下使用表函数。解决 [#42414](https://github.com/ClickHouse/ClickHouse/issues/42414) 实现:_ 在 system.table_functions 表中添加了新字段 allow_readonly。_ 更新以使用新字段 allow_readonly 来允许在只读模式下使用表函数。测试:_ 为文件系统添加了测试 tests/queries/0_stateless/02473_functions_in_readonly_mode.sh 文档:_ 更新了表函数的英文文档。[#42708](https://github.com/ClickHouse/ClickHouse/pull/42708) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
- `system.asynchronous_metrics` 获得了内嵌文档。该文档也会导出到 Prometheus。修复了关于 `cache` 磁盘指标的错误 - 之前仅针对一个任意缓存磁盘计算,而不是所有缓存磁盘。关闭 [#7644](https://github.com/ClickHouse/ClickHouse/issues/7644)。[#43194](https://github.com/ClickHouse/ClickHouse/pull/43194) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 限流算法更改为令牌桶算法。[#42665](https://github.com/ClickHouse/ClickHouse/pull/42665) ([Sergei Trifonov](https://github.com/serxa))。
- 在 `system.query_log` 和 `/var/log/clickhouse-server/*.log` 以及错误消息中屏蔽密码和密钥。[#42484](https://github.com/ClickHouse/ClickHouse/pull/42484) ([Vitaly Baranov](https://github.com/vitlibar))。
- 为已获取的数据分区删除被覆盖的分区(以避免可能的复制延迟增长)。[#39737](https://github.com/ClickHouse/ClickHouse/pull/39737) ([Azat Khuzhin](https://github.com/azat))。
- 如果 `/dev/tty` 可用,clickhouse-client 和 clickhouse-local 中的进度将直接渲染到终端,而不写入 STDERR。这允许即使 STDERR 被重定向到文件时也能获取进度,并且文件不会被终端转义序列污染。可以通过 `--progress false` 禁用进度显示。关闭 [#32238](https://github.com/ClickHouse/ClickHouse/issues/32238)。[#42003](https://github.com/ClickHouse/ClickHouse/pull/42003) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 为 base64 编码函数添加对 `FixedString` 输入的支持。[#42285](https://github.com/ClickHouse/ClickHouse/pull/42285) ([ltrk2](https://github.com/ltrk2))。
- 向 `system.detached_parts` 添加 `bytes_on_disk` 和 `path` 列。关闭 [#42264](https://github.com/ClickHouse/ClickHouse/issues/42264)。[#42303](https://github.com/ClickHouse/ClickHouse/pull/42303) ([chen](https://github.com/xiedeyantu))。
- 改进在表函数中使用插入表结构的功能,现在设置 `use_structure_from_insertion_table_in_table_functions` 有新的可能值 - `2`,这意味着 ClickHouse 将尝试自动确定是否可以使用插入表的结构。关闭 [#40028](https://github.com/ClickHouse/ClickHouse/issues/40028)。[#42320](https://github.com/ClickHouse/ClickHouse/pull/42320) ([Kruglov Pavel](https://github.com/Avogar))。
- 修复 INSERT FROM INFILE 没有进度指示的问题。关闭 [#42548](https://github.com/ClickHouse/ClickHouse/issues/42548)。[#42634](https://github.com/ClickHouse/ClickHouse/pull/42634) ([chen](https://github.com/xiedeyantu))。
- 重构函数 `tokens` 以启用相关函数返回的最大 token 数(默认禁用)。[#42673](https://github.com/ClickHouse/ClickHouse/pull/42673) ([李扬](https://github.com/taiyang-li))。
- 允许在 `formatDateTime` 和 `FROM_UNIXTIME` 函数中使用 `Date32` 参数。[#42737](https://github.com/ClickHouse/ClickHouse/pull/42737) ([Roman Vasin](https://github.com/rvasin))。
- 将 tzdata 更新至 2022f。墨西哥除美国边境附近地区外将不再实行夏令时:https://www.timeanddate.com/news/time/mexico-abolishes-dst-2022.html。奇瓦瓦州于 2022-10-30 转为全年 UTC-6。斐济不再实行夏令时。参见 https://github.com/google/cctz/pull/235 和 https://bugs.launchpad.net/ubuntu/+source/tzdata/+bug/1995209。[#42796](https://github.com/ClickHouse/ClickHouse/pull/42796) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 为异步插入添加 `FailedAsyncInsertQuery` 事件指标。[#42814](https://github.com/ClickHouse/ClickHouse/pull/42814) ([Krzysztof Góralski](https://github.com/kgoralski))。
- 在查询计划之上实现 `read-in-order` 优化。默认启用。设置 `query_plan_read_in_order = 0` 以使用之前基于 AST 的版本。[#42829](https://github.com/ClickHouse/ClickHouse/pull/42829) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 为备份到 S3 时指数级增加上传分块的大小,以避免关于 S3 多部分上传最多 10000 个分块限制的错误。[#42833](https://github.com/ClickHouse/ClickHouse/pull/42833) ([Vitaly Baranov](https://github.com/vitlibar))。
- 当合并任务持续繁忙且磁盘空间不足时,完全过期的数据分区无法被选择和删除,导致磁盘空间不足。我的想法是,当整个数据分区过期时,不需要额外的磁盘空间保证,确保 TTL 的正常执行。[#42869](https://github.com/ClickHouse/ClickHouse/pull/42869) ([zhongyuankai](https://github.com/zhongyuankai))。
- 添加 `oss` 函数和 `OSS` 表引擎(这对用户很方便)。oss 与 s3 完全兼容。[#43155](https://github.com/ClickHouse/ClickHouse/pull/43155) ([zzsmdfj](https://github.com/zzsmdfj))。
- 改进为 `system.asynchronous_metrics` 表收集操作系统相关信息时的错误报告。[#43192](https://github.com/ClickHouse/ClickHouse/pull/43192) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 修改 `INFORMATION_SCHEMA` 表,使 ClickHouse 可以使用 MySQL 兼容协议连接到自身。添加列而不是别名(与 [#9769](https://github.com/ClickHouse/ClickHouse/issues/9769) 相关)。这将提高与各种 MySQL 客户端的兼容性。[#43198](https://github.com/ClickHouse/ClickHouse/pull/43198) ([Filatenkov Artur](https://github.com/FArthur-cmd))。
- 添加一些函数以与 PowerBI 兼容,当它使用 MySQL 协议连接时 [#42612](https://github.com/ClickHouse/ClickHouse/pull/42612) ([Filatenkov Artur](https://github.com/FArthur-cmd))。
- 改进仪表板在变更时的可用性 [#42872](https://github.com/ClickHouse/ClickHouse/pull/42872) ([Vladimir C](https://github.com/vdimir))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-1}

- 为每个拉取请求和主分支提交运行 SQLancer。[SQLancer](https://github.com/sqlancer/sqlancer) 是一个开源模糊测试工具,专注于自动检测逻辑错误。[#42397](https://github.com/ClickHouse/ClickHouse/pull/42397) ([Ilya Yatsishin](https://github.com/qoega))。
- 更新至最新版本的 zlib-ng。[#42463](https://github.com/ClickHouse/ClickHouse/pull/42463) ([Boris Kuschel](https://github.com/bkuschel))。
- 添加使用 Jepsen 测试 ClickHouse 服务器的支持。顺便提一下,我们已经支持使用 Jepsen 测试 ClickHouse Keeper。此拉取请求将支持范围扩展到了复制表。[#42619](https://github.com/ClickHouse/ClickHouse/pull/42619) ([Antonio Andelic](https://github.com/antonio2368))。
- 使用 https://github.com/matus-chochlik/ctcache 缓存 clang-tidy 结果。[#42913](https://github.com/ClickHouse/ClickHouse/pull/42913) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- 修复前,RPM 会将用户自定义配置保存在 `$file.rpmsave` 中。此 PR 修复了该问题,不再替换软件包中的用户文件。[#42936](https://github.com/ClickHouse/ClickHouse/pull/42936) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- 从 Ubuntu Docker 镜像中移除部分库。[#42622](https://github.com/ClickHouse/ClickHouse/pull/42622) ([Alexey Milovidov](https://github.com/alexey-milovidov))。

#### 错误修复(官方稳定版或预稳定版本中用户可见的异常行为) {#bug-fix-user-visible-misbehavior-in-official-stable-or-prestable-release-1}


* 更新 normaliser 以克隆 alias AST，修复了 [#42452](https://github.com/ClickHouse/ClickHouse/issues/42452)。实现：* 更新了 QueryNormalizer，使其在替换 alias 时克隆 alias AST。之前只是做相同的赋值操作，会在 LogicalExpressinsOptimizer 中导致异常，因为这等于再次插入同一个父节点。* 使用新分析器（allow&#95;experimental&#95;analyzer）时不会出现此 bug，因此无需对其进行修改。我为此添加了一个测试。[#42827](https://github.com/ClickHouse/ClickHouse/pull/42827)（[SmitaRKulkarni](https://github.com/SmitaRKulkarni)）。
* 修复 `Lazy` 数据库中表备份的竞争条件问题。[#43104](https://github.com/ClickHouse/ClickHouse/pull/43104)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复 `skip_unavailable_shards`：之前在与 `s3Cluster` 表函数一起使用时无法正常工作。 [#43131](https://github.com/ClickHouse/ClickHouse/pull/43131) ([chen](https://github.com/xiedeyantu)).
* 修复 `s3Cluster` 中的模式推断，并改进 `hdfsCluster`。[#41979](https://github.com/ClickHouse/ClickHouse/pull/41979) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复从 URL 表引擎 / 表函数读取时的重试逻辑（可重试错误可能被重试次数超过必要次数，不可重试错误会导致代码中的断言失败）。 [#42224](https://github.com/ClickHouse/ClickHouse/pull/42224) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 已报告并修复了一个与 DNS 和 c-ares 相关的段错误。[#42234](https://github.com/ClickHouse/ClickHouse/pull/42234) ([Arthur Passos](https://github.com/arthurpassos))。
* 修复在主键分析（单调性检查）中可能出现的 `LOGICAL_ERROR` `Arguments of 'plus' have incorrect data types`。修复对首个参数为常量的单调二元函数进行主键分析时的错误结果。[#42410](https://github.com/ClickHouse/ClickHouse/pull/42410) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复在键类型不能为 `Nullable` 时的错误键分析。修复了 [#42456](https://github.com/ClickHouse/ClickHouse/issues/42456)。[#42469](https://github.com/ClickHouse/ClickHouse/pull/42469)（[Amos Bird](https://github.com/amosbird)）。
* 修复了一个设置名称中的拼写错误，该错误在使用设置 `input_format_csv_use_best_effort_in_schema_inference` 时导致错误地使用了模式推断缓存。修复了 [#41735](https://github.com/ClickHouse/ClickHouse/issues/41735)。[#42536](https://github.com/ClickHouse/ClickHouse/pull/42536)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复在数据类型为 `LowCardinality` 时创建 `Set` 时使用错误表头的问题。关闭 [#42460](https://github.com/ClickHouse/ClickHouse/issues/42460)。[#42579](https://github.com/ClickHouse/ClickHouse/pull/42579)（[flynn](https://github.com/ucasfl)）。
* 在 `PREWHERE` 中对 `(U)Int128` 和 `(U)Int256` 值进行了正确检查。[#42605](https://github.com/ClickHouse/ClickHouse/pull/42605) ([Antonio Andelic](https://github.com/antonio2368))。
* 修复了 `functions` 解析器中一个可能导致段错误的缺陷。 [#42724](https://github.com/ClickHouse/ClickHouse/pull/42724) ([Nikolay Degterinsky](https://github.com/evillique)).
* 修复 `truncate table` 中的锁定机制。[#42728](https://github.com/ClickHouse/ClickHouse/pull/42728) ([flynn](https://github.com/ucasfl)).
* 修复当文件不存在时（或执行 `OPTIMIZE TABLE FINAL` 时，最终也可能出现相同错误）`web` 磁盘可能发生的崩溃。[#42767](https://github.com/ClickHouse/ClickHouse/pull/42767) ([Azat Khuzhin](https://github.com/azat)).
* 通过在枚举值中加入 `SSL_CERTIFICATE`，修复 `system.session_log` 中的 `auth_type` 映射。[#42782](https://github.com/ClickHouse/ClickHouse/pull/42782) ([Miel Donkers](https://github.com/mdonkers))。
* 在 ASAN 构建中修复 `Create User` 查询解析器中的 `stack-use-after-return` 问题。[#42804](https://github.com/ClickHouse/ClickHouse/pull/42804) ([Nikolay Degterinsky](https://github.com/evillique))。
* 修复在符号跨越 16 字节边界时的 `lowerUTF8`/`upperUTF8` 行为（当字符串长度大于 16 字节时这是非常常见的情况）。 [#42812](https://github.com/ClickHouse/ClickHouse/pull/42812) ([Azat Khuzhin](https://github.com/azat))。
* 为修复在输入数据损坏情况下的异常行为，在 LZ4 解压过程里添加了额外的边界检查。 [#42868](https://github.com/ClickHouse/ClickHouse/pull/42868) ([Nikita Taranov](https://github.com/nickitat)).
* 修复在取消查询时可能出现的罕见挂起问题。 [#42874](https://github.com/ClickHouse/ClickHouse/pull/42874) ([Azat Khuzhin](https://github.com/azat)).
* 修复 `hash join` 在包含多个析取条件时的错误行为，关闭 [#42832](https://github.com/ClickHouse/ClickHouse/issues/42832)。[#42876](https://github.com/ClickHouse/ClickHouse/pull/42876)（[Vladimir C](https://github.com/vdimir)）。
* 在执行包含 `IF ... AS ...` 且涉及“三表 JOIN”的查询时会生成空指针，例如如下 SQL 查询：[#42883](https://github.com/ClickHouse/ClickHouse/pull/42883)（[zzsmdfj](https://github.com/zzsmdfj)）。
* 修复 Cluster Discovery 中的 memory sanitizer 报告，关闭 [#42763](https://github.com/ClickHouse/ClickHouse/issues/42763)。[#42905](https://github.com/ClickHouse/ClickHouse/pull/42905)（[Vladimir C](https://github.com/vdimir)）。
* 在空字符串情况下改进 `DateTime` 架构推断。 [#42911](https://github.com/ClickHouse/ClickHouse/pull/42911) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复在可以使用投影但实际上没有可用投影时偶尔出现的 `NOT_FOUND_COLUMN_IN_BLOCK` 错误。该修复解决了 [#42771](https://github.com/ClickHouse/ClickHouse/issues/42771)。该 bug 最初引入于 [https://github.com/ClickHouse/ClickHouse/pull/25563](https://github.com/ClickHouse/ClickHouse/pull/25563)。[#42938](https://github.com/ClickHouse/ClickHouse/pull/42938)（[Amos Bird](https://github.com/amosbird)）。
* 修复 `PostgreSQL` 数据库引擎中，当表包含 DATETIME 数据类型时的 ATTACH TABLE 操作问题。关闭 [#42817](https://github.com/ClickHouse/ClickHouse/issues/42817)。[#42960](https://github.com/ClickHouse/ClickHouse/pull/42960)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复 lambda 解析问题。关闭 [#41848](https://github.com/ClickHouse/ClickHouse/issues/41848)。[#42979](https://github.com/ClickHouse/ClickHouse/pull/42979)（[Nikolay Degterinsky](https://github.com/evillique)）。
* 修复在可空键出现在超矩形中间时的错误键分析问题。修复了 [#43111](https://github.com/ClickHouse/ClickHouse/issues/43111)。[#43133](https://github.com/ClickHouse/ClickHouse/pull/43133)（[Amos Bird](https://github.com/amosbird)）。
* 修复在反序列化精心构造的聚合函数状态时出现的多个缓冲区越界读取问题。[#43159](https://github.com/ClickHouse/ClickHouse/pull/43159)（[Raúl Marín](https://github.com/Algunenano)）。
* 修复函数 `if` 在处理 NULL 和常量 Nullable 参数时的行为。修复 [#43069](https://github.com/ClickHouse/ClickHouse/issues/43069)。[#43178](https://github.com/ClickHouse/ClickHouse/pull/43178)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复使用“best effort”算法解析 `DateTime` 时出现的小数运算溢出问题。关闭 [#43061](https://github.com/ClickHouse/ClickHouse/issues/43061)。[#43180](https://github.com/ClickHouse/ClickHouse/pull/43180)（[Kruglov Pavel](https://github.com/Avogar)）。
* 由 `git-import` 工具生成的 `indent` 字段计算不正确。参见 [https://clickhouse.com/docs/getting-started/example-datasets/github/](https://clickhouse.com/docs/getting-started/example-datasets/github/)。[#43191](https://github.com/ClickHouse/ClickHouse/pull/43191)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 修复了在子查询和类型转换中使用 `Interval` 类型时出现的非预期行为。[#43193](https://github.com/ClickHouse/ClickHouse/pull/43193) ([jh0x](https://github.com/jh0x))。

### <a id="2210"></a> ClickHouse release 22.10, 2022-10-25 {#a-id2210a-clickhouse-release-2210-2022-10-25}

#### 向后不兼容的变更 {#backward-incompatible-change-1}

- 重命名缓存命令：`show caches` -> `show filesystem caches`，`describe cache` -> `describe filesystem cache`。[#41508](https://github.com/ClickHouse/ClickHouse/pull/41508) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 移除对 `LIVE VIEW` 的 `WITH TIMEOUT` 部分的支持。此更改关闭了 [#40557](https://github.com/ClickHouse/ClickHouse/issues/40557)。[#42173](https://github.com/ClickHouse/ClickHouse/pull/42173) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 从客户端提示符中移除对 `{database}` 宏的支持。当数据库未指定时,该宏显示不正确,并且在执行 `USE` 语句时不会更新。此更改关闭了 [#25891](https://github.com/ClickHouse/ClickHouse/issues/25891)。[#42508](https://github.com/ClickHouse/ClickHouse/pull/42508) ([Alexey Milovidov](https://github.com/alexey-milovidov))。


#### 新功能 {#new-feature-2}

- 新增可组合协议配置。现在可以为不同的协议配置不同的监听主机。协议包装器(如 PROXYv1)可以在任何其他协议(TCP、TCP secure、MySQL、Postgres)之上配置。[#41198](https://github.com/ClickHouse/ClickHouse/pull/41198) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
- 新增 `S3` 作为备份目标类型。支持以原始路径/数据结构备份到 S3。[#42333](https://github.com/ClickHouse/ClickHouse/pull/42333) ([Vitaly Baranov](https://github.com/vitlibar))、[#42232](https://github.com/ClickHouse/ClickHouse/pull/42232) ([Azat Khuzhin](https://github.com/azat))。
- 新增函数(`randUniform`、`randNormal`、`randLogNormal`、`randExponential`、`randChiSquared`、`randStudentT`、`randFisherF`、`randBernoulli`、`randBinomial`、`randNegativeBinomial`、`randPoisson`)用于根据指定分布生成随机值。此功能解决了 [#21834](https://github.com/ClickHouse/ClickHouse/issues/21834)。[#42411](https://github.com/ClickHouse/ClickHouse/pull/42411) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- ClickHouse Keeper 改进:新增支持将快照上传到 S3。S3 信息可在 `keeper_server.s3_snapshot` 中定义。[#41342](https://github.com/ClickHouse/ClickHouse/pull/41342) ([Antonio Andelic](https://github.com/antonio2368))。
- 新增聚合函数 `analysisOfVariance`(`anova`)用于对多组正态分布观测值执行统计检验,以确定所有组的均值是否相同。原始 PR [#37872](https://github.com/ClickHouse/ClickHouse/issues/37872)。[#42131](https://github.com/ClickHouse/ClickHouse/pull/42131) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 支持使用设置 `max_temporary_data_on_disk_size_for_user`/`max_temporary_data_on_disk_size_for_query` 限制磁盘上存储的临时数据大小。[#40893](https://github.com/ClickHouse/ClickHouse/pull/40893) ([Vladimir C](https://github.com/vdimir))。
- 新增设置 `format_json_object_each_row_column_for_object_name` 用于在 JSONObjectEachRow 格式中将对象名称作为列值写入/解析。[#41703](https://github.com/ClickHouse/ClickHouse/pull/41703) ([Kruglov Pavel](https://github.com/Avogar))。
- 在 SQL 中新增 BLAKE3 哈希函数。[#33435](https://github.com/ClickHouse/ClickHouse/pull/33435) ([BoloniniD](https://github.com/BoloniniD))。
- 函数 `javaHash` 已扩展支持整数类型。[#41131](https://github.com/ClickHouse/ClickHouse/pull/41131) ([JackyWoo](https://github.com/JackyWoo))。
- 为 ON CLUSTER DDL 新增 OpenTelemetry 支持(需要将 `distributed_ddl_entry_format_version` 设置为 4)。[#41484](https://github.com/ClickHouse/ClickHouse/pull/41484) ([Frank Chen](https://github.com/FrankChen021))。
- 新增系统表 `asynchronous_insert_log`。该表包含异步插入的相关信息(包括即发即弃模式下的查询结果(使用 `wait_for_async_insert=0`)),以便更好地进行监控和分析。[#42040](https://github.com/ClickHouse/ClickHouse/pull/42040) ([Anton Popov](https://github.com/CurtizJ))。
- 在 HTTP 的 `Accept-Encoding` 中新增对 `lz4`、`bz2`、`snappy` 方法的支持,这是对 HTTP 协议的非标准扩展。[#42071](https://github.com/ClickHouse/ClickHouse/pull/42071) ([Nikolay Degterinsky](https://github.com/evillique))。
- 新增 Morton 编码(ZCurve)编码/解码函数。[#41753](https://github.com/ClickHouse/ClickHouse/pull/41753) ([Constantine Peresypkin](https://github.com/pkit))。
- 新增对 `SET setting_name = DEFAULT` 的支持。[#42187](https://github.com/ClickHouse/ClickHouse/pull/42187) ([Filatenkov Artur](https://github.com/FArthur-cmd))。

#### 实验性功能 {#experimental-feature-2}

- 在 `allow_experimental_analyzer` 设置下添加了用于查询分析和规划的新基础架构。[#31796](https://github.com/ClickHouse/ClickHouse/pull/31796) ([Maksim Kita](https://github.com/kitaisreal))。
- Kusto Query Language 的初步实现。请勿使用。[#37961](https://github.com/ClickHouse/ClickHouse/pull/37961) ([Yong Wang](https://github.com/kashwy))。

#### 性能改进 {#performance-improvement-2}

- 放宽了"分区过多"的阈值。这解决了 [#6551](https://github.com/ClickHouse/ClickHouse/issues/6551)。现在,如果平均分区大小足够大(至少 10 GiB),ClickHouse 将允许分区中包含更多数据分区。这使得单个服务器上的单个表的单个分区可以容纳高达 PB 级的数据,通过磁盘阵列或对象存储即可实现。[#42002](https://github.com/ClickHouse/ClickHouse/pull/42002) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 实现运算符优先级元素解析器以减小所需的堆栈大小。[#34892](https://github.com/ClickHouse/ClickHouse/pull/34892) ([Nikolay Degterinsky](https://github.com/evillique))。
- DISTINCT 顺序优化利用了数据流的排序属性。此改进将在适用时为 DISTINCT 启用顺序读取(之前必须为 DISTINCT 中的列提供 ORDER BY)。[#41014](https://github.com/ClickHouse/ClickHouse/pull/41014) ([Igor Nikonov](https://github.com/devcrafter))。
- ColumnVector:使用 AVX512VBMI 优化 UInt8 索引。[#41247](https://github.com/ClickHouse/ClickHouse/pull/41247) ([Guo Wangyang](https://github.com/guowangy))。
- 优化 `ThreadGroupStatus::mutex` 的锁竞争。在 ICX 设备(Intel Xeon Platinum 8380 CPU,80 核,160 线程)上进行的 **SSB**(星型模式基准测试)性能实验表明,此更改可使所有子用例 QPS 的几何平均值提升 **2.95 倍**。[#41675](https://github.com/ClickHouse/ClickHouse/pull/41675) ([Zhiguo Zhou](https://github.com/ZhiguoZh))。
- 为 AArch64 构建添加 `ldapr` 功能。从 Graviton 2+、Azure 和 GCP 实例开始支持。仅在不久前的 clang-15 中[出现](https://github.com/llvm/llvm-project/commit/9609b5daffe9fd28d83d83da895abc5113f76c24)。[#41778](https://github.com/ClickHouse/ClickHouse/pull/41778) ([Daniel Kutenin](https://github.com/danlark1))。
- 改进字符串比较性能,当其中一个参数是空常量字符串时。[#41870](https://github.com/ClickHouse/ClickHouse/pull/41870) ([Jiebin Sun](https://github.com/jiebinn))。
- 优化 ColumnAggregateFunction 的 `insertFrom`,在某些情况下共享聚合状态。[#41960](https://github.com/ClickHouse/ClickHouse/pull/41960) ([flynn](https://github.com/ucasfl))。
- 加快向 `azure_blob_storage` 磁盘写入的速度(遵循 `max_single_part_upload_size` 而不是每个缓冲区大小写入一个块)。[#41754](https://github.com/ClickHouse/ClickHouse/issues/41754) 中提到了低效问题。[#42041](https://github.com/ClickHouse/ClickHouse/pull/42041) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 使进程列表和 query_log 中的线程 ID 唯一,以避免浪费。[#42180](https://github.com/ClickHouse/ClickHouse/pull/42180) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 支持在请求的读取范围超过缓存设置 `bypass_cache_threashold` 定义的阈值时完全跳过缓存(包括下载到缓存和读取缓存数据),需要通过 `enable_bypass_cache_with_threshold` 启用。[#42418](https://github.com/ClickHouse/ClickHouse/pull/42418) ([Han Shukai](https://github.com/KinderRiven))。这对慢速本地磁盘有帮助。


#### 改进 {#improvement-2}

- 添加设置 `allow_implicit_no_password`:与 `allow_no_password` 结合使用时,除非明确指定 `IDENTIFIED WITH no_password`,否则禁止创建无密码用户。[#41341](https://github.com/ClickHouse/ClickHouse/pull/41341) ([Nikolay Degterinsky](https://github.com/evillique))。
- 嵌入式 Keeper 将始终在后台启动,允许 ClickHouse 在未达到仲裁数的情况下启动。[#40991](https://github.com/ClickHouse/ClickHouse/pull/40991) ([Antonio Andelic](https://github.com/antonio2368))。
- 使得在先前连接过期的情况下重新建立到 ZooKeeper 的新连接更加及时。以前默认每分钟生成一个任务,因此表可能在大约这段时间内处于只读状态。[#41092](https://github.com/ClickHouse/ClickHouse/pull/41092) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 现在投影可以与零拷贝复制一起使用(零拷贝复制是非生产环境功能)。[#41147](https://github.com/ClickHouse/ClickHouse/pull/41147) ([alesapin](https://github.com/alesapin))。
- 支持在子查询中使用表达式 `(EXPLAIN SELECT ...)`。像 `SELECT * FROM (EXPLAIN PIPELINE SELECT col FROM TABLE ORDER BY col)` 这样的查询现在有效。[#40630](https://github.com/ClickHouse/ClickHouse/pull/40630) ([Vladimir C](https://github.com/vdimir))。
- 允许在查询范围内更改 `async_insert_max_data_size` 或 `async_insert_busy_timeout_ms`。例如,用户希望很少插入数据,但无法访问服务器配置来调整默认设置。[#40668](https://github.com/ClickHouse/ClickHouse/pull/40668) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 改进从远程文件系统读取的功能,使读/写的线程池大小可配置。关闭 [#41070](https://github.com/ClickHouse/ClickHouse/issues/41070)。[#41011](https://github.com/ClickHouse/ClickHouse/pull/41011) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 支持在 WindowTransform/arratReduce\*/initializeAggregation/聚合函数版本控制中使用所有组合器组合。以前像 `ForEach/Resample/Map` 这样的组合器在这些地方不起作用,使用它们会导致类似 `State function ... inserts results into non-state column` 的异常。[#41107](https://github.com/ClickHouse/ClickHouse/pull/41107) ([Kruglov Pavel](https://github.com/Avogar))。
- 添加函数 `tryDecrypt`,当解密失败时(例如使用错误的密钥解密)返回 NULL,而不是抛出异常。[#41206](https://github.com/ClickHouse/ClickHouse/pull/41206) ([Duc Canh Le](https://github.com/canhld94))。
- 向 `system.disks` 表添加 `unreserved_space` 列,以检查每个磁盘上有多少空间未被预留占用。[#41254](https://github.com/ClickHouse/ClickHouse/pull/41254) ([filimonov](https://github.com/filimonov))。
- 支持在表函数参数中使用 s3 授权头。[#41261](https://github.com/ClickHouse/ClickHouse/pull/41261) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 在 Keeper 和内部 ZooKeeper 客户端中添加对 MultiRead 的支持(这是 ZooKeeper 协议的扩展,仅在 ClickHouse Keeper 中可用)。[#41410](https://github.com/ClickHouse/ClickHouse/pull/41410) ([Antonio Andelic](https://github.com/antonio2368))。
- 添加对在 IN 运算符中将十进制类型与浮点字面量进行比较的支持。[#41544](https://github.com/ClickHouse/ClickHouse/pull/41544) ([liang.huang](https://github.com/lhuang09287750))。
- 允许在缓存配置中使用可读的大小值(如 `1TB`)。[#41688](https://github.com/ClickHouse/ClickHouse/pull/41688) ([Kseniia Sumarokova](https://github.com/kssenii))。
- ClickHouse 可能会在一段时间内(默认为 15 秒)缓存过期的 DNS 条目,直到缓存异步更新。在此期间,ClickHouse 仍可能尝试建立连接并产生错误。此行为已修复。[#41707](https://github.com/ClickHouse/ClickHouse/pull/41707) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 为 `clickhouse-client`/`clickhouse-local` 添加使用类似 fzf 的工具(fzf/sk)进行交互式历史搜索(注意您可以使用 `FZF_DEFAULT_OPTS`/`SKIM_DEFAULT_OPTIONS` 来额外配置行为)。[#41730](https://github.com/ClickHouse/ClickHouse/pull/41730) ([Azat Khuzhin](https://github.com/azat))。
- 仅允许使用 '--accept-certificate' 标志的客户端连接到具有无效证书的安全服务器。[#41743](https://github.com/ClickHouse/ClickHouse/pull/41743) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
- 添加函数 `tryBase58Decode`,类似于现有函数 `tryBase64Decode`。[#41824](https://github.com/ClickHouse/ClickHouse/pull/41824) ([Robert Schulze](https://github.com/rschu1ze))。
- 改进使用不同主键替换分区时的反馈。修复 [#34798](https://github.com/ClickHouse/ClickHouse/issues/34798)。[#41838](https://github.com/ClickHouse/ClickHouse/pull/41838) ([Salvatore](https://github.com/tbsal))。
- 修复并行解析:分段器现在检查 `max_block_size`。这修复了在并行解析和小 LIMIT 情况下的内存过度分配问题。[#41852](https://github.com/ClickHouse/ClickHouse/pull/41852) ([Vitaly Baranov](https://github.com/vitlibar))。
- 如果在从系统表执行 SELECT 期间发生 "TABLE_IS_DROPPED" 异常并被忽略,则不要将其添加到 `system.errors`。[#41908](https://github.com/ClickHouse/ClickHouse/pull/41908) ([AlfVII](https://github.com/AlfVII))。
- 改进选项 `enable_extended_results_for_datetime_functions`,使函数 `toStartOfDay`、`toStartOfHour`、`toStartOfFifteenMinutes`、`toStartOfTenMinutes`、`toStartOfFiveMinutes`、`toStartOfMinute` 和 `timeSlot` 返回 DateTime64 类型的结果。[#41910](https://github.com/ClickHouse/ClickHouse/pull/41910) ([Roman Vasin](https://github.com/rvasin))。
- 改进文本格式的 `DateTime` 类型推断。现在它遵循设置 `date_time_input_format`,并且不会尝试将数字推断为时间戳的日期时间。关闭 [#41389](https://github.com/ClickHouse/ClickHouse/issues/41389) 关闭 [#42206](https://github.com/ClickHouse/ClickHouse/issues/42206)。[#41912](https://github.com/ClickHouse/ClickHouse/pull/41912) ([Kruglov Pavel](https://github.com/Avogar))。
- 移除在 `perform_ttl_move_on_insert` = false 时插入数据时的混淆警告。[#41980](https://github.com/ClickHouse/ClickHouse/pull/41980) ([Vitaly Baranov](https://github.com/vitlibar))。
- 允许用户编写 `countState(*)`,类似于 `count(*)`。这关闭了 [#9338](https://github.com/ClickHouse/ClickHouse/issues/9338)。[#41983](https://github.com/ClickHouse/ClickHouse/pull/41983) ([Amos Bird](https://github.com/amosbird))。
- 修复 `rankCorr` 大小溢出。[#42020](https://github.com/ClickHouse/ClickHouse/pull/42020) ([Duc Canh Le](https://github.com/canhld94))。
- 添加了一个选项,可以在 Sentry 的配置中指定任意字符串作为环境名称,以便生成更方便的报告。[#42037](https://github.com/ClickHouse/ClickHouse/pull/42037) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 修复从 CSV 解析超出范围的 Date。[#42044](https://github.com/ClickHouse/ClickHouse/pull/42044) ([Andrey Zvonov](https://github.com/zvonand))。
- `parseDataTimeBestEffort` 现在支持日期和时间之间的逗号。关闭 [#42038](https://github.com/ClickHouse/ClickHouse/issues/42038)。[#42049](https://github.com/ClickHouse/ClickHouse/pull/42049) ([flynn](https://github.com/ucasfl))。
- 改进了 `ReplicatedMergeTree` 的过期副本恢复过程。如果丢失的副本具有健康副本中不存在的某些部分,但根据健康副本的复制队列,这些部分应该在将来出现,那么丢失的副本将保留这些部分而不是分离它们。[#42134](https://github.com/ClickHouse/ClickHouse/pull/42134) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 添加了为 date_diff 函数使用 `Date32` 参数的可能性。修复了在使用 DateTime64 参数时,起始日期在 Unix 纪元之前且结束日期在 Unix 纪元之后的 date_diff 函数问题。[#42308](https://github.com/ClickHouse/ClickHouse/pull/42308) ([Roman Vasin](https://github.com/rvasin))。
- 当向 Minio 上传大部分数据时,'Complete Multipart Upload' 可能需要很长时间。Minio 每 10 秒发送一次心跳(参见 https://github.com/minio/minio/pull/7198)。但 clickhouse 会更早超时,因为默认的发送/接收超时[设置](https://github.com/ClickHouse/ClickHouse/blob/cc24fcd6d5dfb67f5f66f5483e986bd1010ad9cf/src/IO/S3/PocoHTTPClient.cpp#L123)为 5 秒。[#42321](https://github.com/ClickHouse/ClickHouse/pull/42321) ([filimonov](https://github.com/filimonov))。
- 修复了具有复杂类型(如 Decimal)的聚合状态类型的罕见无效转换。这修复了 [#42408](https://github.com/ClickHouse/ClickHouse/issues/42408)。[#42417](https://github.com/ClickHouse/ClickHouse/pull/42417) ([Amos Bird](https://github.com/amosbird))。
- 允许为 `dateName` 函数使用 `Date32` 参数。[#42554](https://github.com/ClickHouse/ClickHouse/pull/42554) ([Roman Vasin](https://github.com/rvasin))。
- 现在在索引分析期间将使用带有 NULL 字面量的过滤器。[#34063](https://github.com/ClickHouse/ClickHouse/issues/34063)。[#41842](https://github.com/ClickHouse/ClickHouse/pull/41842) ([Amos Bird](https://github.com/amosbird))。
- 如果范围内的每个部分都早于某个阈值,则合并部分。可以使用 `min_age_to_force_merge_seconds` 设置阈值。这关闭了 [#35836](https://github.com/ClickHouse/ClickHouse/issues/35836)。[#42423](https://github.com/ClickHouse/ClickHouse/pull/42423) ([Antonio Andelic](https://github.com/antonio2368))。这是 [@fastio](https://github.com/fastio) 的 [#39550i](https://github.com/ClickHouse/ClickHouse/pull/39550) 的延续,他实现了大部分逻辑。
- 在 `allow_experimental_analyzer` 设置下添加了用于查询分析和规划的新基础设施。[#31796](https://github.com/ClickHouse/ClickHouse/pull/31796) ([Maksim Kita](https://github.com/kitaisreal))。
- 改进恢复丢失的 keeper 连接的时间。[#42541](https://github.com/ClickHouse/ClickHouse/pull/42541) ([Raúl Marín](https://github.com/Algunenano))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-2}

- 为表定义添加模糊测试器 [#40096](https://github.com/ClickHouse/ClickHouse/pull/40096) ([Anton Popov](https://github.com/CurtizJ))。这是今年迄今为止 ClickHouse 测试方面最大的进步。
- ClickHouse Cloud 服务的 Beta 版本已发布:[https://console.clickhouse.cloud/](https://console.clickhouse.cloud/)。它提供了使用 ClickHouse 最简单的方式(甚至比单命令安装更简单)。
- 为 AST 模糊测试器添加了 WHERE 子句生成支持,以及添加或删除 ORDER BY 和 WHERE 子句的功能。[#38519](https://github.com/ClickHouse/ClickHouse/pull/38519) ([Ilya Yatsishin](https://github.com/qoega))。
- Aarch64 二进制文件现在至少需要 2016 年发布的 ARMv8.2 版本。最值得注意的是,这使得可以使用 ARM LSE,即原生原子操作。此外,还添加了 CMake 构建选项 "NO_ARMV81_OR_HIGHER",以允许为较旧的 ARMv8.0 硬件(例如 Raspberry Pi 4)编译二进制文件。[#41610](https://github.com/ClickHouse/ClickHouse/pull/41610) ([Robert Schulze](https://github.com/rschu1ze))。
- 允许使用 Musl 构建 ClickHouse(在之前已支持但损坏后进行的小改动)。[#41987](https://github.com/ClickHouse/ClickHouse/pull/41987) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 添加 `$CLICKHOUSE_CRONFILE` 文件检查,以避免在安装时运行 `sed` 命令导致文件未找到错误。[#42081](https://github.com/ClickHouse/ClickHouse/pull/42081) ([Chun-Sheng, Li](https://github.com/peter279k))。
- 将 cctz 更新至 `2022e` 以支持新的时区变更。巴勒斯坦的时区转换现在为周六 02:00。将乌克兰的三个时区简化为一个。约旦和叙利亚从带有夏令时的 +02/+03 切换为全年 +03。(https://data.iana.org/time-zones/tzdb/NEWS)。这解决了 [#42252](https://github.com/ClickHouse/ClickHouse/issues/42252)。[#42327](https://github.com/ClickHouse/ClickHouse/pull/42327) ([Alexey Milovidov](https://github.com/alexey-milovidov))。[#42273](https://github.com/ClickHouse/ClickHouse/pull/42273) ([Dom Del Nano](https://github.com/ddelnano))。
- 在 ClickHouse 中添加 Rust 代码支持,以 BLAKE3 哈希函数库为例。[#33435](https://github.com/ClickHouse/ClickHouse/pull/33435) ([BoloniniD](https://github.com/BoloniniD))。

#### 错误修复(官方稳定版或预发布版本中用户可见的异常行为) {#bug-fix-user-visible-misbehavior-in-official-stable-or-prestable-release-2}


* 为大整数类型的 `LowCardinality` 选择正确的聚合方法。[#42342](https://github.com/ClickHouse/ClickHouse/pull/42342) ([Duc Canh Le](https://github.com/canhld94)).
* 对 `web` 磁盘进行了一些修复。[#41652](https://github.com/ClickHouse/ClickHouse/pull/41652) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 修复了一个问题：当配置中未设置 `https_port` 时，会导致 docker run 失败。 [#41693](https://github.com/ClickHouse/ClickHouse/pull/41693) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* 在服务器关闭或执行 `SYSTEM STOP MERGES` 查询时，变更操作无法被正确取消，且取消过程可能耗时较长，该问题已修复。 [#41699](https://github.com/ClickHouse/ClickHouse/pull/41699) ([Alexander Tokmakov](https://github.com/tavplubix)).
* 修复在启用“按顺序读取”优化（设置 `optimize_read_in_order` 和 `optimize_aggregation_in_order`）时，对使用排序键前缀列并包裹在单调函数中的 `ORDER BY` 或 `GROUP BY` 查询返回错误结果的问题。 [#41701](https://github.com/ClickHouse/ClickHouse/pull/41701) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在启用 `optimize_monotonous_functions_in_order_by` 设置时，对 `Merge` 表执行 `SELECT` 查询可能发生的崩溃。修复了 [#41269](https://github.com/ClickHouse/ClickHouse/issues/41269)。[#41740](https://github.com/ClickHouse/ClickHouse/pull/41740)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在极少数情况下可能出现的 “Part ... intersects part ...” 错误，这种情况可能发生在副本在将某个分片标记为损坏并分离之后立刻重启时。 [#41741](https://github.com/ClickHouse/ClickHouse/pull/41741) ([Alexander Tokmakov](https://github.com/tavplubix)).
* 不允许创建或修改包含列名 `_row_exists` 的 MergeTree 表，该列名保留用于轻量级删除。已修复 [#41716](https://github.com/ClickHouse/ClickHouse/issues/41716)。[#41763](https://github.com/ClickHouse/ClickHouse/pull/41763)（[Jianmei Zhang](https://github.com/zhangjmruc)）。
* 修复了某些 HTTP 响应中缺少 CORS 头部的问题。 [#41792](https://github.com/ClickHouse/ClickHouse/pull/41792) ([Frank Chen](https://github.com/FrankChen021)).
* 如果某个 `ReplicatedMergeTree` 表由 20.3 或更早版本创建且从未执行过 `ALTER`，则在 22.9 中可能无法启动该表，此问题已修复。修复了 [#41742](https://github.com/ClickHouse/ClickHouse/issues/41742)。[#41796](https://github.com/ClickHouse/ClickHouse/pull/41796)（[Alexander Tokmakov](https://github.com/tavplubix)）。
* 当批量发送因某种原因失败时，无法自动恢复，如果不能及时处理，就会导致积压，打印的错误信息会越来越长，最终导致 http 线程阻塞。[#41813](https://github.com/ClickHouse/ClickHouse/pull/41813) ([zhongyuankai](https://github.com/zhongyuankai))。
* 修复了在启用压缩 marks 设置时 compact parts 的问题。修复了 [#41783](https://github.com/ClickHouse/ClickHouse/issues/41783) 和 [#41746](https://github.com/ClickHouse/ClickHouse/issues/41746)。[#41823](https://github.com/ClickHouse/ClickHouse/pull/41823)（[alesapin](https://github.com/alesapin)）。
* 旧版本的 Replicated 数据库在 [Zoo]Keeper 中没有特殊标记。我们只需要检查该节点是否包含某些异常数据，而不是检查是否存在特殊标记。[#41875](https://github.com/ClickHouse/ClickHouse/pull/41875) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 修复 `fs cache` 中可能出现的异常。[#41884](https://github.com/ClickHouse/ClickHouse/pull/41884) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 修复 s3 表函数的 `use_environment_credentials` 参数。 [#41970](https://github.com/ClickHouse/ClickHouse/pull/41970) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 修复了在分离损坏数据 part 时出现的 “Directory already exists and is not empty” 错误，该错误可能会阻止 `ReplicatedMergeTree` 表启动复制。修复 [#40957](https://github.com/ClickHouse/ClickHouse/issues/40957)。[#41981](https://github.com/ClickHouse/ClickHouse/pull/41981)（[Alexander Tokmakov](https://github.com/tavplubix)）。
* `toDateTime64` 现在在传入负整数和负浮点数参数时返回相同的结果。[#42025](https://github.com/ClickHouse/ClickHouse/pull/42025) ([Robert Schulze](https://github.com/rschu1ze))。
* 修复向 `azure_blob_storage` 写入的问题。部分解决 [#41754](https://github.com/ClickHouse/ClickHouse/issues/41754)。[#42034](https://github.com/ClickHouse/ClickHouse/pull/42034)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复特定 `bzip2` 文件的 `bzip2` 解码错误。[#42046](https://github.com/ClickHouse/ClickHouse/pull/42046)（[Nikolay Degterinsky](https://github.com/evillique)）。
* 修复在扩展范围起始处（1900 年 1 月）启用设置 &quot;enable&#95;extended&#95;results&#95;for&#95;datetime&#95;functions = 1&quot; 时 SQL 函数 `toLastDayOfMonth` 的问题。- 修复在扩展范围末尾（2299 年 12 月）启用设置 &quot;enable&#95;extended&#95;results&#95;for&#95;datetime&#95;functions = 1&quot; 时 SQL 函数 &quot;toRelativeWeekNum()&quot; 的问题。- 通过避免不必要的索引运算，提高 SQL 函数 &quot;toISOYear()&quot;、&quot;toFirstDayNumOfISOYearIndex()&quot; 和 &quot;toYearWeekOfNewyearMode()&quot; 的性能。[#42084](https://github.com/ClickHouse/ClickHouse/pull/42084) ([Roman Vasin](https://github.com/rvasin))。
* 此前每个表的获取操作最大数量被错误地设置为 8，而连接池大小可能更大。现在表的获取操作最大数量等于连接池大小。[#42090](https://github.com/ClickHouse/ClickHouse/pull/42090) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 在检查在不破坏表之间依赖关系的情况下是否可以删除之前，表可能会被关闭且字典可能会被分离，此问题已修复。修复了 [#41982](https://github.com/ClickHouse/ClickHouse/issues/41982)。[#42106](https://github.com/ClickHouse/ClickHouse/pull/42106)（[Alexander Tokmakov](https://github.com/tavplubix)）。
* 修复在使用文件系统缓存时 `remote_filesystem_read_method=read` 的严重低效问题。修复 [#42125](https://github.com/ClickHouse/ClickHouse/issues/42125)。[#42129](https://github.com/ClickHouse/ClickHouse/pull/42129)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在 `use_hedged_requests = 0` 时分布式查询可能出现的超时异常。[#42130](https://github.com/ClickHouse/ClickHouse/pull/42130) ([Azat Khuzhin](https://github.com/azat))。
* 修复了在将函数 `runningDifference` 与 `Date32` 类型一起使用时的一个小 bug。此前内部使用的是 `Date` 类型，这可能会导致一些逻辑错误，例如 `Bad cast from type DB::ColumnVector<int> to DB::ColumnVector<unsigned short>'`。 [#42143](https://github.com/ClickHouse/ClickHouse/pull/42143) ([Alfred Xu](https://github.com/sperlingxx)).
* 修复从基础备份中复用大于 4GB 文件的问题。[#42146](https://github.com/ClickHouse/ClickHouse/pull/42146) ([Azat Khuzhin](https://github.com/azat)).
* 如果排序键中的第一列包含函数，`DISTINCT` 在排序时会以 `LOGICAL_ERROR` 错误失败。 [#42186](https://github.com/ClickHouse/ClickHouse/pull/42186) ([Igor Nikonov](https://github.com/devcrafter))。
* 修复了与投影和 `aggregate_functions_null_for_empty` 设置相关的一个错误。此错误极其罕见，仅当你在服务器配置中启用了 `aggregate_functions_null_for_empty` 设置时才会出现。本次修复关闭了 [#41647](https://github.com/ClickHouse/ClickHouse/issues/41647)。[#42198](https://github.com/ClickHouse/ClickHouse/pull/42198)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 修复从 `Buffer` 表中按降序读取时的读取行为。[#42236](https://github.com/ClickHouse/ClickHouse/pull/42236) ([Duc Canh Le](https://github.com/canhld94)).
* 修复了一个错误：当在默认 profile 中设置了 `background_pool_size`，但未设置 `background_merges_mutations_concurrency_ratio` 时，会导致 ClickHouse 无法启动。 [#42315](https://github.com/ClickHouse/ClickHouse/pull/42315) ([nvartolomei](https://github.com/nvartolomei)).
* 对附加数据片段（其列与表结构不一致）执行 `ALTER UPDATE` 可能会在磁盘上生成无效的 `columns.txt` 元数据。从此类数据片段读取数据可能会报错或返回无效数据。修复了 [#42161](https://github.com/ClickHouse/ClickHouse/issues/42161)。[#42319](https://github.com/ClickHouse/ClickHouse/pull/42319)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 已修复 `additional_table_filters` 设置未应用于 `Distributed` 存储的问题。修复了 [#41692](https://github.com/ClickHouse/ClickHouse/issues/41692)。[#42322](https://github.com/ClickHouse/ClickHouse/pull/42322)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在查询完成/取消时出现的数据竞争问题。此更改关闭了 [#42346](https://github.com/ClickHouse/ClickHouse/issues/42346)。[#42362](https://github.com/ClickHouse/ClickHouse/pull/42362)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 此更改回滚了 [#40217](https://github.com/ClickHouse/ClickHouse/issues/40217)，该变更在日期/时间函数中引入了一个回归问题。[#42367](https://github.com/ClickHouse/ClickHouse/pull/42367)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 修复在 `JOIN` 中基于假值条件的 `assert cast` 问题，关闭 [#42380](https://github.com/ClickHouse/ClickHouse/issues/42380)。[#42407](https://github.com/ClickHouse/ClickHouse/pull/42407)（[Vladimir C](https://github.com/vdimir)）。
* 修复在处理 `Decimal` 数据类型时出现的缓冲区溢出问题。此更改关闭了 [#42451](https://github.com/ClickHouse/ClickHouse/issues/42451)。[#42465](https://github.com/ClickHouse/ClickHouse/pull/42465)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* `AggregateFunctionQuantile` 现在可以正确处理 UInt128 列。此前，分位数状态会将 `UInt128` 列解释为 `Int128`，这可能会导致结果不正确。[#42473](https://github.com/ClickHouse/ClickHouse/pull/42473) ([Antonio Andelic](https://github.com/antonio2368)).
* 修复在向非 Float32 列上的 `Annoy` 索引执行 INSERT 时触发的 bad&#95;cast 断言错误。`Annoy` 索引是一个实验性特性。[#42485](https://github.com/ClickHouse/ClickHouse/pull/42485) ([Robert Schulze](https://github.com/rschu1ze))。
* 在对 `Date` 或 `DateTime` 与 128 或 256 位整数进行算术运算时，会引用未初始化的内存。 [#42453](https://github.com/ClickHouse/ClickHouse/issues/42453)。 [#42573](https://github.com/ClickHouse/ClickHouse/pull/42573) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* 修复在服务器升级期间，当分区键包含别名函数名称时出现的意外表加载错误。[#36379](https://github.com/ClickHouse/ClickHouse/pull/36379)（[Amos Bird](https://github.com/amosbird)）。

### <a id="229"></a> ClickHouse 版本 22.9, 2022-09-22 {#a-id229a-clickhouse-release-229-2022-09-22}

#### 向后不兼容的变更 {#backward-incompatible-change-2}

- 如果存在任何 `ReplicatedMergeTree` 表,从 20.3 及更早版本升级到 22.9 及更新版本时必须通过中间版本进行,否则新版本的服务器将无法启动。[#40641](https://github.com/ClickHouse/ClickHouse/pull/40641) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 移除函数 `accurate_Cast` 和 `accurate_CastOrNull`(它们与 `accurateCast` 和 `accurateCastOrNull` 的区别在于名称中的下划线,且不受 `cast_keep_nullable` 设置值的影响)。这些函数未被文档化、未经测试、未被使用且无实际需要。它们的存在是由于代码泛化所致。[#40682](https://github.com/ClickHouse/ClickHouse/pull/40682) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 添加测试以确保每个新的表函数都会被文档化。参见 [#40649](https://github.com/ClickHouse/ClickHouse/issues/40649)。将表函数 `MeiliSearch` 重命名为 `meilisearch`。[#40709](https://github.com/ClickHouse/ClickHouse/pull/40709) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 添加测试以确保每个新函数都会被文档化。参见 [#40649](https://github.com/ClickHouse/ClickHouse/pull/40649)。函数 `lemmatize`、`synonyms`、`stem` 错误地设置为不区分大小写。现在它们已改为区分大小写。[#40711](https://github.com/ClickHouse/ClickHouse/pull/40711) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 出于安全性和稳定性考虑,catboost 模型不再在 ClickHouse 服务器内进行评估。评估现在在 clickhouse-library-bridge 中完成,这是一个独立的进程,负责加载 catboost 库并通过 HTTP 与服务器进程通信。[#40897](https://github.com/ClickHouse/ClickHouse/pull/40897) ([Robert Schulze](https://github.com/rschu1ze))。
- 使 YAML 配置的解析更加符合常规。[#41044](https://github.com/ClickHouse/ClickHouse/pull/41044) ([Vitaly Baranov](https://github.com/vitlibar))。


#### 新功能 {#new-feature-3}

- 支持 `insert_quorum = 'auto'` 以使用多数节点数。[#39970](https://github.com/ClickHouse/ClickHouse/pull/39970) ([Sachin](https://github.com/SachinSetiya))。
- 为 ClickHouse 服务器添加内置仪表板。这是一个演示项目,展示如何利用 ClickHouse 功能以 1% 的投入实现 90% 的效果。[#40461](https://github.com/ClickHouse/ClickHouse/pull/40461) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 新增设置约束可写性类型 `changeable_in_readonly`。[#40631](https://github.com/ClickHouse/ClickHouse/pull/40631) ([Sergei Trifonov](https://github.com/serxa))。
- 新增对 `INTERSECT DISTINCT` 和 `EXCEPT DISTINCT` 的支持。[#40792](https://github.com/ClickHouse/ClickHouse/pull/40792) ([Duc Canh Le](https://github.com/canhld94))。
- 新增输入/输出格式 `JSONObjectEachRow` - 支持导入 `JSON/JSONCompact/JSONColumnsWithMetadata` 格式。新增设置 `input_format_json_validate_types_from_metadata`,用于控制是否检查元数据中的数据类型与表头中的数据类型是否匹配。- 新增设置 `input_format_json_validate_utf8`,启用后,所有 `JSON` 格式将验证 UTF-8 序列。默认禁用。请注意,此设置不影响输出格式 `JSON/JSONCompact/JSONColumnsWithMetadata`,这些格式始终验证 UTF-8 序列(出于兼容性考虑做出此例外)。- 新增设置 `input_format_json_read_numbers_as_strings`,允许在 String 列中解析数字,该设置默认禁用。- 新增设置 `output_format_json_quote_decimals`,允许在双引号中输出小数,默认禁用。- 允许在数据导入期间解析双引号中的小数。[#40910](https://github.com/ClickHouse/ClickHouse/pull/40910) ([Kruglov Pavel](https://github.com/Avogar))。
- DESCRIBE TABLE 查询支持查询参数。[#40952](https://github.com/ClickHouse/ClickHouse/pull/40952) ([Nikita Taranov](https://github.com/nickitat))。
- 通过将 Parquet Time32/64 转换为 DateTime64 来支持该类型。Parquet time32/64 表示自午夜以来经过的时间,而 DateTime32/64 表示实际的 Unix 时间戳。转换只是从 `0` 进行偏移。[#41333](https://github.com/ClickHouse/ClickHouse/pull/41333) ([Arthur Passos](https://github.com/arthurpassos))。
- 实现 Apache Datasketches 的集合操作。[#39919](https://github.com/ClickHouse/ClickHouse/pull/39919) ([Fangyuan Deng](https://github.com/pzhdfy))。注意:使用 Apache Datasketches 意义不大,其性能不如 ClickHouse,仅在与其他系统集成时才有意义。
- 允许在读取文本格式(`CSV`、`TSV`)时将错误记录到指定文件。[#40516](https://github.com/ClickHouse/ClickHouse/pull/40516) ([zjial](https://github.com/zjial))。

#### 实验性功能 {#experimental-feature-3}

- 新增基于 `Annoy` 的 ANN(近似最近邻)索引。[#40818](https://github.com/ClickHouse/ClickHouse/pull/40818) ([Filatenkov Artur](https://github.com/FArthur-cmd))。[#37215](https://github.com/ClickHouse/ClickHouse/pull/37215) ([VVMak](https://github.com/VVMak))。
- 新增存储引擎 `KeeperMap`,使用 ClickHouse Keeper 或 ZooKeeper 作为键值存储。[#39976](https://github.com/ClickHouse/ClickHouse/pull/39976) ([Antonio Andelic](https://github.com/antonio2368))。此存储引擎用于存储少量元数据。
- 内存数据部分改进:删除已完全处理的 WAL 文件。[#40592](https://github.com/ClickHouse/ClickHouse/pull/40592) ([Azat Khuzhin](https://github.com/azat))。


#### 性能改进 {#performance-improvement-3}

- 实现标记和主键的压缩。关闭 [#34437](https://github.com/ClickHouse/ClickHouse/issues/34437)。[#37693](https://github.com/ClickHouse/ClickHouse/pull/37693) ([zhongyuankai](https://github.com/zhongyuankai))。
- 允许使用线程池提前加载标记。通过设置 `load_marks_asynchronously` 控制(默认值:0)。[#40821](https://github.com/ClickHouse/ClickHouse/pull/40821) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 基于 S3 的虚拟文件系统将使用随机对象名称并拆分为多个路径前缀,以在 AWS 上获得更好的性能。[#40968](https://github.com/ClickHouse/ClickHouse/pull/40968) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 在生成单级聚合结果时考虑 `max_block_size` 值。允许使用更多线程执行后续查询计划步骤。[#39138](https://github.com/ClickHouse/ClickHouse/pull/39138) ([Nikita Taranov](https://github.com/nickitat))。
- 在聚合中使用软件预取来加速哈希表操作。通过设置 `enable_software_prefetch_in_aggregation` 控制,默认启用。[#39304](https://github.com/ClickHouse/ClickHouse/pull/39304) ([Nikita Taranov](https://github.com/nickitat))。
- 在应用 `WHERE` 子句后某些排序键列始终为常量的情况下,更好地支持 `optimize_read_in_order`。例如,类似 `SELECT ... FROM table WHERE a = 'x' ORDER BY a, b` 的查询,其中 `table` 的存储定义为:`MergeTree ORDER BY (a, b)`。[#38715](https://github.com/ClickHouse/ClickHouse/pull/38715) ([Anton Popov](https://github.com/CurtizJ))。
- 在排序之前,对 `full_sorting_join` 的连接流进行相互过滤。[#39418](https://github.com/ClickHouse/ClickHouse/pull/39418) ([Vladimir C](https://github.com/vdimir))。
- 通过跳过空字面量处理来优化 LZ4 解压缩。[#40142](https://github.com/ClickHouse/ClickHouse/pull/40142) ([Nikita Taranov](https://github.com/nickitat))。
- 在可能的情况下使用原生 `copy` 而不是通过 `clickhouse-server` 内存复制来加速备份过程。[#40395](https://github.com/ClickHouse/ClickHouse/pull/40395) ([alesapin](https://github.com/alesapin))。
- 不再为每个 INSERT 块获取存储快照(略微提升性能)。[#40638](https://github.com/ClickHouse/ClickHouse/pull/40638) ([Azat Khuzhin](https://github.com/azat))。
- 为具有多个可空参数的聚合函数实现批处理。[#41058](https://github.com/ClickHouse/ClickHouse/pull/41058) ([Raúl Marín](https://github.com/Algunenano))。
- 加速读取 UniquesHashSet(例如从磁盘读取 `uniqState`)。[#41089](https://github.com/ClickHouse/ClickHouse/pull/41089) ([Raúl Marín](https://github.com/Algunenano))。
- 修复了在具有大量列的表中执行紧凑部分的变更时的高内存使用问题。[#41122](https://github.com/ClickHouse/ClickHouse/pull/41122) ([lthaooo](https://github.com/lthaooo))。
- 在 ARM 上启用 vectorscan 库,这加速了正则表达式求值。[#41033](https://github.com/ClickHouse/ClickHouse/pull/41033) ([Robert Schulze](https://github.com/rschu1ze))。
- 将 vectorscan 升级到 5.4.8,该版本包含许多性能优化以加速正则表达式求值。[#41270](https://github.com/ClickHouse/ClickHouse/pull/41270) ([Robert Schulze](https://github.com/rschu1ze))。
- 修复了在非常高的并发级别下发生的跳过 VFS(如 S3)本地文件系统缓存的错误回退。[#40420](https://github.com/ClickHouse/ClickHouse/pull/40420) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 如果行策略过滤器始终为 false,则立即返回空结果而不读取任何数据。这关闭了 [#24012](https://github.com/ClickHouse/ClickHouse/issues/24012)。[#40740](https://github.com/ClickHouse/ClickHouse/pull/40740) ([Amos Bird](https://github.com/amosbird))。
- Float 数据类型的并行哈希 JOIN 可能不是最优的。对其进行改进。[#41183](https://github.com/ClickHouse/ClickHouse/pull/41183) ([Alexey Milovidov](https://github.com/alexey-milovidov))。





#### 改进 {#improvement-3}

- During startup and ATTACH call, `ReplicatedMergeTree` tables will be readonly until the ZooKeeper connection is made and the setup is finished. [#40148](https://github.com/ClickHouse/ClickHouse/pull/40148) ([Antonio Andelic](https://github.com/antonio2368)).
- Add `enable_extended_results_for_datetime_functions` option to return results of type Date32 for functions toStartOfYear, toStartOfISOYear, toStartOfQuarter, toStartOfMonth, toStartOfWeek, toMonday and toLastDayOfMonth when argument is Date32 or DateTime64, otherwise results of Date type are returned. For compatibility reasons default value is '0'. [#41214](https://github.com/ClickHouse/ClickHouse/pull/41214) ([Roman Vasin](https://github.com/rvasin)).
- For security and stability reasons, CatBoost models are no longer evaluated within the ClickHouse server. Instead, the evaluation is now done in the clickhouse-library-bridge, a separate process that loads the catboost library and communicates with the server process via HTTP. Function `modelEvaluate()` was replaced by `catboostEvaluate()`. [#40897](https://github.com/ClickHouse/ClickHouse/pull/40897) ([Robert Schulze](https://github.com/rschu1ze)). [#39629](https://github.com/ClickHouse/ClickHouse/pull/39629) ([Robert Schulze](https://github.com/rschu1ze)).
- Add more metrics for on-disk temporary data, close [#40206](https://github.com/ClickHouse/ClickHouse/issues/40206). [#40239](https://github.com/ClickHouse/ClickHouse/pull/40239) ([Vladimir C](https://github.com/vdimir)).
- Add config option `warning_supress_regexp`, close [#40330](https://github.com/ClickHouse/ClickHouse/issues/40330). [#40548](https://github.com/ClickHouse/ClickHouse/pull/40548) ([Vladimir C](https://github.com/vdimir)).
- Add setting to disable limit on kafka_num_consumers. Closes [#40331](https://github.com/ClickHouse/ClickHouse/issues/40331). [#40670](https://github.com/ClickHouse/ClickHouse/pull/40670) ([Kruglov Pavel](https://github.com/Avogar)).
- Support `SETTINGS` in `DELETE ...` query. [#41533](https://github.com/ClickHouse/ClickHouse/pull/41533) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Detailed S3 profile events `DiskS3*` per S3 API call split for S3 ObjectStorage. [#41532](https://github.com/ClickHouse/ClickHouse/pull/41532) ([Sergei Trifonov](https://github.com/serxa)).
- Two new metrics in `system.asynchronous_metrics`. `NumberOfDetachedParts` and `NumberOfDetachedByUserParts`. [#40779](https://github.com/ClickHouse/ClickHouse/pull/40779) ([Sema Checherinda](https://github.com/CheSema)).
- Allow CONSTRAINTs for ODBC and JDBC tables. [#34551](https://github.com/ClickHouse/ClickHouse/pull/34551) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Don't print `SETTINGS` more than once during query formatting if it didn't appear multiple times in the original query. [#38900](https://github.com/ClickHouse/ClickHouse/pull/38900) ([Raúl Marín](https://github.com/Algunenano)).
- Improve the tracing (OpenTelemetry) context propagation across threads. [#39010](https://github.com/ClickHouse/ClickHouse/pull/39010) ([Frank Chen](https://github.com/FrankChen021)).
- ClickHouse Keeper: add listeners for `interserver_listen_host` only in Keeper if specified. [#39973](https://github.com/ClickHouse/ClickHouse/pull/39973) ([Antonio Andelic](https://github.com/antonio2368)).
- Improve recovery of Replicated user access storage after errors. [#39977](https://github.com/ClickHouse/ClickHouse/pull/39977) ([Vitaly Baranov](https://github.com/vitlibar)).
- Add support for TTL in `EmbeddedRocksDB`. [#39986](https://github.com/ClickHouse/ClickHouse/pull/39986) ([Lloyd-Pottiger](https://github.com/Lloyd-Pottiger)).
- Add schema inference to `clickhouse-obfuscator`, so the `--structure` argument is no longer required. [#40120](https://github.com/ClickHouse/ClickHouse/pull/40120) ([Nikolay Degterinsky](https://github.com/evillique)).
- Improve and fix dictionaries in `Arrow` format. [#40173](https://github.com/ClickHouse/ClickHouse/pull/40173) ([Kruglov Pavel](https://github.com/Avogar)).
- More natural conversion of `Date32`, `DateTime64`, `Date` to narrower types: upper or lower normal value is considered when out of normal range. [#40217](https://github.com/ClickHouse/ClickHouse/pull/40217) ([Andrey Zvonov](https://github.com/zvonand)).
- Fix the case when `Merge` table over `View` cannot use index. [#40233](https://github.com/ClickHouse/ClickHouse/pull/40233) ([Duc Canh Le](https://github.com/canhld94)).
- Custom key names for JSON server logs. [#40251](https://github.com/ClickHouse/ClickHouse/pull/40251) ([Mallik Hassan](https://github.com/SadiHassan)).
- It is now possible to set a custom error code for the exception thrown by function `throwIf`. [#40319](https://github.com/ClickHouse/ClickHouse/pull/40319) ([Robert Schulze](https://github.com/rschu1ze)).
- Improve schema inference cache, respect format settings that can change the schema. [#40414](https://github.com/ClickHouse/ClickHouse/pull/40414) ([Kruglov Pavel](https://github.com/Avogar)).
- Allow parsing `Date` as `DateTime` and `DateTime64`. This implements the enhancement proposed in [#36949](https://github.com/ClickHouse/ClickHouse/issues/36949). [#40474](https://github.com/ClickHouse/ClickHouse/pull/40474) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Allow conversion from `String` with `DateTime64` like `2022-08-22 01:02:03.456` to `Date` and `Date32`. Allow conversion from String with DateTime like `2022-08-22 01:02:03` to `Date32`. This closes [#39598](https://github.com/ClickHouse/ClickHouse/issues/39598). [#40475](https://github.com/ClickHouse/ClickHouse/pull/40475) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Better support for nested data structures in Parquet format [#40485](https://github.com/ClickHouse/ClickHouse/pull/40485) ([Arthur Passos](https://github.com/arthurpassos)).
- Support reading Array(Record) into flatten nested table in Avro. [#40534](https://github.com/ClickHouse/ClickHouse/pull/40534) ([Kruglov Pavel](https://github.com/Avogar)).
- Add read-only support for `EmbeddedRocksDB`. [#40543](https://github.com/ClickHouse/ClickHouse/pull/40543) ([Lloyd-Pottiger](https://github.com/Lloyd-Pottiger)).
- Validate the compression method parameter of URL table engine. [#40600](https://github.com/ClickHouse/ClickHouse/pull/40600) ([Frank Chen](https://github.com/FrankChen021)).
- Better format detection for url table function/engine in presence of a query string after a file name. Closes [#40315](https://github.com/ClickHouse/ClickHouse/issues/40315). [#40636](https://github.com/ClickHouse/ClickHouse/pull/40636) ([Kruglov Pavel](https://github.com/Avogar)).
- Disable projection when grouping set is used. It generated wrong result. This fixes [#40635](https://github.com/ClickHouse/ClickHouse/issues/40635). [#40726](https://github.com/ClickHouse/ClickHouse/pull/40726) ([Amos Bird](https://github.com/amosbird)).
- Fix incorrect format of `APPLY` column transformer which can break metadata if used in table definition. This fixes [#37590](https://github.com/ClickHouse/ClickHouse/issues/37590). [#40727](https://github.com/ClickHouse/ClickHouse/pull/40727) ([Amos Bird](https://github.com/amosbird)).
- Support the `%z` descriptor for formatting the timezone offset in `formatDateTime`. [#40736](https://github.com/ClickHouse/ClickHouse/pull/40736) ([Cory Levy](https://github.com/LevyCory)).
- The interactive mode in `clickhouse-client` now interprets `.` and `/` as "run the last command". [#40750](https://github.com/ClickHouse/ClickHouse/pull/40750) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix issue with passing MySQL timeouts for MySQL database engine and MySQL table function. Closes [#34168](https://github.com/ClickHouse/ClickHouse/issues/34168). [#40751](https://github.com/ClickHouse/ClickHouse/pull/40751) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Create status file for filesystem cache directory to make sure that cache directories are not shared between different servers or caches. [#40820](https://github.com/ClickHouse/ClickHouse/pull/40820) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Add support for `DELETE` and `UPDATE` for `EmbeddedRocksDB` storage. [#40853](https://github.com/ClickHouse/ClickHouse/pull/40853) ([Antonio Andelic](https://github.com/antonio2368)).
- ClickHouse Keeper: fix shutdown during long commit and increase allowed request size. [#40941](https://github.com/ClickHouse/ClickHouse/pull/40941) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix race in WriteBufferFromS3, add TSA annotations. [#40950](https://github.com/ClickHouse/ClickHouse/pull/40950) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Grouping sets with group_by_use_nulls should only convert key columns to nullable. [#40997](https://github.com/ClickHouse/ClickHouse/pull/40997) ([Duc Canh Le](https://github.com/canhld94)).
- Improve the observability of INSERT on distributed table. [#41034](https://github.com/ClickHouse/ClickHouse/pull/41034) ([Frank Chen](https://github.com/FrankChen021)).
- More low-level metrics for S3 interaction. [#41039](https://github.com/ClickHouse/ClickHouse/pull/41039) ([mateng915](https://github.com/mateng0915)).
- Support relative path in Location header after HTTP redirect. Closes [#40985](https://github.com/ClickHouse/ClickHouse/issues/40985). [#41162](https://github.com/ClickHouse/ClickHouse/pull/41162) ([Kruglov Pavel](https://github.com/Avogar)).
- Apply changes to HTTP handlers on fly without server restart. [#41177](https://github.com/ClickHouse/ClickHouse/pull/41177) ([Azat Khuzhin](https://github.com/azat)).
- ClickHouse Keeper: properly close active sessions during shutdown. [#41215](https://github.com/ClickHouse/ClickHouse/pull/41215) ([Antonio Andelic](https://github.com/antonio2368)). This lowers the period of "table is read-only" errors.
- Add ability to automatically comment SQL queries in clickhouse-client/local (with `Alt-#`, like in readline). [#41224](https://github.com/ClickHouse/ClickHouse/pull/41224) ([Azat Khuzhin](https://github.com/azat)).
- Fix incompatibility of cache after switching setting `do_no_evict_index_and_mark_files` from 1 to 0, 0 to 1. [#41330](https://github.com/ClickHouse/ClickHouse/pull/41330) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Add a setting `allow_suspicious_fixed_string_types` to prevent users from creating columns of type FixedString with size > 256. [#41495](https://github.com/ClickHouse/ClickHouse/pull/41495) ([Duc Canh Le](https://github.com/canhld94)).
- Add `has_lightweight_delete` to system.parts. [#41564](https://github.com/ClickHouse/ClickHouse/pull/41564) ([Kseniia Sumarokova](https://github.com/kssenii)).





#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-3}

- 强制要求为每个设置编写文档。[#40644](https://github.com/ClickHouse/ClickHouse/pull/40644) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 强制要求为每个当前指标编写文档。[#40645](https://github.com/ClickHouse/ClickHouse/pull/40645) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 强制要求为每个性能事件计数器编写文档。在缺失的地方补充文档。[#40646](https://github.com/ClickHouse/ClickHouse/pull/40646) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 通过修正某些依赖项,支持最小化的 `clickhouse-local` 构建。[#40460](https://github.com/ClickHouse/ClickHouse/pull/40460) ([Alexey Milovidov](https://github.com/alexey-milovidov))。大小小于 50 MiB。
- 计算并报告测试中的 SQL 函数覆盖率。[#40593](https://github.com/ClickHouse/ClickHouse/issues/40593)。[#40647](https://github.com/ClickHouse/ClickHouse/pull/40647) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 强制要求为每个 MergeTree 设置编写文档。[#40648](https://github.com/ClickHouse/ClickHouse/pull/40648) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 为高级统一服务器组件提供嵌入式参考文档的原型。[#40649](https://github.com/ClickHouse/ClickHouse/pull/40649) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 我们将检查已更改性能测试中的所有查询,以确保所有已更改的查询都经过了测试。[#40322](https://github.com/ClickHouse/ClickHouse/pull/40322) ([Nikita Taranov](https://github.com/nickitat))。
- 修复 TGZ 软件包。[#40681](https://github.com/ClickHouse/ClickHouse/pull/40681) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- 修复调试符号。[#40873](https://github.com/ClickHouse/ClickHouse/pull/40873) ([Azat Khuzhin](https://github.com/azat))。
- 扩展 CI 配置以创建仅支持 x86 SSE2 的构建。适用于旧硬件或嵌入式硬件。[#40999](https://github.com/ClickHouse/ClickHouse/pull/40999) ([Robert Schulze](https://github.com/rschu1ze))。
- 切换到 llvm/clang 15。[#41046](https://github.com/ClickHouse/ClickHouse/pull/41046) ([Azat Khuzhin](https://github.com/azat))。
- 延续 [#40938](https://github.com/ClickHouse/ClickHouse/issues/40938)。修复 `Loggers` 类的 ODR 违规。修复 [#40398](https://github.com/ClickHouse/ClickHouse/issues/40398)、[#40937](https://github.com/ClickHouse/ClickHouse/issues/40937)。[#41060](https://github.com/ClickHouse/ClickHouse/pull/41060) ([Dmitry Novik](https://github.com/novikd))。
- 将 macOS 二进制文件添加到 GitHub 发布资产,修复 [#37718](https://github.com/ClickHouse/ClickHouse/issues/37718)。[#41088](https://github.com/ClickHouse/ClickHouse/pull/41088) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- c-ares 库现已与 ClickHouse 的构建系统捆绑在一起。[#41239](https://github.com/ClickHouse/ClickHouse/pull/41239) ([Robert Schulze](https://github.com/rschu1ze))。
- 从主 ClickHouse 代码中移除 `dlopen`。它仍保留在 library-bridge 和 odbc-bridge 中。[#41428](https://github.com/ClickHouse/ClickHouse/pull/41428) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 不允许在主 ClickHouse 二进制文件中使用 `dlopen`,因为它有害且不安全。我们不使用它。但某些库可能会使用它来实现"插件"。我们强烈反对将第三方不受控制的危险库加载到进程地址空间这种过时的技术,因为这是极不合理的。[#41429](https://github.com/ClickHouse/ClickHouse/pull/41429) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 向 deb 软件包添加 `source` 字段,更新 `nfpm`。[#41531](https://github.com/ClickHouse/ClickHouse/pull/41531) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- 在内部 DWARF 解析器中支持 DWARF-5。[#40710](https://github.com/ClickHouse/ClickHouse/pull/40710) ([Azat Khuzhin](https://github.com/azat))。
- 在 ZooKeeper 客户端中添加故障注入以进行测试 [#30498](https://github.com/ClickHouse/ClickHouse/pull/30498) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 添加使用 s3 存储的无状态测试,包含 debug 和 tsan [#35262](https://github.com/ClickHouse/ClickHouse/pull/35262) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 在 S3 之上尝试压力测试 [#36837](https://github.com/ClickHouse/ClickHouse/pull/36837) ([alesapin](https://github.com/alesapin))。
- 在 `clang-tidy` 中启用 `concurrency-mt-unsafe` [#40224](https://github.com/ClickHouse/ClickHouse/pull/40224) ([Alexey Milovidov](https://github.com/alexey-milovidov))。

#### 错误修复 {#bug-fix}


* 修复了由于 [AWS SDK 中的一个 bug](https://github.com/aws/aws-sdk-cpp/issues/658) 可能导致的数据丢失问题。该 bug 只有在通过 S3 使用 ClickHouse 时才会被触发。[#40506](https://github.com/ClickHouse/ClickHouse/pull/40506)（[alesapin](https://github.com/alesapin)）。这个 bug 在 AWS SDK 中存在了 5 年之久，并且是在我们报告之后才被关闭。
* Native 格式中的恶意数据可能会导致崩溃。 [#41441](https://github.com/ClickHouse/ClickHouse/pull/41441) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* 聚合函数 `categorialInformationValue` 的属性定义不正确，这可能在运行时导致空指针解引用。此更改修复了 [#41443](https://github.com/ClickHouse/ClickHouse/issues/41443)。[#41449](https://github.com/ClickHouse/ClickHouse/pull/41449)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 以 Apache `ORC` 格式写入数据可能会导致缓冲区越界。[#41458](https://github.com/ClickHouse/ClickHouse/pull/41458)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 修复在将 `Array of Nullable` 用作参数时，函数 `encrypt` 和 `contingency` 存在的内存安全问题。此修复解决了 [#41004](https://github.com/ClickHouse/ClickHouse/issues/41004)。[#40195](https://github.com/ClickHouse/ClickHouse/pull/40195)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 修复当 &#39;not&#95;processed&#39; 非空时 MergeJoin 中的 bug。[#40335](https://github.com/ClickHouse/ClickHouse/pull/40335) ([liql2007](https://github.com/liql2007)).
* 修复在使用 `IN` 运算符时，由于 decimal 精度丢失而导致结果不正确的问题，参见 [#41125](https://github.com/ClickHouse/ClickHouse/issues/41125)。[#41130](https://github.com/ClickHouse/ClickHouse/pull/41130)（[Vladimir C](https://github.com/vdimir)）。
* 修复多级 `Nested` 列在填充缺失值时的问题。[#37152](https://github.com/ClickHouse/ClickHouse/pull/37152) ([Anton Popov](https://github.com/CurtizJ))。
* 修复 Ordinary（已弃用）数据库的 `SYSTEM UNFREEZE` 查询。针对 [https://github.com/ClickHouse/ClickHouse/pull/36424](https://github.com/ClickHouse/ClickHouse/pull/36424) 的修复。[#38262](https://github.com/ClickHouse/ClickHouse/pull/38262)（[Vadim Volodin](https://github.com/PolyProgrammist)）。
* 修复由 `WITH` 语句引入的未使用的未知列。这修复了 [#37812](https://github.com/ClickHouse/ClickHouse/issues/37812)。[#39131](https://github.com/ClickHouse/ClickHouse/pull/39131) ([Amos Bird](https://github.com/amosbird))。
* 修复在存在窗口函数时对 `ORDER BY` 的查询分析。修复了 [#38741](https://github.com/ClickHouse/ClickHouse/issues/38741) 和 [#24892](https://github.com/ClickHouse/ClickHouse/issues/24892)。[#39354](https://github.com/ClickHouse/ClickHouse/pull/39354)（[Dmitry Novik](https://github.com/novikd)）。
* 修复了当用户尝试对聚合函数计算 WINDOW ORDER BY/PARTITION BY 表达式时出现的 `Unknown identifier (aggregate-function)` 异常。[#39762](https://github.com/ClickHouse/ClickHouse/pull/39762)（[Vladimir Chebotaryov](https://github.com/quickhouse)）。
* 通过设置 `max_analyze_depth` 限制单个查询的分析深度。这样可以防止在包含异常大量子查询的查询中分析时间呈指数级增长。[#40334](https://github.com/ClickHouse/ClickHouse/pull/40334) ([Vladimir C](https://github.com/vdimir)).
* 修复 MergeTree 引擎族中与列 TTL 相关的罕见错误：在重复执行垂直合并的情况下，可能会出现错误 `Cannot unlink file ColumnName.bin ... No such file or directory.`。 [#40346](https://github.com/ClickHouse/ClickHouse/pull/40346) ([alesapin](https://github.com/alesapin)).
* 如果同时存在 IPv4 和 IPv6，请为二者都使用 DNS 记录。 [#40353](https://github.com/ClickHouse/ClickHouse/pull/40353) ([Maksim Kita](https://github.com/kitaisreal)).
* 允许读取来自 Hadoop 的 Snappy 压缩文件。[#40482](https://github.com/ClickHouse/ClickHouse/pull/40482) ([Kruglov Pavel](https://github.com/Avogar))。
* 修复在解析包含可变维度数组的 `Object` 类型值（实验性功能）时发生的崩溃。[#40483](https://github.com/ClickHouse/ClickHouse/pull/40483) ([Duc Canh Le](https://github.com/canhld94))。
* 修复设置 `input_format_tsv_skip_first_lines`。[#40491](https://github.com/ClickHouse/ClickHouse/pull/40491) ([mini4](https://github.com/mini4))。
* 修复在启动 `MaterializedPostgreSQL` 数据库/表引擎时出现的错误（竞态条件）。[#40262](https://github.com/ClickHouse/ClickHouse/issues/40262)。修复在达到 `relcache_callback_list` 槽位上限时出现的错误。[#40511](https://github.com/ClickHouse/ClickHouse/pull/40511) ([Maksim Buren](https://github.com/maks-buren630501))。
* 修复在解析 DateTime64 时可能出现的 “Decimal math overflow” 错误。[#40546](https://github.com/ClickHouse/ClickHouse/pull/40546) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复包含轻量级已删除行的数据分片的纵向合并。[#40559](https://github.com/ClickHouse/ClickHouse/pull/40559) ([Alexander Gololobov](https://github.com/davenger)).
* 修复在 `URL` 表引擎启用压缩时写入数据会发生段错误的问题。 [#40565](https://github.com/ClickHouse/ClickHouse/pull/40565) ([Frank Chen](https://github.com/FrankChen021)).
* 修复在 `arrayElement` 函数与 `Map` 类型一起使用时可能出现的逻辑错误 `'Invalid Field get from type UInt64 to type String'`。 [#40572](https://github.com/ClickHouse/ClickHouse/pull/40572) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复文件系统缓存中的潜在竞态问题。[#40586](https://github.com/ClickHouse/ClickHouse/pull/40586) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 移除了在 `MergeTree` 表中对未受影响分区跳过执行变更的机制，因为该特性从未正确工作，并且可能导致已完成的变更被“复活”。[#40589](https://github.com/ClickHouse/ClickHouse/pull/40589) ([Alexander Tokmakov](https://github.com/tavplubix)).
* 如果在运行时将已被占用的 gRPC 端口添加到配置中，ClickHouse 服务器将会崩溃。 [#40597](https://github.com/ClickHouse/ClickHouse/pull/40597) ([何李夫](https://github.com/helifu))。
* 修复 `base58Encode / base58Decode` 对前导 0 / &#39;1&#39; 的处理。[#40620](https://github.com/ClickHouse/ClickHouse/pull/40620) ([Andrey Zvonov](https://github.com/zvonand))。
* keeper-fix：修复在安装快照时访问日志时出现的竞争条件。 [#40627](https://github.com/ClickHouse/ClickHouse/pull/40627) ([Antonio Andelic](https://github.com/antonio2368))。
* 修复 `toFixedString` 函数的短路求值行为。部分解决 [#40622](https://github.com/ClickHouse/ClickHouse/issues/40622)。[#40628](https://github.com/ClickHouse/ClickHouse/pull/40628)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复了在 ClickHouse 中将 SQLite 的 `int8` 列转换为 `int64` 列的行为。修复了 [#40639](https://github.com/ClickHouse/ClickHouse/issues/40639)。[#40642](https://github.com/ClickHouse/ClickHouse/pull/40642)（[Barum Rho](https://github.com/barumrho)）。
* 修复递归 `Buffer` 表中的栈溢出问题。已关闭 [#40637](https://github.com/ClickHouse/ClickHouse/issues/40637)。[#40643](https://github.com/ClickHouse/ClickHouse/pull/40643)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 在向 `ProcessList` 插入新查询时会进行内存分配。如果在这些分配过程中达到内存限制，我们无法使用 `OvercommitTracker`，因为此时已经持有 `ProcessList::mutex`。修复了 [#40611](https://github.com/ClickHouse/ClickHouse/issues/40611)。[#40677](https://github.com/ClickHouse/ClickHouse/pull/40677)（[Dmitry Novik](https://github.com/novikd)）。
* 修复在读取 marks 时将 `max_read_buffer_size` 设为 `0` 所导致的 `LOGICAL_ERROR`。 [#40705](https://github.com/ClickHouse/ClickHouse/pull/40705) ([Azat Khuzhin](https://github.com/azat)).
* 修复在没有查询上下文的情况下向物化视图推送数据（来自 Kafka 等）时的内存泄漏。 [#40732](https://github.com/ClickHouse/ClickHouse/pull/40732) ([Azat Khuzhin](https://github.com/azat)).
* 修复在 CSV 架构推断中可能出现的错误 “Attempt to read after eof”。[#40746](https://github.com/ClickHouse/ClickHouse/pull/40746)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复写通缓存中的逻辑错误“文件段只能由下载器完成”。关闭 [#40748](https://github.com/ClickHouse/ClickHouse/issues/40748)。[#40759](https://github.com/ClickHouse/ClickHouse/pull/40759)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 使 `GROUPING` 函数的结果与 SQL 和其他 DBMS 中的结果保持一致。 [#40762](https://github.com/ClickHouse/ClickHouse/pull/40762) ([Dmitry Novik](https://github.com/novikd)).
* 在 [#40595](https://github.com/ClickHouse/ClickHouse/issues/40595) 中，有报告称 `host_regexp` 功能在配合 `/etc/hosts` 中的名称到地址解析使用时工作不正常。该问题已修复。[#40769](https://github.com/ClickHouse/ClickHouse/pull/40769)（[Arthur Passos](https://github.com/arthurpassos)）。
* 修复 Log 系列表的增量备份功能。[#40827](https://github.com/ClickHouse/ClickHouse/pull/40827) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复零拷贝复制中一个极其罕见但可能导致数据丢失的错误。 [#40844](https://github.com/ClickHouse/ClickHouse/pull/40844) ([alesapin](https://github.com/alesapin)).
* 修复在从不同列构建相同集合表达式时导致键条件分析崩溃的问题。[#40850](https://github.com/ClickHouse/ClickHouse/pull/40850) ([Duc Canh Le](https://github.com/canhld94)).
* 修复嵌套 JSON 对象的架构推断。[#40851](https://github.com/ClickHouse/ClickHouse/pull/40851) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复了在文件系统缓存文件为空时，未删除其对应的 3 位前缀目录的问题。关闭 [#40797](https://github.com/ClickHouse/ClickHouse/issues/40797)。[#40867](https://github.com/ClickHouse/ClickHouse/pull/40867)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在连接副本失败时未捕获的 DNS&#95;ERROR。 [#40881](https://github.com/ClickHouse/ClickHouse/pull/40881) ([Robert Coelho](https://github.com/coelho)).
* 修复在子查询中移除不必要列时的错误。[#40884](https://github.com/ClickHouse/ClickHouse/pull/40884) ([luocongkai](https://github.com/TKaxe))。
* 修复远程读取缓冲区中额外的内存分配。[#40896](https://github.com/ClickHouse/ClickHouse/pull/40896) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 修复了这样一种情况：即使已显式撤销删除数据库权限，用户仍然可以删除数据库。 [#40906](https://github.com/ClickHouse/ClickHouse/pull/40906) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 针对 ClickHouse Keeper 的修复：在写入请求中正确将路径与 Keeper 内部系统节点路径进行比较。[#40918](https://github.com/ClickHouse/ClickHouse/pull/40918) ([Antonio Andelic](https://github.com/antonio2368)).
* 修复 `WriteBufferFromS3` 中的死锁问题。[#40943](https://github.com/ClickHouse/ClickHouse/pull/40943) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 修复 `DESCRIBE TABLE url()` 以及其他一些 `DESCRIBE TABLE <table_function>()` 的访问权限问题。[#40975](https://github.com/ClickHouse/ClickHouse/pull/40975) ([Vitaly Baranov](https://github.com/vitlibar))。
* 移除 `WITH GROUPING SETS` 的错误解析逻辑，该逻辑可能导致空指针解引用。[#41049](https://github.com/ClickHouse/ClickHouse/pull/41049) ([Duc Canh Le](https://github.com/canhld94)).
* 修复 ClickHouse Keeper：修复 Keeper 关闭期间可能发生的段错误。 [#41075](https://github.com/ClickHouse/ClickHouse/pull/41075) ([Antonio Andelic](https://github.com/antonio2368)).
* 修复聚合函数组合器中可能出现的段错误、use-heap-after-free 和内存泄漏问题。修复 [#40848](https://github.com/ClickHouse/ClickHouse/issues/40848)。[#41083](https://github.com/ClickHouse/ClickHouse/pull/41083)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复 `query_views_log` 与 Window 视图的配合使用。 [#41132](https://github.com/ClickHouse/ClickHouse/pull/41132) ([Raúl Marín](https://github.com/Algunenano)).
* 默认禁用 optimize&#95;monotonous&#95;functions&#95;in&#95;order&#95;by，以规避问题：[#40094](https://github.com/ClickHouse/ClickHouse/issues/40094)。[#41136](https://github.com/ClickHouse/ClickHouse/pull/41136)（[Denny Crane](https://github.com/den-crane)）。
* 修复了在将数据库引擎从 Ordinary 自动转换为 Atomic 时出现的“possible deadlock avoided”（已避免潜在死锁）错误。[#41146](https://github.com/ClickHouse/ClickHouse/pull/41146) ([Alexander Tokmakov](https://github.com/tavplubix))。
* 修复在 `SortedBlocksWriter` 中因空 block 导致的 SIGSEGV（在 `optimize_aggregation_in_order` 与 `join_algorithm=auto` 组合下可能出现）。[#41154](https://github.com/ClickHouse/ClickHouse/pull/41154) ([Azat Khuzhin](https://github.com/azat)).
* 修复在启用 trivial count 优化并使用 array join 时导致查询结果不正确的问题。修复了 [#39431](https://github.com/ClickHouse/ClickHouse/issues/39431)。[#41158](https://github.com/ClickHouse/ClickHouse/pull/41158)（[Denny Crane](https://github.com/den-crane)）。
* 修复 `GetPriorityForLoadBalancing::getPriorityFunc()` 中的 stack-use-after-return 错误。 [#41159](https://github.com/ClickHouse/ClickHouse/pull/41159) ([Azat Khuzhin](https://github.com/azat)).
* 修复位置参数异常 `Positional argument out of bounds`。修复了 [#40634](https://github.com/ClickHouse/ClickHouse/issues/40634)。[#41189](https://github.com/ClickHouse/ClickHouse/pull/41189)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复对损坏的已分离部分的后台清理。 [#41190](https://github.com/ClickHouse/ClickHouse/pull/41190) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 修复在存在大量带 `WHERE` 的交叉连接时的指数级查询重写问题，关闭 [#21557](https://github.com/ClickHouse/ClickHouse/issues/21557)。[#41223](https://github.com/ClickHouse/ClickHouse/pull/41223)（[Vladimir C](https://github.com/vdimir)）。
* 修复了写通缓存中可能出现的逻辑错误，该错误是由于未按要求处理所有类型的异常所导致。修复了 [#41208](https://github.com/ClickHouse/ClickHouse/issues/41208)。[#41232](https://github.com/ClickHouse/ClickHouse/pull/41232)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复 `system.filesystem_cache_log` 中的字符串类型日志记录。 [#41233](https://github.com/ClickHouse/ClickHouse/pull/41233) ([jmimbrero](https://github.com/josemimbrero-tinybird)).
* 在子查询中包含 `OFFSET` 子句且在外层查询中包含 `WHERE` 子句的查询可能返回不正确的结果，该问题已修复。修复了 [#40416](https://github.com/ClickHouse/ClickHouse/issues/40416)。[#41280](https://github.com/ClickHouse/ClickHouse/pull/41280)（[Alexander Tokmakov](https://github.com/tavplubix)）。
* 修复在启用 `query_plan_optimize_primary_key` 时可能出现的错误查询结果。修复 [#40599](https://github.com/ClickHouse/ClickHouse/issues/40599)。[#41281](https://github.com/ClickHouse/ClickHouse/pull/41281)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 不要让无效序列在 lowerUTF8/upperUTF8 中影响其他行。 [#41286](https://github.com/ClickHouse/ClickHouse/pull/41286) ([Azat Khuzhin](https://github.com/azat)).
* 修复包含 `Object` 类型列的 `ALTER &lt;table&gt; ADD COLUMN` 查询。[#41290](https://github.com/ClickHouse/ClickHouse/pull/41290)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复了在配置中没有 `distributed_ddl.path` 时，从 `system.distributed_ddl_queue` 查询会出现 “No node” 错误的问题。修复了 [#41096](https://github.com/ClickHouse/ClickHouse/issues/41096)。[#41296](https://github.com/ClickHouse/ClickHouse/pull/41296)（[young scott](https://github.com/young-scott)）。
* 修复磁盘对象存储中不正确的逻辑错误 `Expected relative path`。相关 issue：[#41246](https://github.com/ClickHouse/ClickHouse/issues/41246)。[#41297](https://github.com/ClickHouse/ClickHouse/pull/41297)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在以 MsgPack 格式插入 UUID 之前增加列类型检查。 [#41309](https://github.com/ClickHouse/ClickHouse/pull/41309) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复在异步插入（启用 `async_insert` 设置）格式错误的数据到 `Object` 类型列时可能发生的崩溃问题。如果异步插入的所有批次中的 JSON 都无效且无法解析，就可能触发该问题。[#41336](https://github.com/ClickHouse/ClickHouse/pull/41336) ([Anton Popov](https://github.com/CurtizJ))。
* 修复在使用 async&#95;socket&#95;for&#95;remote/use&#95;hedged&#95;requests 并行执行 KILL 时可能出现的死锁。[#41343](https://github.com/ClickHouse/ClickHouse/pull/41343) ([Azat Khuzhin](https://github.com/azat)).
* 默认关闭 optimize&#95;rewrite&#95;sum&#95;if&#95;to&#95;count&#95;if，以缓解：[#38605](https://github.com/ClickHouse/ClickHouse/issues/38605) [#38683](https://github.com/ClickHouse/ClickHouse/issues/38683)。[#41388](https://github.com/ClickHouse/ClickHouse/pull/41388) ([Denny Crane](https://github.com/den-crane))。
* 自 22.8 起，如果数据库为 `Replicated` 且集群名称与数据库名称相同，则会忽略 `ON CLUSTER` 子句。由于这一行为，`DROP PARTITION ON CLUSTER` 在 `Replicated` 上的表现与预期不符。此问题已修复，现在仅对在数据库级别进行复制的查询才会忽略 `ON CLUSTER` 子句。修复了 [#41299](https://github.com/ClickHouse/ClickHouse/issues/41299)。[#41390](https://github.com/ClickHouse/ClickHouse/pull/41390)（[Alexander Tokmakov](https://github.com/tavplubix)）。
* 修复在取消查询（`KILL QUERY` 或服务器关闭）时可能出现的挂起/死锁问题。[#41467](https://github.com/ClickHouse/ClickHouse/pull/41467) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在使用 JBOD 功能时可能导致服务器崩溃的问题。修复了 [#41365](https://github.com/ClickHouse/ClickHouse/issues/41365)。[#41483](https://github.com/ClickHouse/ClickHouse/pull/41483)（[Amos Bird](https://github.com/amosbird)）。
* 修复从可为 `NULL` 的定长字符串到字符串的转换。[#41541](https://github.com/ClickHouse/ClickHouse/pull/41541)（[Duc Canh Le](https://github.com/canhld94)）。
* 在向 groupBitmap* 传递错误的聚合状态时防止崩溃。 [#41563](https://github.com/ClickHouse/ClickHouse/pull/41563) ([Raúl Marín](https://github.com/Algunenano)).
* 带有 `ORDER BY` 且满足 `1500 <= LIMIT <= max_block_size` 的查询，可能因为结果开头缺失部分行而返回不正确的结果。修复了 [#41182](https://github.com/ClickHouse/ClickHouse/issues/41182)。[#41576](https://github.com/ClickHouse/ClickHouse/pull/41576)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在使用物化视图时 `X-ClickHouse-Summary` 中读取字节数/行数的统计。 [#41586](https://github.com/ClickHouse/ClickHouse/pull/41586) ([Raúl Marín](https://github.com/Algunenano)).
* 修复在带有 `OFFSET` 的查询中可能出现的 `pipeline stuck` 异常。该错误是在 `enable_optimize_predicate_expression = 0` 且 `WHERE` 中条件恒为假时发现的。修复了 [#41383](https://github.com/ClickHouse/ClickHouse/issues/41383)。[#41588](https://github.com/ClickHouse/ClickHouse/pull/41588)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。

### <a id="228"></a> ClickHouse 版本 22.8, 2022-08-18 {#a-id228a-clickhouse-release-228-2022-08-18}

#### 向后不兼容的变更 {#backward-incompatible-change-3}

- 扩展了 `Date32` 和 `DateTime64` 的范围,支持从 1900 年到 2299 年的日期。在之前的版本中,支持的区间仅为 1925 年到 2283 年。该实现使用前推格里高利历(符合 [ISO 8601](https://en.wikipedia.org/wiki/ISO_8601):2004 (第 3.2.1 条 格里高利历)),而不是考虑从儒略历到格里高利历的历史转换。此变更影响超出范围参数的实现特定行为。例如,在之前的版本中 `1899-01-01` 的值被限制为 `1925-01-01`,在新版本中它将被限制为 `1900-01-01`。如果您传递 `INTERVAL 3 QUARTER`,它会改变 `toStartOfInterval` 的舍入行为,最多相差一个季度,因为间隔是从实现特定的时间点开始计算的。关闭 [#28216](https://github.com/ClickHouse/ClickHouse/issues/28216),改进 [#38393](https://github.com/ClickHouse/ClickHouse/issues/38393)。[#39425](https://github.com/ClickHouse/ClickHouse/pull/39425) ([Roman Vasin](https://github.com/rvasin))。
- 现在,所有相关的字典源都遵守 `remote_url_allow_hosts` 设置。HTTP、Cassandra、Redis 已经完成。新增了 ClickHouse、MongoDB、MySQL、PostgreSQL。仅对从 DDL 创建的字典检查主机。[#39184](https://github.com/ClickHouse/ClickHouse/pull/39184) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 预构建的 ClickHouse x86 二进制文件现在需要支持 AVX 指令,即不早于 Intel Sandy Bridge / AMD Bulldozer 的 CPU,两者均于 2011 年发布。[#39000](https://github.com/ClickHouse/ClickHouse/pull/39000) ([Robert Schulze](https://github.com/rschu1ze))。
- 使远程文件系统缓存可组合,允许不驱逐某些文件(如 idx、mrk 等),删除旧的缓存版本。现在可以在 Azure Blob 存储磁盘、本地磁盘、StaticWeb 磁盘等上配置缓存。此 PR 被标记为向后不兼容,因为缓存配置发生了变化,为了使缓存正常工作需要更新配置文件。旧缓存仍将与新配置一起使用。服务器将使用旧缓存配置正常启动。关闭 https://github.com/ClickHouse/ClickHouse/issues/36140。关闭 https://github.com/ClickHouse/ClickHouse/issues/37889。([Kseniia Sumarokova](https://github.com/kssenii))。[#36171](https://github.com/ClickHouse/ClickHouse/pull/36171))


#### 新功能 {#new-feature-4}

- 支持在 MergeTree 表上使用 SQL 标准 DELETE FROM 语法,并为 MergeTree 系列实现轻量级删除。[#37893](https://github.com/ClickHouse/ClickHouse/pull/37893) ([Jianmei Zhang](https://github.com/zhangjmruc)) ([Alexander Gololobov](https://github.com/davenger))。注意:此新功能不会使 ClickHouse 成为 HTAP 数据库管理系统。
- 查询参数可以在交互模式下通过 `SET param_abc = 'def'` 设置,并通过原生协议作为设置传输。[#39906](https://github.com/ClickHouse/ClickHouse/pull/39906) ([Nikita Taranov](https://github.com/nickitat))。
- 配额键可以在原生协议中设置 ([Yakov Olkhovsky](https://github.com/ClickHouse/ClickHouse/pull/39874))。
- 添加了设置 `exact_rows_before_limit` (0/1)。启用后,ClickHouse 将为 `rows_before_limit_at_least` 统计信息提供精确值,但代价是必须完整读取 limit 之前的数据。此功能解决了 [#6613](https://github.com/ClickHouse/ClickHouse/issues/6613)。[#25333](https://github.com/ClickHouse/ClickHouse/pull/25333) ([kevin wan](https://github.com/MaxWk))。
- 添加了对使用 `s3Cluster` 表函数向 `Distributed` 和 `Replicated` 引擎表进行并行分布式插入查询的支持 [#34670](https://github.com/ClickHouse/ClickHouse/issues/34670)。[#39107](https://github.com/ClickHouse/ClickHouse/pull/39107) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 添加了新的设置以控制从文本格式推断模式:- `input_format_try_infer_dates` - 尝试从字符串推断日期。- `input_format_try_infer_datetimes` - 尝试从字符串推断日期时间。- `input_format_try_infer_integers` - 尝试推断 `Int64` 而不是 `Float64`。- `input_format_json_try_infer_numbers_from_strings` - 尝试从 JSON 格式中的 JSON 字符串推断数字。[#39186](https://github.com/ClickHouse/ClickHouse/pull/39186) ([Kruglov Pavel](https://github.com/Avogar))。
- 提供 JSON 格式日志输出的选项。目的是便于日志分析工具进行采集和查询。[#39277](https://github.com/ClickHouse/ClickHouse/pull/39277) ([Mallik Hassan](https://github.com/SadiHassan))。
- 添加函数 `nowInBlock`,允许在长时间运行和连续查询期间获取当前时间。解决了 [#39522](https://github.com/ClickHouse/ClickHouse/issues/39522)。注意:不存在 `now64InBlock` 和 `todayInBlock` 函数。[#39533](https://github.com/ClickHouse/ClickHouse/pull/39533) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 添加了为 `executable()` 表函数指定设置的功能。[#39681](https://github.com/ClickHouse/ClickHouse/pull/39681) ([Constantine Peresypkin](https://github.com/pkit))。
- 实现了数据库引擎从 `Ordinary` 到 `Atomic` 的自动转换。在 `flags` 目录中创建空的 `convert_ordinary_to_atomic` 文件,所有 `Ordinary` 数据库将在下次服务器启动时自动转换。解决了 [#39546](https://github.com/ClickHouse/ClickHouse/issues/39546)。[#39933](https://github.com/ClickHouse/ClickHouse/pull/39933) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 支持 `SELECT ... INTO OUTFILE '...' AND STDOUT`。[#37490](https://github.com/ClickHouse/ClickHouse/issues/37490)。[#39054](https://github.com/ClickHouse/ClickHouse/pull/39054) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
- 添加了格式 `PrettyMonoBlock`、`PrettyNoEscapesMonoBlock`、`PrettyCompactNoEscapes`、`PrettyCompactNoEscapesMonoBlock`、`PrettySpaceNoEscapes`、`PrettySpaceMonoBlock`、`PrettySpaceNoEscapesMonoBlock`。[#39646](https://github.com/ClickHouse/ClickHouse/pull/39646) ([Kruglov Pavel](https://github.com/Avogar))。


#### 性能改进 {#performance-improvement-4}

- 改进了聚合结果内存高效合并过程中的内存使用。[#39429](https://github.com/ClickHouse/ClickHouse/pull/39429) ([Nikita Taranov](https://github.com/nickitat))。
- 添加了并发控制逻辑,用于限制查询创建的并发线程总数。[#37558](https://github.com/ClickHouse/ClickHouse/pull/37558) ([Sergei Trifonov](https://github.com/serxa))。添加 `concurrent_threads_soft_limit` 参数,通过限制所有查询的线程总数来提高高 QPS 场景下的性能。[#37285](https://github.com/ClickHouse/ClickHouse/pull/37285) ([Roman Vasin](https://github.com/rvasin))。
- 为未压缩缓存和标记缓存添加 `SLRU` 缓存策略。([Kseniia Sumarokova](https://github.com/kssenii))。[#34651](https://github.com/ClickHouse/ClickHouse/pull/34651) ([alexX512](https://github.com/alexX512))。解耦本地缓存功能和缓存算法 [#38048](https://github.com/ClickHouse/ClickHouse/pull/38048) ([Han Shukai](https://github.com/KinderRiven))。
- Intel® In-Memory Analytics Accelerator (Intel® IAA) 是即将推出的新一代 Intel® Xeon® Scalable 处理器("Sapphire Rapids")中提供的硬件加速器。其目标是加速分析中的常见操作,如数据压缩/解压缩和过滤。ClickHouse 新增了 "DeflateQpl" 压缩编解码器,该编解码器利用 Intel® IAA 卸载技术提供高性能的 DEFLATE 实现。该编解码器使用 [Intel® Query Processing Library (QPL)](https://github.com/intel/qpl),它抽象了对硬件加速器的访问,并在硬件加速器不可用时提供软件回退方案。DEFLATE 通常比 ClickHouse 的 LZ4 默认编解码器提供更高的压缩率,因此可以减少磁盘 I/O 并降低主内存消耗。[#36654](https://github.com/ClickHouse/ClickHouse/pull/36654) ([jasperzhu](https://github.com/jinjunzh))。[#39494](https://github.com/ClickHouse/ClickHouse/pull/39494) ([Robert Schulze](https://github.com/rschu1ze))。
- 带 `ORDER BY` 的有序 `DISTINCT`:根据输入流排序描述推断排序方式。如果输入流已排序则跳过排序。[#38719](https://github.com/ClickHouse/ClickHouse/pull/38719) ([Igor Nikonov](https://github.com/devcrafter))。显著改进内存使用和查询执行时间 + 当 `DISTINCT` 列与 `ORDER BY` 列匹配时,对最终去重使用 `DistinctSortedChunkTransform`,但在 `EXPLAIN PIPELINE` 中重命名为 `DistinctSortedStreamTransform` → 这显著改进了内存使用 + 移除 `DistinctSortedChunkTransform` 热循环中的不必要内存分配。[#39432](https://github.com/ClickHouse/ClickHouse/pull/39432) ([Igor Nikonov](https://github.com/devcrafter))。仅当排序描述适用于 DISTINCT 列时使用 `DistinctSortedTransform`,否则回退到普通 DISTINCT 实现 + 这允许在 `DistinctSortedTransform` 执行期间进行更少的检查。[#39528](https://github.com/ClickHouse/ClickHouse/pull/39528) ([Igor Nikonov](https://github.com/devcrafter))。修复:`DistinctSortedTransform` 未能利用排序优势。由于 clearing_columns 检测不正确(始终为空),它从未清除 HashSet。因此,它基本上像普通 `DISTINCT`(`DistinctTransform`)一样工作。此修复显著减少了内存使用。[#39538](https://github.com/ClickHouse/ClickHouse/pull/39538) ([Igor Nikonov](https://github.com/devcrafter))。
- 执行 `cluster` 和类似表函数时,优先使用本地节点获取远程表结构。[#39440](https://github.com/ClickHouse/ClickHouse/pull/39440) ([Mingliang Pan](https://github.com/liangliangpan))。
- 使用 AVX512VBMI2 压缩存储优化数值列过滤。[#39633](https://github.com/ClickHouse/ClickHouse/pull/39633) ([Guo Wangyang](https://github.com/guowangy))。对于具有 AVX512 VBMI2 的系统,此 PR 将 SSB 基准测试查询 3.1、3.2 和 3.3(SF=100)的性能提高约 6%。在 Intel Icelake Xeon 8380 \* 2 插槽上测试。[#40033](https://github.com/ClickHouse/ClickHouse/pull/40033) ([Robert Schulze](https://github.com/rschu1ze))。
- 在多线程场景中优化带函数表达式的索引分析。[#39812](https://github.com/ClickHouse/ClickHouse/pull/39812) ([Guo Wangyang](https://github.com/guowangy))。
- 复杂查询优化:如果未注册 UDF,则不遍历 AST。[#40069](https://github.com/ClickHouse/ClickHouse/pull/40069) ([Raúl Marín](https://github.com/Algunenano))。优化 CurrentMemoryTracker 的分配和释放。[#40078](https://github.com/ClickHouse/ClickHouse/pull/40078) ([Raúl Marín](https://github.com/Algunenano))。
- 改进 Base58 编码/解码。[#39292](https://github.com/ClickHouse/ClickHouse/pull/39292) ([Andrey Zvonov](https://github.com/zvonand))。
- 改进 SSE/AVX/AVX512 的字节到位掩码转换。[#39586](https://github.com/ClickHouse/ClickHouse/pull/39586) ([Guo Wangyang](https://github.com/guowangy))。





#### 改进 {#improvement-4}

- 规范化 `AggregateFunction` 类型和状态表示,因为像 [#35788](https://github.com/ClickHouse/ClickHouse/pull/35788) 这样的优化会将 `count(not null columns)` 视为 `count()`,这可能导致分布式解释器出现以下错误:`Conversion from AggregateFunction(count) to AggregateFunction(count, Int64) is not supported`。[#39420](https://github.com/ClickHouse/ClickHouse/pull/39420) ([Amos Bird](https://github.com/amosbird))。具有相同状态的函数可以在物化视图中互换使用。
- 重构并简化 `system.backups` 表,移除 `internal` 列,允许用户设置操作 ID,添加 `num_files`、`uncompressed_size`、`compressed_size`、`start_time`、`end_time` 列。[#39503](https://github.com/ClickHouse/ClickHouse/pull/39503) ([Vitaly Baranov](https://github.com/vitlibar))。
- 改进 `Replicated` 数据库的 DDL 查询结果表结构(分片和副本名称使用独立列,状态更清晰) - 如果 `distributed_ddl_entry_format_version` 设置为 3(默认值),`CREATE TABLE ... ON CLUSTER` 查询可以首先在发起节点上规范化。这意味着如果发起节点不属于查询中指定的集群,`ON CLUSTER` 查询可能无法正常工作。修复 [#37318](https://github.com/ClickHouse/ClickHouse/issues/37318)、[#39500](https://github.com/ClickHouse/ClickHouse/issues/39500) - 如果数据库是 `Replicated` 且集群名称等于数据库名称,则忽略 `ON CLUSTER` 子句。相关 [#35570](https://github.com/ClickHouse/ClickHouse/issues/35570) - `Replicated` 数据库引擎的其他小修复 - 启动 `Replicated` 数据库时检查元数据一致性,如果本地元数据与 Keeper 中的元数据不匹配则启动副本恢复。解决 [#24880](https://github.com/ClickHouse/ClickHouse/issues/24880)。[#37198](https://github.com/ClickHouse/ClickHouse/pull/37198) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 在进度报告(`X-ClickHouse-Summary`)中添加 result_rows 和 result_bytes。[#39567](https://github.com/ClickHouse/ClickHouse/pull/39567) ([Raúl Marín](https://github.com/Algunenano))。
- 改进 MergeTree 的主键分析。[#25563](https://github.com/ClickHouse/ClickHouse/pull/25563) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- `timeSlots` 现在支持 DateTime64;使用 DateTime64 时可以使用亚秒级持续时间和时间槽大小。[#37951](https://github.com/ClickHouse/ClickHouse/pull/37951) ([Andrey Zvonov](https://github.com/zvonand))。
- 添加对 `EmbeddedRocksDB` 表的 `LEFT SEMI` 和 `LEFT ANTI` 直接连接的支持。[#38956](https://github.com/ClickHouse/ClickHouse/pull/38956) ([Vladimir C](https://github.com/vdimir))。
- 为 fsync 操作添加性能事件。[#39179](https://github.com/ClickHouse/ClickHouse/pull/39179) ([Azat Khuzhin](https://github.com/azat))。
- 为普通函数 `file(path[, default])` 添加第二个参数,当文件不存在时函数返回该参数值。[#39218](https://github.com/ClickHouse/ClickHouse/pull/39218) ([Nikolay Degterinsky](https://github.com/evillique))。
- 通过 http 读取的一些小修复,允许在收到 200 OK 响应时重试部分内容。[#39244](https://github.com/ClickHouse/ClickHouse/pull/39244) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 支持 `CREATE TEMPORARY TABLE ... (<list of columns>) AS ...` 查询。[#39462](https://github.com/ClickHouse/ClickHouse/pull/39462) ([Kruglov Pavel](https://github.com/Avogar))。
- 在自定义 TLD 中添加对 `!`/`*`(感叹号/星号)的支持(`cutToFirstSignificantSubdomainCustom()`/`cutToFirstSignificantSubdomainCustomWithWWW()`/`firstSignificantSubdomainCustom()`)。[#39496](https://github.com/ClickHouse/ClickHouse/pull/39496) ([Azat Khuzhin](https://github.com/azat))。
- 添加对 NATS 的 TLS 连接支持。实现 [#39525](https://github.com/ClickHouse/ClickHouse/issues/39525)。[#39527](https://github.com/ClickHouse/ClickHouse/pull/39527) ([Constantine Peresypkin](https://github.com/pkit))。
- `clickhouse-obfuscator`(用于测试和负载生成的数据库混淆工具)现在具有新的 `--save` 和 `--load` 参数,用于处理预训练模型。关闭 [#39534](https://github.com/ClickHouse/ClickHouse/issues/39534)。[#39541](https://github.com/ClickHouse/ClickHouse/pull/39541) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 修复重启期间日志轮转的错误行为。[#39558](https://github.com/ClickHouse/ClickHouse/pull/39558) ([Nikolay Degterinsky](https://github.com/evillique))。
- 修复启用外部聚合时构建聚合投影的问题。标记为改进,因为这种情况很少见,并且存在通过更改设置来修复的简单解决方法。修复 [#39667](https://github.com/ClickHouse/ClickHouse/issues/39667)。[#39671](https://github.com/ClickHouse/ClickHouse/pull/39671) ([Amos Bird](https://github.com/amosbird))。
- 允许使用 `Map` 类型的参数执行哈希函数。[#39685](https://github.com/ClickHouse/ClickHouse/pull/39685) ([Anton Popov](https://github.com/CurtizJ))。
- 添加配置参数以隐藏堆栈跟踪中的地址。这可能会稍微提高安全性,但通常是有害的,不应使用。[#39690](https://github.com/ClickHouse/ClickHouse/pull/39690) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 更改 AggregateFunctionDistinct 的前缀大小,以确保嵌套函数数据内存段对齐。[#39696](https://github.com/ClickHouse/ClickHouse/pull/39696) ([Pxl](https://github.com/BiteTheDDDDt))。
- 正确转义传递给 `clickhouse-diagnostic` 工具的凭据。[#39707](https://github.com/ClickHouse/ClickHouse/pull/39707) ([Dale McDiarmid](https://github.com/gingerwizard))。
- ClickHouse Keeper 改进:退出时创建快照。可以通过配置 `keeper_server.create_snapshot_on_exit` 控制,默认为 `true`。[#39755](https://github.com/ClickHouse/ClickHouse/pull/39755) ([Antonio Andelic](https://github.com/antonio2368))。
- 支持 `row_policy_filter` 和 `additional_filter` 的主键分析。这也有助于修复类似 [#37454](https://github.com/ClickHouse/ClickHouse/issues/37454) 的问题。[#39826](https://github.com/ClickHouse/ClickHouse/pull/39826) ([Amos Bird](https://github.com/amosbird))。
- 修复 Play UI 中的两个可用性问题:- 由于多余的边框圆角和边距,在 iPad 上显示不够精确;- 第一次查询后进度指示不显示。关闭 [#39957](https://github.com/ClickHouse/ClickHouse/issues/39957)。关闭 [#39960](https://github.com/ClickHouse/ClickHouse/issues/39960)。[#39961](https://github.com/ClickHouse/ClickHouse/pull/39961) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- Play UI:添加行号;添加单击单元格选择;为表格单元格添加滞后效应。[#39962](https://github.com/ClickHouse/ClickHouse/pull/39962) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- Play UI:识别文本区域中的 Tab 键,但同时不干扰 Tab 导航。[#40053](https://github.com/ClickHouse/ClickHouse/pull/40053) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 客户端将显示服务器端经过的时间。这对于比较远程数据中心中 ClickHouse 服务的性能非常重要。关闭 [#38070](https://github.com/ClickHouse/ClickHouse/issues/38070)。另请参阅[此处](https://github.com/ClickHouse/ClickBench/blob/main/hardware/benchmark-cloud.sh#L37)了解动机。[#39968](https://github.com/ClickHouse/ClickHouse/pull/39968) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 添加 `parseDateTime64BestEffortUS`、`parseDateTime64BestEffortUSOrNull`、`parseDateTime64BestEffortUSOrZero` 函数,关闭 [#37492](https://github.com/ClickHouse/ClickHouse/issues/37492)。[#40015](https://github.com/ClickHouse/ClickHouse/pull/40015) ([Tanya Bragin](https://github.com/tbragin))。
- 扩展 `system.processors_profile_log`,添加更多信息,如输入行数。[#40121](https://github.com/ClickHouse/ClickHouse/pull/40121) ([Amos Bird](https://github.com/amosbird))。
- 如果可用(自 ClickHouse 版本 22.8 起),`clickhouse-benchmark` 默认显示服务器端时间。这是正确比较云性能所必需的。可以使用新的 `--client-side-time` 命令行选项更改此行为。将 `--randomize` 命令行选项从 `--randomize 1` 更改为不带参数的形式。[#40193](https://github.com/ClickHouse/ClickHouse/pull/40193) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 为设置并达到查询复杂度限制的情况添加计数器(ProfileEvents)(为 `overflow_mode` = `break` 和 `throw` 分别设置计数器)。例如,如果您设置了 `max_rows_to_read` 并将 `read_overflow_mode = 'break'`,查看 `OverflowBreak` 计数器的值将允许区分不完整的结果。[#40205](https://github.com/ClickHouse/ClickHouse/pull/40205) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 修复"内存限制超出"错误情况下的内存统计(以前[峰值]内存使用量会将失败的分配计入)。[#40249](https://github.com/ClickHouse/ClickHouse/pull/40249) ([Azat Khuzhin](https://github.com/azat))。
- 为文件系统缓存添加指标:`FilesystemCacheSize` 和 `FilesystemCacheElements`。[#40260](https://github.com/ClickHouse/ClickHouse/pull/40260) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 支持 hadoop 安全 RPC 传输(hadoop.rpc.protection=privacy 和 hadoop.rpc.protection=integrity)。[#39411](https://github.com/ClickHouse/ClickHouse/pull/39411) ([michael1589](https://github.com/michael1589))。
- 避免使用函数 multi(Fuzzy)Match(Any|AllIndices|AnyIndex)() 时模式缓存的内存消耗持续增长。[#40264](https://github.com/ClickHouse/ClickHouse/pull/40264) ([Robert Schulze](https://github.com/rschu1ze))。





#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-4}

- [ClickFiddle](https://fiddle.clickhouse.com/): 一个用于在读/写模式下测试 ClickHouse 版本的新工具 (**Igor Baliuk**)。
- ClickHouse 二进制文件现已支持自解压 [#35775](https://github.com/ClickHouse/ClickHouse/pull/35775) ([Yakov Olkhovskiy, Arthur Filatenkov](https://github.com/yakov-olkhovskiy))。
- 将 tzdata 更新至 2022b 以支持新的时区变更。参见 https://github.com/google/cctz/pull/226。智利 2022 年夏令时开始时间从 9 月 4 日推迟至 9 月 11 日。伊朗计划在 2022-09-21 回退后永久停止实施夏令时。对 1977 年 Asia/Tehran 历史时区进行了修正:伊朗在 1935 年而非 1946 年采用标准时间。1977 年其夏令时实施时间为 03-21 23:00 至 10-20 24:00;1978 年的转换时间为 03-24 和 08-05,而非 03-20 和 10-20;1979 年春季转换时间为 05-27,而非 03-21 (https://data.iana.org/time-zones/tzdb/NEWS)。([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 旧版软件包曾将 systemd.service 文件安装到 `/etc` 目录。该目录中的文件被标记为 `conf`,不会被清理,也不会自动更新。此 PR 对其进行了清理。[#39323](https://github.com/ClickHouse/ClickHouse/pull/39323) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- 确保 LSan 有效运行。[#39430](https://github.com/ClickHouse/ClickHouse/pull/39430) ([Azat Khuzhin](https://github.com/azat))。
- TSAN 在 clang-14 中存在问题 (https://github.com/google/sanitizers/issues/1552, https://github.com/google/sanitizers/issues/1540),因此我们使用 clang-15 构建 TSAN 二进制文件。[#39450](https://github.com/ClickHouse/ClickHouse/pull/39450) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- 移除将 ClickHouse 工具构建为独立可执行程序的选项。此更改修复了 [#37847](https://github.com/ClickHouse/ClickHouse/issues/37847)。[#39520](https://github.com/ClickHouse/ClickHouse/pull/39520) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 为在 s390x(大端序架构)上构建进行小规模准备工作。[#39627](https://github.com/ClickHouse/ClickHouse/pull/39627) ([Harry Lee](https://github.com/HarryLeeIBM))。[#39656](https://github.com/ClickHouse/ClickHouse/pull/39656) ([Harry Lee](https://github.com/HarryLeeIBM))。修复了 s390x 架构 BitHelpers 中的字节序问题。[#39656](https://github.com/ClickHouse/ClickHouse/pull/39656) ([Harry Lee](https://github.com/HarryLeeIBM))。为 s390x 架构(ClickHouse 不支持该架构)实现了与 SipHash 相关的代码片段。[#39732](https://github.com/ClickHouse/ClickHouse/pull/39732) ([Harry Lee](https://github.com/HarryLeeIBM))。修复了 s390x 架构(ClickHouse 不支持该架构)Coordination 快照代码中的字节序问题。[#39931](https://github.com/ClickHouse/ClickHouse/pull/39931) ([Harry Lee](https://github.com/HarryLeeIBM))。修复了 s390x 架构(ClickHouse 不支持该架构)Codec 代码中的字节序问题。[#40008](https://github.com/ClickHouse/ClickHouse/pull/40008) ([Harry Lee](https://github.com/HarryLeeIBM))。修复了 s390x 架构(ClickHouse 不支持该架构)ReadHelpers 和 WriteHelpers 代码中读取/写入大端序二进制数据时的字节序问题。[#40179](https://github.com/ClickHouse/ClickHouse/pull/40179) ([Harry Lee](https://github.com/HarryLeeIBM))。
- 支持使用 `clang-16` (trunk) 进行构建。此更改关闭了 [#39949](https://github.com/ClickHouse/ClickHouse/issues/39949)。[#40181](https://github.com/ClickHouse/ClickHouse/pull/40181) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 准备在 CI 中运行 RISC-V 64 构建。此工作针对 [#40141](https://github.com/ClickHouse/ClickHouse/issues/40141)。[#40197](https://github.com/ClickHouse/ClickHouse/pull/40197) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 简化了函数注册宏接口 (`FUNCTION_REGISTER*`),消除了在 registerFunctions.cpp 中添加和调用外部函数的步骤,同时也加快了新函数的增量构建速度。[#38615](https://github.com/ClickHouse/ClickHouse/pull/38615) ([Li Yin](https://github.com/liyinsg))。
- Docker: 现在 Docker 镜像中的 entrypoint.sh 会为多磁盘配置中在配置文件中找到的所有文件夹创建并执行 chown [#17717](https://github.com/ClickHouse/ClickHouse/issues/17717)。[#39121](https://github.com/ClickHouse/ClickHouse/pull/39121) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。





#### 错误修复 {#bug-fix-1}

- Fix possible segfault in `CapnProto` input format. This bug was found and send through ClickHouse bug-bounty [program](https://github.com/ClickHouse/ClickHouse/issues/38986) by _kiojj_. [#40241](https://github.com/ClickHouse/ClickHouse/pull/40241) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix a very rare case of incorrect behavior of array subscript operator. This closes [#28720](https://github.com/ClickHouse/ClickHouse/issues/28720). [#40185](https://github.com/ClickHouse/ClickHouse/pull/40185) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix insufficient argument check for encryption functions (found by query fuzzer). This closes [#39987](https://github.com/ClickHouse/ClickHouse/issues/39987). [#40194](https://github.com/ClickHouse/ClickHouse/pull/40194) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix the case when the order of columns can be incorrect if the `IN` operator is used with a table with `ENGINE = Set` containing multiple columns. This fixes [#13014](https://github.com/ClickHouse/ClickHouse/issues/13014). [#40225](https://github.com/ClickHouse/ClickHouse/pull/40225) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix seeking while reading from encrypted disk. This PR fixes [#38381](https://github.com/ClickHouse/ClickHouse/issues/38381). [#39687](https://github.com/ClickHouse/ClickHouse/pull/39687) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix duplicate columns in join plan. Finally, solve [#26809](https://github.com/ClickHouse/ClickHouse/issues/26809). [#40009](https://github.com/ClickHouse/ClickHouse/pull/40009) ([Vladimir C](https://github.com/vdimir)).
- Fixed query hanging for SELECT with ORDER BY WITH FILL with different date/time types. [#37849](https://github.com/ClickHouse/ClickHouse/pull/37849) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix ORDER BY that matches projections ORDER BY (before it simply returns unsorted result). [#38725](https://github.com/ClickHouse/ClickHouse/pull/38725) ([Azat Khuzhin](https://github.com/azat)).
- Do not optimise functions in GROUP BY statements if they shadow one of the table columns or expressions. Fixes [#37032](https://github.com/ClickHouse/ClickHouse/issues/37032). [#39103](https://github.com/ClickHouse/ClickHouse/pull/39103) ([Anton Kozlov](https://github.com/tonickkozlov)).
- Fix wrong table name in logs after RENAME TABLE. This fixes [#38018](https://github.com/ClickHouse/ClickHouse/issues/38018). [#39227](https://github.com/ClickHouse/ClickHouse/pull/39227) ([Amos Bird](https://github.com/amosbird)).
- Fix positional arguments in case of columns pruning when optimising the query. Closes [#38433](https://github.com/ClickHouse/ClickHouse/issues/38433). [#39293](https://github.com/ClickHouse/ClickHouse/pull/39293) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix bug in schema inference in case of empty messages in Protobuf/CapnProto formats that allowed to create column with empty `Tuple` type. Closes [#39051](https://github.com/ClickHouse/ClickHouse/issues/39051) Add 2 new settings `input_format_{protobuf/capnproto}_skip_fields_with_unsupported_types_in_schema_inference` that allow to skip fields with unsupported types while schema inference for Protobuf and CapnProto formats. [#39357](https://github.com/ClickHouse/ClickHouse/pull/39357) ([Kruglov Pavel](https://github.com/Avogar)).
- (Window View is an experimental feature) Fix segmentation fault on `CREATE WINDOW VIEW .. ON CLUSTER ... INNER`. Closes [#39363](https://github.com/ClickHouse/ClickHouse/issues/39363). [#39384](https://github.com/ClickHouse/ClickHouse/pull/39384) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix WriteBuffer finalize when cancelling insert into function (in previous versions it may leat to std::terminate). [#39458](https://github.com/ClickHouse/ClickHouse/pull/39458) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix storing of columns of type `Object` in sparse serialization. [#39464](https://github.com/ClickHouse/ClickHouse/pull/39464) ([Anton Popov](https://github.com/CurtizJ)).
- Fix possible "Not found column in block" exception when using projections. This closes [#39469](https://github.com/ClickHouse/ClickHouse/issues/39469). [#39470](https://github.com/ClickHouse/ClickHouse/pull/39470) ([小路](https://github.com/nicelulu)).
- Fix exception on race between DROP and INSERT with materialized views. [#39477](https://github.com/ClickHouse/ClickHouse/pull/39477) ([Azat Khuzhin](https://github.com/azat)).
- A bug in Apache Avro library: fix data race and possible heap-buffer-overflow in Avro format. Closes [#39094](https://github.com/ClickHouse/ClickHouse/issues/39094) Closes [#33652](https://github.com/ClickHouse/ClickHouse/issues/33652). [#39498](https://github.com/ClickHouse/ClickHouse/pull/39498) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix rare bug in asynchronous reading (with setting `local_filesystem_read_method='pread_threadpool'`) with enabled `O_DIRECT` (enabled by setting `min_bytes_to_use_direct_io`). [#39506](https://github.com/ClickHouse/ClickHouse/pull/39506) ([Anton Popov](https://github.com/CurtizJ)).
- (only on FreeBSD) Fixes "Code: 49. DB::Exception: FunctionFactory: the function name '' is not unique. (LOGICAL_ERROR)" observed on FreeBSD when starting clickhouse. [#39551](https://github.com/ClickHouse/ClickHouse/pull/39551) ([Alexander Gololobov](https://github.com/davenger)).
- Fix bug with the recently introduced "maxsplit" argument for `splitByChar`, which was not working correctly. [#39552](https://github.com/ClickHouse/ClickHouse/pull/39552) ([filimonov](https://github.com/filimonov)).
- Fix bug in ASOF JOIN with `enable_optimize_predicate_expression`, close [#37813](https://github.com/ClickHouse/ClickHouse/issues/37813). [#39556](https://github.com/ClickHouse/ClickHouse/pull/39556) ([Vladimir C](https://github.com/vdimir)).
- Fixed `CREATE/DROP INDEX` query with `ON CLUSTER` or `Replicated` database and `ReplicatedMergeTree`. It used to be executed on all replicas (causing error or DDL queue stuck). Fixes [#39511](https://github.com/ClickHouse/ClickHouse/issues/39511). [#39565](https://github.com/ClickHouse/ClickHouse/pull/39565) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix "column not found" error for push down with join, close [#39505](https://github.com/ClickHouse/ClickHouse/issues/39505). [#39575](https://github.com/ClickHouse/ClickHouse/pull/39575) ([Vladimir C](https://github.com/vdimir)).
- Fix the wrong `REGEXP_REPLACE` alias. This fixes https://github.com/ClickHouse/ClickBench/issues/9. [#39592](https://github.com/ClickHouse/ClickHouse/pull/39592) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fixed point of origin for exponential decay window functions to the last value in window. Previously, decay was calculated by formula `exp((t - curr_row_t) / decay_length)`, which is incorrect when right boundary of window is not `CURRENT ROW`. It was changed to: `exp((t - last_row_t) / decay_length)`. There is no change in results for windows with `ROWS BETWEEN (smth) AND CURRENT ROW`. [#39593](https://github.com/ClickHouse/ClickHouse/pull/39593) ([Vladimir Chebotaryov](https://github.com/quickhouse)).
- Fix Decimal division overflow, which can be detected based on operands scale. [#39600](https://github.com/ClickHouse/ClickHouse/pull/39600) ([Andrey Zvonov](https://github.com/zvonand)).
- Fix settings `output_format_arrow_string_as_string` and `output_format_arrow_low_cardinality_as_dictionary` work in combination. Closes [#39624](https://github.com/ClickHouse/ClickHouse/issues/39624). [#39647](https://github.com/ClickHouse/ClickHouse/pull/39647) ([Kruglov Pavel](https://github.com/Avogar)).
- Fixed a bug in default database resolution in distributed table reads. [#39674](https://github.com/ClickHouse/ClickHouse/pull/39674) ([Anton Kozlov](https://github.com/tonickkozlov)).
- (Only with the obsolete Ordinary databases) Select might read data of dropped table if cache for mmap IO is used and database engine is Ordinary and new tables was created with the same name as dropped one had. It's fixed. [#39708](https://github.com/ClickHouse/ClickHouse/pull/39708) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix possible error `Invalid column type for ColumnUnique::insertRangeFrom. Expected String, got ColumnLowCardinality` Fixes [#38460](https://github.com/ClickHouse/ClickHouse/issues/38460). [#39716](https://github.com/ClickHouse/ClickHouse/pull/39716) ([Arthur Passos](https://github.com/arthurpassos)).
- Field names in the `meta` section of JSON format were erroneously double escaped. This closes [#39693](https://github.com/ClickHouse/ClickHouse/issues/39693). [#39747](https://github.com/ClickHouse/ClickHouse/pull/39747) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix wrong index analysis with tuples and operator `IN`, which could lead to wrong query result. [#39752](https://github.com/ClickHouse/ClickHouse/pull/39752) ([Anton Popov](https://github.com/CurtizJ)).
- Fix `EmbeddedRocksDB` tables filtering by key using params. [#39757](https://github.com/ClickHouse/ClickHouse/pull/39757) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix error `Invalid number of columns in chunk pushed to OutputPort` which was caused by ARRAY JOIN optimization. Fixes [#39164](https://github.com/ClickHouse/ClickHouse/issues/39164). [#39799](https://github.com/ClickHouse/ClickHouse/pull/39799) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- A workaround for a bug in Linux kernel. Fix `CANNOT_READ_ALL_DATA` exception with `local_filesystem_read_method=pread_threadpool`. This bug affected only Linux kernel version 5.9 and 5.10 according to [man](https://manpages.debian.org/testing/manpages-dev/preadv2.2.en.html#BUGS). [#39800](https://github.com/ClickHouse/ClickHouse/pull/39800) ([Anton Popov](https://github.com/CurtizJ)).
- (Only on NFS) Fix broken NFS mkdir for root-squashed volumes. [#39898](https://github.com/ClickHouse/ClickHouse/pull/39898) ([Constantine Peresypkin](https://github.com/pkit)).
- Remove dictionaries from prometheus metrics on DETACH/DROP. [#39926](https://github.com/ClickHouse/ClickHouse/pull/39926) ([Azat Khuzhin](https://github.com/azat)).
- Fix read of StorageFile with virtual columns. Closes [#39907](https://github.com/ClickHouse/ClickHouse/issues/39907). [#39943](https://github.com/ClickHouse/ClickHouse/pull/39943) ([flynn](https://github.com/ucasfl)).
- Fix big memory usage during fetches. Fixes [#39915](https://github.com/ClickHouse/ClickHouse/issues/39915). [#39990](https://github.com/ClickHouse/ClickHouse/pull/39990) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- (experimental feature) Fix `hashId` crash and salt parameter not being used. [#40002](https://github.com/ClickHouse/ClickHouse/pull/40002) ([Raúl Marín](https://github.com/Algunenano)).
- `EXCEPT` and `INTERSECT` operators may lead to crash if a specific combination of constant and non-constant columns were used. [#40020](https://github.com/ClickHouse/ClickHouse/pull/40020) ([Duc Canh Le](https://github.com/canhld94)).
- Fixed "Part directory doesn't exist" and "`tmp_<part_name>` ... No such file or directory" errors during too slow INSERT or too long merge/mutation. Also fixed issue that may cause some replication queue entries to stuck without any errors or warnings in logs if previous attempt to fetch part failed, but `tmp-fetch_<part_name>` directory was not cleaned up. [#40031](https://github.com/ClickHouse/ClickHouse/pull/40031) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix rare cases of parsing of arrays of tuples in format `Values`. [#40034](https://github.com/ClickHouse/ClickHouse/pull/40034) ([Anton Popov](https://github.com/CurtizJ)).
- Fixes ArrowColumn format Dictionary(X) & Dictionary(Nullable(X)) conversion to ClickHouse LowCardinality(X) & LowCardinality(Nullable(X)) respectively. [#40037](https://github.com/ClickHouse/ClickHouse/pull/40037) ([Arthur Passos](https://github.com/arthurpassos)).
- Fix potential deadlock in writing to S3 during task scheduling failure. [#40070](https://github.com/ClickHouse/ClickHouse/pull/40070) ([Maksim Kita](https://github.com/kitaisreal)).
- Fix bug in collectFilesToSkip() by adding correct file extension (.idx or idx2) for indexes to be recalculated, avoid wrong hard links. Fixed [#39896](https://github.com/ClickHouse/ClickHouse/issues/39896). [#40095](https://github.com/ClickHouse/ClickHouse/pull/40095) ([Jianmei Zhang](https://github.com/zhangjmruc)).
- A fix for reverse DNS resolution. [#40134](https://github.com/ClickHouse/ClickHouse/pull/40134) ([Arthur Passos](https://github.com/arthurpassos)).
- Fix unexpected result `arrayDifference` of `Array(UInt32). [#40211](https://github.com/ClickHouse/ClickHouse/pull/40211) ([Duc Canh Le](https://github.com/canhld94)).

### <a id="227"></a> ClickHouse release 22.7, 2022-07-21 {#a-id227a-clickhouse-release-227-2022-07-21}

#### 升级说明 {#upgrade-notes-1}

- 默认启用 `enable_positional_arguments` 设置。该设置允许使用类似 `SELECT ... ORDER BY 1, 2` 的查询,其中 1、2 是对 select 子句的引用。如需恢复旧行为,请禁用此设置。[#38204](https://github.com/ClickHouse/ClickHouse/pull/38204) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 默认禁用 `format_csv_allow_single_quotes`。参见 [#37096](https://github.com/ClickHouse/ClickHouse/issues/37096)。([Kruglov Pavel](https://github.com/Avogar))。
- `Ordinary` 数据库引擎和 `*MergeTree` 表的旧存储定义语法已被弃用。默认情况下无法使用 `Ordinary` 引擎创建新数据库。如果 `system` 数据库使用 `Ordinary` 引擎,它将在服务器启动时自动转换为 `Atomic`。有一些设置可以保留旧行为(`allow_deprecated_database_ordinary` 和 `allow_deprecated_syntax_for_merge_tree`),但这些设置可能会在未来版本中移除。[#38335](https://github.com/ClickHouse/ClickHouse/pull/38335) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 默认强制将逗号连接重写为内连接(设置默认值 `cross_to_inner_join_rewrite = 2`)。要保留旧行为,请设置 `cross_to_inner_join_rewrite = 1`。[#39326](https://github.com/ClickHouse/ClickHouse/pull/39326) ([Vladimir C](https://github.com/vdimir))。如果遇到任何不兼容问题,可以将此设置恢复。


#### 新功能 {#new-feature-5}

- 支持窗口函数表达式。关闭 [#19857](https://github.com/ClickHouse/ClickHouse/issues/19857)。[#37848](https://github.com/ClickHouse/ClickHouse/pull/37848) ([Dmitry Novik](https://github.com/novikd))。
- 为 `EmbeddedRocksDB` 表新增 `direct` 连接算法,参见 [#33582](https://github.com/ClickHouse/ClickHouse/issues/33582)。[#35363](https://github.com/ClickHouse/ClickHouse/pull/35363) ([Vladimir C](https://github.com/vdimir))。
- 新增完整排序归并连接算法。[#35796](https://github.com/ClickHouse/ClickHouse/pull/35796) ([Vladimir C](https://github.com/vdimir))。
- 实现 NATS 表引擎,支持向 NATS 发布/订阅消息。关闭 [#32388](https://github.com/ClickHouse/ClickHouse/issues/32388)。[#37171](https://github.com/ClickHouse/ClickHouse/pull/37171) ([tchepavel](https://github.com/tchepavel))。([Kseniia Sumarokova](https://github.com/kssenii))
- 实现 `mongodb` 表函数。支持写入 `MongoDB` 存储/表函数。[#37213](https://github.com/ClickHouse/ClickHouse/pull/37213) ([aaapetrenko](https://github.com/aaapetrenko))。([Kseniia Sumarokova](https://github.com/kssenii))
- 新增 `SQLInsert` 输出格式。关闭 [#38441](https://github.com/ClickHouse/ClickHouse/issues/38441)。[#38477](https://github.com/ClickHouse/ClickHouse/pull/38477) ([Kruglov Pavel](https://github.com/Avogar))。
- 引入 `additional_table_filters` 设置。使用此设置可为表指定额外的过滤条件,该条件将在读取后立即应用。示例:`select number, x, y from (select number from system.numbers limit 5) f any left join (select x, y from table_1) s on f.number = s.x settings additional_table_filters={'system.numbers : 'number != 3', 'table_1' : 'x != 2'}`。引入 `additional_result_filter` 设置,用于指定查询结果的额外过滤条件。关闭 [#37918](https://github.com/ClickHouse/ClickHouse/issues/37918)。[#38475](https://github.com/ClickHouse/ClickHouse/pull/38475) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 新增 `compatibility` 设置和 `system.settings_changes` 系统表,包含 ClickHouse 各版本设置变更的信息。关闭 [#35972](https://github.com/ClickHouse/ClickHouse/issues/35972)。[#38957](https://github.com/ClickHouse/ClickHouse/pull/38957) ([Kruglov Pavel](https://github.com/Avogar))。
- 新增函数 `translate(string, from_string, to_string)` 和 `translateUTF8(string, from_string, to_string)`。用于将某些字符转换为其他字符。[#38935](https://github.com/ClickHouse/ClickHouse/pull/38935) ([Nikolay Degterinsky](https://github.com/evillique))。
- 支持 `parseTimeDelta` 函数。可以使用 ` ;-+,:` 作为分隔符,例如 `1yr-2mo`、`2m:6s`:`SELECT parseTimeDelta('1yr-2mo-4w + 12 days, 3 hours : 1 minute ; 33 seconds')`。[#39071](https://github.com/ClickHouse/ClickHouse/pull/39071) ([jiahui-97](https://github.com/jiahui-97))。
- 新增 `CREATE TABLE ... EMPTY AS SELECT` 查询。自动从 SELECT 查询推断表结构,但创建后不填充表。解决 [#38049](https://github.com/ClickHouse/ClickHouse/issues/38049)。[#38272](https://github.com/ClickHouse/ClickHouse/pull/38272) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 新增限制远程存储 IO 操作的选项:`max_remote_read_network_bandwidth_for_server` 和 `max_remote_write_network_bandwidth_for_server`。[#39095](https://github.com/ClickHouse/ClickHouse/pull/39095) ([Sergei Trifonov](https://github.com/serxa))。
- 新增 `group_by_use_nulls` 设置,使聚合键列在 ROLLUP、CUBE 和 GROUPING SETS 情况下可为空。关闭 [#37359](https://github.com/ClickHouse/ClickHouse/issues/37359)。[#38642](https://github.com/ClickHouse/ClickHouse/pull/38642) ([Dmitry Novik](https://github.com/novikd))。
- 新增在数据导出期间指定压缩级别的功能。[#38907](https://github.com/ClickHouse/ClickHouse/pull/38907) ([Nikolay Degterinsky](https://github.com/evillique))。
- 新增选项,要求显式授权才能从 `system` 数据库执行 SELECT 操作。详情:[#38970](https://github.com/ClickHouse/ClickHouse/pull/38970) ([Vitaly Baranov](https://github.com/vitlibar))。
- 函数 `multiMatchAny`、`multiMatchAnyIndex`、`multiMatchAllIndices` 及其模糊变体现在接受非常量模式数组参数。[#38485](https://github.com/ClickHouse/ClickHouse/pull/38485) ([Robert Schulze](https://github.com/rschu1ze))。SQL 函数 `multiSearchAllPositions` 现在接受非常量搜索参数。[#39167](https://github.com/ClickHouse/ClickHouse/pull/39167) ([Robert Schulze](https://github.com/rschu1ze))。
- 新增 `zstd_window_log_max` 设置,用于配置导入外部文件时 zstd 解码的最大内存使用量。关闭 [#35693](https://github.com/ClickHouse/ClickHouse/issues/35693)。[#37015](https://github.com/ClickHouse/ClickHouse/pull/37015) ([wuxiaobai24](https://github.com/wuxiaobai24))。
- 新增 `send_logs_source_regexp` 设置。发送服务器文本日志时使用指定的正则表达式匹配日志源名称。空值表示所有源。[#39161](https://github.com/ClickHouse/ClickHouse/pull/39161) ([Amos Bird](https://github.com/amosbird))。
- 支持对 `Hive` 表执行 `ALTER` 操作。[#38214](https://github.com/ClickHouse/ClickHouse/pull/38214) ([lgbo](https://github.com/lgbo-ustc))。
- 支持 `isNullable` 函数。此函数检查其参数是否可为空并返回 1 或 0。关闭 [#38611](https://github.com/ClickHouse/ClickHouse/issues/38611)。[#38841](https://github.com/ClickHouse/ClickHouse/pull/38841) ([lokax](https://github.com/lokax))。
- 新增 base58 编码/解码函数。[#38159](https://github.com/ClickHouse/ClickHouse/pull/38159) ([Andrey Zvonov](https://github.com/zvonand))。
- 为 Play UI 新增图表可视化功能。[#38197](https://github.com/ClickHouse/ClickHouse/pull/38197) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 为数组和元组新增 L2 平方距离和范数函数。[#38545](https://github.com/ClickHouse/ClickHouse/pull/38545) ([Julian Gilyadov](https://github.com/israelg99))。
- 新增通过 SQL 向 `url` 表函数/存储传递 HTTP 头的功能。关闭 [#37897](https://github.com/ClickHouse/ClickHouse/issues/37897)。[#38176](https://github.com/ClickHouse/ClickHouse/pull/38176) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 在软件包中新增 `clickhouse-diagnostics` 二进制文件。[#38647](https://github.com/ClickHouse/ClickHouse/pull/38647) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。

#### 实验性功能 {#experimental-feature-4}

- 新增设置 `implicit_transaction`,用于在事务中运行独立查询。该设置会自动处理事务的创建和关闭(查询成功时执行 COMMIT,失败时执行 ROLLBACK)。[#38344](https://github.com/ClickHouse/ClickHouse/pull/38344) ([Raúl Marín](https://github.com/Algunenano))。


#### 性能改进 {#performance-improvement-5}

- 针对已排序列的 Distinct 优化。当输入流按 distinct 中的列排序时,使用专门的 distinct 转换。优化可应用于预 distinct、最终 distinct 或两者。初始实现由 @dimarub2000 完成。[#37803](https://github.com/ClickHouse/ClickHouse/pull/37803) ([Igor Nikonov](https://github.com/devcrafter))。
- 使用批处理版本的 `BinaryHeap` 改进 `ORDER BY`、`MergeTree` 合并和窗口函数的性能。[#38022](https://github.com/ClickHouse/ClickHouse/pull/38022) ([Maksim Kita](https://github.com/kitaisreal))。
- 为带有 `FINAL` 的查询提供更多并行执行。[#36396](https://github.com/ClickHouse/ClickHouse/pull/36396) ([Nikita Taranov](https://github.com/nickitat))。
- 修复在 [#35616](https://github.com/ClickHouse/ClickHouse/pull/35616) 中引入的重大 join 性能回退。有趣的是,诸如 ssb 查询之类的常见 join 查询在近 3 个月内慢了 10 倍,却没有人投诉。[#38052](https://github.com/ClickHouse/ClickHouse/pull/38052) ([Amos Bird](https://github.com/amosbird))。
- 从 Intel hyperscan 库迁移到 vectorscan,这在非 x86 平台上加速了许多字符串匹配操作。[#38171](https://github.com/ClickHouse/ClickHouse/pull/38171) ([Robert Schulze](https://github.com/rschu1ze))。
- 提高聚合后执行的查询计划步骤的并行度。[#38295](https://github.com/ClickHouse/ClickHouse/pull/38295) ([Nikita Taranov](https://github.com/nickitat))。
- 改进 `JSON` 类型列的插入性能。[#38320](https://github.com/ClickHouse/ClickHouse/pull/38320) ([Anton Popov](https://github.com/CurtizJ))。
- 优化 HashTable 中的插入和查找操作。[#38413](https://github.com/ClickHouse/ClickHouse/pull/38413) ([Nikita Taranov](https://github.com/nickitat))。
- 修复来自 [#32493](https://github.com/ClickHouse/ClickHouse/issues/32493) 的性能下降问题。[#38417](https://github.com/ClickHouse/ClickHouse/pull/38417) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 使用 SIMD 指令改进数值列的 join 性能。[#37235](https://github.com/ClickHouse/ClickHouse/pull/37235) ([zzachimed](https://github.com/zzachimed))。[#38565](https://github.com/ClickHouse/ClickHouse/pull/38565) ([Maksim Kita](https://github.com/kitaisreal))。
- 数组的 Norm 和 Distance 函数速度提升 1.2-2 倍。[#38740](https://github.com/ClickHouse/ClickHouse/pull/38740) ([Alexander Gololobov](https://github.com/davenger))。
- 为 LZ4 解压缩添加 AVX-512 VBMI 优化的 `copyOverlap32Shuffle`。换句话说,LZ4 解压缩性能得到改进。[#37891](https://github.com/ClickHouse/ClickHouse/pull/37891) ([Guo Wangyang](https://github.com/guowangy))。
- `ORDER BY (a, b)` 将使用与 `ORDER BY a, b` 相同的所有优势。[#38873](https://github.com/ClickHouse/ClickHouse/pull/38873) ([Igor Nikonov](https://github.com/devcrafter))。
- 将分支对齐到 32B 边界以使基准测试更稳定。[#38988](https://github.com/ClickHouse/ClickHouse/pull/38988) ([Guo Wangyang](https://github.com/guowangy))。在 Intel 上平均提升 1..2% 的性能。
- 可执行 UDF、可执行字典和 Executable 表将避免在等待子进程终止期间浪费一秒钟。[#38929](https://github.com/ClickHouse/ClickHouse/pull/38929) ([Constantine Peresypkin](https://github.com/pkit))。
- 当未选择所有列时,优化对 `system.stack_trace` 表的访问。[#39177](https://github.com/ClickHouse/ClickHouse/pull/39177) ([Azat Khuzhin](https://github.com/azat))。
- 改进 LowCardinality 参数的 isNullable/isConstant/isNull/isNotNull 性能。[#39192](https://github.com/ClickHouse/ClickHouse/pull/39192) ([Kruglov Pavel](https://github.com/Avogar))。
- 优化窗口函数中 ORDER BY 的处理。[#34632](https://github.com/ClickHouse/ClickHouse/pull/34632) ([Vladimir Chebotarev](https://github.com/excitoon))。
- 表 `system.asynchronous_metric_log` 进一步优化了存储空间。这解决了 [#38134](https://github.com/ClickHouse/ClickHouse/issues/38134)。请参阅 [YouTube 视频](https://www.youtube.com/watch?v=0fSp9SF8N8A)。[#38428](https://github.com/ClickHouse/ClickHouse/pull/38428) ([Alexey Milovidov](https://github.com/alexey-milovidov))。





#### 改进 {#improvement-5}

- 支持 SQL 标准的 CREATE INDEX 和 DROP INDEX 语法。[#35166](https://github.com/ClickHouse/ClickHouse/pull/35166) ([Jianmei Zhang](https://github.com/zhangjmruc))。
- 为 INSERT 查询发送性能分析事件(此前仅支持 SELECT)。[#37391](https://github.com/ClickHouse/ClickHouse/pull/37391) ([Azat Khuzhin](https://github.com/azat))。
- 为完全物化的投影实现有序聚合(`optimize_aggregation_in_order`)。[#37469](https://github.com/ClickHouse/ClickHouse/pull/37469) ([Azat Khuzhin](https://github.com/azat))。
- 移除 Kerberos 初始化的子进程运行。添加了新的集成测试。关闭 [#27651](https://github.com/ClickHouse/ClickHouse/issues/27651)。[#38105](https://github.com/ClickHouse/ClickHouse/pull/38105) ([Roman Vasin](https://github.com/rvasin))。
- - 添加设置 `multiple_joins_try_to_keep_original_names`,在多个 JOIN 重写时不重写标识符名称,关闭 [#34697](https://github.com/ClickHouse/ClickHouse/issues/34697)。[#38149](https://github.com/ClickHouse/ClickHouse/pull/38149) ([Vladimir C](https://github.com/vdimir))。
- 改进了 trace-visualizer 用户体验。[#38169](https://github.com/ClickHouse/ClickHouse/pull/38169) ([Sergei Trifonov](https://github.com/serxa))。
- 为 AArch64 启用堆栈跟踪收集和查询性能分析器。[#38181](https://github.com/ClickHouse/ClickHouse/pull/38181) ([Maksim Kita](https://github.com/kitaisreal))。
- 在加载 SQL 用户定义函数期间不跳过 `user_defined` 目录中的符号链接。关闭 [#38042](https://github.com/ClickHouse/ClickHouse/issues/38042)。[#38184](https://github.com/ClickHouse/ClickHouse/pull/38184) ([Maksim Kita](https://github.com/kitaisreal))。
- 添加了 `store/` 中子目录的后台清理。在某些情况下,clickhouse-server 可能会在 `store/` 中留下垃圾子目录(例如,在表创建失败时),这些目录从未被删除。修复 [#33710](https://github.com/ClickHouse/ClickHouse/issues/33710)。[#38265](https://github.com/ClickHouse/ClickHouse/pull/38265) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 添加 `DESCRIBE CACHE` 查询以显示配置中的缓存设置。添加 `SHOW CACHES` 查询以显示可用的文件系统缓存列表。[#38279](https://github.com/ClickHouse/ClickHouse/pull/38279) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 为 `system drop filesystem cache` 添加访问检查。支持 ON CLUSTER。[#38319](https://github.com/ClickHouse/ClickHouse/pull/38319) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 修复从 21.3 升级到 22.3 时 PostgreSQL 数据库引擎的不兼容问题。关闭 [#36659](https://github.com/ClickHouse/ClickHouse/issues/36659)。[#38369](https://github.com/ClickHouse/ClickHouse/pull/38369) ([Kseniia Sumarokova](https://github.com/kssenii))。
- `filesystemAvailable` 和类似函数现在可以在 `clickhouse-local` 中工作。这关闭了 [#38423](https://github.com/ClickHouse/ClickHouse/issues/38423)。[#38424](https://github.com/ClickHouse/ClickHouse/pull/38424) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 添加 `revision` 函数。[#38555](https://github.com/ClickHouse/ClickHouse/pull/38555) ([Azat Khuzhin](https://github.com/azat))。
- 修复通过代理隧道使用 GCS 的问题。[#38726](https://github.com/ClickHouse/ClickHouse/pull/38726) ([Azat Khuzhin](https://github.com/azat))。
- 在 clickhouse client / local 中支持 `\i file`(类似于 psql \i)。[#38813](https://github.com/ClickHouse/ClickHouse/pull/38813) ([Kseniia Sumarokova](https://github.com/kssenii))。
- `EXPLAIN AST` 中的新选项 `optimize = 1`。如果启用,显示重写后的 AST,否则显示原始查询的 AST。默认禁用。[#38910](https://github.com/ClickHouse/ClickHouse/pull/38910) ([Igor Nikonov](https://github.com/devcrafter))。
- 允许列列表中的尾随逗号。关闭 [#38425](https://github.com/ClickHouse/ClickHouse/issues/38425)。[#38440](https://github.com/ClickHouse/ClickHouse/pull/38440) ([chen](https://github.com/xiedeyantu))。
- `parallel_hash` JOIN 方法的错误修复和性能改进。[#37648](https://github.com/ClickHouse/ClickHouse/pull/37648) ([Vladimir C](https://github.com/vdimir))。
- 支持 Hadoop 安全 RPC 传输(hadoop.rpc.protection=privacy 和 hadoop.rpc.protection=integrity)。[#37852](https://github.com/ClickHouse/ClickHouse/pull/37852) ([Peng Liu](https://github.com/michael1589))。
- 在 `StorageHive` 中添加 struct 类型支持。[#38118](https://github.com/ClickHouse/ClickHouse/pull/38118) ([lgbo](https://github.com/lgbo-ustc))。
- S3 单个对象现在使用 `RemoveObjectRequest` 删除。实现与 GCP 的兼容性,GCP 不允许使用 `removeFileIfExists`,这有效地破坏了大约一半的 `remove` 功能。自动检测 GCS 不支持的 `DeleteObjects` S3 API。这将允许在配置中不显式设置 `support_batch_delete=0` 的情况下使用 GCS。[#37882](https://github.com/ClickHouse/ClickHouse/pull/37882) ([Vladimir Chebotarev](https://github.com/excitoon))。
- 公开基本的 ClickHouse Keeper 相关监控数据(通过 ProfileEvents 和 CurrentMetrics)。[#38072](https://github.com/ClickHouse/ClickHouse/pull/38072) ([lingpeng0314](https://github.com/lingpeng0314))。
- 支持 PostgreSQL 引擎连接的 `auto_close` 选项。关闭 [#31486](https://github.com/ClickHouse/ClickHouse/issues/31486)。[#38363](https://github.com/ClickHouse/ClickHouse/pull/38363) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 允许在表函数的列声明中使用 `NULL` 修饰符。[#38816](https://github.com/ClickHouse/ClickHouse/pull/38816) ([Kruglov Pavel](https://github.com/Avogar))。
- 在关闭前停用 `mutations_finalizing_task` 以避免关闭期间出现良性的 `TABLE_IS_READ_ONLY` 错误。[#38851](https://github.com/ClickHouse/ClickHouse/pull/38851) ([Raúl Marín](https://github.com/Algunenano))。
- 如果使用已弃用的 Ordinary 数据库,在存在 INSERT 查询的情况下,消除 ALTER 查询后 SELECT 查询的不必要等待。[#38864](https://github.com/ClickHouse/ClickHouse/pull/38864) ([Azat Khuzhin](https://github.com/azat))。
- `EXPLAIN AST` 中的新选项 `rewrite`。如果启用,显示重写后的 AST,否则显示原始查询的 AST。默认禁用。[#38910](https://github.com/ClickHouse/ClickHouse/pull/38910) ([Igor Nikonov](https://github.com/devcrafter))。
- 当预期出现 ZooKeeper "Node exists" 异常时,停止在 system.errors 中报告这些异常。[#38961](https://github.com/ClickHouse/ClickHouse/pull/38961) ([Raúl Marín](https://github.com/Algunenano))。
- `clickhouse-keeper`:添加对实时摘要计算和验证的支持。默认禁用。[#37555](https://github.com/ClickHouse/ClickHouse/pull/37555) ([Antonio Andelic](https://github.com/antonio2368))。
- 允许在 `clickhouse-extract-from-config` 工具的键内指定通配符 `* or {expr1, expr2, expr3}`。[#38966](https://github.com/ClickHouse/ClickHouse/pull/38966) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- clearOldLogs:在并发删除时不报告 KEEPER_EXCEPTION。[#39016](https://github.com/ClickHouse/ClickHouse/pull/39016) ([Raúl Marín](https://github.com/Algunenano))。
- clickhouse-keeper 改进:将关于 keeper 服务器的元信息持久化到磁盘。[#39069](https://github.com/ClickHouse/ClickHouse/pull/39069) ([Antonio Andelic](https://github.com/antonio2368))。这将使同时关闭或重启所有 keeper 节点的操作更加容易。
- 使用文件系统缓存时磁盘空间不足时继续运行而不抛出异常。[#39106](https://github.com/ClickHouse/ClickHouse/pull/39106) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 处理来自 k8s 的 SIGTERM 信号。[#39130](https://github.com/ClickHouse/ClickHouse/pull/39130) ([Timur Solodovnikov](https://github.com/tsolodov))。
- 向 system.part_log 添加 `merge_algorithm` 列(Undecided、Horizontal、Vertical)。[#39181](https://github.com/ClickHouse/ClickHouse/pull/39181) ([Azat Khuzhin](https://github.com/azat))。
- 当磁盘不是旋转式时,不增加 `system.errors` 中的计数器。[#39216](https://github.com/ClickHouse/ClickHouse/pull/39216) ([Raúl Marín](https://github.com/Algunenano))。
- `system.query_log` 中 `INSERT` 查询的指标 `result_bytes` 显示插入的字节数。以前的值不正确,存储的值与 `result_rows` 相同。[#39225](https://github.com/ClickHouse/ClickHouse/pull/39225) ([Ilya Yatsishin](https://github.com/qoega))。
- clickhouse-client 中的 CPU 使用率指标将以更好的方式显示。修复 [#38756](https://github.com/ClickHouse/ClickHouse/issues/38756)。[#39280](https://github.com/ClickHouse/ClickHouse/pull/39280) ([Sergei Trifonov](https://github.com/serxa))。
- 在服务器启动时文件系统缓存初始化时重新抛出异常,提供更好的错误消息。[#39386](https://github.com/ClickHouse/ClickHouse/pull/39386) ([Kseniia Sumarokova](https://github.com/kssenii))。
- OpenTelemetry 现在默认收集不包含 Processors 跨度的跟踪(因为太多了)。要启用 Processors 跨度收集,请使用 `opentelemetry_trace_processors` 设置。[#39170](https://github.com/ClickHouse/ClickHouse/pull/39170) ([Ilya Yatsishin](https://github.com/qoega))。
- 函数 `multiMatch[Fuzzy](AllIndices/Any/AnyIndex)` - 如果 needle 参数为空,不抛出逻辑错误。[#39012](https://github.com/ClickHouse/ClickHouse/pull/39012) ([Robert Schulze](https://github.com/rschu1ze))。
- 允许声明不带默认参数 `x-max-length` 和 `x-overflow` 的 `RabbitMQ` 队列。[#39259](https://github.com/ClickHouse/ClickHouse/pull/39259) ([rnbondarenko](https://github.com/rnbondarenko))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-5}

- 为 ClickHouse 应用 Clang 线程安全分析 (TSA) 注解。[#38068](https://github.com/ClickHouse/ClickHouse/pull/38068) ([Robert Schulze](https://github.com/rschu1ze))。
- 适配 FreeBSD 通用安装脚本。[#39302](https://github.com/ClickHouse/ClickHouse/pull/39302) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 为 `s390x` 平台构建做准备。[#39193](https://github.com/ClickHouse/ClickHouse/pull/39193) ([Harry Lee](https://github.com/HarryLeeIBM))。
- 修复 `jemalloc` 库中的一个错误 [#38757](https://github.com/ClickHouse/ClickHouse/pull/38757) ([Azat Khuzhin](https://github.com/azat))。
- 硬件基准测试现已支持自动上传结果。[#38427](https://github.com/ClickHouse/ClickHouse/pull/38427) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 系统表 "system.licenses" 现在可以在 Mac (Darwin) 上正确填充。[#38294](https://github.com/ClickHouse/ClickHouse/pull/38294) ([Robert Schulze](https://github.com/rschu1ze))。
- 将 `all|noarch` 包更改为架构相关包 - 修复相关文档 - 将 aarch64|arm64 包推送到 artifactory 和发布资产 - 修复 [#36443](https://github.com/ClickHouse/ClickHouse/issues/36443)。[#38580](https://github.com/ClickHouse/ClickHouse/pull/38580) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。


#### 错误修复(官方稳定版或预稳定版中用户可见的异常行为) {#bug-fix-user-visible-misbehavior-in-official-stable-or-prestable-release-3}

- Fix rounding for `Decimal128/Decimal256` with more than 19-digits long scale. [#38027](https://github.com/ClickHouse/ClickHouse/pull/38027) ([Igor Nikonov](https://github.com/devcrafter)).
- Fixed crash caused by data race in storage `Hive` (integration table engine). [#38887](https://github.com/ClickHouse/ClickHouse/pull/38887) ([lgbo](https://github.com/lgbo-ustc)).
- Fix crash when executing GRANT ALL ON _._ with ON CLUSTER. It was broken in https://github.com/ClickHouse/ClickHouse/pull/35767. This closes [#38618](https://github.com/ClickHouse/ClickHouse/issues/38618). [#38674](https://github.com/ClickHouse/ClickHouse/pull/38674) ([Vitaly Baranov](https://github.com/vitlibar)).
- Correct glob expansion in case of `{0..10}` forms. Fixes [#38498](https://github.com/ClickHouse/ClickHouse/issues/38498) Current Implementation is similar to what shell does mentiond by @rschu1ze [here](https://github.com/ClickHouse/ClickHouse/pull/38502#issuecomment-1169057723). [#38502](https://github.com/ClickHouse/ClickHouse/pull/38502) ([Heena Bansal](https://github.com/HeenaBansal2009)).
- Fix crash for `mapUpdate`, `mapFilter` functions when using with constant map argument. Closes [#38547](https://github.com/ClickHouse/ClickHouse/issues/38547). [#38553](https://github.com/ClickHouse/ClickHouse/pull/38553) ([hexiaoting](https://github.com/hexiaoting)).
- Fix `toHour` monotonicity information for query optimization which can lead to incorrect query result (incorrect index analysis). This fixes [#38333](https://github.com/ClickHouse/ClickHouse/issues/38333). [#38675](https://github.com/ClickHouse/ClickHouse/pull/38675) ([Amos Bird](https://github.com/amosbird)).
- Fix checking whether s3 storage support parallel writes. It resulted in s3 parallel writes not working. [#38792](https://github.com/ClickHouse/ClickHouse/pull/38792) ([chen](https://github.com/xiedeyantu)).
- Fix s3 seekable reads with parallel read buffer. (Affected memory usage during query). Closes [#38258](https://github.com/ClickHouse/ClickHouse/issues/38258). [#38802](https://github.com/ClickHouse/ClickHouse/pull/38802) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Update `simdjson`. This fixes [#38621](https://github.com/ClickHouse/ClickHouse/issues/38621) - a buffer overflow on machines with the latest Intel CPUs with AVX-512 VBMI. [#38838](https://github.com/ClickHouse/ClickHouse/pull/38838) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix possible logical error for Vertical merges. [#38859](https://github.com/ClickHouse/ClickHouse/pull/38859) ([Maksim Kita](https://github.com/kitaisreal)).
- Fix settings profile with seconds unit. [#38896](https://github.com/ClickHouse/ClickHouse/pull/38896) ([Raúl Marín](https://github.com/Algunenano)).
- Fix incorrect partition pruning when there is a nullable partition key. Note: most likely you don't use nullable partition keys - this is an obscure feature you should not use. Nullable keys are a nonsense and this feature is only needed for some crazy use-cases. This fixes [#38941](https://github.com/ClickHouse/ClickHouse/issues/38941). [#38946](https://github.com/ClickHouse/ClickHouse/pull/38946) ([Amos Bird](https://github.com/amosbird)).
- Improve `fsync_part_directory` for fetches. [#38993](https://github.com/ClickHouse/ClickHouse/pull/38993) ([Azat Khuzhin](https://github.com/azat)).
- Fix possible dealock inside `OvercommitTracker`. Fixes [#37794](https://github.com/ClickHouse/ClickHouse/issues/37794). [#39030](https://github.com/ClickHouse/ClickHouse/pull/39030) ([Dmitry Novik](https://github.com/novikd)).
- Fix bug in filesystem cache that could happen in some corner case which coincided with cache capacity hitting the limit. Closes [#39066](https://github.com/ClickHouse/ClickHouse/issues/39066). [#39070](https://github.com/ClickHouse/ClickHouse/pull/39070) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix some corner cases of interpretation of the arguments of window expressions. Fixes [#38538](https://github.com/ClickHouse/ClickHouse/issues/38538) Allow using of higher-order functions in window expressions. [#39112](https://github.com/ClickHouse/ClickHouse/pull/39112) ([Dmitry Novik](https://github.com/novikd)).
- Keep `LowCardinality` type in `tuple` function. Previously `LowCardinality` type was dropped and elements of created tuple had underlying type of `LowCardinality`. [#39113](https://github.com/ClickHouse/ClickHouse/pull/39113) ([Anton Popov](https://github.com/CurtizJ)).
- Fix error `Block structure mismatch` which could happen for INSERT into table with attached MATERIALIZED VIEW and enabled setting `extremes = 1`. Closes [#29759](https://github.com/ClickHouse/ClickHouse/issues/29759) and [#38729](https://github.com/ClickHouse/ClickHouse/issues/38729). [#39125](https://github.com/ClickHouse/ClickHouse/pull/39125) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix unexpected query result when both `optimize_trivial_count_query` and `empty_result_for_aggregation_by_empty_set` are set to true. This fixes [#39140](https://github.com/ClickHouse/ClickHouse/issues/39140). [#39155](https://github.com/ClickHouse/ClickHouse/pull/39155) ([Amos Bird](https://github.com/amosbird)).
- Fixed error `Not found column Type in block` in selects with `PREWHERE` and read-in-order optimizations. [#39157](https://github.com/ClickHouse/ClickHouse/pull/39157) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix extremely rare race condition in during hardlinks for remote filesystem. The only way to reproduce it is concurrent run of backups. [#39190](https://github.com/ClickHouse/ClickHouse/pull/39190) ([alesapin](https://github.com/alesapin)).
- (zero-copy replication is an experimental feature that should not be used in production) Fix fetch of in-memory part with `allow_remote_fs_zero_copy_replication`. [#39214](https://github.com/ClickHouse/ClickHouse/pull/39214) ([Azat Khuzhin](https://github.com/azat)).
- (MaterializedPostgreSQL - experimental feature). Fix segmentation fault in MaterializedPostgreSQL database engine, which could happen if some exception occurred at replication initialisation. Closes [#36939](https://github.com/ClickHouse/ClickHouse/issues/36939). [#39272](https://github.com/ClickHouse/ClickHouse/pull/39272) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix incorrect fetch of table metadata from PostgreSQL database engine. Closes [#33502](https://github.com/ClickHouse/ClickHouse/issues/33502). [#39283](https://github.com/ClickHouse/ClickHouse/pull/39283) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix projection exception when aggregation keys are wrapped inside other functions. This fixes [#37151](https://github.com/ClickHouse/ClickHouse/issues/37151). [#37155](https://github.com/ClickHouse/ClickHouse/pull/37155) ([Amos Bird](https://github.com/amosbird)).
- Fix possible logical error `... with argument with type Nothing and default implementation for Nothing is expected to return result with type Nothing, got ...` in some functions. Closes: [#37610](https://github.com/ClickHouse/ClickHouse/issues/37610) Closes: [#37741](https://github.com/ClickHouse/ClickHouse/issues/37741). [#37759](https://github.com/ClickHouse/ClickHouse/pull/37759) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix incorrect columns order in subqueries of UNION (in case of duplicated columns in subselects may produce incorrect result). [#37887](https://github.com/ClickHouse/ClickHouse/pull/37887) ([Azat Khuzhin](https://github.com/azat)).
- Fix incorrect work of MODIFY ALTER Column with column names that contain dots. Closes [#37907](https://github.com/ClickHouse/ClickHouse/issues/37907). [#37971](https://github.com/ClickHouse/ClickHouse/pull/37971) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix reading of sparse columns from `MergeTree` tables that store their data in S3. [#37978](https://github.com/ClickHouse/ClickHouse/pull/37978) ([Anton Popov](https://github.com/CurtizJ)).
- Fix possible crash in `Distributed` async insert in case of removing a replica from config. [#38029](https://github.com/ClickHouse/ClickHouse/pull/38029) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix "Missing columns" for GLOBAL JOIN with CTE without alias. [#38056](https://github.com/ClickHouse/ClickHouse/pull/38056) ([Azat Khuzhin](https://github.com/azat)).
- Rewrite tuple functions as literals in backwards-compatibility mode. [#38096](https://github.com/ClickHouse/ClickHouse/pull/38096) ([Anton Kozlov](https://github.com/tonickkozlov)).
- Fix redundant memory reservation for output block during `ORDER BY`. [#38127](https://github.com/ClickHouse/ClickHouse/pull/38127) ([iyupeng](https://github.com/iyupeng)).
- Fix possible logical error `Bad cast from type DB::IColumn* to DB::ColumnNullable*` in array mapped functions. Closes [#38006](https://github.com/ClickHouse/ClickHouse/issues/38006). [#38132](https://github.com/ClickHouse/ClickHouse/pull/38132) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix temporary name clash in partial merge join, close [#37928](https://github.com/ClickHouse/ClickHouse/issues/37928). [#38135](https://github.com/ClickHouse/ClickHouse/pull/38135) ([Vladimir C](https://github.com/vdimir)).
- Some minr issue with queries like `CREATE TABLE nested_name_tuples (`a` Tuple(x String, y Tuple(i Int32, j String))) ENGINE = Memory;` [#38136](https://github.com/ClickHouse/ClickHouse/pull/38136) ([lgbo](https://github.com/lgbo-ustc)).
- Fix bug with nested short-circuit functions that led to execution of arguments even if condition is false. Closes [#38040](https://github.com/ClickHouse/ClickHouse/issues/38040). [#38173](https://github.com/ClickHouse/ClickHouse/pull/38173) ([Kruglov Pavel](https://github.com/Avogar)).
- (Window View is a experimental feature) Fix LOGICAL_ERROR for WINDOW VIEW with incorrect structure. [#38205](https://github.com/ClickHouse/ClickHouse/pull/38205) ([Azat Khuzhin](https://github.com/azat)).
- Update librdkafka submodule to fix crash when an OAUTHBEARER refresh callback is set. [#38225](https://github.com/ClickHouse/ClickHouse/pull/38225) ([Rafael Acevedo](https://github.com/racevedoo)).
- Fix INSERT into Distributed hung due to ProfileEvents. [#38307](https://github.com/ClickHouse/ClickHouse/pull/38307) ([Azat Khuzhin](https://github.com/azat)).
- Fix retries in PostgreSQL engine. [#38310](https://github.com/ClickHouse/ClickHouse/pull/38310) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix optimization in PartialSortingTransform (SIGSEGV and possible incorrect result). [#38324](https://github.com/ClickHouse/ClickHouse/pull/38324) ([Azat Khuzhin](https://github.com/azat)).
- Fix RabbitMQ with formats based on PeekableReadBuffer. Closes [#38061](https://github.com/ClickHouse/ClickHouse/issues/38061). [#38356](https://github.com/ClickHouse/ClickHouse/pull/38356) ([Kseniia Sumarokova](https://github.com/kssenii)).
- MaterializedPostgreSQL - experimentail feature. Fix possible `Invalid number of rows in Chunk` in MaterializedPostgreSQL. Closes [#37323](https://github.com/ClickHouse/ClickHouse/issues/37323). [#38360](https://github.com/ClickHouse/ClickHouse/pull/38360) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix RabbitMQ configuration with connection string setting. Closes [#36531](https://github.com/ClickHouse/ClickHouse/issues/36531). [#38365](https://github.com/ClickHouse/ClickHouse/pull/38365) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix PostgreSQL engine not using PostgreSQL schema when retrieving array dimension size. Closes [#36755](https://github.com/ClickHouse/ClickHouse/issues/36755). Closes [#36772](https://github.com/ClickHouse/ClickHouse/issues/36772). [#38366](https://github.com/ClickHouse/ClickHouse/pull/38366) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix possibly incorrect result of distributed queries with `DISTINCT` and `LIMIT`. Fixes [#38282](https://github.com/ClickHouse/ClickHouse/issues/38282). [#38371](https://github.com/ClickHouse/ClickHouse/pull/38371) ([Anton Popov](https://github.com/CurtizJ)).
- Fix wrong results of countSubstrings() & position() on patterns with 0-bytes. [#38589](https://github.com/ClickHouse/ClickHouse/pull/38589) ([Robert Schulze](https://github.com/rschu1ze)).
- Now it's possible to start a clickhouse-server and attach/detach tables even for tables with the incorrect values of IPv4/IPv6 representation. Proper fix for issue [#35156](https://github.com/ClickHouse/ClickHouse/issues/35156). [#38590](https://github.com/ClickHouse/ClickHouse/pull/38590) ([alesapin](https://github.com/alesapin)).
- `rankCorr` function will work correctly if some arguments are NaNs. This closes [#38396](https://github.com/ClickHouse/ClickHouse/issues/38396). [#38722](https://github.com/ClickHouse/ClickHouse/pull/38722) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix `parallel_view_processing=1` with `optimize_trivial_insert_select=1`. Fix `max_insert_threads` while pushing to views. [#38731](https://github.com/ClickHouse/ClickHouse/pull/38731) ([Azat Khuzhin](https://github.com/azat)).
- Fix use-after-free for aggregate functions with `Map` combinator that leads to incorrect result. [#38748](https://github.com/ClickHouse/ClickHouse/pull/38748) ([Azat Khuzhin](https://github.com/azat)).

### <a id="226"></a> ClickHouse 版本 22.6, 2022-06-16 {#a-id226a-clickhouse-release-226-2022-06-16}

#### 向后不兼容的变更 {#backward-incompatible-change-4}

- 移除对 SQL 中八进制数字字面量的支持。在之前的版本中,它们被解析为 Float64 类型。[#37765](https://github.com/ClickHouse/ClickHouse/pull/37765) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
- 更改了使用 `seconds` 作为类型的设置的解析方式,以支持浮点数值(例如:`max_execution_time=0.5`)。无穷大或 NaN 值将抛出异常。[#37187](https://github.com/ClickHouse/ClickHouse/pull/37187) ([Raúl Marín](https://github.com/Algunenano))。
- 更改了实验性类型 `Object` 列的二进制序列化格式。新格式更便于第三方客户端实现。[#37482](https://github.com/ClickHouse/ClickHouse/pull/37482) ([Anton Popov](https://github.com/CurtizJ))。
- 默认启用设置 `output_format_json_named_tuples_as_objects`。该设置允许在 JSON 格式中将命名元组序列化为 JSON 对象。[#37756](https://github.com/ClickHouse/ClickHouse/pull/37756) ([Anton Popov](https://github.com/CurtizJ))。
- 现在不允许使用带有尾随转义符号('\\')的 LIKE 模式(按照 SQL 标准的要求)。[#37764](https://github.com/ClickHouse/ClickHouse/pull/37764) ([Robert Schulze](https://github.com/rschu1ze))。
- 如果您在使用 AArch64 CPU 的集群上运行不同版本的 ClickHouse,或在集群上混合使用 AArch64 和 amd64,并且使用带有 GROUP BY 多个固定大小类型键(适合 256 位但不适合 64 位)的分布式查询,且结果集非常大,则在升级期间这些查询的结果中数据将不会完全聚合。解决方法:使用停机升级而不是滚动升级。


#### 新功能 {#new-feature-6}

- 新增 `GROUPING` 函数。该函数用于在使用 `ROLLUP`、`CUBE` 或 `GROUPING SETS` 的查询中消除记录的歧义。关闭 [#19426](https://github.com/ClickHouse/ClickHouse/issues/19426)。[#37163](https://github.com/ClickHouse/ClickHouse/pull/37163) ([Dmitry Novik](https://github.com/novikd))。
- 新增用于浮点数据压缩的 [FPC](https://userweb.cs.txstate.edu/~burtscher/papers/dcc07a.pdf) 编解码器算法。[#37553](https://github.com/ClickHouse/ClickHouse/pull/37553) ([Mikhail Guzov](https://github.com/koloshmet))。
- 新增列式 JSON 格式:`JSONColumns`、`JSONCompactColumns`、`JSONColumnsWithMetadata`。关闭 [#36338](https://github.com/ClickHouse/ClickHouse/issues/36338) 关闭 [#34509](https://github.com/ClickHouse/ClickHouse/issues/34509)。[#36975](https://github.com/ClickHouse/ClickHouse/pull/36975) ([Kruglov Pavel](https://github.com/Avogar))。
- 新增基于 d3js 的 OpenTelemetry 追踪可视化工具。[#37810](https://github.com/ClickHouse/ClickHouse/pull/37810) ([Sergei Trifonov](https://github.com/serxa))。
- 支持向 `system.zookeeper` 表执行 INSERT 操作。关闭 [#22130](https://github.com/ClickHouse/ClickHouse/issues/22130)。[#37596](https://github.com/ClickHouse/ClickHouse/pull/37596) ([Han Fei](https://github.com/hanfei1991))。
- 支持 `LIKE`、`ILIKE` 和 `match` 函数使用非常量模式参数。[#37251](https://github.com/ClickHouse/ClickHouse/pull/37251) ([Robert Schulze](https://github.com/rschu1ze))。
- 可执行用户自定义函数现已支持参数。示例:`SELECT test_function(parameters)(arguments)`。关闭 [#37578](https://github.com/ClickHouse/ClickHouse/issues/37578)。[#37720](https://github.com/ClickHouse/ClickHouse/pull/37720) ([Maksim Kita](https://github.com/kitaisreal))。
- 在 system.part_log 表中新增 `merge_reason` 列。[#36912](https://github.com/ClickHouse/ClickHouse/pull/36912) ([Sema Checherinda](https://github.com/CheSema))。
- 新增对 Avro 格式中 Maps 和 Records 的支持。新增设置 `input_format_avro_null_as_default`,允许在 Avro 格式中将 null 作为默认值插入。关闭 [#18925](https://github.com/ClickHouse/ClickHouse/issues/18925) 关闭 [#37378](https://github.com/ClickHouse/ClickHouse/issues/37378) 关闭 [#32899](https://github.com/ClickHouse/ClickHouse/issues/32899)。[#37525](https://github.com/ClickHouse/ClickHouse/pull/37525) ([Kruglov Pavel](https://github.com/Avogar))。
- 新增 `clickhouse-disks` 工具,用于检查和操作为 ClickHouse 配置的虚拟文件系统。[#36060](https://github.com/ClickHouse/ClickHouse/pull/36060) ([Artyom Yurkov](https://github.com/Varinara))。
- 新增 H3 单向边函数。[#36843](https://github.com/ClickHouse/ClickHouse/pull/36843) ([Bharat Nallan](https://github.com/bharatnc))。
- 新增从无符号整数计算 [hashids](https://hashids.org/) 的支持。[#37013](https://github.com/ClickHouse/ClickHouse/pull/37013) ([Michael Nutt](https://github.com/mnutt))。
- 允许在 `CREATE USER <user> IDENTIFIED WITH sha256_hash` 中显式指定 `SALT`。[#37377](https://github.com/ClickHouse/ClickHouse/pull/37377) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
- 新增两个设置 `input_format_csv_skip_first_lines/input_format_tsv_skip_first_lines`,允许在 CSV/TSV 格式中跳过文件开头指定数量的行。[#37537](https://github.com/ClickHouse/ClickHouse/pull/37537) ([Kruglov Pavel](https://github.com/Avogar))。
- `showCertificate` 函数用于显示当前服务器的 SSL 证书。[#37540](https://github.com/ClickHouse/ClickHouse/pull/37540) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
- 支持在命名集合中使用 HTTP 源作为数据字典的数据源。[#37581](https://github.com/ClickHouse/ClickHouse/pull/37581) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
- 新增窗口函数 `nonNegativeDerivative(metric_column, timestamp_column[, INTERVAL x SECOND])`。[#37628](https://github.com/ClickHouse/ClickHouse/pull/37628) ([Andrey Zvonov](https://github.com/zvonand))。
- 实现了修改 `ReplicatedMergeTree` 表注释的功能。[#37416](https://github.com/ClickHouse/ClickHouse/pull/37416) ([Vasily Nemkov](https://github.com/Enmk))。
- 新增 `SYSTEM UNFREEZE` 查询,无论对应的表是否已删除,都会删除整个备份。[#36424](https://github.com/ClickHouse/ClickHouse/pull/36424) ([Vadim Volodin](https://github.com/PolyProgrammist))。

#### 实验性功能 {#experimental-feature-5}

- 为 `WINDOW VIEW` 启用 `POPULATE` 功能。[#36945](https://github.com/ClickHouse/ClickHouse/pull/36945) ([vxider](https://github.com/Vxider))。
- 为 `WINDOW VIEW` 添加 `ALTER TABLE ... MODIFY QUERY` 支持。[#37188](https://github.com/ClickHouse/ClickHouse/pull/37188) ([vxider](https://github.com/Vxider))。
- 此 PR 修改了 `WINDOW VIEW` 中 `ENGINE` 语法的行为,使其与 `MATERIALIZED VIEW` 保持一致。[#37214](https://github.com/ClickHouse/ClickHouse/pull/37214) ([vxider](https://github.com/Vxider))。


#### 性能改进 {#performance-improvement-6}

- 为 ARM NEON 添加了大量优化 [#38093](https://github.com/ClickHouse/ClickHouse/pull/38093)([Daniel Kutenin](https://github.com/danlark1)), ([Alexandra Pilipyuk](https://github.com/chalice19)) 注意:如果您在配备 ARM CPU 的集群上运行不同版本的 ClickHouse,并使用带有 GROUP BY 多个固定大小类型键(适合 256 位但不适合 64 位)的分布式查询,则在升级期间聚合查询的结果将出现错误。解决方法:使用停机升级而非滚动升级。
- 改进了 Native、Protobuf、CapnProto、JSONEachRow、TSKV 以及所有带有 WithNames/WithNamesAndTypes 后缀的格式在选择列子集时的性能和内存使用。以前,从这些格式的文件中仅选择列子集时,所有列都会被读取并存储在内存中。现在只读取所需的列。此 PR 默认启用了 `input_format_skip_unknown_fields` 设置,否则在选择列子集的情况下会抛出异常。[#37192](https://github.com/ClickHouse/ClickHouse/pull/37192) ([Kruglov Pavel](https://github.com/Avogar))。
- 现在可以为 join 下推更多过滤器。[#37472](https://github.com/ClickHouse/ClickHouse/pull/37472) ([Amos Bird](https://github.com/amosbird))。
- 读取宽数据部分时仅加载必要列的标记。[#36879](https://github.com/ClickHouse/ClickHouse/pull/36879) ([Anton Kozlov](https://github.com/tonickkozlov))。
- 改进了当稀疏列(可通过 `MergeTree` 表中的实验性设置 `ratio_of_defaults_for_sparse_serialization` 启用)用作聚合函数参数时的聚合性能。[#37617](https://github.com/ClickHouse/ClickHouse/pull/37617) ([Anton Popov](https://github.com/CurtizJ))。
- 优化了带有两个参数的 `COALESCE` 函数。[#37666](https://github.com/ClickHouse/ClickHouse/pull/37666) ([Anton Popov](https://github.com/CurtizJ))。
- 当 `multiIf` 只有一个条件时,将其替换为 `if`,因为 `if` 函数性能更好。[#37695](https://github.com/ClickHouse/ClickHouse/pull/37695) ([Anton Popov](https://github.com/CurtizJ))。
- 改进了 `dictGetDescendants`、`dictGetChildren` 函数的性能,每个查询创建一次临时的父到子层次索引,而不是在查询期间每次函数调用时创建。允许为 `HIERARHICAL` 属性指定 `BIDIRECTIONAL`,字典将在内存中维护父到子索引,这样 `dictGetDescendants`、`dictGetChildren` 函数就不会在每个查询中创建临时索引。关闭 [#32481](https://github.com/ClickHouse/ClickHouse/issues/32481)。[#37148](https://github.com/ClickHouse/ClickHouse/pull/37148) ([Maksim Kita](https://github.com/kitaisreal))。
- 聚合状态销毁现在可以提交到线程池。对于带有 LIMIT 和大状态的查询,这提供了显著的加速,例如 `select uniq(number) from numbers_mt(1e7) group by number limit 100` 速度提高了约 2.5 倍。[#37855](https://github.com/ClickHouse/ClickHouse/pull/37855) ([Nikita Taranov](https://github.com/nickitat))。
- 改进了单列排序性能。[#37195](https://github.com/ClickHouse/ClickHouse/pull/37195) ([Maksim Kita](https://github.com/kitaisreal))。
- 使用排序队列特化改进了单列排序的性能。[#37990](https://github.com/ClickHouse/ClickHouse/pull/37990) ([Maksim Kita](https://github.com/kitaisreal))。
- 将数组范数和距离函数的性能提高了 2 到 4 倍。[#37394](https://github.com/ClickHouse/ClickHouse/pull/37394) ([Alexander Gololobov](https://github.com/davenger))。
- 使用动态分派改进了数字比较函数的性能。[#37399](https://github.com/ClickHouse/ClickHouse/pull/37399) ([Maksim Kita](https://github.com/kitaisreal))。
- 改进了带有 LIMIT 的 ORDER BY 的性能。[#37481](https://github.com/ClickHouse/ClickHouse/pull/37481) ([Maksim Kita](https://github.com/kitaisreal))。
- 使用动态分派基础设施改进了 `hasAll` 函数的性能。[#37484](https://github.com/ClickHouse/ClickHouse/pull/37484) ([Maksim Kita](https://github.com/kitaisreal))。
- 改进了 `greatCircleAngle`、`greatCircleDistance`、`geoDistance` 函数的性能。[#37524](https://github.com/ClickHouse/ClickHouse/pull/37524) ([Maksim Kita](https://github.com/kitaisreal))。
- 改进了当 ORDER BY 中有多列时插入 MergeTree 的性能。[#35762](https://github.com/ClickHouse/ClickHouse/pull/35762) ([Maksim Kita](https://github.com/kitaisreal))。
- 修复了当有大量表时后台 CPU 使用过多的问题。[#38028](https://github.com/ClickHouse/ClickHouse/pull/38028) ([Maksim Kita](https://github.com/kitaisreal))。
- 使用动态分派改进了 `not` 函数的性能。[#38058](https://github.com/ClickHouse/ClickHouse/pull/38058) ([Maksim Kita](https://github.com/kitaisreal))。
- 优化了 re2 模式的内部缓存,例如在 LIKE 和 MATCH 函数中使用的模式。[#37544](https://github.com/ClickHouse/ClickHouse/pull/37544) ([Robert Schulze](https://github.com/rschu1ze))。
- 使用 AVX-512 指令改进了过滤器位掩码生成器函数的一体化实现。[#37588](https://github.com/ClickHouse/ClickHouse/pull/37588) ([yaqi-zhao](https://github.com/yaqi-zhao))。
- 为 Hive 集成引擎应用 `threadpool` 读取方法。这将显著加快读取速度。[#36328](https://github.com/ClickHouse/ClickHouse/pull/36328) ([李扬](https://github.com/taiyang-li))。
- 当所有要读取的列都是分区键时,通过文件的行号构造列,而无需实际读取 Hive 文件。[#37103](https://github.com/ClickHouse/ClickHouse/pull/37103) ([lgbo](https://github.com/lgbo-ustc))。
- 支持使用多个磁盘缓存 Hive 文件。[#37279](https://github.com/ClickHouse/ClickHouse/pull/37279) ([lgbo](https://github.com/lgbo-ustc))。
- 限制每个查询的最大缓存使用量可以有效防止缓存池污染。[相关问题](https://github.com/ClickHouse/ClickHouse/issues/28961)。[#37859](https://github.com/ClickHouse/ClickHouse/pull/37859) ([Han Shukai](https://github.com/KinderRiven))。
- 目前 ClickHouse 直接将所有远程文件下载到本地缓存(即使它们只被读取一次),这会频繁导致本地硬盘的 IO。在某些场景中,这些 IO 可能是不必要的,并且可能容易导致负优化。如下图所示,当我们运行 SSB Q1-Q4 时,缓存的性能导致了负优化。[#37516](https://github.com/ClickHouse/ClickHouse/pull/37516) ([Han Shukai](https://github.com/KinderRiven))。
- 允许在从 S3 读取时通过虚拟列(如 `_file` 和 `_path`)修剪文件列表。这是为了 [#37174](https://github.com/ClickHouse/ClickHouse/issues/37174)、[#23494](https://github.com/ClickHouse/ClickHouse/issues/23494)。[#37356](https://github.com/ClickHouse/ClickHouse/pull/37356) ([Amos Bird](https://github.com/amosbird))。
- 在函数 CompressedWriteBuffer::nextImpl() 中,存在一个不必要的写入-复制步骤,该步骤在插入数据期间会频繁发生。以下显示了此补丁的区别:- 之前:1. 将 "working_buffer" 压缩到 "compressed_buffer" 2. 写入-复制到 "out" - 之后:直接将 "working_buffer" 压缩到 "out"。[#37242](https://github.com/ClickHouse/ClickHouse/pull/37242) ([jasperzhu](https://github.com/jinjunzh))。





#### 改进 {#improvement-6}

- Support types with non-standard defaults in ROLLUP, CUBE, GROUPING SETS. Closes [#37360](https://github.com/ClickHouse/ClickHouse/issues/37360). [#37667](https://github.com/ClickHouse/ClickHouse/pull/37667) ([Dmitry Novik](https://github.com/novikd)).
- Fix stack traces collection on ARM. Closes [#37044](https://github.com/ClickHouse/ClickHouse/issues/37044). Closes [#15638](https://github.com/ClickHouse/ClickHouse/issues/15638). [#37797](https://github.com/ClickHouse/ClickHouse/pull/37797) ([Maksim Kita](https://github.com/kitaisreal)).
- Client will try every IP address returned by DNS resolution until successful connection. [#37273](https://github.com/ClickHouse/ClickHouse/pull/37273) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Allow to use String type instead of Binary in Arrow/Parquet/ORC formats. This PR introduces 3 new settings for it: `output_format_arrow_string_as_string`, `output_format_parquet_string_as_string`, `output_format_orc_string_as_string`. Default value for all settings is `false`. [#37327](https://github.com/ClickHouse/ClickHouse/pull/37327) ([Kruglov Pavel](https://github.com/Avogar)).
- Apply setting `input_format_max_rows_to_read_for_schema_inference` for all read rows in total from all files in globs. Previously setting `input_format_max_rows_to_read_for_schema_inference` was applied for each file in glob separately and in case of huge number of nulls we could read first `input_format_max_rows_to_read_for_schema_inference` rows from each file and get nothing. Also increase default value for this setting to 25000. [#37332](https://github.com/ClickHouse/ClickHouse/pull/37332) ([Kruglov Pavel](https://github.com/Avogar)).
- Add separate `CLUSTER` grant (and `access_control_improvements.on_cluster_queries_require_cluster_grant` configuration directive, for backward compatibility, default to `false`). [#35767](https://github.com/ClickHouse/ClickHouse/pull/35767) ([Azat Khuzhin](https://github.com/azat)).
- Added support for schema inference for `hdfsCluster`. [#35812](https://github.com/ClickHouse/ClickHouse/pull/35812) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Implement `least_used` load balancing algorithm for disks inside volume (multi disk configuration). [#36686](https://github.com/ClickHouse/ClickHouse/pull/36686) ([Azat Khuzhin](https://github.com/azat)).
- Modify the HTTP Endpoint to return the full stats under the `X-ClickHouse-Summary` header when `send_progress_in_http_headers=0` (before it would return all zeros). - Modify the HTTP Endpoint to return `X-ClickHouse-Exception-Code` header when progress has been sent before (`send_progress_in_http_headers=1`) - Modify the HTTP Endpoint to return `HTTP_REQUEST_TIMEOUT` (408) instead of `HTTP_INTERNAL_SERVER_ERROR` (500) on `TIMEOUT_EXCEEDED` errors. [#36884](https://github.com/ClickHouse/ClickHouse/pull/36884) ([Raúl Marín](https://github.com/Algunenano)).
- Allow a user to inspect grants from granted roles. [#36941](https://github.com/ClickHouse/ClickHouse/pull/36941) ([nvartolomei](https://github.com/nvartolomei)).
- Do not calculate an integral numerically but use CDF functions instead. This will speed up execution and will increase the precision. This fixes [#36714](https://github.com/ClickHouse/ClickHouse/issues/36714). [#36953](https://github.com/ClickHouse/ClickHouse/pull/36953) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Add default implementation for Nothing in functions. Now most of the functions will return column with type Nothing in case one of it's arguments is Nothing. It also solves problem with functions like arrayMap/arrayFilter and similar when they have empty array as an argument. Previously queries like `select arrayMap(x -> 2 * x, []);` failed because function inside lambda cannot work with type `Nothing`, now such queries return empty array with type `Array(Nothing)`. Also add support for arrays of nullable types in functions like arrayFilter/arrayFill. Previously, queries like `select arrayFilter(x -> x % 2, [1, NULL])` failed, now they work (if the result of lambda is NULL, then this value won't be included in the result). Closes [#37000](https://github.com/ClickHouse/ClickHouse/issues/37000). [#37048](https://github.com/ClickHouse/ClickHouse/pull/37048) ([Kruglov Pavel](https://github.com/Avogar)).
- Now if a shard has local replica we create a local plan and a plan to read from all remote replicas. They have shared initiator which coordinates reading. [#37204](https://github.com/ClickHouse/ClickHouse/pull/37204) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Do no longer abort server startup if configuration option "mark_cache_size" is not explicitly set. [#37326](https://github.com/ClickHouse/ClickHouse/pull/37326) ([Robert Schulze](https://github.com/rschu1ze)).
- Allows providing `NULL`/`NOT NULL` right after type in column declaration. [#37337](https://github.com/ClickHouse/ClickHouse/pull/37337) ([Igor Nikonov](https://github.com/devcrafter)).
- optimize file segment PARTIALLY_DOWNLOADED get read buffer. [#37338](https://github.com/ClickHouse/ClickHouse/pull/37338) ([xiedeyantu](https://github.com/xiedeyantu)).
- Try to improve short circuit functions processing to fix problems with stress tests. [#37384](https://github.com/ClickHouse/ClickHouse/pull/37384) ([Kruglov Pavel](https://github.com/Avogar)).
- Closes [#37395](https://github.com/ClickHouse/ClickHouse/issues/37395). [#37415](https://github.com/ClickHouse/ClickHouse/pull/37415) ([Memo](https://github.com/Joeywzr)).
- Fix extremely rare deadlock during part fetch in zero-copy replication. Fixes [#37423](https://github.com/ClickHouse/ClickHouse/issues/37423). [#37424](https://github.com/ClickHouse/ClickHouse/pull/37424) ([metahys](https://github.com/metahys)).
- Don't allow to create storage with unknown data format. [#37450](https://github.com/ClickHouse/ClickHouse/pull/37450) ([Kruglov Pavel](https://github.com/Avogar)).
- Set `global_memory_usage_overcommit_max_wait_microseconds` default value to 5 seconds. Add info about `OvercommitTracker` to OOM exception message. Add `MemoryOvercommitWaitTimeMicroseconds` profile event. [#37460](https://github.com/ClickHouse/ClickHouse/pull/37460) ([Dmitry Novik](https://github.com/novikd)).
- Do not display `-0.0` CPU time in clickhouse-client. It can appear due to rounding errors. This closes [#38003](https://github.com/ClickHouse/ClickHouse/issues/38003). This closes [#38038](https://github.com/ClickHouse/ClickHouse/issues/38038). [#38064](https://github.com/ClickHouse/ClickHouse/pull/38064) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Play UI: Keep controls in place when the page is scrolled horizontally. This makes edits comfortable even if the table is wide and it was scrolled far to the right. The feature proposed by Maksym Tereshchenko from CaspianDB. [#37470](https://github.com/ClickHouse/ClickHouse/pull/37470) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Modify query div in play.html to be extendable beyond 20% height. In case of very long queries it is helpful to extend the textarea element, only today, since the div is fixed height, the extended textarea hides the data div underneath. With this fix, extending the textarea element will push the data div down/up such the extended textarea won't hide it. Also, keeps query box width 100% even when the user adjusting the size of the query textarea. [#37488](https://github.com/ClickHouse/ClickHouse/pull/37488) ([guyco87](https://github.com/guyco87)).
- Added `ProfileEvents` for introspection of type of written (inserted or merged) parts (`Inserted{Wide/Compact/InMemory}Parts`, `MergedInto{Wide/Compact/InMemory}Parts`. Added column `part_type` to `system.part_log`. Resolves [#37495](https://github.com/ClickHouse/ClickHouse/issues/37495). [#37536](https://github.com/ClickHouse/ClickHouse/pull/37536) ([Anton Popov](https://github.com/CurtizJ)).
- clickhouse-keeper improvement: move broken logs to a timestamped folder. [#37565](https://github.com/ClickHouse/ClickHouse/pull/37565) ([Antonio Andelic](https://github.com/antonio2368)).
- Do not write expired columns by TTL after subsequent merges (before only first merge/optimize of the part will not write expired by TTL columns, all other will do). [#37570](https://github.com/ClickHouse/ClickHouse/pull/37570) ([Azat Khuzhin](https://github.com/azat)).
- More precise result of the `dumpColumnStructure` miscellaneous function in presence of LowCardinality or Sparse columns. In previous versions, these functions were converting the argument to a full column before returning the result. This is needed to provide an answer in [#6935](https://github.com/ClickHouse/ClickHouse/issues/6935). [#37633](https://github.com/ClickHouse/ClickHouse/pull/37633) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- clickhouse-keeper: store only unique session IDs for watches. [#37641](https://github.com/ClickHouse/ClickHouse/pull/37641) ([Azat Khuzhin](https://github.com/azat)).
- Fix possible "Cannot write to finalized buffer". [#37645](https://github.com/ClickHouse/ClickHouse/pull/37645) ([Azat Khuzhin](https://github.com/azat)).
- Add setting `support_batch_delete` for `DiskS3` to disable multiobject delete calls, which Google Cloud Storage doesn't support. [#37659](https://github.com/ClickHouse/ClickHouse/pull/37659) ([Fred Wulff](https://github.com/frew)).
- Add an option to disable connection pooling in ODBC bridge. [#37705](https://github.com/ClickHouse/ClickHouse/pull/37705) ([Anton Kozlov](https://github.com/tonickkozlov)).
- Functions `dictGetHierarchy`, `dictIsIn`, `dictGetChildren`, `dictGetDescendants` added support nullable `HIERARCHICAL` attribute in dictionaries. Closes [#35521](https://github.com/ClickHouse/ClickHouse/issues/35521). [#37805](https://github.com/ClickHouse/ClickHouse/pull/37805) ([Maksim Kita](https://github.com/kitaisreal)).
- Expose BoringSSL version related info in the `system.build_options` table. [#37850](https://github.com/ClickHouse/ClickHouse/pull/37850) ([Bharat Nallan](https://github.com/bharatnc)).
- Now clickhouse-server removes `delete_tmp` directories on server start. Fixes [#26503](https://github.com/ClickHouse/ClickHouse/issues/26503). [#37906](https://github.com/ClickHouse/ClickHouse/pull/37906) ([alesapin](https://github.com/alesapin)).
- Clean up broken detached parts after timeout. Closes [#25195](https://github.com/ClickHouse/ClickHouse/issues/25195). [#37975](https://github.com/ClickHouse/ClickHouse/pull/37975) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Now in MergeTree table engines family failed-to-move parts will be removed instantly. [#37994](https://github.com/ClickHouse/ClickHouse/pull/37994) ([alesapin](https://github.com/alesapin)).
- Now if setting `always_fetch_merged_part` is enabled for ReplicatedMergeTree merges will try to find parts on other replicas rarely with smaller load for [Zoo]Keeper. [#37995](https://github.com/ClickHouse/ClickHouse/pull/37995) ([alesapin](https://github.com/alesapin)).
- Add implicit grants with grant option too. For example `GRANT CREATE TABLE ON test.* TO A WITH GRANT OPTION` now allows `A` to execute `GRANT CREATE VIEW ON test.* TO B`. [#38017](https://github.com/ClickHouse/ClickHouse/pull/38017) ([Vitaly Baranov](https://github.com/vitlibar)).

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-6}

- 使用 `clang-14` 和 LLVM 基础设施版本 14 进行构建。此更改关闭了 [#34681](https://github.com/ClickHouse/ClickHouse/issues/34681)。[#34754](https://github.com/ClickHouse/ClickHouse/pull/34754) ([Alexey Milovidov](https://github.com/alexey-milovidov))。注意：`clang-14` 的 ThreadSanitizer 存在[一个缺陷](https://github.com/google/sanitizers/issues/1540)，导致我们的 CI 运行效果变差。
- 允许在启动时降低权限。这简化了 Docker 镜像。关闭了 [#36293](https://github.com/ClickHouse/ClickHouse/issues/36293)。[#36341](https://github.com/ClickHouse/ClickHouse/pull/36341) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 在 CI 中添加文档拼写检查。[#37790](https://github.com/ClickHouse/ClickHouse/pull/37790) ([Vladimir C](https://github.com/vdimir))。
- 修复过度激进的剥离操作，该操作移除了用于检查可执行文件一致性所需的嵌入式哈希值。[#37993](https://github.com/ClickHouse/ClickHouse/pull/37993) ([Robert Schulze](https://github.com/rschu1ze))。

#### 错误修复 {#bug-fix-2}


* 修复在常量字符串类型上使用的 `SELECT ... INTERSECT` 和 `EXCEPT SELECT` 语句。[#37738](https://github.com/ClickHouse/ClickHouse/pull/37738)（[Antonio Andelic](https://github.com/antonio2368)）。
* 修复对 `AggregateFunction` 类型列进行 `GROUP BY` 的处理（即按具有 `AggregateFunction` 类型的列进行分组）。 [#37093](https://github.com/ClickHouse/ClickHouse/pull/37093) ([Azat Khuzhin](https://github.com/azat)).
* （实验性 WINDOW VIEW）修复 WindowView 中的 `addDependency`。该缺陷可以按 [#37237](https://github.com/ClickHouse/ClickHouse/issues/37237) 所示复现。[#37224](https://github.com/ClickHouse/ClickHouse/pull/37224)（[vxider](https://github.com/Vxider)）。
* 修复 `ORDER BY ... WITH FILL` 功能中的不一致问题。包含 `ORDER BY ... WITH FILL` 的查询在存在多个 `WITH FILL` 列时可能会生成多余的行。[#38074](https://github.com/ClickHouse/ClickHouse/pull/38074)（[Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)）。
* 此 PR 将 `addDependency` 从构造函数移动到 `startup()`，以避免向*已删除*的表添加依赖，从而修复 [#37237](https://github.com/ClickHouse/ClickHouse/issues/37237)。[#37243](https://github.com/ClickHouse/ClickHouse/pull/37243)（[vxider](https://github.com/Vxider)）。
* 修复在列式格式中为缺失值插入默认值的行为。此前，缺失列被填充的是数据类型的默认值，而非该列自身的默认值。[#37253](https://github.com/ClickHouse/ClickHouse/pull/37253) ([Kruglov Pavel](https://github.com/Avogar))。
* （实验性 `Object` 类型）修复了在向 `Object` 类型列插入嵌套数组时出现的某些问题。[#37305](https://github.com/ClickHouse/ClickHouse/pull/37305)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复在聚合函数、`prewhere` 和 `join` 中因常量字符串冲突引发的意外错误。关闭 [#36891](https://github.com/ClickHouse/ClickHouse/issues/36891)。[#37336](https://github.com/ClickHouse/ClickHouse/pull/37336)（[Vladimir C](https://github.com/vdimir)）。
* 修复在查询中使用 GROUP/ORDER BY 时的 projection，以及 `optimize_aggregation_in_order`（之前结果不正确，因为只执行了最终排序）。 [#37342](https://github.com/ClickHouse/ClickHouse/pull/37342) ([Azat Khuzhin](https://github.com/azat)).
* 修复了 S3 中键名包含特殊符号时的错误。修复了 [#33009](https://github.com/ClickHouse/ClickHouse/issues/33009)。[#37344](https://github.com/ClickHouse/ClickHouse/pull/37344)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* 当 `GROUPING SETS` 与 `ROLLUP` 或 `CUBE` 一起使用时，抛出异常。[#37367](https://github.com/ClickHouse/ClickHouse/pull/37367)（[Dmitry Novik](https://github.com/novikd)）。
* 修复在合并期间 `getMaxSourcePartsSizeForMerge` 中出现的 LOGICAL&#95;ERROR（当在 `config.xml`（新的配置方式）中指定了非常规且更大的 `background_pool_size`/`background_merges_mutations_concurrency_ratio` 值，而不是在已弃用的 `users.xml`（旧的配置方式）中指定时会触发）。[#37413](https://github.com/ClickHouse/ClickHouse/pull/37413)（[Azat Khuzhin](https://github.com/azat)）。
* 不再在 RowBinary 格式中移除 UTF-8 BOM。[#37428](https://github.com/ClickHouse/ClickHouse/pull/37428) ([Paul Loyd](https://github.com/loyd)). [#37428](https://github.com/ClickHouse/ClickHouse/pull/37428) ([Paul Loyd](https://github.com/loyd)).
* clickhouse-keeper 错误修复：修复单节点集群的强制恢复。 [#37440](https://github.com/ClickHouse/ClickHouse/pull/37440) ([Antonio Andelic](https://github.com/antonio2368)).
* 修复 `normalizeUTF8` 函数中的逻辑错误。关闭 [#37298](https://github.com/ClickHouse/ClickHouse/issues/37298)。[#37443](https://github.com/ClickHouse/ClickHouse/pull/37443)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复 `JoinSwitcher` 中可为空类型的 `LowCardinality` 类型转换问题，关闭 [#37385](https://github.com/ClickHouse/ClickHouse/issues/37385)。[#37453](https://github.com/ClickHouse/ClickHouse/pull/37453)（[Vladimir C](https://github.com/vdimir)）。
* 修复 ORC/Arrow/Parquet 格式中具名元组的输出。[#37458](https://github.com/ClickHouse/ClickHouse/pull/37458) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复在存在 `GROUPING SETS` 时，对 `ORDER BY` 子句中单调函数的优化问题。修复了 [#37401](https://github.com/ClickHouse/ClickHouse/issues/37401)。[#37493](https://github.com/ClickHouse/ClickHouse/pull/37493)（[Dmitry Novik](https://github.com/novikd)）。
* 修复在某些条件下与字典进行 `JOIN` 时出现的错误。修复内容见 [#37386](https://github.com/ClickHouse/ClickHouse/issues/37386)。[#37530](https://github.com/ClickHouse/ClickHouse/pull/37530)（[Vladimir C](https://github.com/vdimir)）。
* 禁止将 `optimize_aggregation_in_order` 与 `GROUPING SETS` 一起使用（修复 `LOGICAL_ERROR`）。 [#37542](https://github.com/ClickHouse/ClickHouse/pull/37542) ([Azat Khuzhin](https://github.com/azat)).
* 修复 ActionsDAG 错误的导出信息。[#37587](https://github.com/ClickHouse/ClickHouse/pull/37587) ([zhanglistar](https://github.com/zhanglistar))。
* 修复 `UNION` 查询中的类型转换问题（可能会导致 `LOGICAL_ERROR`）。[#37593](https://github.com/ClickHouse/ClickHouse/pull/37593) ([Azat Khuzhin](https://github.com/azat))。
* 修复在 `STEP` 子句中使用负间隔时的 `WITH FILL` 修饰符。[#37600](https://github.com/ClickHouse/ClickHouse/pull/37600) 修复了 [#37514](https://github.com/ClickHouse/ClickHouse/issues/37514)（[Anton Popov](https://github.com/CurtizJ)）。
* 在 `join_use_nulls = 1` 时修复了非法的 `joinGet` 数组用法。这修复了 [#37562](https://github.com/ClickHouse/ClickHouse/issues/37562)。[#37650](https://github.com/ClickHouse/ClickHouse/pull/37650)（[Amos Bird](https://github.com/amosbird)）。
* 修复 `CROSS JOIN` 中列数不匹配的问题，关闭 [#37561](https://github.com/ClickHouse/ClickHouse/issues/37561)。[#37653](https://github.com/ClickHouse/ClickHouse/pull/37653)（[Vladimir C](https://github.com/vdimir)）。
* 修复在配置了命名集合（named collections）的 MySQL 数据库中执行 `SHOW CREATE TABLE` 时出现的段错误。修复 [#37683](https://github.com/ClickHouse/ClickHouse/issues/37683)。[#37690](https://github.com/ClickHouse/ClickHouse/pull/37690)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在未使用 SETTINGS 子句创建存储时，服务器重启后 RabbitMQ Storage 无法启动的问题。修复 [#37463](https://github.com/ClickHouse/ClickHouse/issues/37463)。[#37691](https://github.com/ClickHouse/ClickHouse/pull/37691)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在只读模式下，SQL 用户自定义函数禁止执行 `CREATE`/`DROP`。修复了 [#37280](https://github.com/ClickHouse/ClickHouse/issues/37280)。[#37699](https://github.com/ClickHouse/ClickHouse/pull/37699)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复可执行用户自定义函数中 `Nullable` 参数的格式处理。关闭 [#35897](https://github.com/ClickHouse/ClickHouse/issues/35897)。[#37711](https://github.com/ClickHouse/ClickHouse/pull/37711)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复了在分布式查询中通过设置 `optimize_monotonous_functions_in_order_by` 启用的优化。修复了 [#36037](https://github.com/ClickHouse/ClickHouse/issues/36037)。[#37724](https://github.com/ClickHouse/ClickHouse/pull/37724)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复 `values` 表函数中可能出现的逻辑错误：`Invalid Field get from type UInt64 to type Float64`。修复了 [#37602](https://github.com/ClickHouse/ClickHouse/issues/37602)。[#37754](https://github.com/ClickHouse/ClickHouse/pull/37754)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复在 `SchemaReader` 构造函数抛出异常时进行模式推断时可能发生的段错误。关闭 [#37680](https://github.com/ClickHouse/ClickHouse/issues/37680)。[#37760](https://github.com/ClickHouse/ClickHouse/pull/37760)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复内部 `cast` 函数中 `cast_ipv4_ipv6_default_on_conversion_error` 设置的行为。修复 [#35156](https://github.com/ClickHouse/ClickHouse/issues/35156)。[#37761](https://github.com/ClickHouse/ClickHouse/pull/37761)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复 `DataTypeDate32` 类型的 `toString` 错误。[#37775](https://github.com/ClickHouse/ClickHouse/pull/37775) ([LiuNeng](https://github.com/liuneng1994))。
* clickhouse-keeper 设置项 `dead_session_check_period_ms` 被错误地按微秒处理（乘以 1000），这导致失效会话要在数分钟后才会被清理（而不是 500ms）。 [#37824](https://github.com/ClickHouse/ClickHouse/pull/37824) ([Michael Lex](https://github.com/mlex)).
* 修复在分布式查询中可能出现的“No more packets are available”错误（在禁用 `async_socket_for_remote` / `use_hedged_requests` 时）。[#37826](https://github.com/ClickHouse/ClickHouse/pull/37826) ([Azat Khuzhin](https://github.com/azat)).
* （实验性 WINDOW VIEW）在 WindowView 中执行 `ALTER TABLE ... MODIFY QUERY` 时不会再删除内部目标表。 [#37879](https://github.com/ClickHouse/ClickHouse/pull/37879) ([vxider](https://github.com/Vxider)).
* 修复 clickhouse-keeper Docker 镜像中协调目录的目录所有权。修复了 [#37914](https://github.com/ClickHouse/ClickHouse/issues/37914)。[#37915](https://github.com/ClickHouse/ClickHouse/pull/37915)（[James Maidment](https://github.com/jamesmaidment)）。
* 修复了在字典中使用更新字段和 `{condition}` 的自定义查询。关闭 [#33746](https://github.com/ClickHouse/ClickHouse/issues/33746)。[#37947](https://github.com/ClickHouse/ClickHouse/pull/37947)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复在应当在 `WITH FILL` 结果之后再应用 `ORDER BY`（例如外层查询的场景）时，`SELECT ... WITH FILL` 可能产生错误结果的问题。错误结果由针对 `ORDER BY` 表达式的优化导致（[#35623](https://github.com/ClickHouse/ClickHouse/issues/35623)）。关闭 [#37904](https://github.com/ClickHouse/ClickHouse/issues/37904)。[#37959](https://github.com/ClickHouse/ClickHouse/pull/37959)（[Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)）。
* （实验性 WINDOW VIEW）在 WindowView 中向目标表写入数据时补全缺失的默认列，修复 [#37815](https://github.com/ClickHouse/ClickHouse/issues/37815)。[#37965](https://github.com/ClickHouse/ClickHouse/pull/37965)（[vxider](https://github.com/Vxider)）。
* 修复了因栈帧过大而导致编译失败的问题。[#37996](https://github.com/ClickHouse/ClickHouse/pull/37996)（[Han Shukai](https://github.com/KinderRiven)）。
* 开启 `enable&#95;filesystem&#95;query&#95;cache&#95;limit` 时，如果预留缓存大小超过剩余缓存大小，则抛出错误 `Reserved cache size exceeds the remaining cache size`。 [#38004](https://github.com/ClickHouse/ClickHouse/pull/38004) ([xiedeyantu](https://github.com/xiedeyantu)).
* 修复 `UNION` 查询中的类型转换问题（可能会触发 `LOGICAL_ERROR`）。 [#34775](https://github.com/ClickHouse/ClickHouse/pull/34775) ([Azat Khuzhin](https://github.com/azat)).
* 如果 BackgroundExecutor 繁忙，TTL 合并可能不会再次被调度。--merges&#95;with&#95;ttl&#95;counter 会在 selectPartsToMerge() 中增加 --如果 BackgroundExecutor 繁忙，合并任务将被忽略 --merges&#95;with&#95;ttl&#95;counter 不会被减少。 [#36387](https://github.com/ClickHouse/ClickHouse/pull/36387) ([lthaooo](https://github.com/lthaooo)).
* 修复被覆盖的 `normalize_function_names` 设置项的值。[#36937](https://github.com/ClickHouse/ClickHouse/pull/36937) ([李扬](https://github.com/taiyang-li)).
* 修复指数时间衰减窗口函数。现在会正确遵守窗口边界。 [#36944](https://github.com/ClickHouse/ClickHouse/pull/36944) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 修复在读取 system.projection&#95;parts 和 system.projection&#95;parts&#95;columns 时可能出现的 heap-use-after-free 错误。修复了 [#37184](https://github.com/ClickHouse/ClickHouse/issues/37184)。[#37185](https://github.com/ClickHouse/ClickHouse/pull/37185)（[Amos Bird](https://github.com/amosbird)）。
* 修复了 `DateTime64` 在 Unix 纪元之前的秒级小数行为。 [#37697](https://github.com/ClickHouse/ClickHouse/pull/37697) ([Andrey Zvonov](https://github.com/zvonand)). [#37039](https://github.com/ClickHouse/ClickHouse/pull/37039) ([李扬](https://github.com/taiyang-li)).

### <a id="225"></a> ClickHouse 版本 22.5, 2022-05-19 {#a-id225a-clickhouse-release-225-2022-05-19}

#### 升级说明 {#upgrade-notes-2}

- 现在,后台合并、变更和 `OPTIMIZE` 操作将不再增加 `SelectedRows` 和 `SelectedBytes` 指标。它们(仍然)会像以前一样增加 `MergedRows` 和 `MergedUncompressedBytes`。这仅影响指标值,并使其更加准确。此更改不会引入任何不兼容性,但您可能会对指标的变化感到疑惑,因此我们将其放在此类别中。[#37040](https://github.com/ClickHouse/ClickHouse/pull/37040) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 将 BoringSSL 模块更新至官方 FIPS 合规版本。这使得 ClickHouse 符合 FIPS 标准。[#35914](https://github.com/ClickHouse/ClickHouse/pull/35914) ([Meena-Renganathan](https://github.com/Meena-Renganathan))。密码算法 `aes-192-cfb128` 和 `aes-256-cfb128` 已被移除,因为它们未包含在 BoringSSL 的 FIPS 认证版本中。
- 已从 `users.xml` 中的默认用户配置文件中移除 `max_memory_usage` 设置。这使得查询可以使用灵活的内存限制,而不是以前固定的 10 GB 限制。
- 默认禁用 `log_query_threads` 设置。该设置控制参与查询执行的每个线程的统计信息记录。在支持异步读取后,不同线程 ID 的总数变得过大,记录到 `query_thread_log` 变得过于繁重。[#37077](https://github.com/ClickHouse/ClickHouse/pull/37077) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 移除存在错误的函数 `groupArraySorted`。[#36822](https://github.com/ClickHouse/ClickHouse/pull/36822) ([Alexey Milovidov](https://github.com/alexey-milovidov))。

#### 新功能 {#new-feature-7}


- 默认启用内存超额使用。[#35921](https://github.com/ClickHouse/ClickHouse/pull/35921) ([Dmitry Novik](https://github.com/novikd))。
- 在 GROUP BY 子句中添加对 GROUPING SETS 的支持。此实现支持分组集的并行处理。[#33631](https://github.com/ClickHouse/ClickHouse/pull/33631) ([Dmitry Novik](https://github.com/novikd))。
- 新增 `system.certificates` 表。[#37142](https://github.com/ClickHouse/ClickHouse/pull/37142) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
- 新增 `h3Line`、`h3Distance` 和 `h3HexRing` 函数。[#37030](https://github.com/ClickHouse/ClickHouse/pull/37030) ([Bharat Nallan](https://github.com/bharatnc))。
- 新增基于单一二进制文件的诊断工具 (clickhouse-diagnostics)。[#36705](https://github.com/ClickHouse/ClickHouse/pull/36705) ([Dale McDiarmid](https://github.com/gingerwizard))。
- 新增输出格式 `Prometheus` [#36051](https://github.com/ClickHouse/ClickHouse/issues/36051)。[#36206](https://github.com/ClickHouse/ClickHouse/pull/36206) ([Vladimir C](https://github.com/vdimir))。
- 新增 `MySQLDump` 输入格式。它从转储文件中读取属于单个表的所有 INSERT 查询数据。如果存在多个表,默认读取第一个表的数据。[#36667](https://github.com/ClickHouse/ClickHouse/pull/36667) ([Kruglov Pavel](https://github.com/Avogar))。
- 在 `system.tables` 中为临时表显示 `total_rows` 和 `total_bytes` 字段。[#36401](https://github.com/ClickHouse/ClickHouse/issues/36401)。[#36439](https://github.com/ClickHouse/ClickHouse/pull/36439) ([xiedeyantu](https://github.com/xiedeyantu))。
- 允许使用查询级设置覆盖 `parts_to_delay_insert` 和 `parts_to_throw_insert`。如果定义了这些设置,将覆盖表级设置。[#36371](https://github.com/ClickHouse/ClickHouse/pull/36371) ([Memo](https://github.com/Joeywzr))。

#### 实验性功能 {#experimental-feature-6}


- 为数组实现了 L1、L2、Linf、余弦距离函数以及 L1、L2、Linf 范数函数。
  [#37033](https://github.com/ClickHouse/ClickHouse/pull/37033) ([qieqieplus](https://github.com/qieqieplus))。注意:这些函数将被重命名。
- 改进 WindowView 中的 `WATCH` 查询:1. 通过调用 `fire_condition` 信号减少查询结果返回的延迟。2. 通过更频繁地检查 `isCancelled()` 加快取消查询操作(ctrl-c)的速度。[#37226](https://github.com/ClickHouse/ClickHouse/pull/37226) ([vxider](https://github.com/Vxider))。
- 为删除文件系统缓存添加内省功能。[#36802](https://github.com/ClickHouse/ClickHouse/pull/36802) ([Han Shukai](https://github.com/KinderRiven))。
- 为 SQL 添加了新的哈希函数 `wyHash64`。[#36467](https://github.com/ClickHouse/ClickHouse/pull/36467) ([olevino](https://github.com/olevino))。
- 复制数据库改进:添加了 `SYSTEM SYNC DATABASE REPLICA` 查询,允许同步 Replicated 数据库内的表元数据,因为当前同步是异步的。[#35944](https://github.com/ClickHouse/ClickHouse/pull/35944) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 远程文件系统缓存改进:优化从缓存读取的性能。[#37054](https://github.com/ClickHouse/ClickHouse/pull/37054) ([Kseniia Sumarokova](https://github.com/kssenii))。改进 `SYSTEM DROP FILESYSTEM CACHE` 查询:添加 `<path>` 选项和 `FORCE` 选项。[#36639](https://github.com/ClickHouse/ClickHouse/pull/36639) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 半结构化数据改进:允许将 `Object(...)` 类型的列转换为 `Object(Nullable(...))`。[#36564](https://github.com/ClickHouse/ClickHouse/pull/36564) ([awakeljw](https://github.com/awakeljw))。
- 并行副本改进:如果要在本地主机副本上执行查询,我们会创建一个本地解释器。但在多个副本上执行查询时,我们依赖于连接的存在,以便副本可以与协调器通信。现在已改进,本地主机副本可以在同一进程中直接与协调器通信。[#36281](https://github.com/ClickHouse/ClickHouse/pull/36281) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。

#### 性能改进 {#performance-improvement-7}


- 改进不使用 GROUP BY 表达式时 `avg`、`sum` 聚合函数的性能。[#37257](https://github.com/ClickHouse/ClickHouse/pull/37257) ([Maksim Kita](https://github.com/kitaisreal))。
- 使用动态分发改进一元算术函数(`bitCount`、`bitNot`、`abs`、`intExp2`、`intExp10`、`negate`、`roundAge`、`roundDuration`、`roundToExp2`、`sign`)的性能。[#37289](https://github.com/ClickHouse/ClickHouse/pull/37289) ([Maksim Kita](https://github.com/kitaisreal))。
- 使用排序列比较器的 JIT 编译改进 ORDER BY、MergeJoin、插入 MergeTree 的性能。[#34469](https://github.com/ClickHouse/ClickHouse/pull/34469) ([Maksim Kita](https://github.com/kitaisreal))。
- 更改 `system.asynchronous_metric_log` 的结构。它将占用约少 10 倍的空间。这解决了 [#36357](https://github.com/ClickHouse/ClickHouse/issues/36357)。字段 `event_time_microseconds` 已被移除,因为它没有用处。[#36360](https://github.com/ClickHouse/ClickHouse/pull/36360) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 读取宽部分时仅为必要的列加载标记。[#36879](https://github.com/ClickHouse/ClickHouse/pull/36879) ([Anton Kozlov](https://github.com/tonickkozlov))。
- 通过缩小互斥锁范围改进文件描述符缓存的性能。[#36682](https://github.com/ClickHouse/ClickHouse/pull/36682) ([Anton Kozlov](https://github.com/tonickkozlov))。
- 改进从存储 `File` 和表函数 `file` 读取的性能,适用于路径包含通配符且匹配目录包含大量文件的情况。[#36647](https://github.com/ClickHouse/ClickHouse/pull/36647) ([Anton Popov](https://github.com/CurtizJ))。
- 对输入格式 `HiveText` 应用并行解析,在读取本地文件时可将 HiveText 解析速度提高 2 倍。[#36650](https://github.com/ClickHouse/ClickHouse/pull/36650) ([李扬](https://github.com/taiyang-li))。
- 默认的 `HashJoin` 在插入右表行时不是线程安全的,并在单线程中运行。当右表很大时,连接过程会因 CPU 利用率低而过慢。[#36415](https://github.com/ClickHouse/ClickHouse/pull/36415) ([lgbo](https://github.com/lgbo-ustc))。
- 允许将 `select countDistinct(a) from t` 重写为 `select count(1) from (select a from t groupBy a)`。[#35993](https://github.com/ClickHouse/ClickHouse/pull/35993) ([zhanglistar](https://github.com/zhanglistar))。
- 将 OR LIKE 链转换为 multiMatchAny。一旦我们对其工作更有信心就会启用。[#34932](https://github.com/ClickHouse/ClickHouse/pull/34932) ([Daniel Kutenin](https://github.com/danlark1))。
- 通过内联改进某些函数的性能。[#34544](https://github.com/ClickHouse/ClickHouse/pull/34544) ([Daniel Kutenin](https://github.com/danlark1))。
- 添加分支以避免 readBig 中不必要的 memcpy。这在一定程度上改进了性能。[#36095](https://github.com/ClickHouse/ClickHouse/pull/36095) ([jasperzhu](https://github.com/jinjunzh))。
- 为 optimize_aggregation_in_order 实现部分 GROUP BY 键。[#35111](https://github.com/ClickHouse/ClickHouse/pull/35111) ([Azat Khuzhin](https://github.com/azat))。

#### 改进 {#improvement-7}


* 在执行表函数 `file`、`s3` 和 `url` 时，如果发生解析错误，则显示出错文件的名称。 [#36314](https://github.com/ClickHouse/ClickHouse/pull/36314) ([Anton Popov](https://github.com/CurtizJ)).
* 如果在顶层配置中指定了后台操作（合并、变更、移动和拉取）的线程数，则允许在运行时增加这些后台操作的线程数。[#36425](https://github.com/ClickHouse/ClickHouse/pull/36425) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 现在，生成早于 1970-01-01 00:00:00、且处于带有非整小时/分钟偏移时区下时间的日期时间转换函数，其结果将不再溢出，而是被截断为零。这是对 [https://github.com/ClickHouse/ClickHouse/pull/29953](https://github.com/ClickHouse/ClickHouse/pull/29953) 的延续，该 PR 解决了 [https://github.com/ClickHouse/ClickHouse/pull/29953#discussion&#95;r800550280](https://github.com/ClickHouse/ClickHouse/pull/29953#discussion_r800550280) 中提出的问题。将其标记为改进，因为这属于实现自定义行为（且是极少见的情况），我们可以对其进行不兼容更改。[#36656](https://github.com/ClickHouse/ClickHouse/pull/36656)（[Amos Bird](https://github.com/amosbird)）。
* 如果有人在运行 clickhouse-server 时使用日志级别 &quot;test&quot;，会添加一条警告。日志级别 &quot;test&quot; 是最近新增的，由于会带来不可避免、无法规避、致命且极其严重的性能下降，不能在生产环境中使用。[#36824](https://github.com/ClickHouse/ClickHouse/pull/36824) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* 在 `CREATE TABLE` 中解析排序规则，根据情况抛出异常或忽略。修复 [#35892](https://github.com/ClickHouse/ClickHouse/issues/35892)。[#36271](https://github.com/ClickHouse/ClickHouse/pull/36271)（[yuuch](https://github.com/yuuch)）。
* 选项 `compatibility_ignore_auto_increment_in_create_table` 允许在列定义中忽略 `AUTO_INCREMENT` 关键字，从而简化从 MySQL 迁移的过程。 [#37178](https://github.com/ClickHouse/ClickHouse/pull/37178) ([Igor Nikonov](https://github.com/devcrafter)).
* 为 `JSONEachRow` 添加 `JSONLines` 和 `NDJSON` 别名。解决 [#36303](https://github.com/ClickHouse/ClickHouse/issues/36303)。[#36327](https://github.com/ClickHouse/ClickHouse/pull/36327)（[flynn](https://github.com/ucasfl)）。
* 限制每个 Hive 表在查询时可扫描的最大分区数量，避免资源过载。[#37281](https://github.com/ClickHouse/ClickHouse/pull/37281) ([lgbo](https://github.com/lgbo-ustc))。
* 为 `h3kRing` 函数的第二个参数添加了隐式类型转换以提升易用性。修复了 [#35432](https://github.com/ClickHouse/ClickHouse/issues/35432)。[#37189](https://github.com/ClickHouse/ClickHouse/pull/37189)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复 `clickhouse-local` 中针对任意查询的 `INSERT SELECT` 进度显示，以及客户端中的文件进度显示，使文件进度更加准确。[#37075](https://github.com/ClickHouse/ClickHouse/pull/37075) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 修复了一个错误：在删除数据部分过程中如果发生文件系统故障，可能会导致 MergeTree 表引擎系列中遗留过期的数据部分。在修复之前，这些部分只有在服务器首次重启后才会被删除。[#37014](https://github.com/ClickHouse/ClickHouse/pull/37014) ([alesapin](https://github.com/alesapin)).
* 实现了一种新的行策略处理模式，可以在主配置中启用，使即使未关联宽松行策略的用户也能读取数据行。 [#36997](https://github.com/ClickHouse/ClickHouse/pull/36997) ([Vitaly Baranov](https://github.com/vitlibar)).
* Play UI：在表格单元格中，`Nullable` 数值将右对齐。此更改修复了 [#36982](https://github.com/ClickHouse/ClickHouse/issues/36982)。[#36988](https://github.com/ClickHouse/ClickHouse/pull/36988)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* Play UI：如果结果中只有一行且列比较多，则以纵向方式显示结果。[#36811](https://github.com/ClickHouse/ClickHouse/issues/36811) 的延续。[#36842](https://github.com/ClickHouse/ClickHouse/pull/36842)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 整理 Play UI 中的 CSS，使像素分布更加均匀，提升了表格单元格中长内容的可用性。[#36569](https://github.com/ClickHouse/ClickHouse/pull/36569) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* 在发生异常时最终确定写入缓冲区，而不是在析构函数中处理。希望这可以修复：[ #36907 ](https://github.com/ClickHouse/ClickHouse/issues/36907)。[ #36979 ](https://github.com/ClickHouse/ClickHouse/pull/36979)（[Kruglov Pavel](https://github.com/Avogar)）。
* 在 [#36425](https://github.com/ClickHouse/ClickHouse/issues/36425) 之后，`background_fetches_pool_size` 等设置被废弃，虽然它们仍然可以出现在顶层配置中，但 clickhouse 会抛出类似 `Error updating configuration from '/etc/clickhouse-server/config.xml' config.: Code: 137. DB::Exception: A setting 'background_fetches_pool_size' appeared at top level in config /etc/clickhouse-server/config.xml.` 的异常。此问题已修复。[#36917](https://github.com/ClickHouse/ClickHouse/pull/36917)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 在将异常发送到其他服务器时（如适用）添加额外的诊断信息。 [#36872](https://github.com/ClickHouse/ClickHouse/pull/36872) ([tavplubix](https://github.com/tavplubix))。
* 允许对类型为 `Array(Tuple(..))` 的参数执行哈希函数。 [#36812](https://github.com/ClickHouse/ClickHouse/pull/36812) ([Anton Popov](https://github.com/CurtizJ))。
* 添加了 `user_defined_path` 配置项。 [#36753](https://github.com/ClickHouse/ClickHouse/pull/36753) ([Maksim Kita](https://github.com/kitaisreal)).
* 在 `s3Cluster` 表函数中允许使用集群宏。[#36726](https://github.com/ClickHouse/ClickHouse/pull/36726) ([Vadim Volodin](https://github.com/PolyProgrammist))。
* 在 `clickhouse-client`/`clickhouse-local` 中正确中止 INSERT 查询。[#36710](https://github.com/ClickHouse/ClickHouse/pull/36710) ([Azat Khuzhin](https://github.com/azat)).
* 允许在 `MySQLHandler` 中取消查询的同时仍保留合适的查询 ID。 [#36699](https://github.com/ClickHouse/ClickHouse/pull/36699) ([Amos Bird](https://github.com/amosbird)).
* 在 `system.processes` 中新增 `is_all_data_sent` 列，并基于该列改进内部测试的健壮性检查。 [#36649](https://github.com/ClickHouse/ClickHouse/pull/36649) ([Azat Khuzhin](https://github.com/azat)).
* 用于统计从 s3 读取耗时的指标现在已被正确计算。关闭 [#35483](https://github.com/ClickHouse/ClickHouse/issues/35483)。[#36572](https://github.com/ClickHouse/ClickHouse/pull/36572)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 如果在 `clickhouse-local` 中运行，允许在表函数 `file` 中使用文件描述符。 [#36562](https://github.com/ClickHouse/ClickHouse/pull/36562) ([wuxiaobai24](https://github.com/wuxiaobai24)).
* 允许元组元素的名称以数字开头。[#36544](https://github.com/ClickHouse/ClickHouse/pull/36544) ([Anton Popov](https://github.com/CurtizJ))。
* 现在，clickhouse-benchmark 可以从环境变量中读取认证信息。[#36497](https://github.com/ClickHouse/ClickHouse/pull/36497)（[Anton Kozlov](https://github.com/tonickkozlov)）。
* `clickhouse-keeper` 改进：新增对强制恢复的支持，使您可以在未达成仲裁的情况下重新配置集群。[#36258](https://github.com/ClickHouse/ClickHouse/pull/36258) ([Antonio Andelic](https://github.com/antonio2368))。
* 改进对 JSON 对象的模式推断。[#36207](https://github.com/ClickHouse/ClickHouse/pull/36207) ([Kruglov Pavel](https://github.com/Avogar))。
* 重构基于通配符进行 schema 推断的相关代码。仅在确有必要时才从通配符结果中尝试下一个文件（此前我们在遇到任意错误时都会直接尝试下一个文件）。同时修复了 [#36317](https://github.com/ClickHouse/ClickHouse/issues/36317)。[#36205](https://github.com/ClickHouse/ClickHouse/pull/36205)（[Kruglov Pavel](https://github.com/Avogar)）。
* 添加单独的 `CLUSTER` 权限（以及 `access_control_improvements.on_cluster_queries_require_cluster_grant` 配置指令，为了向后兼容，默认值为 `false`）。[#35767](https://github.com/ClickHouse/ClickHouse/pull/35767) ([Azat Khuzhin](https://github.com/azat)).
* 如果在选定的查询停止之前所需的内存已经可用，所有等待中的查询将继续执行。现在，如果在选定查询获知取消之前内存已经被释放，我们不会停止任何查询。[#35637](https://github.com/ClickHouse/ClickHouse/pull/35637) ([Dmitry Novik](https://github.com/novikd))。
* 在 protobuf 中检测 Nullable。在 proto3 中，默认值不会通过网络发送。这使得在 Nullable 列中区分 null 和默认值变得不那么直接。处理此问题的标准方式是使用 Google wrapper，将目标值嵌套在内部 message 中（参见 [https://github.com/protocolbuffers/protobuf/blob/master/src/google/protobuf/wrappers.proto](https://github.com/protocolbuffers/protobuf/blob/master/src/google/protobuf/wrappers.proto)）。在这种情况下，缺失字段会被解释为 null 值，字段存在但缺失具体值会被解释为默认值，而具有普通值的字段则被解释为普通值。然而，ClickHouse 会将 Google wrapper 解释为嵌套列。我们建议引入特殊处理逻辑来识别 Google wrapper，并按上述方式对其进行解释。例如，为了序列化 Nullable 列 `test` 的值，我们会在 .proto schema 中使用 `google.protobuf.StringValue test`。请注意，这些类型在 Protobuf 中被称为 “well-known types”，由库本身实现。[#35149](https://github.com/ClickHouse/ClickHouse/pull/35149)（[Jakub Kuklis](https://github.com/jkuklis)）。
* 为预定义和静态 HTTP 处理程序配置新增了对指定 `content_type` 的支持。[#34916](https://github.com/ClickHouse/ClickHouse/pull/34916) ([Roman Nikonov](https://github.com/nic11))。
* 在未事先使用 `--external` 参数时使用 `clickhouse-client --file` 时给出适当警告。关闭 [#34747](https://github.com/ClickHouse/ClickHouse/issues/34747)。[#34765](https://github.com/ClickHouse/ClickHouse/pull/34765)（[李扬](https://github.com/taiyang-li)）。
* 改进 MySQL 数据库引擎，使其兼容 `binary(0)` 数据类型。 [#37232](https://github.com/ClickHouse/ClickHouse/pull/37232) ([zzsmdfj](https://github.com/zzsmdfj)).
* 改进 `clickhouse-benchmark` 的 JSON 报告。[#36473](https://github.com/ClickHouse/ClickHouse/pull/36473) ([Tian Xinhui](https://github.com/xinhuitian))。
* 如果无法解析外部 ClickHouse 字典的主机名，服务器可能会拒绝启动。此问题已修复，对应问题 [#36451](https://github.com/ClickHouse/ClickHouse/issues/36451)。[#36463](https://github.com/ClickHouse/ClickHouse/pull/36463)（[tavplubix](https://github.com/tavplubix)）。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-7}

- 现在 `x86_64` 架构的 `clickhouse-keeper` 已与 [musl](https://musl.libc.org/) 静态链接，不再依赖任何系统库。[#31833](https://github.com/ClickHouse/ClickHouse/pull/31833) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `PowerPC64LE` 架构的 ClickHouse 构建版本现已可通过通用安装脚本 `curl https://clickhouse.com/ | sh` 和直接链接 `https://builds.clickhouse.com/master/powerpc64le/clickhouse` 获取。[#37095](https://github.com/ClickHouse/ClickHouse/pull/37095) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 将 PowerPC 代码生成限制为 Power8 以提高兼容性。此更改关闭了 [#36025](https://github.com/ClickHouse/ClickHouse/issues/36025)。[#36529](https://github.com/ClickHouse/ClickHouse/pull/36529) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 简化性能测试。这将使我们能够更好地使用它。[#36769](https://github.com/ClickHouse/ClickHouse/pull/36769) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 当报告中出现错误时使性能比较失败。[#34797](https://github.com/ClickHouse/ClickHouse/pull/34797) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- 为 Arrow 添加 ZSTD 支持。此更改修复了 [#35283](https://github.com/ClickHouse/ClickHouse/issues/35283)。[#35486](https://github.com/ClickHouse/ClickHouse/pull/35486) ([Sean Lafferty](https://github.com/seanlaff))。

#### 错误修复 {#bug-fix-3}


* 如果 URI 中存在 Version ID，则从中提取并将其作为请求参数添加到 AWS HTTP URI。关闭 [#31221](https://github.com/ClickHouse/ClickHouse/issues/31221)。 - [x] 如果存在，则从 URI 中提取 `Version ID`，并在移除该参数后重新组装 URI。 - [x] 使用该请求参数配置 `AWS HTTP URI` 对象。 - [x] 单元测试：[`gtest_s3_uri`](https://github.com/ClickHouse/ClickHouse/blob/2340a6c6849ebc05a8efbf97ba8de3ff9dc0eff4/src/IO/tests/gtest_s3_uri.cpp) - [x] 删除埋点提交。[#34571](https://github.com/ClickHouse/ClickHouse/pull/34571) ([Saad Ur Rahman](https://github.com/surahman))。
* 将 system.opentelemetry&#95;span&#95;log 表中的 attribute.values 别名从 keys 更正为 values。 [#37275](https://github.com/ClickHouse/ClickHouse/pull/37275) ([Aleksandr Razumov](https://github.com/ernado)).
* 修复 Nullable(String) 到 Nullable(Bool/IPv4/IPv6) 的转换问题，关闭 [#37221](https://github.com/ClickHouse/ClickHouse/issues/37221)。[#37270](https://github.com/ClickHouse/ClickHouse/pull/37270)（[Kruglov Pavel](https://github.com/Avogar)）。
* 实验功能：修复在包含 `Object` 类型列的表中执行变更（mutation）时的行为。目前在 `UPDATE` 或 `DELETE` 查询的 `WHERE` 表达式中使用 `Object` 类型的子列仍然不被允许，对单独子列进行（`DROP`、`MODIFY`）操作也同样不被允许。修复了 [#37205](https://github.com/ClickHouse/ClickHouse/issues/37205)。[#37266](https://github.com/ClickHouse/ClickHouse/pull/37266)（[Anton Popov](https://github.com/CurtizJ)）。
* Kafka 在生产者阶段不需要 `group.id`。在控制台日志中，你可以看到一条描述此问题的警告：`2022.05.15 17:59:13.270227 [ 137 ] {} <Warning> StorageKafka (topic-name): [rdk:CONFWARN] [thrd:app]: Configuration property group.id is a consumer property and will be ignored by this producer instance`。 [#37228](https://github.com/ClickHouse/ClickHouse/pull/37228) ([Mark Andreev](https://github.com/mrk-andreev)).
* 实验特性（WindowView）：仅在数据块实际触发后再更新 `max_fired_watermark`，以避免删除尚未触发的数据。[#37225](https://github.com/ClickHouse/ClickHouse/pull/37225) ([vxider](https://github.com/Vxider))。
* 修复在带有 LIMIT BY 的分布式查询中出现的“Cannot create column of type Set”错误。[#37193](https://github.com/ClickHouse/ClickHouse/pull/37193) ([Azat Khuzhin](https://github.com/azat)).
* 实验特性：现在 WindowView 的 `WATCH EVENTS` 查询不会再因为在 `WindowViewSource.h:58` 中创建的非空 Chunk 而被终止。[#37182](https://github.com/ClickHouse/ClickHouse/pull/37182) ([vxider](https://github.com/Vxider))。
* 为子查询启用 `enable_global_with_statement`，修复 [#37141](https://github.com/ClickHouse/ClickHouse/issues/37141)。[#37166](https://github.com/ClickHouse/ClickHouse/pull/37166)（[Vladimir C](https://github.com/vdimir)）。
* 修复 `optimize_skip_unused_shards_rewrite_in` 的隐式类型转换。 [#37153](https://github.com/ClickHouse/ClickHouse/pull/37153) ([Azat Khuzhin](https://github.com/azat)).
* 在 `FixedString` 列上使用 `ILIKE` 函数时，可能会返回错误结果（即匹配的行数少于应有数量）。[#37117](https://github.com/ClickHouse/ClickHouse/pull/37117) ([Robert Schulze](https://github.com/rschu1ze))。
* 修复 `GROUP BY` 中使用 `AggregateFunction` 的问题（即按具有 `AggregateFunction` 类型的列进行分组）。[#37093](https://github.com/ClickHouse/ClickHouse/pull/37093) ([Azat Khuzhin](https://github.com/azat)).
* 实验特性：修复在使用前缀 GROUP BY 和 *Array 聚合函数时的 `optimize_aggregation_in_order`。 [#37050](https://github.com/ClickHouse/ClickHouse/pull/37050) ([Azat Khuzhin](https://github.com/azat)).
* 修复了某些带有隐式聚合的 `INSERT SELECT` 查询的性能回退问题。修复了 [#36792](https://github.com/ClickHouse/ClickHouse/issues/36792)。[#37047](https://github.com/ClickHouse/ClickHouse/pull/37047)（[tavplubix](https://github.com/tavplubix)）。
* 实验特性：修复与 `*Array`（`groupArrayArray`/...）聚合函数一起使用的有序 `GROUP BY`（`optimize_aggregation_in_order=1`）。[#37046](https://github.com/ClickHouse/ClickHouse/pull/37046) ([Azat Khuzhin](https://github.com/azat)).
* 修复当索引类型不是 UInt8 时，LowCardinality-&gt;ArrowDictionary 的输出无效的问题。修复 [#36832](https://github.com/ClickHouse/ClickHouse/issues/36832)。[#37043](https://github.com/ClickHouse/ClickHouse/pull/37043)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复了 `quantileTDigest` 中处理 inf 的问题，对应修复 [#32107](https://github.com/ClickHouse/ClickHouse/issues/32107)。[#37021](https://github.com/ClickHouse/ClickHouse/pull/37021)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* 修复了在 `max_parallel_replicas` != 1 时，通过 `HedgedConnections` 发送外部表数据的问题。 [#36981](https://github.com/ClickHouse/ClickHouse/pull/36981) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复了在 `Replicated` 数据库中执行 `TRUNCATE` 查询时的逻辑错误。修复了 [#33747](https://github.com/ClickHouse/ClickHouse/issues/33747)。[#36976](https://github.com/ClickHouse/ClickHouse/pull/36976)（[tavplubix](https://github.com/tavplubix)）。
* 实验特性：修复在 `WindowView` 中删除源表时卡死的问题。修复 [#35678](https://github.com/ClickHouse/ClickHouse/issues/35678)。[#36967](https://github.com/ClickHouse/ClickHouse/pull/36967)（[vxider](https://github.com/Vxider)）。
* 实验特性（rocksdb cache）：修复问题 [#36671](https://github.com/ClickHouse/ClickHouse/issues/36671)。参见 [#36929](https://github.com/ClickHouse/ClickHouse/pull/36929)（[李扬](https://github.com/taiyang-li)）。
* 实验特性：通过添加转换操作，使得在 `writeIntoWindowView` 使用略有不同的 schema 时也可以调用，从而修复在 WindowView 中使用多列时的错误。 [#36928](https://github.com/ClickHouse/ClickHouse/pull/36928) ([vxider](https://github.com/Vxider))。
* 修复 clickhouse-keeper 中的一个 bug，在负载较低且发生重启的情况下，该 bug 可能导致压缩日志文件损坏。[#36910](https://github.com/ClickHouse/ClickHouse/pull/36910) ([alesapin](https://github.com/alesapin))。
* 修复在执行常量聚合时得到的错误查询结果。修复了 [#36728](https://github.com/ClickHouse/ClickHouse/issues/36728)。[#36888](https://github.com/ClickHouse/ClickHouse/pull/36888)（[Amos Bird](https://github.com/amosbird)）。
* 实验性特性：修复缓存中 `current_size` 的计数。[#36887](https://github.com/ClickHouse/ClickHouse/pull/36887) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 实验特性：修复在带 hop window 的 window view 中的触发机制 [#34044](https://github.com/ClickHouse/ClickHouse/issues/34044)。[#36861](https://github.com/ClickHouse/ClickHouse/pull/36861) ([vxider](https://github.com/Vxider))。
* 实验性功能：修复来自远程文件系统缓存缓冲区中的错误 `cast`。 [#36809](https://github.com/ClickHouse/ClickHouse/pull/36809) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 修复了在使用 `flatten_nested = 0` 创建表时的问题。此前，未展平的 `Nested` 列在服务器重启后可能会被展平。[#36803](https://github.com/ClickHouse/ClickHouse/pull/36803) ([Anton Popov](https://github.com/CurtizJ))。
* 修复了在读取低基数数据时，从远程文件系统进行异步读取所出现的一些问题。 [#36763](https://github.com/ClickHouse/ClickHouse/pull/36763) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 实验性特性：修复了从多个文件向 `Object` 类型列插入数据的问题，例如通过带有通配符的表函数 `file`。 [#36762](https://github.com/ClickHouse/ClickHouse/pull/36762) ([Anton Popov](https://github.com/CurtizJ)).
* 修复 Hedged 请求中的超时问题。发送远程查询后连接立即挂起可能导致无限期等待。[#36749](https://github.com/ClickHouse/ClickHouse/pull/36749) ([Kruglov Pavel](https://github.com/Avogar)).
* 实验特性：修复了在分布式表上使用 `groupBitmapAndState`/`groupBitmapOrState`/`groupBitmapXorState` 时出现的一个错误。 [#36739](https://github.com/ClickHouse/ClickHouse/pull/36739) ([Zhang Yifan](https://github.com/zhangyifan27)).
* 实验特性：在 [PR](https://github.com/ClickHouse/ClickHouse/pull/36376) 的[测试](https://s3.amazonaws.com/clickhouse-test-reports/36376/1cb1c7275cb53769ab826772db9b71361bb3e413/stress_test__thread__actions_/clickhouse-server.clean.log)过程中，我发现有一个缓存类被初始化了两次，从而抛出了异常。虽然目前还不清楚问题的根本原因，但可以确定 ClickHouse 中存在重复加载磁盘的代码逻辑，因此需要针对这种情况做特殊处理。[#36737](https://github.com/ClickHouse/ClickHouse/pull/36737)（[Han Shukai](https://github.com/KinderRiven)）。
* 修复在宽表部分进行垂直合并时的问题。此前在合并过程中可能会抛出 `There is no column` 异常。[#36707](https://github.com/ClickHouse/ClickHouse/pull/36707)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复在端口变更时服务器重新加载的问题（不再等待查询上下文中的现有连接）。 [#36700](https://github.com/ClickHouse/ClickHouse/pull/36700) ([Azat Khuzhin](https://github.com/azat)).
* 实验性特性：在之前的 [PR](https://github.com/ClickHouse/ClickHouse/pull/36376) 中，我发现测试（无状态测试、flaky 检查（address、actions））会超时。此外，本地测试也可能触发不稳定的系统死锁。即便使用当前 master 分支的最新源码，该问题仍然存在。[#36697](https://github.com/ClickHouse/ClickHouse/pull/36697)（[Han Shukai](https://github.com/KinderRiven)）。
* 实验特性：修复因缓存配置更改而导致的服务器重启问题。 [#36685](https://github.com/ClickHouse/ClickHouse/pull/36685) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 修复模式推断中可能出现的 heap-use-after-free 问题。关联关闭 [#36661](https://github.com/ClickHouse/ClickHouse/issues/36661)。[#36679](https://github.com/ClickHouse/ClickHouse/pull/36679)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复了在未指定引擎时，对 `CREATE` 查询中查询设置的解析。修复了 [https://github.com/ClickHouse/ClickHouse/pull/34187#issuecomment-1103812419](https://github.com/ClickHouse/ClickHouse/pull/34187#issuecomment-1103812419)。[#36642](https://github.com/ClickHouse/ClickHouse/pull/36642)（[tavplubix](https://github.com/tavplubix)）。
* 实验特性：修复包含 `Object` 类型的宽分区的合并。[#36637](https://github.com/ClickHouse/ClickHouse/pull/36637)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复当默认表达式跟在非字面量的 `EPHEMERAL` 之后时导致的格式化崩溃。关闭 [#36618](https://github.com/ClickHouse/ClickHouse/issues/36618)。[#36633](https://github.com/ClickHouse/ClickHouse/pull/36633)（[flynn](https://github.com/ucasfl)）。
* 修复在 `ENGINE = MergeTree` 表中使用 `INTERPOLATE` 时可能出现的 `Missing column` 异常。[#36549](https://github.com/ClickHouse/ClickHouse/pull/36549) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* 修复关联查询中 `WHERE` 子句里字面量可能导致的潜在错误。关闭 [#36279](https://github.com/ClickHouse/ClickHouse/issues/36279)。[#36542](https://github.com/ClickHouse/ClickHouse/pull/36542)（[Vladimir C](https://github.com/vdimir)）。
* 修复 `ReadBufferFromEncryptedFile` 的偏移量更新问题，该问题可能导致未定义的行为。 [#36493](https://github.com/ClickHouse/ClickHouse/pull/36493) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 修复 Keeper 集群配置中的主机名合法性检查。新增 `keeper_server.host_checks_enabled` 配置项，用于启用或禁用这些检查。[#36492](https://github.com/ClickHouse/ClickHouse/pull/36492) ([Antonio Andelic](https://github.com/antonio2368)).
* 修复在 `GROUP BY` 中使用可执行用户自定义函数的问题。此前，可执行用户自定义函数不能作为 `GROUP BY` 子句中的表达式使用。关闭 [#36448](https://github.com/ClickHouse/ClickHouse/issues/36448)。[#36486](https://github.com/ClickHouse/ClickHouse/pull/36486)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复客户端在处理来自服务器的未知数据包时可能出现的异常。 [#36481](https://github.com/ClickHouse/ClickHouse/pull/36481) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 实验性功能（请务必不要使用 `system.session_log`，该表即将被移除）：在 `system.session_log` 表中补齐缺失的枚举值。修复 [#36474](https://github.com/ClickHouse/ClickHouse/issues/36474)。[#36480](https://github.com/ClickHouse/ClickHouse/pull/36480) ([Memo](https://github.com/Joeywzr))。
* 修复了 `s3Cluster` 模式推断中的一个错误，该错误导致在从 `s3Cluster` 执行 `SELECT` 时无法读取全部数据。该缺陷是在 [https://github.com/ClickHouse/ClickHouse/pull/35544](https://github.com/ClickHouse/ClickHouse/pull/35544) 中引入的。[#36434](https://github.com/ClickHouse/ClickHouse/pull/36434)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复 JOIN 和 COLUMNS 匹配器中的 `nullptr` 解引用问题。修复了 [#36416](https://github.com/ClickHouse/ClickHouse/issues/36416)。对应的 PR 为 [https://github.com/ClickHouse/ClickHouse/pull/36417](https://github.com/ClickHouse/ClickHouse/pull/36417)。[#36430](https://github.com/ClickHouse/ClickHouse/pull/36430)（[Amos Bird](https://github.com/amosbird)）。
* 修复当 `ClickHouseDictionarySource` 包含标量子查询时的字典重新加载问题。[#36390](https://github.com/ClickHouse/ClickHouse/pull/36390) ([lthaooo](https://github.com/lthaooo)).
* 修复 JOIN 中的断言，关闭 [#36199](https://github.com/ClickHouse/ClickHouse/issues/36199)。[#36201](https://github.com/ClickHouse/ClickHouse/pull/36201)（[Vladimir C](https://github.com/vdimir)）。
* 在特殊运算符中包含别名的查询会返回解析错误（在 22.1 版本中出现问题）。示例：`SELECT substring('test' AS t, 1, 1)`。[#36167](https://github.com/ClickHouse/ClickHouse/pull/36167) ([Maksim Kita](https://github.com/kitaisreal))。
* 实验特性：修复将包含嵌套数组的复杂 JSON 插入到 `Object` 类型列时的问题。 [#36077](https://github.com/ClickHouse/ClickHouse/pull/36077) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在包含紧凑分片的嵌套列上执行 `ALTER DROP COLUMN` 时的问题（即在存在列 `n.d` 时执行 `ALTER TABLE x DROP COLUMN n`）。[#35797](https://github.com/ClickHouse/ClickHouse/pull/35797) ([Azat Khuzhin](https://github.com/azat)).
* 修复当 `offset` 和 `length` 为负常量且 `s` 非常量时，`substring` 函数范围错误的长度问题。 [#33861](https://github.com/ClickHouse/ClickHouse/pull/33861) ([RogerYK](https://github.com/RogerYK)).

### <a id="224"></a> ClickHouse 版本 22.4，2022-04-19 {#a-id224a-clickhouse-release-224-2022-04-19}

#### 向后不兼容变更 {#backward-incompatible-change-5}

- 不再允许在 INSERT 查询的 FORMAT 之后使用 SETTINGS（可通过兼容性设置 `allow_settings_after_format_in_insert` 接受此类查询，但默认为关闭状态）。[#35883](https://github.com/ClickHouse/ClickHouse/pull/35883) ([Azat Khuzhin](https://github.com/azat))。
- 函数 `yandexConsistentHash`（由 Konstantin "kostik" Oblakov 开发的一致性哈希算法）已重命名为 `kostikConsistentHash`。旧名称作为别名保留以保持兼容性。尽管此变更向后兼容，但我们可能会在后续版本中移除该别名，因此建议更新应用程序中对此函数的使用。[#35553](https://github.com/ClickHouse/ClickHouse/pull/35553) ([Alexey Milovidov](https://github.com/alexey-milovidov))。

#### 新功能 {#new-feature-8}


* 为 `ORDER BY ... WITH FILL` 新增 `INTERPOLATE` 扩展。修复 [#34903](https://github.com/ClickHouse/ClickHouse/issues/34903)。[#35349](https://github.com/ClickHouse/ClickHouse/pull/35349)（[Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)）。
* 在处理器级别进行性能分析（在启用 `log_processors_profiles` 设置后，ClickHouse 会将处理器在执行/等待数据期间所花费的时间写入 `system.processors_profile_log` 表）。[#34355](https://github.com/ClickHouse/ClickHouse/pull/34355)（[Azat Khuzhin](https://github.com/azat)）。
* 新增函数 makeDate(year, month, day)、makeDate32(year, month, day)。[#35628](https://github.com/ClickHouse/ClickHouse/pull/35628)（[Alexander Gololobov](https://github.com/davenger)）。实现了 makeDateTime() 和 makeDateTime64()。[#35934](https://github.com/ClickHouse/ClickHouse/pull/35934)（[Alexander Gololobov](https://github.com/davenger)）。
* 支持新的配额类型 `WRITTEN BYTES`，用于限制插入查询期间写入的字节数。[#35736](https://github.com/ClickHouse/ClickHouse/pull/35736) ([Anton Popov](https://github.com/CurtizJ))。
* 新增函数 `flattenTuple`。该函数接收嵌套的具名 `Tuple` 作为参数，并返回一个扁平化的 `Tuple`，其元素为原始 `Tuple` 中各元素的路径。例如：`Tuple(a Int, Tuple(b Int, c Int)) -> Tuple(a Int, b Int, c Int)`。`flattenTuple` 可用于将类型为 `Object` 的所有路径选为单独的列。[#35690](https://github.com/ClickHouse/ClickHouse/pull/35690) ([Anton Popov](https://github.com/CurtizJ))。
* 新增函数 `arrayFirstOrNull`、`arrayLastOrNull`。修复 [#35238](https://github.com/ClickHouse/ClickHouse/issues/35238)。[#35414](https://github.com/ClickHouse/ClickHouse/pull/35414)（[Maksim Kita](https://github.com/kitaisreal)）。
* 新增了函数 `minSampleSizeContinous` 和 `minSampleSizeConversion`。作者：[achimbab](https://github.com/achimbab)。[#35360](https://github.com/ClickHouse/ClickHouse/pull/35360)（[Maksim Kita](https://github.com/kitaisreal)）。
* 新增函数 `minSampleSizeContinous` 和 `minSampleSizeConversion`。[#34354](https://github.com/ClickHouse/ClickHouse/pull/34354)（[achimbab](https://github.com/achimbab)）。
* 引入 `ProtobufList` 格式（所有记录都作为 repeated message 写入输出 Protobuf）。修复 [#16436](https://github.com/ClickHouse/ClickHouse/issues/16436)。[#35152](https://github.com/ClickHouse/ClickHouse/pull/35152)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 添加 `h3PointDistM`、`h3PointDistKm`、`h3PointDistRads`、`h3GetRes0Indexes`、`h3GetPentagonIndexes` 函数。[#34568](https://github.com/ClickHouse/ClickHouse/pull/34568)（[Bharat Nallan](https://github.com/bharatnc)）。
* 添加 `toLastDayOfMonth` 函数，用于将日期或带时间的日期向上舍入到该月的最后一天。[#33501](https://github.com/ClickHouse/ClickHouse/issues/33501)。[#34394](https://github.com/ClickHouse/ClickHouse/pull/34394)（[Habibullah Oladepo](https://github.com/holadepo)）。
* 为 [Zoo]Keeper 客户端新增负载均衡设置，修复了 [#29617](https://github.com/ClickHouse/ClickHouse/issues/29617)。[#30325](https://github.com/ClickHouse/ClickHouse/pull/30325) ([小路](https://github.com/nicelulu))。
* 新增一种名为 `simple` 的行策略。在此 PR 之前，我们有两种行策略：`permissive` 和 `restrictive`。`simple` 行策略只是在表上添加一个新的过滤条件，不会像 `permissive` 和 `restrictive` 策略那样产生任何副作用。[#35345](https://github.com/ClickHouse/ClickHouse/pull/35345) ([Vitaly Baranov](https://github.com/vitlibar))。
* 在复制数据库中新增了指定集群密钥的功能。 [#35333](https://github.com/ClickHouse/ClickHouse/pull/35333) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 在服务器启动时增加了有效性检查（可用内存和磁盘空间、最大线程数等）。 [#34566](https://github.com/ClickHouse/ClickHouse/pull/34566) ([Sergei Trifonov](https://github.com/serxa)).
* `INTERVAL` 得到改进——现在可以与 `[MILLI|MICRO|NANO]SECOND` 一起使用。新增 `toStartOf[Milli|Micro|Nano]second()` 函数。新增 `[add|subtract][Milli|Micro|Nano]seconds()` 函数。 [#34353](https://github.com/ClickHouse/ClickHouse/pull/34353) ([Andrey Zvonov](https://github.com/zvonand))。

#### 实验性功能 {#experimental-feature-7}

- 为简单的 `MergeTree` 表添加了事务支持。此功能为高度实验性功能,不建议在生产环境中使用。属于 [#22086](https://github.com/ClickHouse/ClickHouse/issues/22086) 的一部分。[#24258](https://github.com/ClickHouse/ClickHouse/pull/24258) ([tavplubix](https://github.com/tavplubix))。
- 支持在 `JSONEachRow` 格式中对 `Object` 类型进行模式推断。允许将 `Map` 类型的列转换为 `Object` 类型的列。[#35629](https://github.com/ClickHouse/ClickHouse/pull/35629) ([Anton Popov](https://github.com/CurtizJ))。
- 允许在所有写入操作中写入远程文件系统缓存。添加 `system.remote_filesystem_cache` 表。添加 `drop remote filesystem cache` 查询。通过 `system.remote_data_paths` 表添加 S3 元数据的内省功能。关闭 [#34021](https://github.com/ClickHouse/ClickHouse/issues/34021)。通过添加 `read_from_filesystem_cache_if_exists_otherwise_bypass_cache` 模式为合并操作添加缓存选项(默认为合并操作启用,也可以通过同名查询设置启用)。重命名缓存相关设置(`remote_fs_enable_cache -> enable_filesystem_cache` 等)。[#35475](https://github.com/ClickHouse/ClickHouse/pull/35475) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 在 RocksDB 中存储数据分片元数据的选项。加速 MergeTree 的数据分片加载过程以加快 clickhouse-server 的启动速度。通过此改进,在拥有 70 万个 MergeTree 数据分片的情况下,clickhouse-server 能够将启动时间从 75 分钟缩短至 20 秒。[#32928](https://github.com/ClickHouse/ClickHouse/pull/32928) ([李扬](https://github.com/taiyang-li))。

#### 性能改进 {#performance-improvement-8}


- 新的查询计划优化。在可能的情况下,在 `ORDER BY` 之后再计算函数。例如,对于查询 `SELECT sipHash64(number) FROM numbers(1e8) ORDER BY number LIMIT 5`,函数 `sipHash64` 将在 `ORDER BY` 和 `LIMIT` 之后计算,这可以带来约 20 倍的性能提升。[#35623](https://github.com/ClickHouse/ClickHouse/pull/35623) ([Nikita Taranov](https://github.com/nickitat))。
- 现在会收集聚合期间使用的哈希表大小,并在后续查询中使用,以避免哈希表重新调整大小。[#33439](https://github.com/ClickHouse/ClickHouse/pull/33439) ([Nikita Taranov](https://github.com/nickitat))。
- 使用 SIMD 指令(SSE 和 AVX2)改进 hasAll 函数。[#27653](https://github.com/ClickHouse/ClickHouse/pull/27653) ([youennL-cs](https://github.com/youennL-cs))。[#35723](https://github.com/ClickHouse/ClickHouse/pull/35723) ([Maksim Kita](https://github.com/kitaisreal))。
- 多项更改以提高 ASOF JOIN 性能(快 1.2 - 1.6 倍)。同时增加了对大整数的支持。[#34733](https://github.com/ClickHouse/ClickHouse/pull/34733) ([Raúl Marín](https://github.com/Algunenano))。
- 当键为原生整数类型时,提高 ASOF JOIN 的性能。[#35525](https://github.com/ClickHouse/ClickHouse/pull/35525) ([Maksim Kita](https://github.com/kitaisreal))。
- 并行化多部分上传到 S3 存储。[#35343](https://github.com/ClickHouse/ClickHouse/pull/35343) ([Sergei Trifonov](https://github.com/serxa))。
- 如果端点支持 HTTP Range,URL 存储引擎现在可以并行下载多个数据块。新增了两个设置 `max_download_threads` 和 `max_download_buffer_size`,分别用于控制单个查询可用于下载文件的最大线程数以及每个线程可处理的最大字节数。[#35150](https://github.com/ClickHouse/ClickHouse/pull/35150) ([Antonio Andelic](https://github.com/antonio2368))。
- 使用多线程从 S3 下载对象。可以使用 `max_download_threads` 和 `max_download_buffer_size` 设置控制下载行为。[#35571](https://github.com/ClickHouse/ClickHouse/pull/35571) ([Antonio Andelic](https://github.com/antonio2368))。
- 与 HDFS 交互时缩小互斥锁范围。相关问题:[#35292](https://github.com/ClickHouse/ClickHouse/issues/35292)。[#35646](https://github.com/ClickHouse/ClickHouse/pull/35646) ([shuchaome](https://github.com/shuchaome))。
- 仅在表级 TTL 发生更改时才需要执行变更操作。[#35953](https://github.com/ClickHouse/ClickHouse/pull/35953) ([Azat Khuzhin](https://github.com/azat))。

#### 改进 {#improvement-8}


* 对模式推断进行了多项改进。使用一些调整和启发式方法来在 CSV、TSV 和 TSVRaw 数据格式中判断数字、字符串、数组、元组和 Map。为 CSV 格式添加了设置 `input_format_csv_use_best_effort_in_schema_inference`，用于开启/关闭这些启发式方法；如果关闭，则将所有内容视为字符串。为 TSV/TSVRaw 格式添加了类似的设置 `input_format_tsv_use_best_effort_in_schema_inference`。这些设置默认启用。- 为 Values 格式的模式推断添加了 Map 支持。- 修复了 Values 格式模式推断中可能出现的段错误。- 允许在 Arrow/ORC/Parquet 格式中跳过具有不受支持类型的列。为此添加了对应设置：`input_format_{parquet|orc|arrow}_skip_columns_with_unsupported_types_in_schema_inference`。这些设置默认禁用。- 允许在 Arrow/Parquet 格式中将类型为 Null 的列转换为包含全部 NULL 值的 Nullable 列。- 允许通过设置 `column_names_for_schema_inference`，为不包含列名的格式（如 CSV、TSV、JSONCompactEachRow 等）在模式推断中指定列名。- 修复了 ORC/Arrow/Parquet 格式在处理 Nullable 列时的模式推断问题。此前所有推断出的类型都不是 Nullable，这会阻止从数据中读取 Nullable 列；现在已修复，所有推断出的类型始终为 Nullable（因为仅通过读取 schema 无法判断列是否为 Nullable）。- 修复了在使用 CSV 转义规则的 Template 格式中的模式推断问题。[#35582](https://github.com/ClickHouse/ClickHouse/pull/35582)（[Kruglov Pavel](https://github.com/Avogar)）。
* 为 `JSONAsObject` 格式添加并行解析和模式推断。[#35592](https://github.com/ClickHouse/ClickHouse/pull/35592) ([Anton Popov](https://github.com/CurtizJ)).
* 为 `s3Cluster` 表函数添加了自动 schema 推断支持，使其与 `s3` 的签名保持一致。[#35544](https://github.com/ClickHouse/ClickHouse/pull/35544) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 为 `hdfsCluster` 添加了架构推断支持。[#35602](https://github.com/ClickHouse/ClickHouse/pull/35602) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 新增设置 `input_format_json_read_bools_as_numbers`，允许在 JSON 输入格式中将 bool 推断并解析为数字。默认启用。由 @alexey-milovidov 建议。 [#35735](https://github.com/ClickHouse/ClickHouse/pull/35735) ([Kruglov Pavel](https://github.com/Avogar)).
* 改进对 TSKV 和 JSONEachRow 格式进行模式推断时的列顺序，修复 [#35640](https://github.com/ClickHouse/ClickHouse/issues/35640)。在对 TSKV 和 JSONEachRow 格式进行模式推断时，读取到空行时不要停止模式推断。[#35724](https://github.com/ClickHouse/ClickHouse/pull/35724) ([Kruglov Pavel](https://github.com/Avogar))。
* 添加设置 `input_format_orc_case_insensitive_column_matching`、`input_format_arrow_case_insensitive_column_matching` 和 `input_format_parquet_case_insensitive_column_matching`，使 ClickHouse 在从 ORC、Arrow 或 Parquet 文件读取数据时可以使用不区分大小写的列名匹配。[#35459](https://github.com/ClickHouse/ClickHouse/pull/35459)（[Antonio Andelic](https://github.com/antonio2368)）。
* 向 `system.query_log` 添加了 `is_secure` 列，用于指示客户端是否通过 TCP 或 HTTP 使用安全连接。[#35705](https://github.com/ClickHouse/ClickHouse/pull/35705)（[Antonio Andelic](https://github.com/antonio2368)）。
* 现在在低资源机器（物理核心少于 16 个）上，`kafka_num_consumers` 可以设置为大于物理核心数量的值。[#35926](https://github.com/ClickHouse/ClickHouse/pull/35926) ([alesapin](https://github.com/alesapin))。
* 为 `engine=Kafka` 表添加了一些基础监控指标。 [#35916](https://github.com/ClickHouse/ClickHouse/pull/35916) ([filimonov](https://github.com/filimonov)).
* 现在不允许在 MergeTree 引擎系列中对不存在的设置执行 `ALTER TABLE ... RESET SETTING`。修复了 [#35816](https://github.com/ClickHouse/ClickHouse/issues/35816)。[#35884](https://github.com/ClickHouse/ClickHouse/pull/35884)（[alesapin](https://github.com/alesapin)）。
* 现在，针对 `Arrays` 和 `Nullable` 类型的部分 `ALTER MODIFY COLUMN` 查询可以仅在元数据层完成，而无需执行 mutation。比如，将 `Array(Enum8('Option1'=1))` 修改为 `Array(Enum8('Option1'=1, 'Option2'=2))`。 [#35882](https://github.com/ClickHouse/ClickHouse/pull/35882) ([alesapin](https://github.com/alesapin))。
* 为沙漏图标添加了动画效果，以提示用户查询正在运行。[#35860](https://github.com/ClickHouse/ClickHouse/pull/35860) ([peledni](https://github.com/peledni))。
* 支持 `ALTER TABLE t DETACH PARTITION (ALL)`。 [#35794](https://github.com/ClickHouse/ClickHouse/pull/35794) ([awakeljw](https://github.com/awakeljw))。
* 改进投影分析，以优化诸如 `count()` 之类的简单查询。 [#35788](https://github.com/ClickHouse/ClickHouse/pull/35788) ([Amos Bird](https://github.com/amosbird)).
* 为使用 `input` 表函数的 insert select 提供模式推断支持。对于支持模式推断的表函数执行 insert select 时，从插入目标表获取模式，而不是从数据中推断模式。修复 [#35639](https://github.com/ClickHouse/ClickHouse/issues/35639)。[#35760](https://github.com/ClickHouse/ClickHouse/pull/35760)（[Kruglov Pavel](https://github.com/Avogar)）。
* 对 Hive 表生效 `remote_url_allow_hosts` 设置。 [#35743](https://github.com/ClickHouse/ClickHouse/pull/35743) ([李扬](https://github.com/taiyang-li)).
* 为 clickhouse-local 实现 `send_logs_level`。修复 [#35653](https://github.com/ClickHouse/ClickHouse/issues/35653)。[#35716](https://github.com/ClickHouse/ClickHouse/pull/35716)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复 [#35641](https://github.com/ClickHouse/ClickHouse/issues/35641)，允许在没有显式默认表达式的情况下使用 `EPHEMERAL` 列。[#35706](https://github.com/ClickHouse/ClickHouse/pull/35706)（[Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)）。
* 添加 `AsyncInsertBytes` profile event 计数器，用于统计异步 `INSERT` 的字节大小。[#35644](https://github.com/ClickHouse/ClickHouse/pull/35644) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* 改进 JOIN 的管道描述。[#35612](https://github.com/ClickHouse/ClickHouse/pull/35612)（[何李夫](https://github.com/helifu)）。
* 推导绝对 hdfs 配置路径。 [#35572](https://github.com/ClickHouse/ClickHouse/pull/35572) ([李扬](https://github.com/taiyang-li)).
* 改进 `clickhouse-client` 的粘贴性能和兼容性。这有助于解决 [#35501](https://github.com/ClickHouse/ClickHouse/issues/35501)。[#35541](https://github.com/ClickHouse/ClickHouse/pull/35541)（[Amos Bird](https://github.com/amosbird)）。
* 在分布式查询中，如果在解析嵌套层级非常深的数据类型时（至少在 debug 构建中），启用了 `async_socket_for_remote` 和 `use_hedged_requests` 这两个设置中的任意一个，就有可能导致栈溢出。修复了 [#35509](https://github.com/ClickHouse/ClickHouse/issues/35509)。[#35524](https://github.com/ClickHouse/ClickHouse/pull/35524)（[Kruglov Pavel](https://github.com/Avogar)）。
* 在 `system.parts_columns` 表中新增子列大小。[#35488](https://github.com/ClickHouse/ClickHouse/pull/35488)（[Anton Popov](https://github.com/CurtizJ)）。
* 在查询计划和管道的扫描节点中添加显式表信息。 [#35460](https://github.com/ClickHouse/ClickHouse/pull/35460) ([何李夫](https://github.com/helifu)).
* 允许服务器绑定到低号端口（例如 443）。ClickHouse 安装脚本会为该二进制文件设置 `cap_net_bind_service`。[#35451](https://github.com/ClickHouse/ClickHouse/pull/35451) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* 修复 `INSERT INTO table FROM INFILE`：之前不会显示进度条。[#35429](https://github.com/ClickHouse/ClickHouse/pull/35429) ([xiedeyantu](https://github.com/xiedeyantu))。
* 为 `clickhouse-diagnostics` 工具新增 `--user`、`--password`、`--host`、`--port` 参数。[#35422](https://github.com/ClickHouse/ClickHouse/pull/35422) ([李扬](https://github.com/taiyang-li))。
* 为 Postgres 引擎提供 `uuid` 支持。修复 [#35384](https://github.com/ClickHouse/ClickHouse/issues/35384)。[#35403](https://github.com/ClickHouse/ClickHouse/pull/35403)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 对于表函数 `s3cluster`、`HDFSCluster` 或 `hive`，我们无法通过 `StorageFactory::instance().getSourceAccessType(getStorageTypeName())` 获取正确的 `AccessType`。该 PR 对此进行了修复。[#35365](https://github.com/ClickHouse/ClickHouse/pull/35365)（[李扬](https://github.com/taiyang-li)）。
* 移除 clickhouse-client 的 `--testmode` 选项，并始终启用该模式。 [#35354](https://github.com/ClickHouse/ClickHouse/pull/35354) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 不允许在 clickhouse-keeper 中执行 `wchc` 操作（四字母命令）。[#35320](https://github.com/ClickHouse/ClickHouse/pull/35320) ([zhangyuli1](https://github.com/zhangyuli1)).
* 添加函数 `getTypeSerializationStreams`。对于指定类型（从列中检测得到），返回一个包含该类型所有序列化子流路径的数组。此函数主要供开发人员使用。[#35290](https://github.com/ClickHouse/ClickHouse/pull/35290)（[李扬](https://github.com/taiyang-li)）。
* 如果在集群配置中未指定 `port`，将使用默认服务器端口。此更改修复了 [#34769](https://github.com/ClickHouse/ClickHouse/issues/34769)。[#34772](https://github.com/ClickHouse/ClickHouse/pull/34772)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 在 Hive 引擎中为 ORC/Parquet 文件使用 `minmax` 索引。相关 PR: [https://github.com/ClickHouse/arrow/pull/10](https://github.com/ClickHouse/arrow/pull/10)。[#34631](https://github.com/ClickHouse/ClickHouse/pull/34631)（[李扬](https://github.com/taiyang-li)）。
* 系统日志表现在允许在 ENGINE 声明中指定 COMMENT。修复 [#33768](https://github.com/ClickHouse/ClickHouse/issues/33768)。[#34536](https://github.com/ClickHouse/ClickHouse/pull/34536)（[Maksim Kita](https://github.com/kitaisreal)）。
* 在按排序键顺序读取且指定了 `LIMIT` 的情况下，现已正确支持设置 `max_rows_to_read`。此前，即使查询实际需要读取的行数更少，也可能抛出 `Limit for rows or bytes to read exceeded` 异常。[#33230](https://github.com/ClickHouse/ClickHouse/pull/33230) ([Anton Popov](https://github.com/CurtizJ))。
* 仅遵循来自 cgroups 的配额和周期，忽略 shares（它们并不能真正限制可用 CPU 核心的数量）。 [#35815](https://github.com/ClickHouse/ClickHouse/pull/35815) ([filimonov](https://github.com/filimonov)).

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-8}

- 在功能测试中添加下一批随机化设置。[#35047](https://github.com/ClickHouse/ClickHouse/pull/35047) ([Kruglov Pavel](https://github.com/Avogar))。
- 在压力测试中添加向后兼容性检查。关闭 [#25088](https://github.com/ClickHouse/ClickHouse/issues/25088)。[#27928](https://github.com/ClickHouse/ClickHouse/pull/27928) ([Kruglov Pavel](https://github.com/Avogar))。
- 将包构建迁移到 `nfpm` - 弃用 `release` 脚本,改用 `packages/build` - 在 clickhouse/binary-builder 镜像中构建所有内容(清理:clickhouse/deb-builder) - 向 cmake 添加符号剥离(待办:使用 $prefix/lib/$bin_dir/clickhouse/$binary.debug) - 修复 DWARF 符号问题 - 添加 Alpine APK 包 - 将 `alien` 重命名为 `additional_pkgs`。[#33664](https://github.com/ClickHouse/ClickHouse/pull/33664) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- 为 Coverity 添加夜间扫描和上传。[#34895](https://github.com/ClickHouse/ClickHouse/pull/34895) ([Boris Kuschel](https://github.com/bkuschel))。
- 为 `clickhouse-keeper` 提供专用的小型包。[#35308](https://github.com/ClickHouse/ClickHouse/pull/35308) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- 使用 podman 运行失败:它提示两次指定了相同的卷。[#35978](https://github.com/ClickHouse/ClickHouse/pull/35978) ([Roman Nikonov](https://github.com/nic11))。
- contrib/krb5 构建配置的小幅改进。[#35832](https://github.com/ClickHouse/ClickHouse/pull/35832) ([Anton Kozlov](https://github.com/tonickkozlov))。
- 添加标签以识别每个镜像的构建任务。[#35583](https://github.com/ClickHouse/ClickHouse/pull/35583) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- 对 Python 代码应用 `black` 格式化程序并添加每次提交检查。[#35466](https://github.com/ClickHouse/ClickHouse/pull/35466) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- 重做 Alpine 镜像以使用干净的 Dockerfile。在 tests/ci 中创建脚本以构建 Ubuntu 和 Alpine 镜像。添加 clickhouse-keeper 镜像(抄送 @nikitamikhaylov)。向 PullRequestCI 添加构建检查。向 ReleaseCI 添加作业。向 MasterCI 添加作业,为每个合并的 PR 构建并推送 `clickhouse/clickhouse-server:head` 和 `clickhouse/clickhouse-keeper:head` 镜像。[#35211](https://github.com/ClickHouse/ClickHouse/pull/35211) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- 修复 CI 中的压力测试报告,现在我们只上传一次包含已启动压力测试信息的运行日志。[#35093](https://github.com/ClickHouse/ClickHouse/pull/35093) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- 切换到 LLVM 14 的 libcxx / libcxxabi。[#34906](https://github.com/ClickHouse/ClickHouse/pull/34906) ([Raúl Marín](https://github.com/Algunenano))。
- 更新 unixodbc 以缓解 CVE-2018-7485。注意:此 CVE 与 ClickHouse 无关,因为它为 ODBC 实现了自己的隔离层。[#35943](https://github.com/ClickHouse/ClickHouse/pull/35943) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。

#### 错误修复 {#bug-fix-4}


* 新增设置 `input_format_ipv4_default_on_conversion_error`、`input_format_ipv6_default_on_conversion_error`，用于在插入数据时在转换出错的情况下，将无效的 IP 地址值按默认值写入表中。修复 [#35726](https://github.com/ClickHouse/ClickHouse/issues/35726)。[#35733](https://github.com/ClickHouse/ClickHouse/pull/35733)（[Maksim Kita](https://github.com/kitaisreal)）。
* 在从 Hive 读取数据时，如果某列不存在，则避免尝试从数据块中删除该列。[#35393](https://github.com/ClickHouse/ClickHouse/pull/35393) ([lgbo](https://github.com/lgbo-ustc)).
* 在创建物化视图时添加类型检查。关闭：[#23684](https://github.com/ClickHouse/ClickHouse/issues/23684)。[#24896](https://github.com/ClickHouse/ClickHouse/pull/24896)（[hexiaoting](https://github.com/hexiaoting)）。
* 修复 `INSERT INFILE` 查询的格式（缺少引号）。[#35886](https://github.com/ClickHouse/ClickHouse/pull/35886)（[Azat Khuzhin](https://github.com/azat)）。
* 由于模糊测试发现了内存安全问题，已禁用 `session_log`。参见 [#35714](https://github.com/ClickHouse/ClickHouse/issues/35714)。[#35873](https://github.com/ClickHouse/ClickHouse/pull/35873)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 避免对每列的 `TTL` 进行重复处理。[#35820](https://github.com/ClickHouse/ClickHouse/pull/35820)（[Azat Khuzhin](https://github.com/azat)）。
* 修复在 `INSERT` 查询中包含来自多个分区的数据时，对 `Object` 类型列的插入问题。 [#35806](https://github.com/ClickHouse/ClickHouse/pull/35806) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了 -WithNames 格式中未提供列的索引处理中的一个错误，该错误在列数超过 256 时会导致 `INCORRECT_NUMBER_OF_COLUMNS`。修复问题 [#35793](https://github.com/ClickHouse/ClickHouse/issues/35793)。[#35803](https://github.com/ClickHouse/ClickHouse/pull/35803)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复了 [#35751](https://github.com/ClickHouse/ClickHouse/issues/35751)。[#35799](https://github.com/ClickHouse/ClickHouse/pull/35799)（[Nikolay Degterinsky](https://github.com/evillique)）。
* 修复以 Snappy 格式从 HDFS 读取数据时的问题。[#35771](https://github.com/ClickHouse/ClickHouse/pull/35771) ([shuchaome](https://github.com/shuchaome)).
* 修复了从自定义类型转换为字符串时可能导致段错误或意外错误消息的缺陷。关闭 [#35752](https://github.com/ClickHouse/ClickHouse/issues/35752)。[#35755](https://github.com/ClickHouse/ClickHouse/pull/35755) ([Kruglov Pavel](https://github.com/Avogar))。
* 修复 `ANY`/`ALL`（子查询）实现。关闭 [#35489](https://github.com/ClickHouse/ClickHouse/issues/35489)。[#35727](https://github.com/ClickHouse/ClickHouse/pull/35727)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在 `clickhouse-local` 中无法删除非空数据库的问题。关闭 [#35692](https://github.com/ClickHouse/ClickHouse/issues/35692)。[#35711](https://github.com/ClickHouse/ClickHouse/pull/35711)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复了在服务器重启后创建带子查询的 `materialized view` 时的错误。服务器重启后，对底层表进行插入操作时，`materialized view` 无法更新。修复了 [#35511](https://github.com/ClickHouse/ClickHouse/issues/35511)。[#35691](https://github.com/ClickHouse/ClickHouse/pull/35691) ([Kruglov Pavel](https://github.com/Avogar))。
* 修复在读取实验特性类型 `Object` 的子列时可能出现的 `Can't adjust last granule` 异常。[#35687](https://github.com/ClickHouse/ClickHouse/pull/35687) ([Anton Popov](https://github.com/CurtizJ)).
* 默认启用支持 JIT 编译的构建。 [#35683](https://github.com/ClickHouse/ClickHouse/pull/35683) ([Maksim Kita](https://github.com/kitaisreal)).
* 修复实验性类型 `Object` 中可能出现的子列丢失问题。[#35682](https://github.com/ClickHouse/ClickHouse/pull/35682)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复对 ASOF JOIN 键可空性检查的问题，关闭 [#35565](https://github.com/ClickHouse/ClickHouse/issues/35565)。[#35674](https://github.com/ClickHouse/ClickHouse/pull/35674)（[Vladimir C](https://github.com/vdimir)）。
* 修复带有 projection 的数据分片的校验逻辑。当 projection 与主分片类型不同时会触发错误。该问题与 [https://github.com/ClickHouse/ClickHouse/pull/33774](https://github.com/ClickHouse/ClickHouse/pull/33774) 类似。此 bug 由 @caoyang10 修复。[#35667](https://github.com/ClickHouse/ClickHouse/pull/35667)（[Amos Bird](https://github.com/amosbird)）。
* 修复在向 `format` 函数传入大量参数时导致的服务器崩溃问题。请参考测试文件，了解如何复现该崩溃。[#35651](https://github.com/ClickHouse/ClickHouse/pull/35651) ([Amos Bird](https://github.com/amosbird))。
* 修复异步插入场景下配额的使用问题。 [#35645](https://github.com/ClickHouse/ClickHouse/pull/35645) ([Anton Popov](https://github.com/CurtizJ)).
* 修复带有别名的位置参数。修复 [#35600](https://github.com/ClickHouse/ClickHouse/issues/35600)。[#35620](https://github.com/ClickHouse/ClickHouse/pull/35620)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在 URL 引擎中进行 schema 推断前检查 `remote_url_allow_hosts`，修复了 [#35064](https://github.com/ClickHouse/ClickHouse/issues/35064)。[#35619](https://github.com/ClickHouse/ClickHouse/pull/35619)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复在使用 `LowCardinality` 类型列时的 `HashJoin`。此更改关闭了 [#35548](https://github.com/ClickHouse/ClickHouse/issues/35548)。[#35616](https://github.com/ClickHouse/ClickHouse/pull/35616)（[Antonio Andelic](https://github.com/antonio2368)）。
* 修复了 MaterializedPostgreSQL 中可能出现的段错误：当将收集在内存中的数据同步到底层表时，如果发生异常，会导致该问题。关闭关联的 [#35611](https://github.com/ClickHouse/ClickHouse/issues/35611)。[#35614](https://github.com/ClickHouse/ClickHouse/pull/35614)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 当之前分离的表仍在使用时，为 `ATTACH TABLE` 查询设置 `database_atomic_wait_for_drop_and_detach_synchronously` 会导致行为不正确，现已修复。 [#35594](https://github.com/ClickHouse/ClickHouse/pull/35594) ([tavplubix](https://github.com/tavplubix)).
* 修复使用命名集合时的 HTTP 请求头，并添加 `compression_method`。关闭 [#35273](https://github.com/ClickHouse/ClickHouse/issues/35273)。关闭 [#35269](https://github.com/ClickHouse/ClickHouse/issues/35269)。[#35593](https://github.com/ClickHouse/ClickHouse/pull/35593)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复 s3 引擎获取虚拟列的方式。关闭 [#35411](https://github.com/ClickHouse/ClickHouse/issues/35411)。[#35586](https://github.com/ClickHouse/ClickHouse/pull/35586)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复了 `caseWithExpression` 的返回类型推导。现在会正确考虑 ELSE 分支的类型。[#35576](https://github.com/ClickHouse/ClickHouse/pull/35576)（[Antonio Andelic](https://github.com/antonio2368)）。
* 修复长度超过 39 个字符的 IPv6 地址的解析问题。关闭 [#34022](https://github.com/ClickHouse/ClickHouse/issues/34022)。[#35539](https://github.com/ClickHouse/ClickHouse/pull/35539)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复了在 `IN` 子句中将值转换为 IPv4、IPv6 地址的行为。修复了 [#35528](https://github.com/ClickHouse/ClickHouse/issues/35528)。[#35534](https://github.com/ClickHouse/ClickHouse/pull/35534)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复在短路函数求值时，当某个参数为可空常量时发生的崩溃。修复 [#35497](https://github.com/ClickHouse/ClickHouse/issues/35497)。修复 [#35496](https://github.com/ClickHouse/ClickHouse/issues/35496)。[#35502](https://github.com/ClickHouse/ClickHouse/pull/35502)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复函数 `throwIf` 在使用常量参数时导致的崩溃。[#35500](https://github.com/ClickHouse/ClickHouse/pull/35500)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复 Keeper 中可能导致客户端连接不稳定的 bug。该问题首次出现于 [#35031](https://github.com/ClickHouse/ClickHouse/issues/35031)。[#35498](https://github.com/ClickHouse/ClickHouse/pull/35498)（[alesapin](https://github.com/alesapin)）。
* 修复函数 `if` 中的一个错误：当结果列类型与结果数据类型不一致时，会导致诸如 `Logical error: 'Bad cast from type DB::ColumnVector<int> to DB::ColumnVector<long>'.` 之类的逻辑错误。修复了 [#35367](https://github.com/ClickHouse/ClickHouse/issues/35367)。[#35476](https://github.com/ClickHouse/ClickHouse/pull/35476)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复在将 S3 用作 MergeTree 后端或作为单独的表引擎/函数时过度日志记录的问题。修复了 [#30559](https://github.com/ClickHouse/ClickHouse/issues/30559)。[#35434](https://github.com/ClickHouse/ClickHouse/pull/35434)（[alesapin](https://github.com/alesapin)）。
* 现在使用零拷贝复制（实验特性）执行的合并将不再在日志中频繁输出如下消息：`Found parts with the same min block and with the same max block as the missing part _ on replica _. Hoping that it will eventually appear as a result of a merge.`。 [#35430](https://github.com/ClickHouse/ClickHouse/pull/35430) ([alesapin](https://github.com/alesapin)).
* 如果在 GroupingAggregatedTransform 中出现空块，则跳过可能发生的异常。 [#35417](https://github.com/ClickHouse/ClickHouse/pull/35417) ([Nikita Taranov](https://github.com/nickitat)).
* 修复在 Arrow/Parquet/ORC 格式中处理查询中不需要的列的方式，避免在文件包含不受支持类型的列但查询中并未使用该列时出现类似 `Unsupported &lt;format&gt; type &lt;type&gt; of an input column &lt;column_name&gt;` 的潜在错误。 [#35406](https://github.com/ClickHouse/ClickHouse/pull/35406) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复在极端场景下高并发访问时远程文件系统本地缓存（实验特性）的问题。 [#35381](https://github.com/ClickHouse/ClickHouse/pull/35381) ([Kseniia Sumarokova](https://github.com/kssenii))。修复缓存中可能出现的死锁问题。 [#35378](https://github.com/ClickHouse/ClickHouse/pull/35378) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 修复在 `WHERE` 子句中与常量比较时的分区裁剪问题。如果列与常量的数据类型不同，则可能发生溢出，查询可能会错误地返回空结果。修复了 [#35304](https://github.com/ClickHouse/ClickHouse/issues/35304)。[#35334](https://github.com/ClickHouse/ClickHouse/pull/35334)（[Amos Bird](https://github.com/amosbird)）。
* 在使用较小的 `max_read_buffer_size` 时修复 `TSKV` 格式的 schema 推断。 [#35332](https://github.com/ClickHouse/ClickHouse/pull/35332) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复在启用稀疏列的表上的变更操作。 [#35284](https://github.com/ClickHouse/ClickHouse/pull/35284) ([Anton Popov](https://github.com/CurtizJ)).
* 默认情况下不再延迟最终部分的写入（通过添加 `max_insert_delayed_streams_for_parallel_write`，对写入 S3 的情况默认设为 1000，其它情况则像之前一样保持禁用，从而修复 `INSERT` 期间可能出现的 `Memory limit exceeded`）。 [#34780](https://github.com/ClickHouse/ClickHouse/pull/34780) ([Azat Khuzhin](https://github.com/azat)).

### <a id="223"></a> ClickHouse 版本 v22.3-lts, 2022-03-17 {#a-id223a-clickhouse-release-v223-lts-2022-03-17}

#### 向后不兼容的变更 {#backward-incompatible-change-6}

- 使 `arrayCompact` 函数的行为与其他高阶函数保持一致:对原始数组执行压缩操作,而不是对 lambda 函数的结果执行压缩。如果您在 arrayCompact 中使用了非平凡的 lambda 函数,可以通过将 `arrayCompact` 的参数包装到 `arrayMap` 中来恢复旧行为。关闭 [#34010](https://github.com/ClickHouse/ClickHouse/issues/34010) [#18535](https://github.com/ClickHouse/ClickHouse/issues/18535) [#14778](https://github.com/ClickHouse/ClickHouse/issues/14778)。[#34795](https://github.com/ClickHouse/ClickHouse/pull/34795) ([Alexandre Snarskii](https://github.com/snar))。
- 更改 `toDatetime` 函数溢出时的实现特定行为。溢出时将饱和到 datetime 支持的最近的最小/最大时刻,而不是回绕。此更改被标记为"向后不兼容",因为可能有人无意中依赖了旧行为。[#32898](https://github.com/ClickHouse/ClickHouse/pull/32898) ([HaiBo Li](https://github.com/marising))。
- 使函数 `cast(value, 'IPv4')` 和 `cast(value, 'IPv6')` 的行为与 `toIPv4` 和 `toIPv6` 函数相同。更改了传入函数 `toIPv4` 和 `toIPv6` 的错误 IP 地址的行为,现在如果将无效 IP 地址传入这些函数将抛出异常,而之前这些函数会返回默认值。新增了函数 `IPv4StringToNumOrDefault`、`IPv4StringToNumOrNull`、`IPv6StringToNumOrDefault`、`IPv6StringOrNull`、`toIPv4OrDefault`、`toIPv4OrNull`、`toIPv6OrDefault`、`toIPv6OrNull`。如果之前的逻辑依赖于 `IPv4StringToNum`、`toIPv4`、`toIPv6` 对无效地址返回默认值,则应使用函数 `IPv4StringToNumOrDefault`、`toIPv4OrDefault`、`toIPv6OrDefault`。新增了设置 `cast_ipv4_ipv6_default_on_conversion_error`,如果启用此设置,则 IP 地址转换函数将保持之前的行为。关闭 [#22825](https://github.com/ClickHouse/ClickHouse/issues/22825)。关闭 [#5799](https://github.com/ClickHouse/ClickHouse/issues/5799)。关闭 [#35156](https://github.com/ClickHouse/ClickHouse/issues/35156)。[#35240](https://github.com/ClickHouse/ClickHouse/pull/35240) ([Maksim Kita](https://github.com/kitaisreal))。

#### 新功能 {#new-feature-9}


- 支持为远程文件系统在本地缓存数据。可为 `s3` 磁盘启用此功能。关闭 [#28961](https://github.com/ClickHouse/ClickHouse/issues/28961)。[#33717](https://github.com/ClickHouse/ClickHouse/pull/33717) ([Kseniia Sumarokova](https://github.com/kssenii))。同时,我们在 s3 文件系统上启用了测试套件,不再存在已知问题,因此已开始达到生产就绪状态。
- 新增表函数 `hive`。使用方式如下:`hive('<hive metastore url>', '<hive database>', '<hive table name>', '<columns definition>', '<partition columns>')`,例如 `SELECT * FROM hive('thrift://hivetest:9083', 'test', 'demo', 'id Nullable(String), score Nullable(Int32), day Nullable(String)', 'day')`。[#34946](https://github.com/ClickHouse/ClickHouse/pull/34946) ([lgbo](https://github.com/lgbo-ustc))。
- 支持通过 X.509 证书对经由 SSL 连接的用户进行身份验证。[#31484](https://github.com/ClickHouse/ClickHouse/pull/31484) ([eungenue](https://github.com/eungenue))。
- 支持向表函数 `file`/`hdfs`/`s3`/`url` 插入数据时进行模式推断。[#34732](https://github.com/ClickHouse/ClickHouse/pull/34732) ([Kruglov Pavel](https://github.com/Avogar))。
- 现在可以读取 `system.zookeeper` 表而不受路径限制或使用 `like` 表达式。此类读取可能会对 ZooKeeper 产生较大负载,因此要启用此功能,必须启用 `allow_unrestricted_reads_from_keeper` 设置。[#34609](https://github.com/ClickHouse/ClickHouse/pull/34609) ([Sergei Trifonov](https://github.com/serxa))。
- 在 clickhouse-local 中显示 CPU 和内存指标。关闭 [#34545](https://github.com/ClickHouse/ClickHouse/issues/34545)。[#34605](https://github.com/ClickHouse/ClickHouse/pull/34605) ([李扬](https://github.com/taiyang-li))。
- 为数组实现 `startsWith` 和 `endsWith` 函数,关闭 [#33982](https://github.com/ClickHouse/ClickHouse/issues/33982)。[#34368](https://github.com/ClickHouse/ClickHouse/pull/34368) ([usurai](https://github.com/usurai))。
- 为 Map 数据类型新增三个函数:1. `mapReplace(map1, map2)` - 用 map2 中对应键的值替换 map1 中键的值;添加 map1 中不存在但 map2 中存在的键。2. `mapFilter` 3. `mapMap`。mapFilter 和 mapMap 是高阶函数,接受两个参数,第一个参数是以 k、v 键值对作为参数的 lambda 函数,第二个参数是 Map 类型的列。[#33698](https://github.com/ClickHouse/ClickHouse/pull/33698) ([hexiaoting](https://github.com/hexiaoting))。
- 允许从 `CLICKHOUSE_USER` 和 `CLICKHOUSE_PASSWORD` 环境变量获取 clickhouse-client 的默认用户名和密码。关闭 [#34538](https://github.com/ClickHouse/ClickHouse/issues/34538)。[#34947](https://github.com/ClickHouse/ClickHouse/pull/34947) ([DR](https://github.com/freedomDR))。

#### 实验性功能 {#experimental-feature-8}

- 新增数据类型 `Object(<schema_format>)`,支持存储半结构化数据(目前仅支持 JSON)。数据以字符串形式写入此类型。然后根据半结构化数据的格式提取所有路径,并以能够存储所有值的最优类型写入单独的列。可以通过与源数据中路径匹配的名称查询这些列。例如 `data.key1.key2` 或使用类型转换操作符 `data.key1.key2::Int64`。
- 新增 `database_replicated_allow_only_replicated_engine` 设置。启用后,仅允许在 `Replicated` 数据库中创建 `Replicated` 表或使用无状态引擎的表。[#35214](https://github.com/ClickHouse/ClickHouse/pull/35214) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。请注意,`Replicated` 数据库仍然是实验性功能。

#### 性能改进 {#performance-improvement-9}


- 通过优化排序提升向 `MergeTree` 表插入数据的性能。在实际基准测试中观察到最高可达 2 倍的性能提升。[#34750](https://github.com/ClickHouse/ClickHouse/pull/34750) ([Maksim Kita](https://github.com/kitaisreal))。
- 从 URL 和 S3 读取 Parquet、ORC 和 Arrow 文件时支持列裁剪。关闭 [#34163](https://github.com/ClickHouse/ClickHouse/issues/34163)。[#34849](https://github.com/ClickHouse/ClickHouse/pull/34849) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 从 Hive 读取 Parquet、ORC 和 Arrow 文件时支持列裁剪。[#34954](https://github.com/ClickHouse/ClickHouse/pull/34954) ([lgbo](https://github.com/lgbo-ustc))。
- 来自性能优化专家的一系列性能优化。提升处理包含大型 `IN` 子句的查询的性能。当 `direct` 字典的数据源为 `ClickHouse` 时提升其性能。提升 `detectCharset`、`detectLanguageUnknown` 函数的性能。[#34888](https://github.com/ClickHouse/ClickHouse/pull/34888) ([Maksim Kita](https://github.com/kitaisreal))。
- 通过增加批处理提升 `any` 聚合函数的性能。[#34760](https://github.com/ClickHouse/ClickHouse/pull/34760) ([Raúl Marín](https://github.com/Algunenano))。
- `clickhouse-keeper` 的多项性能改进:减少锁竞争 [#35010](https://github.com/ClickHouse/ClickHouse/pull/35010) ([zhanglistar](https://github.com/zhanglistar)),通过流式读写快照而非完整复制来降低内存使用 [#34584](https://github.com/ClickHouse/ClickHouse/pull/34584) ([zhanglistar](https://github.com/zhanglistar)),优化 RAFT 实现中日志存储的压缩 [#34534](https://github.com/ClickHouse/ClickHouse/pull/34534) ([zhanglistar](https://github.com/zhanglistar)),内部数据结构的版本控制 [#34486](https://github.com/ClickHouse/ClickHouse/pull/34486) ([zhanglistar](https://github.com/zhanglistar))。

#### 改进 {#improvement-9}


* 允许对表函数进行异步插入。修复 [#34864](https://github.com/ClickHouse/ClickHouse/issues/34864)。 [#34866](https://github.com/ClickHouse/ClickHouse/pull/34866) ([Anton Popov](https://github.com/CurtizJ))。
* 为函数 `dictGetHierarchy`、`dictIsIn`、`dictGetChildren`、`dictGetDescendants` 的 key 参数添加隐式类型转换。修复 [#34970](https://github.com/ClickHouse/ClickHouse/issues/34970)。[#35027](https://github.com/ClickHouse/ClickHouse/pull/35027)（[Maksim Kita](https://github.com/kitaisreal)）。
* `EXPLAIN AST` 查询可以以 Graphviz 格式的图形方式输出 AST：`EXPLAIN AST graph = 1 SELECT * FROM system.parts`。 [#35173](https://github.com/ClickHouse/ClickHouse/pull/35173) ([李扬](https://github.com/taiyang-li))。
* 使用 `s3` 表函数或表引擎写入大文件时，由于 AWS SDK 中的一个缺陷，这些文件的内容类型被错误地设置为 `application/xml`。此更改修复了 [#33964](https://github.com/ClickHouse/ClickHouse/issues/33964)。[#34433](https://github.com/ClickHouse/ClickHouse/pull/34433)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 对限制型行策略进行了部分调整，使其在简单场景下更容易作为宽松型策略的替代方案。如果某个表仅存在限制型策略（没有宽松型策略），用户仍然可以看到部分行。另外，`SHOW CREATE ROW POLICY` 在行策略定义中将始终显示 `AS permissive` 或 `AS restrictive`。[#34596](https://github.com/ClickHouse/ClickHouse/pull/34596)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 改进 File/S3/HDFS/URL 引擎中使用通配符的 schema 推断机制。在出错时尝试使用下一个路径进行 schema 推断。[#34465](https://github.com/ClickHouse/ClickHouse/pull/34465)（[Kruglov Pavel](https://github.com/Avogar)）。
* Play UI 现在可以从操作系统中正确检测首选的亮色/暗色主题。[#35068](https://github.com/ClickHouse/ClickHouse/pull/35068) ([peledni](https://github.com/peledni))。
* 添加了 `date_time_input_format = 'best_effort_us'`。修复了 [#34799](https://github.com/ClickHouse/ClickHouse/issues/34799)。[#34982](https://github.com/ClickHouse/ClickHouse/pull/34982)（[WenYao](https://github.com/Cai-Yao)）。
* 在服务器配置中新增了名为 `allow_plaintext_password` 和 `allow_no_password` 的设置，用于开启或关闭在某些环境下在特定环境中可能不够安全的认证类型。默认情况下它们是启用的。 [#34738](https://github.com/ClickHouse/ClickHouse/pull/34738) ([Heena Bansal](https://github.com/HeenaBansal2009)).
* 在 `Arrow` 格式中增加对 `DateTime64` 数据类型的支持，修复 [#8280](https://github.com/ClickHouse/ClickHouse/issues/8280) 和 [#28574](https://github.com/ClickHouse/ClickHouse/issues/28574)。[#34561](https://github.com/ClickHouse/ClickHouse/pull/34561)（[李扬](https://github.com/taiyang-li)）。
* 在配置更新时重新加载 `remote_url_allow_hosts`（用于过滤出站连接）。[#35294](https://github.com/ClickHouse/ClickHouse/pull/35294) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 为 `clickhouse-local` 增加对 `--testmode` 参数的支持。该参数用于解析我们在功能测试中使用的测试提示。 [#35264](https://github.com/ClickHouse/ClickHouse/pull/35264) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 在查询日志中添加 `distributed_depth`。它类似于 `is_initial_query` 的更细化版本 [#35207](https://github.com/ClickHouse/ClickHouse/pull/35207) ([李扬](https://github.com/taiyang-li))。
* 在 `MySQL` 和 `PostgreSQL` 表函数中遵循 `remote_url_allow_hosts` 设置。[#35191](https://github.com/ClickHouse/ClickHouse/pull/35191) ([Heena Bansal](https://github.com/HeenaBansal2009))。
* 在 `system.part_log` 中新增了 `disk_name` 字段。 [#35178](https://github.com/ClickHouse/ClickHouse/pull/35178) ([Artyom Yurkov](https://github.com/Varinara)).
* 在查询远程 URL 时，不要对不可重试的错误进行重试。关闭 [#35161](https://github.com/ClickHouse/ClickHouse/issues/35161)。[#35172](https://github.com/ClickHouse/ClickHouse/pull/35172)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 支持在 `view()` 表函数中使用分布式 INSERT SELECT 查询（通过设置 `parallel_distributed_insert_select`）。 [#35132](https://github.com/ClickHouse/ClickHouse/pull/35132) ([Azat Khuzhin](https://github.com/azat)).
* 在向包含 `AggregateFunction` 的 `Buffer` 执行 `INSERT` 时，实现了更精确的内存跟踪。[#35072](https://github.com/ClickHouse/ClickHouse/pull/35072) ([Azat Khuzhin](https://github.com/azat))。
* 在 Linux 内核存在 bug 的情况下，避免在 Query Profiler 中发生除零错误。关闭 [#34787](https://github.com/ClickHouse/ClickHouse/issues/34787)。[#35032](https://github.com/ClickHouse/ClickHouse/pull/35032)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 为 keeper 配置增加更多健全性检查：现在不允许混用 `localhost` 和非本地服务器，并且增加了对内部 Raft 端口与 keeper 客户端端口是否相同的检查。 [#35004](https://github.com/ClickHouse/ClickHouse/pull/35004) ([alesapin](https://github.com/alesapin)).
* 当前，如果用户更改系统表的设置，将会产生成批的日志，并且 ClickHouse 每分钟都会重命名这些表。此更改修复了 [#34929](https://github.com/ClickHouse/ClickHouse/issues/34929)。[#34949](https://github.com/ClickHouse/ClickHouse/pull/34949)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 为 Hive metastore 客户端启用连接池。 [#34940](https://github.com/ClickHouse/ClickHouse/pull/34940) ([lgbo](https://github.com/lgbo-ustc)).
* 在 `CREATE TABLE AS` 中，如果新表引擎不支持按列 `TTL`（即该引擎不属于 `MergeTree` 系列），则会忽略按列 `TTL`。 [#34938](https://github.com/ClickHouse/ClickHouse/pull/34938) ([Azat Khuzhin](https://github.com/azat)).
* 允许在 `ngrambf_v1`/`tokenbf_v1` 索引中使用 `LowCardinality` 字符串。修复 [#21865](https://github.com/ClickHouse/ClickHouse/issues/21865)。[#34911](https://github.com/ClickHouse/ClickHouse/pull/34911)（[Lars Hiller Eidnes](https://github.com/larspars)）。
* 如果文件不存在，则允许打开空的 sqlite 数据库。修复 [#33367](https://github.com/ClickHouse/ClickHouse/issues/33367)。[#34907](https://github.com/ClickHouse/ClickHouse/pull/34907)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 为 FreeBSD 实现内存统计功能，以确保 `max_server_memory_usage` 能够正常工作。[#34902](https://github.com/ClickHouse/ClickHouse/pull/34902)（[Alexandre Snarskii](https://github.com/snar)）。
* 在之前的版本中，`clickhouse-client` 中的进度条会无缘无故地在接近 50% 时突然向前跳动。此更改关闭了 [#34324](https://github.com/ClickHouse/ClickHouse/issues/34324)。[#34801](https://github.com/ClickHouse/ClickHouse/pull/34801)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 现在，对于 `MergeTree` 表引擎，当 `columnX` 是 `ALIAS` 列时，执行 `ALTER TABLE DROP COLUMN columnX` 查询将会立即生效。修复了 [#34660](https://github.com/ClickHouse/ClickHouse/issues/34660)。[#34786](https://github.com/ClickHouse/ClickHouse/pull/34786)（[alesapin](https://github.com/alesapin)）。
* 当用户错误输入数据跳过索引名称时显示提示信息。修复 [#29698](https://github.com/ClickHouse/ClickHouse/issues/29698)。[#34764](https://github.com/ClickHouse/ClickHouse/pull/34764) ([flynn](https://github.com/ucasfl))。
* 为 `parallel_distributed_insert_select` 添加对 `remote()`/`cluster()` 表函数的支持。[#34728](https://github.com/ClickHouse/ClickHouse/pull/34728) ([Azat Khuzhin](https://github.com/azat)).
* 在配置文件中未设置相关项时，不要重置通过 `--log-file`/`--errorlog-file` 命令行选项配置的日志记录。 [#34718](https://github.com/ClickHouse/ClickHouse/pull/34718) ([Amos Bird](https://github.com/amosbird)).
* 仅在创建表时提取一次 schema，避免在每次服务器启动时都需要从本地文件或外部源读取来提取 schema。 [#34684](https://github.com/ClickHouse/ClickHouse/pull/34684) ([Kruglov Pavel](https://github.com/Avogar)).
* 允许为可执行 UDF 指定参数名称。对于那些在序列化中包含参数名称的格式（例如 `Native`、`JSONEachRow`），这是必要的。修复 [#34604](https://github.com/ClickHouse/ClickHouse/issues/34604)。[#34653](https://github.com/ClickHouse/ClickHouse/pull/34653)（[Maksim Kita](https://github.com/kitaisreal)）。
* 实验性特性 `MaterializedMySQL` 现在支持 `materialized_mysql_tables_list`（一个以逗号分隔的 MySQL 数据库表名列表，这些表将由 MaterializedMySQL 数据库引擎复制。默认值：空列表——表示将复制所有表），参见 [#32977](https://github.com/ClickHouse/ClickHouse/issues/32977)。[#34487](https://github.com/ClickHouse/ClickHouse/pull/34487)（[zzsmdfj](https://github.com/zzsmdfj)）。
* 改进分布式表 `INSERT` 操作的 OpenTelemetry span 日志。 [#34480](https://github.com/ClickHouse/ClickHouse/pull/34480) ([Frank Chen](https://github.com/FrankChen021)).
* 在 ClickHouse Keeper 中使各服务器上的 znode `ctime` 和 `mtime` 保持一致。[#33441](https://github.com/ClickHouse/ClickHouse/pull/33441) ([小路](https://github.com/nicelulu)).

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-9}

- 软件包仓库已迁移至 JFrog Artifactory（**Mikhail f. Shiryaev**）。
- 在功能测试中随机化部分设置，以测试更多可能的设置组合。这是另一种模糊测试方法,可确保更好的测试覆盖率。此更改关闭了 [#32268](https://github.com/ClickHouse/ClickHouse/issues/32268)。[#34092](https://github.com/ClickHouse/ClickHouse/pull/34092)（[Kruglov Pavel](https://github.com/Avogar)）。
- 从 CI 中移除 PVS-Studio。[#34680](https://github.com/ClickHouse/ClickHouse/pull/34680)（[Mikhail f. Shiryaev](https://github.com/Felixoid)）。
- 新增使用 CMake 构建精简二进制文件的功能。在之前的版本中,此操作由 dh-tools 执行。[#35196](https://github.com/ClickHouse/ClickHouse/pull/35196)（[alesapin](https://github.com/alesapin)）。
- 更小的"精简版" `clickhouse-keeper` 构建。[#35031](https://github.com/ClickHouse/ClickHouse/pull/35031)（[alesapin](https://github.com/alesapin)）。
- 对于类似 https://github.com/ClickHouse/ClickHouse/pull/34685 的 PR,使用 @robot-clickhouse 作为作者和提交者。[#34793](https://github.com/ClickHouse/ClickHouse/pull/34793)（[Mikhail f. Shiryaev](https://github.com/Felixoid)）。
- 将调试信息的 DWARF 版本限制为最高版本 4,因为内部堆栈符号解析器无法解析 DWARF 版本 5。如果使用 clang-15 编译 ClickHouse,此限制尤为重要。[#34777](https://github.com/ClickHouse/ClickHouse/pull/34777)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
- 移除 `clickhouse-test` Debian 软件包,因为它增加了不必要的复杂性。CI 使用代码仓库中的测试,不再支持通过 deb 软件包进行独立测试。[#34606](https://github.com/ClickHouse/ClickHouse/pull/34606)（[Ilya Yatsishin](https://github.com/qoega)）。

#### 错误修复（官方稳定版或预发布版本中用户可见的异常行为）{#bug-fix-user-visible-misbehaviour-in-official-stable-or-prestable-release}


* 修复 HDFS 集成的问题：当内部缓冲区大小过小时，`HadoopSnappyDecoder` 中的 NEED&#95;MORE&#95;INPUT 会针对同一个压缩块运行多次（&gt;=3）。这会导致输入数据被复制到 `HadoopSnappyDecoder::buffer` 中的错误位置。[#35116](https://github.com/ClickHouse/ClickHouse/pull/35116)（[lgbo](https://github.com/lgbo-ustc)）。
* 在 `ATTACH GRANT` 语句中忽略已过时的授权。本 PR 修复了 [#34815](https://github.com/ClickHouse/ClickHouse/issues/34815)。[#34855](https://github.com/ClickHouse/ClickHouse/pull/34855)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复在使用命名集合创建的 Postgres 数据库中获取 `CREATE TABLE` 查询时发生的段错误。修复问题 [#35312](https://github.com/ClickHouse/ClickHouse/issues/35312)。[#35313](https://github.com/ClickHouse/ClickHouse/pull/35313)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复部分合并连接中产生重复行的错误，关闭 [#31009](https://github.com/ClickHouse/ClickHouse/issues/31009)。[#35311](https://github.com/ClickHouse/ClickHouse/pull/35311)（[Vladimir C](https://github.com/vdimir)）。
* 修复在使用 bzip2 压缩且 `max_read_buffer_size` 设置值较小时可能出现的 `Assertion 'position() != working_buffer.end()' failed` 问题。该错误在 [https://github.com/ClickHouse/ClickHouse/pull/35047](https://github.com/ClickHouse/ClickHouse/pull/35047) 中被发现。[#35300](https://github.com/ClickHouse/ClickHouse/pull/35300)（[Kruglov Pavel](https://github.com/Avogar)）。修复在使用 lz4 压缩且 `max_read_buffer_size` 设置值较小时可能出现的问题。[#35296](https://github.com/ClickHouse/ClickHouse/pull/35296)（[Kruglov Pavel](https://github.com/Avogar)）。修复在使用 lzma 压缩且 `max_read_buffer_size` 设置值较小时可能出现的问题。[#35295](https://github.com/ClickHouse/ClickHouse/pull/35295)（[Kruglov Pavel](https://github.com/Avogar)）。修复在使用 `brotli` 压缩且 `max_read_buffer_size` 设置值较小时可能出现的问题。该错误在 [https://github.com/ClickHouse/ClickHouse/pull/35047](https://github.com/ClickHouse/ClickHouse/pull/35047) 中被发现。[#35281](https://github.com/ClickHouse/ClickHouse/pull/35281)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复 `JSONEachRow` 模式推断中可能出现的段错误。 [#35291](https://github.com/ClickHouse/ClickHouse/pull/35291) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复在表中启用稀疏列时的 `CHECK TABLE` 查询问题。[#35274](https://github.com/ClickHouse/ClickHouse/pull/35274) ([Anton Popov](https://github.com/CurtizJ)).
* 在从远程 VFS 读取时出现异常时，避免调用 `std::terminate`。 [#35257](https://github.com/ClickHouse/ClickHouse/pull/35257) ([Azat Khuzhin](https://github.com/azat)).
* 修复从配置中读取端口的问题，解决 [#34776](https://github.com/ClickHouse/ClickHouse/issues/34776)。[#35193](https://github.com/ClickHouse/ClickHouse/pull/35193)（[Vladimir C](https://github.com/vdimir)）。
* 在 `HAVING` 返回空结果时，修复了使用 `WITH TOTALS` 的查询中的错误。修复了 [#33711](https://github.com/ClickHouse/ClickHouse/issues/33711)。[#35186](https://github.com/ClickHouse/ClickHouse/pull/35186)（[Amos Bird](https://github.com/amosbird)）。
* 修复 `replaceRegexpAll` 的一个极端情况，关闭 [#35117](https://github.com/ClickHouse/ClickHouse/issues/35117)。[#35182](https://github.com/ClickHouse/ClickHouse/pull/35182)（[Vladimir C](https://github.com/vdimir)）。
* 在使用 `INSERT INTO FUNCTION s3(...) FROM ...` 时，模式推断未能正确工作，它尝试从 s3 文件而不是从 select 查询的结果中推断模式。[#35176](https://github.com/ClickHouse/ClickHouse/pull/35176)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复 MaterializedPostgreSQL（实验特性）中关于 `partition by` 等的 `table overrides`。关闭 [#35048](https://github.com/ClickHouse/ClickHouse/issues/35048)。[#35162](https://github.com/ClickHouse/ClickHouse/pull/35162)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复了在 MaterializedPostgreSQL（实验性特性）中，手动移除表（DETACH TABLE）后将新表添加到复制（ATTACH TABLE）时出现的问题。修复了 [#33800](https://github.com/ClickHouse/ClickHouse/issues/33800)。修复了 [#34922](https://github.com/ClickHouse/ClickHouse/issues/34922)。修复了 [#34315](https://github.com/ClickHouse/ClickHouse/issues/34315)。[#35158](https://github.com/ClickHouse/ClickHouse/pull/35158)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在将非单调函数与 IN 运算符一起使用时的分区裁剪错误。修复了 [#35136](https://github.com/ClickHouse/ClickHouse/issues/35136)。[#35146](https://github.com/ClickHouse/ClickHouse/pull/35146)（[Amos Bird](https://github.com/amosbird)）。
* 修复了将 YAML 配置转换为 XML 时略有偏差的转换结果。[#35135](https://github.com/ClickHouse/ClickHouse/pull/35135) ([Miel Donkers](https://github.com/mdonkers))。
* 修复 `optimize_skip_unused_shards_rewrite_in` 在处理有符号列和负值时的问题。 [#35134](https://github.com/ClickHouse/ClickHouse/pull/35134) ([Azat Khuzhin](https://github.com/azat)).
* `update_lag` 外部字典配置选项无法使用，并会显示错误信息 ``Unexpected key `update_lag` in dictionary source configuration``。 [#35089](https://github.com/ClickHouse/ClickHouse/pull/35089) ([Jason Chu](https://github.com/1lann)).
* 避免在服务器关闭时发生潜在死锁。[#35081](https://github.com/ClickHouse/ClickHouse/pull/35081) ([Azat Khuzhin](https://github.com/azat))。
* 在启用 `optimize_functions_to_subcolumns` 设置时，修复了函数被优化为子列后丢失别名的问题。修复 [#33798](https://github.com/ClickHouse/ClickHouse/issues/33798)。[#35079](https://github.com/ClickHouse/ClickHouse/pull/35079)（[qieqieplus](https://github.com/qieqieplus)）。
* 修复在存在向表函数进行异步插入时，从 `system.asynchronous_inserts` 表读取的数据问题。 [#35050](https://github.com/ClickHouse/ClickHouse/pull/35050) ([Anton Popov](https://github.com/CurtizJ)).
* 修复可能出现的异常 `Reading for MergeTree family tables must be done with last position boundary`（与远程 VFS 上的操作相关）。修复了 [#34979](https://github.com/ClickHouse/ClickHouse/issues/34979)。[#35001](https://github.com/ClickHouse/ClickHouse/pull/35001)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在窗口帧中使用 `-State` 类型聚合函数时出现的意外结果。[#34999](https://github.com/ClickHouse/ClickHouse/pull/34999) ([metahys](https://github.com/metahys)).
* 修复 `FileLog`（实验特性）中的潜在段错误。修复 [#30749](https://github.com/ClickHouse/ClickHouse/issues/30749)。[#34996](https://github.com/ClickHouse/ClickHouse/pull/34996)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复可能出现的罕见错误 `Cannot push block to port which already has data`。 [#34993](https://github.com/ClickHouse/ClickHouse/pull/34993) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复 CSV 中未加引号日期的错误 schema 推断。修复 [#34768](https://github.com/ClickHouse/ClickHouse/issues/34768)。[#34961](https://github.com/ClickHouse/ClickHouse/pull/34961)（[Kruglov Pavel](https://github.com/Avogar)）。
* Integration with Hive：修复在 Hive 查询的 `where` 子句中使用 `in` 时出现的意外结果。[#34945](https://github.com/ClickHouse/ClickHouse/pull/34945) ([lgbo](https://github.com/lgbo-ustc))。
* 在 ClickHouse Keeper 中查找要删除的 changelog 文件时，避免进行忙轮询。[#34931](https://github.com/ClickHouse/ClickHouse/pull/34931) ([Azat Khuzhin](https://github.com/azat)).
* 修复从 PostgreSQL 导入的 `DateTime64` 转换。关闭 [#33364](https://github.com/ClickHouse/ClickHouse/issues/33364)。[#34910](https://github.com/ClickHouse/ClickHouse/pull/34910)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在通过 s3 上的 VFS 支持的 MergeTree 表执行 `INSERT` 时可能出现的 “Part directory doesn’t exist” 问题。 [#34876](https://github.com/ClickHouse/ClickHouse/pull/34876) ([Azat Khuzhin](https://github.com/azat)).
* 支持在跨副本集群上执行 `CREATE USER` 等 DDL。 [#34860](https://github.com/ClickHouse/ClickHouse/pull/34860) ([Jianmei Zhang](https://github.com/zhangjmruc))。
* 修复 `WindowView`（实验性功能）中按多个列进行 GROUP BY 时的错误。[#34859](https://github.com/ClickHouse/ClickHouse/pull/34859) ([vxider](https://github.com/Vxider))。
* 修复在查询包含 const 列时 S2 函数中可能发生的故障。[#34745](https://github.com/ClickHouse/ClickHouse/pull/34745)（[Bharat Nallan](https://github.com/bharatnc)）。
* 修复包含常量列的 H3 函数中的 bug，该 bug 会导致查询失败。[#34743](https://github.com/ClickHouse/ClickHouse/pull/34743) ([Bharat Nallan](https://github.com/bharatnc))。
* 在启用 `fsync_part_directory` 和垂直合并时修复 `No such file or directory` 错误。[#34739](https://github.com/ClickHouse/ClickHouse/pull/34739) ([Azat Khuzhin](https://github.com/azat)).
* 修复在使用 `ON CLUSTER` 时，对系统查询 `RELOAD MODEL`、`RELOAD FUNCTION`、`RESTART DISK` 的序列化/打印。关闭 [#34514](https://github.com/ClickHouse/ClickHouse/issues/34514)。[#34696](https://github.com/ClickHouse/ClickHouse/pull/34696)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复 `allow_experimental_projection_optimization` 与 `enable_global_with_statement` 的配合问题（之前在 `WITH` 子句中包含多个表达式时可能导致 `Stack size too large` 错误，而且会反复执行标量子查询，现在则会更加高效）。[#34650](https://github.com/ClickHouse/ClickHouse/pull/34650) ([Azat Khuzhin](https://github.com/azat)).
* 当其他副本已经为 `ReplatedMergeTree` 引擎更新事务日志时，停止选择要进行 `MUTATE` 的数据分片。[#34633](https://github.com/ClickHouse/ClickHouse/pull/34633) ([Jianmei Zhang](https://github.com/zhangjmruc)).
* 修复在使用 part movement 功能时，简单 `count` 查询结果不正确的问题 [#34089](https://github.com/ClickHouse/ClickHouse/issues/34089)。 [#34385](https://github.com/ClickHouse/ClickHouse/pull/34385) ([nvartolomei](https://github.com/nvartolomei))。
* 修复分布式子查询中 `max_query_size` 限制行为不一致的问题。 [#34078](https://github.com/ClickHouse/ClickHouse/pull/34078) ([Chao Ma](https://github.com/godliness)).

### <a id="222"></a> ClickHouse release v22.2, 2022-02-17 {#a-id222a-clickhouse-release-v222-2022-02-17}

#### 升级注意事项 {#upgrade-notes-3}

- 对使用 FINAL 的查询应用数据跳过索引可能产生错误结果。在此版本中,我们默认禁用了使用 FINAL 查询时的数据跳过索引(引入了新配置项 `use_skip_indexes_if_final`,默认为禁用状态)。[#34243](https://github.com/ClickHouse/ClickHouse/pull/34243) ([Azat Khuzhin](https://github.com/azat)).

#### 新功能 {#new-feature-10}


* Projections 功能已达到生产可用级别。默认启用 `allow_experimental_projection_optimization`，并弃用该设置。[#34456](https://github.com/ClickHouse/ClickHouse/pull/34456) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 在向 `File`/`S3`/`HDFS` 引擎插入时，增加创建新文件的选项。允许在 `HDFS` 中覆盖文件。默认情况下，尝试在 `S3` 中覆盖文件会抛出异常。对于具有后缀（因此不支持追加，如 `Parquet`、`ORC`）的格式，在尝试向文件追加数据时会抛出异常。关闭 [#31640](https://github.com/ClickHouse/ClickHouse/issues/31640) 关闭 [#31622](https://github.com/ClickHouse/ClickHouse/issues/31622) 关闭 [#23862](https://github.com/ClickHouse/ClickHouse/issues/23862) 关闭 [#15022](https://github.com/ClickHouse/ClickHouse/issues/15022) 关闭 [#16674](https://github.com/ClickHouse/ClickHouse/issues/16674)。[#33302](https://github.com/ClickHouse/ClickHouse/pull/33302)（[Kruglov Pavel](https://github.com/Avogar)）。
* 在 `MergeTree`/`ReplicatedMergeTree` 中新增了一个设置，允许用户提供自定义去重语义。如果提供了该设置，将使用其值而不是数据摘要来生成块 ID。比如，通过在每条 INSERT 语句中为该设置提供唯一值，用户可以避免相同插入数据被去重。修复了：[#7461](https://github.com/ClickHouse/ClickHouse/issues/7461)。[#32304](https://github.com/ClickHouse/ClickHouse/pull/32304) ([Igor Nikonov](https://github.com/devcrafter))。
* 为 INSERT 语句添加对 `DEFAULT` 关键字的支持。修复 [#6331](https://github.com/ClickHouse/ClickHouse/issues/6331)。[#33141](https://github.com/ClickHouse/ClickHouse/pull/33141)（[Andrii Buriachevskyi](https://github.com/1over)）。
* 在 `CREATE TABLE` 查询中新增了 `EPHEMERAL` 列说明符。关闭了 [#9436](https://github.com/ClickHouse/ClickHouse/issues/9436)。[#34424](https://github.com/ClickHouse/ClickHouse/pull/34424)（[yakov-olkhovskiy](https://github.com/yakov-olkhovskiy)）。
* 为 `TTL expr TO [DISK|VOLUME] [IF EXISTS] 'xxx'` 功能增加对 `IF EXISTS` 子句的支持。只有当副本上存在相应的磁盘或卷时，分片才会被移动到该磁盘或卷，因此 `MOVE TTL` 规则可以根据现有的存储策略在不同副本上表现出不同的行为。修复 [#34455](https://github.com/ClickHouse/ClickHouse/issues/34455)。[#34504](https://github.com/ClickHouse/ClickHouse/pull/34504)（[Anton Popov](https://github.com/CurtizJ)）。
* 允许设置默认表引擎，并在未显式指定 ENGINE 的情况下创建表。[#34187](https://github.com/ClickHouse/ClickHouse/pull/34187)（[Ilya Yatsishin](https://github.com/qoega)）。
* 新增表函数 `format(format_name, data)`。 [#34125](https://github.com/ClickHouse/ClickHouse/pull/34125) ([Kruglov Pavel](https://github.com/Avogar)).
* 即使通过 stdin 传入文件，`clickhouse-local` 也可以根据文件名检测格式。 [#33829](https://github.com/ClickHouse/ClickHouse/pull/33829) ([Kruglov Pavel](https://github.com/Avogar)).
* 为 `values` 表函数添加表结构自动推断功能。修复 [#33811](https://github.com/ClickHouse/ClickHouse/issues/33811)。[#34017](https://github.com/ClickHouse/ClickHouse/pull/34017)（[Kruglov Pavel](https://github.com/Avogar)）。
* 在重新加载配置时动态重新加载服务器 TLS 证书。关闭 [#15764](https://github.com/ClickHouse/ClickHouse/issues/15764)。[#15765](https://github.com/ClickHouse/ClickHouse/pull/15765)（[johnskopis](https://github.com/johnskopis)）。[#31257](https://github.com/ClickHouse/ClickHouse/pull/31257)（[Filatenkov Artur](https://github.com/FArthur-cmd)）。
* 现在，`ReplicatedMergeTree` 即使在部分磁盘损坏时也可以恢复数据。[#13544](https://github.com/ClickHouse/ClickHouse/pull/13544)（[Amos Bird](https://github.com/amosbird)）。
* 在 clickhouse-client 中支持容错连接：`clickhouse-client ... --host host1 --host host2 --port port2 --host host3 --port port --host host4`。[#34490](https://github.com/ClickHouse/ClickHouse/pull/34490)（[Kruglov Pavel](https://github.com/Avogar)）。[#33824](https://github.com/ClickHouse/ClickHouse/pull/33824)（[Filippov Denis](https://github.com/DF5HSE)）。
* 为兼容 MySQL，新增 `DEGREES` 和 `RADIANS` 函数。[#33769](https://github.com/ClickHouse/ClickHouse/pull/33769)（[Bharat Nallan](https://github.com/bharatnc)）。
* 添加 `h3ToCenterChild` 函数。[#33313](https://github.com/ClickHouse/ClickHouse/pull/33313) ([Bharat Nallan](https://github.com/bharatnc))。新增 h3 其他函数：`edgeLengthKm`、`exactEdgeLengthKm`、`exactEdgeLengthM`、`exactEdgeLengthRads`、`numHexagons`。[#33621](https://github.com/ClickHouse/ClickHouse/pull/33621) ([Bharat Nallan](https://github.com/bharatnc))。
* 添加函数 `bitSlice`，用于从 String/FixedString 中提取位子序列。[#33360](https://github.com/ClickHouse/ClickHouse/pull/33360) ([RogerYK](https://github.com/RogerYK))。
* 实现了 `meanZTest` 聚合函数。[#33354](https://github.com/ClickHouse/ClickHouse/pull/33354) ([achimbab](https://github.com/achimbab))。
* 为 T 检验聚合函数添加置信区间。[#33260](https://github.com/ClickHouse/ClickHouse/pull/33260)（[achimbab](https://github.com/achimbab)）。
* 添加函数 `addressToLineWithInlines`。修复 [#26211](https://github.com/ClickHouse/ClickHouse/issues/26211)。[#33467](https://github.com/ClickHouse/ClickHouse/pull/33467)（[SuperDJY](https://github.com/cmsxbc)）。
* 新增将 `#!` 和 `# ` 识别为单行注释起始标记的支持。修复 [#34138](https://github.com/ClickHouse/ClickHouse/issues/34138)。[#34230](https://github.com/ClickHouse/ClickHouse/pull/34230)（[Aaron Katz](https://github.com/aaronstephenkatz)）。

#### 实验性功能 {#experimental-feature-9}

- 文本分类函数:语言和字符集检测。参见 [#23271](https://github.com/ClickHouse/ClickHouse/issues/23271)。[#33314](https://github.com/ClickHouse/ClickHouse/pull/33314) ([Nikolay Degterinsky](https://github.com/evillique))。
- 为 `MemoryTracker` 添加内存超额使用功能。新增 `guaranteed` 设置用于表示软内存限制。当达到硬内存限制时,`MemoryTracker` 会尝试取消超额使用最多的查询。新设置 `memory_usage_overcommit_max_wait_microseconds` 指定查询等待其他查询停止的最长时间。关闭 [#28375](https://github.com/ClickHouse/ClickHouse/issues/28375)。[#31182](https://github.com/ClickHouse/ClickHouse/pull/31182) ([Dmitry Novik](https://github.com/novikd))。
- 在 WindowView 中启用流到表的关联。[#33729](https://github.com/ClickHouse/ClickHouse/pull/33729) ([vxider](https://github.com/Vxider))。
- 在 `MaterializedMySQL`(实验性功能)中支持 `SET`、`YEAR`、`TIME` 和 `GEOMETRY` 数据类型。修复 [#18091](https://github.com/ClickHouse/ClickHouse/issues/18091)、[#21536](https://github.com/ClickHouse/ClickHouse/issues/21536)、[#26361](https://github.com/ClickHouse/ClickHouse/issues/26361)。[#33429](https://github.com/ClickHouse/ClickHouse/pull/33429) ([zzsmdfj](https://github.com/zzsmdfj))。
- 修复默认启用投影时的各种问题。每个问题在单独的提交中描述。针对 [#33678](https://github.com/ClickHouse/ClickHouse/issues/33678)。修复 [#34273](https://github.com/ClickHouse/ClickHouse/issues/34273)。[#34305](https://github.com/ClickHouse/ClickHouse/pull/34305) ([Amos Bird](https://github.com/amosbird))。

#### 性能改进 {#performance-improvement-10}


* 如果排序键的前缀已经有序，则支持 `optimize_read_in_order`。例如，如果表的排序键为 `ORDER BY (a, b)`，并且查询包含 `WHERE a = const ORDER BY b` 子句，则现在会通过按排序键顺序读取来执行查询，而不是进行完整排序。[#32748](https://github.com/ClickHouse/ClickHouse/pull/32748) ([Anton Popov](https://github.com/CurtizJ))。
* 提升针对分区插入的表函数 `URL`、`S3`、`File` 和 `HDFS` 的性能。关闭 [#34348](https://github.com/ClickHouse/ClickHouse/issues/34348)。[#34510](https://github.com/ClickHouse/ClickHouse/pull/34510)（[Maksim Kita](https://github.com/kitaisreal)）。
* 对 clickhouse-keeper 进行了多项性能优化。 [#34484](https://github.com/ClickHouse/ClickHouse/pull/34484) [#34587](https://github.com/ClickHouse/ClickHouse/pull/34587) ([zhanglistar](https://github.com/zhanglistar)).
* `FlatDictionary` 提升了字典数据加载性能。 [#33871](https://github.com/ClickHouse/ClickHouse/pull/33871) ([Maksim Kita](https://github.com/kitaisreal)).
* 优化 `mapPopulateSeries` 函数的性能。关闭 [#33944](https://github.com/ClickHouse/ClickHouse/issues/33944)。[#34318](https://github.com/ClickHouse/ClickHouse/pull/34318)（[Maksim Kita](https://github.com/kitaisreal)）。
* 在类文件表引擎中，虚拟列 `_file` 和 `_path` 被设置为 `LowCardinality` —— 这将加快对多个文件的查询。修复了 [#34300](https://github.com/ClickHouse/ClickHouse/issues/34300)。[#34317](https://github.com/ClickHouse/ClickHouse/pull/34317)（[flynn](https://github.com/ucasfl)）。
* 加快数据分片的加载速度。之前未实现并行化：设置 `part_loading_threads` 不生效。参见 [#4699](https://github.com/ClickHouse/ClickHouse/issues/4699)。[#34310](https://github.com/ClickHouse/ClickHouse/pull/34310)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 改进 `LineAsString` 格式的性能。修复 [#34303](https://github.com/ClickHouse/ClickHouse/issues/34303)。[#34306](https://github.com/ClickHouse/ClickHouse/pull/34306)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 将 `quantilesExact{Low,High}` 优化为使用 `nth_element` 而非 `sort`。 [#34287](https://github.com/ClickHouse/ClickHouse/pull/34287) ([Danila Kutenin](https://github.com/danlark1))。
* 略微提升了 `Regexp` 格式的性能。[#34202](https://github.com/ClickHouse/ClickHouse/pull/34202) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 对标量子查询的分析进行了小幅改进。 [#34128](https://github.com/ClickHouse/ClickHouse/pull/34128) ([Federico Rodriguez](https://github.com/fedrod))。
* 让 `ORDER BY tuple` 的速度几乎与按多个列 `ORDER BY` 一样快。我们对多列 `ORDER BY` 做了专门优化：[https://github.com/ClickHouse/ClickHouse/pull/10831](https://github.com/ClickHouse/ClickHouse/pull/10831)。将这些优化同样应用到 `tuple` 列上也很有收益。[#34060](https://github.com/ClickHouse/ClickHouse/pull/34060) ([Amos Bird](https://github.com/amosbird)).
* 重新设计并在物化视图执行中重新启用标量子查询缓存。 [#33958](https://github.com/ClickHouse/ClickHouse/pull/33958) ([Raúl Marín](https://github.com/Algunenano)).
* 通过为 `memcmpSmall` 函数添加 x86-64 AVX-512 支持来小幅提升 `ORDER BY` 的性能，加速内存比较。仅在你自行编译 ClickHouse 时才会生效。[#33706](https://github.com/ClickHouse/ClickHouse/pull/33706) ([hanqf-git](https://github.com/hanqf-git))。
* 在某个键包含大量区间时，提高 `range_hashed` 字典的性能。修复了 [#23821](https://github.com/ClickHouse/ClickHouse/issues/23821)。[#33516](https://github.com/ClickHouse/ClickHouse/pull/33516)（[Maksim Kita](https://github.com/kitaisreal)）。
* 对于向 S3 执行插入和合并操作，在可能的情况下并行写入文件（TODO：检查是否已合并）。[#33291](https://github.com/ClickHouse/ClickHouse/pull/33291) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 提升 `clickhouse-keeper` 的性能，并修复 NuRaft 库中的多处内存泄漏。[#33329](https://github.com/ClickHouse/ClickHouse/pull/33329) ([alesapin](https://github.com/alesapin))。

#### 改进 {#improvement-10}


* 在 `clickhouse-client` 中为携带内联数据的查询提供异步插入支持。[#34267](https://github.com/ClickHouse/ClickHouse/pull/34267) ([Anton Popov](https://github.com/CurtizJ)).
* 函数 `dictGet`、`dictHas` 会在键参数与字典键结构不同时隐式地将键参数转换为字典键结构类型。 [#33672](https://github.com/ClickHouse/ClickHouse/pull/33672) ([Maksim Kita](https://github.com/kitaisreal)).
* 改进 `range_hashed` 字典。在存在多个属性时提高加载性能。允许创建没有属性的字典。新增选项用于在区间 `start` 和 `end` 为 `Nullable` 类型时指定策略，`convert_null_range_bound_to_open` 默认值为 `true`。关闭 [#29791](https://github.com/ClickHouse/ClickHouse/issues/29791)。允许将 `Float`、`Decimal`、`DateTime64`、`Int128`、`Int256`、`UInt128`、`UInt256` 指定为区间类型。`RangeHashedDictionary` 增加了对超出 `Int64` 类型取值范围的区间的支持。关闭 [#28322](https://github.com/ClickHouse/ClickHouse/issues/28322)。新增选项 `range_lookup_strategy` 用于指定区间查询类型 `min`、`max`，默认值为 `min`。关闭 [#21647](https://github.com/ClickHouse/ClickHouse/issues/21647)。修正已分配字节数的计算。修正 `ComplexKeyHashedDictionary` 情况下 `system.dictionaries` 中的类型名。[#33927](https://github.com/ClickHouse/ClickHouse/pull/33927)（[Maksim Kita](https://github.com/kitaisreal)）。
* `flat`、`hashed`、`hashed_array` 字典现在支持在没有属性的情况下创建，并支持读取键以及使用 `dictHas`。修复了 [#33820](https://github.com/ClickHouse/ClickHouse/issues/33820)。[#33918](https://github.com/ClickHouse/ClickHouse/pull/33918)（[Maksim Kita](https://github.com/kitaisreal)）。
* 在字典中新增了对 `DateTime64` 数据类型的支持。[#33914](https://github.com/ClickHouse/ClickHouse/pull/33914) ([Maksim Kita](https://github.com/kitaisreal)).
* 允许写成 `s3(url, access_key_id, secret_access_key)`（自动检测数据格式和表结构，但使用显式凭证）。[#34503](https://github.com/ClickHouse/ClickHouse/pull/34503)（[Kruglov Pavel](https://github.com/Avogar)）。
* 按照 [#34362](https://github.com/ClickHouse/ClickHouse/issues/34362) 中的建议，新增了将输出格式回传给客户端的功能，其行为与 HTTP 协议中的做法类似。关闭 [#34362](https://github.com/ClickHouse/ClickHouse/issues/34362)。[#34499](https://github.com/ClickHouse/ClickHouse/pull/34499)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 在执行 INSERT SELECT 查询时发送 ProfileEvents 统计信息（用于在 `clickhouse-client` 中展示此类查询的查询指标）。[#34498](https://github.com/ClickHouse/ClickHouse/pull/34498) ([Dmitry Novik](https://github.com/novikd))。
* 为 JSONEachRow 格式支持识别 `.jsonl` 扩展名。[#34496](https://github.com/ClickHouse/ClickHouse/pull/34496) ([Kruglov Pavel](https://github.com/Avogar))。
* 改进 `clickhouse-local` 中的 schema 推断能力。现在可以直接使用 `clickhouse-local -q "select * from table" < data.format`。 [#34495](https://github.com/ClickHouse/ClickHouse/pull/34495) ([Kruglov Pavel](https://github.com/Avogar)).
* `CREATE`/`ALTER`/`DROP ROW POLICY` 权限现在既可以在全局 `*.*` 上授予，也可以在单个表或 `database.*` 上授予。 [#34489](https://github.com/ClickHouse/ClickHouse/pull/34489) ([Vitaly Baranov](https://github.com/vitlibar)).
* 允许将任意大小的文件导出到 `s3`。新增两个设置：`s3_upload_part_size_multiply_factor` 和 `s3_upload_part_size_multiply_parts_count_threshold`。现在，每当在单个查询中上传到 S3 的分片数量达到 `s3_upload_part_size_multiply_parts_count_threshold` 时，`s3_min_upload_part_size` 就会乘以 `s3_upload_part_size_multiply_factor`。修复了 [#34244](https://github.com/ClickHouse/ClickHouse/issues/34244)。[#34422](https://github.com/ClickHouse/ClickHouse/pull/34422)（[alesapin](https://github.com/alesapin)）。
* 在使用 URL 存储 / 表函数时，允许在通配符匹配中跳过返回未找到 (404) 的 URL。同时关闭 [#34359](https://github.com/ClickHouse/ClickHouse/issues/34359)。[#34392](https://github.com/ClickHouse/ClickHouse/pull/34392)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `clickhouse-local` 的默认输入和输出格式，可通过 --input-format 和 --output-format 参数进行覆盖。修复 [#30631](https://github.com/ClickHouse/ClickHouse/issues/30631)。[#34352](https://github.com/ClickHouse/ClickHouse/pull/34352)（[李扬](https://github.com/taiyang-li)）。
* 为 `clickhouse-format` 添加选项，支持 `max_query_size` 和 `max_parser_depth`，从而关闭 [#30528](https://github.com/ClickHouse/ClickHouse/issues/30528)。[#34349](https://github.com/ClickHouse/ClickHouse/pull/34349)（[李扬](https://github.com/taiyang-li)）。
* 在客户端启动前更好地处理预先输入的数据。这是针对 [#34308](https://github.com/ClickHouse/ClickHouse/issues/34308)。[#34336](https://github.com/ClickHouse/ClickHouse/pull/34336)（[Amos Bird](https://github.com/amosbird)）。
* 为兼容 PostgreSQL，新增 `REGEXP_MATCHES` 和 `REGEXP_REPLACE` 函数别名。关闭 [#30885](https://github.com/ClickHouse/ClickHouse/issues/30885)。[#34334](https://github.com/ClickHouse/ClickHouse/pull/34334)（[李扬](https://github.com/taiyang-li)）。
* 一些服务器期望在其 HTTP 请求中包含 `User-Agent` 头。现已在 HTTP 请求中添加如下形式的 `User-Agent` 头条目：User-Agent: ClickHouse/VERSION&#95;STRING。 [#34330](https://github.com/ClickHouse/ClickHouse/pull/34330) ([Saad Ur Rahman](https://github.com/surahman))。
* 在获取用于 `TRUNCATE` 查询的表锁之前先取消合并操作，以避免在某些情况下出现 `DEADLOCK_AVOIDED` 错误。修复 [#34302](https://github.com/ClickHouse/ClickHouse/issues/34302)。[#34304](https://github.com/ClickHouse/ClickHouse/pull/34304)（[tavplubix](https://github.com/tavplubix)）。
* 更改日志中 “Cancelled merging parts” 消息的严重性级别，因为这不是错误。修复了 [#34148](https://github.com/ClickHouse/ClickHouse/issues/34148)。[#34232](https://github.com/ClickHouse/ClickHouse/pull/34232)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 添加支持将 PostgreSQL 风格的类型转换操作符 `::` 与使用 `[]` 和 `.` 操作符（数组和元组索引）的表达式组合使用。[#34229](https://github.com/ClickHouse/ClickHouse/pull/34229)（[Nikolay Degterinsky](https://github.com/evillique)）。
* 在 `parseDateTimeBestEffort` 函数中支持识别 `YYYYMMDD-hhmmss` 格式。修复了 [#34206](https://github.com/ClickHouse/ClickHouse/issues/34206)。[#34208](https://github.com/ClickHouse/ClickHouse/pull/34208)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在使用 `Regexp` 格式解析时，允许在行中间出现回车符。此更改解决了 [#34200](https://github.com/ClickHouse/ClickHouse/issues/34200)。[#34205](https://github.com/ClickHouse/ClickHouse/pull/34205)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 允许将字典的 `PRIMARY KEY` 解析为 `PRIMARY KEY (id, value)`；之前仅支持 `PRIMARY KEY id, value`。修复 [#34135](https://github.com/ClickHouse/ClickHouse/issues/34135)。[#34141](https://github.com/ClickHouse/ClickHouse/pull/34141)（[Maksim Kita](https://github.com/kitaisreal)）。
* 为 `splitByChar` 添加一个可选参数，用于限制结果元素的数量。修复 [#34081](https://github.com/ClickHouse/ClickHouse/issues/34081)。 [#34140](https://github.com/ClickHouse/ClickHouse/pull/34140) ([李扬](https://github.com/taiyang-li))。
* 改进 `clickhouse-client` 的多行编辑体验。这是对 [#31123](https://github.com/ClickHouse/ClickHouse/pull/31123) 的后续改进。[#34114](https://github.com/ClickHouse/ClickHouse/pull/34114)（[Amos Bird](https://github.com/amosbird)）。
* 在 `MsgPack` 输入/输出格式中添加对 `UUID` 的支持。 [#34065](https://github.com/ClickHouse/ClickHouse/pull/34065) ([Kruglov Pavel](https://github.com/Avogar))。
* 现在会从 GRPC 客户端的元数据中传播跟踪上下文（用于 OpenTelemetry）（此更改与 GRPC 客户端-服务器协议相关）。 [#34064](https://github.com/ClickHouse/ClickHouse/pull/34064) ([andremarianiello](https://github.com/andremarianiello)).
* 支持所有带有 `ON CLUSTER` 子句的 `SYSTEM` 查询。[#34005](https://github.com/ClickHouse/ClickHouse/pull/34005) ([小路](https://github.com/nicelulu)).
* 改进对使用内存低于 `max_untracker_memory` 的查询的内存统计。[#34001](https://github.com/ClickHouse/ClickHouse/pull/34001) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在小写和大写字符由不同字节数表示时，对固定 UTF-8 字符串进行不区分大小写搜索的问题。例如 `ẞ` 和 `ß`。此变更关闭了 [#7334](https://github.com/ClickHouse/ClickHouse/issues/7334)。[#33992](https://github.com/ClickHouse/ClickHouse/pull/33992)（[Harry Lee](https://github.com/HarryLeeIBM)）。
* 在 `clickhouse-local` 中从 stdin 自动检测格式和 schema。[#33960](https://github.com/ClickHouse/ClickHouse/pull/33960)（[Kruglov Pavel](https://github.com/Avogar)）。
* 正确处理多个磁盘在文件系统上使用相同路径时的错误配置问题。 [#29072](https://github.com/ClickHouse/ClickHouse/issues/29072)。 [#33905](https://github.com/ClickHouse/ClickHouse/pull/33905) ([zhongyuankai](https://github.com/zhongyuankai))。
* 在获取 S3 代理时尝试使用每个已解析的 IP 地址。S3 代理很少被使用，主要用于 Yandex Cloud。[#33862](https://github.com/ClickHouse/ClickHouse/pull/33862) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 支持 `EXPLAIN AST CREATE FUNCTION` 查询 `EXPLAIN AST CREATE FUNCTION mycast AS (n) -> cast(n as String)`，该查询将返回 `EXPLAIN AST CREATE FUNCTION mycast AS n -> CAST(n, 'String')`。 [#33819](https://github.com/ClickHouse/ClickHouse/pull/33819) ([李扬](https://github.com/taiyang-li)).
* 新增支持将 `Map(Key, Value)` 转换为 `Array(Tuple(Key, Value))`。[#33794](https://github.com/ClickHouse/ClickHouse/pull/33794) ([Maksim Kita](https://github.com/kitaisreal)).
* 为 `Bool` 数据类型添加了一些改进和修复内容。修复了 [#33244](https://github.com/ClickHouse/ClickHouse/issues/33244)。[#33737](https://github.com/ClickHouse/ClickHouse/pull/33737)（[Kruglov Pavel](https://github.com/Avogar)）。
* 以大端序解析并存储 OpenTelemetry trace-id。 [#33723](https://github.com/ClickHouse/ClickHouse/pull/33723) ([Frank Chen](https://github.com/FrankChen021)).
* 改进了 `fromUnixTimestamp64` 系列函数。现在它们可以接受任何可转换为 `Int64` 的整数值。已关闭相关 issue：[#14648](https://github.com/ClickHouse/ClickHouse/issues/14648)。[#33505](https://github.com/ClickHouse/ClickHouse/pull/33505)（[Andrey Zvonov](https://github.com/zvonand)）。
* 使用 `shardNum()` 函数（参见 [#27020](https://github.com/ClickHouse/ClickHouse/issues/27020)）重新实现基于常量的 `_shard_num`（参见 [#7624](https://github.com/ClickHouse/ClickHouse/issues/7624)），以避免可能的问题（例如在 [#16947](https://github.com/ClickHouse/ClickHouse/issues/16947) 中发现的问题）。[#33392](https://github.com/ClickHouse/ClickHouse/pull/33392)（[Azat Khuzhin](https://github.com/azat)）。
* 在 `Decimal` 和 `Float` 之间启用二元算术运算（加、减、乘、除、`least`、`greatest`）。 [#33355](https://github.com/ClickHouse/ClickHouse/pull/33355) ([flynn](https://github.com/ucasfl))。
* 在 `max_threads` 自动检测中遵循 cgroups 限制。[#33342](https://github.com/ClickHouse/ClickHouse/pull/33342) ([JaySon](https://github.com/JaySon-Huang)).
* 新增 clickhouse-keeper 配置项 `min_session_timeout_ms`。现在 clickhouse-keeper 将根据 `min_session_timeout_ms` 和 `session_timeout_ms` 配置来确定客户端会话超时时间。 [#33288](https://github.com/ClickHouse/ClickHouse/pull/33288) ([JackyWoo](https://github.com/JackyWoo)).
* 为函数 `hex` 和 `bin` 增加了对 `UUID` 数据类型的支持。[#32170](https://github.com/ClickHouse/ClickHouse/pull/32170) ([Frank Chen](https://github.com/FrankChen021))。
* 修复了读取名称中包含点号的子列的问题。尤其是，当 `Nested` 列的元素名称包含点号时（例如 ``Nested(`keys.name` String, `keys.id` UInt64, values UInt64)``），现在可以被正确读取。[#34228](https://github.com/ClickHouse/ClickHouse/pull/34228)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复了在使用 `VALUES` 向表中插入数据时，`parallel_view_processing = 0` 不生效的问题。- 修复了 `query_views_log` 中物化视图的 `view_duration_ms` 字段未被正确设置的问题。 [#34067](https://github.com/ClickHouse/ClickHouse/pull/34067) ([Raúl Marín](https://github.com/Algunenano)).
* 修复从 ZooKeeper 解析表结构的逻辑：现在会以规范形式将来自 ZooKeeper 的元数据与本地元数据进行比较。这有助于应对在不同 ClickHouse 版本之间规范函数名发生变化的情况。 [#33933](https://github.com/ClickHouse/ClickHouse/pull/33933) ([sunny](https://github.com/sunny19930321))。
* 为与 LDAP 交互，正确转义某些字符。 [#33401](https://github.com/ClickHouse/ClickHouse/pull/33401) ([IlyaTsoi](https://github.com/IlyaTsoi)).

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-10}

- 移除非捆绑构建支持。[#33690](https://github.com/ClickHouse/ClickHouse/pull/33690) ([Azat Khuzhin](https://github.com/azat))。
- 确保测试不依赖于相等元素的非稳定排序结果。在调试模式下,排序后对相等项范围进行随机化,以防止依赖相等项排序顺序时出现问题。[#34393](https://github.com/ClickHouse/ClickHouse/pull/34393) ([Maksim Kita](https://github.com/kitaisreal))。
- 为样式检查添加详细输出。[#34289](https://github.com/ClickHouse/ClickHouse/pull/34289) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- 移除 `clickhouse-test` Debian 软件包,因为它已过时。[#33948](https://github.com/ClickHouse/ClickHouse/pull/33948) ([Ilya Yatsishin](https://github.com/qoega))。
- 对构建系统进行多项改进,以消除偶尔使用操作系统软件包的可能性,并强制执行封闭式构建。[#33695](https://github.com/ClickHouse/ClickHouse/pull/33695) ([Amos Bird](https://github.com/amosbird))。

#### Bug 修复(官方稳定版或预发布版本中用户可见的异常行为){#bug-fix-user-visible-misbehaviour-in-official-stable-or-prestable-release-1}


* 修复了在同时使用 `allow_experimental_parallel_reading_from_replicas` 且将 `max_parallel_replicas` 设为 1 时触发的断言问题。此更改修复了 [#34525](https://github.com/ClickHouse/ClickHouse/issues/34525)。[#34613](https://github.com/ClickHouse/ClickHouse/pull/34613)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 修复在读取空数组时出现的罕见错误，该错误可能会导致 `Data compressed with different methods` 报错。如果数据中大部分是空数组（但并非所有情况），并且读取是以带有 ORDER BY ... DESC 的倒序方式进行，就有可能复现该问题。此错误出现的概率极低。[#34327](https://github.com/ClickHouse/ClickHouse/pull/34327) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在对小整数类型的整数值进行取整时，`round`/`roundBankers` 返回错误结果的问题。修复了 [#33267](https://github.com/ClickHouse/ClickHouse/issues/33267)。[#34562](https://github.com/ClickHouse/ClickHouse/pull/34562)（[李扬](https://github.com/taiyang-li)）。
* 有时在从 s3 或 HDFS 读取多个文件时，查询取消不会立即生效。修复了 [#34301](https://github.com/ClickHouse/ClickHouse/issues/34301)，相关问题 [#34397](https://github.com/ClickHouse/ClickHouse/issues/34397)。[#34539](https://github.com/ClickHouse/ClickHouse/pull/34539)（[Dmitry Novik](https://github.com/novikd)）。
* 修复异常 `Chunk should have AggregatedChunkInfo in MergingAggregatedTransform`（在 `optimize_aggregation_in_order = 1` 且 `distributed_aggregation_memory_efficient = 0` 的情况下触发）。修复了 [#34526](https://github.com/ClickHouse/ClickHouse/issues/34526)。[#34532](https://github.com/ClickHouse/ClickHouse/pull/34532)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复索引分析中整数与浮点数比较的问题。此前这可能会导致错误地跳过某些用于读取的粒度。修复了 [#34493](https://github.com/ClickHouse/ClickHouse/issues/34493)。[#34528](https://github.com/ClickHouse/ClickHouse/pull/34528)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复 URL 引擎对压缩的支持。[#34524](https://github.com/ClickHouse/ClickHouse/pull/34524)（[Frank Chen](https://github.com/FrankChen021)）。
* 修复在文件模式自动检测中可能出现的错误 &#39;file&#95;size: Operation not supported&#39;。[#34479](https://github.com/ClickHouse/ClickHouse/pull/34479) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复了在删除表时可能出现的竞态问题。 [#34416](https://github.com/ClickHouse/ClickHouse/pull/34416) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 修复在短路函数求值中可能出现的错误 `Cannot convert column Function to mask`。修复了 [#34171](https://github.com/ClickHouse/ClickHouse/issues/34171)。[#34415](https://github.com/ClickHouse/ClickHouse/pull/34415)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复从 URL 源进行 schema 推断时可能发生的崩溃。关闭 [#34147](https://github.com/ClickHouse/ClickHouse/issues/34147)。[#34405](https://github.com/ClickHouse/ClickHouse/pull/34405)（[Kruglov Pavel](https://github.com/Avogar)）。
* 对于 UDF，访问权限被错误地在数据库级别进行检查，而本应在全局级别进行检查。修复了 [#34281](https://github.com/ClickHouse/ClickHouse/issues/34281)。[#34404](https://github.com/ClickHouse/ClickHouse/pull/34404)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复在对使用 `Memory` 引擎的数据库执行 `SHOW CREATE DATABASE` 查询时，结果中引擎语法错误的问题。修复了 [#34335](https://github.com/ClickHouse/ClickHouse/issues/34335)。[#34345](https://github.com/ClickHouse/ClickHouse/pull/34345)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了几个极其罕见的竞争条件，这些问题可能导致复制队列状态异常以及“intersecting parts”错误。 [#34297](https://github.com/ClickHouse/ClickHouse/pull/34297) ([tavplubix](https://github.com/tavplubix)).
* 修复进度条宽度。此前宽度被错误地取整为整数字符数。[#34275](https://github.com/ClickHouse/ClickHouse/pull/34275)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复用于服务器间通信的 `current_user`/`current_address` 客户端信息字段（在此补丁之前，`current_user`/`current_address` 会沿用上一个查询的值）。 [#34263](https://github.com/ClickHouse/ClickHouse/pull/34263) ([Azat Khuzhin](https://github.com/azat)).
* 修复在启用 `optimize_aggregation_in_order=1` 时，查询处理过程中遇到某些异常导致的内存泄漏问题。[#34234](https://github.com/ClickHouse/ClickHouse/pull/34234) ([Azat Khuzhin](https://github.com/azat)).
* 修复指标 `Query`，该指标用于显示当前正在执行的查询数量。在最近几个版本中，该值始终为 0。[#34224](https://github.com/ClickHouse/ClickHouse/pull/34224) ([Anton Popov](https://github.com/CurtizJ))。
* 修复表函数 `s3` 的模式推断。 [#34186](https://github.com/ClickHouse/ClickHouse/pull/34186) ([Kruglov Pavel](https://github.com/Avogar))。
* 修复了 `HDFS`、`S3` 和 `URL` 存储引擎中一种罕见且无害的竞争条件，该问题可能会导致额外的连接。[#34172](https://github.com/ClickHouse/ClickHouse/pull/34172) ([alesapin](https://github.com/alesapin)).
* 修复了一个 bug，该 bug 在罕见情况下可能会在读取将数据存储在远程文件系统（如 S3）上的 MergeTree 表引擎族的 `LowCardinality` 列时导致错误 “Cannot read all data”（基于 S3 的虚拟文件系统是尚未准备好用于生产环境的实验性特性）。 [#34139](https://github.com/ClickHouse/ClickHouse/pull/34139) ([alesapin](https://github.com/alesapin)).
* 在原生协议发生变更时，修复对 Distributed 表的插入操作。上一次变更是在 22.1 版本中，因此在升级到该版本后，对 Distributed 表进行插入时可能会出现一些失败。[#34132](https://github.com/ClickHouse/ClickHouse/pull/34132)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复在 `File` 表引擎中由 [#33960](https://github.com/ClickHouse/ClickHouse/pull/33960) 引入的潜在数据竞争问题。修复 [#34111](https://github.com/ClickHouse/ClickHouse/issues/34111)。[#34113](https://github.com/ClickHouse/ClickHouse/pull/34113)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复了一个轻微的竞态条件，该问题在 ZooKeeper 连接丢失后，在极少数情况下可能导致“intersecting parts”错误。 [#34096](https://github.com/ClickHouse/ClickHouse/pull/34096) ([tavplubix](https://github.com/tavplubix)).
* 修复使用 `Native` 格式的异步插入问题。 [#34068](https://github.com/ClickHouse/ClickHouse/pull/34068) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了一个错误，该错误会导致在同时使用 replicated access storage 和 keeper（嵌入在 clickhouse-server 中）时服务器无法启动。为 keeper 的 socket 超时新增了两个设置，用于替代原先从默认用户继承的设置：`keeper_server.socket_receive_timeout_sec` 和 `keeper_server.socket_send_timeout_sec`。修复了 [#33973](https://github.com/ClickHouse/ClickHouse/issues/33973)。[#33988](https://github.com/ClickHouse/ClickHouse/pull/33988)（[alesapin](https://github.com/alesapin)）。
* 修复了解析页脚损坏的 ORC 文件时发生的段错误。关闭 [#33797](https://github.com/ClickHouse/ClickHouse/issues/33797)。[#33984](https://github.com/ClickHouse/ClickHouse/pull/33984)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复从查询参数（预处理语句）解析 IPv6 的问题，并修复 IPv6 转字符串时的转换。关闭 [#33928](https://github.com/ClickHouse/ClickHouse/issues/33928)。[#33971](https://github.com/ClickHouse/ClickHouse/pull/33971)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复读取嵌套元组时的崩溃问题。修复了 [#33838](https://github.com/ClickHouse/ClickHouse/issues/33838)。[#33956](https://github.com/ClickHouse/ClickHouse/pull/33956)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复在分布式查询中使用带字面量参数的 `array` 和 `tuple` 函数时的行为。此前这些用法可能会导致 `Not found columns` 异常。[#33938](https://github.com/ClickHouse/ClickHouse/pull/33938)（[Anton Popov](https://github.com/CurtizJ)）。
* 聚合函数组合器 `-If` 未能正确处理 `Nullable` 类型的过滤参数。此修复关闭了 [#27073](https://github.com/ClickHouse/ClickHouse/issues/27073)。[#33920](https://github.com/ClickHouse/ClickHouse/pull/33920)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复在进行远程磁盘读取时可能出现的竞争情况（基于 S3 的虚拟文件系统是实验性功能，尚未准备好用于生产环境）。[#33912](https://github.com/ClickHouse/ClickHouse/pull/33912)（[Amos Bird](https://github.com/amosbird)）。
* 修复了在使用带有非标识符参数的 lambda 创建 SQL UDF 时发生的崩溃问题。修复问题 [#33866](https://github.com/ClickHouse/ClickHouse/issues/33866)。[#33868](https://github.com/ClickHouse/ClickHouse/pull/33868)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复稀疏列的使用（可通过实验性设置 `ratio_of_defaults_for_sparse_serialization` 启用）。 [#33849](https://github.com/ClickHouse/ClickHouse/pull/33849) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了在副本实际为只读时，`SYSTEM RESTORE REPLICA` 查询中出现的 `replica is not readonly` 逻辑错误。修复了 [#33806](https://github.com/ClickHouse/ClickHouse/issues/33806)。[#33847](https://github.com/ClickHouse/ClickHouse/pull/33847)（[tavplubix](https://github.com/tavplubix)）。
* 修复在使用压缩（默认）时 `clickhouse-keeper` 中出现的内存泄漏。[#33840](https://github.com/ClickHouse/ClickHouse/pull/33840) ([Azat Khuzhin](https://github.com/azat))。
* 修复在没有可用公共类型时的索引分析。 [#33833](https://github.com/ClickHouse/ClickHouse/pull/33833) ([Amos Bird](https://github.com/amosbird)).
* 修复 `JSONEachRow` 和 `JSONCompactEachRow` 的架构推断。[#33830](https://github.com/ClickHouse/ClickHouse/pull/33830) ([Kruglov Pavel](https://github.com/Avogar))。
* 修复了在使用 `redis` 源且键数量较大时外部字典的行为问题。 [#33804](https://github.com/ClickHouse/ClickHouse/pull/33804) ([Anton Popov](https://github.com/CurtizJ)).
* 修复客户端中的一个错误，该错误会导致服务器端出现“Connection reset by peer”。修复了 [#33309](https://github.com/ClickHouse/ClickHouse/issues/33309)。[#33790](https://github.com/ClickHouse/ClickHouse/pull/33790)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复对查询 `INSERT INTO ... VALUES SETTINGS ... (...), ...` 的解析 [#33776](https://github.com/ClickHouse/ClickHouse/pull/33776) ([Kruglov Pavel](https://github.com/Avogar))。
* 修复在使用 `wide` 格式和投影创建数据分片时执行 `CHECK TABLE` 出错的 bug。 [#33774](https://github.com/ClickHouse/ClickHouse/pull/33774) ([李扬](https://github.com/taiyang-li)).
* 修复 MergeTree 中 `count()` 与 `INSERT`/合并/... 之间的细微竞争条件（在启用 `optimize_trivial_count_query` 的 `SELECT` 查询中，可能会返回不正确的行数）。[#33753](https://github.com/ClickHouse/ClickHouse/pull/33753) ([Azat Khuzhin](https://github.com/azat)).
* 在 HDFS 存储中，当目录列表请求失败时抛出异常。 [#33724](https://github.com/ClickHouse/ClickHouse/pull/33724) ([LiuNeng](https://github.com/liuneng1994)).
* 修复在表包含投影时的变更操作问题。修复了 [#33010](https://github.com/ClickHouse/ClickHouse/issues/33010)。修复了 [#33275](https://github.com/ClickHouse/ClickHouse/issues/33275)。[#33679](https://github.com/ClickHouse/ClickHouse/pull/33679)（[Amos Bird](https://github.com/amosbird)）。
* 在具名 HTTP 会话中执行 `CREATE TEMPORARY TABLE AS SELECT` 查询时，能够正确确定当前数据库。这是一个非常罕见的用例。此更改修复了 [#8340](https://github.com/ClickHouse/ClickHouse/issues/8340)。[#33676](https://github.com/ClickHouse/ClickHouse/pull/33676)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 允许包含排序、LIMIT BY、ARRAY JOIN 和 lambda 函数的部分查询。这解决了 [#7462](https://github.com/ClickHouse/ClickHouse/issues/7462)。[#33675](https://github.com/ClickHouse/ClickHouse/pull/33675)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了“zero copy replication”（一项仍在开发且不应在生产环境中使用的功能）中的一个错误，该错误会在执行 TTL 移动时导致数据重复。修复了 [#33643](https://github.com/ClickHouse/ClickHouse/issues/33643)。[#33642](https://github.com/ClickHouse/ClickHouse/pull/33642)（[alesapin](https://github.com/alesapin)）。
* 修复在 `optimize_aggregation_in_order = 1` 情况下出现的 `Chunk should have AggregatedChunkInfo in GroupingAggregatedTransform` 问题。 [#33637](https://github.com/ClickHouse/ClickHouse/pull/33637) ([Azat Khuzhin](https://github.com/azat)).
* 修复错误 `Bad cast from type ... to DB::DataTypeArray`，该错误可能在表包含名称中带有点号的 `Nested` 列且为其生成默认值时发生（例如在插入时，当该列未在插入列列表中列出时）。这是 [#28762](https://github.com/ClickHouse/ClickHouse/issues/28762) 的延续。[#33588](https://github.com/ClickHouse/ClickHouse/pull/33588)（[Alexey Pavlenko](https://github.com/alexeypavlenko)）。
* 修复了导出为 `lz4` 文件的问题。关闭 [#31421](https://github.com/ClickHouse/ClickHouse/issues/31421)。[#31862](https://github.com/ClickHouse/ClickHouse/pull/31862)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复在将 `group_by_overflow_mode` 设置为 `any`（近似 GROUP BY）且按单个 `LowCardinality` 类型列进行聚合时可能发生的崩溃问题。 [#34506](https://github.com/ClickHouse/ClickHouse/pull/34506) ([DR](https://github.com/freedomDR)).
* 修复通过 gRPC 客户端-服务器协议向临时表插入数据的问题。修复了 [#34347](https://github.com/ClickHouse/ClickHouse/issues/34347)，议题 `#2`。[#34364](https://github.com/ClickHouse/ClickHouse/pull/34364)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复问题 [#19429](https://github.com/ClickHouse/ClickHouse/issues/19429)。[#34225](https://github.com/ClickHouse/ClickHouse/pull/34225)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复了问题 [#18206](https://github.com/ClickHouse/ClickHouse/issues/18206)。 [#33977](https://github.com/ClickHouse/ClickHouse/pull/33977)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 此 PR 允许在同一用户目录列表中使用多个 LDAP 存储。之前这一点是可行的，但由于 LDAP 测试被禁用（它们属于 testflows 测试的一部分），导致该功能失效。[#33574](https://github.com/ClickHouse/ClickHouse/pull/33574)（[Vitaly Baranov](https://github.com/vitlibar)）。

### <a id="221"></a> ClickHouse 版本 v22.1, 2022-01-18 {#a-id221a-clickhouse-release-v221-2022-01-18}

#### 升级注意事项 {#upgrade-notes-4}

- 函数 `left` 和 `right` 之前在解析器中实现,现已成为完整功能。如果集群包含不同版本的 clickhouse-server,使用不带别名的 `left` 或 `right` 函数的分布式查询可能会抛出异常。如果您在升级集群时遇到此错误,应完成集群升级以确保所有节点版本一致。您也可以在查询中为列添加别名(如 `AS something`)来避免此问题。[#33407](https://github.com/ClickHouse/ClickHouse/pull/33407) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 从此版本开始,标量子查询的资源使用情况已被完全统计。通过此更改,标量子查询中读取的行数现在会记录在 query_log 中。如果标量子查询被缓存(重复执行或为多行调用),读取的行数仅计算一次。此更改允许在执行标量子查询时终止查询并报告进度。[#32271](https://github.com/ClickHouse/ClickHouse/pull/32271) ([Raúl Marín](https://github.com/Algunenano))。

#### 新功能 {#new-feature-11}


* 为输入格式实现数据模式推断。允许在表函数 `file`、`url`、`s3`、`hdfs` 以及 `clickhouse-local` 的参数中省略结构（或只写 `auto`）。允许在为表引擎 `File`、`HDFS`、`S3`、`URL`、`Merge`、`Buffer`、`Distributed` 和 `ReplicatedMergeTree`（在新增副本时）创建表的查询中省略结构。[#32455](https://github.com/ClickHouse/ClickHouse/pull/32455) ([Kruglov Pavel](https://github.com/Avogar))。
* 在 `file`/`hdfs`/`s3`/`url` 表函数和 `HDFS`/`S3`/`URL` 表引擎中，以及在使用 `SELECT INTO OUTFILE` 和 `INSERT FROM INFILE` 时，通过文件扩展名自动检测格式 [#33565](https://github.com/ClickHouse/ClickHouse/pull/33565)（[Kruglov Pavel](https://github.com/Avogar)）。关闭 [#30918](https://github.com/ClickHouse/ClickHouse/issues/30918)。[#33443](https://github.com/ClickHouse/ClickHouse/pull/33443)（[OnePiece](https://github.com/zhongyuankai)）。
* 用于在需要技术支持时收集诊断数据的工具。[#33175](https://github.com/ClickHouse/ClickHouse/pull/33175) ([Alexander Burmak](https://github.com/Alex-Burmak))。
* 通过 Zoo/Keeper 自动发现集群，使得可以在不更改每台服务器配置的情况下向集群添加副本。 [#31442](https://github.com/ClickHouse/ClickHouse/pull/31442) ([vdimir](https://github.com/vdimir))。
* 实现 `hive` 表引擎，以便在 ClickHouse 中访问 Apache Hive。实现了：[#29245](https://github.com/ClickHouse/ClickHouse/issues/29245)。[#31104](https://github.com/ClickHouse/ClickHouse/pull/31104)（[taiyang-li](https://github.com/taiyang-li)）。
* 添加聚合函数 `cramersV`、`cramersVBiasCorrected`、`theilsU` 和 `contingency`。这些函数用于计算分类值之间的依赖关系（关联度量）。所有这些函数的实现都基于交叉表（成对直方图）。可以将其类比为相关系数，但适用于任意离散值（不一定是数值）。[#33366](https://github.com/ClickHouse/ClickHouse/pull/33366)（[alexey-milovidov](https://github.com/alexey-milovidov)）。初始实现由 [Vanyok-All-is-OK](https://github.com/Vanyok-All-is-OK) 和 [antikvist](https://github.com/antikvist) 完成。
* 新增了表函数 `hdfsCluster`，可在指定集群的多个节点上并行处理来自 HDFS 的文件，类似于 `s3Cluster`。[#32400](https://github.com/ClickHouse/ClickHouse/pull/32400) ([Zhichang Yu](https://github.com/yuzhichang))。
* 以类似于基于 AWS S3 的磁盘的方式，增加对基于 Azure Blob Storage 的磁盘的支持。[#31505](https://github.com/ClickHouse/ClickHouse/pull/31505)（[Jakub Kuklis](https://github.com/jkuklis)）。
* 在 `CREATE VIEW` 中允许使用 `COMMENT`（适用于所有类型的视图）。[#31062](https://github.com/ClickHouse/ClickHouse/pull/31062)（[Vasily Nemkov](https://github.com/Enmk)）。
* 当配置发生更改时，动态重新初始化侦听端口和协议。[#30549](https://github.com/ClickHouse/ClickHouse/pull/30549) ([Kevin Michel](https://github.com/kmichel-aiven)).
* 添加了 `left`、`right`、`leftUTF8`、`rightUTF8` 函数。修复了 `substringUTF8` 函数在使用负偏移量（从字符串末尾起计算偏移）时的实现错误。[#33407](https://github.com/ClickHouse/ClickHouse/pull/33407) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 为 `H3` 坐标系新增了函数：`h3HexAreaKm2`、`h3CellAreaM2`、`h3CellAreaRads2`。 [#33479](https://github.com/ClickHouse/ClickHouse/pull/33479) ([Bharat Nallan](https://github.com/bharatnc)).
* 添加 `MONTHNAME` 函数。[#33436](https://github.com/ClickHouse/ClickHouse/pull/33436) ([usurai](https://github.com/usurai))。
* 已添加函数 `arrayLast`。修复 [#33390](https://github.com/ClickHouse/ClickHouse/issues/33390)。[#33415](https://github.com/ClickHouse/ClickHouse/pull/33415) 已添加函数 `arrayLastIndex`。[#33465](https://github.com/ClickHouse/ClickHouse/pull/33465)（[Maksim Kita](https://github.com/kitaisreal)）。
* 新增函数 `decodeURLFormComponent`，与 `decodeURLComponent` 略有不同。修复 [#10298](https://github.com/ClickHouse/ClickHouse/issues/10298)。[#33451](https://github.com/ClickHouse/ClickHouse/pull/33451) ([SuperDJY](https://github.com/cmsxbc))。
* 允许针对普通指标/带标签指标分别设置 `GraphiteMergeTree` 汇总规则（可选的 rule&#95;type 字段）。[#33494](https://github.com/ClickHouse/ClickHouse/pull/33494) ([Michail Safronov](https://github.com/msaf1980)).

#### 性能改进 {#performance-improvement-11}

- 支持将条件移动到 `PREWHERE`(设置 `optimize_move_to_prewhere`)用于 `Merge` 引擎的表,前提是其所有底层表都支持 `PREWHERE`。[#33300](https://github.com/ClickHouse/ClickHouse/pull/33300) ([Anton Popov](https://github.com/CurtizJ))。
- 更高效地处理 URL 存储的通配符。现在您可以轻松地并行查询数百万个 URL 并支持重试。关闭 [#32866](https://github.com/ClickHouse/ClickHouse/issues/32866)。[#32907](https://github.com/ClickHouse/ClickHouse/pull/32907) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 避免解析器中的指数级回溯。这关闭了 [#20158](https://github.com/ClickHouse/ClickHouse/issues/20158)。[#33481](https://github.com/ClickHouse/ClickHouse/pull/33481) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 滥用 `untuple` 函数会导致查询分析的指数级复杂度(由模糊测试器发现)。这关闭了 [#33297](https://github.com/ClickHouse/ClickHouse/issues/33297)。[#33445](https://github.com/ClickHouse/ClickHouse/pull/33445) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 减少具有字符串属性的字典所分配的内存。[#33466](https://github.com/ClickHouse/ClickHouse/pull/33466) ([Maksim Kita](https://github.com/kitaisreal))。
- `reinterpret` 函数的轻微性能改进。[#32587](https://github.com/ClickHouse/ClickHouse/pull/32587) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 非重要更改。在极少数情况下,当每个副本上的数据部分丢失时,在合并某些数据部分后,后续查询在分区修剪期间可能会跳过较少数量的分区。这几乎不会影响任何内容。[#32220](https://github.com/ClickHouse/ClickHouse/pull/32220) ([Azat Khuzhin](https://github.com/azat))。
- 通过优化大小计算逻辑来提高 `clickhouse-keeper` 的写入性能。[#32366](https://github.com/ClickHouse/ClickHouse/pull/32366) ([zhanglistar](https://github.com/zhanglistar))。
- 优化单部分投影物化。这关闭了 [#31669](https://github.com/ClickHouse/ClickHouse/issues/31669)。[#31885](https://github.com/ClickHouse/ClickHouse/pull/31885) ([Amos Bird](https://github.com/amosbird))。
- 提高系统表的查询性能。[#33312](https://github.com/ClickHouse/ClickHouse/pull/33312) ([OnePiece](https://github.com/zhongyuankai))。
- 优化可在卷之间移动的 MergeTree 部分的选择。[#33225](https://github.com/ClickHouse/ClickHouse/pull/33225) ([OnePiece](https://github.com/zhongyuankai))。
- 修复 `sparse_hashed` 字典在顺序键下的性能问题(错误的哈希函数)。[#32536](https://github.com/ClickHouse/ClickHouse/pull/32536) ([Azat Khuzhin](https://github.com/azat))。

#### 实验性功能 {#experimental-feature-10}


- 在分布式查询期间从分片内的多个副本并行读取数据,无需使用采样键。要启用此功能,请设置 `allow_experimental_parallel_reading_from_replicas = 1` 和 `max_parallel_replicas` 为任意数值。此功能解决了 [#26748](https://github.com/ClickHouse/ClickHouse/issues/26748)。[#29279](https://github.com/ClickHouse/ClickHouse/pull/29279) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 实现了稀疏序列化。它可以减少磁盘空间使用,并提高包含大量默认值(零值)的列的某些查询性能。可以通过设置 `ratio_for_sparse_serialization` 来启用此功能。如果列的默认值数量与所有值数量的比率超过该阈值,将动态选择稀疏序列化。序列化方式(默认或稀疏)对于数据部分中的每一列是固定的,但在不同数据部分之间可能有所不同。[#22535](https://github.com/ClickHouse/ClickHouse/pull/22535) ([Anton Popov](https://github.com/CurtizJ))。
- 添加了 "TABLE OVERRIDE" 功能,用于自定义 MaterializedMySQL 表结构。[#32325](https://github.com/ClickHouse/ClickHouse/pull/32325) ([Stig Bakken](https://github.com/stigsb))。
- 添加了 `EXPLAIN TABLE OVERRIDE` 查询。[#32836](https://github.com/ClickHouse/ClickHouse/pull/32836) ([Stig Bakken](https://github.com/stigsb))。
- 支持 MaterializedPostgreSQL 的 TABLE OVERRIDE 子句。RFC:[#31480](https://github.com/ClickHouse/ClickHouse/issues/31480)。[#32749](https://github.com/ClickHouse/ClickHouse/pull/32749) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 更改了共享数据零拷贝标记的 ZooKeeper 路径。请注意,"零拷贝复制"是一个非生产环境功能(处于早期开发阶段),无论如何您都不应该使用。但如果您已经使用了它,请注意此更改。[#32061](https://github.com/ClickHouse/ClickHouse/pull/32061) ([ianton-ru](https://github.com/ianton-ru))。
- 为 WINDOW VIEW 监视查询添加了 Events 子句支持。[#32607](https://github.com/ClickHouse/ClickHouse/pull/32607) ([vxider](https://github.com/Vxider))。
- 修复了 `clickhouse-keeper` 中使用显式数字哈希的 ACL 问题:现在行为与 ZooKeeper 一致,生成的摘要始终被接受。[#33249](https://github.com/ClickHouse/ClickHouse/pull/33249) ([小路](https://github.com/nicelulu))。[#33246](https://github.com/ClickHouse/ClickHouse/pull/33246)。
- 修复了分离数据部分时意外删除投影的问题。[#32067](https://github.com/ClickHouse/ClickHouse/pull/32067) ([Amos Bird](https://github.com/amosbird))。

#### 改进 {#improvement-11}


* 现在，生成早于 `1970-01-01 00:00:00` 的时间值的日期时间转换函数将被饱和为零，而不是发生溢出。[#29953](https://github.com/ClickHouse/ClickHouse/pull/29953) ([Amos Bird](https://github.com/amosbird))。这还修复了在索引分析中，一个日期截断函数如果产生 Unix 纪元之前的结果时会触发的错误。
* 始终在客户端中显示资源使用情况（总 CPU 使用率、总 RAM 使用量以及每个主机的最大 RAM 使用量）。 [#33271](https://github.com/ClickHouse/ClickHouse/pull/33271) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 改进 `Bool` 类型的序列化和反序列化，并校验取值范围。[#32984](https://github.com/ClickHouse/ClickHouse/pull/32984)（[Kruglov Pavel](https://github.com/Avogar)）。
* 如果通过 `SET` 查询或在 HTTP 请求中通过查询参数定义了无效设置，错误消息将包含与该无效设置名称相近的设置建议（如果有的话）。[#32946](https://github.com/ClickHouse/ClickHouse/pull/32946) ([Antonio Andelic](https://github.com/antonio2368))。
* 为 `clickhouse-client` 和 `clickhouse-local` 中拼写错误的设置名称提供提示支持。修复 [#32237](https://github.com/ClickHouse/ClickHouse/issues/32237)。[#32841](https://github.com/ClickHouse/ClickHouse/pull/32841)（[凌涛](https://github.com/lingtaolf)）。
* 允许在物化视图中使用虚拟列。修复 [#11210](https://github.com/ClickHouse/ClickHouse/issues/11210)。[#33482](https://github.com/ClickHouse/ClickHouse/pull/33482) ([OnePiece](https://github.com/zhongyuankai))。
* 在需要时为 clickhouse-keeper 添加用于禁用 IPv6 的配置选项。此更改解决了 [#33381](https://github.com/ClickHouse/ClickHouse/issues/33381)。[#33450](https://github.com/ClickHouse/ClickHouse/pull/33450)（[Wu Xueyang](https://github.com/wuxueyang96)）。
* 向 `system.build_options` 中添加更多当前 git 提交版本的信息。[#33431](https://github.com/ClickHouse/ClickHouse/pull/33431) ([taiyang-li](https://github.com/taiyang-li))。
* `clickhouse-local`：在启用 `--max_memory_usage_in_client` 选项时跟踪内存使用情况。[#33341](https://github.com/ClickHouse/ClickHouse/pull/33341) ([Azat Khuzhin](https://github.com/azat))。
* 在函数 `intervalLengthSum` 中允许负区间，它们的长度也会被计入。这解决了 [#33323](https://github.com/ClickHouse/ClickHouse/issues/33323)。[#33335](https://github.com/ClickHouse/ClickHouse/pull/33335)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `LineAsString` 可用作输出格式。已关闭 [#30919](https://github.com/ClickHouse/ClickHouse/issues/30919)。[#33331](https://github.com/ClickHouse/ClickHouse/pull/33331)（[Sergei Trifonov](https://github.com/serxa)）。
* 在集群配置中支持使用 `<secure/>`，作为 `<secure>1</secure>` 的一种替代表达形式。关闭 [#33270](https://github.com/ClickHouse/ClickHouse/issues/33270)。[#33330](https://github.com/ClickHouse/ClickHouse/pull/33330)（[SuperDJY](https://github.com/cmsxbc)）。
* 连续按下两次 Ctrl+C 将立即终止 `clickhouse-benchmark`，而不会等待正在执行的查询完成。此更改解决了 [#32586](https://github.com/ClickHouse/ClickHouse/issues/32586)。[#33303](https://github.com/ClickHouse/ClickHouse/pull/33303)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 在 `parseDateTimeBestEffort` 函数中支持带毫秒的 Unix 时间戳。[#33276](https://github.com/ClickHouse/ClickHouse/pull/33276) ([Ben](https://github.com/benbiti))。
* 允许在以 `Arrow` / `Parquet` / `ORC` 格式从外部表读取数据时取消查询 —— 在处理大文件且将 input&#95;format&#95;allow&#95;seeks 设置为 false 的情况下，此前无法取消查询。修复了 [#29678](https://github.com/ClickHouse/ClickHouse/issues/29678)。[#33238](https://github.com/ClickHouse/ClickHouse/pull/33238)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 如果表引擎支持 `SETTINGS` 子句，则允许以键值对或通过配置文件传递设置。为 MySQL 添加了此支持。[#33231](https://github.com/ClickHouse/ClickHouse/pull/33231) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 在必要时正确禁止使用 `Nullable` 主键。相关问题见 [#32780](https://github.com/ClickHouse/ClickHouse/issues/32780)。[#33218](https://github.com/ClickHouse/ClickHouse/pull/33218)（[Amos Bird](https://github.com/amosbird)）。
* 在尚未获取到任何数据的情况下，为 `PostgreSQL` 连接添加重试机制。修复 [#33199](https://github.com/ClickHouse/ClickHouse/issues/33199)。[#33209](https://github.com/ClickHouse/ClickHouse/pull/33209)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 校验外部字典的配置键。[#33095](https://github.com/ClickHouse/ClickHouse/issues/33095#issuecomment-1000577517)。[#33130](https://github.com/ClickHouse/ClickHouse/pull/33130) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 在 `clickhouse-local` 中发送配置文件信息。修复 [#33093](https://github.com/ClickHouse/ClickHouse/issues/33093)。[#33097](https://github.com/ClickHouse/ClickHouse/pull/33097)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 短路求值：支持函数 `throwIf`。修复 [#32969](https://github.com/ClickHouse/ClickHouse/issues/32969)。[#32973](https://github.com/ClickHouse/ClickHouse/pull/32973)（[Maksim Kita](https://github.com/kitaisreal)）。
* （仅在非官方构建中会发生）。修复了在向压缩的 Decimal、String、FixedString 和 Array 列插入数据时出现的段错误。修复了 [#32939](https://github.com/ClickHouse/ClickHouse/issues/32939)。[#32940](https://github.com/ClickHouse/ClickHouse/pull/32940)（[N. Kolotov](https://github.com/nkolotov)）。
* 新增支持将子查询指定为 SQL 用户定义函数。例如：`CREATE FUNCTION test AS () -> (SELECT 1)`。修复了 [#30755](https://github.com/ClickHouse/ClickHouse/issues/30755)。[#32758](https://github.com/ClickHouse/ClickHouse/pull/32758)（[Maksim Kita](https://github.com/kitaisreal)）。
* 改进 gRPC 压缩功能支持，参见 [#28671](https://github.com/ClickHouse/ClickHouse/issues/28671)。[#32747](https://github.com/ClickHouse/ClickHouse/pull/32747)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 在关闭服务器或分离表时，如果未启用 WAL，则刷新所有内存数据分段。 [#32742](https://github.com/ClickHouse/ClickHouse/pull/32742) ([nauta](https://github.com/nautaa)).
* 允许控制 MySQL 的连接超时时间（此前仅在字典源中受支持）。修复了 [#16669](https://github.com/ClickHouse/ClickHouse/issues/16669)。此前默认的 `connect_timeout` 值相当小，现在可以进行配置。[#32734](https://github.com/ClickHouse/ClickHouse/pull/32734) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 为 `MongoDB` 存储引擎增加对 `authSource` 选项的支持。修复 [#32594](https://github.com/ClickHouse/ClickHouse/issues/32594)。[#32702](https://github.com/ClickHouse/ClickHouse/pull/32702)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在 `genarateRandom` 表函数中增加对 `Date32` 类型的支持。[#32643](https://github.com/ClickHouse/ClickHouse/pull/32643) ([nauta](https://github.com/nautaa)).
* 添加 `max_concurrent_select_queries` 和 `max_concurrent_insert_queries` 设置，用于按查询类型控制并发查询。修复 [#3575](https://github.com/ClickHouse/ClickHouse/issues/3575)。[#32609](https://github.com/ClickHouse/ClickHouse/pull/32609)（[SuperDJY](https://github.com/cmsxbc)）。
* 改进在读取 `Protobuf` 格式数据时对包含缺失列的嵌套结构的处理。是对 [https://github.com/ClickHouse/ClickHouse/pull/31988](https://github.com/ClickHouse/ClickHouse/pull/31988) 的后续优化。[#32531](https://github.com/ClickHouse/ClickHouse/pull/32531)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 允许 `MongoDB` 引擎使用空凭据。关闭 [#26267](https://github.com/ClickHouse/ClickHouse/issues/26267)。[#32460](https://github.com/ClickHouse/ClickHouse/pull/32460)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 禁用某些可能导致异常的窗口函数优化。修复了 [#31535](https://github.com/ClickHouse/ClickHouse/issues/31535)。修复了 [#31620](https://github.com/ClickHouse/ClickHouse/issues/31620)。[#32453](https://github.com/ClickHouse/ClickHouse/pull/32453)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 支持连接到 MongoDB 5.0。修复了 [#31483](https://github.com/ClickHouse/ClickHouse/issues/31483)、[#32416](https://github.com/ClickHouse/ClickHouse/pull/32416)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 支持 `Decimal` 与 `Float` 类型之间的比较。修复了 [#22626](https://github.com/ClickHouse/ClickHouse/issues/22626)。[#31966](https://github.com/ClickHouse/ClickHouse/pull/31966)（[flynn](https://github.com/ucasFL)）。
* 为 `StorageExecutable`、`StorageExecutablePool`、`ExecutableDictionary`、`ExecutablePoolDictionary`、`ExecutableUserDefinedFunctions` 新增了设置 `command_read_timeout` 和 `command_write_timeout`。设置 `command_read_timeout` 控制从命令 stdout 读取数据的超时时间，单位为毫秒。设置 `command_write_timeout` 控制向命令 stdin 写入数据的超时时间，单位为毫秒。为 `ExecutableUserDefinedFunction`、`ExecutableDictionary`、`StorageExecutable` 新增了设置 `command_termination_timeout`。为 `ExecutableUserDefinedFunction` 新增了设置 `execute_direct`，默认值为 true。为 `ExecutableDictionary`、`ExecutablePoolDictionary` 新增了设置 `execute_direct`，默认值为 false。[#30957](https://github.com/ClickHouse/ClickHouse/pull/30957) ([Maksim Kita](https://github.com/kitaisreal))。
* 对于超出范围的参数，Bitmap 聚合函数将返回正确结果，而不是发生溢出回绕。 [#33127](https://github.com/ClickHouse/ClickHouse/pull/33127) ([DR](https://github.com/freedomDR))。
* 修复解析包含 `FROM INFILE` 子句的错误查询时出现的问题。 [#33521](https://github.com/ClickHouse/ClickHouse/pull/33521) ([Kruglov Pavel](https://github.com/Avogar)).
* 如果路径包含通配符，则禁止写入 `S3`。 [#33142](https://github.com/ClickHouse/ClickHouse/pull/33142) ([Kruglov Pavel](https://github.com/Avogar)).
* 在批处理模式下执行单个查询时，`clickhouse-client` 不会使用 `--echo` 选项。 [#32843](https://github.com/ClickHouse/ClickHouse/pull/32843) ([N. Kolotov](https://github.com/nkolotov)).
* 在 clickhouse-local 中使用 `--database` 选项。[#32797](https://github.com/ClickHouse/ClickHouse/pull/32797)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复了 SQL 普通函数 `file` 中出人意料的糟糕代码。现在它支持符号链接。 [#32640](https://github.com/ClickHouse/ClickHouse/pull/32640) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 在数据部分移动后，更新 `system.parts` 中该数据部分的 `modification_time` [#32964](https://github.com/ClickHouse/ClickHouse/issues/32964)。 [#32965](https://github.com/ClickHouse/ClickHouse/pull/32965) ([save-my-heart](https://github.com/save-my-heart))。
* 潜在问题，无法被利用：在调整数组大小时可能发生整数溢出。[#33024](https://github.com/ClickHouse/ClickHouse/pull/33024) ([varadarajkumar](https://github.com/varadarajkumar))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-11}

- 为 ClickHouse 的 AArch64 (ARM) 版本添加软件包、功能测试和 Docker 构建。[#32911](https://github.com/ClickHouse/ClickHouse/pull/32911) ([Mikhail f. Shiryaev](https://github.com/Felixoid)). [#32415](https://github.com/ClickHouse/ClickHouse/pull/32415)
- 准备使用 musl-libc 构建 ClickHouse。默认未启用。[#33134](https://github.com/ClickHouse/ClickHouse/pull/33134) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- 使安装脚本可在 FreeBSD 上运行。此更改关闭了 [#33384](https://github.com/ClickHouse/ClickHouse/issues/33384)。[#33418](https://github.com/ClickHouse/ClickHouse/pull/33418) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- 为 GitHub Actions 工作流添加 `actionlint`,并通过 `act --list` 验证工作流文件以检查工作流语法的正确性。[#33612](https://github.com/ClickHouse/ClickHouse/pull/33612) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- 为可空主键功能添加更多测试。添加了使用不同数据类型和合并树类型的更多测试,以及随机生成的数据。[#33228](https://github.com/ClickHouse/ClickHouse/pull/33228) ([Amos Bird](https://github.com/amosbird)).
- 添加一个简单的工具,用于在 Web 浏览器中可视化不稳定的测试。[#33185](https://github.com/ClickHouse/ClickHouse/pull/33185) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- 为共享构建启用封闭式构建。此功能主要面向开发人员。[#32968](https://github.com/ClickHouse/ClickHouse/pull/32968) ([Amos Bird](https://github.com/amosbird)).
- 将 `libc++` 和 `libc++abi` 更新到最新版本。[#32484](https://github.com/ClickHouse/ClickHouse/pull/32484) ([Raúl Marín](https://github.com/Algunenano)).
- 为外部 .NET 客户端 ([ClickHouse.Client](https://github.com/DarkWanderer/ClickHouse.Client)) 添加集成测试。[#23230](https://github.com/ClickHouse/ClickHouse/pull/23230) ([Oleg V. Kozlyuk](https://github.com/DarkWanderer)).
- 将 git 信息注入到 ClickHouse 二进制文件中。这样我们可以轻松地从 ClickHouse 二进制文件中获取源代码修订版本。[#33124](https://github.com/ClickHouse/ClickHouse/pull/33124) ([taiyang-li](https://github.com/taiyang-li)).
- 从 ConfigProcessor 中移除过时的代码。Yandex 特定代码不再使用。该代码包含一个小缺陷。此缺陷由 [Mallik Hassan](https://github.com/SadiHassan) 在 [#33032](https://github.com/ClickHouse/ClickHouse/issues/33032) 中报告。此更改关闭了 [#33032](https://github.com/ClickHouse/ClickHouse/issues/33032)。[#33026](https://github.com/ClickHouse/ClickHouse/pull/33026) ([alexey-milovidov](https://github.com/alexey-milovidov)).

#### Bug 修复(官方稳定版或预发布版本中用户可见的错误行为){#bug-fix-user-visible-misbehavior-in-official-stable-or-prestable-release-4}


* 对格式解析进行了多项修复。如果将 `clickhouse-server` 对攻击者开放写入权限，这些问题就会产生影响。精心构造的 `Native` 格式输入数据可能导致读取未初始化内存或导致崩溃。如果将 `clickhouse-server` 对攻击者开放写入权限，这些问题就会产生影响。 [#33050](https://github.com/ClickHouse/ClickHouse/pull/33050) ([Heena Bansal](https://github.com/HeenaBansal2009))。修复了 Apache Avro 二进制格式中 Apache Avro Union 类型索引越界的问题。 [#33022](https://github.com/ClickHouse/ClickHouse/pull/33022) ([Harry Lee](https://github.com/HarryLeeIBM))。修复了在 `Native` 格式反序列化 `LowCardinality` 数据时出现的空指针解引用问题。 [#33021](https://github.com/ClickHouse/ClickHouse/pull/33021) ([Harry Lee](https://github.com/HarryLeeIBM))。
* 在发送响应后，ClickHouse Keeper 处理器会正确移除该操作。[#32988](https://github.com/ClickHouse/ClickHouse/pull/32988) ([JackyWoo](https://github.com/JackyWoo)).
* 潜在的配额 off-by-one 计算错误：配额上限尚未达到，却被判定为已超出限制。此修复解决了 [#31174](https://github.com/ClickHouse/ClickHouse/issues/31174)。[#31656](https://github.com/ClickHouse/ClickHouse/pull/31656)（[sunny](https://github.com/sunny19930321)）。
* 修复了从 String 到 IPv4 或 IPv6 以及再转换回来的 CAST 行为。修复了在转换失败时的错误消息。[#29224](https://github.com/ClickHouse/ClickHouse/pull/29224) ([Dmitry Novik](https://github.com/novikd)) [#27914](https://github.com/ClickHouse/ClickHouse/pull/27914) ([Vasily Nemkov](https://github.com/Enmk))。
* 修复了在远程服务器执行时出现的类似 `Unknown aggregate function nothing` 的异常。此修复解决了 [#16689](https://github.com/ClickHouse/ClickHouse/issues/16689)。[#26074](https://github.com/ClickHouse/ClickHouse/pull/26074)（[hexiaoting](https://github.com/hexiaoting)）。
* 修复分布式查询中未显式指定数据库时 `JOIN` 使用错误数据库的问题（修复：[ #10471 ](https://github.com/ClickHouse/ClickHouse/issues/10471)）。[ #33611 ](https://github.com/ClickHouse/ClickHouse/pull/33611)（[Azat Khuzhin](https://github.com/azat)）。
* 修复在向文件进行第二次插入后会在 Apache `Avro` 格式中出现的段错误。[#33566](https://github.com/ClickHouse/ClickHouse/pull/33566) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复当模式包含 `Dictionary` 类型时 Apache `Arrow` 格式中的段错误。修复关联的 [#33507](https://github.com/ClickHouse/ClickHouse/issues/33507)。[#33529](https://github.com/ClickHouse/ClickHouse/pull/33529)（[Kruglov Pavel](https://github.com/Avogar)）。
* 用于视图的带外 `offset` 和 `limit` 设置可能被错误应用。关闭 [#33289](https://github.com/ClickHouse/ClickHouse/issues/33289) [#33518](https://github.com/ClickHouse/ClickHouse/pull/33518)（[hexiaoting](https://github.com/hexiaoting)）。
* 修复在向包含默认嵌套 `LowCardinality` 列的表中插入数据时可能出现的 `Block structure mismatch` 异常。修复了 [#33028](https://github.com/ClickHouse/ClickHouse/issues/33028)。[#33504](https://github.com/ClickHouse/ClickHouse/pull/33504)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复通过 DDL 创建的 `range_hashed` 字典中范围最小值和范围最大值属性的表达式。关闭 [#30809](https://github.com/ClickHouse/ClickHouse/issues/30809)。[#33478](https://github.com/ClickHouse/ClickHouse/pull/33478)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复在向物化视图执行 INSERT 时与并发执行 DROP 同时发生时可能出现的 use-after-free 问题（[Azat Khuzhin](https://github.com/azat)）。
* 不要在 EOF 之后继续读取（这是为规避 Linux 内核中的一个 bug），该 bug 可以在内核版本 (3.14..5.9) 上复现，并且需要设置 `index_granularity_bytes=0`（即关闭自适应索引粒度）。[#33372](https://github.com/ClickHouse/ClickHouse/pull/33372)（[Azat Khuzhin](https://github.com/azat)）。
* 命令 `SYSTEM SUSPEND` 和 `SYSTEM ... THREAD FUZZER` 之前缺少访问控制，现已修复。作者：Kevin Michel。 [#33333](https://github.com/ClickHouse/ClickHouse/pull/33333) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 修复了字典的 `COMMENT` 在 `system.tables`、`system.dictionaries` 中不显示的问题。允许修改 `Dictionary` 引擎的注释。修复了 [#33251](https://github.com/ClickHouse/ClickHouse/issues/33251)。[#33261](https://github.com/ClickHouse/ClickHouse/pull/33261)（[Maksim Kita](https://github.com/kitaisreal)）。
* 将异步插入（启用 `async_insert` 设置时）添加到查询日志中。此前，此类查询不会记录在查询日志中。[#33239](https://github.com/ClickHouse/ClickHouse/pull/33239) ([Anton Popov](https://github.com/CurtizJ))。
* 修复向外部数据库发送 `WHERE 1 = 0` 条件的查询问题。关闭 [#33152](https://github.com/ClickHouse/ClickHouse/issues/33152)。[#33214](https://github.com/ClickHouse/ClickHouse/pull/33214)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复 MaterializedPostgreSQL 的 DDL 校验。修复 `materialized_postgresql_allow_automatic_update` 设置。关闭 [#29535](https://github.com/ClickHouse/ClickHouse/issues/29535)。[#33200](https://github.com/ClickHouse/ClickHouse/pull/33200)（[Kseniia Sumarokova](https://github.com/kssenii)）。确保始终移除未使用的复制槽。在 [#26952](https://github.com/ClickHouse/ClickHouse/issues/26952) 中发现。[#33187](https://github.com/ClickHouse/ClickHouse/pull/33187)（[Kseniia Sumarokova](https://github.com/kssenii)）。修复 MaterializedPostgreSQL 对具有非默认 schema 的表执行 detach/attach（从复制中移除/添加）的逻辑。在 [#29535](https://github.com/ClickHouse/ClickHouse/issues/29535) 中发现。[#33179](https://github.com/ClickHouse/ClickHouse/pull/33179)（[Kseniia Sumarokova](https://github.com/kssenii)）。修复 DROP MaterializedPostgreSQL 数据库。[#33468](https://github.com/ClickHouse/ClickHouse/pull/33468)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 指标 `StorageBufferBytes` 有时会被错误地计算。 [#33159](https://github.com/ClickHouse/ClickHouse/pull/33159) ([xuyatian](https://github.com/xuyatian)).
* 修复在启用 `local_filesystem_read_prefetch` 或 `remote_filesystem_read_prefetch` 时，从 `LowCardinality` 列读取数据时出现 `Invalid version for SerializationLowCardinality key column` 错误的问题。[#33046](https://github.com/ClickHouse/ClickHouse/pull/33046) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复 `s3` 表函数在读取空文件时的问题。关闭 [#33008](https://github.com/ClickHouse/ClickHouse/issues/33008)。[#33037](https://github.com/ClickHouse/ClickHouse/pull/33037)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在 `cancel_http_readonly_queries_on_client_close` 场景下的 Context 泄漏问题（即已上传到服务器的外部表及其他资源发生泄漏）。 [#32982](https://github.com/ClickHouse/ClickHouse/pull/32982) ([Azat Khuzhin](https://github.com/azat)).
* 在使用自定义 CSV 分隔符时，修复了 `CSV` 格式中错误的元组输出。[#32981](https://github.com/ClickHouse/ClickHouse/pull/32981)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复了 HDFS URL 校验中不允许使用 HA NameNode 地址的问题。该缺陷引入于 [https://github.com/ClickHouse/ClickHouse/pull/31042](https://github.com/ClickHouse/ClickHouse/pull/31042)。[#32976](https://github.com/ClickHouse/ClickHouse/pull/32976)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复在使用非位置参数时，误抛出类似“positional argument out of bounds”的异常的问题。关闭 [#31173](https://github.com/ClickHouse/ClickHouse/issues/31173)#event-5789668239。 [#32961](https://github.com/ClickHouse/ClickHouse/pull/32961)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在通过 HTTP 查询填充 `set` 时遇到意外 EOF 时的 UB（例如客户端在中途中断，即执行 `timeout 0.15s curl -Ss -F 's=@t.csv;' 'http://127.0.0.1:8123/?s_structure=key+Int&query=SELECT+dummy+IN+s'` 且 `t.csv` 足够大时）。 [#32955](https://github.com/ClickHouse/ClickHouse/pull/32955) ([Azat Khuzhin](https://github.com/azat)).
* 修复 `replaceRegexpAll` 函数中的回归问题。当匹配到的子串为空时，该函数的行为不正确。此更改关闭了 [#32777](https://github.com/ClickHouse/ClickHouse/issues/32777)。此更改关闭了 [#30245](https://github.com/ClickHouse/ClickHouse/issues/30245)。[#32945](https://github.com/ClickHouse/ClickHouse/pull/32945)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复 `ORC` 格式的条带（stripe）读取。[#32929](https://github.com/ClickHouse/ClickHouse/pull/32929) ([kreuzerkrieg](https://github.com/kreuzerkrieg)).
* `topKWeightedState` 在某些输入类型上执行失败。[#32487](https://github.com/ClickHouse/ClickHouse/issues/32487)。[#32914](https://github.com/ClickHouse/ClickHouse/pull/32914)（[vdimir](https://github.com/vdimir)）。
* 修复物化视图中出现的异常 `Single chunk is expected from view inner query (LOGICAL_ERROR)`。修复了 [#31419](https://github.com/ClickHouse/ClickHouse/issues/31419)。[#32862](https://github.com/ClickHouse/ClickHouse/pull/32862)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复针对远程文件系统异步读取的延迟 seek 优化。关闭 [#32803](https://github.com/ClickHouse/ClickHouse/issues/32803)。[#32835](https://github.com/ClickHouse/ClickHouse/pull/32835)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `MergeTree` 表引擎在当前运行的 mutation 过多或内存占用过高时，可能会悄然跳过部分 mutation，该问题已修复。修复了 [#17882](https://github.com/ClickHouse/ClickHouse/issues/17882)。[#32814](https://github.com/ClickHouse/ClickHouse/pull/32814) ([tavplubix](https://github.com/tavplubix))。
* 在处理 MV 块时避免重用标量子查询缓存。此更改修复了当标量查询引用源表时出现的一个错误，但这也意味着 MV 定义中的所有子标量查询都将针对每个块重新计算。[#32811](https://github.com/ClickHouse/ClickHouse/pull/32811) ([Raúl Marín](https://github.com/Algunenano))。
* 如果使用 `MySQL` 引擎的数据库无法连接到 MySQL 服务器，可能会导致服务器无法启动，此问题已修复。修复 [#14441](https://github.com/ClickHouse/ClickHouse/issues/14441)。[#32802](https://github.com/ClickHouse/ClickHouse/pull/32802)（[tavplubix](https://github.com/tavplubix)）。
* 修复在使用 `fuzzBits` 函数时出现的崩溃，关闭 [#32737](https://github.com/ClickHouse/ClickHouse/issues/32737)。[#32755](https://github.com/ClickHouse/ClickHouse/pull/32755)（[SuperDJY](https://github.com/cmsxbc)）。
* 修复在基于 `Kafka`/`RabbitMQ` 的物化视图中使用 `GROUP BY (list of columns)`（该语句会被解析为 `GROUP BY tuple(...)`）时出现的 `Column is not under aggregate function` 错误。修复了 [#32668](https://github.com/ClickHouse/ClickHouse/issues/32668) 和 [#32744](https://github.com/ClickHouse/ClickHouse/issues/32744)。[#32751](https://github.com/ClickHouse/ClickHouse/pull/32751)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在 `TTL ... DELETE WHERE ...` 和 `TTL ... GROUP BY ...` 模式下执行的 `ALTER TABLE ... MATERIALIZE TTL` 查询。[#32695](https://github.com/ClickHouse/ClickHouse/pull/32695) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在表引擎为 `Distributed` 或 `Merge`，且其底层 `MergeTree` 表的排序键前缀中包含单调函数时的 `optimize_read_in_order` 优化问题。 [#32670](https://github.com/ClickHouse/ClickHouse/pull/32670) ([Anton Popov](https://github.com/CurtizJ)).
* 修复当物化视图的目标是 `JOIN` 或 `SET` 表时出现的 `LOGICAL_ERROR` 异常。[#32669](https://github.com/ClickHouse/ClickHouse/pull/32669) ([Raúl Marín](https://github.com/Algunenano))。
* 使用多部分上传方式向 S3 写入到 Google Cloud Storage 时可能会触发中止操作。[#32504](https://github.com/ClickHouse/ClickHouse/issues/32504)。[#32649](https://github.com/ClickHouse/ClickHouse/pull/32649) ([vdimir](https://github.com/vdimir))。
* 通过延迟创建通道来修复 `RabbitMQ` 存储在启动时可能出现的异常。[#32584](https://github.com/ClickHouse/ClickHouse/pull/32584) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 在并行执行 `DROP TABLE` 和 `INSERT` 时，修复表生命周期问题（即可能出现 use-after-free）。[#32572](https://github.com/ClickHouse/ClickHouse/pull/32572) ([Azat Khuzhin](https://github.com/azat))。
* 修复了使用 `CustomSeparated`、`Template`、`Regexp`、`MsgPack` 和 `JSONAsString` 等格式的异步插入行为。此前，这些格式下的异步插入不会读取任何数据。[#32530](https://github.com/ClickHouse/ClickHouse/pull/32530) ([Kruglov Pavel](https://github.com/Avogar))。
* 修复分布式表中的 `groupBitmapAnd` 函数。[#32529](https://github.com/ClickHouse/ClickHouse/pull/32529) ([minhthucdao](https://github.com/dmthuc))。
* 修复由模糊测试工具发现的 `JOIN` 崩溃问题，关闭 [#32458](https://github.com/ClickHouse/ClickHouse/issues/32458)。[#32508](https://github.com/ClickHouse/ClickHouse/pull/32508) ([vdimir](https://github.com/vdimir))。
* 对 Apache Arrow 列重复情况的正确处理。[#32507](https://github.com/ClickHouse/ClickHouse/pull/32507)（[Dmitriy Mokhnatkin](https://github.com/DMokhnatkin)）。
* 修复了分布式查询中存在的查询格式歧义问题，该问题会在部分表的列名为 `ALL` 或 `DISTINCT` 时导致错误。修复关联的 issue [#32391](https://github.com/ClickHouse/ClickHouse/issues/32391)。[#32490](https://github.com/ClickHouse/ClickHouse/pull/32490)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 修复了在查询尝试使用尚未物化的跳过索引时导致的失败问题。修复了 [#32292](https://github.com/ClickHouse/ClickHouse/issues/32292) 和 [#30343](https://github.com/ClickHouse/ClickHouse/issues/30343)。[#32359](https://github.com/ClickHouse/ClickHouse/pull/32359)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复在同一列上存在超过 2 个行策略时，在同一会话中从第二个查询开始会出错的 `SELECT` 查询。[#31606](https://github.com/ClickHouse/ClickHouse/issues/31606)。[#32291](https://github.com/ClickHouse/ClickHouse/pull/32291)（[SuperDJY](https://github.com/cmsxbc)）。
* 修复了将带小数的 unix 时间戳转换为 `DateTime64` 时的问题，对于负的 unix 时间戳（早于 1970-01-01），其小数部分被颠倒。 [#32240](https://github.com/ClickHouse/ClickHouse/pull/32240) ([Ben](https://github.com/benbiti)).
* 复制队列中的某些条目可能会在 `temporary_directories_lifetime`（默认 1 天）这一时长内一直处于挂起状态，并报出 `Directory tmp_merge_<part_name>` 或 `Part ... (state Deleting) already exists, but it will be deleted soon` 等类似错误。该问题已修复。修复了 [#29616](https://github.com/ClickHouse/ClickHouse/issues/29616)。[#32201](https://github.com/ClickHouse/ClickHouse/pull/32201) ([tavplubix](https://github.com/tavplubix))。
* 修复 `APPLY lambda` 列转换器的解析问题，该问题可能导致客户端或服务器崩溃。[#32138](https://github.com/ClickHouse/ClickHouse/pull/32138)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复 `base64Encode` 在短字符串上多附加尾字节的问题。[#31797](https://github.com/ClickHouse/ClickHouse/pull/31797) ([Kevin Michel](https://github.com/kmichel-aiven))。
* 修复了在窗口函数使用 `LowCardinality` 参数时可能导致的崩溃或结果不正确的问题。修复了 [#31114](https://github.com/ClickHouse/ClickHouse/issues/31114)。[#31888](https://github.com/ClickHouse/ClickHouse/pull/31888)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复执行命令 `DROP TABLE system.query_log sync` 时出现的卡死问题。 [#33293](https://github.com/ClickHouse/ClickHouse/pull/33293) ([zhanghuajie](https://github.com/zhanghuajieHIT)).





## [2021 年更新日志](./2021.md) {#changelog-for-2021}
