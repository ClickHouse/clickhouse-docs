---
slug: /whats-new/changelog/2019
sidebar_position: 8
sidebar_label: '2019'
title: '2019 更新日志'
description: '2019 年更新日志'
doc_type: 'changelog'
keywords: ['ClickHouse 2019', '2019 更新日志', '发布说明', '版本历史', '历史版本']
---



## ClickHouse 版本 19.17 {#clickhouse-release-v19-17}

### ClickHouse 版本 19.17.6.36，2019-12-27 {#clickhouse-release-v19-17-6-36-2019-12-27}

#### 缺陷修复 {#bug-fix}



* 修复了 `decompress` 中潜在的缓冲区溢出问题。恶意用户可能传入伪造的压缩数据，从而导致对缓冲区的越界读取。该问题由 Yandex 信息安全团队的 Eldar Zaitov 发现。[#8404](https://github.com/ClickHouse/ClickHouse/pull/8404) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了在以下情况下可能发生的服务器崩溃（`std::terminate`）问题：当服务器无法以 JSON 或 XML 格式发送或写入包含 `String` 类型（需要进行 UTF-8 校验）值的数据时，或在使用 Brotli 算法压缩结果数据时，或在其他一些罕见情况下。 [#8384](https://github.com/ClickHouse/ClickHouse/pull/8384) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了以 ClickHouse 中的 `VIEW` 作为源的固定字典，现在读取此类字典时不会再触发 `There is no query` 错误。[#8351](https://github.com/ClickHouse/ClickHouse/pull/8351) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* 修复了根据 users.xml 中指定的 host&#95;regexp 判断客户端主机是否被允许的逻辑。[#8241](https://github.com/ClickHouse/ClickHouse/pull/8241), [#8342](https://github.com/ClickHouse/ClickHouse/pull/8342) ([Vitaly Baranov](https://github.com/vitlibar))
* 现在，对分布式表执行 `RENAME TABLE` 时，会在将数据发送到分片之前，先重命名包含已插入数据的目录。这样修复了连续重命名 `tableA->tableB`、`tableC->tableA` 时出现的问题。 [#8306](https://github.com/ClickHouse/ClickHouse/pull/8306) ([tavplubix](https://github.com/tavplubix))
* 通过 DDL 查询创建的 `range_hashed` 外部字典现在允许使用任意数值类型的区间。[#8275](https://github.com/ClickHouse/ClickHouse/pull/8275) ([alesapin](https://github.com/alesapin))
* 修复了 `INSERT INTO table SELECT ... FROM mysql(...)` 表函数。[#8234](https://github.com/ClickHouse/ClickHouse/pull/8234)（[tavplubix](https://github.com/tavplubix)）
* 修复了在向不存在的文件中执行 `INSERT INTO TABLE FUNCTION file()` 时出现的段错误。现在在这种情况下会先创建该文件，然后再处理插入操作。[#8177](https://github.com/ClickHouse/ClickHouse/pull/8177) ([Olga Khvostikova](https://github.com/stavrolia))
* 修复了在聚合 bitmap 与标量 bitmap 求交时出现的 bitmapAnd 错误。 [#8082](https://github.com/ClickHouse/ClickHouse/pull/8082) ([Yue Huang](https://github.com/moon03432))
* 修复了当 `EXISTS` 查询未带 `TABLE` 或 `DICTIONARY` 限定符（如 `EXISTS t`）时导致的段错误。 [#8213](https://github.com/ClickHouse/ClickHouse/pull/8213) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 在参数可为空的情况下，修正了函数 `rand` 和 `randConstant` 的返回类型。现在这些函数始终返回 `UInt32`，而不会返回 `Nullable(UInt32)`。 [#8204](https://github.com/ClickHouse/ClickHouse/pull/8204) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* 修复了 `DROP DICTIONARY IF EXISTS db.dict`，现在即使 `db` 不存在也不会抛出异常。 [#8185](https://github.com/ClickHouse/ClickHouse/pull/8185) ([Vitaly Baranov](https://github.com/vitlibar))
* 如果由于服务器崩溃导致表未完全删除，服务器将尝试恢复并加载该表 [#8176](https://github.com/ClickHouse/ClickHouse/pull/8176) ([tavplubix](https://github.com/tavplubix))
* 修复了在分布式表上执行简单的 count 查询时，当存在两个以上分片本地表时的问题。 [#8164](https://github.com/ClickHouse/ClickHouse/pull/8164) ([小路](https://github.com/nicelulu))
* 修复了 `DB::BlockStreamProfileInfo::calculateRowsBeforeLimit()` 中导致数据竞争的问题 [#8143](https://github.com/ClickHouse/ClickHouse/pull/8143) ([Alexander Kazakov](https://github.com/Akazz))
* 修复了在合并指定分片后立即执行的 `ALTER table MOVE part`，该问题可能会导致移动指定分片被合并到的目标分片。现在它会正确地只移动指定的分片。 [#8104](https://github.com/ClickHouse/ClickHouse/pull/8104) ([Vladimir Chebotarev](https://github.com/excitoon))
* 现在可以将字典的表达式指定为字符串。对于在从非 ClickHouse 数据源提取数据时计算属性的场景，这非常有用，因为它允许为这些表达式使用非 ClickHouse 语法。[#8098](https://github.com/ClickHouse/ClickHouse/pull/8098) ([alesapin](https://github.com/alesapin))
* 修复了 `clickhouse-copier` 中由于 ZXid 溢出而导致的一个极其罕见的竞争条件。 [#8088](https://github.com/ClickHouse/ClickHouse/pull/8088) ([Ding Xiang Fei](https://github.com/dingxiangfei2009))
* 修复了一个错误：在查询失败之后（例如由于 &quot;Too many simultaneous queries&quot;），不会读取外部表信息；随后下一个请求会将这些信息解释为下一条查询的开头，从而引发类似 `Unknown packet from client` 的错误。 [#8084](https://github.com/ClickHouse/ClickHouse/pull/8084) ([Azat Khuzhin](https://github.com/azat))
* 避免在出现 &quot;Unknown packet X from server&quot; 错误时发生空指针解引用 [#8071](https://github.com/ClickHouse/ClickHouse/pull/8071) ([Azat Khuzhin](https://github.com/azat))
* 恢复对所有 ICU 区域设置的支持，新增对常量表达式应用排序规则的支持，并在 system.collations 表中添加语言名称。 [#8051](https://github.com/ClickHouse/ClickHouse/pull/8051) ([alesapin](https://github.com/alesapin))
* 现在对从 `StorageFile` 和 `StorageHDFS` 读取时的读取流数量进行了限制，以避免内存超限。[#7981](https://github.com/ClickHouse/ClickHouse/pull/7981) ([alesapin](https://github.com/alesapin))
* 修复了在无主键的 `*MergeTree` 表上执行的 `CHECK TABLE` 查询。 [#7979](https://github.com/ClickHouse/ClickHouse/pull/7979) ([alesapin](https://github.com/alesapin))
* 在没有 mutations 的情况下，从 part 名称中移除了 mutation 编号。此更改提升了与旧版本的兼容性。[#8250](https://github.com/ClickHouse/ClickHouse/pull/8250) ([alesapin](https://github.com/alesapin))
* 修复了一个 bug：由于某些已附加 part 的 `data_version` 大于表的 mutation 版本，导致这些 part 的变更被跳过。 [#7812](https://github.com/ClickHouse/ClickHouse/pull/7812) ([Zhichang Yu](https://github.com/yuzhichang))
* 允许在将数据分片移动到其他设备后，即使存在冗余副本也能启动服务器。 [#7810](https://github.com/ClickHouse/ClickHouse/pull/7810) ([Vladimir Chebotarev](https://github.com/excitoon))
* 修复了在使用聚合函数列时可能出现的错误 “Sizes of columns does not match”。 [#7790](https://github.com/ClickHouse/ClickHouse/pull/7790) ([Boris Granveaud](https://github.com/bgranvea))
* 现在，如果将 WITH TIES 与 LIMIT BY 一起使用，将会抛出异常。现在也可以将 TOP 与 LIMIT BY 一起使用。[#7637](https://github.com/ClickHouse/ClickHouse/pull/7637) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
* 修复在字典配置了 `invalidate_query` 时的重载问题，该问题会导致更新停止，并在之前的更新尝试中抛出异常。 [#8029](https://github.com/ClickHouse/ClickHouse/pull/8029) ([alesapin](https://github.com/alesapin))



### ClickHouse 版本 19.17.4.11，2019-11-22 {#clickhouse-release-v19-17-4-11-2019-11-22}

#### 向后不兼容的变更 {#backward-incompatible-change}

- 为了获得更好的性能，使用列而不是 AST 来存储标量子查询结果。在 19.17 中新增了设置 `enable_scalar_subquery_optimization`，且默认开启。这会在从早期版本升级到 19.17.2 或 19.17.3 时导致类似[这里](https://github.com/ClickHouse/ClickHouse/issues/7851)的错误。此设置在 19.17.4 中默认改为禁用，以便可以从 19.16 及更早版本无错误地升级。 [#7392](https://github.com/ClickHouse/ClickHouse/pull/7392) ([Amos Bird](https://github.com/amosbird))

#### 新功能 {#new-feature}

- 支持使用 DDL 查询创建字典。[#7360](https://github.com/ClickHouse/ClickHouse/pull/7360) ([alesapin](https://github.com/alesapin))
- 使 `bloom_filter` 类型索引支持 `LowCardinality` 和 `Nullable`。[#7363](https://github.com/ClickHouse/ClickHouse/issues/7363) [#7561](https://github.com/ClickHouse/ClickHouse/pull/7561) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- 添加函数 `isValidJSON`，用于检查传入字符串是否为有效的 JSON。[#5910](https://github.com/ClickHouse/ClickHouse/issues/5910) [#7293](https://github.com/ClickHouse/ClickHouse/pull/7293) ([Vdimir](https://github.com/Vdimir))
- 实现 `arrayCompact` 函数。[#7328](https://github.com/ClickHouse/ClickHouse/pull/7328) ([Memo](https://github.com/Joeywzr))
- 新增用于 Decimal 数字的函数 `hex`。其行为类似于 `hex(reinterpretAsString())`，但不会删除末尾的零字节。[#7355](https://github.com/ClickHouse/ClickHouse/pull/7355) ([Mikhail Korotov](https://github.com/millb))
- 添加 `arrayFill` 和 `arrayReverseFill` 函数，它们会将数组中的元素替换为其前/后面的其他元素。[#7380](https://github.com/ClickHouse/ClickHouse/pull/7380) ([hcz](https://github.com/hczhcz))
- 添加对 `CRC32IEEE()`/`CRC64()` 的支持。[#7480](https://github.com/ClickHouse/ClickHouse/pull/7480) ([Azat Khuzhin](https://github.com/azat))
- 实现与 [MySQL](https://dev.mysql.com/doc/refman/8.0/en/string-functions.html#function_char) 中类似的 `char` 函数。[#7486](https://github.com/ClickHouse/ClickHouse/pull/7486) ([sundyli](https://github.com/sundy-li))
- 添加 `bitmapTransform` 函数。它将 bitmap 中的一组值转换为另一组值，结果为一个新的 bitmap。[#7598](https://github.com/ClickHouse/ClickHouse/pull/7598) ([Zhichang Yu](https://github.com/yuzhichang))
- 实现 `javaHashUTF16LE()` 函数。[#7651](https://github.com/ClickHouse/ClickHouse/pull/7651) ([achimbab](https://github.com/achimbab))
- 为 Distributed 引擎添加 `_shard_num` 虚拟列。[#7624](https://github.com/ClickHouse/ClickHouse/pull/7624) ([Azat Khuzhin](https://github.com/azat))

#### 实验性功能 {#experimental-feature}

- 在 `MergeTree` 中支持处理器（新的查询执行管道）。 [#7181](https://github.com/ClickHouse/ClickHouse/pull/7181) ([Nikolai Kochetov](https://github.com/KochetovNicolai))

#### Bug 修复 {#bug-fix-1}



* 修复 `Values` 中的浮点数解析错误 [#7817](https://github.com/ClickHouse/ClickHouse/issues/7817) [#7870](https://github.com/ClickHouse/ClickHouse/pull/7870) ([tavplubix](https://github.com/tavplubix))
* 修复在启用 `trace_log` 时可能发生的罕见死锁。[#7838](https://github.com/ClickHouse/ClickHouse/pull/7838) ([filimonov](https://github.com/filimonov))
* 在向存在任意从其读取的物化视图（MV）的 Kafka 表写入数据时，防止消息重复 [#7265](https://github.com/ClickHouse/ClickHouse/pull/7265) ([Ivan](https://github.com/abyss7))
* 在 `IN` 中添加对 `Array(LowCardinality(Nullable(String)))` 的支持。解决 [#7364](https://github.com/ClickHouse/ClickHouse/issues/7364) [#7366](https://github.com/ClickHouse/ClickHouse/pull/7366)（[achimbab](https://github.com/achimbab)）
* 在 ODBC Bridge 中新增对 `SQL_TINYINT` 和 `SQL_BIGINT` 的处理，并修复对 `SQL_FLOAT` 数据源类型的处理。[#7491](https://github.com/ClickHouse/ClickHouse/pull/7491) ([Denis Glazachev](https://github.com/traceon))
* 修复对空 decimal 列进行聚合（`avg` 和分位数）时的问题 [#7431](https://github.com/ClickHouse/ClickHouse/pull/7431)（[Andrey Konyaev](https://github.com/akonyaev90)）
* 修复对包含 `MATERIALIZED` 列的 Distributed 表执行 `INSERT` 时的问题 [#7377](https://github.com/ClickHouse/ClickHouse/pull/7377) ([Azat Khuzhin](https://github.com/azat))
* 当分区的部分数据已在目标磁盘或卷上时，使 `MOVE PARTITION` 也能正常工作 [#7434](https://github.com/ClickHouse/ClickHouse/pull/7434) ([Vladimir Chebotarev](https://github.com/excitoon))
* 修复了在多磁盘配置中，`ReplicatedMergeTree` 在执行 mutation 过程中创建硬链接失败的问题。 [#7558](https://github.com/ClickHouse/ClickHouse/pull/7558) ([Vladimir Chebotarev](https://github.com/excitoon))
* 修复了在 MergeTree 上执行 mutation 时，如果整个 part 保持不变且在另一块磁盘上寻找最佳存储位置时出现的 bug [#7602](https://github.com/ClickHouse/ClickHouse/pull/7602) ([Vladimir Chebotarev](https://github.com/excitoon))
* 修复了未能从磁盘配置中读取 `keep_free_space_ratio` 的问题 [#7645](https://github.com/ClickHouse/ClickHouse/pull/7645) ([Vladimir Chebotarev](https://github.com/excitoon))
* 修复当表只包含 `Tuple` 列或具有复杂路径的列时出现的 bug。修复了 [7541](https://github.com/ClickHouse/ClickHouse/issues/7541)。[#7545](https://github.com/ClickHouse/ClickHouse/pull/7545)（[alesapin](https://github.com/alesapin)）
* 不要在 `max_memory_usage` 限制中将 Buffer 引擎的内存计入统计 [#7552](https://github.com/ClickHouse/ClickHouse/pull/7552) ([Azat Khuzhin](https://github.com/azat))
* 修复按 `tuple()` 排序的 `MergeTree` 表中最终标记的使用方式。在极少数情况下，这可能会在执行查询时导致 `Can't adjust last granule` 错误。 [#7639](https://github.com/ClickHouse/ClickHouse/pull/7639) ([Anton Popov](https://github.com/CurtizJ))
* 修复在带有谓词且该谓词包含需要上下文的操作（例如 JSON 函数）的 mutation 中的错误，该错误可能导致崩溃或奇怪的异常。 [#7664](https://github.com/ClickHouse/ClickHouse/pull/7664) ([alesapin](https://github.com/alesapin))
* 修复 `data/` 和 `shadow/` 目录中数据库和表名转义规则不一致的问题 [#7575](https://github.com/ClickHouse/ClickHouse/pull/7575) ([Alexander Burmak](https://github.com/Alex-Burmak))
* 在 RIGHT|FULL JOIN 中支持重复键，例如 `ON t.x = u.x AND t.x = u.y`。修复此情况下的崩溃问题。[#7586](https://github.com/ClickHouse/ClickHouse/pull/7586) ([Artem Zuikov](https://github.com/4ertus2))
* 修复在使用 RIGHT 或 FULL JOIN 按表达式进行 JOIN 时出现的 `Not found column &lt;expression&gt; in block` 问题。[#7641](https://github.com/ClickHouse/ClickHouse/pull/7641) ([Artem Zuikov](https://github.com/4ertus2))
* 再次尝试修复 `PrettySpace` 格式中的死循环 [#7591](https://github.com/ClickHouse/ClickHouse/pull/7591) ([Olga Khvostikova](https://github.com/stavrolia))
* 修复 `concat` 函数在所有参数都是相同大小的 `FixedString` 类型时的错误。 [#7635](https://github.com/ClickHouse/ClickHouse/pull/7635) ([alesapin](https://github.com/alesapin))
* 修复了在使用单个参数定义 S3、URL 和 HDFS 存储时出现的异常。[#7618](https://github.com/ClickHouse/ClickHouse/pull/7618) ([Vladimir Chebotarev](https://github.com/excitoon))
* 修复带查询视图的 InterpreterSelectQuery 作用域问题 [#7601](https://github.com/ClickHouse/ClickHouse/pull/7601) ([Azat Khuzhin](https://github.com/azat))



#### 改进 {#improvement}

- 通过 ODBC-bridge 正确识别 `Nullable` 列并正确处理 NULL 值 [#7402](https://github.com/ClickHouse/ClickHouse/pull/7402) ([Vasily Nemkov](https://github.com/Enmk))
- 以原子方式写入当前批次数据用于分布式发送 [#7600](https://github.com/ClickHouse/ClickHouse/pull/7600) ([Azat Khuzhin](https://github.com/azat))
- 如果无法在查询中根据列名检测到对应的表，则抛出异常。[#7358](https://github.com/ClickHouse/ClickHouse/pull/7358) ([Artem Zuikov](https://github.com/4ertus2))
- 在 `MergeTreeSettings` 中添加 `merge_max_block_size` 设置 [#7412](https://github.com/ClickHouse/ClickHouse/pull/7412) ([Artem Zuikov](https://github.com/4ertus2))
- 带有 `HAVING` 但没有 `GROUP BY` 的查询会假定按常量分组。因此，现在 `SELECT 1 HAVING 1` 会返回结果。[#7496](https://github.com/ClickHouse/ClickHouse/pull/7496) ([Amos Bird](https://github.com/amosbird))
- 支持像 python 一样将 `(X,)` 解析为元组。[#7501](https://github.com/ClickHouse/ClickHouse/pull/7501), [#7562](https://github.com/ClickHouse/ClickHouse/pull/7562) ([Amos Bird](https://github.com/amosbird))
- 使 `range` 函数的行为尽可能接近 python 风格。[#7518](https://github.com/ClickHouse/ClickHouse/pull/7518) ([sundyli](https://github.com/sundy-li))
- 为表 `system.settings` 添加 `constraints` 列 [#7553](https://github.com/ClickHouse/ClickHouse/pull/7553) ([Vitaly Baranov](https://github.com/vitlibar))
- 改进 tcp handler 的 Null 格式，因此可以通过 clickhouse-client 使用 `select ignore(<expression>) from table format Null` 来进行性能测量 [#7606](https://github.com/ClickHouse/ClickHouse/pull/7606) ([Amos Bird](https://github.com/amosbird))
- 类似 `CREATE TABLE ... AS (SELECT (1, 2))` 的查询现在可以被正确解析 [#7542](https://github.com/ClickHouse/ClickHouse/pull/7542) ([hcz](https://github.com/hczhcz))

#### 性能改进 {#performance-improvement}

- 提升了针对短字符串键的聚合性能。[#6243](https://github.com/ClickHouse/ClickHouse/pull/6243) ([Alexander Kuzmenkov](https://github.com/akuzm), [Amos Bird](https://github.com/amosbird))
- 再执行一轮语法/表达式分析，以便在常量谓词折叠之后发现潜在的优化机会。[#7497](https://github.com/ClickHouse/ClickHouse/pull/7497) ([Amos Bird](https://github.com/amosbird))
- 使用存储元信息来评估简单的 `SELECT count() FROM table;` [#7510](https://github.com/ClickHouse/ClickHouse/pull/7510) ([Amos Bird](https://github.com/amosbird), [alexey-milovidov](https://github.com/alexey-milovidov))
- 向量化处理 `arrayReduce`，方式类似于 Aggregator 的 `addBatch`。[#7608](https://github.com/ClickHouse/ClickHouse/pull/7608) ([Amos Bird](https://github.com/amosbird))
- 对 `Kafka` 消费性能进行若干小幅改进 [#7475](https://github.com/ClickHouse/ClickHouse/pull/7475) ([Ivan](https://github.com/abyss7))

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement}



- 增加对交叉编译为 AARCH64 CPU 架构的支持。重构打包脚本。[#7370](https://github.com/ClickHouse/ClickHouse/pull/7370) [#7539](https://github.com/ClickHouse/ClickHouse/pull/7539) ([Ivan](https://github.com/abyss7))
- 在构建包时，将 darwin-x86_64 和 linux-aarch64 工具链解压到挂载的 Docker 卷中 [#7534](https://github.com/ClickHouse/ClickHouse/pull/7534) ([Ivan](https://github.com/abyss7))
- 更新二进制打包器（Binary Packager）的 Docker 镜像 [#7474](https://github.com/ClickHouse/ClickHouse/pull/7474) ([Ivan](https://github.com/abyss7))
- 修复在 macOS Catalina 上的编译错误 [#7585](https://github.com/ClickHouse/ClickHouse/pull/7585) ([Ernest Poletaev](https://github.com/ernestp))
- 对查询分析逻辑进行部分重构：将复杂类拆分为多个简单类。[#7454](https://github.com/ClickHouse/ClickHouse/pull/7454) ([Artem Zuikov](https://github.com/4ertus2))
- 修复在不包含子模块时的构建问题 [#7295](https://github.com/ClickHouse/ClickHouse/pull/7295) ([proller](https://github.com/proller))
- 改进 CMake 文件中的 `add_globs` [#7418](https://github.com/ClickHouse/ClickHouse/pull/7418) ([Amos Bird](https://github.com/amosbird))
- 删除 `unwind` 目标中硬编码的路径 [#7460](https://github.com/ClickHouse/ClickHouse/pull/7460) ([Konstantin Podshumok](https://github.com/podshumok))
- 允许在不使用 SSL 的情况下使用 MySQL 格式 [#7524](https://github.com/ClickHouse/ClickHouse/pull/7524) ([proller](https://github.com/proller))

#### 其他 {#other}

- 为 ClickHouse SQL 方言新增 ANTLR4 语法规则 [#7595](https://github.com/ClickHouse/ClickHouse/issues/7595) [#7596](https://github.com/ClickHouse/ClickHouse/pull/7596) ([alexey-milovidov](https://github.com/alexey-milovidov))



## ClickHouse Release 19.16 {#clickhouse-release-v19-16}

#### ClickHouse Release 19.16.14.65, 2020-03-25 {#clickhouse-release-v19-16-14-65-2020-03-25}

- 修复了在对多参数（三元）逻辑运算符（参数数量大于 10）进行批量计算时的一个错误。[#8718](https://github.com/ClickHouse/ClickHouse/pull/8718)（[Alexander Kazakov](https://github.com/Akazz)）该错误修复根据 Altinity 的特别请求回溯移植到了 19.16 版本。

#### ClickHouse Release 19.16.14.65, 2020-03-05 {#clickhouse-release-v19-16-14-65-2020-03-05}

- 修复了分布式子查询与旧版 CH 不兼容的问题。修复 [#7851](https://github.com/ClickHouse/ClickHouse/issues/7851)
    [(tabplubix)](https://github.com/tavplubix)
- 在执行 `CREATE` 查询时，对存储引擎参数中的常量表达式进行折叠。将空的数据库名替换为当前数据库。修复 [#6508](https://github.com/ClickHouse/ClickHouse/issues/6508)、[#3492](https://github.com/ClickHouse/ClickHouse/issues/3492)。同时修复了在 `ClickHouseDictionarySource` 中检查本地地址的问题。
    [#9262](https://github.com/ClickHouse/ClickHouse/pull/9262) [(tabplubix)](https://github.com/tavplubix)
- 现在，`*MergeTree` 表引擎族中的后台合并操作，能够更精确地保持存储策略各卷的顺序。
    [#8549](https://github.com/ClickHouse/ClickHouse/pull/8549)（[Vladimir Chebotarev](https://github.com/excitoon)）
- 防止在极少数情况下，在读取后缀之后但在提交之前抛出异常时导致 `Kafka` 中数据丢失。修复 [#9378](https://github.com/ClickHouse/ClickHouse/issues/9378)。相关问题：[#7175](https://github.com/ClickHouse/ClickHouse/issues/7175)
    [#9507](https://github.com/ClickHouse/ClickHouse/pull/9507) [(filimonov)](https://github.com/filimonov)
- 修复了当尝试使用/删除使用错误参数创建的 `Kafka` 表时，会导致服务器终止的错误。修复 [#9494](https://github.com/ClickHouse/ClickHouse/issues/9494)。合并了 [#9507](https://github.com/ClickHouse/ClickHouse/issues/9507)。
    [#9513](https://github.com/ClickHouse/ClickHouse/pull/9513) [(filimonov)](https://github.com/filimonov)
- 允许在 `Kafka` 表之上的子查询中使用 `MaterializedView`。
    [#8197](https://github.com/ClickHouse/ClickHouse/pull/8197)（[filimonov](https://github.com/filimonov)）

#### 新功能 {#new-feature-1}

- 新增 `deduplicate_blocks_in_dependent_materialized_views` 选项，用于控制向带有物化视图的表进行幂等插入时的行为。该新特性根据 Altinity 的特别请求被加入到了此错误修复版本中。
    [#9070](https://github.com/ClickHouse/ClickHouse/pull/9070) [(urykhy)](https://github.com/urykhy)

### ClickHouse Release 19.16.2.2, 2019-10-30 {#clickhouse-release-v19-16-2-2-2019-10-30}

#### 向后不兼容变更 {#backward-incompatible-change-1}

- 为 count/counIf 补充缺失的参数个数（arity）校验。
    [#7095](https://github.com/ClickHouse/ClickHouse/issues/7095)
    [#7298](https://github.com/ClickHouse/ClickHouse/pull/7298)（[Vdimir](https://github.com/Vdimir)）
- 移除已废弃的 `asterisk_left_columns_only` 设置（默认已禁用）。
    [#7335](https://github.com/ClickHouse/ClickHouse/pull/7335)（[Artem
    Zuikov](https://github.com/4ertus2)）
- Template 数据格式所使用的格式字符串现在需在文件中进行指定。
    [#7118](https://github.com/ClickHouse/ClickHouse/pull/7118)
    ([tavplubix](https://github.com/tavplubix))

#### 新功能 {#new-feature-2}



- 引入 `uniqCombined64()`，用于计算大于 `UINT_MAX` 的基数。
    [#7213](https://github.com/ClickHouse/ClickHouse/pull/7213),
    [#7222](https://github.com/ClickHouse/ClickHouse/pull/7222) ([Azat
    Khuzhin](https://github.com/azat))
- 支持在 `Array` 列上使用 Bloom 过滤器索引。
    [#6984](https://github.com/ClickHouse/ClickHouse/pull/6984)
    ([achimbab](https://github.com/achimbab))
- 新增函数 `getMacro(name)`，返回服务器配置中对应 `<macros>` 的值，类型为 `String`。
    [#7240](https://github.com/ClickHouse/ClickHouse/pull/7240)
    ([alexey-milovidov](https://github.com/alexey-milovidov))
- 为基于 HTTP 源的字典设置两个配置项：`credentials` 和
    `http-headers`。 [#7092](https://github.com/ClickHouse/ClickHouse/pull/7092) ([Guillaume
    Tassery](https://github.com/YiuRULE))
- 新增 `ProfileEvent` `Merge`，用于统计启动的后台合并次数。
    [#7093](https://github.com/ClickHouse/ClickHouse/pull/7093) ([Mikhail
    Korotov](https://github.com/millb))
- 新增 `fullHostName` 函数，返回完全限定域名（FQDN）。
    [#7263](https://github.com/ClickHouse/ClickHouse/issues/7263)
    [#7291](https://github.com/ClickHouse/ClickHouse/pull/7291) ([sundyli](https://github.com/sundy-li))
- 新增函数 `arraySplit` 和 `arrayReverseSplit`，用于按照“切断”条件拆分数组。
    它们在处理时间序列时非常有用。
    [#7294](https://github.com/ClickHouse/ClickHouse/pull/7294) ([hcz](https://github.com/hczhcz))
- 新增函数，用于在 `multiMatch` 系列函数中返回所有匹配索引组成的 `Array`。
    [#7299](https://github.com/ClickHouse/ClickHouse/pull/7299) ([Danila
    Kutenin](https://github.com/danlark1))
- 新增数据库引擎 `Lazy`，针对存储大量小型 `Log` 引擎表进行了优化。
    [#7171](https://github.com/ClickHouse/ClickHouse/pull/7171) ([Nikita
    Vasilev](https://github.com/nikvas0))
- 为 bitmap 列新增聚合函数 `groupBitmapAnd`、`groupBitmapOr`、`groupBitmapXor`。
    [#7109](https://github.com/ClickHouse/ClickHouse/pull/7109) ([Zhichang
    Yu](https://github.com/yuzhichang))
- 新增聚合函数组合子 `-OrNull` 和 `-OrDefault`，在没有可聚合数据时返回 `null`
    或默认值。
    [#7331](https://github.com/ClickHouse/ClickHouse/pull/7331)
    ([hcz](https://github.com/hczhcz))
- 引入 `CustomSeparated` 数据格式，支持自定义转义和
    分隔符规则。 [#7118](https://github.com/ClickHouse/ClickHouse/pull/7118)
    ([tavplubix](https://github.com/tavplubix))
- 支持使用 Redis 作为外部字典的数据源。 [#4361](https://github.com/ClickHouse/ClickHouse/pull/4361) [#6962](https://github.com/ClickHouse/ClickHouse/pull/6962) ([comunodi](https://github.com/comunodi), [Anton
    Popov](https://github.com/CurtizJ))

#### Bug 修复 {#bug-fix-2}



- 修复在查询包含 `WHERE IN (SELECT ...)` 子句且使用 `optimize_read_in_order` 时得到错误查询结果的问题。[#7371](https://github.com/ClickHouse/ClickHouse/pull/7371)（[Anton
    Popov](https://github.com/CurtizJ)）
- 禁用依赖于项目外部文件的 MariaDB 身份验证插件。
    [#7140](https://github.com/ClickHouse/ClickHouse/pull/7140)（[Yuriy
    Baranov](https://github.com/yurriy)）
- 修复在使用函数 `now()`, `today()`, `yesterday()`, `randConstant()` 时，极少数情况下可能出现的异常：
    `Cannot convert column ... because it is constant but values of constants are different in source and result`。
    [#7156](https://github.com/ClickHouse/ClickHouse/pull/7156)（[Nikolai
    Kochetov](https://github.com/KochetovNicolai)）
- 修复使用 HTTP keep alive 超时时间而非 TCP keep alive 超时时间的问题。
    [#7351](https://github.com/ClickHouse/ClickHouse/pull/7351)（[Vasily
    Nemkov](https://github.com/Enmk)）
- 修复在 groupBitmapOr 中的段错误（问题 [#7109](https://github.com/ClickHouse/ClickHouse/issues/7109)）。
    [#7289](https://github.com/ClickHouse/ClickHouse/pull/7289)（[Zhichang
    Yu](https://github.com/yuzhichang)）
- 对于物化视图，在所有数据写入完成后才对 Kafka 执行提交操作。
    [#7175](https://github.com/ClickHouse/ClickHouse/pull/7175)（[Ivan](https://github.com/abyss7)）
- 修复 `system.part_log` 表中错误的 `duration_ms` 值。原来的值偏差了十倍。
    [#7172](https://github.com/ClickHouse/ClickHouse/pull/7172)（[Vladimir
    Chebotarev](https://github.com/excitoon)）
- 快速修复 LIVE VIEW 表中的崩溃问题，并重新启用所有 LIVE VIEW 测试。
    [#7201](https://github.com/ClickHouse/ClickHouse/pull/7201)
    ([vzakaznikov](https://github.com/vzakaznikov))
- 在 MergeTree 数据片段的 min/max 索引中正确序列化 NULL 值。
    [#7234](https://github.com/ClickHouse/ClickHouse/pull/7234)（[Alexander
    Kuzmenkov](https://github.com/akuzm)）
- 当通过 `CREATE TABLE AS` 创建表时，不再将虚拟列写入 .sql 元数据。
    [#7183](https://github.com/ClickHouse/ClickHouse/pull/7183)（[Ivan](https://github.com/abyss7)）
- 修复在执行 `ATTACH PART` 查询时发生的段错误。
    [#7185](https://github.com/ClickHouse/ClickHouse/pull/7185)
    ([alesapin](https://github.com/alesapin))
- 修复由于对空 IN 子查询和空 INNER/RIGHT JOIN 的优化导致某些查询返回错误结果的问题。
    [#7284](https://github.com/ClickHouse/ClickHouse/pull/7284)（[Nikolai
    Kochetov](https://github.com/KochetovNicolai)）
- 修复 LIVE VIEW 的 getHeader() 方法中的 AddressSanitizer 错误。
    [#7271](https://github.com/ClickHouse/ClickHouse/pull/7271)
    ([vzakaznikov](https://github.com/vzakaznikov))

#### 改进 {#improvement-1}



- 在发生 `queue_wait_max_ms` 等待时添加一条消息。
    [#7390](https://github.com/ClickHouse/ClickHouse/pull/7390) ([Azat
    Khuzhin](https://github.com/azat))
- 将 `s3_min_upload_part_size` 设置改为表级别。
    [#7059](https://github.com/ClickHouse/ClickHouse/pull/7059) ([Vladimir
    Chebotarev](https://github.com/excitoon))
- 在 StorageFactory 中检查 TTL。 [#7304](https://github.com/ClickHouse/ClickHouse/pull/7304)
    ([sundyli](https://github.com/sundy-li))
- 在部分合并连接（partial merge join）中合并左侧数据块（优化）。
    [#7122](https://github.com/ClickHouse/ClickHouse/pull/7122) ([Artem
    Zuikov](https://github.com/4ertus2))
- 不允许在 Replicated 表引擎的 mutation 中使用非确定性函数，因为这可能会在副本之间引入不一致。
    [#7247](https://github.com/ClickHouse/ClickHouse/pull/7247) ([Alexander
    Kazakov](https://github.com/Akazz))
- 在将异常堆栈跟踪转换为字符串时禁用内存追踪器。这样可以防止服务端类型为 `Memory limit exceeded` 的错误消息丢失，否则可能会在客户端引发 `Attempt to read after eof` 异常。 [#7264](https://github.com/ClickHouse/ClickHouse/pull/7264)
    ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- 各种格式改进。解决了
    [#6033](https://github.com/ClickHouse/ClickHouse/issues/6033),
    [#2633](https://github.com/ClickHouse/ClickHouse/issues/2633),
    [#6611](https://github.com/ClickHouse/ClickHouse/issues/6611),
    [#6742](https://github.com/ClickHouse/ClickHouse/issues/6742)
    [#7215](https://github.com/ClickHouse/ClickHouse/pull/7215)
    ([tavplubix](https://github.com/tavplubix))
- ClickHouse 会忽略 IN 运算符右侧中无法转换为左侧类型的值。现在这一行为已对复合类型（`Array` 和 `Tuple`）也能正确生效。
    [#7283](https://github.com/ClickHouse/ClickHouse/pull/7283) ([Alexander
    Kuzmenkov](https://github.com/akuzm))
- 为 ASOF JOIN 支持缺失的不等式。现在可以在 ON 语法中，对 ASOF 列使用“小于等于”变体以及严格“大于”和“小于”变体来进行连接。
    [#7282](https://github.com/ClickHouse/ClickHouse/pull/7282) ([Artem
    Zuikov](https://github.com/4ertus2))
- 优化 partial merge join。 [#7070](https://github.com/ClickHouse/ClickHouse/pull/7070)
    ([Artem Zuikov](https://github.com/4ertus2))
- 在 `uniqCombined` 函数中不使用超过 98K 的内存。
    [#7236](https://github.com/ClickHouse/ClickHouse/pull/7236),
    [#7270](https://github.com/ClickHouse/ClickHouse/pull/7270) ([Azat
    Khuzhin](https://github.com/azat))
- 在 PartialMergeJoin 中将右侧连接表的部分数据刷写到磁盘（如果内存不足），并在需要时再将数据加载回来。 [#7186](https://github.com/ClickHouse/ClickHouse/pull/7186)
    ([Artem Zuikov](https://github.com/4ertus2))

#### 性能改进 {#performance-improvement-1}

- 通过避免数据复制，加速带常量参数的 `joinGet`。
    [#7359](https://github.com/ClickHouse/ClickHouse/pull/7359) ([Amos
    Bird](https://github.com/amosbird))
- 如果子查询为空则提前返回。
    [#7007](https://github.com/ClickHouse/ClickHouse/pull/7007) ([小路](https://github.com/nicelulu))
- 优化 `Values` 中 SQL 表达式的解析。
    [#6781](https://github.com/ClickHouse/ClickHouse/pull/6781)
    ([tavplubix](https://github.com/tavplubix))

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-1}



* 在针对 Mac OS 的交叉编译中禁用部分 contrib 组件。
  [#7101](https://github.com/ClickHouse/ClickHouse/pull/7101) ([Ivan](https://github.com/abyss7))
* 为 clickhouse&#95;common&#95;io 补充缺失的 PocoXML 链接。
  [#7200](https://github.com/ClickHouse/ClickHouse/pull/7200) ([Azat
  Khuzhin](https://github.com/azat))
* 在 clickhouse-test 中支持多个测试过滤参数。
  [#7226](https://github.com/ClickHouse/ClickHouse/pull/7226) ([Alexander
  Kuzmenkov](https://github.com/akuzm))
* 在 ARM 平台上启用 musl 和 jemalloc。[#7300](https://github.com/ClickHouse/ClickHouse/pull/7300)
  ([Amos Bird](https://github.com/amosbird))
* 为 `clickhouse-test` 新增 `--client-option` 参数，以便向客户端传递额外参数。
  [#7277](https://github.com/ClickHouse/ClickHouse/pull/7277) ([Nikolai
  Kochetov](https://github.com/KochetovNicolai))
* 升级 RPM 软件包时保留现有配置。
  [#7103](https://github.com/ClickHouse/ClickHouse/pull/7103)
  ([filimonov](https://github.com/filimonov))
* 修复由 PVS 检测到的错误。 [#7153](https://github.com/ClickHouse/ClickHouse/pull/7153) ([Artem
  Zuikov](https://github.com/4ertus2))
* 修复 Darwin 平台上的构建。 [#7149](https://github.com/ClickHouse/ClickHouse/pull/7149)
  ([Ivan](https://github.com/abyss7))
* glibc 2.29 兼容性。 [#7142](https://github.com/ClickHouse/ClickHouse/pull/7142) ([Amos
  Bird](https://github.com/amosbird))
* 确保 `dh_clean` 不会清理潜在的源文件。
  [#7205](https://github.com/ClickHouse/ClickHouse/pull/7205) ([Amos
  Bird](https://github.com/amosbird))
* 尝试在从 Altinity RPM 更新时避免冲突——其配置文件被单独打包在 clickhouse-server-common 中。[#7073](https://github.com/ClickHouse/ClickHouse/pull/7073)
  ([filimonov](https://github.com/filimonov))
* 优化部分头文件以缩短重建时间。
  [#7212](https://github.com/ClickHouse/ClickHouse/pull/7212),
  [#7231](https://github.com/ClickHouse/ClickHouse/pull/7231) ([Alexander
  Kuzmenkov](https://github.com/akuzm))
* 为 Date 和 DateTime 添加性能测试。 [#7332](https://github.com/ClickHouse/ClickHouse/pull/7332) ([Vasily
  Nemkov](https://github.com/Enmk))
* 修复了一些包含非确定性变更操作的测试。
  [#7132](https://github.com/ClickHouse/ClickHouse/pull/7132) ([Alexander
  Kazakov](https://github.com/Akazz))
* 在 CI 中添加启用 MemorySanitizer 的构建。[#7066](https://github.com/ClickHouse/ClickHouse/pull/7066)
  ([Alexander Kuzmenkov](https://github.com/akuzm))
* 避免在 MetricsTransmitter 中使用未初始化的值。
  [#7158](https://github.com/ClickHouse/ClickHouse/pull/7158) ([Azat
  Khuzhin](https://github.com/azat))
* 修复了 MemorySanitizer 在 Fields 中发现的若干问题。
  [#7135](https://github.com/ClickHouse/ClickHouse/pull/7135),
  [#7179](https://github.com/ClickHouse/ClickHouse/pull/7179) ([Alexander
  Kuzmenkov](https://github.com/akuzm)), [#7376](https://github.com/ClickHouse/ClickHouse/pull/7376)
  ([Amos Bird](https://github.com/amosbird))
* 修复 MurmurHash32 中的未定义行为。 [#7388](https://github.com/ClickHouse/ClickHouse/pull/7388) ([Amos
  Bird](https://github.com/amosbird))
* 修复 StoragesInfoStream 中的未定义行为。 [#7384](https://github.com/ClickHouse/ClickHouse/pull/7384)
  ([tavplubix](https://github.com/tavplubix))
* 修复了外部数据库引擎（MySQL、ODBC、JDBC）的常量表达式折叠问题。在之前的版本中，对多个常量表达式的折叠不起作用，并且对 Date、DateTime 和 UUID 完全无效。本次修复对应 [#7245](https://github.com/ClickHouse/ClickHouse/issues/7245)
  [#7252](https://github.com/ClickHouse/ClickHouse/pull/7252)
  （[alexey-milovidov](https://github.com/alexey-milovidov)）
* 修复在 LIVE VIEW 中访问 no&#95;users&#95;thread 变量时出现的 ThreadSanitizer 数据竞争错误。
  [#7353](https://github.com/ClickHouse/ClickHouse/pull/7353)
  ([vzakaznikov](https://github.com/vzakaznikov))
* 在 libcommon 中移除 malloc 符号
  [#7134](https://github.com/ClickHouse/ClickHouse/pull/7134),
  [#7065](https://github.com/ClickHouse/ClickHouse/pull/7065) ([Amos
  Bird](https://github.com/amosbird))
* 添加全局标志位 ENABLE&#95;LIBRARIES，用于禁用所有库。
  [#7063](https://github.com/ClickHouse/ClickHouse/pull/7063)
  ([proller](https://github.com/proller))



#### 代码清理 {#code-cleanup}

- 将配置仓库通用化，为 Dictionaries 的 DDL 做准备。[#7155](https://github.com/ClickHouse/ClickHouse/pull/7155)
    ([alesapin](https://github.com/alesapin))
- 为 Dictionaries 的 DDL 实现一个不带任何语义的解析器。
    [#7209](https://github.com/ClickHouse/ClickHouse/pull/7209)
    ([alesapin](https://github.com/alesapin))
- 将 ParserCreateQuery 拆分为多个更小的解析器。
    [#7253](https://github.com/ClickHouse/ClickHouse/pull/7253)
    ([alesapin](https://github.com/alesapin))
- 在与 external dictionaries 相关的代码附近进行了一些小的重构和重命名。
    [#7111](https://github.com/ClickHouse/ClickHouse/pull/7111)
    ([alesapin](https://github.com/alesapin))
- 重构部分代码，为基于角色的访问控制做准备。[#7235](https://github.com/ClickHouse/ClickHouse/pull/7235) ([Vitaly
    Baranov](https://github.com/vitlibar))
- 对 DatabaseOrdinary 代码进行了一些改进。
    [#7086](https://github.com/ClickHouse/ClickHouse/pull/7086) ([Nikita
    Vasilev](https://github.com/nikvas0))
- 在哈希表的 find() 和 emplace() 方法中不再使用迭代器。
    [#7026](https://github.com/ClickHouse/ClickHouse/pull/7026) ([Alexander
    Kuzmenkov](https://github.com/akuzm))
- 修复在参数 root 非空情况下 getMultipleValuesFromConfig 的行为。[#7374](https://github.com/ClickHouse/ClickHouse/pull/7374)
    ([Mikhail Korotov](https://github.com/millb))
- 移除一些重复代码（TemporaryFile 和 TemporaryFileStream）。
    [#7166](https://github.com/ClickHouse/ClickHouse/pull/7166) ([Artem
    Zuikov](https://github.com/4ertus2))
- 略微提升代码可读性（`MergeTreeData::getActiveContainingPart`）。
    [#7361](https://github.com/ClickHouse/ClickHouse/pull/7361) ([Vladimir
    Chebotarev](https://github.com/excitoon))
- 当 `ThreadPool::schedule(...)` 抛出异常时，等待所有已调度且使用本地对象的任务完成。将 `ThreadPool::schedule(...)` 重命名为 `ThreadPool::scheduleOrThrowOnError(...)`，并修正注释以明确其可能抛出异常。
    [#7350](https://github.com/ClickHouse/ClickHouse/pull/7350)
    ([tavplubix](https://github.com/tavplubix))



## ClickHouse 发行版 19.15 {#clickhouse-release-19-15}

### ClickHouse 发行版 19.15.4.10，2019-10-31 {#clickhouse-release-19-15-4-10-2019-10-31}

#### Bug 修复 {#bug-fix-3}

- 在 ODBC Bridge 中新增对 SQL_TINYINT 和 SQL_BIGINT 的处理，并修复了对 SQL_FLOAT 数据源类型的处理。
    [#7491](https://github.com/ClickHouse/ClickHouse/pull/7491) ([Denis Glazachev](https://github.com/traceon))
- 允许在执行 MOVE PARTITION 时，部分数据部分位于目标磁盘或卷上。
    [#7434](https://github.com/ClickHouse/ClickHouse/pull/7434) ([Vladimir Chebotarev](https://github.com/excitoon))
- 修复了通过 ODBC bridge 在可为 NULL 的列中处理 NULL 值的问题。
    [#7402](https://github.com/ClickHouse/ClickHouse/pull/7402) ([Vasily Nemkov](https://github.com/Enmk))
- 修复了向非本地节点上的 Distributed 表插入包含 MATERIALIZED 列的数据时的问题。
    [#7377](https://github.com/ClickHouse/ClickHouse/pull/7377) ([Azat Khuzhin](https://github.com/azat))
- 修复了函数 getMultipleValuesFromConfig。
    [#7374](https://github.com/ClickHouse/ClickHouse/pull/7374) ([Mikhail Korotov](https://github.com/millb))
- 修复了使用 HTTP keep alive 超时时间而不是 TCP keep alive 超时时间的问题。
    [#7351](https://github.com/ClickHouse/ClickHouse/pull/7351) ([Vasily Nemkov](https://github.com/Enmk))
- 在发生异常时等待所有任务完成（修复罕见的段错误）。
    [#7350](https://github.com/ClickHouse/ClickHouse/pull/7350) ([tavplubix](https://github.com/tavplubix))
- 向 Kafka 表插入数据时不再推送到物化视图（MVs）。
    [#7265](https://github.com/ClickHouse/ClickHouse/pull/7265) ([Ivan](https://github.com/abyss7))
- 为异常栈禁用内存跟踪器。
    [#7264](https://github.com/ClickHouse/ClickHouse/pull/7264) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- 修复了为外部数据库转换查询时的不正确代码。
    [#7252](https://github.com/ClickHouse/ClickHouse/pull/7252) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 避免在 MetricsTransmitter 中使用未初始化的值。
    [#7158](https://github.com/ClickHouse/ClickHouse/pull/7158) ([Azat Khuzhin](https://github.com/azat))
- 添加了带宏的测试用示例配置。
    ([alexey-milovidov](https://github.com/alexey-milovidov))

### ClickHouse 发行版 19.15.3.6，2019-10-09 {#clickhouse-release-19-15-3-6-2019-10-09}

#### Bug 修复 {#bug-fix-4}

- 修复了哈希字典中的 bad_variant。
    ([alesapin](https://github.com/alesapin))
- 修复了 ATTACH PART 查询中导致段错误的 bug。
    ([alesapin](https://github.com/alesapin))
- 修复了 `MergeTreeData` 中的时间计算。
    ([Vladimir Chebotarev](https://github.com/excitoon))
- 在写入完成后显式提交到 Kafka。
    [#7175](https://github.com/ClickHouse/ClickHouse/pull/7175) ([Ivan](https://github.com/abyss7))
- 在 MergeTree 数据部分的 min/max 索引中正确序列化 NULL 值。
    [#7234](https://github.com/ClickHouse/ClickHouse/pull/7234) ([Alexander Kuzmenkov](https://github.com/akuzm))

### ClickHouse 发行版 19.15.2.2，2019-10-01 {#clickhouse-release-19-15-2-2-2019-10-01}

#### 新特性 {#new-feature-3}



- 分层存储：支持为使用 MergeTree 引擎的表配置多个存储卷。可以将最新数据存储在 SSD 上，并自动将旧数据迁移到 HDD。（[示例](https://clickhouse.github.io/clickhouse-presentations/meetup30/new_features/#12)）。[#4918](https://github.com/ClickHouse/ClickHouse/pull/4918) ([Igr](https://github.com/ObjatieGroba)) [#6489](https://github.com/ClickHouse/ClickHouse/pull/6489) ([alesapin](https://github.com/alesapin))
- 添加表函数 `input`，用于在 `INSERT SELECT` 查询中读取输入数据。 [#5450](https://github.com/ClickHouse/ClickHouse/pull/5450) ([palasonic1](https://github.com/palasonic1)) [#6832](https://github.com/ClickHouse/ClickHouse/pull/6832) ([Anton Popov](https://github.com/CurtizJ))
- 新增 `sparse_hashed` 字典布局，该布局在功能上等同于 `hashed` 布局，但更节省内存。在取值速度变慢的代价下，内存占用约为后者的一半。 [#6894](https://github.com/ClickHouse/ClickHouse/pull/6894) ([Azat Khuzhin](https://github.com/azat))
- 实现可为字典配置访问用户列表的功能。仅对当前连接的数据库生效。 [#6907](https://github.com/ClickHouse/ClickHouse/pull/6907) ([Guillaume Tassery](https://github.com/YiuRULE))
- 为 `SHOW` 查询添加 `LIMIT` 选项。 [#6944](https://github.com/ClickHouse/ClickHouse/pull/6944) ([Philipp Malkovsky](https://github.com/malkfilipp))
- 添加 `bitmapSubsetLimit(bitmap, range_start, limit)` 函数，该函数返回集合中不小于 `range_start` 的、按值从小到大排列的最小 `limit` 个值的子集。 [#6957](https://github.com/ClickHouse/ClickHouse/pull/6957) ([Zhichang Yu](https://github.com/yuzhichang))
- 添加 `bitmapMin` 和 `bitmapMax` 函数。 [#6970](https://github.com/ClickHouse/ClickHouse/pull/6970) ([Zhichang Yu](https://github.com/yuzhichang))
- 添加与 [issue-6648](https://github.com/ClickHouse/ClickHouse/issues/6648) 相关的函数 `repeat`。 [#6999](https://github.com/ClickHouse/ClickHouse/pull/6999) ([flynn](https://github.com/ucasFL))

#### 实验特性 {#experimental-feature-1}

- 实现一种不会改变当前流水线的（内存中）Merge Join 变体。结果按合并键部分排序。将 `partial_merge_join` 设为 `1` 以使用此特性。Merge Join 仍在开发中。 [#6940](https://github.com/ClickHouse/ClickHouse/pull/6940) ([Artem Zuikov](https://github.com/4ertus2))
- 新增 `S3` 引擎和表函数。该功能仍在开发中（尚不支持身份验证）。 [#5596](https://github.com/ClickHouse/ClickHouse/pull/5596) ([Vladimir Chebotarev](https://github.com/excitoon))

#### 改进 {#improvement-2}



- 从 Kafka 读取的每条消息都会以原子方式插入。这解决了几乎所有已知的 Kafka engine 问题。[#6950](https://github.com/ClickHouse/ClickHouse/pull/6950) ([Ivan](https://github.com/abyss7))
- 改进 Distributed 查询的故障切换。缩短恢复时间，同时现在可以进行配置，并且可在 `system.clusters` 中查看。[#6399](https://github.com/ClickHouse/ClickHouse/pull/6399) ([Vasily Nemkov](https://github.com/Enmk))
- 在 `IN` 子句中直接支持 Enums 的数值形式。#6766 [#6941](https://github.com/ClickHouse/ClickHouse/pull/6941) ([dimarub2000](https://github.com/dimarub2000))
- 为 URL 存储新增（可选的，默认禁用）重定向支持。[#6914](https://github.com/ClickHouse/ClickHouse/pull/6914) ([maqroll](https://github.com/maqroll))
- 当使用较旧版本的客户端连接到服务器时，添加提示信息。[#6893](https://github.com/ClickHouse/ClickHouse/pull/6893) ([Philipp Malkovsky](https://github.com/malkfilipp))
- 移除在 Distributed 表中发送数据时的最大退避等待时间限制。[#6895](https://github.com/ClickHouse/ClickHouse/pull/6895) ([Azat Khuzhin](https://github.com/azat))
- 支持向 Graphite 发送带有累积值的 profile events（计数器）。可以在服务器 `config.xml` 中的 `<events_cumulative>` 下启用。[#6969](https://github.com/ClickHouse/ClickHouse/pull/6969) ([Azat Khuzhin](https://github.com/azat))
- 在通过 HTTP 以 Native 格式向 `LowCardinality(T)` 类型的列插入数据时，自动将类型 `T` 转换为 `LowCardinality(T)`。[#6891](https://github.com/ClickHouse/ClickHouse/pull/6891) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- 在对 `Float32`、`Float64` 使用函数 `hex` 时，无需再使用 `reinterpretAsString`。[#7024](https://github.com/ClickHouse/ClickHouse/pull/7024) ([Mikhail Korotov](https://github.com/millb))

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-2}

- 为带有调试信息的 ClickHouse 可执行文件添加 gdb-index，这将加快 `gdb` 的启动时间。[#6947](https://github.com/ClickHouse/ClickHouse/pull/6947) ([alesapin](https://github.com/alesapin))
- 使用打过补丁并使用 `pigz` 的 dpkg-deb 来加速 deb 打包。[#6960](https://github.com/ClickHouse/ClickHouse/pull/6960) ([alesapin](https://github.com/alesapin))
- 设置 `enable_fuzzing = 1`，以启用对整个项目代码的 libfuzzer 插桩。[#7042](https://github.com/ClickHouse/ClickHouse/pull/7042) ([kyprizel](https://github.com/kyprizel))
- 在 CI 中新增拆分构建的冒烟测试。[#7061](https://github.com/ClickHouse/ClickHouse/pull/7061) ([alesapin](https://github.com/alesapin))
- 在 CI 中新增使用 MemorySanitizer 的构建。[#7066](https://github.com/ClickHouse/ClickHouse/pull/7066) ([Alexander Kuzmenkov](https://github.com/akuzm))
- 将 `libsparsehash` 替换为 `sparsehash-c11`。[#6965](https://github.com/ClickHouse/ClickHouse/pull/6965) ([Azat Khuzhin](https://github.com/azat))

#### Bug 修复 {#bug-fix-5}



- 修复了在大表上对复杂键进行索引分析时的性能下降问题。这修复了 #6924。[#7075](https://github.com/ClickHouse/ClickHouse/pull/7075) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了在从空的 Kafka 主题进行查询时导致段错误的逻辑错误。[#6909](https://github.com/ClickHouse/ClickHouse/pull/6909) ([Ivan](https://github.com/abyss7))
- 修复了在 `MySQLBlockInputStream.cpp` 中过早关闭 MySQL 连接的问题。[#6882](https://github.com/ClickHouse/ClickHouse/pull/6882) ([Clément Rodriguez](https://github.com/clemrodriguez))
- 恢复了对非常旧的 Linux 内核的支持（修复 [#6841](https://github.com/ClickHouse/ClickHouse/issues/6841)）。[#6853](https://github.com/ClickHouse/ClickHouse/pull/6853) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了在输入流中存在空块时，`insert select` 查询可能导致数据丢失的问题。#6834 #6862 [#6911](https://github.com/ClickHouse/ClickHouse/pull/6911) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- 修复了函数 `АrrayEnumerateUniqRanked` 在参数包含空数组时的问题。[#6928](https://github.com/ClickHouse/ClickHouse/pull/6928) ([proller](https://github.com/proller))
- 修复了包含 ARRAY JOIN 和全局子查询的复杂查询的问题。[#6934](https://github.com/ClickHouse/ClickHouse/pull/6934) ([Ivan](https://github.com/abyss7))
- 修复了在包含多个 JOIN 的 ORDER BY 和 GROUP BY 中出现的 `Unknown identifier` 错误。[#7022](https://github.com/ClickHouse/ClickHouse/pull/7022) ([Artem Zuikov](https://github.com/4ertus2))
- 修复了在执行带有 `LowCardinality` 参数的函数时出现的 `MSan` 警告。[#7062](https://github.com/ClickHouse/ClickHouse/pull/7062) ([Nikolai Kochetov](https://github.com/KochetovNicolai))

#### 向后不兼容的变更 {#backward-incompatible-change-2}

- 修改了 bitmap\* 聚合函数状态的序列化格式以提升性能。先前版本中序列化得到的 bitmap\* 状态将无法读取。[#6908](https://github.com/ClickHouse/ClickHouse/pull/6908) ([Zhichang Yu](https://github.com/yuzhichang))



## ClickHouse 版本 19.14 {#clickhouse-release-19-14}

### ClickHouse 版本 19.14.7.15，2019-10-02 {#clickhouse-release-19-14-7-15-2019-10-02}

#### Bug 修复 {#bug-fix-6}

- 此版本还包含来自 19.11.12.69 的所有 bug 修复。
- 修复了 19.14 与更早版本之间分布式查询的兼容性。修复了 [#7068](https://github.com/ClickHouse/ClickHouse/issues/7068)。[#7069](https://github.com/ClickHouse/ClickHouse/pull/7069)（[alexey-milovidov](https://github.com/alexey-milovidov)）

### ClickHouse 版本 19.14.6.12，2019-09-19 {#clickhouse-release-19-14-6-12-2019-09-19}

#### Bug 修复 {#bug-fix-7}

- 修复了函数 `АrrayEnumerateUniqRanked` 在参数为空数组时的问题。[#6928](https://github.com/ClickHouse/ClickHouse/pull/6928)（[proller](https://github.com/proller)）
- 修复了在带有 `ARRAY JOIN` 和带别名的 `GLOBAL IN subquery` 的查询中子查询名称的问题。如果指定了子查询别名，则将其用作外部表名。[#6934](https://github.com/ClickHouse/ClickHouse/pull/6934)（[Ivan](https://github.com/abyss7)）

#### 构建/测试/打包 改进 {#buildtestingpackaging-improvement-3}

- 通过将测试改写为 shell 脚本，修复了[不稳定（flapping）](https://clickhouse-test-reports.s3.yandex.net/6944/aab95fd5175a513413c7395a73a82044bdafb906/functional_stateless_tests_(debug).html)的测试 `00715_fetch_merged_or_mutated_part_zookeeper`，因为它需要等待变更（mutation）生效。[#6977](https://github.com/ClickHouse/ClickHouse/pull/6977)（[Alexander Kazakov](https://github.com/Akazz)）
- 修复了函数 `groupUniqArray` 在空数组参数情况下的 UBSan 和 MemSan 失败。问题是由于将空的 `PaddedPODArray` 放入哈希表的第 0 个单元格，而该单元格值的构造函数未被调用所导致。[#6937](https://github.com/ClickHouse/ClickHouse/pull/6937)（[Amos Bird](https://github.com/amosbird)）

### ClickHouse 版本 19.14.3.3，2019-09-10 {#clickhouse-release-19-14-3-3-2019-09-10}

#### 新功能 {#new-feature-4}



* `ORDER BY` 的 `WITH FILL` 修饰符。（[#5069](https://github.com/ClickHouse/ClickHouse/issues/5069) 的后续）[#6610](https://github.com/ClickHouse/ClickHouse/pull/6610)（[Anton Popov](https://github.com/CurtizJ)）
* 为 `LIMIT` 增加 `WITH TIES` 修饰符。（[#5069](https://github.com/ClickHouse/ClickHouse/issues/5069) 的延续） [#6610](https://github.com/ClickHouse/ClickHouse/pull/6610) ([Anton Popov](https://github.com/CurtizJ))
* 在设置 `format_csv_unquoted_null_literal_as_null=1` 时，将未加引号的 `NULL` 字面量解析为 NULL。若该字段的数据类型不可为空（非 Nullable 类型），在设置 `input_format_null_as_default=1` 时，将 NULL 字段初始化为默认值。 [#5990](https://github.com/ClickHouse/ClickHouse/issues/5990) [#6055](https://github.com/ClickHouse/ClickHouse/pull/6055) ([tavplubix](https://github.com/tavplubix))
* 在表函数 `file` 和 `hdfs` 的路径中支持使用通配符。如果路径包含通配符，则该表将为只读。用法示例：`select * from hdfs('hdfs://hdfs1:9000/some_dir/another_dir/*/file{0..9}{0..9}')` 和 `select * from file('some_dir/{some_file,another_file,yet_another}.tsv', 'TSV', 'value UInt32')`。 [#6092](https://github.com/ClickHouse/ClickHouse/pull/6092) ([Olga Khvostikova](https://github.com/stavrolia))
* 新的 `system.metric_log` 表，用于以指定的时间间隔存储 `system.events` 和 `system.metrics` 的值。 [#6363](https://github.com/ClickHouse/ClickHouse/issues/6363) [#6467](https://github.com/ClickHouse/ClickHouse/pull/6467) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)) [#6530](https://github.com/ClickHouse/ClickHouse/pull/6530) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 支持将 ClickHouse 文本日志写入 `system.text_log` 表。 [#6037](https://github.com/ClickHouse/ClickHouse/issues/6037) [#6103](https://github.com/ClickHouse/ClickHouse/pull/6103) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)) [#6164](https://github.com/ClickHouse/ClickHouse/pull/6164) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 在堆栈跟踪中显示私有符号（通过解析 ELF 文件的符号表实现）。如果存在调试信息，在堆栈跟踪中增加文件名和行号信息。通过为程序中存在的符号建立索引来加速符号名称查找。新增用于自省的 SQL 函数：`demangle` 和 `addressToLine`。为保持一致性，将函数 `symbolizeAddress` 重命名为 `addressToSymbol`。出于性能原因，函数 `addressToSymbol` 将返回 mangled 符号名，用户需要自行调用 `demangle`。新增设置 `allow_introspection_functions`，默认关闭。 [#6201](https://github.com/ClickHouse/ClickHouse/pull/6201) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 表函数 `values`（函数名不区分大小写）。它支持从在 [#5984](https://github.com/ClickHouse/ClickHouse/issues/5984) 中提出的 `VALUES` 列表中读取数据。示例：`SELECT * FROM VALUES('a UInt64, s String', (1, 'one'), (2, 'two'), (3, 'three'))`。[#6217](https://github.com/ClickHouse/ClickHouse/issues/6217)。[#6209](https://github.com/ClickHouse/ClickHouse/pull/6209)（[dimarub2000](https://github.com/dimarub2000)）
* 现在可以修改存储设置。语法：`ALTER TABLE <table> MODIFY SETTING <setting> = <value>`。[#6366](https://github.com/ClickHouse/ClickHouse/pull/6366) [#6669](https://github.com/ClickHouse/ClickHouse/pull/6669) [#6685](https://github.com/ClickHouse/ClickHouse/pull/6685) ([alesapin](https://github.com/alesapin))
* 支持删除已分离的 part。语法：`ALTER TABLE <table_name> DROP DETACHED PART '<part_id>'`。[#6158](https://github.com/ClickHouse/ClickHouse/pull/6158) ([tavplubix](https://github.com/tavplubix))
* 表约束。允许在表定义中添加约束条件，并在插入数据时进行检查。[#5273](https://github.com/ClickHouse/ClickHouse/pull/5273) ([Gleb Novikov](https://github.com/NanoBjorn)) [#6652](https://github.com/ClickHouse/ClickHouse/pull/6652) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 支持级联物化视图. [#6324](https://github.com/ClickHouse/ClickHouse/pull/6324) ([Amos Bird](https://github.com/amosbird))
* 默认启用查询性能分析器，使其每秒对每个查询执行线程采样一次。 [#6283](https://github.com/ClickHouse/ClickHouse/pull/6283) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 输入格式为 `ORC`。 [#6454](https://github.com/ClickHouse/ClickHouse/pull/6454) [#6703](https://github.com/ClickHouse/ClickHouse/pull/6703) ([akonyaev90](https://github.com/akonyaev90))
* 添加了两个新函数：`sigmoid` 和 `tanh`（对机器学习应用很有用）。[#6254](https://github.com/ClickHouse/ClickHouse/pull/6254) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 函数 `hasToken(haystack, token)`、`hasTokenCaseInsensitive(haystack, token)` 用于检查给定的 token 是否存在于 haystack 中。Token 是指位于两个非字母数字的 ASCII 字符（或 haystack 边界）之间、长度尽可能长的子字符串。Token 必须是常量字符串。支持 tokenbf&#95;v1 索引特化。[#6596](https://github.com/ClickHouse/ClickHouse/pull/6596)、[#6662](https://github.com/ClickHouse/ClickHouse/pull/6662)（[Vasily Nemkov](https://github.com/Enmk)）
* 新函数 `neighbor(value, offset[, default_value])`。用于在一个数据块中访问同一列中的前/后相邻值。 [#5925](https://github.com/ClickHouse/ClickHouse/pull/5925) ([Alex Krash](https://github.com/alex-krash)) [6685365ab8c5b74f9650492c88a012596eb1b0c6](https://github.com/ClickHouse/ClickHouse/commit/6685365ab8c5b74f9650492c88a012596eb1b0c6) [341e2e4587a18065c2da1ca888c73389f48ce36c](https://github.com/ClickHouse/ClickHouse/commit/341e2e4587a18065c2da1ca888c73389f48ce36c) [Alexey Milovidov](https://github.com/alexey-milovidov)
* 创建了函数 `currentUser()`，用于返回当前已认证用户的登录名。为兼容 MySQL，添加了别名 `user()`。 [#6470](https://github.com/ClickHouse/ClickHouse/pull/6470) ([Alex Krash](https://github.com/alex-krash))
* 新增了聚合函数 `quantilesExactInclusive` 和 `quantilesExactExclusive`，这些函数最初在 [#5885](https://github.com/ClickHouse/ClickHouse/issues/5885) 中被提出。[#6477](https://github.com/ClickHouse/ClickHouse/pull/6477) ([dimarub2000](https://github.com/dimarub2000))
* 函数 `bitmapRange(bitmap, range_begin, range_end)` 返回一个在指定范围内的新集合（不包含 `range_end`）。[#6314](https://github.com/ClickHouse/ClickHouse/pull/6314) ([Zhichang Yu](https://github.com/yuzhichang))
* 函数 `geohashesInBox(longitude_min, latitude_min, longitude_max, latitude_max, precision)` 会创建一个由长度为 `precision` 的 geohash 网格框字符串组成的数组，用于覆盖指定区域。 [#6127](https://github.com/ClickHouse/ClickHouse/pull/6127) ([Vasily Nemkov](https://github.com/Enmk))
* 为 `Kafka` 表实现对 INSERT 查询的支持。 [#6012](https://github.com/ClickHouse/ClickHouse/pull/6012) ([Ivan](https://github.com/abyss7))
* 为 Kafka 引擎新增对 `_partition` 和 `_timestamp` 虚拟列的支持。 [#6400](https://github.com/ClickHouse/ClickHouse/pull/6400) ([Ivan](https://github.com/abyss7))
* 支持使用基于正则表达式的规则，从 `query_log`、服务器日志和进程列表中移除敏感数据。 [#5710](https://github.com/ClickHouse/ClickHouse/pull/5710) ([filimonov](https://github.com/filimonov))



#### 实验性功能 {#experimental-feature-2}

- `Template` 输入和输出数据格式。它允许为输入和输出指定自定义格式字符串。[#4354](https://github.com/ClickHouse/ClickHouse/issues/4354) [#6727](https://github.com/ClickHouse/ClickHouse/pull/6727) ([tavplubix](https://github.com/tavplubix))
- 实现 `LIVE VIEW` 表，该功能最初在 [#2898](https://github.com/ClickHouse/ClickHouse/pull/2898) 中提出，在 [#3925](https://github.com/ClickHouse/ClickHouse/issues/3925) 中进行了准备，并在 [#5541](https://github.com/ClickHouse/ClickHouse/issues/5541) 中更新。详细说明请参见 [#5541](https://github.com/ClickHouse/ClickHouse/issues/5541)。[#5541](https://github.com/ClickHouse/ClickHouse/issues/5541) ([vzakaznikov](https://github.com/vzakaznikov)) [#6425](https://github.com/ClickHouse/ClickHouse/pull/6425) ([Nikolai Kochetov](https://github.com/KochetovNicolai)) [#6656](https://github.com/ClickHouse/ClickHouse/pull/6656) ([vzakaznikov](https://github.com/vzakaznikov)) 请注意，`LIVE VIEW` 功能可能会在后续版本中移除。

#### Bug 修复 {#bug-fix-8}



* 本次发布还包含 19.13 和 19.11 中的所有错误修复。
* 修复当表包含跳过索引且发生垂直合并时出现的段错误问题。 [#6723](https://github.com/ClickHouse/ClickHouse/pull/6723) ([alesapin](https://github.com/alesapin))
* 修复在存在复杂列默认值时的按列 TTL 行为。此前，在使用带有 `OPTIMIZE ... FINAL` 的查询强制执行 TTL 合并时，过期的值会被类型默认值替换，而不是用户指定的列默认值。[#6796](https://github.com/ClickHouse/ClickHouse/pull/6796)（[Anton Popov](https://github.com/CurtizJ)）
* 在服务器正常重启时修复 Kafka 消息重复的问题。 [#6597](https://github.com/ClickHouse/ClickHouse/pull/6597) ([Ivan](https://github.com/abyss7))
* 修复读取 Kafka 消息时出现的无限循环问题。在订阅时完全不要对 consumer 执行暂停/恢复操作——否则在某些场景下它可能会被无限期暂停。[#6354](https://github.com/ClickHouse/ClickHouse/pull/6354) ([Ivan](https://github.com/abyss7))
* 修复 `bitmapContains` 函数中出现的 `Key expression contains comparison between inconvertible types` 异常。[#6136](https://github.com/ClickHouse/ClickHouse/issues/6136) [#6146](https://github.com/ClickHouse/ClickHouse/issues/6146) [#6156](https://github.com/ClickHouse/ClickHouse/pull/6156) ([dimarub2000](https://github.com/dimarub2000))
* 修复在启用 `optimize_skip_unused_shards` 且缺少分片键时出现的段错误。 [#6384](https://github.com/ClickHouse/ClickHouse/pull/6384) ([Anton Popov](https://github.com/CurtizJ))
* 修复了 mutation 中可能导致内存损坏的错误代码。修复了由于并发执行 `DROP TABLE` 和从 `system.parts` 或 `system.parts_columns` 中执行 `SELECT` 而可能发生的读取地址 `0x14c0` 的段错误（segfault）。修复了在准备 mutation 查询时出现的竞争条件（race condition）。修复了由于对 Replicated 表执行 `OPTIMIZE` 与 ALTER 等并发修改操作导致的死锁（deadlock）。 [#6514](https://github.com/ClickHouse/ClickHouse/pull/6514) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 移除 MySQL 接口中过于冗长的日志输出 [#6389](https://github.com/ClickHouse/ClickHouse/pull/6389) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 恢复在配置文件中将 &#39;true&#39; 和 &#39;false&#39; 解析为布尔设置的功能。 [#6278](https://github.com/ClickHouse/ClickHouse/pull/6278) ([alesapin](https://github.com/alesapin))
* 修复在 `Nullable(Decimal128)` 上使用 `quantile` 和 `median` 函数时出现的崩溃问题。 [#6378](https://github.com/ClickHouse/ClickHouse/pull/6378) ([Artem Zuikov](https://github.com/4ertus2))
* 修复了在主键上带有 `WHERE` 条件且对其进行了 Float 类型转换的 `SELECT` 查询可能返回不完整结果的问题。该问题是由于 `toFloat` 函数中对单调性的检查不正确所致。 [#6248](https://github.com/ClickHouse/ClickHouse/issues/6248) [#6374](https://github.com/ClickHouse/ClickHouse/pull/6374) ([dimarub2000](https://github.com/dimarub2000))
* 检查用于 mutation 操作的 `max_expanded_ast_elements` 设置。在执行 `TRUNCATE TABLE` 后清理 mutation。 [#6205](https://github.com/ClickHouse/ClickHouse/pull/6205) ([Winter Zhang](https://github.com/zhang2014))
* 修复在使用 `join_use_nulls` 时键列 JOIN 结果的问题，将列默认值改为填充为 NULL。[#6249](https://github.com/ClickHouse/ClickHouse/pull/6249) ([Artem Zuikov](https://github.com/4ertus2))
* 修复了在垂直合并和 ALTER 操作中使用 skip 索引时的问题。修复了 `Bad size of marks file` 异常。[#6594](https://github.com/ClickHouse/ClickHouse/issues/6594) [#6713](https://github.com/ClickHouse/ClickHouse/pull/6713) ([alesapin](https://github.com/alesapin))
* 修复在 `ALTER MODIFY COLUMN` 和垂直合并中，当参与合并/修改的某个数据分片为空（0 行）时会发生的罕见崩溃 [#6746](https://github.com/ClickHouse/ClickHouse/issues/6746) [#6780](https://github.com/ClickHouse/ClickHouse/pull/6780) ([alesapin](https://github.com/alesapin))
* 修复了 `AggregateFunctionFactory` 中 `LowCardinality` 类型转换的 Bug，从而解决了 [#6257](https://github.com/ClickHouse/ClickHouse/issues/6257)。[#6281](https://github.com/ClickHouse/ClickHouse/pull/6281)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）
* 修复 `topK` 和 `topKWeighted` 聚合函数中的错误行为以及潜在的段错误。 [#6404](https://github.com/ClickHouse/ClickHouse/pull/6404) ([Anton Popov](https://github.com/CurtizJ))
* 修复了与 `getIdentifier` 函数相关的不安全代码。[#6401](https://github.com/ClickHouse/ClickHouse/issues/6401) [#6409](https://github.com/ClickHouse/ClickHouse/pull/6409) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了 MySQL wire 协议中的缺陷（用于通过 MySQL 客户端连接到 ClickHouse）。该缺陷由 `PacketPayloadWriteBuffer` 中的堆缓冲溢出导致。[#6212](https://github.com/ClickHouse/ClickHouse/pull/6212) ([Yuriy Baranov](https://github.com/yurriy))
* 修复 `bitmapSubsetInRange` 函数中的内存泄漏问题。 [#6819](https://github.com/ClickHouse/ClickHouse/pull/6819) ([Zhichang Yu](https://github.com/yuzhichang))
* 修复在粒度变更后执行 mutation 时出现的罕见 bug。 [#6816](https://github.com/ClickHouse/ClickHouse/pull/6816) ([alesapin](https://github.com/alesapin))
* 默认允许 protobuf 消息包含所有字段。 [#6132](https://github.com/ClickHouse/ClickHouse/pull/6132) ([Vitaly Baranov](https://github.com/vitlibar))
* 修复当第二个参数为 `NULL` 时 `nullIf` 函数中的一个 bug。[#6446](https://github.com/ClickHouse/ClickHouse/pull/6446) ([Guillaume Tassery](https://github.com/YiuRULE))
* 修复复杂键缓存字典在包含字符串字段时，错误的内存分配/释放导致的一个罕见问题，该问题会导致内存被无限占用（表现类似内存泄漏）。当字符串长度为从 8 开始的 2 的幂（8、16、32 等）时会复现此 Bug。 [#6447](https://github.com/ClickHouse/ClickHouse/pull/6447) ([alesapin](https://github.com/alesapin))
* 修复了对短序列进行 Gorilla 编码时的问题，该问题会抛出异常 `Cannot write after end of buffer`。 [#6398](https://github.com/ClickHouse/ClickHouse/issues/6398) [#6444](https://github.com/ClickHouse/ClickHouse/pull/6444) ([Vasily Nemkov](https://github.com/Enmk))
* 在启用 `join_use_nulls` 时，允许在 JOIN 中使用非 Nullable 类型。 [#6705](https://github.com/ClickHouse/ClickHouse/pull/6705) ([Artem Zuikov](https://github.com/4ertus2))
* 在 `clickhouse-client` 中禁用查询中的 `Poco::AbstractConfiguration` 替换功能。 [#6706](https://github.com/ClickHouse/ClickHouse/pull/6706) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 避免在 `REPLACE PARTITION` 中发生死锁。 [#6677](https://github.com/ClickHouse/ClickHouse/pull/6677) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 对常量参数调用 `arrayReduce` 可能导致段错误。[#6242](https://github.com/ClickHouse/ClickHouse/issues/6242) [#6326](https://github.com/ClickHouse/ClickHouse/pull/6326) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复当副本在执行 `DROP PARTITION` 之后恢复时可能出现的不一致数据分片。[#6522](https://github.com/ClickHouse/ClickHouse/issues/6522) [#6523](https://github.com/ClickHouse/ClickHouse/pull/6523) ([tavplubix](https://github.com/tavplubix))
* 修复了 `JSONExtractRaw` 函数中的挂起问题。[#6195](https://github.com/ClickHouse/ClickHouse/issues/6195) [#6198](https://github.com/ClickHouse/ClickHouse/pull/6198) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了在自适应粒度下 skip indices 序列化和聚合不正确的问题。[#6594](https://github.com/ClickHouse/ClickHouse/issues/6594)。[#6748](https://github.com/ClickHouse/ClickHouse/pull/6748) ([alesapin](https://github.com/alesapin))
* 修复在两级聚合中使用 `GROUP BY` 时 `WITH ROLLUP` 和 `WITH CUBE` 修饰符的问题。 [#6225](https://github.com/ClickHouse/ClickHouse/pull/6225) ([Anton Popov](https://github.com/CurtizJ))
* 修复在使用自适应粒度时写入二级索引标记的缺陷。 [#6126](https://github.com/ClickHouse/ClickHouse/pull/6126) ([alesapin](https://github.com/alesapin))
* 在服务器启动阶段修正初始化顺序。由于 `StorageMergeTree::background_task_handle` 在 `startup()` 中才会初始化，`MergeTreeBlockOutputStream::write()` 可能会在其初始化之前尝试使用它。因此，只需在使用前检查该句柄是否已初始化即可。[#6080](https://github.com/ClickHouse/ClickHouse/pull/6080) ([Ivan](https://github.com/abyss7))
* 清空上一次因错误结束的读取操作留下的数据缓冲区。[#6026](https://github.com/ClickHouse/ClickHouse/pull/6026) ([Nikolay](https://github.com/bopohaa))
* 修复了在为 Replicated*MergeTree 表创建新副本时启用自适应粒度的问题。 [#6394](https://github.com/ClickHouse/ClickHouse/issues/6394) [#6452](https://github.com/ClickHouse/ClickHouse/pull/6452) ([alesapin](https://github.com/alesapin))
* 修复了在服务器启动期间可能发生的一种崩溃：当访问未初始化的 `ThreadStatus` 结构体抛出异常时，如果在处理该异常的过程中 `libunwind` 再次抛出异常，可能会导致崩溃。 [#6456](https://github.com/ClickHouse/ClickHouse/pull/6456) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
* 修复 `yandexConsistentHash` 函数中的崩溃问题。通过模糊测试发现。[#6304](https://github.com/ClickHouse/ClickHouse/issues/6304) [#6305](https://github.com/ClickHouse/ClickHouse/pull/6305) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了在服务器过载且全局线程池接近耗尽时查询可能挂起的问题。在具有大量分片（数百个）的集群上更有可能出现此问题，因为分布式查询会为到每个分片的连接分配一个线程。例如，如果一个具有 330 个分片的集群正在处理 30 个并发分布式查询，就可能复现该问题。此问题影响从 19.2 开始的所有版本。[#6301](https://github.com/ClickHouse/ClickHouse/pull/6301) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了 `arrayEnumerateUniqRanked` 函数的逻辑。[#6423](https://github.com/ClickHouse/ClickHouse/pull/6423) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复在解码符号表时出现的段错误。 [#6603](https://github.com/ClickHouse/ClickHouse/pull/6603) ([Amos Bird](https://github.com/amosbird))
* 修复了在将 `LowCardinality(Nullable)` 转换为非 Nullable 列时，如果列中不包含 Null 值（例如在 `SELECT CAST(CAST('Hello' AS LowCardinality(Nullable(String))) AS String)` 这样的查询中），会抛出的无关异常。 [#6094](https://github.com/ClickHouse/ClickHouse/issues/6094) [#6119](https://github.com/ClickHouse/ClickHouse/pull/6119) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* 移除了 `system.settings` 表中对 `description` 字段的多余引号。[#6696](https://github.com/ClickHouse/ClickHouse/issues/6696) [#6699](https://github.com/ClickHouse/ClickHouse/pull/6699) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 避免在复制表的 `TRUNCATE` 操作中可能出现的死锁。[#6695](https://github.com/ClickHouse/ClickHouse/pull/6695) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复按排序键顺序读取的问题。 [#6189](https://github.com/ClickHouse/ClickHouse/pull/6189) ([Anton Popov](https://github.com/CurtizJ))
* 修复在 `enable_mixed_granularity_parts=1` 表上执行 `ALTER TABLE ... UPDATE` 查询时的问题。 [#6543](https://github.com/ClickHouse/ClickHouse/pull/6543) ([alesapin](https://github.com/alesapin))
* 修复由 [#4405](https://github.com/ClickHouse/ClickHouse/pull/4405)（自 19.4.0 起）引入的 bug。该问题会在对基于 MergeTree 表的 Distributed 表执行查询且未查询任何列时（如 `SELECT 1`）复现。[#6236](https://github.com/ClickHouse/ClickHouse/pull/6236)（[alesapin](https://github.com/alesapin)）
* 修复了带符号类型与无符号类型进行整数除法时的溢出问题。此前行为与 C 或 C++ 语言完全相同（遵循整数提升规则），这可能会让人感到意外。请注意，当将较大的带符号整数与较大的无符号整数相互进行除法运算时，仍然有可能发生溢出（但这种情况不太常见）。该问题存在于所有服务器版本中。 [#6214](https://github.com/ClickHouse/ClickHouse/issues/6214) [#6233](https://github.com/ClickHouse/ClickHouse/pull/6233) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 在设置了 `max_execution_speed` 或 `max_execution_speed_bytes` 时，限制用于限流的最大休眠时间。修复了诸如 `Estimated query execution time (inf seconds) is too long` 之类的误报错误。 [#5547](https://github.com/ClickHouse/ClickHouse/issues/5547) [#6232](https://github.com/ClickHouse/ClickHouse/pull/6232) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了在 `MaterializedView` 中使用 `MATERIALIZED` 列和别名时存在的问题。[#448](https://github.com/ClickHouse/ClickHouse/issues/448) [#3484](https://github.com/ClickHouse/ClickHouse/issues/3484) [#3450](https://github.com/ClickHouse/ClickHouse/issues/3450) [#2878](https://github.com/ClickHouse/ClickHouse/issues/2878) [#2285](https://github.com/ClickHouse/ClickHouse/issues/2285) [#3796](https://github.com/ClickHouse/ClickHouse/pull/3796) ([Amos Bird](https://github.com/amosbird)) [#6316](https://github.com/ClickHouse/ClickHouse/pull/6316) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复 `FormatFactory` 对未实现为 processor 的输入流的处理行为。 [#6495](https://github.com/ClickHouse/ClickHouse/pull/6495) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* 修复拼写错误。 [#6631](https://github.com/ClickHouse/ClickHouse/pull/6631) ([Alex Ryndin](https://github.com/alexryndin))
* 错误信息中的笔误（is -&gt; are）。[#6839](https://github.com/ClickHouse/ClickHouse/pull/6839)（[Denis Zhuravlev](https://github.com/den-crane)）
* 修复了从字符串解析列列表时的错误：如果类型中包含逗号就会触发该错误（该问题会影响 `File`、`URL`、`HDFS` 存储）[#6217](https://github.com/ClickHouse/ClickHouse/issues/6217)。[#6209](https://github.com/ClickHouse/ClickHouse/pull/6209)（[dimarub2000](https://github.com/dimarub2000)）



#### 安全修复 {#security-fix}

- 此版本还包含 19.13 和 19.11 中的所有安全漏洞修复。
- 修复了伪造查询可能导致 SQL 解析器栈溢出并使服务器崩溃的问题。修复了在 Merge 和 Distributed 表、物化视图，以及包含子查询的行级安全策略条件中可能出现栈溢出的问题。 [#6433](https://github.com/ClickHouse/ClickHouse/pull/6433) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### 改进 {#improvement-3}



* 正确实现 `AND/OR` 的三值逻辑。 [#6048](https://github.com/ClickHouse/ClickHouse/pull/6048) ([Alexander Kazakov](https://github.com/Akazz))
* 现在，具有已过期 TTL 的值和行会在对旧的、没有 TTL 信息或 TTL 信息已过期的部分执行 `OPTIMIZE ... FINAL` 查询后被移除，例如在执行 `ALTER ... MODIFY TTL` 查询之后。新增了 `SYSTEM STOP/START TTL MERGES` 查询，用于禁止/允许分配带有 TTL 的合并任务，并在所有合并中过滤已过期的值。 [#6274](https://github.com/ClickHouse/ClickHouse/pull/6274) ([Anton Popov](https://github.com/CurtizJ))
* 支持通过 `CLICKHOUSE_HISTORY_FILE` 环境变量更改 ClickHouse 客户端历史文件的位置。[#6840](https://github.com/ClickHouse/ClickHouse/pull/6840) ([filimonov](https://github.com/filimonov))
* 从 `InterpreterSelectQuery` 中移除 `dry_run` 标志位。... [#6375](https://github.com/ClickHouse/ClickHouse/pull/6375) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* 支持在 `ON` 子句中使用 `ASOF JOIN`。[#6211](https://github.com/ClickHouse/ClickHouse/pull/6211) ([Artem Zuikov](https://github.com/4ertus2))
* 改进了针对变更（mutations）和复制（replication）操作的跳过索引（skip indexes）支持。支持 `MATERIALIZE/CLEAR INDEX ... IN PARTITION` 查询。`UPDATE x = x` 会重新计算所有使用列 `x` 的索引。 [#5053](https://github.com/ClickHouse/ClickHouse/pull/5053) ([Nikita Vasilev](https://github.com/nikvas0))
* 允许在不受 `allow_experimental_live_view` 设置限制的情况下（例如在服务器启动时）对 live view 执行 `ATTACH` 操作。 [#6754](https://github.com/ClickHouse/ClickHouse/pull/6754) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 在查询分析器收集的堆栈跟踪中，不包括由查询分析器自身生成的堆栈帧。[#6250](https://github.com/ClickHouse/ClickHouse/pull/6250) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 现在表函数 `values`、`file`、`url`、`hdfs` 已支持 ALIAS 列。[#6255](https://github.com/ClickHouse/ClickHouse/pull/6255) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 如果 `config.d` 文件未使用与配置文件相同的根元素，则抛出异常。[#6123](https://github.com/ClickHouse/ClickHouse/pull/6123) ([dimarub2000](https://github.com/dimarub2000))
* 在出现 `no space left on device` 错误时，在异常消息中输出更多信息。[#6182](https://github.com/ClickHouse/ClickHouse/issues/6182), [#6252](https://github.com/ClickHouse/ClickHouse/issues/6252) [#6352](https://github.com/ClickHouse/ClickHouse/pull/6352) ([tavplubix](https://github.com/tavplubix))
* 在确定读查询需要覆盖 `Distributed` 表的哪些分片时（当 `optimize_skip_unused_shards` = 1 时），ClickHouse 现在会同时检查 select 语句中 `prewhere` 和 `where` 子句中的条件。[#6521](https://github.com/ClickHouse/ClickHouse/pull/6521) ([Alexander Kazakov](https://github.com/Akazz))
* 在不支持 AVX2、但支持 SSE 4.2 和 PCLMUL 指令集的机器上启用 `SIMDJSON`。 [#6285](https://github.com/ClickHouse/ClickHouse/issues/6285) [#6320](https://github.com/ClickHouse/ClickHouse/pull/6320) ([alexey-milovidov](https://github.com/alexey-milovidov))
* ClickHouse 可以在不支持 `O_DIRECT` 的文件系统（例如 ZFS 和 BtrFS）上运行，而无需额外调优。 [#4449](https://github.com/ClickHouse/ClickHouse/issues/4449) [#6730](https://github.com/ClickHouse/ClickHouse/pull/6730) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 支持在 `FINAL` 子查询中进行谓词下推。[#6120](https://github.com/ClickHouse/ClickHouse/pull/6120) ([TCeason](https://github.com/TCeason)) [#6162](https://github.com/ClickHouse/ClickHouse/pull/6162) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 改进 `JOIN ON` 键的提取 [#6131](https://github.com/ClickHouse/ClickHouse/pull/6131) ([Artem Zuikov](https://github.com/4ertus2))
* 更新了 `SIMDJSON`。[#6285](https://github.com/ClickHouse/ClickHouse/issues/6285)。[#6306](https://github.com/ClickHouse/ClickHouse/pull/6306) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 对 `SELECT count()` 查询进行了优化，优先选择最小列。[#6344](https://github.com/ClickHouse/ClickHouse/pull/6344) ([Amos Bird](https://github.com/amosbird))
* 在 `windowFunnel()` 中新增了 `strict` 参数。设置 `strict` 后，`windowFunnel()` 仅对唯一值应用条件。[#6548](https://github.com/ClickHouse/ClickHouse/pull/6548) ([achimbab](https://github.com/achimbab))
* 更安全的 `mysqlxx::Pool` 接口。 [#6150](https://github.com/ClickHouse/ClickHouse/pull/6150) ([avasiliev](https://github.com/avasiliev))
* 使用 `--help` 选项执行时，帮助输出中的选项行长度现在会根据终端大小自动调整。[#6590](https://github.com/ClickHouse/ClickHouse/pull/6590) ([dimarub2000](https://github.com/dimarub2000))
* 在无键聚合中禁用 &quot;read in order&quot; 优化。[#6599](https://github.com/ClickHouse/ClickHouse/pull/6599) ([Anton Popov](https://github.com/CurtizJ))
* `INCORRECT_DATA` 和 `TYPE_MISMATCH` 错误码对应的 HTTP 状态码已从默认的 `500 Internal Server Error` 修改为 `400 Bad Request`。 [#6271](https://github.com/ClickHouse/ClickHouse/pull/6271) ([Alexander Rodin](https://github.com/a-rodin))
* 将 `Join` 对象从 `ExpressionAction` 移动到 `AnalyzedJoin` 中。`ExpressionAnalyzer` 和 `ExpressionAction` 不再直接依赖 `Join` 类，其逻辑由 `AnalyzedJoin` 接口进行封装和隐藏。 [#6801](https://github.com/ClickHouse/ClickHouse/pull/6801) ([Artem Zuikov](https://github.com/4ertus2))
* 修复在某个分片为 localhost 且查询通过网络连接发送时，分布式查询可能发生死锁的问题。 [#6759](https://github.com/ClickHouse/ClickHouse/pull/6759) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 更改了多张表 `RENAME` 操作的语义，以避免可能发生的死锁。[#6757](https://github.com/ClickHouse/ClickHouse/issues/6757)。[#6756](https://github.com/ClickHouse/ClickHouse/pull/6756) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 重写了 MySQL 兼容服务器，以避免在内存中加载完整的数据包负载。将每个连接的内存占用降低至大约 `2 * DBMS_DEFAULT_BUFFER_SIZE`（读/写缓冲区）。 [#5811](https://github.com/ClickHouse/ClickHouse/pull/5811) ([Yuriy Baranov](https://github.com/yurriy))
* 将 AST 别名解析逻辑从解析器中移出，因为解析器无需了解任何查询语义。 [#6108](https://github.com/ClickHouse/ClickHouse/pull/6108) ([Artem Zuikov](https://github.com/4ertus2))
* 使 `NamesAndTypesList` 的解析稍微更加安全。[#6408](https://github.com/ClickHouse/ClickHouse/issues/6408)。[#6410](https://github.com/ClickHouse/ClickHouse/pull/6410) ([alexey-milovidov](https://github.com/alexey-milovidov))
* `clickhouse-copier`：允许在检查分区是否存在的查询中使用配置中的 `where_condition`，并在查询中使用 `partition_key` 别名（之前它仅用于读取数据的查询）。 [#6577](https://github.com/ClickHouse/ClickHouse/pull/6577) ([proller](https://github.com/proller))
* 在 `throwIf` 中新增了可选的 message 参数。([#5772](https://github.com/ClickHouse/ClickHouse/issues/5772)) [#6329](https://github.com/ClickHouse/ClickHouse/pull/6329) ([Vdimir](https://github.com/Vdimir))
* 在发送插入数据时收到的服务器端异常现在也会在客户端进行处理。[#5891](https://github.com/ClickHouse/ClickHouse/issues/5891) [#6711](https://github.com/ClickHouse/ClickHouse/pull/6711) ([dimarub2000](https://github.com/dimarub2000))
* 新增指标 `DistributedFilesToInsert`，用于显示由 Distributed 表选中、准备发送到远程服务器的文件系统中文件的总数。该数量会在所有分片上进行求和。 [#6600](https://github.com/ClickHouse/ClickHouse/pull/6600) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 将大部分 JOIN 的预处理逻辑从 `ExpressionAction/ExpressionAnalyzer` 移动到 `AnalyzedJoin`。 [#6785](https://github.com/ClickHouse/ClickHouse/pull/6785) ([Artem Zuikov](https://github.com/4ertus2))
* 修复 TSan 关于“锁顺序反转”（lock-order-inversion）的[告警](https://clickhouse-test-reports.s3.yandex.net/6399/c1c1d1daa98e199e620766f1bd06a5921050a00d/functional_stateful_tests_\(thread\).html)。[#6740](https://github.com/ClickHouse/ClickHouse/pull/6740) ([Vasily Nemkov](https://github.com/Enmk))
* 改进了在缺少 Linux capabilities 时的信息提示。以 &quot;fatal&quot; 级别记录致命错误，便于在 `system.text_log` 中定位。 [#6441](https://github.com/ClickHouse/ClickHouse/pull/6441) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 在启用在执行 `GROUP BY`、`ORDER BY` 时将临时数据转储到磁盘以限制内存使用的功能时，之前不会检查可用磁盘空间。此修复新增了一个设置项 `min_free_disk_space`，当可用磁盘空间小于该阈值时，查询会停止并抛出 `ErrorCodes::NOT_ENOUGH_SPACE`。 [#6678](https://github.com/ClickHouse/ClickHouse/pull/6678) ([Weiqing Xu](https://github.com/weiqxu)) [#6691](https://github.com/ClickHouse/ClickHouse/pull/6691) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 移除了基于线程的递归读写锁。这样做没有意义，因为线程会在查询之间被重用。`SELECT` 查询可能会在一个线程中获取锁、在另一个线程中持有锁，并在第一个线程中退出。与此同时，第一个线程可能会被 `DROP` 查询重用。这会导致出现错误的“Attempt to acquire exclusive lock recursively”消息。[#6771](https://github.com/ClickHouse/ClickHouse/pull/6771) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 拆分 `ExpressionAnalyzer.appendJoin()`。在 `ExpressionAnalyzer` 中为 `MergeJoin` 预留位置。[#6524](https://github.com/ClickHouse/ClickHouse/pull/6524) ([Artem Zuikov](https://github.com/4ertus2))
* 为 MySQL 兼容性服务器添加了 `mysql_native_password` 身份验证插件。[#6194](https://github.com/ClickHouse/ClickHouse/pull/6194) ([Yuriy Baranov](https://github.com/yurriy))
* 减少对 `clock_gettime` 的调用次数；修复了 `Allocator` 在调试版/发布版之间的 ABI 兼容性问题（影响较小）。 [#6197](https://github.com/ClickHouse/ClickHouse/pull/6197) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 将 `collectUsedColumns` 从 `ExpressionAnalyzer` 移动到 `SyntaxAnalyzer`。`SyntaxAnalyzer` 现在会自行构造 `required_source_columns`。[#6416](https://github.com/ClickHouse/ClickHouse/pull/6416) ([Artem Zuikov](https://github.com/4ertus2))
* 新增设置 `joined_subquery_requires_alias`，用于在 `FROM` 子句中当存在多个表（即包含 JOIN 的查询）时，强制要求子查询和表函数必须使用别名。 [#6733](https://github.com/ClickHouse/ClickHouse/pull/6733) ([Artem Zuikov](https://github.com/4ertus2))
* 从 `ExpressionAnalyzer` 中提取 `GetAggregatesVisitor` 类。 [#6458](https://github.com/ClickHouse/ClickHouse/pull/6458) ([Artem Zuikov](https://github.com/4ertus2))
* `system.query_log`：将 `type` 列的数据类型修改为 `Enum`。 [#6265](https://github.com/ClickHouse/ClickHouse/pull/6265) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
* 对 `sha256_password` 认证插件进行静态链接。 [#6512](https://github.com/ClickHouse/ClickHouse/pull/6512) ([Yuriy Baranov](https://github.com/yurriy))
* 避免为了让 `compile` 设置生效而引入额外的依赖项。在之前的版本中，用户可能会遇到诸如 `cannot open crti.o`、`unable to find library -lc` 等错误。[#6309](https://github.com/ClickHouse/ClickHouse/pull/6309) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 进一步加强对可能来自恶意副本的输入的验证。[#6303](https://github.com/ClickHouse/ClickHouse/pull/6303) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 现在 `clickhouse-obfuscator` 文件随 `clickhouse-client` 软件包一同提供。 在之前的版本中，它名为 `clickhouse obfuscator`（中间带空格）。[#5816](https://github.com/ClickHouse/ClickHouse/issues/5816) [#6609](https://github.com/ClickHouse/ClickHouse/pull/6609) ([dimarub2000](https://github.com/dimarub2000))
* 修复了以下情况下可能出现的死锁：当存在至少两个查询以不同顺序读取至少两个表，且另有一个查询在其中一个表上执行 DDL 操作时。还修复了另一个极其罕见的死锁。[#6764](https://github.com/ClickHouse/ClickHouse/pull/6764) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 为 `system.processes` 和 `system.query_log` 添加了 `os_thread_ids` 列，以便更好地进行调试。 [#6763](https://github.com/ClickHouse/ClickHouse/pull/6763) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 针对在将 `sha256_password` 用作默认身份验证插件时会出现的 PHP mysqlnd 扩展缺陷的变通解决方案（详见 [#6031](https://github.com/ClickHouse/ClickHouse/issues/6031)）。[#6113](https://github.com/ClickHouse/ClickHouse/pull/6113)（[Yuriy Baranov](https://github.com/yurriy)）
* 移除在更改列可空性时不必要的步骤。 [#6693](https://github.com/ClickHouse/ClickHouse/pull/6693) ([Artem Zuikov](https://github.com/4ertus2))
* 将 `queue_max_wait_ms` 的默认值设置为零，因为当前的值（五秒）几乎没有意义。只有在极少数情况下该设置才会被用到。为避免歧义，新增了设置项 `replace_running_query_max_wait_ms`、`kafka_max_wait_ms` 和 `connection_pool_max_wait_ms`。 [#6692](https://github.com/ClickHouse/ClickHouse/pull/6692) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 从 `ExpressionAnalyzer` 中抽取出 `SelectQueryExpressionAnalyzer`。保留后者用于非 SELECT 查询。[#6499](https://github.com/ClickHouse/ClickHouse/pull/6499) ([Artem Zuikov](https://github.com/4ertus2))
* 去除了重复的输入和输出格式。 [#6239](https://github.com/ClickHouse/ClickHouse/pull/6239) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* 允许用户在建立连接时自定义 `poll_interval` 和 `idle_connection_timeout` 设置。 [#6230](https://github.com/ClickHouse/ClickHouse/pull/6230) ([alexey-milovidov](https://github.com/alexey-milovidov))
* `MergeTree` 现在新增了一个选项 `ttl_only_drop_parts`（默认禁用），用于避免对数据分片进行部分裁剪，从而在某个分片中的所有行都过期时，直接将该分片整体删除。[#6191](https://github.com/ClickHouse/ClickHouse/pull/6191) ([Sergi Vladykin](https://github.com/svladykin))
* 为 set index 函数添加类型检查。如果函数收到错误类型则抛出异常。修复了使用 UBSan 的模糊测试问题。[#6511](https://github.com/ClickHouse/ClickHouse/pull/6511) ([Nikita Vasilev](https://github.com/nikvas0))



#### 性能改进 {#performance-improvement-2}

- 使用 `ORDER BY expressions` 子句优化查询，其中 `expressions` 的前缀与 `MergeTree` 表的排序键前缀一致。该优化由 `optimize_read_in_order` 设置控制。[#6054](https://github.com/ClickHouse/ClickHouse/pull/6054) [#6629](https://github.com/ClickHouse/ClickHouse/pull/6629) ([Anton Popov](https://github.com/CurtizJ))
- 允许在数据片段加载和删除期间使用多个线程。[#6372](https://github.com/ClickHouse/ClickHouse/issues/6372) [#6074](https://github.com/ClickHouse/ClickHouse/issues/6074) [#6438](https://github.com/ClickHouse/ClickHouse/pull/6438) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 实现了批量更新聚合函数状态的方式，这可能带来性能收益。[#6435](https://github.com/ClickHouse/ClickHouse/pull/6435) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 在 `exp`、`log`、`sigmoid`、`tanh` 函数中使用 `FastOps` 库。FastOps 是由 Michael Parakhin（Yandex CTO）编写的高速向量数学库。`exp` 和 `log` 函数的性能提升超过 6 倍。对 `Float32` 参数的 `exp` 和 `log` 函数现在将返回 `Float32`（在之前版本中它们始终返回 `Float64`）。现在 `exp(nan)` 可能返回 `inf`。`exp` 和 `log` 函数的结果可能不是与真实结果最近的机器可表示数值。[#6254](https://github.com/ClickHouse/ClickHouse/pull/6254) ([alexey-milovidov](https://github.com/alexey-milovidov)) 使用 Danila Kutenin 的方案来使 FastOps 正常工作 [#6317](https://github.com/ClickHouse/ClickHouse/pull/6317) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 禁用对 `UInt8/16` 的连续键优化。[#6298](https://github.com/ClickHouse/ClickHouse/pull/6298) [#6701](https://github.com/ClickHouse/ClickHouse/pull/6701) ([akuzm](https://github.com/akuzm))
- 通过去除 `ParsedJson::Iterator` 中的动态分配，提高了 `simdjson` 库的性能。[#6479](https://github.com/ClickHouse/ClickHouse/pull/6479) ([Vitaly Baranov](https://github.com/vitlibar))
- 在使用 `mmap()` 分配内存时预先触碰内存页。[#6667](https://github.com/ClickHouse/ClickHouse/pull/6667) ([akuzm](https://github.com/akuzm))
- 修复了 `Decimal` 比较中的性能问题。[#6380](https://github.com/ClickHouse/ClickHouse/pull/6380) ([Artem Zuikov](https://github.com/4ertus2))

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-4}



* 移除 Compiler（运行时模板实例化），因为当前实现的性能已经优于它。[#6646](https://github.com/ClickHouse/ClickHouse/pull/6646) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 添加了性能测试，以更隔离的方式展示 gcc-9 中的性能退化。 [#6302](https://github.com/ClickHouse/ClickHouse/pull/6302) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 新增表函数 `numbers_mt`，这是 `numbers` 的多线程版本。更新了使用哈希函数的性能测试。[#6554](https://github.com/ClickHouse/ClickHouse/pull/6554) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* `clickhouse-benchmark` 比较模式 [#6220](https://github.com/ClickHouse/ClickHouse/issues/6220) [#6343](https://github.com/ClickHouse/ClickHouse/pull/6343) ([dimarub2000](https://github.com/dimarub2000))
* 采用尽力而为的方式打印堆栈跟踪。同时添加了 `SIGPROF` 作为调试信号，用于打印正在运行线程的堆栈跟踪。[#6529](https://github.com/ClickHouse/ClickHouse/pull/6529) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 将每个函数放在单独的文件中，第 10 部分。 [#6321](https://github.com/ClickHouse/ClickHouse/pull/6321) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 移除重复定义的常量 `TABLE_IS_READ_ONLY`。 [#6566](https://github.com/ClickHouse/ClickHouse/pull/6566) ([filimonov](https://github.com/filimonov))
* 针对 `StringHashMap` PR [#5417](https://github.com/ClickHouse/ClickHouse/issues/5417) 的格式更改。[#6700](https://github.com/ClickHouse/ClickHouse/pull/6700) ([akuzm](https://github.com/akuzm))
* 在 `ExpressionAnalyzer` 中改进了用于创建 join 的子查询。[#6824](https://github.com/ClickHouse/ClickHouse/pull/6824) ([Artem Zuikov](https://github.com/4ertus2))
* 删除一个冗余条件（由 PVS Studio 发现）。[#6775](https://github.com/ClickHouse/ClickHouse/pull/6775) ([akuzm](https://github.com/akuzm))
* 将 `ReverseIndex` 的哈希表接口拆分出来。 [#6672](https://github.com/ClickHouse/ClickHouse/pull/6672) ([akuzm](https://github.com/akuzm))
* 设置重构。[#6689](https://github.com/ClickHouse/ClickHouse/pull/6689) ([alesapin](https://github.com/alesapin))
* 为 `set` 索引函数添加注释。 [#6319](https://github.com/ClickHouse/ClickHouse/pull/6319) ([Nikita Vasilev](https://github.com/nikvas0))
* 在 Linux 调试版本中提高 OOM 分数。 [#6152](https://github.com/ClickHouse/ClickHouse/pull/6152) ([akuzm](https://github.com/akuzm))
* HDFS HA 现在在 debug 构建中也能正常工作。 [#6650](https://github.com/ClickHouse/ClickHouse/pull/6650) ([Weiqing Xu](https://github.com/weiqxu))
* 为 `transform_query_for_external_database` 添加了一个测试用例。[#6388](https://github.com/ClickHouse/ClickHouse/pull/6388) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 为 Kafka 表添加多个物化视图的测试。[#6509](https://github.com/ClickHouse/ClickHouse/pull/6509) ([Ivan](https://github.com/abyss7))
* 优化构建方案。 [#6500](https://github.com/ClickHouse/ClickHouse/pull/6500) ([Ivan](https://github.com/abyss7))
* 修复了在非 root 用户下运行时的 `test_external_dictionaries` 集成测试。[#6507](https://github.com/ClickHouse/ClickHouse/pull/6507) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* 当写入的数据包总大小超过 `DBMS_DEFAULT_BUFFER_SIZE` 时，该 bug 会复现。 [#6204](https://github.com/ClickHouse/ClickHouse/pull/6204) ([Yuriy Baranov](https://github.com/yurriy))
* 为 `RENAME` 表操作的竞态条件添加了测试 [#6752](https://github.com/ClickHouse/ClickHouse/pull/6752) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 避免在 `KILL QUERY` 中对 Settings 发生数据竞争。 [#6753](https://github.com/ClickHouse/ClickHouse/pull/6753) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 为缓存字典的错误处理添加集成测试。 [#6755](https://github.com/ClickHouse/ClickHouse/pull/6755) ([Vitaly Baranov](https://github.com/vitlibar))
* 在 Mac OS 上禁用 ELF 目标文件的解析，因为这样做没有意义。[#6578](https://github.com/ClickHouse/ClickHouse/pull/6578) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 尝试改进变更日志生成器。[#6327](https://github.com/ClickHouse/ClickHouse/pull/6327) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 为 GCC 添加 `-Wshadow` 开关。 [#6325](https://github.com/ClickHouse/ClickHouse/pull/6325) ([kreuzerkrieg](https://github.com/kreuzerkrieg))
* 移除了用于 `mimalloc` 支持的过时代码。[#6715](https://github.com/ClickHouse/ClickHouse/pull/6715) ([alexey-milovidov](https://github.com/alexey-milovidov))
* `zlib-ng` 会检测 x86 的特性，并将此信息保存到全局变量中。此操作在 defalteInit 调用时执行，而该调用可能会被不同线程同时触发。为避免多线程并发写入，应在库启动时完成此操作。 [#6141](https://github.com/ClickHouse/ClickHouse/pull/6141) ([akuzm](https://github.com/akuzm))
* 针对曾在 `JOIN` 中出现、并已在 [#5192](https://github.com/ClickHouse/ClickHouse/issues/5192) 中修复的 bug 的回归测试。[#6147](https://github.com/ClickHouse/ClickHouse/pull/6147) ([Bakhtiyor Ruziev](https://github.com/theruziev))
* 修复了 MSan 报告。[#6144](https://github.com/ClickHouse/ClickHouse/pull/6144) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复不稳定的 TTL 测试。[#6782](https://github.com/ClickHouse/ClickHouse/pull/6782) ([Anton Popov](https://github.com/CurtizJ))
* 修复 `MergeTreeDataPart::is_frozen` 字段中的虚假数据竞争。 [#6583](https://github.com/ClickHouse/ClickHouse/pull/6583) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了模糊测试中的超时问题。在此前的版本中，它会错误地将查询 `SELECT * FROM numbers_mt(gccMurmurHash(''))` 判定为挂起。[#6582](https://github.com/ClickHouse/ClickHouse/pull/6582) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 在对列执行 `static_cast` 时添加了调试检查。[#6581](https://github.com/ClickHouse/ClickHouse/pull/6581) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 在官方 RPM 软件包中增加对 Oracle Linux 的支持。[#6356](https://github.com/ClickHouse/ClickHouse/issues/6356) [#6585](https://github.com/ClickHouse/ClickHouse/pull/6585) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 将 JSON perftests 的类型从 `once` 更改为 `loop` 类型。 [#6536](https://github.com/ClickHouse/ClickHouse/pull/6536) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* `odbc-bridge.cpp` 定义了 `main()`，因此不应包含在 `clickhouse-lib` 中。 [#6538](https://github.com/ClickHouse/ClickHouse/pull/6538) ([Orivej Desh](https://github.com/orivej))
* 用于测试在右表键包含 NULL 值时 `FULL|RIGHT JOIN` 崩溃的问题。 [#6362](https://github.com/ClickHouse/ClickHouse/pull/6362) ([Artem Zuikov](https://github.com/4ertus2))
* 为别名展开的限制添加了一个测试，以防万一。[#6442](https://github.com/ClickHouse/ClickHouse/pull/6442) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 在适当的地方将 `boost::filesystem` 替换为 `std::filesystem`。 [#6253](https://github.com/ClickHouse/ClickHouse/pull/6253) [#6385](https://github.com/ClickHouse/ClickHouse/pull/6385) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 已在网站上添加 RPM 软件包。 [#6251](https://github.com/ClickHouse/ClickHouse/pull/6251) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 为已修复的 `IN` 子句中的 `Unknown identifier` 异常添加测试。[#6708](https://github.com/ClickHouse/ClickHouse/pull/6708) ([Artem Zuikov](https://github.com/4ertus2))
* 简化 `shared_ptr_helper`，因为许多人表示难以理解它。 [#6675](https://github.com/ClickHouse/ClickHouse/pull/6675) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 已为修复后的 Gorilla 和 DoubleDelta 编解码器添加性能测试。[#6179](https://github.com/ClickHouse/ClickHouse/pull/6179) ([Vasily Nemkov](https://github.com/Enmk))
* 将集成测试 `test_dictionaries` 拆分为 4 个独立的测试用例。[#6776](https://github.com/ClickHouse/ClickHouse/pull/6776) ([Vitaly Baranov](https://github.com/vitlibar))
* 修复 `PipelineExecutor` 中的 PVS-Studio 警告。[#6777](https://github.com/ClickHouse/ClickHouse/pull/6777) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* 允许在启用 ASan 时使用 `library` 字典源。[#6482](https://github.com/ClickHouse/ClickHouse/pull/6482) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 新增了从 PR 列表生成变更日志的选项。 [#6350](https://github.com/ClickHouse/ClickHouse/pull/6350) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 读取时锁定 `TinyLog` 存储。[#6226](https://github.com/ClickHouse/ClickHouse/pull/6226) ([akuzm](https://github.com/akuzm))
* 在 CI 中检查失效的符号链接。 [#6634](https://github.com/ClickHouse/ClickHouse/pull/6634) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 增加“stack overflow”测试的超时时间，因为在调试构建中它可能会花费很长时间。[#6637](https://github.com/ClickHouse/ClickHouse/pull/6637) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 新增了对双空格的检查。[#6643](https://github.com/ClickHouse/ClickHouse/pull/6643) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 在使用 sanitizer 编译时修复 `new/delete` 内存跟踪。当前跟踪逻辑并不清晰，目前仅能在测试中避免触发内存限制异常。[#6450](https://github.com/ClickHouse/ClickHouse/pull/6450) ([Artem Zuikov](https://github.com/4ertus2))
* 重新启用在链接阶段对未定义符号的检查。 [#6453](https://github.com/ClickHouse/ClickHouse/pull/6453) ([Ivan](https://github.com/abyss7))
* 避免每天都重新构建 `hyperscan`。 [#6307](https://github.com/ClickHouse/ClickHouse/pull/6307) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了 `ProtobufWriter` 中由 UBSan 报告的问题。[#6163](https://github.com/ClickHouse/ClickHouse/pull/6163) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 不允许在启用 sanitizer 时使用查询分析器，因为二者不兼容。 [#6769](https://github.com/ClickHouse/ClickHouse/pull/6769) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 添加测试，用于在失败后由计时器触发重新加载字典。[#6114](https://github.com/ClickHouse/ClickHouse/pull/6114) ([Vitaly Baranov](https://github.com/vitlibar))
* 修复 `PipelineExecutor::prepareProcessor` 参数类型不一致的问题。 [#6494](https://github.com/ClickHouse/ClickHouse/pull/6494) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* 为无效的 URI 添加了测试。[#6493](https://github.com/ClickHouse/ClickHouse/pull/6493) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 为 `CAST` 函数增加了更多检查，以便在模糊测试中获取更多关于段错误的信息。 [#6346](https://github.com/ClickHouse/ClickHouse/pull/6346) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* 为在本地构建镜像的 `docker/builder` 容器添加了对 `gcc-9` 的支持。[#6333](https://github.com/ClickHouse/ClickHouse/pull/6333) ([Gleb Novikov](https://github.com/NanoBjorn))
* 针对 `LowCardinality(String)` 主键的测试。[#5044](https://github.com/ClickHouse/ClickHouse/issues/5044) [#6219](https://github.com/ClickHouse/ClickHouse/pull/6219) ([dimarub2000](https://github.com/dimarub2000))
* 修复了由于堆栈跟踪打印缓慢而受影响的测试。[#6315](https://github.com/ClickHouse/ClickHouse/pull/6315) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 为 `groupUniqArray` 中已在 [#6029](https://github.com/ClickHouse/ClickHouse/pull/6029) 中修复的崩溃问题添加一个测试用例。[#4402](https://github.com/ClickHouse/ClickHouse/issues/4402) [#6129](https://github.com/ClickHouse/ClickHouse/pull/6129) ([akuzm](https://github.com/akuzm))
* 修复索引变更测试。[#6645](https://github.com/ClickHouse/ClickHouse/pull/6645) ([Nikita Vasilev](https://github.com/nikvas0))
* 在性能测试中，不要从查询日志中读取我们未执行的查询。 [#6427](https://github.com/ClickHouse/ClickHouse/pull/6427) ([akuzm](https://github.com/akuzm))
* 现在可以使用任意低基数类型创建物化视图，而不受关于「可疑低基数类型」设置的限制。 [#6428](https://github.com/ClickHouse/ClickHouse/pull/6428) ([Olga Khvostikova](https://github.com/stavrolia))
* 更新了 `send_logs_level` 设置的测试。[#6207](https://github.com/ClickHouse/ClickHouse/pull/6207)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）
* 修复在 gcc-8.2 下的构建问题。[#6196](https://github.com/ClickHouse/ClickHouse/pull/6196) ([Max Akhmedov](https://github.com/zlobober))
* 修复使用内部 libc++ 时的构建问题。 [#6724](https://github.com/ClickHouse/ClickHouse/pull/6724) ([Ivan](https://github.com/abyss7))
* 修复基于 `rdkafka` 库的共享库构建 [#6101](https://github.com/ClickHouse/ClickHouse/pull/6101) ([Ivan](https://github.com/abyss7))
* 针对 Mac OS 的构建修复（不完整）。[#6390](https://github.com/ClickHouse/ClickHouse/pull/6390) ([alexey-milovidov](https://github.com/alexey-milovidov)) [#6429](https://github.com/ClickHouse/ClickHouse/pull/6429) ([alex-zaitsev](https://github.com/alex-zaitsev))
* 修复“splitted”构建版本。[#6618](https://github.com/ClickHouse/ClickHouse/pull/6618) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 其他构建修复项：[#6186](https://github.com/ClickHouse/ClickHouse/pull/6186) ([Amos Bird](https://github.com/amosbird)) [#6486](https://github.com/ClickHouse/ClickHouse/pull/6486) [#6348](https://github.com/ClickHouse/ClickHouse/pull/6348) ([vxider](https://github.com/Vxider)) [#6744](https://github.com/ClickHouse/ClickHouse/pull/6744) ([Ivan](https://github.com/abyss7)) [#6016](https://github.com/ClickHouse/ClickHouse/pull/6016) [#6421](https://github.com/ClickHouse/ClickHouse/pull/6421) [#6491](https://github.com/ClickHouse/ClickHouse/pull/6491) ([proller](https://github.com/proller))



#### 向后不兼容的变更 {#backward-incompatible-change-3}

- 移除了很少使用的表函数 `catBoostPool` 和存储引擎 `CatBoostPool`。如果你曾使用过该表函数，请发送邮件到 `feedback@clickhouse.com`。注意，CatBoost 集成功能仍然保留并会继续得到支持。[#6279](https://github.com/ClickHouse/ClickHouse/pull/6279) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 默认禁用 `ANY RIGHT JOIN` 和 `ANY FULL JOIN`。请通过设置 `any_join_distinct_right_table_keys` 参数来启用它们。[#5126](https://github.com/ClickHouse/ClickHouse/issues/5126) [#6351](https://github.com/ClickHouse/ClickHouse/pull/6351) ([Artem Zuikov](https://github.com/4ertus2))



## ClickHouse Release 19.13 {#clickhouse-release-19-13}

### ClickHouse Release 19.13.6.51, 2019-10-02 {#clickhouse-release-19-13-6-51-2019-10-02}

#### Bug Fix {#bug-fix-9}

- 此版本还包含 19.11.12.69 中的所有错误修复。

### ClickHouse Release 19.13.5.44, 2019-09-20 {#clickhouse-release-19-13-5-44-2019-09-20}

#### Bug Fix {#bug-fix-10}

- 此版本还包含 19.14.6.12 中的所有错误修复。
- 修复了在 ZooKeeper 不可访问时，对副本表执行 `DROP` 查询可能导致表处于不一致状态的问题。 [#6045](https://github.com/ClickHouse/ClickHouse/issues/6045) [#6413](https://github.com/ClickHouse/ClickHouse/pull/6413) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- 修复了 StorageMerge 中的数据竞争问题。 [#6717](https://github.com/ClickHouse/ClickHouse/pull/6717) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了在查询分析器中引入的错误，该错误会导致从套接字无限次接收数据。 [#6386](https://github.com/ClickHouse/ClickHouse/pull/6386) ([alesapin](https://github.com/alesapin))
- 修复了在布尔值上执行 `JSONExtractRaw` 函数时过高的 CPU 使用率。 [#6208](https://github.com/ClickHouse/ClickHouse/pull/6208) ([Vitaly Baranov](https://github.com/vitlibar))
- 修复了向物化视图写入数据时的回归问题。 [#6415](https://github.com/ClickHouse/ClickHouse/pull/6415) ([Ivan](https://github.com/abyss7))
- 表函数 `url` 存在一个漏洞，允许攻击者在请求中注入任意 HTTP 头部。该问题由 [Nikita Tikhomirov](https://github.com/NSTikhomirov) 发现。 [#6466](https://github.com/ClickHouse/ClickHouse/pull/6466) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了 Set 索引中无用的 `AST` 检查。 [#6510](https://github.com/ClickHouse/ClickHouse/issues/6510) [#6651](https://github.com/ClickHouse/ClickHouse/pull/6651) ([Nikita Vasilev](https://github.com/nikvas0))
- 修复了解析嵌入在查询中的 `AggregateFunction` 值时的问题。 [#6575](https://github.com/ClickHouse/ClickHouse/issues/6575) [#6773](https://github.com/ClickHouse/ClickHouse/pull/6773) ([Zhichang Yu](https://github.com/yuzhichang))
- 修复了 `trim` 函数族的不正确行为。 [#6647](https://github.com/ClickHouse/ClickHouse/pull/6647) ([alexey-milovidov](https://github.com/alexey-milovidov))

### ClickHouse Release 19.13.4.32, 2019-09-10 {#clickhouse-release-19-13-4-32-2019-09-10}

#### Bug Fix {#bug-fix-11}



- 此版本还包含 19.11.9.52 和 19.11.10.54 中的所有安全漏洞修复。
- 修复了在 `system.parts` 表和 `ALTER` 查询中的数据竞争问题。[#6245](https://github.com/ClickHouse/ClickHouse/issues/6245) [#6513](https://github.com/ClickHouse/ClickHouse/pull/6513) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了在从带有 sample 和 prewhere 的空分布式表读取时发生的数据流头部不匹配问题。[#6167](https://github.com/ClickHouse/ClickHouse/issues/6167) ([Lixiang Qian](https://github.com/fancyqlx)) [#6823](https://github.com/ClickHouse/ClickHouse/pull/6823) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- 修复了在使用带有元组子查询的 `IN` 子句时发生的崩溃。[#6125](https://github.com/ClickHouse/ClickHouse/issues/6125) [#6550](https://github.com/ClickHouse/ClickHouse/pull/6550) ([tavplubix](https://github.com/tavplubix))
- 修复了在 `GLOBAL JOIN ON` 子句中存在相同列名时的问题。[#6181](https://github.com/ClickHouse/ClickHouse/pull/6181) ([Artem Zuikov](https://github.com/4ertus2))
- 修复了在将不支持转换为 `Decimal` 的类型进行转换时的崩溃，现在改为抛出异常。[#6297](https://github.com/ClickHouse/ClickHouse/pull/6297) ([Artem Zuikov](https://github.com/4ertus2))
- 修复了 `extractAll()` 函数中的崩溃。[#6644](https://github.com/ClickHouse/ClickHouse/pull/6644) ([Artem Zuikov](https://github.com/4ertus2))
- 现在 `MySQL`、`ODBC`、`JDBC` 表函数的查询改写已能正确处理包含多个 `AND` 表达式的 `SELECT WHERE` 查询。[#6381](https://github.com/ClickHouse/ClickHouse/issues/6381) [#6676](https://github.com/ClickHouse/ClickHouse/pull/6676) ([dimarub2000](https://github.com/dimarub2000))
- 为 MySQL 8 集成增加了对重复声明的检查。[#6569](https://github.com/ClickHouse/ClickHouse/pull/6569) ([Rafael David Tinoco](https://github.com/rafaeldtinoco))

#### 安全修复 {#security-fix-1}

- 修复了解压阶段中编解码器的两个漏洞（恶意用户可以伪造压缩数据，从而在解压过程中导致缓冲区溢出）。[#6670](https://github.com/ClickHouse/ClickHouse/pull/6670) ([Artem Zuikov](https://github.com/4ertus2))

### ClickHouse Release 19.13.3.26，2019-08-22 {#clickhouse-release-19-13-3-26-2019-08-22}

#### 错误修复 {#bug-fix-12}



- 修复在 `enable_mixed_granularity_parts=1` 的表上执行 `ALTER TABLE ... UPDATE` 查询的问题。[#6543](https://github.com/ClickHouse/ClickHouse/pull/6543) ([alesapin](https://github.com/alesapin))
- 修复在 IN 子句中使用带元组的子查询时出现的 NPE（空指针异常）。[#6125](https://github.com/ClickHouse/ClickHouse/issues/6125) [#6550](https://github.com/ClickHouse/ClickHouse/pull/6550) ([tavplubix](https://github.com/tavplubix))
- 修复一个问题：如果落后的副本恢复为可用状态，它可能仍然包含已被 DROP PARTITION 删除的数据分片。[#6522](https://github.com/ClickHouse/ClickHouse/issues/6522) [#6523](https://github.com/ClickHouse/ClickHouse/pull/6523) ([tavplubix](https://github.com/tavplubix))
- 修复解析 CSV 的问题。[#6426](https://github.com/ClickHouse/ClickHouse/issues/6426) [#6559](https://github.com/ClickHouse/ClickHouse/pull/6559) ([tavplubix](https://github.com/tavplubix))
- 修复 `system.parts` 表和 ALTER 查询中的数据竞争问题。这修复了 [#6245](https://github.com/ClickHouse/ClickHouse/issues/6245)。[#6513](https://github.com/ClickHouse/ClickHouse/pull/6513) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了变更（mutation）代码中的错误，该错误可能导致内存损坏。修复了读取地址 `0x14c0` 时产生的段错误（segfault），该问题可能由于并发执行 `DROP TABLE` 与从 `system.parts` 或 `system.parts_columns` 进行 `SELECT` 导致。修复了在准备变更查询时出现的竞争条件。修复了由复制表（Replicated 表）的 `OPTIMIZE` 与 ALTER 等并发修改操作引起的死锁。[#6514](https://github.com/ClickHouse/ClickHouse/pull/6514) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了在带有跳过索引（skipping index）的表上执行 `ALTER DELETE` 查询后可能导致数据丢失的问题。[#6224](https://github.com/ClickHouse/ClickHouse/issues/6224) [#6282](https://github.com/ClickHouse/ClickHouse/pull/6282) ([Nikita Vasilev](https://github.com/nikvas0))

#### 安全修复 {#security-fix-2}

- 如果攻击者对 ZooKeeper 拥有写权限，并且能够在 ClickHouse 所在网络中运行自定义服务器，则可以创建一个特制的恶意服务器，使其作为 ClickHouse 副本运行并在 ZooKeeper 中注册。当其他副本从该恶意副本拉取数据分片时，它可以强制 clickhouse-server 向文件系统上的任意路径写入数据。该问题由 Yandex 信息安全团队的 Eldar Zaitov 发现。[#6247](https://github.com/ClickHouse/ClickHouse/pull/6247) ([alexey-milovidov](https://github.com/alexey-milovidov))

### ClickHouse Release 19.13.2.19，2019-08-14 {#clickhouse-release-19-13-2-19-2019-08-14}

#### 新特性 {#new-feature-5}



- 查询级别的采样分析器。 [示例](https://gist.github.com/alexey-milovidov/92758583dd41c24c360fdb8d6a4da194)。 [#4247](https://github.com/ClickHouse/ClickHouse/issues/4247) ([laplab](https://github.com/laplab)) [#6124](https://github.com/ClickHouse/ClickHouse/pull/6124) ([alexey-milovidov](https://github.com/alexey-milovidov)) [#6250](https://github.com/ClickHouse/ClickHouse/pull/6250) [#6283](https://github.com/ClickHouse/ClickHouse/pull/6283) [#6386](https://github.com/ClickHouse/ClickHouse/pull/6386)
- 允许使用 `COLUMNS('regexp')` 表达式指定列列表，该表达式的行为类似于更高级版本的 `*` 通配符。 [#5951](https://github.com/ClickHouse/ClickHouse/pull/5951) ([mfridental](https://github.com/mfridental)), ([alexey-milovidov](https://github.com/alexey-milovidov))
- 现在支持 `CREATE TABLE AS table_function()`。 [#6057](https://github.com/ClickHouse/ClickHouse/pull/6057) ([dimarub2000](https://github.com/dimarub2000))
- 在 `stochasticLinearRegression()` 和 `stochasticLogisticRegression()` 聚合函数中，默认使用随机梯度下降的 Adam 优化器，因为它在几乎无需调参的情况下就能提供良好的效果。 [#6000](https://github.com/ClickHouse/ClickHouse/pull/6000) ([Quid37](https://github.com/Quid37))
- 新增用于处理自定义周序号的函数。 [#5212](https://github.com/ClickHouse/ClickHouse/pull/5212) ([Andy Yang](https://github.com/andyyzh))
- 现在 `RENAME` 查询可用于所有存储引擎。 [#5953](https://github.com/ClickHouse/ClickHouse/pull/5953) ([Ivan](https://github.com/abyss7))
- 现在客户端可以通过设置 `send_logs_level`，在不考虑服务端配置的日志级别的情况下，从服务端接收任意所需级别的日志。 [#5964](https://github.com/ClickHouse/ClickHouse/pull/5964) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))

#### 向后不兼容的更改 {#backward-incompatible-change-4}

- 设置 `input_format_defaults_for_omitted_fields` 默认启用。对 Distributed 表执行插入操作时，需要在整个集群中保持该设置一致（需要在滚动升级前设置好）。该设置会在 `JSONEachRow` 和 `CSV*` 格式中，为被省略字段计算复杂的默认表达式。这应该是预期行为，但可能带来可以忽略不计的性能差异。 [#6043](https://github.com/ClickHouse/ClickHouse/pull/6043) ([Artem Zuikov](https://github.com/4ertus2)), [#5625](https://github.com/ClickHouse/ClickHouse/pull/5625) ([akuzm](https://github.com/akuzm))

#### 实验特性 {#experimental-features}

- 新的查询处理流水线。使用 `experimental_use_processors=1` 选项启用。请自行承担使用风险。 [#4914](https://github.com/ClickHouse/ClickHouse/pull/4914) ([Nikolai Kochetov](https://github.com/KochetovNicolai))

#### Bug 修复 {#bug-fix-13}

- 本版本修复了 Kafka 集成。
- 修复了在 `DoubleDelta` 值较大时 `Int64` 的 `DoubleDelta` 编码，并改进了 `Int32` 在随机数据上的 `DoubleDelta` 编码。 [#5998](https://github.com/ClickHouse/ClickHouse/pull/5998) ([Vasily Nemkov](https://github.com/Enmk))
- 修复了当 `merge_tree_uniform_read_distribution` 设置为 0 时，对 `max_rows_to_read` 的高估问题。 [#6019](https://github.com/ClickHouse/ClickHouse/pull/6019) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### 改进 {#improvement-4}

- 当 `config.d` 文件不包含与主配置文件对应的根元素时抛出异常。 [#6123](https://github.com/ClickHouse/ClickHouse/pull/6123) ([dimarub2000](https://github.com/dimarub2000))



#### 性能改进 {#performance-improvement-3}

- 优化 `count()`。现在它会优先使用最小的列（如果可能）。[#6028](https://github.com/ClickHouse/ClickHouse/pull/6028) ([Amos Bird](https://github.com/amosbird))

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-5}

- 在性能测试中报告内存使用情况。[#5899](https://github.com/ClickHouse/ClickHouse/pull/5899) ([akuzm](https://github.com/akuzm))
- 修复使用外部 `libcxx` 时的构建问题。[#6010](https://github.com/ClickHouse/ClickHouse/pull/6010) ([Ivan](https://github.com/abyss7))
- 修复基于 `rdkafka` 库的共享库构建问题。[#6101](https://github.com/ClickHouse/ClickHouse/pull/6101) ([Ivan](https://github.com/abyss7))



## ClickHouse 发行版 19.11 {#clickhouse-release-19-11}

### ClickHouse 发行版 19.11.13.74，2019-11-01 {#clickhouse-release-19-11-13-74-2019-11-01}

#### Bug Fix {#bug-fix-14}

- 修复了在执行 `ALTER MODIFY COLUMN` 和垂直合并时，当被合并/被修改的某个数据部分为空（0 行）时出现的罕见崩溃问题。 [#6780](https://github.com/ClickHouse/ClickHouse/pull/6780) ([alesapin](https://github.com/alesapin))
- 手动更新 `SIMDJSON`。修复了可能向 stderr 输出文件大量写入虚假的 JSON 诊断消息的问题。 [#7548](https://github.com/ClickHouse/ClickHouse/pull/7548) ([Alexander Kazakov](https://github.com/Akazz))
- 修复了与变更操作中 `mrk` 文件扩展名相关的错误。 [#7548](https://github.com/ClickHouse/ClickHouse/pull/7548) ([alesapin](https://github.com/alesapin))

### ClickHouse 发行版 19.11.12.69，2019-10-02 {#clickhouse-release-19-11-12-69-2019-10-02}

#### Bug Fix {#bug-fix-15}

- 修复了在大表上针对复杂键进行索引分析时的性能下降问题。修复了 [#6924](https://github.com/ClickHouse/ClickHouse/issues/6924)。 [#7075](https://github.com/ClickHouse/ClickHouse/pull/7075) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 避免在向使用 Distributed 引擎的表发送数据时出现罕见的 SIGSEGV（`Failed to send batch: file with index XXXXX is absent`）。 [#7032](https://github.com/ClickHouse/ClickHouse/pull/7032) ([Azat Khuzhin](https://github.com/azat))
- 修复了多表 join 时出现的 `Unknown identifier` 错误。修复了 [#5254](https://github.com/ClickHouse/ClickHouse/issues/5254)。 [#7022](https://github.com/ClickHouse/ClickHouse/pull/7022) ([Artem Zuikov](https://github.com/4ertus2))

### ClickHouse 发行版 19.11.11.57，2019-09-13 {#clickhouse-release-19-11-11-57-2019-09-13}

- 修复了在从空的 Kafka 主题中进行查询时导致段错误的逻辑错误。 [#6902](https://github.com/ClickHouse/ClickHouse/issues/6902) [#6909](https://github.com/ClickHouse/ClickHouse/pull/6909) ([Ivan](https://github.com/abyss7))
- 修复了函数 `АrrayEnumerateUniqRanked` 在参数包含空数组时的问题。 [#6928](https://github.com/ClickHouse/ClickHouse/pull/6928) ([proller](https://github.com/proller))

### ClickHouse 发行版 19.11.10.54，2019-09-10 {#clickhouse-release-19-11-10-54-2019-09-10}

#### Bug Fix {#bug-fix-16}

- 手动存储 Kafka 消息的 offset，以便能够一次性为所有分区统一提交。修复了在「一个 consumer - 多个 partition」场景下可能出现的重复消费问题。 [#6872](https://github.com/ClickHouse/ClickHouse/pull/6872) ([Ivan](https://github.com/abyss7))

### ClickHouse 发行版 19.11.9.52，2019-09-6 {#clickhouse-release-19-11-9-52-2019-09-6}



- 改进缓存字典中的错误处理。 [#6737](https://github.com/ClickHouse/ClickHouse/pull/6737) ([Vitaly Baranov](https://github.com/vitlibar))
- 修复函数 `arrayEnumerateUniqRanked` 中的错误。 [#6779](https://github.com/ClickHouse/ClickHouse/pull/6779) ([proller](https://github.com/proller))
- 修复从 JSON 中提取 `Tuple` 时 `JSONExtract` 函数的问题。 [#6718](https://github.com/ClickHouse/ClickHouse/pull/6718) ([Vitaly Baranov](https://github.com/vitlibar))
- 修复在带有 skipping 索引的表上执行 `ALTER DELETE` 查询后可能发生的数据丢失问题。 [#6224](https://github.com/ClickHouse/ClickHouse/issues/6224) [#6282](https://github.com/ClickHouse/ClickHouse/pull/6282) ([Nikita Vasilev](https://github.com/nikvas0))
- 修复性能测试。 [#6392](https://github.com/ClickHouse/ClickHouse/pull/6392) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Parquet：修复读取 boolean 列的问题。 [#6579](https://github.com/ClickHouse/ClickHouse/pull/6579) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复 `nullIf` 函数在常量参数下的错误行为。 [#6518](https://github.com/ClickHouse/ClickHouse/pull/6518) ([Guillaume Tassery](https://github.com/YiuRULE)) [#6580](https://github.com/ClickHouse/ClickHouse/pull/6580) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复在正常服务器重启时 Kafka 消息重复的问题。 [#6597](https://github.com/ClickHouse/ClickHouse/pull/6597) ([Ivan](https://github.com/abyss7))
- 修复一个问题：长时间运行的 `ALTER UPDATE` 或 `ALTER DELETE` 可能会阻止常规合并执行。如果没有足够空闲线程可用，则阻止执行变更操作（mutation）。 [#6502](https://github.com/ClickHouse/ClickHouse/issues/6502) [#6617](https://github.com/ClickHouse/ClickHouse/pull/6617) ([tavplubix](https://github.com/tavplubix))
- 修复在服务器配置文件中处理 "timezone" 时的错误。 [#6709](https://github.com/ClickHouse/ClickHouse/pull/6709) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复 Kafka 测试。 [#6805](https://github.com/ClickHouse/ClickHouse/pull/6805) ([Ivan](https://github.com/abyss7))

#### 安全修复 {#security-fix-3}

- 如果攻击者对 ZooKeeper 拥有写入权限，并且能够在 ClickHouse 所在网络中运行自定义服务器，则它可以创建一个特制的恶意服务器，使其作为 ClickHouse 副本并注册到 ZooKeeper 中。当另一副本从该恶意副本拉取数据分片时，可以强制 clickhouse-server 向文件系统上的任意路径写入。该问题由 Yandex 信息安全团队的 Eldar Zaitov 发现。 [#6247](https://github.com/ClickHouse/ClickHouse/pull/6247) ([alexey-milovidov](https://github.com/alexey-milovidov))

### ClickHouse Release 19.11.8.46，2019-08-22 {#clickhouse-release-19-11-8-46-2019-08-22}

#### Bug 修复 {#bug-fix-17}



- 修复在 `enable_mixed_granularity_parts=1` 的表上执行 `ALTER TABLE ... UPDATE` 查询的问题。[#6543](https://github.com/ClickHouse/ClickHouse/pull/6543) ([alesapin](https://github.com/alesapin))
- 修复在 `IN` 子句中使用带有元组的子查询时出现的空指针异常（NPE）。[#6125](https://github.com/ClickHouse/ClickHouse/issues/6125) [#6550](https://github.com/ClickHouse/ClickHouse/pull/6550) ([tavplubix](https://github.com/tavplubix))
- 修复这样一个问题：如果一个过期副本重新变为活跃状态，它可能仍然包含已被 `DROP PARTITION` 删除的数据分片。[#6522](https://github.com/ClickHouse/ClickHouse/issues/6522) [#6523](https://github.com/ClickHouse/ClickHouse/pull/6523) ([tavplubix](https://github.com/tavplubix))
- 修复解析 CSV 时的问题。[#6426](https://github.com/ClickHouse/ClickHouse/issues/6426) [#6559](https://github.com/ClickHouse/ClickHouse/pull/6559) ([tavplubix](https://github.com/tavplubix))
- 修复 `system.parts` 表与 `ALTER` 查询中的数据竞争问题。此修复解决了 [#6245](https://github.com/ClickHouse/ClickHouse/issues/6245)。[#6513](https://github.com/ClickHouse/ClickHouse/pull/6513) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复变更（mutation）代码中的错误，该错误可能导致内存损坏。修复因并发执行 `DROP TABLE` 与从 `system.parts` 或 `system.parts_columns` 中执行 `SELECT` 读取而可能发生的读取地址 `0x14c0` 的段错误（segfault）。修复在准备变更查询时的竞争条件。修复由对 Replicated 表执行 `OPTIMIZE` 与并发 `ALTER` 等修改操作导致的死锁。[#6514](https://github.com/ClickHouse/ClickHouse/pull/6514) ([alexey-milovidov](https://github.com/alexey-milovidov))

### ClickHouse Release 19.11.7.40, 2019-08-14 {#clickhouse-release-19-11-7-40-2019-08-14}

#### Bug Fix {#bug-fix-18}



- 本版本已修复 Kafka 集成。
- 修复了对常量参数使用 `arrayReduce` 时的段错误（segfault）。 [#6326](https://github.com/ClickHouse/ClickHouse/pull/6326) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了 `toFloat()` 的单调性问题。 [#6374](https://github.com/ClickHouse/ClickHouse/pull/6374) ([dimarub2000](https://github.com/dimarub2000))
- 修复在启用 `optimize_skip_unused_shards` 且缺失分片键时出现的段错误（segfault）。 [#6384](https://github.com/ClickHouse/ClickHouse/pull/6384) ([CurtizJ](https://github.com/CurtizJ))
- 修正了 `arrayEnumerateUniqRanked` 函数的逻辑。 [#6423](https://github.com/ClickHouse/ClickHouse/pull/6423) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 从 MySQL 处理器中移除了多余的详细日志输出。 [#6389](https://github.com/ClickHouse/ClickHouse/pull/6389) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了 `topK` 和 `topKWeighted` 聚合函数中的错误行为及可能发生的段错误（segfault）。 [#6404](https://github.com/ClickHouse/ClickHouse/pull/6404) ([CurtizJ](https://github.com/CurtizJ))
- 不再在 `system.columns` 表中暴露虚拟列。此更改是为了保持向后兼容性。 [#6406](https://github.com/ClickHouse/ClickHouse/pull/6406) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了复合键缓存字典中字符串字段内存分配的错误。 [#6447](https://github.com/ClickHouse/ClickHouse/pull/6447) ([alesapin](https://github.com/alesapin))
- 修复在为 `Replicated*MergeTree` 表创建新副本时启用自适应粒度（adaptive granularity）功能的错误。 [#6452](https://github.com/ClickHouse/ClickHouse/pull/6452) ([alesapin](https://github.com/alesapin))
- 修复了读取 Kafka 消息时出现的无限循环问题。 [#6354](https://github.com/ClickHouse/ClickHouse/pull/6354) ([abyss7](https://github.com/abyss7))
- 修复了构造查询可能导致 SQL 解析器栈溢出并引发服务器崩溃的问题，以及在 `Merge` 和 `Distributed` 表中可能出现的栈溢出问题。 [#6433](https://github.com/ClickHouse/ClickHouse/pull/6433) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了在短序列上进行 Gorilla 编码时的错误。 [#6444](https://github.com/ClickHouse/ClickHouse/pull/6444) ([Enmk](https://github.com/Enmk))

#### 改进 {#improvement-5}

- 允许用户在连接时重写 `poll_interval` 和 `idle_connection_timeout` 设置。 [#6230](https://github.com/ClickHouse/ClickHouse/pull/6230) ([alexey-milovidov](https://github.com/alexey-milovidov))

### ClickHouse Release 19.11.5.28, 2019-08-05 {#clickhouse-release-19-11-5-28-2019-08-05}

#### Bug 修复 {#bug-fix-19}



- 修复了在服务器过载时查询可能挂起的问题。[#6301](https://github.com/ClickHouse/ClickHouse/pull/6301) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了 `yandexConsistentHash` 函数中的浮点运算异常（FPE）。此修复对应 [#6304](https://github.com/ClickHouse/ClickHouse/issues/6304)。[#6126](https://github.com/ClickHouse/ClickHouse/pull/6126) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了在 `AggregateFunctionFactory` 中转换 `LowCardinality` 类型时的错误。此修复对应 [#6257](https://github.com/ClickHouse/ClickHouse/issues/6257)。[#6281](https://github.com/ClickHouse/ClickHouse/pull/6281) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- 修复了从配置文件中的字符串 `true` 和 `false` 解析 `bool` 设置时的问题。[#6278](https://github.com/ClickHouse/ClickHouse/pull/6278) ([alesapin](https://github.com/alesapin))
- 修复了在对基于 `MergeTree` 表的 `Distributed` 表执行查询时，当 `WHERE` 的一部分被下推到 `PREWHERE` 时，可能出现的数据流头部不兼容的罕见错误。[#6236](https://github.com/ClickHouse/ClickHouse/pull/6236) ([alesapin](https://github.com/alesapin))
- 修复了有符号类型除以无符号类型时整数除法溢出的问题。此修复对应 [#6214](https://github.com/ClickHouse/ClickHouse/issues/6214)。[#6233](https://github.com/ClickHouse/ClickHouse/pull/6233) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### 向后不兼容的变更 {#backward-incompatible-change-5}

- `Kafka` 仍然不可用。

### ClickHouse Release 19.11.4.24, 2019-08-01 {#clickhouse-release-19-11-4-24-2019-08-01}

#### Bug 修复 {#bug-fix-20}



- 修复了在自适应粒度下写入二级索引标记时的 bug。[#6126](https://github.com/ClickHouse/ClickHouse/pull/6126) ([alesapin](https://github.com/alesapin))
- 修复了在两级聚合下 `GROUP BY` 的 `WITH ROLLUP` 和 `WITH CUBE` 修饰符的问题。[#6225](https://github.com/ClickHouse/ClickHouse/pull/6225) ([Anton Popov](https://github.com/CurtizJ))
- 修复了 `JSONExtractRaw` 函数中的挂起问题。修复了 [#6195](https://github.com/ClickHouse/ClickHouse/issues/6195) [#6198](https://github.com/ClickHouse/ClickHouse/pull/6198) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了 ExternalLoader::reloadOutdated() 中的段错误。[#6082](https://github.com/ClickHouse/ClickHouse/pull/6082) ([Vitaly Baranov](https://github.com/vitlibar))
- 修复了服务器可能关闭监听套接字但自身不关闭、并继续处理剩余查询的情况。最终可能会出现两个正在运行的 clickhouse-server 进程。有时，服务器可能会对剩余查询返回 `bad_function_call` 错误。[#6231](https://github.com/ClickHouse/ClickHouse/pull/6231) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了通过 ODBC、MySQL、ClickHouse 和 HTTP 初始加载外部字典时，对更新字段进行无用且不正确条件判断的问题。此更改修复了 [#6069](https://github.com/ClickHouse/ClickHouse/issues/6069) [#6083](https://github.com/ClickHouse/ClickHouse/pull/6083) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了在将 `LowCardinality(Nullable)` 转换为非 Nullable 列、且该列不包含 Null 的情况下（例如在类似 `SELECT CAST(CAST('Hello' AS LowCardinality(Nullable(String))) AS String)` 的查询中）抛出的无关异常。[#6094](https://github.com/ClickHouse/ClickHouse/issues/6094) [#6119](https://github.com/ClickHouse/ClickHouse/pull/6119) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- 修复了在极其罕见情况下 "uniq" 聚合函数结果非确定性的问题。该 bug 存在于所有 ClickHouse 版本中。[#6058](https://github.com/ClickHouse/ClickHouse/pull/6058) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了在对函数 `IPv6CIDRToRange` 设置略高的 CIDR 时产生的段错误。[#6068](https://github.com/ClickHouse/ClickHouse/pull/6068) ([Guillaume Tassery](https://github.com/YiuRULE))
- 修复了当服务器在许多不同上下文中抛出大量异常时发生的小内存泄漏。[#6144](https://github.com/ClickHouse/ClickHouse/pull/6144) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了 consumer 在订阅之前被暂停且之后未恢复的情况。[#6075](https://github.com/ClickHouse/ClickHouse/pull/6075) ([Ivan](https://github.com/abyss7)) 请注意，Kafka 在该版本中是不可用的。
- 清理了上一次以错误结束的读取操作留下的 Kafka 数据缓冲区。[#6026](https://github.com/ClickHouse/ClickHouse/pull/6026) ([Nikolay](https://github.com/bopohaa)) 请注意，Kafka 在该版本中是不可用的。
- 由于 `StorageMergeTree::background_task_handle` 在 `startup()` 中初始化，`MergeTreeBlockOutputStream::write()` 可能会在其初始化之前尝试使用它。因此仅在使用前检查它是否已初始化。[#6080](https://github.com/ClickHouse/ClickHouse/pull/6080) ([Ivan](https://github.com/abyss7))

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-6}



- 添加了官方的 `rpm` 软件包。[#5740](https://github.com/ClickHouse/ClickHouse/pull/5740) ([proller](https://github.com/proller)) ([alesapin](https://github.com/alesapin))
- 新增支持使用 `packager` 脚本构建 `.rpm` 和 `.tgz` 软件包。[#5769](https://github.com/ClickHouse/ClickHouse/pull/5769) ([alesapin](https://github.com/alesapin))
- 修复了与 "Arcadia" 构建系统相关的问题。[#6223](https://github.com/ClickHouse/ClickHouse/pull/6223) ([proller](https://github.com/proller))

#### 不向后兼容的变更 {#backward-incompatible-change-6}

- 本版本中 `Kafka` 不可用。

### ClickHouse Release 19.11.3.11, 2019-07-18 {#clickhouse-release-19-11-3-11-2019-07-18}

#### 新特性 {#new-feature-6}

- 增加了对预处理语句（prepared statements）的支持。[#5331](https://github.com/ClickHouse/ClickHouse/pull/5331/) ([Alexander](https://github.com/sanych73)) [#5630](https://github.com/ClickHouse/ClickHouse/pull/5630) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 新增 `DoubleDelta` 和 `Gorilla` 列编解码器。[#5600](https://github.com/ClickHouse/ClickHouse/pull/5600) ([Vasily Nemkov](https://github.com/Enmk))
- 新增 `os_thread_priority` 设置项，用于控制查询处理线程的 "nice" 值，操作系统会根据该值调整动态调度优先级。要正常工作需要 `CAP_SYS_NICE` 权限。实现了 [#5858](https://github.com/ClickHouse/ClickHouse/issues/5858) [#5909](https://github.com/ClickHouse/ClickHouse/pull/5909) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 为 Kafka 引擎实现 `_topic`、`_offset`、`_key` 列。[#5382](https://github.com/ClickHouse/ClickHouse/pull/5382) ([Ivan](https://github.com/abyss7)) 请注意，本版本中 Kafka 不可用。
- 新增聚合函数组合子 `-Resample`。[#5590](https://github.com/ClickHouse/ClickHouse/pull/5590) ([hcz](https://github.com/hczhcz))
- 新增聚合函数 `groupArrayMovingSum(win_size)(x)` 和 `groupArrayMovingAvg(win_size)(x)`，用于计算带或不带窗口大小限制的滑动求和/平均值。[#5595](https://github.com/ClickHouse/ClickHouse/pull/5595) ([inv2004](https://github.com/inv2004))
- 新增同义函数 `arrayFlatten` \<-\> `flatten`。[#5764](https://github.com/ClickHouse/ClickHouse/pull/5764) ([hcz](https://github.com/hczhcz))
- 集成了来自 Uber 的 H3 函数 `geoToH3`。[#4724](https://github.com/ClickHouse/ClickHouse/pull/4724) ([Remen Ivan](https://github.com/BHYCHIK)) [#5805](https://github.com/ClickHouse/ClickHouse/pull/5805) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### Bug 修复 {#bug-fix-21}



* 实现异步更新的 DNS 缓存机制。独立线程会定期解析所有主机并更新 DNS 缓存（周期由设置 `dns_cache_update_period` 控制）。当主机 IP 频繁变更时，这将很有帮助。 [#5857](https://github.com/ClickHouse/ClickHouse/pull/5857) ([Anton Popov](https://github.com/CurtizJ))
* 修复 `Delta` 编解码器中的段错误，该错误会影响包含小于 32 位值的列。此缺陷会导致内存随机损坏。[#5786](https://github.com/ClickHouse/ClickHouse/pull/5786) ([alesapin](https://github.com/alesapin))
* 修复在对包含非物理列的块执行 TTL 合并时发生的段错误。 [#5819](https://github.com/ClickHouse/ClickHouse/pull/5819) ([Anton Popov](https://github.com/CurtizJ))
* 修复在检查包含 `LowCardinality` 列的数据分片时的一个罕见错误。此前，对于包含 `LowCardinality` 列的数据分片，`checkDataPart` 总是会失败。[#5832](https://github.com/ClickHouse/ClickHouse/pull/5832) ([alesapin](https://github.com/alesapin))
* 当服务器线程池已满时，避免连接被挂起。对于来自 `remote` 表函数的连接，或在连接超时时间较长且目标分片没有副本的情况下发起的连接，这一点尤为重要。此更改修复了 [#5878](https://github.com/ClickHouse/ClickHouse/issues/5878) [#5881](https://github.com/ClickHouse/ClickHouse/pull/5881)（[alexey-milovidov](https://github.com/alexey-milovidov)）
* 为 `evalMLModel` 函数增加对常量参数的支持。修复了 [#5817](https://github.com/ClickHouse/ClickHouse/issues/5817) 和 [#5820](https://github.com/ClickHouse/ClickHouse/pull/5820)（[alexey-milovidov](https://github.com/alexey-milovidov)）
* 修复了 ClickHouse 将默认时区识别为 `UCT` 而不是 `UTC` 的问题。此修复解决了 [#5804](https://github.com/ClickHouse/ClickHouse/issues/5804)。[#5828](https://github.com/ClickHouse/ClickHouse/pull/5828)（[alexey-milovidov](https://github.com/alexey-milovidov)）
* 修复了 `visitParamExtractRaw` 中的缓冲区下溢问题。此更改修复了 [#5901](https://github.com/ClickHouse/ClickHouse/issues/5901) 和 [#5902](https://github.com/ClickHouse/ClickHouse/pull/5902)（[alexey-milovidov](https://github.com/alexey-milovidov)）
* 现在，分布式的 `DROP/ALTER/TRUNCATE/OPTIMIZE ON CLUSTER` 查询将直接在主副本上执行。 [#5757](https://github.com/ClickHouse/ClickHouse/pull/5757) ([alesapin](https://github.com/alesapin))
* 修复 `coalesce` 在 `ColumnConst` 与 `ColumnNullable` 组合下的问题及相关更改。 [#5755](https://github.com/ClickHouse/ClickHouse/pull/5755) ([Artem Zuikov](https://github.com/4ertus2))
* 修复 `ReadBufferFromKafkaConsumer`，使其在调用 `commit()` 之后能够继续读取新消息，即使此前曾发生阻塞 [#5852](https://github.com/ClickHouse/ClickHouse/pull/5852) ([Ivan](https://github.com/abyss7))
* 在右表使用 `Nullable` 键进行关联时，修复 `FULL` 和 `RIGHT` JOIN 的结果。[#5859](https://github.com/ClickHouse/ClickHouse/pull/5859) ([Artem Zuikov](https://github.com/4ertus2))
* 可能修复了低优先级查询无限期休眠的问题。 [#5842](https://github.com/ClickHouse/ClickHouse/pull/5842) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复竞态条件，该问题会导致在执行 `SYSTEM FLUSH LOGS` 查询后，一些查询可能不会出现在 query&#95;log 中。[#5456](https://github.com/ClickHouse/ClickHouse/issues/5456) [#5685](https://github.com/ClickHouse/ClickHouse/pull/5685) ([Anton Popov](https://github.com/CurtizJ))
* 修复了 ClusterCopier 中的 `heap-use-after-free` ASan 警告，该警告是由于 watch 尝试使用已移除的 copier 对象而触发的。 [#5871](https://github.com/ClickHouse/ClickHouse/pull/5871) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* 修复了一些 `IColumn::deserializeAndInsertFromArena` 实现返回错误的 `StringRef` 指针的问题。此缺陷仅影响单元测试。[#5973](https://github.com/ClickHouse/ClickHouse/pull/5973) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* 避免源列和中间 ARRAY JOIN 列覆盖同名列。 [#5941](https://github.com/ClickHouse/ClickHouse/pull/5941) ([Artem Zuikov](https://github.com/4ertus2))
* 修复向 MySQL 引擎执行 INSERT 和 SELECT 查询时对 MySQL 风格标识符引用的处理。 [#5704](https://github.com/ClickHouse/ClickHouse/pull/5704) ([Winter Zhang](https://github.com/zhang2014))
* 现在 `CHECK TABLE` 查询可以用于 MergeTree 引擎系列。它会为每个数据部分（对于更简单的引擎则为每个文件）返回检查状态以及（如果有的话）消息。同时修复了在拉取损坏数据部分时的一个错误。[#5865](https://github.com/ClickHouse/ClickHouse/pull/5865) ([alesapin](https://github.com/alesapin))
* 修复 SPLIT&#95;SHARED&#95;LIBRARIES 运行时错误 [#5793](https://github.com/ClickHouse/ClickHouse/pull/5793) ([Danila Kutenin](https://github.com/danlark1))
* 修复了在 `/etc/localtime` 为类似 `../usr/share/zoneinfo/Asia/Istanbul` 的相对符号链接时的时区初始化问题 [#5922](https://github.com/ClickHouse/ClickHouse/pull/5922) ([alexey-milovidov](https://github.com/alexey-milovidov))
* clickhouse-copier：修复关闭时的 use-after-free 问题 [#5752](https://github.com/ClickHouse/ClickHouse/pull/5752) ([proller](https://github.com/proller))
* 已更新 `simdjson`。修复了某些包含零字节的无效 JSON 仍被成功解析的问题。[#5938](https://github.com/ClickHouse/ClickHouse/pull/5938) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复 SystemLogs 的关闭逻辑 [#5802](https://github.com/ClickHouse/ClickHouse/pull/5802) ([Anton Popov](https://github.com/CurtizJ))
* 修复当 `invalidate_query` 中的条件依赖于字典时导致的挂起问题。[#6011](https://github.com/ClickHouse/ClickHouse/pull/6011) ([Vitaly Baranov](https://github.com/vitlibar))



#### 改进 {#improvement-6}



* 允许在集群配置中使用无法解析的地址。它们将被视为不可用，并在每次连接尝试时重新解析。这对 Kubernetes 尤其有用。此更改修复了 [#5714](https://github.com/ClickHouse/ClickHouse/issues/5714) [#5924](https://github.com/ClickHouse/ClickHouse/pull/5924)（[alexey-milovidov](https://github.com/alexey-milovidov)）
* 关闭空闲的 TCP 连接（默认超时时间为一小时）。这对大型集群尤为重要，尤其是在每台服务器上都有多张分布式表的情况下，因为每台服务器都可能对其他每台服务器维护一个连接池，在峰值查询并发结束后，这些连接会长时间处于空闲状态。此更改修复了 [#5879](https://github.com/ClickHouse/ClickHouse/issues/5879) [#5880](https://github.com/ClickHouse/ClickHouse/pull/5880)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 提升了 `topK` 函数的结果质量。更改了 SavingSpace 集合的行为：当新元素的权重大于最后一个元素时，将移除最后一个元素。 [#5833](https://github.com/ClickHouse/ClickHouse/issues/5833) [#5850](https://github.com/ClickHouse/ClickHouse/pull/5850) ([Guillaume Tassery](https://github.com/YiuRULE))
* 用于处理域名的 URL 函数现在也可以处理缺少 scheme 的不完整 URL [#5725](https://github.com/ClickHouse/ClickHouse/pull/5725) ([alesapin](https://github.com/alesapin))
* 已向 `system.parts_columns` 表添加校验和。 [#5874](https://github.com/ClickHouse/ClickHouse/pull/5874) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
* 添加了 `Enum` 数据类型，作为 `Enum8` 或 `Enum16` 的别名。 [#5886](https://github.com/ClickHouse/ClickHouse/pull/5886) ([dimarub2000](https://github.com/dimarub2000))
* 针对 `T64` 编解码器的完全比特转置版本。与 `zstd` 搭配使用时可以获得更好的压缩效果。[#5742](https://github.com/ClickHouse/ClickHouse/pull/5742) ([Artem Zuikov](https://github.com/4ertus2))
* 现在 `startsWith` 函数中的条件可以使用主键。这修复了 [#5310](https://github.com/ClickHouse/ClickHouse/issues/5310)、[#5882](https://github.com/ClickHouse/ClickHouse/issues/5882) 和 [#5919](https://github.com/ClickHouse/ClickHouse/pull/5919)（[dimarub2000](https://github.com/dimarub2000)）。
* 通过允许数据库名为空，使 `clickhouse-copier` 可用于跨复制集群拓扑。 [#5745](https://github.com/ClickHouse/ClickHouse/pull/5745) ([nvartolomei](https://github.com/nvartolomei))
* 在未安装 `tzdata` 的系统上（例如纯 Docker 容器）使用 `UTC` 作为默认时区。在此补丁之前，会打印错误信息 `Could not determine local time zone`，并且服务器或客户端会拒绝启动。 [#5827](https://github.com/ClickHouse/ClickHouse/pull/5827) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 为向后兼容，恢复了函数 `quantileTiming` 对浮点参数的支持。 [#5911](https://github.com/ClickHouse/ClickHouse/pull/5911) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 在错误信息中显示缺少列的是哪个表。[#5768](https://github.com/ClickHouse/ClickHouse/pull/5768) ([Ivan](https://github.com/abyss7))
* 禁止不同用户使用相同 query&#95;id 运行查询 [#5430](https://github.com/ClickHouse/ClickHouse/pull/5430) ([proller](https://github.com/proller))
* 用于向 Graphite 发送指标的代码更加健壮。即使在长时间执行多次 `RENAME TABLE` 操作期间，它也能正常工作。[#5875](https://github.com/ClickHouse/ClickHouse/pull/5875) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 当 ThreadPool 无法调度任务执行时，将显示更详细的错误信息。此更改修复了 [#5305](https://github.com/ClickHouse/ClickHouse/issues/5305) [#5801](https://github.com/ClickHouse/ClickHouse/pull/5801)（[alexey-milovidov](https://github.com/alexey-milovidov)）
* 反转 ngramSearch 以使其更直观 [#5807](https://github.com/ClickHouse/ClickHouse/pull/5807) ([Danila Kutenin](https://github.com/danlark1))
* 在 HDFS 引擎构建器中添加用户解析功能 [#5946](https://github.com/ClickHouse/ClickHouse/pull/5946) ([akonyaev90](https://github.com/akonyaev90))
* 更新 `max_ast_elements` 参数的默认值 [#5933](https://github.com/ClickHouse/ClickHouse/pull/5933) ([Artem Konovalov](https://github.com/izebit))
* 新增了“已弃用设置”的概念。已弃用设置 `allow_experimental_low_cardinality_type` 仍可使用，但不会产生任何效果。[0f15c01c6802f7ce1a1494c12c846be8c98944cd](https://github.com/ClickHouse/ClickHouse/commit/0f15c01c6802f7ce1a1494c12c846be8c98944cd) [Alexey Milovidov](https://github.com/alexey-milovidov)



#### 性能改进 {#performance-improvement-4}

- 增加用于从 Merge 表执行 SELECT 的流数量，以实现线程更均匀的分布。新增设置 `max_streams_multiplier_for_merge_tables`。修复了 [#5797](https://github.com/ClickHouse/ClickHouse/issues/5797) [#5915](https://github.com/ClickHouse/ClickHouse/pull/5915) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-7}



* 为不同 ClickHouse 版本间的客户端-服务器交互添加向后兼容性测试。 [#5868](https://github.com/ClickHouse/ClickHouse/pull/5868) ([alesapin](https://github.com/alesapin))
* 在每次提交和拉取请求中提供测试覆盖率信息。[#5896](https://github.com/ClickHouse/ClickHouse/pull/5896) ([alesapin](https://github.com/alesapin))
* 与 AddressSanitizer 配合使用，以支持我们的自定义分配器（`Arena` 和 `ArenaWithFreeLists`），从而更好地调试“释放后使用”（use-after-free）错误。[#5728](https://github.com/ClickHouse/ClickHouse/pull/5728) ([akuzm](https://github.com/akuzm))
* 切换为使用 [LLVM libunwind 实现](https://github.com/llvm-mirror/libunwind)，用于 C++ 异常处理以及打印栈回溯信息 [#4828](https://github.com/ClickHouse/ClickHouse/pull/4828)（[Nikita Lapkov](https://github.com/laplab)）
* 从 `-Weverything` 再添加两个警告 [#5923](https://github.com/ClickHouse/ClickHouse/pull/5923) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 支持使用 Memory Sanitizer 构建 ClickHouse。 [#3949](https://github.com/ClickHouse/ClickHouse/pull/3949) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了 fuzz 测试中针对 `bitTest` 函数的 UBSan 报告。[#5943](https://github.com/ClickHouse/ClickHouse/pull/5943) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Docker：新增可初始化需要认证的 ClickHouse 实例的功能。[#5727](https://github.com/ClickHouse/ClickHouse/pull/5727) ([Korviakov Andrey](https://github.com/shurshun))
* 将 librdkafka 更新至 1.1.0 版本 [#5872](https://github.com/ClickHouse/ClickHouse/pull/5872) ([Ivan](https://github.com/abyss7))
* 为集成测试添加全局超时，并在测试代码中禁用部分测试用例。 [#5741](https://github.com/ClickHouse/ClickHouse/pull/5741) ([alesapin](https://github.com/alesapin))
* 修复了一些 ThreadSanitizer 报错。 [#5854](https://github.com/ClickHouse/ClickHouse/pull/5854) ([akuzm](https://github.com/akuzm))
* `--no-undefined` 选项会强制链接器在链接时检查所有外部符号是否存在。在拆分构建模式下，对于追踪库之间的实际依赖关系非常有用。[#5855](https://github.com/ClickHouse/ClickHouse/pull/5855) ([Ivan](https://github.com/abyss7))
* 针对 [#5797](https://github.com/ClickHouse/ClickHouse/issues/5797) 和 [#5914](https://github.com/ClickHouse/ClickHouse/pull/5914) 添加了性能测试（[alexey-milovidov](https://github.com/alexey-milovidov)）
* 修复了与 gcc-7 的兼容性。[#5840](https://github.com/ClickHouse/ClickHouse/pull/5840) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 新增对 gcc-9 的支持，从而修复了 [#5717](https://github.com/ClickHouse/ClickHouse/issues/5717) [#5774](https://github.com/ClickHouse/ClickHouse/pull/5774) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了由于 `libunwind` 可能被错误链接而导致的错误。[#5948](https://github.com/ClickHouse/ClickHouse/pull/5948) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了一些由 PVS-Studio 检测到的警告。[#5921](https://github.com/ClickHouse/ClickHouse/pull/5921)（[alexey-milovidov](https://github.com/alexey-milovidov)）
* 添加了对 `clang-tidy` 静态分析器的初步支持。 [#5806](https://github.com/ClickHouse/ClickHouse/pull/5806) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 将 BSD/Linux 的字节序宏（&#39;be64toh&#39; 和 &#39;htobe64&#39;）替换为 Mac OS X 中的等价宏 [#5785](https://github.com/ClickHouse/ClickHouse/pull/5785) ([Fu Chen](https://github.com/fredchenbj))
* 改进了集成测试指南。[#5796](https://github.com/ClickHouse/ClickHouse/pull/5796) ([Vladimir Chebotarev](https://github.com/excitoon))
* 修复在 macOS + gcc9 环境下的构建 [#5822](https://github.com/ClickHouse/ClickHouse/pull/5822) ([filimonov](https://github.com/filimonov))
* 修复一个不易发现的拼写错误：aggreAGte -&gt; aggregate。[#5753](https://github.com/ClickHouse/ClickHouse/pull/5753) ([akuzm](https://github.com/akuzm))
* 修复 FreeBSD 下的构建 [#5760](https://github.com/ClickHouse/ClickHouse/pull/5760) ([proller](https://github.com/proller))
* 在网站中添加指向实验性 YouTube 频道的链接 [#5845](https://github.com/ClickHouse/ClickHouse/pull/5845) ([Ivan Blinkov](https://github.com/blinkov))
* CMake：为覆盖率标志添加选项：WITH&#95;COVERAGE [#5776](https://github.com/ClickHouse/ClickHouse/pull/5776) ([proller](https://github.com/proller))
* 修复某些内联 PODArray 的初始大小。 [#5787](https://github.com/ClickHouse/ClickHouse/pull/5787) ([akuzm](https://github.com/akuzm))
* clickhouse-server.postinst：修复在 CentOS 6 上的操作系统检测 [#5788](https://github.com/ClickHouse/ClickHouse/pull/5788) ([proller](https://github.com/proller))
* 增加了对 Arch Linux 软件包构建的支持。[#5719](https://github.com/ClickHouse/ClickHouse/pull/5719) ([Vladimir Chebotarev](https://github.com/excitoon))
* 按库（dbms）对 Common/config.h 进行拆分 [#5715](https://github.com/ClickHouse/ClickHouse/pull/5715) ([proller](https://github.com/proller))
* 针对 &quot;Arcadia&quot; 构建平台的修复 [#5795](https://github.com/ClickHouse/ClickHouse/pull/5795) ([proller](https://github.com/proller))
* 非常规构建（gcc9、无子模块）相关修复 [#5792](https://github.com/ClickHouse/ClickHouse/pull/5792) ([proller](https://github.com/proller))
* 在 `unalignedStore` 中要求显式指定类型，因为此前已证明这种方式容易出错 [#5791](https://github.com/ClickHouse/ClickHouse/pull/5791) ([akuzm](https://github.com/akuzm))
* 修复 macOS 平台上的构建问题 [#5830](https://github.com/ClickHouse/ClickHouse/pull/5830) ([filimonov](https://github.com/filimonov))
* 根据此处的请求，对新 JIT 功能在更大数据集上的性能进行测试 [#5263](https://github.com/ClickHouse/ClickHouse/issues/5263) [#5887](https://github.com/ClickHouse/ClickHouse/pull/5887)（[Guillaume Tassery](https://github.com/YiuRULE)）
* 在压力测试中运行有状态测试 [12693e568722f11e19859742f56428455501fd2a](https://github.com/ClickHouse/ClickHouse/commit/12693e568722f11e19859742f56428455501fd2a) ([alesapin](https://github.com/alesapin))



#### 向后不兼容的变更 {#backward-incompatible-change-7}

- 此版本中的 `Kafka` 表引擎不可用。
- 对新的 `MergeTree` 表默认启用 `adaptive_index_granularity` = 10MB。如果你在 19.11+ 版本上创建了新的 MergeTree 表，则无法降级到 19.6 之前的版本。 [#5628](https://github.com/ClickHouse/ClickHouse/pull/5628) ([alesapin](https://github.com/alesapin))
- 移除了供 Yandex.Metrica 使用的、已过时且未公开文档的内置字典。函数 `OSIn`、`SEIn`、`OSToRoot`、`SEToRoot`、`OSHierarchy`、`SEHierarchy` 将不再可用。如果你在使用这些函数，请发送邮件至 clickhouse-feedback@yandex-team.com。注意：在最后一刻我们决定暂时保留这些函数。 [#5780](https://github.com/ClickHouse/ClickHouse/pull/5780) ([alexey-milovidov](https://github.com/alexey-milovidov))



## ClickHouse 版本 19.10 {#clickhouse-release-19-10}

### ClickHouse 版本 19.10.1.5，2019-07-12 {#clickhouse-release-19-10-1-5-2019-07-12}

#### 新特性 {#new-feature-7}

- 新增列编解码器：`T64`。适用于 (U)IntX/EnumX/Data(Time)/DecimalX 列。对于取值恒定或取值范围很小的列效果较好。该编解码器本身允许在无需重新压缩的情况下扩大或缩小数据类型。[#5557](https://github.com/ClickHouse/ClickHouse/pull/5557) ([Artem Zuikov](https://github.com/4ertus2))
- 新增数据库引擎 `MySQL`，允许查看远程 MySQL 服务器中的所有表。[#5599](https://github.com/ClickHouse/ClickHouse/pull/5599) ([Winter Zhang](https://github.com/zhang2014))
- 实现 `bitmapContains`。当第二个 bitmap 只包含一个元素时，其速度是 `bitmapHasAny` 的两倍。[#5535](https://github.com/ClickHouse/ClickHouse/pull/5535) ([Zhichang Yu](https://github.com/yuzhichang))
- 支持 `crc32` 函数（其行为与 MySQL 或 PHP 中完全一致）。如果你需要的是哈希函数，请不要使用它。[#5661](https://github.com/ClickHouse/ClickHouse/pull/5661) ([Remen Ivan](https://github.com/BHYCHIK))
- 实现了 `SYSTEM START/STOP DISTRIBUTED SENDS` 查询，用于控制对 `Distributed` 表的异步插入。[#4935](https://github.com/ClickHouse/ClickHouse/pull/4935) ([Winter Zhang](https://github.com/zhang2014))

#### Bug 修复 {#bug-fix-22}

- 在执行 mutation 时，忽略查询执行限制以及用于合并操作的最大 part 大小限制。[#5659](https://github.com/ClickHouse/ClickHouse/pull/5659) ([Anton Popov](https://github.com/CurtizJ))
- 修复可能导致正常数据块被去重（极其罕见）以及插入重复数据块（较常见）的 bug。[#5549](https://github.com/ClickHouse/ClickHouse/pull/5549) ([alesapin](https://github.com/alesapin))
- 修复函数 `arrayEnumerateUniqRanked` 在参数为空数组时的行为问题。[#5559](https://github.com/ClickHouse/ClickHouse/pull/5559) ([proller](https://github.com/proller))
- 如果没有拉取任何消息的意图，则不要订阅 Kafka 主题。[#5698](https://github.com/ClickHouse/ClickHouse/pull/5698) ([Ivan](https://github.com/abyss7))
- 让设置项 `join_use_nulls` 对不能出现在 Nullable 中的类型不产生任何效果。[#5700](https://github.com/ClickHouse/ClickHouse/pull/5700) ([Olga Khvostikova](https://github.com/stavrolia))
- 修复 `Incorrect size of index granularity` 错误。[#5720](https://github.com/ClickHouse/ClickHouse/pull/5720) ([coraxster](https://github.com/coraxster))
- 修复 Float 转 Decimal 时的溢出问题。[#5607](https://github.com/ClickHouse/ClickHouse/pull/5607) ([coraxster](https://github.com/coraxster))
- 在调用 `WriteBufferFromHDFS` 析构函数时刷新缓冲区，从而修复向 `HDFS` 写入的问题。[#5684](https://github.com/ClickHouse/ClickHouse/pull/5684) ([Xindong Peng](https://github.com/eejoin))

#### 改进 {#improvement-7}



- 启用 `input_format_defaults_for_omitted_fields` 设置后，将 `CSV` 中的空单元格视为默认值。[#5625](https://github.com/ClickHouse/ClickHouse/pull/5625) ([akuzm](https://github.com/akuzm))
- 对外部字典进行非阻塞加载。[#5567](https://github.com/ClickHouse/ClickHouse/pull/5567) ([Vitaly Baranov](https://github.com/vitlibar))
- 已建立连接的网络超时时间可以根据设置动态更改。[#4558](https://github.com/ClickHouse/ClickHouse/pull/4558) ([Konstantin Podshumok](https://github.com/podshumok))
- 在函数 `firstSignificantSubdomain`、`cutToFirstSignificantSubdomain` 中使用 "public_suffix_list"。它使用由 `gperf` 生成的完美哈希表，该哈希表基于以下文件生成的列表：https://publicsuffix.org/list/public_suffix_list.dat。（例如，现在我们能将域名后缀 `ac.uk` 识别为非重要部分。）[#5030](https://github.com/ClickHouse/ClickHouse/pull/5030) ([Guillaume Tassery](https://github.com/YiuRULE))
- 在 system 表中采用 `IPv6` 数据类型；统一了 `system.processes` 和 `system.query_log` 中的客户端信息列。[#5640](https://github.com/ClickHouse/ClickHouse/pull/5640) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 对使用 MySQL 兼容协议的连接启用会话机制。#5476 [#5646](https://github.com/ClickHouse/ClickHouse/pull/5646) ([Yuriy Baranov](https://github.com/yurriy))
- 支持在集群上执行更多 `ALTER` 查询（`ON CLUSTER`）。[#5593](https://github.com/ClickHouse/ClickHouse/pull/5593) [#5613](https://github.com/ClickHouse/ClickHouse/pull/5613) ([sundyli](https://github.com/sundy-li))
- 在 `clickhouse-local` 配置文件中支持 `<logger>` 部分。[#5540](https://github.com/ClickHouse/ClickHouse/pull/5540) ([proller](https://github.com/proller))
- 允许在 `clickhouse-local` 中使用 `remote` 表函数运行查询。[#5627](https://github.com/ClickHouse/ClickHouse/pull/5627) ([proller](https://github.com/proller))

#### 性能改进 {#performance-improvement-5}

- 新增在 MergeTree 列末尾写入最终标记的功能。这可以避免对超出表数据范围的键进行无用读取。仅在使用自适应索引粒度时启用。[#5624](https://github.com/ClickHouse/ClickHouse/pull/5624) ([alesapin](https://github.com/alesapin))
- 通过减少 `stat` 系统调用次数，提高了在非常慢的文件系统上 MergeTree 表的性能。[#5648](https://github.com/ClickHouse/ClickHouse/pull/5648) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了在 19.6 版本中引入的，从 MergeTree 表读取时的性能下降问题。修复 #5631。[#5633](https://github.com/ClickHouse/ClickHouse/pull/5633) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-8}



- 实现了一个用于测试的 ZooKeeper 接口实现 `TestKeeper` [#5643](https://github.com/ClickHouse/ClickHouse/pull/5643) ([alexey-milovidov](https://github.com/alexey-milovidov)) ([levushkin aleksej](https://github.com/alexey-milovidov))
- 从现在开始，`.sql` 测试可以按服务器隔离、并行运行，并使用随机数据库。这样可以更快地运行测试，添加具有自定义服务器配置的新测试，并确保不同测试之间不会互相影响。[#5554](https://github.com/ClickHouse/ClickHouse/pull/5554) ([Ivan](https://github.com/abyss7))
- 从性能测试中移除了 `<name>` 和 `<metrics>` [#5672](https://github.com/ClickHouse/ClickHouse/pull/5672) ([Olga Khvostikova](https://github.com/stavrolia))
- 修复了 `Pretty` 格式的 "select_format" 性能测试 [#5642](https://github.com/ClickHouse/ClickHouse/pull/5642) ([alexey-milovidov](https://github.com/alexey-milovidov))



## ClickHouse Release 19.9 {#clickhouse-release-19-9}

### ClickHouse Release 19.9.3.31, 2019-07-05 {#clickhouse-release-19-9-3-31-2019-07-05}

#### Bug Fix {#bug-fix-23}

- 修复 Delta 编解码器中的段错误，该错误会影响值长度小于 32 位的列。此缺陷会导致随机内存损坏。 [#5786](https://github.com/ClickHouse/ClickHouse/pull/5786) ([alesapin](https://github.com/alesapin))
- 修复在检查包含 LowCardinality 列的 part 时出现的罕见错误。 [#5832](https://github.com/ClickHouse/ClickHouse/pull/5832) ([alesapin](https://github.com/alesapin))
- 修复在对包含非物理列的 block 进行 TTL merge 时的段错误。 [#5819](https://github.com/ClickHouse/ClickHouse/pull/5819) ([Anton Popov](https://github.com/CurtizJ))
- 修复低优先级查询可能无限休眠的潜在问题。 [#5842](https://github.com/ClickHouse/ClickHouse/pull/5842) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复 ClickHouse 将默认时区判定为 UCT 而不是 UTC 的问题。 [#5828](https://github.com/ClickHouse/ClickHouse/pull/5828) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复一个 bug，该 bug 会导致在分布式执行 DROP/ALTER/TRUNCATE/OPTIMIZE ON CLUSTER 查询时，先在 follower 副本上而不是在 leader 副本上执行。现在这些查询将直接在 leader 副本上执行。 [#5757](https://github.com/ClickHouse/ClickHouse/pull/5757) ([alesapin](https://github.com/alesapin))
- 修复一个竞争条件，该问题会导致在执行 SYSTEM FLUSH LOGS 查询后，一些查询不会立即出现在 `query_log` 中。 [#5685](https://github.com/ClickHouse/ClickHouse/pull/5685) ([Anton Popov](https://github.com/CurtizJ))
- 为 `evalMLModel` 函数补充对常量参数的支持。 [#5820](https://github.com/ClickHouse/ClickHouse/pull/5820) ([alexey-milovidov](https://github.com/alexey-milovidov))

### ClickHouse Release 19.9.2.4, 2019-06-24 {#clickhouse-release-19-9-2-4-2019-06-24}

#### New Feature {#new-feature-8}

- 在 `system.parts` 表中显示关于 frozen parts 的信息。 [#5471](https://github.com/ClickHouse/ClickHouse/pull/5471) ([proller](https://github.com/proller))
- 如果未在参数中设置密码，则在 TTY 上启动 `clickhouse-client` 时向客户端询问密码。 [#5092](https://github.com/ClickHouse/ClickHouse/pull/5092) ([proller](https://github.com/proller))
- 为 Decimal 类型实现 `dictGet` 和 `dictGetOrDefault` 函数。 [#5394](https://github.com/ClickHouse/ClickHouse/pull/5394) ([Artem Zuikov](https://github.com/4ertus2))

#### Improvement {#improvement-8}

- Debian init：添加服务停止超时时间。 [#5522](https://github.com/ClickHouse/ClickHouse/pull/5522) ([proller](https://github.com/proller))
- 添加一个默认禁用的设置，用于创建带有可疑 LowCardinality 类型的表。 [#5448](https://github.com/ClickHouse/ClickHouse/pull/5448) ([Olga Khvostikova](https://github.com/stavrolia))
- 当在 `evalMLMethod` 函数中不以 State 形式使用时，回归函数会返回模型权重。 [#5411](https://github.com/ClickHouse/ClickHouse/pull/5411) ([Quid37](https://github.com/Quid37))
- 重命名并改进回归方法。 [#5492](https://github.com/ClickHouse/ClickHouse/pull/5492) ([Quid37](https://github.com/Quid37))
- 使字符串搜索器的接口更清晰。 [#5586](https://github.com/ClickHouse/ClickHouse/pull/5586) ([Danila Kutenin](https://github.com/danlark1))

#### Bug Fix {#bug-fix-24}



* 修复 Kafka 中潜在的数据丢失 [#5445](https://github.com/ClickHouse/ClickHouse/pull/5445) ([Ivan](https://github.com/abyss7))
* 修复在以零列为参数调用时 `PrettySpace` 格式中可能出现的无限循环问题 [#5560](https://github.com/ClickHouse/ClickHouse/pull/5560) ([Olga Khvostikova](https://github.com/stavrolia))
* 修复了线性模型中 UInt32 溢出的问题。允许对非 const 模型参数调用 eval ML 模型。[#5516](https://github.com/ClickHouse/ClickHouse/pull/5516) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* 如果指定的索引不存在，`ALTER TABLE ... DROP INDEX IF EXISTS ...` 不应抛出异常 [#5524](https://github.com/ClickHouse/ClickHouse/pull/5524) ([Gleb Novikov](https://github.com/NanoBjorn))
* 修复在标量子查询中使用 `bitmapHasAny` 时出现的段错误 [#5528](https://github.com/ClickHouse/ClickHouse/pull/5528) ([Zhichang Yu](https://github.com/yuzhichang))
* 修复了一个错误：在清空 DNS 缓存后，复制连接池不会重试解析主机。 [#5534](https://github.com/ClickHouse/ClickHouse/pull/5534) ([alesapin](https://github.com/alesapin))
* 修复了 ReplicatedMergeTree 上 `ALTER ... MODIFY TTL` 的问题。[#5539](https://github.com/ClickHouse/ClickHouse/pull/5539) ([Anton Popov](https://github.com/CurtizJ))
* 修复向带有 MATERIALIZED 列的 Distributed 表执行 INSERT 时的问题 [#5429](https://github.com/ClickHouse/ClickHouse/pull/5429) ([Azat Khuzhin](https://github.com/azat))
* 修复在截断 Join 存储时出现的 bad alloc 问题 [#5437](https://github.com/ClickHouse/ClickHouse/pull/5437) ([TCeason](https://github.com/TCeason))
* 在最近几个版本的 `tzdata` 软件包中，一些文件现在是符号链接。用于检测默认时区的现有机制因此被破坏，对某些时区会返回错误的名称。现在至少在提供 `TZ` 的情况下，我们会强制将时区名称设置为 `TZ` 的内容。[#5443](https://github.com/ClickHouse/ClickHouse/pull/5443)（[Ivan](https://github.com/abyss7)）
* 修复了在极少数情况下使用 MultiVolnitsky 搜索器时的问题：当常量 needle 的总长度至少为 16KB 时，算法会遗漏或覆盖之前的结果，从而可能导致 `multiSearchAny` 的结果不正确。[#5588](https://github.com/ClickHouse/ClickHouse/pull/5588) ([Danila Kutenin](https://github.com/danlark1))
* 修复了 ExternalData 请求的设置无法复用 ClickHouse 设置的问题。此外，目前由于名称存在歧义（在 external data 中可以被解释为表格式，而在查询中可以被解释为设置），`date_time_input_format` 和 `low_cardinality_allow_in_native_format` 这两个设置暂时无法使用。[#5455](https://github.com/ClickHouse/ClickHouse/pull/5455) ([Danila Kutenin](https://github.com/danlark1))
* 修复了仅从文件系统删除数据片段而未从 Zookeeper 中删除时会出现的 Bug。 [#5520](https://github.com/ClickHouse/ClickHouse/pull/5520) ([alesapin](https://github.com/alesapin))
* 从 MySQL 协议中移除调试日志 [#5478](https://github.com/ClickHouse/ClickHouse/pull/5478) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 在 DDL 查询处理过程中忽略 ZNONODE [#5489](https://github.com/ClickHouse/ClickHouse/pull/5489) ([Azat Khuzhin](https://github.com/azat))
* 修复在包含不同类型的 `UNION ALL` 中结果列的类型问题。在某些情况下，结果列的数据与列类型不一致。 [#5503](https://github.com/ClickHouse/ClickHouse/pull/5503) ([Artem Zuikov](https://github.com/4ertus2))
* 在 `dictGetT` 函数中遇到错误的整数时抛出异常，而不是直接崩溃。[#5446](https://github.com/ClickHouse/ClickHouse/pull/5446) ([Artem Zuikov](https://github.com/4ertus2))
* 修复 `system.dictionaries` 表中哈希字典的 `element_count` 和 `load_factor` 字段值错误。 [#5440](https://github.com/ClickHouse/ClickHouse/pull/5440) ([Azat Khuzhin](https://github.com/azat))



#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-9}

- 修复在未启用 `Brotli` HTTP 压缩支持（`ENABLE_BROTLI=OFF` cmake 变量）的情况下的构建问题。[#5521](https://github.com/ClickHouse/ClickHouse/pull/5521) ([Anton Yuzhaninov](https://github.com/citrin))
- 将 roaring.h 头文件以 roaring/roaring.h 的路径包含。[#5523](https://github.com/ClickHouse/ClickHouse/pull/5523) ([Orivej Desh](https://github.com/orivej))
- 修复 hyperscan 中的 gcc9 警告（#line 指令非常糟糕！）。[#5546](https://github.com/ClickHouse/ClickHouse/pull/5546) ([Danila Kutenin](https://github.com/danlark1))
- 修复使用 gcc-9 编译时的所有警告。修复部分 contrib 问题。修复 gcc9 ICE 并将其提交到 Bugzilla。[#5498](https://github.com/ClickHouse/ClickHouse/pull/5498) ([Danila Kutenin](https://github.com/danlark1))
- 修复使用 lld 链接时的问题。[#5477](https://github.com/ClickHouse/ClickHouse/pull/5477) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 移除字典中未使用的特化实现。[#5452](https://github.com/ClickHouse/ClickHouse/pull/5452) ([Artem Zuikov](https://github.com/4ertus2))
- 改进针对不同类型文件的表格格式化与解析的性能测试。[#5497](https://github.com/ClickHouse/ClickHouse/pull/5497) ([Olga Khvostikova](https://github.com/stavrolia))
- 修复并行测试运行相关的问题。[#5506](https://github.com/ClickHouse/ClickHouse/pull/5506) ([proller](https://github.com/proller))
- Docker：使用来自 clickhouse-test 的配置。[#5531](https://github.com/ClickHouse/ClickHouse/pull/5531) ([proller](https://github.com/proller))
- 修复在 FreeBSD 上的编译问题。[#5447](https://github.com/ClickHouse/ClickHouse/pull/5447) ([proller](https://github.com/proller))
- 将 boost 升级到 1.70。[#5570](https://github.com/ClickHouse/ClickHouse/pull/5570) ([proller](https://github.com/proller))
- 修复将 ClickHouse 作为子模块进行构建时的问题。[#5574](https://github.com/ClickHouse/ClickHouse/pull/5574) ([proller](https://github.com/proller))
- 改进 JSONExtract 的性能测试。[#5444](https://github.com/ClickHouse/ClickHouse/pull/5444) ([Vitaly Baranov](https://github.com/vitlibar))



## ClickHouse 19.8 发布 {#clickhouse-release-19-8}

### ClickHouse 19.8.3.8 发布，2019-06-11 {#clickhouse-release-19-8-3-8-2019-06-11}

#### 新功能 {#new-features}



* 增加了用于处理 JSON 的函数 [#4686](https://github.com/ClickHouse/ClickHouse/pull/4686) ([hcz](https://github.com/hczhcz)) [#5124](https://github.com/ClickHouse/ClickHouse/pull/5124). ([Vitaly Baranov](https://github.com/vitlibar))
* 添加一个名为 basename 的函数，其行为类似于许多语言中已存在的 basename 函数（例如 Python 中的 `os.path.basename`、PHP 中的 `basename` 等）。可同时处理类 UNIX 路径和 Windows 路径。[#5136](https://github.com/ClickHouse/ClickHouse/pull/5136) ([Guillaume Tassery](https://github.com/YiuRULE))
* 添加了 `LIMIT n, m BY` 或 `LIMIT m OFFSET n BY` 语法，用于在 LIMIT BY 子句中将偏移量设为 n。 [#5138](https://github.com/ClickHouse/ClickHouse/pull/5138) ([Anton Popov](https://github.com/CurtizJ))
* 新增了数据类型 `SimpleAggregateFunction`，可在 `AggregatingMergeTree` 中使用带有轻量级聚合的列。该类型只能与 `any`、`anyLast`、`sum`、`min`、`max` 等简单函数一起使用。 [#4629](https://github.com/ClickHouse/ClickHouse/pull/4629) ([Boris Granveaud](https://github.com/bgranvea))
* 为函数 `ngramDistance` 新增了对非常量参数的支持 [#5198](https://github.com/ClickHouse/ClickHouse/pull/5198) ([Danila Kutenin](https://github.com/danlark1))
* 新增函数 `skewPop`、`skewSamp`、`kurtPop` 和 `kurtSamp`，分别用于计算总体偏度、样本偏度、总体峰度和样本峰度。 [#5200](https://github.com/ClickHouse/ClickHouse/pull/5200) ([hcz](https://github.com/hczhcz))
* 为 `MaterializeView` 存储添加重命名操作支持。 [#5209](https://github.com/ClickHouse/ClickHouse/pull/5209) ([Guillaume Tassery](https://github.com/YiuRULE))
* 新增了服务器，支持使用 MySQL 客户端连接 ClickHouse。 [#4715](https://github.com/ClickHouse/ClickHouse/pull/4715) ([Yuriy Baranov](https://github.com/yurriy))
* 添加 `toDecimal*OrZero` 和 `toDecimal*OrNull` 函数。 [#5291](https://github.com/ClickHouse/ClickHouse/pull/5291) ([Artem Zuikov](https://github.com/4ertus2))
* 为函数 `quantile`、`quantiles`、`median`、`quantileExactWeighted`、`quantilesExactWeighted`、`medianExactWeighted` 增加对 Decimal 类型的支持。[#5304](https://github.com/ClickHouse/ClickHouse/pull/5304) ([Artem Zuikov](https://github.com/4ertus2))
* 添加了 `toValidUTF8` 函数，用于将所有无效的 UTF-8 字符替换为替换字符 �（U+FFFD）。 [#5322](https://github.com/ClickHouse/ClickHouse/pull/5322) ([Danila Kutenin](https://github.com/danlark1))
* 添加了 `format` 函数。使用常量格式模式（简化版 Python 格式模式）对参数中列出的字符串进行格式化。[#5330](https://github.com/ClickHouse/ClickHouse/pull/5330) ([Danila Kutenin](https://github.com/danlark1))
* 添加了 `system.detached_parts` 表，用于存储 `MergeTree` 表中已分离数据部件（detached parts）的信息。 [#5353](https://github.com/ClickHouse/ClickHouse/pull/5353) ([akuzm](https://github.com/akuzm))
* 新增 `ngramSearch` 函数，用于计算 needle 与 haystack 之间的非对称差异。[#5418](https://github.com/ClickHouse/ClickHouse/pull/5418)[#5422](https://github.com/ClickHouse/ClickHouse/pull/5422) ([Danila Kutenin](https://github.com/danlark1))
* 使用聚合函数接口实现了基础机器学习方法（随机线性回归和逻辑回归）。提供多种模型权重更新策略（简单梯度下降、动量法、Nesterov 方法）。同时支持自定义大小的小批量（mini-batch）。 [#4943](https://github.com/ClickHouse/ClickHouse/pull/4943) ([Quid37](https://github.com/Quid37))
* 实现 `geohashEncode` 和 `geohashDecode` 函数。[#5003](https://github.com/ClickHouse/ClickHouse/pull/5003)（[Vasily Nemkov](https://github.com/Enmk)）
* 新增聚合函数 `timeSeriesGroupSum`，可对采样时间戳未对齐的不同时间序列进行聚合。它会在相邻两个采样时间戳之间使用线性插值，然后将这些时间序列求和。新增聚合函数 `timeSeriesGroupRateSum`，用于计算时间序列的变化速率并对这些速率求和。 [#4542](https://github.com/ClickHouse/ClickHouse/pull/4542) ([Yangkuan Liu](https://github.com/LiuYangkuan))
* 新增了函数 `IPv4CIDRtoIPv4Range` 和 `IPv6CIDRtoIPv6Range`，用于根据 CIDR 计算子网中 IP 地址范围的起始和结束地址。 [#5095](https://github.com/ClickHouse/ClickHouse/pull/5095) ([Guillaume Tassery](https://github.com/YiuRULE))
* 在通过 HTTP 发送查询且启用 `send_progress_in_http_headers` 设置时，添加一个 X-ClickHouse-Summary 头部。返回与 X-ClickHouse-Progress 相同的常规信息，并额外包含本次查询插入的行数和字节数等信息。 [#5116](https://github.com/ClickHouse/ClickHouse/pull/5116) ([Guillaume Tassery](https://github.com/YiuRULE))



#### 改进 {#improvements}



* 为 MergeTree 系列表添加了 `max_parts_in_total` 设置（默认值：100 000），用于防止不安全地指定分区键 #5166。 [#5171](https://github.com/ClickHouse/ClickHouse/pull/5171) ([alexey-milovidov](https://github.com/alexey-milovidov))
* `clickhouse-obfuscator`：通过将初始种子与列名（而非列位置）组合，为每一列派生种子值。此功能用于转换包含多个关联表的数据集，以便在转换后这些表之间仍然可以进行 JOIN 操作。[#5178](https://github.com/ClickHouse/ClickHouse/pull/5178) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 新增函数 `JSONExtractRaw`、`JSONExtractKeyAndValues`。将函数 `jsonExtract<type>` 重命名为 `JSONExtract<type>`。在出错时，这些函数返回相应的值，而不是 `NULL`。修改了函数 `JSONExtract`，现在它从最后一个参数获取返回类型，并且不会引入 Nullable 类型。当 AVX2 指令不可用时，增加了回退到 RapidJSON 的机制。simdjson 库已更新到新版本。[#5235](https://github.com/ClickHouse/ClickHouse/pull/5235) ([Vitaly Baranov](https://github.com/vitlibar))
* 现在，`if` 和 `multiIf` 函数不再依赖条件的 `Nullable`，而是依赖各个分支来实现 SQL 兼容性。[#5238](https://github.com/ClickHouse/ClickHouse/pull/5238) ([Jian Wu](https://github.com/janplus))
* `In` 谓词现在会像 `Equal` 函数一样，对 `Null` 输入生成 `Null` 结果。[#5152](https://github.com/ClickHouse/ClickHouse/pull/5152) ([Jian Wu](https://github.com/janplus))
* 每当从 Kafka 读取了 (flush&#95;interval / poll&#95;timeout) 行数据时，就检查一次时间限制。这样可以更频繁地中断 Kafka 消费者的读取，并检查顶层数据流的时间限制 [#5249](https://github.com/ClickHouse/ClickHouse/pull/5249) ([Ivan](https://github.com/abyss7))
* 将 rdkafka 与内置的 SASL 链接起来，这样就可以使用 SASL SCRAM 认证 [#5253](https://github.com/ClickHouse/ClickHouse/pull/5253) ([Ivan](https://github.com/abyss7))
* RowRefList 的批处理版本，用于 ALL JOINS。 [#5267](https://github.com/ClickHouse/ClickHouse/pull/5267) ([Artem Zuikov](https://github.com/4ertus2))
* clickhouse-server：提供更详细的 listen 错误消息。[#5268](https://github.com/ClickHouse/ClickHouse/pull/5268) ([proller](https://github.com/proller))
* 在 clickhouse-copier 中为 `<sharding_key>` 所使用的函数增加字典支持 [#5270](https://github.com/ClickHouse/ClickHouse/pull/5270) ([proller](https://github.com/proller))
* 新增配置项 `kafka_commit_every_batch` 用于控制 Kafka 提交策略。
  它允许设置提交模式：在处理完每一批消息后提交，或在整个数据块写入存储后再提交。这是在某些极端情况下，在可能丢失部分消息与可能重复读取消息之间进行的权衡。 [#5308](https://github.com/ClickHouse/ClickHouse/pull/5308) ([Ivan](https://github.com/abyss7))
* 使 `windowFunnel` 支持更多无符号整数类型。 [#5320](https://github.com/ClickHouse/ClickHouse/pull/5320) ([sundyli](https://github.com/sundy-li))
* 允许在 Merge 引擎中隐藏虚拟列 `_table`。 [#5325](https://github.com/ClickHouse/ClickHouse/pull/5325) ([Ivan](https://github.com/abyss7))
* 使 `sequenceMatch` 聚合函数支持其他无符号整数类型 [#5339](https://github.com/ClickHouse/ClickHouse/pull/5339) ([sundyli](https://github.com/sundy-li))
* 当校验和不匹配且很可能由硬件故障导致时，提供更清晰的错误消息。[#5355](https://github.com/ClickHouse/ClickHouse/pull/5355) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 检查 `StorageMerge` 所依赖的底层表是否支持采样 [#5366](https://github.com/ClickHouse/ClickHouse/pull/5366) ([Ivan](https://github.com/abyss7))
* 在外部字典中使用完 MySQL 连接后将其关闭。此更改与问题 #893 相关。[#5395](https://github.com/ClickHouse/ClickHouse/pull/5395) ([Clément Rodriguez](https://github.com/clemrodriguez))
* 改进 MySQL Wire 协议。将格式名称更改为 MySQLWire。使用 RAII 调用 RSA&#95;free。如果无法创建上下文则禁用 SSL。 [#5419](https://github.com/ClickHouse/ClickHouse/pull/5419) ([Yuriy Baranov](https://github.com/yurriy))
* clickhouse-client：允许在历史文件无法访问时也能运行（只读、没有磁盘空间、文件是目录等）。 [#5431](https://github.com/ClickHouse/ClickHouse/pull/5431) ([proller](https://github.com/proller))
* 在对 Distributed 表执行异步 INSERT 时遵从查询设置。 [#4936](https://github.com/ClickHouse/ClickHouse/pull/4936) ([TCeason](https://github.com/TCeason))
* 已将函数 `leastSqr` 重命名为 `simpleLinearRegression`，`LinearRegression` 重命名为 `linearRegression`，`LogisticRegression` 重命名为 `logisticRegression`。 [#5391](https://github.com/ClickHouse/ClickHouse/pull/5391) ([Nikolai Kochetov](https://github.com/KochetovNicolai))



#### 性能改进 {#performance-improvements}

- 在 `ALTER MODIFY` 查询中对非复制的 MergeTree 表的部分进行并行处理。[#4639](https://github.com/ClickHouse/ClickHouse/pull/4639) ([Ivan Kush](https://github.com/IvanKush))
- 优化正则表达式提取。[#5193](https://github.com/ClickHouse/ClickHouse/pull/5193) [#5191](https://github.com/ClickHouse/ClickHouse/pull/5191) ([Danila Kutenin](https://github.com/danlark1))
- 如果右连接键列仅在 `JOIN ON` 子句中使用，则不要将其添加到连接结果中。[#5260](https://github.com/ClickHouse/ClickHouse/pull/5260) ([Artem Zuikov](https://github.com/4ertus2))
- 在首次获得空响应后冻结 Kafka 缓冲区，从而避免在某些行解析流中针对空结果多次调用 `ReadBuffer::next()`。[#5283](https://github.com/ClickHouse/ClickHouse/pull/5283) ([Ivan](https://github.com/abyss7))
- 对多参数的 `concat` 函数进行优化。[#5357](https://github.com/ClickHouse/ClickHouse/pull/5357) ([Danila Kutenin](https://github.com/danlark1))
- 查询优化：在将逗号连接或交叉连接重写为内连接时，允许下推 `IN` 谓词。[#5396](https://github.com/ClickHouse/ClickHouse/pull/5396) ([Artem Zuikov](https://github.com/4ertus2))
- 将我们的 LZ4 实现升级为参考实现，以加快解压缩速度。[#5070](https://github.com/ClickHouse/ClickHouse/pull/5070) ([Danila Kutenin](https://github.com/danlark1))
- 实现了基于 kxsort 的 MSD 基数排序以及部分排序。[#5129](https://github.com/ClickHouse/ClickHouse/pull/5129) ([Evgenii Pravda](https://github.com/kvinty))

#### Bug 修复 {#bug-fixes}

- 修复在存在 `JOIN` 时下推所需列的问题。[#5192](https://github.com/ClickHouse/ClickHouse/pull/5192) ([Winter Zhang](https://github.com/zhang2014))
- 修复当 ClickHouse 由 systemd 运行时，命令 `sudo service clickhouse-server forcerestart` 未按预期工作的问题。[#5204](https://github.com/ClickHouse/ClickHouse/pull/5204) ([proller](https://github.com/proller))
- 修复 DataPartsExchange 中的 HTTP 错误码（用于服务器间通信并监听 9009 端口的 HTTP 服务器在出错时也始终返回 200）。[#5216](https://github.com/ClickHouse/ClickHouse/pull/5216) ([proller](https://github.com/proller))
- 修复 `SimpleAggregateFunction` 在 `String` 长度大于 `MAX_SMALL_STRING_SIZE` 时的问题。[#5311](https://github.com/ClickHouse/ClickHouse/pull/5311) ([Azat Khuzhin](https://github.com/azat))
- 修复在 `IN` 中从 `Decimal` 转换为 `Nullable(Decimal)` 的错误，并支持其他 Decimal 到 Decimal 的转换（包括不同的小数位数）。[#5350](https://github.com/ClickHouse/ClickHouse/pull/5350) ([Artem Zuikov](https://github.com/4ertus2))
- 修复 simdjson 库中 FPU 状态被破坏的问题，该问题会导致 `uniqHLL` 和 `uniqCombined` 聚合函数以及 `log` 等数学函数的计算结果错误。[#5354](https://github.com/ClickHouse/ClickHouse/pull/5354) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复 JSON 函数中处理常量 / 非常量混合场景时的问题。[#5435](https://github.com/ClickHouse/ClickHouse/pull/5435) ([Vitaly Baranov](https://github.com/vitlibar))
- 修复 `retention` 函数。现在一行数据中所有满足条件的项都会被添加到该行的数据状态中。[#5119](https://github.com/ClickHouse/ClickHouse/pull/5119) ([小路](https://github.com/nicelulu))
- 修复 `quantileExact` 在使用 Decimal 时的结果类型问题。[#5304](https://github.com/ClickHouse/ClickHouse/pull/5304) ([Artem Zuikov](https://github.com/4ertus2))

#### 文档 {#documentation}



- 将 `CollapsingMergeTree` 的文档翻译为中文。[#5168](https://github.com/ClickHouse/ClickHouse/pull/5168) ([张风啸](https://github.com/AlexZFX))
- 将部分关于表引擎的文档翻译为中文。
    [#5134](https://github.com/ClickHouse/ClickHouse/pull/5134)
    [#5328](https://github.com/ClickHouse/ClickHouse/pull/5328)
    ([never lee](https://github.com/neverlee))

#### 构建/测试/打包方面的改进 {#buildtestingpackaging-improvements}

- 修复了一些由 sanitizer 报告的、可能存在 use-after-free 的问题。[#5139](https://github.com/ClickHouse/ClickHouse/pull/5139) [#5143](https://github.com/ClickHouse/ClickHouse/pull/5143) [#5393](https://github.com/ClickHouse/ClickHouse/pull/5393) ([Ivan](https://github.com/abyss7))
- 为了方便起见，将性能测试从各自的独立目录中移出。[#5158](https://github.com/ClickHouse/ClickHouse/pull/5158) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复不正确的性能测试用例。[#5255](https://github.com/ClickHouse/ClickHouse/pull/5255) ([alesapin](https://github.com/alesapin))
- 添加了一个用于计算由比特翻转引起的校验和的工具，以便调试硬件问题。[#5334](https://github.com/ClickHouse/ClickHouse/pull/5334) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 提高 runner 脚本的可用性。[#5340](https://github.com/ClickHouse/ClickHouse/pull/5340)[#5360](https://github.com/ClickHouse/ClickHouse/pull/5360) ([filimonov](https://github.com/filimonov))
- 添加了一份简短的性能测试编写说明。[#5408](https://github.com/ClickHouse/ClickHouse/pull/5408) ([alesapin](https://github.com/alesapin))
- 在性能测试中新增了在 CREATE、FILL 和 DROP 查询里进行替换的功能。[#5367](https://github.com/ClickHouse/ClickHouse/pull/5367) ([Olga Khvostikova](https://github.com/stavrolia))



## ClickHouse 版本 19.7 {#clickhouse-release-19-7}

### ClickHouse 版本 19.7.5.29，2019-07-05 {#clickhouse-release-19-7-5-29-2019-07-05}

#### Bug 修复 {#bug-fix-25}

- 修复了某些包含 JOIN 的查询中的性能回归问题。 [#5192](https://github.com/ClickHouse/ClickHouse/pull/5192) ([Winter Zhang](https://github.com/zhang2014))

### ClickHouse 版本 19.7.5.27，2019-06-09 {#clickhouse-release-19-7-5-27-2019-06-09}

#### 新特性 {#new-features-1}

- 添加了与数组函数 `hasAny` 和 `hasAll` 类似的位图函数 `bitmapHasAny` 和 `bitmapHasAll`。 [#5279](https://github.com/ClickHouse/ClickHouse/pull/5279) ([Sergi Vladykin](https://github.com/svladykin))

#### Bug 修复 {#bug-fixes-1}



- 修复在包含 Null 值时 `minmax` 索引导致的段错误问题。[#5246](https://github.com/ClickHouse/ClickHouse/pull/5246) ([Nikita Vasilev](https://github.com/nikvas0))
- 将 LIMIT BY 中的所有输入列标记为必需的输出列，修复某些分布式查询中的 "Not found column" 错误。[#5407](https://github.com/ClickHouse/ClickHouse/pull/5407) ([Constantin S. Pan](https://github.com/kvap))
- 修复在带有 DEFAULT 的列上执行 `SELECT .. PREWHERE` 时出现的 "Column '0' already exists" 错误。[#5397](https://github.com/ClickHouse/ClickHouse/pull/5397) ([proller](https://github.com/proller))
- 修复在 `ReplicatedMergeTree` 上执行 `ALTER MODIFY TTL` 查询的问题。[#5539](https://github.com/ClickHouse/ClickHouse/pull/5539/commits) ([Anton Popov](https://github.com/CurtizJ))
- 当 Kafka 消费者启动失败时，不再导致服务器崩溃。[#5285](https://github.com/ClickHouse/ClickHouse/pull/5285) ([Ivan](https://github.com/abyss7))
- 修复导致 bitmap 函数产生错误结果的问题。[#5359](https://github.com/ClickHouse/ClickHouse/pull/5359) ([Andy Yang](https://github.com/andyyzh))
- 修复哈希字典的 element_count 计算（不再包含重复项）。[#5440](https://github.com/ClickHouse/ClickHouse/pull/5440) ([Azat Khuzhin](https://github.com/azat))
- 使用环境变量 TZ 的内容作为时区名称，这有助于在某些情况下正确检测默认时区。[#5443](https://github.com/ClickHouse/ClickHouse/pull/5443) ([Ivan](https://github.com/abyss7))
- 不再在 `dictGetT` 函数中尝试转换整数，因为该转换行为不正确，改为抛出异常。[#5446](https://github.com/ClickHouse/ClickHouse/pull/5446) ([Artem Zuikov](https://github.com/4ertus2))
- 修复 ExternalData HTTP 请求中的设置问题。[#5455](https://github.com/ClickHouse/ClickHouse/pull/5455) ([Danila
    Kutenin](https://github.com/danlark1))
- 修复仅从文件系统删除数据分片而未从 ZooKeeper 中删除的问题。[#5520](https://github.com/ClickHouse/ClickHouse/pull/5520) ([alesapin](https://github.com/alesapin))
- 修复 `bitmapHasAny` 函数中的段错误问题。[#5528](https://github.com/ClickHouse/ClickHouse/pull/5528) ([Zhichang Yu](https://github.com/yuzhichang))
- 修复复制连接池在 DNS 缓存已被清除的情况下仍不会重试解析主机的错误。[#5534](https://github.com/ClickHouse/ClickHouse/pull/5534) ([alesapin](https://github.com/alesapin))
- 修复 `DROP INDEX IF EXISTS` 查询。现在在指定索引不存在时，`ALTER TABLE ... DROP INDEX IF EXISTS ...` 查询不会抛出异常。[#5524](https://github.com/ClickHouse/ClickHouse/pull/5524) ([Gleb Novikov](https://github.com/NanoBjorn))
- 修复 UNION ALL 的超类型列问题。此前在结果列的数据和列类型上可能出现不一致的情况。[#5503](https://github.com/ClickHouse/ClickHouse/pull/5503) ([Artem Zuikov](https://github.com/4ertus2))
- 在处理 DDL 查询时跳过 ZNONODE。此前如果另一个节点从任务队列中删除了 znode，而本节点尚未处理它、但已经获取到子节点列表，则会终止 DDLWorker 线程。[#5489](https://github.com/ClickHouse/ClickHouse/pull/5489) ([Azat Khuzhin](https://github.com/azat))
- 修复向带有 MATERIALIZED 列的 Distributed() 表执行 INSERT 时的问题。[#5429](https://github.com/ClickHouse/ClickHouse/pull/5429) ([Azat Khuzhin](https://github.com/azat))

### ClickHouse 版本 19.7.3.9，2019-05-30 {#clickhouse-release-19-7-3-9-2019-05-30}

#### 新特性 {#new-features-2}



- 允许限制用户可指定的设置取值范围。
    这些约束可以在用户设置配置文件中进行配置。
    [#4931](https://github.com/ClickHouse/ClickHouse/pull/4931) ([Vitaly
    Baranov](https://github.com/vitlibar))
- 为函数 `groupUniqArray` 增加第二个版本，带有可选的 `max_size`
    参数，用于限制结果数组的大小。其行为类似于 `groupArray(max_size)(x)` 函数。
    [#5026](https://github.com/ClickHouse/ClickHouse/pull/5026) ([Guillaume
    Tassery](https://github.com/YiuRULE))
- 对于 TSVWithNames/CSVWithNames 输入文件格式，现在可以从文件头中确定列顺序。
    这由 `input_format_with_names_use_header` 参数控制。
    [#5081](https://github.com/ClickHouse/ClickHouse/pull/5081)
    ([Alexander](https://github.com/Akazz))

#### Bug 修复 {#bug-fixes-2}

- 在合并期间使用 uncompressed_cache + JOIN 时发生崩溃 (#5197)
    [#5133](https://github.com/ClickHouse/ClickHouse/pull/5133) ([Danila
    Kutenin](https://github.com/danlark1))
- 对 system 表执行 clickhouse-client 查询时发生段错误。#5066
    [#5127](https://github.com/ClickHouse/ClickHouse/pull/5127)
    ([Ivan](https://github.com/abyss7))
- 通过 KafkaEngine 在高负载下导致数据丢失 (#4736)
    [#5080](https://github.com/ClickHouse/ClickHouse/pull/5080)
    ([Ivan](https://github.com/abyss7))
- 修复了一个极其罕见的数据竞争问题：在执行带有 UNION ALL 的查询时，如果涉及至少两个对 system.columns、system.tables、system.parts、system.parts_tables 或 Merge 系列表的 SELECT，并且同时对相关表的列执行 ALTER 操作，则可能会触发该问题。[#5189](https://github.com/ClickHouse/ClickHouse/pull/5189) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### 性能改进 {#performance-improvements-1}

- 当在 `ORDER BY` 中按单个数值列排序且未使用 `LIMIT` 时，使用基数排序 (radix sort)。[#5106](https://github.com/ClickHouse/ClickHouse/pull/5106),
    [#4439](https://github.com/ClickHouse/ClickHouse/pull/4439)
    ([Evgenii Pravda](https://github.com/kvinty),
    [alexey-milovidov](https://github.com/alexey-milovidov))

#### 文档 {#documentation-1}

- 将部分表引擎的文档翻译为中文。
    [#5107](https://github.com/ClickHouse/ClickHouse/pull/5107),
    [#5094](https://github.com/ClickHouse/ClickHouse/pull/5094),
    [#5087](https://github.com/ClickHouse/ClickHouse/pull/5087)
    ([张风啸](https://github.com/AlexZFX)),
    [#5068](https://github.com/ClickHouse/ClickHouse/pull/5068) ([never
    lee](https://github.com/neverlee))

#### 构建/测试/打包改进 {#buildtestingpackaging-improvements-1}



- 在 `clickhouse-test` 中正确打印 UTF-8 字符。
    [#5084](https://github.com/ClickHouse/ClickHouse/pull/5084)
    ([alexey-milovidov](https://github.com/alexey-milovidov))
- 为 clickhouse-client 添加命令行参数，以始终加载提示
    数据。[#5102](https://github.com/ClickHouse/ClickHouse/pull/5102)
    ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复部分 PVS-Studio 警告。
    [#5082](https://github.com/ClickHouse/ClickHouse/pull/5082)
    ([alexey-milovidov](https://github.com/alexey-milovidov))
- 更新 LZ4 [#5040](https://github.com/ClickHouse/ClickHouse/pull/5040) ([Danila
    Kutenin](https://github.com/danlark1))
- 将 gperf 添加到构建依赖项中，为即将提交的 pull request #5030 做准备。
    [#5110](https://github.com/ClickHouse/ClickHouse/pull/5110)
    ([proller](https://github.com/proller))



## ClickHouse 版本 19.6 {#clickhouse-release-19-6}

### ClickHouse 版本 19.6.3.18，2019-06-13 {#clickhouse-release-19-6-3-18-2019-06-13}

#### Bug 修复 {#bug-fixes-3}

- 修复了来自表函数 `mysql` 和 `odbc` 以及对应表引擎的查询中 IN 条件下推优化的问题。修复了 #3540 和 #2384。[#5313](https://github.com/ClickHouse/ClickHouse/pull/5313) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了 Zookeeper 中的死锁。[#5297](https://github.com/ClickHouse/ClickHouse/pull/5297) ([github1youlc](https://github.com/github1youlc))
- 允许在 CSV 中使用带引号的小数。[#5284](https://github.com/ClickHouse/ClickHouse/pull/5284) ([Artem Zuikov](https://github.com/4ertus2))
- 禁止将浮点数的 Inf/NaN 转换为 Decimal 类型（抛出异常）。[#5282](https://github.com/ClickHouse/ClickHouse/pull/5282) ([Artem Zuikov](https://github.com/4ertus2))
- 修复了 `RENAME` 查询中的数据竞争问题。[#5247](https://github.com/ClickHouse/ClickHouse/pull/5247) ([Winter Zhang](https://github.com/zhang2014))
- 临时禁用 LFAlloc。使用 LFAlloc 可能会在为 UncompressedCache 分配时导致大量 MAP_FAILED，从而在高负载服务器上引发查询崩溃。[cfdba93](https://github.com/ClickHouse/ClickHouse/commit/cfdba938ce22f16efeec504f7f90206a515b1280) ([Danila Kutenin](https://github.com/danlark1))

### ClickHouse 版本 19.6.2.11，2019-05-13 {#clickhouse-release-19-6-2-11-2019-05-13}

#### 新特性 {#new-features-3}

- 支持对列和表使用 TTL 表达式。[#4212](https://github.com/ClickHouse/ClickHouse/pull/4212) ([Anton Popov](https://github.com/CurtizJ))
- 为 HTTP 响应添加了对 `brotli` 压缩的支持（Accept-Encoding: br）。[#4388](https://github.com/ClickHouse/ClickHouse/pull/4388) ([Mikhail](https://github.com/fandyushin))
- 新增函数 `isValidUTF8`，用于检查一组字节是否为正确的 UTF-8 编码。[#4934](https://github.com/ClickHouse/ClickHouse/pull/4934) ([Danila Kutenin](https://github.com/danlark1))
- 新增负载均衡策略 `first_or_random`，该策略会将查询发送到第一个指定主机，如果该主机不可访问，则将查询发送到分片中的随机主机。对跨复制拓扑的部署非常有用。[#5012](https://github.com/ClickHouse/ClickHouse/pull/5012) ([nvartolomei](https://github.com/nvartolomei))

#### 实验性特性 {#experimental-features-1}

- 为 MergeTree\* 表族新增设置 `index_granularity_bytes`（自适应索引粒度）。[#4826](https://github.com/ClickHouse/ClickHouse/pull/4826) ([alesapin](https://github.com/alesapin))

#### 改进 {#improvements-1}



- 为函数 `substringUTF8` 新增对非常量以及负值 size 和 length 参数的支持。[#4989](https://github.com/ClickHouse/ClickHouse/pull/4989) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 禁用在 LEFT JOIN 中对右表、RIGHT JOIN 中对左表，以及 FULL JOIN 中对两侧表的谓词下推（push-down）。这修复了某些情况下错误的 JOIN 结果。[#4846](https://github.com/ClickHouse/ClickHouse/pull/4846) ([Ivan](https://github.com/abyss7))
- `clickhouse-copier`：自动从 `--task-file` 选项指定的文件中上传任务配置。[#4876](https://github.com/ClickHouse/ClickHouse/pull/4876) ([proller](https://github.com/proller))
- 为存储工厂（storage factory）和表函数工厂（table functions factory）增加拼写错误处理器。[#4891](https://github.com/ClickHouse/ClickHouse/pull/4891) ([Danila Kutenin](https://github.com/danlark1))
- 在没有子查询的多表 JOIN 中支持星号和限定星号（qualified asterisk）。[#4898](https://github.com/ClickHouse/ClickHouse/pull/4898) ([Artem Zuikov](https://github.com/4ertus2))
- 让缺失列的错误信息更易于理解、更友好。[#4915](https://github.com/ClickHouse/ClickHouse/pull/4915) ([Artem Zuikov](https://github.com/4ertus2))

#### 性能改进 {#performance-improvements-2}

- 显著加速 ASOF JOIN。[#4924](https://github.com/ClickHouse/ClickHouse/pull/4924) ([Martijn Bakker](https://github.com/Gladdy))

#### 向后不兼容的更改 {#backward-incompatible-changes}

- 为保持一致性，将 HTTP 头 `Query-Id` 重命名为 `X-ClickHouse-Query-Id`。[#4972](https://github.com/ClickHouse/ClickHouse/pull/4972) ([Mikhail](https://github.com/fandyushin))

#### Bug 修复 {#bug-fixes-4}

- 修复了 `clickhouse-copier` 中潜在的空指针解引用问题。[#4900](https://github.com/ClickHouse/ClickHouse/pull/4900) ([proller](https://github.com/proller))
- 修复了在包含 JOIN + ARRAY JOIN 的查询中出现的错误。[#4938](https://github.com/ClickHouse/ClickHouse/pull/4938) ([Artem Zuikov](https://github.com/4ertus2))
- 修复了在一个字典通过 engine=Dictionary 的数据库依赖于另一个字典时，服务器启动时可能发生的挂起问题。[#4962](https://github.com/ClickHouse/ClickHouse/pull/4962) ([Vitaly Baranov](https://github.com/vitlibar))
- 部分修复 distributed_product_mode = local。现在可以通过表别名在 where/having/order by/... 中引用本地表的列。如果表没有别名则抛出异常。目前仍然无法在没有表别名的情况下访问这些列。[#4986](https://github.com/ClickHouse/ClickHouse/pull/4986) ([Artem Zuikov](https://github.com/4ertus2))
- 修复了在 `SELECT DISTINCT` 与 `JOIN` 一起使用时可能出现的错误结果。[#5001](https://github.com/ClickHouse/ClickHouse/pull/5001) ([Artem Zuikov](https://github.com/4ertus2))
- 修复了一个极少见的数据竞争问题：在执行包含至少两个来自 system.columns、system.tables、system.parts、system.parts_tables 或 Merge 系列表的 SELECT，并通过 UNION ALL 合并，同时对相关表的列执行 ALTER 操作的查询时，可能会触发该问题。[#5189](https://github.com/ClickHouse/ClickHouse/pull/5189) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### 构建 / 测试 / 打包改进 {#buildtestingpackaging-improvements-2}



- 修复了在不同主机上运行 clickhouse-server 时出现的测试失败问题 [#4713](https://github.com/ClickHouse/ClickHouse/pull/4713) ([Vasily Nemkov](https://github.com/Enmk))
- clickhouse-test：在非 TTY 环境中禁用颜色控制序列。[#4937](https://github.com/ClickHouse/ClickHouse/pull/4937) ([alesapin](https://github.com/alesapin))
- clickhouse-test：允许使用任意测试数据库（在可能的情况下移除 `test.` 限定）[#5008](https://github.com/ClickHouse/ClickHouse/pull/5008) ([proller](https://github.com/proller))
- 修复 ubsan 错误 [#5037](https://github.com/ClickHouse/ClickHouse/pull/5037) ([Vitaly Baranov](https://github.com/vitlibar))
- 将 Yandex LFAlloc 添加到 ClickHouse，以便使用不同方式为 MarkCache 和 UncompressedCache 数据分配内存，从而更可靠地捕获段错误 [#4995](https://github.com/ClickHouse/ClickHouse/pull/4995) ([Danila Kutenin](https://github.com/danlark1))
- 用于辅助回溯移植（backport）和编写变更日志的 Python 工具。[#4949](https://github.com/ClickHouse/ClickHouse/pull/4949) ([Ivan](https://github.com/abyss7))



## ClickHouse 版本 19.5 {#clickhouse-release-19-5}

### ClickHouse 版本 19.5.4.22，2019-05-13 {#clickhouse-release-19-5-4-22-2019-05-13}

#### Bug 修复 {#bug-fixes-5}

- 修复了在 bitmap\* 函数中可能发生的崩溃。 [#5220](https://github.com/ClickHouse/ClickHouse/pull/5220) [#5228](https://github.com/ClickHouse/ClickHouse/pull/5228) ([Andy Yang](https://github.com/andyyzh))
- 修复了一个极少出现的数据竞争问题：在执行包含至少两个从 system.columns、system.tables、system.parts、system.parts_tables 或 Merge 系列表进行 SELECT 的 UNION ALL 查询时，如果同时对相关表的列执行 ALTER 操作，可能会触发该问题。 [#5189](https://github.com/ClickHouse/ClickHouse/pull/5189) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复错误 `Set for IN is not created yet in case of using single LowCardinality column in the left part of IN`。当 LowCardinality 列是主键的一部分时会出现此错误。#5031 [#5154](https://github.com/ClickHouse/ClickHouse/pull/5154) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- 修改 retention 函数行为：之前如果一行同时满足第一个条件和第 N 个条件，则仅将第一个满足的条件加入数据状态。现在会将该行中所有满足的条件都加入数据状态。 [#5119](https://github.com/ClickHouse/ClickHouse/pull/5119) ([小路](https://github.com/nicelulu))

### ClickHouse 版本 19.5.3.8，2019-04-18 {#clickhouse-release-19-5-3-8-2019-04-18}

#### Bug 修复 {#bug-fixes-6}

- 将设置 `max_partitions_per_insert_block` 的类型从 boolean 修正为 UInt64。 [#5028](https://github.com/ClickHouse/ClickHouse/pull/5028) ([Mohammad Hossein Sekhavat](https://github.com/mhsekhavat))

### ClickHouse 版本 19.5.2.6，2019-04-15 {#clickhouse-release-19-5-2-6-2019-04-15}

#### 新特性 {#new-features-4}



- 添加了基于 [Hyperscan](https://github.com/intel/hyperscan) 的多模式正则表达式匹配（函数 `multiMatchAny`、`multiMatchAnyIndex`、`multiFuzzyMatchAny`、`multiFuzzyMatchAnyIndex`）。[#4780](https://github.com/ClickHouse/ClickHouse/pull/4780)，[#4841](https://github.com/ClickHouse/ClickHouse/pull/4841)（[Danila Kutenin](https://github.com/danlark1)）
- 添加了 `multiSearchFirstPosition` 函数。[#4780](https://github.com/ClickHouse/ClickHouse/pull/4780)（[Danila Kutenin](https://github.com/danlark1)）
- 为表实现了针对每行的预定义表达式过滤器。[#4792](https://github.com/ClickHouse/ClickHouse/pull/4792)（[Ivan](https://github.com/abyss7)）
- 新增了一种基于 Bloom Filter 的数据跳过索引类型（可用于 `equal`、`in` 和 `like` 函数）。[#4499](https://github.com/ClickHouse/ClickHouse/pull/4499)（[Nikita Vasilev](https://github.com/nikvas0)）
- 新增 `ASOF JOIN`，用于执行将数据与最新已知值关联起来的查询。[#4774](https://github.com/ClickHouse/ClickHouse/pull/4774) [#4867](https://github.com/ClickHouse/ClickHouse/pull/4867) [#4863](https://github.com/ClickHouse/ClickHouse/pull/4863) [#4875](https://github.com/ClickHouse/ClickHouse/pull/4875)（[Martijn Bakker](https://github.com/Gladdy)、[Artem Zuikov](https://github.com/4ertus2)）
- 将多个 `COMMA JOIN` 重写为 `CROSS JOIN`，然后在可能的情况下再将其重写为 `INNER JOIN`。[#4661](https://github.com/ClickHouse/ClickHouse/pull/4661)（[Artem Zuikov](https://github.com/4ertus2)）

#### 改进 {#improvement-9}



- `topK` 和 `topKWeighted` 现在支持自定义 `loadFactor`（修复问题 [#4252](https://github.com/ClickHouse/ClickHouse/issues/4252)）。[#4634](https://github.com/ClickHouse/ClickHouse/pull/4634)（[Kirill Danshin](https://github.com/kirillDanshin)）
- 允许在没有采样的表上使用 `parallel_replicas_count > 1`（对于这类表，该设置会被直接忽略）。在之前的版本中，这会导致异常。[#4637](https://github.com/ClickHouse/ClickHouse/pull/4637)（[Alexey Elymanov](https://github.com/digitalist)）
- 支持 `CREATE OR REPLACE VIEW`。允许在单条语句中创建视图或设置新的定义。[#4654](https://github.com/ClickHouse/ClickHouse/pull/4654)（[Boris Granveaud](https://github.com/bgranvea)）
- `Buffer` 表引擎现在支持 `PREWHERE`。[#4671](https://github.com/ClickHouse/ClickHouse/pull/4671)（[Yangkuan Liu](https://github.com/LiuYangkuan)）
- 新增支持在 zookeeper 中缺少元数据时，以 `readonly` 模式启动副本表。[#4691](https://github.com/ClickHouse/ClickHouse/pull/4691)（[alesapin](https://github.com/alesapin)）
- 修复了 clickhouse-client 中进度条闪烁的问题。该问题在对流式查询使用 `FORMAT Null` 时最为明显。[#4811](https://github.com/ClickHouse/ClickHouse/pull/4811)（[alexey-milovidov](https://github.com/alexey-milovidov)）
- 允许按用户级别禁用使用 `hyperscan` 库的函数，以限制潜在的过度且不可控的资源使用。[#4816](https://github.com/ClickHouse/ClickHouse/pull/4816)（[alexey-milovidov](https://github.com/alexey-milovidov)）
- 在所有错误日志中增加版本号记录。[#4824](https://github.com/ClickHouse/ClickHouse/pull/4824)（[proller](https://github.com/proller)）
- 为 `multiMatch` 函数添加了限制，要求字符串大小必须能适配到 `unsigned int` 的范围。同时为 `multiSearch` 函数添加了参数数量上限。[#4834](https://github.com/ClickHouse/ClickHouse/pull/4834)（[Danila Kutenin](https://github.com/danlark1)）
- 改进了 Hyperscan 中临时缓冲区的使用和错误处理。[#4866](https://github.com/ClickHouse/ClickHouse/pull/4866)（[Danila Kutenin](https://github.com/danlark1)）
- 从 `*GraphiteMergeTree` 引擎表的表配置中填充 `system.graphite_detentions`。[#4584](https://github.com/ClickHouse/ClickHouse/pull/4584)（[Mikhail f. Shiryaev](https://github.com/Felixoid)）
- 将 `trigramDistance` 函数重命名为 `ngramDistance`，并添加了更多带有 `CaseInsensitive` 和 `UTF` 的函数。[#4602](https://github.com/ClickHouse/ClickHouse/pull/4602)（[Danila Kutenin](https://github.com/danlark1)）
- 改进了数据跳过索引的计算。[#4640](https://github.com/ClickHouse/ClickHouse/pull/4640)（[Nikita Vasilev](https://github.com/nikvas0)）
- 将普通列、`DEFAULT`、`MATERIALIZED` 和 `ALIAS` 列保存在同一个列表中（修复问题 [#2867](https://github.com/ClickHouse/ClickHouse/issues/2867)）。[#4707](https://github.com/ClickHouse/ClickHouse/pull/4707)（[Alex Zatelepin](https://github.com/ztlpn)）

#### Bug 修复 {#bug-fix-26}



* 在内存分配失败时避免调用 `std::terminate`。现在会按预期抛出 `std::bad_alloc` 异常。 [#4665](https://github.com/ClickHouse/ClickHouse/pull/4665) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了从缓冲区读取 `capnproto` 的问题。有时文件无法通过 HTTP 成功加载。[#4674](https://github.com/ClickHouse/ClickHouse/pull/4674)（[Vladislav](https://github.com/smirnov-vs)）
* 修复在执行 `OPTIMIZE TABLE FINAL` 查询时出现的错误 `Unknown log entry type: 0`。 [#4683](https://github.com/ClickHouse/ClickHouse/pull/4683) ([Amos Bird](https://github.com/amosbird))
* 向 `hasAny` 或 `hasAll` 函数传入错误参数可能会导致段错误（segfault）。 [#4698](https://github.com/ClickHouse/ClickHouse/pull/4698) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 在执行 `DROP DATABASE dictionary` 查询时可能会发生死锁。 [#4701](https://github.com/ClickHouse/ClickHouse/pull/4701) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复 `median` 和 `quantile` 函数中的未定义行为。 [#4702](https://github.com/ClickHouse/ClickHouse/pull/4702) ([hcz](https://github.com/hczhcz))
* 修复当 `network_compression_method` 使用小写时的压缩级别检测问题。该问题出现在 v19.1 中。[#4706](https://github.com/ClickHouse/ClickHouse/pull/4706) ([proller](https://github.com/proller))
* 修复了忽略 `<timezone>UTC</timezone>` 设置的问题（修复问题 [#4658](https://github.com/ClickHouse/ClickHouse/issues/4658)）。[#4718](https://github.com/ClickHouse/ClickHouse/pull/4718)（[proller](https://github.com/proller)）
* 修复 `histogram` 函数在 `Distributed` 表上的行为。[#4741](https://github.com/ClickHouse/ClickHouse/pull/4741) ([olegkv](https://github.com/olegkv))
* 修复了 TSan 报告 `destroy of a locked mutex`。 [#4742](https://github.com/ClickHouse/ClickHouse/pull/4742) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了由于系统日志使用中的竞争条件导致在关闭时出现的 TSan 报告。修复了在启用 part&#95;log 时，关闭过程中可能出现的 use-after-free 问题。[#4758](https://github.com/ClickHouse/ClickHouse/pull/4758) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 在发生错误时，修复 `ReplicatedMergeTreeAlterThread` 中对部分的重新检查。[#4772](https://github.com/ClickHouse/ClickHouse/pull/4772) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* 对中间 `aggregate function` 状态进行算术运算在使用常量参数（例如子查询结果）时不起作用。 [#4776](https://github.com/ClickHouse/ClickHouse/pull/4776) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 在元数据中始终使用反引号包裹列名。否则，将无法创建包含名为 `index` 的列的表（由于元数据中的 `ATTACH` 查询格式错误，服务器将无法重启）。[#4782](https://github.com/ClickHouse/ClickHouse/pull/4782) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复在 `Distributed` 表上执行 `ALTER ... MODIFY ORDER BY` 时的崩溃。[#4790](https://github.com/ClickHouse/ClickHouse/pull/4790) ([TCeason](https://github.com/TCeason))
* 修复在启用 `enable_optimize_predicate_expression` 时 `JOIN ON` 导致的段错误。 [#4794](https://github.com/ClickHouse/ClickHouse/pull/4794) ([Winter Zhang](https://github.com/zhang2014))
* 修复从 Kafka 消费 protobuf 消息后多插入一行记录的错误。 [#4808](https://github.com/ClickHouse/ClickHouse/pull/4808) ([Vitaly Baranov](https://github.com/vitlibar))
* 修复在非空列与可空列之间执行 `JOIN` 时的崩溃。修复在启用 `ANY JOIN` 且设置 `join_use_nulls` 时，对右侧键中的 `NULLs` 处理不正确的问题。[#4815](https://github.com/ClickHouse/ClickHouse/pull/4815) ([Artem Zuikov](https://github.com/4ertus2))
* 修复 `clickhouse-copier` 中的段错误。 [#4835](https://github.com/ClickHouse/ClickHouse/pull/4835) ([proller](https://github.com/proller))
* 修复了在对 `system.tables` 执行 `SELECT` 时，如果表被并发重命名或修改可能出现的竞争条件。 [#4836](https://github.com/ClickHouse/ClickHouse/pull/4836) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了在获取已过期的数据分片时发生的数据竞争问题。[#4839](https://github.com/ClickHouse/ClickHouse/pull/4839) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了在对 MergeTree 系列表执行 `RENAME` 操作时可能发生的罕见数据竞争问题。 [#4844](https://github.com/ClickHouse/ClickHouse/pull/4844) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了函数 `arrayIntersect` 中的段错误。当混合使用常量参数和普通参数调用该函数时，可能会发生段错误。[#4847](https://github.com/ClickHouse/ClickHouse/pull/4847) ([Lixiang Qian](https://github.com/fancyqlx))
* 修复了在罕见情况下从 `Array(LowCardinality)` 列读取数据的问题，该问题会在列中包含一长串空数组时出现。 [#4850](https://github.com/ClickHouse/ClickHouse/pull/4850) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* 修复在 `FULL/RIGHT JOIN` 中，当连接条件包含可为 NULL 和不可为 NULL 的列时出现的崩溃问题。[#4855](https://github.com/ClickHouse/ClickHouse/pull/4855) ([Artem Zuikov](https://github.com/4ertus2))
* 修复在副本之间获取数据分片时抛出的 `No message received` 异常。[#4856](https://github.com/ClickHouse/ClickHouse/pull/4856) ([alesapin](https://github.com/alesapin))
* 修复了在单个数组中存在多个重复值时，`arrayIntersect` 函数结果不正确的问题。 [#4871](https://github.com/ClickHouse/ClickHouse/pull/4871) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* 修复了在并发执行 `ALTER COLUMN` 查询时可能导致服务器崩溃的竞争条件（修复问题 [#3421](https://github.com/ClickHouse/ClickHouse/issues/3421)）。 [#4592](https://github.com/ClickHouse/ClickHouse/pull/4592) ([Alex Zatelepin](https://github.com/ztlpn))
* 修复在包含常量列的 `FULL/RIGHT JOIN` 中出现错误结果的问题。 [#4723](https://github.com/ClickHouse/ClickHouse/pull/4723) ([Artem Zuikov](https://github.com/4ertus2))
* 修复使用星号的 `GLOBAL JOIN` 中的重复项。 [#4705](https://github.com/ClickHouse/ClickHouse/pull/4705) ([Artem Zuikov](https://github.com/4ertus2))
* 在未指定列类型时，修复对列 `CODEC` 执行 `ALTER MODIFY` 时的参数推导问题。 [#4883](https://github.com/ClickHouse/ClickHouse/pull/4883) ([alesapin](https://github.com/alesapin))
* 当 `URL` 包含片段但不包含查询字符串时，函数 `cutQueryStringAndFragment()` 和 `queryStringAndFragment()` 现在能够正确工作。[#4894](https://github.com/ClickHouse/ClickHouse/pull/4894) ([Vitaly Baranov](https://github.com/vitlibar))
* 修复在将 `min_bytes_to_use_direct_io` 设置为大于零时出现的罕见错误，该错误会在线程需要在列文件中向后定位时发生。 [#4897](https://github.com/ClickHouse/ClickHouse/pull/4897) ([alesapin](https://github.com/alesapin))
* 修复对带有 `LowCardinality` 参数的聚合函数的错误参数类型处理（修复问题 [#4919](https://github.com/ClickHouse/ClickHouse/issues/4919)）。[#4922](https://github.com/ClickHouse/ClickHouse/pull/4922)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）
* 修复 `GLOBAL JOIN` 中名称限定错误。[#4969](https://github.com/ClickHouse/ClickHouse/pull/4969) ([Artem Zuikov](https://github.com/4ertus2))
* 修正函数 `toISOWeek` 在 1970 年的结果。[#4988](https://github.com/ClickHouse/ClickHouse/pull/4988) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复在针对 `ReplicatedMergeTree*` 表引擎系列执行 `ON CLUSTER` 时，`DROP`、`TRUNCATE` 和 `OPTIMIZE` 查询被重复执行的问题。[#4991](https://github.com/ClickHouse/ClickHouse/pull/4991) ([alesapin](https://github.com/alesapin))



#### 向后不兼容的变更 {#backward-incompatible-change-8}

- 将设置 `insert_sample_with_metadata` 重命名为 `input_format_defaults_for_omitted_fields`。 [#4771](https://github.com/ClickHouse/ClickHouse/pull/4771) ([Artem Zuikov](https://github.com/4ertus2))
- 新增设置 `max_partitions_per_insert_block`（默认值为 100）。如果插入的数据块包含的分区数量大于该值，将抛出异常。如果希望移除此限制，可将其设置为 0（不推荐）。 [#4845](https://github.com/ClickHouse/ClickHouse/pull/4845) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 多重搜索函数被重命名（`multiPosition` 重命名为 `multiSearchAllPositions`，`multiSearch` 重命名为 `multiSearchAny`，`firstMatch` 重命名为 `multiSearchFirstIndex`）。 [#4780](https://github.com/ClickHouse/ClickHouse/pull/4780) ([Danila Kutenin](https://github.com/danlark1))

#### 性能改进 {#performance-improvement-6}

- 通过内联优化 Volnitsky 搜索器，对于包含大量待查模式（needles）或许多相似二元组（bigrams）的查询，可带来约 5–10% 的搜索性能提升。 [#4862](https://github.com/ClickHouse/ClickHouse/pull/4862) ([Danila Kutenin](https://github.com/danlark1))
- 修复在 `use_uncompressed_cache` 设置大于 0 且所有读取数据都在缓存中的情况下出现的性能问题。 [#4913](https://github.com/ClickHouse/ClickHouse/pull/4913) ([alesapin](https://github.com/alesapin))

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-10}



- 加强 debug 构建：更细粒度的内存映射和 ASLR；为 mark 缓存和索引添加内存保护。这有助于在 ASan 和 MSan 无法捕获问题时发现更多内存踩踏类 bug。[#4632](https://github.com/ClickHouse/ClickHouse/pull/4632) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 增加对 cmake 变量 `ENABLE_PROTOBUF`、`ENABLE_PARQUET` 和 `ENABLE_BROTLI` 的支持，从而可以启用/禁用上述特性（与我们对 librdkafka、mysql 等所做的类似）。[#4669](https://github.com/ClickHouse/ClickHouse/pull/4669) ([Silviu Caragea](https://github.com/silviucpp))
- 增加在测试运行结束后，当某些查询挂起时打印进程列表以及所有线程堆栈跟踪的能力。[#4675](https://github.com/ClickHouse/ClickHouse/pull/4675) ([alesapin](https://github.com/alesapin))
- 在 `clickhouse-test` 中对 `Connection loss` 错误添加重试逻辑。[#4682](https://github.com/ClickHouse/ClickHouse/pull/4682) ([alesapin](https://github.com/alesapin))
- 在打包脚本中增加基于 Vagrant 的 FreeBSD 构建以及基于 Thread Sanitizer 的构建。[#4712](https://github.com/ClickHouse/ClickHouse/pull/4712) [#4748](https://github.com/ClickHouse/ClickHouse/pull/4748) ([alesapin](https://github.com/alesapin))
- 安装过程中现在会要求用户为 `'default'` 用户设置密码。[#4725](https://github.com/ClickHouse/ClickHouse/pull/4725) ([proller](https://github.com/proller))
- 在 `rdkafka` 库中抑制警告。[#4740](https://github.com/ClickHouse/ClickHouse/pull/4740) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 允许在构建时关闭 SSL 支持。[#4750](https://github.com/ClickHouse/ClickHouse/pull/4750) ([proller](https://github.com/proller))
- 新增一种方式，以自定义用户身份运行 clickhouse-server 镜像。[#4753](https://github.com/ClickHouse/ClickHouse/pull/4753) ([Mikhail f. Shiryaev](https://github.com/Felixoid))
- 将 contrib 中的 boost 升级到 1.69。[#4793](https://github.com/ClickHouse/ClickHouse/pull/4793) ([proller](https://github.com/proller))
- 在使用 Thread Sanitizer 编译时禁用 `mremap` 的使用。出乎意料的是，TSan 不会拦截 `mremap`（尽管会拦截 `mmap`、`munmap`），这会导致误报。已修复有状态测试中的 TSan 报告。[#4859](https://github.com/ClickHouse/ClickHouse/pull/4859) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 添加通过 HTTP 接口使用 format schema 的测试用例。[#4864](https://github.com/ClickHouse/ClickHouse/pull/4864) ([Vitaly Baranov](https://github.com/vitlibar))



## ClickHouse 版本 19.4 {#clickhouse-release-19-4}

### ClickHouse 版本 19.4.4.33，2019-04-17 {#clickhouse-release-19-4-4-33-2019-04-17}

#### 错误修复 {#bug-fixes-7}



* 避免在内存分配失败时调用 `std::terminate`。现在会按预期抛出 `std::bad_alloc` 异常。[#4665](https://github.com/ClickHouse/ClickHouse/pull/4665) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了 `capnproto` 从缓冲区读取的问题。有时文件无法通过 HTTP 成功加载。[#4674](https://github.com/ClickHouse/ClickHouse/pull/4674) ([Vladislav](https://github.com/smirnov-vs))
* 修复在执行 `OPTIMIZE TABLE FINAL` 查询后出现的错误 `Unknown log entry type: 0`。 [#4683](https://github.com/ClickHouse/ClickHouse/pull/4683) ([Amos Bird](https://github.com/amosbird))
* 向 `hasAny` 或 `hasAll` 函数传入错误参数可能会导致段错误。 [#4698](https://github.com/ClickHouse/ClickHouse/pull/4698) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 在执行 `DROP DATABASE dictionary` 查询时可能会发生死锁。 [#4701](https://github.com/ClickHouse/ClickHouse/pull/4701) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复 `median` 和 `quantile` 函数中的未定义行为。 [#4702](https://github.com/ClickHouse/ClickHouse/pull/4702) ([hcz](https://github.com/hczhcz))
* 修复当 `network_compression_method` 使用小写时的压缩级别检测问题。该问题存在于 v19.1 版本中。[#4706](https://github.com/ClickHouse/ClickHouse/pull/4706) ([proller](https://github.com/proller))
* 修复了忽略 `<timezone>UTC</timezone>` 设置的问题（修复了 issue [#4658](https://github.com/ClickHouse/ClickHouse/issues/4658)）。 [#4718](https://github.com/ClickHouse/ClickHouse/pull/4718) ([proller](https://github.com/proller))
* 修正 `Distributed` 表上 `histogram` 函数的行为。 [#4741](https://github.com/ClickHouse/ClickHouse/pull/4741) ([olegkv](https://github.com/olegkv))
* 修复了 tsan 报告的 `destroy of a locked mutex` 问题。 [#4742](https://github.com/ClickHouse/ClickHouse/pull/4742) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了由于系统日志使用中的竞争条件导致在关闭过程中触发的 TSan 报告。修复了在启用 part&#95;log 时，关闭时可能出现的 use-after-free 问题。 [#4758](https://github.com/ClickHouse/ClickHouse/pull/4758) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 在出错时修复 `ReplicatedMergeTreeAlterThread` 中对数据部件的重新检查。 [#4772](https://github.com/ClickHouse/ClickHouse/pull/4772) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* 对中间 `aggregate function` 状态执行算术运算在处理常量参数（例如子查询结果）时无法正常工作。[#4776](https://github.com/ClickHouse/ClickHouse/pull/4776)（[alexey-milovidov](https://github.com/alexey-milovidov)）
* 在元数据中始终使用反引号括起列名。否则将无法创建名为 `index` 的列（服务器会因为元数据中格式错误的 `ATTACH` 查询而无法重启）。 [#4782](https://github.com/ClickHouse/ClickHouse/pull/4782) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复在 `Distributed` 表上执行 `ALTER ... MODIFY ORDER BY` 时的崩溃问题。 [#4790](https://github.com/ClickHouse/ClickHouse/pull/4790) ([TCeason](https://github.com/TCeason))
* 修复在启用 `enable_optimize_predicate_expression` 时 `JOIN ON` 出现的段错误。 [#4794](https://github.com/ClickHouse/ClickHouse/pull/4794) ([Winter Zhang](https://github.com/zhang2014))
* 修复从 Kafka 消费 protobuf 消息后多出一行的错误。[#4808](https://github.com/ClickHouse/ClickHouse/pull/4808) ([Vitaly Baranov](https://github.com/vitlibar))
* 修复 `clickhouse-copier` 中的段错误。 [#4835](https://github.com/ClickHouse/ClickHouse/pull/4835) ([proller](https://github.com/proller))
* 修复了在对 `system.tables` 执行 `SELECT` 时，表被并发重命名或修改所导致的竞争问题。 [#4836](https://github.com/ClickHouse/ClickHouse/pull/4836) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了在获取已过期数据部件时出现的数据竞争问题。 [#4839](https://github.com/ClickHouse/ClickHouse/pull/4839) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了在对 MergeTree 系列表执行 `RENAME TABLE` 操作时可能发生的罕见数据竞争问题。 [#4844](https://github.com/ClickHouse/ClickHouse/pull/4844) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了函数 `arrayIntersect` 的段错误。当以常量参数和普通参数混用的方式调用该函数时，可能会发生段错误。 [#4847](https://github.com/ClickHouse/ClickHouse/pull/4847) ([Lixiang Qian](https://github.com/fancyqlx))
* 修复了在罕见情况下从 `Array(LowCardinality)` 列读取数据的问题，该问题会在列包含长序列空数组时出现。 [#4850](https://github.com/ClickHouse/ClickHouse/pull/4850) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* 修复在副本之间获取数据分片时出现的 `No message received` 异常。[#4856](https://github.com/ClickHouse/ClickHouse/pull/4856) ([alesapin](https://github.com/alesapin))
* 修复在单个数组中存在多个重复值时，`arrayIntersect` 函数返回结果错误的问题。 [#4871](https://github.com/ClickHouse/ClickHouse/pull/4871) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* 修复并发执行 `ALTER COLUMN` 查询时的竞争条件，该问题可能导致服务器崩溃（修复问题 [#3421](https://github.com/ClickHouse/ClickHouse/issues/3421)）。[#4592](https://github.com/ClickHouse/ClickHouse/pull/4592)（[Alex Zatelepin](https://github.com/ztlpn)）
* 在未指定列类型时，修复对列 `CODEC` 执行 `ALTER MODIFY` 时的参数推导逻辑。 [#4883](https://github.com/ClickHouse/ClickHouse/pull/4883) ([alesapin](https://github.com/alesapin))
* 函数 `cutQueryStringAndFragment()` 和 `queryStringAndFragment()` 现在在 `URL` 包含片段但没有查询字符串时可以正确工作。[#4894](https://github.com/ClickHouse/ClickHouse/pull/4894) ([Vitaly Baranov](https://github.com/vitlibar))
* 修复在将 `min_bytes_to_use_direct_io` 设置为大于零时出现的罕见错误，该错误会在线程需要在列文件中向后移动读指针时触发。 [#4897](https://github.com/ClickHouse/ClickHouse/pull/4897) ([alesapin](https://github.com/alesapin))
* 修正聚合函数在处理 `LowCardinality` 参数时的参数类型错误（修复 issue [#4919](https://github.com/ClickHouse/ClickHouse/issues/4919)）。[#4922](https://github.com/ClickHouse/ClickHouse/pull/4922)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）
* 修复 `toISOWeek` 函数在 1970 年的结果。[#4988](https://github.com/ClickHouse/ClickHouse/pull/4988)（[alexey-milovidov](https://github.com/alexey-milovidov)）
* 修复在 `ReplicatedMergeTree*` 表族上使用 `ON CLUSTER` 执行 `DROP`、`TRUNCATE` 和 `OPTIMIZE` 查询时出现的重复执行问题。[#4991](https://github.com/ClickHouse/ClickHouse/pull/4991) ([alesapin](https://github.com/alesapin))



#### 改进 {#improvements-2}

- 将普通列、`DEFAULT`、`MATERIALIZED` 和 `ALIAS` 列维护在同一个列表中（修复问题 [#2867](https://github.com/ClickHouse/ClickHouse/issues/2867)）。[#4707](https://github.com/ClickHouse/ClickHouse/pull/4707)（[Alex Zatelepin](https://github.com/ztlpn)）

### ClickHouse 版本 19.4.3.11，2019-04-02 {#clickhouse-release-19-4-3-11-2019-04-02}

#### 错误修复 {#bug-fixes-8}

- 修复在 `FULL/RIGHT JOIN` 中，当连接条件一侧为 Nullable 而另一侧为非 Nullable 时发生的崩溃。[#4855](https://github.com/ClickHouse/ClickHouse/pull/4855)（[Artem Zuikov](https://github.com/4ertus2)）
- 修复 `clickhouse-copier` 中的段错误（segmentation fault）。[#4835](https://github.com/ClickHouse/ClickHouse/pull/4835)（[proller](https://github.com/proller)）

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-11}

- 新增一种方式，可以以自定义用户身份运行 clickhouse-server 镜像。[#4753](https://github.com/ClickHouse/ClickHouse/pull/4753)（[Mikhail f. Shiryaev](https://github.com/Felixoid)）

### ClickHouse 版本 19.4.2.7，2019-03-30 {#clickhouse-release-19-4-2-7-2019-03-30}

#### 错误修复 {#bug-fixes-9}

- 修复在罕见情况下，从 `Array(LowCardinality)` 列读取数据时的问题：当列包含一长串空数组时会出错。[#4850](https://github.com/ClickHouse/ClickHouse/pull/4850)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）

### ClickHouse 版本 19.4.1.3，2019-03-19 {#clickhouse-release-19-4-1-3-2019-03-19}

#### 错误修复 {#bug-fixes-10}

- 修复包含 `LIMIT BY` 和 `LIMIT` 的远程查询。在此之前，如果远程查询同时使用 `LIMIT BY` 和 `LIMIT`，`LIMIT` 可能会先于 `LIMIT BY` 执行，从而导致结果被过滤得过多。[#4708](https://github.com/ClickHouse/ClickHouse/pull/4708)（[Constantin S. Pan](https://github.com/kvap)）

### ClickHouse 版本 19.4.0.49，2019-03-09 {#clickhouse-release-19-4-0-49-2019-03-09}

#### 新功能 {#new-features-5}



- 为 `Protobuf` 格式添加了完整支持（输入、输出以及嵌套数据结构）。[#4174](https://github.com/ClickHouse/ClickHouse/pull/4174) [#4493](https://github.com/ClickHouse/ClickHouse/pull/4493) ([Vitaly Baranov](https://github.com/vitlibar))
- 基于 Roaring Bitmaps 新增了位图函数。[#4207](https://github.com/ClickHouse/ClickHouse/pull/4207) ([Andy Yang](https://github.com/andyyzh)) [#4568](https://github.com/ClickHouse/ClickHouse/pull/4568) ([Vitaly Baranov](https://github.com/vitlibar))
- 新增对 Parquet 格式的支持。[#4448](https://github.com/ClickHouse/ClickHouse/pull/4448) ([proller](https://github.com/proller))
- 为模糊字符串比较新增了 N-gram 距离，类似于 R 语言中的 q-gram 度量。[#4466](https://github.com/ClickHouse/ClickHouse/pull/4466) ([Danila Kutenin](https://github.com/danlark1))
- 将 Graphite rollup 规则从独立的聚合和保留模式中进行了合并。[#4426](https://github.com/ClickHouse/ClickHouse/pull/4426) ([Mikhail f. Shiryaev](https://github.com/Felixoid))
- 添加了 `max_execution_speed` 和 `max_execution_speed_bytes` 设置以限制资源使用，新增的 `min_execution_speed_bytes` 设置用于补充 `min_execution_speed`。[#4430](https://github.com/ClickHouse/ClickHouse/pull/4430) ([Winter Zhang](https://github.com/zhang2014))
- 实现了函数 `flatten`。[#4555](https://github.com/ClickHouse/ClickHouse/pull/4555) [#4409](https://github.com/ClickHouse/ClickHouse/pull/4409) ([alexey-milovidov](https://github.com/alexey-milovidov), [kzon](https://github.com/kzon))
- 添加了函数 `arrayEnumerateDenseRanked` 和 `arrayEnumerateUniqRanked`（类似于 `arrayEnumerateUniq`，但允许精细控制数组深度，以便查看多维数组内部）。[#4475](https://github.com/ClickHouse/ClickHouse/pull/4475) ([proller](https://github.com/proller)) [#4601](https://github.com/ClickHouse/ClickHouse/pull/4601) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 支持多表 JOIN（有部分限制：不支持使用星号，不支持在 ON/WHERE/GROUP BY/… 中使用复杂别名）。[#4462](https://github.com/ClickHouse/ClickHouse/pull/4462) ([Artem Zuikov](https://github.com/4ertus2))

#### Bug 修复 {#bug-fixes-11}



* 本次发布还包含 19.3 和 19.1 中的所有错误修复。
* 修复了数据跳过索引中的一个错误：在执行 `INSERT` 后 granule 的顺序不正确。[#4407](https://github.com/ClickHouse/ClickHouse/pull/4407) ([Nikita Vasilev](https://github.com/nikvas0))
* 修复了 `Nullable` 和 `LowCardinality` 列上的 `set` 索引。此前，在 `Nullable` 或 `LowCardinality` 列上使用 `set` 索引，在执行查询时会导致错误 `Data type must be deserialized with multiple streams`。 [#4594](https://github.com/ClickHouse/ClickHouse/pull/4594) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* 在执行 `executable` 字典的全量更新时正确设置 update&#95;time。 [#4551](https://github.com/ClickHouse/ClickHouse/pull/4551) ([Tema Novikov](https://github.com/temoon))
* 修复 19.3 中损坏的进度条。 [#4627](https://github.com/ClickHouse/ClickHouse/pull/4627) ([filimonov](https://github.com/filimonov))
* 在某些情况下，当内存区域收缩时，修复了 MemoryTracker 记录值不一致的问题。 [#4619](https://github.com/ClickHouse/ClickHouse/pull/4619) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了 `ThreadPool` 中的未定义行为。[#4612](https://github.com/ClickHouse/ClickHouse/pull/4612) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了一个极其罕见的崩溃问题，其报错信息为 `mutex lock failed: Invalid argument`，该问题可能在执行 SELECT 的同时并发删除 MergeTree 表时出现。[#4608](https://github.com/ClickHouse/ClickHouse/pull/4608) ([Alex Zatelepin](https://github.com/ztlpn))
* ODBC 驱动对 `LowCardinality` 数据类型的兼容性。[#4381](https://github.com/ClickHouse/ClickHouse/pull/4381) ([proller](https://github.com/proller))
* FreeBSD：修复 `AIOcontextPool: Found io_event with unknown id 0` 错误。[#4438](https://github.com/ClickHouse/ClickHouse/pull/4438) ([urgordeadbeef](https://github.com/urgordeadbeef))
* 无论配置如何，都会创建 `system.part_log` 表。[#4483](https://github.com/ClickHouse/ClickHouse/pull/4483) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复缓存字典中 `dictIsIn` 函数的未定义行为。 [#4515](https://github.com/ClickHouse/ClickHouse/pull/4515) ([alesapin](https://github.com/alesapin))
* 修复了这样一种死锁问题：在存在并发 DDL 查询时，当一个 SELECT 查询多次锁定同一张表（例如由不同线程发起或在执行多个子查询时）会导致死锁。 [#4535](https://github.com/ClickHouse/ClickHouse/pull/4535) ([Alex Zatelepin](https://github.com/ztlpn))
* 默认禁用 `compile_expressions`，直到我们引入自有的 `llvm` contrib 并可以使用 `clang` 和 `asan` 对其进行测试。[#4579](https://github.com/ClickHouse/ClickHouse/pull/4579) ([alesapin](https://github.com/alesapin))
* 当 `clickhouse` 外部字典源的 `invalidate_query` 返回不正确的结果集（为空、包含多于一行或多于一列）时，避免调用 `std::terminate`。修复了一个问题：无论 `lifetime` 设置如何，`invalidate_query` 都会每隔五秒执行一次。 [#4583](https://github.com/ClickHouse/ClickHouse/pull/4583) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 在对以 `clickhouse` 为源的字典执行 `invalidate_query` 且该查询涉及 `system.dictionaries` 表或 `Dictionaries` 数据库时，避免发生死锁（较为罕见的情况）。 [#4599](https://github.com/ClickHouse/ClickHouse/pull/4599) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了在 `WHERE` 为空时的 `CROSS JOIN` 行为。[#4598](https://github.com/ClickHouse/ClickHouse/pull/4598) ([Artem Zuikov](https://github.com/4ertus2))
* 修复了在向函数 `replicate` 传递常量参数时发生的段错误。 [#4603](https://github.com/ClickHouse/ClickHouse/pull/4603) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复谓词优化器中对 lambda 函数的处理。 [#4408](https://github.com/ClickHouse/ClickHouse/pull/4408) ([Winter Zhang](https://github.com/zhang2014))
* 多个 JOIN，多处修复。 [#4595](https://github.com/ClickHouse/ClickHouse/pull/4595) ([Artem Zuikov](https://github.com/4ertus2))



#### 改进 {#improvements-3}

- 支持在 JOIN ON 子句中为右表列使用别名。 [#4412](https://github.com/ClickHouse/ClickHouse/pull/4412) ([Artem Zuikov](https://github.com/4ertus2))
- 多个 JOIN 的结果在子查询中使用时需要正确的结果列名。在结果中用源名称替换扁平别名。 [#4474](https://github.com/ClickHouse/ClickHouse/pull/4474) ([Artem Zuikov](https://github.com/4ertus2))
- 改进对包含 JOIN 的语句的下推逻辑。 [#4387](https://github.com/ClickHouse/ClickHouse/pull/4387) ([Ivan](https://github.com/abyss7))

#### 性能改进 {#performance-improvements-3}

- 改进“move to PREWHERE”优化的启发式规则。 [#4405](https://github.com/ClickHouse/ClickHouse/pull/4405) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 使用针对 8 位和 16 位键、基于 HashTable API 的合适查找表。 [#4536](https://github.com/ClickHouse/ClickHouse/pull/4536) ([Amos Bird](https://github.com/amosbird))
- 提升字符串比较的性能。 [#4564](https://github.com/ClickHouse/ClickHouse/pull/4564) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 在单独的线程中清理分布式 DDL 队列，从而不会减慢处理分布式 DDL 任务的主循环。 [#4502](https://github.com/ClickHouse/ClickHouse/pull/4502) ([Alex Zatelepin](https://github.com/ztlpn))
- 当 `min_bytes_to_use_direct_io` 被设置为 1 时，并非每个文件都以 O_DIRECT 模式打开，因为要读取的数据量有时会被低估为仅一个压缩块的大小。 [#4526](https://github.com/ClickHouse/ClickHouse/pull/4526) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-12}



- 增加对 clang-9 的支持 [#4604](https://github.com/ClickHouse/ClickHouse/pull/4604) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复错误的 `__asm__` 指令（再次修复） [#4621](https://github.com/ClickHouse/ClickHouse/pull/4621) ([Konstantin Podshumok](https://github.com/podshumok))
- 添加从命令行为 `clickhouse-performance-test` 指定设置的功能。 [#4437](https://github.com/ClickHouse/ClickHouse/pull/4437) ([alesapin](https://github.com/alesapin))
- 将字典测试添加到集成测试中。 [#4477](https://github.com/ClickHouse/ClickHouse/pull/4477) ([alesapin](https://github.com/alesapin))
- 将网站上基准测试中的查询添加到自动化性能测试中。 [#4496](https://github.com/ClickHouse/ClickHouse/pull/4496) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 外部 lz4 中不存在 `xxhash.h`，因为它是实现细节，其符号使用 `XXH_NAMESPACE` 宏进行命名空间处理。当 lz4 作为外部库使用时，xxHash 也必须作为外部库使用，并且依赖方必须与其链接。 [#4495](https://github.com/ClickHouse/ClickHouse/pull/4495) ([Orivej Desh](https://github.com/orivej))
- 修复了 `quantileTiming` 聚合函数可以使用负数或浮点参数调用的情况（从而修复了使用未定义行为检测器（sanitizer）的 fuzz 测试）。 [#4506](https://github.com/ClickHouse/ClickHouse/pull/4506) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 拼写错误修正。 [#4531](https://github.com/ClickHouse/ClickHouse/pull/4531) ([sdk2](https://github.com/sdk2))
- 修复在 Mac 上的编译问题。 [#4371](https://github.com/ClickHouse/ClickHouse/pull/4371) ([Vitaly Baranov](https://github.com/vitlibar))
- 修复 FreeBSD 和多种非常规构建配置下的构建问题。 [#4444](https://github.com/ClickHouse/ClickHouse/pull/4444) ([proller](https://github.com/proller))



## ClickHouse 发行版 19.3 {#clickhouse-release-19-3}

### ClickHouse 发行版 19.3.9.1，2019-04-02 {#clickhouse-release-19-3-9-1-2019-04-02}

#### Bug 修复 {#bug-fixes-12}

- 修复在对可为空与不可为空列进行 `FULL/RIGHT JOIN` 时发生的崩溃。 [#4855](https://github.com/ClickHouse/ClickHouse/pull/4855) ([Artem Zuikov](https://github.com/4ertus2))
- 修复 `clickhouse-copier` 中的段错误。 [#4835](https://github.com/ClickHouse/ClickHouse/pull/4835) ([proller](https://github.com/proller))
- 修复在列包含长序列空数组这一少见情况下，从 `Array(LowCardinality)` 列读取数据的问题。 [#4850](https://github.com/ClickHouse/ClickHouse/pull/4850) ([Nikolai Kochetov](https://github.com/KochetovNicolai))

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-13}

- 增加了一种以自定义用户启动 clickhouse-server 镜像的方式。 [#4753](https://github.com/ClickHouse/ClickHouse/pull/4753) ([Mikhail f. Shiryaev](https://github.com/Felixoid))

### ClickHouse 发行版 19.3.7，2019-03-12 {#clickhouse-release-19-3-7-2019-03-12}

#### Bug 修复 {#bug-fixes-13}

- 修复了 #3920 中的错误。该错误表现为随机的缓存损坏（消息为 `Unknown codec family code`、`Cannot seek through file`）以及段错误。此 Bug 首次出现在 19.1 版本，并存在于 19.1.10 和 19.3.6 之前的版本中。 [#4623](https://github.com/ClickHouse/ClickHouse/pull/4623) ([alexey-milovidov](https://github.com/alexey-milovidov))

### ClickHouse 发行版 19.3.6，2019-03-02 {#clickhouse-release-19-3-6-2019-03-02}

#### Bug 修复 {#bug-fixes-14}

- 当线程池中有超过 1000 个线程时，在线程退出时可能会触发 `std::terminate`。 [Azat Khuzhin](https://github.com/azat) [#4485](https://github.com/ClickHouse/ClickHouse/pull/4485) [#4505](https://github.com/ClickHouse/ClickHouse/pull/4505) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 现在可以创建 `ReplicatedMergeTree*` 表，这些表可以在无默认值的列上添加注释，也可以创建包含列级 codec 且没有注释和默认值的表。同时还修复了 codec 的比较。 [#4523](https://github.com/ClickHouse/ClickHouse/pull/4523) ([alesapin](https://github.com/alesapin))
- 修复了使用数组或元组进行 JOIN 时的崩溃。 [#4552](https://github.com/ClickHouse/ClickHouse/pull/4552) ([Artem Zuikov](https://github.com/4ertus2))
- 修复了 clickhouse-copier 中带有 `ThreadStatus not created` 消息的崩溃。 [#4540](https://github.com/ClickHouse/ClickHouse/pull/4540) ([Artem Zuikov](https://github.com/4ertus2))
- 修复了在使用分布式 DDL 时，服务器关闭时发生的卡死问题。 [#4472](https://github.com/ClickHouse/ClickHouse/pull/4472) ([Alex Zatelepin](https://github.com/ztlpn))
- 修复了在解析列号大于 10 的文本格式时，错误消息中打印的列号不正确的问题。 [#4484](https://github.com/ClickHouse/ClickHouse/pull/4484) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### 构建/测试/打包改进 {#buildtestingpackaging-improvements-3}



- 修复了启用 AVX 时的构建问题。[#4527](https://github.com/ClickHouse/ClickHouse/pull/4527) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 基于已知稳定的内核版本启用扩展记账和 IO 记账，而不是基于编译时所在的内核版本。[#4541](https://github.com/ClickHouse/ClickHouse/pull/4541) ([nvartolomei](https://github.com/nvartolomei))
- 允许跳过对 `core_dump.size_limit` 的设置，当设置限制失败时发出警告而不是抛出异常。[#4473](https://github.com/ClickHouse/ClickHouse/pull/4473) ([proller](https://github.com/proller))
- 移除了 `Field.cpp` 中 `void readBinary(...)` 的 `inline` 关键字。同时合并了多余的 `namespace DB` 代码块。[#4530](https://github.com/ClickHouse/ClickHouse/pull/4530) ([hcz](https://github.com/hczhcz))

### ClickHouse Release 19.3.5，2019-02-21 {#clickhouse-release-19-3-5-2019-02-21}

#### Bug 修复 {#bug-fixes-15}

- 修复了处理大型 HTTP 插入查询时的错误。[#4454](https://github.com/ClickHouse/ClickHouse/pull/4454) ([alesapin](https://github.com/alesapin))
- 修复了由于 `send_logs_level` 设置实现错误导致的与旧版本的向后不兼容问题。[#4445](https://github.com/ClickHouse/ClickHouse/pull/4445) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了在引入列注释后，表函数 `remote` 的向后不兼容问题。[#4446](https://github.com/ClickHouse/ClickHouse/pull/4446) ([alexey-milovidov](https://github.com/alexey-milovidov))

### ClickHouse Release 19.3.4，2019-02-16 {#clickhouse-release-19-3-4-2019-02-16}

#### 改进 {#improvements-4}

- 在执行 `ATTACH TABLE` 查询时，表索引大小不再计入内存限制，从而避免了表在被 `DETACH` 之后无法再次 `ATTACH` 的情况。[#4396](https://github.com/ClickHouse/ClickHouse/pull/4396) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 略微提高了从 ZooKeeper 接收的最大字符串和数组大小限制。这允许在 ZooKeeper 上使用更大的 `CLIENT_JVMFLAGS=-Djute.maxbuffer=...` 配置后仍能继续工作。[#4398](https://github.com/ClickHouse/ClickHouse/pull/4398) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 即使副本在其队列中已经存在大量节点，也允许修复被遗弃的副本。[#4399](https://github.com/ClickHouse/ClickHouse/pull/4399) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 为 `SET` 索引增加了一个必需参数（最大存储行数）。[#4386](https://github.com/ClickHouse/ClickHouse/pull/4386) ([Nikita Vasilev](https://github.com/nikvas0))

#### Bug 修复 {#bug-fixes-16}

- 修复了按单个 `LowCardinality` 键分组时 `WITH ROLLUP` 结果错误的问题。[#4384](https://github.com/ClickHouse/ClickHouse/pull/4384) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- 修复了集合索引中的错误（当一个粒度包含超过 `max_rows` 行时会删除该粒度）。[#4386](https://github.com/ClickHouse/ClickHouse/pull/4386) ([Nikita Vasilev](https://github.com/nikvas0))
- 大量针对 FreeBSD 的构建修复。[#4397](https://github.com/ClickHouse/ClickHouse/pull/4397) ([proller](https://github.com/proller))
- 修复了在包含相同别名的子查询中进行别名替换时的问题（issue [#4110](https://github.com/ClickHouse/ClickHouse/issues/4110)）。[#4351](https://github.com/ClickHouse/ClickHouse/pull/4351) ([Artem Zuikov](https://github.com/4ertus2))



#### 构建/测试/打包改进 {#buildtestingpackaging-improvements-4}

- 在 Docker 镜像中支持以无状态测试模式运行 `clickhouse-server`。[#4347](https://github.com/ClickHouse/ClickHouse/pull/4347) ([Vasily Nemkov](https://github.com/Enmk))

### ClickHouse 发布 19.3.3，2019-02-13 {#clickhouse-release-19-3-3-2019-02-13}

#### 新功能 {#new-features-6}



- 新增 `KILL MUTATION` 语句，用于删除由于某些原因卡住的 mutation。向 `system.mutations` 表中添加了 `latest_failed_part`、`latest_fail_time`、`latest_fail_reason` 字段，便于排查问题。 [#4287](https://github.com/ClickHouse/ClickHouse/pull/4287) ([Alex Zatelepin](https://github.com/ztlpn))
- 新增聚合函数 `entropy`，用于计算香农熵（Shannon entropy）。 [#4238](https://github.com/ClickHouse/ClickHouse/pull/4238) ([Quid37](https://github.com/Quid37))
- 现在可以向服务器发送 `INSERT INTO tbl VALUES (....` 查询，而无需拆分为 `query` 和 `data` 部分。 [#4301](https://github.com/ClickHouse/ClickHouse/pull/4301) ([alesapin](https://github.com/alesapin))
- 新增 `arrayWithConstant` 函数的通用实现。 [#4322](https://github.com/ClickHouse/ClickHouse/pull/4322) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 实现了 `NOT BETWEEN` 比较运算符。 [#4228](https://github.com/ClickHouse/ClickHouse/pull/4228) ([Dmitry Naumov](https://github.com/nezed))
- 实现 `sumMapFiltered`，以便能够限制由 `sumMap` 参与求和的键的数量。 [#4129](https://github.com/ClickHouse/ClickHouse/pull/4129) ([Léo Ercolanelli](https://github.com/ercolanelli-leo))
- 在 `mysql` table function 中增加了对 `Nullable` 类型的支持。 [#4198](https://github.com/ClickHouse/ClickHouse/pull/4198) ([Emmanuel Donin de Rosière](https://github.com/edonin))
- 在 `LIMIT` 子句中支持任意常量表达式。 [#4246](https://github.com/ClickHouse/ClickHouse/pull/4246) ([k3box](https://github.com/k3box))
- 新增 `topKWeighted` 聚合函数，它接收一个额外的（无符号整数）权重参数。 [#4245](https://github.com/ClickHouse/ClickHouse/pull/4245) ([Andrew Golman](https://github.com/andrewgolman))
- `StorageJoin` 现在支持 `join_any_take_last_row` 设置，允许覆盖相同键的现有值。 [#3973](https://github.com/ClickHouse/ClickHouse/pull/3973) ([Amos Bird](https://github.com/amosbird))
- 新增函数 `toStartOfInterval`。 [#4304](https://github.com/ClickHouse/ClickHouse/pull/4304) ([Vitaly Baranov](https://github.com/vitlibar))
- 新增 `RowBinaryWithNamesAndTypes` 格式。 [#4200](https://github.com/ClickHouse/ClickHouse/pull/4200) ([Oleg V. Kozlyuk](https://github.com/DarkWanderer))
- 新增 `IPv4` 和 `IPv6` 数据类型，并对 `IPv*` 函数进行了更高效的实现。 [#3669](https://github.com/ClickHouse/ClickHouse/pull/3669) ([Vasily Nemkov](https://github.com/Enmk))
- 新增函数 `toStartOfTenMinutes()`。 [#4298](https://github.com/ClickHouse/ClickHouse/pull/4298) ([Vitaly Baranov](https://github.com/vitlibar))
- 新增 `Protobuf` 输出格式。 [#4005](https://github.com/ClickHouse/ClickHouse/pull/4005) [#4158](https://github.com/ClickHouse/ClickHouse/pull/4158) ([Vitaly Baranov](https://github.com/vitlibar))
- 为用于数据导入（INSERT）的 HTTP 接口添加了 brotli 支持。 [#4235](https://github.com/ClickHouse/ClickHouse/pull/4235) ([Mikhail](https://github.com/fandyushin))
- 当用户在命令行客户端中输入的函数名或类型存在拼写错误时，新增提示信息。 [#4239](https://github.com/ClickHouse/ClickHouse/pull/4239) ([Danila Kutenin](https://github.com/danlark1))
- 在服务器的 HTTP 响应头中添加了 `Query-Id`。 [#4231](https://github.com/ClickHouse/ClickHouse/pull/4231) ([Mikhail](https://github.com/fandyushin))

#### 实验性特性 {#experimental-features-2}



- 为 MergeTree 表引擎系列新增了 `minmax` 和 `set` 数据跳过索引。[#4143](https://github.com/ClickHouse/ClickHouse/pull/4143) ([Nikita Vasilev](https://github.com/nikvas0))
- 在可能的情况下，将 `CROSS JOIN` 自动转换为 `INNER JOIN`。[#4221](https://github.com/ClickHouse/ClickHouse/pull/4221) [#4266](https://github.com/ClickHouse/ClickHouse/pull/4266) ([Artem Zuikov](https://github.com/4ertus2))

#### Bug 修复 {#bug-fixes-17}



* 修复了在 `JOIN ON` 部分中因重复列导致的 `Not found column` 错误。[#4279](https://github.com/ClickHouse/ClickHouse/pull/4279) ([Artem Zuikov](https://github.com/4ertus2))
* 使 `START REPLICATED SENDS` 命令真正开始执行复制发送。[#4229](https://github.com/ClickHouse/ClickHouse/pull/4229) ([nvartolomei](https://github.com/nvartolomei))
* 修复了在使用 `Array(LowCardinality)` 参数时聚合函数的执行问题。[#4055](https://github.com/ClickHouse/ClickHouse/pull/4055) ([KochetovNicolai](https://github.com/KochetovNicolai))
* 修复了在执行 `INSERT ... SELECT ... FROM file(...)` 查询时的错误行为：当文件格式为 `CSVWithNames` 或 `TSVWIthNames` 且缺少第一行数据时的处理。 [#4297](https://github.com/ClickHouse/ClickHouse/pull/4297) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了在字典不可用时重新加载字典导致的崩溃问题。该问题首次出现在 19.1.6 版本中。 [#4188](https://github.com/ClickHouse/ClickHouse/pull/4188) ([proller](https://github.com/proller))
* 修复了在右表包含重复行时的 `ALL JOIN`。 [#4184](https://github.com/ClickHouse/ClickHouse/pull/4184) ([Artem Zuikov](https://github.com/4ertus2))
* 修复了在 `use_uncompressed_cache=1` 时出现的段错误，以及因未压缩大小不正确而抛出的异常。此 Bug 出现在 19.1.6 版本中。 [#4186](https://github.com/ClickHouse/ClickHouse/pull/4186) ([alesapin](https://github.com/alesapin))
* 修复了在比较超过 int16 范围的日期时的 `compile_expressions` bug。 [#4341](https://github.com/ClickHouse/ClickHouse/pull/4341) ([alesapin](https://github.com/alesapin))
* 修复了从表函数 `numbers(0)` 查询时出现的无限循环问题。 [#4280](https://github.com/ClickHouse/ClickHouse/pull/4280) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 暂时禁用针对 `ORDER BY` 的谓词优化。 [#3890](https://github.com/ClickHouse/ClickHouse/pull/3890) ([Winter Zhang](https://github.com/zhang2014))
* 修复了在旧 CPU 上使用 base64 函数时出现的 `Illegal instruction` 错误。该错误目前仅在使用 gcc-8 编译 ClickHouse 时被复现。[#4275](https://github.com/ClickHouse/ClickHouse/pull/4275) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了通过 TLS 连接与 PostgreSQL ODBC Driver 交互时出现的 `No message received` 错误，同时也修复了使用 MySQL ODBC Driver 时发生的段错误。 [#4170](https://github.com/ClickHouse/ClickHouse/pull/4170) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了在条件运算符（函数 `if`）的分支中使用 `Date` 和 `DateTime` 参数时产生错误结果的问题。为函数 `if` 增加了通用情况支持。[#4243](https://github.com/ClickHouse/ClickHouse/pull/4243) ([alexey-milovidov](https://github.com/alexey-milovidov))
* ClickHouse 字典现在在 `clickhouse` 进程内加载。[#4166](https://github.com/ClickHouse/ClickHouse/pull/4166) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了在对 `File` 引擎的表执行 `SELECT` 时，在遇到 `No such file or directory` 错误后重试会导致死锁的问题。 [#4161](https://github.com/ClickHouse/ClickHouse/pull/4161) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了一个竞争条件，在从 `system.tables` 查询时可能导致报错 `table does not exist`。 [#4313](https://github.com/ClickHouse/ClickHouse/pull/4313) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 如果以交互模式运行，`clickhouse-client` 在退出时为命令行建议加载数据的过程中可能会发生段错误（segfault）。[#4317](https://github.com/ClickHouse/ClickHouse/pull/4317) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了一个错误：执行包含 `IN` 运算符的 mutation 时会产生错误结果。[#4099](https://github.com/ClickHouse/ClickHouse/pull/4099) ([Alex Zatelepin](https://github.com/ztlpn))
* 已修复错误：如果存在使用 `Dictionary` 引擎的数据库，所有字典会在服务器启动时被强制加载，而如果其中某个字典的 ClickHouse 源指向 localhost，则该字典无法加载。 [#4255](https://github.com/ClickHouse/ClickHouse/pull/4255) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了在服务器关闭期间再次尝试创建系统日志时出现的错误。[#4254](https://github.com/ClickHouse/ClickHouse/pull/4254) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 在 `joinGet` 函数中返回正确的类型并妥善处理锁。[#4153](https://github.com/ClickHouse/ClickHouse/pull/4153) ([Amos Bird](https://github.com/amosbird))
* 新增 `sumMapWithOverflow` 函数。 [#4151](https://github.com/ClickHouse/ClickHouse/pull/4151) ([Léo Ercolanelli](https://github.com/ercolanelli-leo))
* 修复了与 `allow_experimental_multiple_joins_emulation` 相关的段错误。 [52de2c](https://github.com/ClickHouse/ClickHouse/commit/52de2cd927f7b5257dd67e175f0a5560a48840d0) ([Artem Zuikov](https://github.com/4ertus2))
* 修复了 `Date` 和 `DateTime` 比较不正确的问题。[#4237](https://github.com/ClickHouse/ClickHouse/pull/4237) ([valexey](https://github.com/valexey))
* 修复了在启用 undefined behavior sanitizer 时的模糊测试：为 `quantile*Weighted` 函数族添加了参数类型检查。 [#4145](https://github.com/ClickHouse/ClickHouse/pull/4145) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了一个罕见的竞争条件，该问题会导致在删除旧数据部件时操作失败并出现 `File not found` 错误。 [#4378](https://github.com/ClickHouse/ClickHouse/pull/4378) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复安装包中缺少 `/etc/clickhouse-server/config.xml` 的情况。 [#4343](https://github.com/ClickHouse/ClickHouse/pull/4343) ([proller](https://github.com/proller))



#### 构建/测试/打包改进 {#buildtestingpackaging-improvements-5}

- Debian 包：根据配置修正 `/etc/clickhouse-server/preprocessed` 链接。 [#4205](https://github.com/ClickHouse/ClickHouse/pull/4205) ([proller](https://github.com/proller))
- 修复了多个针对 FreeBSD 的构建问题。 [#4225](https://github.com/ClickHouse/ClickHouse/pull/4225) ([proller](https://github.com/proller))
- 在 `perftest` 中增加了创建、填充和删除表的功能。 [#4220](https://github.com/ClickHouse/ClickHouse/pull/4220) ([alesapin](https://github.com/alesapin))
- 添加了用于检查重复 include 的脚本。 [#4326](https://github.com/ClickHouse/ClickHouse/pull/4326) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 在性能测试中增加了按索引运行查询的功能。 [#4264](https://github.com/ClickHouse/ClickHouse/pull/4264) ([alesapin](https://github.com/alesapin))
- 建议安装带有调试符号的包。 [#4274](https://github.com/ClickHouse/ClickHouse/pull/4274) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 重构了 `performance-test`，改进了日志记录和信号处理。 [#4171](https://github.com/ClickHouse/ClickHouse/pull/4171) ([alesapin](https://github.com/alesapin))
- 为匿名化的 Yandex.Metrica 数据集添加了文档。 [#4164](https://github.com/ClickHouse/ClickHouse/pull/4164) ([alesapin](https://github.com/alesapin))
- 添加了用于将旧的按月分区的分片转换为自定义分区格式的工具。 [#4195](https://github.com/ClickHouse/ClickHouse/pull/4195) ([Alex Zatelepin](https://github.com/ztlpn))
- 为 S3 中的两个数据集添加了文档。 [#4144](https://github.com/ClickHouse/ClickHouse/pull/4144) ([alesapin](https://github.com/alesapin))
- 添加了根据 pull request 描述生成变更日志的脚本。 [#4169](https://github.com/ClickHouse/ClickHouse/pull/4169) [#4173](https://github.com/ClickHouse/ClickHouse/pull/4173) ([KochetovNicolai](https://github.com/KochetovNicolai)) ([KochetovNicolai](https://github.com/KochetovNicolai))
- 为 ClickHouse 添加了 puppet 模块。 [#4182](https://github.com/ClickHouse/ClickHouse/pull/4182) ([Maxim Fedotov](https://github.com/MaxFedotov))
- 为一组未记录的函数添加了文档。 [#4168](https://github.com/ClickHouse/ClickHouse/pull/4168) ([Winter Zhang](https://github.com/zhang2014))
- 修复了 ARM 构建问题。 [#4210](https://github.com/ClickHouse/ClickHouse/pull/4210)[#4306](https://github.com/ClickHouse/ClickHouse/pull/4306) [#4291](https://github.com/ClickHouse/ClickHouse/pull/4291) ([proller](https://github.com/proller)) ([proller](https://github.com/proller))
- 现在可以通过 `ctest` 运行字典测试。 [#4189](https://github.com/ClickHouse/ClickHouse/pull/4189) ([proller](https://github.com/proller))
- 现在 `/etc/ssl` 被用作 SSL 证书的默认目录。 [#4167](https://github.com/ClickHouse/ClickHouse/pull/4167) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 在启动时添加了对 SSE 和 AVX 指令的检查。 [#4234](https://github.com/ClickHouse/ClickHouse/pull/4234) ([Igr](https://github.com/igron99))
- 初始化脚本现在会在服务器启动完成前一直等待。 [#4281](https://github.com/ClickHouse/ClickHouse/pull/4281) ([proller](https://github.com/proller))

#### 向后不兼容的变更 {#backward-incompatible-changes-1}



- 移除了 `allow_experimental_low_cardinality_type` 设置。`LowCardinality` 数据类型已可用于生产环境。[#4323](https://github.com/ClickHouse/ClickHouse/pull/4323) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 根据可用内存大小，相应减小 mark cache 和未压缩 cache 的大小。[#4240](https://github.com/ClickHouse/ClickHouse/pull/4240) ([Lopatin Konstantin](https://github.com/k-lopatin))
- 在 `CREATE TABLE` 查询中增加了关键字 `INDEX`。名为 `index` 的列必须使用反引号或双引号进行引用：`` `index` ``。[#4143](https://github.com/ClickHouse/ClickHouse/pull/4143) ([Nikita Vasilev](https://github.com/nikvas0))
- `sumMap` 现在会提升结果类型以避免溢出。旧的 `sumMap` 行为可以通过使用 `sumMapWithOverflow` 函数实现。[#4151](https://github.com/ClickHouse/ClickHouse/pull/4151) ([Léo Ercolanelli](https://github.com/ercolanelli-leo))

#### 性能改进 {#performance-improvements-4}

- 对于没有 `LIMIT` 的查询，将 `std::sort` 替换为 `pdqsort`。[#4236](https://github.com/ClickHouse/ClickHouse/pull/4236) ([Evgenii Pravda](https://github.com/kvinty))
- 现在服务器会复用全局线程池中的线程。这会在某些极端情况下影响性能。[#4150](https://github.com/ClickHouse/ClickHouse/pull/4150) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### 改进 {#improvements-5}



- 为 FreeBSD 实现了 AIO 支持。 [#4305](https://github.com/ClickHouse/ClickHouse/pull/4305) ([urgordeadbeef](https://github.com/urgordeadbeef))
- `SELECT * FROM a JOIN b USING a, b` 现在只返回左表中的 `a` 和 `b` 列。 [#4141](https://github.com/ClickHouse/ClickHouse/pull/4141) ([Artem Zuikov](https://github.com/4ertus2))
- 允许客户端选项 `-C` 像 `-c` 选项一样使用。 [#4232](https://github.com/ClickHouse/ClickHouse/pull/4232) ([syominsergey](https://github.com/syominsergey))
- 现在在不带参数使用选项 `--password` 时，会从 stdin 请求密码。 [#4230](https://github.com/ClickHouse/ClickHouse/pull/4230) ([BSD_Conqueror](https://github.com/bsd-conqueror))
- 为包含 `LIKE` 表达式或正则表达式的字符串字面量中未转义的元字符添加了高亮显示。 [#4327](https://github.com/ClickHouse/ClickHouse/pull/4327) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 添加了在客户端 socket 断开时取消 HTTP 只读查询的功能。 [#4213](https://github.com/ClickHouse/ClickHouse/pull/4213) ([nvartolomei](https://github.com/nvartolomei))
- 现在服务端会报告进度以保持客户端连接存活。 [#4215](https://github.com/ClickHouse/ClickHouse/pull/4215) ([Ivan](https://github.com/abyss7))
- 在启用 `optimize_throw_if_noop` 设置时，改进了用于说明 OPTIMIZE 查询原因的消息。 [#4294](https://github.com/ClickHouse/ClickHouse/pull/4294) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 为 clickhouse server 添加了对 `--version` 选项的支持。 [#4251](https://github.com/ClickHouse/ClickHouse/pull/4251) ([Lopatin Konstantin](https://github.com/k-lopatin))
- 为 `clickhouse-server` 添加了 `--help/-h` 选项。 [#4233](https://github.com/ClickHouse/ClickHouse/pull/4233) ([Yuriy Baranov](https://github.com/yurriy))
- 添加了对返回聚合函数状态结果的标量子查询的支持。 [#4348](https://github.com/ClickHouse/ClickHouse/pull/4348) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- 改进了服务端关闭耗时以及 ALTER 等待时间。 [#4372](https://github.com/ClickHouse/ClickHouse/pull/4372) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 在 system.replicas 中添加了关于 `replicated_can_become_leader` 设置的信息，并在副本不会尝试成为 leader 时添加了日志记录。 [#4379](https://github.com/ClickHouse/ClickHouse/pull/4379) ([Alex Zatelepin](https://github.com/ztlpn))



## ClickHouse 版本 19.1 {#clickhouse-release-19-1}

### ClickHouse 版本 19.1.14，2019-03-14 {#clickhouse-release-19-1-14-2019-03-14}

- 修复了在使用 `GLOBAL JOIN` 配合 `SELECT *` 时（罕见情况），如果将设置项 `asterisk_left_columns_only` 设为 1，可能出现的错误 `Column ... queried more than once`。该问题在 19.3 及之后的版本中不存在。[6bac7d8d](https://github.com/ClickHouse/ClickHouse/pull/4692/commits/6bac7d8d11a9b0d6de0b32b53c47eb2f6f8e7062)（[Artem Zuikov](https://github.com/4ertus2)）

### ClickHouse 版本 19.1.13，2019-03-12 {#clickhouse-release-19-1-13-2019-03-12}

此版本包含的补丁集与 19.3.7 完全相同。

### ClickHouse 版本 19.1.10，2019-03-03 {#clickhouse-release-19-1-10-2019-03-03}

此版本包含的补丁集与 19.3.6 完全相同。



## ClickHouse 发行版 19.1 {#clickhouse-release-19-1-1}

### ClickHouse 发行版 19.1.9，2019-02-21 {#clickhouse-release-19-1-9-2019-02-21}

#### Bug 修复 {#bug-fixes-18}

- 修复了由于 `send_logs_level` 设置实现错误导致与旧版本不兼容的问题。 [#4445](https://github.com/ClickHouse/ClickHouse/pull/4445) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 修复了在引入列注释后导致的表函数 `remote` 的向后不兼容问题。 [#4446](https://github.com/ClickHouse/ClickHouse/pull/4446) ([alexey-milovidov](https://github.com/alexey-milovidov))

### ClickHouse 发行版 19.1.8，2019-02-16 {#clickhouse-release-19-1-8-2019-02-16}

#### Bug 修复 {#bug-fixes-19}

- 修复了安装包中缺少 /etc/clickhouse-server/config.xml 的问题。 [#4343](https://github.com/ClickHouse/ClickHouse/pull/4343) ([proller](https://github.com/proller))



## ClickHouse 19.1 版本发布 {#clickhouse-release-19-1-2}

### ClickHouse 19.1.7 版本发布，2019-02-15 {#clickhouse-release-19-1-7-2019-02-15}

#### Bug 修复 {#bug-fixes-20}



* 在 `joinGet` 函数中返回正确的类型并妥善处理锁。[#4153](https://github.com/ClickHouse/ClickHouse/pull/4153) ([Amos Bird](https://github.com/amosbird))
* 修复了在服务器关闭过程中再次尝试创建系统日志时出现的错误。 [#4254](https://github.com/ClickHouse/ClickHouse/pull/4254) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 已修复一个错误：如果存在使用 `Dictionary` 引擎的数据库，所有字典会在服务器启动时被强制加载，此时如果有字典使用来自本机（localhost）上 ClickHouse 的数据源，该字典将无法加载。 [#4255](https://github.com/ClickHouse/ClickHouse/pull/4255) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了一个错误：执行包含 `IN` 运算符的变更操作时会产生不正确的结果。 [#4099](https://github.com/ClickHouse/ClickHouse/pull/4099) ([Alex Zatelepin](https://github.com/ztlpn))
* 如果以交互模式运行，`clickhouse-client` 在退出时为命令行补全加载数据时可能会发生段错误（segfault）。[#4317](https://github.com/ClickHouse/ClickHouse/pull/4317) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了在查询 `system.tables` 时可能导致 `table does not exist` 错误的竞争条件。[#4313](https://github.com/ClickHouse/ClickHouse/pull/4313) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了在对使用 `File` 引擎的表执行 `SELECT` 时，遇到 `No such file or directory` 错误后重试可能发生的死锁问题。 [#4161](https://github.com/ClickHouse/ClickHouse/pull/4161) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了这样一个问题：本地 ClickHouse 字典原本通过 TCP 加载，但应在进程内加载。 [#4166](https://github.com/ClickHouse/ClickHouse/pull/4166) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了通过 TLS 连接与 PostgreSQL ODBC Driver 交互时出现的 `No message received` 错误，并修复了使用 MySQL ODBC Driver 时发生的段错误。 [#4170](https://github.com/ClickHouse/ClickHouse/pull/4170) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 暂时禁用对 `ORDER BY` 的谓词优化。[#3890](https://github.com/ClickHouse/ClickHouse/pull/3890) ([Winter Zhang](https://github.com/zhang2014))
* 修复了从表函数 `numbers(0)` 查询数据时出现的无限循环问题。[#4280](https://github.com/ClickHouse/ClickHouse/pull/4280) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了 `compile_expressions` 在比较较大日期（超过 int16 范围）时的问题。 [#4341](https://github.com/ClickHouse/ClickHouse/pull/4341) ([alesapin](https://github.com/alesapin))
* 修复了在 `uncompressed_cache=1` 时出现的段错误，以及因未压缩大小错误引发的异常。[#4186](https://github.com/ClickHouse/ClickHouse/pull/4186) ([alesapin](https://github.com/alesapin))
* 修复了右表存在重复数据时的 `ALL JOIN` 行为。 [#4184](https://github.com/ClickHouse/ClickHouse/pull/4184) ([Artem Zuikov](https://github.com/4ertus2))
* 修复了在执行 `INSERT ... SELECT ... FROM file(...)` 查询时的错误行为：当文件格式为 `CSVWithNames` 或 `TSVWIthNames` 且第一行数据缺失时的处理问题。 [#4297](https://github.com/ClickHouse/ClickHouse/pull/4297) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了在处理 `Array(LowCardinality)` 参数时的聚合函数执行问题。[#4055](https://github.com/ClickHouse/ClickHouse/pull/4055) ([KochetovNicolai](https://github.com/KochetovNicolai))
* Debian 软件包：根据配置修正 /etc/clickhouse-server/preprocessed 链接，使其与配置一致。[#4205](https://github.com/ClickHouse/ClickHouse/pull/4205) ([proller](https://github.com/proller))
* 在启用未定义行为 sanitizer 时修复了 fuzz 测试：为 `quantile*Weighted` 函数族添加了参数类型检查。[#4145](https://github.com/ClickHouse/ClickHouse/pull/4145) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 使 `START REPLICATED SENDS` 命令能够启动复制发送。 [#4229](https://github.com/ClickHouse/ClickHouse/pull/4229) ([nvartolomei](https://github.com/nvartolomei))
* 修复了在 JOIN ON 子句中出现重复列时导致的 `Not found column` 错误。[#4279](https://github.com/ClickHouse/ClickHouse/pull/4279) ([Artem Zuikov](https://github.com/4ertus2))
* 现在 `/etc/ssl` 被用作存放 SSL 证书的默认目录。[#4167](https://github.com/ClickHouse/ClickHouse/pull/4167) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了在字典不可用时重新加载它时发生的崩溃。 [#4188](https://github.com/ClickHouse/ClickHouse/pull/4188) ([proller](https://github.com/proller))
* 修复了 `Date` 与 `DateTime` 比较结果不正确的问题。 [#4237](https://github.com/ClickHouse/ClickHouse/pull/4237) ([valexey](https://github.com/valexey))
* 修复了在条件运算符（函数 `if`）的分支中使用 `Date` 和 `DateTime` 参数时会产生错误结果的问题。为函数 `if` 添加了通用实现。[#4243](https://github.com/ClickHouse/ClickHouse/pull/4243) ([alexey-milovidov](https://github.com/alexey-milovidov))



### ClickHouse Release 19.1.6, 2019-01-24 {#clickhouse-release-19-1-6-2019-01-24}

#### 新特性 {#new-features-7}

- 表支持为每一列自定义压缩编解码器。 [#3899](https://github.com/ClickHouse/ClickHouse/pull/3899) [#4111](https://github.com/ClickHouse/ClickHouse/pull/4111) ([alesapin](https://github.com/alesapin), [Winter Zhang](https://github.com/zhang2014), [Anatoly](https://github.com/Sindbag))
- 新增压缩编解码器 `Delta`。 [#4052](https://github.com/ClickHouse/ClickHouse/pull/4052) ([alesapin](https://github.com/alesapin))
- 允许使用 `ALTER` 修改压缩编解码器。 [#4054](https://github.com/ClickHouse/ClickHouse/pull/4054) ([alesapin](https://github.com/alesapin))
- 为兼容 SQL 标准，新增函数 `left`、`right`、`trim`、`ltrim`、`rtrim`、`timestampadd`、`timestampsub`。 [#3826](https://github.com/ClickHouse/ClickHouse/pull/3826) ([Ivan Blinkov](https://github.com/blinkov))
- 支持向 `HDFS` 表写入数据，并提供 `hdfs` 表函数。 [#4084](https://github.com/ClickHouse/ClickHouse/pull/4084) ([alesapin](https://github.com/alesapin))
- 新增用于在大字符串中搜索多个常量字符串的函数：`multiPosition`、`multiSearch`、`firstMatch`，以及它们的 `-UTF8`、`-CaseInsensitive` 和 `-CaseInsensitiveUTF8` 变体。 [#4053](https://github.com/ClickHouse/ClickHouse/pull/4053) ([Danila Kutenin](https://github.com/danlark1))
- 当 `SELECT` 查询按分片键过滤时，可跳过未使用的分片（设置项 `optimize_skip_unused_shards`）。 [#3851](https://github.com/ClickHouse/ClickHouse/pull/3851) ([Gleb Kanterov](https://github.com/kanterov), [Ivan](https://github.com/abyss7))
- 允许 `Kafka` 引擎对每个数据块忽略一定数量的解析错误。 [#4094](https://github.com/ClickHouse/ClickHouse/pull/4094) ([Ivan](https://github.com/abyss7))
- 新增对 `CatBoost` 多分类模型评估的支持。函数 `modelEvaluate` 会针对多分类模型返回一个包含各类别原始预测值的元组。`libcatboostmodel.so` 需要按照 [#607](https://github.com/catboost/catboost/pull/607) 进行构建。 [#3959](https://github.com/ClickHouse/ClickHouse/pull/3959) ([KochetovNicolai](https://github.com/KochetovNicolai))
- 新增函数 `filesystemAvailable`、`filesystemFree`、`filesystemCapacity`。 [#4097](https://github.com/ClickHouse/ClickHouse/pull/4097) ([Boris Granveaud](https://github.com/bgranvea))
- 新增哈希函数 `xxHash64` 和 `xxHash32`。 [#3905](https://github.com/ClickHouse/ClickHouse/pull/3905) ([filimonov](https://github.com/filimonov))
- 新增哈希函数 `gccMurmurHash`（GCC 风格的 Murmur 哈希），其使用与 [gcc](https://github.com/gcc-mirror/gcc/blob/41d6b10e96a1de98e90a7c0378437c3255814b16/libstdc%2B%2B-v3/include/bits/functional_hash.h#L191) 相同的哈希种子。 [#4000](https://github.com/ClickHouse/ClickHouse/pull/4000) ([sundyli](https://github.com/sundy-li))
- 新增哈希函数 `javaHash`、`hiveHash`。 [#3811](https://github.com/ClickHouse/ClickHouse/pull/3811) ([shangshujie365](https://github.com/shangshujie365))
- 新增表函数 `remoteSecure`。该函数与 `remote` 类似，但使用安全连接。 [#4088](https://github.com/ClickHouse/ClickHouse/pull/4088) ([proller](https://github.com/proller))

#### 实验性特性 {#experimental-features-3}



- 添加了对多个 JOIN 仿真的支持（`allow_experimental_multiple_joins_emulation` 设置）。[#3946](https://github.com/ClickHouse/ClickHouse/pull/3946) ([Artem Zuikov](https://github.com/4ertus2))

#### Bug 修复 {#bug-fixes-21}



* 默认限制 `compiled_expression_cache_size` 以降低内存占用。[#4041](https://github.com/ClickHouse/ClickHouse/pull/4041) ([alesapin](https://github.com/alesapin))
* 修复了一个 Bug，该 Bug 会导致执行 Replicated 表 ALTER 操作的线程以及用于从 ZooKeeper 更新配置的线程发生挂起。[#2947](https://github.com/ClickHouse/ClickHouse/issues/2947) [#3891](https://github.com/ClickHouse/ClickHouse/issues/3891) [#3934](https://github.com/ClickHouse/ClickHouse/pull/3934) ([Alex Zatelepin](https://github.com/ztlpn))
* 修复了在执行分布式 ALTER 任务时的竞态条件。该竞态条件会导致多个副本同时尝试执行该任务，并使除一个副本之外的所有副本因 ZooKeeper 错误而失败。[#3904](https://github.com/ClickHouse/ClickHouse/pull/3904) ([Alex Zatelepin](https://github.com/ztlpn))
* 修复了一个错误：当对 ZooKeeper 的请求超时后，`from_zk` 配置元素不会被刷新。[#2947](https://github.com/ClickHouse/ClickHouse/issues/2947) [#3947](https://github.com/ClickHouse/ClickHouse/pull/3947) ([Alex Zatelepin](https://github.com/ztlpn))
* 修复 IPv4 子网掩码前缀错误的问题。 [#3945](https://github.com/ClickHouse/ClickHouse/pull/3945) ([alesapin](https://github.com/alesapin))
* 修复了在极少数情况下由于资源耗尽而无法创建新线程时触发的崩溃（`std::terminate`）。 [#3956](https://github.com/ClickHouse/ClickHouse/pull/3956) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复在执行 `remote` 表函数时，`getStructureOfRemoteTable` 使用了错误限制条件的问题。 [#4009](https://github.com/ClickHouse/ClickHouse/pull/4009) ([alesapin](https://github.com/alesapin))
* 修复 netlink 套接字泄漏问题。它们被放入一个池中却从未被删除，当所有当前套接字都在使用时，每当启动新线程就会创建新的套接字。[#4017](https://github.com/ClickHouse/ClickHouse/pull/4017) ([Alex Zatelepin](https://github.com/ztlpn))
* 修复了在 fork 出 `odbc-bridge` 子进程后、在从 `/proc` 读取完所有文件描述符之前就提前关闭 `/proc/self/fd` 目录的错误。 [#4120](https://github.com/ClickHouse/ClickHouse/pull/4120) ([alesapin](https://github.com/alesapin))
* 在主键中使用 String 时，修复了从 FixedString 到 UInt 的单调转换问题。 [#3870](https://github.com/ClickHouse/ClickHouse/pull/3870) ([Winter Zhang](https://github.com/zhang2014))
* 修复了整数转换函数单调性计算中的错误。[#3921](https://github.com/ClickHouse/ClickHouse/pull/3921) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了在某些无效参数情况下，`arrayEnumerateUniq` 和 `arrayEnumerateDense` 函数出现段错误的问题。 [#3909](https://github.com/ClickHouse/ClickHouse/pull/3909) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复 StorageMerge 中的未定义行为（UB）。 [#3910](https://github.com/ClickHouse/ClickHouse/pull/3910) ([Amos Bird](https://github.com/amosbird))
* 修复了函数 `addDays`、`subtractDays` 中的段错误。 [#3913](https://github.com/ClickHouse/ClickHouse/pull/3913) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了一个错误：当以整数参数并使用较大的负 scale 值执行时，函数 `round`、`floor`、`trunc`、`ceil` 可能返回不正确的结果。 [#3914](https://github.com/ClickHouse/ClickHouse/pull/3914) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了一个由 &#39;kill query sync&#39; 引发并导致 core dump 的缺陷。 [#3916](https://github.com/ClickHouse/ClickHouse/pull/3916) ([muVulDeePecker](https://github.com/fancyqlx))
* 修复在复制队列清空后出现的长时间延迟问题。 [#3928](https://github.com/ClickHouse/ClickHouse/pull/3928) [#3932](https://github.com/ClickHouse/ClickHouse/pull/3932) ([alesapin](https://github.com/alesapin))
* 修复了在向具有 `LowCardinality` 主键的表中插入数据时内存占用过高的问题。[#3955](https://github.com/ClickHouse/ClickHouse/pull/3955) ([KochetovNicolai](https://github.com/KochetovNicolai))
* 修复了在数组为空时，`Native` 格式中 `LowCardinality` 的序列化问题。 [#3907](https://github.com/ClickHouse/ClickHouse/issues/3907) [#4011](https://github.com/ClickHouse/ClickHouse/pull/4011) ([KochetovNicolai](https://github.com/KochetovNicolai))
* 修复了在对单个 LowCardinality 数值列使用 DISTINCT 子句时产生错误结果的问题。 [#3895](https://github.com/ClickHouse/ClickHouse/issues/3895) [#4012](https://github.com/ClickHouse/ClickHouse/pull/4012) ([KochetovNicolai](https://github.com/KochetovNicolai))
* 修复在启用 `compile` 设置时使用 LowCardinality 键的专用聚合问题。 [#3886](https://github.com/ClickHouse/ClickHouse/pull/3886) ([KochetovNicolai](https://github.com/KochetovNicolai))
* 修复复制表查询中的用户和密码转发问题。 [#3957](https://github.com/ClickHouse/ClickHouse/pull/3957) ([alesapin](https://github.com/alesapin)) ([小路](https://github.com/nicelulu))
* 修复了一个极少见的竞态条件问题，该问题可能在重新加载字典的同时列出 Dictionary 数据库中的表时发生。 [#3970](https://github.com/ClickHouse/ClickHouse/pull/3970) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了在将 HAVING 与 ROLLUP 或 CUBE 一起使用时结果不正确的问题。 [#3756](https://github.com/ClickHouse/ClickHouse/issues/3756) [#3837](https://github.com/ClickHouse/ClickHouse/pull/3837) ([Sam Chou](https://github.com/reflection))
* 修复了使用 `JOIN ON` 语法且包含分布式表的查询中的列别名处理。[#3980](https://github.com/ClickHouse/ClickHouse/pull/3980) ([Winter Zhang](https://github.com/zhang2014))
* 修复了 `quantileTDigest` 内部实现中的错误（由 Artem Vakhrushev 发现）。该错误在 ClickHouse 中从未触发，仅会影响那些直接将 ClickHouse 代码库当作库使用的用户。 [#3935](https://github.com/ClickHouse/ClickHouse/pull/3935) ([alexey-milovidov](https://github.com/alexey-milovidov))



#### 改进 {#improvements-6}

- 在 `ALTER TABLE ADD COLUMN` 语句中支持 `IF NOT EXISTS`，并在 `DROP/MODIFY/CLEAR/COMMENT COLUMN` 中支持 `IF EXISTS`。 [#3900](https://github.com/ClickHouse/ClickHouse/pull/3900) ([Boris Granveaud](https://github.com/bgranvea))
- 函数 `parseDateTimeBestEffort`：支持格式 `DD.MM.YYYY`、`DD.MM.YY`、`DD-MM-YYYY`、`DD-Mon-YYYY`、`DD/Month/YYYY` 及类似格式。 [#3922](https://github.com/ClickHouse/ClickHouse/pull/3922) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `CapnProtoInputStream` 现在支持不规则（jagged）结构。 [#4063](https://github.com/ClickHouse/ClickHouse/pull/4063) ([Odin Hultgren Van Der Horst](https://github.com/Miniwoffer))
- 易用性改进：增加检查，要求服务器进程必须由数据目录所有者启动。如果数据属于非 root 用户，则不允许以 root 用户启动服务器。 [#3785](https://github.com/ClickHouse/ClickHouse/pull/3785) ([sergey-v-galtsev](https://github.com/sergey-v-galtsev))
- 改进在分析带有 JOIN 的查询时检查必需列的逻辑。 [#3930](https://github.com/ClickHouse/ClickHouse/pull/3930) ([Artem Zuikov](https://github.com/4ertus2))
- 在单个服务器上存在大量 Distributed 表的情况下，降低连接数。 [#3726](https://github.com/ClickHouse/ClickHouse/pull/3726) ([Winter Zhang](https://github.com/zhang2014))
- 为 ODBC 驱动的 `WITH TOTALS` 查询增加汇总行支持。 [#3836](https://github.com/ClickHouse/ClickHouse/pull/3836) ([Maksim Koritckiy](https://github.com/nightweb))
- 允许在 if 函数中将 `Enum` 作为整数使用。 [#3875](https://github.com/ClickHouse/ClickHouse/pull/3875) ([Ivan](https://github.com/abyss7))
- 新增 `low_cardinality_allow_in_native_format` 设置。若禁用，则在 `Native` 格式中不使用 `LowCardinality` 类型。 [#3879](https://github.com/ClickHouse/ClickHouse/pull/3879) ([KochetovNicolai](https://github.com/KochetovNicolai))
- 从已编译表达式缓存中移除了一些冗余对象，以降低内存使用。 [#4042](https://github.com/ClickHouse/ClickHouse/pull/4042) ([alesapin](https://github.com/alesapin))
- 增加检查，以确保 `SET send_logs_level = 'value'` 查询接受的是有效的值。 [#3873](https://github.com/ClickHouse/ClickHouse/pull/3873) ([Sabyanin Maxim](https://github.com/s-mx))
- 修复了类型转换函数中的数据类型检查。 [#3896](https://github.com/ClickHouse/ClickHouse/pull/3896) ([Winter Zhang](https://github.com/zhang2014))

#### 性能改进 {#performance-improvements-5}



- 添加一个 MergeTree 设置 `use_minimalistic_part_header_in_zookeeper`。如果启用，Replicated 表会在单个 part znode 中存储紧凑的 part 元数据。这可以显著减少 ZooKeeper 快照大小（尤其是在表包含大量列时）。注意，在启用此设置后，将无法降级到不支持该设置的版本。[#3960](https://github.com/ClickHouse/ClickHouse/pull/3960) ([Alex Zatelepin](https://github.com/ztlpn))
- 为函数 `sequenceMatch` 和 `sequenceCount` 添加一个基于 DFA 的实现，用于模式不包含时间条件的情况。[#4004](https://github.com/ClickHouse/ClickHouse/pull/4004) ([Léo Ercolanelli](https://github.com/ercolanelli-leo))
- 提升整数序列化的性能。[#3968](https://github.com/ClickHouse/ClickHouse/pull/3968) ([Amos Bird](https://github.com/amosbird))
- 对 PODArray 进行左侧零填充，使得索引为 -1 的元素始终有效且被清零。它用于无分支的偏移量计算。[#3920](https://github.com/ClickHouse/ClickHouse/pull/3920) ([Amos Bird](https://github.com/amosbird))
- 回退了导致性能下降的 `jemalloc` 版本。[#4018](https://github.com/ClickHouse/ClickHouse/pull/4018) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### 向后不兼容的更改 {#backward-incompatible-changes-2}

- 移除了未在文档中记录的特性 `ALTER MODIFY PRIMARY KEY`，因为它已被 `ALTER MODIFY ORDER BY` 命令取代。[#3887](https://github.com/ClickHouse/ClickHouse/pull/3887) ([Alex Zatelepin](https://github.com/ztlpn))
- 移除函数 `shardByHash`。[#3833](https://github.com/ClickHouse/ClickHouse/pull/3833) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 禁止使用结果类型为 `AggregateFunction` 的标量子查询。[#3865](https://github.com/ClickHouse/ClickHouse/pull/3865) ([Ivan](https://github.com/abyss7))

#### 构建 / 测试 / 打包改进 {#buildtestingpackaging-improvements-6}



* 新增对 PowerPC（`ppc64le`）构建的支持。[#4132](https://github.com/ClickHouse/ClickHouse/pull/4132) ([Danila Kutenin](https://github.com/danlark1))
* 有状态功能测试在公开可用的数据集上运行。 [#3969](https://github.com/ClickHouse/ClickHouse/pull/3969) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复了在 Docker 或 systemd-nspawn 环境中，当服务器因出现 `bash: /usr/bin/clickhouse-extract-from-config: Operation not permitted` 消息而无法启动的问题。[#4136](https://github.com/ClickHouse/ClickHouse/pull/4136) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 将 `rdkafka` 库更新到 v1.0.0-RC5。使用 cppkafka 替代原生 C 接口。[#4025](https://github.com/ClickHouse/ClickHouse/pull/4025) ([Ivan](https://github.com/abyss7))
* 更新了 `mariadb-client` 库。修复了 UBSan 报告的其中一个问题。 [#3924](https://github.com/ClickHouse/ClickHouse/pull/3924) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 针对 UBSan 构建的若干修复。[#3926](https://github.com/ClickHouse/ClickHouse/pull/3926) [#3021](https://github.com/ClickHouse/ClickHouse/pull/3021) [#3948](https://github.com/ClickHouse/ClickHouse/pull/3948) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 为每次提交新增基于 UBSan 构建的测试运行。
* 为每次提交新增 PVS-Studio 静态分析器运行。
* 修复了通过 PVS-Studio 发现的缺陷。 [#4013](https://github.com/ClickHouse/ClickHouse/pull/4013) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修复 glibc 兼容性问题。 [#4100](https://github.com/ClickHouse/ClickHouse/pull/4100) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 将 Docker 镜像升级到 18.10，并为 glibc &gt;= 2.28 添加兼容性文件 [#3965](https://github.com/ClickHouse/ClickHouse/pull/3965) ([alesapin](https://github.com/alesapin))
* 添加环境变量，以便在用户不想在服务器 Docker 镜像中对目录执行 chown 操作时使用。 [#3967](https://github.com/ClickHouse/ClickHouse/pull/3967) ([alesapin](https://github.com/alesapin))
* 在 clang 中启用了 `-Weverything` 中的大部分警告，并启用了 `-Wpedantic`。[#3986](https://github.com/ClickHouse/ClickHouse/pull/3986) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 新增了几项仅在 clang 8 中可用的警告。[#3993](https://github.com/ClickHouse/ClickHouse/pull/3993) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 在进行动态链接时，链接到 `libLLVM`，而不是分别链接各个 LLVM 库。[#3989](https://github.com/ClickHouse/ClickHouse/pull/3989) ([Orivej Desh](https://github.com/orivej))
* 为测试镜像添加了 sanitizer 变量。 [#4072](https://github.com/ClickHouse/ClickHouse/pull/4072) ([alesapin](https://github.com/alesapin))
* `clickhouse-server` 的 Debian 软件包将推荐安装 `libcap2-bin` 软件包，以便使用 `setcap` 工具设置 capabilities。此步骤是可选的。 [#4093](https://github.com/ClickHouse/ClickHouse/pull/4093) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 优化了编译时间并修复了 include。 [#3898](https://github.com/ClickHouse/ClickHouse/pull/3898) ([proller](https://github.com/proller))
* 新增了哈希函数的性能测试。 [#3918](https://github.com/ClickHouse/ClickHouse/pull/3918) ([filimonov](https://github.com/filimonov))
* 修复了循环库依赖。[#3958](https://github.com/ClickHouse/ClickHouse/pull/3958) ([proller](https://github.com/proller))
* 在可用内存较低的情况下优化了编译过程。[#4030](https://github.com/ClickHouse/ClickHouse/pull/4030) ([proller](https://github.com/proller))
* 添加了用于复现 `jemalloc` 性能退化问题的测试脚本。[#4036](https://github.com/ClickHouse/ClickHouse/pull/4036) ([alexey-milovidov](https://github.com/alexey-milovidov))
* 修正了 `dbms` 下注释和字符串字面量中的拼写错误。 [#4122](https://github.com/ClickHouse/ClickHouse/pull/4122) ([maiha](https://github.com/maiha))
* 修正注释中的拼写错误。[#4089](https://github.com/ClickHouse/ClickHouse/pull/4089) ([Evgenii Pravda](https://github.com/kvinty))





## [2018 年更新日志](./2018.md) {#changelog-for-2018}
