---
slug: /whats-new/changelog/2024
sidebar_position: 3
sidebar_label: "2024"
title: "2024 更新日志"
description: "2024 年更新日志"
keywords:
  [
    "ClickHouse 2024",
    "changelog 2024",
    "发布说明",
    "版本历史",
    "新功能"
  ]
doc_type: "changelog"
---

### 目录 {#table-of-contents}

**[ClickHouse 版本 v24.12, 2024-12-19](/whats-new/changelog/2024#a-id2412a-clickhouse-release-2412-2024-12-19)**<br/>
**[ClickHouse 版本 v24.11, 2024-11-26](/whats-new/changelog/2024#a-id2411a-clickhouse-release-2411-2024-11-26)**<br/>
**[ClickHouse 版本 v24.10, 2024-10-31](/whats-new/changelog/2024#a-id2410a-clickhouse-release-2410-2024-10-31)**<br/>
**[ClickHouse 版本 v24.9, 2024-09-26](/whats-new/changelog/2024#a-id249a-clickhouse-release-249-2024-09-26)**<br/>
**[ClickHouse 版本 v24.8 LTS, 2024-08-20](/whats-new/changelog/2024#a-id248a-clickhouse-release-248-lts-2024-08-20)**<br/>
**[ClickHouse 版本 v24.7, 2024-07-30](/whats-new/changelog/2024#a-id247a-clickhouse-release-247-2024-07-30)**<br/>
**[ClickHouse 版本 v24.6, 2024-07-01](/whats-new/changelog/2024#a-id246a-clickhouse-release-246-2024-07-01)**<br/>
**[ClickHouse 版本 v24.5, 2024-05-30](/whats-new/changelog/2024#a-id245a-clickhouse-release-245-2024-05-30)**<br/>
**[ClickHouse 版本 v24.4, 2024-04-30](/whats-new/changelog/2024#a-id244a-clickhouse-release-244-2024-04-30)**<br/>
**[ClickHouse 版本 v24.3 LTS, 2024-03-26](/whats-new/changelog/2024#a-id243a-clickhouse-release-243-lts-2024-03-27)**<br/>
**[ClickHouse 版本 v24.2, 2024-02-29](/whats-new/changelog/2024#a-id242a-clickhouse-release-242-2024-02-29)**<br/>
**[ClickHouse 版本 v24.1, 2024-01-30](/whats-new/changelog/2024#a-id241a-clickhouse-release-241-2024-01-30)**<br/>
**[2023 年更新日志](/whats-new/changelog/2023/)**<br/>

### <a id="2412"></a> ClickHouse 版本 24.12, 2024-12-19 {#a-id2412a-clickhouse-release-2412-2024-12-19}

#### 向后不兼容的变更 {#backward-incompatible-change}

- 函数 `greatest` 和 `least` 现在会忽略 NULL 输入值,而之前如果其中一个参数为 NULL 则返回 NULL。例如,`SELECT greatest(1, 2, NULL)` 现在返回 2。这使得行为与 PostgreSQL 兼容,但同时破坏了与 MySQL 的兼容性(MySQL 返回 NULL)。要保留之前的行为,请将设置 `least_greatest_legacy_null_behavior`(默认值:`false`)设置为 `true`。[#65519](https://github.com/ClickHouse/ClickHouse/pull/65519) [#73344](https://github.com/ClickHouse/ClickHouse/pull/73344) ([kevinyhzou](https://github.com/KevinyhZou))。
- 新的 MongoDB 集成现在是默认选项。希望使用旧版 MongoDB 驱动程序(基于 Poco 驱动程序)的用户可以启用服务器设置 `use_legacy_mongodb_integration`。[#73359](https://github.com/ClickHouse/ClickHouse/pull/73359) ([Kirill Nikiforov](https://github.com/allmazz))。


#### 新功能 {#new-feature}

- 将 `JSON`/`Dynamic`/`Variant` 类型从实验性功能升级为 Beta 版本。[#72294](https://github.com/ClickHouse/ClickHouse/pull/72294) ([Pavel Kruglov](https://github.com/Avogar))。我们还将所有修复以及此更改回溯到 24.11 版本。
- [Iceberg 数据存储](https://iceberg.apache.org/spec/#file-system-operations)格式的模式演进为用户提供了丰富的选项来修改表模式。列的顺序、列名称以及简单的类型扩展都可以在底层进行更改。[#69445](https://github.com/ClickHouse/ClickHouse/pull/69445) ([Daniil Ivanik](https://github.com/divanik))。
- 集成 Iceberg REST Catalog:一个名为 Iceberg 的新数据库引擎,可将整个目录集成到 ClickHouse 中。[#71542](https://github.com/ClickHouse/ClickHouse/pull/71542) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 为 `MergeTree` 表的主索引添加了缓存(可通过表设置 `use_primary_key_cache` 启用)。如果为主索引启用了延迟加载和缓存,它将按需加载到缓存中(类似于标记缓存),而不是永久保存在内存中。在数据部分的插入/合并/获取以及表重启时添加了主索引的预热功能(可通过设置 `prewarm_primary_key_cache` 启用)。这使得共享存储上的大型表可以降低内存使用量,我们在超过一千万亿条记录的表上进行了测试。[#72102](https://github.com/ClickHouse/ClickHouse/pull/72102) ([Anton Popov](https://github.com/CurtizJ))。[#72750](https://github.com/ClickHouse/ClickHouse/pull/72750) ([Alexander Gololobov](https://github.com/davenger))。
- 实现 `SYSTEM LOAD PRIMARY KEY` 命令,用于加载指定表所有部分的主索引,如果未指定表则加载所有表的主索引。这对于基准测试以及防止查询执行期间的额外延迟非常有用。[#66252](https://github.com/ClickHouse/ClickHouse/pull/66252) [#67733](https://github.com/ClickHouse/ClickHouse/pull/67733) ([ZAWA_ll](https://github.com/Zawa-ll))。
- 添加了允许将 `MergeTree` 表附加为 `ReplicatedMergeTree` 以及反向操作的查询:`ATTACH TABLE ... AS REPLICATED` 和 `ATTACH TABLE ... AS NOT REPLICATED`。[#65401](https://github.com/ClickHouse/ClickHouse/pull/65401) ([Kirill](https://github.com/kirillgarbar))。
- 新增设置 `http_response_headers`,允许您自定义 HTTP 响应头。例如,您可以指示浏览器渲染存储在数据库中的图片。这解决了 [#59620](https://github.com/ClickHouse/ClickHouse/issues/59620)。[#72656](https://github.com/ClickHouse/ClickHouse/pull/72656) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 添加函数 `toUnixTimestamp64Second`,将 `DateTime64` 转换为具有固定秒精度的 `Int64` 值,因此如果日期早于 Unix 纪元,可以支持返回负值。[#70597](https://github.com/ClickHouse/ClickHouse/pull/70597) ([zhanglistar](https://github.com/zhanglistar))。[#73146](https://github.com/ClickHouse/ClickHouse/pull/73146) ([Robert Schulze](https://github.com/rschu1ze))。
- 添加新设置 `enforce_index_structure_match_on_partition_manipulation`,当源表的投影和二级索引集合是目标表的子集时允许附加操作。解决了 [#70602](https://github.com/ClickHouse/ClickHouse/issues/70602)。[#70603](https://github.com/ClickHouse/ClickHouse/pull/70603) ([zwy991114](https://github.com/zwy991114))。
- 添加语法 ALTER USER `{ADD|MODIFY|DROP SETTING}`,ALTER USER `{ADD|DROP PROFILE}`,ALTER ROLE 和 ALTER PROFILE 也支持相同语法。因此,您可以修改设置,而不是替换整个设置集合。[#72050](https://github.com/ClickHouse/ClickHouse/pull/72050) ([pufit](https://github.com/pufit))。
- 添加 `arrayPRAUC` 函数,用于计算精确率-召回率曲线的 AUC(曲线下面积)。[#72073](https://github.com/ClickHouse/ClickHouse/pull/72073) ([Emmanuel](https://github.com/emmanuelsdias))。
- 为数组类型添加 `indexOfAssumeSorted` 函数。在数组按非递减顺序排序的情况下优化搜索。该效果在非常大的数组(超过 100,000 个元素)上显现。[#72517](https://github.com/ClickHouse/ClickHouse/pull/72517) ([Eric Kurbanov](https://github.com/erickurbanov))。
- 允许将分隔符作为聚合函数 `groupConcat` 的可选第二个参数。[#72540](https://github.com/ClickHouse/ClickHouse/pull/72540) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- 函数 `translate` 现在支持字符删除,如果 `from` 参数包含的字符多于 `to` 参数。示例:`SELECT translate('clickhouse', 'clickhouse', 'CLICK')` 现在返回 `CLICK`。[#71441](https://github.com/ClickHouse/ClickHouse/pull/71441) ([shuai.xu](https://github.com/shuai-xu))。

#### 实验性功能 {#experimental-features}

- 新增 MergeTree 设置 `allow_experimental_reverse_key`,用于在 MergeTree 排序键中启用降序排序支持。这对时间序列分析特别有用,尤其适用于 TopN 查询。使用示例:`ENGINE = MergeTree ORDER BY (time DESC, key)` - 对 `time` 字段按降序排列。[#71095](https://github.com/ClickHouse/ClickHouse/pull/71095) ([Amos Bird](https://github.com/amosbird))。


#### 性能改进 {#performance-improvement}

- JOIN 重排序。新增了一个选项,用于选择在查询计划中作为内部(构建)表的 JOIN 侧。这由 `query_plan_join_swap_table` 控制,可以设置为 `auto`。在此模式下,ClickHouse 将尝试选择行数最少的表。[#71577](https://github.com/ClickHouse/ClickHouse/pull/71577) ([Vladimir Cherkasov](https://github.com/vdimir))。
- 现在当 `join_algorithm` 设置为 `default` 时,将使用 `parallel_hash` 算法(如果适用)。当 `parallel_hash` 无法使用时,仍会考虑之前的两个替代方案(`direct` 和 `hash`)。[#70788](https://github.com/ClickHouse/ClickHouse/pull/70788) ([Nikita Taranov](https://github.com/nickitat))。
- 新增选项,从 `WHERE` 和 `ON` 表达式中提取公共表达式,以减少 JOIN 期间使用的哈希表数量。当 JOIN ON 条件在不同的 OR 部分的 AND 内部具有公共部分时,这很有意义。可以通过 `optimize_extract_common_expressions = 1` 启用。[#71537](https://github.com/ClickHouse/ClickHouse/pull/71537) ([János Benjamin Antal](https://github.com/antaljanosbenjamin))。
- 允许在 `SELECT` 中使用索引,当索引列被 CAST 为 `LowCardinality(String)` 时,这种情况可能发生在对 Merge 表运行查询时,其中一些表具有 `String` 类型,一些具有 `LowCardinality(String)` 类型。[#71598](https://github.com/ClickHouse/ClickHouse/pull/71598) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- 在启用本地计划的并行副本查询执行期间,不在 worker 上执行索引分析。协调器将根据其侧(查询发起者)的索引分析为 worker 选择要读取的范围。这使得使用并行副本的短查询具有与单节点查询一样低的延迟。[#72109](https://github.com/ClickHouse/ClickHouse/pull/72109) ([Igor Nikonov](https://github.com/devcrafter))。
- 对于对象存储磁盘,`clickhouse disks remove --recursive` 的内存使用量已减少。[#67323](https://github.com/ClickHouse/ClickHouse/pull/67323) ([Kirill](https://github.com/kirillgarbar))。
- 恢复了来自 [#57631](https://github.com/ClickHouse/ClickHouse/pull/57631) 的在紧凑部分中读取单列子列的优化。该优化被意外删除。[#72285](https://github.com/ClickHouse/ClickHouse/pull/72285) ([Pavel Kruglov](https://github.com/Avogar))。
- 通过在比较器中去虚拟化调用,加速 `LowCardinality(String)` 列的排序。[#72337](https://github.com/ClickHouse/ClickHouse/pull/72337) ([Alexander Gololobov](https://github.com/davenger))。
- 针对某些简单数据类型优化 `argMin`/`argMax` 函数。[#72350](https://github.com/ClickHouse/ClickHouse/pull/72350) ([alesapin](https://github.com/alesapin))。
- 在内存跟踪器中使用共享锁优化锁定,以减少锁争用,从而提高具有大量 CPU 的系统上的性能。[#72375](https://github.com/ClickHouse/ClickHouse/pull/72375) ([Jiebin Sun](https://github.com/jiebinn))。
- 新增设置 `use_async_executor_for_materialized_views`。使用异步和潜在的多线程执行物化视图查询,可以加速 INSERT 期间的视图处理,但也会消耗更多内存。[#72497](https://github.com/ClickHouse/ClickHouse/pull/72497) ([alesapin](https://github.com/alesapin))。
- 改进了聚合函数状态的反序列化性能(在数据类型 `AggregateFunction` 和分布式查询中)。略微改进了 `RowBinary` 格式的解析性能。[#72818](https://github.com/ClickHouse/ClickHouse/pull/72818) ([Anton Popov](https://github.com/CurtizJ))。
- 在使用并行副本读取时,按表键的顺序拆分范围,以在读取期间消耗更少的内存。[#72173](https://github.com/ClickHouse/ClickHouse/pull/72173) ([JIaQi](https://github.com/JiaQiTang98))。
- 在插入批次内分区键为单个值的情况下,加速向 MergeTree 的插入。[#72348](https://github.com/ClickHouse/ClickHouse/pull/72348) ([alesapin](https://github.com/alesapin))。
- 实现从备份恢复时并行创建表。在此 PR 之前,`RESTORE` 命令始终在单个线程中创建表,在包含许多表的备份情况下可能会很慢。[#72427](https://github.com/ClickHouse/ClickHouse/pull/72427) ([Vitaly Baranov](https://github.com/vitlibar))。
- 如果标记缓存很大,删除它可能需要明显的时间。如果在此期间持有上下文互斥锁,它会阻塞许多其他活动,甚至在释放之前无法建立新的客户端连接。而且持有此互斥锁实际上并不是同步所必需的,通过共享指针拥有对缓存的本地引用就足够了。[#72749](https://github.com/ClickHouse/ClickHouse/pull/72749) ([Alexander Gololobov](https://github.com/davenger))。





#### 改进 {#improvement}

- 移除 `allow_experimental_join_condition` 设置,默认允许非等值条件。[#69910](https://github.com/ClickHouse/ClickHouse/pull/69910) ([Vladimir Cherkasov](https://github.com/vdimir))。
- 服务器配置文件(users.xml)中的设置现在也会应用到客户端。这对格式设置很有用,例如 `date_time_output_format`。[#71178](https://github.com/ClickHouse/ClickHouse/pull/71178) ([Michael Kolupaev](https://github.com/al13n321))。
- 根据服务器/用户内存使用情况自动将 `GROUP BY`/`ORDER BY` 溢出到磁盘。通过查询设置 `max_bytes_ratio_before_external_group_by`/`max_bytes_ratio_before_external_sort` 进行控制。[#71406](https://github.com/ClickHouse/ClickHouse/pull/71406) ([Azat Khuzhin](https://github.com/azat))。
- 添加新的取消逻辑:`CancellationChecker` 检查每个已启动查询的超时时间,并在达到超时后停止查询。[#69880](https://github.com/ClickHouse/ClickHouse/pull/69880) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- 支持从 `Object` 到 `JSON` 的 ALTER 操作,这意味着您可以轻松地从已弃用的 Object 类型迁移。[#71784](https://github.com/ClickHouse/ClickHouse/pull/71784) ([Pavel Kruglov](https://github.com/Avogar))。
- 允许集合中包含 Enum 中不存在的未知值。修复 [#72662](https://github.com/ClickHouse/ClickHouse/issues/72662)。[#72686](https://github.com/ClickHouse/ClickHouse/pull/72686) ([zhanglistar](https://github.com/zhanglistar))。
- 支持 `Enum` 数据类型的字符串搜索操作符(例如 LIKE),实现 [#72661](https://github.com/ClickHouse/ClickHouse/issues/72661)。[#72732](https://github.com/ClickHouse/ClickHouse/pull/72732) ([zhanglistar](https://github.com/zhanglistar))。
- 之前会接受一些无意义的 ALTER USER 查询。修复 [#71227](https://github.com/ClickHouse/ClickHouse/issues/71227)。[#71286](https://github.com/ClickHouse/ClickHouse/pull/71286) ([Arthur Passos](https://github.com/arthurpassos))。
- 在为分布式 `INSERT ... SELECT` 构建执行计划时遵循 `prefer_locahost_replica` 设置。[#72190](https://github.com/ClickHouse/ClickHouse/pull/72190) ([filimonov](https://github.com/filimonov))。
- Azure 违反了 Iceberg 规范,错误地将 Iceberg v1 标记为 Iceberg v2。问题[在此描述](https://github.com/ClickHouse/ClickHouse/issues/72091)。Azure Iceberg Writer 创建的 Iceberg 元数据文件(以及清单文件)违反了规范。现在我们尝试使用 v2 读取器读取 v1 Iceberg 格式的元数据(因为它们以这种方式写入),并在清单文件中未创建相应字段时添加错误提示。[#72277](https://github.com/ClickHouse/ClickHouse/pull/72277) ([Daniil Ivanik](https://github.com/divanik))。
- 现在允许在查询中使用 `UNION [ALL]` 来 `CREATE MATERIALIZED VIEW`。行为与带有 `JOIN` 的物化视图相同:只有 `SELECT` 表达式中的第一个表会作为插入触发器,所有其他表将被忽略。但是,如果对第一个表有多个引用(例如与自身进行 UNION),所有这些引用都将作为插入的数据块进行处理。[#72347](https://github.com/ClickHouse/ClickHouse/pull/72347) ([alesapin](https://github.com/alesapin))。
- 当 ClickHouse 用作字典的数据源时,添加了源查询验证。[#72548](https://github.com/ClickHouse/ClickHouse/pull/72548) ([Alexey Katsman](https://github.com/alexkats))。
- 确保 ClickHouse 在配置重新加载时能够感知 ZooKeeper 的变更。[#72593](https://github.com/ClickHouse/ClickHouse/pull/72593) ([Azat Khuzhin](https://github.com/azat))。
- 改进缓存标记的内存使用估算,以减少缓存的总内存使用量。[#72630](https://github.com/ClickHouse/ClickHouse/pull/72630) ([Antonio Andelic](https://github.com/antonio2368))。
- 添加新的 `StartupScriptsExecutionState` 指标。该指标可以有三个值:0 = 启动脚本尚未完成,1 = 启动脚本执行成功,2 = 启动脚本失败。我们需要这个指标来了解启动脚本在云环境中是否成功执行,特别是在发布基础配置更新之后。[#72637](https://github.com/ClickHouse/ClickHouse/pull/72637) ([Miсhael Stetsyuk](https://github.com/mstetsyuk))。
- 向 `system.metrics` 添加新的 `MergeTreeIndexGranularityInternalArraysTotalSize` 指标。此指标用于查找具有大型数据集且容易受到高
- 为创建复制表添加重试机制。[#72682](https://github.com/ClickHouse/ClickHouse/pull/72682) ([Vitaly Baranov](https://github.com/vitlibar))。
- 向 `system.tables` 添加 `total_bytes_with_inactive` 以统计非活动部分的总字节数。[#72690](https://github.com/ClickHouse/ClickHouse/pull/72690) ([Kai Zhu](https://github.com/nauu))。
- 将 MergeTree 设置添加到 `system.settings_changes`。[#72694](https://github.com/ClickHouse/ClickHouse/pull/72694) ([Raúl Marín](https://github.com/Algunenano))。
- 在 `notEmpty` 函数中支持 JSON 类型。[#72741](https://github.com/ClickHouse/ClickHouse/pull/72741) ([Pavel Kruglov](https://github.com/Avogar))。
- 支持解析 GCS S3 错误 `AuthenticationRequired`。[#72753](https://github.com/ClickHouse/ClickHouse/pull/72753) ([Vitaly Baranov](https://github.com/vitlibar))。
- 在函数 `ifNull` 和 `coalesce` 中支持 `Dynamic` 类型。[#72772](https://github.com/ClickHouse/ClickHouse/pull/72772) ([Pavel Kruglov](https://github.com/Avogar))。
- 在函数 `toFloat64`/`touInt32`/等中支持 `Dynamic`。[#72989](https://github.com/ClickHouse/ClickHouse/pull/72989) ([Pavel Kruglov](https://github.com/Avogar))。
- 添加 S3 请求设置 `http_max_fields`、`http_max_field_name_size`、`http_max_field_value_size`,并在备份或恢复期间解析 S3 API 响应时使用它们。[#72778](https://github.com/ClickHouse/ClickHouse/pull/72778) ([Vitaly Baranov](https://github.com/vitlibar))。
- 仅在使用此元数据的最后一个表被删除后,才删除 Storage S3(Azure)Queue 在 keeper 中的表元数据。[#72810](https://github.com/ClickHouse/ClickHouse/pull/72810) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 添加 `JoinBuildTableRowCount`/`JoinProbeTableRowCount/JoinResultRowCount` 性能事件。[#72842](https://github.com/ClickHouse/ClickHouse/pull/72842) ([Vladimir Cherkasov](https://github.com/vdimir))。
- 在 MergeTree 排序键和跳数索引中支持子列。[#72644](https://github.com/ClickHouse/ClickHouse/pull/72644) ([Pavel Kruglov](https://github.com/Avogar))。





#### Bug Fix (官方稳定版本中用户可见的错误行为) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release}

- 修复 MergeTree 可能出现的数据分片交叉问题(在将数据分片移动到 detached 目录的操作失败后,可能由对象存储操作引起)。[#70476](https://github.com/ClickHouse/ClickHouse/pull/70476) ([Azat Khuzhin](https://github.com/azat))。
- 修复表名过长时的错误检测。提供诊断信息以显示最大长度限制。新增函数 `getMaxTableNameLengthForDatabase`。[#70810](https://github.com/ClickHouse/ClickHouse/pull/70810) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- 修复 `clickhouse-library-bridge` 崩溃后产生的僵尸进程问题(该程序用于运行不安全的库)。[#71301](https://github.com/ClickHouse/ClickHouse/pull/71301) ([MikhailBurdukov](https://github.com/MikhailBurdukov))。
- 修复在 `plain_rewritable` 磁盘上创建目录失败时事务回滚期间出现的 NoSuchKey 错误。[#71439](https://github.com/ClickHouse/ClickHouse/pull/71439) ([Julia Kartseva](https://github.com/jkartseva))。
- 修复 `Pretty` JSON 格式中 `Dynamic` 值的序列化问题。[#71923](https://github.com/ClickHouse/ClickHouse/pull/71923) ([Pavel Kruglov](https://github.com/Avogar))。
- 在 `File`/`S3`/`URL`/`HDFS`/`Azure` 引擎的创建查询中添加推断的格式名称。以前每次服务器重启时都会重新推断格式名称,如果指定的数据文件被删除,会导致服务器启动时出错。[#72108](https://github.com/ClickHouse/ClickHouse/pull/72108) ([Pavel Kruglov](https://github.com/Avogar))。
- 修复在旧分析器中使用 UDF 进行 join 表达式时的错误。[#72179](https://github.com/ClickHouse/ClickHouse/pull/72179) ([Raúl Marín](https://github.com/Algunenano))。
- 修复 `StorageObjectStorage` 中的一些小错误。需要默认启用 `use_hive_partitioning`。[#72185](https://github.com/ClickHouse/ClickHouse/pull/72185) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- 修复 `min_age_to_force_merge_on_partition_only` 卡住的错误,该错误会反复尝试合并已经合并为单个分片的同一分区,而不合并具有多个分片的分区。[#72209](https://github.com/ClickHouse/ClickHouse/pull/72209) ([Christoph Wurm](https://github.com/cwurm))。
- 修复 `SimpleSquashingChunksTransform` 在处理稀疏列时极少数情况下发生的崩溃。[#72226](https://github.com/ClickHouse/ClickHouse/pull/72226) ([Vladimir Cherkasov](https://github.com/vdimir))。
- 修复 `GraceHashJoin` 中的数据竞争,该竞争可能导致 join 输出中缺少某些行。[#72233](https://github.com/ClickHouse/ClickHouse/pull/72233) ([Nikita Taranov](https://github.com/nickitat))。
- 修复带有物化 `_block_number` 列的 `ALTER DELETE` 查询(当启用 `enable_block_number_column` 设置时)。[#72261](https://github.com/ClickHouse/ClickHouse/pull/72261) ([Anton Popov](https://github.com/CurtizJ))。
- 修复并发调用 `ColumnDynamic::dumpStructure()` 时的数据竞争,例如在 `ConcurrentHashJoin` 构造函数中。[#72278](https://github.com/ClickHouse/ClickHouse/pull/72278) ([Nikita Taranov](https://github.com/nickitat))。
- 修复 `ORDER BY ... WITH FILL` 中重复列可能导致的 `LOGICAL_ERROR`。[#72387](https://github.com/ClickHouse/ClickHouse/pull/72387) ([Vladimir Cherkasov](https://github.com/vdimir))。
- 修复应用 `optimize_functions_to_subcolumns` 后在多种情况下出现的类型不匹配问题。[#72394](https://github.com/ClickHouse/ClickHouse/pull/72394) ([Anton Popov](https://github.com/CurtizJ))。
- 使用 `AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE` 而不是 `AWS_CONTAINER_AUTHORIZATION_TOKEN_PATH`。修复 [#71074](https://github.com/ClickHouse/ClickHouse/issues/71074)。[#72397](https://github.com/ClickHouse/ClickHouse/pull/72397) ([Konstantin Bogdanov](https://github.com/thevar1able))。
- 修复解析 `BACKUP DATABASE db EXCEPT TABLES db.table` 查询时的失败。[#72429](https://github.com/ClickHouse/ClickHouse/pull/72429) ([Konstantin Bogdanov](https://github.com/thevar1able))。
- 不允许创建空的 `Variant`。[#72454](https://github.com/ClickHouse/ClickHouse/pull/72454) ([Pavel Kruglov](https://github.com/Avogar))。
- 修复 `system.merges` 中 `result_part_path` 的格式错误。[#72567](https://github.com/ClickHouse/ClickHouse/pull/72567) ([Konstantin Bogdanov](https://github.com/thevar1able))。
- 修复解析单元素 glob 模式(例如 `{file}`)的问题。[#72572](https://github.com/ClickHouse/ClickHouse/pull/72572) ([Konstantin Bogdanov](https://github.com/thevar1able))。
- 修复在分布式查询中使用 `ARRAY JOIN` 时从服务器的查询生成问题。修复 [#69276](https://github.com/ClickHouse/ClickHouse/issues/69276)。[#72608](https://github.com/ClickHouse/ClickHouse/pull/72608) ([Dmitry Novik](https://github.com/novikd))。
- 修复 DateTime64 IN DateTime64 不返回任何结果的错误。[#72640](https://github.com/ClickHouse/ClickHouse/pull/72640) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- 修复向包含使用 `flatten_nested=0` 创建的表的 Replicated 数据库添加新副本时的元数据不一致问题。[#72685](https://github.com/ClickHouse/ClickHouse/pull/72685) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 修复 Keeper 内部通信的高级 SSL 配置。[#72730](https://github.com/ClickHouse/ClickHouse/pull/72730) ([Antonio Andelic](https://github.com/antonio2368))。
- 修复 S3Queue 无序模式中当 `tracked_files_limit` 设置小于 S3 文件出现速率时的 "No such key" 错误。[#72738](https://github.com/ClickHouse/ClickHouse/pull/72738) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 修复当用户在本地不存在时 RemoteQueryExecutor 抛出的异常。[#72759](https://github.com/ClickHouse/ClickHouse/pull/72759) ([Andrey Zvonov](https://github.com/zvonand))。
- 修复带有物化 `_block_number` 列的变更操作(当启用 `enable_block_number_column` 设置时)。[#72854](https://github.com/ClickHouse/ClickHouse/pull/72854) ([Anton Popov](https://github.com/CurtizJ))。
- 修复在备份中存在空文件时使用 plain rewritable 磁盘的备份/恢复问题。[#72858](https://github.com/ClickHouse/ClickHouse/pull/72858) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 正确取消 DistributedAsyncInsertDirectoryQueue 中的插入操作。[#72885](https://github.com/ClickHouse/ClickHouse/pull/72885) ([Antonio Andelic](https://github.com/antonio2368))。
- 修复将不正确的数据解析到稀疏列时的崩溃(可能在启用 `enable_parsing_to_custom_serialization` 设置时发生)。[#72891](https://github.com/ClickHouse/ClickHouse/pull/72891) ([Anton Popov](https://github.com/CurtizJ))。
- 修复备份恢复期间可能发生的崩溃。[#72947](https://github.com/ClickHouse/ClickHouse/pull/72947) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 修复 `parallel_hash` JOIN 方法中的错误,该错误可能在查询的 `ON` 子句中包含不等式过滤器的复杂条件时出现。[#72993](https://github.com/ClickHouse/ClickHouse/pull/72993) ([Nikita Taranov](https://github.com/nickitat))。
- 在 JSON 解析期间使用默认格式设置以避免反序列化损坏。[#73043](https://github.com/ClickHouse/ClickHouse/pull/73043) ([Pavel Kruglov](https://github.com/Avogar))。
- 修复不支持的存储引擎中事务的崩溃问题。[#73045](https://github.com/ClickHouse/ClickHouse/pull/73045) ([Raúl Marín](https://github.com/Algunenano))。
- 修复内存跟踪可能的高估问题(当 `MemoryTracking` 和 `MemoryResident` 之间的差异持续增长时)。[#73081](https://github.com/ClickHouse/ClickHouse/pull/73081) ([Azat Khuzhin](https://github.com/azat))。
- 在 Tuple 解析期间检查重复的 JSON 键。以前这可能导致解析期间出现逻辑错误 `Invalid number of rows in Chunk`。[#73082](https://github.com/ClickHouse/ClickHouse/pull/73082) ([Pavel Kruglov](https://github.com/Avogar))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement}

- 之前存储在 `/utils` 文件夹中、需要手动从源代码编译的所有小型实用工具现已成为 ClickHouse 主包的一部分。此更改解决了：[#72404](https://github.com/ClickHouse/ClickHouse/issues/72404)。[#72426](https://github.com/ClickHouse/ClickHouse/pull/72426) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 移除 22.3 版本中引入的 `/etc/systemd/system/clickhouse-server.service` 删除操作 [#39323](https://github.com/ClickHouse/ClickHouse/issues/39323)。[#72259](https://github.com/ClickHouse/ClickHouse/pull/72259) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- 拆分大型编译单元以避免因内存/CPU 限制导致的编译失败。[#72352](https://github.com/ClickHouse/ClickHouse/pull/72352) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
- OSX：构建时启用 ICU 支持，从而支持排序规则、字符集转换和其他本地化功能。[#73083](https://github.com/ClickHouse/ClickHouse/pull/73083) ([Raúl Marín](https://github.com/Algunenano))。

### <a id="2411"></a> ClickHouse 24.11 版本发布，2024-11-26 {#a-id2411a-clickhouse-release-2411-2024-11-26}

#### 向后不兼容的变更 {#backward-incompatible-change-1}

- 移除系统表 `generate_series` 和 `generateSeries`。它们是在此处被错误添加的：[#59390](https://github.com/ClickHouse/ClickHouse/issues/59390)。[#71091](https://github.com/ClickHouse/ClickHouse/pull/71091) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 移除 `StorageExternalDistributed`。解决了 [#70600](https://github.com/ClickHouse/ClickHouse/issues/70600)。[#71176](https://github.com/ClickHouse/ClickHouse/pull/71176) ([flynn](https://github.com/ucasfl))。
- 表引擎 Kafka、NATS 和 RabbitMQ 现在在 `SOURCES` 层次结构中拥有各自的授权。需要为使用这些引擎类型创建表的任何非默认数据库用户添加相应授权。[#71250](https://github.com/ClickHouse/ClickHouse/pull/71250) ([Christoph Wurm](https://github.com/cwurm))。
- 在执行完整的变更查询之前进行检查(包括子查询)。这可以防止意外运行无效查询并累积阻塞有效变更的失效变更。[#71300](https://github.com/ClickHouse/ClickHouse/pull/71300) ([Christoph Wurm](https://github.com/cwurm))。
- 将文件系统缓存设置 `skip_download_if_exceeds_query_cache` 重命名为 `filesystem_cache_skip_download_if_exceeds_per_query_cache_write_limit`。[#71578](https://github.com/ClickHouse/ClickHouse/pull/71578) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 移除 `deltaSumTimestamp` 中对 `Enum` 以及 `UInt128` 和 `UInt256` 参数的支持。移除 `deltaSumTimestamp` 第二个("timestamp")参数对 `Int8`、`UInt8`、`Int16` 和 `UInt16` 的支持。[#71790](https://github.com/ClickHouse/ClickHouse/pull/71790) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 当使用 Dictionary 存储、字典表函数或直接从字典本身进行 SELECT 来直接从字典检索数据时,现在只需拥有字典的 `SELECT` 权限或 `dictGet` 权限即可。这与之前防止 ACL 绕过的尝试保持一致:https://github.com/ClickHouse/ClickHouse/pull/57362 和 https://github.com/ClickHouse/ClickHouse/pull/65359。这也使后者向后兼容。[#72051](https://github.com/ClickHouse/ClickHouse/pull/72051) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。


#### 实验性功能 {#experimental-feature}

- 实现 `allow_feature_tier` 作为全局开关,用于禁用所有实验性/Beta 功能。[#71841](https://github.com/ClickHouse/ClickHouse/pull/71841) [#71145](https://github.com/ClickHouse/ClickHouse/pull/71145) ([Raúl Marín](https://github.com/Algunenano))。
- 修复因 JSON 子列文件中未转义的特殊符号而可能导致的 `No such file or directory` 错误。[#71182](https://github.com/ClickHouse/ClickHouse/pull/71182) ([Pavel Kruglov](https://github.com/Avogar))。
- 支持从 String 类型 ALTER 为 JSON 类型。此 PR 还将 JSON 和 Dynamic 类型的序列化方式更改为新版本 V2。旧版本 V1 仍可通过启用设置 `merge_tree_use_v1_object_and_dynamic_serialization` 来使用(可在升级期间使用,以便能够无问题地回滚版本)。[#70442](https://github.com/ClickHouse/ClickHouse/pull/70442) ([Pavel Kruglov](https://github.com/Avogar))。
- 实现从 Map/Tuple/Object 到新 JSON 类型的简单 CAST 转换,通过 JSON 字符串的序列化/反序列化完成。[#71320](https://github.com/ClickHouse/ClickHouse/pull/71320) ([Pavel Kruglov](https://github.com/Avogar))。
- 默认情况下不允许在 ORDER BY/GROUP BY/PARTITION BY/PRIMARY KEY 中使用 Variant/Dynamic 类型,因为这可能导致意外结果。[#69731](https://github.com/ClickHouse/ClickHouse/pull/69731) ([Pavel Kruglov](https://github.com/Avogar))。
- 禁止在 min/max 函数中使用 Dynamic/Variant 类型,以避免混淆。[#71761](https://github.com/ClickHouse/ClickHouse/pull/71761) ([Pavel Kruglov](https://github.com/Avogar))。

#### 新功能 {#new-feature-1}

- 添加了用于描述工作负载和资源管理的 SQL 语法。https://clickhouse.com/docs/operations/workload-scheduling。[#69187](https://github.com/ClickHouse/ClickHouse/pull/69187) ([Sergei Trifonov](https://github.com/serxa))。
- 新增数据类型 `BFloat16`,表示具有 8 位指数、符号位和 7 位尾数的 16 位浮点数。此功能解决了 [#44206](https://github.com/ClickHouse/ClickHouse/issues/44206)。此功能解决了 [#49937](https://github.com/ClickHouse/ClickHouse/issues/49937)。[#64712](https://github.com/ClickHouse/ClickHouse/pull/64712) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 添加 `CHECK GRANT` 查询,用于检查当前用户/角色是否已被授予特定权限,以及相应的表/列是否存在于内存中。[#68885](https://github.com/ClickHouse/ClickHouse/pull/68885) ([Unalian](https://github.com/Unalian))。
- 添加 `iceberg[S3;HDFS;Azure]Cluster`、`deltaLakeCluster`、`hudiCluster` 表函数。[#72045](https://github.com/ClickHouse/ClickHouse/pull/72045) ([Mikhail Artemenko](https://github.com/Michicosun))。
- 添加在 http_handlers 中设置用户名/密码的功能(适用于 `dynamic_query_handler`/`predefined_query_handler`)。[#70725](https://github.com/ClickHouse/ClickHouse/pull/70725) ([Azat Khuzhin](https://github.com/azat))。
- 在 ORDER BY WITH FILL 操作符中添加对 staleness 子句的支持。[#71151](https://github.com/ClickHouse/ClickHouse/pull/71151) ([Mikhail Artemenko](https://github.com/Michicosun))。
- 允许每个身份验证方法拥有自己的过期日期,并从用户实体中移除该属性。[#70090](https://github.com/ClickHouse/ClickHouse/pull/70090) ([Arthur Passos](https://github.com/arthurpassos))。
- 添加了新函数 `parseDateTime64`、`parseDateTime64OrNull` 和 `parseDateTime64OrZero`。与现有函数 `parseDateTime`(及其变体)相比,它们返回 `DateTime64` 类型的值而不是 `DateTime` 类型。[#71581](https://github.com/ClickHouse/ClickHouse/pull/71581) ([kevinyhzou](https://github.com/KevinyhZou))。


#### 性能改进 {#performance-improvement-1}

- 优化了当数据分片的粒度为常量时索引粒度值的内存使用。新增了始终为数据分片选择常量粒度的能力(设置 `use_const_adaptive_granularity`),这有助于确保其在内存中始终得到优化。这有助于在大型工作负载(共享存储中数万亿行)中避免数据分片元数据(索引粒度值)导致的内存使用持续增长。[#71786](https://github.com/ClickHouse/ClickHouse/pull/71786) ([Anton Popov](https://github.com/CurtizJ))。
- 现在当使用 `join_algorithm = 'parallel_hash'` 在线程间分配输入数据块列进行并行处理时,我们不再复制这些列。[#67782](https://github.com/ClickHouse/ClickHouse/pull/67782) ([Nikita Taranov](https://github.com/nickitat))。
- 优化了针对非交叉数据分片的 `Replacing` 合并算法。[#70977](https://github.com/ClickHouse/ClickHouse/pull/70977) ([Anton Popov](https://github.com/CurtizJ))。
- 在指标和 system.detached_parts 中不再列出只读和一次写入磁盘上的已分离数据分片。[#71086](https://github.com/ClickHouse/ClickHouse/pull/71086) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 默认情况下不再计算重量级异步指标。该功能在 [#40332](https://github.com/ClickHouse/ClickHouse/issues/40332) 中引入,但拥有一个仅为单个客户需要的重量级后台任务并不合适。[#71087](https://github.com/ClickHouse/ClickHouse/pull/71087) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 对于 `plain_rewritable` 磁盘:在列出目录时不再调用对象存储 API,因为这可能成本效率低下。而是将文件名列表存储在内存中。权衡之处在于增加了初始加载时间和存储文件名所需的内存。[#70823](https://github.com/ClickHouse/ClickHouse/pull/70823) ([Julia Kartseva](https://github.com/jkartseva))。
- 通过减少临界区,提高了 `system.query_metric_log` 收集间隔的性能和准确性。[#71473](https://github.com/ClickHouse/ClickHouse/pull/71473) ([Pablo Marcos](https://github.com/pamarcos))。
- 通过生成虚拟行进行顺序读取优化,从而在合并排序期间读取更少的数据,在存在多个数据分片时尤其有用。[#62125](https://github.com/ClickHouse/ClickHouse/pull/62125) ([Shichao Jin](https://github.com/jsc0218))。
- 新增服务器设置 `async_load_system_database`,允许服务器在系统数据库未完全加载的情况下启动。当存在大量系统表时,这有助于更快地启动 ClickHouse。[#69847](https://github.com/ClickHouse/ClickHouse/pull/69847) ([Sergei Trifonov](https://github.com/serxa))。
- 为 `clickhouse-compressor` 添加了 `--threads` 参数,允许并行压缩数据。[#70860](https://github.com/ClickHouse/ClickHouse/pull/70860) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 新增设置 `prewarm_mark_cache`,可在插入、合并、获取数据分片以及表启动时将标记加载到标记缓存中。[#71053](https://github.com/ClickHouse/ClickHouse/pull/71053) ([Anton Popov](https://github.com/CurtizJ))。
- 收缩 index_granularity 数组以适应内存大小,从而减少 MergeTree 表引擎系列的内存占用。[#71595](https://github.com/ClickHouse/ClickHouse/pull/71595) ([alesapin](https://github.com/alesapin))。
- 对于非磁盘读取关闭文件系统缓存设置 `boundary_alignment`,这提高了从独立远程文件读取并使用缓存时的性能。[#71827](https://github.com/ClickHouse/ClickHouse/pull/71827) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 类似 `SELECT * FROM table LIMIT ...` 的查询过去会加载数据分片索引,即使这些索引并未被使用。[#71866](https://github.com/ClickHouse/ClickHouse/pull/71866) ([Alexander Gololobov](https://github.com/davenger))。
- 默认启用 `parallel_replicas_local_plan`。在查询发起者上构建完整的本地计划可以提高并行副本的性能并减少资源消耗,同时提供应用更多查询优化的机会。[#70171](https://github.com/ClickHouse/ClickHouse/pull/70171) ([Igor Nikonov](https://github.com/devcrafter))。





#### 改进 {#improvement-1}

- 允许使用文件参数调用 clickhouse,例如 `ch queries.sql`。[#71589](https://github.com/ClickHouse/ClickHouse/pull/71589) ([Raúl Marín](https://github.com/Algunenano))。
- `Vertical` 格式(当您以 `\G` 结束查询时也会激活)现在具有 Pretty 格式的特性,例如:- 高亮显示数字中的千位分组;- 打印可读的数字提示。[#71630](https://github.com/ClickHouse/ClickHouse/pull/71630) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 将外部用户角色从查询发起节点推送到集群中的其他节点。当只有发起节点能够访问外部身份验证器(如 LDAP)时很有用。[#70332](https://github.com/ClickHouse/ClickHouse/pull/70332) ([Andrey Zvonov](https://github.com/zvonand))。
- 为聚合函数 `any` 添加了别名 `anyRespectNulls`、`firstValueRespectNulls` 和 `anyValueRespectNulls`。同时为聚合函数 `anyLast` 添加了别名 `anyLastRespectNulls` 和 `lastValueRespectNulls`。这允许使用更自然的纯驼峰命名语法,而不是混合驼峰/下划线语法,例如:`SELECT anyLastRespectNullsStateIf` 而不是 `anyLast_respect_nullsStateIf`。[#71403](https://github.com/ClickHouse/ClickHouse/pull/71403) ([Peter Nguyen](https://github.com/petern48))。
- 添加了配置参数 `date_time_utc`,使 JSON 日志格式支持 RFC 3339/ISO8601 格式的 UTC 日期时间。[#71560](https://github.com/ClickHouse/ClickHouse/pull/71560) ([Ali](https://github.com/xogoodnow))。
- 为 S3 端点的用户身份验证添加了新的标头类型(`access_header`)。这允许获取具有最低优先级的访问标头,该标头将被来自任何其他源(例如表结构或命名集合)的 `access_key_id` 覆盖。[#71011](https://github.com/ClickHouse/ClickHouse/pull/71011) ([MikhailBurdukov](https://github.com/MikhailBurdukov))。
- 具有常量数组和常量捕获参数的高阶函数将返回常量。[#58400](https://github.com/ClickHouse/ClickHouse/pull/58400) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 查询计划步骤名称(`EXPLAIN PLAN json=1`)和管道处理器名称(`EXPLAIN PIPELINE compact=0,graph=1`)现在具有唯一 ID 作为后缀。这允许将处理器性能分析输出和 OpenTelemetry 跟踪与 explain 输出进行匹配。[#63518](https://github.com/ClickHouse/ClickHouse/pull/63518) ([qhsong](https://github.com/qhsong))。
- 添加了在将对象写入 Azure Blob Storage 后检查对象是否存在的选项,该选项由设置 `check_objects_after_upload` 控制。[#64847](https://github.com/ClickHouse/ClickHouse/pull/64847) ([Smita Kulkarni](https://github.com/SmitaRKulkarni))。
- 在 `clickhouse-local` 中默认使用 `Atomic` 数据库。解决了 [#50647](https://github.com/ClickHouse/ClickHouse/issues/50647) 中的第 1 项和第 5 项。关闭 [#44817](https://github.com/ClickHouse/ClickHouse/issues/44817)。[#68024](https://github.com/ClickHouse/ClickHouse/pull/68024) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 异常会中断 HTTP 协议以向客户端发出错误警报。[#68800](https://github.com/ClickHouse/ClickHouse/pull/68800) ([Sema Checherinda](https://github.com/CheSema))。
- 通过创建 replica_dir 并在 DDLWorker 中将副本标记为活动状态来报告运行分布式 DDL 查询的主机。[#69658](https://github.com/ClickHouse/ClickHouse/pull/69658) ([tuanpach](https://github.com/tuanpach))。
- 如果 distributed_ddl_output_mode 设置为 \*\_only_active,则仅在活动副本上等待数据库 ON CLUSTER 查询。[#69660](https://github.com/ClickHouse/ClickHouse/pull/69660) ([tuanpach](https://github.com/tuanpach))。
- 改进了 `ON CLUSTER` 备份和恢复的错误处理和取消机制:- 如果备份或恢复在一台主机上失败,则会在其他主机上自动取消 - 不会因为某些主机失败而其他主机继续工作而产生异常错误 - 如果备份或恢复在一台主机上被取消,则会在其他主机上自动取消 - 修复了 `test_disallow_concurrency` 的问题 - 现在禁用并发应该能更好地工作 - 备份和恢复现在对 ZooKeeper 断开连接的抵抗力更强。[#70027](https://github.com/ClickHouse/ClickHouse/pull/70027) ([Vitaly Baranov](https://github.com/vitlibar))。
- 支持对存储引擎 S3Queue 中的某些设置使用 `ALTER TABLE ... MODIFY/RESET SETTING ...`。[#70811](https://github.com/ClickHouse/ClickHouse/pull/70811) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 添加了以与重新加载服务器证书相同的方式重新加载客户端证书的功能。[#70997](https://github.com/ClickHouse/ClickHouse/pull/70997) ([Roman Antonov](https://github.com/Romeo58rus))。
- 使客户端历史记录大小可配置,并增加其默认大小。[#71014](https://github.com/ClickHouse/ClickHouse/pull/71014) ([Jiří Kozlovský](https://github.com/jirislav))。
- Parquet 原生读取器支持布尔类型。[#71055](https://github.com/ClickHouse/ClickHouse/pull/71055) ([Arthur Passos](https://github.com/arthurpassos))。
- 在与 S3 交互时重试更多错误,例如"格式错误的消息"。[#71088](https://github.com/ClickHouse/ClickHouse/pull/71088) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 降低某些关于 S3 的消息的日志级别。[#71090](https://github.com/ClickHouse/ClickHouse/pull/71090) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 支持写入包含空格的 HDFS 文件。[#71105](https://github.com/ClickHouse/ClickHouse/pull/71105) ([exmy](https://github.com/exmy))。
- 添加了限制复制表、字典和视图数量的设置。[#71179](https://github.com/ClickHouse/ClickHouse/pull/71179) ([Kirill](https://github.com/kirillgarbar))。
- 如果 `AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE` 可用,则使用它而不是 `AWS_CONTAINER_AUTHORIZATION_TOKEN`。修复 [#71074](https://github.com/ClickHouse/ClickHouse/issues/71074)。[#71269](https://github.com/ClickHouse/ClickHouse/pull/71269) ([Konstantin Bogdanov](https://github.com/thevar1able))。
- 从 ReplicatedMergeTree 重启线程中移除 metadata_version ZooKeeper 节点的创建。唯一需要创建此节点的场景是用户从 20.4 之前的版本直接升级到 24.10 之后的版本。ClickHouse 不支持跨度超过一年的升级,因此我们应该抛出异常并要求用户逐步升级,而不是创建该节点。[#71385](https://github.com/ClickHouse/ClickHouse/pull/71385) ([Miсhael Stetsyuk](https://github.com/mstetsyuk))。
- 向高级仪表板添加每个主机的仪表板 `Overview (host)` 和 `Cloud overview (host)`。[#71422](https://github.com/ClickHouse/ClickHouse/pull/71422) ([alesapin](https://github.com/alesapin))。
- `clickhouse-local` 默认使用隐式 SELECT,这允许将其用作计算器。改进隐式 SELECT 模式的语法高亮显示。[#71620](https://github.com/ClickHouse/ClickHouse/pull/71620) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 命令行应用程序将为多语句高亮显示语法。[#71622](https://github.com/ClickHouse/ClickHouse/pull/71622) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 命令行应用程序在出错时将返回非零退出代码。在以前的版本中,`disks` 应用程序在出错时返回零,其他应用程序对错误 256(`PARTITION_ALREADY_EXISTS`)和 512(`SET_NON_GRANTED_ROLE`)返回零。[#71623](https://github.com/ClickHouse/ClickHouse/pull/71623) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 当用户/组以 ID 形式给出时,`clickhouse su` 会失败。此补丁修复了该问题,使其也能接受 `UID:GID`。[#71626](https://github.com/ClickHouse/ClickHouse/pull/71626) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- 允许通过设置 `filesystem_cache_prefer_bigger_buffer_size` 禁用文件系统缓存的内存缓冲区增加。[#71640](https://github.com/ClickHouse/ClickHouse/pull/71640) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 为文件系统缓存中的后台下载最大文件段大小添加单独的设置 `background_download_max_file_segment_size`。[#71648](https://github.com/ClickHouse/ClickHouse/pull/71648) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 稍微改进了 JSON 类型解析:如果 JSON 路径的当前块包含多种类型的值,则尝试通过按特殊的尽力而为顺序尝试类型来选择最佳类型。[#71785](https://github.com/ClickHouse/ClickHouse/pull/71785) ([Pavel Kruglov](https://github.com/Avogar))。
- 以前从 `system.asynchronous_metrics` 读取会等待并发更新完成。如果系统负载很重,这可能需要很长时间。通过此更改,始终可以读取先前收集的值。[#71798](https://github.com/ClickHouse/ClickHouse/pull/71798) ([Alexander Gololobov](https://github.com/davenger))。
- S3Queue 和 AzureQueue:将 `polling_max_timeout_ms` 设置为 10 分钟,将 `polling_backoff_ms` 设置为 30 秒。[#71817](https://github.com/ClickHouse/ClickHouse/pull/71817) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 在一个 `history` 周期内更新 `HostResolver` 三次。[#71863](https://github.com/ClickHouse/ClickHouse/pull/71863) ([Sema Checherinda](https://github.com/CheSema))。
- 在高级仪表板 HTML 页面上添加了从 `system.dashboards` 表中选择仪表板的下拉选择器。[#72081](https://github.com/ClickHouse/ClickHouse/pull/72081) ([Sergei Trifonov](https://github.com/serxa))。
- 在授权后检查默认数据库是否存在。修复 [#71097](https://github.com/ClickHouse/ClickHouse/issues/71097)。[#71140](https://github.com/ClickHouse/ClickHouse/pull/71140) ([Konstantin Bogdanov](https://github.com/thevar1able))。





#### Bug Fix (官方稳定版本中用户可见的错误行为) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-1}

- The parts deduplicated during `ATTACH PART` query don't get stuck with the `attaching_` prefix anymore. [#65636](https://github.com/ClickHouse/ClickHouse/pull/65636) ([Kirill](https://github.com/kirillgarbar)).
- Fix for the bug when DateTime64 losing precision for the `IN` function. [#67230](https://github.com/ClickHouse/ClickHouse/pull/67230) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fix possible logical error when using functions with `IGNORE/RESPECT NULLS` in `ORDER BY ... WITH FILL`, close [#57609](https://github.com/ClickHouse/ClickHouse/issues/57609). [#68234](https://github.com/ClickHouse/ClickHouse/pull/68234) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Fixed rare logical errors in asynchronous inserts with format `Native` in case of reached memory limit. [#68965](https://github.com/ClickHouse/ClickHouse/pull/68965) ([Anton Popov](https://github.com/CurtizJ)).
- Fix COMMENT in CREATE TABLE for EPHEMERAL column. [#70458](https://github.com/ClickHouse/ClickHouse/pull/70458) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix logical error in JSONExtract with LowCardinality(Nullable). [#70549](https://github.com/ClickHouse/ClickHouse/pull/70549) ([Pavel Kruglov](https://github.com/Avogar)).
- Allow system drop replica zkpath when there is another replica with the same zk path. [#70642](https://github.com/ClickHouse/ClickHouse/pull/70642) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
- Fix a crash and a leak in AggregateFunctionGroupArraySorted. [#70820](https://github.com/ClickHouse/ClickHouse/pull/70820) ([Michael Kolupaev](https://github.com/al13n321)).
- Add ability to override Content-Type by user headers in the URL engine. [#70859](https://github.com/ClickHouse/ClickHouse/pull/70859) ([Artem Iurin](https://github.com/ortyomka)).
- Fix logical error in `StorageS3Queue` "Cannot create a persistent node in /processed since it already exists". [#70984](https://github.com/ClickHouse/ClickHouse/pull/70984) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fixed named sessions not being closed and hanging on forever under certain circumstances. [#70998](https://github.com/ClickHouse/ClickHouse/pull/70998) ([Márcio Martins](https://github.com/marcio-absmartly)).
- Fix the bug that didn't consider \_row_exists column in rebuild option of projection lightweight delete. [#71089](https://github.com/ClickHouse/ClickHouse/pull/71089) ([Shichao Jin](https://github.com/jsc0218)).
- Fix `AT_* is out of range` problem when running on Oracle Linux UEK 6.10. [#71109](https://github.com/ClickHouse/ClickHouse/pull/71109) ([Örjan Fors](https://github.com/op)).
- Fix wrong value in system.query_metric_log due to unexpected race condition. [#71124](https://github.com/ClickHouse/ClickHouse/pull/71124) ([Pablo Marcos](https://github.com/pamarcos)).
- Fix mismatched aggreage function name of quantileExactWeightedInterpolated. The bug was introduced in https://github.com/ClickHouse/ClickHouse/pull/69619. cc @Algunenano. [#71168](https://github.com/ClickHouse/ClickHouse/pull/71168) ([李扬](https://github.com/taiyang-li)).
- Fix bad_weak_ptr exception with Dynamic in functions comparison. [#71183](https://github.com/ClickHouse/ClickHouse/pull/71183) ([Pavel Kruglov](https://github.com/Avogar)).
- Checks that read 7z file is on a local machine. [#71184](https://github.com/ClickHouse/ClickHouse/pull/71184) ([Daniil Ivanik](https://github.com/divanik)).
- Fix ignoring format settings in Native format via HTTP and Async Inserts. [#71193](https://github.com/ClickHouse/ClickHouse/pull/71193) ([Pavel Kruglov](https://github.com/Avogar)).
- SELECT queries run with setting `use_query_cache = 1` are no longer rejected if the name of a system table appears as a literal, e.g. `SELECT * FROM users WHERE name = 'system.metrics' SETTINGS use_query_cache = true;` now works. [#71254](https://github.com/ClickHouse/ClickHouse/pull/71254) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix bug of memory usage increase if enable_filesystem_cache=1, but disk in storage configuration did not have any cache configuration. [#71261](https://github.com/ClickHouse/ClickHouse/pull/71261) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix possible error "Cannot read all data" erros during deserialization of LowCardinality dictionary from Dynamic column. [#71299](https://github.com/ClickHouse/ClickHouse/pull/71299) ([Pavel Kruglov](https://github.com/Avogar)).
- Fix incomplete cleanup of parallel output format in the client. [#71304](https://github.com/ClickHouse/ClickHouse/pull/71304) ([Raúl Marín](https://github.com/Algunenano)).
- Added missing unescaping in named collections. Without fix clickhouse-server can't start. [#71308](https://github.com/ClickHouse/ClickHouse/pull/71308) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
- Fix async inserts with empty blocks via native protocol. [#71312](https://github.com/ClickHouse/ClickHouse/pull/71312) ([Anton Popov](https://github.com/CurtizJ)).
- Fix inconsistent AST formatting when granting wrong wildcard grants [#71309](https://github.com/ClickHouse/ClickHouse/issues/71309). [#71332](https://github.com/ClickHouse/ClickHouse/pull/71332) ([pufit](https://github.com/pufit)).
- Add try/catch to data parts destructors to avoid std::terminate. [#71364](https://github.com/ClickHouse/ClickHouse/pull/71364) ([alesapin](https://github.com/alesapin)).
- Check suspicious and experimental types in JSON type hints. [#71369](https://github.com/ClickHouse/ClickHouse/pull/71369) ([Pavel Kruglov](https://github.com/Avogar)).
- Start memory worker thread on non-Linux OS too (fixes [#71051](https://github.com/ClickHouse/ClickHouse/issues/71051)). [#71384](https://github.com/ClickHouse/ClickHouse/pull/71384) ([Alexandre Snarskii](https://github.com/snar)).
- Fix error Invalid number of rows in Chunk with the Variant column. [#71388](https://github.com/ClickHouse/ClickHouse/pull/71388) ([Pavel Kruglov](https://github.com/Avogar)).
- Fix error column "attgenerated" does not exist for older PostgreSQL versions, fix [#60651](https://github.com/ClickHouse/ClickHouse/issues/60651). [#71396](https://github.com/ClickHouse/ClickHouse/pull/71396) ([0xMihalich](https://github.com/0xMihalich)).
- To avoid spamming the server logs, failing authentication attempts are now logged at level `DEBUG` instead of `ERROR`. [#71405](https://github.com/ClickHouse/ClickHouse/pull/71405) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix crash in `mongodb` table function when passing wrong arguments (e.g. `NULL`). [#71426](https://github.com/ClickHouse/ClickHouse/pull/71426) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Fix crash with optimize_rewrite_array_exists_to_has. [#71432](https://github.com/ClickHouse/ClickHouse/pull/71432) ([Raúl Marín](https://github.com/Algunenano)).
- Fixed the usage of setting `max_insert_delayed_streams_for_parallel_write` in inserts. Previously it worked incorrectly which could lead to high memory usage in inserts which write data into several partitions. [#71474](https://github.com/ClickHouse/ClickHouse/pull/71474) ([Anton Popov](https://github.com/CurtizJ)).
- Fix possible error `Argument for function must be constant` (old analyzer) in case when arrayJoin can apparently appear in `WHERE` condition. Regression after https://github.com/ClickHouse/ClickHouse/pull/65414. [#71476](https://github.com/ClickHouse/ClickHouse/pull/71476) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Prevent crash in SortCursor with 0 columns (old analyzer). [#71494](https://github.com/ClickHouse/ClickHouse/pull/71494) ([Raúl Marín](https://github.com/Algunenano)).
- Fix Date32 out of range caused by uninitialized ORC data. For more details, refer to https://github.com/apache/incubator-gluten/issues/7823. [#71500](https://github.com/ClickHouse/ClickHouse/pull/71500) ([李扬](https://github.com/taiyang-li)).
- Fix counting column size in wide part for Dynamic and JSON types. [#71526](https://github.com/ClickHouse/ClickHouse/pull/71526) ([Pavel Kruglov](https://github.com/Avogar)).
- Analyzer fix when query inside materialized view uses IN with CTE. Closes [#65598](https://github.com/ClickHouse/ClickHouse/issues/65598). [#71538](https://github.com/ClickHouse/ClickHouse/pull/71538) ([Maksim Kita](https://github.com/kitaisreal)).
- Avoid crash when using a UDF in a constraint. [#71541](https://github.com/ClickHouse/ClickHouse/pull/71541) ([Raúl Marín](https://github.com/Algunenano)).
- Return 0 or default char instead of throwing an error in bitShift functions in case of out of bounds. [#71580](https://github.com/ClickHouse/ClickHouse/pull/71580) ([Pablo Marcos](https://github.com/pamarcos)).
- Fix server crashes while using materialized view with certain engines. [#71593](https://github.com/ClickHouse/ClickHouse/pull/71593) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
- Array join with a nested data structure, which contains an alias to a constant array was leading to a null pointer dereference. This closes [#71677](https://github.com/ClickHouse/ClickHouse/issues/71677). [#71678](https://github.com/ClickHouse/ClickHouse/pull/71678) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix LOGICAL_ERROR when doing ALTER with empty tuple. This fixes [#71647](https://github.com/ClickHouse/ClickHouse/issues/71647). [#71679](https://github.com/ClickHouse/ClickHouse/pull/71679) ([Amos Bird](https://github.com/amosbird)).
- Don't transform constant set in predicates over partition columns in case of NOT IN operator. [#71695](https://github.com/ClickHouse/ClickHouse/pull/71695) ([Eduard Karacharov](https://github.com/korowa)).
- Fix docker init script fail log message for more clean understanding. [#71734](https://github.com/ClickHouse/ClickHouse/pull/71734) ([Андрей](https://github.com/andreineustroev)).
- Fix CAST from LowCardinality(Nullable) to Dynamic. Previously it could lead to error `Bad cast from type DB::ColumnVector<int> to DB::ColumnNullable`. [#71742](https://github.com/ClickHouse/ClickHouse/pull/71742) ([Pavel Kruglov](https://github.com/Avogar)).
- Fix exception for toDayOfWeek on WHERE condition with primary key of DateTime64 type. [#71849](https://github.com/ClickHouse/ClickHouse/pull/71849) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fixed filling of defaults after parsing into sparse columns. [#71854](https://github.com/ClickHouse/ClickHouse/pull/71854) ([Anton Popov](https://github.com/CurtizJ)).
- Fix GROUPING function error when input is ALIAS on distributed table, close [#68602](https://github.com/ClickHouse/ClickHouse/issues/68602). [#71855](https://github.com/ClickHouse/ClickHouse/pull/71855) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Fix possible crash when using `allow_experimental_join_condition`, close [#71693](https://github.com/ClickHouse/ClickHouse/issues/71693). [#71857](https://github.com/ClickHouse/ClickHouse/pull/71857) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Fixed select statements that use `WITH TIES` clause which might not return enough rows. [#71886](https://github.com/ClickHouse/ClickHouse/pull/71886) ([wxybear](https://github.com/wxybear)).
- Fix the TOO_LARGE_ARRAY_SIZE exception caused when a column of arrayWithConstant evaluation is mistaken to cross the array size limit. [#71894](https://github.com/ClickHouse/ClickHouse/pull/71894) ([Udi](https://github.com/udiz)).
- `clickhouse-benchmark` reported wrong metrics for queries taking longer than one second. [#71898](https://github.com/ClickHouse/ClickHouse/pull/71898) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix data race between the progress indicator and the progress table in clickhouse-client. This issue is visible when FROM INFILE is used. Intercept keystrokes during INSERT queries to toggle progress table display. [#71901](https://github.com/ClickHouse/ClickHouse/pull/71901) ([Julia Kartseva](https://github.com/jkartseva)).
- Use auxiliary keepers for cluster autodiscovery. [#71911](https://github.com/ClickHouse/ClickHouse/pull/71911) ([Anton Ivashkin](https://github.com/ianton-ru)).
- Fix rows_processed column in system.s3/azure_queue_log broken in 24.6. Closes [#69975](https://github.com/ClickHouse/ClickHouse/issues/69975). [#71946](https://github.com/ClickHouse/ClickHouse/pull/71946) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fixed case when `s3`/`s3Cluster` functions could return incomplete result or throw an exception. It involved using glob pattern in s3 uri (like `pattern/*`) and an empty object should exist with the key `pattern/` (such objects automatically created by S3 Console). Also default value for setting `s3_skip_empty_files` changed from `false` to `true` by default. [#71947](https://github.com/ClickHouse/ClickHouse/pull/71947) ([Nikita Taranov](https://github.com/nickitat)).
- Fix a crash in clickhouse-client syntax highlighting. Closes [#71864](https://github.com/ClickHouse/ClickHouse/issues/71864). [#71949](https://github.com/ClickHouse/ClickHouse/pull/71949) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix `Illegal type` error for `MergeTree` tables with binary monotonic function in `ORDER BY` when the first argument is constant. Fixes [#71941](https://github.com/ClickHouse/ClickHouse/issues/71941). [#71966](https://github.com/ClickHouse/ClickHouse/pull/71966) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Allow only SELECT queries in EXPLAIN AST used inside subquery. Other types of queries lead to logical error: 'Bad cast from type DB::ASTCreateQuery to DB::ASTSelectWithUnionQuery' or `Inconsistent AST formatting`. [#71982](https://github.com/ClickHouse/ClickHouse/pull/71982) ([Pavel Kruglov](https://github.com/Avogar)).
- When insert a record by `clickhouse-client`, client will read column descriptions from server. but there was a bug that we wrote the descritions with a wrong order , it should be [statistics, ttl, settings]. [#71991](https://github.com/ClickHouse/ClickHouse/pull/71991) ([Han Fei](https://github.com/hanfei1991)).
- Fix formatting of `MOVE PARTITION ... TO TABLE ...` alter commands when `format_alter_commands_with_parentheses` is enabled. [#72080](https://github.com/ClickHouse/ClickHouse/pull/72080) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fixes RIGHT / FULL joins in queries with parallel replicas. Now, RIGHT joins can be executed with parallel replicas (right table reading is distributed). FULL joins can't be parallelized among nodes, - executed locally. [#71162](https://github.com/ClickHouse/ClickHouse/pull/71162) ([Igor Nikonov](https://github.com/devcrafter)).
- Fix the issue where ClickHouse in Docker containers printed "get_mempolicy: Operation not permitted" into stderr due to restricted syscalls. [#70900](https://github.com/ClickHouse/ClickHouse/pull/70900) ([filimonov](https://github.com/filimonov)).
- Fix the metadata_version record in ZooKeeper in restarting thread rather than in attach thread. [#70297](https://github.com/ClickHouse/ClickHouse/pull/70297) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- This is a fix for "zero-copy" replication, which is unsupported and will be removed entirely. Don't delete a blob when there are nodes using it in ReplicatedMergeTree with zero-copy replication. [#71186](https://github.com/ClickHouse/ClickHouse/pull/71186) ([Antonio Andelic](https://github.com/antonio2368)).
- This is a fix for "zero-copy" replication, which is unsupported and will be removed entirely. Acquiring zero-copy shared lock before moving a part to zero-copy disk to prevent possible data loss if Keeper is unavailable. [#71845](https://github.com/ClickHouse/ClickHouse/pull/71845) ([Aleksei Filatov](https://github.com/aalexfvk)).

### <a id="2410"></a> ClickHouse 版本 24.10, 2024-10-31 {#a-id2410a-clickhouse-release-2410-2024-10-31}

#### 向后不兼容变更 {#backward-incompatible-change-2}

- 当子查询位于括号内时,现在允许在包含 `UNION` 的查询链中于 `FORMAT` 之前编写 `SETTINGS`。此更改解决了 [#39712](https://github.com/ClickHouse/ClickHouse/issues/39712)。同时更改了查询中连续两次指定 SETTINGS 子句时的行为。距离子查询最近的 SETTINGS 子句将优先应用于该子查询。在之前的版本中,最外层的 SETTINGS 子句可能会优先于内层子句。[#68614](https://github.com/ClickHouse/ClickHouse/pull/68614) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 现在默认允许对 `[PRE]WHERE` 子句中的过滤条件进行重新排序。可通过将 `allow_reorder_prewhere_conditions` 设置为 `false` 来禁用该功能。[#70657](https://github.com/ClickHouse/ClickHouse/pull/70657) ([Nikita Taranov](https://github.com/nickitat))。
- 移除了许可证不兼容的 `idxd-config` 库。同时也移除了实验性的 Intel DeflateQPL 编解码器。[#70987](https://github.com/ClickHouse/ClickHouse/pull/70987) ([Alexey Milovidov](https://github.com/alexey-milovidov))。


#### 新功能 {#new-feature-2}

- 允许授予通配符前缀的访问权限。`GRANT SELECT ON db.table_pefix_* TO user`。[#65311](https://github.com/ClickHouse/ClickHouse/pull/65311) ([pufit](https://github.com/pufit))。
- 在查询运行期间按下空格键,客户端将显示包含详细指标的实时表格。您可以在 clickhouse-client 中使用新的 `--progress-table` 选项全局启用此功能;新的 `--enable-progress-table-toggle` 选项与 `--progress-table` 选项关联,通过按下控制键(空格键)来切换进度表的渲染。[#63689](https://github.com/ClickHouse/ClickHouse/pull/63689) ([Maria Khristenko](https://github.com/mariaKhr)),[#70423](https://github.com/ClickHouse/ClickHouse/pull/70423) ([Julia Kartseva](https://github.com/jkartseva))。
- 允许为对象存储表引擎和数据湖缓存读取的文件,使用 ETag + 文件路径的哈希值作为缓存键。[#70135](https://github.com/ClickHouse/ClickHouse/pull/70135) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 支持使用查询创建表:`CREATE TABLE ... CLONE AS ...`。它会克隆源表的架构,然后将所有分区附加到新创建的表。此功能仅支持 `MergeTree` 系列的表。关闭 [#65015](https://github.com/ClickHouse/ClickHouse/issues/65015)。[#69091](https://github.com/ClickHouse/ClickHouse/pull/69091) ([tuanpach](https://github.com/tuanpach))。
- 添加新的系统表 `system.query_metric_log`,其中包含来自 system.events 表的各个查询的内存和指标值历史记录,定期刷新到磁盘。[#66532](https://github.com/ClickHouse/ClickHouse/pull/66532) ([Pablo Marcos](https://github.com/pamarcos))。
- 简单的 SELECT 查询可以使用隐式 SELECT 编写,以启用计算器风格的表达式,例如 `ch "1 + 2"`。这由新设置 `implicit_select` 控制。[#68502](https://github.com/ClickHouse/ClickHouse/pull/68502) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 支持 clickhouse local 的 `--copy` 模式作为格式转换的快捷方式 [#68503](https://github.com/ClickHouse/ClickHouse/issues/68503)。[#68583](https://github.com/ClickHouse/ClickHouse/pull/68583) ([Denis Hananein](https://github.com/denis-hananein))。
- 添加用于可视化合并的内置 HTML 页面,可在 `/merges` 路径访问。[#70821](https://github.com/ClickHouse/ClickHouse/pull/70821) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 添加对 `arrayUnion` 函数的支持。[#68989](https://github.com/ClickHouse/ClickHouse/pull/68989) ([Peter Nguyen](https://github.com/petern48))。
- 允许参数化的 SQL 别名。[#50665](https://github.com/ClickHouse/ClickHouse/pull/50665) ([Anton Kozlov](https://github.com/tonickkozlov))。
- 新的聚合函数 `quantileExactWeightedInterpolated`,这是基于 quantileExactWeighted 的插值版本。有些人可能会疑惑为什么我们需要新的 `quantileExactWeightedInterpolated`,因为我们已经有了 `quantileExactInterpolatedWeighted`。原因是新函数比旧函数更准确。这是为了与 Spark 兼容。[#69619](https://github.com/ClickHouse/ClickHouse/pull/69619) ([李扬](https://github.com/taiyang-li))。
- 新函数 `arrayElementOrNull`。如果数组索引超出范围或未找到 Map 键,则返回 `NULL`。[#69646](https://github.com/ClickHouse/ClickHouse/pull/69646) ([李扬](https://github.com/taiyang-li))。
- 允许用户通过 `config.xml` 文件中的新 `message_regexp` 和 `message_regexp_negative` 字段指定正则表达式来过滤日志记录。日志记录应用于格式化的无颜色文本,以提供最直观的开发者体验。[#69657](https://github.com/ClickHouse/ClickHouse/pull/69657) ([Peter Nguyen](https://github.com/petern48))。
- 添加 `RIPEMD160` 函数,用于计算字符串的 RIPEMD-160 加密哈希值。示例:`SELECT HEX(RIPEMD160('The quick brown fox jumps over the lazy dog'))` 返回 `37F332F68DB77BD9D7EDD4969571AD671CF9DD3B`。[#70087](https://github.com/ClickHouse/ClickHouse/pull/70087) ([Dergousov Maxim](https://github.com/m7kss1))。
- 支持读取 `HDFS` 上的 `Iceberg` 表。[#70268](https://github.com/ClickHouse/ClickHouse/pull/70268) ([flynn](https://github.com/ucasfl))。
- 支持 `WITH ... INSERT` 形式的 CTE,之前我们仅支持 `INSERT ... WITH ...`。[#70593](https://github.com/ClickHouse/ClickHouse/pull/70593) ([Shichao Jin](https://github.com/jsc0218))。
- MongoDB 集成:支持所有 MongoDB 类型,支持在 MongoDB 端执行 WHERE 和 ORDER BY 语句,限制 MongoDB 不支持的表达式。请注意,新集成默认处于禁用状态,要使用它,请在服务器配置中将 `<use_legacy_mongodb_integration>` 设置为 `false`。[#63279](https://github.com/ClickHouse/ClickHouse/pull/63279) ([Kirill Nikiforov](https://github.com/allmazz))。
- 添加新函数 `getSettingOrDefault`,用于返回默认值并在当前配置文件中未找到自定义设置时避免异常。[#69917](https://github.com/ClickHouse/ClickHouse/pull/69917) ([Shankar](https://github.com/shiyer7474))。

#### 实验性功能 {#experimental-feature-1}

- 可刷新物化视图已达到生产就绪状态。[#70550](https://github.com/ClickHouse/ClickHouse/pull/70550) ([Michael Kolupaev](https://github.com/al13n321))。可刷新物化视图现已支持在复制数据库中使用。[#60669](https://github.com/ClickHouse/ClickHouse/pull/60669) ([Michael Kolupaev](https://github.com/al13n321))。
- 并行副本功能已从实验性阶段升级至测试版。重新设计了控制并行副本算法行为的设置。简要回顾:ClickHouse 提供四种不同的多副本并行读取算法,通过 `parallel_replicas_mode` 设置进行配置,其默认值为 `read_tasks`。此外,还新增了开关设置 `enable_parallel_replicas`。[#63151](https://github.com/ClickHouse/ClickHouse/pull/63151) ([Alexey Milovidov](https://github.com/alexey-milovidov)), ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 大多数函数现已支持 `Dynamic` 类型,通过在 `Dynamic` 内部类型上执行函数来实现。[#69691](https://github.com/ClickHouse/ClickHouse/pull/69691) ([Pavel Kruglov](https://github.com/Avogar))。
- 允许在 `RowBinary` 格式中通过设置 `input_format_binary_read_json_as_string/output_format_binary_write_json_as_string` 将 `JSON` 类型作为二进制字符串进行读写。[#70288](https://github.com/ClickHouse/ClickHouse/pull/70288) ([Pavel Kruglov](https://github.com/Avogar))。
- 允许在 Native 格式中将 `JSON` 列序列化/反序列化为单个 String 列。对于输出,使用设置 `output_format_native_write_json_as_string`。对于输入,在列数据之前使用序列化版本 `1`。[#70312](https://github.com/ClickHouse/ClickHouse/pull/70312) ([Pavel Kruglov](https://github.com/Avogar))。
- 为 MergeTree 表引入了一种特殊的(实验性)合并选择器模式,该模式对接近分区数量限制的分区采取更激进的合并策略。该功能由 MergeTree 级别的设置 `merge_selector_use_blurry_base` 控制。[#70645](https://github.com/ClickHouse/ClickHouse/pull/70645) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 实现了 Avro 的 `Union` 类型与 ClickHouse 的 `Variant` 类型之间的通用序列化/反序列化。解决了 [#69713](https://github.com/ClickHouse/ClickHouse/issues/69713)。[#69712](https://github.com/ClickHouse/ClickHouse/pull/69712) ([Jiří Kozlovský](https://github.com/jirislav))。


#### 性能改进 {#performance-improvement-2}

- 重构 `IDisk` 和 `IObjectStorage` 以提升性能。来自 `plain` 和 `plain_rewritable` 对象存储的表初始化速度更快。[#68146](https://github.com/ClickHouse/ClickHouse/pull/68146) ([Alexey Milovidov](https://github.com/alexey-milovidov), [Julia Kartseva](https://github.com/jkartseva))。在判断 plain rewritable 磁盘上文件或目录是否存在时,不再调用 LIST 对象存储 API,因为这可能导致成本效率低下。[#70852](https://github.com/ClickHouse/ClickHouse/pull/70852) ([Julia Kartseva](https://github.com/jkartseva))。减少 plain_rewritable 磁盘中对象存储 HEAD API 请求的数量。[#70915](https://github.com/ClickHouse/ClickHouse/pull/70915) ([Julia Kartseva](https://github.com/jkartseva))。
- 新增将数据直接解析为稀疏列的功能。[#69828](https://github.com/ClickHouse/ClickHouse/pull/69828) ([Anton Popov](https://github.com/CurtizJ))。
- 改进了解析含有大量缺失值的格式(例如 `JSONEachRow`)的性能。[#69875](https://github.com/ClickHouse/ClickHouse/pull/69875) ([Anton Popov](https://github.com/CurtizJ))。
- 支持并行读取 Parquet 行组,以及在单线程模式下预取行组。[#69862](https://github.com/ClickHouse/ClickHouse/pull/69862) ([LiuNeng](https://github.com/liuneng1994))。
- 支持 `pointInPolygon` 的 minmax 索引。[#62085](https://github.com/ClickHouse/ClickHouse/pull/62085) ([JackyWoo](https://github.com/JackyWoo))。
- 读取 Parquet 文件时使用布隆过滤器。[#62966](https://github.com/ClickHouse/ClickHouse/pull/62966) ([Arthur Passos](https://github.com/arthurpassos))。
- 无锁数据分区重命名,避免 INSERT 影响 SELECT(由于分区锁)(在使用 `fsync_part_directory` 的正常情况下,并行执行 INSERT 时 SELECT 的 QPS 提升 2 倍,在高负载下效果更加显著)。注意,目前仅适用于 `ReplicatedMergeTree`。[#64955](https://github.com/ClickHouse/ClickHouse/pull/64955) ([Azat Khuzhin](https://github.com/azat))。
- 在 `materialize ttl` 中遵守 `ttl_only_drop_parts`;仅读取必要的列以重新计算 TTL,并通过替换为空分区来删除分区。[#65488](https://github.com/ClickHouse/ClickHouse/pull/65488) ([Andrey Zvonov](https://github.com/zvonand))。
- 优化了 ThreadPool 中的线程创建以最小化锁竞争。线程创建现在在临界区之外执行,避免在高负载条件下作业调度和线程管理出现延迟。这使得 ClickHouse 在高并发负载下响应更加迅速。[#68694](https://github.com/ClickHouse/ClickHouse/pull/68694) ([filimonov](https://github.com/filimonov))。
- 支持从 `ORC` 读取 `LowCardinality` 字符串列。[#69481](https://github.com/ClickHouse/ClickHouse/pull/69481) ([李扬](https://github.com/taiyang-li))。
- 在系统日志(如 `part_log`、`query_views_log`、`filesystem_cache_log`)中对 `ProfileEvents` 使用 `LowCardinality`。[#70152](https://github.com/ClickHouse/ClickHouse/pull/70152) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 改进 `fromUnixTimestamp`/`toUnixTimestamp` 函数的性能。[#71042](https://github.com/ClickHouse/ClickHouse/pull/71042) ([kevinyhzou](https://github.com/KevinyhZou))。
- 从阻塞 I/O 读取时,不再为整个服务器禁用页面缓存的非阻塞读取。当单个文件系统(例如 tmpfs)不支持 `preadv2` 系统调用而其他文件系统支持时,之前的做法会导致性能下降。[#70299](https://github.com/ClickHouse/ClickHouse/pull/70299) ([Antonio Andelic](https://github.com/antonio2368))。
- `ALTER TABLE .. REPLACE PARTITION` 不再等待其他分区中发生的变更/合并操作。[#59138](https://github.com/ClickHouse/ClickHouse/pull/59138) ([Vasily Nemkov](https://github.com/Enmk))。
- 从 Keeper 同步 ACL 时不再进行验证。验证在创建时已执行。这通常影响不大,但在创建了数万甚至更多用户的部署环境中,不必要的哈希验证可能会导致服务器启动期间耗时过长(它会从 Keeper 同步所有内容)。[#70644](https://github.com/ClickHouse/ClickHouse/pull/70644) ([Raúl Marín](https://github.com/Algunenano))。





#### 改进 {#improvement-2}

- `CREATE TABLE AS` 将复制 `PRIMARY KEY`、`ORDER BY` 以及类似的子句(针对 `MergeTree` 表)。[#69739](https://github.com/ClickHouse/ClickHouse/pull/69739) ([sakulali](https://github.com/sakulali))。
- 在 Keeper 中支持 64 位 XID。可以通过 `use_xid_64` 配置值启用。[#69908](https://github.com/ClickHouse/ClickHouse/pull/69908) ([Antonio Andelic](https://github.com/antonio2368))。
- 当未为参数提供值时,布尔设置的命令行参数将设置为 true(例如 `clickhouse-client --optimize_aggregation_in_order --query "SELECT 1"`)。[#70459](https://github.com/ClickHouse/ClickHouse/pull/70459) ([davidtsuk](https://github.com/davidtsuk))。
- 添加了用户级设置 `min_free_disk_bytes_to_perform_insert` 和 `min_free_disk_perform_to_throw_insert`,以防止在几乎已满的磁盘上执行插入操作。[#69755](https://github.com/ClickHouse/ClickHouse/pull/69755) ([Marco Vilas Boas](https://github.com/marco-vb))。
- 设置的嵌入式文档将严格比网站上的文档更详细和完整。这是使网站文档始终从源代码自动生成之前的第一步。这具有长远的意义:- 将保证包含每个设置;- 不会出现默认值过时的情况;- 我们可以为每个 ClickHouse 版本生成此文档;- 即使没有互联网访问,服务器本身也可以显示该文档。从源代码生成网站上的文档。[#70289](https://github.com/ClickHouse/ClickHouse/pull/70289) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 允许在 `replace` 函数中使用空的 needle,与 PostgreSQL 的行为相同。[#69918](https://github.com/ClickHouse/ClickHouse/pull/69918) ([zhanglistar](https://github.com/zhanglistar))。
- 允许在 `replaceRegexp*` 函数中使用空的 needle。[#70053](https://github.com/ClickHouse/ClickHouse/pull/70053) ([zhanglistar](https://github.com/zhanglistar))。
- `data/database_name/` 目录中表的符号链接根据存储策略创建到表数据的实际路径,而不是默认磁盘上的 `store/...` 目录。[#61777](https://github.com/ClickHouse/ClickHouse/pull/61777) ([Kirill](https://github.com/kirillgarbar))。
- 在从 `JSON` 解析 `Enum` 字段时,包含整数的字符串将被解释为相应的 `Enum` 元素。这解决了 [#65119](https://github.com/ClickHouse/ClickHouse/issues/65119)。[#66801](https://github.com/ClickHouse/ClickHouse/pull/66801) ([scanhex12](https://github.com/scanhex12))。
- 允许 `TRIM` `LEADING` 或 `TRAILING` 空字符串作为无操作。解决了 [#67792](https://github.com/ClickHouse/ClickHouse/issues/67792)。[#68455](https://github.com/ClickHouse/ClickHouse/pull/68455) ([Peter Nguyen](https://github.com/petern48))。
- 改进 `cast(timestamp as String)` 与 Spark 的兼容性。[#69179](https://github.com/ClickHouse/ClickHouse/pull/69179) ([Wenzheng Liu](https://github.com/lwz9103))。
- 当 `enable_analyzer` 设置为 `true` 时,始终使用新的分析器来计算常量表达式。支持在不使用 `SELECT` 查询的情况下计算 `executable` 表函数参数的常量表达式。[#69292](https://github.com/ClickHouse/ClickHouse/pull/69292) ([Dmitry Novik](https://github.com/novikd))。
- 添加设置 `enable_secure_identifiers` 以禁止使用包含特殊字符的标识符。[#69411](https://github.com/ClickHouse/ClickHouse/pull/69411) ([tuanpach](https://github.com/tuanpach))。
- 添加 `show_create_query_identifier_quoting_rule` 以定义 `SHOW CREATE TABLE` 查询结果中的标识符引用行为。可能的值:- `user_display`:当标识符是关键字时。- `when_necessary`:当标识符是 `{"distinct", "all", "table"}` 之一且可能导致歧义时:列名、字典属性名。- `always`:始终引用标识符。[#69448](https://github.com/ClickHouse/ClickHouse/pull/69448) ([tuanpach](https://github.com/tuanpach))。
- 改进访问实体依赖关系的恢复 [#69563](https://github.com/ClickHouse/ClickHouse/pull/69563) ([Vitaly Baranov](https://github.com/vitlibar))。
- 如果您运行 `clickhouse-client` 或其他 CLI 应用程序,并且由于服务器过载而启动缓慢,当您开始输入查询(例如 `SELECT`)时,以前的版本会在打印问候消息之前显示终端回显内容的剩余部分,例如 `SELECTClickHouse local version 24.10.1.1.` 而不是 `ClickHouse local version 24.10.1.1.`。现在已修复。这解决了 [#31696](https://github.com/ClickHouse/ClickHouse/issues/31696)。[#69856](https://github.com/ClickHouse/ClickHouse/pull/69856) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 向 `system.replicas` 表添加新列 `readonly_duration`。需要能够在告警中区分实际的只读副本和哨兵副本。[#69871](https://github.com/ClickHouse/ClickHouse/pull/69871) ([Miсhael Stetsyuk](https://github.com/mstetsyuk))。
- 将 `join_output_by_rowlist_perkey_rows_threshold` 设置的类型更改为无符号整数。[#69886](https://github.com/ClickHouse/ClickHouse/pull/69886) ([kevinyhzou](https://github.com/KevinyhZou))。
- 增强 OpenTelemetry span 日志记录以包含查询设置。[#70011](https://github.com/ClickHouse/ClickHouse/pull/70011) ([sharathks118](https://github.com/sharathks118))。
- 如果 lambda 结果类型不符合预期,则添加有关高阶数组函数的诊断信息。[#70093](https://github.com/ClickHouse/ClickHouse/pull/70093) ([ttanay](https://github.com/ttanay))。
- Keeper 改进:在集群变更期间减少锁定。[#70275](https://github.com/ClickHouse/ClickHouse/pull/70275) ([Antonio Andelic](https://github.com/antonio2368))。
- 向 `SHOW GRANTS` 命令添加 `WITH IMPLICIT` 和 `FINAL` 关键字。修复隐式授权的一个小错误:[#70094](https://github.com/ClickHouse/ClickHouse/issues/70094)。[#70293](https://github.com/ClickHouse/ClickHouse/pull/70293) ([pufit](https://github.com/pufit))。
- 遵守 MergeTree 设置的 `compatibility`。`compatibility` 值在服务器启动时从 `default` 配置文件中获取,并相应地更改默认的 MergeTree 设置。`compatibility` 设置的进一步更改不会影响 MergeTree 设置。[#70322](https://github.com/ClickHouse/ClickHouse/pull/70322) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 避免在服务器间通信期间发生错误时用大型 HTTP 响应体充斥日志。[#70487](https://github.com/ClickHouse/ClickHouse/pull/70487) ([Vladimir Cherkasov](https://github.com/vdimir))。
- 添加了新设置 `max_parts_to_move` 以控制一次可以移动的最大分区数。[#70520](https://github.com/ClickHouse/ClickHouse/pull/70520) ([Vladimir Cherkasov](https://github.com/vdimir))。
- 限制某些日志消息的频率。[#70601](https://github.com/ClickHouse/ClickHouse/pull/70601) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 带有 `PART` 限定符的 `CHECK TABLE` 在客户端中格式不正确。[#70660](https://github.com/ClickHouse/ClickHouse/pull/70660) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 支持使用 parquet 原生写入器写入列索引和偏移索引。[#70669](https://github.com/ClickHouse/ClickHouse/pull/70669) ([LiuNeng](https://github.com/liuneng1994))。
- 支持以 joda 语法解析 `DateTime64` 的微秒和时区("joda" 是一个流行的 Java 日期和时间库,"joda 语法"是该库的风格)。[#70737](https://github.com/ClickHouse/ClickHouse/pull/70737) ([kevinyhzou](https://github.com/KevinyhZou))。
- 更改了确定云存储是否支持[批量删除](https://docs.aws.amazon.com/AmazonS3/latest/API/API_DeleteObjects.html)的方法。[#70786](https://github.com/ClickHouse/ClickHouse/pull/70786) ([Vitaly Baranov](https://github.com/vitlibar))。
- 在原生读取器中支持 Parquet page v2。[#70807](https://github.com/ClickHouse/ClickHouse/pull/70807) ([Arthur Passos](https://github.com/arthurpassos))。
- 检查表是否同时设置了 `storage_policy` 和 `disk`。添加了在使用 `disk` 设置时检查新存储策略是否与旧存储策略兼容的功能。[#70839](https://github.com/ClickHouse/ClickHouse/pull/70839) ([Kirill](https://github.com/kirillgarbar))。
- 添加 `system.s3_queue_settings` 和 `system.azure_queue_settings`。[#70841](https://github.com/ClickHouse/ClickHouse/pull/70841) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 函数 `base58Encode` 和 `base58Decode` 现在接受 `FixedString` 类型的参数。示例:`SELECT base58Encode(toFixedString('plaintext', 9));`。[#70846](https://github.com/ClickHouse/ClickHouse/pull/70846) ([Faizan Patel](https://github.com/faizan2786))。
- 向分区日志的每个条目类型添加 `partition` 列。以前,它仅为某些条目设置。这解决了 [#70819](https://github.com/ClickHouse/ClickHouse/issues/70819)。[#70848](https://github.com/ClickHouse/ClickHouse/pull/70848) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 向 `system.part_log` 添加 `MergeStart` 和 `MutateStart` 事件,这有助于合并分析和可视化。[#70850](https://github.com/ClickHouse/ClickHouse/pull/70850) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 添加关于合并源分区数量的性能事件。它允许在生产环境中监控合并树的扇出。[#70908](https://github.com/ClickHouse/ClickHouse/pull/70908) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 重新启用了到文件系统缓存的后台下载。[#70929](https://github.com/ClickHouse/ClickHouse/pull/70929) ([Nikita Taranov](https://github.com/nickitat))。
- 添加了一个名为 `Trivial` 的新合并选择器算法,仅供专业使用。它比 `Simple` 合并选择器更差。[#70969](https://github.com/ClickHouse/ClickHouse/pull/70969) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 支持原子性的 `CREATE OR REPLACE VIEW`。[#70536](https://github.com/ClickHouse/ClickHouse/pull/70536) ([tuanpach](https://github.com/tuanpach))
- 向聚合函数 `windowFunnel` 添加 `strict_once` 模式,以避免在一个事件匹配多个条件时多次计数,解决了 [#21835](https://github.com/ClickHouse/ClickHouse/issues/21835)。[#69738](https://github.com/ClickHouse/ClickHouse/pull/69738) ([Vladimir Cherkasov](https://github.com/vdimir))。





#### 错误修复(官方稳定版本中用户可见的异常行为) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-2}

- Apply configuration updates in global context object. It fixes issues like [#62308](https://github.com/ClickHouse/ClickHouse/issues/62308). [#62944](https://github.com/ClickHouse/ClickHouse/pull/62944) ([Amos Bird](https://github.com/amosbird)).
- Fix `ReadSettings` not using user set values, because defaults were only used. [#65625](https://github.com/ClickHouse/ClickHouse/pull/65625) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix type mismatch issue in `sumMapFiltered` when using signed arguments. [#58408](https://github.com/ClickHouse/ClickHouse/pull/58408) ([Chen768959](https://github.com/Chen768959)).
- Fix toHour-like conversion functions' monotonicity when optional time zone argument is passed. [#60264](https://github.com/ClickHouse/ClickHouse/pull/60264) ([Amos Bird](https://github.com/amosbird)).
- Relax `supportsPrewhere` check for `Merge` tables. This fixes [#61064](https://github.com/ClickHouse/ClickHouse/issues/61064). It was hardened unnecessarily in [#60082](https://github.com/ClickHouse/ClickHouse/issues/60082). [#61091](https://github.com/ClickHouse/ClickHouse/pull/61091) ([Amos Bird](https://github.com/amosbird)).
- Fix `use_concurrency_control` setting handling for proper `concurrent_threads_soft_limit_num` limit enforcing. This enables concurrency control by default because previously it was broken. [#61473](https://github.com/ClickHouse/ClickHouse/pull/61473) ([Sergei Trifonov](https://github.com/serxa)).
- Fix incorrect `JOIN ON` section optimization in case of `IS NULL` check under any other function (like `NOT`) that may lead to wrong results. Closes [#67915](https://github.com/ClickHouse/ClickHouse/issues/67915). [#68049](https://github.com/ClickHouse/ClickHouse/pull/68049) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Prevent `ALTER` queries that would make the `CREATE` query of tables invalid. [#68574](https://github.com/ClickHouse/ClickHouse/pull/68574) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fix inconsistent AST formatting for `negate` (`-`) and `NOT` functions with tuples and arrays. [#68600](https://github.com/ClickHouse/ClickHouse/pull/68600) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Fix insertion of incomplete type into `Dynamic` during deserialization. It could lead to `Parameter out of bound` errors. [#69291](https://github.com/ClickHouse/ClickHouse/pull/69291) ([Pavel Kruglov](https://github.com/Avogar)).
- Zero-copy replication, which is experimental and should not be used in production: fix inf loop after `restore replica` in the replicated merge tree with zero copy. [#69293](https://github.com/CljmnickHouse/ClickHouse/pull/69293) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
- Return back default value of `processing_threads_num` as number of cpu cores in storage `S3Queue`. [#69384](https://github.com/ClickHouse/ClickHouse/pull/69384) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Bypass try/catch flow when de/serializing nested repeated protobuf to nested columns (fixes [#41971](https://github.com/ClickHouse/ClickHouse/issues/41971)). [#69556](https://github.com/ClickHouse/ClickHouse/pull/69556) ([Eliot Hautefeuille](https://github.com/hileef)).
- Fix crash during insertion into FixedString column in PostgreSQL engine. [#69584](https://github.com/ClickHouse/ClickHouse/pull/69584) ([Pavel Kruglov](https://github.com/Avogar)).
- Fix crash when executing `create view t as (with recursive 42 as ttt select ttt);`. [#69676](https://github.com/ClickHouse/ClickHouse/pull/69676) ([Han Fei](https://github.com/hanfei1991)).
- Fixed `maxMapState` throwing 'Bad get' if value type is DateTime64. [#69787](https://github.com/ClickHouse/ClickHouse/pull/69787) ([Michael Kolupaev](https://github.com/al13n321)).
- Fix `getSubcolumn` with `LowCardinality` columns by overriding `useDefaultImplementationForLowCardinalityColumns` to return `true`. [#69831](https://github.com/ClickHouse/ClickHouse/pull/69831) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- Fix permanent blocked distributed sends if a DROP of distributed table failed. [#69843](https://github.com/ClickHouse/ClickHouse/pull/69843) ([Azat Khuzhin](https://github.com/azat)).
- Fix non-cancellable queries containing WITH FILL with NaN keys. This closes [#69261](https://github.com/ClickHouse/ClickHouse/issues/69261). [#69845](https://github.com/ClickHouse/ClickHouse/pull/69845) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix analyzer default with old compatibility value. [#69895](https://github.com/ClickHouse/ClickHouse/pull/69895) ([Raúl Marín](https://github.com/Algunenano)).
- Don't check dependencies during CREATE OR REPLACE VIEW during DROP of old table. Previously CREATE OR REPLACE query failed when there are dependent tables of the recreated view. [#69907](https://github.com/ClickHouse/ClickHouse/pull/69907) ([Pavel Kruglov](https://github.com/Avogar)).
- Something for Decimal. Fixes [#69730](https://github.com/ClickHouse/ClickHouse/issues/69730). [#69978](https://github.com/ClickHouse/ClickHouse/pull/69978) ([Arthur Passos](https://github.com/arthurpassos)).
- Now DEFINER/INVOKER will work with parameterized views. [#69984](https://github.com/ClickHouse/ClickHouse/pull/69984) ([pufit](https://github.com/pufit)).
- Fix parsing for view's definers. [#69985](https://github.com/ClickHouse/ClickHouse/pull/69985) ([pufit](https://github.com/pufit)).
- Fixed a bug when the timezone could change the result of the query with a `Date` or `Date32` arguments. [#70036](https://github.com/ClickHouse/ClickHouse/pull/70036) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fixes `Block structure mismatch` for queries with nested views and `WHERE` condition. Fixes [#66209](https://github.com/ClickHouse/ClickHouse/issues/66209). [#70054](https://github.com/ClickHouse/ClickHouse/pull/70054) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Avoid reusing columns among different named tuples when evaluating `tuple` functions. This fixes [#70022](https://github.com/ClickHouse/ClickHouse/issues/70022). [#70103](https://github.com/ClickHouse/ClickHouse/pull/70103) ([Amos Bird](https://github.com/amosbird)).
- Fix wrong LOGICAL_ERROR when replacing literals in ranges. [#70122](https://github.com/ClickHouse/ClickHouse/pull/70122) ([Pablo Marcos](https://github.com/pamarcos)).
- Check for Nullable(Nothing) type during ALTER TABLE MODIFY COLUMN/QUERY to prevent tables with such data type. [#70123](https://github.com/ClickHouse/ClickHouse/pull/70123) ([Pavel Kruglov](https://github.com/Avogar)).
- Proper error message for illegal query `JOIN ... ON *` , close [#68650](https://github.com/ClickHouse/ClickHouse/issues/68650). [#70124](https://github.com/ClickHouse/ClickHouse/pull/70124) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Fix wrong result with skipping index. [#70127](https://github.com/ClickHouse/ClickHouse/pull/70127) ([Raúl Marín](https://github.com/Algunenano)).
- Fix data race in ColumnObject/ColumnTuple decompress method that could lead to heap use after free. [#70137](https://github.com/ClickHouse/ClickHouse/pull/70137) ([Pavel Kruglov](https://github.com/Avogar)).
- Fix possible hung in ALTER COLUMN with Dynamic type. [#70144](https://github.com/ClickHouse/ClickHouse/pull/70144) ([Pavel Kruglov](https://github.com/Avogar)).
- Now ClickHouse will consider more errors as retriable and will not mark data parts as broken in case of such errors. [#70145](https://github.com/ClickHouse/ClickHouse/pull/70145) ([alesapin](https://github.com/alesapin)).
- Use correct `max_types` parameter during Dynamic type creation for JSON subcolumn. [#70147](https://github.com/ClickHouse/ClickHouse/pull/70147) ([Pavel Kruglov](https://github.com/Avogar)).
- Fix the password being displayed in `system.query_log` for users with bcrypt password authentication method. [#70148](https://github.com/ClickHouse/ClickHouse/pull/70148) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix event counter for the native interface (InterfaceNativeSendBytes). [#70153](https://github.com/ClickHouse/ClickHouse/pull/70153) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix possible crash related to JSON columns. [#70172](https://github.com/ClickHouse/ClickHouse/pull/70172) ([Pavel Kruglov](https://github.com/Avogar)).
- Fix multiple issues with arrayMin and arrayMax. [#70207](https://github.com/ClickHouse/ClickHouse/pull/70207) ([Raúl Marín](https://github.com/Algunenano)).
- Respect setting allow_simdjson in the JSON type parser. [#70218](https://github.com/ClickHouse/ClickHouse/pull/70218) ([Pavel Kruglov](https://github.com/Avogar)).
- Fix a null pointer dereference on creating a materialized view with two selects and an `INTERSECT`, e.g. `CREATE MATERIALIZED VIEW v0 AS (SELECT 1) INTERSECT (SELECT 1);`. [#70264](https://github.com/ClickHouse/ClickHouse/pull/70264) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Don't modify global settings with startup scripts. Previously, changing a setting in a startup script would change it globally. [#70310](https://github.com/ClickHouse/ClickHouse/pull/70310) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix ALTER of `Dynamic` type with reducing max_types parameter that could lead to server crash. [#70328](https://github.com/ClickHouse/ClickHouse/pull/70328) ([Pavel Kruglov](https://github.com/Avogar)).
- Fix crash when using WITH FILL incorrectly. [#70338](https://github.com/ClickHouse/ClickHouse/pull/70338) ([Raúl Marín](https://github.com/Algunenano)).
- Fix possible use-after-free in `SYSTEM DROP FORMAT SCHEMA CACHE FOR Protobuf`. [#70358](https://github.com/ClickHouse/ClickHouse/pull/70358) ([Azat Khuzhin](https://github.com/azat)).
- Fix crash during GROUP BY JSON sub-object subcolumn. [#70374](https://github.com/ClickHouse/ClickHouse/pull/70374) ([Pavel Kruglov](https://github.com/Avogar)).
- Don't prefetch parts for vertical merges if part has no rows. [#70452](https://github.com/ClickHouse/ClickHouse/pull/70452) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix crash in WHERE with lambda functions. [#70464](https://github.com/ClickHouse/ClickHouse/pull/70464) ([Raúl Marín](https://github.com/Algunenano)).
- Fix table creation with `CREATE ... AS table_function(...)` with database `Replicated` and unavailable table function source on secondary replica. [#70511](https://github.com/ClickHouse/ClickHouse/pull/70511) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Ignore all output on async insert with `wait_for_async_insert=1`. Closes [#62644](https://github.com/ClickHouse/ClickHouse/issues/62644). [#70530](https://github.com/ClickHouse/ClickHouse/pull/70530) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Ignore frozen_metadata.txt while traversing shadow directory from system.remote_data_paths. [#70590](https://github.com/ClickHouse/ClickHouse/pull/70590) ([Aleksei Filatov](https://github.com/aalexfvk)).
- Fix creation of stateful window functions on misaligned memory. [#70631](https://github.com/ClickHouse/ClickHouse/pull/70631) ([Raúl Marín](https://github.com/Algunenano)).
- Fixed rare crashes in `SELECT`-s and merges after adding a column of `Array` type with non-empty default expression. [#70695](https://github.com/ClickHouse/ClickHouse/pull/70695) ([Anton Popov](https://github.com/CurtizJ)).
- Insert into table function s3 will respect query settings. [#70696](https://github.com/ClickHouse/ClickHouse/pull/70696) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Fix infinite recursion when inferring a protobuf schema when skipping unsupported fields is enabled. [#70697](https://github.com/ClickHouse/ClickHouse/pull/70697) ([Raúl Marín](https://github.com/Algunenano)).
- Disable enable_named_columns_in_function_tuple by default. [#70833](https://github.com/ClickHouse/ClickHouse/pull/70833) ([Raúl Marín](https://github.com/Algunenano)).
- Fix S3Queue table engine setting processing_threads_num not being effective in case it was deduced from the number of cpu cores on the server. [#70837](https://github.com/ClickHouse/ClickHouse/pull/70837) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Normalize named tuple arguments in aggregation states. This fixes [#69732](https://github.com/ClickHouse/ClickHouse/issues/69732) . [#70853](https://github.com/ClickHouse/ClickHouse/pull/70853) ([Amos Bird](https://github.com/amosbird)).
- Fix a logical error due to negative zeros in the two-level hash table. This closes [#70973](https://github.com/ClickHouse/ClickHouse/issues/70973). [#70979](https://github.com/ClickHouse/ClickHouse/pull/70979) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix `limit by`, `limit with ties` for distributed and parallel replicas. [#70880](https://github.com/ClickHouse/ClickHouse/pull/70880) ([Nikita Taranov](https://github.com/nickitat)).

### <a id="249"></a> ClickHouse 24.9 版本,2024-09-26 {#a-id249a-clickhouse-release-249-2024-09-26}

#### 向后不兼容变更 {#backward-incompatible-change-3}

- 现已支持对命名元组使用 `a[b].c` 形式的表达式,以及对任意表达式使用命名下标,例如 `expr().name`。这对处理 JSON 非常有用。此变更解决了 [#54965](https://github.com/ClickHouse/ClickHouse/issues/54965)。在之前的版本中,`expr().name` 形式的表达式会被解析为 `tupleElement(expr(), name)`,查询分析器会搜索名为 `name` 的列而非对应的元组元素;而在新版本中,已更改为 `tupleElement(expr(), 'name')`。在大多数情况下,之前的版本无法正常工作,但可以想象一个极为罕见的场景,此变更可能导致不兼容:如果您将元组元素的名称存储在列或别名中,且该列或别名的名称与元组元素名称不同:`SELECT 'b' AS a, CAST([tuple(123)] AS 'Array(Tuple(b UInt8))') AS t, t[1].a`。您极不可能使用过此类查询,但我们仍需将此变更标记为潜在的向后不兼容。[#68435](https://github.com/ClickHouse/ClickHouse/pull/68435) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 当启用 `print_pretty_type_names` 设置时,将在 `SHOW CREATE TABLE` 语句、`formatQuery` 函数以及 `clickhouse-client` 和 `clickhouse-local` 的交互模式中以美化形式显示 `Tuple` 数据类型。在之前的版本中,此设置仅应用于 `DESCRIBE` 查询和 `toTypeName`。此变更解决了 [#65753](https://github.com/ClickHouse/ClickHouse/issues/65753)。[#68492](https://github.com/ClickHouse/ClickHouse/pull/68492) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 在 `Replicated` 数据库中创建表时,不再允许显式指定 UUID。同时,在 Replicated 数据库中也不再允许为 \*MergeTree 表显式指定 Keeper 路径和副本名称。此变更引入了新设置 `database_replicated_allow_explicit_uuid`,并将 `database_replicated_allow_replicated_engine_arguments` 的类型从 Bool 更改为 UInt64 [#66104](https://github.com/ClickHouse/ClickHouse/pull/66104) ([Alexander Tokmakov](https://github.com/tavplubix))。


#### 新功能 {#new-feature-3}

- 允许用户使用多种身份验证方法,而不再局限于单一方法。允许将身份验证方法重置为最近添加的方法。如果您需要同时运行 24.8 和 24.9 版本的实例一段时间,建议在此期间将 `max_authentication_methods_per_user` 设置为 1,以避免潜在的兼容性问题。[#65277](https://github.com/ClickHouse/ClickHouse/pull/65277) ([Arthur Passos](https://github.com/arthurpassos))。
- 添加对 `ATTACH PARTITION ALL FROM` 的支持。[#61987](https://github.com/ClickHouse/ClickHouse/pull/61987) ([Kirill Nikiforov](https://github.com/allmazz))。
- 添加 `input_format_json_empty_as_default` 设置,启用后会将 JSON 输入中的空字段视为默认值。关闭 [#59339](https://github.com/ClickHouse/ClickHouse/issues/59339)。[#66782](https://github.com/ClickHouse/ClickHouse/pull/66782) ([Alexis Arnaud](https://github.com/a-a-f))。
- 添加了 `overlay` 和 `overlayUTF8` 函数,用于将字符串的部分内容替换为另一个字符串。示例:`SELECT overlay('Hello New York', 'Jersey', 11)` 返回 `Hello New Jersey`。[#66933](https://github.com/ClickHouse/ClickHouse/pull/66933) ([李扬](https://github.com/taiyang-li))。
- 添加对分区轻量级删除的支持 `DELETE FROM [db.]table [ON CLUSTER cluster] [IN PARTITION partition_expr] WHERE expr; ` [#67805](https://github.com/ClickHouse/ClickHouse/pull/67805) ([sunny](https://github.com/sunny19930321))。
- 实现了不同单位(如秒和分钟)的 `Interval` 数据类型值的比较,现在它们会转换为最小公共超类型。[#68057](https://github.com/ClickHouse/ClickHouse/pull/68057) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- 添加 `create_if_not_exists` 设置,使 CREATE 语句默认采用 `IF NOT EXISTS` 行为。[#68164](https://github.com/ClickHouse/ClickHouse/pull/68164) ([Peter Nguyen](https://github.com/petern48))。
- 支持在 Azure 和本地环境中读取 `Iceberg` 表。[#68210](https://github.com/ClickHouse/ClickHouse/pull/68210) ([Daniil Ivanik](https://github.com/divanik))。
- 现在可以按标签删除查询缓存条目。例如,由 `SELECT 1 SETTINGS use_query_cache = true, query_cache_tag = 'abc'` 创建的查询缓存条目现在可以通过 `SYSTEM DROP QUERY CACHE TAG 'abc'` 删除。[#68477](https://github.com/ClickHouse/ClickHouse/pull/68477) ([Michał Tabaszewski](https://github.com/pinsvin00))。
- 为命名集合添加存储加密功能。[#68615](https://github.com/ClickHouse/ClickHouse/pull/68615) ([Pablo Marcos](https://github.com/pamarcos))。
- 为 `URL` 表引擎添加虚拟列 `_headers`。关闭 [#65026](https://github.com/ClickHouse/ClickHouse/issues/65026)。[#68867](https://github.com/ClickHouse/ClickHouse/pull/68867) ([flynn](https://github.com/ucasfl))。
- 添加 `system.projections` 表以跟踪可用的投影。[#68901](https://github.com/ClickHouse/ClickHouse/pull/68901) ([Jordi Villar](https://github.com/jrdi))。
- 添加新函数 `arrayZipUnaligned` 以实现与 Spark 的兼容性(在 Spark 中命名为 `arrays_zip`),该函数基于原始的 `arrayZip`,允许处理非对齐数组。[#69030](https://github.com/ClickHouse/ClickHouse/pull/69030) ([李扬](https://github.com/taiyang-li))。
- 为 keeper 客户端命令行应用程序添加了 `cp`/`mv` 命令,可以原子性地复制/移动节点。[#69034](https://github.com/ClickHouse/ClickHouse/pull/69034) ([Mikhail Artemenko](https://github.com/Michicosun))。
- 为函数 `arrayAUC` 添加参数 `scale`(默认值:`true`),允许跳过归一化步骤(问题 [#69609](https://github.com/ClickHouse/ClickHouse/issues/69609))。[#69717](https://github.com/ClickHouse/ClickHouse/pull/69717) ([gabrielmcg44](https://github.com/gabrielmcg44))。

#### 实验性功能 {#experimental-feature-2}

- 新增设置 `input_format_try_infer_variants`,当列/数组元素存在多种可能类型时,允许在文本格式的模式推断过程中推断 `Variant` 类型。[#63798](https://github.com/ClickHouse/ClickHouse/pull/63798) ([Shaun Struwig](https://github.com/Blargian))。
- 新增聚合函数 `distinctDynamicTypes`/`distinctJSONPaths`/`distinctJSONPathsAndTypes`,用于更好地检查 JSON 列类型内容。[#68463](https://github.com/ClickHouse/ClickHouse/pull/68463) ([Kruglov Pavel](https://github.com/Avogar))。
- 新增算法,通过一致性哈希确定并行副本之间标记分布的单位。针对不同的读取模式选择不同数量的标记以提升性能。[#68424](https://github.com/ClickHouse/ClickHouse/pull/68424) ([Nikita Taranov](https://github.com/nickitat))。
- 之前并行副本通告处理中数据分片去重逻辑的算法复杂度为 O(n^2),对于具有大量分片(或分区)的表可能需要较长时间。此更改将复杂度降低到 O(n\*log(n))。[#69596](https://github.com/ClickHouse/ClickHouse/pull/69596) ([Alexander Gololobov](https://github.com/davenger))。
- 可刷新物化视图改进:追加模式(`... REFRESH EVERY 1 MINUTE APPEND ...`)可向现有表添加行而不是覆盖整个表,重试机制(默认禁用,在查询的 SETTINGS 部分配置),`SYSTEM WAIT VIEW <name>` 查询可等待当前正在运行的刷新,以及一些修复。[#58934](https://github.com/ClickHouse/ClickHouse/pull/58934) ([Michael Kolupaev](https://github.com/al13n321))。
- 新增 `min_max` 作为新的(实验性)统计信息类型。它支持对数值列的范围谓词进行估算,例如 `x < 100`。[#67013](https://github.com/ClickHouse/ClickHouse/pull/67013) ([JackyWoo](https://github.com/JackyWoo))。
- 改进了从 Variant/Dynamic 列的 castOrDefault 功能,使其在内部类型完全不可转换时也能正常工作。[#67150](https://github.com/ClickHouse/ClickHouse/pull/67150) ([Kruglov Pavel](https://github.com/Avogar))。
- 现在可以通过 MaterializedPostgreSQL 实现列子集的复制。关闭 [#33748](https://github.com/ClickHouse/ClickHouse/issues/33748)。[#69092](https://github.com/ClickHouse/ClickHouse/pull/69092) ([Kruglov Kirill](https://github.com/1on))。


#### 性能改进 {#performance-improvement-3}

- 实现了 Hive 分区仅读取所需文件的功能。[#68963](https://github.com/ClickHouse/ClickHouse/pull/68963) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- 在 LEFT 或 INNER 哈希连接中,当表键较为密集时,通过按键重新排列右表来提升 JOIN 性能。[#60341](https://github.com/ClickHouse/ClickHouse/pull/60341) ([kevinyhzou](https://github.com/KevinyhZou))。
- 通过延迟追加行列表来提升 ALL JOIN 性能。[#63677](https://github.com/ClickHouse/ClickHouse/pull/63677) ([kevinyhzou](https://github.com/KevinyhZou))。
- 在启动过程中异步加载文件系统缓存元数据,以加快重启速度(由设置 `load_metadata_asynchronously` 控制)。[#65736](https://github.com/ClickHouse/ClickHouse/pull/65736) ([Daniel Pozo Escalona](https://github.com/danipozo))。
- 优化了 `array` 和 `map` 函数,使其在处理某些常见场景时速度显著提升。[#67707](https://github.com/ClickHouse/ClickHouse/pull/67707) ([李扬](https://github.com/taiyang-li))。
- 对 ORC 字符串读取进行了轻量级优化,特别是当列不包含 NULL 值时。[#67794](https://github.com/ClickHouse/ClickHouse/pull/67794) ([李扬](https://github.com/taiyang-li))。
- 通过减少合并调度步骤的开销,提升了合并的整体性能。[#68016](https://github.com/ClickHouse/ClickHouse/pull/68016) ([Anton Popov](https://github.com/CurtizJ))。
- 当未设置配置文件、未设置凭证且 IMDS 不可用时(例如,在云环境外的机器上查询公共存储桶时),加快了对 S3 的请求速度。这解决了 [#52771](https://github.com/ClickHouse/ClickHouse/issues/52771)。[#68082](https://github.com/ClickHouse/ClickHouse/pull/68082) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 对 `RowInputFormatWithNamesAndTypes` 中的格式读取器进行去虚拟化,以提升性能。[#68437](https://github.com/ClickHouse/ClickHouse/pull/68437) ([李扬](https://github.com/taiyang-li))。
- 为 `uniq` 聚合函数在使用 GROUP BY 键进行聚合时添加了并行合并功能,以最大化 CPU 利用率。[#68441](https://github.com/ClickHouse/ClickHouse/pull/68441) ([Jiebin Sun](https://github.com/jiebinn))。
- 添加了设置 `output_format_orc_dictionary_key_size_threshold`,允许用户在 `ORC` 输出格式中为字符串列启用字典编码。这有助于减小输出 `ORC` 文件大小并显著提升读取性能。[#68591](https://github.com/ClickHouse/ClickHouse/pull/68591) ([李扬](https://github.com/taiyang-li))。
- 引入了新的 Keeper 请求 RemoveRecursive,可删除节点及其所有子树。[#69332](https://github.com/ClickHouse/ClickHouse/pull/69332) ([Mikhail Artemenko](https://github.com/Michicosun))。
- 通过并行向向量索引添加数据,加快了向带有向量相似度索引的表中插入数据的性能。[#69493](https://github.com/ClickHouse/ClickHouse/pull/69493) ([flynn](https://github.com/ucasfl))。
- 通过使用自适应写入缓冲区大小,减少了向 JSON 插入数据的内存使用量。在宽格式部分中,由 JSON 列创建的许多文件包含少量数据,为它们分配 1MB 缓冲区并不合理。[#69272](https://github.com/ClickHouse/ClickHouse/pull/69272) ([Kruglov Pavel](https://github.com/Avogar))。
- 避免在并发哈希连接线程池中返回线程,以防止查询过度生成线程。[#69406](https://github.com/ClickHouse/ClickHouse/pull/69406) ([Duc Canh Le](https://github.com/canhld94))。


#### 改进 {#improvement-3}

- CREATE TABLE AS 现在会复制 PRIMARY KEY、ORDER BY 和类似子句。目前仅支持 MergeTree 系列表引擎。[#69076](https://github.com/ClickHouse/ClickHouse/pull/69076) ([sakulali](https://github.com/sakulali))。
- 加固了与小型实体解析相关的代码库部分。发现并修复了以下（次要）错误：- 如果 `DeltaLake` 表按 Bool 分区，分区值始终被解释为 false；- `ExternalDistributed` 表仅使用提供地址中的单个分片；`max_threads` 设置及类似设置的值被打印为 `'auto(N)'` 而不是 `auto(N)`。[#52503](https://github.com/ClickHouse/ClickHouse/pull/52503) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 使用 cgroup 特定的指标进行 CPU 使用率统计,而不是系统级指标。[#62003](https://github.com/ClickHouse/ClickHouse/pull/62003) ([Nikita Taranov](https://github.com/nickitat))。
- 远程 S3 磁盘的 IO 调度现在在 HTTP 套接字流级别完成（而不是整个 S3 请求），以解决 `bandwidth_limit` 限流问题。[#65182](https://github.com/ClickHouse/ClickHouse/pull/65182) ([Sergei Trifonov](https://github.com/serxa))。
- 函数 `upperUTF8` 和 `lowerUTF8` 以前只能将西里尔字符转换为大写/小写。现在已移除此限制，可以对任意语言的字符进行大小写转换。示例：`SELECT upperUTF8('Süden')` 现在返回 `SÜDEN`。[#65761](https://github.com/ClickHouse/ClickHouse/pull/65761) ([李扬](https://github.com/taiyang-li))。
- 当在具有投影的表上执行轻量级删除时，尽管用户可以选择抛出异常（默认）或在轻量级删除发生时删除投影，现在有第三个选项，即仍然执行轻量级删除然后重建投影。[#66169](https://github.com/ClickHouse/ClickHouse/pull/66169) ([jsc0218](https://github.com/jsc0218))。
- 添加了两个选项（`dns_allow_resolve_names_to_ipv4` 和 `dns_allow_resolve_names_to_ipv6`），用于阻止特定 IP 协议族的连接。[#66895](https://github.com/ClickHouse/ClickHouse/pull/66895) ([MikhailBurdukov](https://github.com/MikhailBurdukov))。
- 在 clickhouse-client 中使 Ctrl-Z 忽略可配置（ignore_shell_suspend）。[#67134](https://github.com/ClickHouse/ClickHouse/pull/67134) ([Azat Khuzhin](https://github.com/azat))。
- 改进 JSON 输出格式中的 UTF-8 验证。确保在结果数据中存在特定字节序列的情况下生成有效的 JSON。[#67938](https://github.com/ClickHouse/ClickHouse/pull/67938) ([mwoenker](https://github.com/mwoenker))。
- 为合并和变更添加了性能事件，以便更好地进行内省。[#68015](https://github.com/ClickHouse/ClickHouse/pull/68015) ([Anton Popov](https://github.com/CurtizJ))。
- ODBC：从服务器配置中获取 http_max_tries。[#68128](https://github.com/ClickHouse/ClickHouse/pull/68128) ([Rodolphe Dugé de Bernonville](https://github.com/RodolpheDuge))。
- 在 X.509 SubjectAltName 扩展中为用户标识添加通配符支持。[#68236](https://github.com/ClickHouse/ClickHouse/pull/68236) ([Marco Vilas Boas](https://github.com/marco-vb))。
- 改进日期时间的模式推断。现在仅当日期时间具有小数部分时才使用 `DateTime64`，否则使用常规 DateTime。Date/DateTime 的推断现在更加严格，特别是当 `date_time_input_format='best_effort'` 时，以避免在边缘情况下从字符串推断日期时间。[#68382](https://github.com/ClickHouse/ClickHouse/pull/68382) ([Kruglov Pavel](https://github.com/Avogar))。
- 从字典中删除命名集合的旧代码并替换为新代码，允许在字典中使用通过 DDL 创建的命名集合。关闭 [#60936](https://github.com/ClickHouse/ClickHouse/issues/60936)，关闭 [#36890](https://github.com/ClickHouse/ClickHouse/issues/36890)。[#68412](https://github.com/ClickHouse/ClickHouse/pull/68412) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 对外部 HTTP 认证器使用 HTTP/1.1 而不是 HTTP/1.0（默认设置）。[#68456](https://github.com/ClickHouse/ClickHouse/pull/68456) ([Aleksei Filatov](https://github.com/aalexfvk))。
- 添加了一组新的线程池内省指标，提供对线程池性能和行为的更深入洞察。[#68674](https://github.com/ClickHouse/ClickHouse/pull/68674) ([filimonov](https://github.com/filimonov))。
- 在使用 `Values` 格式的异步插入中支持查询参数。[#68741](https://github.com/ClickHouse/ClickHouse/pull/68741) ([Anton Popov](https://github.com/CurtizJ))。
- 在 `dateTrunc` 和 `toStartOfInterval` 中支持 `Date32`。[#68874](https://github.com/ClickHouse/ClickHouse/pull/68874) ([LiuNeng](https://github.com/liuneng1994))。
- 向 `system.processors_profile_log` 添加 `plan_step_name` 和 `plan_step_description` 列。[#68954](https://github.com/ClickHouse/ClickHouse/pull/68954) ([Alexander Gololobov](https://github.com/davenger))。
- 在嵌入式字典中支持西班牙语。[#69035](https://github.com/ClickHouse/ClickHouse/pull/69035) ([Vasily Okunev](https://github.com/VOkunev))。
- 在简短故障信息消息中添加 CPU 架构。[#69037](https://github.com/ClickHouse/ClickHouse/pull/69037) ([Konstantin Bogdanov](https://github.com/thevar1able))。
- 如果在重试期间无法建立新的 Keeper 连接，查询将更快失败。[#69148](https://github.com/ClickHouse/ClickHouse/pull/69148) ([Raúl Marín](https://github.com/Algunenano))。
- 更新 Database Factory，使用户定义的数据库引擎可以具有参数、设置和表覆盖（类似于 StorageFactory）。[#69201](https://github.com/ClickHouse/ClickHouse/pull/69201) ([NikBarykin](https://github.com/NikBarykin))。
- 将所有外部表引擎和函数替换为 `Null` 引擎的恢复模式（`restore_replace_external_engines_to_null`、`restore_replace_external_table_functions_to_null` 设置）在表具有 SETTINGS 时会失败。现在在这种情况下会从表定义中删除设置，并允许恢复此类表。[#69253](https://github.com/ClickHouse/ClickHouse/pull/69253) ([Ilya Yatsishin](https://github.com/qoega))。
- 在 clickhouse 镜像的入口点中，CLICKHOUSE_PASSWORD 已正确转义为 XML 格式。[#69301](https://github.com/ClickHouse/ClickHouse/pull/69301) ([aohoyd](https://github.com/aohoyd))。
- 允许 `arrayZip`/`arrayZipUnaligned` 使用空参数，就像 concat 在 https://github.com/ClickHouse/ClickHouse/pull/65887 中所做的那样。这是为了在 Gluten CH Backend 中实现 Spark 兼容性。[#69576](https://github.com/ClickHouse/ClickHouse/pull/69576) ([李扬](https://github.com/taiyang-li))。
- 为 Keeper 的内部通信支持更高级的 SSL 选项（例如带密码的私钥）。[#69582](https://github.com/ClickHouse/ClickHouse/pull/69582) ([Antonio Andelic](https://github.com/antonio2368))。
- 对于具有许多部分或分区的大表，索引分析可能需要相当长的时间。此更改应该能够在该阶段终止重型查询。[#69606](https://github.com/ClickHouse/ClickHouse/pull/69606) ([Alexander Gololobov](https://github.com/davenger))。
- 在 `gcs` 表函数中屏蔽敏感信息。[#69611](https://github.com/ClickHouse/ClickHouse/pull/69611) ([Vitaly Baranov](https://github.com/vitlibar))。
- 为减少行数的合并重建投影。[#62364](https://github.com/ClickHouse/ClickHouse/pull/62364) ([cangyin](https://github.com/cangyin))。





#### 错误修复(官方稳定版本中用户可见的异常行为) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-3}

- Fix attaching table when pg dbname contains "-" in the experimental and unsupported MaterializedPostgreSQL engine. [#62730](https://github.com/ClickHouse/ClickHouse/pull/62730) ([takakawa](https://github.com/takakawa)).
- Fixed error on generated columns in the experimental and totally unsupported MaterializedPostgreSQL engine when adnum ordering is broken [#63161](https://github.com/ClickHouse/ClickHouse/issues/63161). Fixed error on id column with nextval expression as default in the experimental and totally unsupported MaterializedPostgreSQL when there are generated columns in table. Fixed error on dropping publication with symbols except \[a-z1-9-\]. [#67664](https://github.com/ClickHouse/ClickHouse/pull/67664) ([Kruglov Kirill](https://github.com/1on)).
- Storage Join to support Nullable columns in the left table, close [#61247](https://github.com/ClickHouse/ClickHouse/issues/61247). [#66926](https://github.com/ClickHouse/ClickHouse/pull/66926) ([vdimir](https://github.com/vdimir)).
- Incorrect query result with parallel replicas (distribute queries as well) when `IN` operator contains conversion to Decimal(). The bug was introduced with the new analyzer. [#67234](https://github.com/ClickHouse/ClickHouse/pull/67234) ([Igor Nikonov](https://github.com/devcrafter)).
- Fix the problem that alter modify order by causes inconsistent metadata. [#67436](https://github.com/ClickHouse/ClickHouse/pull/67436) ([iceFireser](https://github.com/iceFireser)).
- Fix the upper bound of the function `fromModifiedJulianDay`. It was supposed to be `9999-12-31` but was mistakenly set to `9999-01-01`. [#67583](https://github.com/ClickHouse/ClickHouse/pull/67583) ([PHO](https://github.com/depressed-pho)).
- Fix when the index is not at the beginning of the tuple during `IN` query. [#67626](https://github.com/ClickHouse/ClickHouse/pull/67626) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fix expiration in `RoleCache`. [#67748](https://github.com/ClickHouse/ClickHouse/pull/67748) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix window view missing blocks due to slow flush to view. [#67983](https://github.com/ClickHouse/ClickHouse/pull/67983) ([Raúl Marín](https://github.com/Algunenano)).
- Fix MSan issue caused by incorrect date format. [#68105](https://github.com/ClickHouse/ClickHouse/pull/68105) ([JackyWoo](https://github.com/JackyWoo)).
- Fixed crash in Parquet filtering when data types in the file substantially differ from requested types (e.g. `... FROM file('a.parquet', Parquet, 'x String')`, but the file has `x Int64`). Without this fix, use `input_format_parquet_filter_push_down = 0` as a workaround. [#68131](https://github.com/ClickHouse/ClickHouse/pull/68131) ([Michael Kolupaev](https://github.com/al13n321)).
- Fix crash in `lag`/`lead` which is introduced in [#67091](https://github.com/ClickHouse/ClickHouse/issues/67091). [#68262](https://github.com/ClickHouse/ClickHouse/pull/68262) ([lgbo](https://github.com/lgbo-ustc)).
- Try fix postgres crash when query is cancelled. [#68288](https://github.com/ClickHouse/ClickHouse/pull/68288) ([Kseniia Sumarokova](https://github.com/kssenii)).
- After https://github.com/ClickHouse/ClickHouse/pull/61984 `schema_inference_make_columns_nullable=0` still can make columns `Nullable` in Parquet/Arrow formats. The change was backward incompatible and users noticed the changes in the behaviour. This PR makes `schema_inference_make_columns_nullable=0` to work as before (no Nullable columns will be inferred) and introduces new value `auto` for this setting that will make columns `Nullable` only if data has information about nullability. [#68298](https://github.com/ClickHouse/ClickHouse/pull/68298) ([Kruglov Pavel](https://github.com/Avogar)).
- Fixes [#50868](https://github.com/ClickHouse/ClickHouse/issues/50868). Small DateTime64 constant values returned by a nested subquery inside a distributed query were wrongly transformed to Nulls, thus causing errors and possible incorrect query results. [#68323](https://github.com/ClickHouse/ClickHouse/pull/68323) ([Shankar](https://github.com/shiyer7474)).
- Fix missing sync replica mode in query `SYSTEM SYNC REPLICA`. [#68326](https://github.com/ClickHouse/ClickHouse/pull/68326) ([Duc Canh Le](https://github.com/canhld94)).
- Fix bug in key condition. [#68354](https://github.com/ClickHouse/ClickHouse/pull/68354) ([Han Fei](https://github.com/hanfei1991)).
- Fix crash on drop or rename a role that is used in LDAP external user directory. [#68355](https://github.com/ClickHouse/ClickHouse/pull/68355) ([Andrey Zvonov](https://github.com/zvonand)).
- Fix Progress column value of system.view_refreshes greater than 1 [#68377](https://github.com/ClickHouse/ClickHouse/issues/68377). [#68378](https://github.com/ClickHouse/ClickHouse/pull/68378) ([megao](https://github.com/jetgm)).
- Process regexp flags correctly. [#68389](https://github.com/ClickHouse/ClickHouse/pull/68389) ([Han Fei](https://github.com/hanfei1991)).
- PostgreSQL-style cast operator (`::`) works correctly even for SQL-style hex and binary string literals (e.g., `SELECT x'414243'::String`). This closes [#68324](https://github.com/ClickHouse/ClickHouse/issues/68324). [#68482](https://github.com/ClickHouse/ClickHouse/pull/68482) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Minor patch for https://github.com/ClickHouse/ClickHouse/pull/68131. [#68494](https://github.com/ClickHouse/ClickHouse/pull/68494) ([Chang chen](https://github.com/baibaichen)).
- Fix [#68239](https://github.com/ClickHouse/ClickHouse/issues/68239) SAMPLE n where n is an integer. [#68499](https://github.com/ClickHouse/ClickHouse/pull/68499) ([Denis Hananein](https://github.com/denis-hananein)).
- Fix bug in mann-whitney-utest when the size of two districutions are not equal. [#68556](https://github.com/ClickHouse/ClickHouse/pull/68556) ([Han Fei](https://github.com/hanfei1991)).
- After unexpected restart, fail to start replication of ReplicatedMergeTree due to abnormal handling of covered-by-broken part. [#68584](https://github.com/ClickHouse/ClickHouse/pull/68584) ([baolin](https://github.com/baolinhuang)).
- Fix `LOGICAL_ERROR`s when functions `sipHash64Keyed`, `sipHash128Keyed`, or `sipHash128ReferenceKeyed` are applied to empty arrays or tuples. [#68630](https://github.com/ClickHouse/ClickHouse/pull/68630) ([Robert Schulze](https://github.com/rschu1ze)).
- Full text index may filter out wrong columns when index multiple columns, it didn't reset row_id between different columns, the reproduce procedure is in tests/queries/0_stateless/03228_full_text_with_multi_col.sql. Without this. [#68644](https://github.com/ClickHouse/ClickHouse/pull/68644) ([siyuan](https://github.com/linkwk7)).
- Fix invalid character '\t' and '\n' in replica_name when creating a Replicated table, which causes incorrect parsing of 'source replica' in LogEntry. Mentioned in issue [#68640](https://github.com/ClickHouse/ClickHouse/issues/68640). [#68645](https://github.com/ClickHouse/ClickHouse/pull/68645) ([Zhigao Hong](https://github.com/zghong)).
- Added back virtual columns ` _table` and `_database` to distributed tables. They were available until version 24.3. [#68672](https://github.com/ClickHouse/ClickHouse/pull/68672) ([Anton Popov](https://github.com/CurtizJ)).
- Fix possible error `Size of permutation (0) is less than required (...)` during Variant column permutation. [#68681](https://github.com/ClickHouse/ClickHouse/pull/68681) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix possible error `DB::Exception: Block structure mismatch in joined block stream: different columns:` with new JSON column. [#68686](https://github.com/ClickHouse/ClickHouse/pull/68686) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix issue with materialized constant keys when hashing maps with arrays as keys in functions `sipHash(64/128)Keyed`. [#68731](https://github.com/ClickHouse/ClickHouse/pull/68731) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
- Make `ColumnsDescription::toString` format each column using the same `IAST::FormatState object`. This results in uniform columns metadata being written to disk and ZooKeeper. [#68733](https://github.com/ClickHouse/ClickHouse/pull/68733) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- Fix merging of aggregated data for grouping sets. [#68744](https://github.com/ClickHouse/ClickHouse/pull/68744) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix logical error, when we create a replicated merge tree, alter a column and then execute modify statistics. [#68820](https://github.com/ClickHouse/ClickHouse/pull/68820) ([Han Fei](https://github.com/hanfei1991)).
- Fix resolving dynamic subcolumns from subqueries in analyzer. [#68824](https://github.com/ClickHouse/ClickHouse/pull/68824) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix complex types metadata parsing in DeltaLake. Closes [#68739](https://github.com/ClickHouse/ClickHouse/issues/68739). [#68836](https://github.com/ClickHouse/ClickHouse/pull/68836) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fixed asynchronous inserts in case when metadata of table is changed (by `ALTER ADD/MODIFY COLUMN` queries) after insert but before flush to the table. [#68837](https://github.com/ClickHouse/ClickHouse/pull/68837) ([Anton Popov](https://github.com/CurtizJ)).
- Fix unexpected exception when passing empty tuple in array. This fixes [#68618](https://github.com/ClickHouse/ClickHouse/issues/68618). [#68848](https://github.com/ClickHouse/ClickHouse/pull/68848) ([Amos Bird](https://github.com/amosbird)).
- Fix parsing pure metadata mutations commands. [#68935](https://github.com/ClickHouse/ClickHouse/pull/68935) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fix possible wrong result during anyHeavy state merge. [#68950](https://github.com/ClickHouse/ClickHouse/pull/68950) ([Raúl Marín](https://github.com/Algunenano)).
- Fixed writing to Materialized Views with enabled setting `optimize_functions_to_subcolumns`. [#68951](https://github.com/ClickHouse/ClickHouse/pull/68951) ([Anton Popov](https://github.com/CurtizJ)).
- Don't use serializations cache in const Dynamic column methods. It could let to use-of-uninitialized value or even race condition during aggregations. [#68953](https://github.com/ClickHouse/ClickHouse/pull/68953) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix parsing error when null should be inserted as default in some cases during JSON type parsing. [#68955](https://github.com/ClickHouse/ClickHouse/pull/68955) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix `Content-Encoding` not sent in some compressed responses. [#64802](https://github.com/ClickHouse/ClickHouse/issues/64802). [#68975](https://github.com/ClickHouse/ClickHouse/pull/68975) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- There were cases when path was concatenated incorrectly and had the `//` part in it, solving this problem using path normalization. [#69066](https://github.com/ClickHouse/ClickHouse/pull/69066) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fix logical error when we have empty async insert. [#69080](https://github.com/ClickHouse/ClickHouse/pull/69080) ([Han Fei](https://github.com/hanfei1991)).
- Fixed data race of progress indication in clickhouse-client during query canceling. [#69081](https://github.com/ClickHouse/ClickHouse/pull/69081) ([Sergei Trifonov](https://github.com/serxa)).
- Fix a bug that the vector similarity index (currently experimental) was not utilized when used with cosine distance as distance function. [#69090](https://github.com/ClickHouse/ClickHouse/pull/69090) ([flynn](https://github.com/ucasfl)).
- This change addresses an issue where attempting to create a Replicated database again after a server failure during the initial creation process could result in error. [#69102](https://github.com/ClickHouse/ClickHouse/pull/69102) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- Don't infer Bool type from String in CSV when `input_format_csv_try_infer_numbers_from_strings = 1` because we don't allow reading bool values from strings. [#69109](https://github.com/ClickHouse/ClickHouse/pull/69109) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix explain ast insert queries parsing errors on client when `--multiquery` is enabled. [#69123](https://github.com/ClickHouse/ClickHouse/pull/69123) ([wxybear](https://github.com/wxybear)).
- `UNION` clause in subqueries wasn't handled correctly in queries with parallel replicas and lead to LOGICAL_ERROR `Duplicate announcement received for replica`. [#69146](https://github.com/ClickHouse/ClickHouse/pull/69146) ([Igor Nikonov](https://github.com/devcrafter)).
- Fix propogating structure argument in s3Cluster. Previously the `DEFAULT` expression of the column could be lost when sending the query to the replicas in s3Cluster. [#69147](https://github.com/ClickHouse/ClickHouse/pull/69147) ([Kruglov Pavel](https://github.com/Avogar)).
- Respect format settings in Values format during conversion from expression to the destination type. [#69149](https://github.com/ClickHouse/ClickHouse/pull/69149) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix `clickhouse-client --queries-file` for readonly users (previously fails with `Cannot modify 'log_comment' setting in readonly mode`). [#69175](https://github.com/ClickHouse/ClickHouse/pull/69175) ([Azat Khuzhin](https://github.com/azat)).
- Fix data race in clickhouse-client when it's piped to a process that terminated early. [#69186](https://github.com/ClickHouse/ClickHouse/pull/69186) ([vdimir](https://github.com/vdimir)).
- Fix incorrect results of Fix uniq and GROUP BY for JSON/Dynamic types. [#69203](https://github.com/ClickHouse/ClickHouse/pull/69203) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix the INFILE format detection for asynchronous inserts. If the format is not explicitly defined in the FORMAT clause, it can be detected from the INFILE file extension. [#69237](https://github.com/ClickHouse/ClickHouse/pull/69237) ([Julia Kartseva](https://github.com/jkartseva)).
- After [this issue](https://github.com/ClickHouse/ClickHouse/pull/59946#issuecomment-1943653197) there are quite a few table replicas in production such that their `metadata_version` node value is both equal to `0` and is different from the respective table's `metadata` node version. This leads to `alter` queries failing on such replicas. [#69274](https://github.com/ClickHouse/ClickHouse/pull/69274) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- Mark Dynamic type as not safe primary key type to avoid issues with Fields. [#69311](https://github.com/ClickHouse/ClickHouse/pull/69311) ([Kruglov Pavel](https://github.com/Avogar)).
- Improve restoring of access entities' dependencies. [#69346](https://github.com/ClickHouse/ClickHouse/pull/69346) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix undefined behavior when all connection attempts fail getting a connection for insertions. [#69390](https://github.com/ClickHouse/ClickHouse/pull/69390) ([Pablo Marcos](https://github.com/pamarcos)).
- Close [#69135](https://github.com/ClickHouse/ClickHouse/issues/69135). If we try to reuse joined data for `cross` join, but this could not happen in ClickHouse at present. It's better to keep `have_compressed` in `reuseJoinedData`. [#69404](https://github.com/ClickHouse/ClickHouse/pull/69404) ([lgbo](https://github.com/lgbo-ustc)).
- Make `materialize()` function return full column when parameter is a sparse column. [#69429](https://github.com/ClickHouse/ClickHouse/pull/69429) ([Alexander Gololobov](https://github.com/davenger)).
- Fixed a `LOGICAL_ERROR` with function `sqidDecode` ([#69450](https://github.com/ClickHouse/ClickHouse/issues/69450)). [#69451](https://github.com/ClickHouse/ClickHouse/pull/69451) ([Robert Schulze](https://github.com/rschu1ze)).
- Quick fix for s3queue problem on 24.6 or create query with database replicated. [#69454](https://github.com/ClickHouse/ClickHouse/pull/69454) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fixed case when memory consumption was too high because of the squashing in `INSERT INTO ... SELECT` or `CREATE TABLE AS SELECT` queries. [#69469](https://github.com/ClickHouse/ClickHouse/pull/69469) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Statements `SHOW COLUMNS` and `SHOW INDEX` now work properly if the table has dots in its name. [#69514](https://github.com/ClickHouse/ClickHouse/pull/69514) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
- Usage of the query cache for queries with an overflow mode != 'throw' is now disallowed. This prevents situations where potentially truncated and incorrect query results could be stored in the query cache. (issue [#67476](https://github.com/ClickHouse/ClickHouse/issues/67476)). [#69549](https://github.com/ClickHouse/ClickHouse/pull/69549) ([Robert Schulze](https://github.com/rschu1ze)).
- Keep original order of conditions during move to prewhere. Previously the order could change and it could lead to failing queries when the order is important. [#69560](https://github.com/ClickHouse/ClickHouse/pull/69560) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix Keeper multi-request preprocessing after ZNOAUTH error. [#69627](https://github.com/ClickHouse/ClickHouse/pull/69627) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix METADATA_MISMATCH that might have happened due to TTL with a WHERE clause in DatabaseReplicated when creating a new replica. [#69736](https://github.com/ClickHouse/ClickHouse/pull/69736) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix `StorageS3(Azure)Queue` settings `tracked_file_ttl_sec`. We wrote it to keeper with key `tracked_file_ttl_sec`, but read as `tracked_files_ttl_sec`, which was a typo. [#69742](https://github.com/ClickHouse/ClickHouse/pull/69742) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Use tryconvertfieldtotype in gethyperrectangleforrowgroup. [#69745](https://github.com/ClickHouse/ClickHouse/pull/69745) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- Revert "Fix prewhere without columns and without adaptive index granularity (almost w/o anything)"'. Due to the reverted changes some errors might happen when reading data parts produced by old CH releases (presumably 2021 or older). [#68897](https://github.com/ClickHouse/ClickHouse/pull/68897) ([Alexander Gololobov](https://github.com/davenger)).

### <a id="248"></a> ClickHouse 24.8 LTS 版本，2024-08-20 {#a-id248a-clickhouse-release-248-lts-2024-08-20}

#### 向后不兼容变更 {#backward-incompatible-change-4}

- `clickhouse-client` 和 `clickhouse-local` 现在默认使用多查询模式（而非单查询模式）。例如，`clickhouse-client -q "SELECT 1; SELECT 2"` 现在可以正常工作，而用户以前必须添加 `--multiquery`（或 `-n`）参数。`--multiquery/-n` 开关已过时。多查询语句中的 INSERT 查询根据其 FORMAT 子句进行特殊处理：如果 FORMAT 是 `VALUES`（最常见的情况），INSERT 语句的结束由查询末尾的分号 `;` 表示。对于所有其他 FORMAT（例如 `CSV` 或 `JSONEachRow`），INSERT 语句的结束由查询末尾的两个换行符 `\n\n` 表示。[#63898](https://github.com/ClickHouse/ClickHouse/pull/63898) ([FFish](https://github.com/wxybear))。
- 在以前的版本中，可以通过在数据类型名称后附加 `WithDictionary` 来使用 `LowCardinality` 数据类型的替代语法。这是一个初始的工作实现，从未被记录或公开。现在，它已被弃用。如果您使用了此语法，则必须 ALTER 您的表并将数据类型重命名为 `LowCardinality`。[#66842](https://github.com/ClickHouse/ClickHouse/pull/66842) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 修复了将存储引擎 `Buffer` 与分布式目标表一起使用时的逻辑错误。这是一个向后不兼容变更：如果表在查询中出现多次（例如在自连接中），使用 `Buffer` 与分布式目标表的查询可能会停止工作。[#67015](https://github.com/ClickHouse/ClickHouse/pull/67015) ([vdimir](https://github.com/vdimir))。
- 在以前的版本中，使用接近零的负参数调用基于 Gamma 函数的随机分布函数（如卡方分布、Student 分布、Fisher 分布）会导致长时间计算或无限循环。在新版本中，使用零或负参数调用这些函数将产生异常。这解决了 [#67297](https://github.com/ClickHouse/ClickHouse/issues/67297)。[#67326](https://github.com/ClickHouse/ClickHouse/pull/67326) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 系统表 `text_log` 默认启用。这与以前的版本完全兼容，但您可能会注意到本地磁盘使用量略有增加（此系统表占用少量磁盘空间）。[#67428](https://github.com/ClickHouse/ClickHouse/pull/67428) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 在以前的版本中，如果要求生成非常大的数组，`arrayWithConstant` 可能会很慢。在新版本中，每个数组限制为 1 GB。这解决了 [#32754](https://github.com/ClickHouse/ClickHouse/issues/32754)。[#67741](https://github.com/ClickHouse/ClickHouse/pull/67741) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 修复 REPLACE 修饰符格式化（禁止省略括号）。[#67774](https://github.com/ClickHouse/ClickHouse/pull/67774) ([Azat Khuzhin](https://github.com/azat))。
- 在 [#68349](https://github.com/ClickHouse/ClickHouse/issues/68349) 中回溯移植：重新实现 `Dynamic` 类型。现在，当达到动态数据类型的限制时，新类型不会被转换为 String，而是以二进制格式存储在特殊数据结构中，并使用二进制编码的数据类型。现在，任何曾经插入到 `Dynamic` 列中的类型都可以作为子列从中读取。[#68132](https://github.com/ClickHouse/ClickHouse/pull/68132) ([Kruglov Pavel](https://github.com/Avogar))。


#### 新功能 {#new-feature-4}

- 新增 `MergeTree` 设置 `deduplicate_merge_projection_mode`,用于控制合并期间的投影(针对特定引擎)以及 `OPTIMIZE DEDUPLICATE` 查询。支持的选项:`throw`(如果投影不完全支持 \*MergeTree 引擎则抛出异常)、`drop`(如果投影本身无法一致地合并,则在合并期间删除投影)和 `rebuild`(从头重建投影,这是一个重量级操作)。[#66672](https://github.com/ClickHouse/ClickHouse/pull/66672) ([jsc0218](https://github.com/jsc0218))。
- 为 S3 表引擎添加 `_etag` 虚拟列。修复 [#65312](https://github.com/ClickHouse/ClickHouse/issues/65312)。[#65386](https://github.com/ClickHouse/ClickHouse/pull/65386) ([skyoct](https://github.com/skyoct))。
- 为查询缓存添加标记(命名空间)机制。具有不同标记的相同查询会被查询缓存视为不同的查询。示例:`SELECT 1 SETTINGS use_query_cache = 1, query_cache_tag = 'abc'` 和 `SELECT 1 SETTINGS use_query_cache = 1, query_cache_tag = 'def'` 现在会创建不同的查询缓存条目。[#68235](https://github.com/ClickHouse/ClickHouse/pull/68235) ([sakulali](https://github.com/sakulali))。
- 支持更多 JOIN 严格性变体(`LEFT/RIGHT SEMI/ANTI/ANY JOIN`)与涉及左右表列的不等式条件。例如 `t1.y < t2.y`(参见设置 `allow_experimental_join_condition`)。[#64281](https://github.com/ClickHouse/ClickHouse/pull/64281) ([lgbo](https://github.com/lgbo-ustc))。
- 为不同引擎(`File`、`URL`、`S3`、`AzureBlobStorage`、`HDFS`)解析 Hive 风格的分区。Hive 风格的分区将数据组织到分区子目录中,使查询和管理大型数据集更加高效。目前,它仅创建具有适当名称和数据的虚拟列。后续 PR 将引入相应的数据过滤(性能提升)。[#65997](https://github.com/ClickHouse/ClickHouse/pull/65997) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- 添加函数 `printf` 以实现 Spark 兼容性(但您可以使用现有的 `format` 函数)。[#66257](https://github.com/ClickHouse/ClickHouse/pull/66257) ([李扬](https://github.com/taiyang-li))。
- 添加选项 `restore_replace_external_engines_to_null` 和 `restore_replace_external_table_functions_to_null`,将外部引擎和表引擎替换为 `Null` 引擎,这对测试很有用。它应该适用于 RESTORE 和显式表创建。[#66536](https://github.com/ClickHouse/ClickHouse/pull/66536) ([Ilya Yatsishin](https://github.com/qoega))。
- 添加了使用函数 `readWKTLineString` 读取 `WKT` 格式的 `MULTILINESTRING` 几何图形的支持。[#67647](https://github.com/ClickHouse/ClickHouse/pull/67647) ([Jacob Reckhard](https://github.com/jacobrec))。
- 添加新的表函数 `fuzzQuery`。此函数允许使用随机变化修改给定的查询字符串。示例:`SELECT query FROM fuzzQuery('SELECT 1') LIMIT 5;`。[#67655](https://github.com/ClickHouse/ClickHouse/pull/67655) ([pufit](https://github.com/pufit))。
- 添加查询 `ALTER TABLE ... DROP DETACHED PARTITION ALL` 以删除所有已分离的分区。[#67885](https://github.com/ClickHouse/ClickHouse/pull/67885) ([Duc Canh Le](https://github.com/canhld94))。
- 当启用新设置 `rows_before_aggregation` 时,在查询响应中添加 `rows_before_aggregation_at_least` 统计信息。此统计信息表示聚合前读取的行数。在分布式查询的上下文中,当使用 `group by` 或 `max` 聚合函数而不使用 `limit` 时,`rows_before_aggregation_at_least` 可以反映查询命中的行数。[#66084](https://github.com/ClickHouse/ClickHouse/pull/66084) ([morning-color](https://github.com/morning-color))。
- 支持对 `Join` 表执行 `OPTIMIZE` 查询以减少其内存占用。[#67883](https://github.com/ClickHouse/ClickHouse/pull/67883) ([Duc Canh Le](https://github.com/canhld94))。
- 如果在 URL 中添加 `&run=1`,则允许在 play 中立即运行查询 [#66457](https://github.com/ClickHouse/ClickHouse/pull/66457) ([Aleksandr Musorin](https://github.com/AVMusorin))。

#### 实验性功能 {#experimental-feature-3}

- 实现新的 `JSON` 数据类型。[#66444](https://github.com/ClickHouse/ClickHouse/pull/66444) ([Kruglov Pavel](https://github.com/Avogar))。
- 新增 `TimeSeries` 表引擎。[#64183](https://github.com/ClickHouse/ClickHouse/pull/64183) ([Vitaly Baranov](https://github.com/vitlibar))。
- 新增实验性 `Kafka` 存储引擎,将偏移量存储在 Keeper 中,而非提交到 Kafka。这使得向 ClickHouse 表的提交操作相对于队列消费具有原子性。[#57625](https://github.com/ClickHouse/ClickHouse/pull/57625) ([János Benjamin Antal](https://github.com/antaljanosbenjamin))。
- 为并行副本使用自适应读取任务大小计算方法(自适应是指根据读取列的大小动态调整)。[#60377](https://github.com/ClickHouse/ClickHouse/pull/60377) ([Nikita Taranov](https://github.com/nickitat))。
- 新增统计类型 `count_min`(count-min sketch),为等值谓词(如 `col = 'val'`)提供选择性估算。支持的数据类型包括字符串、日期、日期时间和数值类型。[#65521](https://github.com/ClickHouse/ClickHouse/pull/65521) ([JackyWoo](https://github.com/JackyWoo))。

#### 性能改进 {#performance-improvement-4}

- 设置 `optimize_functions_to_subcolumns` 现已默认启用。[#68053](https://github.com/ClickHouse/ClickHouse/pull/68053) ([Anton Popov](https://github.com/CurtizJ))。
- 将 `plain_rewritable` 磁盘目录元数据存储在 `__meta` 布局中,与对象存储中的合并树数据分离。将 `plain_rewritable` 磁盘迁移至扁平目录结构。[#65751](https://github.com/ClickHouse/ClickHouse/pull/65751) ([Julia Kartseva](https://github.com/jkartseva))。
- 通过为所有子列预先分配所需内存,改进 `String`/`Array`/`Map`/`Variant`/`Dynamic` 类型的列合并操作(INSERT 查询中执行的操作)。[#67043](https://github.com/ClickHouse/ClickHouse/pull/67043) ([Kruglov Pavel](https://github.com/Avogar))。
- 加速 `SYSTEM FLUSH LOGS` 执行并优化关闭时的日志刷新。[#67472](https://github.com/ClickHouse/ClickHouse/pull/67472) ([Sema Checherinda](https://github.com/CheSema))。
- 通过减少合并调度步骤的开销,提升了合并的整体性能。[#68016](https://github.com/ClickHouse/ClickHouse/pull/68016) ([Anton Popov](https://github.com/CurtizJ))。
- 加速 `DROP DATABASE` 查询的表删除操作,将 `database_catalog_drop_table_concurrency` 的默认值提升至 16。[#67228](https://github.com/ClickHouse/ClickHouse/pull/67228) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 避免在写入 ORC 时为数组列分配过多容量。数组列性能提升 15%。[#67879](https://github.com/ClickHouse/ClickHouse/pull/67879) ([李扬](https://github.com/taiyang-li))。
- 显著加速非复制 MergeTree 的变更操作 [#66911](https://github.com/ClickHouse/ClickHouse/pull/66911) [#66909](https://github.com/ClickHouse/ClickHouse/pull/66909) ([Alexey Milovidov](https://github.com/alexey-milovidov))。


#### 改进 {#improvement-4}

- 设置 `allow_experimental_analyzer` 已重命名为 `enable_analyzer`。旧名称以别名形式保留。这标志着 Analyzer 不再处于 beta 阶段,已正式投入生产使用。[#66438](https://github.com/ClickHouse/ClickHouse/pull/66438) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 改进日期时间的模式推断。现在仅当日期时间包含小数部分时才使用 DateTime64,否则使用常规 DateTime。Date/DateTime 的推断现在更加严格,特别是当 `date_time_input_format='best_effort'` 时,以避免在边缘情况下从字符串推断日期时间。[#68382](https://github.com/ClickHouse/ClickHouse/pull/68382) ([Kruglov Pavel](https://github.com/Avogar))。
- ClickHouse 服务器现在支持新设置 `max_keep_alive_requests`。对于到服务器的 keep-alive HTTP 连接,它与 `keep_alive_timeout` 协同工作 - 如果空闲超时未过期但通过给定连接已完成的请求数超过 `max_keep_alive_requests`,则服务器将关闭该连接。[#61793](https://github.com/ClickHouse/ClickHouse/pull/61793) ([Nikita Taranov](https://github.com/nickitat))。
- 高级仪表板的多项改进。这解决了 [#67697](https://github.com/ClickHouse/ClickHouse/issues/67697)。这解决了 [#63407](https://github.com/ClickHouse/ClickHouse/issues/63407)。这解决了 [#51129](https://github.com/ClickHouse/ClickHouse/issues/51129)。这解决了 [#61204](https://github.com/ClickHouse/ClickHouse/issues/61204)。[#67701](https://github.com/ClickHouse/ClickHouse/pull/67701) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 创建 Distributed 表时不再需要 REMOTE 权限:Distributed 引擎的权限即可。[#65419](https://github.com/ClickHouse/ClickHouse/pull/65419) ([jsc0218](https://github.com/jsc0218))。
- 在 Docker 镜像中不显式传递 keeper 的日志配置,以允许覆盖。[#65564](https://github.com/ClickHouse/ClickHouse/pull/65564) ([Azat Khuzhin](https://github.com/azat))。
- 为 `BACKUP` 和 `RESTORE` 查询引入了 `use_same_password_for_base_backup` 设置,允许创建和恢复受密码保护归档的增量备份。[#66214](https://github.com/ClickHouse/ClickHouse/pull/66214) ([Samuele](https://github.com/sguerrini97))。
- 对 `ATTACH` 查询忽略 `async_load_databases`(以前 ATTACH 可能在表附加完成之前就返回)。[#66240](https://github.com/ClickHouse/ClickHouse/pull/66240) ([Azat Khuzhin](https://github.com/azat))。
- 为被拒绝的连接(资源不足的情况)添加了日志和指标。[#66410](https://github.com/ClickHouse/ClickHouse/pull/66410) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 为 MongoDB 引擎支持正确的 `UUID` 类型。[#66671](https://github.com/ClickHouse/ClickHouse/pull/66671) ([Azat Khuzhin](https://github.com/azat))。
- 添加复制延迟和恢复时间指标。[#66703](https://github.com/ClickHouse/ClickHouse/pull/66703) ([Miсhael Stetsyuk](https://github.com/mstetsyuk))。
- 添加 `DiskS3NoSuchKeyErrors` 指标。[#66704](https://github.com/ClickHouse/ClickHouse/pull/66704) ([Miсhael Stetsyuk](https://github.com/mstetsyuk))。
- 确保 `COMMENT` 子句适用于所有表引擎。[#66832](https://github.com/ClickHouse/ClickHouse/pull/66832) ([Joe Lynch](https://github.com/joelynch))。
- 函数 `mapFromArrays` 现在接受 `Map(K, V)` 作为第一个参数,例如:`SELECT mapFromArrays(map('a', 4, 'b', 4), ['aa', 'bb'])` 现在可以正常工作并返回 `{('a',4):'aa',('b',4):'bb'}`。此外,如果第一个参数是 Array,现在也可以是 `Array(Nullable(T))` 或 `Array(LowCardinality(Nullable(T)))` 类型,只要实际数组值不是 `NULL`。[#67103](https://github.com/ClickHouse/ClickHouse/pull/67103) ([李扬](https://github.com/taiyang-li))。
- 从 `~/.clickhouse-local` 读取 `clickhouse-local` 的配置。[#67135](https://github.com/ClickHouse/ClickHouse/pull/67135) ([Azat Khuzhin](https://github.com/azat))。
- 将设置 `input_format_orc_read_use_writer_time_zone` 重命名为 `input_format_orc_reader_timezone`,并允许用户设置读取器时区。[#67175](https://github.com/ClickHouse/ClickHouse/pull/67175) ([kevinyhzou](https://github.com/KevinyhZou))。
- 当 HTTP 连接在建立后立即被对端重置时,降低 `Socket is not connected` 错误的级别,解决 [#34218](https://github.com/ClickHouse/ClickHouse/issues/34218)。[#67177](https://github.com/ClickHouse/ClickHouse/pull/67177) ([vdimir](https://github.com/vdimir))。
- 添加从配置加载 `system.dashboards` 仪表板的功能(一旦设置,将覆盖默认的仪表板预设)。[#67232](https://github.com/ClickHouse/ClickHouse/pull/67232) ([Azat Khuzhin](https://github.com/azat))。
- SQL 中的窗口函数传统上使用下划线命名法。ClickHouse 使用驼峰命名法,因此创建了新的别名 `denseRank()` 和 `percentRank()`。这些新函数的调用方式与原始的 `dense_rank()` 和 `percent_rank()` 函数完全相同。下划线命名法和驼峰命名法语法都可以使用。还为每个函数添加了新的测试。这解决了 [#67042](https://github.com/ClickHouse/ClickHouse/issues/67042)。[#67334](https://github.com/ClickHouse/ClickHouse/pull/67334) ([Peter Nguyen](https://github.com/petern48))。
- 如果不是 `.xml`、`.yml` 或 `.yaml`,则自动检测配置文件格式。如果文件以 &lt; 开头,则可能是 XML,否则可能是 YAML。这在从管道提供配置文件时很有用:`clickhouse-server --config-file <(echo "hello: world")`。[#67391](https://github.com/ClickHouse/ClickHouse/pull/67391) ([sakulali](https://github.com/sakulali))。
- 函数 `formatDateTime` 和 `formatDateTimeInJodaSyntax` 现在将其格式参数视为可选。如果未指定,则假定格式字符串为 `%Y-%m-%d %H:%i:%s` 和 `yyyy-MM-dd HH:mm:ss`。示例:`SELECT parseDateTime('2021-01-04 23:12:34')` 现在返回 DateTime 值 `2021-01-04 23:12:34`(以前会抛出异常)。[#67399](https://github.com/ClickHouse/ClickHouse/pull/67399) ([Robert Schulze](https://github.com/rschu1ze))。
- 如果 KeeperMap 中的 Keeper 请求因超时或连接丢失而失败,则自动重试。[#67448](https://github.com/ClickHouse/ClickHouse/pull/67448) ([Antonio Andelic](https://github.com/antonio2368))。
- 在 Aarch64 Linux 构建中添加 `-no-pie`,以允许在 ClickHouse 重启后正确进行内省和堆栈跟踪符号化。[#67916](https://github.com/ClickHouse/ClickHouse/pull/67916) ([filimonov](https://github.com/filimonov))。
- 为合并和变更添加了性能事件,以便更好地进行内省。[#68015](https://github.com/ClickHouse/ClickHouse/pull/68015) ([Anton Popov](https://github.com/CurtizJ))。
- 删除非复制 `MergeTree` 的不必要日志。[#68238](https://github.com/ClickHouse/ClickHouse/pull/68238) ([Daniil Ivanik](https://github.com/divanik))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-1}

- 集成测试的不稳定性检查现在会多次运行每个测试用例,以发现测试中的更多问题并提高可靠性。该功能使用 `pytest-repeat` 库在同一环境中多次运行测试用例。为了通过测试,在测试用例结束时清理表和其他实体非常重要。重复运行比多次执行 pytest 快得多,因为它只需启动一次必要的容器。[#66986](https://github.com/ClickHouse/ClickHouse/pull/66986) ([Ilya Yatsishin](https://github.com/qoega))。
- 解除了 CLion 与 ClickHouse 配合使用时的阻塞问题。在之前的版本中,CLion 每次按键都会冻结一分钟。此修复关闭了 [#66994](https://github.com/ClickHouse/ClickHouse/issues/66994)。[#66995](https://github.com/ClickHouse/ClickHouse/pull/66995) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- getauxval:避免在较新的 Linux 内核中因高 ASLR 熵导致 sanitizer 重新执行时发生崩溃。[#67081](https://github.com/ClickHouse/ClickHouse/pull/67081) ([Raúl Marín](https://github.com/Algunenano))。
- 将客户端代码的某些部分提取到单个文件中,并对其应用尽可能高级别的优化,即使在调试构建中也是如此。此修复关闭了:[#65745](https://github.com/ClickHouse/ClickHouse/issues/65745)。[#67215](https://github.com/ClickHouse/ClickHouse/pull/67215) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。


#### 错误修复 {#bug-fix}

- Only relevant to the experimental Variant data type. Fix crash with Variant + AggregateFunction type. [#67122](https://github.com/ClickHouse/ClickHouse/pull/67122) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix crash in DistributedAsyncInsert when connection is empty. [#67219](https://github.com/ClickHouse/ClickHouse/pull/67219) ([Pablo Marcos](https://github.com/pamarcos)).
- Fix crash of `uniq` and `uniqTheta ` with `tuple()` argument. Closes [#67303](https://github.com/ClickHouse/ClickHouse/issues/67303). [#67306](https://github.com/ClickHouse/ClickHouse/pull/67306) ([flynn](https://github.com/ucasfl)).
- Fixes [#66026](https://github.com/ClickHouse/ClickHouse/issues/66026). Avoid unresolved table function arguments traversal in `ReplaceTableNodeToDummyVisitor`. [#67522](https://github.com/ClickHouse/ClickHouse/pull/67522) ([Dmitry Novik](https://github.com/novikd)).
- Fix potential stack overflow in `JSONMergePatch` function. Renamed this function from `jsonMergePatch` to `JSONMergePatch` because the previous name was wrong. The previous name is still kept for compatibility. Improved diagnostic of errors in the function. This closes [#67304](https://github.com/ClickHouse/ClickHouse/issues/67304). [#67756](https://github.com/ClickHouse/ClickHouse/pull/67756) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fixed a NULL pointer dereference, triggered by a specially crafted query, that crashed the server via hopEnd, hopStart, tumbleEnd, and tumbleStart. [#68098](https://github.com/ClickHouse/ClickHouse/pull/68098) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
- Fixed `Not-ready Set` in some system tables when filtering using subqueries. [#66018](https://github.com/ClickHouse/ClickHouse/pull/66018) ([Michael Kolupaev](https://github.com/al13n321)).
- Fixed reading of subcolumns after `ALTER ADD COLUMN` query. [#66243](https://github.com/ClickHouse/ClickHouse/pull/66243) ([Anton Popov](https://github.com/CurtizJ)).
- Fix boolean literals in query sent to external database (for engines like `PostgreSQL`). [#66282](https://github.com/ClickHouse/ClickHouse/pull/66282) ([vdimir](https://github.com/vdimir)).
- Fix formatting of query with aliased JOIN ON expression, e.g. `... JOIN t2 ON (x = y) AS e ORDER BY x` should be formatted as `... JOIN t2 ON ((x = y) AS e) ORDER BY x`. [#66312](https://github.com/ClickHouse/ClickHouse/pull/66312) ([vdimir](https://github.com/vdimir)).
- Fix cluster() for inter-server secret (preserve initial user as before). [#66364](https://github.com/ClickHouse/ClickHouse/pull/66364) ([Azat Khuzhin](https://github.com/azat)).
- Fix possible runtime error while converting Array field with nulls to Array(Variant). [#66727](https://github.com/ClickHouse/ClickHouse/pull/66727) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix for occasional deadlock in Context::getDDLWorker. [#66843](https://github.com/ClickHouse/ClickHouse/pull/66843) ([Alexander Gololobov](https://github.com/davenger)).
- Fix creating KeeperMap table after an incomplete drop. [#66865](https://github.com/ClickHouse/ClickHouse/pull/66865) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix broken part error while restoring to a `s3_plain_rewritable` disk. [#66881](https://github.com/ClickHouse/ClickHouse/pull/66881) ([Vitaly Baranov](https://github.com/vitlibar)).
- In rare cases ClickHouse could consider parts as broken because of some unexpected projections on disk. Now it's fixed. [#66898](https://github.com/ClickHouse/ClickHouse/pull/66898) ([alesapin](https://github.com/alesapin)).
- Fix invalid format detection in schema inference that could lead to logical error Format {} doesn't support schema inference. [#66899](https://github.com/ClickHouse/ClickHouse/pull/66899) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix possible deadlock on query cancel with parallel replicas. [#66905](https://github.com/ClickHouse/ClickHouse/pull/66905) ([Nikita Taranov](https://github.com/nickitat)).
- Forbid create as select even when database_replicated_allow_heavy_create is set. It was unconditionally forbidden in 23.12 and accidentally allowed under the setting in unreleased 24.7. [#66980](https://github.com/ClickHouse/ClickHouse/pull/66980) ([vdimir](https://github.com/vdimir)).
- Reading from the `numbers` could wrongly throw an exception when the `max_rows_to_read` limit was set. This closes [#66992](https://github.com/ClickHouse/ClickHouse/issues/66992). [#66996](https://github.com/ClickHouse/ClickHouse/pull/66996) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Add proper type conversion to lagInFrame and leadInFrame window functions - fixes msan test. [#67091](https://github.com/ClickHouse/ClickHouse/pull/67091) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- TRUNCATE DATABASE used to stop replication as if it was a DROP DATABASE query, it's fixed. [#67129](https://github.com/ClickHouse/ClickHouse/pull/67129) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Use a separate client context in `clickhouse-local`. [#67133](https://github.com/ClickHouse/ClickHouse/pull/67133) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix error `Cannot convert column because it is non constant in source stream but must be constant in result.` for a query that reads from the `Merge` table over the `Distriburted` table with one shard. [#67146](https://github.com/ClickHouse/ClickHouse/pull/67146) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Correct behavior of `ORDER BY all` with disabled `enable_order_by_all` and parallel replicas (distributed queries as well). [#67153](https://github.com/ClickHouse/ClickHouse/pull/67153) ([Igor Nikonov](https://github.com/devcrafter)).
- Fix wrong usage of input_format_max_bytes_to_read_for_schema_inference in schema cache. [#67157](https://github.com/ClickHouse/ClickHouse/pull/67157) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix the memory leak for count distinct, when exception issued during group by single nullable key. [#67171](https://github.com/ClickHouse/ClickHouse/pull/67171) ([Jet He](https://github.com/compasses)).
- Fix an error in optimization which converts OUTER JOIN to INNER JOIN. This closes [#67156](https://github.com/ClickHouse/ClickHouse/issues/67156). This closes [#66447](https://github.com/ClickHouse/ClickHouse/issues/66447). The bug was introduced in https://github.com/ClickHouse/ClickHouse/pull/62907. [#67178](https://github.com/ClickHouse/ClickHouse/pull/67178) ([Maksim Kita](https://github.com/kitaisreal)).
- Fix error `Conversion from AggregateFunction(name, Type) to AggregateFunction(name, Nullable(Type)) is not supported`. The bug was caused by the `optimize_rewrite_aggregate_function_with_if` optimization. Fixes [#67112](https://github.com/ClickHouse/ClickHouse/issues/67112). [#67229](https://github.com/ClickHouse/ClickHouse/pull/67229) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix hung query when using empty tuple as lhs of function IN. [#67295](https://github.com/ClickHouse/ClickHouse/pull/67295) ([Duc Canh Le](https://github.com/canhld94)).
- It was possible to create a very deep nested JSON data that triggered stack overflow while skipping unknown fields. This closes [#67292](https://github.com/ClickHouse/ClickHouse/issues/67292). [#67324](https://github.com/ClickHouse/ClickHouse/pull/67324) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix attaching ReplicatedMergeTree table after exception during startup. [#67360](https://github.com/ClickHouse/ClickHouse/pull/67360) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix segfault caused by incorrectly detaching from thread group in `Aggregator`. [#67385](https://github.com/ClickHouse/ClickHouse/pull/67385) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix one more case when a non-deterministic function is specified in PK. [#67395](https://github.com/ClickHouse/ClickHouse/pull/67395) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fixed `bloom_filter` index breaking queries with mildly weird conditions like `(k=2)=(k=2)` or `has([1,2,3], k)`. [#67423](https://github.com/ClickHouse/ClickHouse/pull/67423) ([Michael Kolupaev](https://github.com/al13n321)).
- Correctly parse file name/URI containing `::` if it's not an archive. [#67433](https://github.com/ClickHouse/ClickHouse/pull/67433) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix wait for tasks in ~WriteBufferFromS3 in case WriteBuffer was cancelled. [#67459](https://github.com/ClickHouse/ClickHouse/pull/67459) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Protect temporary part directories from removing during RESTORE. [#67491](https://github.com/ClickHouse/ClickHouse/pull/67491) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix execution of nested short-circuit functions. [#67520](https://github.com/ClickHouse/ClickHouse/pull/67520) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix `Logical error: Expected the argument №N of type T to have X rows, but it has 0`. The error could happen in a remote query with constant expression in `GROUP BY` (with a new analyzer). [#67536](https://github.com/ClickHouse/ClickHouse/pull/67536) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix join on tuple with NULLs: Some queries with the new analyzer and `NULL` inside the tuple in the `JOIN ON` section returned incorrect results. [#67538](https://github.com/ClickHouse/ClickHouse/pull/67538) ([vdimir](https://github.com/vdimir)).
- Fix redundant reschedule of FileCache::freeSpaceRatioKeepingThreadFunc() in case of full non-evictable cache. [#67540](https://github.com/ClickHouse/ClickHouse/pull/67540) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix inserting into stream like engines (Kafka, RabbitMQ, NATS) through HTTP interface. [#67554](https://github.com/ClickHouse/ClickHouse/pull/67554) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fix for function `toStartOfWeek` which returned the wrong result with a small `DateTime64` value. [#67558](https://github.com/ClickHouse/ClickHouse/pull/67558) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fix creation of view with recursive CTE. [#67587](https://github.com/ClickHouse/ClickHouse/pull/67587) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix `Logical error: 'file_offset_of_buffer_end <= read_until_position'` in filesystem cache. Closes [#57508](https://github.com/ClickHouse/ClickHouse/issues/57508). [#67623](https://github.com/ClickHouse/ClickHouse/pull/67623) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fixes [#62282](https://github.com/ClickHouse/ClickHouse/issues/62282). Removed the call to `convertFieldToString()` and added datatype specific serialization code. Parameterized view substitution was broken for multiple datatypes when parameter value was a function or expression returning datatype instance. [#67654](https://github.com/ClickHouse/ClickHouse/pull/67654) ([Shankar](https://github.com/shiyer7474)).
- Fix crash on `percent_rank`. `percent_rank`'s default frame type is changed to `range unbounded preceding and unbounded following`. `IWindowFunction`'s default window frame is considered and now window functions without window frame definition in sql can be put into different `WindowTransfomer`s properly. [#67661](https://github.com/ClickHouse/ClickHouse/pull/67661) ([lgbo](https://github.com/lgbo-ustc)).
- Fix reloading SQL UDFs with UNION. Previously, restarting the server could make UDF invalid. [#67665](https://github.com/ClickHouse/ClickHouse/pull/67665) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix possible logical error "Unexpected return type from if" with experimental Variant type and enabled setting `use_variant_as_common_type ` in function if with Tuples and Maps. [#67687](https://github.com/ClickHouse/ClickHouse/pull/67687) ([Kruglov Pavel](https://github.com/Avogar)).
- Due to a bug in Linux Kernel, a query can hung in `TimerDescriptor::drain`. This closes [#37686](https://github.com/ClickHouse/ClickHouse/issues/37686). [#67702](https://github.com/ClickHouse/ClickHouse/pull/67702) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix completion of `RESTORE ON CLUSTER` command. [#67720](https://github.com/ClickHouse/ClickHouse/pull/67720) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix dictionary hang in case of CANNOT_SCHEDULE_TASK while loading. [#67751](https://github.com/ClickHouse/ClickHouse/pull/67751) ([Azat Khuzhin](https://github.com/azat)).
- Queries like `SELECT count() FROM t WHERE cast(c = 1 or c = 9999 AS Bool) SETTINGS use_skip_indexes=1` with bloom filter indexes on `c` now work correctly. [#67781](https://github.com/ClickHouse/ClickHouse/pull/67781) ([jsc0218](https://github.com/jsc0218)).
- Fix wrong aggregation result in some queries with aggregation without keys and filter, close [#67419](https://github.com/ClickHouse/ClickHouse/issues/67419). [#67804](https://github.com/ClickHouse/ClickHouse/pull/67804) ([vdimir](https://github.com/vdimir)).
- Validate experimental/suspicious data types in ALTER ADD/MODIFY COLUMN. [#67911](https://github.com/ClickHouse/ClickHouse/pull/67911) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix DateTime64 parsing after constant folding in distributed queries, close [#66773](https://github.com/ClickHouse/ClickHouse/issues/66773). [#67920](https://github.com/ClickHouse/ClickHouse/pull/67920) ([vdimir](https://github.com/vdimir)).
- Fix wrong `count()` result when there is non-deterministic function in predicate. [#67922](https://github.com/ClickHouse/ClickHouse/pull/67922) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fixed the calculation of the maximum thread soft limit in containerized environments where the usable CPU count is limited. [#67963](https://github.com/ClickHouse/ClickHouse/pull/67963) ([Robert Schulze](https://github.com/rschu1ze)).
- Now ClickHouse doesn't consider part as broken if projection doesn't exist on disk but exists in `checksums.txt`. [#68003](https://github.com/ClickHouse/ClickHouse/pull/68003) ([alesapin](https://github.com/alesapin)).
- Fixed skipping of untouched parts in mutations with new analyzer. Previously with enabled analyzer data in part could be rewritten by mutation even if mutation doesn't affect this part according to predicate. [#68052](https://github.com/ClickHouse/ClickHouse/pull/68052) ([Anton Popov](https://github.com/CurtizJ)).
- Removes an incorrect optimization to remove sorting in subqueries that use `OFFSET`. Fixes [#67906](https://github.com/ClickHouse/ClickHouse/issues/67906). [#68099](https://github.com/ClickHouse/ClickHouse/pull/68099) ([Graham Campbell](https://github.com/GrahamCampbell)).
- Attempt to fix `Block structure mismatch in AggregatingStep stream: different types` for aggregate projection optimization. [#68107](https://github.com/ClickHouse/ClickHouse/pull/68107) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Try fix postgres crash when query is cancelled. [#68288](https://github.com/ClickHouse/ClickHouse/pull/68288) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix missing sync replica mode in query `SYSTEM SYNC REPLICA`. [#68326](https://github.com/ClickHouse/ClickHouse/pull/68326) ([Duc Canh Le](https://github.com/canhld94)).

### <a id="247"></a> ClickHouse 24.7 版本发布,2024-07-30 {#a-id247a-clickhouse-release-247-2024-07-30}

#### 向后不兼容的变更 {#backward-incompatible-change-5}

- 禁止在 Replicated 数据库中使用 `CREATE MATERIALIZED VIEW ... ENGINE Replicated*MergeTree POPULATE AS SELECT ...`。[#63963](https://github.com/ClickHouse/ClickHouse/pull/63963) ([vdimir](https://github.com/vdimir))。
- `clickhouse-keeper-client` 现在仅接受字符串字面量形式的路径,例如 `ls '/hello/world'`,不再接受裸字符串形式,例如 `ls /hello/world`。[#65494](https://github.com/ClickHouse/ClickHouse/pull/65494) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 指标 `KeeperOutstandingRequets` 已重命名为 `KeeperOutstandingRequests`。[#66206](https://github.com/ClickHouse/ClickHouse/pull/66206) ([Robert Schulze](https://github.com/rschu1ze))。
- 从 `system.functions` 表中移除了 `is_deterministic` 字段。[#66630](https://github.com/ClickHouse/ClickHouse/pull/66630) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 函数 `tuple` 现在会尝试在查询中构造命名元组(由 `enable_named_columns_in_function_tuple` 控制)。引入了函数 `tupleNames` 用于从元组中提取名称。[#54881](https://github.com/ClickHouse/ClickHouse/pull/54881) ([Amos Bird](https://github.com/amosbird))。
- 更改了物化视图去重的工作方式。修复了许多情况,例如:- 在目标表上:数据被拆分为 2 个或更多块,当这些块并行插入时会被视为重复。- 在物化视图目标表上:相同的块会被去重,这种情况发生在物化视图由于执行聚合操作而经常为不同的输入数据产生相同的结果数据时。- 在物化视图目标表上:来自不同物化视图的相同块会被去重。[#61601](https://github.com/ClickHouse/ClickHouse/pull/61601) ([Sema Checherinda](https://github.com/CheSema))。
- 函数 `bitShiftLeft` 和 `bitShiftRight` 对于超出边界的移位位置会返回错误 [#65838](https://github.com/ClickHouse/ClickHouse/pull/65838) ([Pablo Marcos](https://github.com/pamarcos))。


#### 新功能 {#new-feature-5}

- 为 `full_sorting_join` 算法添加 `ASOF JOIN` 支持。[#55051](https://github.com/ClickHouse/ClickHouse/pull/55051) ([vdimir](https://github.com/vdimir))。
- 在 `clickhouse-client` 中支持 JWT 身份验证(仅在 ClickHouse Cloud 中可用)。[#62829](https://github.com/ClickHouse/ClickHouse/pull/62829) ([Konstantin Bogdanov](https://github.com/thevar1able))。
- 添加 SQL 函数 `changeYear`、`changeMonth`、`changeDay`、`changeHour`、`changeMinute`、`changeSecond`。例如,`SELECT changeMonth(toDate('2024-06-14'), 7)` 返回日期 `2024-07-14`。[#63186](https://github.com/ClickHouse/ClickHouse/pull/63186) ([cucumber95](https://github.com/cucumber95))。
- 引入启动脚本,允许在启动阶段执行预配置的查询。[#64889](https://github.com/ClickHouse/ClickHouse/pull/64889) ([pufit](https://github.com/pufit))。
- 在客户端配置中支持 accept_invalid_certificate,以允许客户端通过安全 TCP 连接到使用自签名证书的服务器 - 可用作相应 `openSSL` 客户端设置 `verificationMode=none` + `invalidCertificateHandler.name=AcceptCertificateHandler` 的简写形式。[#65238](https://github.com/ClickHouse/ClickHouse/pull/65238) ([peacewalker122](https://github.com/peacewalker122))。
- 添加 system.error_log 系统表,其中包含来自 system.errors 表的错误值历史记录,定期刷新到磁盘。[#65381](https://github.com/ClickHouse/ClickHouse/pull/65381) ([Pablo Marcos](https://github.com/pamarcos))。
- 添加聚合函数 `groupConcat`。功能与 `arrayStringConcat(groupArray(column), ',')` 基本相同,可以接收 2 个参数:字符串分隔符和要处理的元素数量。[#65451](https://github.com/ClickHouse/ClickHouse/pull/65451) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- 添加 AzureQueue 存储引擎。[#65458](https://github.com/ClickHouse/ClickHouse/pull/65458) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 添加新设置以禁用/启用将页面索引写入 Parquet 文件。[#65475](https://github.com/ClickHouse/ClickHouse/pull/65475) ([lgbo](https://github.com/lgbo-ustc))。
- 引入 `logger.console_log_level` 服务器配置项以控制控制台的日志级别(如果启用)。[#65559](https://github.com/ClickHouse/ClickHouse/pull/65559) ([Azat Khuzhin](https://github.com/azat))。
- 使用表函数 `file` 时自动在目录路径末尾附加通配符 `*`。[#66019](https://github.com/ClickHouse/ClickHouse/pull/66019) ([Zhidong (David) Guo](https://github.com/Gun9niR))。
- 在非交互模式下为客户端添加 `--memory-usage` 选项。[#66393](https://github.com/ClickHouse/ClickHouse/pull/66393) ([vdimir](https://github.com/vdimir))。
- 为 clickhouse-disks 创建交互式客户端,支持从本地目录添加本地磁盘。[#64446](https://github.com/ClickHouse/ClickHouse/pull/64446) ([Daniil Ivanik](https://github.com/divanik))。
- 当在具有投影(projection)的表上执行轻量级删除时,用户可以选择抛出异常(默认)或删除投影。[#65594](https://github.com/ClickHouse/ClickHouse/pull/65594) ([jsc0218](https://github.com/jsc0218))。
- 添加包含所有已分离表主要信息的系统表。[#65400](https://github.com/ClickHouse/ClickHouse/pull/65400) ([Konstantin Morozov](https://github.com/k-morozov))。


#### 实验性功能 {#experimental-feature-4}

- 更改 `Variant` 数据类型的二进制序列化方式:新增 `compact` 模式,避免对仅包含单一变体或仅包含 NULL 值的数据粒度重复写入相同的判别符。新增 MergeTree 设置 `use_compact_variant_discriminators_serialization`,默认启用。注意,Variant 类型仍处于实验阶段,序列化方式的向后不兼容变更是允许的。[#62774](https://github.com/ClickHouse/ClickHouse/pull/62774) ([Kruglov Pavel](https://github.com/Avogar))。
- 支持 clickhouse-keeper 的磁盘后端存储。[#56626](https://github.com/ClickHouse/ClickHouse/pull/56626) ([Han Fei](https://github.com/hanfei1991))。
- 重构 JSONExtract 函数,支持更多类型,包括实验性的 Dynamic 类型。[#66046](https://github.com/ClickHouse/ClickHouse/pull/66046) ([Kruglov Pavel](https://github.com/Avogar))。
- 支持 `Variant` 和 `Dynamic` 子列的 null map 子列。[#66178](https://github.com/ClickHouse/ClickHouse/pull/66178) ([Kruglov Pavel](https://github.com/Avogar))。
- 修复从已变更的 `Memory` 表中读取 `Dynamic` 子列的问题。此前,如果通过 alter 修改了 Memory 表中 Dynamic 类型的 `max_types` 参数,后续读取子列可能返回错误结果。[#66066](https://github.com/ClickHouse/ClickHouse/pull/66066) ([Kruglov Pavel](https://github.com/Avogar))。
- 在使用自定义键并行副本时新增对 `cluster_for_parallel_replicas` 的支持。这使您可以在 MergeTree 表中使用带有自定义键的并行副本。[#65453](https://github.com/ClickHouse/ClickHouse/pull/65453) ([Antonio Andelic](https://github.com/antonio2368))。


#### 性能改进 {#performance-improvement-5}

- 将整数转字符串算法替换为更快的版本(从修改版 amdn/itoa 替换为修改版 jeaiii/itoa)。[#61661](https://github.com/ClickHouse/ClickHouse/pull/61661) ([Raúl Marín](https://github.com/Algunenano))。
- 现在会收集并缓存由 join(`parallel_hash` 算法)创建的哈希表大小。此信息将用于在后续查询执行时预分配哈希表空间,从而节省哈希表调整大小所需的时间。[#64553](https://github.com/ClickHouse/ClickHouse/pull/64553) ([Nikita Taranov](https://github.com/nickitat))。
- 通过使用缓冲优化了包含 `ORDER BY` 主键和具有高选择性条件的 `WHERE` 子句的查询。此功能由设置 `read_in_order_use_buffering` 控制(默认启用),可能会增加查询的内存使用量。[#64607](https://github.com/ClickHouse/ClickHouse/pull/64607) ([Anton Popov](https://github.com/CurtizJ))。
- 提高了加载 `plain_rewritable` 元数据的性能。[#65634](https://github.com/ClickHouse/ClickHouse/pull/65634) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 在只读磁盘上附加表时,通过不加载过时的数据分区来减少资源使用。[#65635](https://github.com/ClickHouse/ClickHouse/pull/65635) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 支持 Set 索引的 minmax 超矩形。[#65676](https://github.com/ClickHouse/ClickHouse/pull/65676) ([AntiTopQuark](https://github.com/AntiTopQuark))。
- 卸载过时数据分区的主索引以降低总内存使用量。[#65852](https://github.com/ClickHouse/ClickHouse/pull/65852) ([Anton Popov](https://github.com/CurtizJ))。
- 当模式为简单模式时,即不包含元字符、模式类、标志、分组字符等,函数 `replaceRegexpAll` 和 `replaceRegexpOne` 现在速度显著提升。(感谢 Taiyang Li)。[#66185](https://github.com/ClickHouse/ClickHouse/pull/66185) ([Robert Schulze](https://github.com/rschu1ze))。
- S3 请求:减少查询的重试时间,增加备份的重试次数。查询为 8.5 分钟和 100 次重试,备份恢复为 1.2 小时和 1000 次重试。[#65232](https://github.com/ClickHouse/ClickHouse/pull/65232) ([Sema Checherinda](https://github.com/CheSema))。
- 支持查询计划 LIMIT 优化。支持 PostgreSQL 存储和表函数的 LIMIT 下推。[#65454](https://github.com/ClickHouse/ClickHouse/pull/65454) ([Maksim Kita](https://github.com/kitaisreal))。
- 改进了 ZooKeeper 负载均衡。尽管设置了 `fallback_session_lifetime`,当前会话在最优节点可用之前不会过期。新增了对可用区感知负载均衡的支持。[#65570](https://github.com/ClickHouse/ClickHouse/pull/65570) ([Alexander Tokmakov](https://github.com/tavplubix))。
- DatabaseCatalog 通过使用最多 database_catalog_drop_table_concurrency 个线程来加快表删除速度。[#66065](https://github.com/ClickHouse/ClickHouse/pull/66065) ([Sema Checherinda](https://github.com/CheSema))。


#### 改进 {#improvement-5}

- 改进了 ZooKeeper 负载均衡。尽管设置了 `fallback_session_lifetime`,当前会话不会过期,直到最优节点可用。新增了对可用区感知均衡的支持。[#65570](https://github.com/ClickHouse/ClickHouse/pull/65570) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 设置 `optimize_trivial_insert_select` 默认已禁用。在大多数情况下,这应该是有益的。但是,如果您发现 INSERT SELECT 变慢或内存使用增加,可以重新启用它或执行 `SET compatibility = '24.6'`。[#58970](https://github.com/ClickHouse/ClickHouse/pull/58970) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 当 `clickhouse-client` 或 `clickhouse-local` 崩溃时打印堆栈跟踪和诊断信息。[#61109](https://github.com/ClickHouse/ClickHouse/pull/61109) ([Alexander Tokmakov](https://github.com/tavplubix))。
- `SHOW INDEX | INDEXES | INDICES | KEYS` 的结果之前按主键列名排序。由于这不够直观,现在结果按主键列在主键中的位置排序。[#61131](https://github.com/ClickHouse/ClickHouse/pull/61131) ([Robert Schulze](https://github.com/rschu1ze))。
- 更改了物化视图去重的工作方式。修复了许多情况,例如:- 在目标表上:数据被拆分为 2 个或更多块,当这些块并行插入时被视为重复。- 在物化视图目标表上:相同的块被去重,这种情况发生在物化视图由于执行聚合而经常为不同的输入数据产生相同的结果数据时。- 在物化视图目标表上:来自不同物化视图的相同块被去重。[#61601](https://github.com/ClickHouse/ClickHouse/pull/61601) ([Sema Checherinda](https://github.com/CheSema))。
- 支持读取分区的 DeltaLake 数据。通过读取元数据而非数据来推断 DeltaLake 模式。[#63201](https://github.com/ClickHouse/ClickHouse/pull/63201) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 在可组合协议中,TLS 层仅接受 `certificateFile` 和 `privateKeyFile` 参数。https://clickhouse.com/docs/operations/settings/composable-protocols。[#63985](https://github.com/ClickHouse/ClickHouse/pull/63985) ([Anton Ivashkin](https://github.com/ianton-ru))。
- 新增了性能事件 `SelectQueriesWithPrimaryKeyUsage`,用于指示有多少 SELECT 查询使用主键来评估 WHERE 子句。[#64492](https://github.com/ClickHouse/ClickHouse/pull/64492) ([0x01f](https://github.com/0xfei))。
- `StorageS3Queue` 相关的修复和改进。根据服务器上的物理 CPU 核心数推导 `s3queue_processing_threads_num` 的默认值(而不是之前的默认值 1)。将 `s3queue_loading_retries` 的默认值设置为 10。修复 `system.s3queue` 异常列中可能出现的模糊"未捕获异常"。在 `MEMORY_LIMIT_EXCEEDED` 异常时不增加重试计数。将文件提交移至表插入完全完成后的阶段,以避免在未插入时提交文件。新增设置 `s3queue_max_processed_files_before_commit`、`s3queue_max_processed_rows_before_commit`、`s3queue_max_processed_bytes_before_commit`、`s3queue_max_processing_time_sec_before_commit`,以更好地控制提交和刷新时间。[#65046](https://github.com/ClickHouse/ClickHouse/pull/65046) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 支持参数化视图函数中的别名(仅限新分析器)。[#65190](https://github.com/ClickHouse/ClickHouse/pull/65190) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 更新了 azureBlobStorage 日志中账户密钥的掩码处理。[#65273](https://github.com/ClickHouse/ClickHouse/pull/65273) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
- 当过滤表达式是 `PARTITION BY` 表达式的一部分时,对 `IN` 谓词进行分区裁剪。[#65335](https://github.com/ClickHouse/ClickHouse/pull/65335) ([Eduard Karacharov](https://github.com/korowa))。
- `arrayMin`/`arrayMax` 可应用于所有可比较的数据类型。[#65455](https://github.com/ClickHouse/ClickHouse/pull/65455) ([pn](https://github.com/chloro-pn))。
- 改进了 cgroups v2 的内存统计,排除了页面缓存占用的内存量。[#65470](https://github.com/ClickHouse/ClickHouse/pull/65470) ([Nikita Taranov](https://github.com/nickitat))。
- 在序列化数据块以插入 EmbeddedRocksDB 表时,不为每一行创建格式设置。[#65474](https://github.com/ClickHouse/ClickHouse/pull/65474) ([Duc Canh Le](https://github.com/canhld94))。
- 将 `clickhouse-local` 提示符简化为 `:)`。`getFQDNOrHostName()` 在 macOS 上耗时过长,而且我们不希望 `clickhouse-local` 的提示符中包含主机名。[#65510](https://github.com/ClickHouse/ClickHouse/pull/65510) ([Konstantin Bogdanov](https://github.com/thevar1able))。
- 避免在低端虚拟机上打印来自 jemalloc 关于每 CPU 内存区域的消息。[#65532](https://github.com/ClickHouse/ClickHouse/pull/65532) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 默认禁用文件系统缓存后台下载。当我们修复可能出现的"内存限制超出"问题后将重新启用。该问题是因为如果使用后台下载线程,内存释放在查询上下文之外完成(而缓冲区在查询上下文内分配)。此外,我们需要添加一个单独的设置来定义后台工作线程的最大下载大小(目前受 max_file_segment_size 限制,这可能太大)。[#65534](https://github.com/ClickHouse/ClickHouse/pull/65534) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 在配置中新增选项 `<config_reload_interval_ms>`,允许指定 ClickHouse 重新加载配置的频率。[#65545](https://github.com/ClickHouse/ClickHouse/pull/65545) ([alesapin](https://github.com/alesapin))。
- 实现了 ClickHouse 数据类型的二进制编码,并在文档中添加了其规范。在 Dynamic 二进制序列化中使用它,允许在设置下的 RowBinaryWithNamesAndTypes 和 Native 格式中使用它。[#65546](https://github.com/ClickHouse/ClickHouse/pull/65546) ([Kruglov Pavel](https://github.com/Avogar))。
- 服务器设置 `compiled_expression_cache_size` 和 `compiled_expression_cache_elements_size` 现在显示在 `system.server_settings` 中。[#65584](https://github.com/ClickHouse/ClickHouse/pull/65584) ([Robert Schulze](https://github.com/rschu1ze))。
- 新增基于 x509 SubjectAltName 扩展的用户身份识别支持。[#65626](https://github.com/ClickHouse/ClickHouse/pull/65626) ([Anton Kozlov](https://github.com/tonickkozlov))。
- `clickhouse-local` 将遵守配置文件中的 `max_server_memory_usage` 和 `max_server_memory_usage_to_ram_ratio`。它还将默认将最大内存使用量设置为系统内存的 90%,与 `clickhouse-server` 相同。[#65697](https://github.com/ClickHouse/ClickHouse/pull/65697) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 新增一个脚本用于将文件备份到 ClickHouse。[#65699](https://github.com/ClickHouse/ClickHouse/pull/65699) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- PostgreSQL 源支持查询取消。[#65722](https://github.com/ClickHouse/ClickHouse/pull/65722) ([Maksim Kita](https://github.com/kitaisreal))。
- 使 `allow_experimental_analyzer` 在分布式查询中由发起者控制。这确保了在混合版本集群中操作时的兼容性和正确性。[#65777](https://github.com/ClickHouse/ClickHouse/pull/65777) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 在 Keeper 中遵守 cgroup CPU 限制。[#65819](https://github.com/ClickHouse/ClickHouse/pull/65819) ([Antonio Andelic](https://github.com/antonio2368))。
- 允许使用空参数调用 `concat` 函数 `:) select concat();`。[#65887](https://github.com/ClickHouse/ClickHouse/pull/65887) ([李扬](https://github.com/taiyang-li))。
- 允许在 `clickhouse-local` 中控制命名集合。[#65973](https://github.com/ClickHouse/ClickHouse/pull/65973) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 改进 Azure 相关的性能事件。[#65999](https://github.com/ClickHouse/ClickHouse/pull/65999) ([alesapin](https://github.com/alesapin))。
- 支持按写入器时区读取 ORC 文件。[#66025](https://github.com/ClickHouse/ClickHouse/pull/66025) ([kevinyhzou](https://github.com/KevinyhZou))。
- 新增控制 PostgreSQL 连接的设置。设置 `postgresql_connection_attempt_timeout` 指定传递给连接 URL 的 `connect_timeout` 参数的值。设置 `postgresql_connection_pool_retries` 指定建立到 PostgreSQL 端点连接的重试次数。[#66232](https://github.com/ClickHouse/ClickHouse/pull/66232) ([Dmitry Novik](https://github.com/novikd))。
- 减少 `system.processors_profile_log` 中 `input_wait_elapsed_us`/`elapsed_us` 的不准确性。[#66239](https://github.com/ClickHouse/ClickHouse/pull/66239) ([Azat Khuzhin](https://github.com/azat))。
- 改进文件系统缓存的性能事件。[#66249](https://github.com/ClickHouse/ClickHouse/pull/66249) ([zhukai](https://github.com/nauu))。
- 新增设置以在使用复制存储进行命名集合管理的查询中忽略 `ON CLUSTER` 子句。[#66288](https://github.com/ClickHouse/ClickHouse/pull/66288) ([MikhailBurdukov](https://github.com/MikhailBurdukov))。
- 函数 `generateSnowflakeID` 现在允许指定机器 ID 作为参数,以防止在大型集群中发生冲突。[#66374](https://github.com/ClickHouse/ClickHouse/pull/66374) ([ZAWA_ll](https://github.com/Zawa-ll))。
- 在交互模式下禁用 `Ctrl+Z` 挂起。这是一个常见的陷阱,对几乎所有用户来说都不是预期行为。我想只有少数极端高级用户可能会欣赏将终端应用程序挂起到后台,但我不认识这样的人。[#66511](https://github.com/ClickHouse/ClickHouse/pull/66511) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 新增用于验证字典中主键类型的选项。如果没有此选项,对于简单布局,任何列类型都将隐式转换为 UInt64。[#66595](https://github.com/ClickHouse/ClickHouse/pull/66595) ([MikhailBurdukov](https://github.com/MikhailBurdukov))。





#### 错误修复(官方稳定版本中用户可见的异常行为) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-4}

- Check cyclic dependencies on CREATE/REPLACE/RENAME/EXCHANGE queries and throw an exception if there is a cyclic dependency. Previously such cyclic dependencies could lead to a deadlock during server startup. Also fix some bugs in dependencies creation. [#65405](https://github.com/ClickHouse/ClickHouse/pull/65405) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix unexpected sizes of `LowCardinality` columns in function calls. [#65298](https://github.com/ClickHouse/ClickHouse/pull/65298) ([Raúl Marín](https://github.com/Algunenano)).
- Fix crash in maxIntersections. [#65689](https://github.com/ClickHouse/ClickHouse/pull/65689) ([Raúl Marín](https://github.com/Algunenano)).
- Fix the `VALID UNTIL` clause in the user definition resetting after a restart. [#66409](https://github.com/ClickHouse/ClickHouse/pull/66409) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix the remaining time column in `SHOW MERGES`. [#66735](https://github.com/ClickHouse/ClickHouse/pull/66735) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- `Query was cancelled` might have been printed twice in clickhouse-client. This behaviour is fixed. [#66005](https://github.com/ClickHouse/ClickHouse/pull/66005) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Fixed crash while using `MaterializedMySQL` (which is an unsupported, experimental feature) with TABLE OVERRIDE that maps MySQL NULL field into ClickHouse not NULL field. [#54649](https://github.com/ClickHouse/ClickHouse/pull/54649) ([Filipp Ozinov](https://github.com/bakwc)).
- Fix logical error when `PREWHERE` expression read no columns and table has no adaptive index granularity (very old table). [#59173](https://github.com/ClickHouse/ClickHouse/pull/59173) ([Alexander Gololobov](https://github.com/davenger)).
- Fix bug with the cancellation buffer when canceling a query. [#64478](https://github.com/ClickHouse/ClickHouse/pull/64478) ([Sema Checherinda](https://github.com/CheSema)).
- Fix filling parts columns from metadata (when columns.txt does not exists). [#64757](https://github.com/ClickHouse/ClickHouse/pull/64757) ([Azat Khuzhin](https://github.com/azat)).
- Fix crash for `ALTER TABLE ... ON CLUSTER ... MODIFY SQL SECURITY`. [#64957](https://github.com/ClickHouse/ClickHouse/pull/64957) ([pufit](https://github.com/pufit)).
- Fix crash on destroying AccessControl: add explicit shutdown. [#64993](https://github.com/ClickHouse/ClickHouse/pull/64993) ([Vitaly Baranov](https://github.com/vitlibar)).
- Eliminate injective function in argument of functions `uniq*` recursively. This used to work correctly but was broken in the new analyzer. [#65140](https://github.com/ClickHouse/ClickHouse/pull/65140) ([Duc Canh Le](https://github.com/canhld94)).
- Fix unexpected projection name when query with CTE. [#65267](https://github.com/ClickHouse/ClickHouse/pull/65267) ([wudidapaopao](https://github.com/wudidapaopao)).
- Require `dictGet` privilege when accessing dictionaries via direct query or the `Dictionary` table engine. [#65359](https://github.com/ClickHouse/ClickHouse/pull/65359) ([Joe Lynch](https://github.com/joelynch)).
- Fix user-specific S3 auth with incremental backups. [#65481](https://github.com/ClickHouse/ClickHouse/pull/65481) ([Antonio Andelic](https://github.com/antonio2368)).
- Disable `non-intersecting-parts` optimization for queries with `FINAL` in case of `read-in-order` optimization was enabled. This could lead to an incorrect query result. As a workaround, disable `do_not_merge_across_partitions_select_final` and `split_parts_ranges_into_intersecting_and_non_intersecting_final` before this fix is merged. [#65505](https://github.com/ClickHouse/ClickHouse/pull/65505) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix getting exception `Index out of bound for blob metadata` in case all files from list batch were filtered out. [#65523](https://github.com/ClickHouse/ClickHouse/pull/65523) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix NOT_FOUND_COLUMN_IN_BLOCK for deduplicate merge of projection. [#65573](https://github.com/ClickHouse/ClickHouse/pull/65573) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fixed bug in MergeJoin. Column in sparse serialisation might be treated as a column of its nested type though the required conversion wasn't performed. [#65632](https://github.com/ClickHouse/ClickHouse/pull/65632) ([Nikita Taranov](https://github.com/nickitat)).
- Fixed a bug that compatibility level '23.4' was not properly applied. [#65737](https://github.com/ClickHouse/ClickHouse/pull/65737) ([cw5121](https://github.com/cw5121)).
- Fix odbc table with nullable fields. [#65738](https://github.com/ClickHouse/ClickHouse/pull/65738) ([Rodolphe Dugé de Bernonville](https://github.com/RodolpheDuge)).
- Fix data race in `TCPHandler`, which could happen on fatal error. [#65744](https://github.com/ClickHouse/ClickHouse/pull/65744) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix invalid exceptions in function `parseDateTime` with `%F` and `%D` placeholders. [#65768](https://github.com/ClickHouse/ClickHouse/pull/65768) ([Antonio Andelic](https://github.com/antonio2368)).
- For queries that read from `PostgreSQL`, cancel the internal `PostgreSQL` query if the ClickHouse query is finished. Otherwise, `ClickHouse` query cannot be canceled until the internal `PostgreSQL` query is finished. [#65771](https://github.com/ClickHouse/ClickHouse/pull/65771) ([Maksim Kita](https://github.com/kitaisreal)).
- Fix a bug in short circuit logic when old analyzer and dictGetOrDefault is used. [#65802](https://github.com/ClickHouse/ClickHouse/pull/65802) ([jsc0218](https://github.com/jsc0218)).
- Fix a bug leads to EmbeddedRocksDB with TTL write corrupted SST files. [#65816](https://github.com/ClickHouse/ClickHouse/pull/65816) ([Duc Canh Le](https://github.com/canhld94)).
- Functions `bitTest`, `bitTestAll`, and `bitTestAny` now return an error if the specified bit index is out-of-bounds [#65818](https://github.com/ClickHouse/ClickHouse/pull/65818) ([Pablo Marcos](https://github.com/pamarcos)).
- Setting `join_any_take_last_row` is supported in any query with hash join. [#65820](https://github.com/ClickHouse/ClickHouse/pull/65820) ([vdimir](https://github.com/vdimir)).
- Better handling of join conditions involving `IS NULL` checks (for example `ON (a = b AND (a IS NOT NULL) AND (b IS NOT NULL) ) OR ( (a IS NULL) AND (b IS NULL) )` is rewritten to `ON a <=> b`), fix incorrect optimization when condition other then `IS NULL` are present. [#65835](https://github.com/ClickHouse/ClickHouse/pull/65835) ([vdimir](https://github.com/vdimir)).
- Fix growing memory usage in S3Queue. [#65839](https://github.com/ClickHouse/ClickHouse/pull/65839) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix tie handling in `arrayAUC` to match sklearn. [#65840](https://github.com/ClickHouse/ClickHouse/pull/65840) ([gabrielmcg44](https://github.com/gabrielmcg44)).
- Fix possible issues with MySQL server protocol TLS connections. [#65917](https://github.com/ClickHouse/ClickHouse/pull/65917) ([Azat Khuzhin](https://github.com/azat)).
- Fix possible issues with MySQL client protocol TLS connections. [#65938](https://github.com/ClickHouse/ClickHouse/pull/65938) ([Azat Khuzhin](https://github.com/azat)).
- Fix handling of `SSL_ERROR_WANT_READ`/`SSL_ERROR_WANT_WRITE` with zero timeout. [#65941](https://github.com/ClickHouse/ClickHouse/pull/65941) ([Azat Khuzhin](https://github.com/azat)).
- Add missing settings `input_format_csv_skip_first_lines/input_format_tsv_skip_first_lines/input_format_csv_try_infer_numbers_from_strings/input_format_csv_try_infer_strings_from_quoted_tuples` in schema inference cache because they can change the resulting schema. It prevents from incorrect result of schema inference with these settings changed. [#65980](https://github.com/ClickHouse/ClickHouse/pull/65980) ([Kruglov Pavel](https://github.com/Avogar)).
- Column \_size in s3 engine and s3 table function denotes the size of a file inside the archive, not a size of the archive itself. [#65993](https://github.com/ClickHouse/ClickHouse/pull/65993) ([Daniil Ivanik](https://github.com/divanik)).
- Fix resolving dynamic subcolumns in analyzer, avoid reading the whole column on dynamic subcolumn reading. [#66004](https://github.com/ClickHouse/ClickHouse/pull/66004) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix config merging for from_env with replace overrides. [#66034](https://github.com/ClickHouse/ClickHouse/pull/66034) ([Azat Khuzhin](https://github.com/azat)).
- Fix a possible hanging in `GRPCServer` during shutdown. [#66061](https://github.com/ClickHouse/ClickHouse/pull/66061) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fixed several cases in function `has` with non-constant `LowCardinality` arguments. [#66088](https://github.com/ClickHouse/ClickHouse/pull/66088) ([Anton Popov](https://github.com/CurtizJ)).
- Fix for `groupArrayIntersect`. It had incorrect behavior in the `merge()` function. Also, fixed behavior in `deserialise()` for numeric and general data. [#66103](https://github.com/ClickHouse/ClickHouse/pull/66103) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fixed buffer overflow bug in `unbin`/`unhex` implementation. [#66106](https://github.com/ClickHouse/ClickHouse/pull/66106) ([Nikita Taranov](https://github.com/nickitat)).
- Disable the `merge-filters` optimization introduced in [#64760](https://github.com/ClickHouse/ClickHouse/issues/64760). It may cause an exception if optimization merges two filter expressions and does not apply a short-circuit evaluation. [#66126](https://github.com/ClickHouse/ClickHouse/pull/66126) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fixed the issue when the server failed to parse Avro files with negative block size arrays encoded, which is now allowed by the Avro specification. [#66130](https://github.com/ClickHouse/ClickHouse/pull/66130) ([Serge Klochkov](https://github.com/slvrtrn)).
- Fixed a bug in ZooKeeper client: a session could get stuck in unusable state after receiving a hardware error from ZooKeeper. For example, this might happen due to "soft memory limit" in ClickHouse Keeper. [#66140](https://github.com/ClickHouse/ClickHouse/pull/66140) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix issue in SumIfToCountIfVisitor and signed integers. [#66146](https://github.com/ClickHouse/ClickHouse/pull/66146) ([Raúl Marín](https://github.com/Algunenano)).
- Fix rare case with missing data in the result of distributed query. [#66174](https://github.com/ClickHouse/ClickHouse/pull/66174) ([vdimir](https://github.com/vdimir)).
- Fix order of parsing metadata fields in StorageDeltaLake. [#66211](https://github.com/ClickHouse/ClickHouse/pull/66211) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Don't throw `TIMEOUT_EXCEEDED` for `none_only_active` mode of `distributed_ddl_output_mode`. [#66218](https://github.com/ClickHouse/ClickHouse/pull/66218) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix handling limit for `system.numbers_mt` when no index can be used. [#66231](https://github.com/ClickHouse/ClickHouse/pull/66231) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fixed how the ClickHouse server detects the maximum number of usable CPU cores as specified by cgroups v2 if the server runs in a container such as Docker. In more detail, containers often run their process in the root cgroup which has an empty name. In that case, ClickHouse ignored the CPU limits set by cgroups v2. [#66237](https://github.com/ClickHouse/ClickHouse/pull/66237) ([filimonov](https://github.com/filimonov)).
- Fix the `Not-ready set` error when a subquery with `IN` is used in the constraint. [#66261](https://github.com/ClickHouse/ClickHouse/pull/66261) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix error reporting while copying to S3 or AzureBlobStorage. [#66295](https://github.com/ClickHouse/ClickHouse/pull/66295) ([Vitaly Baranov](https://github.com/vitlibar)).
- Prevent watchdog from keeping descriptors of unlinked (rotated) log files. [#66334](https://github.com/ClickHouse/ClickHouse/pull/66334) ([Aleksei Filatov](https://github.com/aalexfvk)).
- Fix the bug that logicalexpressionoptimizerpass lost logical type of constant. [#66344](https://github.com/ClickHouse/ClickHouse/pull/66344) ([pn](https://github.com/chloro-pn)).
- Fix `Column identifier is already registered` error with `group_by_use_nulls=true` and new analyzer. [#66400](https://github.com/ClickHouse/ClickHouse/pull/66400) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix possible incorrect result for queries joining and filtering table external engine (like PostgreSQL), due to too aggressive filter pushdown. Since now, conditions from where section won't be send to external database in case of outer join with external table. [#66402](https://github.com/ClickHouse/ClickHouse/pull/66402) ([vdimir](https://github.com/vdimir)).
- Added missing column materialization for cross join. [#66413](https://github.com/ClickHouse/ClickHouse/pull/66413) ([lgbo](https://github.com/lgbo-ustc)).
- Fix `Cannot find column` error for queries with constant expression in `GROUP BY` key and new analyzer enabled. [#66433](https://github.com/ClickHouse/ClickHouse/pull/66433) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Avoid possible logical error during import from Npy format in case of bad array nesting level, fix testing of other kinds of errors. [#66461](https://github.com/ClickHouse/ClickHouse/pull/66461) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fix wrong count() result when there is non-deterministic function in predicate. [#66510](https://github.com/ClickHouse/ClickHouse/pull/66510) ([Duc Canh Le](https://github.com/canhld94)).
- Correctly track memory for `Allocator::realloc`. [#66548](https://github.com/ClickHouse/ClickHouse/pull/66548) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix reading of uninitialized memory when hashing empty tuples. [#66562](https://github.com/ClickHouse/ClickHouse/pull/66562) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix an invalid result for queries with `WINDOW`. This could happen when `PARTITION` columns have sparse serialization and window functions are executed in parallel. [#66579](https://github.com/ClickHouse/ClickHouse/pull/66579) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix removing named collections in local storage. [#66599](https://github.com/ClickHouse/ClickHouse/pull/66599) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fix `column_length` is not updated in `ColumnTuple::insertManyFrom`. [#66626](https://github.com/ClickHouse/ClickHouse/pull/66626) ([lgbo](https://github.com/lgbo-ustc)).
- Fix `Unknown identifier` and `Column is not under aggregate function` errors for queries with the expression `(column IS NULL).` The bug was triggered by [#65088](https://github.com/ClickHouse/ClickHouse/issues/65088), with the disabled analyzer only. [#66654](https://github.com/ClickHouse/ClickHouse/pull/66654) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix `Method getResultType is not supported for QUERY query node` error when scalar subquery was used as the first argument of IN (with new analyzer). [#66655](https://github.com/ClickHouse/ClickHouse/pull/66655) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix possible PARAMETER_OUT_OF_BOUND error during reading variant subcolumn. [#66659](https://github.com/ClickHouse/ClickHouse/pull/66659) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix rare case of stuck merge after drop column. [#66707](https://github.com/ClickHouse/ClickHouse/pull/66707) ([Raúl Marín](https://github.com/Algunenano)).
- Fix assertion `isUniqTypes` when insert select from remote sources. [#66722](https://github.com/ClickHouse/ClickHouse/pull/66722) ([Sema Checherinda](https://github.com/CheSema)).
- Fix logical error in PrometheusRequestHandler. [#66621](https://github.com/ClickHouse/ClickHouse/pull/66621) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix `indexHint` function case found by fuzzer. [#66286](https://github.com/ClickHouse/ClickHouse/pull/66286) ([Anton Popov](https://github.com/CurtizJ)).
- Fix AST formatting of 'create table b empty as a'. [#64951](https://github.com/ClickHouse/ClickHouse/pull/64951) ([Michael Kolupaev](https://github.com/al13n321)).

### <a id="246"></a> ClickHouse 版本 24.6, 2024-07-01 {#a-id246a-clickhouse-release-246-2024-07-01}

#### 向后不兼容的变更 {#backward-incompatible-change-6}

- 默认启用数据库和表的异步加载。请参阅 config.xml 中的 `async_load_databases` 配置。虽然此变更完全兼容,但可能会引入行为差异。当 `async_load_databases` 为 false 时(如旧版本),服务器在所有表加载完成之前不会接受连接。当 `async_load_databases` 为 true 时(如新版本),服务器可以在所有表加载完成之前接受连接。如果对尚未加载的表执行查询,查询将等待该表加载完成,这可能需要相当长的时间。如果服务器是负载均衡器下大型分布式系统的一部分,这可能会改变服务器的行为。在第一种情况下,负载均衡器会收到连接拒绝并快速故障转移到另一台服务器。在第二种情况下,负载均衡器可能会连接到仍在加载表的服务器,导致查询延迟增加。此外,如果大量查询在等待状态下累积,当它们同时开始处理时,可能会导致"惊群"问题。这仅对高负载的分布式后端有影响。您可以将 `async_load_databases` 的值设置为 false 以避免此问题。[#57695](https://github.com/ClickHouse/ClickHouse/pull/57695) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 对于 `MergeTree` 表,默认启用 `replace_long_file_name_to_hash` 设置。[#64457](https://github.com/ClickHouse/ClickHouse/pull/64457) ([Anton Popov](https://github.com/CurtizJ))。此设置完全兼容,升级期间无需任何操作。从 23.9 版本开始的所有版本都支持新的数据格式。启用此设置后,您将无法再降级到 23.8 或更早的版本。
- 某些无效查询将在解析期间更早失败。注意:当内联 KQL 表达式(实验性的 Kusto 语言)被放入 `kql` 表函数而没有使用字符串字面量时,已禁用对其的支持,例如 `kql(garbage | trash)` 而不是 `kql('garbage | trash')` 或 `kql($$garbage | trash$$)`。此功能是无意中引入的,不应该存在。[#61500](https://github.com/ClickHouse/ClickHouse/pull/61500) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 重构了存储 `S3Queue` 的 `Ordered` 模式中的并行处理。如果您使用了 `s3queue_processing_threads_num` 或 `s3queue_total_shards_num` 设置,此 PR 对 Ordered 模式向后不兼容。设置 `s3queue_total_shards_num` 已被删除,以前它只允许在 `s3queue_allow_experimental_sharded_mode` 下使用,该模式现已弃用。添加了一个新设置 - `s3queue_buckets`。[#64349](https://github.com/ClickHouse/ClickHouse/pull/64349) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 添加了新函数 `snowflakeIDToDateTime`、`snowflakeIDToDateTime64`、`dateTimeToSnowflakeID` 和 `dateTime64ToSnowflakeID`。与现有函数 `snowflakeToDateTime`、`snowflakeToDateTime64`、`dateTimeToSnowflake` 和 `dateTime64ToSnowflake` 不同,新函数与函数 `generateSnowflakeID` 兼容,即它们接受由 `generateSnowflakeID` 生成的 snowflake ID,并生成与 `generateSnowflakeID` 相同类型的 snowflake ID(即 `UInt64`)。此外,新函数默认使用 UNIX 纪元(即 1970-01-01),就像 `generateSnowflakeID` 一样。如有必要,可以传递不同的纪元,例如 Twitter/X 的纪元 2010-11-04,即自 UNIX 纪元以来的 1288834974657 毫秒。旧的转换函数已弃用,并将在过渡期后删除:要继续使用它们,请启用设置 `allow_deprecated_snowflake_conversion_functions`。[#64948](https://github.com/ClickHouse/ClickHouse/pull/64948) ([Robert Schulze](https://github.com/rschu1ze))。


#### 新功能 {#new-feature-6}

- 允许在 ClickHouse Keeper 中存储命名集合。[#64574](https://github.com/ClickHouse/ClickHouse/pull/64574) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 支持空元组。[#55061](https://github.com/ClickHouse/ClickHouse/pull/55061) ([Amos Bird](https://github.com/amosbird))。
- 新增 Hilbert 曲线编码和解码函数。[#60156](https://github.com/ClickHouse/ClickHouse/pull/60156) ([Artem Mustafin](https://github.com/Artemmm91))。
- 新增对 `hilbertEncode` 的索引分析支持。[#64662](https://github.com/ClickHouse/ClickHouse/pull/64662) ([Artem Mustafin](https://github.com/Artemmm91))。
- 新增使用 `readWKTLineString` 函数读取 WKT 格式 `LINESTRING` 几何图形的支持。[#62519](https://github.com/ClickHouse/ClickHouse/pull/62519) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 允许从不同磁盘附加数据部分。[#63087](https://github.com/ClickHouse/ClickHouse/pull/63087) ([Unalian](https://github.com/Unalian))。
- 新增 SQL 函数 `generateSnowflakeID`,用于生成 Twitter 风格的 Snowflake ID。[#63577](https://github.com/ClickHouse/ClickHouse/pull/63577) ([Danila Puzov](https://github.com/kazalika))。
- 新增 `merge_workload` 和 `mutation_workload` 设置,用于调节合并、变更和其他工作负载之间的资源利用和共享方式。[#64061](https://github.com/ClickHouse/ClickHouse/pull/64061) ([Sergei Trifonov](https://github.com/serxa))。
- 新增使用 `=` 运算符比较 `IPv4` 和 `IPv6` 类型的支持。[#64292](https://github.com/ClickHouse/ClickHouse/pull/64292) ([Francisco J. Jurado Moreno](https://github.com/Beetelbrox))。
- 支持在二元数学函数(pow、atan2、max2、min2、hypot)中使用 decimal 参数。[#64582](https://github.com/ClickHouse/ClickHouse/pull/64582) ([Mikhail Gorshkov](https://github.com/mgorshkov))。
- 新增 SQL 函数 `parseReadableSize`(以及 `OrNull` 和 `OrZero` 变体)。[#64742](https://github.com/ClickHouse/ClickHouse/pull/64742) ([Francisco J. Jurado Moreno](https://github.com/Beetelbrox))。
- 新增服务器设置 `max_table_num_to_throw` 和 `max_database_num_to_throw`,用于限制 `CREATE` 查询中的数据库或表数量。[#64781](https://github.com/ClickHouse/ClickHouse/pull/64781) ([Xu Jia](https://github.com/XuJia0210))。
- 为类文件存储引擎(s3/file/hdfs/url/azureBlobStorage)新增 `_time` 虚拟列。[#64947](https://github.com/ClickHouse/ClickHouse/pull/64947) ([Ilya Golshtein](https://github.com/ilejn))。
- 引入新函数 `base64URLEncode`、`base64URLDecode` 和 `tryBase64URLDecode`。[#64991](https://github.com/ClickHouse/ClickHouse/pull/64991) ([Mikhail Gorshkov](https://github.com/mgorshkov))。
- 新增函数 `editDistanceUTF8`,用于计算两个 UTF8 字符串之间的[编辑距离](https://en.wikipedia.org/wiki/Edit_distance)。[#65269](https://github.com/ClickHouse/ClickHouse/pull/65269) ([LiuNeng](https://github.com/liuneng1994))。
- 新增 `http_response_headers` 配置,以支持在自定义 HTTP 处理程序中使用自定义响应头。[#63562](https://github.com/ClickHouse/ClickHouse/pull/63562) ([Grigorii](https://github.com/GSokol))。
- 新增表函数 `loop`,支持以无限循环方式返回查询结果。[#63452](https://github.com/ClickHouse/ClickHouse/pull/63452) ([Sariel](https://github.com/sarielwxm))。此功能对测试很有用。
- 在 `system.query_log` 中引入两个新列:`used_privileges` 和 `missing_privileges`。`used_privileges` 记录查询执行期间检查的权限,`missing_privileges` 包含缺失的必需权限。[#64597](https://github.com/ClickHouse/ClickHouse/pull/64597) ([Alexey Katsman](https://github.com/alexkats))。
- 新增设置 `output_format_pretty_display_footer_column_names`,启用后会在长表(默认 50 行)末尾显示列名,最小行数阈值由 `output_format_pretty_display_footer_column_names_min_rows` 控制。[#65144](https://github.com/ClickHouse/ClickHouse/pull/65144) ([Shaun Struwig](https://github.com/Blargian))。

#### 实验性功能 {#experimental-feature-5}

- 引入"唯一值数量"类型的统计信息。[#59357](https://github.com/ClickHouse/ClickHouse/pull/59357) ([Han Fei](https://github.com/hanfei1991))。
- 支持在 ReplicatedMergeTree 中使用统计信息。[#64934](https://github.com/ClickHouse/ClickHouse/pull/64934) ([Han Fei](https://github.com/hanfei1991))。
- 如果为 `Replicated` 数据库配置了"副本组",则自动创建包含所有组副本的集群。[#64312](https://github.com/ClickHouse/ClickHouse/pull/64312) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 添加 `parallel_replicas_custom_key_range_lower` 和 `parallel_replicas_custom_key_range_upper` 设置,用于控制带有动态分片的并行副本在使用范围过滤器时如何并行化查询。[#64604](https://github.com/ClickHouse/ClickHouse/pull/64604) ([josh-hildred](https://github.com/josh-hildred))。


#### 性能改进 {#performance-improvement-6}

- 新增在插入时重新排列行的功能,在不违反 `PRIMARY KEY` 设定顺序的前提下优化存储大小。该功能通过设置 `optimize_row_order` 控制(默认关闭)。[#63578](https://github.com/ClickHouse/ClickHouse/pull/63578) ([Igor Markelov](https://github.com/ElderlyPassionFruit))。
- 新增原生 Parquet 读取器,可直接将 Parquet 二进制数据读取到 ClickHouse 列中。该功能通过设置 `input_format_parquet_use_native_reader` 控制(默认禁用)。[#60361](https://github.com/ClickHouse/ClickHouse/pull/60361) ([ZhiHong Zhang](https://github.com/copperybean))。
- 当查询过滤器能够从 MergeTree 表中选择精确范围时,支持部分简单计数优化。[#60463](https://github.com/ClickHouse/ClickHouse/pull/60463) ([Amos Bird](https://github.com/amosbird))。
- 通过在单个转换中收集多个线程的数据块,降低多线程 `INSERT` 的最大内存使用量。[#61047](https://github.com/ClickHouse/ClickHouse/pull/61047) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- 通过使用固定内存分配避免额外缓冲区的分配,降低使用 Azure 对象存储时的内存使用量。[#63160](https://github.com/ClickHouse/ClickHouse/pull/63160) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
- 减少 `ColumnNullable::size` 中的虚函数调用次数。[#60556](https://github.com/ClickHouse/ClickHouse/pull/60556) ([HappenLee](https://github.com/HappenLee))。
- 当正则表达式参数为单个字符时,加速 `splitByRegexp` 函数。[#62696](https://github.com/ClickHouse/ClickHouse/pull/62696) ([Robert Schulze](https://github.com/rschu1ze))。
- 通过跟踪使用的最小和最大键值,加速 8 位和 16 位键的聚合。这可以减少需要验证的单元格数量。[#62746](https://github.com/ClickHouse/ClickHouse/pull/62746) ([Jiebin Sun](https://github.com/jiebinn))。
- 当左侧为 `LowCardinality` 且右侧为常量集合时,优化 IN 运算符。[#64060](https://github.com/ClickHouse/ClickHouse/pull/64060) ([Zhiguo Zhou](https://github.com/ZhiguoZh))。
- 使用线程池在 `ConcurrentHashJoin` 内部初始化和销毁哈希表。[#64241](https://github.com/ClickHouse/ClickHouse/pull/64241) ([Nikita Taranov](https://github.com/nickitat))。
- 优化包含稀疏列的表的垂直合并。[#64311](https://github.com/ClickHouse/ClickHouse/pull/64311) ([Anton Popov](https://github.com/CurtizJ))。
- 在垂直合并期间启用从远程文件系统预取数据。这改善了数据存储在远程文件系统上的表的垂直合并延迟。[#64314](https://github.com/ClickHouse/ClickHouse/pull/64314) ([Anton Popov](https://github.com/CurtizJ))。
- 减少对 `ColumnSparse::filter` 的 `isDefault` 的冗余调用以提高性能。[#64426](https://github.com/ClickHouse/ClickHouse/pull/64426) ([Jiebin Sun](https://github.com/jiebinn))。
- 通过发起多个异步 getChildren 请求,加速 `find_super_nodes` 和 `find_big_family` keeper-client 命令。[#64628](https://github.com/ClickHouse/ClickHouse/pull/64628) ([Alexander Gololobov](https://github.com/davenger))。
- 改进可空数值类型参数的 `least`/`greatest` 函数。[#64668](https://github.com/ClickHouse/ClickHouse/pull/64668) ([KevinyhZou](https://github.com/KevinyhZou))。
- 允许合并查询计划中两个连续的过滤步骤。如果过滤条件可以从父步骤下推,这将改进过滤器下推优化。[#64760](https://github.com/ClickHouse/ClickHouse/pull/64760) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 移除垂直 final 实现中的不良优化,并默认重新启用垂直 final 算法。[#64783](https://github.com/ClickHouse/ClickHouse/pull/64783) ([Duc Canh Le](https://github.com/canhld94))。
- 从过滤表达式中移除 ALIAS 节点。这略微提高了使用 `PREWHERE` 的查询性能(使用新分析器时)。[#64793](https://github.com/ClickHouse/ClickHouse/pull/64793) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 重新启用 OpenSSL 会话缓存。[#65111](https://github.com/ClickHouse/ClickHouse/pull/65111) ([Robert Schulze](https://github.com/rschu1ze))。
- 新增设置以禁用插入时跳数索引和统计信息的物化(`materialize_skip_indexes_on_insert` 和 `materialize_statistics_on_insert`)。[#64391](https://github.com/ClickHouse/ClickHouse/pull/64391) ([Anton Popov](https://github.com/CurtizJ))。
- 使用已分配的内存大小来计算行组大小,并降低单线程模式下 Parquet 写入器的峰值内存。[#64424](https://github.com/ClickHouse/ClickHouse/pull/64424) ([LiuNeng](https://github.com/liuneng1994))。
- 改进稀疏列的迭代器以减少对 `size` 的调用。[#64497](https://github.com/ClickHouse/ClickHouse/pull/64497) ([Jiebin Sun](https://github.com/jiebinn))。
- 更新条件以对 Azure Blob 存储的备份使用服务器端复制。[#64518](https://github.com/ClickHouse/ClickHouse/pull/64518) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
- 优化包含大量跳数索引的表的垂直合并的内存使用。[#64580](https://github.com/ClickHouse/ClickHouse/pull/64580) ([Anton Popov](https://github.com/CurtizJ))。





#### 改进 {#improvement-6}

- 在系统表上执行 `SHOW CREATE TABLE` 现在将显示每个表独有的实用注释,说明该表的用途。[#63788](https://github.com/ClickHouse/ClickHouse/pull/63788) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 函数 `round()`、`roundBankers()`、`floor()`、`ceil()` 和 `trunc()` 的第二个参数(精度)现在可以是非常量值。[#64798](https://github.com/ClickHouse/ClickHouse/pull/64798) ([Mikhail Gorshkov](https://github.com/mgorshkov))。
- 为 `Distributed` 表添加新磁盘时支持热重载存储策略。[#58285](https://github.com/ClickHouse/ClickHouse/pull/58285) ([Duc Canh Le](https://github.com/canhld94))。
- 避免在服务饱和时调度线程期间 MergeTree 索引分析可能出现的死锁。[#59427](https://github.com/ClickHouse/ClickHouse/pull/59427) ([Sean Haynes](https://github.com/seandhaynes))。
- 对 S3 代理支持和隧道功能的几个边界情况进行了修复。[#63427](https://github.com/ClickHouse/ClickHouse/pull/63427) ([Arthur Passos](https://github.com/arthurpassos))。
- 改进 io_uring 重新提交的可见性。将性能事件 `IOUringSQEsResubmits` 重命名为 `IOUringSQEsResubmitsAsync`,并新增 `IOUringSQEsResubmitsSync`。[#63699](https://github.com/ClickHouse/ClickHouse/pull/63699) ([Tomer Shafir](https://github.com/tomershafir))。
- 新增设置 `metadata_keep_free_space_bytes`,用于在元数据存储磁盘上保留可用空间。[#64128](https://github.com/ClickHouse/ClickHouse/pull/64128) ([MikhailBurdukov](https://github.com/MikhailBurdukov))。
- 新增指标以跟踪 `plain_rewritable` 元数据存储创建和删除的目录数量,以及本地到远程内存映射中的条目数量。[#64175](https://github.com/ClickHouse/ClickHouse/pull/64175) ([Julia Kartseva](https://github.com/jkartseva))。
- 查询缓存现在将具有不同设置的相同查询视为不同查询。这提高了在不同设置(例如 `limit` 或 `additional_table_filters`)会影响查询结果时的健壮性。[#64205](https://github.com/ClickHouse/ClickHouse/pull/64205) ([Robert Schulze](https://github.com/rschu1ze))。
- 支持对象存储中的非标准错误代码 `QpsLimitExceeded` 作为可重试错误。[#64225](https://github.com/ClickHouse/ClickHouse/pull/64225) ([Sema Checherinda](https://github.com/CheSema))。
- 如果该表的 ZooKeeper 路径已存在,则禁止将 MergeTree 表转换为复制表。[#64244](https://github.com/ClickHouse/ClickHouse/pull/64244) ([Kirill](https://github.com/kirillgarbar))。
- 新增设置 `input_format_parquet_prefer_block_bytes` 以控制平均输出块字节数,并将 `input_format_parquet_max_block_size` 的默认值修改为 65409。[#64427](https://github.com/ClickHouse/ClickHouse/pull/64427) ([LiuNeng](https://github.com/liuneng1994))。
- 允许对 `no_proxy` 环境变量和 ClickHouse 代理配置中指定的主机绕过代理。[#63314](https://github.com/ClickHouse/ClickHouse/pull/63314) ([Arthur Passos](https://github.com/arthurpassos))。
- 始终使用全局线程池中足够数量的线程启动 Keeper。[#64444](https://github.com/ClickHouse/ClickHouse/pull/64444) ([Duc Canh Le](https://github.com/canhld94))。
- 用户配置中的设置不会影响对象存储之上 `MergeTree` 的合并和变更操作。[#64456](https://github.com/ClickHouse/ClickHouse/pull/64456) ([alesapin](https://github.com/alesapin))。
- 支持对象存储中的非标准错误代码 `TotalQpsLimitExceeded` 作为可重试错误。[#64520](https://github.com/ClickHouse/ClickHouse/pull/64520) ([Sema Checherinda](https://github.com/CheSema))。
- 更新了开源版本和 ClickHouse Cloud 版本的高级仪表板,新增"最大并发网络连接数"图表。[#64610](https://github.com/ClickHouse/ClickHouse/pull/64610) ([Thom O'Connor](https://github.com/thomoco))。
- 改进 `zeros_mt` 和 `generateRandom` 的进度报告。[#64804](https://github.com/ClickHouse/ClickHouse/pull/64804) ([Raúl Marín](https://github.com/Algunenano))。
- 新增异步指标 `jemalloc.profile.active` 以显示采样当前是否处于活动状态。这是除 prof.active 之外的激活机制;两者都必须处于活动状态才能对调用线程进行采样。[#64842](https://github.com/ClickHouse/ClickHouse/pull/64842) ([Unalian](https://github.com/Unalian))。
- 移除 `allow_experimental_join_condition` 的重要标记。此标记可能阻止了混合版本集群中的分布式查询成功执行。[#65008](https://github.com/ClickHouse/ClickHouse/pull/65008) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 新增服务器异步指标 `DiskGetObjectThrottler*` 和 `DiskPutObjectThrottler*`,反映通过 `s3_max_get_rps` 和 `s3_max_put_rps` 磁盘设置定义的每秒请求速率限制,以及当前可以发送而不会触及磁盘限流限制的请求数量。为每个配置了限制的磁盘定义了这些指标。[#65050](https://github.com/ClickHouse/ClickHouse/pull/65050) ([Sergei Trifonov](https://github.com/serxa))。
- 为 `Poco::ThreadPool` 初始化全局跟踪收集器(Keeper 等需要)。[#65239](https://github.com/ClickHouse/ClickHouse/pull/65239) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 在使用 `bcrypt_hash` 创建用户时新增验证。[#65242](https://github.com/ClickHouse/ClickHouse/pull/65242) ([Raúl Marín](https://github.com/Algunenano))。
- 为 `PREWHERE` 期间/之后读取的行数新增性能事件。[#64198](https://github.com/ClickHouse/ClickHouse/pull/64198) ([Nikita Taranov](https://github.com/nickitat))。
- 在使用并行副本的 `EXPLAIN PLAN` 中打印查询。[#64298](https://github.com/ClickHouse/ClickHouse/pull/64298) ([vdimir](https://github.com/vdimir))。
- 将 `allow_deprecated_functions` 重命名为 `allow_deprecated_error_prone_window_functions`。[#64358](https://github.com/ClickHouse/ClickHouse/pull/64358) ([Raúl Marín](https://github.com/Algunenano))。
- 在 `file` 表函数中也遵守文件描述符的 `max_read_buffer_size` 设置。[#64532](https://github.com/ClickHouse/ClickHouse/pull/64532) ([Azat Khuzhin](https://github.com/azat))。
- 即使对于物化视图,也禁用不支持的存储引擎的事务功能。[#64918](https://github.com/ClickHouse/ClickHouse/pull/64918) ([alesapin](https://github.com/alesapin))。
- 在旧分析器中禁止使用 `QUALIFY` 子句。旧分析器会忽略 `QUALIFY`,因此可能导致变更操作中意外删除数据。[#65356](https://github.com/ClickHouse/ClickHouse/pull/65356) ([Dmitry Novik](https://github.com/novikd))。





#### 错误修复(官方稳定版本中用户可见的异常行为) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-5}

- A bug in Apache ORC library was fixed: Fixed ORC statistics calculation, when writing, for unsigned types on all platforms and Int8 on ARM. [#64563](https://github.com/ClickHouse/ClickHouse/pull/64563) ([Michael Kolupaev](https://github.com/al13n321)).
- Returned back the behaviour of how ClickHouse works and interprets Tuples in CSV format. This change effectively reverts https://github.com/ClickHouse/ClickHouse/pull/60994 and makes it available only under a few settings: `output_format_csv_serialize_tuple_into_separate_columns`, `input_format_csv_deserialize_separate_columns_into_tuple` and `input_format_csv_try_infer_strings_from_quoted_tuples`. [#65170](https://github.com/ClickHouse/ClickHouse/pull/65170) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Fix a permission error where a user in a specific situation can escalate their privileges on the default database without necessary grants. [#64769](https://github.com/ClickHouse/ClickHouse/pull/64769) ([pufit](https://github.com/pufit)).
- Fix crash with UniqInjectiveFunctionsEliminationPass and uniqCombined. [#65188](https://github.com/ClickHouse/ClickHouse/pull/65188) ([Raúl Marín](https://github.com/Algunenano)).
- Fix a bug in ClickHouse Keeper that causes digest mismatch during closing session. [#65198](https://github.com/ClickHouse/ClickHouse/pull/65198) ([Aleksei Filatov](https://github.com/aalexfvk)).
- Use correct memory alignment for Distinct combinator. Previously, crash could happen because of invalid memory allocation when the combinator was used. [#65379](https://github.com/ClickHouse/ClickHouse/pull/65379) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix crash with `DISTINCT` and window functions. [#64767](https://github.com/ClickHouse/ClickHouse/pull/64767) ([Igor Nikonov](https://github.com/devcrafter)).
- Fixed 'set' skip index not working with IN and indexHint(). [#62083](https://github.com/ClickHouse/ClickHouse/pull/62083) ([Michael Kolupaev](https://github.com/al13n321)).
- Support executing function during assignment of parameterized view value. [#63502](https://github.com/ClickHouse/ClickHouse/pull/63502) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Fixed parquet memory tracking. [#63584](https://github.com/ClickHouse/ClickHouse/pull/63584) ([Michael Kolupaev](https://github.com/al13n321)).
- Fixed reading of columns of type `Tuple(Map(LowCardinality(String), String), ...)`. [#63956](https://github.com/ClickHouse/ClickHouse/pull/63956) ([Anton Popov](https://github.com/CurtizJ)).
- Fix an `Cyclic aliases` error for cyclic aliases of different type (expression and function). [#63993](https://github.com/ClickHouse/ClickHouse/pull/63993) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- This fix will use a proper redefined context with the correct definer for each individual view in the query pipeline. [#64079](https://github.com/ClickHouse/ClickHouse/pull/64079) ([pufit](https://github.com/pufit)).
- Fix analyzer: "Not found column" error is fixed when using INTERPOLATE. [#64096](https://github.com/ClickHouse/ClickHouse/pull/64096) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix creating backups to S3 buckets with different credentials from the disk containing the file. [#64153](https://github.com/ClickHouse/ClickHouse/pull/64153) ([Antonio Andelic](https://github.com/antonio2368)).
- The query cache now considers two identical queries against different databases as different. The previous behavior could be used to bypass missing privileges to read from a table. [#64199](https://github.com/ClickHouse/ClickHouse/pull/64199) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix possible abort on uncaught exception in ~WriteBufferFromFileDescriptor in StatusFile. [#64206](https://github.com/ClickHouse/ClickHouse/pull/64206) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix `duplicate alias` error for distributed queries with `ARRAY JOIN`. [#64226](https://github.com/ClickHouse/ClickHouse/pull/64226) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix unexpected accurateCast from string to integer. [#64255](https://github.com/ClickHouse/ClickHouse/pull/64255) ([wudidapaopao](https://github.com/wudidapaopao)).
- Fixed CNF simplification, in case any OR group contains mutually exclusive atoms. [#64256](https://github.com/ClickHouse/ClickHouse/pull/64256) ([Eduard Karacharov](https://github.com/korowa)).
- Fix Query Tree size validation. [#64377](https://github.com/ClickHouse/ClickHouse/pull/64377) ([Dmitry Novik](https://github.com/novikd)).
- Fix `Logical error: Bad cast` for `Buffer` table with `PREWHERE`. [#64388](https://github.com/ClickHouse/ClickHouse/pull/64388) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Prevent recursive logging in `blob_storage_log` when it's stored on object storage. [#64393](https://github.com/ClickHouse/ClickHouse/pull/64393) ([vdimir](https://github.com/vdimir)).
- Fixed `CREATE TABLE AS` queries for tables with default expressions. [#64455](https://github.com/ClickHouse/ClickHouse/pull/64455) ([Anton Popov](https://github.com/CurtizJ)).
- Fixed `optimize_read_in_order` behaviour for ORDER BY ... NULLS FIRST / LAST on tables with nullable keys. [#64483](https://github.com/ClickHouse/ClickHouse/pull/64483) ([Eduard Karacharov](https://github.com/korowa)).
- Fix the `Expression nodes list expected 1 projection names` and `Unknown expression or identifier` errors for queries with aliases to `GLOBAL IN.`. [#64517](https://github.com/ClickHouse/ClickHouse/pull/64517) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix an error `Cannot find column` in distributed queries with constant CTE in the `GROUP BY` key. [#64519](https://github.com/ClickHouse/ClickHouse/pull/64519) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix the crash loop when restoring from backup is blocked by creating an MV with a definer that hasn't been restored yet. [#64595](https://github.com/ClickHouse/ClickHouse/pull/64595) ([pufit](https://github.com/pufit)).
- Fix the output of function `formatDateTimeInJodaSyntax` when a formatter generates an uneven number of characters and the last character is `0`. For example, `SELECT formatDateTimeInJodaSyntax(toDate('2012-05-29'), 'D')` now correctly returns `150` instead of previously `15`. [#64614](https://github.com/ClickHouse/ClickHouse/pull/64614) ([LiuNeng](https://github.com/liuneng1994)).
- Do not rewrite aggregation if `-If` combinator is already used. [#64638](https://github.com/ClickHouse/ClickHouse/pull/64638) ([Dmitry Novik](https://github.com/novikd)).
- Fix type inference for float (in case of small buffer, i.e. `--max_read_buffer_size 1`). [#64641](https://github.com/ClickHouse/ClickHouse/pull/64641) ([Azat Khuzhin](https://github.com/azat)).
- Fix bug which could lead to non-working TTLs with expressions. [#64694](https://github.com/ClickHouse/ClickHouse/pull/64694) ([alesapin](https://github.com/alesapin)).
- Fix removing the `WHERE` and `PREWHERE` expressions, which are always true (for the new analyzer). [#64695](https://github.com/ClickHouse/ClickHouse/pull/64695) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fixed excessive part elimination by token-based text indexes (`ngrambf` , `full_text`) when filtering by result of `startsWith`, `endsWith`, `match`, `multiSearchAny`. [#64720](https://github.com/ClickHouse/ClickHouse/pull/64720) ([Eduard Karacharov](https://github.com/korowa)).
- Fixes incorrect behaviour of ANSI CSI escaping in the `UTF8::computeWidth` function. [#64756](https://github.com/ClickHouse/ClickHouse/pull/64756) ([Shaun Struwig](https://github.com/Blargian)).
- Fix a case of incorrect removal of `ORDER BY` / `LIMIT BY` across subqueries. [#64766](https://github.com/ClickHouse/ClickHouse/pull/64766) ([Raúl Marín](https://github.com/Algunenano)).
- Fix (experimental) unequal join with subqueries for sets which are in the mixed join conditions. [#64775](https://github.com/ClickHouse/ClickHouse/pull/64775) ([lgbo](https://github.com/lgbo-ustc)).
- Fix crash in a local cache over `plain_rewritable` disk. [#64778](https://github.com/ClickHouse/ClickHouse/pull/64778) ([Julia Kartseva](https://github.com/jkartseva)).
- Keeper fix: return correct value for `zk_latest_snapshot_size` in `mntr` command. [#64784](https://github.com/ClickHouse/ClickHouse/pull/64784) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix `Cannot find column` in distributed query with `ARRAY JOIN` by `Nested` column. Fixes [#64755](https://github.com/ClickHouse/ClickHouse/issues/64755). [#64801](https://github.com/ClickHouse/ClickHouse/pull/64801) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix memory leak in slru cache policy. [#64803](https://github.com/ClickHouse/ClickHouse/pull/64803) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fixed possible incorrect memory tracking in several kinds of queries: queries that read any data from S3, queries via http protocol, asynchronous inserts. [#64844](https://github.com/ClickHouse/ClickHouse/pull/64844) ([Anton Popov](https://github.com/CurtizJ)).
- Fix the `Block structure mismatch` error for queries reading with `PREWHERE` from the materialized view when the materialized view has columns of different types than the source table. Fixes [#64611](https://github.com/ClickHouse/ClickHouse/issues/64611). [#64855](https://github.com/ClickHouse/ClickHouse/pull/64855) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix rare crash when table has TTL with subquery + database replicated + parallel replicas + analyzer. It's really rare, but please don't use TTLs with subqueries. [#64858](https://github.com/ClickHouse/ClickHouse/pull/64858) ([alesapin](https://github.com/alesapin)).
- Fix duplicating `Delete` events in `blob_storage_log` in case of large batch to delete. [#64924](https://github.com/ClickHouse/ClickHouse/pull/64924) ([vdimir](https://github.com/vdimir)).
- Fixed `Session moved to another server` error from [Zoo]Keeper that might happen after server startup when the config has includes from [Zoo]Keeper. [#64986](https://github.com/ClickHouse/ClickHouse/pull/64986) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix `ALTER MODIFY COMMENT` query that was broken for parameterized VIEWs in https://github.com/ClickHouse/ClickHouse/pull/54211. [#65031](https://github.com/ClickHouse/ClickHouse/pull/65031) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix `host_id` in DatabaseReplicated when `cluster_secure_connection` parameter is enabled. Previously all the connections within the cluster created by DatabaseReplicated were not secure, even if the parameter was enabled. [#65054](https://github.com/ClickHouse/ClickHouse/pull/65054) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fixing the `Not-ready Set` error after the `PREWHERE` optimization for StorageMerge. [#65057](https://github.com/ClickHouse/ClickHouse/pull/65057) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Avoid writing to finalized buffer in File-like storages. [#65063](https://github.com/ClickHouse/ClickHouse/pull/65063) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix possible infinite query duration in case of cyclic aliases. Fixes [#64849](https://github.com/ClickHouse/ClickHouse/issues/64849). [#65081](https://github.com/ClickHouse/ClickHouse/pull/65081) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix the `Unknown expression identifier` error for remote queries with `INTERPOLATE (alias)` (new analyzer). Fixes [#64636](https://github.com/ClickHouse/ClickHouse/issues/64636). [#65090](https://github.com/ClickHouse/ClickHouse/pull/65090) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix pushing arithmetic operations out of aggregation. In the new analyzer, optimization was applied only once. [#65104](https://github.com/ClickHouse/ClickHouse/pull/65104) ([Dmitry Novik](https://github.com/novikd)).
- Fix aggregate function name rewriting in the new analyzer. [#65110](https://github.com/ClickHouse/ClickHouse/pull/65110) ([Dmitry Novik](https://github.com/novikd)).
- Respond with 5xx instead of 200 OK in case of receive timeout while reading (parts of) the request body from the client socket. [#65118](https://github.com/ClickHouse/ClickHouse/pull/65118) ([Julian Maicher](https://github.com/jmaicher)).
- Fix possible crash for hedged requests. [#65206](https://github.com/ClickHouse/ClickHouse/pull/65206) ([Azat Khuzhin](https://github.com/azat)).
- Fix the bug in Hashed and Hashed_Array dictionary short circuit evaluation, which may read uninitialized number, leading to various errors. [#65256](https://github.com/ClickHouse/ClickHouse/pull/65256) ([jsc0218](https://github.com/jsc0218)).
- This PR ensures that the type of the constant(IN operator's second parameter) is always visible during the IN operator's type conversion process. Otherwise, losing type information may cause some conversions to fail, such as the conversion from DateTime to Date. This fixes ([#64487](https://github.com/ClickHouse/ClickHouse/issues/64487)). [#65315](https://github.com/ClickHouse/ClickHouse/pull/65315) ([pn](https://github.com/chloro-pn)).

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-2}

- 添加对 LLVM XRay 的支持。[#64592](https://github.com/ClickHouse/ClickHouse/pull/64592) [#64837](https://github.com/ClickHouse/ClickHouse/pull/64837) ([Tomer Shafir](https://github.com/tomershafir))。
- 将 s3/hdfs/azure 存储实现统一为使用 IObjectStorage 的单个类。\*Cluster、数据湖和队列存储同样如此。[#59767](https://github.com/ClickHouse/ClickHouse/pull/59767) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 重构数据部分写入器,移除对 MergeTreeData 和 DataPart 的依赖。[#63620](https://github.com/ClickHouse/ClickHouse/pull/63620) ([Alexander Gololobov](https://github.com/davenger))。
- 重构 `KeyCondition` 和键分析,以改进 PartitionPruner 和简单计数优化。这是从 [#60463](https://github.com/ClickHouse/ClickHouse/issues/60463) 中分离出来的。[#61459](https://github.com/ClickHouse/ClickHouse/pull/61459) ([Amos Bird](https://github.com/amosbird))。
- 引入断言,验证所有函数调用时使用的列大小正确。[#63723](https://github.com/ClickHouse/ClickHouse/pull/63723) ([Raúl Marín](https://github.com/Algunenano))。
- 使用 `rc` 初始化脚本启动 ClickHouse 服务器守护进程时,要求 `network` 服务必须可用。[#60650](https://github.com/ClickHouse/ClickHouse/pull/60650) ([Chun-Sheng, Li](https://github.com/peter279k))。
- 减小部分慢速测试的规模。[#64387](https://github.com/ClickHouse/ClickHouse/pull/64387) [#64452](https://github.com/ClickHouse/ClickHouse/pull/64452) ([Raúl Marín](https://github.com/Algunenano))。
- 使用 keeper-bench 重放 ZooKeeper 日志。[#62481](https://github.com/ClickHouse/ClickHouse/pull/62481) ([Antonio Andelic](https://github.com/antonio2368))。

### <a id="245"></a> ClickHouse 24.5 版本,2024-05-30 {#a-id245a-clickhouse-release-245-2024-05-30}

#### 向后不兼容的变更 {#backward-incompatible-change-7}

- 将"倒排索引"重命名为"全文索引",这是一个技术性较低、更加用户友好的名称。此更改也会修改内部表元数据,并导致具有现有(实验性)倒排索引的表无法使用。请确保在升级前删除此类索引,并在升级后重新创建。[#62884](https://github.com/ClickHouse/ClickHouse/pull/62884) ([Robert Schulze](https://github.com/rschu1ze))。
- 函数 `neighbor`、`runningAccumulate`、`runningDifferenceStartingWithFirstValue`、`runningDifference` 的使用已被弃用(因为容易出错)。应改用适当的窗口函数。要重新启用这些函数,请设置 `allow_deprecated_error_prone_window_functions = 1` 或将 `compatibility` 设置为 `'24.4'` 或更低版本。[#63132](https://github.com/ClickHouse/ClickHouse/pull/63132) ([Nikita Taranov](https://github.com/nickitat))。
- 当存在大量列,但许多数据库或表未被授予 `SHOW TABLES` 权限时,来自 `system.columns` 的查询将运行得更快。请注意,在以前的版本中,如果您对单个列授予 `SHOW COLUMNS` 权限而未对相应的表授予 `SHOW TABLES` 权限,`system.columns` 表将显示这些列,但在新版本中,它将完全跳过该表。移除了会降低查询速度的跟踪日志消息"Access granted"和"Access denied"。[#63439](https://github.com/ClickHouse/ClickHouse/pull/63439) ([Alexey Milovidov](https://github.com/alexey-milovidov))。


#### 新功能 {#new-feature-7}

- 新增 `Form` 格式,用于以 `application/x-www-form-urlencoded` 格式读写单条记录。[#60199](https://github.com/ClickHouse/ClickHouse/pull/60199) ([Shaun Struwig](https://github.com/Blargian))。
- 新增在 CROSS JOIN 中进行压缩的功能。[#60459](https://github.com/ClickHouse/ClickHouse/pull/60459) ([p1rattttt](https://github.com/p1rattttt))。
- 新增当数据大小超过限制时在临时文件中执行 `CROSS JOIN` 的功能。[#63432](https://github.com/ClickHouse/ClickHouse/pull/63432) ([p1rattttt](https://github.com/p1rattttt))。
- 支持涉及左右表列的不等条件连接,例如 `t1.y < t2.y`。要启用此功能,请设置 `SET allow_experimental_join_condition = 1`。[#60920](https://github.com/ClickHouse/ClickHouse/pull/60920) ([lgbo](https://github.com/lgbo-ustc))。
- Map 类型现在可以使用 `Float32`、`Float64`、`Array(T)`、`Map(K, V)` 和 `Tuple(T1, T2, ...)` 作为键。关闭 [#54537](https://github.com/ClickHouse/ClickHouse/issues/54537)。[#59318](https://github.com/ClickHouse/ClickHouse/pull/59318) ([李扬](https://github.com/taiyang-li))。
- 为 `EmbeddedRocksDB` 引入批量加载功能,通过创建和导入 SST 文件而非依赖 RocksDB 内置的 memtable。这有助于提高导入速度,特别是对于 StorageEmbeddedRocksDB 表的长时间运行插入查询。同时引入了 `EmbeddedRocksDB` 表设置。[#59163](https://github.com/ClickHouse/ClickHouse/pull/59163) [#63324](https://github.com/ClickHouse/ClickHouse/pull/63324) ([Duc Canh Le](https://github.com/canhld94))。
- 用户现在可以使用 `input_format_tsv_crlf_end_of_line` 设置在 TSV 格式中解析 CRLF。关闭 [#56257](https://github.com/ClickHouse/ClickHouse/issues/56257)。[#59747](https://github.com/ClickHouse/ClickHouse/pull/59747) ([Shaun Struwig](https://github.com/Blargian))。
- 新增设置 `input_format_force_null_for_omitted_fields`,用于强制将省略的字段设为 NULL 值。[#60887](https://github.com/ClickHouse/ClickHouse/pull/60887) ([Constantine Peresypkin](https://github.com/pkit))。
- 之前 S3 存储和 s3 表函数不支持从归档容器文件(如 tarball、zip、7z)中进行查询。现在它们支持遍历 S3 中归档文件内的文件。[#62259](https://github.com/ClickHouse/ClickHouse/pull/62259) ([Daniil Ivanik](https://github.com/divanik))。
- 支持条件函数 `clamp`。[#62377](https://github.com/ClickHouse/ClickHouse/pull/62377) ([skyoct](https://github.com/skyoct))。
- 新增 `NPy` 输出格式。[#62430](https://github.com/ClickHouse/ClickHouse/pull/62430) ([豪肥肥](https://github.com/HowePa))。
- `Raw` 格式作为 `TSVRaw` 的同义词。[#63394](https://github.com/ClickHouse/ClickHouse/pull/63394) ([Unalian](https://github.com/Unalian))。
- 新增 SQL 函数 `generateUUIDv7`,用于生成版本 7 UUID,即带有随机组件的基于时间戳的 UUID。同时新增函数 `UUIDToNum` 用于从 UUID 中提取字节,以及函数 `UUIDv7ToDateTime` 用于从版本 7 UUID 中提取时间戳组件。[#62852](https://github.com/ClickHouse/ClickHouse/pull/62852) ([Alexey Petrunyaka](https://github.com/pet74alex))。
- 在 Linux 和 MacOS 上,如果程序的标准输出重定向到带有压缩扩展名的文件,则使用相应的压缩方法(使其行为类似于 `INTO OUTFILE`)。[#63662](https://github.com/ClickHouse/ClickHouse/pull/63662) ([v01dXYZ](https://github.com/v01dXYZ))。
- 修改了关于大量附加对象的警告信息,以区分表、视图和字典。[#64180](https://github.com/ClickHouse/ClickHouse/pull/64180) ([Francisco J. Jurado Moreno](https://github.com/Beetelbrox))。
- 为 ClickHouse 服务器中的 `azureBlobStorage` 函数提供支持,使用 Azure Workload Identity 对 Azure Blob 存储进行身份验证。如果在配置中设置了 `use_workload_identity` 参数,则使用 [workload identity](https://github.com/Azure/azure-sdk-for-cpp/tree/main/sdk/identity/azure-identity#authenticate-azure-hosted-applications) 进行身份验证。[#57881](https://github.com/ClickHouse/ClickHouse/pull/57881) ([Vinay Suryadevara](https://github.com/vinay92-ch))。
- 在 `system.parts_columns` 表中新增 TTL 信息。[#63200](https://github.com/ClickHouse/ClickHouse/pull/63200) ([litlig](https://github.com/litlig))。

#### 实验性功能 {#experimental-features-1}

- 实现了 `Dynamic` 数据类型,允许存储任意类型的值,无需事先知道所有类型。`Dynamic` 类型可通过设置 `allow_experimental_dynamic_type` 启用。参考:[#54864](https://github.com/ClickHouse/ClickHouse/issues/54864)。[#63058](https://github.com/ClickHouse/ClickHouse/pull/63058) ([Kruglov Pavel](https://github.com/Avogar))。
- 允许在不连接 MySQL 的情况下创建 `MaterializedMySQL` 数据库。[#63397](https://github.com/ClickHouse/ClickHouse/pull/63397) ([Kirill](https://github.com/kirillgarbar))。
- 如果某个 DDL 任务连续失败超过 `max_retries_before_automatic_recovery` 次(默认为 100 次)且错误相同,则自动将 Replicated 数据库的副本标记为丢失并启动恢复。此外,修复了一个可能导致在条目执行早期阶段抛出异常时跳过 DDL 条目的错误。[#63549](https://github.com/ClickHouse/ClickHouse/pull/63549) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 在 `StorageS3Queue` 的 `s3queue_tracked_file_ttl_sec` 和 `s3queue_traked_files_limit` 中统计失败文件。[#63638](https://github.com/ClickHouse/ClickHouse/pull/63638) ([Kseniia Sumarokova](https://github.com/kssenii))。


#### 性能改进 {#performance-improvement-7}

- 减少文件系统缓存中的竞争(第4部分)。通过在后台执行额外的驱逐操作(由 `keep_free_space_size(elements)_ratio` 控制),允许文件系统缓存保持未满状态。这可以减轻查询空间预留的压力(在 `tryReserve` 方法上)。此外,该操作尽可能以无锁方式完成,不会阻塞正常的缓存使用。[#61250](https://github.com/ClickHouse/ClickHouse/pull/61250) ([Kseniia Sumarokova](https://github.com/kssenii)).
- 在 `INSERT` 操作期间跳过新创建的投影块的合并。[#59405](https://github.com/ClickHouse/ClickHouse/pull/59405) ([Nikita Taranov](https://github.com/nickitat)).
- 如果输入字符串全部为 ASCII 字符,则以 ASCII 方式处理 `...UTF8` 字符串函数。灵感来自 https://github.com/apache/doris/pull/29799。总体速度提升 1.07 倍至 1.62 倍。请注意,在某些情况下峰值内存使用量有所降低。[#61632](https://github.com/ClickHouse/ClickHouse/pull/61632) ([李扬](https://github.com/taiyang-li)).
- 改进了 StorageS3 中选择(`{}`)通配符的性能。[#62120](https://github.com/ClickHouse/ClickHouse/pull/62120) ([Andrey Zvonov](https://github.com/zvonand)).
- HostResolver 会多次记录每个 IP 地址。如果远程主机有多个 IP,并且由于某些原因(例如防火墙规则)允许访问某些 IP 而禁止访问其他 IP,则只有第一条被禁止的 IP 记录会被标记为失败,在每次尝试中这些 IP 仍有机会被选中(并再次失败)。即使修复此问题,每 120 秒 DNS 缓存也会被清除,这些 IP 可能再次被选中。[#62652](https://github.com/ClickHouse/ClickHouse/pull/62652) ([Anton Ivashkin](https://github.com/ianton-ru)).
- 添加新配置项 `prefer_merge_sort_block_bytes` 以控制内存使用,并在列数较多时将合并排序速度提高 2 倍。[#62904](https://github.com/ClickHouse/ClickHouse/pull/62904) ([LiuNeng](https://github.com/liuneng1994)).
- `clickhouse-local` 启动速度更快。在以前的版本中,它错误地未删除临时目录。现在会正确删除。这解决了 [#62941](https://github.com/ClickHouse/ClickHouse/issues/62941)。[#63074](https://github.com/ClickHouse/ClickHouse/pull/63074) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- 对新分析器进行微优化。[#63429](https://github.com/ClickHouse/ClickHouse/pull/63429) ([Raúl Marín](https://github.com/Algunenano)).
- 当 `DateTime` 与 `DateTime64` 进行比较时,索引分析将正常工作。这解决了 [#63441](https://github.com/ClickHouse/ClickHouse/issues/63441)。[#63443](https://github.com/ClickHouse/ClickHouse/pull/63443) [#63532](https://github.com/ClickHouse/ClickHouse/pull/63532) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- 通过清理冗余数据,将 `set` 类型索引的速度略微提升(约 1.5 倍)。[#64098](https://github.com/ClickHouse/ClickHouse/pull/64098) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- 移除写入文件系统缓存时的数据复制操作。[#63401](https://github.com/ClickHouse/ClickHouse/pull/63401) ([Kseniia Sumarokova](https://github.com/kssenii)).
- 现在使用 Azure Blob 存储的备份将使用多副本复制。[#64116](https://github.com/ClickHouse/ClickHouse/pull/64116) ([alesapin](https://github.com/alesapin)).
- 允许在不同容器之间对 Azure 使用原生复制。[#64154](https://github.com/ClickHouse/ClickHouse/pull/64154) ([alesapin](https://github.com/alesapin)).
- 最终为 Azure 启用原生复制。[#64182](https://github.com/ClickHouse/ClickHouse/pull/64182) ([alesapin](https://github.com/alesapin)).


#### 改进 {#improvement-7}

- 允许将 `clickhouse-local` 及其快捷方式 `clickhouse` 和 `ch` 与查询或查询文件作为位置参数一起使用。示例:`ch "SELECT 1"`、`ch --param_test Hello "SELECT {test:String}"`、`ch query.sql`。此更改关闭了 [#62361](https://github.com/ClickHouse/ClickHouse/issues/62361)。[#63081](https://github.com/ClickHouse/ClickHouse/pull/63081) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 为本地和 Azure (azure_blob_storage) 对象存储启用 plain_rewritable 元数据。[#63365](https://github.com/ClickHouse/ClickHouse/pull/63365) ([Julia Kartseva](https://github.com/jkartseva))。
- 支持英文风格的 Unicode 引号,例如 "Hello"、'world'。虽然这在一般情况下存在争议,但在文字处理器(如 Google Docs)中输入查询时很有帮助。此更改关闭了 [#58634](https://github.com/ClickHouse/ClickHouse/issues/58634)。[#63381](https://github.com/ClickHouse/ClickHouse/pull/63381) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 允许在 INSERT 查询的列列表中使用尾随逗号。例如,`INSERT INTO test (a, b, c, ) VALUES ...`。[#63803](https://github.com/ClickHouse/ClickHouse/pull/63803) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 改进了 `Regexp` 格式的异常消息。[#63804](https://github.com/ClickHouse/ClickHouse/pull/63804) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 允许在 `Values` 格式中使用尾随逗号。例如,允许以下查询:`INSERT INTO test (a, b, c) VALUES (4, 5, 6,);`。[#63810](https://github.com/ClickHouse/ClickHouse/pull/63810) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 使 rabbitmq 对损坏的消息执行 nack 操作。关闭了 [#45350](https://github.com/ClickHouse/ClickHouse/issues/45350)。[#60312](https://github.com/ClickHouse/ClickHouse/pull/60312) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 修复了在解释调试信息时异步栈展开(例如使用采样查询分析器时)中的崩溃问题。此更改关闭了 [#60460](https://github.com/ClickHouse/ClickHouse/issues/60460)。[#60468](https://github.com/ClickHouse/ClickHouse/pull/60468) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 针对磁盘和存储场景的 s3 错误 'no key' 提供不同的错误消息。[#61108](https://github.com/ClickHouse/ClickHouse/pull/61108) ([Sema Checherinda](https://github.com/CheSema))。
- 进度条现在可用于带有 LIMIT 的简单查询,包括来自 `system.zeros`、`system.zeros_mt`(已支持 `system.numbers` 和 `system.numbers_mt`)以及 `generateRandom` 表函数的查询。此外,如果记录总数超过 `max_rows_to_read` 限制,将更早地抛出异常。此更改关闭了 [#58183](https://github.com/ClickHouse/ClickHouse/issues/58183)。[#61823](https://github.com/ClickHouse/ClickHouse/pull/61823) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 支持 YAML 配置中的 "Merge Key"(这是 YAML 的一个特殊功能,请不必在意)。[#62685](https://github.com/ClickHouse/ClickHouse/pull/62685) ([Azat Khuzhin](https://github.com/azat))。
- 增强了在 Replicated 源中使用非确定性函数时的错误消息。[#62896](https://github.com/ClickHouse/ClickHouse/pull/62896) ([Grégoire Pineau](https://github.com/lyrixx))。
- 修复了来自 `remote` 的 Distributed over Distributed 的服务器间密钥问题。[#63013](https://github.com/ClickHouse/ClickHouse/pull/63013) ([Azat Khuzhin](https://github.com/azat))。
- 支持 YAML 文件的 `include_from`。但是,建议使用 `config.d`。[#63106](https://github.com/ClickHouse/ClickHouse/pull/63106) ([Eduard Karacharov](https://github.com/korowa))。
- 从 skim 建议中选择后在终端中保留先前的数据。[#63261](https://github.com/ClickHouse/ClickHouse/pull/63261) ([FlameFactory](https://github.com/FlameFactory))。
- 字段宽度(在 Pretty 格式或 `visibleWidth` 函数中)现在可以正确忽略 ANSI 转义序列。[#63270](https://github.com/ClickHouse/ClickHouse/pull/63270) ([Shaun Struwig](https://github.com/Blargian))。
- 在适当的情况下,使用更准确的错误代码替换错误代码 `NUMBER_OF_ARGUMENTS_DOESNT_MATCH`。[#63406](https://github.com/ClickHouse/ClickHouse/pull/63406) ([Yohann Jardin](https://github.com/yohannj))。
- `os_user` 和 `client_hostname` 现在可以正确设置用于 clickhouse-client 中命令行建议的查询。此更改关闭了 [#63430](https://github.com/ClickHouse/ClickHouse/issues/63430)。[#63433](https://github.com/ClickHouse/ClickHouse/pull/63433) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 如果 `max_block_size` 为零,则自动将其更正为默认值。[#63587](https://github.com/ClickHouse/ClickHouse/pull/63587) ([Antonio Andelic](https://github.com/antonio2368))。
- 向 trace_log 添加 build_id ALIAS 列,以便在检测到二进制文件更改时自动重命名。这是为了解决 [#52086](https://github.com/ClickHouse/ClickHouse/issues/52086)。[#63656](https://github.com/ClickHouse/ClickHouse/pull/63656) ([Zimu Li](https://github.com/woodlzm))。
- 为对象存储磁盘启用截断操作。[#63693](https://github.com/ClickHouse/ClickHouse/pull/63693) ([MikhailBurdukov](https://github.com/MikhailBurdukov))。
- 关键字列表的加载现在取决于服务器版本,对于旧版本的 ClickHouse 服务器将被禁用。CC @azat。[#63786](https://github.com/ClickHouse/ClickHouse/pull/63786) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- ClickHouse 磁盘必须读取服务器设置以获取实际的元数据格式版本。[#63831](https://github.com/ClickHouse/ClickHouse/pull/63831) ([Sema Checherinda](https://github.com/CheSema))。
- 当 stdout 不是 TTY 时,禁用 pretty 格式限制(`output_format_pretty_max_rows`/`output_format_pretty_max_value_width`)。[#63942](https://github.com/ClickHouse/ClickHouse/pull/63942) ([Azat Khuzhin](https://github.com/azat))。
- 在 AWS Lambda 中使用 ClickHouse 时,异常处理现在可以正常工作。作者:[Alexey Coolnev](https://github.com/acoolnev)。[#64014](https://github.com/ClickHouse/ClickHouse/pull/64014) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 对于通过 HTTP 传递的无效压缩数据,抛出 `CANNOT_DECOMPRESS` 而不是 `CORRUPTED_DATA`。[#64036](https://github.com/ClickHouse/ClickHouse/pull/64036) ([vdimir](https://github.com/vdimir))。
- Pretty 格式中单个大数字的提示现在适用于 Nullable 和 LowCardinality。此更改关闭了 [#61993](https://github.com/ClickHouse/ClickHouse/issues/61993)。[#64084](https://github.com/ClickHouse/ClickHouse/pull/64084) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 在使用索引进行数据分片过滤时添加指标、日志和线程名称。[#64130](https://github.com/ClickHouse/ClickHouse/pull/64130) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 在 `ATTACH` 时忽略 `allow_suspicious_primary_key`,在 `ALTER` 时进行验证。[#64202](https://github.com/ClickHouse/ClickHouse/pull/64202) ([Azat Khuzhin](https://github.com/azat))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-3}

- ClickHouse 现使用 clang-18 进行构建。已启用大量来自 clang-tidy-18 的新检查项。[#60469](https://github.com/ClickHouse/ClickHouse/pull/60469) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 实验性支持 loongarch64 作为 ClickHouse 的新平台。[#63733](https://github.com/ClickHouse/ClickHouse/pull/63733) ([qiangxuhui](https://github.com/qiangxuhui))。
- Dockerfile 已通过 Docker 官方库审核,详见 https://github.com/docker-library/official-images/pull/15846。[#63400](https://github.com/ClickHouse/ClickHouse/pull/63400) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- CI 中每次构建时,每个编译单元中每个符号的信息都将被收集到 CI 数据库中。此改进解决了 [#63494](https://github.com/ClickHouse/ClickHouse/issues/63494)。[#63495](https://github.com/ClickHouse/ClickHouse/pull/63495) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 更新 Apache Datasketches 库。此更新解决了 [#63858](https://github.com/ClickHouse/ClickHouse/issues/63858)。[#63923](https://github.com/ClickHouse/ClickHouse/pull/63923) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 在交叉编译二进制文件时为 aarch64 Linux 启用 GRPC 支持。[#64072](https://github.com/ClickHouse/ClickHouse/pull/64072) ([alesapin](https://github.com/alesapin))。
- 修复 aarch64 上 SIGSEGV 时的栈回溯问题(由于信号栈空间过小导致)[#64058](https://github.com/ClickHouse/ClickHouse/pull/64058) ([Azat Khuzhin](https://github.com/azat))。


#### 错误修复 {#bug-fix-1}

- Disabled `enable_vertical_final` setting by default. This feature should not be used because it has a bug: [#64543](https://github.com/ClickHouse/ClickHouse/issues/64543). [#64544](https://github.com/ClickHouse/ClickHouse/pull/64544) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix making backup when multiple shards are used [#57684](https://github.com/ClickHouse/ClickHouse/pull/57684) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix passing projections/indexes/primary key from columns list from CREATE query into inner table of MV [#59183](https://github.com/ClickHouse/ClickHouse/pull/59183) ([Azat Khuzhin](https://github.com/azat)).
- Fix boundRatio incorrect merge [#60532](https://github.com/ClickHouse/ClickHouse/pull/60532) ([Tao Wang](https://github.com/wangtZJU)).
- Fix crash when calling some functions on const low-cardinality columns [#61966](https://github.com/ClickHouse/ClickHouse/pull/61966) ([Michael Kolupaev](https://github.com/al13n321)).
- Fix queries with FINAL give wrong result when table does not use adaptive granularity [#62432](https://github.com/ClickHouse/ClickHouse/pull/62432) ([Duc Canh Le](https://github.com/canhld94)).
- Improve detection of cgroups v2 support for memory controllers [#62903](https://github.com/ClickHouse/ClickHouse/pull/62903) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix subsequent use of external tables in client [#62964](https://github.com/ClickHouse/ClickHouse/pull/62964) ([Azat Khuzhin](https://github.com/azat)).
- Fix crash with untuple and unresolved lambda [#63131](https://github.com/ClickHouse/ClickHouse/pull/63131) ([Raúl Marín](https://github.com/Algunenano)).
- Fix premature server listen for connections [#63181](https://github.com/ClickHouse/ClickHouse/pull/63181) ([alesapin](https://github.com/alesapin)).
- Fix intersecting parts when restarting after a DROP PART command [#63202](https://github.com/ClickHouse/ClickHouse/pull/63202) ([Han Fei](https://github.com/hanfei1991)).
- Correctly load SQL security defaults during startup [#63209](https://github.com/ClickHouse/ClickHouse/pull/63209) ([pufit](https://github.com/pufit)).
- JOIN filter push down filter join fix [#63234](https://github.com/ClickHouse/ClickHouse/pull/63234) ([Maksim Kita](https://github.com/kitaisreal)).
- Fix infinite loop in AzureObjectStorage::listObjects [#63257](https://github.com/ClickHouse/ClickHouse/pull/63257) ([Julia Kartseva](https://github.com/jkartseva)).
- CROSS join ignore join_algorithm setting [#63273](https://github.com/ClickHouse/ClickHouse/pull/63273) ([vdimir](https://github.com/vdimir)).
- Fix finalize WriteBufferToFileSegment and StatusFile [#63346](https://github.com/ClickHouse/ClickHouse/pull/63346) ([vdimir](https://github.com/vdimir)).
- Fix logical error during SELECT query after ALTER in rare case [#63353](https://github.com/ClickHouse/ClickHouse/pull/63353) ([alesapin](https://github.com/alesapin)).
- Fix `X-ClickHouse-Timezone` header with `session_timezone` [#63377](https://github.com/ClickHouse/ClickHouse/pull/63377) ([Andrey Zvonov](https://github.com/zvonand)).
- Fix debug assert when using grouping WITH ROLLUP and LowCardinality types [#63398](https://github.com/ClickHouse/ClickHouse/pull/63398) ([Raúl Marín](https://github.com/Algunenano)).
- Small fixes for group_by_use_nulls [#63405](https://github.com/ClickHouse/ClickHouse/pull/63405) ([vdimir](https://github.com/vdimir)).
- Fix backup/restore of projection part in case projection was removed from table metadata, but part still has projection [#63426](https://github.com/ClickHouse/ClickHouse/pull/63426) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix mysql dictionary source [#63481](https://github.com/ClickHouse/ClickHouse/pull/63481) ([vdimir](https://github.com/vdimir)).
- Insert QueryFinish on AsyncInsertFlush with no data [#63483](https://github.com/ClickHouse/ClickHouse/pull/63483) ([Raúl Marín](https://github.com/Algunenano)).
- Fix: empty used_dictionaries in system.query_log [#63487](https://github.com/ClickHouse/ClickHouse/pull/63487) ([Eduard Karacharov](https://github.com/korowa)).
- Make `MergeTreePrefetchedReadPool` safer [#63513](https://github.com/ClickHouse/ClickHouse/pull/63513) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix crash on exit with sentry enabled (due to openssl destroyed before sentry) [#63548](https://github.com/ClickHouse/ClickHouse/pull/63548) ([Azat Khuzhin](https://github.com/azat)).
- Fix Array and Map support with Keyed hashing [#63628](https://github.com/ClickHouse/ClickHouse/pull/63628) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
- Fix filter pushdown for Parquet and maybe StorageMerge [#63642](https://github.com/ClickHouse/ClickHouse/pull/63642) ([Michael Kolupaev](https://github.com/al13n321)).
- Prevent conversion to Replicated if zookeeper path already exists [#63670](https://github.com/ClickHouse/ClickHouse/pull/63670) ([Kirill](https://github.com/kirillgarbar)).
- Analyzer: views read only necessary columns [#63688](https://github.com/ClickHouse/ClickHouse/pull/63688) ([Maksim Kita](https://github.com/kitaisreal)).
- Analyzer: Forbid WINDOW redefinition [#63694](https://github.com/ClickHouse/ClickHouse/pull/63694) ([Dmitry Novik](https://github.com/novikd)).
- flatten_nested was broken with the experimental Replicated database. [#63695](https://github.com/ClickHouse/ClickHouse/pull/63695) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix [#63653](https://github.com/ClickHouse/ClickHouse/issues/63653) [#63722](https://github.com/ClickHouse/ClickHouse/pull/63722) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Allow cast from Array(Nothing) to Map(Nothing, Nothing) [#63753](https://github.com/ClickHouse/ClickHouse/pull/63753) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix ILLEGAL_COLUMN in partial_merge join [#63755](https://github.com/ClickHouse/ClickHouse/pull/63755) ([vdimir](https://github.com/vdimir)).
- Fix: remove redundant distinct with window functions [#63776](https://github.com/ClickHouse/ClickHouse/pull/63776) ([Igor Nikonov](https://github.com/devcrafter)).
- Fix possible crash with SYSTEM UNLOAD PRIMARY KEY [#63778](https://github.com/ClickHouse/ClickHouse/pull/63778) ([Raúl Marín](https://github.com/Algunenano)).
- Fix a query with duplicating cycling alias. [#63791](https://github.com/ClickHouse/ClickHouse/pull/63791) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Make `TokenIterator` lazy as it should be [#63801](https://github.com/ClickHouse/ClickHouse/pull/63801) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Add `endpoint_subpath` S3 URI setting [#63806](https://github.com/ClickHouse/ClickHouse/pull/63806) ([Julia Kartseva](https://github.com/jkartseva)).
- Fix deadlock in `ParallelReadBuffer` [#63814](https://github.com/ClickHouse/ClickHouse/pull/63814) ([Antonio Andelic](https://github.com/antonio2368)).
- JOIN filter push down equivalent columns fix [#63819](https://github.com/ClickHouse/ClickHouse/pull/63819) ([Maksim Kita](https://github.com/kitaisreal)).
- Remove data from all disks after DROP with Lazy database. [#63848](https://github.com/ClickHouse/ClickHouse/pull/63848) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
- Fix incorrect result when reading from MV with parallel replicas and new analyzer [#63861](https://github.com/ClickHouse/ClickHouse/pull/63861) ([Nikita Taranov](https://github.com/nickitat)).
- Fixes in `find_super_nodes` and `find_big_family` command of keeper-client [#63862](https://github.com/ClickHouse/ClickHouse/pull/63862) ([Alexander Gololobov](https://github.com/davenger)).
- Update lambda execution name [#63864](https://github.com/ClickHouse/ClickHouse/pull/63864) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix SIGSEGV due to CPU/Real profiler [#63865](https://github.com/ClickHouse/ClickHouse/pull/63865) ([Azat Khuzhin](https://github.com/azat)).
- Fix `EXPLAIN CURRENT TRANSACTION` query [#63926](https://github.com/ClickHouse/ClickHouse/pull/63926) ([Anton Popov](https://github.com/CurtizJ)).
- Fix analyzer: there's turtles all the way down... [#63930](https://github.com/ClickHouse/ClickHouse/pull/63930) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Allow certain ALTER TABLE commands for `plain_rewritable` disk [#63933](https://github.com/ClickHouse/ClickHouse/pull/63933) ([Julia Kartseva](https://github.com/jkartseva)).
- Recursive CTE distributed fix [#63939](https://github.com/ClickHouse/ClickHouse/pull/63939) ([Maksim Kita](https://github.com/kitaisreal)).
- Analyzer: Fix COLUMNS resolve [#63962](https://github.com/ClickHouse/ClickHouse/pull/63962) ([Dmitry Novik](https://github.com/novikd)).
- LIMIT BY and skip_unused_shards with analyzer [#63983](https://github.com/ClickHouse/ClickHouse/pull/63983) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- A fix for some trash (experimental Kusto) [#63992](https://github.com/ClickHouse/ClickHouse/pull/63992) ([Yong Wang](https://github.com/kashwy)).
- Deserialize untrusted binary inputs in a safer way [#64024](https://github.com/ClickHouse/ClickHouse/pull/64024) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix query analysis for queries with the setting `final` = 1 for Distributed tables over tables from other than the MergeTree family. [#64037](https://github.com/ClickHouse/ClickHouse/pull/64037) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Add missing settings to recoverLostReplica [#64040](https://github.com/ClickHouse/ClickHouse/pull/64040) ([Raúl Marín](https://github.com/Algunenano)).
- Fix SQL security access checks with analyzer [#64079](https://github.com/ClickHouse/ClickHouse/pull/64079) ([pufit](https://github.com/pufit)).
- Fix analyzer: only interpolate expression should be used for DAG [#64096](https://github.com/ClickHouse/ClickHouse/pull/64096) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix azure backup writing multipart blocks by 1 MiB (read buffer size) instead of `max_upload_part_size` (in non-native copy case) [#64117](https://github.com/ClickHouse/ClickHouse/pull/64117) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Correctly fallback during backup copy [#64153](https://github.com/ClickHouse/ClickHouse/pull/64153) ([Antonio Andelic](https://github.com/antonio2368)).
- Prevent LOGICAL_ERROR on CREATE TABLE as materialized view [#64174](https://github.com/ClickHouse/ClickHouse/pull/64174) ([Raúl Marín](https://github.com/Algunenano)).
- Query Cache: Consider identical queries against different databases as different [#64199](https://github.com/ClickHouse/ClickHouse/pull/64199) ([Robert Schulze](https://github.com/rschu1ze)).
- Ignore `text_log` for Keeper [#64218](https://github.com/ClickHouse/ClickHouse/pull/64218) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix Logical error: Bad cast for Buffer table with prewhere. [#64388](https://github.com/ClickHouse/ClickHouse/pull/64388) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).

### <a id="244"></a> ClickHouse release 24.4, 2024-04-30 {#a-id244a-clickhouse-release-244-2024-04-30}

#### 升级说明 {#upgrade-notes}

- `clickhouse-odbc-bridge` 和 `clickhouse-library-bridge` 现已作为独立软件包提供。此更改解决了 [#61677](https://github.com/ClickHouse/ClickHouse/issues/61677)。[#62114](https://github.com/ClickHouse/ClickHouse/pull/62114) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 不再允许将 max_parallel_replicas(用于实验性副本并行读取功能)设置为 `0`,因为这样做没有意义。解决了 [#60140](https://github.com/ClickHouse/ClickHouse/issues/60140)。[#61201](https://github.com/ClickHouse/ClickHouse/pull/61201) ([Kruglov Pavel](https://github.com/Avogar))。
- 移除了对 `INSERT WATCH` 查询的支持(该查询是已弃用的 `LIVE VIEW` 功能的一部分)。[#62382](https://github.com/ClickHouse/ClickHouse/pull/62382) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 移除了 `optimize_monotonous_functions_in_order_by` 设置。[#63004](https://github.com/ClickHouse/ClickHouse/pull/63004) ([Raúl Marín](https://github.com/Algunenano))。
- 移除了 `Replicated` 数据库引擎的实验性标签。现已进入 Beta 阶段。[#62937](https://github.com/ClickHouse/ClickHouse/pull/62937) ([Justin de Guzman](https://github.com/justindeguzman))。


#### 新功能 {#new-feature-8}

- 支持递归 CTE。[#62074](https://github.com/ClickHouse/ClickHouse/pull/62074) ([Maksim Kita](https://github.com/kitaisreal))。
- 支持 `QUALIFY` 子句。关闭 [#47819](https://github.com/ClickHouse/ClickHouse/issues/47819)。[#62619](https://github.com/ClickHouse/ClickHouse/pull/62619) ([Maksim Kita](https://github.com/kitaisreal))。
- 表引擎现在可授予权限,且不会影响现有用户的行为。[#60117](https://github.com/ClickHouse/ClickHouse/pull/60117) ([jsc0218](https://github.com/jsc0218))。
- 添加了可重写的 S3 磁盘,支持 INSERT 操作且无需本地存储元数据。[#61116](https://github.com/ClickHouse/ClickHouse/pull/61116) ([Julia Kartseva](https://github.com/jkartseva))。主要用于系统表。
- 客户端中输入时的语法高亮现在在语法级别工作(以前在词法分析器级别工作)。[#62123](https://github.com/ClickHouse/ClickHouse/pull/62123) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 支持同时删除多个表,如 `DROP TABLE a, b, c`;。[#58705](https://github.com/ClickHouse/ClickHouse/pull/58705) ([zhongyuankai](https://github.com/zhongyuankai))。
- 现在支持通过 `ALTER MODIFY SETTING` 修改内存表设置。示例:`ALTER TABLE memory MODIFY SETTING min_rows_to_keep = 100, max_rows_to_keep = 1000;`。[#62039](https://github.com/ClickHouse/ClickHouse/pull/62039) ([zhongyuankai](https://github.com/zhongyuankai))。
- 为 HTTP 接口添加了 `role` 查询参数。其工作方式类似于 `SET ROLE x`,在执行语句之前应用角色。这解决了 HTTP 接口的限制,因为不允许多条语句,无法同时发送 `SET ROLE x` 和语句本身。可以通过这种方式设置多个角色,例如 `?role=x&role=y`,相当于 `SET ROLE x, y`。[#62669](https://github.com/ClickHouse/ClickHouse/pull/62669) ([Serge Klochkov](https://github.com/slvrtrn))。
- 添加 `SYSTEM UNLOAD PRIMARY KEY` 以释放表主键占用的内存。[#62738](https://github.com/ClickHouse/ClickHouse/pull/62738) ([Pablo Marcos](https://github.com/pamarcos))。
- 为 `system.text_log` 添加了 `value1`、`value2`、...、`value10` 列。这些列包含用于格式化消息的值。[#59619](https://github.com/ClickHouse/ClickHouse/pull/59619) ([Alexey Katsman](https://github.com/alexkats))。
- 添加了持久化虚拟列 `_block_offset`,用于存储插入时分配给数据块中行的原始编号。可以通过 MergeTree 设置 `enable_block_offset_column` 启用 `_block_offset` 列的持久化。添加了虚拟列 `_part_data_version`,其中包含最小数据块编号或数据分片的变更版本。持久化虚拟列 `_block_number` 不再被视为实验性功能。[#60676](https://github.com/ClickHouse/ClickHouse/pull/60676) ([Anton Popov](https://github.com/CurtizJ))。
- 添加设置 `input_format_json_throw_on_bad_escape_sequence`,禁用该设置允许在 JSON 输入格式中保留错误的转义序列。[#61889](https://github.com/ClickHouse/ClickHouse/pull/61889) ([Kruglov Pavel](https://github.com/Avogar))。


#### 性能改进 {#performance-improvement-8}

- 使用等价集改进 JOIN 过滤器下推。[#61216](https://github.com/ClickHouse/ClickHouse/pull/61216) ([Maksim Kita](https://github.com/kitaisreal))。
- 当 JOIN 后的过滤器始终过滤默认值时,将 OUTER JOIN 转换为 INNER JOIN 优化。该优化可通过设置 `query_plan_convert_outer_join_to_inner_join` 控制,默认启用。[#62907](https://github.com/ClickHouse/ClickHouse/pull/62907) ([Maksim Kita](https://github.com/kitaisreal))。
- AWS S3 改进。客户端需要向服务器发送 'Keep-Alive: timeout=X' 头。如果客户端收到服务器带有该头的响应,客户端需要使用服务器返回的值。此外,客户端最好不要使用即将过期的连接,以避免连接关闭竞争。[#62249](https://github.com/ClickHouse/ClickHouse/pull/62249) ([Sema Checherinda](https://github.com/CheSema))。
- 降低 mutation 对 SELECT 查询的开销(v2)。[#60856](https://github.com/ClickHouse/ClickHouse/pull/60856) ([Azat Khuzhin](https://github.com/azat))。
- PODArray 中更频繁调用的函数现在强制内联。[#61144](https://github.com/ClickHouse/ClickHouse/pull/61144) ([李扬](https://github.com/taiyang-li))。
- 通过在读取所有必需列后跳过对象的其余部分来加速 JSON 解析。[#62210](https://github.com/ClickHouse/ClickHouse/pull/62210) ([lgbo](https://github.com/lgbo-ustc))。
- 改进从 file/s3/hdfs/url/... 表函数中的文件进行简单 insert select 操作。添加单独的 max_parsing_threads 设置以控制并行解析使用的线程数。[#62404](https://github.com/ClickHouse/ClickHouse/pull/62404) ([Kruglov Pavel](https://github.com/Avogar))。
- 函数 `to_utc_timestamp` 和 `from_utc_timestamp` 现在速度提升约 2 倍。[#62583](https://github.com/ClickHouse/ClickHouse/pull/62583) ([KevinyhZou](https://github.com/KevinyhZou))。
- 当输入主要包含不可解析值时,函数 `parseDateTimeOrNull`、`parseDateTimeOrZero`、`parseDateTimeInJodaSyntaxOrNull` 和 `parseDateTimeInJodaSyntaxOrZero` 现在运行速度显著提升(10 倍 - 1000 倍)。[#62634](https://github.com/ClickHouse/ClickHouse/pull/62634) ([LiuNeng](https://github.com/liuneng1994))。
- 当查询缓存包含大量条目(例如超过 100,000 条)时,针对 `system.query_cache` 的 SELECT 查询现在明显更快。[#62671](https://github.com/ClickHouse/ClickHouse/pull/62671) ([Robert Schulze](https://github.com/rschu1ze))。
- 减少文件系统缓存中的竞争(第 3 部分):在空间预留尝试时无锁执行文件系统删除操作。[#61163](https://github.com/ClickHouse/ClickHouse/pull/61163) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 加速文件系统缓存的动态调整大小。[#61723](https://github.com/ClickHouse/ClickHouse/pull/61723) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 带有 `INVALIDATE_QUERY` 的字典源在启动时不会重复加载两次。[#62050](https://github.com/ClickHouse/ClickHouse/pull/62050) ([vdimir](https://github.com/vdimir))。
- 修复一个问题:当在涉及主键的布尔表达式后添加冗余的 `= 1` 或 `= 0` 时,主索引未被使用。例如,`SELECT * FROM <table> WHERE <primary-key> IN (<value>) = 1` 和 `SELECT * FROM <table> WHERE <primary-key> NOT IN (<value>) = 0` 都会执行全表扫描,而实际上可以使用主索引。[#62142](https://github.com/ClickHouse/ClickHouse/pull/62142) ([josh-hildred](https://github.com/josh-hildred))。
- 从 `system.remote_data_paths` 返回数据块流,而不是将整个结果累积在一个大块中。这可以减少内存消耗、显示中间进度并支持取消查询。[#62613](https://github.com/ClickHouse/ClickHouse/pull/62613) ([Alexander Gololobov](https://github.com/davenger))。

#### 实验性功能 {#experimental-feature-6}

- 通过设置 `azure_allow_parallel_part_upload` 支持 Azure Blob 存储的并行写入缓冲区。[#62534](https://github.com/ClickHouse/ClickHouse/pull/62534) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
- 用户空间页缓存现已支持静态 Web 存储（`disk(type = web)`）。使用客户端设置 `use_page_cache_for_disks_without_file_cache=1` 启用此功能。[#61911](https://github.com/ClickHouse/ClickHouse/pull/61911) ([Michael Kolupaev](https://github.com/al13n321))。
- 在 `Variant` 类型中不再将布尔值和数字变体视为可疑类型。[#61999](https://github.com/ClickHouse/ClickHouse/pull/61999) ([Kruglov Pavel](https://github.com/Avogar))。
- 实现了通过解析将字符串转换为 `Variant` 的改进方法。[#62005](https://github.com/ClickHouse/ClickHouse/pull/62005) ([Kruglov Pavel](https://github.com/Avogar))。
- 在 JSONExtract 函数中支持 `Variant` 类型。[#62014](https://github.com/ClickHouse/ClickHouse/pull/62014) ([Kruglov Pavel](https://github.com/Avogar))。
- 将 `Variant` 类型标记为可比较类型,使其可用于主键。[#62693](https://github.com/ClickHouse/ClickHouse/pull/62693) ([Kruglov Pavel](https://github.com/Avogar))。


#### 改进 {#improvement-8}

- 为方便起见,`SELECT * FROM numbers()` 将以与 `SELECT * FROM system.numbers` 相同的方式工作 - 无需限制。[#61969](https://github.com/ClickHouse/ClickHouse/pull/61969) ([YenchangChan](https://github.com/YenchangChan)).
- 为 Kafka 配置引入独立的消费者/生产者标签。这避免了来自 librdkafka(一个存在大量缺陷的 C 库)的警告,即为生产者实例指定了消费者属性,反之亦然(例如 `Configuration property session.timeout.ms is a consumer property and will be ignored by this producer instance`)。关闭:[#58983](https://github.com/ClickHouse/ClickHouse/issues/58983). [#58956](https://github.com/ClickHouse/ClickHouse/pull/58956) ([Aleksandr Musorin](https://github.com/AVMusorin)).
- 函数 `date_diff` 和 `age` 现在以纳秒精度而非微秒精度计算结果。它们现在还支持将 `nanosecond`(或 `nanoseconds` 或 `ns`)作为 `unit` 参数的可选值。[#61409](https://github.com/ClickHouse/ClickHouse/pull/61409) ([Austin Kothig](https://github.com/kothiga)).
- 为 `date_trunc` 添加了纳秒、微秒、毫秒单位。[#62335](https://github.com/ClickHouse/ClickHouse/pull/62335) ([Misz606](https://github.com/Misz606)).
- 在证书重新加载期间重新加载证书链。[#61671](https://github.com/ClickHouse/ClickHouse/pull/61671) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
- 通过在该副本路径存在活动副本时不允许附加表来尝试防止错误 [#60432](https://github.com/ClickHouse/ClickHouse/issues/60432)。[#61876](https://github.com/ClickHouse/ClickHouse/pull/61876) ([Arthur Passos](https://github.com/arthurpassos)).
- 为 `clickhouse-local` 实现对 `input` 的支持。[#61923](https://github.com/ClickHouse/ClickHouse/pull/61923) ([Azat Khuzhin](https://github.com/azat)).
- 具有严格性 `ANY` 的 `Join` 表引擎在重新加载后保持一致。当插入具有相同键的多行时,第一行将具有更高的优先级(之前在表加载时是随机选择的)。关闭 [#51027](https://github.com/ClickHouse/ClickHouse/issues/51027). [#61972](https://github.com/ClickHouse/ClickHouse/pull/61972) ([vdimir](https://github.com/vdimir)).
- 从 Apache Arrow 模式自动推断 Nullable 列类型。[#61984](https://github.com/ClickHouse/ClickHouse/pull/61984) ([Maksim Kita](https://github.com/kitaisreal)).
- 允许在聚合期间取消聚合状态的并行合并。示例:`uniqExact`。[#61992](https://github.com/ClickHouse/ClickHouse/pull/61992) ([Maksim Kita](https://github.com/kitaisreal)).
- 使用 `system.keywords` 填充建议,并在内部所有位置使用它们。[#62000](https://github.com/ClickHouse/ClickHouse/pull/62000) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- `ReplicatedMergeTree` 的 `OPTIMIZE FINAL` 现在将等待当前活动的合并完成,然后重新尝试调度最终合并。这将使其更符合普通 `MergeTree` 的行为。[#62067](https://github.com/ClickHouse/ClickHouse/pull/62067) ([Nikita Taranov](https://github.com/nickitat)).
- 从 hive 文本文件读取数据时,会使用 hive 文本文件的第一行来调整输入字段的数量,有时第一行的字段数量与 hive 表定义不匹配,例如 hive 表定义为有 3 列,如 `test_tbl(a Int32, b Int32, c Int32)`,但文本文件的第一行只有 2 个字段,在这种情况下,输入字段将被调整为 2,如果文本文件的下一行有 3 个字段,则第三个字段无法读取而是被设置为默认值 0,这是不正确的。[#62086](https://github.com/ClickHouse/ClickHouse/pull/62086) ([KevinyhZou](https://github.com/KevinyhZou)).
- `CREATE AS` 复制表的注释。[#62117](https://github.com/ClickHouse/ClickHouse/pull/62117) ([Pablo Marcos](https://github.com/pamarcos)).
- 向表 zookeeper 添加查询进度。[#62152](https://github.com/ClickHouse/ClickHouse/pull/62152) ([JackyWoo](https://github.com/JackyWoo)).
- 添加在服务器范围内启用跟踪收集器(Real 和 CPU)的能力。[#62189](https://github.com/ClickHouse/ClickHouse/pull/62189) ([alesapin](https://github.com/alesapin)).
- 添加了设置 `lightweight_deletes_sync`(默认值:2 - 同步等待所有副本)。它类似于设置 `mutations_sync`,但仅影响轻量级删除的行为。[#62195](https://github.com/ClickHouse/ClickHouse/pull/62195) ([Anton Popov](https://github.com/CurtizJ)).
- 在解析自定义设置的值时区分布尔值和整数:`SET custom_a = true; SET custom_b = 1;`。[#62206](https://github.com/ClickHouse/ClickHouse/pull/62206) ([Vitaly Baranov](https://github.com/vitlibar)).
- 支持通过 AWS Private Link Interface 端点访问 S3。关闭 [#60021](https://github.com/ClickHouse/ClickHouse/issues/60021)、[#31074](https://github.com/ClickHouse/ClickHouse/issues/31074) 和 [#53761](https://github.com/ClickHouse/ClickHouse/issues/53761)。[#62208](https://github.com/ClickHouse/ClickHouse/pull/62208) ([Arthur Passos](https://github.com/arthurpassos)).
- 如果目录不存在,则不在 clickhouse-client 中为 UDF 创建目录。这关闭了 [#59597](https://github.com/ClickHouse/ClickHouse/issues/59597)。[#62366](https://github.com/ClickHouse/ClickHouse/pull/62366) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- 查询缓存现在不再缓存针对系统表(`system.*`、`information_schema.*`、`INFORMATION_SCHEMA.*`)的查询结果。[#62376](https://github.com/ClickHouse/ClickHouse/pull/62376) ([Robert Schulze](https://github.com/rschu1ze)).
- `MOVE PARTITION TO TABLE` 查询可以被延迟或抛出 `TOO_MANY_PARTS` 异常以避免超出分区数量限制。应用与 `INSERT` 查询相同的设置和限制(参见 `max_parts_in_total`、`parts_to_delay_insert`、`parts_to_throw_insert`、`inactive_parts_to_throw_insert`、`inactive_parts_to_delay_insert`、`max_avg_part_size_for_too_many_parts`、`min_delay_to_insert_ms` 和 `max_delay_to_insert` 设置)。[#62420](https://github.com/ClickHouse/ClickHouse/pull/62420) ([Sergei Trifonov](https://github.com/serxa)).
- 将 macOS 上的默认安装目录从 `/usr/bin` 更改为 `/usr/local/bin`。这是必要的,因为 Apple 在 macOS El Capitan(2015)中引入的系统完整性保护阻止写入 `/usr/bin`,即使使用 `sudo` 也是如此。[#62489](https://github.com/ClickHouse/ClickHouse/pull/62489) ([haohang](https://github.com/yokofly)).
- 使 transform 始终返回第一个匹配项。[#62518](https://github.com/ClickHouse/ClickHouse/pull/62518) ([Raúl Marín](https://github.com/Algunenano)).
- 向系统表 `blob_storage_log` 添加了缺失的 `hostname` 列。[#62456](https://github.com/ClickHouse/ClickHouse/pull/62456) ([Jayme Bird](https://github.com/jaymebrd)).
- 为了与其他系统表保持一致,`system.backup_log` 现在有一个 `event_time` 列。[#62541](https://github.com/ClickHouse/ClickHouse/pull/62541) ([Jayme Bird](https://github.com/jaymebrd)).
- 表 `system.backup_log` 现在具有"默认"排序键,即 `event_date, event_time`,与其他 `_log` 表引擎相同。[#62667](https://github.com/ClickHouse/ClickHouse/pull/62667) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- 在执行 `RESTORE` 时避免评估表 DEFAULT 表达式。[#62601](https://github.com/ClickHouse/ClickHouse/pull/62601) ([Vitaly Baranov](https://github.com/vitlibar)).
- S3 存储和备份也需要与 s3 磁盘相同的默认保持活动设置。[#62648](https://github.com/ClickHouse/ClickHouse/pull/62648) ([Sema Checherinda](https://github.com/CheSema)).
- 将 librdkafka(那个臭名昭著的存在大量缺陷的 C 库)的客户端标识符添加到日志消息中,以便能够区分来自单个表的不同消费者的日志消息。[#62813](https://github.com/ClickHouse/ClickHouse/pull/62813) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- 允许在 Replicated 数据库 ZooKeeper 路径中使用特殊宏 `{uuid}` 和 `{database}`。[#62818](https://github.com/ClickHouse/ClickHouse/pull/62818) ([Vitaly Baranov](https://github.com/vitlibar)).
- 允许在 HTTP 请求中使用具有不同身份验证方案的配额键。[#62842](https://github.com/ClickHouse/ClickHouse/pull/62842) ([Kseniia Sumarokova](https://github.com/kssenii)).
- 减少 `clickhouse client` 和 `clickhouse local` 中命令行参数 `--help` 的详细程度。之前的输出现在由 `--help --verbose` 生成。[#62973](https://github.com/ClickHouse/ClickHouse/pull/62973) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- `log_bin_use_v1_row_events` 在 MySQL 8.3 中被移除,我们为此调整了实验性的 `MaterializedMySQL` 引擎 [#60479](https://github.com/ClickHouse/ClickHouse/issues/60479)。[#63101](https://github.com/ClickHouse/ClickHouse/pull/63101) ([Eugene Klimov](https://github.com/Slach)). 作者:Nikolay Yankin.





#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-4}

- 将 Rust 依赖项纳入供应商管理,使 Rust 代码(我们将其用于一些次要功能以追求新鲜感和趣味性)能够以合理的方式构建,类似于 C++。[#62297](https://github.com/ClickHouse/ClickHouse/pull/62297) ([Raúl Marín](https://github.com/Algunenano))。
- ClickHouse 现在使用 OpenSSL 3.2 而不是 BoringSSL。[#59870](https://github.com/ClickHouse/ClickHouse/pull/59870) ([Robert Schulze](https://github.com/rschu1ze))。请注意,OpenSSL 的工程文化通常较差(例如存在非零数量的清理器报告需要我们修补、复杂的构建系统包含生成的文件等),但具有更好的兼容性。
- 在压力测试中以 1/2 的概率忽略 DROP 查询,在 Memory/JOIN 表的升级检查中使用 TRUNCATE 而不是忽略 DROP。[#61476](https://github.com/ClickHouse/ClickHouse/pull/61476) ([Kruglov Pavel](https://github.com/Avogar))。
- 从 Keeper Docker 镜像中移除 /etc/clickhouse-keeper 和 /var/log/clickhouse-keeper 的卷。[#61683](https://github.com/ClickHouse/ClickHouse/pull/61683) ([Tristan](https://github.com/Tristan971))。
- 为默认启用 Analyzer 后不再相关的所有问题添加测试。关闭:[#55794](https://github.com/ClickHouse/ClickHouse/issues/55794) 关闭:[#49472](https://github.com/ClickHouse/ClickHouse/issues/49472) 关闭:[#44414](https://github.com/ClickHouse/ClickHouse/issues/44414) 关闭:[#13843](https://github.com/ClickHouse/ClickHouse/issues/13843) 关闭:[#55803](https://github.com/ClickHouse/ClickHouse/issues/55803) 关闭:[#48308](https://github.com/ClickHouse/ClickHouse/issues/48308) 关闭:[#45535](https://github.com/ClickHouse/ClickHouse/issues/45535) 关闭:[#44365](https://github.com/ClickHouse/ClickHouse/issues/44365) 关闭:[#44153](https://github.com/ClickHouse/ClickHouse/issues/44153) 关闭:[#42399](https://github.com/ClickHouse/ClickHouse/issues/42399) 关闭:[#27115](https://github.com/ClickHouse/ClickHouse/issues/27115) 关闭:[#23162](https://github.com/ClickHouse/ClickHouse/issues/23162) 关闭:[#15395](https://github.com/ClickHouse/ClickHouse/issues/15395) 关闭:[#15411](https://github.com/ClickHouse/ClickHouse/issues/15411) 关闭:[#14978](https://github.com/ClickHouse/ClickHouse/issues/14978) 关闭:[#17319](https://github.com/ClickHouse/ClickHouse/issues/17319) 关闭:[#11813](https://github.com/ClickHouse/ClickHouse/issues/11813) 关闭:[#13210](https://github.com/ClickHouse/ClickHouse/issues/13210) 关闭:[#23053](https://github.com/ClickHouse/ClickHouse/issues/23053) 关闭:[#37729](https://github.com/ClickHouse/ClickHouse/issues/37729) 关闭:[#32639](https://github.com/ClickHouse/ClickHouse/issues/32639) 关闭:[#9954](https://github.com/ClickHouse/ClickHouse/issues/9954) 关闭:[#41964](https://github.com/ClickHouse/ClickHouse/issues/41964) 关闭:[#54317](https://github.com/ClickHouse/ClickHouse/issues/54317) 关闭:[#7520](https://github.com/ClickHouse/ClickHouse/issues/7520) 关闭:[#36973](https://github.com/ClickHouse/ClickHouse/issues/36973) 关闭:[#40955](https://github.com/ClickHouse/ClickHouse/issues/40955) 关闭:[#19687](https://github.com/ClickHouse/ClickHouse/issues/19687) 关闭:[#23104](https://github.com/ClickHouse/ClickHouse/issues/23104) 关闭:[#21584](https://github.com/ClickHouse/ClickHouse/issues/21584) 关闭:[#23344](https://github.com/ClickHouse/ClickHouse/issues/23344) 关闭:[#22627](https://github.com/ClickHouse/ClickHouse/issues/22627) 关闭:[#10276](https://github.com/ClickHouse/ClickHouse/issues/10276) 关闭:[#19687](https://github.com/ClickHouse/ClickHouse/issues/19687) 关闭:[#4567](https://github.com/ClickHouse/ClickHouse/issues/4567) 关闭:[#17710](https://github.com/ClickHouse/ClickHouse/issues/17710) 关闭:[#11068](https://github.com/ClickHouse/ClickHouse/issues/11068) 关闭:[#24395](https://github.com/ClickHouse/ClickHouse/issues/24395) 关闭:[#23416](https://github.com/ClickHouse/ClickHouse/issues/23416) 关闭:[#23162](https://github.com/ClickHouse/ClickHouse/issues/23162) 关闭:[#25655](https://github.com/ClickHouse/ClickHouse/issues/25655) 关闭:[#11757](https://github.com/ClickHouse/ClickHouse/issues/11757) 关闭:[#6571](https://github.com/ClickHouse/ClickHouse/issues/6571) 关闭:[#4432](https://github.com/ClickHouse/ClickHouse/issues/4432) 关闭:[#8259](https://github.com/ClickHouse/ClickHouse/issues/8259) 关闭:[#9233](https://github.com/ClickHouse/ClickHouse/issues/9233) 关闭:[#14699](https://github.com/ClickHouse/ClickHouse/issues/14699) 关闭:[#27068](https://github.com/ClickHouse/ClickHouse/issues/27068) 关闭:[#28687](https://github.com/ClickHouse/ClickHouse/issues/28687) 关闭:[#28777](https://github.com/ClickHouse/ClickHouse/issues/28777) 关闭:[#29734](https://github.com/ClickHouse/ClickHouse/issues/29734) 关闭:[#61238](https://github.com/ClickHouse/ClickHouse/issues/61238) 关闭:[#33825](https://github.com/ClickHouse/ClickHouse/issues/33825) 关闭:[#35608](https://github.com/ClickHouse/ClickHouse/issues/35608) 关闭:[#29838](https://github.com/ClickHouse/ClickHouse/issues/29838) 关闭:[#35652](https://github.com/ClickHouse/ClickHouse/issues/35652) 关闭:[#36189](https://github.com/ClickHouse/ClickHouse/issues/36189) 关闭:[#39634](https://github.com/ClickHouse/ClickHouse/issues/39634) 关闭:[#47432](https://github.com/ClickHouse/ClickHouse/issues/47432) 关闭:[#54910](https://github.com/ClickHouse/ClickHouse/issues/54910) 关闭:[#57321](https://github.com/ClickHouse/ClickHouse/issues/57321) 关闭:[#59154](https://github.com/ClickHouse/ClickHouse/issues/59154) 关闭:[#61014](https://github.com/ClickHouse/ClickHouse/issues/61014) 关闭:[#61950](https://github.com/ClickHouse/ClickHouse/issues/61950) 关闭:[#55647](https://github.com/ClickHouse/ClickHouse/issues/55647) 关闭:[#61947](https://github.com/ClickHouse/ClickHouse/issues/61947)。[#62185](https://github.com/ClickHouse/ClickHouse/pull/62185) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 为不再相关或已由分析器修复的问题添加更多测试。关闭:[#58985](https://github.com/ClickHouse/ClickHouse/issues/58985) 关闭:[#59549](https://github.com/ClickHouse/ClickHouse/issues/59549) 关闭:[#36963](https://github.com/ClickHouse/ClickHouse/issues/36963) 关闭:[#39453](https://github.com/ClickHouse/ClickHouse/issues/39453) 关闭:[#56521](https://github.com/ClickHouse/ClickHouse/issues/56521) 关闭:[#47552](https://github.com/ClickHouse/ClickHouse/issues/47552) 关闭:[#56503](https://github.com/ClickHouse/ClickHouse/issues/56503) 关闭:[#59101](https://github.com/ClickHouse/ClickHouse/issues/59101) 关闭:[#50271](https://github.com/ClickHouse/ClickHouse/issues/50271) 关闭:[#54954](https://github.com/ClickHouse/ClickHouse/issues/54954) 关闭:[#56466](https://github.com/ClickHouse/ClickHouse/issues/56466) 关闭:[#11000](https://github.com/ClickHouse/ClickHouse/issues/11000) 关闭:[#10894](https://github.com/ClickHouse/ClickHouse/issues/10894) 关闭:https://github.com/ClickHouse/ClickHouse/issues/448 关闭:[#8030](https://github.com/ClickHouse/ClickHouse/issues/8030) 关闭:[#32139](https://github.com/ClickHouse/ClickHouse/issues/32139) 关闭:[#47288](https://github.com/ClickHouse/ClickHouse/issues/47288) 关闭:[#50705](https://github.com/ClickHouse/ClickHouse/issues/50705) 关闭:[#54511](https://github.com/ClickHouse/ClickHouse/issues/54511) 关闭:[#55466](https://github.com/ClickHouse/ClickHouse/issues/55466) 关闭:[#58500](https://github.com/ClickHouse/ClickHouse/issues/58500) 关闭:[#39923](https://github.com/ClickHouse/ClickHouse/issues/39923) 关闭:[#39855](https://github.com/ClickHouse/ClickHouse/issues/39855) 关闭:[#4596](https://github.com/ClickHouse/ClickHouse/issues/4596) 关闭:[#47422](https://github.com/ClickHouse/ClickHouse/issues/47422) 关闭:[#33000](https://github.com/ClickHouse/ClickHouse/issues/33000) 关闭:[#14739](https://github.com/ClickHouse/ClickHouse/issues/14739) 关闭:[#44039](https://github.com/ClickHouse/ClickHouse/issues/44039) 关闭:[#8547](https://github.com/ClickHouse/ClickHouse/issues/8547) 关闭:[#22923](https://github.com/ClickHouse/ClickHouse/issues/22923) 关闭:[#23865](https://github.com/ClickHouse/ClickHouse/issues/23865) 关闭:[#29748](https://github.com/ClickHouse/ClickHouse/issues/29748) 关闭:[#4222](https://github.com/ClickHouse/ClickHouse/issues/4222)。[#62457](https://github.com/ClickHouse/ClickHouse/pull/62457) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 修复了动态链接 OpenSSL 时的构建错误(注意:这通常不受支持,仅在 IBM 的 s390x 平台上需要)。[#62888](https://github.com/ClickHouse/ClickHouse/pull/62888) ([Harry Lee](https://github.com/HarryLeeIBM))。





#### 错误修复(官方稳定版本中用户可见的异常行为) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-6}

- Fix logical-error when undoing quorum insert transaction. [#61953](https://github.com/ClickHouse/ClickHouse/pull/61953) ([Han Fei](https://github.com/hanfei1991)).
- Fix parser error when using COUNT(\*) with FILTER clause [#61357](https://github.com/ClickHouse/ClickHouse/pull/61357) ([Duc Canh Le](https://github.com/canhld94)).
- Fix logical error in `group_by_use_nulls` + grouping sets + analyzer + materialize/constant [#61567](https://github.com/ClickHouse/ClickHouse/pull/61567) ([Kruglov Pavel](https://github.com/Avogar)).
- Cancel merges before removing moved parts [#61610](https://github.com/ClickHouse/ClickHouse/pull/61610) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fix abort in Apache Arrow [#61720](https://github.com/ClickHouse/ClickHouse/pull/61720) ([Kruglov Pavel](https://github.com/Avogar)).
- Search for `convert_to_replicated` flag at the correct path corresponding to the specific disk [#61769](https://github.com/ClickHouse/ClickHouse/pull/61769) ([Kirill](https://github.com/kirillgarbar)).
- Fix possible connections data-race for distributed_foreground_insert/distributed_background_insert_batch [#61867](https://github.com/ClickHouse/ClickHouse/pull/61867) ([Azat Khuzhin](https://github.com/azat)).
- Mark CANNOT_PARSE_ESCAPE_SEQUENCE error as parse error to be able to skip it in row input formats [#61883](https://github.com/ClickHouse/ClickHouse/pull/61883) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix writing exception message in output format in HTTP when http_wait_end_of_query is used [#61951](https://github.com/ClickHouse/ClickHouse/pull/61951) ([Kruglov Pavel](https://github.com/Avogar)).
- Proper fix for LowCardinality together with JSONExtact functions [#61957](https://github.com/ClickHouse/ClickHouse/pull/61957) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Crash in Engine Merge if Row Policy does not have expression [#61971](https://github.com/ClickHouse/ClickHouse/pull/61971) ([Ilya Golshtein](https://github.com/ilejn)).
- Fix WriteBufferAzureBlobStorage destructor uncaught exception [#61988](https://github.com/ClickHouse/ClickHouse/pull/61988) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Fix CREATE TABLE without columns definition for ReplicatedMergeTree [#62040](https://github.com/ClickHouse/ClickHouse/pull/62040) ([Azat Khuzhin](https://github.com/azat)).
- Fix optimize_skip_unused_shards_rewrite_in for composite sharding key [#62047](https://github.com/ClickHouse/ClickHouse/pull/62047) ([Azat Khuzhin](https://github.com/azat)).
- ReadWriteBufferFromHTTP set right header host when redirected [#62068](https://github.com/ClickHouse/ClickHouse/pull/62068) ([Sema Checherinda](https://github.com/CheSema)).
- Fix external table cannot parse data type Bool [#62115](https://github.com/ClickHouse/ClickHouse/pull/62115) ([Duc Canh Le](https://github.com/canhld94)).
- Analyzer: Fix query parameter resolution [#62186](https://github.com/ClickHouse/ClickHouse/pull/62186) ([Dmitry Novik](https://github.com/novikd)).
- Fix restoring parts while readonly [#62207](https://github.com/ClickHouse/ClickHouse/pull/62207) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix crash in index definition containing SQL UDF [#62225](https://github.com/ClickHouse/ClickHouse/pull/62225) ([vdimir](https://github.com/vdimir)).
- Fixing NULL random seed for generateRandom with analyzer. [#62248](https://github.com/ClickHouse/ClickHouse/pull/62248) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Correctly handle const columns in Distinct Transfom [#62250](https://github.com/ClickHouse/ClickHouse/pull/62250) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix Parts Splitter for queries with the FINAL modifier [#62268](https://github.com/ClickHouse/ClickHouse/pull/62268) ([Nikita Taranov](https://github.com/nickitat)).
- Analyzer: Fix alias to parametrized view resolution [#62274](https://github.com/ClickHouse/ClickHouse/pull/62274) ([Dmitry Novik](https://github.com/novikd)).
- Analyzer: Fix name resolution from parent scopes [#62281](https://github.com/ClickHouse/ClickHouse/pull/62281) ([Dmitry Novik](https://github.com/novikd)).
- Fix argMax with nullable non native numeric column [#62285](https://github.com/ClickHouse/ClickHouse/pull/62285) ([Raúl Marín](https://github.com/Algunenano)).
- Fix BACKUP and RESTORE of a materialized view in Ordinary database [#62295](https://github.com/ClickHouse/ClickHouse/pull/62295) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix data race on scalars in Context [#62305](https://github.com/ClickHouse/ClickHouse/pull/62305) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix primary key in materialized view [#62319](https://github.com/ClickHouse/ClickHouse/pull/62319) ([Murat Khairulin](https://github.com/mxwell)).
- Do not build multithread insert pipeline for tables without support [#62333](https://github.com/ClickHouse/ClickHouse/pull/62333) ([vdimir](https://github.com/vdimir)).
- Fix analyzer with positional arguments in distributed query [#62362](https://github.com/ClickHouse/ClickHouse/pull/62362) ([flynn](https://github.com/ucasfl)).
- Fix filter pushdown from additional_table_filters in Merge engine in analyzer [#62398](https://github.com/ClickHouse/ClickHouse/pull/62398) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix GLOBAL IN table queries with analyzer. [#62409](https://github.com/ClickHouse/ClickHouse/pull/62409) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Respect settings truncate_on_insert/create_new_file_on_insert in s3/hdfs/azure engines during partitioned write [#62425](https://github.com/ClickHouse/ClickHouse/pull/62425) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix backup restore path for AzureBlobStorage [#62447](https://github.com/ClickHouse/ClickHouse/pull/62447) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Fix SimpleSquashingChunksTransform [#62451](https://github.com/ClickHouse/ClickHouse/pull/62451) ([Nikita Taranov](https://github.com/nickitat)).
- Fix capture of nested lambda. [#62462](https://github.com/ClickHouse/ClickHouse/pull/62462) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Avoid crash when reading protobuf with recursive types [#62506](https://github.com/ClickHouse/ClickHouse/pull/62506) ([Raúl Marín](https://github.com/Algunenano)).
- Fix a bug moving one partition from one to itself [#62524](https://github.com/ClickHouse/ClickHouse/pull/62524) ([helifu](https://github.com/helifu)).
- Fix scalar subquery in LIMIT [#62567](https://github.com/ClickHouse/ClickHouse/pull/62567) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix segfault in the experimental and unsupported Hive engine, which we don't like anyway [#62578](https://github.com/ClickHouse/ClickHouse/pull/62578) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix memory leak in groupArraySorted [#62597](https://github.com/ClickHouse/ClickHouse/pull/62597) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix crash in largestTriangleThreeBuckets [#62646](https://github.com/ClickHouse/ClickHouse/pull/62646) ([Raúl Marín](https://github.com/Algunenano)).
- Fix tumble\[Start,End\] and hop\[Start,End\] for bigger resolutions [#62705](https://github.com/ClickHouse/ClickHouse/pull/62705) ([Jordi Villar](https://github.com/jrdi)).
- Fix argMin/argMax combinator state [#62708](https://github.com/ClickHouse/ClickHouse/pull/62708) ([Raúl Marín](https://github.com/Algunenano)).
- Fix temporary data in cache failing because of cache lock contention optimization [#62715](https://github.com/ClickHouse/ClickHouse/pull/62715) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix crash in function `mergeTreeIndex` [#62762](https://github.com/ClickHouse/ClickHouse/pull/62762) ([Anton Popov](https://github.com/CurtizJ)).
- fix: update: nested materialized columns: size check fixes [#62773](https://github.com/ClickHouse/ClickHouse/pull/62773) ([Eliot Hautefeuille](https://github.com/hileef)).
- Fix FINAL modifier is not respected in CTE with analyzer [#62811](https://github.com/ClickHouse/ClickHouse/pull/62811) ([Duc Canh Le](https://github.com/canhld94)).
- Fix crash in function `formatRow` with `JSON` format and HTTP interface [#62840](https://github.com/ClickHouse/ClickHouse/pull/62840) ([Anton Popov](https://github.com/CurtizJ)).
- Azure: fix building final url from endpoint object [#62850](https://github.com/ClickHouse/ClickHouse/pull/62850) ([Daniel Pozo Escalona](https://github.com/danipozo)).
- Fix GCD codec [#62853](https://github.com/ClickHouse/ClickHouse/pull/62853) ([Nikita Taranov](https://github.com/nickitat)).
- Fix LowCardinality(Nullable) key in hyperrectangle [#62866](https://github.com/ClickHouse/ClickHouse/pull/62866) ([Amos Bird](https://github.com/amosbird)).
- Fix fromUnixtimestamp in joda syntax while the input value beyond UInt32 [#62901](https://github.com/ClickHouse/ClickHouse/pull/62901) ([KevinyhZou](https://github.com/KevinyhZou)).
- Disable optimize_rewrite_aggregate_function_with_if for sum(nullable) [#62912](https://github.com/ClickHouse/ClickHouse/pull/62912) ([Raúl Marín](https://github.com/Algunenano)).
- Fix PREWHERE for StorageBuffer with different source table column types. [#62916](https://github.com/ClickHouse/ClickHouse/pull/62916) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix temporary data in cache incorrectly processing failure of cache key directory creation [#62925](https://github.com/ClickHouse/ClickHouse/pull/62925) ([Kseniia Sumarokova](https://github.com/kssenii)).
- gRPC: fix crash on IPv6 peer connection [#62978](https://github.com/ClickHouse/ClickHouse/pull/62978) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Fix possible CHECKSUM_DOESNT_MATCH (and others) during replicated fetches [#62987](https://github.com/ClickHouse/ClickHouse/pull/62987) ([Azat Khuzhin](https://github.com/azat)).
- Fix terminate with uncaught exception in temporary data in cache [#62998](https://github.com/ClickHouse/ClickHouse/pull/62998) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix optimize_rewrite_aggregate_function_with_if implicit cast [#62999](https://github.com/ClickHouse/ClickHouse/pull/62999) ([Raúl Marín](https://github.com/Algunenano)).
- Fix unhandled exception in ~RestorerFromBackup [#63040](https://github.com/ClickHouse/ClickHouse/pull/63040) ([Vitaly Baranov](https://github.com/vitlibar)).
- Do not remove server constants from GROUP BY key for secondary query. [#63047](https://github.com/ClickHouse/ClickHouse/pull/63047) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix incorrect judgement of of monotonicity of function abs [#63097](https://github.com/ClickHouse/ClickHouse/pull/63097) ([Duc Canh Le](https://github.com/canhld94)).
- Set server name for SSL handshake in MongoDB engine [#63122](https://github.com/ClickHouse/ClickHouse/pull/63122) ([Alexander Gololobov](https://github.com/davenger)).
- Use user specified db instead of "config" for MongoDB wire protocol version check [#63126](https://github.com/ClickHouse/ClickHouse/pull/63126) ([Alexander Gololobov](https://github.com/davenger)).

### <a id="243"></a> ClickHouse 24.3 LTS 版本,2024-03-27 {#a-id243a-clickhouse-release-243-lts-2024-03-27}


#### 升级说明 {#upgrade-notes-1}

- 设置 `allow_experimental_analyzer` 现已默认启用,它将查询分析切换到新的实现,具有更好的兼容性和功能完整性。"analyzer" 功能现在被视为 beta 版而非实验性功能。您可以通过将 `compatibility` 设置为 `24.2` 或禁用 `allow_experimental_analyzer` 设置来恢复旧行为。观看 [YouTube 视频](https://www.youtube.com/watch?v=zhrOYQpgvkk)。
- ClickHouse 允许 String 数据类型中包含任意二进制数据,通常为 UTF-8 编码。Parquet/ORC/Arrow 的 String 仅支持 UTF-8。因此,您可以选择将 ClickHouse String 数据类型映射到 Arrow 的哪种数据类型 - String 或 Binary。这由设置 `output_format_parquet_string_as_string`、`output_format_orc_string_as_string`、`output_format_arrow_string_as_string` 控制。虽然 Binary 更加准确和兼容,但在大多数情况下,默认使用 String 更符合用户期望。Parquet/ORC/Arrow 支持多种压缩方法,包括 lz4 和 zstd。ClickHouse 支持所有这些压缩方法。一些功能较弱的工具缺乏对更快的 `lz4` 压缩方法的支持,因此我们默认设置为 `zstd`。这由设置 `output_format_parquet_compression_method`、`output_format_orc_compression_method` 和 `output_format_arrow_compression_method` 控制。我们将 Parquet 和 ORC 的默认值更改为 `zstd`,但 Arrow 未更改(它主要用于底层使用场景)。[#61817](https://github.com/ClickHouse/ClickHouse/pull/61817) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 在新的 ClickHouse 版本中,如果所有参数都是 Float64,函数 `geoDistance`、`greatCircleDistance` 和 `greatCircleAngle` 将使用 64 位双精度浮点数据类型进行内部计算和返回类型。这解决了 [#58476](https://github.com/ClickHouse/ClickHouse/issues/58476)。在以前的版本中,该函数始终使用 Float32。您可以通过将 `geo_distance_returns_float64_on_float64_arguments` 设置为 `false` 或将 `compatibility` 设置为 `24.2` 或更早版本来切换到旧行为。[#61848](https://github.com/ClickHouse/ClickHouse/pull/61848) ([Alexey Milovidov](https://github.com/alexey-milovidov))。与 [Geet Patel](https://github.com/geetptl) 共同完成。
- 已过时的内存数据部分自 23.5 版本起已被弃用,自 23.10 版本起不再支持。现在剩余的代码已被移除。这是 [#55186](https://github.com/ClickHouse/ClickHouse/issues/55186) 和 [#45409](https://github.com/ClickHouse/ClickHouse/issues/45409) 的延续。您不太可能使用过内存数据部分,因为它们仅在 23.5 版本之前可用,并且只有在您通过为 MergeTree 表指定相应的 SETTINGS 手动启用它们时才可用。要检查是否有内存数据部分,请运行以下查询:`SELECT part_type, count() FROM system.parts GROUP BY part_type ORDER BY part_type`。要禁用内存数据部分的使用,请执行 `ALTER TABLE ... MODIFY SETTING min_bytes_for_compact_part = DEFAULT, min_rows_for_compact_part = DEFAULT`。在从旧的 ClickHouse 版本升级之前,首先检查您是否没有内存数据部分。如果存在内存数据部分,请先禁用它们,然后等待直到没有内存数据部分后再继续升级。[#61127](https://github.com/ClickHouse/ClickHouse/pull/61127) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 将 `system.zookeeper` 表中的列名从 `duration_ms` 更改为 `duration_microseconds`,以反映持续时间实际上是以微秒为单位的。[#60774](https://github.com/ClickHouse/ClickHouse/pull/60774) ([Duc Canh Le](https://github.com/canhld94))。
- 当查询级设置 `async_insert` 和 `deduplicate_blocks_in_dependent_materialized_views` 同时启用时,拒绝传入的 INSERT 查询。此行为由设置 `throw_if_deduplication_in_dependent_materialized_views_enabled_with_async_insert` 控制,默认启用。这是 https://github.com/ClickHouse/ClickHouse/pull/59699 的延续,用于解除 https://github.com/ClickHouse/ClickHouse/pull/59915 的阻塞。[#60888](https://github.com/ClickHouse/ClickHouse/pull/60888) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 工具 `clickhouse-copier` 已移至 GitHub 上的独立仓库:https://github.com/ClickHouse/copier。它不再包含在安装包中,但仍可作为单独下载提供。这解决了:[#60734](https://github.com/ClickHouse/ClickHouse/issues/60734) 这解决了:[#60540](https://github.com/ClickHouse/ClickHouse/issues/60540) 这解决了:[#60250](https://github.com/ClickHouse/ClickHouse/issues/60250) 这解决了:[#52917](https://github.com/ClickHouse/ClickHouse/issues/52917) 这解决了:[#51140](https://github.com/ClickHouse/ClickHouse/issues/51140) 这解决了:[#47517](https://github.com/ClickHouse/ClickHouse/issues/47517) 这解决了:[#47189](https://github.com/ClickHouse/ClickHouse/issues/47189) 这解决了:[#46598](https://github.com/ClickHouse/ClickHouse/issues/46598) 这解决了:[#40257](https://github.com/ClickHouse/ClickHouse/issues/40257) 这解决了:[#36504](https://github.com/ClickHouse/ClickHouse/issues/36504) 这解决了:[#35485](https://github.com/ClickHouse/ClickHouse/issues/35485) 这解决了:[#33702](https://github.com/ClickHouse/ClickHouse/issues/33702) 这解决了:[#26702](https://github.com/ClickHouse/ClickHouse/issues/26702)。
- 为了提高与 MySQL 的兼容性,兼容性别名 `locate` 现在默认接受参数 `(needle, haystack[, start_pos])`。可以通过设置 `function_locate_has_mysql_compatible_argument_order = 0` 来恢复以前的行为 `(haystack, needle, [, start_pos])`。[#61092](https://github.com/ClickHouse/ClickHouse/pull/61092) ([Robert Schulze](https://github.com/rschu1ze))。
- 默认禁止在 `MergeTree` 表的 `ORDER BY` 中使用 `SimpleAggregateFunction`(类似于 `AggregateFunction` 被禁止,但它们被禁止是因为它们不可比较)(使用 `allow_suspicious_primary_key` 来允许它们)。[#61399](https://github.com/ClickHouse/ClickHouse/pull/61399) ([Azat Khuzhin](https://github.com/azat))。
- `Ordinary` 数据库引擎已被弃用。如果您的服务器正在使用它,您将在 clickhouse-client 中收到警告。这解决了 [#52229](https://github.com/ClickHouse/ClickHouse/issues/52229)。[#56942](https://github.com/ClickHouse/ClickHouse/pull/56942) ([shabroo](https://github.com/shabroo))。

#### 新功能 {#new-feature-9}

- 支持以 `tar` 格式读写备份(除 `zip` 格式外)。[#59535](https://github.com/ClickHouse/ClickHouse/pull/59535) ([josh-hildred](https://github.com/josh-hildred))。
- 实现了对 S3 Express 存储桶的支持。[#59965](https://github.com/ClickHouse/ClickHouse/pull/59965) ([Nikita Taranov](https://github.com/nickitat))。
- 允许从不同磁盘附加数据部分(使用复制而非硬链接)。[#60112](https://github.com/ClickHouse/ClickHouse/pull/60112) ([Unalian](https://github.com/Unalian))。
- 支持大小受限的 `Memory` 表:通过设置 `min_bytes_to_keep`、`max_bytes_to_keep`、`min_rows_to_keep` 和 `max_rows_to_keep` 进行控制。[#60612](https://github.com/ClickHouse/ClickHouse/pull/60612) ([Jake Bamrah](https://github.com/JakeBamrah))。
- 对等待查询和执行查询的数量分别设置限制。新增服务器设置 `max_waiting_queries`,用于限制因 `async_load_databases` 而等待的查询数量。现有的执行查询数量限制不再计入等待查询。[#61053](https://github.com/ClickHouse/ClickHouse/pull/61053) ([Sergei Trifonov](https://github.com/serxa))。
- 新增系统表 `system.keywords`,包含解析器中的所有关键字。主要用于改进模糊测试和语法高亮。[#51808](https://github.com/ClickHouse/ClickHouse/pull/51808) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 新增对 `ATTACH PARTITION ALL` 的支持。[#61107](https://github.com/ClickHouse/ClickHouse/pull/61107) ([Kirill Nikiforov](https://github.com/allmazz))。
- 新增函数 `getClientHTTPHeader`。此功能解决了 [#54665](https://github.com/ClickHouse/ClickHouse/issues/54665)。与 @lingtaolf 共同完成。[#61820](https://github.com/ClickHouse/ClickHouse/pull/61820) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 新增表函数 `generate_series`(作为 PostgreSQL 兼容性别名,对应现有的 `numbers` 函数)。该函数生成包含自然数等差数列的表。[#59390](https://github.com/ClickHouse/ClickHouse/pull/59390) ([divanik](https://github.com/divanik))。
- 为 `topK`/`topkWeighed` 新增支持模式,可返回值的计数及其误差。[#54508](https://github.com/ClickHouse/ClickHouse/pull/54508) ([UnamedRus](https://github.com/UnamedRus))。
- 新增函数 `toMillisecond`,返回 `DateTime` 或 `DateTime64` 类型值的毫秒部分。[#60281](https://github.com/ClickHouse/ClickHouse/pull/60281) ([Shaun Struwig](https://github.com/Blargian))。
- 允许为 clickhouse-server 配置 HTTP 重定向处理程序。例如,可以将 `/` 重定向到 Play UI。[#60390](https://github.com/ClickHouse/ClickHouse/pull/60390) ([Alexey Milovidov](https://github.com/alexey-milovidov))。


#### 性能改进 {#performance-improvement-9}

- 优化了 `dotProduct` 函数,避免不必要且开销较大的内存复制。[#60928](https://github.com/ClickHouse/ClickHouse/pull/60928) ([Robert Schulze](https://github.com/rschu1ze)).
- 256 位整数的打印速度提升 30 倍。[#61100](https://github.com/ClickHouse/ClickHouse/pull/61100) ([Raúl Marín](https://github.com/Algunenano)).
- 如果表的主键包含大量无用列,则不再将它们保留在内存中。这由新设置 `primary_key_ratio_of_unique_prefix_values_to_skip_suffix_columns` 控制,默认值为 `0.9`,这意味着:对于复合主键,如果某列的值变化频率至少达到 0.9,则不会加载其后的列。[#60255](https://github.com/ClickHouse/ClickHouse/pull/60255) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- 改进了涉及多个 `Nullable` 列时序列化聚合方法的性能。[#55809](https://github.com/ClickHouse/ClickHouse/pull/55809) ([Amos Bird](https://github.com/amosbird)).
- 延迟构建 JSON 输出以提升 ALL JOIN 的性能。[#58278](https://github.com/ClickHouse/ClickHouse/pull/58278) ([LiuNeng](https://github.com/liuneng1994)).
- 使与外部服务(如 AWS S3)的 HTTP/HTTPS 连接在所有使用场景下可复用,即使响应为 3xx 或 4xx。[#58845](https://github.com/ClickHouse/ClickHouse/pull/58845) ([Sema Checherinda](https://github.com/CheSema)).
- 改进了聚合函数 `argMin` / `argMax` / `any` / `anyLast` / `anyHeavy`,以及 `ORDER BY {u8/u16/u32/u64/i8/i16/u32/i64) LIMIT 1` 查询。[#58640](https://github.com/ClickHouse/ClickHouse/pull/58640) ([Raúl Marín](https://github.com/Algunenano)).
- 对列过滤器进行了简单优化。在某些情况下,峰值内存可降至原来的 44%。[#59698](https://github.com/ClickHouse/ClickHouse/pull/59698) ([李扬](https://github.com/taiyang-li)).
- 当结果类型的底层类型为数字时,以列式方式执行 `multiIf` 函数。[#60384](https://github.com/ClickHouse/ClickHouse/pull/60384) ([李扬](https://github.com/taiyang-li)).
- 互斥锁速度更快(提升近 2 倍)。[#60823](https://github.com/ClickHouse/ClickHouse/pull/60823) ([Azat Khuzhin](https://github.com/azat)).
- 在分布式查询结束时并行释放多个连接。[#60845](https://github.com/ClickHouse/ClickHouse/pull/60845) ([lizhuoyu5](https://github.com/lzydmxy)).
- 优化了 Nullable 数字或 Nullable 字符串列之间的数据移动,从而改进了一些微基准测试。[#60846](https://github.com/ClickHouse/ClickHouse/pull/60846) ([李扬](https://github.com/taiyang-li)).
- 文件系统缓存操作受锁竞争的影响将减少。[#61066](https://github.com/ClickHouse/ClickHouse/pull/61066) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- 通过防止编译器的错误优化来优化数组连接和其他 JOIN。关闭 [#61074](https://github.com/ClickHouse/ClickHouse/issues/61074). [#61075](https://github.com/ClickHouse/ClickHouse/pull/61075) ([李扬](https://github.com/taiyang-li)).
- 如果包含语法错误的查询中使用了带正则表达式的 `COLUMNS` 匹配器,则在解析器回溯期间会每次都编译正则表达式,而不是只编译一次。这是一个根本性错误。编译后的正则表达式被放入 AST 中。但 AST 中的 A 代表"抽象",意味着它不应包含重量级对象。AST 的部分内容可以在解析过程中创建和丢弃,包括大量回溯。这导致解析端变慢,从而允许只读用户发起 DoS 攻击。但主要问题是它阻碍了模糊测试器的进展。[#61543](https://github.com/ClickHouse/ClickHouse/pull/61543) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- 添加了新的分析器遍历以优化单个值的 IN 运算符。[#61564](https://github.com/ClickHouse/ClickHouse/pull/61564) ([LiuNeng](https://github.com/liuneng1994)).
- DNSResolver 会打乱已解析的 IP 集合,这对于均匀利用 AWS S3 的多个端点是必需的。[#60965](https://github.com/ClickHouse/ClickHouse/pull/60965) ([Sema Checherinda](https://github.com/CheSema)).

#### 实验性功能 {#experimental-feature-7}

- 支持 Azure Blob 存储的并行读取。这提升了实验性 Azure 对象存储的性能。[#61503](https://github.com/ClickHouse/ClickHouse/pull/61503) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- 为 Azure Blob 存储添加类似 S3 的异步 WriteBuffer。这提升了实验性 Azure 对象存储的性能。[#59929](https://github.com/ClickHouse/ClickHouse/pull/59929) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- 使用 Azure Blob Storage 时,为备份 I/O 使用托管标识。添加一个设置以防止 ClickHouse 尝试创建不存在的容器,该操作需要存储账户级别的权限。[#61785](https://github.com/ClickHouse/ClickHouse/pull/61785) ([Daniel Pozo Escalona](https://github.com/danipozo)).
- 添加设置 `parallel_replicas_allow_in_with_subquery = 1`,允许 IN 子查询与并行副本配合工作。[#60950](https://github.com/ClickHouse/ClickHouse/pull/60950) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- "零拷贝"复制的一项变更:当表被删除时,与该表相关的所有零拷贝锁必须被释放。包含这些锁的目录也必须被删除。[#57575](https://github.com/ClickHouse/ClickHouse/pull/57575) ([Sema Checherinda](https://github.com/CheSema)).


#### 改进 {#improvement-9}

- Use `MergeTree` as a default table engine. [#60524](https://github.com/ClickHouse/ClickHouse/pull/60524) ([Alexey Milovidov](https://github.com/alexey-milovidov))
- Enable `output_format_pretty_row_numbers` by default. It is better for usability. [#61791](https://github.com/ClickHouse/ClickHouse/pull/61791) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- In the previous version, some numbers in Pretty formats were not pretty enough. [#61794](https://github.com/ClickHouse/ClickHouse/pull/61794) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- A long value in Pretty formats won't be cut if it is the single value in the resultset, such as in the result of the `SHOW CREATE TABLE` query. [#61795](https://github.com/ClickHouse/ClickHouse/pull/61795) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Similarly to `clickhouse-local`, `clickhouse-client` will accept the `--output-format` option as a synonym to the `--format` option. This closes [#59848](https://github.com/ClickHouse/ClickHouse/issues/59848). [#61797](https://github.com/ClickHouse/ClickHouse/pull/61797) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- If stdout is a terminal and the output format is not specified, `clickhouse-client` and similar tools will use `PrettyCompact` by default, similarly to the interactive mode. `clickhouse-client` and `clickhouse-local` will handle command line arguments for input and output formats in a unified fashion. This closes [#61272](https://github.com/ClickHouse/ClickHouse/issues/61272). [#61800](https://github.com/ClickHouse/ClickHouse/pull/61800) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Underscore digit groups in Pretty formats for better readability. This is controlled by a new setting, `output_format_pretty_highlight_digit_groups`. [#61802](https://github.com/ClickHouse/ClickHouse/pull/61802) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Add ability to override initial INSERT settings via `SYSTEM FLUSH DISTRIBUTED`. [#61832](https://github.com/ClickHouse/ClickHouse/pull/61832) ([Azat Khuzhin](https://github.com/azat)).
- Enable processors profiling (time spent/in and out bytes for sorting, aggregation, ...) by default. [#61096](https://github.com/ClickHouse/ClickHouse/pull/61096) ([Azat Khuzhin](https://github.com/azat)).
- Support files without format extension in Filesystem database. [#60795](https://github.com/ClickHouse/ClickHouse/pull/60795) ([Kruglov Pavel](https://github.com/Avogar)).
- Make all format names case insensitive, like Tsv, or TSV, or tsv, or even rowbinary. [#60420](https://github.com/ClickHouse/ClickHouse/pull/60420) ([豪肥肥](https://github.com/HowePa)). I appreciate if you will continue to write it correctly, e.g., `JSON` 😇, not `Json` 🤮, but we don't mind if you spell it as you prefer.
- Added `none_only_active` mode for `distributed_ddl_output_mode` setting. [#60340](https://github.com/ClickHouse/ClickHouse/pull/60340) ([Alexander Tokmakov](https://github.com/tavplubix)).
- The advanced dashboard has slightly better colors for multi-line graphs. [#60391](https://github.com/ClickHouse/ClickHouse/pull/60391) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- The Advanced dashboard now has controls always visible on scrolling. This allows you to add a new chart without scrolling up. [#60692](https://github.com/ClickHouse/ClickHouse/pull/60692) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- While running the `MODIFY COLUMN` query for materialized views, check the inner table's structure to ensure every column exists. [#47427](https://github.com/ClickHouse/ClickHouse/pull/47427) ([sunny](https://github.com/sunny19930321)).
- String types and Enums can be used in the same context, such as: arrays, UNION queries, conditional expressions. This closes [#60726](https://github.com/ClickHouse/ClickHouse/issues/60726). [#60727](https://github.com/ClickHouse/ClickHouse/pull/60727) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Allow declaring Enums in the structure of external data for query processing (this is an immediate temporary table that you can provide for your query). [#57857](https://github.com/ClickHouse/ClickHouse/pull/57857) ([Duc Canh Le](https://github.com/canhld94)).
- Consider lightweight deleted rows when selecting parts to merge, so the disk size of the resulting part will be estimated better. [#58223](https://github.com/ClickHouse/ClickHouse/pull/58223) ([Zhuo Qiu](https://github.com/jewelzqiu)).
- Added comments for columns for more system tables. Continuation of https://github.com/ClickHouse/ClickHouse/pull/58356. [#59016](https://github.com/ClickHouse/ClickHouse/pull/59016) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Now we can use virtual columns in PREWHERE. It's worthwhile for non-const virtual columns like `_part_offset`. [#59033](https://github.com/ClickHouse/ClickHouse/pull/59033) ([Amos Bird](https://github.com/amosbird)). Improved overall usability of virtual columns. Now it is allowed to use virtual columns in `PREWHERE` (it's worthwhile for non-const virtual columns like `_part_offset`). Now a builtin documentation is available for virtual columns as a comment of column in `DESCRIBE` query with enabled setting `describe_include_virtual_columns`. [#60205](https://github.com/ClickHouse/ClickHouse/pull/60205) ([Anton Popov](https://github.com/CurtizJ)).
- Instead of using a constant key, now object storage generates key for determining remove objects capability. [#59495](https://github.com/ClickHouse/ClickHouse/pull/59495) ([Sema Checherinda](https://github.com/CheSema)).
- Allow "local" as object storage type instead of "local_blob_storage". [#60165](https://github.com/ClickHouse/ClickHouse/pull/60165) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Parallel flush of pending INSERT blocks of Distributed engine on `DETACH`/server shutdown and `SYSTEM FLUSH DISTRIBUTED` (Parallelism will work only if you have multi-disk policy for a table (like everything in the Distributed engine right now)). [#60225](https://github.com/ClickHouse/ClickHouse/pull/60225) ([Azat Khuzhin](https://github.com/azat)).
- Add a setting to force read-through cache for merges. [#60308](https://github.com/ClickHouse/ClickHouse/pull/60308) ([Kseniia Sumarokova](https://github.com/kssenii)).
- An improvement for the MySQL compatibility protocol. The issue [#57598](https://github.com/ClickHouse/ClickHouse/issues/57598) mentions a variant behaviour regarding transaction handling. An issued COMMIT/ROLLBACK when no transaction is active is reported as an error contrary to MySQL behaviour. [#60338](https://github.com/ClickHouse/ClickHouse/pull/60338) ([PapaToemmsn](https://github.com/PapaToemmsn)).
- Function `substring` now has a new alias `byteSlice`. [#60494](https://github.com/ClickHouse/ClickHouse/pull/60494) ([Robert Schulze](https://github.com/rschu1ze)).
- Renamed server setting `dns_cache_max_size` to `dns_cache_max_entries` to reduce ambiguity. [#60500](https://github.com/ClickHouse/ClickHouse/pull/60500) ([Kirill Nikiforov](https://github.com/allmazz)).
- `SHOW INDEX | INDEXES | INDICES | KEYS` no longer sorts by the primary key columns (which was unintuitive). [#60514](https://github.com/ClickHouse/ClickHouse/pull/60514) ([Robert Schulze](https://github.com/rschu1ze)).
- Keeper improvement: abort during startup if an invalid snapshot is detected to avoid data loss. [#60537](https://github.com/ClickHouse/ClickHouse/pull/60537) ([Antonio Andelic](https://github.com/antonio2368)).
- Update tzdata to 2024a. [#60768](https://github.com/ClickHouse/ClickHouse/pull/60768) ([Raúl Marín](https://github.com/Algunenano)).
- Keeper improvement: support `leadership_expiry_ms` in Keeper's settings. [#60806](https://github.com/ClickHouse/ClickHouse/pull/60806) ([Brokenice0415](https://github.com/Brokenice0415)).
- Always infer exponential numbers in JSON formats regardless of the setting `input_format_try_infer_exponent_floats`. Add setting `input_format_json_use_string_type_for_ambiguous_paths_in_named_tuples_inference_from_objects` that allows to use String type for ambiguous paths instead of an exception during named Tuples inference from JSON objects. [#60808](https://github.com/ClickHouse/ClickHouse/pull/60808) ([Kruglov Pavel](https://github.com/Avogar)).
- Add support for `START TRANSACTION` syntax typically used in MySQL syntax, resolving https://github.com/ClickHouse/ClickHouse/discussions/60865. [#60886](https://github.com/ClickHouse/ClickHouse/pull/60886) ([Zach Naimon](https://github.com/ArctypeZach)).
- Add a flag for the full-sorting merge join algorithm to treat null as biggest/smallest. So the behavior can be compitable with other SQL systems, like Apache Spark. [#60896](https://github.com/ClickHouse/ClickHouse/pull/60896) ([loudongfeng](https://github.com/loudongfeng)).
- Support detect output format by file exctension in `clickhouse-client` and `clickhouse-local`. [#61036](https://github.com/ClickHouse/ClickHouse/pull/61036) ([豪肥肥](https://github.com/HowePa)).
- Update memory limit in runtime when Linux's CGroups value changed. [#61049](https://github.com/ClickHouse/ClickHouse/pull/61049) ([Han Fei](https://github.com/hanfei1991)).
- Add the function `toUInt128OrZero`, which was missed by mistake (the mistake is related to https://github.com/ClickHouse/ClickHouse/pull/945). The compatibility aliases `FROM_UNIXTIME` and `DATE_FORMAT` (they are not ClickHouse-native and only exist for MySQL compatibility) have been made case insensitive, as expected for SQL-compatibility aliases. [#61114](https://github.com/ClickHouse/ClickHouse/pull/61114) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Improvements for the access checks, allowing to revoke of unpossessed rights in case the target user doesn't have the revoking grants either. Example: `GRANT SELECT ON *.* TO user1; REVOKE SELECT ON system.* FROM user1;`. [#61115](https://github.com/ClickHouse/ClickHouse/pull/61115) ([pufit](https://github.com/pufit)).
- Fix `has()` function with `Nullable` column (fixes [#60214](https://github.com/ClickHouse/ClickHouse/issues/60214)). [#61249](https://github.com/ClickHouse/ClickHouse/pull/61249) ([Mikhail Koviazin](https://github.com/mkmkme)).
- Now it's possible to specify the attribute `merge="true"` in config substitutions for subtrees `<include from_zk="/path" merge="true">`. In case this attribute specified, clickhouse will merge subtree with existing configuration, otherwise default behavior is append new content to configuration. [#61299](https://github.com/ClickHouse/ClickHouse/pull/61299) ([alesapin](https://github.com/alesapin)).
- Add async metrics for virtual memory mappings: `VMMaxMapCount` & `VMNumMaps`. Closes [#60662](https://github.com/ClickHouse/ClickHouse/issues/60662). [#61354](https://github.com/ClickHouse/ClickHouse/pull/61354) ([Tuan Pham Anh](https://github.com/tuanpavn)).
- Use `temporary_files_codec` setting in all places where we create temporary data, for example external memory sorting and external memory GROUP BY. Before it worked only in `partial_merge` JOIN algorithm. [#61456](https://github.com/ClickHouse/ClickHouse/pull/61456) ([Maksim Kita](https://github.com/kitaisreal)).
- Add a new setting `max_parser_backtracks` which allows to limit the complexity of query parsing. [#61502](https://github.com/ClickHouse/ClickHouse/pull/61502) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Less contention during dynamic resize of the filesystem cache. [#61524](https://github.com/ClickHouse/ClickHouse/pull/61524) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Disallow sharded mode of StorageS3 queue, because it will be rewritten. [#61537](https://github.com/ClickHouse/ClickHouse/pull/61537) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fixed typo: from `use_leagcy_max_level` to `use_legacy_max_level`. [#61545](https://github.com/ClickHouse/ClickHouse/pull/61545) ([William Schoeffel](https://github.com/wiledusc)).
- Remove some duplicate entries in `system.blob_storage_log`. [#61622](https://github.com/ClickHouse/ClickHouse/pull/61622) ([YenchangChan](https://github.com/YenchangChan)).
- Added `current_user` function as a compatibility alias for MySQL. [#61770](https://github.com/ClickHouse/ClickHouse/pull/61770) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fix inconsistent floating point aggregate function states in mixed x86-64 / ARM clusters [#60610](https://github.com/ClickHouse/ClickHouse/pull/60610) ([Harry Lee](https://github.com/HarryLeeIBM)).

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-5}

- 实时查询分析器现已支持 AArch64 架构。在之前的版本中,仅当程序未在系统调用中耗时时才能正常工作。[#60807](https://github.com/ClickHouse/ClickHouse/pull/60807) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 已将 ClickHouse 版本信息添加到 Docker 标签中。关闭 [#54224](https://github.com/ClickHouse/ClickHouse/issues/54224)。[#60949](https://github.com/ClickHouse/ClickHouse/pull/60949) ([Nikolay Monkov](https://github.com/nikmonkov))。
- 将 `prqlc` 升级至 0.11.3 版本。[#60616](https://github.com/ClickHouse/ClickHouse/pull/60616) ([Maximilian Roos](https://github.com/max-sixty))。
- 在 `clickhouse-local` 中添加通用查询文本模糊测试器。[#61508](https://github.com/ClickHouse/ClickHouse/pull/61508) ([Alexey Milovidov](https://github.com/alexey-milovidov))。


#### 错误修复(官方稳定版本中用户可见的异常行为) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-7}

- Fix finished_mutations_to_keep=0 for MergeTree (as docs says 0 is to keep everything) [#60031](https://github.com/ClickHouse/ClickHouse/pull/60031) ([Azat Khuzhin](https://github.com/azat)).
- Something was wrong with the FINAL optimization, here is how the author describes it: "PartsSplitter invalid ranges for the same part". [#60041](https://github.com/ClickHouse/ClickHouse/pull/60041) ([Maksim Kita](https://github.com/kitaisreal)).
- Something was wrong with Apache Hive, which is experimental and not supported. [#60262](https://github.com/ClickHouse/ClickHouse/pull/60262) ([shanfengp](https://github.com/Aed-p)).
- An improvement for experimental parallel replicas: force reanalysis if parallel replicas changed [#60362](https://github.com/ClickHouse/ClickHouse/pull/60362) ([Raúl Marín](https://github.com/Algunenano)).
- Fix usage of plain metadata type with new disks configuration option [#60396](https://github.com/ClickHouse/ClickHouse/pull/60396) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Try to fix logical error 'Cannot capture column because it has incompatible type' in mapContainsKeyLike [#60451](https://github.com/ClickHouse/ClickHouse/pull/60451) ([Kruglov Pavel](https://github.com/Avogar)).
- Avoid calculation of scalar subqueries for CREATE TABLE. [#60464](https://github.com/ClickHouse/ClickHouse/pull/60464) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix deadlock in parallel parsing when lots of rows are skipped due to errors [#60516](https://github.com/ClickHouse/ClickHouse/pull/60516) ([Kruglov Pavel](https://github.com/Avogar)).
- Something was wrong with experimental KQL (Kusto) support: fix `max_query_size_for_kql_compound_operator`: [#60534](https://github.com/ClickHouse/ClickHouse/pull/60534) ([Yong Wang](https://github.com/kashwy)).
- Keeper fix: add timeouts when waiting for commit logs [#60544](https://github.com/ClickHouse/ClickHouse/pull/60544) ([Antonio Andelic](https://github.com/antonio2368)).
- Don't output number tips for date types [#60577](https://github.com/ClickHouse/ClickHouse/pull/60577) ([Raúl Marín](https://github.com/Algunenano)).
- Fix reading from MergeTree with non-deterministic functions in filter [#60586](https://github.com/ClickHouse/ClickHouse/pull/60586) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix logical error on bad compatibility setting value type [#60596](https://github.com/ClickHouse/ClickHouse/pull/60596) ([Kruglov Pavel](https://github.com/Avogar)).
- fix(prql): Robust panic handler [#60615](https://github.com/ClickHouse/ClickHouse/pull/60615) ([Maximilian Roos](https://github.com/max-sixty)).
- Fix `intDiv` for decimal and date arguments [#60672](https://github.com/ClickHouse/ClickHouse/pull/60672) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fix: expand CTE in alter modify query [#60682](https://github.com/ClickHouse/ClickHouse/pull/60682) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix system.parts for non-Atomic/Ordinary database engine (i.e. Memory) [#60689](https://github.com/ClickHouse/ClickHouse/pull/60689) ([Azat Khuzhin](https://github.com/azat)).
- Fix "Invalid storage definition in metadata file" for parameterized views [#60708](https://github.com/ClickHouse/ClickHouse/pull/60708) ([Azat Khuzhin](https://github.com/azat)).
- Fix buffer overflow in CompressionCodecMultiple [#60731](https://github.com/ClickHouse/ClickHouse/pull/60731) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Remove nonsense from SQL/JSON [#60738](https://github.com/ClickHouse/ClickHouse/pull/60738) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Remove wrong assertion in aggregate function quantileGK [#60740](https://github.com/ClickHouse/ClickHouse/pull/60740) ([李扬](https://github.com/taiyang-li)).
- Fix insert-select + insert_deduplication_token bug by setting streams to 1 [#60745](https://github.com/ClickHouse/ClickHouse/pull/60745) ([Jordi Villar](https://github.com/jrdi)).
- Prevent setting custom metadata headers on unsupported multipart upload operations [#60748](https://github.com/ClickHouse/ClickHouse/pull/60748) ([Francisco J. Jurado Moreno](https://github.com/Beetelbrox)).
- Fix toStartOfInterval [#60763](https://github.com/ClickHouse/ClickHouse/pull/60763) ([Andrey Zvonov](https://github.com/zvonand)).
- Fix crash in arrayEnumerateRanked [#60764](https://github.com/ClickHouse/ClickHouse/pull/60764) ([Raúl Marín](https://github.com/Algunenano)).
- Fix crash when using input() in INSERT SELECT JOIN [#60765](https://github.com/ClickHouse/ClickHouse/pull/60765) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix crash with different allow_experimental_analyzer value in subqueries [#60770](https://github.com/ClickHouse/ClickHouse/pull/60770) ([Dmitry Novik](https://github.com/novikd)).
- Remove recursion when reading from S3 [#60849](https://github.com/ClickHouse/ClickHouse/pull/60849) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix possible stuck on error in HashedDictionaryParallelLoader [#60926](https://github.com/ClickHouse/ClickHouse/pull/60926) ([vdimir](https://github.com/vdimir)).
- Fix async RESTORE with Replicated database (experimental feature) [#60934](https://github.com/ClickHouse/ClickHouse/pull/60934) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix deadlock in async inserts to `Log` tables via native protocol [#61055](https://github.com/ClickHouse/ClickHouse/pull/61055) ([Anton Popov](https://github.com/CurtizJ)).
- Fix lazy execution of default argument in dictGetOrDefault for RangeHashedDictionary [#61196](https://github.com/ClickHouse/ClickHouse/pull/61196) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix multiple bugs in groupArraySorted [#61203](https://github.com/ClickHouse/ClickHouse/pull/61203) ([Raúl Marín](https://github.com/Algunenano)).
- Fix Keeper reconfig for standalone binary [#61233](https://github.com/ClickHouse/ClickHouse/pull/61233) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix usage of session_token in S3 engine [#61234](https://github.com/ClickHouse/ClickHouse/pull/61234) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix possible incorrect result of aggregate function `uniqExact` [#61257](https://github.com/ClickHouse/ClickHouse/pull/61257) ([Anton Popov](https://github.com/CurtizJ)).
- Fix bugs in show database [#61269](https://github.com/ClickHouse/ClickHouse/pull/61269) ([Raúl Marín](https://github.com/Algunenano)).
- Fix logical error in RabbitMQ storage with MATERIALIZED columns [#61320](https://github.com/ClickHouse/ClickHouse/pull/61320) ([vdimir](https://github.com/vdimir)).
- Fix CREATE OR REPLACE DICTIONARY [#61356](https://github.com/ClickHouse/ClickHouse/pull/61356) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix ATTACH query with external ON CLUSTER [#61365](https://github.com/ClickHouse/ClickHouse/pull/61365) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix consecutive keys optimization for nullable keys [#61393](https://github.com/ClickHouse/ClickHouse/pull/61393) ([Anton Popov](https://github.com/CurtizJ)).
- fix issue of actions dag split [#61458](https://github.com/ClickHouse/ClickHouse/pull/61458) ([Raúl Marín](https://github.com/Algunenano)).
- Fix finishing a failed RESTORE [#61466](https://github.com/ClickHouse/ClickHouse/pull/61466) ([Vitaly Baranov](https://github.com/vitlibar)).
- Disable async_insert_use_adaptive_busy_timeout correctly with compatibility settings [#61468](https://github.com/ClickHouse/ClickHouse/pull/61468) ([Raúl Marín](https://github.com/Algunenano)).
- Allow queuing in restore pool [#61475](https://github.com/ClickHouse/ClickHouse/pull/61475) ([Nikita Taranov](https://github.com/nickitat)).
- Fix an inconsistency when reading system.parts using UUID. [#61479](https://github.com/ClickHouse/ClickHouse/pull/61479) ([Dan Wu](https://github.com/wudanzy)).
- Fix ALTER QUERY MODIFY SQL SECURITY [#61480](https://github.com/ClickHouse/ClickHouse/pull/61480) ([pufit](https://github.com/pufit)).
- Fix a crash in window view (experimental feature) [#61526](https://github.com/ClickHouse/ClickHouse/pull/61526) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix `repeat` with non-native integers [#61527](https://github.com/ClickHouse/ClickHouse/pull/61527) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix client's `-s` argument [#61530](https://github.com/ClickHouse/ClickHouse/pull/61530) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Fix crash in arrayPartialReverseSort [#61539](https://github.com/ClickHouse/ClickHouse/pull/61539) ([Raúl Marín](https://github.com/Algunenano)).
- Fix string search with const position [#61547](https://github.com/ClickHouse/ClickHouse/pull/61547) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix addDays cause an error when used DateTime64 [#61561](https://github.com/ClickHouse/ClickHouse/pull/61561) ([Shuai li](https://github.com/loneylee)).
- Disallow LowCardinality input type for JSONExtract [#61617](https://github.com/ClickHouse/ClickHouse/pull/61617) ([Julia Kartseva](https://github.com/jkartseva)).
- Fix `system.part_log` for async insert with deduplication [#61620](https://github.com/ClickHouse/ClickHouse/pull/61620) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix a `Non-ready set` exception for system.parts. [#61666](https://github.com/ClickHouse/ClickHouse/pull/61666) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix actual_part_name for REPLACE_RANGE (`Entry actual part isn't empty yet`) [#61675](https://github.com/ClickHouse/ClickHouse/pull/61675) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix a sanitizer report in `multiSearchAllPositionsCaseInsensitiveUTF8` for incorrect UTF-8 [#61749](https://github.com/ClickHouse/ClickHouse/pull/61749) ([pufit](https://github.com/pufit)).
- Fix an observation that the RANGE frame is not supported for Nullable columns. [#61766](https://github.com/ClickHouse/ClickHouse/pull/61766) ([YuanLiu](https://github.com/ditgittube)).

### <a id="242"></a> ClickHouse 24.2 版本发布，2024-02-29 {#a-id242a-clickhouse-release-242-2024-02-29}

#### 向后不兼容的变更 {#backward-incompatible-change-8}

- 验证嵌套类型中的可疑/实验性类型。之前我们不会验证嵌套类型（如 Array/Tuple/Map）中的此类类型（JSON 除外）。[#59385](https://github.com/ClickHouse/ClickHouse/pull/59385) ([Kruglov Pavel](https://github.com/Avogar))。
- 为线程数和块大小添加合理性检查。[#60138](https://github.com/ClickHouse/ClickHouse/pull/60138) ([Raúl Marín](https://github.com/Algunenano))。
- 默认不再推断指数表示法的浮点数。新增设置 `input_format_try_infer_exponent_floats` 可恢复之前的行为（默认禁用）。关闭 [#59476](https://github.com/ClickHouse/ClickHouse/issues/59476)。[#59500](https://github.com/ClickHouse/ClickHouse/pull/59500) ([Kruglov Pavel](https://github.com/Avogar))。
- 允许 alter 操作使用括号包围。括号的输出可通过 `format_alter_operations_with_parentheses` 配置控制。默认情况下，格式化查询中会输出括号，因为我们在某些地方将格式化的 alter 操作存储为元数据（例如：mutations）。新语法明确了一些 alter 操作以列表结尾的查询。例如：`ALTER TABLE x MODIFY TTL date GROUP BY a, b, DROP COLUMN c` 无法使用旧语法正确解析。而在新语法中，查询 `ALTER TABLE x (MODIFY TTL date GROUP BY a, b), (DROP COLUMN c)` 的含义是明确的。旧版本无法识别新语法，因此如果在单个集群中混合使用新旧版本的 ClickHouse，使用新语法可能会导致问题。[#59532](https://github.com/ClickHouse/ClickHouse/pull/59532) ([János Benjamin Antal](https://github.com/antaljanosbenjamin))。
- 修复物化视图安全问题，该问题允许用户在没有所需权限的情况下向表中插入数据。修复后会验证用户不仅有权限插入物化视图，还有权限插入所有底层表。这意味着一些之前可以正常执行的查询现在可能会失败并显示 `Not enough privileges`。为了解决这个问题，该版本引入了视图的 SQL 安全新特性 https://clickhouse.com/docs/sql-reference/statements/create/view#sql_security。[#54901](https://github.com/ClickHouse/ClickHouse/pull/54901) [#60439](https://github.com/ClickHouse/ClickHouse/pull/60439) ([pufit](https://github.com/pufit))。


#### 新功能 {#new-feature-10}

- 新增语法,允许在视图/物化视图中指定定义者用户。这使得可以在不显式授予底层表权限的情况下从视图执行 SELECT/INSERT 操作。因此,视图将封装这些权限。[#54901](https://github.com/ClickHouse/ClickHouse/pull/54901) [#60439](https://github.com/ClickHouse/ClickHouse/pull/60439) ([pufit](https://github.com/pufit))。
- 在 `file/s3/hdfs/url/azureBlobStorage` 引擎中进行模式推断时,如果文件格式未知,则尝试自动检测文件格式。关闭 [#50576](https://github.com/ClickHouse/ClickHouse/issues/50576)。[#59092](https://github.com/ClickHouse/ClickHouse/pull/59092) ([Kruglov Pavel](https://github.com/Avogar))。
- 实现异步插入超时的自动调整。引入以下设置:async_insert_poll_timeout_ms、async_insert_use_adaptive_busy_timeout、async_insert_busy_timeout_min_ms、async_insert_busy_timeout_max_ms、async_insert_busy_timeout_increase_rate、async_insert_busy_timeout_decrease_rate。[#58486](https://github.com/ClickHouse/ClickHouse/pull/58486) ([Julia Kartseva](https://github.com/jkartseva))。
- 允许为最大连续登录失败次数设置配额。[#54737](https://github.com/ClickHouse/ClickHouse/pull/54737) ([Alexey Gerasimchuck](https://github.com/Demilivor))。
- 新增聚合函数 `groupArrayIntersect`。后续:[#49862](https://github.com/ClickHouse/ClickHouse/issues/49862)。[#59598](https://github.com/ClickHouse/ClickHouse/pull/59598) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- 支持 `AzureBlobStorage` 的备份和恢复。解决 [#50747](https://github.com/ClickHouse/ClickHouse/issues/50747)。[#56988](https://github.com/ClickHouse/ClickHouse/pull/56988) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
- 用户现在可以使用 `format_schema_rows_template` 在查询中直接指定模板字符串,作为 `format_template_row` 的替代方案。关闭 [#31363](https://github.com/ClickHouse/ClickHouse/issues/31363)。[#59088](https://github.com/ClickHouse/ClickHouse/pull/59088) ([Shaun Struwig](https://github.com/Blargian))。
- 实现了将不同类型的 MergeTree 表自动转换为复制引擎。在表的数据目录(`/clickhouse/store/xxx/xxxyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy/`)中创建空的 `convert_to_replicated` 文件,该表将在下次服务器启动时自动转换。[#57798](https://github.com/ClickHouse/ClickHouse/pull/57798) ([Kirill](https://github.com/kirillgarbar))。
- 新增查询 `ALTER TABLE table FORGET PARTITION partition`,用于删除与空分区相关的 ZooKeeper 节点。[#59507](https://github.com/ClickHouse/ClickHouse/pull/59507) ([Sergei Trifonov](https://github.com/serxa))。这是专家级功能。
- 支持 NATS 表引擎的 JWT 凭证文件。[#59543](https://github.com/ClickHouse/ClickHouse/pull/59543) ([Nickolaj Jepsen](https://github.com/nickolaj-jepsen))。
- 实现了 `system.dns_cache` 表,可用于调试 DNS 问题。 [#59856](https://github.com/ClickHouse/ClickHouse/pull/59856) ([Kirill Nikiforov](https://github.com/allmazz))。
- 编解码器 `LZ4HC` 将接受新的级别 2,比之前的最低级别 3 更快,但压缩率较低。在以前的版本中,`LZ4HC(2)` 及更低级别与 `LZ4HC(3)` 相同。作者:[Cyan4973](https://github.com/Cyan4973)。[#60090](https://github.com/ClickHouse/ClickHouse/pull/60090) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 实现了 `system.dns_cache` 表,可用于调试 DNS 问题。 新增服务器设置 dns_cache_max_size。[#60257](https://github.com/ClickHouse/ClickHouse/pull/60257) ([Kirill Nikiforov](https://github.com/allmazz))。
- 支持 `merge` 表函数的单参数版本,格式为 `merge(['db_name', ] 'tables_regexp')`。[#60372](https://github.com/ClickHouse/ClickHouse/pull/60372) ([豪肥肥](https://github.com/HowePa))。
- 支持负数位置参数。关闭 [#57736](https://github.com/ClickHouse/ClickHouse/issues/57736)。[#58292](https://github.com/ClickHouse/ClickHouse/pull/58292) ([flynn](https://github.com/ucasfl))。
- 支持在配置中使用 `user` 键为特定 S3 设置指定一组允许的用户。[#60144](https://github.com/ClickHouse/ClickHouse/pull/60144) ([Antonio Andelic](https://github.com/antonio2368))。
- 新增表函数 `mergeTreeIndex`。它表示 `MergeTree` 表的索引和标记文件的内容。可用于内省。语法:`mergeTreeIndex(database, table, [with_marks = true])`,其中 `database.table` 是使用 `MergeTree` 引擎的现有表。[#58140](https://github.com/ClickHouse/ClickHouse/pull/58140) ([Anton Popov](https://github.com/CurtizJ))。

#### 实验性功能 {#experimental-feature-8}

- 新增函数 `seriesOutliersDetectTukey`,使用 Tukey 围栏算法检测时间序列数据中的异常值。[#58632](https://github.com/ClickHouse/ClickHouse/pull/58632) ([Bhavna Jindal](https://github.com/bhavnajindal))。请注意,该行为将在下一个补丁版本中发生变更。
- 新增函数 `variantType`,返回包含每行变体类型名称的 Enum。[#59398](https://github.com/ClickHouse/ClickHouse/pull/59398) ([Kruglov Pavel](https://github.com/Avogar))。
- 支持并行副本的 `LEFT JOIN`、`ALL INNER JOIN` 和简单子查询(仅适用于分析器)。新增设置 `parallel_replicas_prefer_local_join` 用于选择本地 `JOIN` 执行(默认)或 `GLOBAL JOIN`。`cluster_for_parallel_replicas` 中的每个副本上都应存在所有表。新增设置 `min_external_table_block_size_rows` 和 `min_external_table_block_size_bytes` 用于合并发送到临时表的小数据块(仅适用于分析器)。[#58916](https://github.com/ClickHouse/ClickHouse/pull/58916) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 允许在添加或恢复新副本时在 `Replicated` 数据库中并发创建表。[#59277](https://github.com/ClickHouse/ClickHouse/pull/59277) ([Konstantin Bogdanov](https://github.com/thevar1able))。
- 实现 `Variant` 值的比较运算符以及向 `Variant` 列正确插入 Field。默认情况下不允许创建具有相似变体类型的 `Variant` 类型(可通过设置 `allow_suspicious_variant_types` 允许)。关闭 [#59996](https://github.com/ClickHouse/ClickHouse/issues/59996)。关闭 [#59850](https://github.com/ClickHouse/ClickHouse/issues/59850)。[#60198](https://github.com/ClickHouse/ClickHouse/pull/60198) ([Kruglov Pavel](https://github.com/Avogar))。
- 禁用并行副本与 CTE 的 JOIN(非分析器)。[#59239](https://github.com/ClickHouse/ClickHouse/pull/59239) ([Raúl Marín](https://github.com/Algunenano))。


#### 性能改进 {#performance-improvement-10}

- 主键将使用更少的内存。[#60049](https://github.com/ClickHouse/ClickHouse/pull/60049) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 改进主键和其他一些操作的内存使用。[#60050](https://github.com/ClickHouse/ClickHouse/pull/60050) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 表的主键将在首次访问时延迟加载到内存中。这由新的 MergeTree 设置 `primary_key_lazy_load` 控制,默认启用。这提供了几个优势:- 未使用的表不会加载主键;- 如果内存不足,将在首次使用时抛出异常,而不是在服务器启动时。这也带来了几个劣势:- 加载主键的延迟将在第一次查询时产生,而不是在接受连接之前;这在理论上可能引入惊群问题。这解决了 [#11188](https://github.com/ClickHouse/ClickHouse/issues/11188)。[#60093](https://github.com/ClickHouse/ClickHouse/pull/60093) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 向量搜索中使用的向量化距离函数。[#58866](https://github.com/ClickHouse/ClickHouse/pull/58866) ([Robert Schulze](https://github.com/rschu1ze))。
- 向量化函数 `dotProduct`,对向量搜索很有用。[#60202](https://github.com/ClickHouse/ClickHouse/pull/60202) ([Robert Schulze](https://github.com/rschu1ze))。
- 为 `dictGetOrDefault` 函数添加短路能力。解决了 [#52098](https://github.com/ClickHouse/ClickHouse/issues/52098)。[#57767](https://github.com/ClickHouse/ClickHouse/pull/57767) ([jsc0218](https://github.com/jsc0218))。
- Keeper 改进:仅缓存一定数量的日志到内存中,由 `latest_logs_cache_size_threshold` 和 `commit_logs_cache_size_threshold` 控制。[#59460](https://github.com/ClickHouse/ClickHouse/pull/59460) ([Antonio Andelic](https://github.com/antonio2368))。
- Keeper 改进:进一步减小数据节点的大小。[#59592](https://github.com/ClickHouse/ClickHouse/pull/59592) ([Antonio Andelic](https://github.com/antonio2368))。
- 继续优化当结果类型为 `Float*/Decimal*/*Int*` 时 `if` 函数的分支预测失败,这是 https://github.com/ClickHouse/ClickHouse/pull/57885 的后续工作。[#59148](https://github.com/ClickHouse/ClickHouse/pull/59148) ([李扬](https://github.com/taiyang-li))。
- 优化输入类型为 `Map` 时的 `if` 函数,速度提升可达约 10 倍。[#59413](https://github.com/ClickHouse/ClickHouse/pull/59413) ([李扬](https://github.com/taiyang-li))。
- 通过实现严格别名来提高 `Int8` 类型的性能(我们已经为 `UInt8` 和所有其他整数类型实现了这一点)。[#59485](https://github.com/ClickHouse/ClickHouse/pull/59485) ([Raúl Marín](https://github.com/Algunenano))。
- 通过减少分支预测失败来优化 bigint 和 big decimal 类型的条件 sum/avg 性能。[#59504](https://github.com/ClickHouse/ClickHouse/pull/59504) ([李扬](https://github.com/taiyang-li))。
- 提高具有活动 mutation 的 SELECT 查询的性能。[#59531](https://github.com/ClickHouse/ClickHouse/pull/59531) ([Azat Khuzhin](https://github.com/azat))。
- 使用 AVX2 优化 `isNotNull` 函数。[#59621](https://github.com/ClickHouse/ClickHouse/pull/59621) ([李扬](https://github.com/taiyang-li))。
- 提高已排序或接近排序数据的 ASOF JOIN 性能。[#59731](https://github.com/ClickHouse/ClickHouse/pull/59731) ([Maksim Kita](https://github.com/kitaisreal))。
- `async_insert_max_data_size` 之前的默认值为 1 MB,显得过小。新的默认值将为 10 MiB。[#59536](https://github.com/ClickHouse/ClickHouse/pull/59536) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 在执行 RESTORE 命令时,使用多线程从备份中读取表的元数据。[#60040](https://github.com/ClickHouse/ClickHouse/pull/60040) ([Vitaly Baranov](https://github.com/vitlibar))。
- 现在如果 `StorageBuffer` 有多个分片(`num_layers` > 1),后台刷新将在多个线程中同时对所有分片进行。[#60111](https://github.com/ClickHouse/ClickHouse/pull/60111) ([alesapin](https://github.com/alesapin))。





#### 改进 {#improvement-10}

- 当输出格式为 `Pretty` 格式且数据块由单个超过一百万的数值组成时,表格右侧将打印可读格式的数字。[#60379](https://github.com/ClickHouse/ClickHouse/pull/60379) ([rogeryk](https://github.com/rogeryk))。
- 添加了设置 `split_parts_ranges_into_intersecting_and_non_intersecting_final` 和 `split_intersecting_parts_ranges_into_layers_final`。这些设置用于禁用带有 `FINAL` 的查询优化,仅供调试使用。[#59705](https://github.com/ClickHouse/ClickHouse/pull/59705) ([Maksim Kita](https://github.com/kitaisreal))。实际上不仅如此——它们还可以以牺牲性能为代价来降低内存使用量。
- 将设置 `extract_kvp_max_pairs_per_row` 重命名为 `extract_key_value_pairs_max_pairs_per_row`。该问题(设置名称中不必要的缩写)在 https://github.com/ClickHouse/ClickHouse/pull/43606 中引入。修复了此设置的文档。[#59683](https://github.com/ClickHouse/ClickHouse/pull/59683) ([Alexey Milovidov](https://github.com/alexey-milovidov))。[#59960](https://github.com/ClickHouse/ClickHouse/pull/59960) ([jsc0218](https://github.com/jsc0218))。
- 在具有 `DEFAULT` 或 `MATERIALIZED` 表达式的列上运行 `ALTER COLUMN MATERIALIZE` 现在严格遵循语义规则。[#58023](https://github.com/ClickHouse/ClickHouse/pull/58023) ([Duc Canh Le](https://github.com/canhld94))。
- 为变更(mutation)期间的错误启用了指数退避逻辑。这将减少 CPU 使用量、内存使用量和日志文件大小。[#58036](https://github.com/ClickHouse/ClickHouse/pull/58036) ([MikhailBurdukov](https://github.com/MikhailBurdukov))。
- 改进了 `InitialQuery` 性能事件的计数功能。[#58195](https://github.com/ClickHouse/ClickHouse/pull/58195) ([Unalian](https://github.com/Unalian))。
- 允许在 `storage_configuration` 中定义 `volume_priority`。[#58533](https://github.com/ClickHouse/ClickHouse/pull/58533) ([Andrey Zvonov](https://github.com/zvonand))。
- 在 `T64` 编解码器中添加了对 `Date32` 类型的支持。[#58738](https://github.com/ClickHouse/ClickHouse/pull/58738) ([Hongbin Ma](https://github.com/binmahone))。
- 允许在具有多个项的类型中使用尾随逗号。[#59119](https://github.com/ClickHouse/ClickHouse/pull/59119) ([Aleksandr Musorin](https://github.com/AVMusorin))。
- Distributed 表引擎的设置现在可以在服务器配置文件中指定(类似于 MergeTree 设置),例如 `<distributed> <flush_on_detach>false</flush_on_detach> </distributed>`。[#59291](https://github.com/ClickHouse/ClickHouse/pull/59291) ([Azat Khuzhin](https://github.com/azat))。
- 在读取 `system.zookeeper` 时对断开连接和过期会话进行重试。这在从 `system.zookeeper` 表读取大量行时很有帮助,特别是在存在故障注入导致的断开连接的情况下。[#59388](https://github.com/ClickHouse/ClickHouse/pull/59388) ([Alexander Gololobov](https://github.com/davenger))。
- 当 `input_format_values_interpret_expressions=0` 时,不将带前导零的数字解释为八进制数。[#59403](https://github.com/ClickHouse/ClickHouse/pull/59403) ([Joanna Hulboj](https://github.com/jh0x))。
- 在启动时以及配置文件更改时,ClickHouse 会更新其总内存跟踪器的硬内存限制。这些限制基于各种服务器设置和 cgroups 限制(在 Linux 上)计算。以前,`/sys/fs/cgroup/memory.max`(用于 cgroups v2)的设置是硬编码的。因此,为嵌套组(层次结构)配置的 cgroup v2 内存限制,例如 `/sys/fs/cgroup/my/nested/group/memory.max` 会被忽略。现在已修复此问题。v1 内存限制的行为保持不变。[#59435](https://github.com/ClickHouse/ClickHouse/pull/59435) ([Robert Schulze](https://github.com/rschu1ze))。
- 添加了新的性能事件以观察在 `INSERT` 期间计算主键/投影/二级索引所花费的时间。[#59436](https://github.com/ClickHouse/ClickHouse/pull/59436) ([Nikita Taranov](https://github.com/nickitat))。
- 允许在创建时使用设置 `s3queue_last_processed_path` 为有序模式的 S3Queue 定义起始点。[#59446](https://github.com/ClickHouse/ClickHouse/pull/59446) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 使系统表的注释在 `clickhouse-local` 的 `system.tables` 中也可用。[#59493](https://github.com/ClickHouse/ClickHouse/pull/59493) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- `system.zookeeper` 表:以前整个结果在内存中累积并作为一个大块返回。此更改有助于在从 `system.zookeeper` 读取大量行时减少内存消耗,允许显示中间进度(到目前为止已读取多少行),并避免在结果集很大时触发连接超时。[#59545](https://github.com/ClickHouse/ClickHouse/pull/59545) ([Alexander Gololobov](https://github.com/davenger))。
- 现在仪表板可以理解 URL #hash 的压缩和未压缩状态(向后兼容)。[#59124](https://github.com/ClickHouse/ClickHouse/issues/59124) 的延续。[#59548](https://github.com/ClickHouse/ClickHouse/pull/59548) ([Amos Bird](https://github.com/amosbird))。
- 将 Intel QPL(由编解码器 `DEFLATE_QPL` 使用)从 v1.3.1 升级到 v1.4.0。还修复了轮询超时机制的错误,因为我们观察到在某些情况下超时无法正常工作,如果发生超时,IAA 和 CPU 可能会同时处理缓冲区。目前,我们最好确保 IAA 编解码器状态不是 QPL_STS_BEING_PROCESSED,然后回退到软件编解码器。[#59551](https://github.com/ClickHouse/ClickHouse/pull/59551) ([jasperzhu](https://github.com/jinjunzh))。
- 不在 ClickHouse Cloud 中显示有关服务器版本的警告,因为 ClickHouse Cloud 会自动处理无缝升级。[#59657](https://github.com/ClickHouse/ClickHouse/pull/59657) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 自解压后,临时二进制文件被移动而不是复制。[#59661](https://github.com/ClickHouse/ClickHouse/pull/59661) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
- 修复了 Apple macOS 上的堆栈展开问题。这关闭了 [#53653](https://github.com/ClickHouse/ClickHouse/issues/53653)。[#59690](https://github.com/ClickHouse/ClickHouse/pull/59690) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 即使用户将 `max_parser_depth` 设置错误配置为非常高的值,也会在解析器中检查堆栈溢出。这关闭了 [#59622](https://github.com/ClickHouse/ClickHouse/issues/59622)。[#59697](https://github.com/ClickHouse/ClickHouse/pull/59697) ([Alexey Milovidov](https://github.com/alexey-milovidov))。[#60434](https://github.com/ClickHouse/ClickHouse/pull/60434)
- 统一 Kafka 存储中 XML 和 SQL 创建的命名集合行为。[#59710](https://github.com/ClickHouse/ClickHouse/pull/59710) ([Pervakov Grigorii](https://github.com/GrigoryPervakov))。
- 当 `merge_max_block_size_bytes` 足够小且表包含宽行(字符串或元组)时,后台合并可能会陷入无限循环。此行为已修复。https://github.com/ClickHouse/ClickHouse/pull/59340 的后续。[#59812](https://github.com/ClickHouse/ClickHouse/pull/59812) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 如果 CREATE TABLE 明确包含 uuid,则允许在 replica_path 中使用 uuid。[#59908](https://github.com/ClickHouse/ClickHouse/pull/59908) ([Azat Khuzhin](https://github.com/azat))。
- 在 `system.tables` 系统表中添加 ReplicatedMergeTree 表的 `metadata_version` 列。[#59942](https://github.com/ClickHouse/ClickHouse/pull/59942) ([Maksim Kita](https://github.com/kitaisreal))。
- Keeper 改进:仅向 Prometheus 发送与 Keeper 相关的指标/事件。[#59945](https://github.com/ClickHouse/ClickHouse/pull/59945) ([Antonio Andelic](https://github.com/antonio2368))。
- 即使升级后系统表的结构发生了变化,仪表板也会显示不同 ClickHouse 版本的指标。[#59967](https://github.com/ClickHouse/ClickHouse/pull/59967) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 允许从文件加载可用区信息。[#59976](https://github.com/ClickHouse/ClickHouse/pull/59976) ([Konstantin Bogdanov](https://github.com/thevar1able))。
- Keeper 改进:为磁盘相关操作的失败添加重试机制。[#59980](https://github.com/ClickHouse/ClickHouse/pull/59980) ([Antonio Andelic](https://github.com/antonio2368))。
- 添加新的配置设置 `backups.remove_backup_files_after_failure`:`<clickhouse> <backups> <remove_backup_files_after_failure>true</remove_backup_files_after_failure> </backups> </clickhouse>`。[#60002](https://github.com/ClickHouse/ClickHouse/pull/60002) ([Vitaly Baranov](https://github.com/vitlibar))。
- 在 GCP 返回带有 `GATEWAY_TIMEOUT` HTTP 错误代码的 `Internal Error` 时,将 S3 文件 GCP 回退到缓冲区复制。[#60164](https://github.com/ClickHouse/ClickHouse/pull/60164) ([Maksim Kita](https://github.com/kitaisreal))。
- 为 `ULIDStringToDateTime` 实现短路执行。[#60211](https://github.com/ClickHouse/ClickHouse/pull/60211) ([Juan Madurga](https://github.com/jlmadurga))。
- 为表 `system.backups` 和 `system.backup_log` 添加了 `query_id` 列。在 `error` 列中添加了错误堆栈跟踪。[#60220](https://github.com/ClickHouse/ClickHouse/pull/60220) ([Maksim Kita](https://github.com/kitaisreal))。
- 通过 MySQL 端口的连接现在自动使用设置 `prefer_column_name_to_alias = 1` 运行,以开箱即用地支持 QuickSight。此外,设置 `mysql_map_string_to_text_in_show_columns` 和 `mysql_map_fixed_string_to_text_in_show_columns` 现在默认启用,也仅影响 MySQL 连接。这提高了与更多 BI 工具的兼容性。[#60365](https://github.com/ClickHouse/ClickHouse/pull/60365) ([Robert Schulze](https://github.com/rschu1ze))。
- 修复了 JavaScript 代码中导致图表重叠的竞态条件。[#60392](https://github.com/ClickHouse/ClickHouse/pull/60392) ([Alexey Milovidov](https://github.com/alexey-milovidov))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-6}

- 添加了带有内省功能的覆盖率收集构建和测试。延续 [#56102](https://github.com/ClickHouse/ClickHouse/issues/56102)。[#58792](https://github.com/ClickHouse/ClickHouse/pull/58792) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 当设置 CMake 交叉编译工具链变量时,更新 `corrosion-cmake` 中的 Rust 工具链。[#59309](https://github.com/ClickHouse/ClickHouse/pull/59309) ([Aris Tritas](https://github.com/aris-aiven))。
- 为 ASTLiterals 添加模糊测试。[#59383](https://github.com/ClickHouse/ClickHouse/pull/59383) ([Raúl Marín](https://github.com/Algunenano))。
- 如果您希望在每次 ClickHouse 容器启动时运行 initdb 脚本,应初始化环境变量 CLICKHOUSE_ALWAYS_RUN_INITDB_SCRIPTS。[#59808](https://github.com/ClickHouse/ClickHouse/pull/59808) ([Alexander Nikolaev](https://github.com/AlexNik))。
- 移除禁用通用 ClickHouse 组件(如 server/client/...)的功能,但保留需要额外库的组件(如 ODBC 或 keeper)。[#59857](https://github.com/ClickHouse/ClickHouse/pull/59857) ([Azat Khuzhin](https://github.com/azat))。
- 查询模糊测试器将对查询内的 SETTINGS 进行模糊测试。[#60087](https://github.com/ClickHouse/ClickHouse/pull/60087) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 添加使用 clang-19 (master) 构建 ClickHouse 的支持。[#60448](https://github.com/ClickHouse/ClickHouse/pull/60448) ([Alexey Milovidov](https://github.com/alexey-milovidov))。


#### Bug 修复(官方稳定版本中用户可见的错误行为) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-8}

- Fix a "Non-ready set" error in TTL WHERE. [#57430](https://github.com/ClickHouse/ClickHouse/pull/57430) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix a bug in the `quantilesGK` function [#58216](https://github.com/ClickHouse/ClickHouse/pull/58216) ([李扬](https://github.com/taiyang-li)).
- Fix a wrong behavior with `intDiv` for Decimal arguments [#59243](https://github.com/ClickHouse/ClickHouse/pull/59243) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fix `translate` with FixedString input [#59356](https://github.com/ClickHouse/ClickHouse/pull/59356) ([Raúl Marín](https://github.com/Algunenano)).
- Fix digest calculation in Keeper [#59439](https://github.com/ClickHouse/ClickHouse/pull/59439) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix stacktraces for binaries without debug symbols [#59444](https://github.com/ClickHouse/ClickHouse/pull/59444) ([Azat Khuzhin](https://github.com/azat)).
- Fix `ASTAlterCommand::formatImpl` in case of column specific settings... [#59445](https://github.com/ClickHouse/ClickHouse/pull/59445) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fix `SELECT * FROM [...] ORDER BY ALL` with Analyzer [#59462](https://github.com/ClickHouse/ClickHouse/pull/59462) ([zhongyuankai](https://github.com/zhongyuankai)).
- Fix possible uncaught exception during distributed query cancellation [#59487](https://github.com/ClickHouse/ClickHouse/pull/59487) ([Azat Khuzhin](https://github.com/azat)).
- Make MAX use the same rules as permutation for complex types [#59498](https://github.com/ClickHouse/ClickHouse/pull/59498) ([Raúl Marín](https://github.com/Algunenano)).
- Fix corner case when passing `update_insert_deduplication_token_in_dependent_materialized_views` [#59544](https://github.com/ClickHouse/ClickHouse/pull/59544) ([Jordi Villar](https://github.com/jrdi)).
- Fix incorrect result of arrayElement / map on empty value [#59594](https://github.com/ClickHouse/ClickHouse/pull/59594) ([Raúl Marín](https://github.com/Algunenano)).
- Fix crash in topK when merging empty states [#59603](https://github.com/ClickHouse/ClickHouse/pull/59603) ([Raúl Marín](https://github.com/Algunenano)).
- Fix distributed table with a constant sharding key [#59606](https://github.com/ClickHouse/ClickHouse/pull/59606) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix KQL issue found by WingFuzz [#59626](https://github.com/ClickHouse/ClickHouse/pull/59626) ([Yong Wang](https://github.com/kashwy)).
- Fix error "Read beyond last offset" for AsynchronousBoundedReadBuffer [#59630](https://github.com/ClickHouse/ClickHouse/pull/59630) ([Vitaly Baranov](https://github.com/vitlibar)).
- Maintain function alias in RewriteSumFunctionWithSumAndCountVisitor [#59658](https://github.com/ClickHouse/ClickHouse/pull/59658) ([Raúl Marín](https://github.com/Algunenano)).
- Fix query start time on non initial queries [#59662](https://github.com/ClickHouse/ClickHouse/pull/59662) ([Raúl Marín](https://github.com/Algunenano)).
- Validate types of arguments for `minmax` skipping index [#59733](https://github.com/ClickHouse/ClickHouse/pull/59733) ([Anton Popov](https://github.com/CurtizJ)).
- Fix leftPad / rightPad function with FixedString input [#59739](https://github.com/ClickHouse/ClickHouse/pull/59739) ([Raúl Marín](https://github.com/Algunenano)).
- Fix AST fuzzer issue in function `countMatches` [#59752](https://github.com/ClickHouse/ClickHouse/pull/59752) ([Robert Schulze](https://github.com/rschu1ze)).
- RabbitMQ: fix having neither acked nor nacked messages [#59775](https://github.com/ClickHouse/ClickHouse/pull/59775) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix StorageURL doing some of the query execution in single thread [#59833](https://github.com/ClickHouse/ClickHouse/pull/59833) ([Michael Kolupaev](https://github.com/al13n321)).
- S3Queue: fix uninitialized value [#59897](https://github.com/ClickHouse/ClickHouse/pull/59897) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix parsing of partition expressions surrounded by parens [#59901](https://github.com/ClickHouse/ClickHouse/pull/59901) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fix crash in JSONColumnsWithMetadata format over HTTP [#59925](https://github.com/ClickHouse/ClickHouse/pull/59925) ([Kruglov Pavel](https://github.com/Avogar)).
- Do not rewrite sum to count if the return value differs in Analyzer [#59926](https://github.com/ClickHouse/ClickHouse/pull/59926) ([Azat Khuzhin](https://github.com/azat)).
- UniqExactSet read crash fix [#59928](https://github.com/ClickHouse/ClickHouse/pull/59928) ([Maksim Kita](https://github.com/kitaisreal)).
- ReplicatedMergeTree invalid metadata_version fix [#59946](https://github.com/ClickHouse/ClickHouse/pull/59946) ([Maksim Kita](https://github.com/kitaisreal)).
- Fix data race in `StorageDistributed` [#59987](https://github.com/ClickHouse/ClickHouse/pull/59987) ([Nikita Taranov](https://github.com/nickitat)).
- Docker: run init scripts when option is enabled rather than disabled [#59991](https://github.com/ClickHouse/ClickHouse/pull/59991) ([jktng](https://github.com/jktng)).
- Fix INSERT into `SQLite` with single quote (by escaping single quotes with a quote instead of backslash) [#60015](https://github.com/ClickHouse/ClickHouse/pull/60015) ([Azat Khuzhin](https://github.com/azat)).
- Fix several logical errors in `arrayFold` [#60022](https://github.com/ClickHouse/ClickHouse/pull/60022) ([Raúl Marín](https://github.com/Algunenano)).
- Fix optimize_uniq_to_count removing the column alias [#60026](https://github.com/ClickHouse/ClickHouse/pull/60026) ([Raúl Marín](https://github.com/Algunenano)).
- Fix possible exception from S3Queue table on drop [#60036](https://github.com/ClickHouse/ClickHouse/pull/60036) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix formatting of NOT with single literals [#60042](https://github.com/ClickHouse/ClickHouse/pull/60042) ([Raúl Marín](https://github.com/Algunenano)).
- Use max_query_size from context in DDLLogEntry instead of hardcoded 4096 [#60083](https://github.com/ClickHouse/ClickHouse/pull/60083) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix inconsistent formatting of queries containing tables named `table`. Fix wrong formatting of queries with `UNION ALL`, `INTERSECT`, and `EXCEPT` when their structure wasn't linear. This closes #52349. Fix wrong formatting of `SYSTEM` queries, including `SYSTEM ... DROP FILESYSTEM CACHE`, `SYSTEM ... REFRESH/START/STOP/CANCEL/TEST VIEW`, `SYSTEM ENABLE/DISABLE FAILPOINT`. Fix formatting of parameterized DDL queries. Fix the formatting of the `DESCRIBE FILESYSTEM CACHE` query. Fix incorrect formatting of the `SET param_...` (a query setting a parameter). Fix incorrect formatting of `CREATE INDEX` queries. Fix inconsistent formatting of `CREATE USER` and similar queries. Fix inconsistent formatting of `CREATE SETTINGS PROFILE`. Fix incorrect formatting of `ALTER ... MODIFY REFRESH`. Fix inconsistent formatting of window functions if frame offsets were expressions. Fix inconsistent formatting of `RESPECT NULLS` and `IGNORE NULLS` if they were used after a function that implements an operator (such as `plus`). Fix idiotic formatting of `SYSTEM SYNC REPLICA ... LIGHTWEIGHT FROM ...`. Fix inconsistent formatting of invalid queries with `GROUP BY GROUPING SETS ... WITH ROLLUP/CUBE/TOTALS`. Fix inconsistent formatting of `GRANT CURRENT GRANTS`. Fix inconsistent formatting of `CREATE TABLE (... COLLATE)`. Additionally, I fixed the incorrect formatting of `EXPLAIN` in subqueries (#60102). Fixed incorrect formatting of lambda functions (#60012). Added a check so there is no way to miss these abominations in the future. [#60095](https://github.com/ClickHouse/ClickHouse/pull/60095) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix inconsistent formatting of explain in subqueries [#60102](https://github.com/ClickHouse/ClickHouse/pull/60102) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix cosineDistance crash with Nullable [#60150](https://github.com/ClickHouse/ClickHouse/pull/60150) ([Raúl Marín](https://github.com/Algunenano)).
- Allow casting of bools in string representation to true bools [#60160](https://github.com/ClickHouse/ClickHouse/pull/60160) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix `system.s3queue_log` [#60166](https://github.com/ClickHouse/ClickHouse/pull/60166) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix arrayReduce with nullable aggregate function name [#60188](https://github.com/ClickHouse/ClickHouse/pull/60188) ([Raúl Marín](https://github.com/Algunenano)).
- Hide sensitive info for `S3Queue` [#60233](https://github.com/ClickHouse/ClickHouse/pull/60233) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix http exception codes. [#60252](https://github.com/ClickHouse/ClickHouse/pull/60252) ([Austin Kothig](https://github.com/kothiga)).
- S3Queue: fix a bug (also fixes flaky test_storage_s3_queue/test.py::test_shards_distributed) [#60282](https://github.com/ClickHouse/ClickHouse/pull/60282) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix use-of-uninitialized-value and invalid result in hashing functions with IPv6 [#60359](https://github.com/ClickHouse/ClickHouse/pull/60359) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix OptimizeDateOrDateTimeConverterWithPreimageVisitor with null arguments [#60453](https://github.com/ClickHouse/ClickHouse/pull/60453) ([Raúl Marín](https://github.com/Algunenano)).
- Fixed a minor bug that prevented distributed table queries sent from either KQL or PRQL dialect clients to be executed on replicas. [#59674](https://github.com/ClickHouse/ClickHouse/issues/59674). [#60470](https://github.com/ClickHouse/ClickHouse/pull/60470) ([Alexey Milovidov](https://github.com/alexey-milovidov)) [#59674](https://github.com/ClickHouse/ClickHouse/pull/59674) ([Austin Kothig](https://github.com/kothiga)).

### <a id="241"></a> ClickHouse 版本 24.1,2024-01-30 {#a-id241a-clickhouse-release-241-2024-01-30}

#### 向后不兼容变更 {#backward-incompatible-change-9}

- 设置 `print_pretty_type_names` 现在默认启用。您可以将其关闭以保持旧行为,或设置 `SET compatibility = '23.12'`。[#57726](https://github.com/ClickHouse/ClickHouse/pull/57726) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- MergeTree 设置 `clean_deleted_rows` 已弃用,不再有任何效果。`OPTIMIZE` 的 `CLEANUP` 关键字默认不允许使用(除非启用 `allow_experimental_replacing_merge_with_cleanup`)。[#58316](https://github.com/ClickHouse/ClickHouse/pull/58316) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 函数 `reverseDNSQuery` 不再可用。此变更关闭了 [#58368](https://github.com/ClickHouse/ClickHouse/issues/58368)。[#58369](https://github.com/ClickHouse/ClickHouse/pull/58369) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 启用多项变更以改进配置文件中的访问控制。这些变更会影响系统行为,您需要检查 `config.xml` 中的 `access_control_improvements` 部分。如果您不确定,请保持配置文件中的值与之前版本一致。[#58584](https://github.com/ClickHouse/ClickHouse/pull/58584) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 改进 `sumMapFiltered` 对 NaN 值的处理。NaN 值现在被放置在末尾(而不是随机位置),并被视为与任何值都不同。`-0` 现在也被视为等于 `0`;由于 0 值会被丢弃,`-0` 值也会被丢弃。[#58959](https://github.com/ClickHouse/ClickHouse/pull/58959) ([Raúl Marín](https://github.com/Algunenano))。
- 函数 `visibleWidth` 现在将按照文档说明的方式运行。在之前的版本中,它只是在字符串序列化后简单地计算码点数,类似于 `lengthUTF8` 函数,但没有考虑零宽度字符和组合字符、全角字符、制表符和删除符。现在行为已相应更改。如果您想保持旧行为,请将 `function_visible_width_behavior` 设置为 `0`,或将 `compatibility` 设置为 `23.12` 或更低版本。[#59022](https://github.com/ClickHouse/ClickHouse/pull/59022) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `Kusto` 方言已被禁用,直到以下两个 bug 被修复:[#59037](https://github.com/ClickHouse/ClickHouse/issues/59037) 和 [#59036](https://github.com/ClickHouse/ClickHouse/issues/59036)。[#59305](https://github.com/ClickHouse/ClickHouse/pull/59305) ([Alexey Milovidov](https://github.com/alexey-milovidov))。任何尝试使用 `Kusto` 的操作都将导致异常。
- `FINAL` 修饰符的更高效实现不再保证保留顺序,即使 `max_threads = 1` 也是如此。如果您依赖之前的行为,请将 `enable_vertical_final` 设置为 0 或将 `compatibility` 设置为 `23.12`。


#### 新功能 {#new-feature-11}

- 实现 Variant 数据类型,表示其他数据类型的联合。类型 `Variant(T1, T2, ..., TN)` 表示此类型的每一行具有类型 `T1` 或 `T2` 或 ... 或 `TN` 的值,或者为 `NULL` 值。Variant 类型在设置 `allow_experimental_variant_type` 下可用。参考:[#54864](https://github.com/ClickHouse/ClickHouse/issues/54864)。[#58047](https://github.com/ClickHouse/ClickHouse/pull/58047) ([Kruglov Pavel](https://github.com/Avogar))。
- 某些设置(目前为 `min_compress_block_size` 和 `max_compress_block_size`)现在可以在列级别指定,优先级高于相应的表级别设置。示例:`CREATE TABLE tab (col String SETTINGS (min_compress_block_size = 81920, max_compress_block_size = 163840)) ENGINE = MergeTree ORDER BY tuple();`。[#55201](https://github.com/ClickHouse/ClickHouse/pull/55201) ([Duc Canh Le](https://github.com/canhld94))。
- 添加 `quantileDD` 聚合函数以及相应的 `quantilesDD` 和 `medianDD`。基于 DDSketch https://www.vldb.org/pvldb/vol12/p2195-masson.pdf。### 面向用户的更改文档条目。[#56342](https://github.com/ClickHouse/ClickHouse/pull/56342) ([Srikanth Chekuri](https://github.com/srikanthccv))。
- 允许使用任意元数据类型配置任意对象存储。[#58357](https://github.com/ClickHouse/ClickHouse/pull/58357) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 为 `distributed_ddl_output_mode` 添加了 `null_status_on_timeout_only_active` 和 `throw_only_active` 模式,允许避免等待非活动副本。[#58350](https://github.com/ClickHouse/ClickHouse/pull/58350) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 添加函数 `arrayShingles` 以计算子数组,例如 `arrayShingles([1, 2, 3, 4, 5], 3)` 返回 `[[1,2,3],[2,3,4],[3,4,5]]`。[#58396](https://github.com/ClickHouse/ClickHouse/pull/58396) ([Zheng Miao](https://github.com/zenmiao7))。
- 添加了函数 `punycodeEncode`、`punycodeDecode`、`idnaEncode` 和 `idnaDecode`,用于根据 IDNA 标准将国际域名转换为 ASCII 表示。[#58454](https://github.com/ClickHouse/ClickHouse/pull/58454) ([Robert Schulze](https://github.com/rschu1ze))。
- 添加了字符串相似度函数 `dramerauLevenshteinDistance`、`jaroSimilarity` 和 `jaroWinklerSimilarity`。[#58531](https://github.com/ClickHouse/ClickHouse/pull/58531) ([Robert Schulze](https://github.com/rschu1ze))。
- 添加两个设置:`output_format_compression_level` 用于更改输出压缩级别,`output_format_compression_zstd_window_log` 用于显式设置压缩窗口大小,并在输出压缩方法为 `zstd` 时启用长距离模式。适用于 `INTO OUTFILE` 以及写入表函数 `file`、`url`、`hdfs`、`s3` 和 `azureBlobStorage` 时。[#58539](https://github.com/ClickHouse/ClickHouse/pull/58539) ([Duc Canh Le](https://github.com/canhld94))。
- 如果输出不是终端,则在 Pretty 格式中自动禁用 ANSI 转义序列。为设置 `output_format_pretty_color` 添加新的 `auto` 模式。[#58614](https://github.com/ClickHouse/ClickHouse/pull/58614) ([Shaun Struwig](https://github.com/Blargian))。
- 添加了函数 `sqidDecode`,用于解码 [Sqids](https://sqids.org/)。[#58544](https://github.com/ClickHouse/ClickHouse/pull/58544) ([Robert Schulze](https://github.com/rschu1ze))。
- 允许在 JSON 输入格式中将 Bool 值读取为 String。通过默认启用的设置 `input_format_json_read_bools_as_strings` 实现。[#58561](https://github.com/ClickHouse/ClickHouse/pull/58561) ([Kruglov Pavel](https://github.com/Avogar))。
- 添加了函数 `seriesDecomposeSTL`,将时间序列分解为季节性、趋势和残差分量。[#57078](https://github.com/ClickHouse/ClickHouse/pull/57078) ([Bhavna Jindal](https://github.com/bhavnajindal))。
- 为 MaterializedMySQL 引入了 MySQL Binlog 客户端:一个 binlog 连接支持多个数据库。[#57323](https://github.com/ClickHouse/ClickHouse/pull/57323) ([Val Doroshchuk](https://github.com/valbok))。
- Intel QuickAssist Technology (QAT) 提供硬件加速的压缩和加密。ClickHouse 新增了压缩编解码器 `ZSTD_QAT`,利用 QAT 进行 zstd 压缩。该编解码器使用 [Intel 的 QATlib](https://github.com/intel/qatlib) 和 [Intel 的 QAT ZSTD 插件](https://github.com/intel/QAT-ZSTD-Plugin)。目前,仅压缩可以在硬件中加速(如果 QAT 无法初始化,则会回退到软件实现),解压缩始终在软件中运行。[#57509](https://github.com/ClickHouse/ClickHouse/pull/57509) ([jasperzhu](https://github.com/jinjunzh))。
- 实现了为 s3 磁盘生成对象存储键的新方法。现在可以在磁盘描述中使用 `key_template` 选项以 `re2` 正则表达式语法定义格式。[#57663](https://github.com/ClickHouse/ClickHouse/pull/57663) ([Sema Checherinda](https://github.com/CheSema))。
- 表 system.dropped_tables_parts 包含 system.dropped_tables 表的数据分区(已删除但尚未移除的表)。[#58038](https://github.com/ClickHouse/ClickHouse/pull/58038) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
- 添加设置 `max_materialized_views_size_for_table` 以限制附加到表的物化视图数量。[#58068](https://github.com/ClickHouse/ClickHouse/pull/58068) ([zhongyuankai](https://github.com/zhongyuankai))。
- `clickhouse-format` 改进:支持带有 `VALUES` 的 INSERT 查询;支持注释(使用 `--comments` 输出);支持 `--max_line_length` 选项以仅将长查询格式化为多行。[#58246](https://github.com/ClickHouse/ClickHouse/pull/58246) ([vdimir](https://github.com/vdimir))。
- 在 `clickhouse-local` 中附加所有系统表,包括 `system.parts`。解决了 [#58312](https://github.com/ClickHouse/ClickHouse/issues/58312)。[#58359](https://github.com/ClickHouse/ClickHouse/pull/58359) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 在函数 `transform` 中支持 `Enum` 数据类型。解决了 [#58241](https://github.com/ClickHouse/ClickHouse/issues/58241)。[#58360](https://github.com/ClickHouse/ClickHouse/pull/58360) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 添加表 `system.database_engines`。[#58390](https://github.com/ClickHouse/ClickHouse/pull/58390) ([Bharat Nallan](https://github.com/bharatnc))。允许在代码库中独立注册数据库引擎。[#58365](https://github.com/ClickHouse/ClickHouse/pull/58365) ([Bharat Nallan](https://github.com/bharatnc))。允许独立注册解释器。[#58443](https://github.com/ClickHouse/ClickHouse/pull/58443) ([Bharat Nallan](https://github.com/bharatnc))。
- 为 `SYSTEM SYNC REPLICA LIGHTWEIGHT` 查询添加了 `FROM <Replicas>` 修饰符。使用 `FROM` 修饰符可确保仅等待指定源副本的数据获取和范围删除操作,以及任何不在 zookeeper 中或具有空 source_replica 的副本。[#58393](https://github.com/ClickHouse/ClickHouse/pull/58393) ([Jayme Bird](https://github.com/jaymebrd))。
- 添加了设置 `update_insert_deduplication_token_in_dependent_materialized_views`。此设置允许在依赖物化视图中插入数据时使用表标识符更新插入去重令牌。解决了 [#59165](https://github.com/ClickHouse/ClickHouse/issues/59165)。[#59238](https://github.com/ClickHouse/ClickHouse/pull/59238) ([Maksim Kita](https://github.com/kitaisreal))。
- 添加了语句 `SYSTEM RELOAD ASYNCHRONOUS METRICS`,用于更新异步指标。主要用于测试和开发。[#53710](https://github.com/ClickHouse/ClickHouse/pull/53710) ([Robert Schulze](https://github.com/rschu1ze))。





#### 性能改进 {#performance-improvement-11}

- 并行副本的协调机制已重写,以实现更好的并行性和缓存局部性。已在数百个副本上测试线性可扩展性。同时增加了对有序读取的支持。[#57968](https://github.com/ClickHouse/ClickHouse/pull/57968) ([Nikita Taranov](https://github.com/nickitat)).
- 将基于 HTTP 的出站缓冲替换为原生 ClickHouse 缓冲区。为接口添加字节计数指标。[#56064](https://github.com/ClickHouse/ClickHouse/pull/56064) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- 在分布式查询中,`uniqExact` 的大型聚合状态将并行合并。[#59009](https://github.com/ClickHouse/ClickHouse/pull/59009) ([Nikita Taranov](https://github.com/nickitat)).
- 降低从 `MergeTree` 表读取后的内存使用量。[#59290](https://github.com/ClickHouse/ClickHouse/pull/59290) ([Anton Popov](https://github.com/CurtizJ)).
- 降低垂直合并中的内存使用量。[#59340](https://github.com/ClickHouse/ClickHouse/pull/59340) ([Anton Popov](https://github.com/CurtizJ)).
- 在更多情况下避免 Keeper 启动期间的大量内存消耗。[#58455](https://github.com/ClickHouse/ClickHouse/pull/58455) ([Antonio Andelic](https://github.com/antonio2368)).
- Keeper 改进:降低存储节点的 Keeper 内存使用量。[#59002](https://github.com/ClickHouse/ClickHouse/pull/59002) ([Antonio Andelic](https://github.com/antonio2368)).
- 更加缓存友好的 final 实现。行为变更说明:以前使用 `FINAL` 修饰符且以单流读取(例如 `max_threads = 1`)的查询会在未明确提供 `ORDER BY` 子句的情况下产生排序输出。当 `enable_vertical_final = true`(默认情况下如此)时,不再保证此行为。[#54366](https://github.com/ClickHouse/ClickHouse/pull/54366) ([Duc Canh Le](https://github.com/canhld94)).
- 绕过 `ReadBufferFromIStream` 中的额外复制,该缓冲区用于例如从 S3 读取。[#56961](https://github.com/ClickHouse/ClickHouse/pull/56961) ([Nikita Taranov](https://github.com/nickitat)).
- 当输入为 Array(Map)/Array(Array(Num)/Array(Array(String))/Array(BigInt)/Array(Decimal) 时,优化数组元素函数。以前的实现进行了超出需要的内存分配。优化后速度提升最高可达约 6 倍,尤其是当输入类型为 Array(Map) 时。[#56403](https://github.com/ClickHouse/ClickHouse/pull/56403) ([李扬](https://github.com/taiyang-li)).
- 在紧凑部分中从列读取多个子列时,仅读取列一次。[#57631](https://github.com/ClickHouse/ClickHouse/pull/57631) ([Kruglov Pavel](https://github.com/Avogar)).
- 重写 `sum(column + constant)` 函数的 AST。这作为 Analyzer 的优化过程可用。[#57853](https://github.com/ClickHouse/ClickHouse/pull/57853) ([Jiebin Sun](https://github.com/jiebinn)).
- 函数 `match` 的求值现在利用跳数索引 `ngrambf_v1` 和 `tokenbf_v1`。[#57882](https://github.com/ClickHouse/ClickHouse/pull/57882) ([凌涛](https://github.com/lingtaolf)).
- 函数 `match` 的求值现在利用倒排索引。[#58284](https://github.com/ClickHouse/ClickHouse/pull/58284) ([凌涛](https://github.com/lingtaolf)).
- MergeTree `FINAL` 不比较来自同一非 L0 部分的行。[#58142](https://github.com/ClickHouse/ClickHouse/pull/58142) ([Duc Canh Le](https://github.com/canhld94)).
- 加速 iota 调用(用连续数字填充数组)。[#58271](https://github.com/ClickHouse/ClickHouse/pull/58271) ([Raúl Marín](https://github.com/Algunenano)).
- 加速非数值类型的 MIN/MAX。[#58334](https://github.com/ClickHouse/ClickHouse/pull/58334) ([Raúl Marín](https://github.com/Algunenano)).
- 使用 BMI2/SSE 内部函数优化过滤器组合(如多阶段 PREWHERE 中)。[#58800](https://github.com/ClickHouse/ClickHouse/pull/58800) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
- 在 `clickhouse-local` 中减少使用一个线程。[#58968](https://github.com/ClickHouse/ClickHouse/pull/58968) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- 当类型为 Nullable 时,提高 `multiIf` 函数性能。[#57745](https://github.com/ClickHouse/ClickHouse/pull/57745) ([KevinyhZou](https://github.com/KevinyhZou)).
- 添加 `SYSTEM JEMALLOC PURGE` 用于清除未使用的 jemalloc 页面,添加 `SYSTEM JEMALLOC [ ENABLE | DISABLE | FLUSH ] PROFILE` 用于在启用分析器时控制 jemalloc 配置文件。在 Keeper 中添加与 jemalloc 相关的 4LW 命令:`jmst` 用于转储 jemalloc 统计信息,`jmfp`、`jmep`、`jmdp` 用于在启用分析器时控制 jemalloc 配置文件。[#58665](https://github.com/ClickHouse/ClickHouse/pull/58665) ([Antonio Andelic](https://github.com/antonio2368)).
- 降低备份到 S3 时的内存消耗。[#58962](https://github.com/ClickHouse/ClickHouse/pull/58962) ([Vitaly Baranov](https://github.com/vitlibar)).





#### 改进 {#improvement-11}

- Added comments (brief descriptions) to all columns of system tables. There are several reasons for this: - We use system tables a lot, and sometimes it could be very difficult for developer to understand the purpose and the meaning of a particular column. - We change (add new ones or modify existing) system tables a lot and the documentation for them is always outdated. For example take a look at the documentation page for [`system.parts`](/operations/system-tables/parts). It misses a lot of columns - We would like to eventually generate documentation directly from ClickHouse. [#58356](https://github.com/ClickHouse/ClickHouse/pull/58356) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Allow queries without aliases for subqueries for `PASTE JOIN`. [#58654](https://github.com/ClickHouse/ClickHouse/pull/58654) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Enable `MySQL`/`MariaDB` integration on macOS. This closes [#21191](https://github.com/ClickHouse/ClickHouse/issues/21191). [#46316](https://github.com/ClickHouse/ClickHouse/pull/46316) ([Alexey Milovidov](https://github.com/alexey-milovidov)) ([Robert Schulze](https://github.com/rschu1ze)).
- Disable `max_rows_in_set_to_optimize_join` by default. [#56396](https://github.com/ClickHouse/ClickHouse/pull/56396) ([vdimir](https://github.com/vdimir)).
- Add `<host_name>` config parameter that allows avoiding resolving hostnames in ON CLUSTER DDL queries and Replicated database engines. This mitigates the possibility of the queue being stuck in case of a change in cluster definition. Closes [#57573](https://github.com/ClickHouse/ClickHouse/issues/57573). [#57603](https://github.com/ClickHouse/ClickHouse/pull/57603) ([Nikolay Degterinsky](https://github.com/evillique)).
- Increase `load_metadata_threads` to 16 for the filesystem cache. It will make the server start up faster. [#57732](https://github.com/ClickHouse/ClickHouse/pull/57732) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Add ability to throttle merges/mutations (`max_mutations_bandwidth_for_server`/`max_merges_bandwidth_for_server`). [#57877](https://github.com/ClickHouse/ClickHouse/pull/57877) ([Azat Khuzhin](https://github.com/azat)).
- Replaced undocumented (boolean) column `is_hot_reloadable` in system table `system.server_settings` by (Enum8) column `changeable_without_restart` with possible values `No`, `Yes`, `IncreaseOnly` and `DecreaseOnly`. Also documented the column. [#58029](https://github.com/ClickHouse/ClickHouse/pull/58029) ([skyoct](https://github.com/skyoct)).
- Cluster discovery supports setting username and password, close [#58063](https://github.com/ClickHouse/ClickHouse/issues/58063). [#58123](https://github.com/ClickHouse/ClickHouse/pull/58123) ([vdimir](https://github.com/vdimir)).
- Support query parameters in `ALTER TABLE ... PART`. [#58297](https://github.com/ClickHouse/ClickHouse/pull/58297) ([Azat Khuzhin](https://github.com/azat)).
- Create consumers for Kafka tables on the fly (but keep them for some period - `kafka_consumers_pool_ttl_ms`, since last used), this should fix problem with statistics for `system.kafka_consumers` (that does not consumed when nobody reads from Kafka table, which leads to live memory leak and slow table detach) and also this PR enables stats for `system.kafka_consumers` by default again. [#58310](https://github.com/ClickHouse/ClickHouse/pull/58310) ([Azat Khuzhin](https://github.com/azat)).
- `sparkBar` as an alias to `sparkbar`. [#58335](https://github.com/ClickHouse/ClickHouse/pull/58335) ([凌涛](https://github.com/lingtaolf)).
- Avoid sending `ComposeObject` requests after upload to `GCS`. [#58343](https://github.com/ClickHouse/ClickHouse/pull/58343) ([Azat Khuzhin](https://github.com/azat)).
- Correctly handle keys with dot in the name in configurations XMLs. [#58354](https://github.com/ClickHouse/ClickHouse/pull/58354) ([Azat Khuzhin](https://github.com/azat)).
- Make function `format` return constant on constant arguments. This closes [#58355](https://github.com/ClickHouse/ClickHouse/issues/58355). [#58358](https://github.com/ClickHouse/ClickHouse/pull/58358) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Adding a setting `max_estimated_execution_time` to separate `max_execution_time` and `max_estimated_execution_time`. [#58402](https://github.com/ClickHouse/ClickHouse/pull/58402) ([Zhang Yifan](https://github.com/zhangyifan27)).
- Provide a hint when an invalid database engine name is used. [#58444](https://github.com/ClickHouse/ClickHouse/pull/58444) ([Bharat Nallan](https://github.com/bharatnc)).
- Add settings for better control of indexes type in Arrow dictionary. Use signed integer type for indexes by default as Arrow recommends. Closes [#57401](https://github.com/ClickHouse/ClickHouse/issues/57401). [#58519](https://github.com/ClickHouse/ClickHouse/pull/58519) ([Kruglov Pavel](https://github.com/Avogar)).
- Implement [#58575](https://github.com/ClickHouse/ClickHouse/issues/58575) Support `CLICKHOUSE_PASSWORD_FILE ` environment variable when running the docker image. [#58583](https://github.com/ClickHouse/ClickHouse/pull/58583) ([Eyal Halpern Shalev](https://github.com/Eyal-Shalev)).
- When executing some queries, which require a lot of streams for reading data, the error `"Paste JOIN requires sorted tables only"` was previously thrown. Now the numbers of streams resize to 1 in that case. [#58608](https://github.com/ClickHouse/ClickHouse/pull/58608) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Better message for INVALID_IDENTIFIER error. [#58703](https://github.com/ClickHouse/ClickHouse/pull/58703) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Improved handling of signed numeric literals in normalizeQuery. [#58710](https://github.com/ClickHouse/ClickHouse/pull/58710) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
- Support Point data type for MySQL. [#58721](https://github.com/ClickHouse/ClickHouse/pull/58721) ([Kseniia Sumarokova](https://github.com/kssenii)).
- When comparing a Float32 column and a const string, read the string as Float32 (instead of Float64). [#58724](https://github.com/ClickHouse/ClickHouse/pull/58724) ([Raúl Marín](https://github.com/Algunenano)).
- Improve S3 compatibility, add ECloud EOS storage support. [#58786](https://github.com/ClickHouse/ClickHouse/pull/58786) ([xleoken](https://github.com/xleoken)).
- Allow `KILL QUERY` to cancel backups / restores. This PR also makes running backups and restores visible in `system.processes`. Also, there is a new setting in the server configuration now - `shutdown_wait_backups_and_restores` (default=true) which makes the server either wait on shutdown for all running backups and restores to finish or just cancel them. [#58804](https://github.com/ClickHouse/ClickHouse/pull/58804) ([Vitaly Baranov](https://github.com/vitlibar)).
- Avro format to support ZSTD codec. Closes [#58735](https://github.com/ClickHouse/ClickHouse/issues/58735). [#58805](https://github.com/ClickHouse/ClickHouse/pull/58805) ([flynn](https://github.com/ucasfl)).
- MySQL interface gained support for `net_write_timeout` and `net_read_timeout` settings. `net_write_timeout` is translated into the native `send_timeout` ClickHouse setting and, similarly, `net_read_timeout` into `receive_timeout`. Fixed an issue where it was possible to set MySQL `sql_select_limit` setting only if the entire statement was in upper case. [#58835](https://github.com/ClickHouse/ClickHouse/pull/58835) ([Serge Klochkov](https://github.com/slvrtrn)).
- A better exception message while conflict of creating dictionary and table with the same name. [#58841](https://github.com/ClickHouse/ClickHouse/pull/58841) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Make sure that for custom (created from SQL) disks ether `filesystem_caches_path` (a common directory prefix for all filesystem caches) or `custom_cached_disks_base_directory` (a common directory prefix for only filesystem caches created from custom disks) is specified in server config. `custom_cached_disks_base_directory` has higher priority for custom disks over `filesystem_caches_path`, which is used if the former one is absent. Filesystem cache setting `path` must lie inside that directory, otherwise exception will be thrown preventing disk to be created. This will not affect disks created on an older version and server was upgraded - then the exception will not be thrown to allow the server to successfully start). `custom_cached_disks_base_directory` is added to default server config as `/var/lib/clickhouse/caches/`. Closes [#57825](https://github.com/ClickHouse/ClickHouse/issues/57825). [#58869](https://github.com/ClickHouse/ClickHouse/pull/58869) ([Kseniia Sumarokova](https://github.com/kssenii)).
- MySQL interface gained compatibility with `SHOW WARNINGS`/`SHOW COUNT(*) WARNINGS` queries, though the returned result is always an empty set. [#58929](https://github.com/ClickHouse/ClickHouse/pull/58929) ([Serge Klochkov](https://github.com/slvrtrn)).
- Skip unavailable replicas when executing parallel distributed `INSERT SELECT`. [#58931](https://github.com/ClickHouse/ClickHouse/pull/58931) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Display word-descriptive log level while enabling structured log formatting in json. [#58936](https://github.com/ClickHouse/ClickHouse/pull/58936) ([Tim Liou](https://github.com/wheatdog)).
- MySQL interface gained support for `CAST(x AS SIGNED)` and `CAST(x AS UNSIGNED)` statements via data type aliases: `SIGNED` for Int64, and `UNSIGNED` for UInt64. This improves compatibility with BI tools such as Looker Studio. [#58954](https://github.com/ClickHouse/ClickHouse/pull/58954) ([Serge Klochkov](https://github.com/slvrtrn)).
- Change working directory to the data path in docker container. [#58975](https://github.com/ClickHouse/ClickHouse/pull/58975) ([cangyin](https://github.com/cangyin)).
- Added setting for Azure Blob Storage `azure_max_unexpected_write_error_retries` , can also be set from config under azure section. [#59001](https://github.com/ClickHouse/ClickHouse/pull/59001) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Allow server to start with broken data lake table. Closes [#58625](https://github.com/ClickHouse/ClickHouse/issues/58625). [#59080](https://github.com/ClickHouse/ClickHouse/pull/59080) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Allow to ignore schema evolution in the `Iceberg` table engine and read all data using schema specified by the user on table creation or latest schema parsed from metadata on table creation. This is done under a setting `iceberg_engine_ignore_schema_evolution` that is disabled by default. Note that enabling this setting can lead to incorrect result as in case of evolved schema all data files will be read using the same schema. [#59133](https://github.com/ClickHouse/ClickHouse/pull/59133) ([Kruglov Pavel](https://github.com/Avogar)).
- Prohibit mutable operations (`INSERT`/`ALTER`/`OPTIMIZE`/...) on read-only/write-once storages with a proper `TABLE_IS_READ_ONLY` error (to avoid leftovers). Avoid leaving left-overs on write-once disks (`format_version.txt`) on `CREATE`/`ATTACH`. Ignore `DROP` for `ReplicatedMergeTree` (so as for `MergeTree`). Fix iterating over `s3_plain` (`MetadataStorageFromPlainObjectStorage::iterateDirectory`). Note read-only is `web` disk, and write-once is `s3_plain`. [#59170](https://github.com/ClickHouse/ClickHouse/pull/59170) ([Azat Khuzhin](https://github.com/azat)).
- Fix bug in the experimental `_block_number` column which could lead to logical error during complex combination of `ALTER`s and `merge`s. Fixes [#56202](https://github.com/ClickHouse/ClickHouse/issues/56202). Replaces [#58601](https://github.com/ClickHouse/ClickHouse/issues/58601). [#59295](https://github.com/ClickHouse/ClickHouse/pull/59295) ([alesapin](https://github.com/alesapin)).
- Play UI understands when an exception is returned inside JSON. Adjustment for [#52853](https://github.com/ClickHouse/ClickHouse/issues/52853). [#59303](https://github.com/ClickHouse/ClickHouse/pull/59303) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- `/binary` HTTP handler allows to specify user, host, and optionally, password in the query string. [#59311](https://github.com/ClickHouse/ClickHouse/pull/59311) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Support backups for compressed in-memory tables. This closes [#57893](https://github.com/ClickHouse/ClickHouse/issues/57893). [#59315](https://github.com/ClickHouse/ClickHouse/pull/59315) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Support the `FORMAT` clause in `BACKUP` and `RESTORE` queries. [#59338](https://github.com/ClickHouse/ClickHouse/pull/59338) ([Vitaly Baranov](https://github.com/vitlibar)).
- Function `concatWithSeparator` now supports arbitrary argument types (instead of only `String` and `FixedString` arguments). For example, `SELECT concatWithSeparator('.', 'number', 1)` now returns `number.1`. [#59341](https://github.com/ClickHouse/ClickHouse/pull/59341) ([Robert Schulze](https://github.com/rschu1ze)).

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-7}

- 改进 clickhouse 二进制文件的别名(现在 `ch`/`clickhouse` 根据参数可以是 `clickhouse-local` 或 `clickhouse`),并为新别名添加 bash 自动补全功能。[#58344](https://github.com/ClickHouse/ClickHouse/pull/58344) ([Azat Khuzhin](https://github.com/azat))。
- 在 CI 中添加设置变更检查,以确保所有设置变更都记录在设置变更历史中。[#58555](https://github.com/ClickHouse/ClickHouse/pull/58555) ([Kruglov Pavel](https://github.com/Avogar))。
- 在有状态测试中使用直接从 S3 挂载的表。[#58791](https://github.com/ClickHouse/ClickHouse/pull/58791) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 将整个 `fuzzer.log` 保存为归档文件,而不是只保存最后 10 万行。`tail -n 100000` 经常会删除包含表定义的行。示例:。[#58821](https://github.com/ClickHouse/ClickHouse/pull/58821) ([Dmitry Novik](https://github.com/novikd))。
- 在 macOS Aarch64 上启用 Rust(这将在客户端中添加使用 skim 的模糊搜索功能和 PRQL 语言支持,尽管我认为没有人在 darwin 上托管 ClickHouse,所以我认为这主要是为了客户端中的模糊搜索功能)。[#59272](https://github.com/ClickHouse/ClickHouse/pull/59272) ([Azat Khuzhin](https://github.com/azat))。
- 修复混合 x86_64 和 ARM 集群中的聚合问题 [#59132](https://github.com/ClickHouse/ClickHouse/pull/59132) ([Harry Lee](https://github.com/HarryLeeIBM))。

#### Bug 修复(官方稳定版本中用户可见的异常行为) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-9}


* 为嵌套的 LowCardinality 添加 JOIN 键转换 [#51550](https://github.com/ClickHouse/ClickHouse/pull/51550) ([vdimir](https://github.com/vdimir))。
* 当 `flatten_nested=1` 时，仅对真正的 `Nested` 类型进行展开，而不是对所有的 `Array(Tuple)` 进行展开 [#56132](https://github.com/ClickHouse/ClickHouse/pull/56132) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复了在插入时与投影和 `aggregate_functions_null_for_empty` 设置相关的一个错误。[#56944](https://github.com/ClickHouse/ClickHouse/pull/56944) ([Amos Bird](https://github.com/amosbird))。
* 修复了由于过期的配置文件 UUID 导致的潜在异常 [#57263](https://github.com/ClickHouse/ClickHouse/pull/57263) ([Vasily Nemkov](https://github.com/Enmk))。
* 修复 `StreamingFormatExecutor` 中读缓冲区的处理方式 [#57438](https://github.com/ClickHouse/ClickHouse/pull/57438)（[Kruglov Pavel](https://github.com/Avogar)）。
* 在将数据推送到视图时，如果目标表已被删除，则忽略对应的物化视图 [#57520](https://github.com/ClickHouse/ClickHouse/pull/57520)（[Kruglov Pavel](https://github.com/Avogar)）。
* 消除 `ALTER_METADATA` 与 `MERGE_PARTS` 之间可能存在的竞态条件 [#57755](https://github.com/ClickHouse/ClickHouse/pull/57755) ([Azat Khuzhin](https://github.com/azat))。
* 修复在带有 rollup 的 group by 中表达式顺序错误的问题 [#57786](https://github.com/ClickHouse/ClickHouse/pull/57786) ([Chen768959](https://github.com/Chen768959))。
* 为已废弃的“zero-copy”复制功能提供了一项修复：修复在删除包含损坏的 detached 分片的副本后出现的 blob 丢失问题 [#58333](https://github.com/ClickHouse/ClickHouse/pull/58333) ([Alexander Tokmakov](https://github.com/tavplubix))。
* 允许用户在 user&#95;files&#95;path 中使用符号链接进行操作 [#58447](https://github.com/ClickHouse/ClickHouse/pull/58447) ([Duc Canh Le](https://github.com/canhld94)).
* 修复在 `graphite` 表未指定聚合函数时发生的崩溃 [#58453](https://github.com/ClickHouse/ClickHouse/pull/58453) ([Duc Canh Le](https://github.com/canhld94))。
* 延迟从 StorageKafka 读取，以便在物化视图中支持多次读取 [#58477](https://github.com/ClickHouse/ClickHouse/pull/58477) ([János Benjamin Antal](https://github.com/antaljanosbenjamin))。
* 修复一个关于相交数据部分的低级错误 [#58482](https://github.com/ClickHouse/ClickHouse/pull/58482) ([Alexander Tokmakov](https://github.com/tavplubix)).
* 对仅带 LIMIT 的查询禁用 MergeTreePrefetchedReadPool [#58505](https://github.com/ClickHouse/ClickHouse/pull/58505) ([Maksim Kita](https://github.com/kitaisreal))。
* 在恢复期间启用普通数据库 [#58520](https://github.com/ClickHouse/ClickHouse/pull/58520) ([Jihyuk Bok](https://github.com/tomahawk28)).
* 修复 Apache Hive 线程池读取 ORC/Parquet/... 的方式 [#58537](https://github.com/ClickHouse/ClickHouse/pull/58537) ([sunny](https://github.com/sunny19930321)).
* 在 `system.backup_log` 的 `base_backup_name` 列中隐藏敏感凭据 [#58550](https://github.com/ClickHouse/ClickHouse/pull/58550) ([Daniel Pozo Escalona](https://github.com/danipozo))。
* 用于毫秒和微秒值取整的 `toStartOfInterval` [#58557](https://github.com/ClickHouse/ClickHouse/pull/58557)（[Yarik Briukhovetskyi](https://github.com/yariks5s)）。
* 在 ConcurrentHashJoin 中禁用 `max_joined_block_rows` [#58595](https://github.com/ClickHouse/ClickHouse/pull/58595)（[vdimir](https://github.com/vdimir)）。
* 修复旧分析器中使用 `Nullable` 的 `JOIN` [#58596](https://github.com/ClickHouse/ClickHouse/pull/58596)（[vdimir](https://github.com/vdimir)）。
* `makeDateTime64`：允许使用非常量的小数部分参数 [#58597](https://github.com/ClickHouse/ClickHouse/pull/58597)（[Robert Schulze](https://github.com/rschu1ze)）。
* 修复在符号化内联帧时可能发生的 NULL 解引用问题 [#58607](https://github.com/ClickHouse/ClickHouse/pull/58607) ([Azat Khuzhin](https://github.com/azat)).
* 在重新创建用户或切换角色时改进查询缓存条目的隔离性 [#58611](https://github.com/ClickHouse/ClickHouse/pull/58611) ([Robert Schulze](https://github.com/rschu1ze)).
* 在执行投影优化时修复分区键分析错误 [#58638](https://github.com/ClickHouse/ClickHouse/pull/58638) ([Amos Bird](https://github.com/amosbird))。
* 查询缓存：修复按用户配额 [#58731](https://github.com/ClickHouse/ClickHouse/pull/58731) ([Robert Schulze](https://github.com/rschu1ze)).
* 修复并行窗口函数中的流分区 [#58739](https://github.com/ClickHouse/ClickHouse/pull/58739)（[Dmitry Novik](https://github.com/novikd)）。
* 在 `addBatchLookupTable8` 中修复在抛出异常时发生的重复销毁调用 [#58745](https://github.com/ClickHouse/ClickHouse/pull/58745) ([Raúl Marín](https://github.com/Algunenano))。
* 在关闭过程中不要在 Keeper 中处理请求 [#58765](https://github.com/ClickHouse/ClickHouse/pull/58765) ([Antonio Andelic](https://github.com/antonio2368))。
* 修复 `SlabsPolygonIndex::find` 中的空指针解引用问题 [#58771](https://github.com/ClickHouse/ClickHouse/pull/58771)（[Yarik Briukhovetskyi](https://github.com/yariks5s)）。
* 修复针对 LowCardinality(Nullable) 列的 JSONExtract 函数 [#58808](https://github.com/ClickHouse/ClickHouse/pull/58808) ([vdimir](https://github.com/vdimir))。
* 修复了在通过 `CREATE` 和 `DROP` 频繁创建和删除大量表时，内存使用量意外累积的问题。 [#58831](https://github.com/ClickHouse/ClickHouse/pull/58831) ([Maksim Kita](https://github.com/kitaisreal)).
* 在物化视图中支持多读文件日志存储 [#58877](https://github.com/ClickHouse/ClickHouse/pull/58877)（[János Benjamin Antal](https://github.com/antaljanosbenjamin)）。
* 对 S3 的 access key id 添加了限制。[#58900](https://github.com/ClickHouse/ClickHouse/pull/58900) ([MikhailBurdukov](https://github.com/MikhailBurdukov))。
* 修复在加载建议时可能发生的 `clickhouse-local` 崩溃 [#58907](https://github.com/ClickHouse/ClickHouse/pull/58907) ([Kruglov Pavel](https://github.com/Avogar))。
* 修复在使用 `indexHint` 时发生的崩溃 [#58911](https://github.com/ClickHouse/ClickHouse/pull/58911) ([Dmitry Novik](https://github.com/novikd))。
* 修复 StorageURL 在服务器重启后遗失 headers 的问题 [#58933](https://github.com/ClickHouse/ClickHouse/pull/58933) ([Michael Kolupaev](https://github.com/al13n321)).
* Analyzer：修复使用插入块的存储替换 [#58958](https://github.com/ClickHouse/ClickHouse/pull/58958) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
* 修复 `ReadBufferFromZipArchive` 中的 seek 操作 [#58966](https://github.com/ClickHouse/ClickHouse/pull/58966)（[Michael Kolupaev](https://github.com/al13n321)）。
* 针对实验性倒排索引的修复（请勿在生产环境中使用）：现在对倒排索引执行 `DROP INDEX` 时，会从持久化存储中删除所有相关文件 [#59040](https://github.com/ClickHouse/ClickHouse/pull/59040) ([mochi](https://github.com/MochiXu))。
* 修复 `query_factories_info` 上的数据竞争问题 [#59049](https://github.com/ClickHouse/ClickHouse/pull/59049) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 禁用对“Too many redirects”错误的重试 [#59099](https://github.com/ClickHouse/ClickHouse/pull/59099)（[skyoct](https://github.com/skyoct)）。
* 修复未启动数据库时关闭操作导致的死锁 [#59137](https://github.com/ClickHouse/ClickHouse/pull/59137) ([Sergei Trifonov](https://github.com/serxa)).
* 修复：分布式查询中的 `LIMIT BY` 和 `LIMIT` 问题 [#59153](https://github.com/ClickHouse/ClickHouse/pull/59153)（[Igor Nikonov](https://github.com/devcrafter)）。
* 修复在 `toString` 中使用可为空时区时发生的崩溃 [#59190](https://github.com/ClickHouse/ClickHouse/pull/59190) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
* 修复因错误文件路径导致的 Iceberg 元数据中止问题 [#59275](https://github.com/ClickHouse/ClickHouse/pull/59275) ([Kruglov Pavel](https://github.com/Avogar))。
* 修复 Rust 目标中 `select` 语句的架构名称 [#59307](https://github.com/ClickHouse/ClickHouse/pull/59307) ([p1rattttt](https://github.com/p1rattttt))。
* 修复在从 `system.tables` 查询且在 IN 子句中使用子查询时，与“not-ready set”相关的逻辑错误。[#59351](https://github.com/ClickHouse/ClickHouse/pull/59351)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。





## [2023 年更新日志](/whats-new/changelog/2023) {#changelog-for-2023}
