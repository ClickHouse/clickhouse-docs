---
slug: /whats-new/changelog/2023
sidebar_position: 4
sidebar_label: "2023"
title: "2023 更新日志"
description: "2023 年更新日志"
keywords:
  [
    "ClickHouse 2023",
    "2023 更新日志",
    "发行说明",
    "版本历史",
    "性能改进"
  ]
doc_type: "changelog"
---

### 目录 {#table-of-contents}

**[ClickHouse release v23.12, 2023-12-28](#2312)**<br/>
**[ClickHouse release v23.11, 2023-12-06](#2311)**<br/>
**[ClickHouse release v23.10, 2023-11-02](#2310)**<br/>
**[ClickHouse release v23.9, 2023-09-28](#239)**<br/>
**[ClickHouse release v23.8 LTS, 2023-08-31](#238)**<br/>
**[ClickHouse release v23.7, 2023-07-27](#237)**<br/>
**[ClickHouse release v23.6, 2023-06-30](#236)**<br/>
**[ClickHouse release v23.5, 2023-06-08](#235)**<br/>
**[ClickHouse release v23.4, 2023-04-26](#234)**<br/>
**[ClickHouse release v23.3 LTS, 2023-03-30](#233)**<br/>
**[ClickHouse release v23.2, 2023-02-23](#232)**<br/>
**[ClickHouse release v23.1, 2023-01-25](#231)**<br/>
**[2022 年更新日志](/whats-new/changelog/2022/)**<br/>

### <a id="2312"></a> ClickHouse release 23.12, 2023-12-28 {#2312}

#### 向后不兼容的变更 {#backward-incompatible-change}

- 修复了 TTL 表达式中非确定性函数的检查。以前,在某些情况下可以创建包含非确定性函数的 TTL 表达式,这可能导致后续出现未定义的行为。此修复解决了 [#37250](https://github.com/ClickHouse/ClickHouse/issues/37250)。默认情况下禁止使用不依赖于表中任何列的 TTL 表达式。可以通过 `SET allow_suspicious_ttl_expressions = 1` 或 `SET compatibility = '23.11'` 重新允许。关闭了 [#37286](https://github.com/ClickHouse/ClickHouse/issues/37286)。[#51858](https://github.com/ClickHouse/ClickHouse/pull/51858) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- MergeTree 设置 `clean_deleted_rows` 已弃用,不再有任何效果。默认情况下不允许在 `OPTIMIZE` 中使用 `CLEANUP` 关键字(可以通过 `allow_experimental_replacing_merge_with_cleanup` 设置解锁)。[#58267](https://github.com/ClickHouse/ClickHouse/pull/58267) ([Alexander Tokmakov](https://github.com/tavplubix))。此修复解决了 [#57930](https://github.com/ClickHouse/ClickHouse/issues/57930)。关闭了 [#54988](https://github.com/ClickHouse/ClickHouse/issues/54988)。关闭了 [#54570](https://github.com/ClickHouse/ClickHouse/issues/54570)。关闭了 [#50346](https://github.com/ClickHouse/ClickHouse/issues/50346)。关闭了 [#47579](https://github.com/ClickHouse/ClickHouse/issues/47579)。该功能必须被移除,因为它不够完善。我们必须尽快移除它,因为没有其他选择。[#57932](https://github.com/ClickHouse/ClickHouse/pull/57932) ([Alexey Milovidov](https://github.com/alexey-milovidov))。


#### 新功能 {#new-feature}

- 实现可刷新物化视图,该功能在 [#33919](https://github.com/ClickHouse/ClickHouse/issues/33919) 中被提出。[#56946](https://github.com/ClickHouse/ClickHouse/pull/56946) ([Michael Kolupaev](https://github.com/al13n321), [Michael Guzov](https://github.com/koloshmet))。
- 引入 `PASTE JOIN`,允许用户无需 `ON` 子句即可简单地按行号连接表。示例:`SELECT * FROM (SELECT number AS a FROM numbers(2)) AS t1 PASTE JOIN (SELECT number AS a FROM numbers(2) ORDER BY a DESC) AS t2`。[#57995](https://github.com/ClickHouse/ClickHouse/pull/57995) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- `ORDER BY` 子句现在支持指定 `ALL`,表示 ClickHouse 将按 `SELECT` 子句中的所有列进行排序。示例:`SELECT col1, col2 FROM tab WHERE [...] ORDER BY ALL`。[#57875](https://github.com/ClickHouse/ClickHouse/pull/57875) ([zhongyuankai](https://github.com/zhongyuankai))。
- 添加了新的变更命令 `ALTER TABLE <table> APPLY DELETED MASK`,允许强制应用轻量级删除写入的掩码,并从磁盘中删除标记为已删除的行。[#57433](https://github.com/ClickHouse/ClickHouse/pull/57433) ([Anton Popov](https://github.com/CurtizJ))。
- 处理程序 `/binary` 可打开 ClickHouse 二进制文件内符号的可视化查看器。[#58211](https://github.com/ClickHouse/ClickHouse/pull/58211) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 添加了新的 SQL 函数 `sqid` 用于生成 Sqids (https://sqids.org/),示例:`SELECT sqid(125, 126)`。[#57512](https://github.com/ClickHouse/ClickHouse/pull/57512) ([Robert Schulze](https://github.com/rschu1ze))。
- 添加新函数 `seriesPeriodDetectFFT` 以使用 FFT 检测序列周期。[#57574](https://github.com/ClickHouse/ClickHouse/pull/57574) ([Bhavna Jindal](https://github.com/bhavnajindal))。
- 添加 HTTP 端点用于检查 Keeper 是否准备好接受流量。[#55876](https://github.com/ClickHouse/ClickHouse/pull/55876) ([Konstantin Bogdanov](https://github.com/thevar1able))。
- 为模式推断添加 'union' 模式。在此模式下,结果表模式是所有文件模式的并集(即从每个文件推断模式)。模式推断的模式由设置 `schema_inference_mode` 控制,有两个可能的值 - `default` 和 `union`。关闭 [#55428](https://github.com/ClickHouse/ClickHouse/issues/55428)。[#55892](https://github.com/ClickHouse/ClickHouse/pull/55892) ([Kruglov Pavel](https://github.com/Avogar))。
- 添加新设置 `input_format_csv_try_infer_numbers_from_strings`,允许从 CSV 格式的字符串中推断数字。关闭 [#56455](https://github.com/ClickHouse/ClickHouse/issues/56455)。[#56859](https://github.com/ClickHouse/ClickHouse/pull/56859) ([Kruglov Pavel](https://github.com/Avogar))。
- 当数据库或表的数量超过可配置的阈值时,向用户显示警告。[#57375](https://github.com/ClickHouse/ClickHouse/pull/57375) ([凌涛](https://github.com/lingtaolf))。
- 具有 `HASHED_ARRAY`(和 `COMPLEX_KEY_HASHED_ARRAY`)布局的字典支持 `SHARDS`,类似于 `HASHED`。[#57544](https://github.com/ClickHouse/ClickHouse/pull/57544) ([vdimir](https://github.com/vdimir))。
- 添加异步指标,用于统计内存中主键总字节数和已分配主键总字节数。[#57551](https://github.com/ClickHouse/ClickHouse/pull/57551) ([Bharat Nallan](https://github.com/bharatnc))。
- 添加 `SHA512_256` 函数。[#57645](https://github.com/ClickHouse/ClickHouse/pull/57645) ([Bharat Nallan](https://github.com/bharatnc))。
- 添加 `FORMAT_BYTES` 作为 `formatReadableSize` 的别名。[#57592](https://github.com/ClickHouse/ClickHouse/pull/57592) ([Bharat Nallan](https://github.com/bharatnc))。
- 允许向 `s3` 表函数传递可选的会话令牌。[#57850](https://github.com/ClickHouse/ClickHouse/pull/57850) ([Shani Elharrar](https://github.com/shanielh))。
- 引入新设置 `http_make_head_request`。如果关闭此设置,URL 表引擎将不会执行 HEAD 请求来确定文件大小。这对于支持低效、配置错误或功能不足的 HTTP 服务器是必需的。[#54602](https://github.com/ClickHouse/ClickHouse/pull/54602) ([Fionera](https://github.com/fionera))。
- 现在可以在索引(非主键)定义中引用 ALIAS 列(问题 [#55650](https://github.com/ClickHouse/ClickHouse/issues/55650))。示例:`CREATE TABLE tab(col UInt32, col_alias ALIAS col + 1, INDEX idx (col_alias) TYPE minmax) ENGINE = MergeTree ORDER BY col;`。[#57546](https://github.com/ClickHouse/ClickHouse/pull/57546) ([Robert Schulze](https://github.com/rschu1ze))。
- 添加了新设置 `readonly`,可用于指定 S3 磁盘为只读。这对于在 `s3_plain` 类型的磁盘上创建表,同时对底层 S3 存储桶仅具有只读访问权限时非常有用。[#57977](https://github.com/ClickHouse/ClickHouse/pull/57977) ([Pengyuan Bian](https://github.com/bianpengyuan))。
- MergeTree 表中的主键分析现在将应用于包含虚拟列 `_part_offset`(可选地与 `_part` 一起)的谓词。此功能可以作为一种特殊的二级索引。[#58224](https://github.com/ClickHouse/ClickHouse/pull/58224) ([Amos Bird](https://github.com/amosbird))。





#### 性能改进 {#performance-improvement}

- 在 FINAL 处理期间从 MergeTree 表中提取非相交的数据部分范围。这样可以避免对这些非相交数据部分范围执行额外的 FINAL 逻辑。当具有相同主键的重复值数量较少时,性能将与不使用 FINAL 时几乎相同。当设置 `do_not_merge_across_partitions_select_final` 时,可改进 MergeTree FINAL 的读取性能。[#58120](https://github.com/ClickHouse/ClickHouse/pull/58120) ([Maksim Kita](https://github.com/kitaisreal))。
- 在 S3 磁盘之间进行复制时使用 S3 服务器端复制,而不是通过缓冲区复制。改进了 `BACKUP/RESTORE` 操作和 `clickhouse-disks copy` 命令的性能。[#56744](https://github.com/ClickHouse/ClickHouse/pull/56744) ([MikhailBurdukov](https://github.com/MikhailBurdukov))。
- Hash JOIN 现在遵循 `max_joined_block_size_rows` 设置,不会为 `ALL JOIN` 生成过大的数据块。[#56996](https://github.com/ClickHouse/ClickHouse/pull/56996) ([vdimir](https://github.com/vdimir))。
- 更早地释放聚合所用的内存。这可以避免不必要的外部聚合。[#57691](https://github.com/ClickHouse/ClickHouse/pull/57691) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 改进字符串序列化的性能。[#57717](https://github.com/ClickHouse/ClickHouse/pull/57717) ([Maksim Kita](https://github.com/kitaisreal))。
- 支持对 `Merge` 引擎表进行简单计数优化。[#57867](https://github.com/ClickHouse/ClickHouse/pull/57867) ([skyoct](https://github.com/skyoct))。
- 在某些情况下优化了聚合操作。[#57872](https://github.com/ClickHouse/ClickHouse/pull/57872) ([Anton Popov](https://github.com/CurtizJ))。
- `hasAny` 函数现在可以利用全文跳数索引。[#57878](https://github.com/ClickHouse/ClickHouse/pull/57878) ([Jpnock](https://github.com/Jpnock))。
- 函数 `if(cond, then, else)`(及其别名 `cond ? then : else`)已优化为使用无分支求值。[#57885](https://github.com/ClickHouse/ClickHouse/pull/57885) ([zhanglistar](https://github.com/zhanglistar))。
- 如果分区键表达式仅包含主键表达式中的列,MergeTree 会自动推导 `do_not_merge_across_partitions_select_final` 设置。[#58218](https://github.com/ClickHouse/ClickHouse/pull/58218) ([Maksim Kita](https://github.com/kitaisreal))。
- 加速原生类型的 `MIN` 和 `MAX` 操作。[#58231](https://github.com/ClickHouse/ClickHouse/pull/58231) ([Raúl Marín](https://github.com/Algunenano))。
- 为文件系统缓存实现 `SLRU` 缓存策略。[#57076](https://github.com/ClickHouse/ClickHouse/pull/57076) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 后台获取的每个端点连接数限制从 `15` 提高到 `background_fetches_pool_size` 设置的值。- MergeTree 级别的设置 `replicated_max_parallel_fetches_for_host` 已废弃 - MergeTree 级别的设置 `replicated_fetches_http_connection_timeout`、`replicated_fetches_http_send_timeout` 和 `replicated_fetches_http_receive_timeout` 已移至服务器级别。- 设置 `keep_alive_timeout` 已添加到服务器级别设置列表中。[#57523](https://github.com/ClickHouse/ClickHouse/pull/57523) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 使查询 `system.filesystem_cache` 不再占用大量内存。[#57687](https://github.com/ClickHouse/ClickHouse/pull/57687) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 减少字符串反序列化时的内存使用。[#57787](https://github.com/ClickHouse/ClickHouse/pull/57787) ([Maksim Kita](https://github.com/kitaisreal))。
- 更高效的 Enum 构造函数 - 当 Enum 包含大量值时效果显著。[#57887](https://github.com/ClickHouse/ClickHouse/pull/57887) ([Duc Canh Le](https://github.com/canhld94))。
- 改进从文件系统缓存读取的方式:始终使用 `pread` 方法。[#57970](https://github.com/ClickHouse/ClickHouse/pull/57970) ([Nikita Taranov](https://github.com/nickitat))。
- 在逻辑表达式优化器中为 AND notEquals 链添加优化。此优化仅在启用实验性分析器时可用。[#58214](https://github.com/ClickHouse/ClickHouse/pull/58214) ([Kevin Mingtarja](https://github.com/kevinmingtarja))。





#### 改进 {#improvement}

- 支持 Keeper 的软内存限制。当内存使用接近最大值时将拒绝请求。[#57271](https://github.com/ClickHouse/ClickHouse/pull/57271) ([Han Fei](https://github.com/hanfei1991)). [#57699](https://github.com/ClickHouse/ClickHouse/pull/57699) ([Han Fei](https://github.com/hanfei1991)).
- 使分布式表的插入操作能够正确处理更新后的集群配置。当集群节点列表动态更新时,分布式表的目录监视器将同步更新。[#42826](https://github.com/ClickHouse/ClickHouse/pull/42826) ([zhongyuankai](https://github.com/zhongyuankai)).
- 不允许创建具有不一致合并参数的复制表。[#56833](https://github.com/ClickHouse/ClickHouse/pull/56833) ([Duc Canh Le](https://github.com/canhld94)).
- 在 `system.tables` 中显示未压缩大小。[#56618](https://github.com/ClickHouse/ClickHouse/issues/56618). [#57186](https://github.com/ClickHouse/ClickHouse/pull/57186) ([Chen Lixiang](https://github.com/chenlx0)).
- 为 `Distributed` 表添加 `skip_unavailable_shards` 设置,类似于相应的查询级设置。关闭 [#43666](https://github.com/ClickHouse/ClickHouse/issues/43666). [#57218](https://github.com/ClickHouse/ClickHouse/pull/57218) ([Gagan Goel](https://github.com/tntnatbry)).
- 函数 `substring`(别名:`substr`、`mid`)现在可以与 `Enum` 类型一起使用。以前,第一个函数参数必须是 `String` 或 `FixedString` 类型的值。这提高了通过 MySQL 接口与第三方工具(如 Tableau)的兼容性。[#57277](https://github.com/ClickHouse/ClickHouse/pull/57277) ([Serge Klochkov](https://github.com/slvrtrn)).
- 函数 `format` 现在支持任意参数类型(而不仅仅是 `String` 和 `FixedString` 参数)。这对于计算 `SELECT format('The {0} to all questions is {1}', 'answer', 42)` 很重要。[#57549](https://github.com/ClickHouse/ClickHouse/pull/57549) ([Robert Schulze](https://github.com/rschu1ze)).
- 允许 `date_trunc` 函数的第一个参数不区分大小写。现在支持两种写法:`SELECT date_trunc('day', now())` 和 `SELECT date_trunc('DAY', now())`。[#57624](https://github.com/ClickHouse/ClickHouse/pull/57624) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- 当表不存在时提供更好的提示信息。[#57342](https://github.com/ClickHouse/ClickHouse/pull/57342) ([Bharat Nallan](https://github.com/bharatnc)).
- 允许在查询时覆盖 `max_partition_size_to_drop` 和 `max_table_size_to_drop` 服务器设置。[#57452](https://github.com/ClickHouse/ClickHouse/pull/57452) ([Jordi Villar](https://github.com/jrdi)).
- 稍微改进了 JSON 格式中未命名元组的推断。[#57751](https://github.com/ClickHouse/ClickHouse/pull/57751) ([Kruglov Pavel](https://github.com/Avogar)).
- 添加连接到 Keeper 时的只读标志支持(修复 [#53749](https://github.com/ClickHouse/ClickHouse/issues/53749))。[#57479](https://github.com/ClickHouse/ClickHouse/pull/57479) ([Mikhail Koviazin](https://github.com/mkmkme)).
- 修复由于"没有此类文件或目录"导致的分布式发送可能卡住的问题(在从磁盘恢复批次期间)。修复 `system.distribution_queue` 中 `error_count` 可能出现的问题(在 `distributed_directory_monitor_max_sleep_time_ms` >5分钟的情况下)。引入性能事件以跟踪异步 INSERT 失败 - `DistributedAsyncInsertionFailures`。[#57480](https://github.com/ClickHouse/ClickHouse/pull/57480) ([Azat Khuzhin](https://github.com/azat)).
- 在 `MaterializedPostgreSQL` 中支持 PostgreSQL 生成列和默认列值(实验性功能)。关闭 [#40449](https://github.com/ClickHouse/ClickHouse/issues/40449). [#57568](https://github.com/ClickHouse/ClickHouse/pull/57568) ([Kseniia Sumarokova](https://github.com/kssenii)).
- 允许在不重启服务器的情况下应用某些文件系统缓存配置设置更改。[#57578](https://github.com/ClickHouse/ClickHouse/pull/57578) ([Kseniia Sumarokova](https://github.com/kssenii)).
- 正确处理带有空数组的 PostgreSQL 表结构。[#57618](https://github.com/ClickHouse/ClickHouse/pull/57618) ([Mike Kot](https://github.com/myrrc)).
- 将自上次服务器重启以来发生的错误总数作为 `ClickHouseErrorMetric_ALL` 指标公开。[#57627](https://github.com/ClickHouse/ClickHouse/pull/57627) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- 允许配置文件中的节点使用 `from_env`/`from_zk` 引用和带有 replace=1 的非空元素。[#57628](https://github.com/ClickHouse/ClickHouse/pull/57628) ([Azat Khuzhin](https://github.com/azat)).
- 表函数 `fuzzJSON`,允许生成大量格式错误的 JSON 用于模糊测试。[#57646](https://github.com/ClickHouse/ClickHouse/pull/57646) ([Julia Kartseva](https://github.com/jkartseva)).
- 允许 IPv6 到 UInt128 的转换和二进制算术运算。[#57707](https://github.com/ClickHouse/ClickHouse/pull/57707) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- 为 `async inserts deduplication cache` 添加设置 - 等待缓存更新的时长。弃用设置 `async_block_ids_cache_min_update_interval_ms`。现在缓存仅在发生冲突时更新。[#57743](https://github.com/ClickHouse/ClickHouse/pull/57743) ([alesapin](https://github.com/alesapin)).
- `sleep()` 函数现在可以使用 `KILL QUERY` 取消。[#57746](https://github.com/ClickHouse/ClickHouse/pull/57746) ([Vitaly Baranov](https://github.com/vitlibar)).
- 禁止在实验性 `Replicated` 数据库中对 `Replicated` 表引擎使用 `CREATE TABLE ... AS SELECT` 查询,因为不支持此操作。参考 [#35408](https://github.com/ClickHouse/ClickHouse/issues/35408). [#57796](https://github.com/ClickHouse/ClickHouse/pull/57796) ([Nikolay Degterinsky](https://github.com/evillique)).
- 修复并改进外部数据库的查询转换,以递归获取所有兼容的谓词。[#57888](https://github.com/ClickHouse/ClickHouse/pull/57888) ([flynn](https://github.com/ucasfl)).
- 支持动态重新加载文件系统缓存大小。关闭 [#57866](https://github.com/ClickHouse/ClickHouse/issues/57866). [#57897](https://github.com/ClickHouse/ClickHouse/pull/57897) ([Kseniia Sumarokova](https://github.com/kssenii)).
- 正确支持阻塞了 SIGRTMIN 的线程的 `system.stack_trace`(这些线程可能存在于低质量的外部库中,如 Apache rdkafka)。[#57907](https://github.com/ClickHouse/ClickHouse/pull/57907) ([Azat Khuzhin](https://github.com/azat)). 并且仅在信号未被阻塞时才向线程发送信号,以避免在没有意义时等待 `storage_system_stack_trace_pipe_read_timeout_ms`。[#58136](https://github.com/ClickHouse/ClickHouse/pull/58136) ([Azat Khuzhin](https://github.com/azat)).
- 在仲裁插入检查中容忍 keeper 故障。[#57986](https://github.com/ClickHouse/ClickHouse/pull/57986) ([Raúl Marín](https://github.com/Algunenano)).
- 将最大/峰值 RSS(`MemoryResidentMax`)添加到 system.asynchronous_metrics。[#58095](https://github.com/ClickHouse/ClickHouse/pull/58095) ([Azat Khuzhin](https://github.com/azat)).
- 此 PR 允许用户在非默认区域时使用 s3 样式链接(`https://` 和 `s3://`)而无需指定区域。如果用户指定了错误的区域,也会找到正确的区域。[#58148](https://github.com/ClickHouse/ClickHouse/pull/58148) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- `clickhouse-format --obfuscate` 将识别 Settings、MergeTreeSettings 和时区,并保持其名称不变。[#58179](https://github.com/ClickHouse/ClickHouse/pull/58179) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- 在 `ZipArchiveWriter` 中添加显式 `finalize()` 函数。简化 `ZipArchiveWriter` 中过于复杂的代码。这修复了 [#58074](https://github.com/ClickHouse/ClickHouse/issues/58074). [#58202](https://github.com/ClickHouse/ClickHouse/pull/58202) ([Vitaly Baranov](https://github.com/vitlibar)).
- 使具有相同路径的缓存使用相同的缓存对象。此行为以前存在,但在 23.4 中被破坏。如果具有相同路径的此类缓存具有不同的缓存设置集,将抛出异常,表示不允许这样做。[#58264](https://github.com/ClickHouse/ClickHouse/pull/58264) ([Kseniia Sumarokova](https://github.com/kssenii)).
- 并行副本(实验性功能):友好的设置 [#57542](https://github.com/ClickHouse/ClickHouse/pull/57542) ([Igor Nikonov](https://github.com/devcrafter)).
- 并行副本(实验性功能):公告响应处理改进 [#57749](https://github.com/ClickHouse/ClickHouse/pull/57749) ([Igor Nikonov](https://github.com/devcrafter)).
- 并行副本(实验性功能):在 `ParallelReplicasReadingCoordinator` 中更加尊重 `min_number_of_marks` [#57763](https://github.com/ClickHouse/ClickHouse/pull/57763) ([Nikita Taranov](https://github.com/nickitat)).
- 并行副本(实验性功能):禁用带有 IN(子查询)的并行副本 [#58133](https://github.com/ClickHouse/ClickHouse/pull/58133) ([Igor Nikonov](https://github.com/devcrafter)).
- 并行副本(实验性功能):添加性能事件 'ParallelReplicasUsedCount' [#58173](https://github.com/ClickHouse/ClickHouse/pull/58173) ([Igor Nikonov](https://github.com/devcrafter)).
- 非 POST 请求(如 HEAD)将与 GET 类似为只读。[#58060](https://github.com/ClickHouse/ClickHouse/pull/58060) ([San](https://github.com/santrancisco)).
- 向 `system.part_log` 添加 `bytes_uncompressed` 列 [#58167](https://github.com/ClickHouse/ClickHouse/pull/58167) ([Jordi Villar](https://github.com/jrdi)).
- 向 `system.backups` 和 `system.backup_log` 表添加基础备份名称 [#58178](https://github.com/ClickHouse/ClickHouse/pull/58178) ([Pradeep Chhetri](https://github.com/chhetripradeep)).
- 添加在 clickhouse-local 命令行中指定查询参数的支持 [#58210](https://github.com/ClickHouse/ClickHouse/pull/58210) ([Pradeep Chhetri](https://github.com/chhetripradeep)).

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement}

- 随机化更多设置 [#39663](https://github.com/ClickHouse/ClickHouse/pull/39663) ([Anton Popov](https://github.com/CurtizJ))。
- 在 CI 中随机化已禁用的优化 [#57315](https://github.com/ClickHouse/ClickHouse/pull/57315) ([Raúl Marín](https://github.com/Algunenano))。
- 允许在 macOS 上使用 Azure 相关的表引擎/函数。[#51866](https://github.com/ClickHouse/ClickHouse/pull/51866) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- ClickHouse Fast Test 现在使用 Musl 代替 GLibc。[#57711](https://github.com/ClickHouse/ClickHouse/pull/57711) ([Alexey Milovidov](https://github.com/alexey-milovidov))。完全静态的 Musl 构建版本可从 CI 下载。
- 为每次提交运行 ClickBench。此举解决了 [#57708](https://github.com/ClickHouse/ClickHouse/issues/57708)。[#57712](https://github.com/ClickHouse/ClickHouse/pull/57712) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 从外部库中移除有害的 C/POSIX `select` 函数的使用。[#57467](https://github.com/ClickHouse/ClickHouse/pull/57467) ([Igor Nikonov](https://github.com/devcrafter))。
- 为方便起见,仅在 ClickHouse Cloud 中可用的设置现在也将出现在开源 ClickHouse 构建中。[#57638](https://github.com/ClickHouse/ClickHouse/pull/57638) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。


#### Bug Fix (官方稳定版本中用户可见的错误行为) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release}

- 修复了 TTL GROUP BY 中排序顺序可能被破坏的问题 [#49103](https://github.com/ClickHouse/ClickHouse/pull/49103) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 修复：拆分 `lttb` 分桶策略,第一个桶和最后一个桶应仅包含单个点 [#57003](https://github.com/ClickHouse/ClickHouse/pull/57003) ([FFish](https://github.com/wxybear))。
- 修复 `Template` 格式在错误后同步期间可能出现的死锁 [#57004](https://github.com/ClickHouse/ClickHouse/pull/57004) ([Kruglov Pavel](https://github.com/Avogar))。
- 修复在跳过大量错误时解析文件过早停止的问题 [#57006](https://github.com/ClickHouse/ClickHouse/pull/57006) ([Kruglov Pavel](https://github.com/Avogar))。
- 防止通过 `dictionary` 表函数绕过字典的 ACL [#57362](https://github.com/ClickHouse/ClickHouse/pull/57362) ([Salvatore Mesoraca](https://github.com/aiven-sal))。
- 修复 Fuzzer 发现的另一个"非就绪集合"错误。[#57423](https://github.com/ClickHouse/ClickHouse/pull/57423) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 修复有关 PostgreSQL `array_ndims` 使用的多个问题。[#57436](https://github.com/ClickHouse/ClickHouse/pull/57436) ([Ryan Jacobs](https://github.com/ryanmjacobs))。
- 修复写锁超时后 RWLock 不一致的问题 [#57454](https://github.com/ClickHouse/ClickHouse/pull/57454) ([Vitaly Baranov](https://github.com/vitlibar))。修复写锁超时后 RWLock 不一致的问题(再次修复) [#57733](https://github.com/ClickHouse/ClickHouse/pull/57733) ([Vitaly Baranov](https://github.com/vitlibar))。
- 修复：在构建推送到视图链时不排除临时列 [#57461](https://github.com/ClickHouse/ClickHouse/pull/57461) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
- MaterializedPostgreSQL(实验性问题)：修复问题 [#41922](https://github.com/ClickHouse/ClickHouse/issues/41922),为 [#41923](https://github.com/ClickHouse/ClickHouse/issues/41923) 添加测试 [#57515](https://github.com/ClickHouse/ClickHouse/pull/57515) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 在管理复制访问实体的 grant/revoke 查询中忽略 ON CLUSTER 子句。[#57538](https://github.com/ClickHouse/ClickHouse/pull/57538) ([MikhailBurdukov](https://github.com/MikhailBurdukov))。
- 修复 clickhouse-local 中的崩溃 [#57553](https://github.com/ClickHouse/ClickHouse/pull/57553) ([Nikolay Degterinsky](https://github.com/evillique))。
- Hash JOIN 的修复。[#57564](https://github.com/ClickHouse/ClickHouse/pull/57564) ([vdimir](https://github.com/vdimir))。
- 修复 PostgreSQL 源中可能出现的错误 [#57567](https://github.com/ClickHouse/ClickHouse/pull/57567) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 修复嵌套 LowCardinality 的 Hash JOIN 中的类型校正。[#57614](https://github.com/ClickHouse/ClickHouse/pull/57614) ([vdimir](https://github.com/vdimir))。
- 通过正确禁止并行读取来避免 `system.stack_trace` 挂起。[#57641](https://github.com/ClickHouse/ClickHouse/pull/57641) ([Azat Khuzhin](https://github.com/azat))。
- 修复使用 `any(...) RESPECT NULL` 聚合稀疏列时的错误 [#57710](https://github.com/ClickHouse/ClickHouse/pull/57710) ([Azat Khuzhin](https://github.com/azat))。
- 修复一元运算符解析 [#57713](https://github.com/ClickHouse/ClickHouse/pull/57713) ([Nikolay Degterinsky](https://github.com/evillique))。
- 修复实验性表引擎 `MaterializedPostgreSQL` 的依赖加载。[#57754](https://github.com/ClickHouse/ClickHouse/pull/57754) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 修复 BACKUP/RESTORE ON CLUSTER 中断开连接节点的重试 [#57764](https://github.com/ClickHouse/ClickHouse/pull/57764) ([Vitaly Baranov](https://github.com/vitlibar))。
- 修复部分物化投影情况下外部聚合的结果 [#57790](https://github.com/ClickHouse/ClickHouse/pull/57790) ([Anton Popov](https://github.com/CurtizJ))。
- 修复带有 `*Map` 组合器的聚合函数中的合并 [#57795](https://github.com/ClickHouse/ClickHouse/pull/57795) ([Anton Popov](https://github.com/CurtizJ))。
- 禁用 `system.kafka_consumers`,因为它存在错误。[#57822](https://github.com/ClickHouse/ClickHouse/pull/57822) ([Azat Khuzhin](https://github.com/azat))。
- 修复 Merge JOIN 中的 LowCardinality 键支持。[#57827](https://github.com/ClickHouse/ClickHouse/pull/57827) ([vdimir](https://github.com/vdimir))。
- 修复与样本块相关的 `InterpreterCreateQuery`。[#57855](https://github.com/ClickHouse/ClickHouse/pull/57855) ([Maksim Kita](https://github.com/kitaisreal))。
- 来自 PostgreSQL 的命名集合忽略了 `addresses_expr`。[#57874](https://github.com/ClickHouse/ClickHouse/pull/57874) ([joelynch](https://github.com/joelynch))。
- 修复 BLAKE3 (Rust) 中的无效内存访问 [#57876](https://github.com/ClickHouse/ClickHouse/pull/57876) ([Raúl Marín](https://github.com/Algunenano))。随后为了更好的[内存安全性](https://www.memorysafety.org/)将其从 Rust 重写为 C++。[#57994](https://github.com/ClickHouse/ClickHouse/pull/57994) ([Raúl Marín](https://github.com/Algunenano))。
- 规范化 `CREATE INDEX` 中的函数名称 [#57906](https://github.com/ClickHouse/ClickHouse/pull/57906) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 修复第一次请求发生前对不可用副本的处理 [#57933](https://github.com/ClickHouse/ClickHouse/pull/57933) ([Nikita Taranov](https://github.com/nickitat))。
- 修复字面量别名误分类 [#57988](https://github.com/ClickHouse/ClickHouse/pull/57988) ([Chen768959](https://github.com/Chen768959))。
- 修复 Keeper 上的无效预处理 [#58069](https://github.com/ClickHouse/ClickHouse/pull/58069) ([Antonio Andelic](https://github.com/antonio2368))。
- 修复 `Poco` 库中与 `UTF32Encoding` 相关的整数溢出 [#58073](https://github.com/ClickHouse/ClickHouse/pull/58073) ([Andrey Fedotov](https://github.com/anfedotoff))。
- 修复存在带有大整数值的标量子查询时的并行副本(实验性功能) [#58118](https://github.com/ClickHouse/ClickHouse/pull/58118) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 修复超出范围的 `DateTime` 的 `accurateCastOrNull` [#58139](https://github.com/ClickHouse/ClickHouse/pull/58139) ([Andrey Zvonov](https://github.com/zvonand))。
- 修复从 MergeTree 中的宽部分读取子列时可能出现的 `PARAMETER_OUT_OF_BOUND` 错误 [#58175](https://github.com/ClickHouse/ClickHouse/pull/58175) ([Kruglov Pavel](https://github.com/Avogar))。
- 修复具有大量子查询的 CREATE VIEW 速度变慢的问题 [#58220](https://github.com/ClickHouse/ClickHouse/pull/58220) ([Tao Wang](https://github.com/wangtZJU))。
- 修复 JSONCompactEachRow 的并行解析 [#58181](https://github.com/ClickHouse/ClickHouse/pull/58181) ([Alexey Milovidov](https://github.com/alexey-milovidov))。[#58250](https://github.com/ClickHouse/ClickHouse/pull/58250) ([Kruglov Pavel](https://github.com/Avogar))。

### <a id="2311"></a> ClickHouse release 23.11, 2023-12-06 {#2311}

#### 向后不兼容的变更 {#backward-incompatible-change-1}

- 默认的 ClickHouse 服务器配置文件已为 `default` 用户默认启用 `access_management`(通过 SQL 查询管理用户)和 `named_collection_control`(通过 SQL 查询管理命名集合)。这解决了 [#56482](https://github.com/ClickHouse/ClickHouse/issues/56482)。[#56619](https://github.com/ClickHouse/ClickHouse/pull/56619) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 对窗口函数的 `RESPECT NULLS`/`IGNORE NULLS` 进行了多项改进。如果您将它们用作聚合函数并存储带有这些修饰符的聚合函数状态,可能会出现不兼容的情况。[#57189](https://github.com/ClickHouse/ClickHouse/pull/57189) ([Raúl Marín](https://github.com/Algunenano))。
- 移除了优化选项 `optimize_move_functions_out_of_any`。[#57190](https://github.com/ClickHouse/ClickHouse/pull/57190) ([Raúl Marín](https://github.com/Algunenano))。
- 函数 `parseDateTime` 中的格式化符 `%l`/`%k`/`%c` 现在能够解析不带前导零的小时/月份,例如 `select parseDateTime('2023-11-26 8:14', '%F %k:%i')` 现在可以正常工作。设置 `parsedatetime_parse_without_leading_zeros = 0` 可恢复之前需要两位数字的行为。函数 `formatDateTime` 现在也能够输出不带前导零的小时/月份。这由设置 `formatdatetime_format_without_leading_zeros` 控制,但默认关闭以避免破坏现有用例。[#55872](https://github.com/ClickHouse/ClickHouse/pull/55872) ([Azat Khuzhin](https://github.com/azat))。
- 您不能再对 `Decimal` 类型的参数使用聚合函数 `avgWeighted`。解决方法:将参数转换为 `Float64`。这解决了 [#43928](https://github.com/ClickHouse/ClickHouse/issues/43928)。这解决了 [#31768](https://github.com/ClickHouse/ClickHouse/issues/31768)。这解决了 [#56435](https://github.com/ClickHouse/ClickHouse/issues/56435)。如果您在物化视图或投影中使用了带有 `Decimal` 参数的此函数,请联系 support@clickhouse.com。修复了聚合函数 `sumMap` 中的错误,但使其速度降低了约 1.5 到 2 倍。这无关紧要,因为该函数本身就不够理想。这解决了 [#54955](https://github.com/ClickHouse/ClickHouse/issues/54955)。这解决了 [#53134](https://github.com/ClickHouse/ClickHouse/issues/53134)。这解决了 [#55148](https://github.com/ClickHouse/ClickHouse/issues/55148)。修复了函数 `groupArraySample` 中的一个错误 - 当查询中生成多个聚合状态时,它使用了相同的随机种子。[#56350](https://github.com/ClickHouse/ClickHouse/pull/56350) ([Alexey Milovidov](https://github.com/alexey-milovidov))。


#### 新功能 {#new-feature-1}

- 新增服务器设置 `async_load_databases`,用于异步加载数据库和表。可加快服务器启动速度。适用于使用 `Ordinary`、`Atomic` 和 `Replicated` 引擎的数据库。这些数据库的表会异步加载元数据。对表的查询会提高加载作业的优先级并等待其完成。新增 `system.asynchronous_loader` 表用于内省。[#49351](https://github.com/ClickHouse/ClickHouse/pull/49351) ([Sergei Trifonov](https://github.com/serxa))。
- 新增系统表 `blob_storage_log`。该表可用于审计所有写入 S3 和其他对象存储的数据。[#52918](https://github.com/ClickHouse/ClickHouse/pull/52918) ([vdimir](https://github.com/vdimir))。
- 使用统计信息更好地排序 prewhere 条件。[#53240](https://github.com/ClickHouse/ClickHouse/pull/53240) ([Han Fei](https://github.com/hanfei1991))。
- 在 Keeper 协议中新增压缩支持。可以通过在 `zookeeper` 配置段中使用 `use_compression` 标志在 ClickHouse 端启用。请注意,只有 ClickHouse Keeper 支持压缩,Apache ZooKeeper 不支持。解决了 [#49507](https://github.com/ClickHouse/ClickHouse/issues/49507)。[#54957](https://github.com/ClickHouse/ClickHouse/pull/54957) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
- 引入 `storage_metadata_write_full_object_key` 功能。如果设置为 `true`,则元数据文件将以新格式写入。使用该格式时,ClickHouse 会在元数据文件中存储完整的远程对象键,从而提供更好的灵活性和优化能力。[#55566](https://github.com/ClickHouse/ClickHouse/pull/55566) ([Sema Checherinda](https://github.com/CheSema))。
- 新增设置和语法以保护命名集合的字段不被覆盖。这旨在防止恶意用户未经授权访问敏感信息。[#55782](https://github.com/ClickHouse/ClickHouse/pull/55782) ([Salvatore Mesoraca](https://github.com/aiven-sal))。
- 向所有系统日志表新增 `hostname` 列 - 如果您将系统表设置为复制、共享或分布式,该列将非常有用。[#55894](https://github.com/ClickHouse/ClickHouse/pull/55894) ([Bharat Nallan](https://github.com/bharatnc))。
- 新增 `CHECK ALL TABLES` 查询。[#56022](https://github.com/ClickHouse/ClickHouse/pull/56022) ([vdimir](https://github.com/vdimir))。
- 新增函数 `fromDaysSinceYearZero`,类似于 MySQL 的 `FROM_DAYS`。例如,`SELECT fromDaysSinceYearZero(739136)` 返回 `2023-09-08`。[#56088](https://github.com/ClickHouse/ClickHouse/pull/56088) ([Joanna Hulboj](https://github.com/jh0x))。
- 新增外部 Python 工具,用于查看备份并从中提取信息,无需使用 ClickHouse。[#56268](https://github.com/ClickHouse/ClickHouse/pull/56268) ([Vitaly Baranov](https://github.com/vitlibar))。
- 实现了名为 `preferred_optimize_projection_name` 的新设置。如果设置为非空字符串,则会在可能的情况下使用指定的投影,而不是从所有候选项中选择。[#56309](https://github.com/ClickHouse/ClickHouse/pull/56309) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- 新增用于让出/放弃领导权的 4 字母命令 (https://github.com/ClickHouse/ClickHouse/issues/56352)。[#56354](https://github.com/ClickHouse/ClickHouse/pull/56354) ([Pradeep Chhetri](https://github.com/chhetripradeep))。[#56620](https://github.com/ClickHouse/ClickHouse/pull/56620) ([Pradeep Chhetri](https://github.com/chhetripradeep))。
- 新增 SQL 函数 `arrayRandomSample(arr, k)`,从输入数组中返回 k 个元素的样本。以前只能通过不太方便的语法实现类似功能,例如 `SELECT arrayReduce('groupArraySample(3)', range(10))`。[#56416](https://github.com/ClickHouse/ClickHouse/pull/56416) ([Robert Schulze](https://github.com/rschu1ze))。
- 新增对 `Float16` 类型数据在 `.npy` 文件中使用的支持。关闭 [#56344](https://github.com/ClickHouse/ClickHouse/issues/56344)。[#56424](https://github.com/ClickHouse/ClickHouse/pull/56424) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- 新增系统视图 `information_schema.statistics`,以更好地兼容 Tableau Online。[#56425](https://github.com/ClickHouse/ClickHouse/pull/56425) ([Serge Klochkov](https://github.com/slvrtrn))。
- 新增 `system.symbols` 表,用于二进制文件的内省。[#56548](https://github.com/ClickHouse/ClickHouse/pull/56548) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 可配置的仪表板。图表查询现在通过查询加载,默认使用新的 `system.dashboards` 表。[#56771](https://github.com/ClickHouse/ClickHouse/pull/56771) ([Sergei Trifonov](https://github.com/serxa))。
- 引入 `fileCluster` 表函数 - 如果您将共享文件系统(NFS 等)挂载到 `user_files` 目录中,该函数将非常有用。[#56868](https://github.com/ClickHouse/ClickHouse/pull/56868) ([Andrey Zvonov](https://github.com/zvonand))。
- 向 `s3/file/hdfs/url/azureBlobStorage` 引擎新增 `_size` 虚拟列,包含文件大小(以字节为单位)。[#57126](https://github.com/ClickHouse/ClickHouse/pull/57126) ([Kruglov Pavel](https://github.com/Avogar))。
- 从 Prometheus 端点公开自上次重启以来服务器上发生的每个错误代码的错误数量。[#57209](https://github.com/ClickHouse/ClickHouse/pull/57209) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- ClickHouse keeper 在 `/keeper/availability-zone` 路径报告其运行的可用区。可以通过 `<availability_zone><value>us-west-1a</value></availability_zone>` 进行配置。[#56715](https://github.com/ClickHouse/ClickHouse/pull/56715) ([Jianfei Hu](https://github.com/incfly))。
- 使 ALTER materialized_view MODIFY QUERY 成为非实验性功能,并弃用 `allow_experimental_alter_materialized_view_structure` 设置。修复 [#15206](https://github.com/ClickHouse/ClickHouse/issues/15206)。[#57311](https://github.com/ClickHouse/ClickHouse/pull/57311) ([alesapin](https://github.com/alesapin))。
- 设置 `join_algorithm` 遵循指定的顺序 [#51745](https://github.com/ClickHouse/ClickHouse/pull/51745) ([vdimir](https://github.com/vdimir))。
- 在 Protobuf 格式中新增对[众所周知的 Protobuf 类型](https://protobuf.dev/reference/protobuf/google.protobuf/)的支持。[#56741](https://github.com/ClickHouse/ClickHouse/pull/56741) ([János Benjamin Antal](https://github.com/antaljanosbenjamin))。





#### 性能改进 {#performance-improvement-1}

- 与 S3 交互时采用自适应超时机制。首次尝试使用较低的发送和接收超时值。[#56314](https://github.com/ClickHouse/ClickHouse/pull/56314) ([Sema Checherinda](https://github.com/CheSema))。
- 将 `max_concurrent_queries` 的默认值从 100 提升至 1000。当存在大量缓慢发送或接收数据的连接客户端,导致服务器不受 CPU 限制时,或者当 CPU 核心数大于 100 时,此调整非常有意义。此外,默认启用并发控制,并将查询处理线程总数设置为 CPU 核心数的两倍。这在并发查询数量极大的场景中显著提升了性能。[#46927](https://github.com/ClickHouse/ClickHouse/pull/46927) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 支持窗口函数的并行计算。修复 [#34688](https://github.com/ClickHouse/ClickHouse/issues/34688)。[#39631](https://github.com/ClickHouse/ClickHouse/pull/39631) ([Dmitry Novik](https://github.com/novikd))。
- `Numbers` 表引擎(`system.numbers` 表)现在会分析查询条件以生成所需的数据子集,类似于表索引的工作方式。[#50909](https://github.com/ClickHouse/ClickHouse/pull/50909) ([JackyWoo](https://github.com/JackyWoo))。
- 改进了 `Merge` 表引擎使用 `IN (...)` 条件过滤的性能。[#54905](https://github.com/ClickHouse/ClickHouse/pull/54905) ([Nikita Taranov](https://github.com/nickitat))。
- 当文件系统缓存已满且存在大量读取操作时的性能改进。[#55158](https://github.com/ClickHouse/ClickHouse/pull/55158) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 添加禁用 S3 校验和的功能以避免对文件的重复遍历(由设置 `s3_disable_checksum` 控制)。[#55559](https://github.com/ClickHouse/ClickHouse/pull/55559) ([Azat Khuzhin](https://github.com/azat))。
- 现在当数据位于页缓存中时,我们从远程表同步读取(与本地表的处理方式相同)。这种方式更快,不需要线程池内的同步,可以在本地文件系统上自如地执行 `seek` 操作,并减少了 CPU 等待时间。[#55841](https://github.com/ClickHouse/ClickHouse/pull/55841) ([Nikita Taranov](https://github.com/nickitat))。
- 优化从 `map`、`arrayElement` 获取值的操作。将带来约 30% 的性能提升。- 减少预留内存 - 减少 `resize` 调用次数。[#55957](https://github.com/ClickHouse/ClickHouse/pull/55957) ([lgbo](https://github.com/lgbo-ustc))。
- 使用 AVX-512 优化多阶段过滤。在 ICX 设备(Intel Xeon Platinum 8380 CPU,80 核心,160 线程)上对 OnTime 数据集的性能实验表明,此更改可分别为查询 Q2、Q3、Q4、Q5 和 Q6 的 QPS 带来 7.4%、5.9%、4.7%、3.0% 和 4.6% 的性能提升,同时对其他查询无影响。[#56079](https://github.com/ClickHouse/ClickHouse/pull/56079) ([Zhiguo Zhou](https://github.com/ZhiguoZh))。
- 限制查询分析器内活跃线程的数量。如果超过限制,这些线程将跳过性能分析。[#56105](https://github.com/ClickHouse/ClickHouse/pull/56105) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 减少窗口函数中的虚函数调用次数。[#56120](https://github.com/ClickHouse/ClickHouse/pull/56120) ([Maksim Kita](https://github.com/kitaisreal))。
- 允许在 ORC 数据格式中递归裁剪 Tuple 字段以加速扫描。[#56122](https://github.com/ClickHouse/ClickHouse/pull/56122) ([李扬](https://github.com/taiyang-li))。
- 对 `Npy` 数据格式的简单计数优化:像 `select count() from 'data.npy'` 这样的查询将因结果缓存而运行得更快。[#56304](https://github.com/ClickHouse/ClickHouse/pull/56304) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- 包含聚合和大量数据流的查询在执行计划构建期间将使用更少的内存。[#57074](https://github.com/ClickHouse/ClickHouse/pull/57074) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 通过优化对 ProcessList 的访问,提升多用户和高并发查询(>2000 QPS)场景下的查询执行性能。[#57106](https://github.com/ClickHouse/ClickHouse/pull/57106) ([Andrej Hoos](https://github.com/adikus))。
- 对 array join 的简单改进,重用部分中间结果。[#57183](https://github.com/ClickHouse/ClickHouse/pull/57183) ([李扬](https://github.com/taiyang-li))。
- 在某些情况下栈展开速度较慢。现在已解决。[#57221](https://github.com/ClickHouse/ClickHouse/pull/57221) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 现在当 `max_streams = 1` 时,我们使用默认读取池从外部存储读取数据。当启用读取预取时,这种方式更有优势。[#57334](https://github.com/ClickHouse/ClickHouse/pull/57334) ([Nikita Taranov](https://github.com/nickitat))。
- Keeper 改进:通过延迟日志预处理来改善启动期间的内存使用。[#55660](https://github.com/ClickHouse/ClickHouse/pull/55660) ([Antonio Andelic](https://github.com/antonio2368))。
- 改进了 `File` 和 `HDFS` 存储的 glob 匹配性能。[#56141](https://github.com/ClickHouse/ClickHouse/pull/56141) ([Andrey Zvonov](https://github.com/zvonand))。
- 实验性全文索引中的倒排列表现已压缩,将其大小减少了 10-30%。[#56226](https://github.com/ClickHouse/ClickHouse/pull/56226) ([Harry Lee](https://github.com/HarryLeeIBM))。
- 在备份中并行化 `BackupEntriesCollector`。[#56312](https://github.com/ClickHouse/ClickHouse/pull/56312) ([Kseniia Sumarokova](https://github.com/kssenii))。





#### 改进 {#improvement-1}

- Add a new `MergeTree` setting `add_implicit_sign_column_constraint_for_collapsing_engine` (disabled by default). When enabled, it adds an implicit CHECK constraint for `CollapsingMergeTree` tables that restricts the value of the `Sign` column to be only -1 or 1. [#56701](https://github.com/ClickHouse/ClickHouse/issues/56701). [#56986](https://github.com/ClickHouse/ClickHouse/pull/56986) ([Kevin Mingtarja](https://github.com/kevinmingtarja)).
- Enable adding new disk to storage configuration without restart. [#56367](https://github.com/ClickHouse/ClickHouse/pull/56367) ([Duc Canh Le](https://github.com/canhld94)).
- Support creating and materializing index in the same alter query, also support "modify TTL" and "materialize TTL" in the same query. Closes [#55651](https://github.com/ClickHouse/ClickHouse/issues/55651). [#56331](https://github.com/ClickHouse/ClickHouse/pull/56331) ([flynn](https://github.com/ucasfl)).
- Add a new table function named `fuzzJSON` with rows containing perturbed versions of the source JSON string with random variations. [#56490](https://github.com/ClickHouse/ClickHouse/pull/56490) ([Julia Kartseva](https://github.com/jkartseva)).
- Engine `Merge` filters the records according to the row policies of the underlying tables, so you don't have to create another row policy on a `Merge` table. [#50209](https://github.com/ClickHouse/ClickHouse/pull/50209) ([Ilya Golshtein](https://github.com/ilejn)).
- Add a setting `max_execution_time_leaf` to limit the execution time on shard for distributed query, and `timeout_overflow_mode_leaf` to control the behaviour if timeout happens. [#51823](https://github.com/ClickHouse/ClickHouse/pull/51823) ([Duc Canh Le](https://github.com/canhld94)).
- Add ClickHouse setting to disable tunneling for HTTPS requests over HTTP proxy. [#55033](https://github.com/ClickHouse/ClickHouse/pull/55033) ([Arthur Passos](https://github.com/arthurpassos)).
- Set `background_fetches_pool_size` to 16, background_schedule_pool_size to 512 that is better for production usage with frequent small insertions. [#54327](https://github.com/ClickHouse/ClickHouse/pull/54327) ([Denny Crane](https://github.com/den-crane)).
- While read data from a csv format file, and at end of line is `\r` , which not followed by `\n`, then we will enconter the exception as follows `Cannot parse CSV format: found \r (CR) not followed by \n (LF). Line must end by \n (LF) or \r\n (CR LF) or \n\r.` In clickhouse, the csv end of line must be `\n` or `\r\n` or `\n\r`, so the `\r` must be followed by `\n`, but in some situation, the csv input data is abnormal, like above, `\r` is at end of line. [#54340](https://github.com/ClickHouse/ClickHouse/pull/54340) ([KevinyhZou](https://github.com/KevinyhZou)).
- Update Arrow library to release-13.0.0 that supports new encodings. Closes [#44505](https://github.com/ClickHouse/ClickHouse/issues/44505). [#54800](https://github.com/ClickHouse/ClickHouse/pull/54800) ([Kruglov Pavel](https://github.com/Avogar)).
- Improve performance of ON CLUSTER queries by removing heavy system calls to get all network interfaces when looking for local ip address in the DDL entry hosts list. [#54909](https://github.com/ClickHouse/ClickHouse/pull/54909) ([Duc Canh Le](https://github.com/canhld94)).
- Fixed accounting of memory allocated before attaching a thread to a query or a user. [#56089](https://github.com/ClickHouse/ClickHouse/pull/56089) ([Nikita Taranov](https://github.com/nickitat)).
- Add support for `LARGE_LIST` in Apache Arrow formats. [#56118](https://github.com/ClickHouse/ClickHouse/pull/56118) ([edef](https://github.com/edef1c)).
- Allow manual compaction of `EmbeddedRocksDB` via `OPTIMIZE` query. [#56225](https://github.com/ClickHouse/ClickHouse/pull/56225) ([Azat Khuzhin](https://github.com/azat)).
- Add ability to specify BlockBasedTableOptions for `EmbeddedRocksDB` tables. [#56264](https://github.com/ClickHouse/ClickHouse/pull/56264) ([Azat Khuzhin](https://github.com/azat)).
- `SHOW COLUMNS` now displays MySQL's equivalent data type name when the connection was made through the MySQL protocol. Previously, this was the case when setting `use_mysql_types_in_show_columns = 1`. The setting is retained but made obsolete. [#56277](https://github.com/ClickHouse/ClickHouse/pull/56277) ([Robert Schulze](https://github.com/rschu1ze)).
- Fixed possible `The local set of parts of table doesn't look like the set of parts in ZooKeeper` error if server was restarted just after `TRUNCATE` or `DROP PARTITION`. [#56282](https://github.com/ClickHouse/ClickHouse/pull/56282) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fixed handling of non-const query strings in functions `formatQuery`/ `formatQuerySingleLine`. Also added `OrNull` variants of both functions that return a NULL when a query cannot be parsed instead of throwing an exception. [#56327](https://github.com/ClickHouse/ClickHouse/pull/56327) ([Robert Schulze](https://github.com/rschu1ze)).
- Allow backup of materialized view with dropped inner table instead of failing the backup. [#56387](https://github.com/ClickHouse/ClickHouse/pull/56387) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Queries to `system.replicas` initiate requests to ZooKeeper when certain columns are queried. When there are thousands of tables these requests might produce a considerable load on ZooKeeper. If there are multiple simultaneous queries to `system.replicas` they do same requests multiple times. The change is to "deduplicate" requests from concurrent queries. [#56420](https://github.com/ClickHouse/ClickHouse/pull/56420) ([Alexander Gololobov](https://github.com/davenger)).
- Fix translation to MySQL compatible query for querying external databases. [#56456](https://github.com/ClickHouse/ClickHouse/pull/56456) ([flynn](https://github.com/ucasfl)).
- Add support for backing up and restoring tables using `KeeperMap` engine. [#56460](https://github.com/ClickHouse/ClickHouse/pull/56460) ([Antonio Andelic](https://github.com/antonio2368)).
- 404 response for CompleteMultipartUpload has to be rechecked. Operation could be done on server even if client got timeout or other network errors. The next retry of CompleteMultipartUpload receives 404 response. If the object key exists that operation is considered as successful. [#56475](https://github.com/ClickHouse/ClickHouse/pull/56475) ([Sema Checherinda](https://github.com/CheSema)).
- Enable the HTTP OPTIONS method by default - it simplifies requesting ClickHouse from a web browser. [#56483](https://github.com/ClickHouse/ClickHouse/pull/56483) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- The value for `dns_max_consecutive_failures` was changed by mistake in [#46550](https://github.com/ClickHouse/ClickHouse/issues/46550) - this is reverted and adjusted to a better value. Also, increased the HTTP keep-alive timeout to a reasonable value from production. [#56485](https://github.com/ClickHouse/ClickHouse/pull/56485) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Load base backups lazily (a base backup won't be loaded until it's needed). Also add some log message and profile events for backups. [#56516](https://github.com/ClickHouse/ClickHouse/pull/56516) ([Vitaly Baranov](https://github.com/vitlibar)).
- Setting `query_cache_store_results_of_queries_with_nondeterministic_functions` (with values `false` or `true`) was marked obsolete. It was replaced by setting `query_cache_nondeterministic_function_handling`, a three-valued enum that controls how the query cache handles queries with non-deterministic functions: a) throw an exception (default behavior), b) save the non-deterministic query result regardless, or c) ignore, i.e. don't throw an exception and don't cache the result. [#56519](https://github.com/ClickHouse/ClickHouse/pull/56519) ([Robert Schulze](https://github.com/rschu1ze)).
- Rewrite equality with `is null` check in JOIN ON section. Experimental _Analyzer only_. [#56538](https://github.com/ClickHouse/ClickHouse/pull/56538) ([vdimir](https://github.com/vdimir)).
- Function`concat` now supports arbitrary argument types (instead of only String and FixedString arguments). This makes it behave more similar to MySQL `concat` implementation. For example, `SELECT concat('ab', 42)` now returns `ab42`. [#56540](https://github.com/ClickHouse/ClickHouse/pull/56540) ([Serge Klochkov](https://github.com/slvrtrn)).
- Allow getting cache configuration from 'named_collection' section in config or from SQL created named collections. [#56541](https://github.com/ClickHouse/ClickHouse/pull/56541) ([Kseniia Sumarokova](https://github.com/kssenii)).
- PostgreSQL database engine: Make the removal of outdated tables less aggressive with unsuccessful postgres connection. [#56609](https://github.com/ClickHouse/ClickHouse/pull/56609) ([jsc0218](https://github.com/jsc0218)).
- It took too much time to connnect to PG when URL is not right, so the relevant query stucks there and get cancelled. [#56648](https://github.com/ClickHouse/ClickHouse/pull/56648) ([jsc0218](https://github.com/jsc0218)).
- Keeper improvement: disable compressed logs by default in Keeper. [#56763](https://github.com/ClickHouse/ClickHouse/pull/56763) ([Antonio Andelic](https://github.com/antonio2368)).
- Add config setting `wait_dictionaries_load_at_startup`. [#56782](https://github.com/ClickHouse/ClickHouse/pull/56782) ([Vitaly Baranov](https://github.com/vitlibar)).
- There was a potential vulnerability in previous ClickHouse versions: if a user has connected and unsuccessfully tried to authenticate with the "interserver secret" method, the server didn't terminate the connection immediately but continued to receive and ignore the leftover packets from the client. While these packets are ignored, they are still parsed, and if they use a compression method with another known vulnerability, it will lead to exploitation of it without authentication. This issue was found with [ClickHouse Bug Bounty Program](https://github.com/ClickHouse/ClickHouse/issues/38986) by https://twitter.com/malacupa. [#56794](https://github.com/ClickHouse/ClickHouse/pull/56794) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fetching a part waits when that part is fully committed on remote replica. It is better not send part in PreActive state. In case of zero copy this is mandatory restriction. [#56808](https://github.com/ClickHouse/ClickHouse/pull/56808) ([Sema Checherinda](https://github.com/CheSema)).
- Fix possible postgresql logical replication conversion error when using experimental `MaterializedPostgreSQL`. [#53721](https://github.com/ClickHouse/ClickHouse/pull/53721) ([takakawa](https://github.com/takakawa)).
- Implement user-level setting `alter_move_to_space_execute_async` which allow to execute queries `ALTER TABLE ... MOVE PARTITION|PART TO DISK|VOLUME` asynchronously. The size of pool for background executions is controlled by `background_move_pool_size`. Default behavior is synchronous execution. Fixes [#47643](https://github.com/ClickHouse/ClickHouse/issues/47643). [#56809](https://github.com/ClickHouse/ClickHouse/pull/56809) ([alesapin](https://github.com/alesapin)).
- Able to filter by engine when scanning system.tables, avoid unnecessary (potentially time-consuming) connection. [#56813](https://github.com/ClickHouse/ClickHouse/pull/56813) ([jsc0218](https://github.com/jsc0218)).
- Show `total_bytes` and `total_rows` in system tables for RocksDB storage. [#56816](https://github.com/ClickHouse/ClickHouse/pull/56816) ([Aleksandr Musorin](https://github.com/AVMusorin)).
- Allow basic commands in ALTER for TEMPORARY tables. [#56892](https://github.com/ClickHouse/ClickHouse/pull/56892) ([Sergey](https://github.com/icuken)).
- LZ4 compression. Buffer compressed block in a rare case when out buffer capacity is not enough for writing compressed block directly to out's buffer. [#56938](https://github.com/ClickHouse/ClickHouse/pull/56938) ([Sema Checherinda](https://github.com/CheSema)).
- Add metrics for the number of queued jobs, which is useful for the IO thread pool. [#56958](https://github.com/ClickHouse/ClickHouse/pull/56958) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Add a setting for PostgreSQL table engine setting in the config file. Added a check for the setting Added documentation around the additional setting. [#56959](https://github.com/ClickHouse/ClickHouse/pull/56959) ([Peignon Melvyn](https://github.com/melvynator)).
- Function `concat` can now be called with a single argument, e.g., `SELECT concat('abc')`. This makes its behavior more consistent with MySQL's concat implementation. [#57000](https://github.com/ClickHouse/ClickHouse/pull/57000) ([Serge Klochkov](https://github.com/slvrtrn)).
- Signs all `x-amz-*` headers as required by AWS S3 docs. [#57001](https://github.com/ClickHouse/ClickHouse/pull/57001) ([Arthur Passos](https://github.com/arthurpassos)).
- Function `fromDaysSinceYearZero` (alias: `FROM_DAYS`) can now be used with unsigned and signed integer types (previously, it had to be an unsigned integer). This improve compatibility with 3rd party tools such as Tableau Online. [#57002](https://github.com/ClickHouse/ClickHouse/pull/57002) ([Serge Klochkov](https://github.com/slvrtrn)).
- Add `system.s3queue_log` to default config. [#57036](https://github.com/ClickHouse/ClickHouse/pull/57036) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Change the default for `wait_dictionaries_load_at_startup` to true, and use this setting only if `dictionaries_lazy_load` is false. [#57133](https://github.com/ClickHouse/ClickHouse/pull/57133) ([Vitaly Baranov](https://github.com/vitlibar)).
- Check dictionary source type on creation even if `dictionaries_lazy_load` is enabled. [#57134](https://github.com/ClickHouse/ClickHouse/pull/57134) ([Vitaly Baranov](https://github.com/vitlibar)).
- Plan-level optimizations can now be enabled/disabled individually. Previously, it was only possible to disable them all. The setting which previously did that (`query_plan_enable_optimizations`) is retained and can still be used to disable all optimizations. [#57152](https://github.com/ClickHouse/ClickHouse/pull/57152) ([Robert Schulze](https://github.com/rschu1ze)).
- The server's exit code will correspond to the exception code. For example, if the server cannot start due to memory limit, it will exit with the code 241 = MEMORY_LIMIT_EXCEEDED. In previous versions, the exit code for exceptions was always 70 = Poco::Util::ExitCode::EXIT_SOFTWARE. [#57153](https://github.com/ClickHouse/ClickHouse/pull/57153) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Do not demangle and symbolize stack frames from `functional` C++ header. [#57201](https://github.com/ClickHouse/ClickHouse/pull/57201) ([Mike Kot](https://github.com/myrrc)).
- HTTP server page `/dashboard` now supports charts with multiple lines. [#57236](https://github.com/ClickHouse/ClickHouse/pull/57236) ([Sergei Trifonov](https://github.com/serxa)).
- The `max_memory_usage_in_client` command line option supports a string value with a suffix (K, M, G, etc). Closes [#56879](https://github.com/ClickHouse/ClickHouse/issues/56879). [#57273](https://github.com/ClickHouse/ClickHouse/pull/57273) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Bumped Intel QPL (used by codec `DEFLATE_QPL`) from v1.2.0 to v1.3.1 . Also fixed a bug in case of BOF (Block On Fault) = 0, changed to handle page faults by falling back to SW path. [#57291](https://github.com/ClickHouse/ClickHouse/pull/57291) ([jasperzhu](https://github.com/jinjunzh)).
- Increase default `replicated_deduplication_window` of MergeTree settings from 100 to 1k. [#57335](https://github.com/ClickHouse/ClickHouse/pull/57335) ([sichenzhao](https://github.com/sichenzhao)).
- Stop using `INCONSISTENT_METADATA_FOR_BACKUP` that much. If possible prefer to continue scanning instead of stopping and starting the scanning for backup from the beginning. [#57385](https://github.com/ClickHouse/ClickHouse/pull/57385) ([Vitaly Baranov](https://github.com/vitlibar)).





#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-1}

- 添加 SQLLogic 测试。[#56078](https://github.com/ClickHouse/ClickHouse/pull/56078) ([Han Fei](https://github.com/hanfei1991))。
- 为提高易用性,使 `clickhouse-local` 和 `clickhouse-client` 可通过短名称(`ch`、`chl`、`chc`)使用。[#56634](https://github.com/ClickHouse/ClickHouse/pull/56634) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 通过移除外部库中未使用的代码进一步优化构建大小。[#56786](https://github.com/ClickHouse/ClickHouse/pull/56786) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 添加自动检查以确保不存在大型编译单元。[#56559](https://github.com/ClickHouse/ClickHouse/pull/56559) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 降低单二进制文件分发包的大小。此更改解决了 [#55181](https://github.com/ClickHouse/ClickHouse/issues/55181)。[#56617](https://github.com/ClickHouse/ClickHouse/pull/56617) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 每次构建后,每个编译单元和二进制文件的大小信息将发送到 ClickHouse Cloud 中的 CI 数据库。此更改解决了 [#56107](https://github.com/ClickHouse/ClickHouse/issues/56107)。[#56636](https://github.com/ClickHouse/ClickHouse/pull/56636) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- "Apache Arrow" 库的某些文件(我们仅将其用于解析 Arrow 格式等非核心功能)无论构建缓存如何都会持续重新构建。此问题已修复。[#56657](https://github.com/ClickHouse/ClickHouse/pull/56657) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 避免重新编译依赖于自动生成的版本源文件的编译单元。[#56660](https://github.com/ClickHouse/ClickHouse/pull/56660) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 链接器调用的跟踪数据将发送到 ClickHouse Cloud 中的 CI 数据库。[#56725](https://github.com/ClickHouse/ClickHouse/pull/56725) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 为 clickhouse 二进制文件使用 DWARF 5 调试符号(之前为 DWARF 4)。[#56770](https://github.com/ClickHouse/ClickHouse/pull/56770) ([Michael Kolupaev](https://github.com/al13n321))。
- 添加新的构建选项 `SANITIZE_COVERAGE`。启用后,代码将被插桩以跟踪覆盖率。收集的信息可在 ClickHouse 内部通过以下方式获取:(1) 新函数 `coverage`,返回上次覆盖率重置后在代码中发现的唯一地址数组;(2) `SYSTEM RESET COVERAGE` 查询,重置累积的数据。这使我们能够比较不同测试的覆盖率,包括差异代码覆盖率。延续自 [#20539](https://github.com/ClickHouse/ClickHouse/issues/20539)。[#56102](https://github.com/ClickHouse/ClickHouse/pull/56102) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 收集堆栈时,某些堆栈帧可能无法解析。在这种情况下,原始地址可能会有所帮助。[#56267](https://github.com/ClickHouse/ClickHouse/pull/56267) ([Alexander Gololobov](https://github.com/davenger))。
- 添加禁用 `libssh` 的选项。[#56333](https://github.com/ClickHouse/ClickHouse/pull/56333) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 在 CI 的 S3 测试中启用 temporary_data_in_cache。[#48425](https://github.com/ClickHouse/ClickHouse/pull/48425) ([vdimir](https://github.com/vdimir))。
- 在 CI 中为 clickhouse-client 设置最大内存使用量(`1G`)。[#56873](https://github.com/ClickHouse/ClickHouse/pull/56873) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。





#### Bug Fix (官方稳定版本中用户可见的错误行为) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-1}

- Fix exerimental Analyzer - insertion from select with subquery referencing insertion table should process only insertion block. [#50857](https://github.com/ClickHouse/ClickHouse/pull/50857) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix a bug in `str_to_map` function. [#56423](https://github.com/ClickHouse/ClickHouse/pull/56423) ([Arthur Passos](https://github.com/arthurpassos)).
- Keeper `reconfig`: add timeout before yielding/taking leadership [#53481](https://github.com/ClickHouse/ClickHouse/pull/53481) ([Mike Kot](https://github.com/myrrc)).
- Fix incorrect header in grace hash join and filter pushdown [#53922](https://github.com/ClickHouse/ClickHouse/pull/53922) ([vdimir](https://github.com/vdimir)).
- Select from system tables when table based on table function. [#55540](https://github.com/ClickHouse/ClickHouse/pull/55540) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
- RFC: Fix "Cannot find column X in source stream" for Distributed queries with LIMIT BY [#55836](https://github.com/ClickHouse/ClickHouse/pull/55836) ([Azat Khuzhin](https://github.com/azat)).
- Fix 'Cannot read from file:' while running client in a background [#55976](https://github.com/ClickHouse/ClickHouse/pull/55976) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix clickhouse-local exit on bad send_logs_level setting [#55994](https://github.com/ClickHouse/ClickHouse/pull/55994) ([Kruglov Pavel](https://github.com/Avogar)).
- Bug fix explain ast with parameterized view [#56004](https://github.com/ClickHouse/ClickHouse/pull/56004) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Fix a crash during table loading on startup [#56232](https://github.com/ClickHouse/ClickHouse/pull/56232) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix ClickHouse-sourced dictionaries with an explicit query [#56236](https://github.com/ClickHouse/ClickHouse/pull/56236) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix segfault in signal handler for Keeper [#56266](https://github.com/ClickHouse/ClickHouse/pull/56266) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix incomplete query result for UNION in view() function. [#56274](https://github.com/ClickHouse/ClickHouse/pull/56274) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix inconsistency of "cast('0' as DateTime64(3))" and "cast('0' as Nullable(DateTime64(3)))" [#56286](https://github.com/ClickHouse/ClickHouse/pull/56286) ([李扬](https://github.com/taiyang-li)).
- Fix rare race condition related to Memory allocation failure [#56303](https://github.com/ClickHouse/ClickHouse/pull/56303) ([alesapin](https://github.com/alesapin)).
- Fix restore from backup with `flatten_nested` and `data_type_default_nullable` [#56306](https://github.com/ClickHouse/ClickHouse/pull/56306) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix crash in case of adding a column with type Object(JSON) [#56307](https://github.com/ClickHouse/ClickHouse/pull/56307) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Fix crash in filterPushDown [#56380](https://github.com/ClickHouse/ClickHouse/pull/56380) ([vdimir](https://github.com/vdimir)).
- Fix restore from backup with mat view and dropped source table [#56383](https://github.com/ClickHouse/ClickHouse/pull/56383) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix segfault during Kerberos initialization [#56401](https://github.com/ClickHouse/ClickHouse/pull/56401) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix buffer overflow in T64 [#56434](https://github.com/ClickHouse/ClickHouse/pull/56434) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix nullable primary key in final (2) [#56452](https://github.com/ClickHouse/ClickHouse/pull/56452) ([Amos Bird](https://github.com/amosbird)).
- Fix ON CLUSTER queries without database on initial node [#56484](https://github.com/ClickHouse/ClickHouse/pull/56484) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix startup failure due to TTL dependency [#56489](https://github.com/ClickHouse/ClickHouse/pull/56489) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix ALTER COMMENT queries ON CLUSTER [#56491](https://github.com/ClickHouse/ClickHouse/pull/56491) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix ALTER COLUMN with ALIAS [#56493](https://github.com/ClickHouse/ClickHouse/pull/56493) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix empty NAMED COLLECTIONs [#56494](https://github.com/ClickHouse/ClickHouse/pull/56494) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix two cases of projection analysis. [#56502](https://github.com/ClickHouse/ClickHouse/pull/56502) ([Amos Bird](https://github.com/amosbird)).
- Fix handling of aliases in query cache [#56545](https://github.com/ClickHouse/ClickHouse/pull/56545) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix conversion from `Nullable(Enum)` to `Nullable(String)` [#56644](https://github.com/ClickHouse/ClickHouse/pull/56644) ([Nikolay Degterinsky](https://github.com/evillique)).
- More reliable log handling in Keeper [#56670](https://github.com/ClickHouse/ClickHouse/pull/56670) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix configuration merge for nodes with substitution attributes [#56694](https://github.com/ClickHouse/ClickHouse/pull/56694) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Fix duplicate usage of table function input(). [#56695](https://github.com/ClickHouse/ClickHouse/pull/56695) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix: RabbitMQ OpenSSL dynamic loading issue [#56703](https://github.com/ClickHouse/ClickHouse/pull/56703) ([Igor Nikonov](https://github.com/devcrafter)).
- Fix crash in GCD codec in case when zeros present in data [#56704](https://github.com/ClickHouse/ClickHouse/pull/56704) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Fix 'mutex lock failed: Invalid argument' in clickhouse-local during insert into function [#56710](https://github.com/ClickHouse/ClickHouse/pull/56710) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix Date text parsing in optimistic path [#56765](https://github.com/ClickHouse/ClickHouse/pull/56765) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix crash in FPC codec [#56795](https://github.com/ClickHouse/ClickHouse/pull/56795) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- DatabaseReplicated: fix DDL query timeout after recovering a replica [#56796](https://github.com/ClickHouse/ClickHouse/pull/56796) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix incorrect nullable columns reporting in MySQL binary protocol [#56799](https://github.com/ClickHouse/ClickHouse/pull/56799) ([Serge Klochkov](https://github.com/slvrtrn)).
- Support Iceberg metadata files for metastore tables [#56810](https://github.com/ClickHouse/ClickHouse/pull/56810) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix TSAN report under transform [#56817](https://github.com/ClickHouse/ClickHouse/pull/56817) ([Raúl Marín](https://github.com/Algunenano)).
- Fix SET query and SETTINGS formatting [#56825](https://github.com/ClickHouse/ClickHouse/pull/56825) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix failure to start due to table dependency in joinGet [#56828](https://github.com/ClickHouse/ClickHouse/pull/56828) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix flattening existing Nested columns during ADD COLUMN [#56830](https://github.com/ClickHouse/ClickHouse/pull/56830) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix allow cr end of line for csv [#56901](https://github.com/ClickHouse/ClickHouse/pull/56901) ([KevinyhZou](https://github.com/KevinyhZou)).
- Fix `tryBase64Decode` with invalid input [#56913](https://github.com/ClickHouse/ClickHouse/pull/56913) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix generating deep nested columns in CapnProto/Protobuf schemas [#56941](https://github.com/ClickHouse/ClickHouse/pull/56941) ([Kruglov Pavel](https://github.com/Avogar)).
- Prevent incompatible ALTER of projection columns [#56948](https://github.com/ClickHouse/ClickHouse/pull/56948) ([Amos Bird](https://github.com/amosbird)).
- Fix sqlite file path validation [#56984](https://github.com/ClickHouse/ClickHouse/pull/56984) ([San](https://github.com/santrancisco)).
- S3Queue: fix metadata reference increment [#56990](https://github.com/ClickHouse/ClickHouse/pull/56990) ([Kseniia Sumarokova](https://github.com/kssenii)).
- S3Queue minor fix [#56999](https://github.com/ClickHouse/ClickHouse/pull/56999) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix file path validation for DatabaseFileSystem [#57029](https://github.com/ClickHouse/ClickHouse/pull/57029) ([San](https://github.com/santrancisco)).
- Fix `fuzzBits` with `ARRAY JOIN` [#57033](https://github.com/ClickHouse/ClickHouse/pull/57033) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix Nullptr dereference in partial merge join with joined_subquery_re... [#57048](https://github.com/ClickHouse/ClickHouse/pull/57048) ([vdimir](https://github.com/vdimir)).
- Fix race condition in RemoteSource [#57052](https://github.com/ClickHouse/ClickHouse/pull/57052) ([Raúl Marín](https://github.com/Algunenano)).
- Implement `bitHammingDistance` for big integers [#57073](https://github.com/ClickHouse/ClickHouse/pull/57073) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- S3-style links bug fix [#57075](https://github.com/ClickHouse/ClickHouse/pull/57075) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fix JSON_QUERY function with multiple numeric paths [#57096](https://github.com/ClickHouse/ClickHouse/pull/57096) ([KevinyhZou](https://github.com/KevinyhZou)).
- Fix buffer overflow in Gorilla codec [#57107](https://github.com/ClickHouse/ClickHouse/pull/57107) ([Nikolay Degterinsky](https://github.com/evillique)).
- Close interserver connection on any exception before authentication [#57142](https://github.com/ClickHouse/ClickHouse/pull/57142) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix segfault after ALTER UPDATE with Nullable MATERIALIZED column [#57147](https://github.com/ClickHouse/ClickHouse/pull/57147) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix incorrect JOIN plan optimization with partially materialized normal projection [#57196](https://github.com/ClickHouse/ClickHouse/pull/57196) ([Amos Bird](https://github.com/amosbird)).
- Ignore comments when comparing column descriptions [#57259](https://github.com/ClickHouse/ClickHouse/pull/57259) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix `ReadonlyReplica` metric for all cases [#57267](https://github.com/ClickHouse/ClickHouse/pull/57267) ([Antonio Andelic](https://github.com/antonio2368)).
- Background merges correctly use temporary data storage in the cache [#57275](https://github.com/ClickHouse/ClickHouse/pull/57275) ([vdimir](https://github.com/vdimir)).
- Keeper fix for changelog and snapshots [#57299](https://github.com/ClickHouse/ClickHouse/pull/57299) ([Antonio Andelic](https://github.com/antonio2368)).
- Ignore finished ON CLUSTER tasks if hostname changed [#57339](https://github.com/ClickHouse/ClickHouse/pull/57339) ([Alexander Tokmakov](https://github.com/tavplubix)).
- MergeTree mutations reuse source part index granularity [#57352](https://github.com/ClickHouse/ClickHouse/pull/57352) ([Maksim Kita](https://github.com/kitaisreal)).
- FS cache: add a limit for background download [#57424](https://github.com/ClickHouse/ClickHouse/pull/57424) ([Kseniia Sumarokova](https://github.com/kssenii)).

### <a id="2310"></a> ClickHouse release 23.10, 2023-11-02 {#2310}

#### Backward Incompatible Change {#backward-incompatible-change-2}

- 不再提供自动删除损坏数据部分的选项。此变更关闭了 [#55174](https://github.com/ClickHouse/ClickHouse/issues/55174)。[#55184](https://github.com/ClickHouse/ClickHouse/pull/55184) ([Alexey Milovidov](https://github.com/alexey-milovidov))。[#55557](https://github.com/ClickHouse/ClickHouse/pull/55557) ([Jihyuk Bok](https://github.com/tomahawk28))。
- 已废弃的内存数据部分不再能够从预写日志中读取。如果您之前配置了内存数据部分,则必须在升级前将其删除。[#55186](https://github.com/ClickHouse/ClickHouse/pull/55186) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 移除了与 Meilisearch 的集成。原因:该集成仅与旧版本 0.18 兼容。Meilisearch 的最新版本更改了协议,已无法正常工作。注意:如果您能帮助恢复此集成,我们将不胜感激。[#55189](https://github.com/ClickHouse/ClickHouse/pull/55189) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 将目录监控概念重命名为后台 INSERT。所有 `*directory_monitor*` 设置已重命名为 `distributed_background_insert*`。_应保持向后兼容性_(因为旧设置已添加为别名)。[#55978](https://github.com/ClickHouse/ClickHouse/pull/55978) ([Azat Khuzhin](https://github.com/azat))。
- 不再将客户端设置的 `send_timeout` 解释为服务器端的 `receive_timeout`,反之亦然。[#56035](https://github.com/ClickHouse/ClickHouse/pull/56035) ([Azat Khuzhin](https://github.com/azat))。
- 比较不同单位的时间间隔将抛出异常。此变更关闭了 [#55942](https://github.com/ClickHouse/ClickHouse/issues/55942)。您可能偶尔依赖于之前的行为,即无论单位如何都会比较底层的数值。[#56090](https://github.com/ClickHouse/ClickHouse/pull/56090) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 完全重写了实验性的 `S3Queue` 表引擎:更改了在 ZooKeeper 中保存信息的方式,从而减少 ZooKeeper 请求次数;在已知状态不会改变的情况下添加了 ZooKeeper 状态缓存;改进了从 S3 轮询的过程,使其不那么激进;更改了维护已跟踪文件的 TTL 和最大值集合的方式,现在这是一个后台进程。添加了 `system.s3queue` 和 `system.s3queue_log` 表。关闭了 [#54998](https://github.com/ClickHouse/ClickHouse/issues/54998)。[#54422](https://github.com/ClickHouse/ClickHouse/pull/54422) ([Kseniia Sumarokova](https://github.com/kssenii))。
- HTTP 端点上的任意路径不再被解释为对 `/query` 端点的请求。[#55521](https://github.com/ClickHouse/ClickHouse/pull/55521) ([Konstantin Bogdanov](https://github.com/thevar1able))。


#### 新功能 {#new-feature-2}

- 添加函数 `arrayFold(accumulator, x1, ..., xn -> expression, initial, array1, ..., arrayn)`,该函数将 lambda 函数应用于多个相同基数的数组,并将结果收集到累加器中。[#49794](https://github.com/ClickHouse/ClickHouse/pull/49794) ([Lirikl](https://github.com/Lirikl))。
- 支持 `Npy` 格式。`SELECT * FROM file('example_array.npy', Npy)`。[#55982](https://github.com/ClickHouse/ClickHouse/pull/55982) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- 如果表的键中包含空间填充曲线,例如 `ORDER BY mortonEncode(x, y)`,则其参数上的条件(例如 `x >= 10 AND x <= 20 AND y >= 20 AND y <= 30`)可用于索引。新增设置 `analyze_index_with_space_filling_curves` 以启用或禁用此分析。这解决了 [#41195](https://github.com/ClickHouse/ClickHouse/issue/41195)。延续自 [#4538](https://github.com/ClickHouse/ClickHouse/pull/4538)。延续自 [#6286](https://github.com/ClickHouse/ClickHouse/pull/6286)。延续自 [#28130](https://github.com/ClickHouse/ClickHouse/pull/28130)。延续自 [#41753](https://github.com/ClickHouse/ClickHouse/pull/#41753)。[#55642](https://github.com/ClickHouse/ClickHouse/pull/55642) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 新增设置 `force_optimize_projection_name`,它接受投影名称作为参数。如果其值设置为非空字符串,ClickHouse 会检查该投影在查询中至少使用一次。解决了 [#55331](https://github.com/ClickHouse/ClickHouse/issues/55331)。[#56134](https://github.com/ClickHouse/ClickHouse/pull/56134) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- 支持通过原生协议使用外部数据进行异步插入。以前仅在数据内联到查询中时才有效。[#54730](https://github.com/ClickHouse/ClickHouse/pull/54730) ([Anton Popov](https://github.com/CurtizJ))。
- 添加了聚合函数 `lttb`,该函数使用 [Largest-Triangle-Three-Buckets](https://skemman.is/bitstream/1946/15343/3/SS_MSthesis.pdf) 算法对数据进行降采样以用于可视化。[#53145](https://github.com/ClickHouse/ClickHouse/pull/53145) ([Sinan](https://github.com/sinsinan))。
- 查询 `CHECK TABLE` 具有更好的性能和可用性(发送进度更新,可取消)。支持使用 `CHECK TABLE ... PART 'part_name'` 检查特定分区。[#53404](https://github.com/ClickHouse/ClickHouse/pull/53404) ([vdimir](https://github.com/vdimir))。
- 添加了函数 `jsonMergePatch`。在将 JSON 数据作为字符串处理时,它提供了一种将这些字符串(JSON 对象)合并在一起以形成包含单个 JSON 对象的单个字符串的方法。[#54364](https://github.com/ClickHouse/ClickHouse/pull/54364) ([Memo](https://github.com/Joeywzr))。
- Kusto Query Language 方言支持的第二部分。[第一阶段实现](https://github.com/ClickHouse/ClickHouse/pull/37961)已合并。[#42510](https://github.com/ClickHouse/ClickHouse/pull/42510) ([larryluogit](https://github.com/larryluogit))。
- 添加了新的 SQL 函数 `arrayRandomSample(arr, k)`,该函数从输入数组中返回 k 个元素的样本。以前只能使用不太方便的语法实现类似功能,例如 "SELECT arrayReduce('groupArraySample(3)', range(10))"。[#54391](https://github.com/ClickHouse/ClickHouse/pull/54391) ([itayisraelov](https://github.com/itayisraelov))。
- 引入 `-ArgMin`/`-ArgMax` 聚合组合器,允许仅按最小值/最大值进行聚合。可以在 [#54818](https://github.com/ClickHouse/ClickHouse/issues/54818) 中找到一个用例。此 PR 还将组合器重新组织到专用文件夹中。[#54947](https://github.com/ClickHouse/ClickHouse/pull/54947) ([Amos Bird](https://github.com/amosbird))。
- 允许使用 `SYSTEM DROP SCHEMA FORMAT CACHE [FOR Protobuf]` 清除 Protobuf 格式的缓存。[#55064](https://github.com/ClickHouse/ClickHouse/pull/55064) ([Aleksandr Musorin](https://github.com/AVMusorin))。
- 添加外部 HTTP Basic 身份验证器。[#55199](https://github.com/ClickHouse/ClickHouse/pull/55199) ([Aleksei Filatov](https://github.com/aalexfvk))。
- 添加了函数 `byteSwap`,该函数反转无符号整数的字节。这对于反转内部表示为无符号整数的类型(如 IPv4)的值特别有用。[#55211](https://github.com/ClickHouse/ClickHouse/pull/55211) ([Priyansh Agrawal](https://github.com/Priyansh121096))。
- 添加了函数 `formatQuery`,该函数返回 SQL 查询字符串的格式化版本(可能跨越多行)。还添加了函数 `formatQuerySingleLine`,它执行相同的操作,但返回的字符串不包含换行符。[#55239](https://github.com/ClickHouse/ClickHouse/pull/55239) ([Salvatore Mesoraca](https://github.com/aiven-sal))。
- 添加了 `DWARF` 输入格式,该格式从 ELF 可执行文件/库/目标文件中读取调试符号。[#55450](https://github.com/ClickHouse/ClickHouse/pull/55450) ([Michael Kolupaev](https://github.com/al13n321))。
- 允许在 RabbitMQ、NATS 和 FileLog 引擎中保存未解析的记录和错误。添加虚拟列 `_error` 和 `_raw_message`(用于 NATS 和 RabbitMQ)、`_raw_record`(用于 FileLog),当 ClickHouse 无法解析新记录时会填充这些列。该行为通过存储设置进行控制:NATS 使用 `nats_handle_error_mode`,RabbitMQ 使用 `rabbitmq_handle_error_mode`,FileLog 使用 `handle_error_mode`,类似于 `kafka_handle_error_mode`。如果设置为 `default`,当 ClickHouse 无法解析记录时将抛出异常;如果设置为 `stream`,错误和原始记录将保存到虚拟列中。解决了 [#36035](https://github.com/ClickHouse/ClickHouse/issues/36035)。[#55477](https://github.com/ClickHouse/ClickHouse/pull/55477) ([Kruglov Pavel](https://github.com/Avogar))。
- Keeper 客户端改进:添加 `get_all_children_number command`,返回特定路径下所有子节点的数量。[#55485](https://github.com/ClickHouse/ClickHouse/pull/55485) ([guoxiaolong](https://github.com/guoxiaolongzte))。
- Keeper 客户端改进:添加 `get_direct_children_number` 命令,返回路径下直接子节点的数量。[#55898](https://github.com/ClickHouse/ClickHouse/pull/55898) ([xuzifu666](https://github.com/xuzifu666))。
- 添加语句 `SHOW SETTING setting_name`,这是现有语句 `SHOW SETTINGS` 的简化版本。[#55979](https://github.com/ClickHouse/ClickHouse/pull/55979) ([Maksim Kita](https://github.com/kitaisreal))。
- 向 `system.parts_columns` 表添加了字段 `substreams` 和 `filenames`。[#55108](https://github.com/ClickHouse/ClickHouse/pull/55108) ([Anton Popov](https://github.com/CurtizJ))。
- 添加对 `SHOW MERGES` 查询的支持。[#55815](https://github.com/ClickHouse/ClickHouse/pull/55815) ([megao](https://github.com/jetgm))。
- 引入设置 `create_table_empty_primary_key_by_default` 用于默认 `ORDER BY ()`。[#55899](https://github.com/ClickHouse/ClickHouse/pull/55899) ([Srikanth Chekuri](https://github.com/srikanthccv))。





#### 性能改进 {#performance-improvement-2}

- 添加选项 `query_plan_preserve_num_streams_after_window_functions`,在窗口函数计算后保留流的数量,以支持并行流处理。[#50771](https://github.com/ClickHouse/ClickHouse/pull/50771) ([frinkr](https://github.com/frinkr))。
- 当数据量较小时释放更多流。[#53867](https://github.com/ClickHouse/ClickHouse/pull/53867) ([Jiebin Sun](https://github.com/jiebinn))。
- 在序列化之前优化 RoaringBitmaps。[#55044](https://github.com/ClickHouse/ClickHouse/pull/55044) ([UnamedRus](https://github.com/UnamedRus))。
- 倒排索引中的倒排列表现已优化,对内部位图使用尽可能小的表示形式。根据数据的重复程度,这可能会显著减少倒排索引的空间占用。[#55069](https://github.com/ClickHouse/ClickHouse/pull/55069) ([Harry Lee](https://github.com/HarryLeeIBM))。
- 修复 Context 锁的竞争问题,显著提升了大量短时并发查询的性能。[#55121](https://github.com/ClickHouse/ClickHouse/pull/55121) ([Maksim Kita](https://github.com/kitaisreal))。
- 通过将 `std::unordered_map` 替换为 `absl::flat_hash_map`,将倒排索引创建性能提升了 30%。[#55210](https://github.com/ClickHouse/ClickHouse/pull/55210) ([Harry Lee](https://github.com/HarryLeeIBM))。
- 支持 ORC 过滤器下推(行组级别)。[#55330](https://github.com/ClickHouse/ClickHouse/pull/55330) ([李扬](https://github.com/taiyang-li))。
- 提升具有大量临时文件的外部聚合性能。[#55489](https://github.com/ClickHouse/ClickHouse/pull/55489) ([Maksim Kita](https://github.com/kitaisreal))。
- 默认为二级索引的标记缓存设置合理大小,避免反复加载标记。[#55654](https://github.com/ClickHouse/ClickHouse/pull/55654) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 读取跳数索引时避免不必要的索引颗粒重建。这解决了 [#55653](https://github.com/ClickHouse/ClickHouse/issues/55653#issuecomment-1763766009)。[#55683](https://github.com/ClickHouse/ClickHouse/pull/55683) ([Amos Bird](https://github.com/amosbird))。
- 在执行期间缓存集合中的 CAST 函数,以提升当集合元素类型与列类型不完全匹配时 `IN` 函数的性能。[#55712](https://github.com/ClickHouse/ClickHouse/pull/55712) ([Duc Canh Le](https://github.com/canhld94))。
- 提升 `ColumnVector::insertMany` 和 `ColumnVector::insertManyFrom` 的性能。[#55714](https://github.com/ClickHouse/ClickHouse/pull/55714) ([frinkr](https://github.com/frinkr))。
- 通过预测下一行的键位置并减少比较次数,优化 Map 下标操作。[#55929](https://github.com/ClickHouse/ClickHouse/pull/55929) ([lgbo](https://github.com/lgbo-ustc))。
- 支持 Parquet 中的结构体字段裁剪(在之前的版本中某些情况下无法正常工作)。[#56117](https://github.com/ClickHouse/ClickHouse/pull/56117) ([lgbo](https://github.com/lgbo-ustc))。
- 添加根据待读取行数估算来调整查询执行中使用的并行副本数量的能力。[#51692](https://github.com/ClickHouse/ClickHouse/pull/51692) ([Raúl Marín](https://github.com/Algunenano))。
- 优化生成大量临时文件时外部聚合的内存消耗。[#54798](https://github.com/ClickHouse/ClickHouse/pull/54798) ([Nikita Taranov](https://github.com/nickitat))。
- 在 `async_socket_for_remote` 模式(默认)下执行的分布式查询现在遵守 `max_threads` 限制。以前,某些查询可能会创建过多线程(最多 `max_distributed_connections`),导致服务器性能问题。[#53504](https://github.com/ClickHouse/ClickHouse/pull/53504) ([filimonov](https://github.com/filimonov))。
- 从 Zookeeper 分布式 DDL 队列执行 DDL 时缓存可跳过的条目。[#54828](https://github.com/ClickHouse/ClickHouse/pull/54828) ([Duc Canh Le](https://github.com/canhld94))。
- 实验性倒排索引不再存储具有过多匹配项的标记(即倒排列表中的行 ID)。这节省了空间,并在顺序扫描同样快速或更快时避免了低效的索引查找。之前控制何时不存储标记的启发式方法(传递给索引定义的 `density` 参数)对用户来说过于复杂。现引入了一种基于参数 `max_rows_per_postings_list`(默认值:64k)的更简单启发式方法,直接控制倒排列表中允许的最大行 ID 数量。[#55616](https://github.com/ClickHouse/ClickHouse/pull/55616) ([Harry Lee](https://github.com/HarryLeeIBM))。
- 提升 `EmbeddedRocksDB` 表的写入性能。[#55732](https://github.com/ClickHouse/ClickHouse/pull/55732) ([Duc Canh Le](https://github.com/canhld94))。
- 提升了 ClickHouse 在分区内存在大量数据部分(超过 1000 个)时的整体稳定性。这可能会减少 `TOO_MANY_PARTS` 错误的数量。[#55526](https://github.com/ClickHouse/ClickHouse/pull/55526) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 减少加载层次字典时的内存消耗。[#55838](https://github.com/ClickHouse/ClickHouse/pull/55838) ([Nikita Taranov](https://github.com/nickitat))。
- 所有字典都支持设置 `dictionary_use_async_executor`。[#55839](https://github.com/ClickHouse/ClickHouse/pull/55839) ([vdimir](https://github.com/vdimir))。
- 防止反序列化 AggregateFunctionTopKGenericData 时过度使用内存。[#55947](https://github.com/ClickHouse/ClickHouse/pull/55947) ([Raúl Marín](https://github.com/Algunenano))。
- 在具有大量监视的 Keeper 上,AsyncMetrics 线程可能会在 `DB::KeeperStorage::getSessionsWithWatchesCount` 中长时间消耗 100% 的 CPU。修复方法是避免遍历庞大的 `watches` 和 `list_watches` 集合。[#56054](https://github.com/ClickHouse/ClickHouse/pull/56054) ([Alexander Gololobov](https://github.com/davenger))。
- 添加设置 `optimize_trivial_approximate_count_query`,对 EmbeddedRocksDB 存储使用 `count` 近似值。为 StorageJoin 启用简单计数。[#55806](https://github.com/ClickHouse/ClickHouse/pull/55806) ([Duc Canh Le](https://github.com/canhld94))。





#### 改进 {#improvement-2}

- Functions `toDayOfWeek` (MySQL alias: `DAYOFWEEK`), `toYearWeek` (`YEARWEEK`) and `toWeek` (`WEEK`) now supports `String` arguments. This makes its behavior consistent with MySQL's behavior. [#55589](https://github.com/ClickHouse/ClickHouse/pull/55589) ([Robert Schulze](https://github.com/rschu1ze)).
- Introduced setting `date_time_overflow_behavior` with possible values `ignore`, `throw`, `saturate` that controls the overflow behavior when converting from Date, Date32, DateTime64, Integer or Float to Date, Date32, DateTime or DateTime64. [#55696](https://github.com/ClickHouse/ClickHouse/pull/55696) ([Andrey Zvonov](https://github.com/zvonand)).
- Implement query parameters support for `ALTER TABLE ... ACTION PARTITION [ID] {parameter_name:ParameterType}`. Merges [#49516](https://github.com/ClickHouse/ClickHouse/issues/49516). Closes [#49449](https://github.com/ClickHouse/ClickHouse/issues/49449). [#55604](https://github.com/ClickHouse/ClickHouse/pull/55604) ([alesapin](https://github.com/alesapin)).
- Print processor ids in a prettier manner in EXPLAIN. [#48852](https://github.com/ClickHouse/ClickHouse/pull/48852) ([Vlad Seliverstov](https://github.com/behebot)).
- Creating a direct dictionary with a lifetime field will be rejected at create time (as the lifetime does not make sense for direct dictionaries). Fixes: [#27861](https://github.com/ClickHouse/ClickHouse/issues/27861). [#49043](https://github.com/ClickHouse/ClickHouse/pull/49043) ([Rory Crispin](https://github.com/RoryCrispin)).
- Allow parameters in queries with partitions like `ALTER TABLE t DROP PARTITION`. Closes [#49449](https://github.com/ClickHouse/ClickHouse/issues/49449). [#49516](https://github.com/ClickHouse/ClickHouse/pull/49516) ([Nikolay Degterinsky](https://github.com/evillique)).
- Add a new column `xid` for `system.zookeeper_connection`. [#50702](https://github.com/ClickHouse/ClickHouse/pull/50702) ([helifu](https://github.com/helifu)).
- Display the correct server settings in `system.server_settings` after configuration reload. [#53774](https://github.com/ClickHouse/ClickHouse/pull/53774) ([helifu](https://github.com/helifu)).
- Add support for mathematical minus `−` character in queries, similar to `-`. [#54100](https://github.com/ClickHouse/ClickHouse/pull/54100) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Add replica groups to the experimental `Replicated` database engine. Closes [#53620](https://github.com/ClickHouse/ClickHouse/issues/53620). [#54421](https://github.com/ClickHouse/ClickHouse/pull/54421) ([Nikolay Degterinsky](https://github.com/evillique)).
- It is better to retry retriable s3 errors than totally fail the query. Set bigger value to the s3_retry_attempts by default. [#54770](https://github.com/ClickHouse/ClickHouse/pull/54770) ([Sema Checherinda](https://github.com/CheSema)).
- Add load balancing mode `hostname_levenshtein_distance`. [#54826](https://github.com/ClickHouse/ClickHouse/pull/54826) ([JackyWoo](https://github.com/JackyWoo)).
- Improve hiding secrets in logs. [#55089](https://github.com/ClickHouse/ClickHouse/pull/55089) ([Vitaly Baranov](https://github.com/vitlibar)).
- For now the projection analysis will be performed only on top of query plan. The setting `query_plan_optimize_projection` became obsolete (it was enabled by default long time ago). [#55112](https://github.com/ClickHouse/ClickHouse/pull/55112) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- When function `untuple` is now called on a tuple with named elements and itself has an alias (e.g. `select untuple(tuple(1)::Tuple(element_alias Int)) AS untuple_alias`), then the result column name is now generated from the untuple alias and the tuple element alias (in the example: "untuple_alias.element_alias"). [#55123](https://github.com/ClickHouse/ClickHouse/pull/55123) ([garcher22](https://github.com/garcher22)).
- Added setting `describe_include_virtual_columns`, which allows to include virtual columns of table into result of `DESCRIBE` query. Added setting `describe_compact_output`. If it is set to `true`, `DESCRIBE` query returns only names and types of columns without extra information. [#55129](https://github.com/ClickHouse/ClickHouse/pull/55129) ([Anton Popov](https://github.com/CurtizJ)).
- Sometimes `OPTIMIZE` with `optimize_throw_if_noop=1` may fail with an error `unknown reason` while the real cause of it - different projections in different parts. This behavior is fixed. [#55130](https://github.com/ClickHouse/ClickHouse/pull/55130) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Allow to have several `MaterializedPostgreSQL` tables following the same Postgres table. By default this behaviour is not enabled (for compatibility, because it is a backward-incompatible change), but can be turned on with setting `materialized_postgresql_use_unique_replication_consumer_identifier`. Closes [#54918](https://github.com/ClickHouse/ClickHouse/issues/54918). [#55145](https://github.com/ClickHouse/ClickHouse/pull/55145) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Allow to parse negative `DateTime64` and `DateTime` with fractional part from short strings. [#55146](https://github.com/ClickHouse/ClickHouse/pull/55146) ([Andrey Zvonov](https://github.com/zvonand)).
- To improve compatibility with MySQL, 1. `information_schema.tables` now includes the new field `table_rows`, and 2. `information_schema.columns` now includes the new field `extra`. [#55215](https://github.com/ClickHouse/ClickHouse/pull/55215) ([Robert Schulze](https://github.com/rschu1ze)).
- Clickhouse-client won't show "0 rows in set" if it is zero and if exception was thrown. [#55240](https://github.com/ClickHouse/ClickHouse/pull/55240) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
- Support rename table without keyword `TABLE` like `RENAME db.t1 to db.t2`. [#55373](https://github.com/ClickHouse/ClickHouse/pull/55373) ([凌涛](https://github.com/lingtaolf)).
- Add `internal_replication` to `system.clusters`. [#55377](https://github.com/ClickHouse/ClickHouse/pull/55377) ([Konstantin Morozov](https://github.com/k-morozov)).
- Select remote proxy resolver based on request protocol, add proxy feature docs and remove `DB::ProxyConfiguration::Protocol::ANY`. [#55430](https://github.com/ClickHouse/ClickHouse/pull/55430) ([Arthur Passos](https://github.com/arthurpassos)).
- Avoid retrying keeper operations on INSERT after table shutdown. [#55519](https://github.com/ClickHouse/ClickHouse/pull/55519) ([Azat Khuzhin](https://github.com/azat)).
- `SHOW COLUMNS` now correctly reports type `FixedString` as `BLOB` if setting `use_mysql_types_in_show_columns` is on. Also added two new settings, `mysql_map_string_to_text_in_show_columns` and `mysql_map_fixed_string_to_text_in_show_columns` to switch the output for types `String` and `FixedString` as `TEXT` or `BLOB`. [#55617](https://github.com/ClickHouse/ClickHouse/pull/55617) ([Serge Klochkov](https://github.com/slvrtrn)).
- During ReplicatedMergeTree tables startup clickhouse server checks set of parts for unexpected parts (exists locally, but not in zookeeper). All unexpected parts move to detached directory and instead of them server tries to restore some ancestor (covered) parts. Now server tries to restore closest ancestors instead of random covered parts. [#55645](https://github.com/ClickHouse/ClickHouse/pull/55645) ([alesapin](https://github.com/alesapin)).
- The advanced dashboard now supports draggable charts on touch devices. This closes [#54206](https://github.com/ClickHouse/ClickHouse/issues/54206). [#55649](https://github.com/ClickHouse/ClickHouse/pull/55649) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Use the default query format if declared when outputting exception with `http_write_exception_in_output_format`. [#55739](https://github.com/ClickHouse/ClickHouse/pull/55739) ([Raúl Marín](https://github.com/Algunenano)).
- Provide a better message for common MATERIALIZED VIEW pitfalls. [#55826](https://github.com/ClickHouse/ClickHouse/pull/55826) ([Raúl Marín](https://github.com/Algunenano)).
- If you dropped the current database, you will still be able to run some queries in `clickhouse-local` and switch to another database. This makes the behavior consistent with `clickhouse-client`. This closes [#55834](https://github.com/ClickHouse/ClickHouse/issues/55834). [#55853](https://github.com/ClickHouse/ClickHouse/pull/55853) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Functions `(add|subtract)(Year|Quarter|Month|Week|Day|Hour|Minute|Second|Millisecond|Microsecond|Nanosecond)` now support string-encoded date arguments, e.g. `SELECT addDays('2023-10-22', 1)`. This increases compatibility with MySQL and is needed by Tableau Online. [#55869](https://github.com/ClickHouse/ClickHouse/pull/55869) ([Robert Schulze](https://github.com/rschu1ze)).
- The setting `apply_deleted_mask` when disabled allows to read rows that where marked as deleted by lightweight DELETE queries. This is useful for debugging. [#55952](https://github.com/ClickHouse/ClickHouse/pull/55952) ([Alexander Gololobov](https://github.com/davenger)).
- Allow skipping `null` values when serailizing Tuple to json objects, which makes it possible to keep compatibility with Spark's `to_json` function, which is also useful for gluten. [#55956](https://github.com/ClickHouse/ClickHouse/pull/55956) ([李扬](https://github.com/taiyang-li)).
- Functions `(add|sub)Date` now support string-encoded date arguments, e.g. `SELECT addDate('2023-10-22 11:12:13', INTERVAL 5 MINUTE)`. The same support for string-encoded date arguments is added to the plus and minus operators, e.g. `SELECT '2023-10-23' + INTERVAL 1 DAY`. This increases compatibility with MySQL and is needed by Tableau Online. [#55960](https://github.com/ClickHouse/ClickHouse/pull/55960) ([Robert Schulze](https://github.com/rschu1ze)).
- Allow unquoted strings with CR (`\r`) in CSV format. Closes [#39930](https://github.com/ClickHouse/ClickHouse/issues/39930). [#56046](https://github.com/ClickHouse/ClickHouse/pull/56046) ([Kruglov Pavel](https://github.com/Avogar)).
- Allow to run `clickhouse-keeper` using embedded config. [#56086](https://github.com/ClickHouse/ClickHouse/pull/56086) ([Maksim Kita](https://github.com/kitaisreal)).
- Set limit of the maximum configuration value for `queued.min.messages` to avoid problem with start fetching data with Kafka. [#56121](https://github.com/ClickHouse/ClickHouse/pull/56121) ([Stas Morozov](https://github.com/r3b-fish)).
- Fixed a typo in SQL function `minSampleSizeContinous` (renamed `minSampleSizeContinuous`). Old name is preserved for backward compatibility. This closes: [#56139](https://github.com/ClickHouse/ClickHouse/issues/56139). [#56143](https://github.com/ClickHouse/ClickHouse/pull/56143) ([Dorota Szeremeta](https://github.com/orotaday)).
- Print path for broken parts on disk before shutting down the server. Before this change if a part is corrupted on disk and server cannot start, it was almost impossible to understand which part is broken. This is fixed. [#56181](https://github.com/ClickHouse/ClickHouse/pull/56181) ([Duc Canh Le](https://github.com/canhld94)).

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-2}

- 如果 Docker 中的数据库已完成初始化,后续启动时将无需重复初始化。这可以修复数据库在 1000 次尝试内加载失败导致容器无限重启的问题(适用于超大型数据库和多节点部署场景)。[#50724](https://github.com/ClickHouse/ClickHouse/pull/50724) ([Alexander Nikolaev](https://github.com/AlexNik))。
- 在 Darwin 专用构建任务中构建包含子模块的源代码资源。该资源可用于在不检出子模块的情况下构建 ClickHouse。[#51435](https://github.com/ClickHouse/ClickHouse/pull/51435) ([Ilya Yatsishin](https://github.com/qoega))。
- 修复了全局启用 AVX 系列指令构建 ClickHouse 时出现的错误(不建议采用此方式)。错误原因是 snappy 未启用 `SNAPPY_HAVE_X86_CRC32`。[#55049](https://github.com/ClickHouse/ClickHouse/pull/55049) ([monchickey](https://github.com/monchickey))。
- 解决了从 `clickhouse-server` 包启动独立 `clickhouse-keeper` 的问题。[#55226](https://github.com/ClickHouse/ClickHouse/pull/55226) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- 在测试中将 RabbitMQ 版本更新至 3.12.6。改进了 RabbitMQ 测试的日志收集功能。[#55424](https://github.com/ClickHouse/ClickHouse/pull/55424) ([Ilya Yatsishin](https://github.com/qoega))。
- 修改了 openssl 和 boringssl 之间的错误消息差异,以修复功能测试。[#55975](https://github.com/ClickHouse/ClickHouse/pull/55975) ([MeenaRenganathan22](https://github.com/MeenaRenganathan22))。
- 使用上游仓库作为 apache datasketches 的来源。[#55787](https://github.com/ClickHouse/ClickHouse/pull/55787) ([Nikita Taranov](https://github.com/nickitat))。


#### 错误修复(官方稳定版本中用户可见的异常行为) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-2}

- Skip hardlinking inverted index files in mutation [#47663](https://github.com/ClickHouse/ClickHouse/pull/47663) ([cangyin](https://github.com/cangyin)).
- Fixed bug of `match` function (regex) with pattern containing alternation produces incorrect key condition. Closes #53222. [#54696](https://github.com/ClickHouse/ClickHouse/pull/54696) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix 'Cannot find column' in read-in-order optimization with ARRAY JOIN [#51746](https://github.com/ClickHouse/ClickHouse/pull/51746) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Support missed experimental `Object(Nullable(json))` subcolumns in query. [#54052](https://github.com/ClickHouse/ClickHouse/pull/54052) ([zps](https://github.com/VanDarkholme7)).
- Re-add fix for `accurateCastOrNull` [#54629](https://github.com/ClickHouse/ClickHouse/pull/54629) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
- Fix detecting `DEFAULT` for columns of a Distributed table created without AS [#55060](https://github.com/ClickHouse/ClickHouse/pull/55060) ([Vitaly Baranov](https://github.com/vitlibar)).
- Proper cleanup in case of exception in ctor of ShellCommandSource [#55103](https://github.com/ClickHouse/ClickHouse/pull/55103) ([Alexander Gololobov](https://github.com/davenger)).
- Fix deadlock in LDAP assigned role update [#55119](https://github.com/ClickHouse/ClickHouse/pull/55119) ([Julian Maicher](https://github.com/jmaicher)).
- Suppress error statistics update for internal exceptions [#55128](https://github.com/ClickHouse/ClickHouse/pull/55128) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix deadlock in backups [#55132](https://github.com/ClickHouse/ClickHouse/pull/55132) ([alesapin](https://github.com/alesapin)).
- Fix storage Iceberg files retrieval [#55144](https://github.com/ClickHouse/ClickHouse/pull/55144) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix partition pruning of extra columns in set. [#55172](https://github.com/ClickHouse/ClickHouse/pull/55172) ([Amos Bird](https://github.com/amosbird)).
- Fix recalculation of skip indexes in ALTER UPDATE queries when table has adaptive granularity [#55202](https://github.com/ClickHouse/ClickHouse/pull/55202) ([Duc Canh Le](https://github.com/canhld94)).
- Fix for background download in fs cache [#55252](https://github.com/ClickHouse/ClickHouse/pull/55252) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Avoid possible memory leaks in compressors in case of missing buffer finalization [#55262](https://github.com/ClickHouse/ClickHouse/pull/55262) ([Azat Khuzhin](https://github.com/azat)).
- Fix functions execution over sparse columns [#55275](https://github.com/ClickHouse/ClickHouse/pull/55275) ([Azat Khuzhin](https://github.com/azat)).
- Fix incorrect merging of Nested for SELECT FINAL FROM SummingMergeTree [#55276](https://github.com/ClickHouse/ClickHouse/pull/55276) ([Azat Khuzhin](https://github.com/azat)).
- Fix bug with inability to drop detached partition in replicated merge tree on top of S3 without zero copy [#55309](https://github.com/ClickHouse/ClickHouse/pull/55309) ([alesapin](https://github.com/alesapin)).
- Fix a crash in MergeSortingPartialResultTransform (due to zero chunks after `remerge`) [#55335](https://github.com/ClickHouse/ClickHouse/pull/55335) ([Azat Khuzhin](https://github.com/azat)).
- Fix data-race in CreatingSetsTransform (on errors) due to throwing shared exception [#55338](https://github.com/ClickHouse/ClickHouse/pull/55338) ([Azat Khuzhin](https://github.com/azat)).
- Fix trash optimization (up to a certain extent) [#55353](https://github.com/ClickHouse/ClickHouse/pull/55353) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix leak in StorageHDFS [#55370](https://github.com/ClickHouse/ClickHouse/pull/55370) ([Azat Khuzhin](https://github.com/azat)).
- Fix parsing of arrays in cast operator [#55417](https://github.com/ClickHouse/ClickHouse/pull/55417) ([Anton Popov](https://github.com/CurtizJ)).
- Fix filtering by virtual columns with OR filter in query [#55418](https://github.com/ClickHouse/ClickHouse/pull/55418) ([Azat Khuzhin](https://github.com/azat)).
- Fix MongoDB connection issues [#55419](https://github.com/ClickHouse/ClickHouse/pull/55419) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix MySQL interface boolean representation [#55427](https://github.com/ClickHouse/ClickHouse/pull/55427) ([Serge Klochkov](https://github.com/slvrtrn)).
- Fix MySQL text protocol DateTime formatting and LowCardinality(Nullable(T)) types reporting [#55479](https://github.com/ClickHouse/ClickHouse/pull/55479) ([Serge Klochkov](https://github.com/slvrtrn)).
- Make `use_mysql_types_in_show_columns` affect only `SHOW COLUMNS` [#55481](https://github.com/ClickHouse/ClickHouse/pull/55481) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix stack symbolizer parsing `DW_FORM_ref_addr` incorrectly and sometimes crashing [#55483](https://github.com/ClickHouse/ClickHouse/pull/55483) ([Michael Kolupaev](https://github.com/al13n321)).
- Destroy fiber in case of exception in cancelBefore in AsyncTaskExecutor [#55516](https://github.com/ClickHouse/ClickHouse/pull/55516) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix Query Parameters not working with custom HTTP handlers [#55521](https://github.com/ClickHouse/ClickHouse/pull/55521) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Fix checking of non handled data for Values format [#55527](https://github.com/ClickHouse/ClickHouse/pull/55527) ([Azat Khuzhin](https://github.com/azat)).
- Fix 'Invalid cursor state' in odbc interacting with MS SQL Server [#55558](https://github.com/ClickHouse/ClickHouse/pull/55558) ([vdimir](https://github.com/vdimir)).
- Fix max execution time and 'break' overflow mode [#55577](https://github.com/ClickHouse/ClickHouse/pull/55577) ([Alexander Gololobov](https://github.com/davenger)).
- Fix crash in QueryNormalizer with cyclic aliases [#55602](https://github.com/ClickHouse/ClickHouse/pull/55602) ([vdimir](https://github.com/vdimir)).
- Disable wrong optimization and add a test [#55609](https://github.com/ClickHouse/ClickHouse/pull/55609) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Merging [#52352](https://github.com/ClickHouse/ClickHouse/issues/52352) [#55621](https://github.com/ClickHouse/ClickHouse/pull/55621) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Add a test to avoid incorrect decimal sorting [#55662](https://github.com/ClickHouse/ClickHouse/pull/55662) ([Amos Bird](https://github.com/amosbird)).
- Fix progress bar for s3 and azure Cluster functions with url without globs [#55666](https://github.com/ClickHouse/ClickHouse/pull/55666) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix filtering by virtual columns with OR filter in query (resubmit) [#55678](https://github.com/ClickHouse/ClickHouse/pull/55678) ([Azat Khuzhin](https://github.com/azat)).
- Fixes and improvements for Iceberg storage [#55695](https://github.com/ClickHouse/ClickHouse/pull/55695) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix data race in CreatingSetsTransform (v2) [#55786](https://github.com/ClickHouse/ClickHouse/pull/55786) ([Azat Khuzhin](https://github.com/azat)).
- Throw exception when parsing illegal string as float if precise_float_parsing is true [#55861](https://github.com/ClickHouse/ClickHouse/pull/55861) ([李扬](https://github.com/taiyang-li)).
- Disable predicate pushdown if the CTE contains stateful functions [#55871](https://github.com/ClickHouse/ClickHouse/pull/55871) ([Raúl Marín](https://github.com/Algunenano)).
- Fix normalize ASTSelectWithUnionQuery, as it was stripping `FORMAT` from the query [#55887](https://github.com/ClickHouse/ClickHouse/pull/55887) ([flynn](https://github.com/ucasfl)).
- Try to fix possible segfault in Native ORC input format [#55891](https://github.com/ClickHouse/ClickHouse/pull/55891) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix window functions in case of sparse columns. [#55895](https://github.com/ClickHouse/ClickHouse/pull/55895) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- fix: StorageNull supports subcolumns [#55912](https://github.com/ClickHouse/ClickHouse/pull/55912) ([FFish](https://github.com/wxybear)).
- Do not write retriable errors for Replicated mutate/merge into error log [#55944](https://github.com/ClickHouse/ClickHouse/pull/55944) ([Azat Khuzhin](https://github.com/azat)).
- Fix `SHOW DATABASES LIMIT <N>` [#55962](https://github.com/ClickHouse/ClickHouse/pull/55962) ([Raúl Marín](https://github.com/Algunenano)).
- Fix autogenerated Protobuf schema with fields with underscore [#55974](https://github.com/ClickHouse/ClickHouse/pull/55974) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix dateTime64ToSnowflake64() with non-default scale [#55983](https://github.com/ClickHouse/ClickHouse/pull/55983) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix output/input of Arrow dictionary column [#55989](https://github.com/ClickHouse/ClickHouse/pull/55989) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix fetching schema from schema registry in AvroConfluent [#55991](https://github.com/ClickHouse/ClickHouse/pull/55991) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix 'Block structure mismatch' on concurrent ALTER and INSERTs in Buffer table [#55995](https://github.com/ClickHouse/ClickHouse/pull/55995) ([Michael Kolupaev](https://github.com/al13n321)).
- Fix incorrect free space accounting for least_used JBOD policy [#56030](https://github.com/ClickHouse/ClickHouse/pull/56030) ([Azat Khuzhin](https://github.com/azat)).
- Fix missing scalar issue when evaluating subqueries inside table functions [#56057](https://github.com/ClickHouse/ClickHouse/pull/56057) ([Amos Bird](https://github.com/amosbird)).
- Fix wrong query result when http_write_exception_in_output_format=1 [#56135](https://github.com/ClickHouse/ClickHouse/pull/56135) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix schema cache for fallback JSON->JSONEachRow with changed settings [#56172](https://github.com/ClickHouse/ClickHouse/pull/56172) ([Kruglov Pavel](https://github.com/Avogar)).
- Add error handler to odbc-bridge [#56185](https://github.com/ClickHouse/ClickHouse/pull/56185) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).

### <a id="239"></a> ClickHouse 版本 23.9, 2023-09-28 {#239}

#### 向后不兼容变更 {#backward-incompatible-change-3}

- 从默认 Prometheus 处理器中移除 `status_info` 配置选项和字典状态。[#54090](https://github.com/ClickHouse/ClickHouse/pull/54090) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 已从代码库中移除实验性的数据分片元数据缓存。[#54215](https://github.com/ClickHouse/ClickHouse/pull/54215) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 默认禁用 `input_format_json_try_infer_numbers_from_strings` 设置,因此默认不会尝试从 JSON 格式的字符串中推断数字,以避免当样本数据包含类似数字的字符串时可能出现的解析错误。[#55099](https://github.com/ClickHouse/ClickHouse/pull/55099) ([Kruglov Pavel](https://github.com/Avogar))。


#### 新功能 {#new-feature-3}

- 改进 JSON 格式的模式推断:1) 现在可以在 JSON 格式中通过设置 `input_format_json_try_infer_named_tuples_from_objects` 从 JSON 对象推断命名元组,而无需使用实验性 JSON 类型。以前在没有实验性 JSON 类型的情况下,我们只能将 JSON 对象推断为字符串或映射,现在可以推断为命名元组。生成的元组类型将包含在模式推断期间从数据样本中读取的对象的所有键。这对于读取不含稀疏对象的结构化 JSON 数据很有用。该设置默认启用。2) 允许在设置 `input_format_json_read_arrays_as_strings` 下将 JSON 数组解析为字符串类型的列。这有助于读取包含不同类型值的数组。3) 允许在设置 `input_format_json_infer_incomplete_types_as_strings` 下对样本数据中未知类型(`null`/`[]`/`{}`)的 JSON 键使用字符串类型。现在在 JSON 格式中,我们可以将任何值读取到字符串列中,并且可以通过对未知类型使用字符串类型来避免在模式推断期间出现错误 `Cannot determine type for column 'column_name' by first 25000 rows of data, most likely this column contains only Nulls or empty Arrays/Maps`,从而成功读取数据。[#54427](https://github.com/ClickHouse/ClickHouse/pull/54427) ([Kruglov Pavel](https://github.com/Avogar))。
- 为远程磁盘添加了 IO 调度支持。磁盘类型 `s3`、`s3_plain`、`hdfs` 和 `azure_blob_storage` 的存储配置现在可以包含保存资源名称的 `read_resource` 和 `write_resource` 元素。这些资源的调度策略可以在单独的服务器配置部分 `resources` 中配置。可以使用设置 `workload` 标记查询,并使用服务器配置部分 `workload_classifiers` 进行分类,以实现多样化的资源调度目标。更多详细信息请参阅[文档](/operations/workload-scheduling)。[#47009](https://github.com/ClickHouse/ClickHouse/pull/47009) ([Sergei Trifonov](https://github.com/serxa))。添加了 "bandwidth_limit" IO 调度节点类型。它允许您为通过此节点的流量指定 `max_speed` 和 `max_burst` 约束。[#54618](https://github.com/ClickHouse/ClickHouse/pull/54618) ([Sergei Trifonov](https://github.com/serxa))。
- 添加了基于 SSH 密钥的新型身份验证方式。它仅适用于原生 TCP 协议。[#41109](https://github.com/ClickHouse/ClickHouse/pull/41109) ([George Gamezardashvili](https://github.com/InfJoker))。
- 为 MergeTree 表添加了新列 `_block_number`。[#44532](https://github.com/ClickHouse/ClickHouse/issues/44532)。[#47532](https://github.com/ClickHouse/ClickHouse/pull/47532) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
- 为 `DROP TABLE` 查询添加了 `IF EMPTY` 子句。[#48915](https://github.com/ClickHouse/ClickHouse/pull/48915) ([Pavel Novitskiy](https://github.com/pnovitskiy))。
- SQL 函数 `toString(datetime, timezone)` 和 `formatDateTime(datetime, format, timezone)` 现在支持非常量时区参数。[#53680](https://github.com/ClickHouse/ClickHouse/pull/53680) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- 添加了对 `ALTER TABLE MODIFY COMMENT` 的支持。注意:很久以前外部贡献者添加了类似的功能,但该功能完全无法工作,只会让用户感到困惑。这解决了 [#36377](https://github.com/ClickHouse/ClickHouse/issues/36377)。[#51304](https://github.com/ClickHouse/ClickHouse/pull/51304) ([Alexey Milovidov](https://github.com/alexey-milovidov))。注意:此命令不会在副本之间传播,因此表的副本可能具有不同的注释。
- 添加了 `GCD`(即"最大公约数")作为新的数据压缩编解码器。该编解码器计算所有列值的最大公约数,然后将每个值除以最大公约数。GCD 编解码器是一种数据准备编解码器(类似于 Delta 和 DoubleDelta),不能单独使用。它适用于整数、小数和日期/时间类型的数据。GCD 编解码器的一个可行用例是列值以最大公约数的倍数变化(增加/减少),例如 24 - 28 - 16 - 24 - 8 - 24(假设 GCD = 4)。[#53149](https://github.com/ClickHouse/ClickHouse/pull/53149) ([Alexander Nam](https://github.com/seshWCS))。
- 添加了两个新的类型别名 `DECIMAL(P)`(作为 `DECIMAL(P, 0)` 的快捷方式)和 `DECIMAL`(作为 `DECIMAL(10, 0)` 的快捷方式)。这使 ClickHouse 与 MySQL 的 SQL 方言更加兼容。[#53328](https://github.com/ClickHouse/ClickHouse/pull/53328) ([Val Doroshchuk](https://github.com/valbok))。
- 添加了新的系统日志表 `backup_log` 以跟踪所有 `BACKUP` 和 `RESTORE` 操作。[#53638](https://github.com/ClickHouse/ClickHouse/pull/53638) ([Victor Krasnov](https://github.com/sirvickr))。
- 添加了格式设置 `output_format_markdown_escape_special_characters`(默认值:false)。该设置控制在 `Markdown` 输出格式中是否转义特殊字符(如 `!`、`#`、`$` 等)(即在其前面加上反斜杠)。[#53860](https://github.com/ClickHouse/ClickHouse/pull/53860) ([irenjj](https://github.com/irenjj))。
- 添加了函数 `decodeHTMLComponent`。[#54097](https://github.com/ClickHouse/ClickHouse/pull/54097) ([Bharat Nallan](https://github.com/bharatnc))。
- 向 query_log 表添加了 `peak_threads_usage`。[#54335](https://github.com/ClickHouse/ClickHouse/pull/54335) ([Alexey Gerasimchuck](https://github.com/Demilivor))。
- 为 clickhouse-client 添加了 `SHOW FUNCTIONS` 支持。[#54337](https://github.com/ClickHouse/ClickHouse/pull/54337) ([Julia Kartseva](https://github.com/wat-ze-hex))。
- 添加了函数 `toDaysSinceYearZero` 及其别名 `TO_DAYS`(为了与 MySQL 兼容),该函数返回自 `0001-01-01`(在前推格里高利历中)以来经过的天数。[#54479](https://github.com/ClickHouse/ClickHouse/pull/54479) ([Robert Schulze](https://github.com/rschu1ze))。函数 `toDaysSinceYearZero` 现在支持 `DateTime` 和 `DateTime64` 类型的参数。[#54856](https://github.com/ClickHouse/ClickHouse/pull/54856) ([Serge Klochkov](https://github.com/slvrtrn))。
- 添加了函数 `YYYYMMDDtoDate`、`YYYYMMDDtoDate32`、`YYYYMMDDhhmmssToDateTime` 和 `YYYYMMDDhhmmssToDateTime64`。它们将编码为整数的日期或日期时间(例如 20230911)转换为原生日期或日期时间。因此,它们提供了与现有函数 `YYYYMMDDToDate`、`YYYYMMDDToDateTime`、`YYYYMMDDhhmmddToDateTime`、`YYYYMMDDhhmmddToDateTime64` 相反的功能。[#54509](https://github.com/ClickHouse/ClickHouse/pull/54509) ([Quanfa Fu](https://github.com/dentiscalprum)) ([Robert Schulze](https://github.com/rschu1ze))。
- 添加了多个字符串距离函数,包括 `byteHammingDistance`、`editDistance`。[#54935](https://github.com/ClickHouse/ClickHouse/pull/54935) ([flynn](https://github.com/ucasfl))。
- 允许使用 `VALID UNTIL datetime` 子句为用户凭据指定过期日期以及可选的时间。[#51261](https://github.com/ClickHouse/ClickHouse/pull/51261) ([Nikolay Degterinsky](https://github.com/evillique))。
- 允许表函数 `s3`、`gcs`、`oss` 使用 S3 风格的 URL。URL 会自动转换为 HTTP。示例:`'s3://clickhouse-public-datasets/hits.csv'` 转换为 `'https://clickhouse-public-datasets.s3.amazonaws.com/hits.csv'`。[#54931](https://github.com/ClickHouse/ClickHouse/pull/54931) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- 添加了新设置 `print_pretty_type_names` 以美化打印深层嵌套类型,如元组/映射/数组。[#55095](https://github.com/ClickHouse/ClickHouse/pull/55095) ([Kruglov Pavel](https://github.com/Avogar))。





#### 性能改进 {#performance-improvement-3}

- 默认启用预取功能以加速从 S3 读取数据。[#53709](https://github.com/ClickHouse/ClickHouse/pull/53709) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 对于使用 FINAL 的查询,如果不需要,则不在孤立分区中隐式读取主键和版本列。[#53919](https://github.com/ClickHouse/ClickHouse/pull/53919) ([Duc Canh Le](https://github.com/canhld94))。
- 优化按常量键分组。在 https://github.com/ClickHouse/ClickHouse/pull/53529 之后,将优化使用 `_file/_path` 分组的查询。[#53549](https://github.com/ClickHouse/ClickHouse/pull/53549) ([Kruglov Pavel](https://github.com/Avogar))。
- 提高 `Decimal` 列的排序性能。如果 ORDER BY 包含 `Decimal` 列,则提高向 `MergeTree` 插入数据的性能。当数据已排序或接近排序时,提高排序性能。[#35961](https://github.com/ClickHouse/ClickHouse/pull/35961) ([Maksim Kita](https://github.com/kitaisreal))。
- 提高大型查询分析的性能。修复 [#51224](https://github.com/ClickHouse/ClickHouse/issues/51224)。[#51469](https://github.com/ClickHouse/ClickHouse/pull/51469) ([frinkr](https://github.com/frinkr))。
- 一项优化,如果从带有 GROUP BY 的子查询中选择,则将 `COUNT(DISTINCT ...)` 和各种 `uniq` 变体重写为 `count`。[#52082](https://github.com/ClickHouse/ClickHouse/pull/52082) [#52645](https://github.com/ClickHouse/ClickHouse/pull/52645) ([JackyWoo](https://github.com/JackyWoo))。
- 移除对 `mmap/mremap/munmap` 的手动调用,将所有这些工作委托给 `jemalloc`,从而略微提高了性能。[#52792](https://github.com/ClickHouse/ClickHouse/pull/52792) ([Nikita Taranov](https://github.com/nickitat))。
- 修复了使用 NATS 时 CPU 消耗过高的问题。[#54399](https://github.com/ClickHouse/ClickHouse/pull/54399) ([Vasilev Pyotr](https://github.com/vahpetr))。
- 由于我们对带有 datetime 参数的 `toString` 执行使用单独的指令,因此可以略微提高非 datetime 参数的性能,并使代码的某些部分更清晰。后续 [#53680](https://github.com/ClickHouse/ClickHouse/issues/53680)。[#54443](https://github.com/ClickHouse/ClickHouse/pull/54443) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- 此 PR 尝试将序列化结果直接放入 `ColumnString`,而不是将 json 元素序列化到 `std::stringstream` 中。[#54613](https://github.com/ClickHouse/ClickHouse/pull/54613) ([lgbo](https://github.com/lgbo-ustc))。
- 当表位于视图后面时,启用 ORDER BY 优化以按相应顺序从 MergeTree 表读取数据。[#54628](https://github.com/ClickHouse/ClickHouse/pull/54628) ([Vitaly Baranov](https://github.com/vitlibar))。
- 通过重用 `GeneratorJSONPath` 并移除多个共享指针来改进 JSON SQL 函数。[#54735](https://github.com/ClickHouse/ClickHouse/pull/54735) ([lgbo](https://github.com/lgbo-ustc))。
- Keeper 尝试批量刷新请求以获得更好的性能。[#53049](https://github.com/ClickHouse/ClickHouse/pull/53049) ([Antonio Andelic](https://github.com/antonio2368))。
- 现在 `clickhouse-client` 在 `INFILE 'glob_expression'` 的情况下并行处理文件。关闭 [#54218](https://github.com/ClickHouse/ClickHouse/issues/54218)。[#54533](https://github.com/ClickHouse/ClickHouse/pull/54533) ([Max K.](https://github.com/mkaynov))。
- 允许在主键列类型与 `IN` 函数右侧列类型不同的情况下,对 IN 函数使用主键。示例:`SELECT id FROM test_table WHERE id IN (SELECT '5')`。关闭 [#48936](https://github.com/ClickHouse/ClickHouse/issues/48936)。[#54544](https://github.com/ClickHouse/ClickHouse/pull/54544) ([Maksim Kita](https://github.com/kitaisreal))。
- Hash JOIN 尝试收缩内部缓冲区,使其消耗最大可用内存(由 `max_bytes_in_join` 设置)的一半。[#54584](https://github.com/ClickHouse/ClickHouse/pull/54584) ([vdimir](https://github.com/vdimir))。
- 对 array join 遵守 `max_block_size` 以避免可能的内存溢出。关闭 [#54290](https://github.com/ClickHouse/ClickHouse/issues/54290)。[#54664](https://github.com/ClickHouse/ClickHouse/pull/54664) ([李扬](https://github.com/taiyang-li))。
- 在 `s3` 表函数中重用 HTTP 连接。[#54812](https://github.com/ClickHouse/ClickHouse/pull/54812) ([Michael Kolupaev](https://github.com/al13n321))。
- 将 `MergeTreeRangeReader::Stream::ceilRowsToCompleteGranules` 中的线性搜索替换为二分搜索。[#54869](https://github.com/ClickHouse/ClickHouse/pull/54869) ([usurai](https://github.com/usurai))。

#### 实验性功能 {#experimental-feature}

- 现在可以通过 `max_threads_for_annoy_index_creation` 设置来并行创建 `Annoy` 索引。[#54047](https://github.com/ClickHouse/ClickHouse/pull/54047) ([Robert Schulze](https://github.com/rschu1ze))。
- 分布式表上的并行副本不再从所有副本读取数据 [#54199](https://github.com/ClickHouse/ClickHouse/pull/54199) ([Igor Nikonov](https://github.com/devcrafter))。


#### 改进 {#improvement-3}

- Allow to replace long names of files of columns in `MergeTree` data parts to hashes of names. It helps to avoid `File name too long` error in some cases. [#50612](https://github.com/ClickHouse/ClickHouse/pull/50612) ([Anton Popov](https://github.com/CurtizJ)).
- Parse data in `JSON` format as `JSONEachRow` if failed to parse metadata. It will allow to read files with `.json` extension even if real format is JSONEachRow. Closes [#45740](https://github.com/ClickHouse/ClickHouse/issues/45740). [#54405](https://github.com/ClickHouse/ClickHouse/pull/54405) ([Kruglov Pavel](https://github.com/Avogar)).
- Output valid JSON/XML on excetpion during HTTP query execution. Add setting `http_write_exception_in_output_format` to enable/disable this behaviour (enabled by default). [#52853](https://github.com/ClickHouse/ClickHouse/pull/52853) ([Kruglov Pavel](https://github.com/Avogar)).
- View `information_schema.tables` now has a new field `data_length` which shows the approximate size of the data on disk. Required to run queries generated by Amazon QuickSight. [#55037](https://github.com/ClickHouse/ClickHouse/pull/55037) ([Robert Schulze](https://github.com/rschu1ze)).
- The MySQL interface gained a minimal implementation of prepared statements, just enough to allow a connection from Tableau Online to ClickHouse via the MySQL connector. [#54115](https://github.com/ClickHouse/ClickHouse/pull/54115) ([Serge Klochkov](https://github.com/slvrtrn)). Please note: the prepared statements implementation is pretty minimal, we do not support arguments binding yet, it is not required in this particular Tableau online use case. It will be implemented as a follow-up if necessary after extensive testing of Tableau Online in case we discover issues.
- Support case-insensitive and dot-all matching modes in `regexp_tree` dictionaries. [#50906](https://github.com/ClickHouse/ClickHouse/pull/50906) ([Johann Gan](https://github.com/johanngan)).
- Keeper improvement: Add a `createIfNotExists` Keeper command. [#48855](https://github.com/ClickHouse/ClickHouse/pull/48855) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- More precise integer type inference, fix [#51236](https://github.com/ClickHouse/ClickHouse/issues/51236). [#53003](https://github.com/ClickHouse/ClickHouse/pull/53003) ([Chen768959](https://github.com/Chen768959)).
- Introduced resolving of charsets in the string literals for MaterializedMySQL. [#53220](https://github.com/ClickHouse/ClickHouse/pull/53220) ([Val Doroshchuk](https://github.com/valbok)).
- Fix a subtle issue with a rarely used `EmbeddedRocksDB` table engine in an extremely rare scenario: sometimes the `EmbeddedRocksDB` table engine does not close files correctly in NFS after running `DROP TABLE`. [#53502](https://github.com/ClickHouse/ClickHouse/pull/53502) ([Mingliang Pan](https://github.com/liangliangpan)).
- `RESTORE TABLE ON CLUSTER` must create replicated tables with a matching UUID on hosts. Otherwise the macro `{uuid}` in ZooKeeper path can't work correctly after RESTORE. This PR implements that. [#53765](https://github.com/ClickHouse/ClickHouse/pull/53765) ([Vitaly Baranov](https://github.com/vitlibar)).
- Added restore setting `restore_broken_parts_as_detached`: if it's true the RESTORE process won't stop on broken parts while restoring, instead all the broken parts will be copied to the `detached` folder with the prefix `broken-from-backup'. If it's false the RESTORE process will stop on the first broken part (if any). The default value is false. [#53877](https://github.com/ClickHouse/ClickHouse/pull/53877) ([Vitaly Baranov](https://github.com/vitlibar)).
- Add `elapsed_ns` field to HTTP headers X-ClickHouse-Progress and X-ClickHouse-Summary. [#54179](https://github.com/ClickHouse/ClickHouse/pull/54179) ([joelynch](https://github.com/joelynch)).
- Implementation of `reconfig` (https://github.com/ClickHouse/ClickHouse/pull/49450), `sync`, and `exists` commands for keeper-client. [#54201](https://github.com/ClickHouse/ClickHouse/pull/54201) ([pufit](https://github.com/pufit)).
- `clickhouse-local` and `clickhouse-client` now allow to specify the `--query` parameter multiple times, e.g. `./clickhouse-client --query "SELECT 1" --query "SELECT 2"`. This syntax is slightly more intuitive than `./clickhouse-client --multiquery "SELECT  1;S ELECT 2"`, a bit easier to script (e.g. `queries.push_back('--query "$q"')`) and more consistent with the behavior of existing parameter `--queries-file` (e.g. `./clickhouse client --queries-file queries1.sql --queries-file queries2.sql`). [#54249](https://github.com/ClickHouse/ClickHouse/pull/54249) ([Robert Schulze](https://github.com/rschu1ze)).
- Add sub-second precision to `formatReadableTimeDelta`. [#54250](https://github.com/ClickHouse/ClickHouse/pull/54250) ([Andrey Zvonov](https://github.com/zvonand)).
- Enable `allow_remove_stale_moving_parts` by default. [#54260](https://github.com/ClickHouse/ClickHouse/pull/54260) ([vdimir](https://github.com/vdimir)).
- Fix using count from cache and improve progress bar for reading from archives. [#54271](https://github.com/ClickHouse/ClickHouse/pull/54271) ([Kruglov Pavel](https://github.com/Avogar)).
- Add support for S3 credentials using SSO. To define a profile to be used with SSO, set `AWS_PROFILE` environment variable. [#54347](https://github.com/ClickHouse/ClickHouse/pull/54347) ([Antonio Andelic](https://github.com/antonio2368)).
- Support NULL as default for nested types Array/Tuple/Map for input formats. Closes [#51100](https://github.com/ClickHouse/ClickHouse/issues/51100). [#54351](https://github.com/ClickHouse/ClickHouse/pull/54351) ([Kruglov Pavel](https://github.com/Avogar)).
- Allow reading some unusual configuration of chunks from Arrow/Parquet formats. [#54370](https://github.com/ClickHouse/ClickHouse/pull/54370) ([Arthur Passos](https://github.com/arthurpassos)).
- Add `STD` alias to `stddevPop` function for MySQL compatibility. Closes [#54274](https://github.com/ClickHouse/ClickHouse/issues/54274). [#54382](https://github.com/ClickHouse/ClickHouse/pull/54382) ([Nikolay Degterinsky](https://github.com/evillique)).
- Add `addDate` function for compatibility with MySQL and `subDate` for consistency. Reference [#54275](https://github.com/ClickHouse/ClickHouse/issues/54275). [#54400](https://github.com/ClickHouse/ClickHouse/pull/54400) ([Nikolay Degterinsky](https://github.com/evillique)).
- Add `modification_time` into `system.detached_parts`. [#54506](https://github.com/ClickHouse/ClickHouse/pull/54506) ([Azat Khuzhin](https://github.com/azat)).
- Added a setting `splitby_max_substrings_includes_remaining_string` which controls if functions "splitBy\*()" with argument "max_substring" > 0 include the remaining string (if any) in the result array (Python/Spark semantics) or not. The default behavior does not change. [#54518](https://github.com/ClickHouse/ClickHouse/pull/54518) ([Robert Schulze](https://github.com/rschu1ze)).
- Better integer types inference for `Int64`/`UInt64` fields. Continuation of [#53003](https://github.com/ClickHouse/ClickHouse/pull/53003). Now it works also for nested types like Arrays of Arrays and for functions like `map/tuple`. Issue: [#51236](https://github.com/ClickHouse/ClickHouse/issues/51236). [#54553](https://github.com/ClickHouse/ClickHouse/pull/54553) ([Kruglov Pavel](https://github.com/Avogar)).
- Added array operations for multiplying, dividing and modulo on scalar. Works in each way, for example `5 * [5, 5]` and `[5, 5] * 5` - both cases are possible. [#54608](https://github.com/ClickHouse/ClickHouse/pull/54608) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Add optional `version` argument to `rm` command in `keeper-client` to support safer deletes. [#54708](https://github.com/ClickHouse/ClickHouse/pull/54708) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Disable killing the server by systemd (that may lead to data loss when using Buffer tables). [#54744](https://github.com/ClickHouse/ClickHouse/pull/54744) ([Azat Khuzhin](https://github.com/azat)).
- Added field `is_deterministic` to system table `system.functions` which indicates whether the result of a function is stable between two invocations (given exactly the same inputs) or not. [#54766](https://github.com/ClickHouse/ClickHouse/pull/54766) [#55035](https://github.com/ClickHouse/ClickHouse/pull/55035) ([Robert Schulze](https://github.com/rschu1ze)).
- Made the views in schema `information_schema` more compatible with the equivalent views in MySQL (i.e. modified and extended them) up to a point where Tableau Online is able to connect to ClickHouse. More specifically: 1. The type of field `information_schema.tables.table_type` changed from Enum8 to String. 2. Added fields `table_comment` and `table_collation` to view `information_schema.table`. 3. Added views `information_schema.key_column_usage` and `referential_constraints`. 4. Replaced uppercase aliases in `information_schema` views with concrete uppercase columns. [#54773](https://github.com/ClickHouse/ClickHouse/pull/54773) ([Serge Klochkov](https://github.com/slvrtrn)).
- The query cache now returns an error if the user tries to cache the result of a query with a non-deterministic function such as `now`, `randomString` and `dictGet`. Compared to the previous behavior (silently don't cache the result), this reduces confusion and surprise for users. [#54801](https://github.com/ClickHouse/ClickHouse/pull/54801) ([Robert Schulze](https://github.com/rschu1ze)).
- Forbid special columns like materialized/ephemeral/alias for `file`/`s3`/`url`/... storages, fix insert into ephemeral columns from files. Closes [#53477](https://github.com/ClickHouse/ClickHouse/issues/53477). [#54803](https://github.com/ClickHouse/ClickHouse/pull/54803) ([Kruglov Pavel](https://github.com/Avogar)).
- More configurable collecting metadata for backup. [#54804](https://github.com/ClickHouse/ClickHouse/pull/54804) ([Vitaly Baranov](https://github.com/vitlibar)).
- `clickhouse-local`'s log file (if enabled with --server_logs_file flag) will now prefix each line with timestamp, thread id, etc, just like `clickhouse-server`. [#54807](https://github.com/ClickHouse/ClickHouse/pull/54807) ([Michael Kolupaev](https://github.com/al13n321)).
- Field `is_obsolete` in the `system.merge_tree_settings` table - it is now 1 for obsolete merge tree settings. Previously, only the description indicated that the setting is obsolete. [#54837](https://github.com/ClickHouse/ClickHouse/pull/54837) ([Robert Schulze](https://github.com/rschu1ze)).
- Make it possible to use plural when using interval literals. `INTERVAL 2 HOURS` should be equivalent to `INTERVAL 2 HOUR`. [#54860](https://github.com/ClickHouse/ClickHouse/pull/54860) ([Jordi Villar](https://github.com/jrdi)).
- Always allow the creation of a projection with `Nullable` PK. This fixes [#54814](https://github.com/ClickHouse/ClickHouse/issues/54814). [#54895](https://github.com/ClickHouse/ClickHouse/pull/54895) ([Amos Bird](https://github.com/amosbird)).
- Retry backup's S3 operations after connection reset failure. [#54900](https://github.com/ClickHouse/ClickHouse/pull/54900) ([Vitaly Baranov](https://github.com/vitlibar)).
- Make the exception message exact in case of the maximum value of a settings is less than the minimum value. [#54925](https://github.com/ClickHouse/ClickHouse/pull/54925) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- `LIKE`, `match`, and other regular expressions matching functions now allow matching with patterns containing non-UTF-8 substrings by falling back to binary matching. Example: you can use `string LIKE '\xFE\xFF%'` to detect BOM. This closes [#54486](https://github.com/ClickHouse/ClickHouse/issues/54486). [#54942](https://github.com/ClickHouse/ClickHouse/pull/54942) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Added `ContextLockWaitMicroseconds` profile event. [#55029](https://github.com/ClickHouse/ClickHouse/pull/55029) ([Maksim Kita](https://github.com/kitaisreal)).
- The Keeper dynamically adjusts log levels. [#50372](https://github.com/ClickHouse/ClickHouse/pull/50372) ([helifu](https://github.com/helifu)).
- Added function `timestamp` for compatibility with MySQL. Closes [#54275](https://github.com/ClickHouse/ClickHouse/issues/54275). [#54639](https://github.com/ClickHouse/ClickHouse/pull/54639) ([Nikolay Degterinsky](https://github.com/evillique)).

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-3}

- 将 ClickHouse 官方构建和持续集成构建的编译器从 Clang 16 升级至 17。[#53831](https://github.com/ClickHouse/ClickHouse/pull/53831) ([Robert Schulze](https://github.com/rschu1ze))。
- 重新生成用于查询的顶级域名数据 (`tldLookup.generated.cpp`)。[#54269](https://github.com/ClickHouse/ClickHouse/pull/54269) ([Bharat Nallan](https://github.com/bharatnc))。
- 移除冗余的 `clickhouse-keeper-client` 符号链接。[#54587](https://github.com/ClickHouse/ClickHouse/pull/54587) ([Tomas Barton](https://github.com/deric))。
- 使用 `/usr/bin/env` 解析 bash——现已支持 Nix OS。[#54603](https://github.com/ClickHouse/ClickHouse/pull/54603) ([Fionera](https://github.com/fionera))。
- CMake 新增 `PROFILE_CPU` 选项,用于在不使用 DWARF 调用图的情况下执行 `perf record`。[#54917](https://github.com/ClickHouse/ClickHouse/pull/54917) ([Maksim Kita](https://github.com/kitaisreal))。
- 如果链接器不是 LLD,则停止并抛出致命错误。[#55036](https://github.com/ClickHouse/ClickHouse/pull/55036) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 将处理(编码/解码)base64 值的库从 Turbo-Base64 替换为 aklomp-base64。两者均在 x86 和 ARM 上支持 SIMD 加速,但替换原因如下:1. 后者的许可证(BSD-2)对 ClickHouse 更有利,而 Turbo64 已改用 GPL-3;2. aklomp-base64 拥有更多 GitHub 星标,看起来更具可持续性;3. aklomp-base64 的 API 稍显友好(尽管这可能是主观判断);4. aklomp-base64 不需要我们绕过某些 bug(如非线程安全的初始化)。注意:aklomp-base64 会拒绝未填充的 base64 值,而 Turbo-Base64 会尽力解码它们。RFC-4648 对填充是否强制性未作明确规定,但根据具体场景,这可能是需要注意的行为变化。[#54119](https://github.com/ClickHouse/ClickHouse/pull/54119) ([Mikhail Koviazin](https://github.com/mkmkme))。


#### 错误修复(官方稳定版本中用户可见的异常行为) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-3}

- 修复零拷贝复制中的 REPLACE/MOVE PARTITION 问题(注意:"零拷贝复制"是实验性功能)[#54193](https://github.com/ClickHouse/ClickHouse/pull/54193) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 修复零拷贝硬链接锁问题(注意:"零拷贝复制"是实验性功能)[#54859](https://github.com/ClickHouse/ClickHouse/pull/54859) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 修复零拷贝垃圾回收问题(注意:"零拷贝复制"是实验性功能)[#54550](https://github.com/ClickHouse/ClickHouse/pull/54550) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 将 HTTP 重试超时以毫秒为单位传递(之前不正确)。[#54438](https://github.com/ClickHouse/ClickHouse/pull/54438) ([Duc Canh Le](https://github.com/canhld94))。
- 修复 OUTFILE 中使用 `CapnProto`/`Protobuf` 时的误导性错误消息 [#52870](https://github.com/ClickHouse/ClickHouse/pull/52870) ([Kruglov Pavel](https://github.com/Avogar))。
- 修复带 LIMIT 的并行副本汇总报告问题 [#53050](https://github.com/ClickHouse/ClickHouse/pull/53050) ([Raúl Marín](https://github.com/Algunenano))。
- 修复从/到 S3 的 BACKUP 限流问题(在未使用原生复制的情况下)以及其他一些场景 [#53336](https://github.com/ClickHouse/ClickHouse/pull/53336) ([Azat Khuzhin](https://github.com/azat))。
- 修复复制整个目录时的 IO 限流问题 [#53338](https://github.com/ClickHouse/ClickHouse/pull/53338) ([Azat Khuzhin](https://github.com/azat))。
- 修复:移动到 prewhere 条件操作可能导致列丢失 [#53492](https://github.com/ClickHouse/ClickHouse/pull/53492) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
- 修复使用字节相等的部分进行替换时的内部错误 [#53735](https://github.com/ClickHouse/ClickHouse/pull/53735) ([Pedro Riera](https://github.com/priera))。
- 修复:要求参与插值表达式的列 [#53754](https://github.com/ClickHouse/ClickHouse/pull/53754) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
- 修复集群发现初始化以及在配置中设置故障点 [#54113](https://github.com/ClickHouse/ClickHouse/pull/54113) ([vdimir](https://github.com/vdimir))。
- 修复 `accurateCastOrNull` 中的问题 [#54136](https://github.com/ClickHouse/ClickHouse/pull/54136) ([Salvatore Mesoraca](https://github.com/aiven-sal))。
- 修复带 FINAL 修饰符的可空主键 [#54164](https://github.com/ClickHouse/ClickHouse/pull/54164) ([Amos Bird](https://github.com/amosbird))。
- 修复在存在重复数据时阻止向复制物化视图插入新数据的错误。[#54184](https://github.com/ClickHouse/ClickHouse/pull/54184) ([Pedro Riera](https://github.com/priera))。
- 修复:允许布隆过滤器使用 `IPv6` [#54200](https://github.com/ClickHouse/ClickHouse/pull/54200) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
- 修复 `IPv4` 可能的类型不匹配 [#54212](https://github.com/ClickHouse/ClickHouse/pull/54212) ([Bharat Nallan](https://github.com/bharatnc))。
- 修复重新创建索引时的 `system.data_skipping_indices` [#54225](https://github.com/ClickHouse/ClickHouse/pull/54225) ([Artur Malchanau](https://github.com/Hexta))。
- 修复多重连接重写器 v2 的名称冲突 [#54240](https://github.com/ClickHouse/ClickHouse/pull/54240) ([Tao Wang](https://github.com/wangtZJU))。
- 修复连接后 `system.errors` 中的意外错误 [#54306](https://github.com/ClickHouse/ClickHouse/pull/54306) ([vdimir](https://github.com/vdimir))。
- 修复 `isZeroOrNull(NULL)` [#54316](https://github.com/ClickHouse/ClickHouse/pull/54316) ([flynn](https://github.com/ucasfl))。
- 修复:在 `prefer_localhost_replica` = 1 的分布式表上使用并行副本 [#54334](https://github.com/ClickHouse/ClickHouse/pull/54334) ([Igor Nikonov](https://github.com/devcrafter))。
- 修复垂直合并 + 替换合并树 + 优化清理中的逻辑错误 [#54368](https://github.com/ClickHouse/ClickHouse/pull/54368) ([alesapin](https://github.com/alesapin))。
- 修复 `s3` 表函数中可能出现的 `URI contains invalid characters` 错误 [#54373](https://github.com/ClickHouse/ClickHouse/pull/54373) ([Kruglov Pavel](https://github.com/Avogar))。
- 修复 `arrayExists` 函数 AST 优化中的段错误 [#54379](https://github.com/ClickHouse/ClickHouse/pull/54379) ([Nikolay Degterinsky](https://github.com/evillique))。
- 在 `analysisOfVariance` 函数中加法前检查溢出 [#54385](https://github.com/ClickHouse/ClickHouse/pull/54385) ([Antonio Andelic](https://github.com/antonio2368))。
- 重现并修复 removeSharedRecursive 中的错误 [#54430](https://github.com/ClickHouse/ClickHouse/pull/54430) ([Sema Checherinda](https://github.com/CheSema))。
- 修复在 PREWHERE 和 FINAL 中使用 SimpleAggregateFunction 可能产生的不正确结果 [#54436](https://github.com/ClickHouse/ClickHouse/pull/54436) ([Azat Khuzhin](https://github.com/azat))。
- 修复非分析器的 indexHint 过滤部分 [#54449](https://github.com/ClickHouse/ClickHouse/pull/54449) ([Azat Khuzhin](https://github.com/azat))。
- 修复带规范化状态的聚合投影 [#54480](https://github.com/ClickHouse/ClickHouse/pull/54480) ([Amos Bird](https://github.com/amosbird))。
- `clickhouse-local`:多查询参数的相关内容 [#54498](https://github.com/ClickHouse/ClickHouse/pull/54498) ([CuiShuoGuo](https://github.com/bakam412))。
- `clickhouse-local` 支持 `--database` 命令行参数 [#54503](https://github.com/ClickHouse/ClickHouse/pull/54503) ([vdimir](https://github.com/vdimir))。
- 修复禁用 `input_format_with_names_use_header` 时 `-WithNames` 格式中可能出现的解析错误 [#54513](https://github.com/ClickHouse/ClickHouse/pull/54513) ([Kruglov Pavel](https://github.com/Avogar))。
- 修复 CHECKSUM_DOESNT_MATCH 错误的罕见情况 [#54549](https://github.com/ClickHouse/ClickHouse/pull/54549) ([alesapin](https://github.com/alesapin))。
- 修复已排序结果的 UNION ALL 排序 [#54564](https://github.com/ClickHouse/ClickHouse/pull/54564) ([Vitaly Baranov](https://github.com/vitlibar))。
- 修复 Keeper 中的快照安装 [#54572](https://github.com/ClickHouse/ClickHouse/pull/54572) ([Antonio Andelic](https://github.com/antonio2368))。
- 修复 `ColumnUnique` 中的竞态条件 [#54575](https://github.com/ClickHouse/ClickHouse/pull/54575) ([Nikita Taranov](https://github.com/nickitat))。
- Annoy/Usearch 索引:修复使用默认值构建时的 LOGICAL_ERROR [#54600](https://github.com/ClickHouse/ClickHouse/pull/54600) ([Robert Schulze](https://github.com/rschu1ze))。
- 修复 `ColumnDecimal` 的序列化 [#54601](https://github.com/ClickHouse/ClickHouse/pull/54601) ([Nikita Taranov](https://github.com/nickitat))。
- 修复 \*Cluster 函数对包含空格的列名的模式推断 [#54635](https://github.com/ClickHouse/ClickHouse/pull/54635) ([Kruglov Pavel](https://github.com/Avogar))。
- 修复在默认值和显式插入列的情况下使用插入表结构的问题 [#54655](https://github.com/ClickHouse/ClickHouse/pull/54655) ([Kruglov Pavel](https://github.com/Avogar))。
- 修复:避免使用可能包含交替的正则表达式匹配作为键条件。[#54696](https://github.com/ClickHouse/ClickHouse/pull/54696) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
- 修复带垂直合并和清理的 ReplacingMergeTree [#54706](https://github.com/ClickHouse/ClickHouse/pull/54706) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
- 修复 ORDER BY 后虚拟列值不正确的问题 [#54811](https://github.com/ClickHouse/ClickHouse/pull/54811) ([Michael Kolupaev](https://github.com/al13n321))。
- 修复非分析器的 indexHint 过滤部分 [#54825](https://github.com/ClickHouse/ClickHouse/pull/54825) [#54449](https://github.com/ClickHouse/ClickHouse/pull/54449) ([Azat Khuzhin](https://github.com/azat))。
- 修复 Keeper 关闭期间的段错误 [#54841](https://github.com/ClickHouse/ClickHouse/pull/54841) ([Antonio Andelic](https://github.com/antonio2368))。
- 修复 MaterializedPostgreSQL 中的 `Invalid number of rows in Chunk` [#54844](https://github.com/ClickHouse/ClickHouse/pull/54844) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 将过时的格式设置移至单独的部分 [#54855](https://github.com/ClickHouse/ClickHouse/pull/54855) ([Kruglov Pavel](https://github.com/Avogar))。
- 当分区键被修改时重建 `minmax_count_projection` [#54943](https://github.com/ClickHouse/ClickHouse/pull/54943) ([Amos Bird](https://github.com/amosbird))。
- 修复函数 `if` 中到 `ColumnVector<Int128>` 的错误转换 [#55019](https://github.com/ClickHouse/ClickHouse/pull/55019) ([Kruglov Pavel](https://github.com/Avogar))。
- 防止附加来自具有不同投影或索引的表的部分 [#55062](https://github.com/ClickHouse/ClickHouse/pull/55062) ([János Benjamin Antal](https://github.com/antaljanosbenjamin))。
- 为空子查询结果在标量结果映射中存储 NULL [#52240](https://github.com/ClickHouse/ClickHouse/pull/52240) ([vdimir](https://github.com/vdimir))。
- 修复 `FINAL` 在罕见情况下产生无效读取范围 [#54934](https://github.com/ClickHouse/ClickHouse/pull/54934) ([Nikita Taranov](https://github.com/nickitat))。
- 修复:无 keeper 重试的插入仲裁 [#55026](https://github.com/ClickHouse/ClickHouse/pull/55026) ([Igor Nikonov](https://github.com/devcrafter))。
- 修复可空的简单状态 [#55030](https://github.com/ClickHouse/ClickHouse/pull/55030) ([Pedro Riera](https://github.com/priera))。

### <a id="238"></a> ClickHouse 23.8 LTS 版本,2023-08-31 {#238}

#### 向后不兼容变更 {#backward-incompatible-change-4}

- 如果动态磁盘包含名称,应在磁盘函数参数中指定为 `disk = disk(name = 'disk_name'`, ...)`。在之前的版本中可以指定为 `disk = disk_<disk_name>(...)`,现已不再支持此方式。[#52820](https://github.com/ClickHouse/ClickHouse/pull/52820) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 当使用 `--concurrency` 参数且值大于 1 时,`clickhouse-benchmark` 将并行建立连接。以前,如果从欧洲到美国运行 1000 个并发连接,该工具几乎无法使用。现已修正高延迟连接的 QPS 计算。向后不兼容变更:`clickhouse-benchmark` 的 JSON 输出选项已被移除。如果您之前使用过此选项,可以从 `system.query_log` 中以 JSON 格式提取数据作为替代方案。[#53293](https://github.com/ClickHouse/ClickHouse/pull/53293) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `system.text_log` 中的 `microseconds` 列和 `system.metric_log` 中的 `milliseconds` 列已被移除,因为在存在 `event_time_microseconds` 列的情况下它们是冗余的。[#53601](https://github.com/ClickHouse/ClickHouse/pull/53601) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 弃用元数据缓存功能。该功能是实验性的且从未被使用过。该功能存在风险:[#51182](https://github.com/ClickHouse/ClickHouse/issues/51182)。移除 `system.merge_tree_metadata_cache` 系统表。元数据缓存在此版本中仍然可用,但将很快被移除。此变更关闭了 [#39197](https://github.com/ClickHouse/ClickHouse/issues/39197)。[#51303](https://github.com/ClickHouse/ClickHouse/pull/51303) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 禁用 TLS 连接中对 3DES 的支持。[#52893](https://github.com/ClickHouse/ClickHouse/pull/52893) ([Kenji Noguchi](https://github.com/knoguchi))。


#### 新功能 {#new-feature-4}

- 支持直接从 zip/7z/tar 归档文件导入。示例:`file('*.zip :: *.csv')`。[#50321](https://github.com/ClickHouse/ClickHouse/pull/50321) ([nikitakeba](https://github.com/nikitakeba))。
- 为 `trace_type = 'MemorySample'` 的 `system.trace_log` 添加 `ptr` 列。该列包含分配地址。新增 `flameGraph` 函数,可以构建包含已分配但未释放内存的火焰图。重构自 [#38391](https://github.com/ClickHouse/ClickHouse/issues/38391)。[#45322](https://github.com/ClickHouse/ClickHouse/pull/45322) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 新增表函数 `azureBlobStorageCluster`。支持的功能集与表函数 `s3Cluster` 非常相似。[#50795](https://github.com/ClickHouse/ClickHouse/pull/50795) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
- 允许使用 `cluster`、`clusterAllReplicas`、`remote` 和 `remoteSecure` 时不指定表名,相关问题 [#50808](https://github.com/ClickHouse/ClickHouse/issues/50808)。[#50848](https://github.com/ClickHouse/ClickHouse/pull/50848) ([Yangkuan Liu](https://github.com/LiuYangkuan))。
- 新增用于监控 Kafka 消费者的系统表。[#50999](https://github.com/ClickHouse/ClickHouse/pull/50999) ([Ilya Golshtein](https://github.com/ilejn))。
- 新增 `max_sessions_for_user` 设置。[#51724](https://github.com/ClickHouse/ClickHouse/pull/51724) ([Alexey Gerasimchuck](https://github.com/Demilivor))。
- 新增函数 `toUTCTimestamp/fromUTCTimestamp`,功能与 Spark 的 `to_utc_timestamp/from_utc_timestamp` 相同。[#52117](https://github.com/ClickHouse/ClickHouse/pull/52117) ([KevinyhZou](https://github.com/KevinyhZou))。
- 新增函数 `structureToCapnProtoSchema`/`structureToProtobufSchema`,可将 ClickHouse 表结构转换为 CapnProto/Protobuf 格式模式。允许使用从表结构自动生成的模式以 CapnProto/Protobuf 格式输入/输出数据,无需外部格式模式(由设置 `format_capn_proto_use_autogenerated_schema`/`format_protobuf_use_autogenerated_schema` 控制)。允许在输入/输出时使用设置 `output_format_schema` 导出自动生成的模式。[#52278](https://github.com/ClickHouse/ClickHouse/pull/52278) ([Kruglov Pavel](https://github.com/Avogar))。
- `system.query_log` 中的新字段 `query_cache_usage` 现在会显示查询缓存是否被使用以及如何使用。[#52384](https://github.com/ClickHouse/ClickHouse/pull/52384) ([Robert Schulze](https://github.com/rschu1ze))。
- 新增函数 `startsWithUTF8` 和 `endsWithUTF8`。[#52555](https://github.com/ClickHouse/ClickHouse/pull/52555) ([李扬](https://github.com/taiyang-li))。
- 允许 TSV/CustomSeparated/JSONCompactEachRow 格式中的列数可变,使模式推断支持可变列数。新增设置 `input_format_tsv_allow_variable_number_of_columns`、`input_format_custom_allow_variable_number_of_columns`、`input_format_json_compact_allow_variable_number_of_columns`。[#52692](https://github.com/ClickHouse/ClickHouse/pull/52692) ([Kruglov Pavel](https://github.com/Avogar))。
- 新增 `SYSTEM STOP/START PULLING REPLICATION LOG` 查询(用于测试 `ReplicatedMergeTree`)。[#52881](https://github.com/ClickHouse/ClickHouse/pull/52881) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 允许在发起节点上的 mutation 操作中执行常量非确定性函数。[#53129](https://github.com/ClickHouse/ClickHouse/pull/53129) ([Anton Popov](https://github.com/CurtizJ))。
- 新增输入格式 `One`,不读取任何数据,始终返回单行,包含类型为 `UInt8`、值为 `0` 的 `dummy` 列,类似于 `system.one`。它可以与 `_file/_path` 虚拟列一起使用,在 file/s3/url/hdfs 等表函数中列出文件而无需读取任何数据。[#53209](https://github.com/ClickHouse/ClickHouse/pull/53209) ([Kruglov Pavel](https://github.com/Avogar))。
- 新增 `tupleConcat` 函数。关闭 [#52759](https://github.com/ClickHouse/ClickHouse/issues/52759)。[#53239](https://github.com/ClickHouse/ClickHouse/pull/53239) ([Nikolay Degterinsky](https://github.com/evillique))。
- 支持 `TRUNCATE DATABASE` 操作。[#53261](https://github.com/ClickHouse/ClickHouse/pull/53261) ([Bharat Nallan](https://github.com/bharatnc))。
- 新增 `max_threads_for_indexes` 设置以限制用于主键处理的线程数。[#53313](https://github.com/ClickHouse/ClickHouse/pull/53313) ([jorisgio](https://github.com/jorisgio))。
- 重新添加 SipHash 密钥函数。[#53525](https://github.com/ClickHouse/ClickHouse/pull/53525) ([Salvatore Mesoraca](https://github.com/aiven-sal))。
- ([#52755](https://github.com/ClickHouse/ClickHouse/issues/52755)、[#52895](https://github.com/ClickHouse/ClickHouse/issues/52895)) 新增函数 `arrayRotateLeft`、`arrayRotateRight`、`arrayShiftLeft`、`arrayShiftRight`。[#53557](https://github.com/ClickHouse/ClickHouse/pull/53557) ([Mikhail Koviazin](https://github.com/mkmkme))。
- 向 `system.clusters` 添加列 `name` 作为 cluster 的别名。[#53605](https://github.com/ClickHouse/ClickHouse/pull/53605) ([irenjj](https://github.com/irenjj))。
- 高级仪表板现在支持批量编辑(保存/加载)。[#53608](https://github.com/ClickHouse/ClickHouse/pull/53608) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 高级仪表板现在支持最大化图表并移动它们。[#53622](https://github.com/ClickHouse/ClickHouse/pull/53622) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 新增对数组加法和减法的支持:`[5,2] + [1,7]`。由于逐点乘法和标量积之间存在混淆,未实现除法和乘法。关闭 [#49939](https://github.com/ClickHouse/ClickHouse/issues/49939)。[#52625](https://github.com/ClickHouse/ClickHouse/pull/52625) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- 新增对字符串字面量作为表名的支持。关闭 [#52178](https://github.com/ClickHouse/ClickHouse/issues/52178)。[#52635](https://github.com/ClickHouse/ClickHouse/pull/52635) ([hendrik-m](https://github.com/hendrik-m))。

#### 实验性功能 {#experimental-feature-1}

- 新增表引擎 `S3Queue`，用于从 S3 流式导入数据。关闭 [#37012](https://github.com/ClickHouse/ClickHouse/issues/37012)。[#49086](https://github.com/ClickHouse/ClickHouse/pull/49086) ([s-kat](https://github.com/s-kat))。此功能尚未就绪，请勿使用。
- 启用通过分布式表从副本并行读取数据。相关问题 [#49708](https://github.com/ClickHouse/ClickHouse/issues/49708)。[#53005](https://github.com/ClickHouse/ClickHouse/pull/53005) ([Igor Nikonov](https://github.com/devcrafter))。
- 新增对 HNSW 作为近似最近邻搜索方法的实验性支持。[#53447](https://github.com/ClickHouse/ClickHouse/pull/53447) ([Davit Vardanyan](https://github.com/davvard))。此功能目前仅供继续开发实现的人员使用，请勿使用。


#### 性能改进 {#performance-improvement-4}

- Parquet 过滤器下推。即在读取 Parquet 文件时,根据 WHERE 条件和每列的最小/最大值跳过行组(文件块)。特别是,如果文件按某列大致排序,则按该列的短范围进行过滤的查询速度将大幅提升。[#52951](https://github.com/ClickHouse/ClickHouse/pull/52951) ([Michael Kolupaev](https://github.com/al13n321))。
- 通过批量处理小行组来优化 Parquet 读取性能。关闭 [#53069](https://github.com/ClickHouse/ClickHouse/issues/53069)。[#53281](https://github.com/ClickHouse/ClickHouse/pull/53281) ([Kruglov Pavel](https://github.com/Avogar))。
- 优化大多数输入格式中从文件计数的操作。关闭 [#44334](https://github.com/ClickHouse/ClickHouse/issues/44334)。[#53637](https://github.com/ClickHouse/ClickHouse/pull/53637) ([Kruglov Pavel](https://github.com/Avogar))。
- 在 `url`/`file`/`hdfs` 表函数中读取之前使用文件/路径过滤。[#53529](https://github.com/ClickHouse/ClickHouse/pull/53529) ([Kruglov Pavel](https://github.com/Avogar))。
- 为 AArch64、PowerPC、SystemZ、RISC-V 启用 JIT 编译。[#38217](https://github.com/ClickHouse/ClickHouse/pull/38217) ([Maksim Kita](https://github.com/kitaisreal))。
- 添加设置 `rewrite_count_distinct_if_with_count_distinct_implementation` 以使用 `count_distinct_implementation` 重写 `countDistinctIf`。关闭 [#30642](https://github.com/ClickHouse/ClickHouse/issues/30642)。[#46051](https://github.com/ClickHouse/ClickHouse/pull/46051) ([flynn](https://github.com/ucasfl))。
- 通过在合并前并行化转换来加速 `uniq` 和 `uniqExact` 聚合函数状态的合并。[#50748](https://github.com/ClickHouse/ClickHouse/pull/50748) ([Jiebin Sun](https://github.com/jiebinn))。
- 在使用大量可变长度键时优化可空字符串键的聚合性能。[#51399](https://github.com/ClickHouse/ClickHouse/pull/51399) ([LiuNeng](https://github.com/liuneng1994))。
- 在 Analyzer 中添加用于时间过滤器优化的预映射处理过程。在 ICX 设备(Intel Xeon Platinum 8380 CPU,80 核,160 线程)上的 SSB 性能实验表明,当启用实验性分析器时,此更改可使几何平均 QPS 提高 8.5%。[#52091](https://github.com/ClickHouse/ClickHouse/pull/52091) ([Zhiguo Zhou](https://github.com/ZhiguoZh))。
- 如果 `uniqExact`(COUNT DISTINCT)函数中的所有哈希集都是单层的,则优化合并。[#52973](https://github.com/ClickHouse/ClickHouse/pull/52973) ([Jiebin Sun](https://github.com/jiebinn))。
- `Join` 表引擎:不克隆包含所有列的哈希连接数据结构。[#53046](https://github.com/ClickHouse/ClickHouse/pull/53046) ([Duc Canh Le](https://github.com/canhld94))。
- 实现不依赖 "apache arrow" 库的原生 `ORC` 输入格式以提高性能。[#53324](https://github.com/ClickHouse/ClickHouse/pull/53324) ([李扬](https://github.com/taiyang-li))。
- 仪表板将指示服务器压缩数据,这对于在慢速互联网连接上处理大时间范围非常有用。例如,一个包含 86400 个点的图表未压缩时可能为 1.5 MB,使用 `br` 压缩后为 60 KB。[#53569](https://github.com/ClickHouse/ClickHouse/pull/53569) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 更好地利用线程池进行备份和恢复操作。[#53649](https://github.com/ClickHouse/ClickHouse/pull/53649) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 在启动时并行加载文件系统缓存元数据。通过 `load_metadata_threads`(默认值:1)缓存配置设置进行配置。相关于 [#52037](https://github.com/ClickHouse/ClickHouse/issues/52037)。[#52943](https://github.com/ClickHouse/ClickHouse/pull/52943) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 改进 `move_primary_key_columns_to_end_of_prewhere`。[#53337](https://github.com/ClickHouse/ClickHouse/pull/53337) ([Han Fei](https://github.com/hanfei1991))。
- 这优化了与 ClickHouse Keeper 的交互。以前调用者可以多次注册相同的监视回调。在这种情况下,每个条目都会消耗内存,并且相同的回调会被多次调用,这没有太大意义。为了避免这种情况,调用者可以使用一些逻辑来避免多次添加相同的监视。通过此更改,如果监视回调通过 shared_ptr 传递,则会在内部完成去重。[#53452](https://github.com/ClickHouse/ClickHouse/pull/53452) ([Alexander Gololobov](https://github.com/davenger))。
- 在 file/s3/url/hdfs/azure 函数中缓存文件的行数以用于计数。可以通过设置 `use_cache_for_count_from_files`(默认启用)来启用/禁用缓存。https://github.com/ClickHouse/ClickHouse/pull/53637 的延续。[#53692](https://github.com/ClickHouse/ClickHouse/pull/53692) ([Kruglov Pavel](https://github.com/Avogar))。
- 更精细的线程管理将使 S3 表函数在处理大量文件时的速度提高 25% 以上。[#53668](https://github.com/ClickHouse/ClickHouse/pull/53668) ([pufit](https://github.com/pufit))。





#### 改进 {#improvement-4}

- Add `stderr_reaction` configuration/setting to control the reaction (none, log or throw) when external command stderr has data. This helps make debugging external command easier. [#43210](https://github.com/ClickHouse/ClickHouse/pull/43210) ([Amos Bird](https://github.com/amosbird)).
- Add `partition` column to the `system part_log` and merge table. [#48990](https://github.com/ClickHouse/ClickHouse/pull/48990) ([Jianfei Hu](https://github.com/incfly)).
- The sizes of the (index) uncompressed/mark, mmap and query caches can now be configured dynamically at runtime (without server restart). [#51446](https://github.com/ClickHouse/ClickHouse/pull/51446) ([Robert Schulze](https://github.com/rschu1ze)).
- If a dictionary is created with a complex key, automatically choose the "complex key" layout variant. [#49587](https://github.com/ClickHouse/ClickHouse/pull/49587) ([xiebin](https://github.com/xbthink)).
- Add setting `use_concurrency_control` for better testing of the new concurrency control feature. [#49618](https://github.com/ClickHouse/ClickHouse/pull/49618) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Added suggestions for mistyped names for databases and tables. [#49801](https://github.com/ClickHouse/ClickHouse/pull/49801) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- While read small files from HDFS by Gluten, we found that it will cost more times when compare to directly query by Spark. And we did something with that. [#50063](https://github.com/ClickHouse/ClickHouse/pull/50063) ([KevinyhZou](https://github.com/KevinyhZou)).
- There were too many worthless error logs after session expiration, which we didn't like. [#50171](https://github.com/ClickHouse/ClickHouse/pull/50171) ([helifu](https://github.com/helifu)).
- Introduce fallback ZooKeeper sessions which are time-bound. Fixed `index` column in system.zookeeper_connection for DNS addresses. [#50424](https://github.com/ClickHouse/ClickHouse/pull/50424) ([Anton Kozlov](https://github.com/tonickkozlov)).
- Add ability to log when max_partitions_per_insert_block is reached. [#50948](https://github.com/ClickHouse/ClickHouse/pull/50948) ([Sean Haynes](https://github.com/seandhaynes)).
- Added a bunch of custom commands to clickhouse-keeper-client (mostly to make ClickHouse debugging easier). [#51117](https://github.com/ClickHouse/ClickHouse/pull/51117) ([pufit](https://github.com/pufit)).
- Updated check for connection string in `azureBlobStorage` table function as connection string with "sas" does not always begin with the default endpoint and updated connection URL to include "sas" token after adding Azure's container to URL. [#51141](https://github.com/ClickHouse/ClickHouse/pull/51141) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Fix description for filtering sets in the `full_sorting_merge` JOIN algorithm. [#51329](https://github.com/ClickHouse/ClickHouse/pull/51329) ([Tanay Tummalapalli](https://github.com/ttanay)).
- Fixed memory consumption in `Aggregator` when `max_block_size` is huge. [#51566](https://github.com/ClickHouse/ClickHouse/pull/51566) ([Nikita Taranov](https://github.com/nickitat)).
- Add `SYSTEM SYNC FILESYSTEM CACHE` command. It will compare in-memory state of filesystem cache with what it has on disk and fix in-memory state if needed. This is only needed if you are making manual interventions in on-disk data, which is highly discouraged. [#51622](https://github.com/ClickHouse/ClickHouse/pull/51622) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Attempt to create a generic proxy resolver for CH while keeping backwards compatibility with existing S3 storage conf proxy resolver. [#51749](https://github.com/ClickHouse/ClickHouse/pull/51749) ([Arthur Passos](https://github.com/arthurpassos)).
- Support reading tuple subcolumns from file/s3/hdfs/url/azureBlobStorage table functions. [#51806](https://github.com/ClickHouse/ClickHouse/pull/51806) ([Kruglov Pavel](https://github.com/Avogar)).
- Function `arrayIntersect` now returns the values in the order, corresponding to the first argument. Closes [#27622](https://github.com/ClickHouse/ClickHouse/issues/27622). [#51850](https://github.com/ClickHouse/ClickHouse/pull/51850) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Add new queries, which allow to create/drop of access entities in specified access storage or move access entities from one access storage to another. [#51912](https://github.com/ClickHouse/ClickHouse/pull/51912) ([pufit](https://github.com/pufit)).
- Make `ALTER TABLE FREEZE` queries not replicated in the Replicated database engine. [#52064](https://github.com/ClickHouse/ClickHouse/pull/52064) ([Mike Kot](https://github.com/myrrc)).
- Added possibility to flush system tables on unexpected shutdown. [#52174](https://github.com/ClickHouse/ClickHouse/pull/52174) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
- Fix the case when `s3` table function refused to work with pre-signed URLs. close [#50846](https://github.com/ClickHouse/ClickHouse/issues/50846). [#52310](https://github.com/ClickHouse/ClickHouse/pull/52310) ([chen](https://github.com/xiedeyantu)).
- Add column `name` as an alias to `event` and `metric` in the `system.events` and `system.metrics` tables. Closes [#51257](https://github.com/ClickHouse/ClickHouse/issues/51257). [#52315](https://github.com/ClickHouse/ClickHouse/pull/52315) ([chen](https://github.com/xiedeyantu)).
- Added support of syntax `CREATE UNIQUE INDEX` in parser as a no-op for better SQL compatibility. `UNIQUE` index is not supported. Set `create_index_ignore_unique = 1` to ignore UNIQUE keyword in queries. [#52320](https://github.com/ClickHouse/ClickHouse/pull/52320) ([Ilya Yatsishin](https://github.com/qoega)).
- Add support of predefined macro (`{database}` and `{table}`) in some Kafka engine settings: topic, consumer, client_id, etc. [#52386](https://github.com/ClickHouse/ClickHouse/pull/52386) ([Yury Bogomolov](https://github.com/ybogo)).
- Disable updating the filesystem cache during backup/restore. Filesystem cache must not be updated during backup/restore, it seems it just slows down the process without any profit (because the BACKUP command can read a lot of data and it's no use to put all the data to the filesystem cache and immediately evict it). [#52402](https://github.com/ClickHouse/ClickHouse/pull/52402) ([Vitaly Baranov](https://github.com/vitlibar)).
- The configuration of S3 endpoint allow using it from the root, and append '/' automatically if needed. [#47809](https://github.com/ClickHouse/ClickHouse/issues/47809). [#52600](https://github.com/ClickHouse/ClickHouse/pull/52600) ([xiaolei565](https://github.com/xiaolei565)).
- For clickhouse-local allow positional options and populate global UDF settings (user_scripts_path and user_defined_executable_functions_config). [#52643](https://github.com/ClickHouse/ClickHouse/pull/52643) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- `system.asynchronous_metrics` now includes metrics "QueryCacheEntries" and "QueryCacheBytes" to inspect the query cache. [#52650](https://github.com/ClickHouse/ClickHouse/pull/52650) ([Robert Schulze](https://github.com/rschu1ze)).
- Added possibility to use `s3_storage_class` parameter in the `SETTINGS` clause of the `BACKUP` statement for backups to S3. [#52658](https://github.com/ClickHouse/ClickHouse/pull/52658) ([Roman Vasin](https://github.com/rvasin)).
- Add utility `print-backup-info.py` which parses a backup metadata file and prints information about the backup. [#52690](https://github.com/ClickHouse/ClickHouse/pull/52690) ([Vitaly Baranov](https://github.com/vitlibar)).
- Closes [#49510](https://github.com/ClickHouse/ClickHouse/issues/49510). Currently we have database and table names case-sensitive, but BI tools query `information_schema` sometimes in lowercase, sometimes in uppercase. For this reason we have `information_schema` database, containing lowercase tables, such as `information_schema.tables` and `INFORMATION_SCHEMA` database, containing uppercase tables, such as `INFORMATION_SCHEMA.TABLES`. But some tools are querying `INFORMATION_SCHEMA.tables` and `information_schema.TABLES`. The proposed solution is to duplicate both lowercase and uppercase tables in lowercase and uppercase `information_schema` database. [#52695](https://github.com/ClickHouse/ClickHouse/pull/52695) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Query`CHECK TABLE` has better performance and usability (sends progress updates, cancellable). [#52745](https://github.com/ClickHouse/ClickHouse/pull/52745) ([vdimir](https://github.com/vdimir)).
- Add support for `modulo`, `intDiv`, `intDivOrZero` for tuples by distributing them across tuple's elements. [#52758](https://github.com/ClickHouse/ClickHouse/pull/52758) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Search for default `yaml` and `yml` configs in clickhouse-client after `xml`. [#52767](https://github.com/ClickHouse/ClickHouse/pull/52767) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- When merging into non-'clickhouse' rooted configuration, configs with different root node name just bypassed without exception. [#52770](https://github.com/ClickHouse/ClickHouse/pull/52770) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Now it's possible to specify min (`memory_profiler_sample_min_allocation_size`) and max (`memory_profiler_sample_max_allocation_size`) size for allocations to be tracked with sampling memory profiler. [#52779](https://github.com/ClickHouse/ClickHouse/pull/52779) ([alesapin](https://github.com/alesapin)).
- Add `precise_float_parsing` setting to switch float parsing methods (fast/precise). [#52791](https://github.com/ClickHouse/ClickHouse/pull/52791) ([Andrey Zvonov](https://github.com/zvonand)).
- Use the same default paths for `clickhouse-keeper` (symlink) as for `clickhouse-keeper` (executable). [#52861](https://github.com/ClickHouse/ClickHouse/pull/52861) ([Vitaly Baranov](https://github.com/vitlibar)).
- Improve error message for table function `remote`. Closes [#40220](https://github.com/ClickHouse/ClickHouse/issues/40220). [#52959](https://github.com/ClickHouse/ClickHouse/pull/52959) ([jiyoungyoooo](https://github.com/jiyoungyoooo)).
- Added the possibility to specify custom storage policy in the `SETTINGS` clause of `RESTORE` queries. [#52970](https://github.com/ClickHouse/ClickHouse/pull/52970) ([Victor Krasnov](https://github.com/sirvickr)).
- Add the ability to throttle the S3 requests on backup operations (`BACKUP` and `RESTORE` commands now honor `s3_max_[get/put]_[rps/burst]`). [#52974](https://github.com/ClickHouse/ClickHouse/pull/52974) ([Daniel Pozo Escalona](https://github.com/danipozo)).
- Add settings to ignore ON CLUSTER clause in queries for management of replicated user-defined functions or access control entities with replicated storage. [#52975](https://github.com/ClickHouse/ClickHouse/pull/52975) ([Aleksei Filatov](https://github.com/aalexfvk)).
- EXPLAIN actions for JOIN step. [#53006](https://github.com/ClickHouse/ClickHouse/pull/53006) ([Maksim Kita](https://github.com/kitaisreal)).
- Make `hasTokenOrNull` and `hasTokenCaseInsensitiveOrNull` return null for empty needles. [#53059](https://github.com/ClickHouse/ClickHouse/pull/53059) ([ltrk2](https://github.com/ltrk2)).
- Allow to restrict allowed paths for filesystem caches. Mainly useful for dynamic disks. If in server config `filesystem_caches_path` is specified, all filesystem caches' paths will be restricted to this directory. E.g. if the `path` in cache config is relative - it will be put in `filesystem_caches_path`; if `path` in cache config is absolute, it will be required to lie inside `filesystem_caches_path`. If `filesystem_caches_path` is not specified in config, then behaviour will be the same as in earlier versions. [#53124](https://github.com/ClickHouse/ClickHouse/pull/53124) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Added a bunch of custom commands (mostly to make ClickHouse debugging easier). [#53127](https://github.com/ClickHouse/ClickHouse/pull/53127) ([pufit](https://github.com/pufit)).
- Add diagnostic info about file name during schema inference - it helps when you process multiple files with globs. [#53135](https://github.com/ClickHouse/ClickHouse/pull/53135) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Client will load suggestions using the main connection if the second connection is not allowed to create a session. [#53177](https://github.com/ClickHouse/ClickHouse/pull/53177) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
- Add EXCEPT clause to `SYSTEM STOP/START LISTEN QUERIES [ALL/DEFAULT/CUSTOM]` query, for example `SYSTEM STOP LISTEN QUERIES ALL EXCEPT TCP, HTTP`. [#53280](https://github.com/ClickHouse/ClickHouse/pull/53280) ([Nikolay Degterinsky](https://github.com/evillique)).
- Change the default of `max_concurrent_queries` from 100 to 1000. It's ok to have many concurrent queries if they are not heavy, and mostly waiting for the network. Note: don't confuse concurrent queries and QPS: for example, ClickHouse server can do tens of thousands of QPS with less than 100 concurrent queries. [#53285](https://github.com/ClickHouse/ClickHouse/pull/53285) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Limit number of concurrent background partition optimize merges. [#53405](https://github.com/ClickHouse/ClickHouse/pull/53405) ([Duc Canh Le](https://github.com/canhld94)).
- Added a setting `allow_moving_table_directory_to_trash` that allows to ignore `Directory for table data already exists` error when replicating/recovering a `Replicated` database. [#53425](https://github.com/ClickHouse/ClickHouse/pull/53425) ([Alexander Tokmakov](https://github.com/tavplubix)).
- If server settings `asynchronous_metrics_update_period_s` and `asynchronous_heavy_metrics_update_period_s` are misconfigured to 0, it will now fail gracefully instead of terminating the application. [#53428](https://github.com/ClickHouse/ClickHouse/pull/53428) ([Robert Schulze](https://github.com/rschu1ze)).
- The ClickHouse server now respects memory limits changed via cgroups when reloading its configuration. [#53455](https://github.com/ClickHouse/ClickHouse/pull/53455) ([Robert Schulze](https://github.com/rschu1ze)).
- Add ability to turn off flush of Distributed tables on `DETACH`, `DROP`, or server shutdown. [#53501](https://github.com/ClickHouse/ClickHouse/pull/53501) ([Azat Khuzhin](https://github.com/azat)).
- The `domainRFC` function now supports IPv6 in square brackets. [#53506](https://github.com/ClickHouse/ClickHouse/pull/53506) ([Chen768959](https://github.com/Chen768959)).
- Use longer timeout for S3 CopyObject requests, which are used in backups. [#53533](https://github.com/ClickHouse/ClickHouse/pull/53533) ([Michael Kolupaev](https://github.com/al13n321)).
- Added server setting `aggregate_function_group_array_max_element_size`. This setting is used to limit array size for `groupArray` function at serialization. The default value is `16777215`. [#53550](https://github.com/ClickHouse/ClickHouse/pull/53550) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- `SCHEMA` was added as alias for `DATABASE` to improve MySQL compatibility. [#53587](https://github.com/ClickHouse/ClickHouse/pull/53587) ([Daniël van Eeden](https://github.com/dveeden)).
- Add asynchronous metrics about tables in the system database. For example, `TotalBytesOfMergeTreeTablesSystem`. This closes [#53603](https://github.com/ClickHouse/ClickHouse/issues/53603). [#53604](https://github.com/ClickHouse/ClickHouse/pull/53604) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- SQL editor in the Play UI and Dashboard will not use Grammarly. [#53614](https://github.com/ClickHouse/ClickHouse/pull/53614) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- As expert-level settings, it is now possible to (1) configure the size_ratio (i.e. the relative size of the protected queue) of the [index] mark/uncompressed caches, (2) configure the cache policy of the index mark and index uncompressed caches. [#53657](https://github.com/ClickHouse/ClickHouse/pull/53657) ([Robert Schulze](https://github.com/rschu1ze)).
- Added client info validation to the query packet in TCPHandler. [#53673](https://github.com/ClickHouse/ClickHouse/pull/53673) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
- Retry loading parts in case of network errors while interaction with Microsoft Azure. [#53750](https://github.com/ClickHouse/ClickHouse/pull/53750) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Stacktrace for exceptions, Materailized view exceptions are propagated. [#53766](https://github.com/ClickHouse/ClickHouse/pull/53766) ([Ilya Golshtein](https://github.com/ilejn)).
- If no hostname or port were specified, keeper client will try to search for a connection string in the ClickHouse's config.xml. [#53769](https://github.com/ClickHouse/ClickHouse/pull/53769) ([pufit](https://github.com/pufit)).
- Add profile event `PartsLockMicroseconds` which shows the amount of microseconds we hold the data parts lock in MergeTree table engine family. [#53797](https://github.com/ClickHouse/ClickHouse/pull/53797) ([alesapin](https://github.com/alesapin)).
- Make reconnect limit in RAFT limits configurable for keeper. This configuration can help to make keeper to rebuild connection with peers quicker if the current connection is broken. [#53817](https://github.com/ClickHouse/ClickHouse/pull/53817) ([Pengyuan Bian](https://github.com/bianpengyuan)).
- Ignore foreign keys in tables definition to improve compatibility with MySQL, so a user wouldn't need to rewrite his SQL of the foreign key part, ref [#53380](https://github.com/ClickHouse/ClickHouse/issues/53380). [#53864](https://github.com/ClickHouse/ClickHouse/pull/53864) ([jsc0218](https://github.com/jsc0218)).





#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-4}

- 不再向动态链接器暴露 ClickHouse 二进制文件的符号。这可能修复 [#43933](https://github.com/ClickHouse/ClickHouse/issues/43933)。[#47475](https://github.com/ClickHouse/ClickHouse/pull/47475) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 在 clickhouse-server 包中添加 `clickhouse-keeper-client` 符号链接。[#51882](https://github.com/ClickHouse/ClickHouse/pull/51882) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- 将 https://github.com/elliotchance/sqltest 添加到 CI 以报告 SQL 2016 合规性。[#52293](https://github.com/ClickHouse/ClickHouse/pull/52293) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 将 PRQL 升级到 0.9.3。[#53060](https://github.com/ClickHouse/ClickHouse/pull/53060) ([Maximilian Roos](https://github.com/max-sixty))。
- 将 CI 检查的系统表导出到 ClickHouse Cloud。[#53086](https://github.com/ClickHouse/ClickHouse/pull/53086) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 将编译器的性能分析数据(`-ftime-trace`)上传到 ClickHouse Cloud。[#53100](https://github.com/ClickHouse/ClickHouse/pull/53100) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 加速 Debug 和 Tidy 构建。[#53178](https://github.com/ClickHouse/ClickHouse/pull/53178) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 通过移除大量冗余代码来加速构建。其中一个频繁包含的头文件被 boost 污染。[#53180](https://github.com/ClickHouse/ClickHouse/pull/53180) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 移除更多冗余代码。[#53182](https://github.com/ClickHouse/ClickHouse/pull/53182) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 函数 `arrayAUC` 使用了大量 C++ 模板 - 已将其移除。[#53183](https://github.com/ClickHouse/ClickHouse/pull/53183) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 某些编译单元无论 ccache 如何都会被重新构建。已找到并修复了问题根源。[#53184](https://github.com/ClickHouse/ClickHouse/pull/53184) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 将编译器的性能分析数据(`-ftime-trace`)上传到 ClickHouse Cloud,这是继 [#53100](https://github.com/ClickHouse/ClickHouse/issues/53100) 之后的第二次尝试。[#53213](https://github.com/ClickHouse/ClickHouse/pull/53213) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 将有状态测试中的 CI 日志导出到 ClickHouse Cloud。[#53351](https://github.com/ClickHouse/ClickHouse/pull/53351) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 将压力测试中的 CI 日志导出。[#53353](https://github.com/ClickHouse/ClickHouse/pull/53353) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 将模糊测试中的 CI 日志导出。[#53354](https://github.com/ClickHouse/ClickHouse/pull/53354) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 在 `clickhouse start` 命令中保留环境参数。修复 [#51962](https://github.com/ClickHouse/ClickHouse/issues/51962)。[#53418](https://github.com/ClickHouse/ClickHouse/pull/53418) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- 后续跟进 [#53418](https://github.com/ClickHouse/ClickHouse/issues/53418)。对 install_check.py 进行小幅改进,添加测试以确保在 `init.d start` 时正确传递环境参数到主进程。[#53457](https://github.com/ClickHouse/ClickHouse/pull/53457) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- 重新组织 CMake 中的文件管理以防止潜在的重复。例如,`indexHint.cpp` 在 `dbms_sources` 和 `clickhouse_functions_sources` 中都有重复。[#53621](https://github.com/ClickHouse/ClickHouse/pull/53621) ([Amos Bird](https://github.com/amosbird))。
- 将 snappy 升级到 1.1.10。[#53672](https://github.com/ClickHouse/ClickHouse/pull/53672) ([李扬](https://github.com/taiyang-li))。
- 通过清理某些依赖项和移除重复项来略微改进 cmake 构建。每个提交都包含所做更改的简短描述。[#53759](https://github.com/ClickHouse/ClickHouse/pull/53759) ([Amos Bird](https://github.com/amosbird))。





#### 错误修复(官方稳定版本中用户可见的异常行为) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-4}

- Do not reset (experimental) Annoy index during build-up with more than one mark [#51325](https://github.com/ClickHouse/ClickHouse/pull/51325) ([Tian Xinhui](https://github.com/xinhuitian)).
- Fix usage of temporary directories during RESTORE [#51493](https://github.com/ClickHouse/ClickHouse/pull/51493) ([Azat Khuzhin](https://github.com/azat)).
- Fix binary arithmetic for Nullable(IPv4) [#51642](https://github.com/ClickHouse/ClickHouse/pull/51642) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Support IPv4 and IPv6 data types as dictionary attributes [#51756](https://github.com/ClickHouse/ClickHouse/pull/51756) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- A fix for checksum of compress marks [#51777](https://github.com/ClickHouse/ClickHouse/pull/51777) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Fix mistakenly comma parsing as part of datetime in CSV best effort parsing [#51950](https://github.com/ClickHouse/ClickHouse/pull/51950) ([Kruglov Pavel](https://github.com/Avogar)).
- Don't throw exception when executable UDF has parameters [#51961](https://github.com/ClickHouse/ClickHouse/pull/51961) ([Nikita Taranov](https://github.com/nickitat)).
- Fix recalculation of skip indexes and projections in `ALTER DELETE` queries [#52530](https://github.com/ClickHouse/ClickHouse/pull/52530) ([Anton Popov](https://github.com/CurtizJ)).
- MaterializedMySQL: Fix the infinite loop in ReadBuffer::read [#52621](https://github.com/ClickHouse/ClickHouse/pull/52621) ([Val Doroshchuk](https://github.com/valbok)).
- Load suggestion only with `clickhouse` dialect [#52628](https://github.com/ClickHouse/ClickHouse/pull/52628) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Init and destroy ares channel on demand. [#52634](https://github.com/ClickHouse/ClickHouse/pull/52634) ([Arthur Passos](https://github.com/arthurpassos)).
- Fix filtering by virtual columns with OR expression [#52653](https://github.com/ClickHouse/ClickHouse/pull/52653) ([Azat Khuzhin](https://github.com/azat)).
- Fix crash in function `tuple` with one sparse column argument [#52659](https://github.com/ClickHouse/ClickHouse/pull/52659) ([Anton Popov](https://github.com/CurtizJ)).
- Fix named collections on cluster [#52687](https://github.com/ClickHouse/ClickHouse/pull/52687) ([Al Korgun](https://github.com/alkorgun)).
- Fix reading of unnecessary column in case of multistage `PREWHERE` [#52689](https://github.com/ClickHouse/ClickHouse/pull/52689) ([Anton Popov](https://github.com/CurtizJ)).
- Fix unexpected sort result on multi columns with nulls first direction [#52761](https://github.com/ClickHouse/ClickHouse/pull/52761) ([copperybean](https://github.com/copperybean)).
- Fix data race in Keeper reconfiguration [#52804](https://github.com/ClickHouse/ClickHouse/pull/52804) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix sorting of sparse columns with large limit [#52827](https://github.com/ClickHouse/ClickHouse/pull/52827) ([Anton Popov](https://github.com/CurtizJ)).
- clickhouse-keeper: fix implementation of server with poll. [#52833](https://github.com/ClickHouse/ClickHouse/pull/52833) ([Andy Fiddaman](https://github.com/citrus-it)).
- Make regexp analyzer recognize named capturing groups [#52840](https://github.com/ClickHouse/ClickHouse/pull/52840) ([Han Fei](https://github.com/hanfei1991)).
- Fix possible assert in `~PushingAsyncPipelineExecutor` in clickhouse-local [#52862](https://github.com/ClickHouse/ClickHouse/pull/52862) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix reading of empty `Nested(Array(LowCardinality(...)))` [#52949](https://github.com/ClickHouse/ClickHouse/pull/52949) ([Anton Popov](https://github.com/CurtizJ)).
- Added new tests for session_log and fixed the inconsistency between login and logout. [#52958](https://github.com/ClickHouse/ClickHouse/pull/52958) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
- Fix password leak in show create mysql table [#52962](https://github.com/ClickHouse/ClickHouse/pull/52962) ([Duc Canh Le](https://github.com/canhld94)).
- Convert sparse column format to full in CreateSetAndFilterOnTheFlyStep [#53000](https://github.com/ClickHouse/ClickHouse/pull/53000) ([vdimir](https://github.com/vdimir)).
- Fix rare race condition with empty key prefix directory deletion in fs cache [#53055](https://github.com/ClickHouse/ClickHouse/pull/53055) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix ZstdDeflatingWriteBuffer truncating the output sometimes [#53064](https://github.com/ClickHouse/ClickHouse/pull/53064) ([Michael Kolupaev](https://github.com/al13n321)).
- Fix query_id in part_log with async flush queries [#53103](https://github.com/ClickHouse/ClickHouse/pull/53103) ([Raúl Marín](https://github.com/Algunenano)).
- Fix possible error from cache "Read unexpected size" [#53121](https://github.com/ClickHouse/ClickHouse/pull/53121) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Disable the new parquet encoder [#53130](https://github.com/ClickHouse/ClickHouse/pull/53130) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix "Not-ready Set" exception [#53162](https://github.com/ClickHouse/ClickHouse/pull/53162) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix character escaping in the PostgreSQL engine [#53250](https://github.com/ClickHouse/ClickHouse/pull/53250) ([Nikolay Degterinsky](https://github.com/evillique)).
- Experimental session_log table: Added new tests for session_log and fixed the inconsistency between login and logout. [#53255](https://github.com/ClickHouse/ClickHouse/pull/53255) ([Alexey Gerasimchuck](https://github.com/Demilivor)). Fixed inconsistency between login success and logout [#53302](https://github.com/ClickHouse/ClickHouse/pull/53302) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
- Fix adding sub-second intervals to DateTime [#53309](https://github.com/ClickHouse/ClickHouse/pull/53309) ([Michael Kolupaev](https://github.com/al13n321)).
- Fix "Context has expired" error in dictionaries [#53342](https://github.com/ClickHouse/ClickHouse/pull/53342) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix incorrect normal projection AST format [#53347](https://github.com/ClickHouse/ClickHouse/pull/53347) ([Amos Bird](https://github.com/amosbird)).
- Forbid use_structure_from_insertion_table_in_table_functions when execute Scalar [#53348](https://github.com/ClickHouse/ClickHouse/pull/53348) ([flynn](https://github.com/ucasfl)).
- Fix loading lazy database during system.table select query [#53372](https://github.com/ClickHouse/ClickHouse/pull/53372) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Fixed system.data_skipping_indices for MaterializedMySQL [#53381](https://github.com/ClickHouse/ClickHouse/pull/53381) ([Filipp Ozinov](https://github.com/bakwc)).
- Fix processing single carriage return in TSV file segmentation engine [#53407](https://github.com/ClickHouse/ClickHouse/pull/53407) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix `Context has expired` error properly [#53433](https://github.com/ClickHouse/ClickHouse/pull/53433) ([Michael Kolupaev](https://github.com/al13n321)).
- Fix `timeout_overflow_mode` when having subquery in the rhs of IN [#53439](https://github.com/ClickHouse/ClickHouse/pull/53439) ([Duc Canh Le](https://github.com/canhld94)).
- Fix an unexpected behavior in [#53152](https://github.com/ClickHouse/ClickHouse/issues/53152) [#53440](https://github.com/ClickHouse/ClickHouse/pull/53440) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
- Fix JSON_QUERY Function parse error while path is all number [#53470](https://github.com/ClickHouse/ClickHouse/pull/53470) ([KevinyhZou](https://github.com/KevinyhZou)).
- Fix wrong columns order for queries with parallel FINAL. [#53489](https://github.com/ClickHouse/ClickHouse/pull/53489) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fixed SELECTing from ReplacingMergeTree with do_not_merge_across_partitions_select_final [#53511](https://github.com/ClickHouse/ClickHouse/pull/53511) ([Vasily Nemkov](https://github.com/Enmk)).
- Flush async insert queue first on shutdown [#53547](https://github.com/ClickHouse/ClickHouse/pull/53547) ([joelynch](https://github.com/joelynch)).
- Fix crash in join on sparse columna [#53548](https://github.com/ClickHouse/ClickHouse/pull/53548) ([vdimir](https://github.com/vdimir)).
- Fix possible UB in Set skipping index for functions with incorrect args [#53559](https://github.com/ClickHouse/ClickHouse/pull/53559) ([Azat Khuzhin](https://github.com/azat)).
- Fix possible UB in inverted indexes (experimental feature) [#53560](https://github.com/ClickHouse/ClickHouse/pull/53560) ([Azat Khuzhin](https://github.com/azat)).
- Fix: interpolate expression takes source column instead of same name aliased from select expression. [#53572](https://github.com/ClickHouse/ClickHouse/pull/53572) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix number of dropped granules in EXPLAIN PLAN index=1 [#53616](https://github.com/ClickHouse/ClickHouse/pull/53616) ([wangxiaobo](https://github.com/wzb5212)).
- Correctly handle totals and extremes with `DelayedSource` [#53644](https://github.com/ClickHouse/ClickHouse/pull/53644) ([Antonio Andelic](https://github.com/antonio2368)).
- Prepared set cache in mutation pipeline stuck [#53645](https://github.com/ClickHouse/ClickHouse/pull/53645) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix bug on mutations with subcolumns of type JSON in predicates of UPDATE and DELETE queries. [#53677](https://github.com/ClickHouse/ClickHouse/pull/53677) ([VanDarkholme7](https://github.com/VanDarkholme7)).
- Fix filter pushdown for full_sorting_merge join [#53699](https://github.com/ClickHouse/ClickHouse/pull/53699) ([vdimir](https://github.com/vdimir)).
- Try to fix bug with `NULL::LowCardinality(Nullable(...)) NOT IN` [#53706](https://github.com/ClickHouse/ClickHouse/pull/53706) ([Andrey Zvonov](https://github.com/zvonand)).
- Fix: sorted distinct with sparse columns [#53711](https://github.com/ClickHouse/ClickHouse/pull/53711) ([Igor Nikonov](https://github.com/devcrafter)).
- `transform`: correctly handle default column with multiple rows [#53742](https://github.com/ClickHouse/ClickHouse/pull/53742) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
- Fix fuzzer crash in parseDateTime [#53764](https://github.com/ClickHouse/ClickHouse/pull/53764) ([Robert Schulze](https://github.com/rschu1ze)).
- MaterializedPostgreSQL: fix uncaught exception in getCreateTableQueryImpl [#53832](https://github.com/ClickHouse/ClickHouse/pull/53832) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix possible segfault while using PostgreSQL engine [#53847](https://github.com/ClickHouse/ClickHouse/pull/53847) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix named_collection_admin alias [#54066](https://github.com/ClickHouse/ClickHouse/pull/54066) ([Kseniia Sumarokova](https://github.com/kssenii)).

### <a id="237"></a> ClickHouse 版本 23.7, 2023-07-27 {#237}

#### 向后不兼容变更 {#backward-incompatible-change-5}

- 新增 `NAMED COLLECTION` 访问类型(别名为 `USE NAMED COLLECTION`、`NAMED COLLECTION USAGE`)。此 PR 向后不兼容,因为该访问类型默认禁用(其父访问类型 `NAMED COLLECTION ADMIN` 默认也被禁用)。在 [#50277](https://github.com/ClickHouse/ClickHouse/issues/50277) 中提出。要授予权限,使用 `GRANT NAMED COLLECTION ON collection_name TO user` 或 `GRANT NAMED COLLECTION ON * TO user`,为了能够授予这些权限,配置中需要 `named_collection_admin`(之前名为 `named_collection_control`,将保留作为别名)。[#50625](https://github.com/ClickHouse/ClickHouse/pull/50625) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 修复 `system.parts` 列名 `last_removal_attemp_time` 中的拼写错误。现已更正为 `last_removal_attempt_time`。[#52104](https://github.com/ClickHouse/ClickHouse/pull/52104) ([filimonov](https://github.com/filimonov))。
- 将 distributed_ddl_entry_format_version 的默认版本提升至 5(启用 opentelemetry 和 initial_query_idd 传递)。这将导致在_降级_后无法处理分布式 DDL 的现有条目(但请注意,通常不应存在此类未处理的条目)。[#52128](https://github.com/ClickHouse/ClickHouse/pull/52128) ([Azat Khuzhin](https://github.com/azat))。
- 以检查普通元数据的相同方式检查投影元数据。如果存在具有无效投影的表,此变更可能会阻止服务器启动。例如,在主键中创建位置列的投影(如 `projection p (select * order by 1, 4)`,这在表主键中是不允许的,可能在插入/合并期间导致崩溃)。在更新之前请删除此类投影。修复 [#52353](https://github.com/ClickHouse/ClickHouse/issues/52353)。[#52361](https://github.com/ClickHouse/ClickHouse/pull/52361) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 由于存在缺陷,实验性功能 `hashid` 已被移除。该实现的质量从一开始就存在问题,且未能通过实验阶段。这关闭了 [#52406](https://github.com/ClickHouse/ClickHouse/issues/52406)。[#52449](https://github.com/ClickHouse/ClickHouse/pull/52449) ([Alexey Milovidov](https://github.com/alexey-milovidov))。


#### 新功能 {#new-feature-5}

- 新增 `Overlay` 数据库引擎,用于将多个数据库合并为一个。新增 `Filesystem` 数据库引擎,将文件系统中的目录表示为一组自动检测格式和结构的隐式可用表。新增 `S3` 数据库引擎,通过将前缀表示为一组表来以只读方式与 S3 存储交互。新增 `HDFS` 数据库引擎,以相同方式与 HDFS 存储交互。[#48821](https://github.com/ClickHouse/ClickHouse/pull/48821) ([alekseygolub](https://github.com/alekseygolub))。
- 在 Keeper 中添加对外部磁盘的支持,用于存储快照和日志。[#50098](https://github.com/ClickHouse/ClickHouse/pull/50098) ([Antonio Andelic](https://github.com/antonio2368))。
- 添加对多目录选择 (`{}`) 通配符的支持。[#50559](https://github.com/ClickHouse/ClickHouse/pull/50559) ([Andrey Zvonov](https://github.com/zvonand))。
- Kafka 连接器可以使用 URL 编码的凭据通过基本身份验证从 Schema Registry 获取 Avro Schema。[#49664](https://github.com/ClickHouse/ClickHouse/pull/49664) ([Ilya Golshtein](https://github.com/ilejn))。
- 添加函数 `arrayJaccardIndex`,用于计算两个数组之间的 Jaccard 相似度。[#50076](https://github.com/ClickHouse/ClickHouse/pull/50076) ([FFFFFFFHHHHHHH](https://github.com/FFFFFFFHHHHHHH))。
- 在 `system.settings` 和类似表中添加 `is_obsolete` 列。关闭 [#50819](https://github.com/ClickHouse/ClickHouse/issues/50819)。[#50826](https://github.com/ClickHouse/ClickHouse/pull/50826) ([flynn](https://github.com/ucasfl))。
- 实现配置文件中加密元素的支持。添加在配置文件叶子元素中使用加密文本的功能。文本使用 `<encryption_codecs>` 部分的加密编解码器进行加密。[#50986](https://github.com/ClickHouse/ClickHouse/pull/50986) ([Roman Vasin](https://github.com/rvasin))。
- Grace Hash Join 算法现在适用于 FULL 和 RIGHT JOIN。[#49483](https://github.com/ClickHouse/ClickHouse/issues/49483)。[#51013](https://github.com/ClickHouse/ClickHouse/pull/51013) ([lgbo](https://github.com/lgbo-ustc))。
- 添加 `SYSTEM STOP LISTEN` 查询以实现更优雅的终止。关闭 [#47972](https://github.com/ClickHouse/ClickHouse/issues/47972)。[#51016](https://github.com/ClickHouse/ClickHouse/pull/51016) ([Nikolay Degterinsky](https://github.com/evillique))。
- 添加 `input_format_csv_allow_variable_number_of_columns` 选项。[#51273](https://github.com/ClickHouse/ClickHouse/pull/51273) ([Dmitry Kardymon](https://github.com/kardymonds))。
- 另一个无聊的功能:添加函数 `substring_index`,与 Spark 或 MySQL 中的相同。[#51472](https://github.com/ClickHouse/ClickHouse/pull/51472) ([李扬](https://github.com/taiyang-li))。
- 系统表 `jemalloc_bins` 用于显示 jemalloc bins 的统计信息。示例 `SELECT *, size * (nmalloc - ndalloc) AS allocated_bytes FROM system.jemalloc_bins WHERE allocated_bytes > 0 ORDER BY allocated_bytes DESC LIMIT 10`。尽情使用。[#51674](https://github.com/ClickHouse/ClickHouse/pull/51674) ([Alexander Gololobov](https://github.com/davenger))。
- 添加 `RowBinaryWithDefaults` 格式,在每列之前添加额外字节作为使用列默认值的标志。关闭 [#50854](https://github.com/ClickHouse/ClickHouse/issues/50854)。[#51695](https://github.com/ClickHouse/ClickHouse/pull/51695) ([Kruglov Pavel](https://github.com/Avogar))。
- 添加 `default_temporary_table_engine` 设置。与 `default_table_engine` 相同,但用于临时表。[#51292](https://github.com/ClickHouse/ClickHouse/issues/51292)。[#51708](https://github.com/ClickHouse/ClickHouse/pull/51708) ([velavokr](https://github.com/velavokr))。
- 添加新的 `initcap` / `initcapUTF8` 函数,将每个单词的首字母转换为大写,其余字母转换为小写。[#51735](https://github.com/ClickHouse/ClickHouse/pull/51735) ([Dmitry Kardymon](https://github.com/kardymonds))。
- 创建表现在支持在列定义中使用 `PRIMARY KEY` 语法。列按定义顺序添加到主索引中。[#51881](https://github.com/ClickHouse/ClickHouse/pull/51881) ([Ilya Yatsishin](https://github.com/qoega))。
- 添加在日志和错误日志文件名中使用日期和时间格式说明符的功能,可在配置文件(`log` 和 `errorlog` 标签)或命令行参数(`--log-file` 和 `--errorlog-file`)中使用。[#51945](https://github.com/ClickHouse/ClickHouse/pull/51945) ([Victor Krasnov](https://github.com/sirvickr))。
- 在 HTTP 头中添加峰值内存使用统计信息。[#51946](https://github.com/ClickHouse/ClickHouse/pull/51946) ([Dmitry Kardymon](https://github.com/kardymonds))。
- 添加新的 `hasSubsequence`(包括 `CaseInsensitive` 和 `UTF8` 版本)函数,用于匹配字符串中的子序列。[#52050](https://github.com/ClickHouse/ClickHouse/pull/52050) ([Dmitry Kardymon](https://github.com/kardymonds))。
- 添加 `array_agg` 作为 `groupArray` 的别名以实现 PostgreSQL 兼容性。关闭 [#52100](https://github.com/ClickHouse/ClickHouse/issues/52100)。### 面向用户的更改文档条目。[#52135](https://github.com/ClickHouse/ClickHouse/pull/52135) ([flynn](https://github.com/ucasfl))。
- 添加 `any_value` 作为 `any` 聚合函数的兼容性别名。关闭 [#52140](https://github.com/ClickHouse/ClickHouse/issues/52140)。[#52147](https://github.com/ClickHouse/ClickHouse/pull/52147) ([flynn](https://github.com/ucasfl))。
- 添加聚合函数 `array_concat_agg` 以实现与 BigQuery 的兼容性,它是 `groupArrayArray` 的别名。关闭 [#52139](https://github.com/ClickHouse/ClickHouse/issues/52139)。[#52149](https://github.com/ClickHouse/ClickHouse/pull/52149) ([flynn](https://github.com/ucasfl))。
- 添加 `OCTET_LENGTH` 作为 `length` 的别名。关闭 [#52153](https://github.com/ClickHouse/ClickHouse/issues/52153)。[#52176](https://github.com/ClickHouse/ClickHouse/pull/52176) ([FFFFFFFHHHHHHH](https://github.com/FFFFFFFHHHHHHH))。
- 添加 `firstLine` 函数,用于从多行字符串中提取第一行。这关闭了 [#51172](https://github.com/ClickHouse/ClickHouse/issues/51172)。[#52209](https://github.com/ClickHouse/ClickHouse/pull/52209) ([Mikhail Koviazin](https://github.com/mkmkme))。
- 为 `Interval` 数据类型实现 KQL 风格的格式化。这仅用于与 `Kusto` 查询语言的兼容性。[#45671](https://github.com/ClickHouse/ClickHouse/pull/45671) ([ltrk2](https://github.com/ltrk2))。
- 添加查询 `SYSTEM FLUSH ASYNC INSERT QUEUE`,将所有待处理的异步插入刷新到目标表。添加服务器端设置 `async_insert_queue_flush_on_shutdown`(默认为 `true`),用于确定在优雅关闭时是否刷新异步插入队列。设置 `async_insert_threads` 现在是服务器端设置。[#49160](https://github.com/ClickHouse/ClickHouse/pull/49160) ([Anton Popov](https://github.com/CurtizJ))。
- 别名 `current_database` 和新函数 `current_schemas` 以实现与 PostgreSQL 的兼容性。[#51076](https://github.com/ClickHouse/ClickHouse/pull/51076) ([Pedro Riera](https://github.com/priera))。
- 为函数 `today`(现在可以使用 `curdate`/`current_date` 名称)和 `now`(`current_timestamp`)添加别名。[#52106](https://github.com/ClickHouse/ClickHouse/pull/52106) ([Lloyd-Pottiger](https://github.com/Lloyd-Pottiger))。
- 支持异步插入的 `async_deduplication_token`。[#52136](https://github.com/ClickHouse/ClickHouse/pull/52136) ([Han Fei](https://github.com/hanfei1991))。
- 添加新设置 `disable_url_encoding`,允许在 URL 引擎中禁用 URI 路径的解码/编码。[#52337](https://github.com/ClickHouse/ClickHouse/pull/52337) ([Kruglov Pavel](https://github.com/Avogar))。





#### 性能改进 {#performance-improvement-5}

- 默认启用稀疏序列化格式的自动选择。这可以提升性能。该格式自 22.1 版本起支持。此更改后,可能无法降级到 22.1 之前的版本。降级可能需要设置 `ratio_of_defaults_for_sparse_serialization=0.9375` [55153](https://github.com/ClickHouse/ClickHouse/issues/55153)。您可以通过为 MergeTree 表设置 `ratio_of_defaults_for_sparse_serialization = 1` 来关闭稀疏序列化格式的使用。[#49631](https://github.com/ClickHouse/ClickHouse/pull/49631) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 默认启用 `move_all_conditions_to_prewhere` 和 `enable_multiple_prewhere_read_steps` 设置。[#46365](https://github.com/ClickHouse/ClickHouse/pull/46365) ([Alexander Gololobov](https://github.com/davenger))。
- 通过调优分配器提升某些查询的性能。[#46416](https://github.com/ClickHouse/ClickHouse/pull/46416) ([Azat Khuzhin](https://github.com/azat))。
- 现在我们在 `MergeTreePrefetchedReadPool` 中使用固定大小的任务,与 `MergeTreeReadPool` 中一样。此外,从现在开始我们对 S3 请求使用连接池。[#49732](https://github.com/ClickHouse/ClickHouse/pull/49732) ([Nikita Taranov](https://github.com/nickitat))。
- 更多谓词下推到连接的右侧。[#50532](https://github.com/ClickHouse/ClickHouse/pull/50532) ([Nikita Taranov](https://github.com/nickitat))。
- 通过预留哈希表大小改进 grace_hash 连接(重新提交)。[#50875](https://github.com/ClickHouse/ClickHouse/pull/50875) ([lgbo](https://github.com/lgbo-ustc))。
- 在 `OpenedFileCache` 中等待锁有时可能很明显。我们将其分片为多个子映射(每个都有自己的锁)以避免竞争。[#51341](https://github.com/ClickHouse/ClickHouse/pull/51341) ([Nikita Taranov](https://github.com/nickitat))。
- 将包含主键列的条件移至 PREWHERE 链的末尾。其思路是包含主键列的条件可能会用于主键分析,不会对 PREWHERE 过滤贡献太多。[#51958](https://github.com/ClickHouse/ClickHouse/pull/51958) ([Alexander Gololobov](https://github.com/davenger))。
- 通过内联 SipHash 加速字符串类型的 `COUNT(DISTINCT)`。在 ICX 设备(Intel Xeon Platinum 8380 CPU,80 核,160 线程)上对 _OnTime_ 的性能实验表明,此更改可以将查询 _Q8_ 的 QPS 提升 _11.6%_,同时对其他查询没有影响。[#52036](https://github.com/ClickHouse/ClickHouse/pull/52036) ([Zhiguo Zhou](https://github.com/ZhiguoZh))。
- 默认启用 `allow_vertical_merges_from_compact_to_wide_parts`。这将在合并期间节省内存使用。[#52295](https://github.com/ClickHouse/ClickHouse/pull/52295) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 修复使主键失效的不正确投影分析。此问题仅在 `query_plan_optimize_primary_key = 1, query_plan_optimize_projection = 1` 时存在。这修复了 [#48823](https://github.com/ClickHouse/ClickHouse/issues/48823)。这修复了 [#51173](https://github.com/ClickHouse/ClickHouse/issues/51173)。[#52308](https://github.com/ClickHouse/ClickHouse/pull/52308) ([Amos Bird](https://github.com/amosbird))。
- 减少 `FileCache::loadMetadata` 中的系统调用次数 - 如果配置了文件系统缓存,这会加快服务器启动速度。[#52435](https://github.com/ClickHouse/ClickHouse/pull/52435) ([Raúl Marín](https://github.com/Algunenano))。
- 通过在后台下载剩余数据,允许为文件段大小设置严格的下限。文件段的最小大小(如果实际文件大小更大)配置为缓存配置设置 `boundary_alignment`,默认为 `4Mi`。后台线程数配置为缓存配置设置 `background_download_threads`,默认为 `2`。此外,在此 PR 中 `max_file_segment_size` 从 `8Mi` 增加到 `32Mi`。[#51000](https://github.com/ClickHouse/ClickHouse/pull/51000) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 将 S3 的默认超时时间从 30 秒减少到 3 秒,将其他 HTTP 的默认超时时间从 180 秒减少到 30 秒。[#51171](https://github.com/ClickHouse/ClickHouse/pull/51171) ([Michael Kolupaev](https://github.com/al13n321))。
- 添加了新设置 `merge_tree_determine_task_size_by_prewhere_columns`。如果设置为 `true`,则仅考虑 `PREWHERE` 部分中列的大小来确定读取任务大小。否则,将考虑查询中的所有列。[#52606](https://github.com/ClickHouse/ClickHouse/pull/52606) ([Nikita Taranov](https://github.com/nickitat))。





#### 改进 {#improvement-5}

- 在 s3/file/url/... 表函数中使用 read_bytes/total_bytes_to_read 显示进度条,以提供更准确的进度指示。[#51286](https://github.com/ClickHouse/ClickHouse/pull/51286) ([Kruglov Pavel](https://github.com/Avogar))。
- 引入表设置 `wait_for_unique_parts_send_before_shutdown_ms`,用于指定副本在关闭用于复制发送的服务器间处理程序之前的等待时间。同时修复了表和服务器间处理程序关闭顺序的不一致问题:现在服务器先关闭表,然后才关闭服务器间处理程序。[#51851](https://github.com/ClickHouse/ClickHouse/pull/51851) ([alesapin](https://github.com/alesapin))。
- 允许使用不带 `OFFSET` 的 SQL 标准 `FETCH`。参见 https://antonz.org/sql-fetch/。[#51293](https://github.com/ClickHouse/ClickHouse/pull/51293) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 允许通过配置中的新 `http_forbid_headers` 部分为 URL/S3 表函数过滤 HTTP 头。支持精确匹配和正则表达式过滤。[#51038](https://github.com/ClickHouse/ClickHouse/pull/51038) ([Nikolay Degterinsky](https://github.com/evillique))。
- 不再在日志中显示关于 `16 EiB` 可用空间的消息,因为这些信息没有意义。此更改解决了 [#49320](https://github.com/ClickHouse/ClickHouse/issues/49320)。[#49342](https://github.com/ClickHouse/ClickHouse/pull/49342) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 正确检查 `sleepEachRow` 函数的限制。添加设置 `function_sleep_max_microseconds_per_block`。这对于通用查询模糊测试是必需的。[#49343](https://github.com/ClickHouse/ClickHouse/pull/49343) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 修复 `geoHash` 函数中的两个问题。[#50066](https://github.com/ClickHouse/ClickHouse/pull/50066) ([李扬](https://github.com/taiyang-li))。
- 将异步插入刷新查询记录到 `system.query_log` 中。[#51160](https://github.com/ClickHouse/ClickHouse/pull/51160) ([Raúl Marín](https://github.com/Algunenano))。
- 函数 `date_diff` 和 `age` 现在支持毫秒/微秒单位,并以微秒精度工作。[#51291](https://github.com/ClickHouse/ClickHouse/pull/51291) ([Dmitry Kardymon](https://github.com/kardymonds))。
- 改进 clickhouse-keeper-client 中的路径解析。[#51359](https://github.com/ClickHouse/ClickHouse/pull/51359) ([Azat Khuzhin](https://github.com/azat))。
- 依赖 ClickHouse 的第三方产品(Gluten:一个使 Spark SQL 性能翻倍的插件)存在一个 bug。此修复避免了该第三方产品在从 HDFS 读取时发生堆溢出。[#51386](https://github.com/ClickHouse/ClickHouse/pull/51386) ([李扬](https://github.com/taiyang-li))。
- 添加禁用 S3 原生复制的功能(BACKUP/RESTORE 的设置 `allow_s3_native_copy`,以及 `s3`/`s3_plain` 磁盘的 `s3_allow_native_copy`)。[#51448](https://github.com/ClickHouse/ClickHouse/pull/51448) ([Azat Khuzhin](https://github.com/azat))。
- 向 `system.parts` 表添加列 `primary_key_size`,以显示磁盘上压缩后的主键大小。解决了 [#51400](https://github.com/ClickHouse/ClickHouse/issues/51400)。[#51496](https://github.com/ClickHouse/ClickHouse/pull/51496) ([Yarik Briukhovetskyi](https://github.com/yariks5s))。
- 允许在没有 procfs、没有主目录以及没有 glibc 名称解析插件的情况下运行 `clickhouse-local`。[#51518](https://github.com/ClickHouse/ClickHouse/pull/51518) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 在 rename_files_after_processing 设置中为完整文件名添加占位符 `%a`。[#51603](https://github.com/ClickHouse/ClickHouse/pull/51603) ([Kruglov Pavel](https://github.com/Avogar))。
- 向 `system.parts_columns` 添加列 `modification_time`。[#51685](https://github.com/ClickHouse/ClickHouse/pull/51685) ([Azat Khuzhin](https://github.com/azat))。
- 为 CSV 格式添加新设置 `input_format_csv_use_default_on_bad_values`,允许在单个字段解析失败时插入默认值。[#51716](https://github.com/ClickHouse/ClickHouse/pull/51716) ([KevinyhZou](https://github.com/KevinyhZou))。
- 在意外崩溃后添加了将崩溃日志刷新到磁盘的功能。[#51720](https://github.com/ClickHouse/ClickHouse/pull/51720) ([Alexey Gerasimchuck](https://github.com/Demilivor))。
- 修复仪表板页面中不显示与身份验证无关的错误的行为。同时修复"重叠"图表行为。[#51744](https://github.com/ClickHouse/ClickHouse/pull/51744) ([Zach Naimon](https://github.com/ArctypeZach))。
- 允许 UUID 到 UInt128 的转换。[#51765](https://github.com/ClickHouse/ClickHouse/pull/51765) ([Dmitry Kardymon](https://github.com/kardymonds))。
- 添加了对 Nullable 参数的函数 `range` 的支持。[#51767](https://github.com/ClickHouse/ClickHouse/pull/51767) ([Dmitry Kardymon](https://github.com/kardymonds))。
- 将类似 `toyear(x) = c` 的条件转换为 `c1 <= x < c2`。[#51795](https://github.com/ClickHouse/ClickHouse/pull/51795) ([Han Fei](https://github.com/hanfei1991))。
- 改进语句 `SHOW INDEX` 的 MySQL 兼容性。[#51796](https://github.com/ClickHouse/ClickHouse/pull/51796) ([Robert Schulze](https://github.com/rschu1ze))。
- 修复 `use_structure_from_insertion_table_in_table_functions` 不适用于 `MATERIALIZED` 和 `ALIAS` 列的问题。解决了 [#51817](https://github.com/ClickHouse/ClickHouse/issues/51817)。解决了 [#51019](https://github.com/ClickHouse/ClickHouse/issues/51019)。[#51825](https://github.com/ClickHouse/ClickHouse/pull/51825) ([flynn](https://github.com/ucasfl))。
- 缓存字典现在仅从源请求唯一键。解决了 [#51762](https://github.com/ClickHouse/ClickHouse/issues/51762)。[#51853](https://github.com/ClickHouse/ClickHouse/pull/51853) ([Maksim Kita](https://github.com/kitaisreal))。
- 修复了在提供 FORMAT 时设置未应用于 EXPLAIN 查询的问题。[#51859](https://github.com/ClickHouse/ClickHouse/pull/51859) ([Nikita Taranov](https://github.com/nickitat))。
- 允许在 DESCRIBE TABLE 查询中在 FORMAT 之前使用 SETTINGS,以与 SELECT 查询兼容。解决了 [#51544](https://github.com/ClickHouse/ClickHouse/issues/51544)。[#51899](https://github.com/ClickHouse/ClickHouse/pull/51899) ([Nikolay Degterinsky](https://github.com/evillique))。
- Var-Int 编码的整数(例如由原生协议使用)现在可以使用完整的 64 位范围。建议第三方客户端相应地更新其 var-int 代码。[#51905](https://github.com/ClickHouse/ClickHouse/pull/51905) ([Robert Schulze](https://github.com/rschu1ze))。
- 在证书更改时自动更新证书,无需手动执行 SYSTEM RELOAD CONFIG。[#52030](https://github.com/ClickHouse/ClickHouse/pull/52030) ([Mike Kot](https://github.com/myrrc))。
- 添加了 `allow_create_index_without_type` 设置,允许忽略未指定 `TYPE` 的 `ADD INDEX` 查询。标准 SQL 查询将成功执行而不更改表结构。[#52056](https://github.com/ClickHouse/ClickHouse/pull/52056) ([Ilya Yatsishin](https://github.com/qoega))。
- 从服务器启动开始,日志消息将写入 `system.text_log`。[#52113](https://github.com/ClickHouse/ClickHouse/pull/52113) ([Dmitry Kardymon](https://github.com/kardymonds))。
- 在 HTTP 端点具有多个 IP 地址且第一个不可达的情况下,会抛出超时异常。现在会处理所有已解析的端点来创建会话。[#52116](https://github.com/ClickHouse/ClickHouse/pull/52116) ([Aleksei Filatov](https://github.com/aalexfvk))。
- Avro 输入格式现在支持 Union,即使它只包含单一类型。解决了 [#52131](https://github.com/ClickHouse/ClickHouse/issues/52131)。[#52137](https://github.com/ClickHouse/ClickHouse/pull/52137) ([flynn](https://github.com/ucasfl))。
- 添加设置 `optimize_use_implicit_projections` 以禁用隐式投影(目前仅 `min_max_count` 投影)。[#52152](https://github.com/ClickHouse/ClickHouse/pull/52152) ([Amos Bird](https://github.com/amosbird))。
- 之前可以使用函数 `hasToken` 造成无限循环。现在已移除这种可能性。此更改解决了 [#52156](https://github.com/ClickHouse/ClickHouse/issues/52156)。[#52160](https://github.com/ClickHouse/ClickHouse/pull/52160) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 乐观地创建 ZK 祖先节点。[#52195](https://github.com/ClickHouse/ClickHouse/pull/52195) ([Raúl Marín](https://github.com/Algunenano))。
- 修复 [#50582](https://github.com/ClickHouse/ClickHouse/issues/50582)。避免在某些按顺序读取和常量的情况下出现 `Not found column ... in block` 错误。[#52259](https://github.com/ClickHouse/ClickHouse/pull/52259) ([Chen768959](https://github.com/Chen768959))。
- 在 ClickHouse 端尽早检查 S2 地理基元是否无效。此更改解决了:[#27090](https://github.com/ClickHouse/ClickHouse/issues/27090)。[#52260](https://github.com/ClickHouse/ClickHouse/pull/52260) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 当 `query_plan_optimize_projection = 1` 时,添加回缺失的投影 QueryAccessInfo。此更改修复了 [#50183](https://github.com/ClickHouse/ClickHouse/issues/50183)。此更改修复了 [#50093](https://github.com/ClickHouse/ClickHouse/issues/50093)。[#52327](https://github.com/ClickHouse/ClickHouse/pull/52327) ([Amos Bird](https://github.com/amosbird))。
- 当 `ZooKeeperRetriesControl` 重新抛出错误时,查看其原始堆栈跟踪更有用,而不是来自 `ZooKeeperRetriesControl` 本身的堆栈跟踪。[#52347](https://github.com/ClickHouse/ClickHouse/pull/52347) ([Vitaly Baranov](https://github.com/vitlibar))。
- 即使某些磁盘不支持零拷贝复制锁,也要等待它。[#52376](https://github.com/ClickHouse/ClickHouse/pull/52376) ([Raúl Marín](https://github.com/Algunenano))。
- 现在服务器间端口将仅在表关闭后才关闭。[#52498](https://github.com/ClickHouse/ClickHouse/pull/52498) ([alesapin](https://github.com/alesapin))。

#### 实验性功能 {#experimental-feature-2}

- Parquet 文件写入速度提升 10 倍,现已支持多线程。速度几乎与读取相当。[#49367](https://github.com/ClickHouse/ClickHouse/pull/49367) ([Michael Kolupaev](https://github.com/al13n321))。此功能由 `output_format_parquet_use_custom_encoder` 设置控制,默认禁用,因为该功能尚不完善。
- 新增对 [PRQL](https://prql-lang.org/) 查询语言的支持。[#50686](https://github.com/ClickHouse/ClickHouse/pull/50686) ([János Benjamin Antal](https://github.com/antaljanosbenjamin))。
- 允许为自定义磁盘指定磁盘名称。以前自定义磁盘使用内部生成的磁盘名称。现在可以通过 `disk = disk_<name>(...)` 语法实现(例如,磁盘名称为 `name`)。[#51552](https://github.com/ClickHouse/ClickHouse/pull/51552) ([Kseniia Sumarokova](https://github.com/kssenii))。此语法可能在本版本中发生变更。
- (实验性 MaterializedMySQL) 修复了 `mysqlxx::Pool::Entry` 断开连接后使用时导致的崩溃问题。[#52063](https://github.com/ClickHouse/ClickHouse/pull/52063) ([Val Doroshchuk](https://github.com/valbok))。
- (实验性 MaterializedMySQL) MaterializedMySQL 现已支持 `CREATE TABLE ... AS SELECT` 语句。[#52067](https://github.com/ClickHouse/ClickHouse/pull/52067) ([Val Doroshchuk](https://github.com/valbok))。
- (实验性 MaterializedMySQL) 为 MaterializedMySQL 引入了文本类型到 UTF-8 的自动转换功能。[#52084](https://github.com/ClickHouse/ClickHouse/pull/52084) ([Val Doroshchuk](https://github.com/valbok))。
- (实验性 MaterializedMySQL) MaterializedMySQL 的 DDL 现已支持不带引号的 UTF-8 字符串。[#52318](https://github.com/ClickHouse/ClickHouse/pull/52318) ([Val Doroshchuk](https://github.com/valbok))。
- (实验性 MaterializedMySQL) MaterializedMySQL 现已支持双引号注释。[#52355](https://github.com/ClickHouse/ClickHouse/pull/52355) ([Val Doroshchuk](https://github.com/valbok))。
- 将 Intel QPL 从 v1.1.0 升级到 v1.2.0。将 Intel accel-config 从 v3.5 升级到 v4.0。修复了设备 IOTLB 未命中对 IAA 加速器性能产生重大影响的问题。[#52180](https://github.com/ClickHouse/ClickHouse/pull/52180) ([jasperzhu](https://github.com/jinjunzh))。
- `session_timezone` 设置(在 23.6 版本中新增)已降级为实验性功能。[#52445](https://github.com/ClickHouse/ClickHouse/pull/52445) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 为 ClickHouse Keeper 支持 ZooKeeper `reconfig` 命令,提供增量重新配置功能,可通过 `keeper_server.enable_reconfiguration` 设置启用。支持添加服务器、移除服务器以及更改服务器优先级。[#49450](https://github.com/ClickHouse/ClickHouse/pull/49450) ([Mike Kot](https://github.com/myrrc))。该功能疑似尚未完成。


#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-5}

- 在 CI 中添加 Linux RISC-V 64 的实验性 ClickHouse 构建。[#31398](https://github.com/ClickHouse/ClickHouse/pull/31398) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 添加启用分析器的集成测试检查。[#50926](https://github.com/ClickHouse/ClickHouse/pull/50926) [#52210](https://github.com/ClickHouse/ClickHouse/pull/52210) ([Dmitry Novik](https://github.com/novikd))。
- Rust 的可重现构建。[#52395](https://github.com/ClickHouse/ClickHouse/pull/52395) ([Azat Khuzhin](https://github.com/azat))。
- 更新 Cargo 依赖项。[#51721](https://github.com/ClickHouse/ClickHouse/pull/51721) ([Raúl Marín](https://github.com/Algunenano))。
- 使函数 `CHColumnToArrowColumn::fillArrowArrayWithArrayColumnData` 能够处理可空数组,虽然 ClickHouse 本身不支持此功能,但 Gluten 需要。[#52112](https://github.com/ClickHouse/ClickHouse/pull/52112) ([李扬](https://github.com/taiyang-li))。
- 我们已将 CCTZ 库更新到 master 分支,但没有用户可见的变更。[#52124](https://github.com/ClickHouse/ClickHouse/pull/52124) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `system.licenses` 表现在包含硬分叉库 Poco。这解决了 [#52066](https://github.com/ClickHouse/ClickHouse/issues/52066)。[#52127](https://github.com/ClickHouse/ClickHouse/pull/52127) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 检查是否存在错误的标点符号:逗号前有空格,如 `Hello ,world` 而不是 `Hello, world`。[#52549](https://github.com/ClickHouse/ClickHouse/pull/52549) ([Alexey Milovidov](https://github.com/alexey-milovidov))。


#### 错误修复(官方稳定版本中用户可见的异常行为) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-5}

- 修复 MaterializedPostgreSQL syncTables [#49698](https://github.com/ClickHouse/ClickHouse/pull/49698) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 修复使用 optimize_aggregators_of_group_by_keys 的投影 [#49709](https://github.com/ClickHouse/ClickHouse/pull/49709) ([Amos Bird](https://github.com/amosbird))。
- 修复 optimize_skip_unused_shards 与 JOIN 的问题 [#51037](https://github.com/ClickHouse/ClickHouse/pull/51037) ([Azat Khuzhin](https://github.com/azat))。
- 修复 formatDateTime() 处理负数小数 datetime64 的问题 [#51290](https://github.com/ClickHouse/ClickHouse/pull/51290) ([Dmitry Kardymon](https://github.com/kardymonds))。
- `hasToken*` 函数存在严重错误。为 [#43358](https://github.com/ClickHouse/ClickHouse/issues/43358) 添加测试 [#51378](https://github.com/ClickHouse/ClickHouse/pull/51378) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 修复排序前移动函数的优化问题。[#51481](https://github.com/ClickHouse/ClickHouse/pull/51481) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 修复 FINAL 中 Pipe::unitePipes 的 Block 结构不匹配问题 [#51492](https://github.com/ClickHouse/ClickHouse/pull/51492) ([Nikita Taranov](https://github.com/nickitat))。
- 修复所有分片权重为零的集群的 SIGSEGV 问题(修复 INSERT INTO FUNCTION clusterAllReplicas())[#51545](https://github.com/ClickHouse/ClickHouse/pull/51545) ([Azat Khuzhin](https://github.com/azat))。
- 修复对冲请求的超时问题 [#51582](https://github.com/ClickHouse/ClickHouse/pull/51582) ([Azat Khuzhin](https://github.com/azat))。
- 修复 ANTI join 中 NULL 值的逻辑错误 [#51601](https://github.com/ClickHouse/ClickHouse/pull/51601) ([vdimir](https://github.com/vdimir))。
- 修复将 'IN' 条件移动到 PREWHERE 的问题 [#51610](https://github.com/ClickHouse/ClickHouse/pull/51610) ([Alexander Gololobov](https://github.com/davenger))。
- 不对 ASOF/ANTI join 应用 PredicateExpressionsOptimizer [#51633](https://github.com/ClickHouse/ClickHouse/pull/51633) ([vdimir](https://github.com/vdimir))。
- 修复 ReplicatedMergeTree 使用合并算法时带去重的异步插入问题 [#51676](https://github.com/ClickHouse/ClickHouse/pull/51676) ([Antonio Andelic](https://github.com/antonio2368))。
- 修复 `parseSipHashKey` 从空列读取的问题 [#51804](https://github.com/ClickHouse/ClickHouse/pull/51804) ([Nikita Taranov](https://github.com/nickitat))。
- 修复创建无效 EmbeddedRocksdb 表时的段错误 [#51847](https://github.com/ClickHouse/ClickHouse/pull/51847) ([Duc Canh Le](https://github.com/canhld94))。
- 修复向 MongoDB 表插入数据的问题 [#51876](https://github.com/ClickHouse/ClickHouse/pull/51876) ([Nikolay Degterinsky](https://github.com/evillique))。
- 修复 DatabaseCatalog 关闭时的死锁问题 [#51908](https://github.com/ClickHouse/ClickHouse/pull/51908) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 修复子查询运算符中的错误 [#51922](https://github.com/ClickHouse/ClickHouse/pull/51922) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 修复异步连接到具有多个 IP 地址的主机的问题 [#51934](https://github.com/ClickHouse/ClickHouse/pull/51934) ([Kruglov Pavel](https://github.com/Avogar))。
- ActionsDAG::merge 后不移除输入 [#51947](https://github.com/ClickHouse/ClickHouse/pull/51947) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 在 `RemoveManyObjectStorageOperation::finalize` 而非 `execute` 中检查引用计数 [#51954](https://github.com/ClickHouse/ClickHouse/pull/51954) ([vdimir](https://github.com/vdimir))。
- 允许参数化 UDF [#51964](https://github.com/ClickHouse/ClickHouse/pull/51964) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 小幅修复 toDateTime64() 处理 2283-12-31 之后日期的问题 [#52130](https://github.com/ClickHouse/ClickHouse/pull/52130) ([Andrey Zvonov](https://github.com/zvonand))。
- 修复 WINDOW 函数元组的 ORDER BY 问题 [#52145](https://github.com/ClickHouse/ClickHouse/pull/52145) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 修复聚合表达式包含单调函数时的投影分析错误 [#52151](https://github.com/ClickHouse/ClickHouse/pull/52151) ([Amos Bird](https://github.com/amosbird))。
- 修复 `groupArrayMoving` 函数中的错误 [#52161](https://github.com/ClickHouse/ClickHouse/pull/52161) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 禁用范围字典的直接 join [#52187](https://github.com/ClickHouse/ClickHouse/pull/52187) ([Duc Canh Le](https://github.com/canhld94))。
- 修复粘性 mutation 测试(以及极其罕见的竞态条件)[#52197](https://github.com/ClickHouse/ClickHouse/pull/52197) ([alesapin](https://github.com/alesapin))。
- 修复 Web 磁盘中的竞态条件 [#52211](https://github.com/ClickHouse/ClickHouse/pull/52211) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 修复 Connection::setAsyncCallback 中来自服务器的未知数据包导致的数据竞争 [#52219](https://github.com/ClickHouse/ClickHouse/pull/52219) ([Kruglov Pavel](https://github.com/Avogar))。
- 修复启动时临时数据删除的问题,添加测试 [#52275](https://github.com/ClickHouse/ClickHouse/pull/52275) ([vdimir](https://github.com/vdimir))。
- 计数可空列时不使用 minmax_count 投影 [#52297](https://github.com/ClickHouse/ClickHouse/pull/52297) ([Amos Bird](https://github.com/amosbird))。
- MergeTree/ReplicatedMergeTree 应对日志条目使用服务器时区 [#52325](https://github.com/ClickHouse/ClickHouse/pull/52325) ([Azat Khuzhin](https://github.com/azat))。
- 修复带有 CTE 和多次使用的参数化视图 [#52328](https://github.com/ClickHouse/ClickHouse/pull/52328) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
- 禁用时间间隔的表达式模板 [#52335](https://github.com/ClickHouse/ClickHouse/pull/52335) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 修复 Keeper 中的 `apply_snapshot` [#52358](https://github.com/ClickHouse/ClickHouse/pull/52358) ([Antonio Andelic](https://github.com/antonio2368))。
- 更新 build-osx.md [#52377](https://github.com/ClickHouse/ClickHouse/pull/52377) ([AlexBykovski](https://github.com/AlexBykovski))。
- 修复 `countSubstrings` 在空搜索串和列 haystack 时挂起的问题 [#52409](https://github.com/ClickHouse/ClickHouse/pull/52409) ([Sergei Trifonov](https://github.com/serxa))。
- 修复 Merge 表的普通投影 [#52432](https://github.com/ClickHouse/ClickHouse/pull/52432) ([Amos Bird](https://github.com/amosbird))。
- 修复 Aggregator 中可能的双重释放问题 [#52439](https://github.com/ClickHouse/ClickHouse/pull/52439) ([Nikita Taranov](https://github.com/nickitat))。
- 修复向 Buffer 引擎插入数据的问题 [#52440](https://github.com/ClickHouse/ClickHouse/pull/52440) ([Vasily Nemkov](https://github.com/Enmk))。
- AnyHash 的实现不符合规范。[#52448](https://github.com/ClickHouse/ClickHouse/pull/52448) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 在 OptimizedRegularExpression 中检查递归深度 [#52451](https://github.com/ClickHouse/ClickHouse/pull/52451) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 修复 DatabaseReplicated::startupTables()/canExecuteReplicatedMetadataAlter() 的数据竞争 [#52490](https://github.com/ClickHouse/ClickHouse/pull/52490) ([Azat Khuzhin](https://github.com/azat))。
- 修复函数 `transform` 中的中止问题 [#52513](https://github.com/ClickHouse/ClickHouse/pull/52513) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 修复删除投影后的轻量级删除问题 [#52517](https://github.com/ClickHouse/ClickHouse/pull/52517) ([Anton Popov](https://github.com/CurtizJ))。
- 修复可能出现的错误 "Cannot drain connections: cancel first" [#52585](https://github.com/ClickHouse/ClickHouse/pull/52585) ([Kruglov Pavel](https://github.com/Avogar))。

### <a id="236"></a> ClickHouse release 23.6, 2023-06-29 {#236}

#### 向后不兼容的变更 {#backward-incompatible-change-6}

- 删除文件系统缓存中的 `do_not_evict_index_and_mark_files` 功能。该功能只会使情况变得更糟。 [#51253](https://github.com/ClickHouse/ClickHouse/pull/51253) ([Kseniia Sumarokova](https://github.com/kssenii)).
- 移除对实验性 LIVE VIEW 的 ALTER 支持。 [#51287](https://github.com/ClickHouse/ClickHouse/pull/51287) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- 将 `http_max_field_value_size` 和 `http_max_field_name_size` 的默认值降低至 128 KiB。 [#51163](https://github.com/ClickHouse/ClickHouse/pull/51163) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- 与 CPU 相关的 CGroups 指标被替换为单个指标 `CGroupMaxCPU`,以提高可用性。当设置了 CGroups 限制时,`Normalized` CPU 使用率指标将根据 CGroups 限制而非 CPU 总数进行归一化。这解决了 [#50836](https://github.com/ClickHouse/ClickHouse/issues/50836). [#50835](https://github.com/ClickHouse/ClickHouse/pull/50835) ([Alexey Milovidov](https://github.com/alexey-milovidov)).


#### 新功能 {#new-feature-6}

- `transform` 函数以及带值匹配的 `CASE` 语句现已支持所有数据类型。此更新关闭了 [#29730](https://github.com/ClickHouse/ClickHouse/issues/29730)、[#32387](https://github.com/ClickHouse/ClickHouse/issues/32387)、[#50827](https://github.com/ClickHouse/ClickHouse/issues/50827)、[#31336](https://github.com/ClickHouse/ClickHouse/issues/31336)、[#40493](https://github.com/ClickHouse/ClickHouse/issues/40493)。[#51351](https://github.com/ClickHouse/ClickHouse/pull/51351) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 新增选项 `--rename_files_after_processing <pattern>`。此更新关闭了 [#34207](https://github.com/ClickHouse/ClickHouse/issues/34207)。[#49626](https://github.com/ClickHouse/ClickHouse/pull/49626) ([alekseygolub](https://github.com/alekseygolub))。
- 在 `INTO OUTFILE` 子句中新增对 `TRUNCATE` 修饰符的支持。当文件已存在时,建议为 `INTO OUTFILE` 使用 `APPEND` 或 `TRUNCATE`。[#50950](https://github.com/ClickHouse/ClickHouse/pull/50950) ([alekar](https://github.com/alekar))。
- 新增表引擎 `Redis` 和表函数 `redis`,允许查询外部 Redis 服务器。[#50150](https://github.com/ClickHouse/ClickHouse/pull/50150) ([JackyWoo](https://github.com/JackyWoo))。
- 允许在 file/s3/url/hdfs 表函数中通过设置 `s3_skip_empty_files`、`hdfs_skip_empty_files`、`engine_file_skip_empty_files`、`engine_url_skip_empty_files` 跳过空文件。[#50364](https://github.com/ClickHouse/ClickHouse/pull/50364) ([Kruglov Pavel](https://github.com/Avogar))。
- 新增设置 `use_mysql_types_in_show_columns`,用于在客户端通过 MySQL 兼容端口连接时,修改 `SHOW COLUMNS` SQL 语句以显示 MySQL 等效类型。[#49577](https://github.com/ClickHouse/ClickHouse/pull/49577) ([Thomas Panetti](https://github.com/tpanetti))。
- clickhouse-client 现在可以使用连接字符串调用,无需使用 `--host`、`--port`、`--user` 等参数。[#50689](https://github.com/ClickHouse/ClickHouse/pull/50689) ([Alexey Gerasimchuck](https://github.com/Demilivor))。
- 新增设置 `session_timezone`,当未明确指定时,它将用作会话的默认时区。[#44149](https://github.com/ClickHouse/ClickHouse/pull/44149) ([Andrey Zvonov](https://github.com/zvonand))。
- 编解码器 DEFLATE_QPL 现在通过服务器设置 `enable_deflate_qpl_codec`(默认值:false)控制,而不是通过设置 `allow_experimental_codecs` 控制。这标志着 DEFLATE_QPL 不再是实验性功能。[#50775](https://github.com/ClickHouse/ClickHouse/pull/50775) ([Robert Schulze](https://github.com/rschu1ze))。


#### 性能改进 {#performance-improvement-6}

- 改进了 `ReplicatedMergeTree` 中合并选择和清理任务的调度。当没有需要合并或清理的内容时,任务不会过于频繁地执行。新增了 `max_merge_selecting_sleep_ms`、`merge_selecting_sleep_slowdown_factor`、`max_cleanup_delay_period` 和 `cleanup_thread_preferred_points_per_iteration` 配置项。这应该能解决 [#31919](https://github.com/ClickHouse/ClickHouse/issues/31919)。[#50107](https://github.com/ClickHouse/ClickHouse/pull/50107) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 实现了通过交叉连接的过滤器下推。[#50605](https://github.com/ClickHouse/ClickHouse/pull/50605) ([Han Fei](https://github.com/hanfei1991))。
- 通过使用线程本地的 timer_id 而非全局对象,提升了启用 QueryProfiler 时的性能。[#48778](https://github.com/ClickHouse/ClickHouse/pull/48778) ([Jiebin Sun](https://github.com/jiebinn))。
- 重写了 CapnProto 输入/输出格式以提升其性能。列名和 CapnProto 字段映射不区分大小写,修复了嵌套结构字段的读写问题。[#49752](https://github.com/ClickHouse/ClickHouse/pull/49752) ([Kruglov Pavel](https://github.com/Avogar))。
- 优化了并行线程的 Parquet 写入性能。[#50102](https://github.com/ClickHouse/ClickHouse/pull/50102) ([Hongbin Ma](https://github.com/binmahone))。
- 对于处理物化视图和仅包含单个数据块的存储,禁用了 `parallelize_output_from_storages`。[#50214](https://github.com/ClickHouse/ClickHouse/pull/50214) ([Azat Khuzhin](https://github.com/azat))。
- 合并 PR [#46558](https://github.com/ClickHouse/ClickHouse/pull/46558)。如果数据块已经排序,则在排序期间避免数据块置换。[#50697](https://github.com/ClickHouse/ClickHouse/pull/50697) ([Alexey Milovidov](https://github.com/alexey-milovidov), [Maksim Kita](https://github.com/kitaisreal))。
- 并行向 ZooKeeper 发起多个列表请求,以加快从 system.zookeeper 表的读取速度。[#51042](https://github.com/ClickHouse/ClickHouse/pull/51042) ([Alexander Gololobov](https://github.com/davenger))。
- 加快了时区的 DateTime 查找表初始化。这应该能减少 clickhouse-client 的启动/连接时间,特别是在调试构建中,因为它相当耗时。[#51347](https://github.com/ClickHouse/ClickHouse/pull/51347) ([Alexander Gololobov](https://github.com/davenger))。
- 修复了由于同步 HEAD 请求导致的数据湖缓慢问题。(与 Iceberg/Deltalake/Hudi 在处理大量文件时速度慢有关)。[#50976](https://github.com/ClickHouse/ClickHouse/pull/50976) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 不再从右侧 GLOBAL JOIN 表中读取所有列。[#50721](https://github.com/ClickHouse/ClickHouse/pull/50721) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。

#### 实验性功能 {#experimental-feature-3}

- 支持分析器的并行副本功能。[#50441](https://github.com/ClickHouse/ClickHouse/pull/50441) ([Raúl Marín](https://github.com/Algunenano))。
- 在执行大型合并/变更之前添加随机休眠,以便在零拷贝复制的情况下更均匀地分配副本之间的负载。[#51282](https://github.com/ClickHouse/ClickHouse/pull/51282) ([alesapin](https://github.com/alesapin))。
- 如果 `Replicated` 数据库只有一个分片且底层表是 `ReplicatedMergeTree`,则不通过该数据库复制 `ALTER PARTITION` 查询和变更。[#51049](https://github.com/ClickHouse/ClickHouse/pull/51049) ([Alexander Tokmakov](https://github.com/tavplubix))。


#### 改进 {#improvement-6}

- 放宽"数据分片过多"的阈值以适应现代需求。在长时间运行的插入查询期间返回背压。[#50856](https://github.com/ClickHouse/ClickHouse/pull/50856) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 允许将 CIDR ::ffff:0:0/96(IPv4 映射地址)的 IPv6 地址转换为 IPv4 地址。[#49759](https://github.com/ClickHouse/ClickHouse/pull/49759) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
- 更新 MongoDB 协议以支持 MongoDB 5.1 及更新版本。保留对旧协议版本(&lt;3.6)的支持。关闭 [#45621](https://github.com/ClickHouse/ClickHouse/issues/45621)、[#49879](https://github.com/ClickHouse/ClickHouse/issues/49879)。[#50061](https://github.com/ClickHouse/ClickHouse/pull/50061) ([Nikolay Degterinsky](https://github.com/evillique))。
- 添加设置 `input_format_max_bytes_to_read_for_schema_inference` 以限制模式推断中读取的字节数。关闭 [#50577](https://github.com/ClickHouse/ClickHouse/issues/50577)。[#50592](https://github.com/ClickHouse/ClickHouse/pull/50592) ([Kruglov Pavel](https://github.com/Avogar))。
- 在模式推断中遵循设置 `input_format_null_as_default`。[#50602](https://github.com/ClickHouse/ClickHouse/pull/50602) ([Kruglov Pavel](https://github.com/Avogar))。
- 允许通过设置 `input_format_csv_skip_trailing_empty_lines`、`input_format_tsv_skip_trailing_empty_lines` 和 `input_format_custom_skip_trailing_empty_lines` 跳过 CSV/TSV/CustomSeparated 格式中的尾部空行(默认禁用)。关闭 [#49315](https://github.com/ClickHouse/ClickHouse/issues/49315)。[#50635](https://github.com/ClickHouse/ClickHouse/pull/50635) ([Kruglov Pavel](https://github.com/Avogar))。
- 函数"toDateOrDefault|OrNull"和"accuateCast[OrDefault|OrNull]"现在可以正确解析数值参数。[#50709](https://github.com/ClickHouse/ClickHouse/pull/50709) ([Dmitry Kardymon](https://github.com/kardymonds))。
- 支持使用空格或 `\t` 作为字段分隔符的 CSV,这些分隔符在 Spark 中也受支持。[#50712](https://github.com/ClickHouse/ClickHouse/pull/50712) ([KevinyhZou](https://github.com/KevinyhZou))。
- 设置 `number_of_mutations_to_delay` 和 `number_of_mutations_to_throw` 现在默认启用,值分别为 500 和 1000。[#50726](https://github.com/ClickHouse/ClickHouse/pull/50726) ([Anton Popov](https://github.com/CurtizJ))。
- 仪表板现在可以正确显示缺失值。这关闭了 [#50831](https://github.com/ClickHouse/ClickHouse/issues/50831)。[#50832](https://github.com/ClickHouse/ClickHouse/pull/50832) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 在函数 `parseDateTimeBestEffort*` 和 `parseDateTime64BestEffort*` 中添加了使用 syslog 时间戳格式的日期和时间参数的功能。[#50925](https://github.com/ClickHouse/ClickHouse/pull/50925) ([Victor Krasnov](https://github.com/sirvickr))。
- clickhouse-client 中的命令行参数"--password"现在只能指定一次。[#50966](https://github.com/ClickHouse/ClickHouse/pull/50966) ([Alexey Gerasimchuck](https://github.com/Demilivor))。
- 在集群备份期间使用 `system.parts` 中的 `hash_of_all_files` 来检查数据分片的一致性。[#50997](https://github.com/ClickHouse/ClickHouse/pull/50997) ([Vitaly Baranov](https://github.com/vitlibar))。
- 系统表 zookeeper_connection 的 connected_time 标识连接建立的时间(标准格式),并添加了 session_uptime_elapsed_seconds,用于标记已建立连接会话的持续时间(以秒为单位)。[#51026](https://github.com/ClickHouse/ClickHouse/pull/51026) ([郭小龙](https://github.com/guoxiaolongzte))。
- 通过使用源数据的块大小并在每个线程中使用增量总大小计数,改进 file/s3/hdfs/url 表函数的进度条。修复 \*Cluster 函数的进度条。这关闭了 [#47250](https://github.com/ClickHouse/ClickHouse/issues/47250)。[#51088](https://github.com/ClickHouse/ClickHouse/pull/51088) ([Kruglov Pavel](https://github.com/Avogar))。
- 在 TCP 协议的 Progress 数据包中添加 total_bytes_to_read 以改进进度条。[#51158](https://github.com/ClickHouse/ClickHouse/pull/51158) ([Kruglov Pavel](https://github.com/Avogar))。
- 改进对具有文件系统缓存的磁盘上数据分片的检查。[#51164](https://github.com/ClickHouse/ClickHouse/pull/51164) ([Anton Popov](https://github.com/CurtizJ))。
- 修复文件系统缓存中有时不正确的 current_elements_num。[#51242](https://github.com/ClickHouse/ClickHouse/pull/51242) ([Kseniia Sumarokova](https://github.com/kssenii))。

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-6}

- 将嵌入式 keeper-client 添加到独立 keeper 二进制文件中。[#50964](https://github.com/ClickHouse/ClickHouse/pull/50964) ([pufit](https://github.com/pufit))。
- 现在使用最新的 LZ4 版本。[#50621](https://github.com/ClickHouse/ClickHouse/pull/50621) ([Nikita Taranov](https://github.com/nickitat))。
- ClickHouse 服务器将在发生致命错误时打印已更改配置项的列表。此更改解决了 [#51137](https://github.com/ClickHouse/ClickHouse/issues/51137)。[#51138](https://github.com/ClickHouse/ClickHouse/pull/51138) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 允许使用 clang-17 构建 ClickHouse。[#51300](https://github.com/ClickHouse/ClickHouse/pull/51300) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- [SQLancer](https://github.com/sqlancer/sqlancer) 检查现已被视为稳定,因为其触发的错误已被修复。现在 SQLancer 检查失败将被报告为检查失败状态。[#51340](https://github.com/ClickHouse/ClickHouse/pull/51340) ([Ilya Yatsishin](https://github.com/qoega))。
- 将 Dockerfile 中的大型 `RUN` 指令拆分为更小的条件语句。在同一 `RUN` 层中按需安装必要的工具,并在之后删除它们。仅在开始时升级操作系统一次。使用现代方式检查已签名的仓库。将基础镜像降级到 ubuntu:20.04 以解决旧版 Docker 的问题。升级 golang 版本以解决 golang 安全漏洞。[#51504](https://github.com/ClickHouse/ClickHouse/pull/51504) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。

#### 错误修复(官方稳定版本中用户可见的异常行为) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-6}


* 正确报告可执行词典的加载状态 [#48775](https://github.com/ClickHouse/ClickHouse/pull/48775) ([Anton Kozlov](https://github.com/tonickkozlov))。
* 正确处理 skip 索引和投影的变更 [#50104](https://github.com/ClickHouse/ClickHouse/pull/50104) ([Amos Bird](https://github.com/amosbird))。
* 清理可变组件 [#50489](https://github.com/ClickHouse/ClickHouse/pull/50489) ([vdimir](https://github.com/vdimir)).
* 修复聚合函数中 IP 类型哈希的向后兼容问题 [#50551](https://github.com/ClickHouse/ClickHouse/pull/50551) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* 修复 Log 系列表在执行 `TRUNCATE` 后返回错误行数的问题 [#50585](https://github.com/ClickHouse/ClickHouse/pull/50585) ([flynn](https://github.com/ucasfl))。
* 修复 `uniqExact` 并行合并中的 bug [#50590](https://github.com/ClickHouse/ClickHouse/pull/50590)（[Nikita Taranov](https://github.com/nickitat)）。
* 回退最近的 grace hash join 变更 [#50699](https://github.com/ClickHouse/ClickHouse/pull/50699)（[vdimir](https://github.com/vdimir)）。
* 查询缓存：尝试修复从 `ColumnConst` 到 `ColumnVector<char8_t>` 的错误类型转换 [#50704](https://github.com/ClickHouse/ClickHouse/pull/50704)（[Robert Schulze](https://github.com/rschu1ze)）。
* 避免在 Keeper 中存储包含未知操作的日志 [#50751](https://github.com/ClickHouse/ClickHouse/pull/50751) ([Antonio Andelic](https://github.com/antonio2368))。
* `SummingMergeTree` 对 `DateTime64` 的支持 [#50797](https://github.com/ClickHouse/ClickHouse/pull/50797)（[Jordi Villar](https://github.com/jrdi)）。
* 为非常量时区添加兼容性设置 [#50834](https://github.com/ClickHouse/ClickHouse/pull/50834) ([Robert Schulze](https://github.com/rschu1ze))。
* 修复缓存条目中 LDAP 参数的哈希方式 [#50865](https://github.com/ClickHouse/ClickHouse/pull/50865)（[Julian Maicher](https://github.com/jmaicher)）。
* 在 Parquet 格式中，遇到大整数时，改为从 String 解析大整数作为回退行为，而不是抛出异常 [#50873](https://github.com/ClickHouse/ClickHouse/pull/50873)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复在写入备份时过于频繁检查锁文件的行为 [#50889](https://github.com/ClickHouse/ClickHouse/pull/50889) ([Vitaly Baranov](https://github.com/vitlibar))。
* 如果启用了按顺序读取，则不应用投影。[#50923](https://github.com/ClickHouse/ClickHouse/pull/50923) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复 Azure Blob 存储迭代器中的竞争问题 [#50936](https://github.com/ClickHouse/ClickHouse/pull/50936) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* 修复 `CreatingSets` 中错误的 `sort_description` 传递 [#50955](https://github.com/ClickHouse/ClickHouse/pull/50955)（[Nikita Taranov](https://github.com/nickitat)）。
* 修复 Iceberg v2 可选元数据的解析 [#50974](https://github.com/ClickHouse/ClickHouse/pull/50974)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* MaterializedMySQL：在空表覆盖配置中保留括号 [#50977](https://github.com/ClickHouse/ClickHouse/pull/50977) ([Val Doroshchuk](https://github.com/valbok)).
* 修复 BackupCoordinationStageSync::setError() 中的崩溃问题 [#51012](https://github.com/ClickHouse/ClickHouse/pull/51012)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 修复 `ColumnLowCardinality` 字典中存在细微问题的写时复制机制 [#51064](https://github.com/ClickHouse/ClickHouse/pull/51064)（[Michael Kolupaev](https://github.com/al13n321)）。
* 生成安全的 IV 值 [#51086](https://github.com/ClickHouse/ClickHouse/pull/51086) ([Salvatore Mesoraca](https://github.com/aiven-sal))。
* 修复对包含子查询的 SELECT 语句无效的查询缓存 [#51132](https://github.com/ClickHouse/ClickHouse/pull/51132)（[Robert Schulze](https://github.com/rschu1ze)）。
* 修复 Set 索引在与常量可空值比较时的问题。 [#51205](https://github.com/ClickHouse/ClickHouse/pull/51205) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复 `s3` 和 `s3Cluster` 函数中的崩溃问题 [#51209](https://github.com/ClickHouse/ClickHouse/pull/51209)（[Nikolay Degterinsky](https://github.com/evillique)）。
* 修复了由编译表达式导致的崩溃 [#51231](https://github.com/ClickHouse/ClickHouse/pull/51231) ([LiuNeng](https://github.com/liuneng1994))。
* 修复在切换 URL 时 `StorageURL` 中的 use-after-free 错误 [#51260](https://github.com/ClickHouse/ClickHouse/pull/51260)（[Michael Kolupaev](https://github.com/al13n321)）。
* 更新了参数化视图的检查逻辑 [#51272](https://github.com/ClickHouse/ClickHouse/pull/51272)（[SmitaRKulkarni](https://github.com/SmitaRKulkarni)）。
* 修复同一文件被重复写入备份的问题 [#51299](https://github.com/ClickHouse/ClickHouse/pull/51299) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复 ActionsDAG 中的模糊测试（fuzzer）失败 [#51301](https://github.com/ClickHouse/ClickHouse/pull/51301)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 从函数 `transform` 中移除冗余内容 [#51350](https://github.com/ClickHouse/ClickHouse/pull/51350) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

### <a id="235"></a> ClickHouse release 23.5, 2023-06-08 {#235}

#### 升级说明 {#upgrade-notes}

- 默认压缩标记和主键。这显著减少了冷查询时间。升级说明:压缩标记和主键的支持已在 22.9 版本中添加。如果您启用了压缩标记或主键,或安装了 23.5 或更新版本(默认启用压缩标记或主键),则无法降级到 22.8 或更早版本。您也可以通过在服务器配置文件的 `<merge_tree>` 部分中指定 `compress_marks` 和 `compress_primary_key` 设置来显式禁用压缩标记或主键。**升级说明:** 如果您从 22.9 之前的版本升级,应该一次性升级所有副本,或在升级前禁用压缩,或通过支持但默认未启用压缩标记的中间版本(如 23.3)进行升级。[#42587](https://github.com/ClickHouse/ClickHouse/pull/42587) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 使本地对象存储与 S3 对象存储的工作方式保持一致,修复追加问题(关闭 [#48465](https://github.com/ClickHouse/ClickHouse/issues/48465)),使其可配置为独立存储。此更改向后不兼容,因为本地对象存储之上的缓存与先前版本不兼容。[#48791](https://github.com/ClickHouse/ClickHouse/pull/48791) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 移除了实验性功能"内存数据部分"。数据格式仍然受支持,但设置不再生效,将使用紧凑型或宽型数据部分代替。这关闭了 [#45409](https://github.com/ClickHouse/ClickHouse/issues/45409)。[#49429](https://github.com/ClickHouse/ClickHouse/pull/49429) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 更改了设置 `parallelize_output_from_storages` 和 `input_format_parquet_preserve_order` 的默认值。这允许 ClickHouse 在从文件(例如 CSV 或 Parquet)读取时重新排序行,在许多情况下大幅提高了性能。要恢复保持顺序的旧行为,请使用 `parallelize_output_from_storages = 0`、`input_format_parquet_preserve_order = 1`。[#49479](https://github.com/ClickHouse/ClickHouse/pull/49479) ([Michael Kolupaev](https://github.com/al13n321))。
- 使投影功能达到生产就绪状态。添加 `optimize_use_projections` 设置以控制是否为 SELECT 查询选择投影。设置 `allow_experimental_projection_optimization` 已过时且不起作用。[#49719](https://github.com/ClickHouse/ClickHouse/pull/49719) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 将 `joinGet` 标记为非确定性(与 `dictGet` 相同)。这允许在变更操作中使用它们而无需额外设置。[#49843](https://github.com/ClickHouse/ClickHouse/pull/49843) ([Azat Khuzhin](https://github.com/azat))。
- 回滚了"`groupArray` 返回值不能为可空"的更改(由于对 `Nullable` 类型的 `groupArray`/`groupArrayLast`/`groupArraySample` 造成二进制兼容性破坏,这可能导致 `TOO_LARGE_ARRAY_SIZE` 或 `CANNOT_READ_ALL_DATA` 错误)。[#49971](https://github.com/ClickHouse/ClickHouse/pull/49971) ([Azat Khuzhin](https://github.com/azat))。
- 设置 `enable_memory_bound_merging_of_aggregation_results` 默认启用。如果您从 22.12 之前的版本更新,我们建议在更新完成之前将此标志设置为 `false`。[#50319](https://github.com/ClickHouse/ClickHouse/pull/50319) ([Nikita Taranov](https://github.com/nickitat))。


#### 新功能 {#new-feature-7}

- 新增存储引擎 AzureBlobStorage 和 azureBlobStorage 表函数。支持的功能集与 S3 存储/表函数非常相似 [#50604] (https://github.com/ClickHouse/ClickHouse/pull/50604) ([alesapin](https://github.com/alesapin)) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
- 新增原生 ClickHouse Keeper CLI 客户端,可通过 `clickhouse keeper-client` 使用 [#47414](https://github.com/ClickHouse/ClickHouse/pull/47414) ([pufit](https://github.com/pufit))。
- 新增 `urlCluster` 表函数。重构所有 *Cluster 表函数以减少代码重复。使模式推断适用于所有可能的 *Cluster 函数签名和命名集合。关闭 [#38499](https://github.com/ClickHouse/ClickHouse/issues/38499)。[#45427](https://github.com/ClickHouse/ClickHouse/pull/45427) ([attack204](https://github.com/attack204))、Pavel Kruglov。
- 查询缓存现已可用于生产工作负载。[#47977](https://github.com/ClickHouse/ClickHouse/pull/47977) ([Robert Schulze](https://github.com/rschu1ze))。查询缓存现已支持带有 totals 和 extremes 修饰符的查询。[#48853](https://github.com/ClickHouse/ClickHouse/pull/48853) ([Robert Schulze](https://github.com/rschu1ze))。为保持向后兼容性,将 `allow_experimental_query_cache` 设置标记为已废弃。该设置已在 https://github.com/ClickHouse/ClickHouse/pull/47977 中移除。[#49934](https://github.com/ClickHouse/ClickHouse/pull/49934) ([Timur Solodovnikov](https://github.com/tsolodov))。
- 地理数据类型(`Point`、`Ring`、`Polygon` 和 `MultiPolygon`)已可用于生产环境。[#50022](https://github.com/ClickHouse/ClickHouse/pull/50022) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 为 PostgreSQL、MySQL、MeiliSearch 和 SQLite 表引擎添加模式推断功能。关闭 [#49972](https://github.com/ClickHouse/ClickHouse/issues/49972)。[#50000](https://github.com/ClickHouse/ClickHouse/pull/50000) ([Nikolay Degterinsky](https://github.com/evillique))。
- 在类似 `CREATE USER u IDENTIFIED BY 'p'` 的查询中,密码类型将根据服务器 `config.xml` 中的 `default_password_type` 设置自动设定。关闭 [#42915](https://github.com/ClickHouse/ClickHouse/issues/42915)。[#44674](https://github.com/ClickHouse/ClickHouse/pull/44674) ([Nikolay Degterinsky](https://github.com/evillique))。
- 新增 bcrypt 密码认证类型。关闭 [#34599](https://github.com/ClickHouse/ClickHouse/issues/34599)。[#44905](https://github.com/ClickHouse/ClickHouse/pull/44905) ([Nikolay Degterinsky](https://github.com/evillique))。
- 引入新关键字 `INTO OUTFILE 'file.txt' APPEND`。[#48880](https://github.com/ClickHouse/ClickHouse/pull/48880) ([alekar](https://github.com/alekar))。
- 新增 `system.zookeeper_connection` 表,显示 Keeper 连接信息。[#45245](https://github.com/ClickHouse/ClickHouse/pull/45245) ([mateng915](https://github.com/mateng0915))。
- 新增函数 `generateRandomStructure`,用于生成随机表结构。可与表函数 `generateRandom` 结合使用。[#47409](https://github.com/ClickHouse/ClickHouse/pull/47409) ([Kruglov Pavel](https://github.com/Avogar))。
- 允许使用不带 `ELSE` 分支的 `CASE`,并扩展 `transform` 以处理更多类型。同时修复了当 decimal 类型与其他数值类型混合使用时 transform() 返回错误结果的问题。[#48300](https://github.com/ClickHouse/ClickHouse/pull/48300) ([Salvatore Mesoraca](https://github.com/aiven-sal))。这解决了 #2655、#9596 和 #38666。
- 为 S3 表添加了[使用 KMS 密钥的服务器端加密](https://docs.aws.amazon.com/AmazonS3/latest/userguide/UsingKMSEncryption.html),并为 S3 磁盘添加了 `header` 设置。关闭 [#48723](https://github.com/ClickHouse/ClickHouse/issues/48723)。[#48724](https://github.com/ClickHouse/ClickHouse/pull/48724) ([Johann Gan](https://github.com/johanngan))。
- 为后台任务(合并和变更)添加 MemoryTracker。引入 `merges_mutations_memory_usage_soft_limit` 和 `merges_mutations_memory_usage_to_ram_ratio` 设置,表示合并和变更的软内存限制。如果达到此限制,ClickHouse 将不会调度新的合并或变更任务。同时引入 `MergesMutationsMemoryTracking` 指标,用于观察后台任务的当前内存使用情况。重新提交 [#46089](https://github.com/ClickHouse/ClickHouse/issues/46089)。关闭 [#48774](https://github.com/ClickHouse/ClickHouse/issues/48774)。[#48787](https://github.com/ClickHouse/ClickHouse/pull/48787) ([Dmitry Novik](https://github.com/novikd))。
- 函数 `dotProduct` 支持数组。[#49050](https://github.com/ClickHouse/ClickHouse/pull/49050) ([FFFFFFFHHHHHHH](https://github.com/FFFFFFFHHHHHHH))。
- 支持 `SHOW INDEX` 语句以提高与 MySQL 的兼容性。[#49158](https://github.com/ClickHouse/ClickHouse/pull/49158) ([Robert Schulze](https://github.com/rschu1ze))。
- 为表函数 `url` 添加虚拟列 `_file` 和 `_path` 支持。- 改进表函数 `url` 的错误消息。- 解决 [#49231](https://github.com/ClickHouse/ClickHouse/issues/49231) - 解决 [#49232](https://github.com/ClickHouse/ClickHouse/issues/49232)。[#49356](https://github.com/ClickHouse/ClickHouse/pull/49356) ([Ziyi Tan](https://github.com/Ziy1-Tan))。
- 在 users.xml 文件中添加 `grants` 字段,允许为用户指定授权。[#49381](https://github.com/ClickHouse/ClickHouse/pull/49381) ([pufit](https://github.com/pufit))。
- 使用 grace hash join 算法支持 full/right join。[#49483](https://github.com/ClickHouse/ClickHouse/pull/49483) ([lgbo](https://github.com/lgbo-ustc))。
- `WITH FILL` 修饰符按排序前缀分组填充。由 `use_with_fill_by_sorting_prefix` 设置控制(默认启用)。相关于 [#33203](https://github.com/ClickHouse/ClickHouse/issues/33203)#issuecomment-1418736794。[#49503](https://github.com/ClickHouse/ClickHouse/pull/49503) ([Igor Nikonov](https://github.com/devcrafter))。
- 当 "--query"(或 "-q")缺失时,Clickhouse-client 现已接受 "--multiquery" 后的查询。示例:clickhouse-client --multiquery "select 1; select 2;"。[#49870](https://github.com/ClickHouse/ClickHouse/pull/49870) ([Alexey Gerasimchuk](https://github.com/Demilivor))。
- 为从副本接收 Hello 数据包添加单独的 `handshake_timeout`。关闭 [#48854](https://github.com/ClickHouse/ClickHouse/issues/48854)。[#49948](https://github.com/ClickHouse/ClickHouse/pull/49948) ([Kruglov Pavel](https://github.com/Avogar))。
- 新增函数 "space",按指定次数重复空格。[#50103](https://github.com/ClickHouse/ClickHouse/pull/50103) ([Robert Schulze](https://github.com/rschu1ze))。
- 新增 --input_format_csv_trim_whitespaces 选项。[#50215](https://github.com/ClickHouse/ClickHouse/pull/50215) ([Alexey Gerasimchuk](https://github.com/Demilivor))。
- 允许正则表达式树字典的 `dictGetAll` 函数将多个匹配的值作为数组返回。关闭 [#50254](https://github.com/ClickHouse/ClickHouse/issues/50254)。[#50255](https://github.com/ClickHouse/ClickHouse/pull/50255) ([Johann Gan](https://github.com/johanngan))。
- 新增 `toLastDayOfWeek` 函数,将日期或带时间的日期向上舍入到最近的星期六或星期日。[#50315](https://github.com/ClickHouse/ClickHouse/pull/50315) ([Victor Krasnov](https://github.com/sirvickr))。
- 通过指定 `ignore_data_skipping_indices` 可忽略跳数索引。[#50329](https://github.com/ClickHouse/ClickHouse/pull/50329) ([Boris Kuschel](https://github.com/bkuschel))。
- 新增 `system.user_processes` 表和 `SHOW USER PROCESSES` 查询,用于显示用户级别的内存信息和 ProfileEvents。[#50492](https://github.com/ClickHouse/ClickHouse/pull/50492) ([János Benjamin Antal](https://github.com/antaljanosbenjamin))。
- 新增服务器和格式设置 `display_secrets_in_show_and_select`,用于显示表、数据库、表函数和字典的敏感信息。新增权限 `displaySecretsInShowAndSelect`,控制哪些用户可以查看敏感信息。[#46528](https://github.com/ClickHouse/ClickHouse/pull/46528) ([Mike Kot](https://github.com/myrrc))。
- 允许为属于某个 DATABASE 的所有表设置 ROW POLICY。[#47640](https://github.com/ClickHouse/ClickHouse/pull/47640) ([Ilya Golshtein](https://github.com/ilejn))。





#### 性能改进 {#performance-improvement-7}

- 默认压缩标记和主键。这显著减少了冷查询时间。升级说明:对压缩标记和主键的支持已在 22.9 版本中添加。如果您启用了压缩标记或主键,或安装了 23.5 或更新版本(默认启用压缩标记或主键),则无法降级到 22.8 或更早版本。您也可以通过在服务器配置文件的 `<merge_tree>` 部分中指定 `compress_marks` 和 `compress_primary_key` 设置来显式禁用压缩标记或主键。[#42587](https://github.com/ClickHouse/ClickHouse/pull/42587) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 新设置 s3_max_inflight_parts_for_one_file 用于设置单个文件范围内多部分上传请求并发加载部分的限制。[#49961](https://github.com/ClickHouse/ClickHouse/pull/49961) ([Sema Checherinda](https://github.com/CheSema))。
- 从多个文件读取时减少每个文件的并行解析线程数。解决了 [#42192](https://github.com/ClickHouse/ClickHouse/issues/42192)。[#46661](https://github.com/ClickHouse/ClickHouse/pull/46661) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
- 仅当聚合投影读取的颗粒数少于正常读取时才使用聚合投影。这有助于处理查询命中表主键但未命中投影的情况。修复了 [#49150](https://github.com/ClickHouse/ClickHouse/issues/49150)。[#49417](https://github.com/ClickHouse/ClickHouse/pull/49417) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 如果没有插入任何内容,则不在 `ANY` 哈希连接中存储块。[#48633](https://github.com/ClickHouse/ClickHouse/pull/48633) ([vdimir](https://github.com/vdimir))。
- 修复了 JIT 编译时的聚合组合器 `-If`,并为聚合函数启用 JIT 编译。关闭了 [#48120](https://github.com/ClickHouse/ClickHouse/issues/48120)。[#49083](https://github.com/ClickHouse/ClickHouse/pull/49083) ([Igor Nikonov](https://github.com/devcrafter))。
- 对于从远程表读取,我们使用较小的任务(而不是读取整个部分)以使任务窃取机制生效 _ 任务大小由要读取的列的大小决定 _ 始终使用 1MB 缓冲区从 S3 读取 \* 缓存段的边界对齐到 1MB,因此即使在小任务中它们也具有合适的大小。这也应该能防止碎片化。[#49287](https://github.com/ClickHouse/ClickHouse/pull/49287) ([Nikita Taranov](https://github.com/nickitat))。
- 引入的设置:- `merge_max_block_size_bytes` 用于限制后台操作使用的内存量。- `vertical_merge_algorithm_min_bytes_to_activate` 用于添加激活垂直合并的另一个条件。[#49313](https://github.com/ClickHouse/ClickHouse/pull/49313) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 从本地文件系统读取的读取缓冲区的默认大小更改为稍优的值。此外还引入了两个新设置:`max_read_buffer_size_local_fs` 和 `max_read_buffer_size_remote_fs`。[#49321](https://github.com/ClickHouse/ClickHouse/pull/49321) ([Nikita Taranov](https://github.com/nickitat))。
- 改进 `SPARSE_HASHED`/`HASHED` 字典的内存使用和速度(例如 `SPARSE_HASHED` 现在消耗的内存减少 2.6 倍,速度提高约 2 倍)。[#49380](https://github.com/ClickHouse/ClickHouse/pull/49380) ([Azat Khuzhin](https://github.com/azat))。
- 通过在适当时应用 `LowCardinality` 来优化 `system.query_log` 和 `system.query_thread_log` 表。对这些表的查询将更快。[#49530](https://github.com/ClickHouse/ClickHouse/pull/49530) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 读取本地 `Parquet` 文件时性能更好(通过并行读取)。[#49539](https://github.com/ClickHouse/ClickHouse/pull/49539) ([Michael Kolupaev](https://github.com/al13n321))。
- 在某些场景下将 `RIGHT/FULL JOIN` 的性能提高多达 2 倍,特别是在将小的左表与大的右表连接时。[#49585](https://github.com/ClickHouse/ClickHouse/pull/49585) ([lgbo](https://github.com/lgbo-ustc))。
- 通过为 Rust 启用 LTO 将 BLAKE3 的性能提高 11%。[#49600](https://github.com/ClickHouse/ClickHouse/pull/49600) ([Azat Khuzhin](https://github.com/azat))。现在它与 C++ 性能相当。
- 优化 `system.opentelemetry_span_log` 的结构。在适当的地方使用 `LowCardinality`。尽管这个表通常比较低效(即使对于常见属性也使用 Map 数据类型),但它会稍微好一些。[#49647](https://github.com/ClickHouse/ClickHouse/pull/49647) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 尝试在 `grace_hash` 连接中预留哈希表的大小。[#49816](https://github.com/ClickHouse/ClickHouse/pull/49816) ([lgbo](https://github.com/lgbo-ustc))。
- 并行合并 `uniqExactIf` 状态。关闭了 [#49885](https://github.com/ClickHouse/ClickHouse/issues/49885)。[#50285](https://github.com/ClickHouse/ClickHouse/pull/50285) ([flynn](https://github.com/ucasfl))。
- Keeper 改进:向 Keeper 添加 `CheckNotExists` 请求,这允许改进复制表的性能。[#48897](https://github.com/ClickHouse/ClickHouse/pull/48897) ([Antonio Andelic](https://github.com/antonio2368))。
- Keeper 性能改进:在处理时避免两次序列化相同的请求。缓存大型请求的反序列化结果。由新的协调设置 `min_request_size_for_cache` 控制。[#49004](https://github.com/ClickHouse/ClickHouse/pull/49004) ([Antonio Andelic](https://github.com/antonio2368))。
- 在选择要合并的部分且许多分区没有任何内容可合并时,减少了 `List` ZooKeeper 请求的数量。[#49637](https://github.com/ClickHouse/ClickHouse/pull/49637) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 重构 FS 缓存中的锁定 [#44985](https://github.com/ClickHouse/ClickHouse/pull/44985) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 如果可以进行简单计数优化,则禁用纯并行副本。[#50594](https://github.com/ClickHouse/ClickHouse/pull/50594) ([Raúl Marín](https://github.com/Algunenano))。
- 在 Iceberg 模式推断中不为所有键发送 head 请求,仅为用于读取数据的键发送。[#50203](https://github.com/ClickHouse/ClickHouse/pull/50203) ([Kruglov Pavel](https://github.com/Avogar))。
- 设置 `enable_memory_bound_merging_of_aggregation_results` 默认启用。[#50319](https://github.com/ClickHouse/ClickHouse/pull/50319) ([Nikita Taranov](https://github.com/nickitat))。

#### 实验性功能 {#experimental-feature-4}

- `DEFLATE_QPL` 编解码器将最低 SIMD 版本要求降低至 SSE 4.2。[qpl 文档变更](https://github.com/intel/qpl/commit/3f8f5cea27739f5261e8fd577dc233ffe88bf679) - Intel® QPL 依赖运行时内核调度器和 cpuid 检查来选择最佳可用实现(sse/avx2/avx512) - 重构了 ClickHouse 中 qpl 构建的 cmakefile 以与最新的上游 qpl 保持一致。[#49811](https://github.com/ClickHouse/ClickHouse/pull/49811) ([jasperzhu](https://github.com/jinjunzh))。
- 新增了使用纯并行副本执行 JOIN 的初步支持。[#49544](https://github.com/ClickHouse/ClickHouse/pull/49544) ([Raúl Marín](https://github.com/Algunenano))。
- 在"零拷贝复制"中移除 `Outdated` 数据分片时提升了并行度。[#49630](https://github.com/ClickHouse/ClickHouse/pull/49630) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 并行副本:1) 修复了在禁用 `parallel_replicas_for_non_replicated_merge_tree` 设置的情况下,对非复制存储使用并行副本时出现的 `NOT_FOUND_COLUMN_IN_BLOCK` 错误 2) 现在 `allow_experimental_parallel_reading_from_replicas` 有 3 个可能的值 - 0、1 和 2。0 - 禁用,1 - 启用,失败时静默禁用(在使用 FINAL 或 JOIN 的情况下),2 - 启用,失败时抛出异常。3) 如果在 SELECT 查询中使用了 FINAL 修饰符且启用了并行副本,当 `allow_experimental_parallel_reading_from_replicas` 设置为 1 时,ClickHouse 将尝试禁用并行副本,否则抛出异常。[#50195](https://github.com/ClickHouse/ClickHouse/pull/50195) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 当启用并行副本时,将始终跳过不可用的服务器(该行为由 `skip_unavailable_shards` 设置控制,默认启用且只能被禁用)。这解决了:[#48565](https://github.com/ClickHouse/ClickHouse/issues/48565)。[#50293](https://github.com/ClickHouse/ClickHouse/pull/50293) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。


#### 改进 {#improvement-7}

- The `BACKUP` command will not decrypt data from encrypted disks while making a backup. Instead the data will be stored in a backup in encrypted form. Such backups can be restored only to an encrypted disk with the same (or extended) list of encryption keys. [#48896](https://github.com/ClickHouse/ClickHouse/pull/48896) ([Vitaly Baranov](https://github.com/vitlibar)).
- Added possibility to use temporary tables in FROM part of ATTACH PARTITION FROM and REPLACE PARTITION FROM. [#49436](https://github.com/ClickHouse/ClickHouse/pull/49436) ([Roman Vasin](https://github.com/rvasin)).
- Added setting `async_insert` for `MergeTree` tables. It has the same meaning as query-level setting `async_insert` and enables asynchronous inserts for specific table. Note: it doesn't take effect for insert queries from `clickhouse-client`, use query-level setting in that case. [#49122](https://github.com/ClickHouse/ClickHouse/pull/49122) ([Anton Popov](https://github.com/CurtizJ)).
- Add support for size suffixes in quota creation statement parameters. [#49087](https://github.com/ClickHouse/ClickHouse/pull/49087) ([Eridanus](https://github.com/Eridanus117)).
- Extend `first_value` and `last_value` to accept NULL. [#46467](https://github.com/ClickHouse/ClickHouse/pull/46467) ([lgbo](https://github.com/lgbo-ustc)).
- Add alias `str_to_map` and `mapFromString` for `extractKeyValuePairs`. closes https://github.com/clickhouse/clickhouse/issues/47185. [#49466](https://github.com/ClickHouse/ClickHouse/pull/49466) ([flynn](https://github.com/ucasfl)).
- Add support for CGroup version 2 for asynchronous metrics about the memory usage and availability. This closes [#37983](https://github.com/ClickHouse/ClickHouse/issues/37983). [#45999](https://github.com/ClickHouse/ClickHouse/pull/45999) ([sichenzhao](https://github.com/sichenzhao)).
- Cluster table functions should always skip unavailable shards. close [#46314](https://github.com/ClickHouse/ClickHouse/issues/46314). [#46765](https://github.com/ClickHouse/ClickHouse/pull/46765) ([zk_kiger](https://github.com/zk-kiger)).
- Allow CSV file to contain empty columns in its header. [#47496](https://github.com/ClickHouse/ClickHouse/pull/47496) ([你不要过来啊](https://github.com/iiiuwioajdks)).
- Add Google Cloud Storage S3 compatible table function `gcs`. Like the `oss` and `cosn` functions, it is just an alias over the `s3` table function, and it does not bring any new features. [#47815](https://github.com/ClickHouse/ClickHouse/pull/47815) ([Kuba Kaflik](https://github.com/jkaflik)).
- Add ability to use strict parts size for S3 (compatibility with CloudFlare R2 S3 Storage). [#48492](https://github.com/ClickHouse/ClickHouse/pull/48492) ([Azat Khuzhin](https://github.com/azat)).
- Added new columns with info about `Replicated` database replicas to `system.clusters`: `database_shard_name`, `database_replica_name`, `is_active`. Added an optional `FROM SHARD` clause to `SYSTEM DROP DATABASE REPLICA` query. [#48548](https://github.com/ClickHouse/ClickHouse/pull/48548) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Add a new column `zookeeper_name` in system.replicas, to indicate on which (auxiliary) zookeeper cluster the replicated table's metadata is stored. [#48549](https://github.com/ClickHouse/ClickHouse/pull/48549) ([cangyin](https://github.com/cangyin)).
- `IN` operator support the comparison of `Date` and `Date32`. Closes [#48736](https://github.com/ClickHouse/ClickHouse/issues/48736). [#48806](https://github.com/ClickHouse/ClickHouse/pull/48806) ([flynn](https://github.com/ucasfl)).
- Support for erasure codes in `HDFS`, author: @M1eyu2018, @tomscut. [#48833](https://github.com/ClickHouse/ClickHouse/pull/48833) ([M1eyu](https://github.com/M1eyu2018)).
- Implement SYSTEM DROP REPLICA from auxiliary ZooKeeper clusters, may be close [#48931](https://github.com/ClickHouse/ClickHouse/issues/48931). [#48932](https://github.com/ClickHouse/ClickHouse/pull/48932) ([wangxiaobo](https://github.com/wzb5212)).
- Add Array data type to MongoDB. Closes [#48598](https://github.com/ClickHouse/ClickHouse/issues/48598). [#48983](https://github.com/ClickHouse/ClickHouse/pull/48983) ([Nikolay Degterinsky](https://github.com/evillique)).
- Support storing `Interval` data types in tables. [#49085](https://github.com/ClickHouse/ClickHouse/pull/49085) ([larryluogit](https://github.com/larryluogit)).
- Allow using `ntile` window function without explicit window frame definition: `ntile(3) OVER (ORDER BY a)`, close [#46763](https://github.com/ClickHouse/ClickHouse/issues/46763). [#49093](https://github.com/ClickHouse/ClickHouse/pull/49093) ([vdimir](https://github.com/vdimir)).
- Added settings (`number_of_mutations_to_delay`, `number_of_mutations_to_throw`) to delay or throw `ALTER` queries that create mutations (`ALTER UPDATE`, `ALTER DELETE`, `ALTER MODIFY COLUMN`, ...) in case when table already has a lot of unfinished mutations. [#49117](https://github.com/ClickHouse/ClickHouse/pull/49117) ([Anton Popov](https://github.com/CurtizJ)).
- Catch exception from `create_directories` in filesystem cache. [#49203](https://github.com/ClickHouse/ClickHouse/pull/49203) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Copies embedded examples to a new field `example` in `system.functions` to supplement the field `description`. [#49222](https://github.com/ClickHouse/ClickHouse/pull/49222) ([Dan Roscigno](https://github.com/DanRoscigno)).
- Enable connection options for the MongoDB dictionary. Example: `xml <source> <mongodb> <host>localhost</host> <port>27017</port> <user></user> <password></password> <db>test</db> <collection>dictionary_source</collection> <options>ssl=true</options> </mongodb> </source>` ### Documentation entry for user-facing changes. [#49225](https://github.com/ClickHouse/ClickHouse/pull/49225) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
- Added an alias `asymptotic` for `asymp` computational method for `kolmogorovSmirnovTest`. Improved documentation. [#49286](https://github.com/ClickHouse/ClickHouse/pull/49286) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Aggregation function groupBitAnd/Or/Xor now work on signed integer data. This makes them consistent with the behavior of scalar functions bitAnd/Or/Xor. [#49292](https://github.com/ClickHouse/ClickHouse/pull/49292) ([exmy](https://github.com/exmy)).
- Split function-documentation into more fine-granular fields. [#49300](https://github.com/ClickHouse/ClickHouse/pull/49300) ([Robert Schulze](https://github.com/rschu1ze)).
- Use multiple threads shared between all tables within a server to load outdated data parts. The the size of the pool and its queue is controlled by `max_outdated_parts_loading_thread_pool_size` and `outdated_part_loading_thread_pool_queue_size` settings. [#49317](https://github.com/ClickHouse/ClickHouse/pull/49317) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Don't overestimate the size of processed data for `LowCardinality` columns when they share dictionaries between blocks. This closes [#49322](https://github.com/ClickHouse/ClickHouse/issues/49322). See also [#48745](https://github.com/ClickHouse/ClickHouse/issues/48745). [#49323](https://github.com/ClickHouse/ClickHouse/pull/49323) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Parquet writer now uses reasonable row group size when invoked through `OUTFILE`. [#49325](https://github.com/ClickHouse/ClickHouse/pull/49325) ([Michael Kolupaev](https://github.com/al13n321)).
- Allow restricted keywords like `ARRAY` as an alias if the alias is quoted. Closes [#49324](https://github.com/ClickHouse/ClickHouse/issues/49324). [#49360](https://github.com/ClickHouse/ClickHouse/pull/49360) ([Nikolay Degterinsky](https://github.com/evillique)).
- Data parts loading and deletion jobs were moved to shared server-wide pools instead of per-table pools. Pools sizes are controlled via settings `max_active_parts_loading_thread_pool_size`, `max_outdated_parts_loading_thread_pool_size` and `max_parts_cleaning_thread_pool_size` in top-level config. Table-level settings `max_part_loading_threads` and `max_part_removal_threads` became obsolete. [#49474](https://github.com/ClickHouse/ClickHouse/pull/49474) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Allow `?password=pass` in URL of the Play UI. Password is replaced in browser history. [#49505](https://github.com/ClickHouse/ClickHouse/pull/49505) ([Mike Kot](https://github.com/myrrc)).
- Allow reading zero-size objects from remote filesystems. (because empty files are not backup'd, so we might end up with zero blobs in metadata file). Closes [#49480](https://github.com/ClickHouse/ClickHouse/issues/49480). [#49519](https://github.com/ClickHouse/ClickHouse/pull/49519) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Attach thread MemoryTracker to `total_memory_tracker` after `ThreadGroup` detached. [#49527](https://github.com/ClickHouse/ClickHouse/pull/49527) ([Dmitry Novik](https://github.com/novikd)).
- Fix parameterized views when a query parameter is used multiple times in the query. [#49556](https://github.com/ClickHouse/ClickHouse/pull/49556) ([Azat Khuzhin](https://github.com/azat)).
- Release memory allocated for the last sent ProfileEvents snapshot in the context of a query. Followup [#47564](https://github.com/ClickHouse/ClickHouse/issues/47564). [#49561](https://github.com/ClickHouse/ClickHouse/pull/49561) ([Dmitry Novik](https://github.com/novikd)).
- Function "makeDate" now provides a MySQL-compatible overload (year & day of the year argument). [#49603](https://github.com/ClickHouse/ClickHouse/pull/49603) ([Robert Schulze](https://github.com/rschu1ze)).
- Support `dictionary` table function for `RegExpTreeDictionary`. [#49666](https://github.com/ClickHouse/ClickHouse/pull/49666) ([Han Fei](https://github.com/hanfei1991)).
- Added weighted fair IO scheduling policy. Added dynamic resource manager, which allows IO scheduling hierarchy to be updated in runtime w/o server restarts. [#49671](https://github.com/ClickHouse/ClickHouse/pull/49671) ([Sergei Trifonov](https://github.com/serxa)).
- Add compose request after multipart upload to GCS. This enables the usage of copy operation on objects uploaded with the multipart upload. It's recommended to set `s3_strict_upload_part_size` to some value because compose request can fail on objects created with parts of different sizes. [#49693](https://github.com/ClickHouse/ClickHouse/pull/49693) ([Antonio Andelic](https://github.com/antonio2368)).
- For the `extractKeyValuePairs` function: improve the "best-effort" parsing logic to accept `key_value_delimiter` as a valid part of the value. This also simplifies branching and might even speed up things a bit. [#49760](https://github.com/ClickHouse/ClickHouse/pull/49760) ([Arthur Passos](https://github.com/arthurpassos)).
- Add `initial_query_id` field for system.processors_profile_log [#49777](https://github.com/ClickHouse/ClickHouse/pull/49777) ([helifu](https://github.com/helifu)).
- System log tables can now have custom sorting keys. [#49778](https://github.com/ClickHouse/ClickHouse/pull/49778) ([helifu](https://github.com/helifu)).
- A new field `partitions` to `system.query_log` is used to indicate which partitions are participating in the calculation. [#49779](https://github.com/ClickHouse/ClickHouse/pull/49779) ([helifu](https://github.com/helifu)).
- Added `enable_the_endpoint_id_with_zookeeper_name_prefix` setting for `ReplicatedMergeTree` (disabled by default). When enabled, it adds ZooKeeper cluster name to table's interserver communication endpoint. It avoids `Duplicate interserver IO endpoint` errors when having replicated tables with the same path, but different auxiliary ZooKeepers. [#49780](https://github.com/ClickHouse/ClickHouse/pull/49780) ([helifu](https://github.com/helifu)).
- Add query parameters to `clickhouse-local`. Closes [#46561](https://github.com/ClickHouse/ClickHouse/issues/46561). [#49785](https://github.com/ClickHouse/ClickHouse/pull/49785) ([Nikolay Degterinsky](https://github.com/evillique)).
- Allow loading dictionaries and functions from YAML by default. In previous versions, it required editing the `dictionaries_config` or `user_defined_executable_functions_config` in the configuration file, as they expected `*.xml` files. [#49812](https://github.com/ClickHouse/ClickHouse/pull/49812) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- The Kafka table engine now allows to use alias columns. [#49824](https://github.com/ClickHouse/ClickHouse/pull/49824) ([Aleksandr Musorin](https://github.com/AVMusorin)).
- Add setting to limit the max number of pairs produced by `extractKeyValuePairs`, a safeguard to avoid using way too much memory. [#49836](https://github.com/ClickHouse/ClickHouse/pull/49836) ([Arthur Passos](https://github.com/arthurpassos)).
- Add support for (an unusual) case where the arguments in the `IN` operator are single-element tuples. [#49844](https://github.com/ClickHouse/ClickHouse/pull/49844) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
- `bitHammingDistance` function support `String` and `FixedString` data type. Closes [#48827](https://github.com/ClickHouse/ClickHouse/issues/48827). [#49858](https://github.com/ClickHouse/ClickHouse/pull/49858) ([flynn](https://github.com/ucasfl)).
- Fix timeout resetting errors in the client on OS X. [#49863](https://github.com/ClickHouse/ClickHouse/pull/49863) ([alekar](https://github.com/alekar)).
- Add support for big integers, such as UInt128, Int128, UInt256, and Int256 in the function `bitCount`. This enables Hamming distance over large bit masks for AI applications. [#49867](https://github.com/ClickHouse/ClickHouse/pull/49867) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fingerprints to be used instead of key IDs in encrypted disks. This simplifies the configuration of encrypted disks. [#49882](https://github.com/ClickHouse/ClickHouse/pull/49882) ([Vitaly Baranov](https://github.com/vitlibar)).
- Add UUID data type to PostgreSQL. Closes [#49739](https://github.com/ClickHouse/ClickHouse/issues/49739). [#49894](https://github.com/ClickHouse/ClickHouse/pull/49894) ([Nikolay Degterinsky](https://github.com/evillique)).
- Function `toUnixTimestamp` now accepts `Date` and `Date32` arguments. [#49989](https://github.com/ClickHouse/ClickHouse/pull/49989) ([Victor Krasnov](https://github.com/sirvickr)).
- Charge only server memory for dictionaries. [#49995](https://github.com/ClickHouse/ClickHouse/pull/49995) ([Azat Khuzhin](https://github.com/azat)).
- The server will allow using the `SQL_*` settings such as `SQL_AUTO_IS_NULL` as no-ops for MySQL compatibility. This closes [#49927](https://github.com/ClickHouse/ClickHouse/issues/49927). [#50013](https://github.com/ClickHouse/ClickHouse/pull/50013) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Preserve initial_query_id for ON CLUSTER queries, which is useful for introspection (under `distributed_ddl_entry_format_version=5`). [#50015](https://github.com/ClickHouse/ClickHouse/pull/50015) ([Azat Khuzhin](https://github.com/azat)).
- Preserve backward incompatibility for renamed settings by using aliases (`allow_experimental_projection_optimization` for `optimize_use_projections`, `allow_experimental_lightweight_delete` for `enable_lightweight_delete`). [#50044](https://github.com/ClickHouse/ClickHouse/pull/50044) ([Azat Khuzhin](https://github.com/azat)).
- Support passing FQDN through setting my_hostname to register cluster node in keeper. Add setting of invisible to support multi compute groups. A compute group as a cluster, is invisible to other compute groups. [#50186](https://github.com/ClickHouse/ClickHouse/pull/50186) ([Yangkuan Liu](https://github.com/LiuYangkuan)).
- Fix PostgreSQL reading all the data even though `LIMIT n` could be specified. [#50187](https://github.com/ClickHouse/ClickHouse/pull/50187) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Add new profile events for queries with subqueries (`QueriesWithSubqueries`/`SelectQueriesWithSubqueries`/`InsertQueriesWithSubqueries`). [#50204](https://github.com/ClickHouse/ClickHouse/pull/50204) ([Azat Khuzhin](https://github.com/azat)).
- Adding the roles field in the users.xml file, which allows specifying roles with grants via a config file. [#50278](https://github.com/ClickHouse/ClickHouse/pull/50278) ([pufit](https://github.com/pufit)).
- Report `CGroupCpuCfsPeriod` and `CGroupCpuCfsQuota` in AsynchronousMetrics. - Respect cgroup v2 memory limits during server startup. [#50379](https://github.com/ClickHouse/ClickHouse/pull/50379) ([alekar](https://github.com/alekar)).
- Add a signal handler for SIGQUIT to work the same way as SIGINT. Closes [#50298](https://github.com/ClickHouse/ClickHouse/issues/50298). [#50435](https://github.com/ClickHouse/ClickHouse/pull/50435) ([Nikolay Degterinsky](https://github.com/evillique)).
- In case JSON parse fails due to the large size of the object output the last position to allow debugging. [#50474](https://github.com/ClickHouse/ClickHouse/pull/50474) ([Valentin Alexeev](https://github.com/valentinalexeev)).
- Support decimals with not fixed size. Closes [#49130](https://github.com/ClickHouse/ClickHouse/issues/49130). [#50586](https://github.com/ClickHouse/ClickHouse/pull/50586) ([Kruglov Pavel](https://github.com/Avogar)).





#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-7}

- 新增并改进了 `keeper-bench`。所有内容都可以通过 YAML/XML 文件进行自定义:- 请求生成器 - 每种类型的请求生成器可以有特定的字段集 - 只需在 `multi` 键下执行相同操作即可生成多请求 - 对于 multi 中的每个请求或子请求,可以定义 `weight` 字段来控制分布 - 定义测试运行所需设置的树结构 - 可以定义主机并自定义所有超时设置,还可以控制为每个主机生成多少个会话 - 使用 `min_value` 和 `max_value` 字段定义的整数是随机数生成器。 [#48547](https://github.com/ClickHouse/ClickHouse/pull/48547) ([Antonio Andelic](https://github.com/antonio2368)).
- io_uring 在 macOS 上不受支持,在本地运行测试时不要选择它以避免偶发故障。 [#49250](https://github.com/ClickHouse/ClickHouse/pull/49250) ([Frank Chen](https://github.com/FrankChen021)).
- 支持用于测试的命名故障注入。 [#49361](https://github.com/ClickHouse/ClickHouse/pull/49361) ([Han Fei](https://github.com/hanfei1991)).
- 允许在不支持 `prctl`(进程控制)系统调用的操作系统中运行 ClickHouse,例如 AWS Lambda。 [#49538](https://github.com/ClickHouse/ClickHouse/pull/49538) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- 修复了 contrib/isa-l 与 qpl 中 isa-l 之间的构建冲突问题 [49296](https://github.com/ClickHouse/ClickHouse/issues/49296)。 [#49584](https://github.com/ClickHouse/ClickHouse/pull/49584) ([jasperzhu](https://github.com/jinjunzh)).
- 实用工具现在仅在明确请求时("-DENABLE_UTILS=1")才会构建,而不是默认构建,这减少了典型开发构建中的链接时间。 [#49620](https://github.com/ClickHouse/ClickHouse/pull/49620) ([Robert Schulze](https://github.com/rschu1ze)).
- 将 idxd-config 的构建描述提取到单独的 CMake 文件中,以避免将来意外删除。 [#49651](https://github.com/ClickHouse/ClickHouse/pull/49651) ([jasperzhu](https://github.com/jinjunzh)).
- 在主分支中添加启用分析器的 CI 检查。后续 [#49562](https://github.com/ClickHouse/ClickHouse/issues/49562)。 [#49668](https://github.com/ClickHouse/ClickHouse/pull/49668) ([Dmitry Novik](https://github.com/novikd)).
- 切换到 LLVM/clang 16。 [#49678](https://github.com/ClickHouse/ClickHouse/pull/49678) ([Azat Khuzhin](https://github.com/azat)).
- 允许使用 clang-17 构建 ClickHouse。 [#49851](https://github.com/ClickHouse/ClickHouse/pull/49851) ([Alexey Milovidov](https://github.com/alexey-milovidov)). [#50410](https://github.com/ClickHouse/ClickHouse/pull/50410) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- ClickHouse 现在更容易集成到其他 cmake 项目中。 [#49991](https://github.com/ClickHouse/ClickHouse/pull/49991) ([Amos Bird](https://github.com/amosbird)). (强烈不建议这样做 - Alexey Milovidov)。
- 修复了 [#47151](https://github.com/ClickHouse/ClickHouse/issues/47151) 之后出现的奇怪的额外 QEMU 日志记录,参见 https://s3.amazonaws.com/clickhouse-test-reports/50078/a4743996ee4f3583884d07bcd6501df0cfdaa346/stateless_tests__release__databasereplicated__[3_4].html。 [#50442](https://github.com/ClickHouse/ClickHouse/pull/50442) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- ClickHouse 可以在 Linux RISC-V 6.1.22 上运行。这解决了 [#50456](https://github.com/ClickHouse/ClickHouse/issues/50456)。 [#50457](https://github.com/ClickHouse/ClickHouse/pull/50457) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- 将内部 protobuf 升级到 v3.18(修复了虚假的 CVE-2022-1941)。 [#50400](https://github.com/ClickHouse/ClickHouse/pull/50400) ([Robert Schulze](https://github.com/rschu1ze)).
- 将内部 libxml2 升级到 v2.10.4(修复了虚假的 CVE-2023-28484 和虚假的 CVE-2023-29469)。 [#50402](https://github.com/ClickHouse/ClickHouse/pull/50402) ([Robert Schulze](https://github.com/rschu1ze)).
- 将 c-ares 升级到 v1.19.1(虚假的 CVE-2023-32067、虚假的 CVE-2023-31130、虚假的 CVE-2023-31147)。 [#50403](https://github.com/ClickHouse/ClickHouse/pull/50403) ([Robert Schulze](https://github.com/rschu1ze)).
- 修复 libgsasl 中虚假的 CVE-2022-2469。 [#50404](https://github.com/ClickHouse/ClickHouse/pull/50404) ([Robert Schulze](https://github.com/rschu1ze)).

#### 错误修复(官方稳定版本中用户可见的异常行为) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-7}


* ActionsDAG：修复不正确的优化 [#47584](https://github.com/ClickHouse/ClickHouse/pull/47584)（[Salvatore Mesoraca](https://github.com/aiven-sal)）。
* 在 Keeper 中正确处理并行快照 [#48466](https://github.com/ClickHouse/ClickHouse/pull/48466)（[Antonio Andelic](https://github.com/antonio2368)）。
* MergeTreeMarksLoader 现在持有 DataPart 而不是 DataPartStorage [#48515](https://github.com/ClickHouse/ClickHouse/pull/48515)（[SmitaRKulkarni](https://github.com/SmitaRKulkarni)）。
* 修复序列状态 [#48603](https://github.com/ClickHouse/ClickHouse/pull/48603)（[Ilya Golshtein](https://github.com/ilejn)）。
* 在先前失败后执行回退/恢复并发检查 [#48726](https://github.com/ClickHouse/ClickHouse/pull/48726)（[SmitaRKulkarni](https://github.com/SmitaRKulkarni)）。
* 修复附加具有不存在的 ZK 路径的表时不会增加 ReadonlyReplica 指标的问题 [#48954](https://github.com/ClickHouse/ClickHouse/pull/48954) ([wangxiaobo](https://github.com/wzb5212))。
* 修复某些情况下因未捕获异常而可能调用 `terminate` 的问题 [#49112](https://github.com/ClickHouse/ClickHouse/pull/49112) ([Kruglov Pavel](https://github.com/Avogar))。
* 修复在包含多个 `StorageJoin` 的查询中出现的“键未找到”错误 [#49137](https://github.com/ClickHouse/ClickHouse/pull/49137)（[vdimir](https://github.com/vdimir)）。
* 修复在使用可为空主键时出现错误查询结果的问题 [#49172](https://github.com/ClickHouse/ClickHouse/pull/49172)（[Duc Canh Le](https://github.com/canhld94)）。
* 在大端序机器上修复 reinterpretAs*() [#49198](https://github.com/ClickHouse/ClickHouse/pull/49198)（[Suzy Wang](https://github.com/SuzyWangIBMer)）。
* （实验性零拷贝复制）以更高原子性锁定零拷贝数据块 [#49211](https://github.com/ClickHouse/ClickHouse/pull/49211) ([alesapin](https://github.com/alesapin))。
* 修复加载过期分片时的竞态条件 [#49223](https://github.com/ClickHouse/ClickHouse/pull/49223) ([Alexander Tokmakov](https://github.com/tavplubix))。
* 修复在所有键值为 null 且分组使用 ROLLUP 时返回错误结果的问题 [#49282](https://github.com/ClickHouse/ClickHouse/pull/49282) ([Shuai li](https://github.com/loneylee))。
* 修复带有 SHARDS 的 HASHED 字典的 `load_factor` 计算问题 [#49319](https://github.com/ClickHouse/ClickHouse/pull/49319)（[Azat Khuzhin](https://github.com/azat)）。
* 禁止为别名列配置压缩 `CODEC` [#49363](https://github.com/ClickHouse/ClickHouse/pull/49363)（[Timur Solodovnikov](https://github.com/tsolodov)）。
* 修复删除已存在 part 目录时的错误 [#49365](https://github.com/ClickHouse/ClickHouse/pull/49365) ([alesapin](https://github.com/alesapin))。
* 在使用 HMAC 时正确处理 GCS [#49390](https://github.com/ClickHouse/ClickHouse/pull/49390)（[Antonio Andelic](https://github.com/antonio2368)）。
* 修复了在通过 `remote()` 读取时未构建子查询集合的模糊测试缺陷 [#49425](https://github.com/ClickHouse/ClickHouse/pull/49425) ([Alexander Gololobov](https://github.com/davenger))。
* 反转 `shutdown_wait_unfinished_queries` 设置 [#49427](https://github.com/ClickHouse/ClickHouse/pull/49427)（[Konstantin Bogdanov](https://github.com/thevar1able)）。
* （实验性零拷贝复制）修复另一个零拷贝相关错误 [#49473](https://github.com/ClickHouse/ClickHouse/pull/49473) ([alesapin](https://github.com/alesapin))。
* 修复 PostgreSQL 数据库设置 [#49481](https://github.com/ClickHouse/ClickHouse/pull/49481)（[Mal Curtis](https://github.com/snikch)）。
* 正确处理 `s3Cluster` 参数 [#49490](https://github.com/ClickHouse/ClickHouse/pull/49490)（[Antonio Andelic](https://github.com/antonio2368)）。
* 修复 `TraceCollector` 析构函数中的缺陷。[#49508](https://github.com/ClickHouse/ClickHouse/pull/49508)（[Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)）。
* 修复 AsynchronousReadIndirectBufferFromRemoteFS 在短距离 seek 时出错的问题 [#49525](https://github.com/ClickHouse/ClickHouse/pull/49525) ([Michael Kolupaev](https://github.com/al13n321))。
* 修复字典的加载顺序 [#49560](https://github.com/ClickHouse/ClickHouse/pull/49560) ([Alexander Tokmakov](https://github.com/tavplubix)).
* 禁止修改 Object(&#39;json&#39;) 列的数据类型 [#49563](https://github.com/ClickHouse/ClickHouse/pull/49563) ([Nikolay Degterinsky](https://github.com/evillique))。
* 修复压力测试（逻辑错误：期望 7134 &gt;= 11030）[#49623](https://github.com/ClickHouse/ClickHouse/pull/49623)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复 `DISTINCT` 中的缺陷 [#49628](https://github.com/ClickHouse/ClickHouse/pull/49628)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 修复：在按 `DISTINCT` 排序时，非排序列中的零值导致的问题 [#49636](https://github.com/ClickHouse/ClickHouse/pull/49636)（[Igor Nikonov](https://github.com/devcrafter)）。
* 修复了 UBSan 结合模糊测试发现的大整数中的 off-by-one 错误 [#49645](https://github.com/ClickHouse/ClickHouse/pull/49645)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 修复重启后从稀疏列读取的数据问题 [#49660](https://github.com/ClickHouse/ClickHouse/pull/49660) ([Anton Popov](https://github.com/CurtizJ))。
* 修复在使用 fibers 时 `SpanHolder::finish()` 中的断言 [#49673](https://github.com/ClickHouse/ClickHouse/pull/49673)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复带稀疏参数的短路函数和变更操作 [#49716](https://github.com/ClickHouse/ClickHouse/pull/49716) ([Anton Popov](https://github.com/CurtizJ))。
* 修复将追加写入的文件保存到增量备份中的问题 [#49725](https://github.com/ClickHouse/ClickHouse/pull/49725) ([Vitaly Baranov](https://github.com/vitlibar))。
* 修复在包含 Object 列的表上执行轻量级删除变更时出现的 “There is no physical column &#95;row&#95;exists in table” 错误。[#49737](https://github.com/ClickHouse/ClickHouse/pull/49737) ([Alexander Gololobov](https://github.com/davenger))。
* 修复 `randomStringUTF8`（奇数长度）中的 msan 问题 [#49750](https://github.com/ClickHouse/ClickHouse/pull/49750)（[Robert Schulze](https://github.com/rschu1ze)）。
* 修复聚合函数 `kolmogorovSmirnovTest` [#49768](https://github.com/ClickHouse/ClickHouse/pull/49768)（[FFFFFFFHHHHHHH](https://github.com/FFFFFFFHHHHHHH)）。
* 修复原生协议中的设置项别名 [#49776](https://github.com/ClickHouse/ClickHouse/pull/49776) ([Azat Khuzhin](https://github.com/azat))。
* 修复在由单元素元组组成的数组上使用 `arrayMap` 的问题 [#49789](https://github.com/ClickHouse/ClickHouse/pull/49789)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复按查询设置的 IO/BACKUP 限流配置 [#49797](https://github.com/ClickHouse/ClickHouse/pull/49797) ([Azat Khuzhin](https://github.com/azat))。
* 修复在配置文件定义中设置 NULL 的问题 [#49831](https://github.com/ClickHouse/ClickHouse/pull/49831) ([Vitaly Baranov](https://github.com/vitlibar))。
* 修复了与投影及 `aggregate&#95;functions&#95;null&#95;for&#95;empty` 设置（用于 `query&#95;plan&#95;optimize&#95;projection`）相关的一个错误 [#49873](https://github.com/ClickHouse/ClickHouse/pull/49873) ([Amos Bird](https://github.com/amosbird))。
* 修复重启后 Distributed 异步 `INSERT` 未处理挂起批次的问题 [#49884](https://github.com/ClickHouse/ClickHouse/pull/49884) ([Azat Khuzhin](https://github.com/azat))。
* 修复 `CacheMetadata::doCleanup` 中的断言问题 [#49914](https://github.com/ClickHouse/ClickHouse/pull/49914)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复 `OptimizeRegularExpression` 中的 `is_prefix`。[#49919](https://github.com/ClickHouse/ClickHouse/pull/49919)（[Han Fei](https://github.com/hanfei1991)）。
* 修复指标 `WriteBufferFromS3Bytes`、`WriteBufferFromS3Microseconds` 和 `WriteBufferFromS3RequestsErrors` [#49930](https://github.com/ClickHouse/ClickHouse/pull/49930)（[Aleksandr Musorin](https://github.com/AVMusorin)）。
* 修复 protobuf 中的 IPv6 编码问题 [#49933](https://github.com/ClickHouse/ClickHouse/pull/49933) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* 修复在文本格式中对 `Nullable` 的错误解析可能导致的逻辑错误 [#49960](https://github.com/ClickHouse/ClickHouse/pull/49960)（[Kruglov Pavel](https://github.com/Avogar)）。
* 添加设置 `output_format_parquet_compliant_nested_types`，以生成与 Parquet 更加兼容的文件 [#50001](https://github.com/ClickHouse/ClickHouse/pull/50001)（[Michael Kolupaev](https://github.com/al13n321)）。
* 修复压力测试中“Not enough space to add ...”的逻辑错误 [#50021](https://github.com/ClickHouse/ClickHouse/pull/50021) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 避免在 `ReplicatedMergeTree` 的 attach 线程中启动表时发生死锁 [#50026](https://github.com/ClickHouse/ClickHouse/pull/50026)（[Antonio Andelic](https://github.com/antonio2368)）。
* 第二次尝试修复在 fibers 中使用的 SpanHolder::finish() 的断言 [#50034](https://github.com/ClickHouse/ClickHouse/pull/50034) ([Kruglov Pavel](https://github.com/Avogar)).
* 为 DDL OpenTelemetry 上下文序列化添加正确的转义 [#50045](https://github.com/ClickHouse/ClickHouse/pull/50045) ([Azat Khuzhin](https://github.com/azat))。
* 修复损坏投影数据片段的报表 [#50052](https://github.com/ClickHouse/ClickHouse/pull/50052) ([Amos Bird](https://github.com/amosbird))。
* 修复 JIT 编译中“不等于 NaN”的问题 [#50056](https://github.com/ClickHouse/ClickHouse/pull/50056) ([Maksim Kita](https://github.com/kitaisreal)).
* 修复在未提供参数的 Replicated 数据库情况下出现的崩溃问题 [#50058](https://github.com/ClickHouse/ClickHouse/pull/50058) ([Azat Khuzhin](https://github.com/azat))。
* 修复在 `multiIf` 中使用常量条件和可空参数时发生的崩溃 [#50123](https://github.com/ClickHouse/ClickHouse/pull/50123)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复针对日期相关键的无效索引分析 [#50153](https://github.com/ClickHouse/ClickHouse/pull/50153) ([Amos Bird](https://github.com/amosbird))。
* 在没有 `ORDER BY` 列时，不允许修改 `ORDER BY` [#50154](https://github.com/ClickHouse/ClickHouse/pull/50154) ([Han Fei](https://github.com/hanfei1991)).
* 修复当二元运算符包含 `NULL` 常量参数时的错误索引分析 [#50177](https://github.com/ClickHouse/ClickHouse/pull/50177)（[Amos Bird](https://github.com/amosbird)）。
* clickhouse-client：不允许同时使用 `--query` 和 `--queries-file` [#50210](https://github.com/ClickHouse/ClickHouse/pull/50210)（[Alexey Gerasimchuk](https://github.com/Demilivor)）。
* 修复 `INTO OUTFILE` 扩展（`APPEND` / `AND STDOUT`）和 `WATCH EVENTS` 的未定义行为（UB）[#50216](https://github.com/ClickHouse/ClickHouse/pull/50216)（[Azat Khuzhin](https://github.com/azat)）。
* 修复 `CustomSeparatedIgnoreSpaces` 格式在行尾跳过空格的行为 [#50224](https://github.com/ClickHouse/ClickHouse/pull/50224) ([Kruglov Pavel](https://github.com/Avogar))。
* 修复 Iceberg 元数据解析 [#50232](https://github.com/ClickHouse/ClickHouse/pull/50232) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 修复 `WITH` 子句中嵌套的分布式 `SELECT` 查询 [#50234](https://github.com/ClickHouse/ClickHouse/pull/50234)（[Azat Khuzhin](https://github.com/azat)）。
* 修复 keyed SipHash 中的 msan 问题 [#50245](https://github.com/ClickHouse/ClickHouse/pull/50245) ([Robert Schulze](https://github.com/rschu1ze)).
* 修复 Poco 套接字在非阻塞模式下的缺陷，改为使用真正的非阻塞套接字 [#50252](https://github.com/ClickHouse/ClickHouse/pull/50252) ([Kruglov Pavel](https://github.com/Avogar))。
* 修复备份项的校验和计算 [#50264](https://github.com/ClickHouse/ClickHouse/pull/50264) ([Vitaly Baranov](https://github.com/vitlibar))。
* 修复比较函数对 NaN 的处理 [#50287](https://github.com/ClickHouse/ClickHouse/pull/50287) ([Maksim Kita](https://github.com/kitaisreal)).
* 修复 JIT 聚合中可为空键的问题 [#50291](https://github.com/ClickHouse/ClickHouse/pull/50291) ([Maksim Kita](https://github.com/kitaisreal)).
* 修复在写入空 Arrow 或 Parquet 输出时导致 clickhouse-local 崩溃的问题 [#50328](https://github.com/ClickHouse/ClickHouse/pull/50328) ([Michael Kolupaev](https://github.com/al13n321))。
* 修复在调用 Pool::Entry::disconnect() 时出现的崩溃 [#50334](https://github.com/ClickHouse/ClickHouse/pull/50334)（[Val Doroshchuk](https://github.com/valbok)）。
* 通过延长目录锁持有时间改进了 fetch part [#50339](https://github.com/ClickHouse/ClickHouse/pull/50339) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
* 修复在两个参数均为常量时的 `bitShift*` 函数行为 [#50343](https://github.com/ClickHouse/ClickHouse/pull/50343)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复在预处理请求时遇到异常导致的 Keeper 死锁问题。[#50387](https://github.com/ClickHouse/ClickHouse/pull/50387) ([frinkr](https://github.com/frinkr))。
* 修复对 const 整型常量的哈希处理 [#50421](https://github.com/ClickHouse/ClickHouse/pull/50421)（[Robert Schulze](https://github.com/rschu1ze)）。
* 修复数据跳过索引的 merge&#95;tree&#95;min&#95;rows&#95;for&#95;seek/merge&#95;tree&#95;min&#95;bytes&#95;for&#95;seek 设置 [#50432](https://github.com/ClickHouse/ClickHouse/pull/50432) ([Azat Khuzhin](https://github.com/azat))。
* 限制加载过期数据部分的在途任务数量 [#50450](https://github.com/ClickHouse/ClickHouse/pull/50450) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Keeper 修复：在安装快照后应用未提交的状态 [#50483](https://github.com/ClickHouse/ClickHouse/pull/50483) ([Antonio Andelic](https://github.com/antonio2368))。
* 修复错误的常量折叠 [#50536](https://github.com/ClickHouse/ClickHouse/pull/50536) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* 修复压力测试中的逻辑错误（“空间不足，无法添加 ...”）[#50583](https://github.com/ClickHouse/ClickHouse/pull/50583)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在 `values` 表函数中将 `Null` 转换为 `LowCardinality(Nullable)` 的行为 [#50637](https://github.com/ClickHouse/ClickHouse/pull/50637)（[Kruglov Pavel](https://github.com/Avogar)）。
* 回滚无效的 RegExpTreeDictionary 优化 [#50642](https://github.com/ClickHouse/ClickHouse/pull/50642)（[Johann Gan](https://github.com/johanngan)）。

### <a id="234"></a> ClickHouse 版本 23.4, 2023-04-26 {#234}

#### 向后不兼容变更 {#backward-incompatible-change-7}

- 函数 formatDateTime() 中的格式化符 '%M' 现在输出月份名称而非分钟数。此变更使其行为与 MySQL 保持一致。可通过设置 "formatdatetime_parsedatetime_m_is_month_name = 0" 恢复原有行为。[#47246](https://github.com/ClickHouse/ClickHouse/pull/47246) ([Robert Schulze](https://github.com/rschu1ze))。
- 此变更仅在使用虚拟文件系统缓存时适用。如果虚拟文件系统缓存配置中的 `path` 非空且不是绝对路径,则会被放置在 `<clickhouse server data directory>/caches/<path_from_cache_config>` 目录下。[#48784](https://github.com/ClickHouse/ClickHouse/pull/48784) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 现在会拒绝具有相同表达式的主索引/辅助索引和排序键。可通过设置 `allow_suspicious_indices` 禁用此行为。[#48536](https://github.com/ClickHouse/ClickHouse/pull/48536) ([凌涛](https://github.com/lingtaolf))。


#### 新功能 {#new-feature-8}

- 支持新的聚合函数 `quantileGK`/`quantilesGK`,类似于 Spark 中的 [approx_percentile](https://spark.apache.org/docs/latest/api/sql/index.html#approx_percentile)。Greenwald-Khanna 算法参见 http://infolab.stanford.edu/~datar/courses/cs361a/papers/quantiles.pdf。[#46428](https://github.com/ClickHouse/ClickHouse/pull/46428) ([李扬](https://github.com/taiyang-li))。
- 添加 `SHOW COLUMNS` 语句,用于显示 system.columns 表的精简信息。[#48017](https://github.com/ClickHouse/ClickHouse/pull/48017) ([Robert Schulze](https://github.com/rschu1ze))。
- 为 `SYSTEM SYNC REPLICA` 查询添加了 `LIGHTWEIGHT` 和 `PULL` 修饰符。`LIGHTWEIGHT` 版本仅等待数据拉取和范围删除操作(忽略合并和变更)。`PULL` 版本从 ZooKeeper 拉取新条目但不等待其完成。修复 [#47794](https://github.com/ClickHouse/ClickHouse/issues/47794)。[#48085](https://github.com/ClickHouse/ClickHouse/pull/48085) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 添加 `kafkaMurmurHash` 函数以兼容 Kafka DefaultPartitioner。关闭 [#47834](https://github.com/ClickHouse/ClickHouse/issues/47834)。[#48185](https://github.com/ClickHouse/ClickHouse/pull/48185) ([Nikolay Degterinsky](https://github.com/evillique))。
- 允许使用 `GRANT CURRENT GRANTS` 轻松创建具有与当前用户相同授权的用户。[#48262](https://github.com/ClickHouse/ClickHouse/pull/48262) ([pufit](https://github.com/pufit))。
- 添加统计聚合函数 `kolmogorovSmirnovTest`。关闭 [#48228](https://github.com/ClickHouse/ClickHouse/issues/48228)。[#48325](https://github.com/ClickHouse/ClickHouse/pull/48325) ([FFFFFFFHHHHHHH](https://github.com/FFFFFFFHHHHHHH))。
- 在 `system.replicas` 表中添加了 `lost_part_count` 列。该列值显示相应表中丢失数据分片的总数。该值存储在 ZooKeeper 中,可用于监控以替代非持久化的 `ReplicatedDataLoss` 性能事件。[#48526](https://github.com/ClickHouse/ClickHouse/pull/48526) ([Sergei Trifonov](https://github.com/serxa))。
- 添加 `soundex` 函数以提供兼容性。关闭 [#39880](https://github.com/ClickHouse/ClickHouse/issues/39880)。[#48567](https://github.com/ClickHouse/ClickHouse/pull/48567) ([FriendLey](https://github.com/FriendLey))。
- 支持 JSONExtract 的 `Map` 类型。[#48629](https://github.com/ClickHouse/ClickHouse/pull/48629) ([李扬](https://github.com/taiyang-li))。
- 添加 `PrettyJSONEachRow` 格式,用于输出带有换行分隔符和 4 空格缩进的美化 JSON。[#48898](https://github.com/ClickHouse/ClickHouse/pull/48898) ([Kruglov Pavel](https://github.com/Avogar))。
- 添加 `ParquetMetadata` 输入格式以读取 Parquet 文件元数据。[#48911](https://github.com/ClickHouse/ClickHouse/pull/48911) ([Kruglov Pavel](https://github.com/Avogar))。
- 添加 `extractKeyValuePairs` 函数以从字符串中提取键值对。输入字符串可能包含噪声(例如日志文件/不需要 100% 格式化为键值对格式),该算法将查找与传递给函数的参数匹配的键值对。目前,该函数接受以下参数:`data_column`(必需)、`key_value_pair_delimiter`(默认为 `:`)、`pair_delimiters`(默认为 `\space \, \;`)和 `quoting_character`(默认为双引号)。[#43606](https://github.com/ClickHouse/ClickHouse/pull/43606) ([Arthur Passos](https://github.com/arthurpassos))。
- 函数 replaceOne()、replaceAll()、replaceRegexpOne() 和 replaceRegexpAll() 现在可以使用非常量的模式和替换参数进行调用。[#46589](https://github.com/ClickHouse/ClickHouse/pull/46589) ([Robert Schulze](https://github.com/rschu1ze))。
- 添加了用于处理 `Map` 类型列的函数:`mapConcat`、`mapSort`、`mapExists`。[#48071](https://github.com/ClickHouse/ClickHouse/pull/48071) ([Anton Popov](https://github.com/CurtizJ))。

#### 性能改进 {#performance-improvement-8}

- 读取 `Parquet` 格式文件的速度现已大幅提升。IO 和解码操作已并行化(由 `max_threads` 设置控制),且仅读取所需的数据范围。[#47964](https://github.com/ClickHouse/ClickHouse/pull/47964) ([Michael Kolupaev](https://github.com/al13n321))。
- 如果执行带有 IN(子查询)的变更操作,例如:`ALTER TABLE t UPDATE col='new value' WHERE id IN (SELECT id FROM huge_table)`,且表 `t` 包含多个分区,那么会为每个分区在内存中构建子查询 `SELECT id FROM huge_table` 的集合。如果分区数量很多,这可能会消耗大量内存(并导致 OOM)和 CPU 资源。解决方案是引入一个短期缓存,用于存储变更任务当前正在构建的集合。如果同一变更操作的另一个任务并发执行,它可以在缓存中查找该集合,等待其构建完成并重用。[#46835](https://github.com/ClickHouse/ClickHouse/pull/46835) ([Alexander Gololobov](https://github.com/davenger))。
- 应用 `ALTER TABLE` 查询时,仅在必要时检查依赖关系。[#48062](https://github.com/ClickHouse/ClickHouse/pull/48062) ([Raúl Marín](https://github.com/Algunenano))。
- 优化 `mapUpdate` 函数。[#48118](https://github.com/ClickHouse/ClickHouse/pull/48118) ([Anton Popov](https://github.com/CurtizJ))。
- 现在,向本地副本发送的内部查询采用显式发送方式,并通过回环接口接收数据。对于并行副本,不再遵守 `prefer_localhost_replica` 设置。这样做有助于更好地进行调度,并使代码更清晰:发起者仅负责协调读取过程和合并结果,持续响应请求,而所有辅助查询负责读取数据。注意:使用回环接口的性能并不是最优的,否则某些副本可能会出现任务饥饿,这可能导致查询执行速度更慢且无法充分利用所有可用资源。协调器的初始化现在更加延迟。所有传入请求都包含读取算法的相关信息,当第一个请求到达时,我们使用该信息初始化协调器。如果任何副本决定使用不同的算法进行读取,将抛出异常并中止查询。[#48246](https://github.com/ClickHouse/ClickHouse/pull/48246) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 当 `IN` 子句右侧的子查询仅用于分析跳数索引,且通过设置禁用了跳数索引(`use_skip_indexes=0`)时,不再为其构建集合。此前这可能会影响查询性能。[#48299](https://github.com/ClickHouse/ClickHouse/pull/48299) ([Anton Popov](https://github.com/CurtizJ))。
- 从 `FROM file(...)` 读取后立即并行化查询处理。相关问题 [#38755](https://github.com/ClickHouse/ClickHouse/issues/38755)。[#48525](https://github.com/ClickHouse/ClickHouse/pull/48525) ([Igor Nikonov](https://github.com/devcrafter))。从任何数据源读取后立即并行化查询处理。受影响的数据源主要是简单存储或外部存储,如表函数 `url`、`file`。[#48727](https://github.com/ClickHouse/ClickHouse/pull/48727) ([Igor Nikonov](https://github.com/devcrafter))。此功能由设置 `parallelize_output_from_storages` 控制,默认未启用。
- 降低了 ThreadPool 互斥锁的竞争(可能会提升大量小任务场景下的性能)。[#48750](https://github.com/ClickHouse/ClickHouse/pull/48750) ([Sergei Trifonov](https://github.com/serxa))。
- 减少多个 `ALTER DELETE` 变更操作的内存使用量。[#48522](https://github.com/ClickHouse/ClickHouse/pull/48522) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 启用 `skip_unavailable_shards` 设置后,移除多余的连接尝试。[#48771](https://github.com/ClickHouse/ClickHouse/pull/48771) ([Azat Khuzhin](https://github.com/azat))。


#### 实验性功能 {#experimental-feature-5}

- 查询缓存中的条目现在会被合并到 max_block_size 并进行压缩。[#45912](https://github.com/ClickHouse/ClickHouse/pull/45912) ([Robert Schulze](https://github.com/rschu1ze))。
- 现在可以在查询缓存中为每个用户定义配额。[#48284](https://github.com/ClickHouse/ClickHouse/pull/48284) ([Robert Schulze](https://github.com/rschu1ze))。
- 并行副本的一些修复。[#48433](https://github.com/ClickHouse/ClickHouse/pull/48433) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 在加密磁盘上实现零拷贝复制(实验性功能)。[#48741](https://github.com/ClickHouse/ClickHouse/pull/48741) ([Vitaly Baranov](https://github.com/vitlibar))。


#### 改进 {#improvement-8}

- Increase default value for `connect_timeout_with_failover_ms` to 1000 ms (because of adding async connections in https://github.com/ClickHouse/ClickHouse/pull/47229) . Closes [#5188](https://github.com/ClickHouse/ClickHouse/issues/5188). [#49009](https://github.com/ClickHouse/ClickHouse/pull/49009) ([Kruglov Pavel](https://github.com/Avogar)).
- Several improvements around data lakes: - Make `Iceberg` work with non-partitioned data. - Support `Iceberg` format version v2 (previously only v1 was supported) - Support reading partitioned data for `DeltaLake`/`Hudi` - Faster reading of `DeltaLake` metadata by using Delta's checkpoint files - Fixed incorrect `Hudi` reads: previously it incorrectly chose which data to read and therefore was able to read correctly only small size tables - Made these engines to pickup updates of changed data (previously the state was set on table creation) - Make proper testing for `Iceberg`/`DeltaLake`/`Hudi` using spark. [#47307](https://github.com/ClickHouse/ClickHouse/pull/47307) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Add async connection to socket and async writing to socket. Make creating connections and sending query/external tables async across shards. Refactor code with fibers. Closes [#46931](https://github.com/ClickHouse/ClickHouse/issues/46931). We will be able to increase `connect_timeout_with_failover_ms` by default after this PR (https://github.com/ClickHouse/ClickHouse/issues/5188). [#47229](https://github.com/ClickHouse/ClickHouse/pull/47229) ([Kruglov Pavel](https://github.com/Avogar)).
- Support config sections `keeper`/`keeper_server` as an alternative to `zookeeper`. Close [#34766](https://github.com/ClickHouse/ClickHouse/issues/34766) , [#34767](https://github.com/ClickHouse/ClickHouse/issues/34767). [#35113](https://github.com/ClickHouse/ClickHouse/pull/35113) ([李扬](https://github.com/taiyang-li)).
- It is possible to set _secure_ flag in named_collections for a dictionary with a ClickHouse table source. Addresses [#38450](https://github.com/ClickHouse/ClickHouse/issues/38450) . [#46323](https://github.com/ClickHouse/ClickHouse/pull/46323) ([Ilya Golshtein](https://github.com/ilejn)).
- `bitCount` function support `FixedString` and `String` data type. [#49044](https://github.com/ClickHouse/ClickHouse/pull/49044) ([flynn](https://github.com/ucasfl)).
- Added configurable retries for all operations with [Zoo]Keeper for Backup queries. [#47224](https://github.com/ClickHouse/ClickHouse/pull/47224) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Enable `use_environment_credentials` for S3 by default, so the entire provider chain is constructed by default. [#47397](https://github.com/ClickHouse/ClickHouse/pull/47397) ([Antonio Andelic](https://github.com/antonio2368)).
- Currently, the JSON_VALUE function is similar as spark's get_json_object function, which support to get value from JSON string by a path like '$.key'. But still has something different - 1. in spark's get_json_object will return null while the path is not exist, but in JSON_VALUE will return empty string; - 2. in spark's get_json_object will return a complex type value, such as a JSON object/array value, but in JSON_VALUE will return empty string. [#47494](https://github.com/ClickHouse/ClickHouse/pull/47494) ([KevinyhZou](https://github.com/KevinyhZou)).
- For `use_structure_from_insertion_table_in_table_functions` more flexible insert table structure propagation to table function. Fixed an issue with name mapping and using virtual columns. No more need for 'auto' setting. [#47962](https://github.com/ClickHouse/ClickHouse/pull/47962) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Do not continue retrying to connect to Keeper if the query is killed or over limits. [#47985](https://github.com/ClickHouse/ClickHouse/pull/47985) ([Raúl Marín](https://github.com/Algunenano)).
- Support Enum output/input in `BSONEachRow`, allow all map key types and avoid extra calculations on output. [#48122](https://github.com/ClickHouse/ClickHouse/pull/48122) ([Kruglov Pavel](https://github.com/Avogar)).
- Support more ClickHouse types in `ORC`/`Arrow`/`Parquet` formats: Enum(8|16), (U)Int(128|256), Decimal256 (for ORC), allow reading IPv4 from Int32 values (ORC outputs IPv4 as Int32, and we couldn't read it back), fix reading Nullable(IPv6) from binary data for `ORC`. [#48126](https://github.com/ClickHouse/ClickHouse/pull/48126) ([Kruglov Pavel](https://github.com/Avogar)).
- Add columns `perform_ttl_move_on_insert`, `load_balancing` for table `system.storage_policies`, modify column `volume_type` type to `Enum8`. [#48167](https://github.com/ClickHouse/ClickHouse/pull/48167) ([lizhuoyu5](https://github.com/lzydmxy)).
- Added support for `BACKUP ALL` command which backups all tables and databases, including temporary and system ones. [#48189](https://github.com/ClickHouse/ClickHouse/pull/48189) ([Vitaly Baranov](https://github.com/vitlibar)).
- Function mapFromArrays supports `Map` type as an input. [#48207](https://github.com/ClickHouse/ClickHouse/pull/48207) ([李扬](https://github.com/taiyang-li)).
- The output of some SHOW PROCESSLIST is now sorted. [#48241](https://github.com/ClickHouse/ClickHouse/pull/48241) ([Robert Schulze](https://github.com/rschu1ze)).
- Per-query/per-server throttling for remote IO/local IO/BACKUPs (server settings: `max_remote_read_network_bandwidth_for_server`, `max_remote_write_network_bandwidth_for_server`, `max_local_read_bandwidth_for_server`, `max_local_write_bandwidth_for_server`, `max_backup_bandwidth_for_server`, settings: `max_remote_read_network_bandwidth`, `max_remote_write_network_bandwidth`, `max_local_read_bandwidth`, `max_local_write_bandwidth`, `max_backup_bandwidth`). [#48242](https://github.com/ClickHouse/ClickHouse/pull/48242) ([Azat Khuzhin](https://github.com/azat)).
- Support more types in `CapnProto` format: Map, (U)Int(128|256), Decimal(128|256). Allow integer conversions during input/output. [#48257](https://github.com/ClickHouse/ClickHouse/pull/48257) ([Kruglov Pavel](https://github.com/Avogar)).
- Don't throw CURRENT_WRITE_BUFFER_IS_EXHAUSTED for normal behaviour. [#48288](https://github.com/ClickHouse/ClickHouse/pull/48288) ([Raúl Marín](https://github.com/Algunenano)).
- Add new setting `keeper_map_strict_mode` which enforces extra guarantees on operations made on top of `KeeperMap` tables. [#48293](https://github.com/ClickHouse/ClickHouse/pull/48293) ([Antonio Andelic](https://github.com/antonio2368)).
- Check primary key type for simple dictionary is native unsigned integer type Add setting `check_dictionary_primary_key ` for compatibility(set `check_dictionary_primary_key =false` to disable checking). [#48335](https://github.com/ClickHouse/ClickHouse/pull/48335) ([lizhuoyu5](https://github.com/lzydmxy)).
- Don't replicate mutations for `KeeperMap` because it's unnecessary. [#48354](https://github.com/ClickHouse/ClickHouse/pull/48354) ([Antonio Andelic](https://github.com/antonio2368)).
- Allow to write/read unnamed tuple as nested Message in Protobuf format. Tuple elements and Message fields are matched by position. [#48390](https://github.com/ClickHouse/ClickHouse/pull/48390) ([Kruglov Pavel](https://github.com/Avogar)).
- Support `additional_table_filters` and `additional_result_filter` settings in the new planner. Also, add a documentation entry for `additional_result_filter`. [#48405](https://github.com/ClickHouse/ClickHouse/pull/48405) ([Dmitry Novik](https://github.com/novikd)).
- `parseDateTime` now understands format string '%f' (fractional seconds). [#48420](https://github.com/ClickHouse/ClickHouse/pull/48420) ([Robert Schulze](https://github.com/rschu1ze)).
- Format string "%f" in formatDateTime() now prints "000000" if the formatted value has no fractional seconds, the previous behavior (single zero) can be restored using setting "formatdatetime_f_prints_single_zero = 1". [#48422](https://github.com/ClickHouse/ClickHouse/pull/48422) ([Robert Schulze](https://github.com/rschu1ze)).
- Don't replicate DELETE and TRUNCATE for KeeperMap. [#48434](https://github.com/ClickHouse/ClickHouse/pull/48434) ([Antonio Andelic](https://github.com/antonio2368)).
- Generate valid Decimals and Bools in generateRandom function. [#48436](https://github.com/ClickHouse/ClickHouse/pull/48436) ([Kruglov Pavel](https://github.com/Avogar)).
- Allow trailing commas in expression list of SELECT query, for example `SELECT a, b, c, FROM table`. Closes [#37802](https://github.com/ClickHouse/ClickHouse/issues/37802). [#48438](https://github.com/ClickHouse/ClickHouse/pull/48438) ([Nikolay Degterinsky](https://github.com/evillique)).
- Override `CLICKHOUSE_USER` and `CLICKHOUSE_PASSWORD` environment variables with `--user` and `--password` client parameters. Closes [#38909](https://github.com/ClickHouse/ClickHouse/issues/38909). [#48440](https://github.com/ClickHouse/ClickHouse/pull/48440) ([Nikolay Degterinsky](https://github.com/evillique)).
- Added retries to loading of data parts in `MergeTree` tables in case of retryable errors. [#48442](https://github.com/ClickHouse/ClickHouse/pull/48442) ([Anton Popov](https://github.com/CurtizJ)).
- Add support for `Date`, `Date32`, `DateTime`, `DateTime64` data types to `arrayMin`, `arrayMax`, `arrayDifference` functions. Closes [#21645](https://github.com/ClickHouse/ClickHouse/issues/21645). [#48445](https://github.com/ClickHouse/ClickHouse/pull/48445) ([Nikolay Degterinsky](https://github.com/evillique)).
- Add support for `{server_uuid}` macro. It is useful for identifying replicas in autoscaled clusters when new replicas are constantly added and removed in runtime. This closes [#48554](https://github.com/ClickHouse/ClickHouse/issues/48554). [#48563](https://github.com/ClickHouse/ClickHouse/pull/48563) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- The installation script will create a hard link instead of copying if it is possible. [#48578](https://github.com/ClickHouse/ClickHouse/pull/48578) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Support `SHOW TABLE` syntax meaning the same as `SHOW CREATE TABLE`. Closes [#48580](https://github.com/ClickHouse/ClickHouse/issues/48580). [#48591](https://github.com/ClickHouse/ClickHouse/pull/48591) ([flynn](https://github.com/ucasfl)).
- HTTP temporary buffers now support working by evicting data from the virtual filesystem cache. [#48664](https://github.com/ClickHouse/ClickHouse/pull/48664) ([Vladimir C](https://github.com/vdimir)).
- Make Schema inference works for `CREATE AS SELECT`. Closes [#47599](https://github.com/ClickHouse/ClickHouse/issues/47599). [#48679](https://github.com/ClickHouse/ClickHouse/pull/48679) ([flynn](https://github.com/ucasfl)).
- Added a `replicated_max_mutations_in_one_entry` setting for `ReplicatedMergeTree` that allows limiting the number of mutation commands per one `MUTATE_PART` entry (default is 10000). [#48731](https://github.com/ClickHouse/ClickHouse/pull/48731) ([Alexander Tokmakov](https://github.com/tavplubix)).
- In AggregateFunction types, don't count unused arena bytes as `read_bytes`. [#48745](https://github.com/ClickHouse/ClickHouse/pull/48745) ([Raúl Marín](https://github.com/Algunenano)).
- Fix some MySQL-related settings not being handled with the MySQL dictionary source + named collection. Closes [#48402](https://github.com/ClickHouse/ClickHouse/issues/48402). [#48759](https://github.com/ClickHouse/ClickHouse/pull/48759) ([Kseniia Sumarokova](https://github.com/kssenii)).
- If a user set `max_single_part_upload_size` to a very large value, it can lead to a crash due to a bug in the AWS S3 SDK. This fixes [#47679](https://github.com/ClickHouse/ClickHouse/issues/47679). [#48816](https://github.com/ClickHouse/ClickHouse/pull/48816) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix data race in `RabbitMQ` ([report](https://pastila.nl/?004f7100/de1505289ab5bb355e67ebe6c7cc8707)), refactor the code. [#48845](https://github.com/ClickHouse/ClickHouse/pull/48845) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Add aliases `name` and `part_name` form `system.parts` and `system.part_log`. Closes [#48718](https://github.com/ClickHouse/ClickHouse/issues/48718). [#48850](https://github.com/ClickHouse/ClickHouse/pull/48850) ([sichenzhao](https://github.com/sichenzhao)).
- Functions "arrayDifferenceSupport()", "arrayCumSum()" and "arrayCumSumNonNegative()" now support input arrays of wide integer types (U)Int128/256. [#48866](https://github.com/ClickHouse/ClickHouse/pull/48866) ([cluster](https://github.com/infdahai)).
- Multi-line history in clickhouse-client is now no longer padded. This makes pasting more natural. [#48870](https://github.com/ClickHouse/ClickHouse/pull/48870) ([Joanna Hulboj](https://github.com/jh0x)).
- Implement a slight improvement for the rare case when ClickHouse is run inside LXC and LXCFS is used. The LXCFS has an issue: sometimes it returns an error "Transport endpoint is not connected" on reading from the file inside `/proc`. This error was correctly logged into ClickHouse's server log. We have additionally workaround this issue by reopening a file. This is a minuscule change. [#48922](https://github.com/ClickHouse/ClickHouse/pull/48922) ([Real](https://github.com/RunningXie)).
- Improve memory accounting for prefetches. Randomise prefetch settings In CI. [#48973](https://github.com/ClickHouse/ClickHouse/pull/48973) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Correctly set headers for native copy operations on GCS. [#48981](https://github.com/ClickHouse/ClickHouse/pull/48981) ([Antonio Andelic](https://github.com/antonio2368)).
- Add support for specifying setting names in the command line with dashes instead of underscores, for example, `--max-threads` instead of `--max_threads`. Additionally, support Unicode dash characters like `—` instead of `--` - this is useful when you communicate with a team in another company, and a manager from that team copy-pasted code from MS Word. [#48985](https://github.com/ClickHouse/ClickHouse/pull/48985) ([alekseygolub](https://github.com/alekseygolub)).
- Add fallback to password authentication when authentication with SSL user certificate has failed. Closes [#48974](https://github.com/ClickHouse/ClickHouse/issues/48974). [#48989](https://github.com/ClickHouse/ClickHouse/pull/48989) ([Nikolay Degterinsky](https://github.com/evillique)).
- Improve the embedded dashboard. Close [#46671](https://github.com/ClickHouse/ClickHouse/issues/46671). [#49036](https://github.com/ClickHouse/ClickHouse/pull/49036) ([Kevin Zhang](https://github.com/Kinzeng)).
- Add profile events for log messages, so you can easily see the count of log messages by severity. [#49042](https://github.com/ClickHouse/ClickHouse/pull/49042) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- In previous versions, the `LineAsString` format worked inconsistently when the parallel parsing was enabled or not, in presence of DOS or macOS Classic line breaks. This closes [#49039](https://github.com/ClickHouse/ClickHouse/issues/49039). [#49052](https://github.com/ClickHouse/ClickHouse/pull/49052) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- The exception message about the unparsed query parameter will also tell about the name of the parameter. Reimplement [#48878](https://github.com/ClickHouse/ClickHouse/issues/48878). Close [#48772](https://github.com/ClickHouse/ClickHouse/issues/48772). [#49061](https://github.com/ClickHouse/ClickHouse/pull/49061) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-8}

- 更新时区。已更新以下时区:Africa/Cairo、Africa/Casablanca、Africa/El_Aaiun、America/Bogota、America/Cambridge_Bay、America/Ciudad_Juarez、America/Godthab、America/Inuvik、America/Iqaluit、America/Nuuk、America/Ojinaga、America/Pangnirtung、America/Rankin_Inlet、America/Resolute、America/Whitehorse、America/Yellowknife、Asia/Gaza、Asia/Hebron、Asia/Kuala_Lumpur、Asia/Singapore、Canada/Yukon、Egypt、Europe/Kirov、Europe/Volgograd、Singapore。 [#48572](https://github.com/ClickHouse/ClickHouse/pull/48572) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- 减少头文件中的依赖项数量,以加快构建速度。 [#47984](https://github.com/ClickHouse/ClickHouse/pull/47984) ([Dmitry Novik](https://github.com/novikd)).
- 在测试中随机化标记和索引的压缩方式。 [#48286](https://github.com/ClickHouse/ClickHouse/pull/48286) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- 将内部 ZSTD 版本从 1.5.4 升级到 1.5.5。 [#46797](https://github.com/ClickHouse/ClickHouse/pull/46797) ([Robert Schulze](https://github.com/rschu1ze)).
- 在测试中随机化从紧凑部分到宽部分的垂直合并。 [#48287](https://github.com/ClickHouse/ClickHouse/pull/48287) ([Raúl Marín](https://github.com/Algunenano)).
- 支持 HDFS 中的 CRC32 校验和。修复性能问题。 [#48614](https://github.com/ClickHouse/ClickHouse/pull/48614) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- 移除 GCC 支持的残留代码。 [#48671](https://github.com/ClickHouse/ClickHouse/pull/48671) ([Robert Schulze](https://github.com/rschu1ze)).
- 添加启用新分析器基础设施的 CI 运行。 [#48719](https://github.com/ClickHouse/ClickHouse/pull/48719) ([Dmitry Novik](https://github.com/novikd)).

#### Bug 修复(官方稳定版本中用户可见的异常行为) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-8}


* 修复针对从后台线程推送的物化视图的 `system.query_views_log` [#46668](https://github.com/ClickHouse/ClickHouse/pull/46668)（[Azat Khuzhin](https://github.com/azat)）。
* 修复多个 `RENAME COLUMN` 相关的缺陷 [#46946](https://github.com/ClickHouse/ClickHouse/pull/46946) ([alesapin](https://github.com/alesapin))。
* 修复 `clickhouse-format` 中一些次要高亮显示问题 [#47610](https://github.com/ClickHouse/ClickHouse/pull/47610)（[Natasha Murashkina](https://github.com/murfel)）。
* 修复了 LLVM 的 libc++ 中的一个错误，该错误会在将大小超过 INT&#95;MAX 的分片上传到 S3 时导致崩溃 [#47693](https://github.com/ClickHouse/ClickHouse/pull/47693) ([Azat Khuzhin](https://github.com/azat))。
* 修复 `sparkbar` 函数的溢出问题 [#48121](https://github.com/ClickHouse/ClickHouse/pull/48121)（[Vladimir C](https://github.com/vdimir)）。
* 修复 S3 中的竞态问题 [#48190](https://github.com/ClickHouse/ClickHouse/pull/48190) ([Anton Popov](https://github.com/CurtizJ)).
* 由于行为不一致，已禁用聚合函数的 JIT [#48195](https://github.com/ClickHouse/ClickHouse/pull/48195)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 微调 `ALTER` 语句格式 [#48289](https://github.com/ClickHouse/ClickHouse/pull/48289) ([Natasha Murashkina](https://github.com/murfel)).
* 修复 RabbitMQ 中的 CPU 使用问题（在 23.2 版本中因 [#44404](https://github.com/ClickHouse/ClickHouse/issues/44404) 而进一步恶化）[#48311](https://github.com/ClickHouse/ClickHouse/pull/48311)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复在 Distributed 上执行 Merge 时使用 `EXPLAIN PIPELINE` 会崩溃的问题 [#48320](https://github.com/ClickHouse/ClickHouse/pull/48320)（[Azat Khuzhin](https://github.com/azat)）。
* 修复将 `LowCardinality` 序列化为 Arrow 字典时的问题 [#48361](https://github.com/ClickHouse/ClickHouse/pull/48361)（[Kruglov Pavel](https://github.com/Avogar)）。
* 在 TemporaryFileStream 中为缓存文件片段重置下载器 [#48386](https://github.com/ClickHouse/ClickHouse/pull/48386)（[Vladimir C](https://github.com/vdimir)）。
* 修复在执行 DROP/REPLACE PARTITION 时可能导致 `SYSTEM SYNC REPLICA` 卡住的问题 [#48391](https://github.com/ClickHouse/ClickHouse/pull/48391) ([Azat Khuzhin](https://github.com/azat))。
* 修复在加载依赖字典的分布式表时出现的启动错误 [#48419](https://github.com/ClickHouse/ClickHouse/pull/48419) ([MikhailBurdukov](https://github.com/MikhailBurdukov))。
* 在自动重命名系统表时不再检查依赖关系 [#48431](https://github.com/ClickHouse/ClickHouse/pull/48431) ([Raúl Marín](https://github.com/Algunenano))。
* 仅更新 KeeperMap 存储中受影响的行 [#48435](https://github.com/ClickHouse/ClickHouse/pull/48435) ([Antonio Andelic](https://github.com/antonio2368))。
* 修复 VFS 缓存中可能出现的段错误（segfault）[#48469](https://github.com/ClickHouse/ClickHouse/pull/48469)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 当未提供常量字符串时，`toTimeZone` 函数会报错 [#48471](https://github.com/ClickHouse/ClickHouse/pull/48471)（[Jordi Villar](https://github.com/jrdi)）。
* 修复 Protobuf 中的 IPv4 逻辑错误，添加对 Date32 的支持 [#48486](https://github.com/ClickHouse/ClickHouse/pull/48486) ([Kruglov Pavel](https://github.com/Avogar))。
* system.settings 中的 &quot;changed&quot; 标志在具有多重取值的设置上计算不正确 [#48516](https://github.com/ClickHouse/ClickHouse/pull/48516) ([MikhailBurdukov](https://github.com/MikhailBurdukov))。
* 修复启用压缩时的 `Memory` 表引擎 [#48517](https://github.com/ClickHouse/ClickHouse/pull/48517)（[Anton Popov](https://github.com/CurtizJ)）。
* 修复客户端重新连接时 `bracketed-paste` 模式导致密码输入异常的问题 [#48528](https://github.com/ClickHouse/ClickHouse/pull/48528) ([Michael Kolupaev](https://github.com/al13n321))。
* 修复键为 IP 和 UUID 类型的嵌套 `Map` [#48556](https://github.com/ClickHouse/ClickHouse/pull/48556)（[Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)）。
* 修复哈希字典并行加载器中的未捕获异常 [#48571](https://github.com/ClickHouse/ClickHouse/pull/48571) ([Azat Khuzhin](https://github.com/azat))。
* `groupArray` 聚合函数现在可以在可为空类型的空结果上正确工作 [#48593](https://github.com/ClickHouse/ClickHouse/pull/48593) ([lgbo](https://github.com/lgbo-ustc))。
* 修复 Keeper 中的一个错误：在某些情况下，使用 `auth` 模式时节点不会在 ACL 中创建。 [#48595](https://github.com/ClickHouse/ClickHouse/pull/48595) ([Aleksei Filatov](https://github.com/aalexfvk)).
* 允许在 IPv4 与 UInt 之间使用比较运算符 [#48611](https://github.com/ClickHouse/ClickHouse/pull/48611) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* 修复缓存中可能出现的错误 [#48636](https://github.com/ClickHouse/ClickHouse/pull/48636) （[Kseniia Sumarokova](https://github.com/kssenii)）。
* 空数据的异步插入将不再抛出异常。[#48663](https://github.com/ClickHouse/ClickHouse/pull/48663)（[Anton Popov](https://github.com/CurtizJ)）。
* 在 `RENAME TABLE` 失败时修复表依赖关系 [#48683](https://github.com/ClickHouse/ClickHouse/pull/48683)（[Azat Khuzhin](https://github.com/azat)）。
* 如果主键包含重复列（这只可能出现在投影中），在之前的版本中可能会触发 bug [#48838](https://github.com/ClickHouse/ClickHouse/pull/48838)（[Amos Bird](https://github.com/amosbird)）。
* 修复在加入 send&#95;thread/receive&#95;thread 时 ZooKeeper 中的竞争状态 [#48849](https://github.com/ClickHouse/ClickHouse/pull/48849) （[Alexander Gololobov](https://github.com/davenger)）。
* 修复在使用零拷贝复制时尝试删除被忽略的已分离数据片时出现的意外数据片名称错误 [#48862](https://github.com/ClickHouse/ClickHouse/pull/48862) ([Michael Lex](https://github.com/mlex)).
* 修复将 `Date32` Parquet/Arrow 列读取为非 `Date32` 列的问题 [#48864](https://github.com/ClickHouse/ClickHouse/pull/48864)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复在对带有行策略且包含带点列的表进行查询时出现的 `UNKNOWN_IDENTIFIER` 错误 [#48976](https://github.com/ClickHouse/ClickHouse/pull/48976)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复按空可为空字符串进行聚合的问题 [#48999](https://github.com/ClickHouse/ClickHouse/pull/48999) ([LiuNeng](https://github.com/liuneng1994))。

### <a id="233"></a> ClickHouse 23.3 LTS 版本,2023-03-30 {#233}

#### 升级说明 {#upgrade-notes-1}

- 轻量级 DELETE 已达到生产就绪状态并默认启用。MergeTree 表的 `DELETE` 查询现已默认可用。
- `*domain*RFC` 和 `netloc` 函数的行为略有变化:放宽了 URL 授权部分允许使用的符号集,以更好地符合标准。[#46841](https://github.com/ClickHouse/ClickHouse/pull/46841) ([Azat Khuzhin](https://github.com/azat))。
- 禁止在基于 KafkaEngine 创建表时为列使用 DEFAULT/EPHEMERAL/ALIAS/MATERIALIZED 语句。[#47138](https://github.com/ClickHouse/ClickHouse/pull/47138) ([Aleksandr Musorin](https://github.com/AVMusorin))。
- 移除了"异步连接排空"功能。相关设置和指标也已移除。这是一个内部功能,因此该移除不应影响从未了解过该功能的用户。[#47486](https://github.com/ClickHouse/ClickHouse/pull/47486) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 在 `arraySum`/`Min`/`Max`/`Avg`/`Product`、`arrayCumSum`/`CumSumNonNegative`、`arrayDifference`、数组构造、IN 运算符、查询参数、`groupArrayMovingSum`、统计函数、`min`/`max`/`any`/`argMin`/`argMax`、PostgreSQL 线协议、MySQL 表引擎和函数、`sumMap`、`mapAdd`、`mapSubtract`、`arrayIntersect` 中支持 256 位 Decimal 数据类型(超过 38 位数字)。在 `arrayIntersect` 中添加了对大整数的支持。涉及矩的统计聚合函数(如 `corr` 或各种 `TTest`)将使用 `Float64` 作为其内部表示(在此更改之前它们使用 `Decimal128`,但这并无意义),并且这些函数在方差无限的情况下可以返回 `nan` 而不是 `inf`。某些函数在 `Decimal256` 数据类型上是允许的,但在以前的版本中返回 `Decimal128` - 现已修复。这解决了 [#47569](https://github.com/ClickHouse/ClickHouse/issues/47569)。这解决了 [#44864](https://github.com/ClickHouse/ClickHouse/issues/44864)。这解决了 [#28335](https://github.com/ClickHouse/ClickHouse/issues/28335)。[#47594](https://github.com/ClickHouse/ClickHouse/pull/47594) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 将 backup_threads/restore_threads 改为服务器设置(而非用户设置)。[#47881](https://github.com/ClickHouse/ClickHouse/pull/47881) ([Azat Khuzhin](https://github.com/azat))。
- 不允许使用常量和非确定性二级索引 [#46839](https://github.com/ClickHouse/ClickHouse/pull/46839) ([Anton Popov](https://github.com/CurtizJ))。


#### 新功能 {#new-feature-9}

- 新增了一种在副本间分配工作的模式,通过设置 `parallel_replicas_custom_key` 和 `parallel_replicas_custom_key_filter_type` 实现。如果集群由单个分片和多个副本组成,将随机选择最多 `max_parallel_replicas` 个副本并将其转换为分片。对于每个分片,在发送到分片之前,会在发起节点的查询中添加相应的过滤器。如果集群由多个分片组成,其行为将与 `sample_key` 相同,但可以定义任意键。[#45108](https://github.com/ClickHouse/ClickHouse/pull/45108) ([Antonio Andelic](https://github.com/antonio2368))。
- 取消查询时显示部分结果的选项:新增查询设置 `partial_result_on_first_cancel`,允许被取消的查询(例如由于 Ctrl-C)返回部分结果。[#45689](https://github.com/ClickHouse/ClickHouse/pull/45689) ([Alexey Perevyshin](https://github.com/alexX512))。
- 为临时表新增了对任意表引擎的支持(Replicated 和 KeeperMap 引擎除外)。关闭 [#31497](https://github.com/ClickHouse/ClickHouse/issues/31497)。[#46071](https://github.com/ClickHouse/ClickHouse/pull/46071) ([Roman Vasin](https://github.com/rvasin))。
- 新增对使用 Keeper 中集中式存储复制用户定义 SQL 函数的支持。[#46085](https://github.com/ClickHouse/ClickHouse/pull/46085) ([Aleksei Filatov](https://github.com/aalexfvk))。
- 实现了 `system.server_settings`(类似于 `system.settings`),其中包含服务器配置。[#46550](https://github.com/ClickHouse/ClickHouse/pull/46550) ([pufit](https://github.com/pufit))。
- 支持 `UNDROP TABLE` 查询。关闭 [#46811](https://github.com/ClickHouse/ClickHouse/issues/46811)。[#47241](https://github.com/ClickHouse/ClickHouse/pull/47241) ([chen](https://github.com/xiedeyantu))。
- 允许对命名集合进行单独授权(例如,能够仅对某些集合授予 `SHOW/CREATE/ALTER/DROP named collection` 访问权限,而不是一次性授予所有集合)。关闭 [#40894](https://github.com/ClickHouse/ClickHouse/issues/40894)。新增访问类型 `NAMED_COLLECTION_CONTROL`,除非在用户配置中明确添加,否则不会授予默认用户(执行 `GRANT ALL` 时需要此权限),此外,`show_named_collections` 不再像 23.2 版本中那样必须手动指定才能使默认用户拥有完全访问权限。[#46241](https://github.com/ClickHouse/ClickHouse/pull/46241) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 允许嵌套自定义磁盘。以前自定义磁盘仅支持扁平磁盘结构。[#47106](https://github.com/ClickHouse/ClickHouse/pull/47106) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 引入函数 `widthBucket`(带有 `WIDTH_BUCKET` 别名以保持兼容性)。[#42974](https://github.com/ClickHouse/ClickHouse/issues/42974)。[#46790](https://github.com/ClickHouse/ClickHouse/pull/46790) ([avoiderboi](https://github.com/avoiderboi))。
- 根据指定的格式字符串新增函数 `parseDateTime`/`parseDateTimeInJodaSyntax`。parseDateTime 使用 MySQL 语法将字符串解析为 DateTime,parseDateTimeInJodaSyntax 使用 Joda 语法进行解析。[#46815](https://github.com/ClickHouse/ClickHouse/pull/46815) ([李扬](https://github.com/taiyang-li))。
- 对表函数 `null` 的默认结构使用 `dummy UInt8`。关闭 [#46930](https://github.com/ClickHouse/ClickHouse/issues/46930)。[#47006](https://github.com/ClickHouse/ClickHouse/pull/47006) ([flynn](https://github.com/ucasfl))。
- 在 `parseDateTimeBestEffort` 函数中支持带逗号的日期格式,如 `Dec 15, 2021`。关闭 [#46816](https://github.com/ClickHouse/ClickHouse/issues/46816)。[#47071](https://github.com/ClickHouse/ClickHouse/pull/47071) ([chen](https://github.com/xiedeyantu))。
- 新增设置 `http_wait_end_of_query` 和 `http_response_buffer_size`,对应于 HTTP 接口的 URL 参数 `wait_end_of_query` 和 `buffer_size`。这允许在配置文件中更改这些设置。[#47108](https://github.com/ClickHouse/ClickHouse/pull/47108) ([Vladimir C](https://github.com/vdimir))。
- 新增 `system.dropped_tables` 表,显示从 `Atomic` 数据库中删除但尚未完全移除的表。[#47364](https://github.com/ClickHouse/ClickHouse/pull/47364) ([chen](https://github.com/xiedeyantu))。
- 新增 `INSTR` 作为 `positionCaseInsensitive` 的别名以实现 MySQL 兼容性。关闭 [#47529](https://github.com/ClickHouse/ClickHouse/issues/47529)。[#47535](https://github.com/ClickHouse/ClickHouse/pull/47535) ([flynn](https://github.com/ucasfl))。
- 新增 `toDecimalString` 函数,允许将数字转换为具有固定精度的字符串。[#47838](https://github.com/ClickHouse/ClickHouse/pull/47838) ([Andrey Zvonov](https://github.com/zvonand))。
- 新增合并树设置 `max_number_of_mutations_for_replica`。它将每个副本的数据部分变更数量限制为指定数量。零表示对每个副本的变更数量没有限制(执行仍可能受到其他设置的约束)。[#48047](https://github.com/ClickHouse/ClickHouse/pull/48047) ([Vladimir C](https://github.com/vdimir))。
- 新增与 Map 相关的函数 `mapFromArrays`,允许从一对数组创建映射。[#31125](https://github.com/ClickHouse/ClickHouse/pull/31125) ([李扬](https://github.com/taiyang-li))。
- 允许控制 Parquet/ORC/Arrow 输出格式中的压缩,新增对更多压缩输入格式的支持。这关闭了 [#13541](https://github.com/ClickHouse/ClickHouse/issues/13541)。[#47114](https://github.com/ClickHouse/ClickHouse/pull/47114) ([Kruglov Pavel](https://github.com/Avogar))。
- 向原生协议新增 SSL 用户证书身份验证。关闭 [#47077](https://github.com/ClickHouse/ClickHouse/issues/47077)。[#47596](https://github.com/ClickHouse/ClickHouse/pull/47596) ([Nikolay Degterinsky](https://github.com/evillique))。
- 为 `parseDateTime` 新增 *OrNull() 和 *OrZero() 变体,新增别名 `str_to_date` 以实现 MySQL 兼容性。[#48000](https://github.com/ClickHouse/ClickHouse/pull/48000) ([Robert Schulze](https://github.com/rschu1ze))。
- 新增运算符 `REGEXP`(类似于运算符 "LIKE"、"IN"、"MOD" 等)以更好地兼容 MySQL [#47869](https://github.com/ClickHouse/ClickHouse/pull/47869) ([Robert Schulze](https://github.com/rschu1ze))。





#### 性能改进 {#performance-improvement-9}

- 内存中的标记现已压缩,内存使用量减少 3-6 倍。[#47290](https://github.com/ClickHouse/ClickHouse/pull/47290) ([Michael Kolupaev](https://github.com/al13n321))。
- 在以前的版本中,大量文件的备份速度慢得令人难以置信。现在不会了。现在它们快得令人难以置信。[#47251](https://github.com/ClickHouse/ClickHouse/pull/47251) ([Alexey Milovidov](https://github.com/alexey-milovidov))。为备份的 IO 操作引入了单独的线程池。这将允许独立于其他池进行扩展并提高性能。[#47174](https://github.com/ClickHouse/ClickHouse/pull/47174) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。在备份处理的最后阶段使用 MultiRead 请求和重试来收集元数据。[#47243](https://github.com/ClickHouse/ClickHouse/pull/47243) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。如果备份和恢复数据都在 S3 中,则从现在开始应使用服务器端复制。[#47546](https://github.com/ClickHouse/ClickHouse/pull/47546) ([Vitaly Baranov](https://github.com/vitlibar))。
- 修复了带有 `FINAL` 的查询中的过度读取问题。[#47801](https://github.com/ClickHouse/ClickHouse/pull/47801) ([Nikita Taranov](https://github.com/nickitat))。
- 设置 `max_final_threads` 将在服务器启动时设置为核心数(使用与 `max_threads` 相同的算法)。这提高了在具有大量 CPU 的服务器上 `final` 执行的并发性。[#47915](https://github.com/ClickHouse/ClickHouse/pull/47915) ([Nikita Taranov](https://github.com/nickitat))。
- 允许在多个线程中为具有 CLICKHOUSE 源的 DIRECT 字典执行读取管道。要启用,请在 `CREATE DICTIONARY` 语句中为源的 `SETTINGS` 部分设置 `dictionary_use_async_executor=1`。[#47986](https://github.com/ClickHouse/ClickHouse/pull/47986) ([Vladimir C](https://github.com/vdimir))。
- 优化单个可空键聚合性能。[#45772](https://github.com/ClickHouse/ClickHouse/pull/45772) ([LiuNeng](https://github.com/liuneng1994))。
- 为 `hasTokenOrNull`、`hasTokenCaseInsensitive` 和 `hasTokenCaseInsensitiveOrNull` 实现了小写 `tokenbf_v1` 索引利用。[#46252](https://github.com/ClickHouse/ClickHouse/pull/46252) ([ltrk2](https://github.com/ltrk2))。
- 通过使用 SIMD 搜索前两个字符来优化 `position` 和 `LIKE` 函数。[#46289](https://github.com/ClickHouse/ClickHouse/pull/46289) ([Jiebin Sun](https://github.com/jiebinn))。
- 优化来自 `system.detached_parts` 的查询,该表可能非常大。根据块大小限制添加了多个源;在每个块中,使用 IO 线程池来计算分区大小,即并行进行系统调用。[#46624](https://github.com/ClickHouse/ClickHouse/pull/46624) ([Sema Checherinda](https://github.com/CheSema))。
- 将 ReplicatedMergeTree 表的 `max_replicated_merges_in_queue` 默认值从 16 增加到 1000。这允许在具有大量副本的集群上进行更快的后台合并操作,例如 ClickHouse Cloud 中具有共享存储的集群。[#47050](https://github.com/ClickHouse/ClickHouse/pull/47050) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 更新了 `clickhouse-copier` 以使用 `GROUP BY` 而不是 `DISTINCT` 来获取分区列表。对于大型表,这将查询时间从超过 500 秒减少到不到 1 秒。[#47386](https://github.com/ClickHouse/ClickHouse/pull/47386) ([Clayton McClure](https://github.com/cmcclure-twilio))。
- 修复 `ASOF JOIN` 中的性能下降问题。[#47544](https://github.com/ClickHouse/ClickHouse/pull/47544) ([Ongkong](https://github.com/ongkong))。
- 在 Keeper 中进行更多批处理。通过避免在读取请求时中断批处理来提高性能。[#47978](https://github.com/ClickHouse/ClickHouse/pull/47978) ([Antonio Andelic](https://github.com/antonio2368))。
- 允许对具有不同列 DEFAULT 表达式的 Merge 使用 PREWHERE。[#46831](https://github.com/ClickHouse/ClickHouse/pull/46831) ([Azat Khuzhin](https://github.com/azat))。

#### 实验性功能 {#experimental-feature-6}

- 并行副本:通过更好地利用本地副本提升了整体性能,并默认禁止从非复制的 MergeTree 表使用并行副本进行读取。[#47858](https://github.com/ClickHouse/ClickHouse/pull/47858) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- 当启用实验性分析器时,支持将过滤条件下推到左表,适用于与 `Join`、`Dictionary` 和 `EmbeddedRocksDB` 表的 JOIN 操作。[#47280](https://github.com/ClickHouse/ClickHouse/pull/47280) ([Maksim Kita](https://github.com/kitaisreal)).
- 现在使用零拷贝复制的 ReplicatedMergeTree 对 Keeper 的负载更低。[#47676](https://github.com/ClickHouse/ClickHouse/pull/47676) ([alesapin](https://github.com/alesapin)).
- 修复使用 MaterializedPostgreSQL 创建物化视图的问题。[#40807](https://github.com/ClickHouse/ClickHouse/pull/40807) ([Maksim Buren](https://github.com/maks-buren630501)).


#### 改进 {#improvement-9}

- Enable `input_format_json_ignore_unknown_keys_in_named_tuple` by default. [#46742](https://github.com/ClickHouse/ClickHouse/pull/46742) ([Kruglov Pavel](https://github.com/Avogar)).
- Allow errors to be ignored while pushing to MATERIALIZED VIEW (add new setting `materialized_views_ignore_errors`, by default to `false`, but it is set to `true` for flushing logs to `system.*_log` tables unconditionally). [#46658](https://github.com/ClickHouse/ClickHouse/pull/46658) ([Azat Khuzhin](https://github.com/azat)).
- Track the file queue of distributed sends in memory. [#45491](https://github.com/ClickHouse/ClickHouse/pull/45491) ([Azat Khuzhin](https://github.com/azat)).
- Now `X-ClickHouse-Query-Id` and `X-ClickHouse-Timezone` headers are added to responses in all queries via HTTP protocol. Previously it was done only for `SELECT` queries. [#46364](https://github.com/ClickHouse/ClickHouse/pull/46364) ([Anton Popov](https://github.com/CurtizJ)).
- External tables from `MongoDB`: support for connection to a replica set via a URI with a host:port enum and support for the readPreference option in MongoDB dictionaries. Example URI: mongodb://db0.example.com:27017,db1.example.com:27017,db2.example.com:27017/?replicaSet=myRepl&readPreference=primary. [#46524](https://github.com/ClickHouse/ClickHouse/pull/46524) ([artem-yadr](https://github.com/artem-yadr)).
- This improvement should be invisible for users. Re-implement projection analysis on top of query plan. Added setting `query_plan_optimize_projection=1` to switch between old and new version. Fixes [#44963](https://github.com/ClickHouse/ClickHouse/issues/44963). [#46537](https://github.com/ClickHouse/ClickHouse/pull/46537) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Use Parquet format v2 instead of v1 in output format by default. Add setting `output_format_parquet_version` to control parquet version, possible values `1.0`, `2.4`, `2.6`, `2.latest` (default). [#46617](https://github.com/ClickHouse/ClickHouse/pull/46617) ([Kruglov Pavel](https://github.com/Avogar)).
- It is now possible to use the new configuration syntax to configure Kafka topics with periods (`.`) in their name. [#46752](https://github.com/ClickHouse/ClickHouse/pull/46752) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix heuristics that check hyperscan patterns for problematic repeats. [#46819](https://github.com/ClickHouse/ClickHouse/pull/46819) ([Robert Schulze](https://github.com/rschu1ze)).
- Don't report ZK node exists to system.errors when a block was created concurrently by a different replica. [#46820](https://github.com/ClickHouse/ClickHouse/pull/46820) ([Raúl Marín](https://github.com/Algunenano)).
- Increase the limit for opened files in `clickhouse-local`. It will be able to read from `web` tables on servers with a huge number of CPU cores. Do not back off reading from the URL table engine in case of too many opened files. This closes [#46852](https://github.com/ClickHouse/ClickHouse/issues/46852). [#46853](https://github.com/ClickHouse/ClickHouse/pull/46853) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Exceptions thrown when numbers cannot be parsed now have an easier-to-read exception message. [#46917](https://github.com/ClickHouse/ClickHouse/pull/46917) ([Robert Schulze](https://github.com/rschu1ze)).
- Added update `system.backups` after every processed task to track the progress of backups. [#46989](https://github.com/ClickHouse/ClickHouse/pull/46989) ([Aleksandr Musorin](https://github.com/AVMusorin)).
- Allow types conversion in Native input format. Add settings `input_format_native_allow_types_conversion` that controls it (enabled by default). [#46990](https://github.com/ClickHouse/ClickHouse/pull/46990) ([Kruglov Pavel](https://github.com/Avogar)).
- Allow IPv4 in the `range` function to generate IP ranges. [#46995](https://github.com/ClickHouse/ClickHouse/pull/46995) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Improve exception message when it's impossible to move a part from one volume/disk to another. [#47032](https://github.com/ClickHouse/ClickHouse/pull/47032) ([alesapin](https://github.com/alesapin)).
- Support `Bool` type in `JSONType` function. Previously `Null` type was mistakenly returned for bool values. [#47046](https://github.com/ClickHouse/ClickHouse/pull/47046) ([Anton Popov](https://github.com/CurtizJ)).
- Use `_request_body` parameter to configure predefined HTTP queries. [#47086](https://github.com/ClickHouse/ClickHouse/pull/47086) ([Constantine Peresypkin](https://github.com/pkit)).
- Automatic indentation in the built-in UI SQL editor when Enter is pressed. [#47113](https://github.com/ClickHouse/ClickHouse/pull/47113) ([Alexey Korepanov](https://github.com/alexkorep)).
- Self-extraction with 'sudo' will attempt to set uid and gid of extracted files to running user. [#47116](https://github.com/ClickHouse/ClickHouse/pull/47116) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Previously, the `repeat` function's second argument only accepted an unsigned integer type, which meant it could not accept values such as -1. This behavior differed from that of the Spark function. In this update, the repeat function has been modified to match the behavior of the Spark function. It now accepts the same types of inputs, including negative integers. Extensive testing has been performed to verify the correctness of the updated implementation. [#47134](https://github.com/ClickHouse/ClickHouse/pull/47134) ([KevinyhZou](https://github.com/KevinyhZou)). Note: the changelog entry was rewritten by ChatGPT.
- Remove `::__1` part from stacktraces. Display `std::basic_string<char, ...` as `String` in stacktraces. [#47171](https://github.com/ClickHouse/ClickHouse/pull/47171) ([Mike Kot](https://github.com/myrrc)).
- Reimplement interserver mode to avoid replay attacks (note, that change is backward compatible with older servers). [#47213](https://github.com/ClickHouse/ClickHouse/pull/47213) ([Azat Khuzhin](https://github.com/azat)).
- Improve recognition of regular expression groups and refine the regexp_tree dictionary. [#47218](https://github.com/ClickHouse/ClickHouse/pull/47218) ([Han Fei](https://github.com/hanfei1991)).
- Keeper improvement: Add new 4LW `clrs` to clean resources used by Keeper (e.g. release unused memory). [#47256](https://github.com/ClickHouse/ClickHouse/pull/47256) ([Antonio Andelic](https://github.com/antonio2368)).
- Add optional arguments to codecs `DoubleDelta(bytes_size)`, `Gorilla(bytes_size)`, `FPC(level, float_size)`, this allows using these codecs without column type in `clickhouse-compressor`. Fix possible aborts and arithmetic errors in `clickhouse-compressor` with these codecs. Fixes: https://github.com/ClickHouse/ClickHouse/discussions/47262. [#47271](https://github.com/ClickHouse/ClickHouse/pull/47271) ([Kruglov Pavel](https://github.com/Avogar)).
- Add support for big int types to the `runningDifference` function. Closes [#47194](https://github.com/ClickHouse/ClickHouse/issues/47194). [#47322](https://github.com/ClickHouse/ClickHouse/pull/47322) ([Nikolay Degterinsky](https://github.com/evillique)).
- Add an expiration window for S3 credentials that have an expiration time to avoid `ExpiredToken` errors in some edge cases. It can be controlled with `expiration_window_seconds` config, the default is 120 seconds. [#47423](https://github.com/ClickHouse/ClickHouse/pull/47423) ([Antonio Andelic](https://github.com/antonio2368)).
- Support Decimals and Date32 in `Avro` format. [#47434](https://github.com/ClickHouse/ClickHouse/pull/47434) ([Kruglov Pavel](https://github.com/Avogar)).
- Do not start the server if an interrupted conversion from `Ordinary` to `Atomic` was detected, print a better error message with troubleshooting instructions. [#47487](https://github.com/ClickHouse/ClickHouse/pull/47487) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Add a new column `kind` to the `system.opentelemetry_span_log`. This column holds the value of [SpanKind](https://opentelemetry.io/docs/reference/specification/trace/api/#spankind) defined in OpenTelemtry. [#47499](https://github.com/ClickHouse/ClickHouse/pull/47499) ([Frank Chen](https://github.com/FrankChen021)).
- Allow reading/writing nested arrays in `Protobuf` format with only the root field name as column name. Previously column name should've contained all nested field names (like `a.b.c Array(Array(Array(UInt32)))`, now you can use just `a Array(Array(Array(UInt32)))`. [#47650](https://github.com/ClickHouse/ClickHouse/pull/47650) ([Kruglov Pavel](https://github.com/Avogar)).
- Added an optional `STRICT` modifier for `SYSTEM SYNC REPLICA` which makes the query wait for the replication queue to become empty (just like it worked before https://github.com/ClickHouse/ClickHouse/pull/45648). [#47659](https://github.com/ClickHouse/ClickHouse/pull/47659) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Improve the naming of some OpenTelemetry span logs. [#47667](https://github.com/ClickHouse/ClickHouse/pull/47667) ([Frank Chen](https://github.com/FrankChen021)).
- Prevent using too long chains of aggregate function combinators (they can lead to slow queries in the analysis stage). This closes [#47715](https://github.com/ClickHouse/ClickHouse/issues/47715). [#47716](https://github.com/ClickHouse/ClickHouse/pull/47716) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Support for subquery in parameterized views; resolves [#46741](https://github.com/ClickHouse/ClickHouse/issues/46741) [#47725](https://github.com/ClickHouse/ClickHouse/pull/47725) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Fix memory leak in MySQL integration (reproduces with `connection_auto_close=1`). [#47732](https://github.com/ClickHouse/ClickHouse/pull/47732) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Improved error handling in the code related to Decimal parameters, resulting in more informative error messages. Previously, when incorrect Decimal parameters were supplied, the error message generated was unclear or unhelpful. With this update, the error message printed has been fixed to provide more detailed and useful information, making it easier to identify and correct issues related to Decimal parameters. [#47812](https://github.com/ClickHouse/ClickHouse/pull/47812) ([Yu Feng](https://github.com/Vigor-jpg)). Note: this changelog entry is rewritten by ChatGPT.
- The parameter `exact_rows_before_limit` is used to make `rows_before_limit_at_least` is designed to accurately reflect the number of rows returned before the limit is reached. This pull request addresses issues encountered when the query involves distributed processing across multiple shards or sorting operations. Prior to this update, these scenarios were not functioning as intended. [#47874](https://github.com/ClickHouse/ClickHouse/pull/47874) ([Amos Bird](https://github.com/amosbird)).
- ThreadPools metrics introspection. [#47880](https://github.com/ClickHouse/ClickHouse/pull/47880) ([Azat Khuzhin](https://github.com/azat)).
- Add `WriteBufferFromS3Microseconds` and `WriteBufferFromS3RequestsErrors` profile events. [#47885](https://github.com/ClickHouse/ClickHouse/pull/47885) ([Antonio Andelic](https://github.com/antonio2368)).
- Add `--link` and `--noninteractive` (`-y`) options to ClickHouse install. Closes [#47750](https://github.com/ClickHouse/ClickHouse/issues/47750). [#47887](https://github.com/ClickHouse/ClickHouse/pull/47887) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fixed `UNKNOWN_TABLE` exception when attaching to a materialized view that has dependent tables that are not available. This might be useful when trying to restore state from a backup. [#47975](https://github.com/ClickHouse/ClickHouse/pull/47975) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
- Fix case when the (optional) path is not added to an encrypted disk configuration. [#47981](https://github.com/ClickHouse/ClickHouse/pull/47981) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Support for CTE in parameterized views Implementation: Updated to allow query parameters while evaluating scalar subqueries. [#48065](https://github.com/ClickHouse/ClickHouse/pull/48065) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Support big integers `(U)Int128/(U)Int256`, `Map` with any key type and `DateTime64` with any precision (not only 3 and 6). [#48119](https://github.com/ClickHouse/ClickHouse/pull/48119) ([Kruglov Pavel](https://github.com/Avogar)).
- Allow skipping errors related to unknown enum values in row input formats. [#48133](https://github.com/ClickHouse/ClickHouse/pull/48133) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-9}

- ClickHouse 现在使用 `C++23` 进行构建。[#47424](https://github.com/ClickHouse/ClickHouse/pull/47424) ([Robert Schulze](https://github.com/rschu1ze))。
- 在 AST 模糊测试器中对 `EXPLAIN` 查询进行模糊测试。[#47803](https://github.com/ClickHouse/ClickHouse/pull/47803) [#47852](https://github.com/ClickHouse/ClickHouse/pull/47852) ([flynn](https://github.com/ucasfl))。
- 拆分压力测试和自动化向后兼容性检查(现为升级检查)。[#44879](https://github.com/ClickHouse/ClickHouse/pull/44879) ([Kruglov Pavel](https://github.com/Avogar))。
- 更新了 Docker 的 Ubuntu 镜像以消除一些虚假的安全报告。[#46784](https://github.com/ClickHouse/ClickHouse/pull/46784) ([Julio Jimenez](https://github.com/juliojimenez))。请注意,ClickHouse 没有依赖项且不需要 Docker。
- 在使用 "curl | sh" 下载 ClickHouse 时,添加了一个提示以允许删除现有的 `clickhouse` 下载。提示内容为 "ClickHouse binary clickhouse already exists. Overwrite? \[y/N\]"。[#46859](https://github.com/ClickHouse/ClickHouse/pull/46859) ([Dan Roscigno](https://github.com/DanRoscigno))。
- 修复了在旧发行版(例如 Amazon Linux 2)和 ARM 架构上服务器启动时找不到 glibc 2.28 符号的错误。[#47008](https://github.com/ClickHouse/ClickHouse/pull/47008) ([Robert Schulze](https://github.com/rschu1ze))。
- 为 clang 16 做准备。[#47027](https://github.com/ClickHouse/ClickHouse/pull/47027) ([Amos Bird](https://github.com/amosbird))。
- 添加了一个 CI 检查,确保 ClickHouse 可以在 ARM 架构上使用旧版 glibc 运行。[#47063](https://github.com/ClickHouse/ClickHouse/pull/47063) ([Robert Schulze](https://github.com/rschu1ze))。
- 添加了样式检查以防止错误使用 `NDEBUG` 宏。[#47699](https://github.com/ClickHouse/ClickHouse/pull/47699) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 稍微加快了构建速度。[#47714](https://github.com/ClickHouse/ClickHouse/pull/47714) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 将 `vectorscan` 升级到 5.4.9。[#47955](https://github.com/ClickHouse/ClickHouse/pull/47955) ([Robert Schulze](https://github.com/rschu1ze))。
- 添加了一个单元测试以断言 Apache Arrow 的致命日志记录不会中止。它涵盖了 [ClickHouse/arrow#16](https://github.com/ClickHouse/arrow/pull/16) 中的更改。[#47958](https://github.com/ClickHouse/ClickHouse/pull/47958) ([Arthur Passos](https://github.com/arthurpassos))。
- 恢复了原生 macOS 调试服务器构建的启动能力。[#48050](https://github.com/ClickHouse/ClickHouse/pull/48050) ([Robert Schulze](https://github.com/rschu1ze))。注意:此更改仅与开发相关,因为 ClickHouse 官方构建是通过交叉编译完成的。


#### 错误修复(官方稳定版本中用户可见的异常行为) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-9}

- Fix formats parser resetting, test processing bad messages in `Kafka` [#45693](https://github.com/ClickHouse/ClickHouse/pull/45693) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix data size calculation in Keeper [#46086](https://github.com/ClickHouse/ClickHouse/pull/46086) ([Antonio Andelic](https://github.com/antonio2368)).
- Fixed a bug in automatic retries of `DROP TABLE` query with `ReplicatedMergeTree` tables and `Atomic` databases. In rare cases it could lead to `Can't get data for node /zk_path/log_pointer` and `The specified key does not exist` errors if the ZooKeeper session expired during DROP and a new replicated table with the same path in ZooKeeper was created in parallel. [#46384](https://github.com/ClickHouse/ClickHouse/pull/46384) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix incorrect alias recursion while normalizing queries that prevented some queries to run. [#46609](https://github.com/ClickHouse/ClickHouse/pull/46609) ([Raúl Marín](https://github.com/Algunenano)).
- Fix IPv4/IPv6 serialization/deserialization in binary formats [#46616](https://github.com/ClickHouse/ClickHouse/pull/46616) ([Kruglov Pavel](https://github.com/Avogar)).
- ActionsDAG: do not change result of `and` during optimization [#46653](https://github.com/ClickHouse/ClickHouse/pull/46653) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
- Improve query cancellation when a client dies [#46681](https://github.com/ClickHouse/ClickHouse/pull/46681) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix arithmetic operations in aggregate optimization [#46705](https://github.com/ClickHouse/ClickHouse/pull/46705) ([Duc Canh Le](https://github.com/canhld94)).
- Fix possible `clickhouse-local`'s abort on JSONEachRow schema inference [#46731](https://github.com/ClickHouse/ClickHouse/pull/46731) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix changing an expired role [#46772](https://github.com/ClickHouse/ClickHouse/pull/46772) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix combined PREWHERE column accumulation from multiple steps [#46785](https://github.com/ClickHouse/ClickHouse/pull/46785) ([Alexander Gololobov](https://github.com/davenger)).
- Use initial range for fetching file size in HTTP read buffer. Without this change, some remote files couldn't be processed. [#46824](https://github.com/ClickHouse/ClickHouse/pull/46824) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix the incorrect progress bar while using the URL tables [#46830](https://github.com/ClickHouse/ClickHouse/pull/46830) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix MSan report in `maxIntersections` function [#46847](https://github.com/ClickHouse/ClickHouse/pull/46847) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix a bug in `Map` data type [#46856](https://github.com/ClickHouse/ClickHouse/pull/46856) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix wrong results of some LIKE searches when the LIKE pattern contains quoted non-quotable characters [#46875](https://github.com/ClickHouse/ClickHouse/pull/46875) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix - WITH FILL would produce abort when the Filling Transform processing an empty block [#46897](https://github.com/ClickHouse/ClickHouse/pull/46897) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix date and int inference from string in JSON [#46972](https://github.com/ClickHouse/ClickHouse/pull/46972) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix bug in zero-copy replication disk choice during fetch [#47010](https://github.com/ClickHouse/ClickHouse/pull/47010) ([alesapin](https://github.com/alesapin)).
- Fix a typo in systemd service definition [#47051](https://github.com/ClickHouse/ClickHouse/pull/47051) ([Palash Goel](https://github.com/palash-goel)).
- Fix the NOT_IMPLEMENTED error with CROSS JOIN and algorithm = auto [#47068](https://github.com/ClickHouse/ClickHouse/pull/47068) ([Vladimir C](https://github.com/vdimir)).
- Fix the problem that the 'ReplicatedMergeTree' table failed to insert two similar data when the 'part_type' is configured as 'InMemory' mode (experimental feature). [#47121](https://github.com/ClickHouse/ClickHouse/pull/47121) ([liding1992](https://github.com/liding1992)).
- External dictionaries / library-bridge: Fix error "unknown library method 'extDict_libClone'" [#47136](https://github.com/ClickHouse/ClickHouse/pull/47136) ([alex filatov](https://github.com/phil-88)).
- Fix race condition in a grace hash join with limit [#47153](https://github.com/ClickHouse/ClickHouse/pull/47153) ([Vladimir C](https://github.com/vdimir)).
- Fix concrete columns PREWHERE support [#47154](https://github.com/ClickHouse/ClickHouse/pull/47154) ([Azat Khuzhin](https://github.com/azat)).
- Fix possible deadlock in Query Status [#47161](https://github.com/ClickHouse/ClickHouse/pull/47161) ([Kruglov Pavel](https://github.com/Avogar)).
- Forbid insert select for the same `Join` table, as it leads to a deadlock [#47260](https://github.com/ClickHouse/ClickHouse/pull/47260) ([Vladimir C](https://github.com/vdimir)).
- Skip merged partitions for `min_age_to_force_merge_seconds` merges [#47303](https://github.com/ClickHouse/ClickHouse/pull/47303) ([Antonio Andelic](https://github.com/antonio2368)).
- Modify find_first_symbols, so it works as expected for find_first_not_symbols [#47304](https://github.com/ClickHouse/ClickHouse/pull/47304) ([Arthur Passos](https://github.com/arthurpassos)).
- Fix big numbers inference in CSV [#47410](https://github.com/ClickHouse/ClickHouse/pull/47410) ([Kruglov Pavel](https://github.com/Avogar)).
- Disable logical expression optimizer for expression with aliases. [#47451](https://github.com/ClickHouse/ClickHouse/pull/47451) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix error in `decodeURLComponent` [#47457](https://github.com/ClickHouse/ClickHouse/pull/47457) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix explain graph with projection [#47473](https://github.com/ClickHouse/ClickHouse/pull/47473) ([flynn](https://github.com/ucasfl)).
- Fix query parameters [#47488](https://github.com/ClickHouse/ClickHouse/pull/47488) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Parameterized view: a bug fix. [#47495](https://github.com/ClickHouse/ClickHouse/pull/47495) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Fuzzer of data formats, and the corresponding fixes. [#47519](https://github.com/ClickHouse/ClickHouse/pull/47519) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix monotonicity check for `DateTime64` [#47526](https://github.com/ClickHouse/ClickHouse/pull/47526) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix "block structure mismatch" for a Nullable LowCardinality column [#47537](https://github.com/ClickHouse/ClickHouse/pull/47537) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Proper fix for a bug in Apache Parquet [#45878](https://github.com/ClickHouse/ClickHouse/issues/45878) [#47538](https://github.com/ClickHouse/ClickHouse/pull/47538) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix `BSONEachRow` parallel parsing when document size is invalid [#47540](https://github.com/ClickHouse/ClickHouse/pull/47540) ([Kruglov Pavel](https://github.com/Avogar)).
- Preserve error in `system.distribution_queue` on `SYSTEM FLUSH DISTRIBUTED` [#47541](https://github.com/ClickHouse/ClickHouse/pull/47541) ([Azat Khuzhin](https://github.com/azat)).
- Check for duplicate column in `BSONEachRow` format [#47609](https://github.com/ClickHouse/ClickHouse/pull/47609) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix wait for zero copy lock during move [#47631](https://github.com/ClickHouse/ClickHouse/pull/47631) ([alesapin](https://github.com/alesapin)).
- Fix aggregation by partitions [#47634](https://github.com/ClickHouse/ClickHouse/pull/47634) ([Nikita Taranov](https://github.com/nickitat)).
- Fix bug in tuple as array serialization in `BSONEachRow` format [#47690](https://github.com/ClickHouse/ClickHouse/pull/47690) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix crash in `polygonsSymDifferenceCartesian` [#47702](https://github.com/ClickHouse/ClickHouse/pull/47702) ([pufit](https://github.com/pufit)).
- Fix reading from storage `File` compressed files with `zlib` and `gzip` compression [#47796](https://github.com/ClickHouse/ClickHouse/pull/47796) ([Anton Popov](https://github.com/CurtizJ)).
- Improve empty query detection for PostgreSQL (for pgx golang driver) [#47854](https://github.com/ClickHouse/ClickHouse/pull/47854) ([Azat Khuzhin](https://github.com/azat)).
- Fix DateTime monotonicity check for LowCardinality types [#47860](https://github.com/ClickHouse/ClickHouse/pull/47860) ([Antonio Andelic](https://github.com/antonio2368)).
- Use restore_threads (not backup_threads) for RESTORE ASYNC [#47861](https://github.com/ClickHouse/ClickHouse/pull/47861) ([Azat Khuzhin](https://github.com/azat)).
- Fix DROP COLUMN with ReplicatedMergeTree containing projections [#47883](https://github.com/ClickHouse/ClickHouse/pull/47883) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix for Replicated database recovery [#47901](https://github.com/ClickHouse/ClickHouse/pull/47901) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Hotfix for too verbose warnings in HTTP [#47903](https://github.com/ClickHouse/ClickHouse/pull/47903) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix "Field value too long" in `catboostEvaluate` [#47970](https://github.com/ClickHouse/ClickHouse/pull/47970) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix [#36971](https://github.com/ClickHouse/ClickHouse/issues/36971): Watchdog: exit with non-zero code if child process exits [#47973](https://github.com/ClickHouse/ClickHouse/pull/47973) ([Коренберг Марк](https://github.com/socketpair)).
- Fix for "index file `cidx` is unexpectedly long" [#48010](https://github.com/ClickHouse/ClickHouse/pull/48010) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Fix MaterializedPostgreSQL query to get attributes (replica-identity) [#48015](https://github.com/ClickHouse/ClickHouse/pull/48015) ([Solomatov Sergei](https://github.com/solomatovs)).
- parseDateTime(): Fix UB (signed integer overflow) [#48019](https://github.com/ClickHouse/ClickHouse/pull/48019) ([Robert Schulze](https://github.com/rschu1ze)).
- Use unique names for Records in Avro to avoid reusing its schema [#48057](https://github.com/ClickHouse/ClickHouse/pull/48057) ([Kruglov Pavel](https://github.com/Avogar)).
- Correctly set TCP/HTTP socket timeouts in Keeper [#48108](https://github.com/ClickHouse/ClickHouse/pull/48108) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix possible member call on null pointer in `Avro` format [#48184](https://github.com/ClickHouse/ClickHouse/pull/48184) ([Kruglov Pavel](https://github.com/Avogar)).

### <a id="232"></a> ClickHouse release 23.2, 2023-02-23 {#232}

#### 向后不兼容的变更 {#backward-incompatible-change-8}

- 扩展函数 "toDayOfWeek()"(别名:"DAYOFWEEK"),增加一个模式参数,用于编码一周是从周一还是周日开始,以及计数是从 0 还是 1 开始。为了与其他日期时间函数保持一致,模式参数被插入到时间参数和时区参数之间。这会破坏现有的(之前未记录的)双参数语法 "toDayOfWeek(time, time_zone)" 的使用。修复方法是将函数重写为 "toDayOfWeek(time, 0, time_zone)"。[#45233](https://github.com/ClickHouse/ClickHouse/pull/45233) ([Robert Schulze](https://github.com/rschu1ze))。
- 将设置 `max_query_cache_size` 重命名为 `filesystem_cache_max_download_size`。[#45614](https://github.com/ClickHouse/ClickHouse/pull/45614) ([Kseniia Sumarokova](https://github.com/kssenii))。
- `default` 用户默认将不再拥有 `SHOW NAMED COLLECTION` 访问类型的权限(例如,`default` 用户将不再能够像以前那样向其他用户授予 ALL 权限,因此此 PR 向后不兼容)。[#46010](https://github.com/ClickHouse/ClickHouse/pull/46010) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 如果 SETTINGS 子句在 FORMAT 子句之前指定,则这些设置也将应用于格式化。[#46003](https://github.com/ClickHouse/ClickHouse/pull/46003) ([Azat Khuzhin](https://github.com/azat))。
- 移除对设置 `materialized_postgresql_allow_automatic_update` 的支持(该设置默认为关闭状态)。[#46106](https://github.com/ClickHouse/ClickHouse/pull/46106) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 在实际数据集上略微提升了 `countDigits` 的性能。这解决了 [#44518](https://github.com/ClickHouse/ClickHouse/issues/44518)。在以前的版本中,`countDigits(0)` 返回 `0`;现在返回 `1`,这更加正确,并且符合现有文档。[#46187](https://github.com/ClickHouse/ClickHouse/pull/46187) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 禁止创建由编解码器 "Delta" 或 "DoubleDelta" 后跟编解码器 "Gorilla" 或 "FPC" 组合压缩的新列。可以通过设置 "allow_suspicious_codecs = true" 来绕过此限制。[#45652](https://github.com/ClickHouse/ClickHouse/pull/45652) ([Robert Schulze](https://github.com/rschu1ze))。


#### 新功能 {#new-feature-10}

- 新增 `StorageIceberg` 存储引擎和表函数 `iceberg`,用于访问 S3 上的 Iceberg 表存储。[#45384](https://github.com/ClickHouse/ClickHouse/pull/45384) ([flynn](https://github.com/ucasfl))。
- 允许通过 `SETTINGS disk = '<disk_name>'`(替代 `storage_policy`)配置存储,并支持显式磁盘创建 `SETTINGS disk = disk(type=s3, ...)`。[#41976](https://github.com/ClickHouse/ClickHouse/pull/41976) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 在 `system.part_log` 中公开 `ProfileEvents` 计数器。[#38614](https://github.com/ClickHouse/ClickHouse/pull/38614) ([Bharat Nallan](https://github.com/bharatnc))。
- 增强现有的 `ReplacingMergeTree` 引擎以支持重复插入。该引擎在单个 MergeTree 引擎中结合了 `ReplacingMergeTree` 和 `CollapsingMergeTree` 的功能。查询时不会返回已删除的数据,但这些数据也不会从磁盘中移除。[#41005](https://github.com/ClickHouse/ClickHouse/pull/41005) ([youennL-cs](https://github.com/youennL-cs))。
- 新增 `generateULID` 函数。关闭 [#36536](https://github.com/ClickHouse/ClickHouse/issues/36536)。[#44662](https://github.com/ClickHouse/ClickHouse/pull/44662) ([Nikolay Degterinsky](https://github.com/evillique))。
- 新增 `corrMatrix` 聚合函数,用于计算每两列之间的相关性。此外,由于聚合函数 `covarSamp` 和 `covarPop` 与 `corr` 类似,同时新增了 `covarSampMatrix` 和 `covarPopMatrix`。@alexey-milovidov 关闭 [#44587](https://github.com/ClickHouse/ClickHouse/issues/44587)。[#44680](https://github.com/ClickHouse/ClickHouse/pull/44680) ([FFFFFFFHHHHHHH](https://github.com/FFFFFFFHHHHHHH))。
- 引入 `arrayShuffle` 函数,用于随机数组排列。[#45271](https://github.com/ClickHouse/ClickHouse/pull/45271) ([Joanna Hulboj](https://github.com/jh0x))。
- 支持 Arrow 中的 `FIXED_SIZE_BINARY` 类型和 Parquet 中的 `FIXED_LENGTH_BYTE_ARRAY` 类型,并将它们映射到 `FixedString`。新增设置 `output_format_parquet_fixed_string_as_fixed_byte_array` 和 `output_format_arrow_fixed_string_as_fixed_byte_array`,用于控制 FixedString 的默认输出类型。关闭 [#45326](https://github.com/ClickHouse/ClickHouse/issues/45326)。[#45340](https://github.com/ClickHouse/ClickHouse/pull/45340) ([Kruglov Pavel](https://github.com/Avogar))。
- 在 `system.replication_queue` 中新增列 `last_exception_time`。[#45457](https://github.com/ClickHouse/ClickHouse/pull/45457) ([Frank Chen](https://github.com/FrankChen021))。
- 新增两个函数,允许在 SipHash{64,128} 中使用用户自定义的密钥/种子。[#45513](https://github.com/ClickHouse/ClickHouse/pull/45513) ([Salvatore Mesoraca](https://github.com/aiven-sal))。
- 允许表函数 `format` 使用三参数版本。关闭 [#45808](https://github.com/ClickHouse/ClickHouse/issues/45808)。[#45873](https://github.com/ClickHouse/ClickHouse/pull/45873) ([FFFFFFFHHHHHHH](https://github.com/FFFFFFFHHHHHHH))。
- 新增对 'x'、'w'、'S' 的 `JodaTime` 格式支持。参考 https://joda-time.sourceforge.net/apidocs/org/joda/time/format/DateTimeFormat.html。[#46073](https://github.com/ClickHouse/ClickHouse/pull/46073) ([zk_kiger](https://github.com/zk-kiger))。
- 支持窗口函数 `ntile`。([lgbo](https://github.com/lgbo-ustc))。
- 新增设置 `final`,用于隐式地将 `FINAL` 修饰符应用于每个表。[#40945](https://github.com/ClickHouse/ClickHouse/pull/40945) ([Arthur Passos](https://github.com/arthurpassos))。
- 新增 `arrayPartialSort` 和 `arrayPartialReverseSort` 函数。[#46296](https://github.com/ClickHouse/ClickHouse/pull/46296) ([Joanna Hulboj](https://github.com/jh0x))。
- 新增 HTTP 参数 `client_protocol_version`,允许为使用 Native 格式的 HTTP 响应设置客户端协议版本。[#40397](https://github.com/ClickHouse/ClickHouse/issues/40397)。[#46360](https://github.com/ClickHouse/ClickHouse/pull/46360) ([Geoff Genz](https://github.com/genzgd))。
- 新增函数 `regexpExtract`,类似于 Spark 函数 `REGEXP_EXTRACT`,用于实现兼容性。该函数与现有函数 `extract` 类似。[#46469](https://github.com/ClickHouse/ClickHouse/pull/46469) ([李扬](https://github.com/taiyang-li))。
- 新增函数 `JSONArrayLength`,返回最外层 JSON 数组中的元素数量。如果输入的 JSON 字符串无效,该函数返回 NULL。[#46631](https://github.com/ClickHouse/ClickHouse/pull/46631) ([李扬](https://github.com/taiyang-li))。





#### 性能改进 {#performance-improvement-10}

- 引入的逻辑在 PREWHERE 条件为多个条件的合取(cond1 AND cond2 AND ...)时生效。它将需要读取相同列的条件分组为多个步骤。每个步骤执行后,会计算完整条件的相应部分,并可能过滤结果行。这样可以在后续步骤中读取更少的行,从而节省 IO 带宽并减少计算量。此逻辑目前默认禁用。一旦确认没有任何回归问题,它将在未来的某个版本中默认启用,因此强烈建议用于测试。可以通过 2 个设置控制:"enable_multiple_prewhere_read_steps" 和 "move_all_conditions_to_prewhere"。[#46140](https://github.com/ClickHouse/ClickHouse/pull/46140) ([Alexander Gololobov](https://github.com/davenger))。
- 添加了一个选项,当表分区键和 group by 键兼容时,可以独立聚合分区。由设置 `allow_aggregate_partitions_independently` 控制。由于适用范围有限,默认禁用(请参阅文档)。[#45364](https://github.com/ClickHouse/ClickHouse/pull/45364) ([Nikita Taranov](https://github.com/nickitat))。
- 允许对 Compact 格式的数据部分使用垂直合并算法。这将使 ClickHouse 服务器在后台操作中使用更少的内存。这解决了 [#46084](https://github.com/ClickHouse/ClickHouse/issues/46084)。[#45681](https://github.com/ClickHouse/ClickHouse/pull/45681) [#46282](https://github.com/ClickHouse/ClickHouse/pull/46282) ([Anton Popov](https://github.com/CurtizJ))。
- 通过使用批量读取器优化 `Parquet` 读取器。[#45878](https://github.com/ClickHouse/ClickHouse/pull/45878) ([LiuNeng](https://github.com/liuneng1994))。
- 添加新的 `local_filesystem_read_method` 方法 `io_uring`,基于异步 Linux [io_uring](https://kernel.dk/io_uring.pdf) 子系统,与默认的 `pread` 方法相比,几乎在所有情况下都能提升读取性能。[#38456](https://github.com/ClickHouse/ClickHouse/pull/38456) ([Saulius Valatka](https://github.com/sauliusvl))。
- 当逻辑等价时,重写带有 `if` 表达式作为参数的聚合函数。例如,`avg(if(cond, col, null))` 可以重写为 avgIf(cond, col)。这有助于提升性能。[#44730](https://github.com/ClickHouse/ClickHouse/pull/44730) ([李扬](https://github.com/taiyang-li))。
- 使用 avx512 指令提升 lower/upper 函数性能。[#37894](https://github.com/ClickHouse/ClickHouse/pull/37894) ([yaqi-zhao](https://github.com/yaqi-zhao))。
- 移除了在具有 >=32 核心且禁用 SMT 的系统上 ClickHouse 仅使用一半核心的限制(即在 BIOS 中禁用超线程的情况)。[#44973](https://github.com/ClickHouse/ClickHouse/pull/44973) ([Robert Schulze](https://github.com/rschu1ze))。
- 通过列式执行提升函数 `multiIf` 的性能,速度提升 2.3 倍。[#45296](https://github.com/ClickHouse/ClickHouse/pull/45296) ([李扬](https://github.com/taiyang-li))。
- 为函数 `position` 添加快速路径,用于搜索字符串为空的情况。[#45382](https://github.com/ClickHouse/ClickHouse/pull/45382) ([李扬](https://github.com/taiyang-li))。
- 默认启用 `query_plan_remove_redundant_sorting` 优化。优化实现于 [#45420](https://github.com/ClickHouse/ClickHouse/issues/45420)。[#45567](https://github.com/ClickHouse/ClickHouse/pull/45567) ([Igor Nikonov](https://github.com/devcrafter))。
- 增加 HTTP 传输编码块大小,以提升使用 HTTP 接口的大型查询的性能。[#45593](https://github.com/ClickHouse/ClickHouse/pull/45593) ([Geoff Genz](https://github.com/genzgd))。
- 修复了从具有大量 `Array`/`Map`/`Nested` 列的表中读取的短 `SELECT` 查询的性能问题。[#45630](https://github.com/ClickHouse/ClickHouse/pull/45630) ([Anton Popov](https://github.com/CurtizJ))。
- 提升大整数和十进制类型的过滤性能。[#45949](https://github.com/ClickHouse/ClickHouse/pull/45949) ([李扬](https://github.com/taiyang-li))。
- 此更改可以有效减少从 ColumnNullable(UInt8) 获取过滤器的开销,并提升整体查询性能。为了评估此更改的影响,我们采用了 TPC-H 基准测试,但将列类型从非空修改为可空,并测量其查询的 QPS 作为性能指标。[#45962](https://github.com/ClickHouse/ClickHouse/pull/45962) ([Zhiguo Zhou](https://github.com/ZhiguoZh))。
- 将 `_part` 和 `_partition_id` 虚拟列设置为 `LowCardinality(String)` 类型。解决了 [#45964](https://github.com/ClickHouse/ClickHouse/issues/45964)。[#45975](https://github.com/ClickHouse/ClickHouse/pull/45975) ([flynn](https://github.com/ucasfl))。
- 当精度不变时,提升 Decimal 转换的性能。[#46095](https://github.com/ClickHouse/ClickHouse/pull/46095) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 允许增加读取数据的预取量。[#46168](https://github.com/ClickHouse/ClickHouse/pull/46168) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 将 `arrayExists(x -> x = 1, arr)` 重写为 `has(arr, 1)`,性能提升 1.34 倍。[#46188](https://github.com/ClickHouse/ClickHouse/pull/46188) ([李扬](https://github.com/taiyang-li))。
- 修复非远程磁盘上垂直合并的内存使用过大问题。对远程磁盘遵守 `max_insert_delayed_streams_for_parallel_write` 设置。[#46275](https://github.com/ClickHouse/ClickHouse/pull/46275) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 将 zstd 更新到 v1.5.4。它在性能和压缩率方面有一些小幅改进。如果您运行不同版本的 ClickHouse 副本,可能会看到合理的错误消息 `Data after merge/mutation is not byte-identical to data on another replicas.` 及其解释。这些消息是正常的,您无需担心。[#46280](https://github.com/ClickHouse/ClickHouse/pull/46280) ([Raúl Marín](https://github.com/Algunenano))。
- 修复由 [#39737](https://github.com/ClickHouse/ClickHouse/issues/39737) 引起的性能下降。[#46309](https://github.com/ClickHouse/ClickHouse/pull/46309) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 即使在复制队列很大的情况下,`replicas_status` 处理程序也会快速响应。[#46310](https://github.com/ClickHouse/ClickHouse/pull/46310) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 为聚合函数 `sum`、一元算术函数和比较函数添加 avx512 支持。[#37870](https://github.com/ClickHouse/ClickHouse/pull/37870) ([zhao zhou](https://github.com/zzachimed))。
- 重写了标记分布和读取整体协调的代码,以实现最大的性能提升。这解决了 [#34527](https://github.com/ClickHouse/ClickHouse/issues/34527)。[#43772](https://github.com/ClickHouse/ClickHouse/pull/43772) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 移除查询(子查询)中的冗余 DISTINCT 子句。在查询计划之上实现。它对 DISTINCT 子句执行与 `optimize_duplicate_order_by_and_distinct` 类似的优化。可以通过 `query_plan_remove_redundant_distinct` 设置启用。相关于 [#42648](https://github.com/ClickHouse/ClickHouse/issues/42648)。[#44176](https://github.com/ClickHouse/ClickHouse/pull/44176) ([Igor Nikonov](https://github.com/devcrafter))。
- 几个查询重写优化:`sumIf(123, cond) -> 123 * countIf(1, cond)`,`sum(if(cond, 123, 0)) -> 123 * countIf(cond)`,`sum(if(cond, 0, 123)) -> 123 * countIf(not(cond))` [#44728](https://github.com/ClickHouse/ClickHouse/pull/44728) ([李扬](https://github.com/taiyang-li))。
- 改进了内存限制合并和按顺序聚合在顶层查询计划中的交互方式。以前,在某些实际上不需要的情况下,我们会回退到 AIO 的显式排序。[#45892](https://github.com/ClickHouse/ClickHouse/pull/45892) ([Nikita Taranov](https://github.com/nickitat))。
- 默认使用轮询方式调度并发合并,以确保公平且无饥饿的操作。以前,在严重过载的分片中,由于使用严格的优先级调度,大型合并可能会被较小的合并饿死。添加了 `background_merges_mutations_scheduling_policy` 服务器配置选项,用于选择调度算法(`round_robin` 或 `shortest_task_first`)。[#46247](https://github.com/ClickHouse/ClickHouse/pull/46247) ([Sergei Trifonov](https://github.com/serxa))。





#### 改进 {#improvement-10}

- Enable retries for INSERT by default in case of ZooKeeper session loss. We already use it in production. [#46308](https://github.com/ClickHouse/ClickHouse/pull/46308) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Add ability to ignore unknown keys in JSON object for named tuples (`input_format_json_ignore_unknown_keys_in_named_tuple`). [#45678](https://github.com/ClickHouse/ClickHouse/pull/45678) ([Azat Khuzhin](https://github.com/azat)).
- Support optimizing the `where` clause with sorting key expression move to `prewhere` for query with `final`. [#38893](https://github.com/ClickHouse/ClickHouse/issues/38893). [#38950](https://github.com/ClickHouse/ClickHouse/pull/38950) ([hexiaoting](https://github.com/hexiaoting)).
- Add new metrics for backups: num_processed_files and processed_files_size described actual number of processed files. [#42244](https://github.com/ClickHouse/ClickHouse/pull/42244) ([Aleksandr](https://github.com/AVMusorin)).
- Added retries on interserver DNS errors. [#43179](https://github.com/ClickHouse/ClickHouse/pull/43179) ([Anton Kozlov](https://github.com/tonickkozlov)).
- Keeper improvement: try preallocating space on the disk to avoid undefined out-of-space issues. Introduce setting `max_log_file_size` for the maximum size of Keeper's Raft log files. [#44370](https://github.com/ClickHouse/ClickHouse/pull/44370) ([Antonio Andelic](https://github.com/antonio2368)).
- Optimize behavior for a replica delay api logic in case the replica is read-only. [#45148](https://github.com/ClickHouse/ClickHouse/pull/45148) ([mateng915](https://github.com/mateng0915)).
- Ask for the password in clickhouse-client interactively in a case when the empty password is wrong. Closes [#46702](https://github.com/ClickHouse/ClickHouse/issues/46702). [#46730](https://github.com/ClickHouse/ClickHouse/pull/46730) ([Nikolay Degterinsky](https://github.com/evillique)).
- Mark `Gorilla` compression on columns of non-Float\* type as suspicious. [#45376](https://github.com/ClickHouse/ClickHouse/pull/45376) ([Robert Schulze](https://github.com/rschu1ze)).
- Show replica name that is executing a merge in the `postpone_reason` column. [#45458](https://github.com/ClickHouse/ClickHouse/pull/45458) ([Frank Chen](https://github.com/FrankChen021)).
- Save exception stack trace in part_log. [#45459](https://github.com/ClickHouse/ClickHouse/pull/45459) ([Frank Chen](https://github.com/FrankChen021)).
- The `regexp_tree` dictionary is polished and now it is compatible with https://github.com/ua-parser/uap-core. [#45631](https://github.com/ClickHouse/ClickHouse/pull/45631) ([Han Fei](https://github.com/hanfei1991)).
- Updated checking of `SYSTEM SYNC REPLICA`, resolves [#45508](https://github.com/ClickHouse/ClickHouse/issues/45508) [#45648](https://github.com/ClickHouse/ClickHouse/pull/45648) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Rename setting `replication_alter_partitions_sync` to `alter_sync`. [#45659](https://github.com/ClickHouse/ClickHouse/pull/45659) ([Antonio Andelic](https://github.com/antonio2368)).
- The `generateRandom` table function and the engine now support `LowCardinality` data types. This is useful for testing, for example you can write `INSERT INTO table SELECT * FROM generateRandom() LIMIT 1000`. This is needed to debug [#45590](https://github.com/ClickHouse/ClickHouse/issues/45590). [#45661](https://github.com/ClickHouse/ClickHouse/pull/45661) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- The experimental query result cache now provides more modular configuration settings. [#45679](https://github.com/ClickHouse/ClickHouse/pull/45679) ([Robert Schulze](https://github.com/rschu1ze)).
- Renamed "query result cache" to "query cache". [#45682](https://github.com/ClickHouse/ClickHouse/pull/45682) ([Robert Schulze](https://github.com/rschu1ze)).
- add `SYSTEM SYNC FILE CACHE` command. It will do the `sync` syscall. [#8921](https://github.com/ClickHouse/ClickHouse/issues/8921). [#45685](https://github.com/ClickHouse/ClickHouse/pull/45685) ([DR](https://github.com/freedomDR)).
- Add a new S3 setting `allow_head_object_request`. This PR makes usage of `GetObjectAttributes` request instead of `HeadObject` introduced in https://github.com/ClickHouse/ClickHouse/pull/45288 optional (and disabled by default). [#45701](https://github.com/ClickHouse/ClickHouse/pull/45701) ([Vitaly Baranov](https://github.com/vitlibar)).
- Add ability to override connection settings based on connection names (that said that now you can forget about storing password for each connection, you can simply put everything into `~/.clickhouse-client/config.xml` and even use different history files for them, which can be also useful). [#45715](https://github.com/ClickHouse/ClickHouse/pull/45715) ([Azat Khuzhin](https://github.com/azat)).
- Arrow format: support the duration type. Closes [#45669](https://github.com/ClickHouse/ClickHouse/issues/45669). [#45750](https://github.com/ClickHouse/ClickHouse/pull/45750) ([flynn](https://github.com/ucasfl)).
- Extend the logging in the Query Cache to improve investigations of the caching behavior. [#45751](https://github.com/ClickHouse/ClickHouse/pull/45751) ([Robert Schulze](https://github.com/rschu1ze)).
- The query cache's server-level settings are now reconfigurable at runtime. [#45758](https://github.com/ClickHouse/ClickHouse/pull/45758) ([Robert Schulze](https://github.com/rschu1ze)).
- Hide password in logs when a table function's arguments are specified with a named collection. [#45774](https://github.com/ClickHouse/ClickHouse/pull/45774) ([Vitaly Baranov](https://github.com/vitlibar)).
- Improve internal S3 client to correctly deduce regions and redirections for different types of URLs. [#45783](https://github.com/ClickHouse/ClickHouse/pull/45783) ([Antonio Andelic](https://github.com/antonio2368)).
- Add support for Map, IPv4 and IPv6 types in generateRandom. Mostly useful for testing. [#45785](https://github.com/ClickHouse/ClickHouse/pull/45785) ([Raúl Marín](https://github.com/Algunenano)).
- Support empty/notEmpty for IP types. [#45799](https://github.com/ClickHouse/ClickHouse/pull/45799) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- The column `num_processed_files` was split into two columns: `num_files` (for BACKUP) and `files_read` (for RESTORE). The column `processed_files_size` was split into two columns: `total_size` (for BACKUP) and `bytes_read` (for RESTORE). [#45800](https://github.com/ClickHouse/ClickHouse/pull/45800) ([Vitaly Baranov](https://github.com/vitlibar)).
- Add support for `SHOW ENGINES` query for MySQL compatibility. [#45859](https://github.com/ClickHouse/ClickHouse/pull/45859) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
- Improved how the obfuscator deals with queries. [#45867](https://github.com/ClickHouse/ClickHouse/pull/45867) ([Raúl Marín](https://github.com/Algunenano)).
- Improve behaviour of conversion into Date for boundary value 65535 (2149-06-06). [#46042](https://github.com/ClickHouse/ClickHouse/pull/46042) [#45914](https://github.com/ClickHouse/ClickHouse/pull/45914) ([Joanna Hulboj](https://github.com/jh0x)).
- Add setting `check_referential_table_dependencies` to check referential dependencies on `DROP TABLE`. This PR solves [#38326](https://github.com/ClickHouse/ClickHouse/issues/38326). [#45936](https://github.com/ClickHouse/ClickHouse/pull/45936) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix `tupleElement` to return `Null` when having `Null` argument. Closes [#45894](https://github.com/ClickHouse/ClickHouse/issues/45894). [#45952](https://github.com/ClickHouse/ClickHouse/pull/45952) ([flynn](https://github.com/ucasfl)).
- Throw an error on no files satisfying the S3 wildcard. Closes [#45587](https://github.com/ClickHouse/ClickHouse/issues/45587). [#45957](https://github.com/ClickHouse/ClickHouse/pull/45957) ([chen](https://github.com/xiedeyantu)).
- Use cluster state data to check concurrent backup/restore. [#45982](https://github.com/ClickHouse/ClickHouse/pull/45982) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- ClickHouse Client: Use "exact" matching for fuzzy search, which has correct case ignorance and more appropriate algorithm for matching SQL queries. [#46000](https://github.com/ClickHouse/ClickHouse/pull/46000) ([Azat Khuzhin](https://github.com/azat)).
- Forbid wrong create View syntax `CREATE View X TO Y AS SELECT`. Closes [#4331](https://github.com/ClickHouse/ClickHouse/issues/4331). [#46043](https://github.com/ClickHouse/ClickHouse/pull/46043) ([flynn](https://github.com/ucasfl)).
- Storage `Log` family support setting the `storage_policy`. Closes [#43421](https://github.com/ClickHouse/ClickHouse/issues/43421). [#46044](https://github.com/ClickHouse/ClickHouse/pull/46044) ([flynn](https://github.com/ucasfl)).
- Improve `JSONColumns` format when the result is empty. Closes [#46024](https://github.com/ClickHouse/ClickHouse/issues/46024). [#46053](https://github.com/ClickHouse/ClickHouse/pull/46053) ([flynn](https://github.com/ucasfl)).
- Add reference implementation for SipHash128. [#46065](https://github.com/ClickHouse/ClickHouse/pull/46065) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
- Add a new metric to record allocations times and bytes using mmap. [#46068](https://github.com/ClickHouse/ClickHouse/pull/46068) ([李扬](https://github.com/taiyang-li)).
- Currently for functions like `leftPad`, `rightPad`, `leftPadUTF8`, `rightPadUTF8`, the second argument `length` must be UInt8|16|32|64|128|256. Which is too strict for clickhouse users, besides, it is not consistent with other similar functions like `arrayResize`, `substring` and so on. [#46103](https://github.com/ClickHouse/ClickHouse/pull/46103) ([李扬](https://github.com/taiyang-li)).
- Fix assertion in the `welchTTest` function in debug build when the resulting statistics is NaN. Unified the behavior with other similar functions. Change the behavior of `studentTTest` to return NaN instead of throwing an exception because the previous behavior was inconvenient. This closes [#41176](https://github.com/ClickHouse/ClickHouse/issues/41176) This closes [#42162](https://github.com/ClickHouse/ClickHouse/issues/42162). [#46141](https://github.com/ClickHouse/ClickHouse/pull/46141) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- More convenient usage of big integers and ORDER BY WITH FILL. Allow using plain integers for start and end points in WITH FILL when ORDER BY big (128-bit and 256-bit) integers. Fix the wrong result for big integers with negative start or end points. This closes [#16733](https://github.com/ClickHouse/ClickHouse/issues/16733). [#46152](https://github.com/ClickHouse/ClickHouse/pull/46152) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Add `parts`, `active_parts` and `total_marks` columns to `system.tables` on [issue](https://github.com/ClickHouse/ClickHouse/issues/44336). [#46161](https://github.com/ClickHouse/ClickHouse/pull/46161) ([attack204](https://github.com/attack204)).
- Functions "multi[Fuzzy]Match(Any|AnyIndex|AllIndices}" now reject regexes which will likely evaluate very slowly in vectorscan. [#46167](https://github.com/ClickHouse/ClickHouse/pull/46167) ([Robert Schulze](https://github.com/rschu1ze)).
- When `insert_null_as_default` is enabled and column doesn't have defined default value, the default of column type will be used. Also this PR fixes using default values on nulls in case of LowCardinality columns. [#46171](https://github.com/ClickHouse/ClickHouse/pull/46171) ([Kruglov Pavel](https://github.com/Avogar)).
- Prefer explicitly defined access keys for S3 clients. If `use_environment_credentials` is set to `true`, and the user has provided the access key through query or config, they will be used instead of the ones from the environment variable. [#46191](https://github.com/ClickHouse/ClickHouse/pull/46191) ([Antonio Andelic](https://github.com/antonio2368)).
- Add an alias "DATE_FORMAT()" for function "formatDateTime()" to improve compatibility with MySQL's SQL dialect, extend function `formatDateTime` with substitutions "a", "b", "c", "h", "i", "k", "l" "r", "s", "W". ### Documentation entry for user-facing changes User-readable short description: `DATE_FORMAT` is an alias of `formatDateTime`. Formats a Time according to the given Format string. Format is a constant expression, so you cannot have multiple formats for a single result column. (Provide link to [formatDateTime](/sql-reference/functions/date-time-functions/#formatDateTime)). [#46302](https://github.com/ClickHouse/ClickHouse/pull/46302) ([Jake Bamrah](https://github.com/JakeBamrah)).
- Add `ProfileEvents` and `CurrentMetrics` about the callback tasks for parallel replicas (`s3Cluster` and `MergeTree` tables). [#46313](https://github.com/ClickHouse/ClickHouse/pull/46313) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Add support for `DELETE` and `UPDATE` for tables using `KeeperMap` storage engine. [#46330](https://github.com/ClickHouse/ClickHouse/pull/46330) ([Antonio Andelic](https://github.com/antonio2368)).
- Allow writing RENAME queries with query parameters. Resolves [#45778](https://github.com/ClickHouse/ClickHouse/issues/45778). [#46407](https://github.com/ClickHouse/ClickHouse/pull/46407) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix parameterized SELECT queries with REPLACE transformer. Resolves [#33002](https://github.com/ClickHouse/ClickHouse/issues/33002). [#46420](https://github.com/ClickHouse/ClickHouse/pull/46420) ([Nikolay Degterinsky](https://github.com/evillique)).
- Exclude the internal database used for temporary/external tables from the calculation of asynchronous metric "NumberOfDatabases". This makes the behavior consistent with system table "system.databases". [#46435](https://github.com/ClickHouse/ClickHouse/pull/46435) ([Robert Schulze](https://github.com/rschu1ze)).
- Added `last_exception_time` column into distribution_queue table. [#46564](https://github.com/ClickHouse/ClickHouse/pull/46564) ([Aleksandr](https://github.com/AVMusorin)).
- Support for IN clause with parameter in parameterized views. [#46583](https://github.com/ClickHouse/ClickHouse/pull/46583) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Do not load named collections on server startup (load them on first access instead). [#46607](https://github.com/ClickHouse/ClickHouse/pull/46607) ([Kseniia Sumarokova](https://github.com/kssenii)).

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-10}

- 引入由 LLVM 运行时实现的 GWP-ASan。此更改关闭了 [#27039](https://github.com/ClickHouse/ClickHouse/issues/27039)。[#45226](https://github.com/ClickHouse/ClickHouse/pull/45226) ([Han Fei](https://github.com/hanfei1991))。
- 我们希望使测试更不稳定、更易出现波动:在测试中为 MergeTree 设置添加随机化。[#38983](https://github.com/ClickHouse/ClickHouse/pull/38983) ([Anton Popov](https://github.com/CurtizJ))。
- 在 PowerPC 上启用 HDFS 支持,这有助于修复以下功能测试:02113_hdfs_assert.sh、02244_hdfs_cluster.sql 和 02368_cancel_write_into_hdfs.sh。[#44949](https://github.com/ClickHouse/ClickHouse/pull/44949) ([MeenaRenganathan22](https://github.com/MeenaRenganathan22))。
- 为 clickhouse-keeper 添加 systemd.service 文件。修复了 [#44293](https://github.com/ClickHouse/ClickHouse/issues/44293)。[#45568](https://github.com/ClickHouse/ClickHouse/pull/45568) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- ClickHouse 的 Poco 分支已从 "contrib/" 移动到 "base/poco/"。[#46075](https://github.com/ClickHouse/ClickHouse/pull/46075) ([Robert Schulze](https://github.com/rschu1ze))。
- 为 `clickhouse-watchdog` 添加重启子进程的选项。此功能用途不大。[#46312](https://github.com/ClickHouse/ClickHouse/pull/46312) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 如果环境变量 `CLICKHOUSE_DOCKER_RESTART_ON_EXIT` 设置为 1,Docker 容器将以子进程而非主进程的方式运行 `clickhouse-server`,并在其退出时重启它。[#46391](https://github.com/ClickHouse/ClickHouse/pull/46391) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 修复 Systemd 服务文件。[#46461](https://github.com/ClickHouse/ClickHouse/pull/46461) ([SuperDJY](https://github.com/cmsxbc))。
- 将构建 ClickHouse 所需的最低 Clang 版本从 12 提升到 15。[#46710](https://github.com/ClickHouse/ClickHouse/pull/46710) ([Robert Schulze](https://github.com/rschu1ze))。
- 将 Intel QPL 从 v0.3.0 升级到 v1.0.0。构建 libaccel-config 并将其静态链接到 QPL 库,而非动态链接。[#45809](https://github.com/ClickHouse/ClickHouse/pull/45809) ([jasperzhu](https://github.com/jinjunzh))。

#### 错误修复(官方稳定版本中用户可见的异常行为) {#bug-fix-user-visible-misbehavior-in-official-stable-release}


* 在 `StorageRabbitMQ` 中严格根据 `rabbitmq_flush_interval_ms` 或 `rabbitmq_max_block_size` 刷新数据。修复 [#42389](https://github.com/ClickHouse/ClickHouse/issues/42389)。修复 [#45160](https://github.com/ClickHouse/ClickHouse/issues/45160)。[#44404](https://github.com/ClickHouse/ClickHouse/pull/44404)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在 `sparkBar` 函数中使用 `PODArray` 进行渲染，从而控制内存使用。关闭 [#44467](https://github.com/ClickHouse/ClickHouse/issues/44467)。[#44489](https://github.com/ClickHouse/ClickHouse/pull/44489)（[Duc Canh Le](https://github.com/canhld94)）。
* 修复函数 (quantilesExactExclusive, quantilesExactInclusive) 返回未排序数组元素的问题。 [#45379](https://github.com/ClickHouse/ClickHouse/pull/45379) ([wujunfu](https://github.com/wujunfu)).
* 修复在启用 OpenTelemetry 时 `HTTPHandler` 中未捕获异常的问题。 [#45456](https://github.com/ClickHouse/ClickHouse/pull/45456) ([Frank Chen](https://github.com/FrankChen021)).
* 不要从 8 位数字推断日期，这可能会导致读取到错误的数据。[#45581](https://github.com/ClickHouse/ClickHouse/pull/45581) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复了对 `odbc_bridge_use_connection_pooling` 设置的使用方式。[#45591](https://github.com/ClickHouse/ClickHouse/pull/45591) ([Bharat Nallan](https://github.com/bharatnc))。
* 当缓存中的回调被调用时，对应的缓存对象有可能已经被析构。为保证安全，我们按值捕获成员。对于任务调度来说也是安全的，因为在存储被销毁之前，它会先被停用。修复 [#45548](https://github.com/ClickHouse/ClickHouse/issues/45548)。[#45601](https://github.com/ClickHouse/ClickHouse/pull/45601)（[Han Fei](https://github.com/hanfei1991)）。
* 修复在将编解码器 Delta 或 DoubleDelta 与编解码器 Gorilla 组合使用时可能导致的数据损坏问题。 [#45615](https://github.com/ClickHouse/ClickHouse/pull/45615) ([Robert Schulze](https://github.com/rschu1ze)).
* 在使用 N-gram 布隆过滤器索引时正确检查类型，避免无效读取。 [#45617](https://github.com/ClickHouse/ClickHouse/pull/45617) ([Antonio Andelic](https://github.com/antonio2368)).
* 有几起与 `c-ares` 相关的段错误被报告出来。这些问题是在我之前的 pull request 中引入的。在 Alexander Tokmakov 的帮助下，我已修复它们。[#45629](https://github.com/ClickHouse/ClickHouse/pull/45629) ([Arthur Passos](https://github.com/arthurpassos))。
* 在遇到重复主键时修复键描述。这种情况可能出现在投影中。详情参见 [#45590](https://github.com/ClickHouse/ClickHouse/issues/45590)。[#45686](https://github.com/ClickHouse/ClickHouse/pull/45686) ([Amos Bird](https://github.com/amosbird))。
* 为备份设置压缩方法和级别，关闭 [#45690](https://github.com/ClickHouse/ClickHouse/issues/45690)。[#45737](https://github.com/ClickHouse/ClickHouse/pull/45737)（[Pradeep Chhetri](https://github.com/chhetripradeep)）。
* 应使用 `select_query_typed.limitByOffset`，而不是 `select_query_typed.limitOffset`。 [#45817](https://github.com/ClickHouse/ClickHouse/pull/45817) ([刘陶峰](https://github.com/taofengliu)).
* 在使用实验性 analyzer 时，类似 `SELECT number FROM numbers(100) LIMIT 10 OFFSET 10;` 的查询会得到错误结果（该 SQL 返回空结果）。这是因为 planner 额外添加了一个不必要的 offset 步骤所致。[#45822](https://github.com/ClickHouse/ClickHouse/pull/45822)（[刘陶峰](https://github.com/taofengliu)）。
* 向后兼容性 - 允许从 UInt64 到 IPv4 的隐式收窄转换 —— 这是 `INSERT ... VALUES ...` 表达式所需要的。[#45865](https://github.com/ClickHouse/ClickHouse/pull/45865) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
* 修复 IPv6 解析器在处理缺少首个八位组的混合 IPv4 地址（例如 `::.1.2.3`）时的错误。 [#45871](https://github.com/ClickHouse/ClickHouse/pull/45871) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* 将 `query_kind` 列添加到 `system.processes` 表和 `SHOW PROCESSLIST` 查询中，并移除重复代码。修复了一个 Bug：全局配置参数 `max_concurrent_select_queries` 在包含 `INTERSECT` 或 `EXCEPT` 链的查询中未被正确遵守。[#45872](https://github.com/ClickHouse/ClickHouse/pull/45872)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 修复函数 `stochasticLinearRegression` 中的崩溃问题。由 WingFuzz 发现。 [#45985](https://github.com/ClickHouse/ClickHouse/pull/45985) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 修复了在从启用稀疏列（由设置 `ratio_of_defaults_for_sparse_serialization` 控制）的表中读取数据时，带有 `INTERSECT` 和 `EXCEPT` 修饰符的 `SELECT` 查询会发生崩溃的问题。 [#45987](https://github.com/ClickHouse/ClickHouse/pull/45987) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在带有 `FINAL` 的 `DESC` 排序场景中的顺序读取优化，关闭 [#45815](https://github.com/ClickHouse/ClickHouse/issues/45815)。[#46009](https://github.com/ClickHouse/ClickHouse/pull/46009)（[Vladimir C](https://github.com/vdimir)）。
* 修复在紧凑分片中读取多级不存在的嵌套列的问题。 [#46045](https://github.com/ClickHouse/ClickHouse/pull/46045) ([Azat Khuzhin](https://github.com/azat)).
* 修复 `system.processes` 中 `elapsed` 列的 10 倍误差。[#46047](https://github.com/ClickHouse/ClickHouse/pull/46047)（[Azat Khuzhin](https://github.com/azat)）。
* 针对“将域 IP 类型（IPv4、IPv6）替换为原生类型”的后续修复：[https://github.com/ClickHouse/ClickHouse/pull/43221](https://github.com/ClickHouse/ClickHouse/pull/43221)。[#46087](https://github.com/ClickHouse/ClickHouse/pull/46087)（[Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)）。
* 修复当参数已具有值时，配置中的环境变量替换问题。此更改关闭了 [#46131](https://github.com/ClickHouse/ClickHouse/issues/46131)。此更改关闭了 [#9547](https://github.com/ClickHouse/ClickHouse/issues/9547)。[#46144](https://github.com/ClickHouse/ClickHouse/pull/46144)（[pufit](https://github.com/pufit)）。
* 修复在 `GROUPING SETS` 中错误的谓词下推问题。关闭 [#45947](https://github.com/ClickHouse/ClickHouse/issues/45947)。[#46151](https://github.com/ClickHouse/ClickHouse/pull/46151)（[flynn](https://github.com/ucasfl)）。
* 修复在具有常量键的 `fulls_sorting_join` 中可能出现的流水线阻塞错误。[#46175](https://github.com/ClickHouse/ClickHouse/pull/46175) ([Vladimir C](https://github.com/vdimir))。
* 在格式化过程中切勿将 `tuple` 函数重写为字面量，以避免产生不正确的结果。 [#46232](https://github.com/ClickHouse/ClickHouse/pull/46232) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* 修复以 Arrow 格式读取 `LowCardinality(Nullable)` 时可能出现的越界错误。[#46270](https://github.com/ClickHouse/ClickHouse/pull/46270)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复 `SYSTEM UNFREEZE` 查询因抛出 `CANNOT_PARSE_INPUT_ASSERTION_FAILED` 异常而失败的问题。[#46325](https://github.com/ClickHouse/ClickHouse/pull/46325) ([Aleksei Filatov](https://github.com/aalexfvk)).
* 修复了在反序列化存储 `HashTable` 的函数的聚合状态时，由于整数溢出可能导致的崩溃问题。 [#46349](https://github.com/ClickHouse/ClickHouse/pull/46349) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复在以 `VALUES` 格式发送无效数据进行异步插入时可能出现的 `LOGICAL_ERROR`。 [#46350](https://github.com/ClickHouse/ClickHouse/pull/46350) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了在尝试执行 `ALTER ... MOVE PART ... TO TABLE` 时出现的 LOGICAL&#95;ERROR。此类查询实际上从未得到支持。[#46359](https://github.com/ClickHouse/ClickHouse/pull/46359) ([Alexander Tokmakov](https://github.com/tavplubix)).
* 在启用 `parallel_distributed_insert_select` 时，修复 `s3Cluster` 在并行分布式 `INSERT SELECT` 中的表结构推断问题。 [#46381](https://github.com/ClickHouse/ClickHouse/pull/46381) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复类似 `ALTER TABLE ... UPDATE nested.arr1 = nested.arr2 ...` 的查询，其中 `arr1` 和 `arr2` 是同一个 `Nested` 列中的字段。 [#46387](https://github.com/ClickHouse/ClickHouse/pull/46387) ([Anton Popov](https://github.com/CurtizJ)).
* Scheduler 可能无法调度某个任务。如果发生这种情况，应中止整个 MulityPartUpload，并且 `UploadHelper` 必须等待已调度的任务执行完成。[#46451](https://github.com/ClickHouse/ClickHouse/pull/46451) ([Dmitry Novik](https://github.com/novikd))。
* 修复在具有不同默认类型的 Merge 表上使用 PREWHERE 的问题（修复当列的默认类型不同时出现的一些 `NOT_FOUND_COLUMN_IN_BLOCK` 错误；当各表中该列类型一致时允许使用 `PREWHERE`，且仅在类型不一致时禁止使用）。 [#46454](https://github.com/ClickHouse/ClickHouse/pull/46454) ([Azat Khuzhin](https://github.com/azat)).
* 修复在 `ORDER BY` 中使用常量值时可能发生的崩溃。修复 [#46466](https://github.com/ClickHouse/ClickHouse/issues/46466)。[#46493](https://github.com/ClickHouse/ClickHouse/pull/46493)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 如果在查询级别指定了 `disk` 设置，但在配置文件的 MergeTree 设置部分中也指定了 `storage_policy`，则不再抛出异常。`disk` 将覆盖配置文件中的设置。[#46533](https://github.com/ClickHouse/ClickHouse/pull/46533) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 修复函数 `arrayMap` 中对常量 `LowCardinality` 参数的不正确处理。此错误在发布版本中可能导致段错误，在调试构建中会触发逻辑错误 `Bad cast`。[#46569](https://github.com/ClickHouse/ClickHouse/pull/46569) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* 修复了 [#46557](https://github.com/ClickHouse/ClickHouse/issues/46557)。[#46611](https://github.com/ClickHouse/ClickHouse/pull/46611)（[Alexander Gololobov](https://github.com/davenger)）。
* 修复当服务器无法在 1 分 30 秒内启动时，`clickhouse-server` systemd 单元不断重启的问题（禁用通过 systemd 服务启动 `clickhouse-server` 时的超时逻辑）。 [#46613](https://github.com/ClickHouse/ClickHouse/pull/46613) ([Azat Khuzhin](https://github.com/azat)).
* 在异步插入期间分配的内存缓冲区在全局上下文中被释放，但对应用户和查询的 `MemoryTracker` 计数器未被正确更新。这会导致错误触发 OOM 异常。 [#46622](https://github.com/ClickHouse/ClickHouse/pull/46622) ([Dmitry Novik](https://github.com/novikd))。
* 已更新为不再清除 `table_join` 中的 `on_expression`，因为它会在后续的 analyze 运行中使用，从而解决了 [#45185](https://github.com/ClickHouse/ClickHouse/issues/45185)。[#46487](https://github.com/ClickHouse/ClickHouse/pull/46487)（[SmitaRKulkarni](https://github.com/SmitaRKulkarni)）。

### <a id="231"></a> ClickHouse 版本 23.1，2023-01-26 {#231}

### ClickHouse 版本 23.1 {#clickhouse-release-231}

#### 升级注意事项 {#upgrade-notes-2}

- `SYSTEM RESTART DISK` 查询现已成为空操作。[#44647](https://github.com/ClickHouse/ClickHouse/pull/44647) ([alesapin](https://github.com/alesapin))。
- `HASHED`/`SPARSE_HASHED` 字典的 `PREALLOCATE` 选项现已成为空操作。[#45388](https://github.com/ClickHouse/ClickHouse/pull/45388) ([Azat Khuzhin](https://github.com/azat))。该选项不再提供显著优势。
- 禁止在非 Float32 或非 Float64 类型的列上使用 `Gorilla` 编解码器。[#45252](https://github.com/ClickHouse/ClickHouse/pull/45252) ([Robert Schulze](https://github.com/rschu1ze))。这样做毫无意义且会导致不一致性。
- 对于使用已弃用语法创建的 `*MergeTree` 表，并行仲裁插入可能无法正常工作。因此，此类表已完全禁用并行仲裁插入支持。使用新语法创建的表不受影响。[#45430](https://github.com/ClickHouse/ClickHouse/pull/45430) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 使用 `GetObjectAttributes` 请求代替 `HeadObject` 请求来获取 AWS S3 中对象的大小。例如，此更改修复了更新 AWS SDK 后处理未明确指定区域的端点时的问题。[#45288](https://github.com/ClickHouse/ClickHouse/pull/45288) ([Vitaly Baranov](https://github.com/vitlibar))。AWS S3 和 Minio 已经过测试，但请注意，各种 S3 兼容服务（GCS、R2、B2）可能存在细微的不兼容性。此更改还可能需要您调整 ACL 以允许 `GetObjectAttributes` 请求。
- 禁止在时区名称中使用路径。例如，不允许使用类似 `/usr/share/zoneinfo/Asia/Aden` 的时区名称；应使用 IANA 时区数据库名称，如 `Asia/Aden`。[#44225](https://github.com/ClickHouse/ClickHouse/pull/44225) ([Kruglov Pavel](https://github.com/Avogar))。
- 由于会产生错误结果，禁止使用组合了等值连接和常量表达式的查询（例如 `JOIN ON t1.x = t2.x AND 1 = 1`）。[#44016](https://github.com/ClickHouse/ClickHouse/pull/44016) ([Vladimir C](https://github.com/vdimir))。


#### 新功能 {#new-feature-11}

- 新增字典数据源,通过遍历正则表达式树来提取键值。可用于 User-Agent 解析。[#40878](https://github.com/ClickHouse/ClickHouse/pull/40878) ([Vage Ogannisian](https://github.com/nooblose)). [#43858](https://github.com/ClickHouse/ClickHouse/pull/43858) ([Han Fei](https://github.com/hanfei1991)).
- 新增参数化视图功能,现在可以为 View 表引擎指定查询参数。解决了 [#40907](https://github.com/ClickHouse/ClickHouse/issues/40907). [#41687](https://github.com/ClickHouse/ClickHouse/pull/41687) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- 新增 `quantileInterpolatedWeighted`/`quantilesInterpolatedWeighted` 函数。[#38252](https://github.com/ClickHouse/ClickHouse/pull/38252) ([Bharat Nallan](https://github.com/bharatnc)).
- 为 `Map` 类型新增 Array join 支持,类似于 Spark 中的 "explode" 函数。[#43239](https://github.com/ClickHouse/ClickHouse/pull/43239) ([李扬](https://github.com/taiyang-li)).
- 支持 SQL 标准的二进制和十六进制字符串字面量。[#43785](https://github.com/ClickHouse/ClickHouse/pull/43785) ([Mo Xuan](https://github.com/mo-avatar)).
- 支持以 Joda-Time 风格格式化 `DateTime`。请参阅 [Joda-Time 文档](https://joda-time.sourceforge.net/apidocs/org/joda/time/format/DateTimeFormat.html)。[#43818](https://github.com/ClickHouse/ClickHouse/pull/43818) ([李扬](https://github.com/taiyang-li)).
- 为 `formatDateTime` 实现了小数秒格式化器 (`%f`)。[#44060](https://github.com/ClickHouse/ClickHouse/pull/44060) ([ltrk2](https://github.com/ltrk2)). [#44497](https://github.com/ClickHouse/ClickHouse/pull/44497) ([Alexander Gololobov](https://github.com/davenger)).
- 新增 `age` 函数,用于计算两个日期或带时间值的日期之间的差值,以完整单位数表示。关闭了 [#41115](https://github.com/ClickHouse/ClickHouse/issues/41115). [#44421](https://github.com/ClickHouse/ClickHouse/pull/44421) ([Robert Schulze](https://github.com/rschu1ze)).
- 为字典新增 `Null` 数据源。关闭了 [#44240](https://github.com/ClickHouse/ClickHouse/issues/44240). [#44502](https://github.com/ClickHouse/ClickHouse/pull/44502) ([mayamika](https://github.com/mayamika)).
- 支持使用 `s3_storage_class` 配置选项配置 S3 存储类。例如 `<s3_storage_class>STANDARD/INTELLIGENT_TIERING</s3_storage_class>`。关闭了 [#44443](https://github.com/ClickHouse/ClickHouse/issues/44443). [#44707](https://github.com/ClickHouse/ClickHouse/pull/44707) ([chen](https://github.com/xiedeyantu)).
- 在解析命名元组时,如果 JSON 对象中缺少元素,则插入默认值。新增设置 `input_format_json_defaults_for_missing_elements_in_named_tuple` 来控制此行为。关闭了 [#45142](https://github.com/ClickHouse/ClickHouse/issues/45142)#issuecomment-1380153217. [#45231](https://github.com/ClickHouse/ClickHouse/pull/45231) ([Kruglov Pavel](https://github.com/Avogar)).
- 在 ProfileEvents 中记录服务器启动时间 (`ServerStartupMilliseconds`)。解决了 [#43188](https://github.com/ClickHouse/ClickHouse/issues/43188). [#45250](https://github.com/ClickHouse/ClickHouse/pull/45250) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- 重构并改进流式引擎 Kafka/RabbitMQ/NATS,新增对所有格式的支持,同时对格式进行了部分重构:- 修复在带有后缀/前缀的基于行的格式中生成消息的问题。现在每条消息都使用所有分隔符完整格式化,并可以使用输入格式解析回来。- 支持基于块的格式,如 Native、Parquet、ORC 等。每个块都格式化为单独的消息。一条消息中的行数取决于块大小,因此可以通过设置 `max_block_size` 来控制。- 新增引擎设置 `kafka_max_rows_per_message/rabbitmq_max_rows_per_message/nats_max_rows_per_message`。它们控制基于行的格式中一条消息中格式化的行数。默认值:1。- 修复 NATS 表引擎中的高内存消耗问题。- 在 NATS 生产者中支持任意二进制数据(以前仅支持末尾包含 \0 的字符串)- 在文档中补充缺失的 Kafka/RabbitMQ/NATS 引擎设置。- 重构 Kafka/RabbitMQ/NATS 中的生产和消费,将其与 WriteBuffers/ReadBuffers 语义分离。- 重构输出格式:移除 Kafka/RabbitMQ/NATS 中使用的每行回调(现在不再使用回调),支持直接使用 IRowOutputFormat,明确行结束和行之间的分隔符,使重置输出格式以重新开始格式化成为可能 - 在 formatRow 函数中新增适当的实现(格式重构后的额外收获)。[#42777](https://github.com/ClickHouse/ClickHouse/pull/42777) ([Kruglov Pavel](https://github.com/Avogar)).
- 支持在 `CapnProto` 格式中将 `Nested` 表读写为 `Struct` 的 `List`。将 `Decimal32/64` 读写为 `Int32/64`。关闭了 [#43319](https://github.com/ClickHouse/ClickHouse/issues/43319). [#43379](https://github.com/ClickHouse/ClickHouse/pull/43379) ([Kruglov Pavel](https://github.com/Avogar)).
- 向 `system.text_log` 新增 `message_format_string` 列。该列包含用于格式化消息的模式。[#44543](https://github.com/ClickHouse/ClickHouse/pull/44543) ([Alexander Tokmakov](https://github.com/tavplubix)). 这使得可以对 ClickHouse 日志进行各种分析。
- 尝试自动检测 CSV/TSV/CustomSeparated 输入格式的带有列名(可能还有类型)的标题。
  新增设置 input_format_tsv/csv/custom_detect_header 来启用此行为(默认启用)。关闭了 [#44640](https://github.com/ClickHouse/ClickHouse/issues/44640). [#44953](https://github.com/ClickHouse/ClickHouse/pull/44953) ([Kruglov Pavel](https://github.com/Avogar)).

#### 实验性功能 {#experimental-feature-7}

- 新增实验性倒排索引作为新的二级索引类型,用于高效文本搜索。[#38667](https://github.com/ClickHouse/ClickHouse/pull/38667) ([larryluogit](https://github.com/larryluogit))。
- 新增实验性查询结果缓存。[#43797](https://github.com/ClickHouse/ClickHouse/pull/43797) ([Robert Schulze](https://github.com/rschu1ze))。
- 新增可扩展和可配置的 IO 请求调度子系统(尚未与 IO 代码本身集成)。[#41840](https://github.com/ClickHouse/ClickHouse/pull/41840) ([Sergei Trifonov](https://github.com/serxa))。此功能目前不执行任何操作,敬请期待。
- 新增 `SYSTEM DROP DATABASE REPLICA` 命令,用于删除 `Replicated` 数据库中失效副本的元数据。解决了 [#41794](https://github.com/ClickHouse/ClickHouse/issues/41794)。[#42807](https://github.com/ClickHouse/ClickHouse/pull/42807) ([Alexander Tokmakov](https://github.com/tavplubix))。


#### 性能改进 {#performance-improvement-11}

- `MergeTree` 表启动时不再加载非活动数据部分。[#42181](https://github.com/ClickHouse/ClickHouse/pull/42181) ([Anton Popov](https://github.com/CurtizJ))。
- 改进了从 `S3` 存储和 `s3` 表函数读取大量小文件时的延迟。现在从 `S3` 存储读取时,`remote_filesystem_read_method` 和 `remote_filesystem_read_prefetch` 设置会生效。[#43726](https://github.com/ClickHouse/ClickHouse/pull/43726) ([Anton Popov](https://github.com/CurtizJ))。
- 优化了 Parquet/ORC 文件中结构体字段的读取,仅加载所需字段。[#44484](https://github.com/ClickHouse/ClickHouse/pull/44484) ([lgbo](https://github.com/lgbo-ustc))。
- 两级聚合算法在通过 HTTP 接口执行查询时被错误禁用,现已重新启用,带来了显著的性能提升。[#45450](https://github.com/ClickHouse/ClickHouse/pull/45450) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 为 StorageFile 添加了 mmap 支持,可提升 clickhouse-local 的性能。[#43927](https://github.com/ClickHouse/ClickHouse/pull/43927) ([pufit](https://github.com/pufit))。
- 在 HashedDictionary 中添加了分片支持以实现并行加载(基于分片数量可实现近乎线性的扩展)。[#40003](https://github.com/ClickHouse/ClickHouse/pull/40003) ([Azat Khuzhin](https://github.com/azat))。
- 加快了查询解析速度。[#42284](https://github.com/ClickHouse/ClickHouse/pull/42284) ([Raúl Marín](https://github.com/Algunenano))。
- 当 `expr` 是 `LowCardinality` 列时,始终将 OR 链 `expr = x1 OR ... OR expr = xN` 替换为 `expr IN (x1, ..., xN)`。在这种情况下,`optimize_min_equality_disjunction_chain_length` 设置会被忽略。[#42889](https://github.com/ClickHouse/ClickHouse/pull/42889) ([Guo Wangyang](https://github.com/guowangy))。
- 通过优化 ThreadStatus 相关代码略微提升了性能。[#43586](https://github.com/ClickHouse/ClickHouse/pull/43586) ([Zhiguo Zhou](https://github.com/ZhiguoZh))。
- 通过实现自动向量化优化了按列的三元逻辑求值。在此[微基准测试](https://github.com/ZhiguoZh/ClickHouse/blob/20221123-ternary-logic-opt-example/src/Functions/examples/associative_applier_perf.cpp)的性能测试中,我们在 ICX 设备(Intel Xeon Platinum 8380 CPU)上观察到峰值**性能提升**达 **21 倍**。[#43669](https://github.com/ClickHouse/ClickHouse/pull/43669) ([Zhiguo Zhou](https://github.com/ZhiguoZh))。
- 尽可能避免在 `system.tables` 表中获取读锁。[#43840](https://github.com/ClickHouse/ClickHouse/pull/43840) ([Raúl Marín](https://github.com/Algunenano))。
- 优化了 ThreadPool。在 ICX 设备(Intel Xeon Platinum 8380 CPU,80 核,160 线程)上进行的 SSB(星型模式基准测试)性能实验表明,此更改可有效将 ThreadPoolImpl::mutex 的锁竞争减少 **75%**,提高 CPU 利用率并将整体性能提升 **2.4%**。[#44308](https://github.com/ClickHouse/ClickHouse/pull/44308) ([Zhiguo Zhou](https://github.com/ZhiguoZh))。
- 现在,仅当缓存的哈希表大小足够大时才应用预测哈希表大小的优化(阈值根据经验确定并硬编码)。[#44455](https://github.com/ClickHouse/ClickHouse/pull/44455) ([Nikita Taranov](https://github.com/nickitat))。
- 从远程文件系统异步读取时的小幅性能改进。[#44868](https://github.com/ClickHouse/ClickHouse/pull/44868) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 为以下情况添加了快速路径:- `col like '%%'`;- `col like '%'`;- `col not like '%'`;- `col not like '%'`;- `match(col, '.*')`。[#45244](https://github.com/ClickHouse/ClickHouse/pull/45244) ([李扬](https://github.com/taiyang-li))。
- 略微改进了过滤(WHERE 子句)中的快速路径优化。[#45289](https://github.com/ClickHouse/ClickHouse/pull/45289) ([Nikita Taranov](https://github.com/nickitat))。
- 为 `toUnixTimestamp64*` 提供单调性信息,以便为索引分析启用更多代数优化。[#44116](https://github.com/ClickHouse/ClickHouse/pull/44116) ([Nikita Taranov](https://github.com/nickitat))。
- 允许配置查询处理的临时数据(溢出到磁盘)与文件系统缓存协作(占用缓存磁盘空间)[#43972](https://github.com/ClickHouse/ClickHouse/pull/43972) ([Vladimir C](https://github.com/vdimir))。这主要改进了 [ClickHouse Cloud](https://console.clickhouse.cloud/),但如果您了解相关配置,也可用于自管理部署。
- 使 `system.replicas` 表并行获取副本状态。关闭 [#43918](https://github.com/ClickHouse/ClickHouse/issues/43918)。[#43998](https://github.com/ClickHouse/ClickHouse/pull/43998) ([Nikolay Degterinsky](https://github.com/evillique))。
- 优化了备份到 S3 期间的内存消耗:现在文件将直接复制到 S3,而不使用 `WriteBufferFromS3`(该方法可能会占用大量内存)。[#45188](https://github.com/ClickHouse/ClickHouse/pull/45188) ([Vitaly Baranov](https://github.com/vitlibar))。
- 为异步块 ID 添加了缓存。这将在启用异步插入去重时减少对 ZooKeeper 的请求数量。[#45106](https://github.com/ClickHouse/ClickHouse/pull/45106) ([Han Fei](https://github.com/hanfei1991))。

#### 改进 {#improvement-11}


* 在无参数调用 `generateRandom` 时使用插入表的结构。[#45239](https://github.com/ClickHouse/ClickHouse/pull/45239) ([Kruglov Pavel](https://github.com/Avogar))。
* 允许在 `JSONExtract` 函数中，将存储在 JSON 字符串字段中的浮点数隐式转换为整数。例如：`JSONExtract('{"a": "1000.111"}', 'a', 'UInt64')` -&gt; `1000`，之前会返回 0。[#45432](https://github.com/ClickHouse/ClickHouse/pull/45432) ([Anton Popov](https://github.com/CurtizJ))。
* 向表 `system.formats` 添加了字段 `supports_parallel_parsing` 和 `supports_parallel_formatting`，以改进自检能力。 [#45499](https://github.com/ClickHouse/ClickHouse/pull/45499) ([Anton Popov](https://github.com/CurtizJ)).
* 改进在 CustomSeparated/Template 格式中读取 CSV 字段的方式。修复 [#42352](https://github.com/ClickHouse/ClickHouse/issues/42352)、[#39620](https://github.com/ClickHouse/ClickHouse/issues/39620)。[#43332](https://github.com/ClickHouse/ClickHouse/pull/43332)（[Kruglov Pavel](https://github.com/Avogar)）。
* 统一查询耗时的测量方式。 [#43455](https://github.com/ClickHouse/ClickHouse/pull/43455) ([Raúl Marín](https://github.com/Algunenano)).
* 在包含虚拟列的 `SELECT` 查询中，改进表函数 file/hdfs/s3 从插入表自动复用表结构的机制，修复可能出现的 `Block structure mismatch` 或 `number of columns mismatch` 错误。[#43695](https://github.com/ClickHouse/ClickHouse/pull/43695) ([Kruglov Pavel](https://github.com/Avogar))。
* 为 `range` 函数增加对有符号参数的支持。修复 [#43333](https://github.com/ClickHouse/ClickHouse/issues/43333)。[#43733](https://github.com/ClickHouse/ClickHouse/pull/43733)（[sanyu](https://github.com/wineternity)）。
* 移除冗余排序，例如删除子查询中与之相关的 `ORDER BY` 子句排序。该功能基于查询计划实现。它对 `ORDER BY` 子句的优化与 `optimize_duplicate_order_by_and_distinct` 类似，但更加通用，因为它适用于所有冗余的排序步骤（不局限于由 `ORDER BY` 子句引起的），并且可作用于任意深度的子查询。相关议题：[#42648](https://github.com/ClickHouse/ClickHouse/issues/42648)。[#43905](https://github.com/ClickHouse/ClickHouse/pull/43905)（[Igor Nikonov](https://github.com/devcrafter)）。
* 为 `BACKUP` 增加禁用文件去重的功能（对于不进行去重的备份，可以使用 `ATTACH` 来代替完整的 `RESTORE`）。例如：`BACKUP foo TO S3(...) SETTINGS deduplicate_files=0`（默认值为 `deduplicate_files=1`）。[#43947](https://github.com/ClickHouse/ClickHouse/pull/43947)（[Azat Khuzhin](https://github.com/azat)）。
* 重构并改进文本格式的模式推断。新增设置 `schema_inference_make_columns_nullable`，用于控制是否将结果类型设为 `Nullable`（默认启用）。[#44019](https://github.com/ClickHouse/ClickHouse/pull/44019)（[Kruglov Pavel](https://github.com/Avogar)）。
* 更好地支持 `PROXYv1` 协议。[#44135](https://github.com/ClickHouse/ClickHouse/pull/44135) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
* 将清理线程最近一次检查数据分片的信息添加到 `system.parts` 表中。 [#44244](https://github.com/ClickHouse/ClickHouse/pull/44244) ([Dmitry Novik](https://github.com/novikd)).
* 在只读模式下禁用使用表函数执行的插入操作。 [#44290](https://github.com/ClickHouse/ClickHouse/pull/44290) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* 添加设置 `simultaneous_parts_removal_limit`，用于限制一次 CleanupThread 迭代中可处理的分片数量。[#44461](https://github.com/ClickHouse/ClickHouse/pull/44461)（[Dmitry Novik](https://github.com/novikd)）。
* 当查询中只需要虚拟列时，不要初始化 `ReadBufferFromS3`。这可能有助于处理 [#44246](https://github.com/ClickHouse/ClickHouse/issues/44246)。[#44493](https://github.com/ClickHouse/ClickHouse/pull/44493)（[chen](https://github.com/xiedeyantu)）。
* 防止生成重复的列名提示。修复 [#44130](https://github.com/ClickHouse/ClickHouse/issues/44130)。[#44519](https://github.com/ClickHouse/ClickHouse/pull/44519)（[Joanna Hulboj](https://github.com/jh0x)）。
* 允许在磁盘的 endpoint 中进行宏替换。解决 [#40951](https://github.com/ClickHouse/ClickHouse/issues/40951)。[#44533](https://github.com/ClickHouse/ClickHouse/pull/44533)（[SmitaRKulkarni](https://github.com/SmitaRKulkarni)）。
* 在启用 `input_format_json_read_object_as_string` 时改进架构推断。[#44546](https://github.com/ClickHouse/ClickHouse/pull/44546)（[Kruglov Pavel](https://github.com/Avogar)）。
* 添加一个用户级别的设置 `database_replicated_allow_replicated_engine_arguments`，用于禁止在 `DatabaseReplicated` 中创建带参数的 `ReplicatedMergeTree` 表。[#44566](https://github.com/ClickHouse/ClickHouse/pull/44566) ([alesapin](https://github.com/alesapin))。
* 防止用户误将零（无效）值指定给 `index_granularity`。修复了 [#44536](https://github.com/ClickHouse/ClickHouse/issues/44536)。[#44578](https://github.com/ClickHouse/ClickHouse/pull/44578)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 在 config.xml 的 `kerberos` 部分中，为 `keytab` 参数新增了用于设置服务 keytab 文件路径的功能。[#44594](https://github.com/ClickHouse/ClickHouse/pull/44594) ([Roman Vasin](https://github.com/rvasin))。
* 对模糊搜索复用已输入的查询部分（传递给用 Rust 编写并以静态方式链接到 ClickHouse 的 `skim` 库）。 [#44600](https://github.com/ClickHouse/ClickHouse/pull/44600) ([Azat Khuzhin](https://github.com/azat)).
* 默认启用 `input_format_json_read_objects_as_strings`，以便在 JSON Object 类型仍处于实验阶段时能够读取嵌套 JSON 对象。[#44657](https://github.com/ClickHouse/ClickHouse/pull/44657) ([Kruglov Pavel](https://github.com/Avogar)).
* 异步插入去重机制的改进：当用户执行重复的异步插入时，我们应在查询 Keeper 之前先在内存中完成去重。[#44682](https://github.com/ClickHouse/ClickHouse/pull/44682) ([Han Fei](https://github.com/hanfei1991))。
* 输入/输出 `Avro` 格式会将 bool 类型解析为 ClickHouse 的 Bool 类型。[#44684](https://github.com/ClickHouse/ClickHouse/pull/44684)（[Kruglov Pavel](https://github.com/Avogar)）。
* 在 Arrow/Parquet/ORC 中支持 Bool 类型。解决 [#43970](https://github.com/ClickHouse/ClickHouse/issues/43970)。[#44698](https://github.com/ClickHouse/ClickHouse/pull/44698)（[Kruglov Pavel](https://github.com/Avogar)）。
* 读取 `UUID` 时不要贪婪地解析超出引号的内容——这可能会导致错误数据被误判为解析成功。 [#44686](https://github.com/ClickHouse/ClickHouse/pull/44686) ([Raúl Marín](https://github.com/Algunenano)).
* 在 Int64 溢出的情况下推断为 UInt64，并修复模式推断中的部分转换。 [#44696](https://github.com/ClickHouse/ClickHouse/pull/44696) ([Kruglov Pavel](https://github.com/Avogar)).
* 之前在 `Replicated` 数据库中进行依赖关系解析的方式比较 hack，现在已经改为使用显式图进行规范实现。[#44697](https://github.com/ClickHouse/ClickHouse/pull/44697) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 修复 `output_format_pretty_row_numbers` 在各数据块之间无法保持计数器连续的问题。解决 [#44815](https://github.com/ClickHouse/ClickHouse/issues/44815)。[#44832](https://github.com/ClickHouse/ClickHouse/pull/44832)（[flynn](https://github.com/ucasfl)）。
* 不再在 `system.errors` 中上报由于数据分片与后台清理进程并发合并而产生的错误。 [#44874](https://github.com/ClickHouse/ClickHouse/pull/44874) ([Raúl Marín](https://github.com/Algunenano)).
* 优化并修复 Distributed 异步 INSERT 的指标。[#44922](https://github.com/ClickHouse/ClickHouse/pull/44922) ([Azat Khuzhin](https://github.com/azat)).
* 添加用于禁止并发备份和恢复的设置，解决了 [#43891](https://github.com/ClickHouse/ClickHouse/issues/43891)。实现：* 添加了服务器级别的设置，用于禁止并发备份和恢复，在 Context 中创建 BackupWorker 时会读取并设置这些配置。* 设置默认值为 true。* 在开始备份或恢复之前，增加了检查逻辑，用于判断是否有其他备份/恢复正在运行。对于内部请求，会使用 backup&#95;uuid 检查其是否来自本节点。[#45072](https://github.com/ClickHouse/ClickHouse/pull/45072) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
* 为系统日志新增 `<storage_policy>` 配置参数。 [#45320](https://github.com/ClickHouse/ClickHouse/pull/45320) ([Stig Bakken](https://github.com/stigsb)).

#### 构建/测试/打包改进 {#buildtestingpackaging-improvement-11}

- 静态链接 `skim` 库(使用 Rust 编写),用于在 ClickHouse 客户端/本地历史记录中实现模糊搜索。[#44239](https://github.com/ClickHouse/ClickHouse/pull/44239) ([Azat Khuzhin](https://github.com/azat))。
- 我们移除了对共享链接的支持,原因是 Rust。实际上,Rust 只是移除的一个借口,我们本来就想移除它。[#44828](https://github.com/ClickHouse/ClickHouse/pull/44828) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 从软件包中移除对 `adduser` 工具的依赖,因为我们不使用它。这修复了 [#44934](https://github.com/ClickHouse/ClickHouse/issues/44934)。[#45011](https://github.com/ClickHouse/ClickHouse/pull/45011) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `SQLite` 库已更新到最新版本。它用于 SQLite 数据库和表集成引擎。同时修复了一个 TSan 误报问题。这关闭了 [#45027](https://github.com/ClickHouse/ClickHouse/issues/45027)。[#45031](https://github.com/ClickHouse/ClickHouse/pull/45031) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- CRC-32 更改以解决 PowerPC 中的 WeakHash 冲突问题。[#45144](https://github.com/ClickHouse/ClickHouse/pull/45144) ([MeenaRenganathan22](https://github.com/MeenaRenganathan22))。
- 更新 aws-c\* 子模块 [#43020](https://github.com/ClickHouse/ClickHouse/pull/43020) ([Vitaly Baranov](https://github.com/vitlibar))。
- 自动合并通过测试的回溯移植 PR 和通过测试的已批准 PR [#41110](https://github.com/ClickHouse/ClickHouse/pull/41110) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- 引入一个[网站](https://aretestsgreenyet.com/)用于显示 ClickHouse CI 的状态。[源代码](https://github.com/ClickHouse/aretestsgreenyet)。

#### 错误修复 {#bug-fix}


* 将域 IP 类型（IPv4、IPv6）替换为原生类型。[#43221](https://github.com/ClickHouse/ClickHouse/pull/43221)（[Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)）。这将自动修复代码中部分缺失的实现。
* 修复在备份过程中 `mutation` 被终止时的备份流程。 [#45351](https://github.com/ClickHouse/ClickHouse/pull/45351) ([Vitaly Baranov](https://github.com/vitlibar)).
* 修复 `Invalid number of rows in Chunk` 异常信息。[#41404](https://github.com/ClickHouse/ClickHouse/issues/41404)。[#42126](https://github.com/ClickHouse/ClickHouse/pull/42126)（[Alexander Gololobov](https://github.com/davenger)）。
* 修复在排序后执行表达式时可能使用未初始化值的问题。关闭 [#43386](https://github.com/ClickHouse/ClickHouse/issues/43386) [#43635](https://github.com/ClickHouse/ClickHouse/pull/43635)（[Kruglov Pavel](https://github.com/Avogar)）。
* 在聚合组合器中更好地处理 NULL，修复在使用较为冷门的优化 `optimize_rewrite_sum_if_to_count_if` 时可能出现的段错误或逻辑错误。解决 [#43758](https://github.com/ClickHouse/ClickHouse/issues/43758)。[#43813](https://github.com/ClickHouse/ClickHouse/pull/43813)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复 `CREATE USER`/`ROLE` 查询中的 `settings` 约束。 [#43993](https://github.com/ClickHouse/ClickHouse/pull/43993) ([Nikolay Degterinsky](https://github.com/evillique))。
* 修复了表元数据中 `EPHEMERAL` 列默认值不可解析的错误。 [#44026](https://github.com/ClickHouse/ClickHouse/pull/44026) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* 修复从兼容性设置中解析无效版本的问题。 [#44224](https://github.com/ClickHouse/ClickHouse/pull/44224) ([Kruglov Pavel](https://github.com/Avogar)).
* 使从 datetime 中减去 interval 的行为与加上 interval 的行为保持一致。 [#44241](https://github.com/ClickHouse/ClickHouse/pull/44241) ([ltrk2](https://github.com/ltrk2)).
* 移除视图结果集大小的上限限制。 [#44261](https://github.com/ClickHouse/ClickHouse/pull/44261) ([lizhuoyu5](https://github.com/lzydmxy)).
* 修复在 `do_not_evict_index_and_mrk_files=1` 时缓存中可能出现的逻辑错误。修复了 [#42142](https://github.com/ClickHouse/ClickHouse/issues/42142)。[#44268](https://github.com/ClickHouse/ClickHouse/pull/44268)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 修复写穿缓存中可能过早中断写入的问题（在本不应停止缓存时，由于错误假设导致缓存被停止）。 [#44289](https://github.com/ClickHouse/ClickHouse/pull/44289) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 修复在将带常量参数的 `IN` 条件函数与 `LowCardinality` 一起作为常量参数使用时可能发生的崩溃问题。修复了 [#44221](https://github.com/ClickHouse/ClickHouse/issues/44221)。[#44346](https://github.com/ClickHouse/ClickHouse/pull/44346)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了参数化聚合函数中复杂参数（如数组）的支持问题。本次修改关闭了 [#30975](https://github.com/ClickHouse/ClickHouse/issues/30975)。在此变更之前，聚合函数 `sumMapFiltered` 在分布式查询中无法使用。[#44358](https://github.com/ClickHouse/ClickHouse/pull/44358) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* 修复在 BSON 模式推断中读取 ObjectId 的问题。[#44382](https://github.com/ClickHouse/ClickHouse/pull/44382)（[Kruglov Pavel](https://github.com/Avogar)）。
* 修复了 `ReplicatedMergeTree` 中一个可能导致在合并完成前过早删除临时分片的竞态问题。该问题可能会导致类似 `No such file or directory: xxx` 的错误。修复了 [#43983](https://github.com/ClickHouse/ClickHouse/issues/43983)。[#44383](https://github.com/ClickHouse/ClickHouse/pull/44383)（[alesapin](https://github.com/alesapin)）。
* 某些无效的 `SYSTEM ... ON CLUSTER` 查询在未指定集群名称时会以意外的方式执行。该问题已修复，现在无效查询会按预期抛出 `SYNTAX_ERROR`。修复了 [#44264](https://github.com/ClickHouse/ClickHouse/issues/44264)。[#44387](https://github.com/ClickHouse/ClickHouse/pull/44387)（[Alexander Tokmakov](https://github.com/tavplubix)）。
* 修复读取 ORC 格式中 `Map` 类型的问题。 [#44400](https://github.com/ClickHouse/ClickHouse/pull/44400) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复在 Parquet/ORC 格式中读取未在输入数据中存在的列时的问题。此前这可能会导致 `INCORRECT_NUMBER_OF_COLUMNS` 错误。修复了 [#44333](https://github.com/ClickHouse/ClickHouse/issues/44333)。[#44405](https://github.com/ClickHouse/ClickHouse/pull/44405)（[Kruglov Pavel](https://github.com/Avogar)）。
* 之前，`bar` 函数使用相同的 &#39;▋&#39;（U+258B “Left five eighths block”）字符来同时显示 5/8 和 6/8 的柱形。此更改通过对 6/8 的柱形使用 &#39;▊&#39;（U+258A “Left three quarters block”）来修正该行为。[#44410](https://github.com/ClickHouse/ClickHouse/pull/44410)（[Alexander Gololobov](https://github.com/davenger)）。
* 在配置文件中将 profile 设置放在 profile 设置约束之后会导致这些约束失效。 [#44411](https://github.com/ClickHouse/ClickHouse/pull/44411) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* 修复在运行包含数据的 `EXPLAIN AST INSERT` 查询时出现的 `SYNTAX_ERROR`。关闭 [#44207](https://github.com/ClickHouse/ClickHouse/issues/44207)。[#44413](https://github.com/ClickHouse/ClickHouse/pull/44413)（[save-my-heart](https://github.com/save-my-heart)）。
* 修复在 CSV 格式中读取带有 CRLF 的布尔值时的问题。关闭 [#44401](https://github.com/ClickHouse/ClickHouse/issues/44401)。[#44442](https://github.com/ClickHouse/ClickHouse/pull/44442)（[Kruglov Pavel](https://github.com/Avogar)）。
* 不要在 LowCardinality 字典上执行 and/or/if/multiIf 运算，否则结果类型将不能是 LowCardinality。在某些情况下，这可能会导致 `Illegal column ColumnLowCardinality` 错误。修复了 [#43603](https://github.com/ClickHouse/ClickHouse/issues/43603)。[#44469](https://github.com/ClickHouse/ClickHouse/pull/44469)（[Kruglov Pavel](https://github.com/Avogar)）。
* 通过设置 `max_streams_for_merge_tree_reading` 修复 mutation。 [#44472](https://github.com/ClickHouse/ClickHouse/pull/44472) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在 `ASTSelectQuery::formatImpl` 中使用 `GROUPING SETS` 时可能出现的空指针解引用问题（[#43049](https://github.com/ClickHouse/ClickHouse/issues/43049)）。[#44479](https://github.com/ClickHouse/ClickHouse/pull/44479)（[Robert Schulze](https://github.com/rschu1ze)）。
* 根据设置，对表函数参数、`CAST` 函数参数以及 `JSONAsObject` 的模式推断进行类型校验。[#44501](https://github.com/ClickHouse/ClickHouse/pull/44501) ([Kruglov Pavel](https://github.com/Avogar))。
* 修复在同时使用 `LowCardinality` 与常量列时 `IN` 函数的问题，关闭 [#44503](https://github.com/ClickHouse/ClickHouse/issues/44503)。[#44506](https://github.com/ClickHouse/ClickHouse/pull/44506)（[Duc Canh Le](https://github.com/canhld94)）。
* 修复了在 `CREATE TABLE` 语句中对 `DEFAULT` 表达式进行规范化处理时的一个错误。函数 `in` 的第二个参数（或运算符 `IN` 的右参数）在执行 CREATE 查询期间可能会被其求值结果替换。修复了 [#44496](https://github.com/ClickHouse/ClickHouse/issues/44496)。[#44547](https://github.com/ClickHouse/ClickHouse/pull/44547)（[Alexander Tokmakov](https://github.com/tavplubix)）。
* 在使用 `WITH ROLLUP`、`WITH CUBE` 和 `WITH TOTALS` 时，`Projections` 不会生效。在此前版本中，查询会抛出异常，而不是跳过对 `Projections` 的使用。这关闭了 [#44614](https://github.com/ClickHouse/ClickHouse/issues/44614)。这关闭了 [#42772](https://github.com/ClickHouse/ClickHouse/issues/42772)。[#44615](https://github.com/ClickHouse/ClickHouse/pull/44615)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 异步块没有被清理，因为函数 `get all blocks sorted by time` 没有获取到异步块。[#44651](https://github.com/ClickHouse/ClickHouse/pull/44651) ([Han Fei](https://github.com/hanfei1991)).
* 修复在带有子查询、UNION 和 TOTALS 的 JOIN 中出现的 `LOGICAL_ERROR`：`The top step of the right pipeline should be ExpressionStep`。修复 [#43687](https://github.com/ClickHouse/ClickHouse/issues/43687)。[#44673](https://github.com/ClickHouse/ClickHouse/pull/44673)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 在 `Executable` 表引擎中避免出现 `std::out_of_range` 异常。[#44681](https://github.com/ClickHouse/ClickHouse/pull/44681) ([Kruglov Pavel](https://github.com/Avogar)).
* 不要在 AST 上对 quantiles 使用 `optimize_syntax_fuse_functions`，关闭 [#44712](https://github.com/ClickHouse/ClickHouse/issues/44712)。[#44713](https://github.com/ClickHouse/ClickHouse/pull/44713)（[Vladimir C](https://github.com/vdimir)）。
* 修复了在 Merge 表和 PREWHERE 中使用错误类型的 bug，关闭 [#43324](https://github.com/ClickHouse/ClickHouse/issues/43324)。[#44716](https://github.com/ClickHouse/ClickHouse/pull/44716)（[Vladimir C](https://github.com/vdimir)）。
* 修复在关闭期间（销毁 TraceCollector 时）可能发生的崩溃。修复 [#44757](https://github.com/ClickHouse/ClickHouse/issues/44757)。[#44758](https://github.com/ClickHouse/ClickHouse/pull/44758)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复分布式查询处理中的潜在崩溃问题。当带有 `totals` 或 `extremes` 的查询返回空结果且 `Distributed` 表与本地表之间存在数据类型不匹配时，可能会发生崩溃。修复了 [#44738](https://github.com/ClickHouse/ClickHouse/issues/44738)。[#44760](https://github.com/ClickHouse/ClickHouse/pull/44760)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复抓取操作（`min_compressed_bytes_to_fsync_after_fetch`）中的 `fsync`，以及在变更中针对小文件（ttl.txt、columns.txt）的 `fsync`（`min_rows_to_fsync_after_merge`/`min_compressed_bytes_to_fsync_after_merge`）。[#44781](https://github.com/ClickHouse/ClickHouse/pull/44781)（[Azat Khuzhin](https://github.com/azat)）。
* 在对 `system.parts` 或 `system.parts_columns` 表执行查询且数据分片正在不同磁盘之间迁移时，可能会触发一个罕见的竞态条件。该问题在 [#41145](https://github.com/ClickHouse/ClickHouse/issues/41145) 中被引入。[#44809](https://github.com/ClickHouse/ClickHouse/pull/44809)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 修复在启用投影优化时可能出现的 `Context has expired` 错误。该问题可在包含特定函数（例如在运行时使用上下文的 `dictHas/dictGet`）的查询中复现。修复了 [#44844](https://github.com/ClickHouse/ClickHouse/issues/44844)。[#44850](https://github.com/ClickHouse/ClickHouse/pull/44850)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复了在从远程文件系统读取 `LowCardinality` 字典时可能出现的 `Cannot read all data` 错误，对应问题 [#44709](https://github.com/ClickHouse/ClickHouse/issues/44709)。[#44875](https://github.com/ClickHouse/ClickHouse/pull/44875)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 在无法读取硬件监控传感器时忽略这些情况，而不是在日志中显示完整的异常信息。[#44895](https://github.com/ClickHouse/ClickHouse/pull/44895) ([Raúl Marín](https://github.com/Algunenano))。
* 当计算得到的 INSERT 延迟时间超过该设置值时，使用 `max_delay_to_insert` 的值。与 [#44902](https://github.com/ClickHouse/ClickHouse/issues/44902) 相关。[#44916](https://github.com/ClickHouse/ClickHouse/pull/44916)（[Igor Nikonov](https://github.com/devcrafter)）。
* 修复在包含 `UNION` 的查询中出现的错误 `Different order of columns in UNION subquery`。修复了 [#44866](https://github.com/ClickHouse/ClickHouse/issues/44866)。[#44920](https://github.com/ClickHouse/ClickHouse/pull/44920)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 用于 INSERT 的延迟可能被错误计算，这会导致始终使用 `max_delay_to_insert` 设置作为延迟值，而不是正确的数值。现在改为使用简单公式 `max_delay_to_insert * (parts_over_threshold/max_allowed_parts_over_threshold)`，即延迟随超出阈值的 part 数量成比例增长。修复了 [#44902](https://github.com/ClickHouse/ClickHouse/issues/44902)。[#44954](https://github.com/ClickHouse/ClickHouse/pull/44954)（[Igor Nikonov](https://github.com/devcrafter)）。
* 修复在宽部件存在轻量级删除掩码时出现的 `ALTER TABLE ... TTL` 错误。 [#44959](https://github.com/ClickHouse/ClickHouse/pull/44959) ([Mingliang Pan](https://github.com/liangliangpan)).
* 对“将域 IP 类型（IPv4、IPv6）替换为原生类型”的后续修复 [#43221](https://github.com/ClickHouse/ClickHouse/issues/43221)。[#45024](https://github.com/ClickHouse/ClickHouse/pull/45024)（[Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)）。
* 针对“将域 IP 类型（IPv4、IPv6）替换为原生类型”的后续修复： [https://github.com/ClickHouse/ClickHouse/pull/43221](https://github.com/ClickHouse/ClickHouse/pull/43221)。[#45043](https://github.com/ClickHouse/ClickHouse/pull/45043)（[Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)）。
* 在解析器中可能出现缓冲区溢出问题。由模糊测试工具发现。[#45047](https://github.com/ClickHouse/ClickHouse/pull/45047)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 修复存储引擎 FileLog 中可能出现的 cannot-read-all-data 错误。关闭 [#45051](https://github.com/ClickHouse/ClickHouse/issues/45051)、[#38257](https://github.com/ClickHouse/ClickHouse/issues/38257)。[#45057](https://github.com/ClickHouse/ClickHouse/pull/45057)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 当查询中使用 grouping sets 时，将禁用内存高效聚合（`distributed_aggregation_memory_efficient` 设置）。 [#45058](https://github.com/ClickHouse/ClickHouse/pull/45058) ([Nikita Taranov](https://github.com/nickitat))。
* 修复 `RANGE_HASHED` 字典，在指定 `update_field` 时，更新操作会将区间列视为主键的一部分。修复了 [#44588](https://github.com/ClickHouse/ClickHouse/issues/44588)。[#45061](https://github.com/ClickHouse/ClickHouse/pull/45061)（[Maksim Kita](https://github.com/kitaisreal)）。
* 修复嵌套 lambda 中 `LowCardinality` 捕获参数触发的 `Cannot capture column` 错误。修复了 [#45028](https://github.com/ClickHouse/ClickHouse/issues/45028)。[#45065](https://github.com/ClickHouse/ClickHouse/pull/45065)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 修复在使用 minmax/count 投影时，`additional_table_filters` 未应用额外过滤条件而导致查询结果错误的问题。 [#45133](https://github.com/ClickHouse/ClickHouse/pull/45133) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复了 `histogram` 函数允许负值的错误。[#45147](https://github.com/ClickHouse/ClickHouse/pull/45147)（[simpleton](https://github.com/rgzntrade)）。
* 修复 `StorageJoin` 中列可为空属性设置错误的问题，关闭 [#44940](https://github.com/ClickHouse/ClickHouse/issues/44940)。[#45184](https://github.com/ClickHouse/ClickHouse/pull/45184)（[Vladimir C](https://github.com/vdimir)）。
* 修复 `background_fetches_pool_size` 设置在运行时增加时的重新加载问题。[#45189](https://github.com/ClickHouse/ClickHouse/pull/45189) ([Raúl Marín](https://github.com/Algunenano)).
* 在 KV 引擎（例如 `KeeperMap`、`EmbeddedRocksDB`）上，正确处理在键上使用 `IN` 且子查询返回不同类型的 `SELECT` 查询。 [#45215](https://github.com/ClickHouse/ClickHouse/pull/45215) ([Antonio Andelic](https://github.com/antonio2368)).
* 修复在某些情况下 `SEMI JOIN` 与 `join_use_nulls` 的逻辑错误，关闭 [#45163](https://github.com/ClickHouse/ClickHouse/issues/45163) 和 [#45209](https://github.com/ClickHouse/ClickHouse/issues/45209)。 [#45230](https://github.com/ClickHouse/ClickHouse/pull/45230)（[Vladimir C](https://github.com/vdimir)）。
* 修复从 S3 读取时出现的 heap-use-after-free 问题。[#45253](https://github.com/ClickHouse/ClickHouse/pull/45253) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复当 Avro Union 类型为 [&#39;null&#39;, Nested 类型] 时的错误，解决 [#45275](https://github.com/ClickHouse/ClickHouse/issues/45275)。修复一个会将 `bytes` 类型错误推断为 `Float` 的错误。[#45276](https://github.com/ClickHouse/ClickHouse/pull/45276) ([flynn](https://github.com/ucasfl))。
* 当在使用 `Merge` 存储引擎的表上无法使用显式 `PREWHERE` 时，抛出正确的异常。 [#45319](https://github.com/ClickHouse/ClickHouse/pull/45319) ([Antonio Andelic](https://github.com/antonio2368)).
* 在 WSL1 Ubuntu 下，ClickHouse 自解压包由于不一致而解压失败——`/proc/self/maps` 报告的是 32 位文件的 inode，而 `stat` 报告的是 64 位 inode。 [#45339](https://github.com/ClickHouse/ClickHouse/pull/45339) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
* 修复 Distributed 表启动过程中的竞态条件（可能导致异步 `INSERT` 的文件被多次处理）。 [#45360](https://github.com/ClickHouse/ClickHouse/pull/45360) ([Azat Khuzhin](https://github.com/azat)).
* 修复在 `ListObject` 请求失败时，从存储 `S3` 和表函数 `s3` 读取数据可能导致的崩溃问题。[#45371](https://github.com/ClickHouse/ClickHouse/pull/45371) ([Anton Popov](https://github.com/CurtizJ)).
* 修复在存在结构错误的字典（例如在 XML 配置中类型不正确）时执行 `SELECT ... FROM system.dictionaries` 时出现的异常。[#45399](https://github.com/ClickHouse/ClickHouse/pull/45399) ([Aleksei Filatov](https://github.com/aalexfvk)).
* 修复在 `INSERT INTO ... SELECT * FROM s3Cluster` 查询中使用插入表结构时的 s3Cluster 架构推断问题。 [#45422](https://github.com/ClickHouse/ClickHouse/pull/45422) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复了通过 HTTP 解析 `JSON/BSONEachRow` 时的一个错误，该错误可能导致某些列使用默认值而非数据中的值。 [#45424](https://github.com/ClickHouse/ClickHouse/pull/45424) ([Kruglov Pavel](https://github.com/Avogar)).
* 修复了从文本源对 IP 类型进行类型化解析时出现的错误（代码：632. DB::Exception: Unexpected data ... after parsed IPv6 value ...）。[#45425](https://github.com/ClickHouse/ClickHouse/pull/45425)（[Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)）。
* 关闭 [#45297](https://github.com/ClickHouse/ClickHouse/issues/45297)，并添加对空正则表达式的检查。 [#45428](https://github.com/ClickHouse/ClickHouse/pull/45428) ([Han Fei](https://github.com/hanfei1991)).
* 修复可能出现的（很可能是分布式）查询挂起问题。 [#45448](https://github.com/ClickHouse/ClickHouse/pull/45448) ([Azat Khuzhin](https://github.com/azat)).
* 修复在启用 `allow_asynchronous_read_from_io_pool_for_merge_tree` 且 `ThreadPool::schedule` 抛出异常时可能发生的死锁问题。 [#45481](https://github.com/ClickHouse/ClickHouse/pull/45481) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 修复在执行 `DETACH` 之后，表仍可能被使用的问题。 [#45493](https://github.com/ClickHouse/ClickHouse/pull/45493) ([Azat Khuzhin](https://github.com/azat)).
* 修复了在查询被取消且其执行过程中使用并行解析时可能发生的罕见异常中止问题。 [#45498](https://github.com/ClickHouse/ClickHouse/pull/45498) ([Anton Popov](https://github.com/CurtizJ)).
* 修复了在创建 `Distributed` 表和向其执行 `INSERT` 之间的竞态条件（可能会在向该表执行 `INSERT` 时导致 `CANNOT&#95;LINK`）。 [#45502](https://github.com/ClickHouse/ClickHouse/pull/45502) ([Azat Khuzhin](https://github.com/azat)).
* 为缓存策略 getter 添加合适的默认值（SLRU）。关闭 [#45514](https://github.com/ClickHouse/ClickHouse/issues/45514)。[#45524](https://github.com/ClickHouse/ClickHouse/pull/45524)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 在变更操作中禁用 `ARRAY JOIN`，关闭 [#42637](https://github.com/ClickHouse/ClickHouse/issues/42637)、[#44447](https://github.com/ClickHouse/ClickHouse/pull/44447)（[SmitaRKulkarni](https://github.com/SmitaRKulkarni)）。
* 修复了在使用表别名和列转换器时限定星号的处理问题。解决了 [#44736](https://github.com/ClickHouse/ClickHouse/issues/44736)。[#44755](https://github.com/ClickHouse/ClickHouse/pull/44755)（[SmitaRKulkarni](https://github.com/SmitaRKulkarni)）。





## [2022 年更新日志](/whats-new/changelog/2022) {#changelog-for-2022}
