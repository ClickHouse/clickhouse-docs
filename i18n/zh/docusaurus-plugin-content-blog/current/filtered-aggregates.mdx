---
title: 在 ClickHouse 中使用过滤聚合
description: 了解如何在 ClickHouse 中使用结合 `-If` 和 `-Distinct` 聚合组合器的过滤聚合，以简化查询语法并提高分析能力。
date: 2023-03-01
tags: ['函数']
keywords: ['过滤聚合']
---

{frontMatter.description}

{/* 截断 */}

## 使用过滤聚合 \{#using-filtered-aggregates\}

ClickHouse 提供了一种简单直观的方式来编写 *过滤聚合*。

例如，将标准 SQL 中编写过滤聚合的方式（在 ClickHouse 中同样适用）与使用简写语法的方式进行对比：简写语法通过 `-If` [聚合函数组合器](https://clickhouse.com/docs/sql-reference/aggregate-functions/combinators/)，可以附加在任意聚合函数后面：

```sql
--标准 SQL
SELECT
   avg(number)
FILTER (WHERE number > 50)
FROM numbers(100)

--使用 ClickHouse 聚合组合器
SELECT
   avgIf(number, number > 50)
FROM numbers(100)
```

类似地，还有一个 `-Distinct` 聚合函数组合器：

```sql
--标准 SQL
SELECT avg(DISTINCT number)

--ClickHouse 使用聚合组合器
SELECT avgDistinct(number)
```

为什么带过滤条件的聚合很重要？因为它们可以让你在网站分析服务中实现 **&quot;segment comparison&quot;（分群对比）** 功能。
例如：

```sql
WITH
   Region = 'us' AS segment1,
   Browser = 'Chrome' AS segment2
SELECT
   uniqIf(UserID, segment1),
   uniqIf(UserID, segment2)
WHERE segment1 OR segment2
```

请查阅文档中的 [aggregate function combinator](https://clickhouse.com/docs/sql-reference/aggregate-functions/combinators/) 页面以了解更多详细信息。
