---
title: 在生产环境中应使用哪个 ClickHouse 版本？
description: "首先，让我们来讨论一下人们最初为什么会问这个问题。这里有两个主要原因……"
date: 2021-09-01
tags: ['概念', '性能与优化']
keywords: ['生产环境版本']
---

{frontMatter.description}

{/* 截断 */}


## 引言 \{#introduction\}

首先，我们来讨论一下，人们最初为什么会问这个问题。 

主要有两个原因：

1.  ClickHouse 的开发节奏非常快，通常每年会发布 10 个以上的稳定版本。这意味着可供选择的版本非常多，而做出选择并不是一件简单的事。
2.  有些用户不想花时间弄清楚哪个版本最适合自己的使用场景，而是希望直接听从他人的建议。

第二个原因更具根本性，因此我们将从这一点讲起，然后再回到如何在不同的 ClickHouse 版本之间进行选择。

## 你推荐使用哪个 ClickHouse 版本？ \{#which-clickhouse-version-do-you-recommend\}

人们往往会倾向于雇佣顾问，或者信任一些知名专家，以摆脱对自己生产环境的责任。你安装了别人推荐的某个特定 ClickHouse 版本；如果这个版本出了问题——那就不是你的错，而是“别人的”。这种思路是一个巨大的陷阱。没有任何外部人士会比你更了解你公司生产环境中真正发生了什么。

那么，如何正确选择要升级到哪个 ClickHouse 版本？或者，如何选择你的第一个 ClickHouse 版本？首先，你需要投入精力搭建一个**真实的预生产环境**。在理想情况下，它可以是一个完全相同的影子副本，但这通常成本较高。

下面是一些关键要点，可以在成本不太高的情况下，让预生产环境具备足够逼真度：

- 预生产环境需要运行与你打算在生产环境中运行的查询尽可能接近的一组查询：
    - 不要只把它做成带冻结数据的只读环境。
    - 不要只把它做成只写环境，仅复制数据而不构建一些典型报表。
    - 在需要执行 schema 迁移时，不要直接清空它。
- 使用真实生产数据和查询的样本。尽量选择一个仍具有代表性、并且能让 `SELECT` 查询返回合理结果的样本。如果你的数据较为敏感，并且内部策略不允许数据离开生产环境，请使用脱敏处理。
- 确保预生产环境与生产环境一样，被你的监控和告警软件纳入监控，覆盖水平保持一致。
- 如果你的生产环境跨多个数据中心或区域，那么也让预生产环境做到这一点。
- 如果你的生产环境使用了诸如复制、分布式表和级联物化视图等复杂特性，请确保它们在预生产环境中的配置也类似。
- 在预生产环境中，是使用与生产环境大致相同数量但规格更小的服务器或 VM，还是使用数量少得多但规格和生产相同的服务器或 VM，这之间存在权衡。前者可能会额外暴露与网络相关的问题，而后者更易于管理。

第二个需要投入的领域是**自动化测试基础设施**。不要假设某类查询一旦成功执行过一次，就会永远成功执行。使用一些把 ClickHouse 模拟掉的单元测试是可以的，但务必确保你的产品有一套合理的自动化测试集，在真实的 ClickHouse 上运行，用于检查所有重要用例是否仍按预期工作。

更进一步的一步，是把这些自动化测试贡献给 [ClickHouse 的开源测试基础设施](https://github.com/ClickHouse/ClickHouse/tree/master/tests)，该基础设施在日常开发中被持续使用。学习[如何运行它](/development/tests)，以及如何将你的测试适配到这个框架，肯定需要额外的时间和精力，但其回报在于：当某个 ClickHouse 版本被宣布为稳定版时，它已经在这些测试之下被验证过，而不是你一再在事后花时间去报告问题，然后再等待 bug 修复的实现、回溯修复并发布。一些公司甚至把这类对基础设施的测试贡献，作为其内部策略的一部分（在 Google 被称为 [Beyonce's Rule](https://www.oreilly.com/library/view/software-engineering-at/9781492082781/ch01.html#policies_that_scale_well)）。

当你拥有预生产环境和测试基础设施后，选择最佳版本就很直接了：

1.  定期在新的 ClickHouse 发行版上运行你的自动化测试。你甚至可以对被标记为 `testing` 的 ClickHouse 版本这么做，但不推荐在后续步骤中继续使用这些版本。
2.  将通过测试的 ClickHouse 版本部署到预生产环境，并检查所有流程是否如预期运行。
3.  将你发现的任何问题报告到 [ClickHouse GitHub Issues](https://github.com/ClickHouse/ClickHouse/issues)。
4.  如果没有重大问题，通常就可以开始在生产环境中部署该 ClickHouse 版本。投入精力构建渐进发布自动化，实现类似 [canary releases](https://martinfowler.com/bliki/CanaryRelease.html) 或 [green-blue deployments](https://martinfowler.com/bliki/BlueGreenDeployment.html) 的方案，可以进一步降低生产环境中出现问题的风险。

你可能已经注意到，上述方法中并没有什么特定于 ClickHouse 的内容——只要认真对待生产环境，人们都会对任何关键基础设施组件采取类似做法。

## 如何在不同的 ClickHouse 发行版之间进行选择？ \{#how-to-choose-between-clickhouse-releases\}

如果你查看 ClickHouse 软件包仓库中的内容，会看到两种类型的软件包：

1.  `stable`
2.  `lts`（长期支持版，long-term support）

下面是关于如何在它们之间进行选择的一些指导建议：

- `stable` 是我们默认推荐的软件包类型。它们大约每月发布一次（因此可以在合理的延迟内获得新特性），并且最新的三个 `stable` 版本在诊断和缺陷（bug）修复回溯方面都处于支持范围内。
- `lts` 每年发布两次，并在初始发布后提供一年的支持。在以下情况下，你可能会更倾向于选择 `lts` 而不是 `stable`：
    - 你的公司有内部策略，不允许频繁升级或使用非 LTS 软件。
    - 你在一些次要产品中使用 ClickHouse，这些产品要么不需要任何复杂的 ClickHouse 功能，要么没有足够的资源来保持其持续升级。

许多团队起初认为 `lts` 是最佳选择，但最终通常会因为某个对其产品非常重要的新特性而转向 `stable`。

:::warning
在升级 ClickHouse 时还有一件需要牢记的事情：我们始终密切关注各个版本之间的兼容性，但有时保持完全兼容并不现实，一些细节可能会发生变化。因此，请务必在升级之前检查 [changelog](/whats-new/changelog)，以了解是否有关于向后不兼容变更的说明。
:::