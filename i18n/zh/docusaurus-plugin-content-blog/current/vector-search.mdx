---
date: 2023-10-26
title: ClickHouse 是否可用于向量搜索？
description: 了解如何使用 ClickHouse 进行向量搜索，包括存储向量嵌入（embeddings），以及使用余弦相似度等距离函数进行检索。
tags: ['使用场景', '概念']
keywords: ['向量搜索']
---

{frontMatter.description}

{/* 截断 */}

## 使用 ClickHouse 进行向量搜索！ \{#clickhouse-for-vector-search\}

是的，ClickHouse 可以执行向量搜索。

与使用更专业的向量数据库相比，使用 ClickHouse 进行向量搜索的主要优势包括：

* 利用 ClickHouse 的过滤和全文搜索能力，在执行搜索之前先对数据集进行筛选。
* 对数据集进行分析。
* 对现有数据运行 `JOIN`。
* 无需再额外维护一个数据库，从而避免使基础设施变得更加复杂。

下面是一个关于如何使用 ClickHouse 进行向量搜索的快速教程。

## 1. 创建 embeddings \{#1-create-embeddings\}

必须先将你的数据（文档、图像或结构化数据）转换为 *embeddings*。我们建议使用 [OpenAI Embeddings API](https://platform.openai.com/docs/api-reference/embeddings) 或开源 Python 库 [SentenceTransformers](https://www.sbert.net/) 来创建 embeddings。

你可以将 embedding 理解为一个由大量浮点数组成的向量，用于表示你的数据。[查看 OpenAI 的这篇指南，进一步了解 embeddings](https://platform.openai.com/docs/guides/embeddings/what-are-embeddings)。

## 2. 存储向量嵌入 \{#2-store-the-embeddings\}

生成向量嵌入后，需要将其存储到 ClickHouse 中。每个向量嵌入应存储为单独的一行，并且可以包含用于过滤、聚合或分析的元数据。下面是一个可以存储带有说明文字的图像的表示例：

```sql
CREATE TABLE images
(
	`_file` LowCardinality(String),
	`caption` String,
	`image_embedding` Array(Float32)
)
ENGINE = MergeTree;
```

## 3. 搜索相关嵌入向量 \{#3-search-for-related-embeddings\}

假设你想在数据集中搜索狗的图片。你可以使用 `cosineDistance` 这样的距离函数，先为一张狗的图片生成嵌入向量，然后搜索与之相似的图片：

```sql
SELECT
    _file,
	caption,
	cosineDistance(
        -- 您"输入"的狗图片的嵌入向量
        [0.5736801028251648, 0.2516217529773712, ...,  -0.6825592517852783],
        image_embedding
    ) AS score
FROM images
ORDER BY score ASC
LIMIT 10
```

此查询将返回与您提供的狗狗图像最可能相关的前 10 张图像的 `_file` 名称和说明文字（`caption`）。

## 延伸阅读 \{#further-reading\}

如需参阅关于在 ClickHouse 中进行向量搜索的更深入教程，请查看：

* [精确与近似向量搜索](https://clickhouse.com/docs/engines/table-engines/mergetree-family/annindexes)