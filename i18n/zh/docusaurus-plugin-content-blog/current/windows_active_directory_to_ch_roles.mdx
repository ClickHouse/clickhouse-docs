---
title: 将 Windows Active Directory 安全组映射到 ClickHouse 角色
description: "将 Windows Active Directory 安全组映射到 ClickHouse 角色的示例"
date: 2024-05-20
tags: ['工具和实用工具']
keywords: ['Windows']
---

import Image from "@theme/IdealImage";
import ad_env from "@site/static/images/knowledgebase/windows-ad-ch-roles/AD_Env_and_UO_structure.png";
import ad_group from "@site/static/images/knowledgebase/windows-ad-ch-roles/AD_Group_clickhouse_ad_db1_users.png";
import ad_user from "@site/static/images/knowledgebase/windows-ad-ch-roles/AD_user_clickhouse_db1_user.png";
import ad_user_group from "@site/static/images/knowledgebase/windows-ad-ch-roles/AD_user_to_group.png";

{frontMatter.description}

{/* 截断 */}


## 示例

本示例展示了属于不同 AD 安全组的 AD 用户如何在 ClickHouse 中被授予角色访问权限。它还展示了如何将一个用户添加到多个 AD 用户组，从而通过多个角色获得访问权限。

在此环境中，我们有如下配置：

* 一个 Windows Active Directory 域：`marsnet2.local`
* 一个 ClickHouse 集群 `cluster_1S_3R`，在 1 个分片、3 个副本的集群配置上包含 3 个节点
* 3 个 AD 用户

| AD 用户                       | 描述                                   |
| --------------------------- | ------------------------------------ |
| clickhouse&#95;ad&#95;admin | ClickHouse 管理员用户                     |
| clickhouse&#95;db1&#95;user | 具有 db1.table1 访问权限的用户                |
| clickhouse&#95;db2&#95;user | 具有 db2.table1 访问权限的用户                |
| ch&#95;db1&#95;db2&#95;user | 同时具有 db1.table1 和 db2.table1 访问权限的用户 |

* 3 个 AD 安全组

| AD 组                                | 描述                        |
| ----------------------------------- | ------------------------- |
| clickhouse&#95;ad&#95;admins        | ClickHouse 管理员组           |
| clickhouse&#95;ad&#95;db1&#95;users | 映射为具有 db1.table1 访问权限的用户组 |
| clickhouse&#95;ad&#95;db2&#95;users | 映射为具有 db2.table1 访问权限的用户组 |

* 示例 AD 环境和 OU 结构：

<Image img={ad_env} size="md" alt="示例 AD 环境和 OU 结构" />

* 示例 AD 安全组配置：

<Image img={ad_group} size="md" alt="示例 AD 安全组配置" />

* 示例 AD 用户配置：

<Image img={ad_user} size="md" alt="示例 AD 用户配置" />

1. 在 Windows AD Users and Groups 中，将每个用户添加到其各自的组中；这些用户将映射到 ClickHouse 角色（示例见下一步）。

| AD 安全组                      | ClickHouse 角色                                                             |
| --------------------------- | ------------------------------------------------------------------------- |
| clickhouse&#95;ad&#95;admin | clickhouse&#95;ad&#95;admins                                              |
| clickhouse&#95;db1&#95;user | clickhouse&#95;ad&#95;db1&#95;users                                       |
| clickhouse&#95;db2&#95;user | clickhouse&#95;ad&#95;db2&#95;users                                       |
| ch&#95;db1&#95;db2&#95;user | clickhouse&#95;ad&#95;db1&#95;users 和 clickhouse&#95;ad&#95;db2&#95;users |

* 示例用户组成员关系：

<Image img={ad_user_group} size="md" alt="示例用户组成员关系" />

2. 在 ClickHouse 的 `config.xml` 中，将 `ldap_servers` 配置添加到每个 ClickHouse 节点。

```
<ldap_servers>
	<marsnet2_ad>
		<host>marsdc1.marsnet2.local</host>
		<port>389</port>
		<bind_dn>{user_name}@marsnet2.local</bind_dn>
		<user_dn_detection>
			<base_dn>OU=Users,OU=ClickHouse,DC=marsnet2,DC=local</base_dn>
			<search_filter>(&amp;(objectClass=user)(sAMAccountName={user_name}))</search_filter>
		</user_dn_detection>
		<enable_tls>no</enable_tls>
	</marsnet2_ad>
</ldap_servers>
```

| xml tag                   | 描述                                                  | 示例值                                                 |
| ------------------------- | --------------------------------------------------- | --------------------------------------------------- |
| ldap&#95;servers          | 用于定义 ClickHouse 将使用的 ldap 服务器的标签                    | NA                                                  |
| marsnet&#95;ad            | 此标签名称是任意的，仅作为标识符，用于在 `<user_directories>` 部分中识别该服务器 | NA                                                  |
| host                      | Active Directory 服务器或域的 FQDN 或 IP 地址                | marsdc1.marsnet2.local                              |
| port                      | Active Directory 端口，通常非 SSL 为 389，SSL 为 636         | 389                                                 |
| bind&#95;dn               | 用于与 AD 建立绑定的用户，如果不允许使用普通用户，可以使用专用用户                 | `{user_name}@marsnet2.local`                        |
| user&#95;dn&#95;detection | 控制 ClickHouse 如何查找 AD 用户的设置                         | NA                                                  |
| base&#95;dn               | 用于开始搜索用户的 AD OU 路径                                  | OU=Users,OU=ClickHouse,DC=marsnet2,DC=local         |
| search&#95;filter         | 用于查找 AD 用户的 ldap 搜索过滤器                              | `(&(objectClass=user)(sAMAccountName={user_name}))` |

有关完整选项集，请参阅文档：
[https://clickhouse.com/docs/operations/external-authenticators/ldap#ldap-server-definition](https://clickhouse.com/docs/operations/external-authenticators/ldap#ldap-server-definition)

3. 在 ClickHouse 的 `config.xml` 中，为每个 ClickHouse 节点添加包含 `<ldap>` 条目的 `<user_directories>` 配置。


```
<user_directories>
	<users_xml>
		<path>users.xml</path>
	</users_xml>
	<local_directory>
		<path>/var/lib/clickhouse/access/</path>
	</local_directory>
	<ldap>
		<server>marsnet2_ad</server>
		<role_mapping>
			<base_dn>OU=Groups,OU=ClickHouse,DC=marsnet2,DC=local</base_dn>
			<search_filter>(&amp;(objectClass=group)(member={user_dn}))</search_filter>
			<attribute>CN</attribute>
			<scope>subtree</scope>
			<prefix>clickhouse_</prefix>
		</role_mapping>
	</ldap>
</user_directories>
```

| xml tag              | Description                                | Example Value                                |
| -------------------- | ------------------------------------------ | -------------------------------------------- |
| user&#95;directories | 定义将使用哪些身份验证器                               | NA                                           |
| ldap                 | 包含要在 AD 中使用的 LDAP 服务器的相关设置                 | NA                                           |
| server               | 在 `<ldap_servers>` 小节中定义的标签                | marsnet2&#95;ad                              |
| role&#95;mapping     | 定义已通过身份验证的用户在 AD 组与 ClickHouse 角色之间如何进行映射  | NA                                           |
| base&#95;dn          | 系统用于开始搜索 AD 组的 AD 路径                       | OU=Groups,OU=ClickHouse,DC=marsnet2,DC=local |
| search&#95;filter    | 用于查找 AD 组的 LDAP 搜索过滤器                      | `(&(objectClass=group)(member={user_dn}))`   |
| attribute            | 指定应使用哪个 AD 属性字段来标识用户                       | CN                                           |
| scope                | 指定系统在 base DN 中应在哪些层级搜索这些组                 | subtree                                      |
| prefix               | AD 中组名称的前缀；系统会移除此前缀，以在 ClickHouse 中查找对应的角色 | clickhouse&#95;                              |

请参考文档以获取完整的选项集合：
[https://clickhouse.com/docs/operations/external-authenticators/ldap#ldap-external-user-directory](https://clickhouse.com/docs/operations/external-authenticators/ldap#ldap-external-user-directory)

**注意:::**
由于示例中的 AD 安全组名称都带有前缀——即 `clickhouse_ad_db1_users`——当系统检索到这些组时，会移除此前缀，然后系统会查找名为 `ad_db1_users` 的 ClickHouse 角色，以映射到 `clickhouse_ad_db1_users`。
**:::**

4. 创建示例数据库。

```
create database db1 on cluster 'cluster_1S_3R';
create database db2 on cluster 'cluster_1S_3R';
```

5. 创建示例表。

```
create table db1.table1 on cluster 'cluster_1S_3R'
(
  id Int32,
  column1 String
)
engine = MergeTree()
order by id;

create table db2.table1 on cluster 'cluster_1S_3R
(
  id Int32,
  column1 String
)
engine = MergeTree()
order by id;
```

6. 插入示例数据。

```
insert into db1.table1
values
(1, 'a');

insert into db2.table1
values
(2, 'b');
```

7. 创建 ClickHouse 角色。

```
create role ad_admins on cluster 'cluster_1S_3R';
create role ad_db1_users on cluster 'cluster_1S_3R';
create role ad_db2_users on cluster 'cluster_1S_3R';
```

8. 为角色授予权限。

```
GRANT SHOW, SELECT, INSERT, ALTER, CREATE, DROP, UNDROP TABLE, TRUNCATE, OPTIMIZE, BACKUP, KILL QUERY, KILL TRANSACTION, MOVE PARTITION BETWEEN SHARDS, ACCESS MANAGEMENT, SYSTEM, dictGet, displaySecretsInShowAndSelect, INTROSPECTION, SOURCES, CLUSTER ON *.* on cluster 'cluster_1S_3R' TO ad_admins WITH GRANT OPTION;

GRANT SELECT ON db1.table1 on cluster 'cluster_1S_3R' TO ad_db1_users;

GRANT SELECT ON db2.table1 on cluster 'cluster_1S_3R' TO ad_db2_users;
```

9. 测试受限的 db1 用户访问权限。
   例如：


```
root@chnode1:/etc/clickhouse-server# clickhouse-client --user clickhouse_db1_user --password MyPassword123  --secure --port 9440 --host chnode1.marsnet.local
ClickHouse 客户端版本 24.1.3.31（官方构建）。
正在以用户 clickhouse_db1_user 身份连接到 chnode1.marsnet.local:9440。
已连接到 ClickHouse 服务器版本 24.1.3。


clickhouse :) select * from db1.table1;

SELECT *
FROM db1.table1

Query id: b04b92d6-5b8b-40a2-a92a-f06f15774930

┌─id─┬─column1─┐
│  1 │ a       │
└────┴─────────┘

结果集 1 行。耗时：0.004 秒。

clickhouse :) select * from db2.table1;

SELECT *
FROM db2.table1

Query id: 7f7eaa44-7b47-4184-807a-6968a56057ad


耗时：0.115 秒。

从服务器接收到异常（版本 24.1.3）：
代码：497。DB::Exception: 从 chnode1.marsnet.local:9440 接收。DB::Exception: clickhouse_db1_user: 权限不足。要执行此查询，必须拥有对 db2.table1 的 SELECT(id, column1) 授权。(ACCESS_DENIED)
```

10. 使用同时拥有 db1 和 db2 两个数据库访问权限的用户进行访问测试。
    例如：

```
root@chnode1:/etc/clickhouse-server# clickhouse-client --user ch_db1_db2_user --password MyPassword123  --secure --port 9440 --host chnode1.marsnet.local
ClickHouse 客户端版本 24.1.3.31(官方构建)。
正在以用户 ch_db1_db2_user 身份连接到 chnode1.marsnet.local:9440。
已连接到 ClickHouse 服务器版本 24.1.3。

clickhouse :) select * from db1.table1;

SELECT *
FROM db1.table1

Query id: 23084744-08c2-48bd-8635-a23438812026

┌─id─┬─column1─┐
│  1 │ a       │
└────┴─────────┘

结果集 1 行。用时:0.005 秒。

clickhouse :) select * from db2.table1;

SELECT *
FROM db2.table1

Query id: f9954ec4-d8d9-4b5a-9f68-a7aa79a1bb4a

┌─id─┬─column1─┐
│  2 │ b       │
└────┴─────────┘

结果集 1 行。用时:0.004 秒。
```

11. 测试管理员用户的访问权限。
    例如：


```
root@chnode1:/etc/clickhouse-server# clickhouse-client --user clickhouse_ad_admin --password MyPassword123  --secure --port 9440 --host chnode1.marsnet.local
ClickHouse client version 24.1.3.31 (official build).
Connecting to chnode1.marsnet.local:9440 as user clickhouse_ad_admin.
Connected to ClickHouse server version 24.1.3.

clickhouse :) create table db1.table2 on cluster 'cluster_1S_3R'
(
  id Int32,
  column1 String
)
engine = MergeTree()
order by id;

CREATE TABLE db1.table2 ON CLUSTER cluster_1S_3R
(
    `id` Int32,
    `column1` String
)
ENGINE = MergeTree
ORDER BY id

Query id: 6041fd32-4294-44bd-b442-3fdd41333e6f

┌─host──────────────────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐
│ chnode1.marsnet.local │ 9440 │      0 │       │                   2 │                2 │
└───────────────────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘
┌─host──────────────────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐
│ chnode2.marsnet.local │ 9440 │      0 │       │                   1 │                1 │
└───────────────────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘
┌─host──────────────────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐
│ chnode3.marsnet.local │ 9440 │      0 │       │                   0 │                0 │
└───────────────────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘
```
