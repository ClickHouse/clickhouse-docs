---
title: 在 Docker 中配置 CAP_IPC_LOCK 和 CAP_SYS_NICE 权限
description: 了解如何在容器中运行 ClickHouse 时，解决与 `CAP_IPC_LOCK` 和 `CAP_SYS_NICE` 相关的 Docker 权限警告。
date: 2023-06-07
tags: ['错误和异常']
keywords: ['Docker', 'CAP_IPC_LOCK', 'CAP_SYS_NICE']
---

{frontMatter.description}

{/* 截断 */}


## 问题

在 Docker 中运行 ClickHouse 时，Docker 会提示系统缺少 `CAP_IPC_LOCK` 和 `CAP_SYS_NICE` 能力（capability）。该如何解决？

下面是当缺少 `CAP_SYS_NICE` 或 `CAP_SYS_NICE` 能力时日志消息的示例：

```bash
docker run -d --name clickhouse-server \
    --ulimit nofile=262144:262144 \
    --network clickhouse-net \
    -p 8123:8123 -p 9000:9000 -p 9009:9009 -p 9363:9363 \
    clickhouse/clickhouse-server:23.2
```

```response
2023.04.19 08:04:10.022720 [ 1 ] {} <Information> Application: 进程似乎缺少 CAP_IPC_LOCK 权限,二进制 mlock 将被禁用。这可能是由于 ClickHouse 软件包安装不正确所致。您可以通过执行 'sudo setcap cap_ipc_lock=+ep /usr/bin/clickhouse' 手动解决该问题。注意:此方法在使用 'nosuid' 选项挂载的文件系统上无效。

2023.04.19 08:04:10.065860 [ 1 ] {} <Information> Application: 进程似乎缺少 CAP_SYS_NICE 权限,'os_thread_priority' 设置将不生效。这可能是由于 ClickHouse 软件包安装不正确所致。您可以通过执行 'sudo setcap cap_sys_nice=+ep /usr/bin/clickhouse' 手动解决该问题。注意:此方法在使用 'nosuid' 选项挂载的文件系统上无效。
```


## 答案

1. 添加两个 `--cap-add` 参数，为容器授予 `IPC_LOCK` 和 `SYS_NICE` 权限：

```bash
docker run -d --name clickhouse-server \
   --cap-add=SYS_NICE \
   --cap-add=IPC_LOCK \
   --ulimit nofile=262144:262144 \
   --network clickhouse-net \
   -p 8123:8123 -p 9000:9000 -p 9009:9009 -p 9363:9363 \
   clickhouse/clickhouse-server:23.2
```

2. 使用以下命令检查容器中是否显示这些 capabilities：

```bash
apt-get update > /dev/null && apt-get install -y libcap2-bin > /dev/null && capsh --print
```

返回结果类似如下：

```response
debconf: 由于未安装 apt-utils,延迟软件包配置
警告:libcap 需要更新(cap=40 应具有名称)。
Current: = cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_net_raw,cap_ipc_lock,cap_sys_chroot,cap_sys_nice,cap_mknod,cap_audit_write,cap_setfcap+ep
Bounding set =cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_net_raw,cap_ipc_lock,cap_sys_chroot,cap_sys_nice,cap_mknod,cap_audit_write,cap_setfcap
Ambient set =
Securebits: 00/0x0/1'b0
 secure-noroot: no (unlocked)
 secure-no-suid-fixup: no (unlocked)
 secure-keep-caps: no (unlocked)
 secure-no-ambient-raise: no (unlocked)
uid=0(root) euid=0(root)
gid=0(root)
groups=0(root)
推测模式:不确定(0)
```

3. 手动为 ClickHouse 设置这两项 Capabilities

```bash
setcap "cap_ipc_lock=+ep cap_sys_nice=+ep" /usr/bin/clickhouse
```

4. 检查这些 capabilities 是否已生效。

```bash
getcap -v /usr/bin/clickhouse
```

您应当会看到如下内容：

```response
/usr/bin/clickhouse = cap_ipc_lock,cap_sys_nice+ep
```

5. 重启 ClickHouse 服务器后，这些日志消息就不应再出现。

<br />

请查看这篇[关于 Linux capabilities 的文章](https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities)以了解更多详情。
