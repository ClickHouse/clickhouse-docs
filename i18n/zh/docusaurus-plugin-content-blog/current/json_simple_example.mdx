---
title: 使用落地表和物化视图提取 JSON 数据的简单示例流程
description: "使用落地表和物化视图提取 JSON 数据的简单示例流程"
date: 2024-05-20
tags: ['数据格式']
keywords: ['JSON', '落地表', '物化视图']
---

{frontMatter.description}

{/* 截断 */}


## Question \{#question\}

如何在使用源表或落地表处理 JSON 消息时，通过物化视图提取数据？  
在不使用实验性 JSON Object 特性的情况下，如何处理 JSON？

## Answer

处理 JSON 数据的常见模式是先将数据写入一个落地表（landing table），然后使用 JSONExtract 函数配合物化视图触发器（Materialized View trigger）将数据抽取到一个新表中。
通常会按照如下流程和模式进行：

```
源数据 --> MergeTree 表 --> 物化视图(带基表) --> 应用程序/客户端
```

落地表应包含一个 `raw` 字符串字段，用来存储原始 JSON。它还应包含一到两个其他字段，用于该表的管理，便于随着数据变旧对其进行分区和清理。

*某些集成可能会在原始数据上增加字段，例如在使用 ClickHouse Kafka Connector Sink 时。

简化示例如下：

* 创建示例数据库

```
创建数据库 db1;
```

* 创建一个落地表，用于插入你的原始 JSON 数据：

```
create table db1.table2_json_raw
(
    id Int32,
    timestamp DateTime,
    raw String
)
engine = MergeTree()
order by timestamp;
```

* 为物化视图创建基表

```
create table db1.table2_json_mv_base
(
 id Int32,
 timestamp DateTime,
 raw_string String,
 custId Int8,
 custName String
)
engine = MergeTree()
order by timestamp;
```

* 为基表创建物化视图

```
CREATE MATERIALIZED VIEW db1.table2_json_mv TO db1.table2_json_mv_base
AS SELECT
 id,
 timestamp,
 raw as raw_string,
 simpleJSONExtractRaw(raw, 'customerId') as custId,
 simpleJSONExtractRaw(raw, 'customerName') as custName
 FROM
db1.table2_json_raw;
```

* 插入几行示例数据

```
 insert into db1.table2_json_raw
 values
 (1, '2024-05-16 00:00:00', '{"customerId":1, "customerName":"ABC"}'),
 (2, '2024-05-16 00:00:01', '{"customerId":2, "customerName":"XYZ"}');
```

* 查看抽取结果以及查询中将使用的物化视图

```
clickhouse-cloud :) select * from db1.table2_json_mv;

SELECT *
FROM db1.table2_json_mv

Query id: 12655fd3-567a-4dfb-9ef7-abc4b11ad044

┌─id─┬───────────timestamp─┬─raw_string─────────────────────────────┬─custId─┬─custName─┐
│  1 │ 2024-05-16 00:00:00 │ {"customerId":1, "customerName":"ABC"} │ 1      │ "ABC"    │
│  2 │ 2024-05-16 00:00:01 │ {"customerId":2, "customerName":"XYZ"} │ 2      │ "XYZ"    │
└────┴─────────────────────┴────────────────────────────────────────┴────────┴──────────┘
```

附加参考链接：\
物化视图：[https://clickhouse.com/docs/guides/developer/cascading-materialized-views](https://clickhouse.com/docs/guides/developer/cascading-materialized-views)
使用 JSON：[https://clickhouse.com/docs/integrations/data-formats/json#other-approaches](https://clickhouse.com/docs/integrations/data-formats/json#other-approaches)
JSON 函数：[https://clickhouse.com/docs/sql-reference/functions/json-functions](https://clickhouse.com/docs/sql-reference/functions/json-functions)
