---
title: 在 ClickHouse 中按内存使用量识别高开销查询
description: 了解如何使用 `system.query_log` 表在 ClickHouse 中查找最耗内存的查询，并包含针对集群和单机部署的示例。
date: 2023-06-07
tags: ['性能与优化']
keywords: ['高开销查询', '内存使用量']
---

{frontMatter.description}

{/* 截断 */}

## 使用 `system.query_log` 表 \{#using-the-systemquery&#95;log-table\}

下面这个实用查询可以显示，在你已执行的查询中哪些使用了最多的内存。

关于此查询有几点说明：

* 结果是基于过去一天（`now() - toIntervalDay(1))`）的数据计算的，但你可以轻松修改时间区间
* 它假定你有一个名为 `default` 的集群，这也是你在 [ClickHouse Cloud](https://console.clickhouse.cloud) 中集群的名称。请将 `default` 更改为你自己的集群名称
* 如果你没有集群，请参见本文末尾列出的查询

```sql
SELECT
    count() as nb_query,
    user,
    query,
    sum(memory_usage) AS memory,
    normalized_query_hash
FROM
    clusterAllReplicas(default, system.query_log)
WHERE
    (event_time >= (now() - toIntervalDay(1)))
    AND query_kind = 'Select'
    AND type = 'QueryFinish'
    and user != 'monitoring-internal'
GROUP BY
    normalized_query_hash,
    query,
    user
ORDER BY
    memory DESC;
```

响应如下所示：

```response
┌─nb_query─┬─user────┬─query─────────────────────────────────────────────────────────┬───memory─┬─normalized_query_hash─┐
│       11 │ default │ select version()                                              │ 46178924 │   7202516440347714159 │
│        2 │ default │ SELECT * FROM "system"."table_functions" LIMIT 31 OFFSET 0    │  8391544 │  12830067173062987695 │
└──────────┴─────────┴───────────────────────────────────────────────────────────────┴──────────┴───────────────────────┘
```

:::note
如果没有 `system.query_log` 表，则很可能尚未启用查询日志。请参阅 [`query_log` 设置](https://clickhouse.com/docs/operations/server-configuration-parameters/settings#server_configuration_parameters-query-log) 以了解如何启用它。
:::

如果没有集群，可以直接查询单个 `system.query_log` 表：

```sql
SELECT
    count() as nb_query,
    user,
    query,
    sum(memory_usage) AS memory,
    normalized_query_hash
FROM
    system.query_log
WHERE
    (event_time >= (now() - toIntervalDay(1)))
    AND query_kind = 'Select'
    AND type = 'QueryFinish'
    and user != 'monitoring-internal'
GROUP BY
    normalized_query_hash,
    query,
    user
ORDER BY
    memory DESC;
```
