---
title: '查询超出内存限制'
description: '排查查询因超出内存限制而产生的错误'
date: 2025-07-25
tags: ['错误和异常']
keywords: ['OOM', '超出内存限制']
---

{frontMatter.description}

{/* 截断 */}

import Image from '@theme/IdealImage';
import joins from '@site/static/images/knowledgebase/memory-limit-exceeded-for-query.png';

## 查询超出内存限制 \{#troubleshooting-out-of-memory-issues\}

对于新用户来说，ClickHouse 往往看起来像是“魔法”——每个查询都超级快，
即使在最大规模的数据集和最复杂、最激进的查询场景下也是如此。然而，在真实世界的使用中，
即便是 ClickHouse 也终会遇到自己的极限。超出内存限制的查询可能由多种原因导致。
最常见的情况是对高基数字段执行大规模 JOIN 或聚合操作。如果性能至关重要，
并且这些查询又是必需的，我们通常建议用户直接扩容——ClickHouse Cloud
会自动且毫不费力地完成这一点，以确保你的查询始终保持良好的响应速度。
不过，我们也理解，在自托管场景中，这有时并不简单，而且也未必总是需要做到最优性能。
在这种情况下，用户有几种可选做法。

### 聚合 \{#aggregations\}

对于内存密集型的聚合或排序场景，用户可以分别使用
[`max_bytes_before_external_group_by`](/operations/settings/settings#max_bytes_before_external_group_by)
和 [`max_bytes_before_external_sort`](/operations/settings/settings#max_bytes_ratio_before_external_sort)
这两个设置。前者在[这里](/sql-reference/statements/select/group-by/#group-by-in-external-memory)有详细讨论。

总之，该机制确保在超过内存阈值时，任何聚合操作都可以“溢出”到磁盘。这样通常会影响查询性能，但有助于确保查询不会发生 OOM。后者的排序设置则有助于解决内存密集型排序的类似问题。这在分布式环境中特别重要，此时协调节点会从子分片接收到已排序的响应。在这种情况下，协调服务器可能被要求对一个大于其可用内存的数据集进行排序。通过 [`max_bytes_before_external_sort`](/operations/settings/settings#max_bytes_ratio_before_external_sort)，可以允许排序“溢出”到磁盘。该设置对于用户在 `GROUP BY` 之后再使用带 `LIMIT` 的 `ORDER BY` 的情况也很有帮助，尤其是在查询为分布式执行的场景中。

### Joins \{#joins\}

对于 `JOIN`，用户可以选择不同的 `JOIN` 算法，以帮助降低所需内存。默认情况下，`JOIN` 使用哈希连接（hash join），在特性完备性方面最全面，且通常提供最佳性能。该算法会将 `JOIN` 的右表加载到内存中的哈希表中，然后再用左表与之进行匹配。为了尽量减少内存占用，用户应将较小的表放在右侧。然而，在受内存限制的场景中，这种方式仍然存在局限性。在这些情况下，可以通过 [`join_algorithm`](/operations/settings/settings#join_algorithm) 设置启用 `partial_merge` 连接。该算法是[排序合并算法](https://en.wikipedia.org/wiki/Sort-merge_join) 的一种变体，首先将右表按块排序，并为这些块创建 min-max 索引。随后，它按连接键对左表的部分数据进行排序，并将其与右表进行连接。min-max 索引用于跳过不需要的右表块。这种方式在降低内存占用的同时，会牺牲一定的性能。进一步来说，`full_sorting_merge` 算法允许在右侧非常大且无法放入内存、也无法进行查找（例如复杂子查询）时执行 `JOIN`。在这种情况下，如果左右两侧都无法放入内存，它们都会在磁盘上进行排序，从而允许对大表进行连接。

<Image img={joins} size="md" alt="Join 算法" />

从 20.3 版本开始，ClickHouse 支持在 `join_algorithm` 设置中使用 `auto` 取值。这会指示 ClickHouse 采用自适应连接策略：优先使用哈希连接算法，直到触及内存限制，此时会改用 `partial_merge` 算法。最后，关于连接，我们建议读者了解分布式连接的行为以及如何最小化其内存消耗。更多信息请参见[此处](/sql-reference/operators/in#distributed-subqueries)。