---
title: "如何将 PostgreSQL 数据导出为 Parquet、CSV 或 JSON？"
date: 2023-03-22
description: "了解如何使用 `clickhouse-local` 将 PostgreSQL 数据导出为 Parquet、CSV 或 JSON 格式，并通过多个示例进行说明。"
tags: ['数据导出', '数据格式']
keywords: ['PostgreSQL', 'Parquet', 'CSV', 'JSON']
---

{frontMatter.description}

{/* 截断 */}

## 如何将 PostgreSQL 数据导出为 Parquet、CSV 或 JSON \{#how-to-export-postgresql-data-to-parquet-csv-or-json\}

使用 `clickhouse-local` 就很简单：

* 使用 [`postgresql` 表函数](https://clickhouse.com/docs/sql-reference/table-functions/postgresql) 读取数据
* 使用 `INTO OUTFILE _filename_ FORMAT` 子句并指定所需的输出格式

输出格式可以是 ClickHouse 中任意受支持的[输出格式](https://clickhouse.com/docs/interfaces/formats)。下面通过几个示例进行说明……

这些示例使用 `clickhouse-local`，它是 ClickHouse 二进制包的一部分。可以通过以下方式下载：

```bash
curl https://clickhouse.com/ | sh
```

## 将 PostgreSQL 导出到 Parquet \{#export-postgresql-to-parquet\}

`postgresql` 表函数允许对存储在远程 PostgreSQL 服务器上的数据执行 `SELECT`（和 `INSERT`）查询。例如，要查看 PostgreSQL 中某个表的全部内容：

```bash
SELECT *
FROM
   postgresql(
    'localhost:5432',
    'postgres_database',
    'postgres_table',
    'user',
    'password'
);
```

我们可以使用 `INTO OUTFILE` 将此查询的输出写入文件。使用 `FORMAT` 指定要创建的文件格式。下面我们导出整个 PostgreSQL 表的内容，并将其写入一个 Parquet 文件：

```bash
./clickhouse local -q "SELECT * FROM
   postgresql(
    'localhost:5432',
    'postgres_database',
    'postgres_table',
    'user',
    'password'
)
INTO OUTFILE 'my_output_file.parquet'"
```

:::note
由于输出文件名以 `.parquet` 作为扩展名，ClickHouse 会认为我们要使用 Parquet 格式，因此你会注意到我们省略了 `FORMAT Parquet` 子句。
:::

## 将 PostgreSQL 导出为 CSV \{#export-postgresql-to-csv\}

这与导出为 Parquet 的操作相同，只是我们为输出指定了一个更合适的文件名：

```bash
./clickhouse local -q "SELECT * FROM
   postgresql(
    'localhost:5432',
    'postgres_database',
    'postgres_table',
    'user',
    'password'
)
INTO OUTFILE 'my_output_file.csv'"
```

就是这样！ClickHouse 会根据输出文件名中的 `.csv` 扩展名，将数据以逗号分隔的格式输出。其余部分与上面的命令完全相同。

## 将 PostgreSQL 导出为 JSON \{#export-postgresql-to-json\}

要从 PostgreSQL 导出到 JSON，我们只需要更改文件名，ClickHouse 会自动识别格式：

```bash
./clickhouse local -q "SELECT * FROM
   postgresql(
    'localhost:5432',
    'postgres_database',
    'postgres_table',
    'user',
    'password'
)
INTO OUTFILE 'my_output_file.ndjson'"
```

:::note
你不必就此止步 —— 你可以使用 `clickhouse-local` 从 PostgreSQL 拉取数据，并将其发送到[各种输出格式](https://clickhouse.com/docs/sql-reference/formats/)。

如果 ClickHouse 无法通过文件扩展名确定输出类型，或者你想要显式指定某种格式，可以添加 `FOMRAT` 子句：

```sql
```bash
./clickhouse local -q "SELECT * FROM
   postgresql(
    'localhost:5432',
    'postgres_database',
    'postgres_table',
    'user',
    'password'
)
INTO OUTFILE 'my_output_file.ndjson'
FORMAT JSONEachRow"
```

:::

## 将 PostgreSQL 数据流式传输到另一个进程 \{#stream-postgresql-to-another-process\}

你可以不使用 `INTO OUTFILE`，而是将表函数的结果流式传输到另一个进程。下面是一个简单示例来演示语法——我们使用 Linux 的 `wc -l` 命令来统计行数：

```bash
./clickhouse local -q "SELECT *
FROM s3('https://datasets-documentation.s3.eu-west-3.amazonaws.com/house_parquet/house_0.parquet'
FORMAT JSONEachRow
)" | wc -l
```

不过，我们可以很容易地将这些行数据流式传输到 shell 脚本、Python 脚本或任何你需要的其他进程中。
