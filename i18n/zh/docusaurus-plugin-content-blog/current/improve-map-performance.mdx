---
title: 在 ClickHouse 中提升 Map 查找性能
description: 了解如何通过将特定键物化为单独的列来优化 ClickHouse 中 Map 列的查找，从而提升查询性能。
date: 2022-10-30
tags: ['性能与优化']
keywords: ['Map 性能']
---

{frontMatter.description}

{/* 截断 */}


## 问题

类似 `a['key']` 的 Map 查找具有线性时间复杂度（参见[这里](https://clickhouse.com/docs/sql-reference/data-types/map)），因此可能效率较低。原因是：要从表中根据特定键选择对应的值，需要在 Map 列中跨所有行 (N) 遍历所有键 (~M)，最终产生约 M×N 次查找。

使用 Map 进行查找可能比使用 String 列慢 10 倍。下面的实验还展示了在冷查询场景下约 10 倍的性能下降，以及在处理数据量上的数量级差异（7.21 MB 对比 5.65 GB）。

```sql
-- 创建表,SpanName 为 String 类型,ResourceAttributes 为 Map 类型
DROP TABLE IF EXISTS tbl;
CREATE TABLE tbl (
    `Timestamp` DateTime64(9) CODEC (Delta(8), ZSTD(1)),
    `TraceId` String CODEC (ZSTD(1)),
    `ServiceName` LowCardinality(String) CODEC (ZSTD(1)),
    `Duration` UInt8 CODEC (ZSTD(1)), -- Int64
    `SpanName` LowCardinality(String) CODEC (ZSTD(1)),
    `ResourceAttributes` Map(LowCardinality(String), String) CODEC (ZSTD(1))
)
ENGINE = MergeTree
PARTITION BY toDate(Timestamp)
ORDER BY (ServiceName, SpanName, toUnixTimestamp(Timestamp), TraceId);

-- 创建 UDF 为 ResourceAttributes 生成随机 Map 数据
DROP FUNCTION IF EXISTS genmap;
CREATE FUNCTION genmap AS (n) -> arrayMap (x-> (x::String, (x*rand32())::String), range(1, n));

-- 验证 genmap 是否正常工作
SELECT genmap(10)::Map(String, String);

-- 插入 100 万行数据
INSERT INTO tbl
SELECT
    now() - randUniform(1, 1000000.) as Timestamp,
    randomPrintableASCII(2) as TraceId,
    randomPrintableASCII(2) as ServiceName,
    rand32() as Duration,
    randomPrintableASCII(2) as SpanName,
    genmap(rand64()%500)::Map(String, String) as ResourceAttributes
FROM numbers(1_000_000);

-- 查询 SpanName 速度更快
-- [冷查询] 返回 0 行。耗时:0.642 秒。处理了 100 万行,7.21 MB(156 万行/秒,11.22 MB/秒)
-- [热查询] 返回 0 行。耗时:0.164 秒。处理了 100 万行,7.21 MB(610 万行/秒,43.99 MB/秒)
SELECT
    COUNT(*),
    avg(Duration/1E6) as average,
    quantile(0.95)(Duration/1E6) as p95,
    quantile(0.99)(Duration/1E6) as p99,
    SpanName
FROM tbl
GROUP BY SpanName ORDER BY 1 DESC LIMIT 50 FORMAT Null;

-- 查询 ResourceAttributes 速度较慢
-- [冷查询] 返回 0 行。耗时:6.432 秒。处理了 100 万行,5.65 GB(15.546 万行/秒,879.07 MB/秒)
-- [热查询] 返回 0 行。耗时:5.935 秒。处理了 100 万行,5.65 GB(16.850 万行/秒,952.81 MB/秒)
SELECT
    COUNT(*),
    avg(Duration/1E6) as average,
    quantile(0.95)(Duration/1E6) as p95,
    quantile(0.99)(Duration/1E6) as p99,
    ResourceAttributes['1'] as hostname
FROM tbl
GROUP BY hostname ORDER BY 1 DESC LIMIT 50 FORMAT Null;
```

**解决方案**
为改进该查询，我们可以新增一列，将其默认值设为 `Map` 列中某个特定键对应的值，然后对该列进行物化，以填充现有行的列值。通过这种方式，我们在插入数据时就提取并存储所需的值，从而加速查询时的查找过程。


```sql
-- 解决方案是添加一个列,其值默认为 Map 中的特定键
ALTER TABLE tbl ADD COLUMN hostname LowCardinality(String) DEFAULT ResourceAttributes['1'];
ALTER TABLE tbl MATERIALIZE COLUMN hostname;

-- 查询 hostname(新列)现在更快了
-- [冷查询] 返回 0 行。耗时:2.215 秒。处理了 100 万行,21.67 MB(每秒 45.152 万行,9.78 MB/秒)
-- [热查询] 返回 0 行。耗时:0.541 秒。处理了 100 万行,21.67 MB(每秒 185 万行,40.04 MB/秒)
SELECT
    COUNT(*),
    avg(Duration/1E6) as average,
    quantile(0.95)(Duration/1E6) as p95,
    quantile(0.99)(Duration/1E6) as p99,
    hostname
FROM tbl
GROUP BY hostname ORDER BY 1 DESC LIMIT 50 FORMAT Null;

-- 清除缓存以执行冷查询
SYSTEM DROP FILESYSTEM CACHE;
```
