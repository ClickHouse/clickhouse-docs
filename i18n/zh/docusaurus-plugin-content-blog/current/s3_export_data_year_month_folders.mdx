---
date: 2023-03-24
title: "如何在 S3 上按年和按月进行分区写入？"
description: "了解如何在 ClickHouse 中使用自定义路径结构，将按年和按月分区的数据写入 S3 存储桶，以便更好地组织数据。"
tags: ['数据导出', '原生客户端和接口']
keywords: ['S3', '分区写入']
---

{frontMatter.description}

{/* 截断 */}

## 了解如何在 S3 上按年份和月份进行分区写入 \{#learn-how-to-do-partitioned-writes-by-year-and-month-on-s3\}

我想在 S3 存储桶中导出数据，并使路径符合如下结构：

* 2022
  * 1
  * 2
  * ...
  * 12
* 2021
  * 1
  * 2
  * ...
  * 12

以此类推 ...

## 解答 \{#answer\}

考虑以下 ClickHouse 表：

```sql
CREATE TABLE sample_data (
    `name` String,
    `age` Int,
    `time` DateTime
) ENGINE = MergeTree
ORDER BY
    name
```

添加 10000 条记录：

```sql
INSERT INTO
    sample_data
SELECT
    *
FROM
    generateRandom(
        'name String, age Int, time DateTime',
        10,
        10,
        10
    )
LIMIT
    10000;
```

运行以下命令，以在 S3 存储桶 `my_bucket` 中创建所需的结构（注意，此示例以 Parquet 格式写入文件）：

```sql
INSERT INTO
    FUNCTION s3(
        'https://s3-host:4321/my_bucket/{_partition_id}/file.parquet.gz',
        's3-access-key',
        's3-secret-access-key',
        Parquet,
        'name String, age Int, time DateTime'
    ) PARTITION BY concat(
        formatDateTime(time, '%Y'),
        '/',
        formatDateTime(time, '%m')
    )
SELECT
    name,
    age,
    time
FROM
    sample_data
查询 ID: 55adcf22-f6af-491e-b697-d09694bbcc56

完成。

结果集 0 行。耗时:15.579 秒。已处理 10.00 千行,219.93 KB(641.87 行/秒,14.12 KB/秒)。
```
