---
title: 使用 AWS PrivateLink 将私有 RDS 暴露给 ClickPipes 的设置
description: 通过 AWS PrivateLink 将私有 RDS 暴露给 ClickPipes 的设置步骤。
date: 2024-11-27
tags: ['安全和认证', '云管理']
keywords: ['AWS PrivateLink', 'Private RDS', 'ClickPipes']
---

{frontMatter.description}

{/* 截断 */}

## 使用 AWS PrivateLink 将私有 RDS 暴露给 ClickPipes \{#aws-privatelink-setup-to-expose-private-rds-for-clickpipes\}

通过 AWS PrivateLink 将私有 RDS 暴露给 ClickPipes 的配置步骤，同时支持跨区域访问。

:::info
此方式使用 AWS Endpoint Service，主要适用于跨区域访问。如果需要同区域访问，
建议改为[创建 VPC 资源](/integrations/clickpipes/aws-privatelink#vpc-resource)。
:::

## 私有链接创建 \{#private-link-creation\}

按照以下步骤为你的 RDS 实例创建一个 **VPC endpoint service（VPC 终端节点服务）**。如果你有多个需要终端节点服务的
RDS 实例（或者不同实例使用了不同的监听端口），请重复这些步骤：

1. 查找你的 VPC 并[创建 NLB](https://docs.aws.amazon.com/elasticloadbalancing/latest/network/create-network-load-balancer.html)
   * 进入目标 VPC 并创建一个 Network Load Balancer（NLB）。注意，NLB 必须是内部（私有）的，而不是面向互联网的（公有）。

2. 配置 Target Group

   * Target group 应指向 RDS 实例的 endpoint IP 和端口（PostgreSQL 通常为 5432，MySQL 通常为 3306）。

   :::note

   如果你希望自动化更新 target group 中 RDS endpoint IP 的过程，可以使用 AWS Lambda 函数或其他自动化工具。
   可用于此目的的 Terraform 模块之一是[这个](https://github.com/MaterializeInc/terraform-aws-rds-privatelink)。

   :::

   * **重要**：在使用 DB Cluster/Aurora 时，确保所使用的 RDS 实例 endpoint 仅为 WRITER endpoint，而不是 common endpoint。
   * 确保使用 TCP 协议，以避免在 NLB 上发生 TLS 终止。

3. 设置 Listener 端口
   * 负载均衡器的监听端口必须与 target group 使用的端口一致（PostgreSQL 通常为 5432，MySQL 通常为 3306）。

4. 创建 VPC Endpoint Service
   * 在 VPC 中创建一个指向该 NLB 的 endpoint service。
   * 启用对来自特定账户的连接请求的接受。

5. 授权 ClickPipes 使用该 Endpoint Service
   * 授予 ClickPipes 账户请求此 endpoint service 的权限。
     * 通过添加以下 principal ID 来配置允许的 principal：
       ```
       arn:aws:iam::072088201116:root
       ```

6. 在 NLB 上禁用 “Enforce Security Group Inbound Rules on Private Link Traffic”（如果为 NLB 关联了 security group）
   * 进入 NLB 的设置，如果为 NLB 关联了 security group，则禁用 “Enforce Security Group Inbound Rules on Private Link Traffic” 这个设置。
   * 如果使用 Terraform，将 NLB 的 `enforce_security_group_inbound_rules_on_private_link_traffic` 属性设置为 `off`。
   * 此设置是**必需的**，以便允许来自 ClickPipes VPC 到 NLB 的流量。

7. **可选**：当数据库所在区域与 ClickPipes 区域不同时，启用跨区域（Cross-region）支持
   * 在 VPC 控制台的 `Endpoint Services` 下，选择你的 endpoint service。
   * 点击 `Actions` 按钮并选择 `Modify supported Regions`。
   * 添加你希望允许访问该 endpoint service 的区域，ClickPipes 区域列表可[参考此处](/integrations/clickpipes#list-of-static-ips)。

8. **针对 MySQL 的推荐设置**
   * 如果你使用 MySQL，建议在源数据库中将参数设置为 `skip_name_resolve=1`。
     由于来自 NLB 的频繁健康检查，MySQL 会阻止这些 NLB 主机。设置该参数可以完全避免进行 DNS 主机名查询，因此不会阻止 NLB 主机。如果使用 RDS，这将需要重启实例。

## 启动连接 \{#initiating-connection\}

完成上述步骤后，你可以按照指南[启动连接](/integrations/clickpipes/aws-privatelink#creating-clickpipe)。

当控制台中的状态显示为 `Ready` 时，你可以继续下一节来创建 ClickPipe。

## 创建 ClickPipes \{#creating-clickpipes\}

使用你在上一步中获取的 DNS 名称来[创建 ClickPipe](/integrations/clickpipes/postgres)。

## 动态更新 RDS 端点 IP \{#dynamically-updating-the-rds-endpoint-ip\}

当 RDS 端点 IP 发生变化时（例如重启、故障转移或更新），需要将 NLB 目标组更新为新的 IP。可以使用 AWS Lambda 函数或其他自动化工具来自动完成此过程。