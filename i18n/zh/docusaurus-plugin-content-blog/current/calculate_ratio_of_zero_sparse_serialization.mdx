---
title: 如何计算表中每列的空值/零值比例
description: 了解如何计算 ClickHouse 表中每列的空值或零值比例，以优化稀疏列的序列化。
date: 2023-05-18
tags: ['性能和优化']
keywords: ['空值/零值比例', '计算']
---

{frontMatter.description}

{/* 截断 */}


## 如何计算表中每一列空值/零值的比例

如果某一列是稀疏的（为空或大部分为零），ClickHouse 可以将其编码为稀疏格式，并自动优化计算——在查询时数据无需完全解压缩。事实上，如果你知道某一列的稀疏程度，就可以通过 [`ratio_of_defaults_for_sparse_serialization` 设置项](https://clickhouse.com/docs/operations/settings/merge-tree-settings#ratio_of_defaults_for_sparse_serialization) 来定义其比例，以优化序列化。

下面这个实用的查询可能会运行一段时间，但它会分析表中的每一行，并确定指定表中每一列中值为零（或默认值）的比例：

```sql
SELECT *
    APPLY x -> (x = defaultValueOfArgumentType(x)) APPLY avg APPLY x -> round(x, 3)
FROM table_name
FORMAT Vertical
```

例如，我们在上文中针对名为 `sensors` 的 [环境传感器数据集](https://clickhouse.com/docs/getting-started/example-datasets/environmental-sensors) 表运行了此查询，该表包含超过 200 亿行和 19 列：

```sql
SELECT *
    APPLY x -> (x = defaultValueOfArgumentType(x)) APPLY avg APPLY x -> round(x, 3)
FROM sensors
FORMAT Vertical
```

响应如下：

```response

Row 1:
──────
round(avg(equals(sensor_id, defaultValueOfArgumentType(sensor_id))), 3):                 0
round(avg(equals(sensor_type, defaultValueOfArgumentType(sensor_type))), 3):             0.159
round(avg(equals(location, defaultValueOfArgumentType(location))), 3):                   0
round(avg(equals(lat, defaultValueOfArgumentType(lat))), 3):                             0.001
round(avg(equals(lon, defaultValueOfArgumentType(lon))), 3):                             0.001
round(avg(equals(timestamp, defaultValueOfArgumentType(timestamp))), 3):                 0
round(avg(equals(P1, defaultValueOfArgumentType(P1))), 3):                               0.474
round(avg(equals(P2, defaultValueOfArgumentType(P2))), 3):                               0.475
round(avg(equals(P0, defaultValueOfArgumentType(P0))), 3):                               0.995
round(avg(equals(durP1, defaultValueOfArgumentType(durP1))), 3):                         0.999
round(avg(equals(ratioP1, defaultValueOfArgumentType(ratioP1))), 3):                     0.999
round(avg(equals(durP2, defaultValueOfArgumentType(durP2))), 3):                         1
round(avg(equals(ratioP2, defaultValueOfArgumentType(ratioP2))), 3):                     1
round(avg(equals(pressure, defaultValueOfArgumentType(pressure))), 3):                   0.83
round(avg(equals(altitude, defaultValueOfArgumentType(altitude))), 3):                   1
round(avg(equals(pressure_sealevel, defaultValueOfArgumentType(pressure_sealevel))), 3): 1
round(avg(equals(temperature, defaultValueOfArgumentType(temperature))), 3):             0.532
round(avg(equals(humidity, defaultValueOfArgumentType(humidity))), 3):                   0.544

返回 1 行。用时:992.041 秒。已处理 206.9 亿行,1.39 TB(每秒 2086 万行,每秒 1.40 GB)
```

从上述结果可以看出：

* `sensor_id` 列一点也不稀疏。事实上，每一行都有一个非零值
* `sensor_type` 只有大约 15.9% 的情况是稀疏的
* `P0` 列非常稀疏：99.9% 的值为 0
* `pressure` 列相当稀疏，达到 83%
* 而 `temperature` 列有 53.2% 的值缺失或为 0

就像我们说的，这是一条非常方便的查询语句，用来计算 ClickHouse 表中各列的稀疏程度！
