---
title: 使用 Cloud API 的 Terraform 示例
description: "本文示例演示如何使用 Terraform 通过 API 创建和删除集群"
Date: 2023-09-02
tags: ['原生客户端和接口']
keywords: ['Terraform']
---

{frontMatter.description}

{/* 截断 */}

## 问题 \{#question\}

如何通过 API 在 ClickHouse Cloud 上管理集群？

## 解答 \{#answer\}

我们将使用 Terraform 来配置基础设施，并使用 [ClickHouse Provider](https://registry.terraform.io/providers/ClickHouse/clickhouse/latest/docs)。

步骤：

1). 在 ClickHouse Cloud 上创建一个 API Key。\
参考文档： [https://clickhouse.com/docs/cloud/manage/openapi](https://clickhouse.com/docs/cloud/manage/openapi)

将凭据保存在本地。

2). 安装 Terraform： [https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli](https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli)

如果你使用的是 Mac，可以使用 Homebrew 包管理器进行安装。

3). 在任意你希望的位置创建一个目录：

```
mkdir test
➜  test pwd
/Users/jaijhala/Desktop/terraform/test
```

4). 创建两个文件：`main.tf` 和 `secret.tfvars`

复制以下内容：

`main.tf` 文件内容如下：

```
terraform {
 required_providers {
   clickhouse = {
     source = "ClickHouse/clickhouse"
     version = "0.0.2"
   }
 }
}

variable "organization_id" {
  type = string
}

variable "token_key" {
  type = string
}

variable "token_secret" {
  type = string
}

provider clickhouse {
  environment 	= "production"
  organization_id = var.organization_id
  token_key   	= var.token_key
  token_secret	= var.token_secret
}


variable "service_password" {
  type = string
  sensitive   = true
}

resource "clickhouse_service" "service123" {
  name       	= "jai-terraform"
  cloud_provider = "aws"
  region     	= "us-east-2"
  tier       	= "development"
  idle_scaling   = true
  password  = var.service_password
  ip_access = [
	{
    	source  	= "0.0.0.0/0"
    	description = "Anywhere"
	}
  ]
}

output "CLICKHOUSE_HOST" {
  value = clickhouse_service.service123.endpoints.0.host
}
```

你可以在上面的 resources 部分替换你自己的参数，例如服务名、区域等。

`secret.tfvars` 是你存放之前下载的所有 API 密钥相关信息的文件。这个文件的设计目的是将你所有的敏感凭证与主配置文件隔离并隐藏起来。

它的内容大致如下（请将这些参数替换为你自己的值）：

```
organization_id = "e957a5f7-4qe3-4b05-ad5a-d02b2dcd0593"
token_key = "QWhhkMeytqQruTeKg"
token_secret = "4b1dNmjWdLUno9lXxmKvSUcPP62jvn7irkuZPbY"
service_password = "password123!"
```

5).  在该目录下运行 `terraform init`

预期输出：

```
正在初始化后端...

正在初始化 provider 插件...
- 正在查找匹配 "0.0.2" 的 ClickHouse/ClickHouse 版本...
- 正在安装 ClickHouse/ClickHouse v0.0.2...
- 已安装 ClickHouse/ClickHouse v0.0.2(自签名,密钥 ID D7089EE5C6A92ED1)

合作伙伴和社区 provider 由其开发者签名。
如需了解有关 provider 签名的更多信息,请访问:
https://www.terraform.io/docs/cli/plugins/signing.html

Terraform 已创建锁定文件 .terraform.lock.hcl 以记录上述 provider 选择。请将此文件包含在版本控制仓库中,以便 Terraform 在将来运行 "terraform init" 时能够保证默认使用相同的选择。

Terraform 已成功初始化!

现在可以开始使用 Terraform。尝试运行 "terraform plan" 以查看基础设施所需的任何更改。所有 Terraform 命令现在都应该可以正常工作。

如果您设置或更改了 Terraform 的模块或后端配置,请重新运行此命令以重新初始化工作目录。如果您忘记执行此操作,其他命令将检测到并在必要时提醒您。
```

6). 运行 `terraform apply -var-file=secret.tfvars` 命令。

类似下面这样：

```
➜  test terraform apply -var-file=secret.tfvars

Terraform 使用所选提供商生成以下执行计划。资源操作使用以下符号表示:
  + create

Terraform 将执行以下操作:

  # clickhouse_service.service123 将被创建
  + resource "clickhouse_service" "service123" {
      + cloud_provider = "aws"
      + endpoints      = (应用后已知)
      + id             = (应用后已知)
      + idle_scaling   = true
      + ip_access      = [
          + {
              + description = "Anywhere"
              + source      = "0.0.0.0/0"
            },
        ]
      + last_updated   = (应用后已知)
      + name           = "jai-terraform"
      + password       = (敏感值)
      + region         = "us-east-2"
      + tier           = "development"
    }

计划: 新增 1 个,变更 0 个,销毁 0 个。

输出变更:
  + CLICKHOUSE_HOST = (应用后已知)

是否要执行这些操作?
  Terraform 将执行上述操作。
  只有输入 'yes' 才会被接受以批准。

  输入值: yes
```

输入 `yes` 然后按回车键

顺带一提：注意上面显示的是 `password       = (sensitive value)`。
这是因为我们在 main.tf 文件中为密码设置了 `sensitive   = true`。

7). 创建该服务需要几分钟时间，但最终你应该会看到类似下面的结果：

```
  Enter a value: yes

clickhouse_service.service123: 正在创建...
clickhouse_service.service123: 仍在创建... [10s elapsed]
clickhouse_service.service123: 仍在创建... [20s elapsed]
clickhouse_service.service123: 仍在创建... [30s elapsed]
clickhouse_service.service123: 仍在创建... [40s elapsed]
clickhouse_service.service123: 仍在创建... [50s elapsed]
clickhouse_service.service123: 仍在创建... [1m0s elapsed]
clickhouse_service.service123: 仍在创建... [1m10s elapsed]
clickhouse_service.service123: 仍在创建... [1m20s elapsed]
clickhouse_service.service123: 仍在创建... [1m30s elapsed]
clickhouse_service.service123: 仍在创建... [1m40s elapsed]
clickhouse_service.service123: 创建完成,耗时 1 分 41 秒 [id=aa8d8d63-1878-4600-8470-630715af38ed]

应用完成!资源:已添加 1 个,已更改 0 个,已销毁 0 个。

输出:

CLICKHOUSE_HOST = "h3ljlaqez6.us-east-2.aws.clickhouse.cloud"
➜  test
```

8). 在 Cloud 控制台中检查，你应该能看到已创建的服务。

9). 要再次清理/销毁该服务，运行 `terraform destroy -var-file=secret.tfvars` 即可。

类似如下：

```
Terraform 使用所选提供商生成以下执行计划。资源操作使用以下符号表示:
  - destroy

Terraform 将执行以下操作:

  # clickhouse_service.service123 将被销毁
  - resource "clickhouse_service" "service123" {
      - cloud_provider = "aws" -> null
      - ............

计划:新增 0 个,变更 0 个,销毁 1 个。

输出变更:
  - CLICKHOUSE_HOST = "h3ljlaqez6.us-east-2.aws.clickhouse.cloud" -> null

确定要销毁所有资源吗?
  Terraform 将销毁您的所有托管基础设施,如上所示。
  此操作不可撤销。只有输入 'yes' 才能确认。

  输入值:
```

键入 yes，然后按回车键

10）。

```
clickhouse_service.service123: 正在销毁... [id=aa8d8d63-1878-4600-8470-630715af38ed]
clickhouse_service.service123: 仍在销毁中... [id=aa8d8d63-1878-4600-8470-630715af38ed, 已用时 10 秒]
clickhouse_service.service123: 仍在销毁中... [id=aa8d8d63-1878-4600-8470-630715af38ed, 已用时 20 秒]
clickhouse_service.service123: 销毁完成,用时 27 秒

销毁完成!资源:已销毁 1 个。
```

现在它也应该已经从 Cloud Console 中移除。

关于 Cloud API 的更多详情，请参见： [https://clickhouse.com/docs/cloud/manage/api/api-overview](https://clickhouse.com/docs/cloud/manage/api/api-overview)
