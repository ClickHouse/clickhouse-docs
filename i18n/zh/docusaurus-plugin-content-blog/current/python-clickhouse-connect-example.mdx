---
date: 2023-05-08
title: "Python 客户端连接 ClickHouse Cloud Service 的示例"
description: "通过使用 clickhouse-connect 驱动的分步示例，了解如何使用 Python 连接到 ClickHouse Cloud Service。"
tags: ['语言客户端']
keywords: ['Python', 'ClickHouse Cloud']
---

{frontMatter.description}

{/* truncate */}

这是一个分步骤示例，演示如何开始在 ClickHouse Cloud 服务中使用 Python。

:::note
请注意，Python 版本和库依赖在不断演进。请确保在尝试本示例时，驱动程序和 Python 运行环境都使用各自最新受支持的版本。

在撰写本文时，我们使用的是 [clickhouse-connect](https://github.com/ClickHouse/clickhouse-connect) 驱动版本 `0.5.23`，以及 Python `3.11.2`。
:::


## 步骤

1. 检查 Python 版本：

```
$  python -V
Python 3.11.2
```

2. 我们将在名为 `ch-python` 的文件夹中创建该项目：

```
$ mkdir ch-python
$ cd ch-python
```

3. 创建一个名为 `requirements.txt` 的依赖文件，内容如下：

```
clickhouse-connect==0.5.23
```

4. 创建一个名为 `main.py` 的 Python 源文件：

```py
import clickhouse_connect
import sys
import json

CLICKHOUSE_CLOUD_HOSTNAME = 'HOSTNAME.clickhouse.cloud'
CLICKHOUSE_CLOUD_USER = 'default'
CLICKHOUSE_CLOUD_PASSWORD = 'YOUR_SECRET_PASSWORD'

client = clickhouse_connect.get_client(
    host=CLICKHOUSE_CLOUD_HOSTNAME, port=8443, username=CLICKHOUSE_CLOUD_USER, password=CLICKHOUSE_CLOUD_PASSWORD)

print("已连接到 " + CLICKHOUSE_CLOUD_HOSTNAME + "\n")
client.command(
    'CREATE TABLE IF NOT EXISTS new_table (key UInt32, value String, metric Float64) ENGINE MergeTree ORDER BY key')

print("表 new_table 已创建或已存在！\n")

row1 = [1000, '字符串值 1000', 5.233]
row2 = [2000, '字符串值 2000', -107.04]
data = [row1, row2]
client.insert('new_table', data, column_names=['key', 'value', 'metric'])

print("已向表 new_table 写入 2 行\n")

QUERY = "SELECT max(key), avg(metric) FROM new_table"

result = client.query(QUERY)

sys.stdout.write("查询：["+QUERY + "] 返回：\n\n")
print(result.result_rows)
```

5. 创建虚拟环境：

```
chpython$ python -m venv venv
```

6. 激活虚拟环境：

```
chpython$ source venv/bin/activate
```

加载完成后，你的终端提示符前应出现 (venv)，然后安装依赖：

```
(venv) ➜  chpython$ pip install -r requirements.txt
Collecting certifi
  Using cached certifi-2023.5.7-py3-none-any.whl (156 kB)
Collecting urllib3>=1.26
  Using cached urllib3-2.0.2-py3-none-any.whl (123 kB)
Collecting pytz
  Using cached pytz-2023.3-py2.py3-none-any.whl (502 kB)
Collecting zstandard
  Using cached zstandard-0.21.0-cp311-cp311-macosx_11_0_arm64.whl (364 kB)
Collecting lz4
  Using cached lz4-4.3.2-cp311-cp311-macosx_11_0_arm64.whl (212 kB)
Installing collected packages: pytz, zstandard, urllib3, lz4, certifi, clickhouse-connect
Successfully installed certifi-2023.5.7 clickhouse-connect-0.5.23 lz4-4.3.2 pytz-2023.3 urllib3-2.0.2 zstandard-0.21.0
```

7. 运行代码！

```
(venv) chpython$ venv/bin/python main.py

connected to HOSTNAME.clickhouse.cloud

table new_table created or exists already!

written 2 rows to table new_table

query: [SELECT max(key), avg(metric) FROM new_table] returns:

[(2000, -50.9035)]
```

:::tip
如果使用的是较旧版本的 Python（例如 `3.9.6`），可能会遇到与 `urllib3` 库相关的 `ImportError`。
在这种情况下，可以将 Python 环境升级到较新的版本，或者在 requirements.txt 文件中将 `urllib3` 的版本固定为 `1.26.15`。
:::
