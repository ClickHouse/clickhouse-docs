---
title: 如何使用 SSH 密钥连接 ClickHouse
description: "如何使用 SSH 密钥连接 ClickHouse 和 ClickHouse Cloud"
date: 2024-07-25
tags: ['云管理', '安全与身份验证']
keywords: ['云', 'SSH']
---

{frontMatter.description}

{/* 截断 */}


## 问题 \{#question\}

如何使用 SSH 密钥认证连接到 ClickHouse？

:::note
这里我们以 ClickHouse Cloud 为示例，但该示例在开源版 ClickHouse 上同样适用。
:::

<iframe width="100%" height="315" src="https://www.youtube.com/embed/Rhe-kUyrFUE?si=JgcAusW1TcEyRqPr" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

## 答案

1. 使用 ssh-keygen 创建密钥对。例如：

```
➜  new ssh-keygen \
-t ed25519 \
> -f /Users/testuser/.ssh/ch_key
正在生成 ed25519 公钥/私钥对。
输入密码短语(留空表示不设置密码短语):
再次输入相同的密码短语:
您的私钥已保存在 /Users/testuser/.ssh/ch_key
您的公钥已保存在 /Users/testuser/.ssh/ch_key.pub
.....
```

2. 使用公钥（上述示例中的 ch&#95;key.pub）创建用户。

```sql
clickhouse-cloud :) CREATE USER abcuser IDENTIFIED WITH ssh_key BY KEY 'AAAABBBcdE1lZDI1NTE5AAAAIISdl4CrGM8mckXBUXLjL3ef9XwnycDWEvBPu3toB40m' TYPE 'ssh-ed25519';

CREATE USER abcuser IDENTIFIED WITH ssh_key BY KEY AAAABBBcdE1lZDI1NTE5AAAAIISdl4CrGM8mckXBUXLjL3ef9XwnycDWEvBPu3toB40m TYPE `ssh-ed25519`

Query id: 34c6aad6-5f88-4c80-af7a-7d37c91ba7d5

Ok.
```

3. 运行 `SHOW users` 以确认用户已创建。

4. 将 default&#95;role 授予该用户（可选）。

```sql
clickhouse-cloud :) grant default_role to abcuser;

GRANT default_role TO abcuser

Query id: 4a054003-220a-4dea-8e8d-eb1f08ee7b10

Ok.

0 rows in set. Elapsed: 0.137 sec.
```

5. 现在使用私钥对该服务进行身份验证。

```sql
➜  new ./clickhouse client --host myhost.us-central1.gcp.clickhouse.cloud --secure --user abcuser --ssh-key-file '/Users/testuser/.ssh/ch_key'
ClickHouse 客户端版本 23.12.1.863（官方构建版本）。
请输入私钥密码（无密码请留空）：
正在以用户 abcuser 身份连接到 myhost.us-central1.gcp.clickhouse.cloud:9440。
已连接到 ClickHouse 服务器，版本 23.9.2。

clickhouse-cloud :) select currentUser();

SELECT currentUser()

Query id: d4b6bb60-ef45-47d3-8740-db9f2941dcd2

┌─currentUser()─┐
│ abcuser       │
└───────────────┘

返回 1 行。用时：0.001 秒。

clickhouse-cloud :)
```
