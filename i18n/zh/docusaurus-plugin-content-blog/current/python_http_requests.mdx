---
title: 使用 HTTP requests 模块的 Python 快速示例
description: "使用 Python 和 requests 模块向 ClickHouse 写入和读取数据的示例"
date: 2022-07-10
tags: ['原生客户端与接口']
keywords: ['Python']
---

{frontMatter.description}

{/* 截断 */}


## 问题 \{#question\}

我能否直接使用 _requests_ 模块向 ClickHouse 服务器发送 HTTP 请求？

## 回答

是的，示例代码如下。

```py
import requests
import datetime

create_replace_stmt = 'CREATE OR REPLACE TABLE test_table (name String, age UInt8) Engine=MergeTree ORDER BY tuple();'
select_query = 'SELECT count() FROM test_table'
insert_query = 'INSERT INTO test_table SELECT * FROM  generateRandom(\'name String, age UInt8\',1,1) LIMIT 300000000'

CH_URL = 'https://your_clickhouse_service_fqdn:8443'
CH_USER = 'default'
CH_PASSWORD = 'secret_pwd'

headers = {}
headers["X-ClickHouse-User"] = CH_USER
headers["X-ClickHouse-Key"] = CH_PASSWORD

now = (datetime.datetime.now())
print("{} - 开始执行...".format(now))


# 创建/替换表
now = (datetime.datetime.now())
print("{} - 正在创建/替换表...".format(now))
response = requests.post(url=CH_URL,
                         params={"database": "default",
                                 "query": create_replace_stmt,
                                 "session_id": "my-session-id-string"
                                 },
                         headers=headers)

# 执行计数查询
response = requests.post(url=CH_URL,
                         params={"database": "default",
                                 "query": select_query,
                                 "session_id": "my-session-id-string"
                                 },
                         headers=headers)

now = (datetime.datetime.now())
print("{} - 插入前 test_table 中的记录数: {}".format(
    now, response.content.decode('utf-8')))


# 插入数据
now = (datetime.datetime.now())
print("{} - 正在插入数据...".format(now))
response = requests.post(url=CH_URL,
                         params={"database": "default",
                                 "query": insert_query,
                                 "session_id": "my-session-id-string",
                                 "wait_end_of_query": 1
                                 },
                         headers=headers)

now = (datetime.datetime.now())
print("{} - 数据插入完成...".format(now))

response = requests.post(url=CH_URL,
                         params={"database": "default",
                                 "query": select_query,
                                 "session_id": "my-session-id-string",
                                 },
                         headers=headers)

now = (datetime.datetime.now())
print("{} - 插入后 test_table 中的记录数: {}".format(
    now, response.content.decode('utf-8')))
```

预期示例输出：

```
(venv) ➜  venv/bin/python main.py
2023-07-07 14:54:27.336450 - 开始...
2023-07-07 14:54:27.336476 - 正在创建/替换表...
2023-07-07 14:54:28.125270 - 插入前 test_table 中的记录数: 0

2023-07-07 14:54:28.125352 - 正在插入数据...
2023-07-07 14:55:23.788466 - 数据插入完成...
2023-07-07 14:55:23.962134 - 插入后 test_table 中的记录数: 299115357
```

requirements.txt

```
requests==2.31.0
```

请参阅这篇[知识库文章](https://clickhouse.com/docs/knowledgebase/python-clickhouse-connect-example#steps)，了解如何设置 Python 虚拟环境（venv）的具体步骤。
