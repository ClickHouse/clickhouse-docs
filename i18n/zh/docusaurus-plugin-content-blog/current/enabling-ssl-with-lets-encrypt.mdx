---
title: 如何在单个 ClickHouse 服务器上使用 Let's Encrypt 启用 SSL
description: 了解如何使用 Let's Encrypt 为单个 ClickHouse 服务器启用 SSL，包括证书签发、配置和验证。
date: 2024-12-11
tags: ['安全与认证']
keywords: ['SSL', 'Let/`s Encrypt']
---

import Image from "@theme/IdealImage";
import security_group from "@site/static/images/knowledgebase/lets-encrypt-ssl/port_80_security_group.png";

{frontMatter.description}

{/* 截断 */}


## 操作步骤

以下步骤可用于为单个 ClickHouse Server 启用 SSL，这里使用 [Let&#39;s Encrypt](https://letsencrypt.org/)，这是一个免费、自动化且开放的证书颁发机构（CA），旨在让任何人都能轻松使用 HTTPS 保护其网站。通过自动化证书签发和续期流程，Let&#39;s Encrypt 可确保网站在无需人工干预的情况下保持安全。

:::note
在本指南中，我们假定 ClickHouse 已安装在标准的软件包安装路径中。示例中使用的域名为 `product-test-server.clickhouse-dev.com`。请根据实际情况替换为您自己的域名。
:::

1. 确认您已配置一个指向服务器的 DNS `A` 或 `AAAA` 记录。您可以使用 Linux 工具 `dig` 来完成此操作。例如，若使用 Cloudflare DNS 服务器 `1.1.1.1`，对 `product-test-server.clickhouse-dev.com` 的响应可能类似如下：

<br />

```bash
dig @1.1.1.1 product-test-server.clickhouse-dev.com

; <<>> DiG 9.18.28-0ubuntu0.22.04.1-Ubuntu <<>> @1.1.1.1 product-test-server.clickhouse-dev.com
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 22315
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
;; QUESTION SECTION:
;product-test-server.clickhouse-dev.com.    IN A

;; ANSWER SECTION:
product-test-server.clickhouse-dev.com. 300 IN A 34.248.59.9

;; Query time: 52 msec
;; SERVER: 1.1.1.1#53(1.1.1.1) (UDP)
;; WHEN: Thu Dec 12 09:37:33 UTC 2024
;; MSG SIZE  rcvd: 83
```

请留意下方用于确认 A 记录是否存在的部分。

```bash
;; 应答段:
product-test-server.clickhouse-dev.com. 300 IN A 34.248.59.9
```

2. 在你的服务器上开放端口 80。该端口将被使用 ACME 协议的 `certbot` 用于自动证书续期。对于 AWS，可以通过[修改实例关联的 Security Group](https://repost.aws/knowledge-center/connect-http-https-ec2) 来实现。

<br />

<Image img={security_group} size="md" alt="显示开放端口 80 的 AWS Security Group 配置" border />

3. 安装 [`certbot`](https://certbot.eff.org/instructions)，例如使用 `apt`。

<br />

```bash
sudo apt install certbot
```

4. 获取 SSL 证书

<br />


```bash
sudo certbot certonly
正在将调试日志保存到 /var/log/letsencrypt/letsencrypt.log

您希望如何向 ACME CA 进行身份验证?
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
1: 启动临时 Web 服务器(standalone)
2: 将文件放置在 webroot 目录中(webroot)
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
选择相应的数字 [1-2] 然后按 [enter](按 'c' 取消): 1
请输入您希望在证书中包含的域名(用逗号和/或
空格分隔)(输入 'c' 取消): product-test-server.clickhouse-dev.com
正在为 product-test-server.clickhouse-dev.com 请求证书

已成功获取证书。
证书保存位置: /etc/letsencrypt/live/product-test-server.clickhouse-dev.com/fullchain.pem
密钥保存位置:         /etc/letsencrypt/live/product-test-server.clickhouse-dev.com/privkey.pem
此证书将于 2025-03-12 过期。
证书续订时将自动更新这些文件。
Certbot 已设置计划任务,将在后台自动续订此证书。

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
如果您喜欢 Certbot,请考虑通过以下方式支持我们的工作:
 * 向 ISRG / Let's Encrypt 捐赠:   https://letsencrypt.org/donate
 * 向 EFF 捐赠:                    https://eff.org/donate-le
```

:::note
我们的服务器上没有运行 Web 服务器，因此请选择选项 (1)，允许 Certbot 使用独立的临时 Web 服务器。
:::

在提示时输入你服务器的完整域名，例如 `product-test-server.clickhouse-dev.com`。

:::note
Let&#39;s Encrypt 有一项策略，规定不会为某些类型的域名签发证书，例如由公共云服务提供商生成的域名（如 AWS 的 `*.compute.amazonaws.com` 域名）。这些域名被视为共享基础设施，出于安全和防止滥用的原因会被屏蔽。
:::

5. 将证书复制到 ClickHouse 目录。

<br />

```bash
echo '* * * * * root cp -u /etc/letsencrypt/live/product-test-server.clickhouse-dev.com/*.pem /etc/clickhouse-server/ && chown clickhouse:clickhouse /etc/clickhouse-server/*.pem && chmod 400 /etc/clickhouse-server/*.pem' | sudo tee /etc/cron.d/copy-certificates
```

此命令会设置一个 cron 任务，用于自动管理 ClickHouse 服务器的 Let&#39;s Encrypt SSL 证书。它以 root 用户身份每分钟运行一次，将 .pem 文件从 Let&#39;s Encrypt 目录复制到 ClickHouse 服务器的配置目录，但仅在这些文件已更新时才会复制。复制完成后，脚本会将文件的所有权设置为 clickhouse 用户和用户组，确保服务器具有所需的访问权限。它还会为复制后的文件设置安全的只读权限（`chmod 400`），以保持严格的文件安全性。这样可以确保 ClickHouse 服务器始终能够访问最新的 SSL 证书，而无需人工干预，从而保持安全性并将运维开销降到最低。

6. 在 clickhouse-server 中配置使用这些证书。

<br />

```bash
echo "https_port: 8443
tcp_port_secure: 9440
openSSL:
 server:
 certificateFile: '/etc/clickhouse-server/fullchain.pem'
 privateKeyFile: '/etc/clickhouse-server/privkey.pem'
 disableProtocols: 'sslv2,sslv3,tlsv1,tlsv1_1'" | sudo tee /etc/clickhouse-server/config.d/ssl.yaml
```

7. 重启 ClickHouse 服务器

<br />

```bash
sudo clickhouse restart
```

8. 验证 ClickHouse 是否能够通过 SSL 进行通信

<br />

```bash
curl https://product-test-server.clickhouse-dev.com:8443/

好的。
```

要使最后这一步正常生效，你可能需要确保 8443 端口是可访问的，例如在 AWS 的安全组（Security Group）中放行该端口。或者，如果你只需要在该服务器上访问 ClickHouse，可以修改你的 hosts 文件，即：

```bash
echo "127.0.0.1 product-test-server.clickhouse-dev.com" | sudo tee -a /etc/hosts
```

:::warning
如果要允许来自通配符地址的连接，请确保至少采取以下措施之一：


* 服务器受防火墙保护，且无法从不受信任的网络访问；
* 将所有用户限制在特定的网络地址子集内（参见 users.xml）；
* 所有用户都使用强密码，仅开放安全（TLS）接口，或者只允许通过 TLS 接口建立连接；
* 无密码用户仅具有只读访问权限。

另见： [https://www.shodan.io/search?query=clickhouse](https://www.shodan.io/search?query=clickhouse)

博客 [Building single page applications with ClickHouse](https://clickhouse.com/blog/building-single-page-applications-with-clickhouse-and-http) 可作为保护公网暴露实例的参考指南。
:::

如果从运行 ClickHouse 的本机进行连接，下面的方法同样适用。要通过 `product-test-server.clickhouse-dev.com` 进行连接，请在你的防火墙中开放 9440 端口：

```bash
clickhouse client --secure --user default --password <密码>
```
