---
title: 解决 ClickHouse 中 “Cannot Append Data in Parquet Format” 错误
description: 你是否在 ClickHouse 中遇到 “Cannot append data in format Parquet to file” 错误？本文将介绍如何解决这个问题。
date: 2023-03-25
tags: ['错误和异常', '数据格式']
keywords: ['Parquet', 'Cannot Append Data']
---

{frontMatter.description}

{/* 截断 */}

## 在 ClickHouse 中解决 &quot;Cannot Append Data in Parquet Format&quot; 错误 \{#resolving-cannot-append-data-in-parquet-format-error-in-clickhouse\}

是否在 ClickHouse 中遇到过 &quot;Cannot append data in format Parquet to file&quot; 这一错误？

通常该错误会报告为：

`DB::Exception: Cannot append data in format Parquet to file, because this format doesn't support appends. (CANNOT_APPEND_TO_FILE)`

假设你创建了一个基于 `File` 表引擎且使用 Parquet 格式的表。

```sql
CREATE TABLE parquet_test
(
    `x` UInt32,
    `y` String
)
ENGINE = File(Parquet)
```

你可以向该表写入一次：

```sql
INSERT INTO parquet_test VALUES
   (1, 'Hello'),
   (2, 'Hi')
```

这将在 `data/default/parquet_test` 文件夹中创建一个名为 `data.Parquet` 的文件。如果你尝试再插入新的一批数据：

```sql
INSERT INTO parquet_test VALUES
   (3, 'World'),
   (4, 'Bye')
```

……你将会看到如下错误：

```response
代码:641. DB::Exception:从 localhost:9000 接收。DB::Exception:无法以 Parquet 格式向文件追加数据,因为该格式不支持追加操作。可以通过启用 engine_file_allow_create_multiple_files 设置,允许每次插入时创建新文件。(CANNOT_APPEND_TO_FILE)
```

在 ClickHouse 中无法向 Parquet 文件追加数据。但你可以通过启用 [`engine_file_allow_create_multiple_files` 设置](https://clickhouse.com/docs/operations/settings/settings#engine_file_allow_create_multiple_files)，让 ClickHouse 在每次执行 `INSERT` 时创建一个新文件。启用后，每次插入都会创建一个新文件，文件名将遵循以下模式：

`data.Parquet` -&gt; `data.1.Parquet` -&gt; `data.2.Parquet` 等等：

我们来试一下。我们会将两个命令放到一个名为 `parquet.sql` 的文件中：

```sql
SET engine_file_allow_create_multiple_files = 1;

INSERT INTO default.parquet_test VALUES  (3, 'World'), (4, 'Bye');
```

使用 `clickhouse-client` 运行：

```bash
./clickhouse client --queries-file parquet.sql
```

现在，你会在 `data/default/parquet_test` 中看到两个文件（以及之后每次插入都会新增的一个新文件）。

:::note
`engine_file_allow_create_multiple_files` 设置也适用于其他不支持追加写入的数据格式，例如 JSON 和 ORC。
:::
