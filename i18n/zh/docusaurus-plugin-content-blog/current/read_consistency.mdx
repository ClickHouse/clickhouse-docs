---
date: 2024-02-14
title: "如何在 ClickHouse 中实现数据读取一致性？"
description: "了解在从 ClickHouse 读取数据时如何确保数据一致性，无论你连接的是同一节点还是随机节点。"
tags: ['性能与优化']
keywords: ['读取一致性']
---

{frontMatter.description}

{/* 截断 */}


## Question \{#question\}

我正在向 ClickHouse Cloud 写入数据，并且在读取数据时，需要保证获取到的是最新且完整的信息。

## 答案 \{#answer\}

### 与同一节点通信 \{#talking-to-the-same-node\}

如果您使用的是 native 协议，或通过同一个会话执行写入和读取操作，那么您将连接到同一副本：在这种情况下，您会直接从执行写入的那个节点进行读取，因此读取结果将始终保持一致。

### 与随机节点通信

如果你无法保证自己总是与同一个节点通信（例如，通过会被负载均衡器分发到不同节点的 HTTPS 调用与节点通信），你可以选择：

A)

1. 写入数据
2. 连接到一个新的副本
3. 运行 `SYSTEM SYNC REPLICA db.table_name LIGHTWEIGHT`
4. 读取最新数据

参见 `SYSTEM` 命令[参考文档](https://clickhouse.com/docs/sql-reference/statements/system#sync-replica)

或者

B) 在任意时间读取，同时保证顺序一致性

```sql
SELECT 
...
SETTINGS select_sequential_consistency = 1
```

请注意，当使用 ClickHouse Cloud 及其默认的 [SharedMergeTree](https://clickhouse.com/docs/cloud/reference/shared-merge-tree) 表引擎时，无需使用 `insert_quorum_parallel`——对 SharedMergeTree 的所有插入本身就是仲裁式插入（按设计如此）。

使用 [`SYSTEM SYNC REPLICAS`](https://clickhouse.com/docs/sql-reference/statements/system#sync-replica) 或 [`select_sequential_consistency`](https://clickhouse.com/docs/operations/settings/settings#select_sequential_consistency) 会增加 ClickHouse Keeper 的负载，并且根据服务当前的负载情况，可能导致性能下降。

推荐的做法是使用同一个会话或使用原生协议（粘性连接）进行写入/读取操作。
