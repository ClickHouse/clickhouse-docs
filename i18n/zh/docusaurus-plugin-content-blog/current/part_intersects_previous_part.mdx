---
title: "DB::Exception: Part XXXXX intersects previous part YYYYY. It is a bug or a result of manual intervention in the ZooKeeper data."
date: 2023-05-02
description: "本文解释如何解决 ClickHouse 中与数据分片区间重叠相关的 DB::Exception 错误，该错误通常由竞争条件或对 ZooKeeper 数据的手动干预导致。"
tags: ['错误和异常', '系统表']
keywords: ['Part Intersects', 'system.replicas']
---

{frontMatter.description}

{/* 截断 */}

## 发生原因 \{#why-it-occurs\}

当出现此错误时，表会显示为只读，并且错误消息会列出相互交叉的部分。

您可以在日志中看到该错误，或者通过

```sql
SELECT *
FROM system.replicas
WHERE is_readonly = 1
```

错误信息如下所示：

```
代码：49. DB::Exception：数据分片 XXXXX 与先前的数据分片 YYYYY 存在交集。这是一个程序错误或人为干预 ZooKeeper 数据的结果。(LOGICAL_ERROR)（版本 21.12.4.1（官方构建版本））
```

## 错误原因 \{#cause-of-the-error\}

此错误可能是由 `mergeSelectingTask` 与队列重新初始化之间的竞态条件引起的。

## 解决方案 \{#solution\}

在所有副本上执行以下查询：

```sql
DETACH TABLE table_name;  -- 执行 DROP REPLICA 前必需

SYSTEM DROP REPLICA 'replica_name' FROM ZKPATH '/table_path_in_zk/'; -- 将删除 /table_path_in_zk 路径下的所有内容

ATTACH TABLE table_name;  -- 表将处于只读模式,因为 ZooKeeper 中无元数据
```

然后在所有副本上执行以下操作：

```sql
SYSTEM RESTORE REPLICA table_name;  -- 将分离所有分区,在 ZK 中重新创建元数据(如同新建的空表),然后重新附加所有分区

SYSTEM SYNC REPLICA table_name; -- 等待副本同步数据分片。建议在恢复完成后检查所有副本上的 `system.detached_parts`。
```

:::tip
建议升级到最新版本的 ClickHouse
:::

## 其他资源 \{#additional-resources\}

相关 PR 和 GitHub Issue：

* [ClickHouse/ClickHouse#34096](https://github.com/ClickHouse/ClickHouse/pull/34096)
* [ClickHouse/ClickHouse#30651](https://github.com/ClickHouse/ClickHouse/pull/30651)
* [ClickHouse/ClickHouse#31060](https://github.com/ClickHouse/ClickHouse/pull/31060)
* [ClickHouse/ClickHouse#35863](https://github.com/ClickHouse/ClickHouse/issues/35863)

## 受影响的版本： \{#versions-affected\}

ClickHouse v22.12 及更早版本