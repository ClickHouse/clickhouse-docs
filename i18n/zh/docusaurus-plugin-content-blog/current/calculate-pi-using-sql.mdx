---
title: 用 SQL 来计算圆周率
description: 今天是圆周率日！让我们使用 ClickHouse SQL 来计算圆周率
date: 2023-03-14
tags: ['使用场景']
keywords: ['计算圆周率', 'SQL']
---

{frontMatter.description}

{/* 截断 */}


## 今天是圆周率日！让我们使用 SQL 计算圆周率

圆周率日快乐!我们认为在 ClickHouse 中使用 SQL 查询来计算圆周率会很有趣。以下是我们目前的一些方法...

1. 此示例使用 ClickHouse 的 `numbers_mt` 表函数返回 10 亿行数据，计算仅耗时 40 毫秒：

```sql
SELECT 4 * sum(if(number % 2, -1, 1) / ((number * 2) + 1)) AS pi
FROM numbers_mt(1000000000.)

┌────────────────pi─┐
│ 3.141592652589797 │
└───────────────────┘

1 行在集合中。耗时：0.432 秒。已处理 1.00 亿行，8.00 GB（2.32 亿行/秒，18.53 GB/秒）。
```

2. 下面的示例同样会处理 10 亿个数字，只是处理速度没那么快：

```sql
SELECT 3 + (4 * sum(if((number % 2) = 0, if((number % 4) = 0, -1 / ((number * (number + 1)) * (number + 2)), 1 / ((number * (number + 1)) * (number + 2))), 0))) AS pi
FROM numbers_mt(2, 10000000000)

┌─────────────────pi─┐
│ 3.1415926525808087 │
└────────────────────┘

1 row in set. Elapsed: 9.825 sec. Processed 10.00 billion rows, 80.00 GB (1.02 billion rows/s., 8.14 GB/s.)
```

3. 在 ClickHouse 里，我们显然最偏爱这一种（而且也是最精确的！）：

```sql
SELECT pi()

┌──────────────pi()─┐
│ 3.141592653589793 │
└───────────────────┘

1 row in set. Elapsed: 0.008 sec.
```

4. 这下真有人把三角函数玩明白了：

```sql
SELECT 2 * asin(1) AS pi

┌────────────────pi─┐
│ 3.141592653589793 │
└───────────────────┘

返回 1 行。耗时: 0.005 秒。
```

5. 下面有一个实用的 API，可让你指定所需的位数：

```sql
SELECT *
FROM url('https://api.pi.delivery/v1/pi?start=0&numberOfDigits=100', 'JSONEachRow')

┌───────────────content─┐
│ 3.1415926535897933e99 │
└───────────────────────┘

返回 1 行。耗时: 0.556 秒。
```

6. 这个示例很巧妙——它使用了 ClickHouse 的距离函数：

```sql
WITH random_points AS
    (
        SELECT (rand64(1) / pow(2, 64), rand64(2) / pow(2, 64)) AS point
        FROM numbers(1000000000)
    )
SELECT (4 * countIf(L2Norm(point) < 1)) / count() AS pi
FROM random_points


┌──────────pi─┐
│ 3.141627208 │
└─────────────┘

1 row in set. Elapsed: 4.742 sec. Processed 1.00 billion rows, 8.00 GB (210.88 million rows/s., 1.69 GB/s.)
```

7. 如果你是物理学家，你应该会对这一部分感到满意：

```sql
SELECT 22 / 7

┌─────divide(22, 7)─┐
│ 3.142857142857143 │
└───────────────────┘
```

8. 另一个间接方法（由 Alexey Milovidov 提出），精确到小数点后 7 位，且计算速度很快：

```sql
WITH
    10 AS length,
    (number / 1000000000.) * length AS x
SELECT pow((2 * length) * avg(exp(-(x * x))), 2) AS pi
FROM numbers_mt(1000000000.)


┌─────────────────pi─┐
│ 3.1415926890388595 │
└────────────────────┘

返回 1 行。耗时：1.245 秒。处理了 10 亿行，8.00 GB（每秒 8.0325 亿行，6.43 GB/秒）。
```

:::note
如果您有更多内容,我们非常欢迎您的贡献。谢谢!
:::