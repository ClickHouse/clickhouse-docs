---
title: 如何将新的 JSON 数据类型与 Kafka 搭配使用？
description: "了解如何使用 Kafka 表引擎和 JSON 数据类型，将来自 Apache Kafka 的 JSON 消息直接加载到 ClickHouse 中的单个 JSON 列。"
date: 2024-11-06
tags: ['数据格式', '数据摄取']
---

{frontMatter.description}

{/* 截断 */}


## Kafka 与 JSON 数据类型 \{#kafka-and-the-json-data-type\}

随着新的 [`JSON`](/sql-reference/data-types/newjson) 数据类型的引入，ClickHouse 现在已经是[用于 JSON 分析的理想数据库选择](https://clickhouse.com/engineering-resources/json-database)。
在本指南中，我们将学习如何将来自 Apache Kafka 的 JSON 消息直接加载到 ClickHouse 中的单个 `JSON` 列中。

## 设置 Kafka

首先在本机上运行一个 Kafka broker 实例。我们还会将 9092 端口映射到主机操作系统上的 9092 端口，以便更方便地与 Kafka 交互：

```bash
docker run --name broker -p 9092:9092 apache/kafka:3.8.1
```


## 将数据摄取到 Kafka

在其运行之后，我们需要摄取一些数据。
Wikimedia 的最近更改（recent changes）订阅源是一个很好的流式数据来源，因此我们将其摄取到 `wiki_events` 主题中：

```bash
curl -N https://stream.wikimedia.org/v2/stream/recentchange 2>/dev/null |
awk '/^data: /{gsub(/^data: /, ""); print}' |
jq -cr --arg sep ø '[.meta.id, tostring] | join($sep)' |
kcat -P -b localhost:9092 -t wiki_events -Kø
```

我们可以通过运行以下命令来检查是否正在摄取数据：

```bash
kcat -C -b localhost:9092  -t wiki_events
```


```text
{"$schema":"/mediawiki/recentchange/1.0.0","meta":{"uri":"https://www.wikidata.org/wiki/Q130972321","request_id":"5c687ded-4721-4bfc-ae6c-58ca25f4a6ce","id":"0fbb0982-c43b-4e8b-989b-db7e78dbdc76","dt":"2024-11-06T11:59:57Z","domain":"www.wikidata.org","stream":"mediawiki.recentchange","topic":"codfw.mediawiki.recentchange","partition":0,"offset":1228777205},"id":2338656448,"type":"edit","namespace":0,"title":"Q130972321","title_url":"https://www.wikidata.org/wiki/Q130972321","comment":"/* wbsetclaim-create:2||1 */ [[Property:P18]]: Mahdi Rrezaei Journalist.jpg","timestamp":1730894397,"user":"Wikimellatir","bot":false,"notify_url":"https://www.wikidata.org/w/index.php?diff=2270885254&oldid=2270870214&rcid=2338656448","minor":false,"patrolled":false,"length":{"old":4269,"new":4636},"revision":{"old":2270870214,"new":2270885254},"server_url":"https://www.wikidata.org","server_name":"www.wikidata.org","server_script_path":"/w","wiki":"wikidatawiki","parsedcomment":"<span dir=\"auto\"><span class=\"autocomment\">Created claim: </span></span> <a href=\"/wiki/Property:P18\" title=\"image | image of relevant illustration of the subject; if available, also use more specific properties (sample: coat of arms image, locator map, flag image, signature image, logo image, collage image)\"><span class=\"wb-itemlink\"><span class=\"wb-itemlink-label\" lang=\"en\" dir=\"ltr\">image</span> <span class=\"wb-itemlink-id\">(P18)</span></span></a>: Mahdi Rrezaei Journalist.jpg"}
{"$schema":"/mediawiki/recentchange/1.0.0","meta":{"uri":"https://www.wikidata.org/wiki/Q75756596","request_id":"eb116219-7372-4725-986f-790211708d36","id":"9e0d5299-5bd1-4c58-b796-9852afd8a84e","dt":"2024-11-06T11:59:54Z","domain":"www.wikidata.org","stream":"mediawiki.recentchange","topic":"codfw.mediawiki.recentchange","partition":0,"offset":1228777206},"id":2338656449,"type":"edit","namespace":0,"title":"Q75756596","title_url":"https://www.wikidata.org/wiki/Q75756596","comment":"/* wbeditentity-update-languages-and-other:0||55 */ mv labels and aliases matching [[Property:P528]] or [[Property:P3083]] to mul","timestamp":1730894394,"user":"Twofivesixbot","bot":true,"notify_url":"https://www.wikidata.org/w/index.php?diff=2270885237&oldid=2147709089&rcid=2338656449","minor":false,"patrolled":true,"length":{"old":30879,"new":27161},"revision":{"old":2147709089,"new":2270885237},"server_url":"https://www.wikidata.org","server_name":"www.wikidata.org","server_script_path":"/w","wiki":"wikidatawiki","parsedcomment":"<span dir=\"auto\"><span class=\"autocomment\">Changed label, description and/or aliases in 55 languages, and other parts: </span></span> mv labels and aliases matching <a href=\"/wiki/Property:P528\" title=\"catalog code | catalog name of an object, use with qualifier P972\"><span class=\"wb-itemlink\"><span class=\"wb-itemlink-label\" lang=\"en\" dir=\"ltr\">catalog code</span> <span class=\"wb-itemlink-id\">(P528)</span></span></a> or <a href=\"/wiki/Property:P3083\" title=\"SIMBAD ID | identifier for an astronomical object, in the University of Strasbourg&#039;s SIMBAD database\"><span class=\"wb-itemlink\"><span class=\"wb-itemlink-label\" lang=\"en\" dir=\"ltr\">SIMBAD ID</span> <span class=\"wb-itemlink-id\">(P3083)</span></span></a> to mul"}
```

到目前为止，一切顺利。


## 将数据摄取到 ClickHouse

接下来，我们将把数据摄取到 ClickHouse 中。
首先，通过设置以下属性来启用 JSON 类型（当前仍为实验功能）：

```sql
SET allow_experimental_json_type = 1;
```

现在，我们将创建 `wiki_queue` 表，该表使用 [`Kafka` 表引擎](/integrations/kafka/kafka-table-engine)。

```sql
CREATE TABLE wiki_queue
(
    json JSON
)
ENGINE = Kafka(
  'localhost:9092', 
  'wiki_events', 
  'clickhouse-consumer-group',
  'JSONAsObject'
);
```

请注意，我们使用的是 [`JSONAsObject`](https://clickhouse.com/docs/interfaces/formats/JSON/JSONAsObject) 格式，它可以确保传入的消息以 JSON 对象的形式提供。
这种格式只能解析为仅包含一个 `JSON` 类型列的表。

接下来，我们将创建用于存储 Wiki 数据的底层表：

```sql
CREATE TABLE wiki
(
    json JSON,
    id String MATERIALIZED getSubcolumn(json, 'meta.id')
)
ENGINE = MergeTree
ORDER BY id;
```

最后，让我们创建一个物化视图用于填充 `wiki` 表：

```sql
CREATE MATERIALIZED VIEW wiki_mv TO wiki AS 
SELECT json
FROM wiki_queue;
```


## 在 ClickHouse 中查询 JSON 数据

接下来我们可以对 `wiki` 表进行查询。
例如，我们可以统计已经提交更改的机器人数量：

```sql
SELECT json.bot, count()
FROM wiki
GROUP BY ALL
```

```text
   ┌─json.bot─┬─count()─┐
1. │ true     │    2526 │
2. │ false    │    4691 │
   └──────────┴─────────┘
```

或者，我们可以找出在 `en.wikipedia.org` 上改动最多的用户：

```sql
SELECT
    json.user,
    count()
FROM wiki
WHERE json.server_name = 'en.wikipedia.org'
GROUP BY ALL
ORDER BY count() DESC
LIMIT 10
```

```text
    ┌─json.user──────────────────────────────┬─count()─┐
 1. │ Monkbot                                │     267 │
 2. │ Onel5969                               │     107 │
 3. │ Bangwiki                               │      37 │
 4. │ HHH Pedrigree                          │      28 │
 5. │ REDACTED403                            │      23 │
 6. │ KylieTastic                            │      22 │
 7. │ Tinniesbison                           │      21 │
 8. │ XTheBedrockX                           │      20 │
 9. │ 2001:4455:1DB:4000:51F3:6A16:408E:69FC │      19 │
10. │ Wcquidditch                            │      15 │
    └────────────────────────────────────────┴─────────┘
```
