---
date: 2025-11-19
title: 存储故障后如何恢复副本
tags: ['部署与扩展']
keywords: ['恢复', '副本', '存储故障', 'Atomic 数据库']
description: '本文介绍在 ClickHouse 中使用 Atomic 数据库的复制表时，当某个副本上的磁盘或存储丢失或损坏时，如何恢复数据。'
---

{frontMatter.description}

{/* 截断 */}

<br />

<br />

:::note
本指南假定您在 config.xml 文件中将 `<path>` 参数设置为：

```text
<path>/var/lib/clickhouse/</path>
```

如果你配置了不同的数据路径，请将下方命令中所有出现的 `/var/lib/clickhouse` 替换为 `<path>` 配置项的实际值。
:::

<VerticalStepper headerLevel="h2">
  ## 从健康副本复制访问配置

  从健康副本中复制包含本地用户的 `access` 文件夹内容：

  ```text
  /var/lib/clickhouse/access
  ```

  ## 从健康副本备份 metadata 目录

  1. 进入 ClickHouse 数据目录：

  ```text
  cd /var/lib/clickhouse
  ```

  2. 创建 metadata 目录的备份（包括符号链接）：metadata 目录包含数据库和表的 DDL。
     数据库目录中包含指向 `/var/lib/clickhouse/store/..` 的符号链接，该目录包含所有表的 DDL。

  ```bash
  { find metadata -type f; find metadata -type l; find metadata -type l | xargs readlink -f; } | tar -cPf backup.tar --files-from=-
  ```

  :::note
  此命令确保在备份中同时保留 **metadata 文件** 和符号链接结构。
  :::

  ## 在故障副本上恢复 metadata

  1. 将生成的 `backup.tar` 文件复制到故障副本上。
  2. 将其解压到 ClickHouse 数据目录中：

  ```text
  cd /var/lib/clickhouse/
  tar -xvPf backup.tar
  ```

  ## 创建强制恢复标志文件

  为了触发从其他副本自动进行数据同步，创建以下标志文件：

  ```text
  sudo -u clickhouse touch /var/lib/clickhouse/flags/force_restore_data
  ```

  ## 重启故障副本

  1. 在故障节点上重启 ClickHouse 服务器。
  2. 检查服务器日志，你应该能看到从健康副本下载数据分片的过程：

  ```bash
  2025.11.02 00:00:04.047097 [ 682 ] {} <Debug> analytics.events_local (...) (Fetcher): Downloading files 23
  2025.11.02 00:00:04.055542 [ 682 ] {} <Debug> analytics.events_local (...) (Fetcher): Download of part 202511_0_0_0 onto disk disk2 finished.
  2025.11.02 00:00:04.101888 [ 687 ] {} <Debug> warehouse.customers_local (...) (Fetcher): Downloading part 2025_0_0_1 onto disk default.
  2025.11.02 00:00:04.102005 [ 687 ] {} <Debug> warehouse.customers_local (...) (Fetcher): Downloading files 11
  2025.11.02 00:00:04.102210 [ 690 ] {} <Debug> warehouse.customers_local (...) (Fetcher): Downloading part 2022_0_0_1 onto disk disk1.
  2025.11.02 00:00:04.102247 [ 688 ] {} <Debug> warehouse.customers_local (...) (Fetcher): Downloading part 2021_0_0_1 onto disk disk2.
  2025.11.02 00:00:04.102331 [ 690 ] {} <Debug> warehouse.customers_local (...) (Fetcher): Downloading files 11
  ```
</VerticalStepper>
