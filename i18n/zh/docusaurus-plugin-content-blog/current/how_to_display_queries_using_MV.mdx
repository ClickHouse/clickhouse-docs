---
title: 如何在 ClickHouse 中识别使用物化视图的查询
description: 了解如何查询 ClickHouse 日志，以在指定时间范围内识别所有涉及物化视图的查询。
date: 2023-03-24
tags: ['系统表']
keywords: ['物化视图', 'create_table_query']
---

{frontMatter.description}

{/* 截断 */}

***

## 问题 \{#question\}

如何显示过去 60 分钟内所有涉及物化视图的查询？

## 答案 \{#answer\}

此查询将在以下前提下显示所有指向物化视图的查询：

* 我们可以利用 `system.tables` 表中的 `create_table_query` 字段来识别哪些表是物化视图显式（`TO`）的目标表；
* 我们可以通过 `uuid` 以及命名约定 `.inner_id.<uuid>` 回溯出哪些表是物化视图的隐式目标表；

我们还可以通过修改初始查询中的 CTE 的值（默认 `60` 分钟），来配置要回溯多长时间的数据。

```sql
WITH(60) -- 默认 60 分钟
AS timeRange,
(
    --为所有具有非空 uuid 的表准备可能的隐式物化视图隐藏目标表名称
    SELECT groupArray(
            concat('default.`.inner_id.', toString(uuid), '`')
        )
    FROM clusterAllReplicas(default, system.tables)
    WHERE notEmpty(uuid)
) AS MV_implicit_possible_hidden_target_tables_names_array,
(
    --捕获物化视图名称和目标表（如果指定了 TO）
    --TODO 看起来 extract 只会返回第一个捕获组 :( 可用后替换为 regexpExtract
    SELECT arrayFilter(
            x->x != '',
            --移除空捕获
            groupArray(
                extract(
                    create_table_query,
                    '^CREATE MATERIALIZED VIEW\s(\w+\.\w+)\s(?:TO\s(\S+))?'
                )
            )
        )
    FROM clusterAllReplicas(default, system.tables)
    WHERE engine = 'MaterializedView'
) AS MV_explicit_target_tables_names_array
SELECT event_time,
    query,
    tables as "MVs tables"
FROM clusterAllReplicas(default, system.query_log)
WHERE (
        -- 仅 60 分钟内的 SELECT
        event_time > now() - toIntervalMinute(timeRange)
        AND startsWith(query, 'SELECT')
    ) -- 检查查询是否涉及隐式物化视图目标表名称
    AND (
        hasAny(
            tables,
            MV_implicit_possible_hidden_target_tables_names_array
        )
        OR -- 检查查询是否涉及显式物化视图目标表
        hasAny(tables, MV_explicit_target_tables_names_array)
    )
ORDER BY event_time DESC;
```

预期输出：

```sql
| event_time          | query                                                                                          | MVs tables                                                            |
| ------------------- | ---------------------------------------------------------------------------------------------- | --------------------------------------------------------------------- |
| 2023-02-23 08:14:14 | SELECT     rand(),* FROM     default.sum_of_volumes,     default.big_changes,     system.users | ["default.big_changes_mv","default.sum_of_volumes_mv","system.users"] |
| 2023-02-23 08:04:47 | SELECT     price,* FROM     default.sum_of_volumes,     default.big_changes                    | ["default.big_changes_mv","default.sum_of_volumes_mv"]                |

```

在上述示例结果中，`default.big_changes_mv` 和 `default.sum_of_volumes_mv` 都是物化视图。
